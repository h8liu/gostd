<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html" class="current">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4598513">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4598568">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4598622">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4598673">package</span>&nbsp;<span class="ident" id="4598681">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4598686">import</span>&nbsp;<span class="op" id="4598693">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4598696">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4598706">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4598722">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4598736">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4598753">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4598768">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4598785">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4598795">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4598802">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4598807">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4598810">//&nbsp;serverHandshakeState&nbsp;contains&nbsp;details&nbsp;of&nbsp;a&nbsp;server&nbsp;handshake&nbsp;in&nbsp;progress.</span><br>
<span class="lineno">20</span><span class="comment" id="4598886">//&nbsp;It&#39;s&nbsp;discarded&nbsp;once&nbsp;the&nbsp;handshake&nbsp;has&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="4598938">type</span>&nbsp;<span class="ident" id="4598943">serverHandshakeState</span>&nbsp;<span class="keyword" id="4598964">struct</span>&nbsp;<span class="op" id="4598971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598974">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4598990">*</span><span class="ident" id="4598991">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598997">clientHello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4599013">*</span><span class="ident" id="4599014">clientHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599030">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4599046">*</span><span class="ident" id="4599047">serverHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599063">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4599079">*</span><span class="ident" id="4599080">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599093">ellipticOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4599109">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599115">ecdsaOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4599131">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599137">sessionState</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4599153">*</span><span class="ident" id="4599154">sessionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599168">finishedHash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4599184">finishedHash</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599198">masterSecret</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4599214">[</span><span class="op" id="4599215">]</span><span class="builtintype" id="4599216">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599222">certsFromClient</span>&nbsp;<span class="op" id="4599238">[</span><span class="op" id="4599239">]</span><span class="op" id="4599240">[</span><span class="op" id="4599241">]</span><span class="builtintype" id="4599242">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599248">cert</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4599264">*</span><span class="ident" id="4599265">Certificate</span><br>
<span class="lineno"></span><span class="op" id="4599277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="4599280">//&nbsp;serverHandshake&nbsp;performs&nbsp;a&nbsp;TLS&nbsp;handshake&nbsp;as&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="4599337">func</span>&nbsp;<span class="op" id="4599342">(</span><span class="ident" id="4599343">c</span>&nbsp;<span class="op" id="4599345">*</span><span class="ident" id="4599346">Conn</span><span class="op" id="4599350">)</span>&nbsp;<span class="ident" id="4599352">serverHandshake</span><span class="op" id="4599367">(</span><span class="op" id="4599368">)</span>&nbsp;<span class="builtintype" id="4599370">error</span>&nbsp;<span class="op" id="4599376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599379">config</span>&nbsp;<span class="op" id="4599386">:=</span>&nbsp;<span class="ident" id="4599389">c</span><span class="op" id="4599390">.</span><span class="ident" id="4599391">config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4599400">//&nbsp;If&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;server&nbsp;handshake,&nbsp;we&nbsp;generate&nbsp;a&nbsp;random&nbsp;key&nbsp;to</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4599471">//&nbsp;encrypt&nbsp;the&nbsp;tickets&nbsp;with.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599501">config</span><span class="op" id="4599507">.</span><span class="ident" id="4599508">serverInitOnce</span><span class="op" id="4599522">.</span><span class="ident" id="4599523">Do</span><span class="op" id="4599525">(</span><span class="ident" id="4599526">config</span><span class="op" id="4599532">.</span><span class="ident" id="4599533">serverInit</span><span class="op" id="4599543">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599547">hs</span>&nbsp;<span class="op" id="4599550">:=</span>&nbsp;<span class="ident" id="4599553">serverHandshakeState</span><span class="op" id="4599573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599577">c</span><span class="op" id="4599578">:</span>&nbsp;<span class="ident" id="4599580">c</span><span class="op" id="4599581">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4599584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599587">isResume</span><span class="op" id="4599595">,</span>&nbsp;<span class="ident" id="4599597">err</span>&nbsp;<span class="op" id="4599601">:=</span>&nbsp;<span class="ident" id="4599604">hs</span><span class="op" id="4599606">.</span><span class="ident" id="4599607">readClientHello</span><span class="op" id="4599622">(</span><span class="op" id="4599623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4599626">if</span>&nbsp;<span class="ident" id="4599629">err</span>&nbsp;<span class="op" id="4599633">!=</span>&nbsp;<span class="ident" id="4599636">nil</span>&nbsp;<span class="op" id="4599640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4599644">return</span>&nbsp;<span class="ident" id="4599651">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4599656">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4599660">//&nbsp;For&nbsp;an&nbsp;overview&nbsp;of&nbsp;TLS&nbsp;handshaking,&nbsp;see&nbsp;https://tools.ietf.org/html/rfc5246#section-7.3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4599752">if</span>&nbsp;<span class="ident" id="4599755">isResume</span>&nbsp;<span class="op" id="4599764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4599768">//&nbsp;The&nbsp;client&nbsp;has&nbsp;included&nbsp;a&nbsp;session&nbsp;ticket&nbsp;and&nbsp;so&nbsp;we&nbsp;do&nbsp;an&nbsp;abbreviated&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4599853">if</span>&nbsp;<span class="ident" id="4599856">err</span>&nbsp;<span class="op" id="4599860">:=</span>&nbsp;<span class="ident" id="4599863">hs</span><span class="op" id="4599865">.</span><span class="ident" id="4599866">doResumeHandshake</span><span class="op" id="4599883">(</span><span class="op" id="4599884">)</span><span class="op" id="4599885">;</span>&nbsp;<span class="ident" id="4599887">err</span>&nbsp;<span class="op" id="4599891">!=</span>&nbsp;<span class="ident" id="4599894">nil</span>&nbsp;<span class="op" id="4599898">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4599903">return</span>&nbsp;<span class="ident" id="4599910">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4599916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4599920">if</span>&nbsp;<span class="ident" id="4599923">err</span>&nbsp;<span class="op" id="4599927">:=</span>&nbsp;<span class="ident" id="4599930">hs</span><span class="op" id="4599932">.</span><span class="ident" id="4599933">establishKeys</span><span class="op" id="4599946">(</span><span class="op" id="4599947">)</span><span class="op" id="4599948">;</span>&nbsp;<span class="ident" id="4599950">err</span>&nbsp;<span class="op" id="4599954">!=</span>&nbsp;<span class="ident" id="4599957">nil</span>&nbsp;<span class="op" id="4599961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4599966">return</span>&nbsp;<span class="ident" id="4599973">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4599979">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4599983">if</span>&nbsp;<span class="ident" id="4599986">err</span>&nbsp;<span class="op" id="4599990">:=</span>&nbsp;<span class="ident" id="4599993">hs</span><span class="op" id="4599995">.</span><span class="ident" id="4599996">sendFinished</span><span class="op" id="4600008">(</span><span class="ident" id="4600009">c</span><span class="op" id="4600010">.</span><span class="ident" id="4600011">firstFinished</span><span class="op" id="4600024">[</span><span class="op" id="4600025">:</span><span class="op" id="4600026">]</span><span class="op" id="4600027">)</span><span class="op" id="4600028">;</span>&nbsp;<span class="ident" id="4600030">err</span>&nbsp;<span class="op" id="4600034">!=</span>&nbsp;<span class="ident" id="4600037">nil</span>&nbsp;<span class="op" id="4600041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600046">return</span>&nbsp;<span class="ident" id="4600053">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4600059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600063">if</span>&nbsp;<span class="ident" id="4600066">err</span>&nbsp;<span class="op" id="4600070">:=</span>&nbsp;<span class="ident" id="4600073">hs</span><span class="op" id="4600075">.</span><span class="ident" id="4600076">readFinished</span><span class="op" id="4600088">(</span><span class="ident" id="4600089">nil</span><span class="op" id="4600092">)</span><span class="op" id="4600093">;</span>&nbsp;<span class="ident" id="4600095">err</span>&nbsp;<span class="op" id="4600099">!=</span>&nbsp;<span class="ident" id="4600102">nil</span>&nbsp;<span class="op" id="4600106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600111">return</span>&nbsp;<span class="ident" id="4600118">err</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4600124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600128">c</span><span class="op" id="4600129">.</span><span class="ident" id="4600130">didResume</span>&nbsp;<span class="op" id="4600140">=</span>&nbsp;<span class="builtintype" id="4600142">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4600148">}</span>&nbsp;<span class="keyword" id="4600150">else</span>&nbsp;<span class="op" id="4600155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4600159">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;include&nbsp;a&nbsp;session&nbsp;ticket,&nbsp;or&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4600221">//&nbsp;valid&nbsp;so&nbsp;we&nbsp;do&nbsp;a&nbsp;full&nbsp;handshake.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600259">if</span>&nbsp;<span class="ident" id="4600262">err</span>&nbsp;<span class="op" id="4600266">:=</span>&nbsp;<span class="ident" id="4600269">hs</span><span class="op" id="4600271">.</span><span class="ident" id="4600272">doFullHandshake</span><span class="op" id="4600287">(</span><span class="op" id="4600288">)</span><span class="op" id="4600289">;</span>&nbsp;<span class="ident" id="4600291">err</span>&nbsp;<span class="op" id="4600295">!=</span>&nbsp;<span class="ident" id="4600298">nil</span>&nbsp;<span class="op" id="4600302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600307">return</span>&nbsp;<span class="ident" id="4600314">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4600320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600324">if</span>&nbsp;<span class="ident" id="4600327">err</span>&nbsp;<span class="op" id="4600331">:=</span>&nbsp;<span class="ident" id="4600334">hs</span><span class="op" id="4600336">.</span><span class="ident" id="4600337">establishKeys</span><span class="op" id="4600350">(</span><span class="op" id="4600351">)</span><span class="op" id="4600352">;</span>&nbsp;<span class="ident" id="4600354">err</span>&nbsp;<span class="op" id="4600358">!=</span>&nbsp;<span class="ident" id="4600361">nil</span>&nbsp;<span class="op" id="4600365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600370">return</span>&nbsp;<span class="ident" id="4600377">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4600383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600387">if</span>&nbsp;<span class="ident" id="4600390">err</span>&nbsp;<span class="op" id="4600394">:=</span>&nbsp;<span class="ident" id="4600397">hs</span><span class="op" id="4600399">.</span><span class="ident" id="4600400">readFinished</span><span class="op" id="4600412">(</span><span class="ident" id="4600413">c</span><span class="op" id="4600414">.</span><span class="ident" id="4600415">firstFinished</span><span class="op" id="4600428">[</span><span class="op" id="4600429">:</span><span class="op" id="4600430">]</span><span class="op" id="4600431">)</span><span class="op" id="4600432">;</span>&nbsp;<span class="ident" id="4600434">err</span>&nbsp;<span class="op" id="4600438">!=</span>&nbsp;<span class="ident" id="4600441">nil</span>&nbsp;<span class="op" id="4600445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600450">return</span>&nbsp;<span class="ident" id="4600457">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4600463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600467">if</span>&nbsp;<span class="ident" id="4600470">err</span>&nbsp;<span class="op" id="4600474">:=</span>&nbsp;<span class="ident" id="4600477">hs</span><span class="op" id="4600479">.</span><span class="ident" id="4600480">sendSessionTicket</span><span class="op" id="4600497">(</span><span class="op" id="4600498">)</span><span class="op" id="4600499">;</span>&nbsp;<span class="ident" id="4600501">err</span>&nbsp;<span class="op" id="4600505">!=</span>&nbsp;<span class="ident" id="4600508">nil</span>&nbsp;<span class="op" id="4600512">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600517">return</span>&nbsp;<span class="ident" id="4600524">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4600530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600534">if</span>&nbsp;<span class="ident" id="4600537">err</span>&nbsp;<span class="op" id="4600541">:=</span>&nbsp;<span class="ident" id="4600544">hs</span><span class="op" id="4600546">.</span><span class="ident" id="4600547">sendFinished</span><span class="op" id="4600559">(</span><span class="ident" id="4600560">nil</span><span class="op" id="4600563">)</span><span class="op" id="4600564">;</span>&nbsp;<span class="ident" id="4600566">err</span>&nbsp;<span class="op" id="4600570">!=</span>&nbsp;<span class="ident" id="4600573">nil</span>&nbsp;<span class="op" id="4600577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600582">return</span>&nbsp;<span class="ident" id="4600589">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4600595">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4600598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600601">c</span><span class="op" id="4600602">.</span><span class="ident" id="4600603">handshakeComplete</span>&nbsp;<span class="op" id="4600621">=</span>&nbsp;<span class="builtintype" id="4600623">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600630">return</span>&nbsp;<span class="ident" id="4600637">nil</span><br>
<span class="lineno"></span><span class="op" id="4600641">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4600644">//&nbsp;readClientHello&nbsp;reads&nbsp;a&nbsp;ClientHello&nbsp;message&nbsp;from&nbsp;the&nbsp;client&nbsp;and&nbsp;decides</span><br>
<span class="lineno"></span><span class="comment" id="4600719">//&nbsp;whether&nbsp;we&nbsp;will&nbsp;perform&nbsp;session&nbsp;resumption.</span><br>
<span class="lineno"></span><span class="keyword" id="4600766">func</span>&nbsp;<span class="op" id="4600771">(</span><span class="ident" id="4600772">hs</span>&nbsp;<span class="op" id="4600775">*</span><span class="ident" id="4600776">serverHandshakeState</span><span class="op" id="4600796">)</span>&nbsp;<span class="ident" id="4600798">readClientHello</span><span class="op" id="4600813">(</span><span class="op" id="4600814">)</span>&nbsp;<span class="op" id="4600816">(</span><span class="ident" id="4600817">isResume</span>&nbsp;<span class="builtintype" id="4600826">bool</span><span class="op" id="4600830">,</span>&nbsp;<span class="ident" id="4600832">err</span>&nbsp;<span class="builtintype" id="4600836">error</span><span class="op" id="4600841">)</span>&nbsp;<span class="op" id="4600843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600846">config</span>&nbsp;<span class="op" id="4600853">:=</span>&nbsp;<span class="ident" id="4600856">hs</span><span class="op" id="4600858">.</span><span class="ident" id="4600859">c</span><span class="op" id="4600860">.</span><span class="ident" id="4600861">config</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600869">c</span>&nbsp;<span class="op" id="4600871">:=</span>&nbsp;<span class="ident" id="4600874">hs</span><span class="op" id="4600876">.</span><span class="ident" id="4600877">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600881">msg</span><span class="op" id="4600884">,</span>&nbsp;<span class="ident" id="4600886">err</span>&nbsp;<span class="op" id="4600890">:=</span>&nbsp;<span class="ident" id="4600893">c</span><span class="op" id="4600894">.</span><span class="ident" id="4600895">readHandshake</span><span class="op" id="4600908">(</span><span class="op" id="4600909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600912">if</span>&nbsp;<span class="ident" id="4600915">err</span>&nbsp;<span class="op" id="4600919">!=</span>&nbsp;<span class="ident" id="4600922">nil</span>&nbsp;<span class="op" id="4600926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600930">return</span>&nbsp;<span class="builtintype" id="4600937">false</span><span class="op" id="4600942">,</span>&nbsp;<span class="ident" id="4600944">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4600949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600952">var</span>&nbsp;<span class="ident" id="4600956">ok</span>&nbsp;<span class="builtintype" id="4600959">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600965">hs</span><span class="op" id="4600967">.</span><span class="ident" id="4600968">clientHello</span><span class="op" id="4600979">,</span>&nbsp;<span class="ident" id="4600981">ok</span>&nbsp;<span class="op" id="4600984">=</span>&nbsp;<span class="ident" id="4600986">msg</span><span class="op" id="4600989">.</span><span class="op" id="4600990">(</span><span class="op" id="4600991">*</span><span class="ident" id="4600992">clientHelloMsg</span><span class="op" id="4601006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601009">if</span>&nbsp;<span class="op" id="4601012">!</span><span class="ident" id="4601013">ok</span>&nbsp;<span class="op" id="4601016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601020">c</span><span class="op" id="4601021">.</span><span class="ident" id="4601022">sendAlert</span><span class="op" id="4601031">(</span><span class="ident" id="4601032">alertUnexpectedMessage</span><span class="op" id="4601054">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601058">return</span>&nbsp;<span class="builtintype" id="4601065">false</span><span class="op" id="4601070">,</span>&nbsp;<span class="ident" id="4601072">unexpectedMessageError</span><span class="op" id="4601094">(</span><span class="ident" id="4601095">hs</span><span class="op" id="4601097">.</span><span class="ident" id="4601098">clientHello</span><span class="op" id="4601109">,</span>&nbsp;<span class="ident" id="4601111">msg</span><span class="op" id="4601114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4601117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601120">c</span><span class="op" id="4601121">.</span><span class="ident" id="4601122">vers</span><span class="op" id="4601126">,</span>&nbsp;<span class="ident" id="4601128">ok</span>&nbsp;<span class="op" id="4601131">=</span>&nbsp;<span class="ident" id="4601133">config</span><span class="op" id="4601139">.</span><span class="ident" id="4601140">mutualVersion</span><span class="op" id="4601153">(</span><span class="ident" id="4601154">hs</span><span class="op" id="4601156">.</span><span class="ident" id="4601157">clientHello</span><span class="op" id="4601168">.</span><span class="ident" id="4601169">vers</span><span class="op" id="4601173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601176">if</span>&nbsp;<span class="op" id="4601179">!</span><span class="ident" id="4601180">ok</span>&nbsp;<span class="op" id="4601183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601187">c</span><span class="op" id="4601188">.</span><span class="ident" id="4601189">sendAlert</span><span class="op" id="4601198">(</span><span class="ident" id="4601199">alertProtocolVersion</span><span class="op" id="4601219">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601223">return</span>&nbsp;<span class="builtintype" id="4601230">false</span><span class="op" id="4601235">,</span>&nbsp;<span class="ident" id="4601237">fmt</span><span class="op" id="4601240">.</span><span class="ident" id="4601241">Errorf</span><span class="op" id="4601247">(</span><span class="string" id="4601248">&#34;tls:&nbsp;client&nbsp;offered&nbsp;an&nbsp;unsupported,&nbsp;maximum&nbsp;protocol&nbsp;version&nbsp;of&nbsp;%x&#34;</span><span class="op" id="4601316">,</span>&nbsp;<span class="ident" id="4601318">hs</span><span class="op" id="4601320">.</span><span class="ident" id="4601321">clientHello</span><span class="op" id="4601332">.</span><span class="ident" id="4601333">vers</span><span class="op" id="4601337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4601340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601343">c</span><span class="op" id="4601344">.</span><span class="ident" id="4601345">haveVers</span>&nbsp;<span class="op" id="4601354">=</span>&nbsp;<span class="builtintype" id="4601356">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601363">hs</span><span class="op" id="4601365">.</span><span class="ident" id="4601366">finishedHash</span>&nbsp;<span class="op" id="4601379">=</span>&nbsp;<span class="ident" id="4601381">newFinishedHash</span><span class="op" id="4601396">(</span><span class="ident" id="4601397">c</span><span class="op" id="4601398">.</span><span class="ident" id="4601399">vers</span><span class="op" id="4601403">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601406">hs</span><span class="op" id="4601408">.</span><span class="ident" id="4601409">finishedHash</span><span class="op" id="4601421">.</span><span class="ident" id="4601422">Write</span><span class="op" id="4601427">(</span><span class="ident" id="4601428">hs</span><span class="op" id="4601430">.</span><span class="ident" id="4601431">clientHello</span><span class="op" id="4601442">.</span><span class="ident" id="4601443">marshal</span><span class="op" id="4601450">(</span><span class="op" id="4601451">)</span><span class="op" id="4601452">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601456">hs</span><span class="op" id="4601458">.</span><span class="ident" id="4601459">hello</span>&nbsp;<span class="op" id="4601465">=</span>&nbsp;<span class="builtinfunc" id="4601467">new</span><span class="op" id="4601470">(</span><span class="ident" id="4601471">serverHelloMsg</span><span class="op" id="4601485">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601489">supportedCurve</span>&nbsp;<span class="op" id="4601504">:=</span>&nbsp;<span class="builtintype" id="4601507">false</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601514">preferredCurves</span>&nbsp;<span class="op" id="4601530">:=</span>&nbsp;<span class="ident" id="4601533">config</span><span class="op" id="4601539">.</span><span class="ident" id="4601540">curvePreferences</span><span class="op" id="4601556">(</span><span class="op" id="4601557">)</span><br>
<span class="lineno"></span><span class="ident" id="4601559">Curves</span><span class="op" id="4601565">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601568">for</span>&nbsp;<span class="ident" id="4601572">_</span><span class="op" id="4601573">,</span>&nbsp;<span class="ident" id="4601575">curve</span>&nbsp;<span class="op" id="4601581">:=</span>&nbsp;<span class="keyword" id="4601584">range</span>&nbsp;<span class="ident" id="4601590">hs</span><span class="op" id="4601592">.</span><span class="ident" id="4601593">clientHello</span><span class="op" id="4601604">.</span><span class="ident" id="4601605">supportedCurves</span>&nbsp;<span class="op" id="4601621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601625">for</span>&nbsp;<span class="ident" id="4601629">_</span><span class="op" id="4601630">,</span>&nbsp;<span class="ident" id="4601632">supported</span>&nbsp;<span class="op" id="4601642">:=</span>&nbsp;<span class="keyword" id="4601645">range</span>&nbsp;<span class="ident" id="4601651">preferredCurves</span>&nbsp;<span class="op" id="4601667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601672">if</span>&nbsp;<span class="ident" id="4601675">supported</span>&nbsp;<span class="op" id="4601685">==</span>&nbsp;<span class="ident" id="4601688">curve</span>&nbsp;<span class="op" id="4601694">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601700">supportedCurve</span>&nbsp;<span class="op" id="4601715">=</span>&nbsp;<span class="builtintype" id="4601717">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601726">break</span>&nbsp;<span class="ident" id="4601732">Curves</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4601742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4601746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4601749">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601753">supportedPointFormat</span>&nbsp;<span class="op" id="4601774">:=</span>&nbsp;<span class="builtintype" id="4601777">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601784">for</span>&nbsp;<span class="ident" id="4601788">_</span><span class="op" id="4601789">,</span>&nbsp;<span class="ident" id="4601791">pointFormat</span>&nbsp;<span class="op" id="4601803">:=</span>&nbsp;<span class="keyword" id="4601806">range</span>&nbsp;<span class="ident" id="4601812">hs</span><span class="op" id="4601814">.</span><span class="ident" id="4601815">clientHello</span><span class="op" id="4601826">.</span><span class="ident" id="4601827">supportedPoints</span>&nbsp;<span class="op" id="4601843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601847">if</span>&nbsp;<span class="ident" id="4601850">pointFormat</span>&nbsp;<span class="op" id="4601862">==</span>&nbsp;<span class="ident" id="4601865">pointFormatUncompressed</span>&nbsp;<span class="op" id="4601889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601894">supportedPointFormat</span>&nbsp;<span class="op" id="4601915">=</span>&nbsp;<span class="builtintype" id="4601917">true</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601925">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4601933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4601936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601939">hs</span><span class="op" id="4601941">.</span><span class="ident" id="4601942">ellipticOk</span>&nbsp;<span class="op" id="4601953">=</span>&nbsp;<span class="ident" id="4601955">supportedCurve</span>&nbsp;<span class="op" id="4601970">&amp;&amp;</span>&nbsp;<span class="ident" id="4601973">supportedPointFormat</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601996">foundCompression</span>&nbsp;<span class="op" id="4602013">:=</span>&nbsp;<span class="builtintype" id="4602016">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4602023">//&nbsp;We&nbsp;only&nbsp;support&nbsp;null&nbsp;compression,&nbsp;so&nbsp;check&nbsp;that&nbsp;the&nbsp;client&nbsp;offered&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602098">for</span>&nbsp;<span class="ident" id="4602102">_</span><span class="op" id="4602103">,</span>&nbsp;<span class="ident" id="4602105">compression</span>&nbsp;<span class="op" id="4602117">:=</span>&nbsp;<span class="keyword" id="4602120">range</span>&nbsp;<span class="ident" id="4602126">hs</span><span class="op" id="4602128">.</span><span class="ident" id="4602129">clientHello</span><span class="op" id="4602140">.</span><span class="ident" id="4602141">compressionMethods</span>&nbsp;<span class="op" id="4602160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602164">if</span>&nbsp;<span class="ident" id="4602167">compression</span>&nbsp;<span class="op" id="4602179">==</span>&nbsp;<span class="ident" id="4602182">compressionNone</span>&nbsp;<span class="op" id="4602198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602203">foundCompression</span>&nbsp;<span class="op" id="4602220">=</span>&nbsp;<span class="builtintype" id="4602222">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602230">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4602238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4602241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602245">if</span>&nbsp;<span class="op" id="4602248">!</span><span class="ident" id="4602249">foundCompression</span>&nbsp;<span class="op" id="4602266">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602270">c</span><span class="op" id="4602271">.</span><span class="ident" id="4602272">sendAlert</span><span class="op" id="4602281">(</span><span class="ident" id="4602282">alertHandshakeFailure</span><span class="op" id="4602303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602307">return</span>&nbsp;<span class="builtintype" id="4602314">false</span><span class="op" id="4602319">,</span>&nbsp;<span class="ident" id="4602321">errors</span><span class="op" id="4602327">.</span><span class="ident" id="4602328">New</span><span class="op" id="4602331">(</span><span class="string" id="4602332">&#34;tls:&nbsp;client&nbsp;does&nbsp;not&nbsp;support&nbsp;uncompressed&nbsp;connections&#34;</span><span class="op" id="4602387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4602390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602394">hs</span><span class="op" id="4602396">.</span><span class="ident" id="4602397">hello</span><span class="op" id="4602402">.</span><span class="ident" id="4602403">vers</span>&nbsp;<span class="op" id="4602408">=</span>&nbsp;<span class="ident" id="4602410">c</span><span class="op" id="4602411">.</span><span class="ident" id="4602412">vers</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602418">hs</span><span class="op" id="4602420">.</span><span class="ident" id="4602421">hello</span><span class="op" id="4602426">.</span><span class="ident" id="4602427">random</span>&nbsp;<span class="op" id="4602434">=</span>&nbsp;<span class="builtinfunc" id="4602436">make</span><span class="op" id="4602440">(</span><span class="op" id="4602441">[</span><span class="op" id="4602442">]</span><span class="builtintype" id="4602443">byte</span><span class="op" id="4602447">,</span>&nbsp;<span class="num" id="4602449">32</span><span class="op" id="4602451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602454">_</span><span class="op" id="4602455">,</span>&nbsp;<span class="ident" id="4602457">err</span>&nbsp;<span class="op" id="4602461">=</span>&nbsp;<span class="ident" id="4602463">io</span><span class="op" id="4602465">.</span><span class="ident" id="4602466">ReadFull</span><span class="op" id="4602474">(</span><span class="ident" id="4602475">config</span><span class="op" id="4602481">.</span><span class="ident" id="4602482">rand</span><span class="op" id="4602486">(</span><span class="op" id="4602487">)</span><span class="op" id="4602488">,</span>&nbsp;<span class="ident" id="4602490">hs</span><span class="op" id="4602492">.</span><span class="ident" id="4602493">hello</span><span class="op" id="4602498">.</span><span class="ident" id="4602499">random</span><span class="op" id="4602505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602508">if</span>&nbsp;<span class="ident" id="4602511">err</span>&nbsp;<span class="op" id="4602515">!=</span>&nbsp;<span class="ident" id="4602518">nil</span>&nbsp;<span class="op" id="4602522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602526">c</span><span class="op" id="4602527">.</span><span class="ident" id="4602528">sendAlert</span><span class="op" id="4602537">(</span><span class="ident" id="4602538">alertInternalError</span><span class="op" id="4602556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602560">return</span>&nbsp;<span class="builtintype" id="4602567">false</span><span class="op" id="4602572">,</span>&nbsp;<span class="ident" id="4602574">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4602579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602582">hs</span><span class="op" id="4602584">.</span><span class="ident" id="4602585">hello</span><span class="op" id="4602590">.</span><span class="ident" id="4602591">secureRenegotiation</span>&nbsp;<span class="op" id="4602611">=</span>&nbsp;<span class="ident" id="4602613">hs</span><span class="op" id="4602615">.</span><span class="ident" id="4602616">clientHello</span><span class="op" id="4602627">.</span><span class="ident" id="4602628">secureRenegotiation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602649">hs</span><span class="op" id="4602651">.</span><span class="ident" id="4602652">hello</span><span class="op" id="4602657">.</span><span class="ident" id="4602658">compressionMethod</span>&nbsp;<span class="op" id="4602676">=</span>&nbsp;<span class="ident" id="4602678">compressionNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602695">if</span>&nbsp;<span class="builtinfunc" id="4602698">len</span><span class="op" id="4602701">(</span><span class="ident" id="4602702">hs</span><span class="op" id="4602704">.</span><span class="ident" id="4602705">clientHello</span><span class="op" id="4602716">.</span><span class="ident" id="4602717">serverName</span><span class="op" id="4602727">)</span>&nbsp;<span class="op" id="4602729">&gt;</span>&nbsp;<span class="num" id="4602731">0</span>&nbsp;<span class="op" id="4602733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602737">c</span><span class="op" id="4602738">.</span><span class="ident" id="4602739">serverName</span>&nbsp;<span class="op" id="4602750">=</span>&nbsp;<span class="ident" id="4602752">hs</span><span class="op" id="4602754">.</span><span class="ident" id="4602755">clientHello</span><span class="op" id="4602766">.</span><span class="ident" id="4602767">serverName</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4602779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602783">if</span>&nbsp;<span class="builtinfunc" id="4602786">len</span><span class="op" id="4602789">(</span><span class="ident" id="4602790">hs</span><span class="op" id="4602792">.</span><span class="ident" id="4602793">clientHello</span><span class="op" id="4602804">.</span><span class="ident" id="4602805">alpnProtocols</span><span class="op" id="4602818">)</span>&nbsp;<span class="op" id="4602820">&gt;</span>&nbsp;<span class="num" id="4602822">0</span>&nbsp;<span class="op" id="4602824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602828">if</span>&nbsp;<span class="ident" id="4602831">selectedProto</span><span class="op" id="4602844">,</span>&nbsp;<span class="ident" id="4602846">fallback</span>&nbsp;<span class="op" id="4602855">:=</span>&nbsp;<span class="ident" id="4602858">mutualProtocol</span><span class="op" id="4602872">(</span><span class="ident" id="4602873">hs</span><span class="op" id="4602875">.</span><span class="ident" id="4602876">clientHello</span><span class="op" id="4602887">.</span><span class="ident" id="4602888">alpnProtocols</span><span class="op" id="4602901">,</span>&nbsp;<span class="ident" id="4602903">c</span><span class="op" id="4602904">.</span><span class="ident" id="4602905">config</span><span class="op" id="4602911">.</span><span class="ident" id="4602912">NextProtos</span><span class="op" id="4602922">)</span><span class="op" id="4602923">;</span>&nbsp;<span class="op" id="4602925">!</span><span class="ident" id="4602926">fallback</span>&nbsp;<span class="op" id="4602935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602940">hs</span><span class="op" id="4602942">.</span><span class="ident" id="4602943">hello</span><span class="op" id="4602948">.</span><span class="ident" id="4602949">alpnProtocol</span>&nbsp;<span class="op" id="4602962">=</span>&nbsp;<span class="ident" id="4602964">selectedProto</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602981">c</span><span class="op" id="4602982">.</span><span class="ident" id="4602983">clientProtocol</span>&nbsp;<span class="op" id="4602998">=</span>&nbsp;<span class="ident" id="4603000">selectedProto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4603016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4603019">}</span>&nbsp;<span class="keyword" id="4603021">else</span>&nbsp;<span class="op" id="4603026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4603030">//&nbsp;Although&nbsp;sending&nbsp;an&nbsp;empty&nbsp;NPN&nbsp;extension&nbsp;is&nbsp;reasonable,&nbsp;Firefox&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4603102">//&nbsp;had&nbsp;a&nbsp;bug&nbsp;around&nbsp;this.&nbsp;Best&nbsp;to&nbsp;send&nbsp;nothing&nbsp;at&nbsp;all&nbsp;if</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4603161">//&nbsp;config.NextProtos&nbsp;is&nbsp;empty.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4603198">//&nbsp;https://code.google.com/p/go/issues/detail?id=5445.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4603255">if</span>&nbsp;<span class="ident" id="4603258">hs</span><span class="op" id="4603260">.</span><span class="ident" id="4603261">clientHello</span><span class="op" id="4603272">.</span><span class="ident" id="4603273">nextProtoNeg</span>&nbsp;<span class="op" id="4603286">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4603289">len</span><span class="op" id="4603292">(</span><span class="ident" id="4603293">config</span><span class="op" id="4603299">.</span><span class="ident" id="4603300">NextProtos</span><span class="op" id="4603310">)</span>&nbsp;<span class="op" id="4603312">&gt;</span>&nbsp;<span class="num" id="4603314">0</span>&nbsp;<span class="op" id="4603316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603321">hs</span><span class="op" id="4603323">.</span><span class="ident" id="4603324">hello</span><span class="op" id="4603329">.</span><span class="ident" id="4603330">nextProtoNeg</span>&nbsp;<span class="op" id="4603343">=</span>&nbsp;<span class="builtintype" id="4603345">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603353">hs</span><span class="op" id="4603355">.</span><span class="ident" id="4603356">hello</span><span class="op" id="4603361">.</span><span class="ident" id="4603362">nextProtos</span>&nbsp;<span class="op" id="4603373">=</span>&nbsp;<span class="ident" id="4603375">config</span><span class="op" id="4603381">.</span><span class="ident" id="4603382">NextProtos</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4603395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4603398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4603402">if</span>&nbsp;<span class="builtinfunc" id="4603405">len</span><span class="op" id="4603408">(</span><span class="ident" id="4603409">config</span><span class="op" id="4603415">.</span><span class="ident" id="4603416">Certificates</span><span class="op" id="4603428">)</span>&nbsp;<span class="op" id="4603430">==</span>&nbsp;<span class="num" id="4603433">0</span>&nbsp;<span class="op" id="4603435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603439">c</span><span class="op" id="4603440">.</span><span class="ident" id="4603441">sendAlert</span><span class="op" id="4603450">(</span><span class="ident" id="4603451">alertInternalError</span><span class="op" id="4603469">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4603473">return</span>&nbsp;<span class="builtintype" id="4603480">false</span><span class="op" id="4603485">,</span>&nbsp;<span class="ident" id="4603487">errors</span><span class="op" id="4603493">.</span><span class="ident" id="4603494">New</span><span class="op" id="4603497">(</span><span class="string" id="4603498">&#34;tls:&nbsp;no&nbsp;certificates&nbsp;configured&#34;</span><span class="op" id="4603531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4603534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603537">hs</span><span class="op" id="4603539">.</span><span class="ident" id="4603540">cert</span>&nbsp;<span class="op" id="4603545">=</span>&nbsp;<span class="op" id="4603547">&amp;</span><span class="ident" id="4603548">config</span><span class="op" id="4603554">.</span><span class="ident" id="4603555">Certificates</span><span class="op" id="4603567">[</span><span class="num" id="4603568">0</span><span class="op" id="4603569">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4603572">if</span>&nbsp;<span class="builtinfunc" id="4603575">len</span><span class="op" id="4603578">(</span><span class="ident" id="4603579">hs</span><span class="op" id="4603581">.</span><span class="ident" id="4603582">clientHello</span><span class="op" id="4603593">.</span><span class="ident" id="4603594">serverName</span><span class="op" id="4603604">)</span>&nbsp;<span class="op" id="4603606">&gt;</span>&nbsp;<span class="num" id="4603608">0</span>&nbsp;<span class="op" id="4603610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603614">chi</span>&nbsp;<span class="op" id="4603618">:=</span>&nbsp;<span class="op" id="4603621">&amp;</span><span class="ident" id="4603622">ClientHelloInfo</span><span class="op" id="4603637">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603642">CipherSuites</span><span class="op" id="4603654">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4603659">hs</span><span class="op" id="4603661">.</span><span class="ident" id="4603662">clientHello</span><span class="op" id="4603673">.</span><span class="ident" id="4603674">cipherSuites</span><span class="op" id="4603686">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603691">ServerName</span><span class="op" id="4603701">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4603708">hs</span><span class="op" id="4603710">.</span><span class="ident" id="4603711">clientHello</span><span class="op" id="4603722">.</span><span class="ident" id="4603723">serverName</span><span class="op" id="4603733">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603738">SupportedCurves</span><span class="op" id="4603753">:</span>&nbsp;<span class="ident" id="4603755">hs</span><span class="op" id="4603757">.</span><span class="ident" id="4603758">clientHello</span><span class="op" id="4603769">.</span><span class="ident" id="4603770">supportedCurves</span><span class="op" id="4603785">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603790">SupportedPoints</span><span class="op" id="4603805">:</span>&nbsp;<span class="ident" id="4603807">hs</span><span class="op" id="4603809">.</span><span class="ident" id="4603810">clientHello</span><span class="op" id="4603821">.</span><span class="ident" id="4603822">supportedPoints</span><span class="op" id="4603837">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4603841">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4603845">if</span>&nbsp;<span class="ident" id="4603848">hs</span><span class="op" id="4603850">.</span><span class="ident" id="4603851">cert</span><span class="op" id="4603855">,</span>&nbsp;<span class="ident" id="4603857">err</span>&nbsp;<span class="op" id="4603861">=</span>&nbsp;<span class="ident" id="4603863">config</span><span class="op" id="4603869">.</span><span class="ident" id="4603870">getCertificate</span><span class="op" id="4603884">(</span><span class="ident" id="4603885">chi</span><span class="op" id="4603888">)</span><span class="op" id="4603889">;</span>&nbsp;<span class="ident" id="4603891">err</span>&nbsp;<span class="op" id="4603895">!=</span>&nbsp;<span class="ident" id="4603898">nil</span>&nbsp;<span class="op" id="4603902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603907">c</span><span class="op" id="4603908">.</span><span class="ident" id="4603909">sendAlert</span><span class="op" id="4603918">(</span><span class="ident" id="4603919">alertInternalError</span><span class="op" id="4603937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4603942">return</span>&nbsp;<span class="builtintype" id="4603949">false</span><span class="op" id="4603954">,</span>&nbsp;<span class="ident" id="4603956">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4603962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4603965">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603969">_</span><span class="op" id="4603970">,</span>&nbsp;<span class="ident" id="4603972">hs</span><span class="op" id="4603974">.</span><span class="ident" id="4603975">ecdsaOk</span>&nbsp;<span class="op" id="4603983">=</span>&nbsp;<span class="ident" id="4603985">hs</span><span class="op" id="4603987">.</span><span class="ident" id="4603988">cert</span><span class="op" id="4603992">.</span><span class="ident" id="4603993">PrivateKey</span><span class="op" id="4604003">.</span><span class="op" id="4604004">(</span><span class="op" id="4604005">*</span><span class="ident" id="4604006">ecdsa</span><span class="op" id="4604011">.</span><span class="ident" id="4604012">PrivateKey</span><span class="op" id="4604022">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604026">if</span>&nbsp;<span class="ident" id="4604029">hs</span><span class="op" id="4604031">.</span><span class="ident" id="4604032">checkForResumption</span><span class="op" id="4604050">(</span><span class="op" id="4604051">)</span>&nbsp;<span class="op" id="4604053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604057">return</span>&nbsp;<span class="builtintype" id="4604064">true</span><span class="op" id="4604068">,</span>&nbsp;<span class="ident" id="4604070">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4604075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604079">var</span>&nbsp;<span class="ident" id="4604083">preferenceList</span><span class="op" id="4604097">,</span>&nbsp;<span class="ident" id="4604099">supportedList</span>&nbsp;<span class="op" id="4604113">[</span><span class="op" id="4604114">]</span><span class="builtintype" id="4604115">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604123">if</span>&nbsp;<span class="ident" id="4604126">c</span><span class="op" id="4604127">.</span><span class="ident" id="4604128">config</span><span class="op" id="4604134">.</span><span class="ident" id="4604135">PreferServerCipherSuites</span>&nbsp;<span class="op" id="4604160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4604164">preferenceList</span>&nbsp;<span class="op" id="4604179">=</span>&nbsp;<span class="ident" id="4604181">c</span><span class="op" id="4604182">.</span><span class="ident" id="4604183">config</span><span class="op" id="4604189">.</span><span class="ident" id="4604190">cipherSuites</span><span class="op" id="4604202">(</span><span class="op" id="4604203">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4604207">supportedList</span>&nbsp;<span class="op" id="4604221">=</span>&nbsp;<span class="ident" id="4604223">hs</span><span class="op" id="4604225">.</span><span class="ident" id="4604226">clientHello</span><span class="op" id="4604237">.</span><span class="ident" id="4604238">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4604252">}</span>&nbsp;<span class="keyword" id="4604254">else</span>&nbsp;<span class="op" id="4604259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4604263">preferenceList</span>&nbsp;<span class="op" id="4604278">=</span>&nbsp;<span class="ident" id="4604280">hs</span><span class="op" id="4604282">.</span><span class="ident" id="4604283">clientHello</span><span class="op" id="4604294">.</span><span class="ident" id="4604295">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4604310">supportedList</span>&nbsp;<span class="op" id="4604324">=</span>&nbsp;<span class="ident" id="4604326">c</span><span class="op" id="4604327">.</span><span class="ident" id="4604328">config</span><span class="op" id="4604334">.</span><span class="ident" id="4604335">cipherSuites</span><span class="op" id="4604347">(</span><span class="op" id="4604348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4604351">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604355">for</span>&nbsp;<span class="ident" id="4604359">_</span><span class="op" id="4604360">,</span>&nbsp;<span class="ident" id="4604362">id</span>&nbsp;<span class="op" id="4604365">:=</span>&nbsp;<span class="keyword" id="4604368">range</span>&nbsp;<span class="ident" id="4604374">preferenceList</span>&nbsp;<span class="op" id="4604389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604393">if</span>&nbsp;<span class="ident" id="4604396">hs</span><span class="op" id="4604398">.</span><span class="ident" id="4604399">suite</span>&nbsp;<span class="op" id="4604405">=</span>&nbsp;<span class="ident" id="4604407">c</span><span class="op" id="4604408">.</span><span class="ident" id="4604409">tryCipherSuite</span><span class="op" id="4604423">(</span><span class="ident" id="4604424">id</span><span class="op" id="4604426">,</span>&nbsp;<span class="ident" id="4604428">supportedList</span><span class="op" id="4604441">,</span>&nbsp;<span class="ident" id="4604443">c</span><span class="op" id="4604444">.</span><span class="ident" id="4604445">vers</span><span class="op" id="4604449">,</span>&nbsp;<span class="ident" id="4604451">hs</span><span class="op" id="4604453">.</span><span class="ident" id="4604454">ellipticOk</span><span class="op" id="4604464">,</span>&nbsp;<span class="ident" id="4604466">hs</span><span class="op" id="4604468">.</span><span class="ident" id="4604469">ecdsaOk</span><span class="op" id="4604476">)</span><span class="op" id="4604477">;</span>&nbsp;<span class="ident" id="4604479">hs</span><span class="op" id="4604481">.</span><span class="ident" id="4604482">suite</span>&nbsp;<span class="op" id="4604488">!=</span>&nbsp;<span class="ident" id="4604491">nil</span>&nbsp;<span class="op" id="4604495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604500">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4604508">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4604511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604515">if</span>&nbsp;<span class="ident" id="4604518">hs</span><span class="op" id="4604520">.</span><span class="ident" id="4604521">suite</span>&nbsp;<span class="op" id="4604527">==</span>&nbsp;<span class="ident" id="4604530">nil</span>&nbsp;<span class="op" id="4604534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4604538">c</span><span class="op" id="4604539">.</span><span class="ident" id="4604540">sendAlert</span><span class="op" id="4604549">(</span><span class="ident" id="4604550">alertHandshakeFailure</span><span class="op" id="4604571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604575">return</span>&nbsp;<span class="builtintype" id="4604582">false</span><span class="op" id="4604587">,</span>&nbsp;<span class="ident" id="4604589">errors</span><span class="op" id="4604595">.</span><span class="ident" id="4604596">New</span><span class="op" id="4604599">(</span><span class="string" id="4604600">&#34;tls:&nbsp;no&nbsp;cipher&nbsp;suite&nbsp;supported&nbsp;by&nbsp;both&nbsp;client&nbsp;and&nbsp;server&#34;</span><span class="op" id="4604658">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4604661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4604665">//&nbsp;See&nbsp;https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604735">for</span>&nbsp;<span class="ident" id="4604739">_</span><span class="op" id="4604740">,</span>&nbsp;<span class="ident" id="4604742">id</span>&nbsp;<span class="op" id="4604745">:=</span>&nbsp;<span class="keyword" id="4604748">range</span>&nbsp;<span class="ident" id="4604754">hs</span><span class="op" id="4604756">.</span><span class="ident" id="4604757">clientHello</span><span class="op" id="4604768">.</span><span class="ident" id="4604769">cipherSuites</span>&nbsp;<span class="op" id="4604782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604786">if</span>&nbsp;<span class="ident" id="4604789">id</span>&nbsp;<span class="op" id="4604792">==</span>&nbsp;<span class="ident" id="4604795">TLS_FALLBACK_SCSV</span>&nbsp;<span class="op" id="4604813">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4604818">//&nbsp;The&nbsp;client&nbsp;is&nbsp;doing&nbsp;a&nbsp;fallback&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604867">if</span>&nbsp;<span class="ident" id="4604870">hs</span><span class="op" id="4604872">.</span><span class="ident" id="4604873">clientHello</span><span class="op" id="4604884">.</span><span class="ident" id="4604885">vers</span>&nbsp;<span class="op" id="4604890">&lt;</span>&nbsp;<span class="ident" id="4604892">c</span><span class="op" id="4604893">.</span><span class="ident" id="4604894">config</span><span class="op" id="4604900">.</span><span class="ident" id="4604901">MaxVersion</span>&nbsp;<span class="op" id="4604912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4604918">c</span><span class="op" id="4604919">.</span><span class="ident" id="4604920">sendAlert</span><span class="op" id="4604929">(</span><span class="ident" id="4604930">alertInappropriateFallback</span><span class="op" id="4604956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604962">return</span>&nbsp;<span class="builtintype" id="4604969">false</span><span class="op" id="4604974">,</span>&nbsp;<span class="ident" id="4604976">errors</span><span class="op" id="4604982">.</span><span class="ident" id="4604983">New</span><span class="op" id="4604986">(</span><span class="string" id="4604987">&#34;tls:&nbsp;client&nbsp;using&nbsp;inppropriate&nbsp;protocol&nbsp;fallback&#34;</span><span class="op" id="4605037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605042">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605047">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605062">return</span>&nbsp;<span class="builtintype" id="4605069">false</span><span class="op" id="4605074">,</span>&nbsp;<span class="ident" id="4605076">nil</span><br>
<span class="lineno">240</span><span class="op" id="4605080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4605083">//&nbsp;checkForResumption&nbsp;returns&nbsp;true&nbsp;if&nbsp;we&nbsp;should&nbsp;perform&nbsp;resumption&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4605170">func</span>&nbsp;<span class="op" id="4605175">(</span><span class="ident" id="4605176">hs</span>&nbsp;<span class="op" id="4605179">*</span><span class="ident" id="4605180">serverHandshakeState</span><span class="op" id="4605200">)</span>&nbsp;<span class="ident" id="4605202">checkForResumption</span><span class="op" id="4605220">(</span><span class="op" id="4605221">)</span>&nbsp;<span class="builtintype" id="4605223">bool</span>&nbsp;<span class="op" id="4605228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4605231">c</span>&nbsp;<span class="op" id="4605233">:=</span>&nbsp;<span class="ident" id="4605236">hs</span><span class="op" id="4605238">.</span><span class="ident" id="4605239">c</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605243">if</span>&nbsp;<span class="ident" id="4605246">c</span><span class="op" id="4605247">.</span><span class="ident" id="4605248">config</span><span class="op" id="4605254">.</span><span class="ident" id="4605255">SessionTicketsDisabled</span>&nbsp;<span class="op" id="4605278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605282">return</span>&nbsp;<span class="builtintype" id="4605289">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605300">var</span>&nbsp;<span class="ident" id="4605304">ok</span>&nbsp;<span class="builtintype" id="4605307">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605313">if</span>&nbsp;<span class="ident" id="4605316">hs</span><span class="op" id="4605318">.</span><span class="ident" id="4605319">sessionState</span><span class="op" id="4605331">,</span>&nbsp;<span class="ident" id="4605333">ok</span>&nbsp;<span class="op" id="4605336">=</span>&nbsp;<span class="ident" id="4605338">c</span><span class="op" id="4605339">.</span><span class="ident" id="4605340">decryptTicket</span><span class="op" id="4605353">(</span><span class="ident" id="4605354">hs</span><span class="op" id="4605356">.</span><span class="ident" id="4605357">clientHello</span><span class="op" id="4605368">.</span><span class="ident" id="4605369">sessionTicket</span><span class="op" id="4605382">)</span><span class="op" id="4605383">;</span>&nbsp;<span class="op" id="4605385">!</span><span class="ident" id="4605386">ok</span>&nbsp;<span class="op" id="4605389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605393">return</span>&nbsp;<span class="builtintype" id="4605400">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605411">if</span>&nbsp;<span class="ident" id="4605414">hs</span><span class="op" id="4605416">.</span><span class="ident" id="4605417">sessionState</span><span class="op" id="4605429">.</span><span class="ident" id="4605430">vers</span>&nbsp;<span class="op" id="4605435">&gt;</span>&nbsp;<span class="ident" id="4605437">hs</span><span class="op" id="4605439">.</span><span class="ident" id="4605440">clientHello</span><span class="op" id="4605451">.</span><span class="ident" id="4605452">vers</span>&nbsp;<span class="op" id="4605457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605461">return</span>&nbsp;<span class="builtintype" id="4605468">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605478">if</span>&nbsp;<span class="ident" id="4605481">vers</span><span class="op" id="4605485">,</span>&nbsp;<span class="ident" id="4605487">ok</span>&nbsp;<span class="op" id="4605490">:=</span>&nbsp;<span class="ident" id="4605493">c</span><span class="op" id="4605494">.</span><span class="ident" id="4605495">config</span><span class="op" id="4605501">.</span><span class="ident" id="4605502">mutualVersion</span><span class="op" id="4605515">(</span><span class="ident" id="4605516">hs</span><span class="op" id="4605518">.</span><span class="ident" id="4605519">sessionState</span><span class="op" id="4605531">.</span><span class="ident" id="4605532">vers</span><span class="op" id="4605536">)</span><span class="op" id="4605537">;</span>&nbsp;<span class="op" id="4605539">!</span><span class="ident" id="4605540">ok</span>&nbsp;<span class="op" id="4605543">||</span>&nbsp;<span class="ident" id="4605546">vers</span>&nbsp;<span class="op" id="4605551">!=</span>&nbsp;<span class="ident" id="4605554">hs</span><span class="op" id="4605556">.</span><span class="ident" id="4605557">sessionState</span><span class="op" id="4605569">.</span><span class="ident" id="4605570">vers</span>&nbsp;<span class="op" id="4605575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605579">return</span>&nbsp;<span class="builtintype" id="4605586">false</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4605597">cipherSuiteOk</span>&nbsp;<span class="op" id="4605611">:=</span>&nbsp;<span class="builtintype" id="4605614">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4605621">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;still&nbsp;offering&nbsp;the&nbsp;ciphersuite&nbsp;in&nbsp;the&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605697">for</span>&nbsp;<span class="ident" id="4605701">_</span><span class="op" id="4605702">,</span>&nbsp;<span class="ident" id="4605704">id</span>&nbsp;<span class="op" id="4605707">:=</span>&nbsp;<span class="keyword" id="4605710">range</span>&nbsp;<span class="ident" id="4605716">hs</span><span class="op" id="4605718">.</span><span class="ident" id="4605719">clientHello</span><span class="op" id="4605730">.</span><span class="ident" id="4605731">cipherSuites</span>&nbsp;<span class="op" id="4605744">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605748">if</span>&nbsp;<span class="ident" id="4605751">id</span>&nbsp;<span class="op" id="4605754">==</span>&nbsp;<span class="ident" id="4605757">hs</span><span class="op" id="4605759">.</span><span class="ident" id="4605760">sessionState</span><span class="op" id="4605772">.</span><span class="ident" id="4605773">cipherSuite</span>&nbsp;<span class="op" id="4605785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4605790">cipherSuiteOk</span>&nbsp;<span class="op" id="4605804">=</span>&nbsp;<span class="builtintype" id="4605806">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605814">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605825">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605828">if</span>&nbsp;<span class="op" id="4605831">!</span><span class="ident" id="4605832">cipherSuiteOk</span>&nbsp;<span class="op" id="4605846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605850">return</span>&nbsp;<span class="builtintype" id="4605857">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4605868">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;also&nbsp;support&nbsp;the&nbsp;ciphersuite&nbsp;from&nbsp;the&nbsp;session.</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4605933">hs</span><span class="op" id="4605935">.</span><span class="ident" id="4605936">suite</span>&nbsp;<span class="op" id="4605942">=</span>&nbsp;<span class="ident" id="4605944">c</span><span class="op" id="4605945">.</span><span class="ident" id="4605946">tryCipherSuite</span><span class="op" id="4605960">(</span><span class="ident" id="4605961">hs</span><span class="op" id="4605963">.</span><span class="ident" id="4605964">sessionState</span><span class="op" id="4605976">.</span><span class="ident" id="4605977">cipherSuite</span><span class="op" id="4605988">,</span>&nbsp;<span class="ident" id="4605990">c</span><span class="op" id="4605991">.</span><span class="ident" id="4605992">config</span><span class="op" id="4605998">.</span><span class="ident" id="4605999">cipherSuites</span><span class="op" id="4606011">(</span><span class="op" id="4606012">)</span><span class="op" id="4606013">,</span>&nbsp;<span class="ident" id="4606015">hs</span><span class="op" id="4606017">.</span><span class="ident" id="4606018">sessionState</span><span class="op" id="4606030">.</span><span class="ident" id="4606031">vers</span><span class="op" id="4606035">,</span>&nbsp;<span class="ident" id="4606037">hs</span><span class="op" id="4606039">.</span><span class="ident" id="4606040">ellipticOk</span><span class="op" id="4606050">,</span>&nbsp;<span class="ident" id="4606052">hs</span><span class="op" id="4606054">.</span><span class="ident" id="4606055">ecdsaOk</span><span class="op" id="4606062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606065">if</span>&nbsp;<span class="ident" id="4606068">hs</span><span class="op" id="4606070">.</span><span class="ident" id="4606071">suite</span>&nbsp;<span class="op" id="4606077">==</span>&nbsp;<span class="ident" id="4606080">nil</span>&nbsp;<span class="op" id="4606084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606088">return</span>&nbsp;<span class="builtintype" id="4606095">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4606102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4606106">sessionHasClientCerts</span>&nbsp;<span class="op" id="4606128">:=</span>&nbsp;<span class="builtinfunc" id="4606131">len</span><span class="op" id="4606134">(</span><span class="ident" id="4606135">hs</span><span class="op" id="4606137">.</span><span class="ident" id="4606138">sessionState</span><span class="op" id="4606150">.</span><span class="ident" id="4606151">certificates</span><span class="op" id="4606163">)</span>&nbsp;<span class="op" id="4606165">!=</span>&nbsp;<span class="num" id="4606168">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4606171">needClientCerts</span>&nbsp;<span class="op" id="4606187">:=</span>&nbsp;<span class="ident" id="4606190">c</span><span class="op" id="4606191">.</span><span class="ident" id="4606192">config</span><span class="op" id="4606198">.</span><span class="ident" id="4606199">ClientAuth</span>&nbsp;<span class="op" id="4606210">==</span>&nbsp;<span class="ident" id="4606213">RequireAnyClientCert</span>&nbsp;<span class="op" id="4606234">||</span>&nbsp;<span class="ident" id="4606237">c</span><span class="op" id="4606238">.</span><span class="ident" id="4606239">config</span><span class="op" id="4606245">.</span><span class="ident" id="4606246">ClientAuth</span>&nbsp;<span class="op" id="4606257">==</span>&nbsp;<span class="ident" id="4606260">RequireAndVerifyClientCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606288">if</span>&nbsp;<span class="ident" id="4606291">needClientCerts</span>&nbsp;<span class="op" id="4606307">&amp;&amp;</span>&nbsp;<span class="op" id="4606310">!</span><span class="ident" id="4606311">sessionHasClientCerts</span>&nbsp;<span class="op" id="4606333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606337">return</span>&nbsp;<span class="builtintype" id="4606344">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4606351">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606354">if</span>&nbsp;<span class="ident" id="4606357">sessionHasClientCerts</span>&nbsp;<span class="op" id="4606379">&amp;&amp;</span>&nbsp;<span class="ident" id="4606382">c</span><span class="op" id="4606383">.</span><span class="ident" id="4606384">config</span><span class="op" id="4606390">.</span><span class="ident" id="4606391">ClientAuth</span>&nbsp;<span class="op" id="4606402">==</span>&nbsp;<span class="ident" id="4606405">NoClientCert</span>&nbsp;<span class="op" id="4606418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606422">return</span>&nbsp;<span class="builtintype" id="4606429">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4606436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606440">return</span>&nbsp;<span class="builtintype" id="4606447">true</span><br>
<span class="lineno">290</span><span class="op" id="4606452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4606455">func</span>&nbsp;<span class="op" id="4606460">(</span><span class="ident" id="4606461">hs</span>&nbsp;<span class="op" id="4606464">*</span><span class="ident" id="4606465">serverHandshakeState</span><span class="op" id="4606485">)</span>&nbsp;<span class="ident" id="4606487">doResumeHandshake</span><span class="op" id="4606504">(</span><span class="op" id="4606505">)</span>&nbsp;<span class="builtintype" id="4606507">error</span>&nbsp;<span class="op" id="4606513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4606516">c</span>&nbsp;<span class="op" id="4606518">:=</span>&nbsp;<span class="ident" id="4606521">hs</span><span class="op" id="4606523">.</span><span class="ident" id="4606524">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4606528">hs</span><span class="op" id="4606530">.</span><span class="ident" id="4606531">hello</span><span class="op" id="4606536">.</span><span class="ident" id="4606537">cipherSuite</span>&nbsp;<span class="op" id="4606549">=</span>&nbsp;<span class="ident" id="4606551">hs</span><span class="op" id="4606553">.</span><span class="ident" id="4606554">suite</span><span class="op" id="4606559">.</span><span class="ident" id="4606560">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606564">//&nbsp;We&nbsp;echo&nbsp;the&nbsp;client&#39;s&nbsp;session&nbsp;ID&nbsp;in&nbsp;the&nbsp;ServerHello&nbsp;to&nbsp;let&nbsp;it&nbsp;know</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606634">//&nbsp;that&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;resumption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4606669">hs</span><span class="op" id="4606671">.</span><span class="ident" id="4606672">hello</span><span class="op" id="4606677">.</span><span class="ident" id="4606678">sessionId</span>&nbsp;<span class="op" id="4606688">=</span>&nbsp;<span class="ident" id="4606690">hs</span><span class="op" id="4606692">.</span><span class="ident" id="4606693">clientHello</span><span class="op" id="4606704">.</span><span class="ident" id="4606705">sessionId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4606716">hs</span><span class="op" id="4606718">.</span><span class="ident" id="4606719">finishedHash</span><span class="op" id="4606731">.</span><span class="ident" id="4606732">Write</span><span class="op" id="4606737">(</span><span class="ident" id="4606738">hs</span><span class="op" id="4606740">.</span><span class="ident" id="4606741">hello</span><span class="op" id="4606746">.</span><span class="ident" id="4606747">marshal</span><span class="op" id="4606754">(</span><span class="op" id="4606755">)</span><span class="op" id="4606756">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4606759">c</span><span class="op" id="4606760">.</span><span class="ident" id="4606761">writeRecord</span><span class="op" id="4606772">(</span><span class="ident" id="4606773">recordTypeHandshake</span><span class="op" id="4606792">,</span>&nbsp;<span class="ident" id="4606794">hs</span><span class="op" id="4606796">.</span><span class="ident" id="4606797">hello</span><span class="op" id="4606802">.</span><span class="ident" id="4606803">marshal</span><span class="op" id="4606810">(</span><span class="op" id="4606811">)</span><span class="op" id="4606812">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606816">if</span>&nbsp;<span class="builtinfunc" id="4606819">len</span><span class="op" id="4606822">(</span><span class="ident" id="4606823">hs</span><span class="op" id="4606825">.</span><span class="ident" id="4606826">sessionState</span><span class="op" id="4606838">.</span><span class="ident" id="4606839">certificates</span><span class="op" id="4606851">)</span>&nbsp;<span class="op" id="4606853">&gt;</span>&nbsp;<span class="num" id="4606855">0</span>&nbsp;<span class="op" id="4606857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606861">if</span>&nbsp;<span class="ident" id="4606864">_</span><span class="op" id="4606865">,</span>&nbsp;<span class="ident" id="4606867">err</span>&nbsp;<span class="op" id="4606871">:=</span>&nbsp;<span class="ident" id="4606874">hs</span><span class="op" id="4606876">.</span><span class="ident" id="4606877">processCertsFromClient</span><span class="op" id="4606899">(</span><span class="ident" id="4606900">hs</span><span class="op" id="4606902">.</span><span class="ident" id="4606903">sessionState</span><span class="op" id="4606915">.</span><span class="ident" id="4606916">certificates</span><span class="op" id="4606928">)</span><span class="op" id="4606929">;</span>&nbsp;<span class="ident" id="4606931">err</span>&nbsp;<span class="op" id="4606935">!=</span>&nbsp;<span class="ident" id="4606938">nil</span>&nbsp;<span class="op" id="4606942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606947">return</span>&nbsp;<span class="ident" id="4606954">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4606960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4606963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4606967">hs</span><span class="op" id="4606969">.</span><span class="ident" id="4606970">masterSecret</span>&nbsp;<span class="op" id="4606983">=</span>&nbsp;<span class="ident" id="4606985">hs</span><span class="op" id="4606987">.</span><span class="ident" id="4606988">sessionState</span><span class="op" id="4607000">.</span><span class="ident" id="4607001">masterSecret</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4607016">return</span>&nbsp;<span class="ident" id="4607023">nil</span><br>
<span class="lineno"></span><span class="op" id="4607027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4607030">func</span>&nbsp;<span class="op" id="4607035">(</span><span class="ident" id="4607036">hs</span>&nbsp;<span class="op" id="4607039">*</span><span class="ident" id="4607040">serverHandshakeState</span><span class="op" id="4607060">)</span>&nbsp;<span class="ident" id="4607062">doFullHandshake</span><span class="op" id="4607077">(</span><span class="op" id="4607078">)</span>&nbsp;<span class="builtintype" id="4607080">error</span>&nbsp;<span class="op" id="4607086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607089">config</span>&nbsp;<span class="op" id="4607096">:=</span>&nbsp;<span class="ident" id="4607099">hs</span><span class="op" id="4607101">.</span><span class="ident" id="4607102">c</span><span class="op" id="4607103">.</span><span class="ident" id="4607104">config</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607112">c</span>&nbsp;<span class="op" id="4607114">:=</span>&nbsp;<span class="ident" id="4607117">hs</span><span class="op" id="4607119">.</span><span class="ident" id="4607120">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4607124">if</span>&nbsp;<span class="ident" id="4607127">hs</span><span class="op" id="4607129">.</span><span class="ident" id="4607130">clientHello</span><span class="op" id="4607141">.</span><span class="ident" id="4607142">ocspStapling</span>&nbsp;<span class="op" id="4607155">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4607158">len</span><span class="op" id="4607161">(</span><span class="ident" id="4607162">hs</span><span class="op" id="4607164">.</span><span class="ident" id="4607165">cert</span><span class="op" id="4607169">.</span><span class="ident" id="4607170">OCSPStaple</span><span class="op" id="4607180">)</span>&nbsp;<span class="op" id="4607182">&gt;</span>&nbsp;<span class="num" id="4607184">0</span>&nbsp;<span class="op" id="4607186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607190">hs</span><span class="op" id="4607192">.</span><span class="ident" id="4607193">hello</span><span class="op" id="4607198">.</span><span class="ident" id="4607199">ocspStapling</span>&nbsp;<span class="op" id="4607212">=</span>&nbsp;<span class="builtintype" id="4607214">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4607220">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607224">hs</span><span class="op" id="4607226">.</span><span class="ident" id="4607227">hello</span><span class="op" id="4607232">.</span><span class="ident" id="4607233">ticketSupported</span>&nbsp;<span class="op" id="4607249">=</span>&nbsp;<span class="ident" id="4607251">hs</span><span class="op" id="4607253">.</span><span class="ident" id="4607254">clientHello</span><span class="op" id="4607265">.</span><span class="ident" id="4607266">ticketSupported</span>&nbsp;<span class="op" id="4607282">&amp;&amp;</span>&nbsp;<span class="op" id="4607285">!</span><span class="ident" id="4607286">config</span><span class="op" id="4607292">.</span><span class="ident" id="4607293">SessionTicketsDisabled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607317">hs</span><span class="op" id="4607319">.</span><span class="ident" id="4607320">hello</span><span class="op" id="4607325">.</span><span class="ident" id="4607326">cipherSuite</span>&nbsp;<span class="op" id="4607338">=</span>&nbsp;<span class="ident" id="4607340">hs</span><span class="op" id="4607342">.</span><span class="ident" id="4607343">suite</span><span class="op" id="4607348">.</span><span class="ident" id="4607349">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607353">hs</span><span class="op" id="4607355">.</span><span class="ident" id="4607356">finishedHash</span><span class="op" id="4607368">.</span><span class="ident" id="4607369">Write</span><span class="op" id="4607374">(</span><span class="ident" id="4607375">hs</span><span class="op" id="4607377">.</span><span class="ident" id="4607378">hello</span><span class="op" id="4607383">.</span><span class="ident" id="4607384">marshal</span><span class="op" id="4607391">(</span><span class="op" id="4607392">)</span><span class="op" id="4607393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607396">c</span><span class="op" id="4607397">.</span><span class="ident" id="4607398">writeRecord</span><span class="op" id="4607409">(</span><span class="ident" id="4607410">recordTypeHandshake</span><span class="op" id="4607429">,</span>&nbsp;<span class="ident" id="4607431">hs</span><span class="op" id="4607433">.</span><span class="ident" id="4607434">hello</span><span class="op" id="4607439">.</span><span class="ident" id="4607440">marshal</span><span class="op" id="4607447">(</span><span class="op" id="4607448">)</span><span class="op" id="4607449">)</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607453">certMsg</span>&nbsp;<span class="op" id="4607461">:=</span>&nbsp;<span class="builtinfunc" id="4607464">new</span><span class="op" id="4607467">(</span><span class="ident" id="4607468">certificateMsg</span><span class="op" id="4607482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607485">certMsg</span><span class="op" id="4607492">.</span><span class="ident" id="4607493">certificates</span>&nbsp;<span class="op" id="4607506">=</span>&nbsp;<span class="ident" id="4607508">hs</span><span class="op" id="4607510">.</span><span class="ident" id="4607511">cert</span><span class="op" id="4607515">.</span><span class="ident" id="4607516">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607529">hs</span><span class="op" id="4607531">.</span><span class="ident" id="4607532">finishedHash</span><span class="op" id="4607544">.</span><span class="ident" id="4607545">Write</span><span class="op" id="4607550">(</span><span class="ident" id="4607551">certMsg</span><span class="op" id="4607558">.</span><span class="ident" id="4607559">marshal</span><span class="op" id="4607566">(</span><span class="op" id="4607567">)</span><span class="op" id="4607568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607571">c</span><span class="op" id="4607572">.</span><span class="ident" id="4607573">writeRecord</span><span class="op" id="4607584">(</span><span class="ident" id="4607585">recordTypeHandshake</span><span class="op" id="4607604">,</span>&nbsp;<span class="ident" id="4607606">certMsg</span><span class="op" id="4607613">.</span><span class="ident" id="4607614">marshal</span><span class="op" id="4607621">(</span><span class="op" id="4607622">)</span><span class="op" id="4607623">)</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4607627">if</span>&nbsp;<span class="ident" id="4607630">hs</span><span class="op" id="4607632">.</span><span class="ident" id="4607633">hello</span><span class="op" id="4607638">.</span><span class="ident" id="4607639">ocspStapling</span>&nbsp;<span class="op" id="4607652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607656">certStatus</span>&nbsp;<span class="op" id="4607667">:=</span>&nbsp;<span class="builtinfunc" id="4607670">new</span><span class="op" id="4607673">(</span><span class="ident" id="4607674">certificateStatusMsg</span><span class="op" id="4607694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607698">certStatus</span><span class="op" id="4607708">.</span><span class="ident" id="4607709">statusType</span>&nbsp;<span class="op" id="4607720">=</span>&nbsp;<span class="ident" id="4607722">statusTypeOCSP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607739">certStatus</span><span class="op" id="4607749">.</span><span class="ident" id="4607750">response</span>&nbsp;<span class="op" id="4607759">=</span>&nbsp;<span class="ident" id="4607761">hs</span><span class="op" id="4607763">.</span><span class="ident" id="4607764">cert</span><span class="op" id="4607768">.</span><span class="ident" id="4607769">OCSPStaple</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607782">hs</span><span class="op" id="4607784">.</span><span class="ident" id="4607785">finishedHash</span><span class="op" id="4607797">.</span><span class="ident" id="4607798">Write</span><span class="op" id="4607803">(</span><span class="ident" id="4607804">certStatus</span><span class="op" id="4607814">.</span><span class="ident" id="4607815">marshal</span><span class="op" id="4607822">(</span><span class="op" id="4607823">)</span><span class="op" id="4607824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607828">c</span><span class="op" id="4607829">.</span><span class="ident" id="4607830">writeRecord</span><span class="op" id="4607841">(</span><span class="ident" id="4607842">recordTypeHandshake</span><span class="op" id="4607861">,</span>&nbsp;<span class="ident" id="4607863">certStatus</span><span class="op" id="4607873">.</span><span class="ident" id="4607874">marshal</span><span class="op" id="4607881">(</span><span class="op" id="4607882">)</span><span class="op" id="4607883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4607886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607890">keyAgreement</span>&nbsp;<span class="op" id="4607903">:=</span>&nbsp;<span class="ident" id="4607906">hs</span><span class="op" id="4607908">.</span><span class="ident" id="4607909">suite</span><span class="op" id="4607914">.</span><span class="ident" id="4607915">ka</span><span class="op" id="4607917">(</span><span class="ident" id="4607918">c</span><span class="op" id="4607919">.</span><span class="ident" id="4607920">vers</span><span class="op" id="4607924">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607927">skx</span><span class="op" id="4607930">,</span>&nbsp;<span class="ident" id="4607932">err</span>&nbsp;<span class="op" id="4607936">:=</span>&nbsp;<span class="ident" id="4607939">keyAgreement</span><span class="op" id="4607951">.</span><span class="ident" id="4607952">generateServerKeyExchange</span><span class="op" id="4607977">(</span><span class="ident" id="4607978">config</span><span class="op" id="4607984">,</span>&nbsp;<span class="ident" id="4607986">hs</span><span class="op" id="4607988">.</span><span class="ident" id="4607989">cert</span><span class="op" id="4607993">,</span>&nbsp;<span class="ident" id="4607995">hs</span><span class="op" id="4607997">.</span><span class="ident" id="4607998">clientHello</span><span class="op" id="4608009">,</span>&nbsp;<span class="ident" id="4608011">hs</span><span class="op" id="4608013">.</span><span class="ident" id="4608014">hello</span><span class="op" id="4608019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608022">if</span>&nbsp;<span class="ident" id="4608025">err</span>&nbsp;<span class="op" id="4608029">!=</span>&nbsp;<span class="ident" id="4608032">nil</span>&nbsp;<span class="op" id="4608036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608040">c</span><span class="op" id="4608041">.</span><span class="ident" id="4608042">sendAlert</span><span class="op" id="4608051">(</span><span class="ident" id="4608052">alertHandshakeFailure</span><span class="op" id="4608073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608077">return</span>&nbsp;<span class="ident" id="4608084">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4608089">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608092">if</span>&nbsp;<span class="ident" id="4608095">skx</span>&nbsp;<span class="op" id="4608099">!=</span>&nbsp;<span class="ident" id="4608102">nil</span>&nbsp;<span class="op" id="4608106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608110">hs</span><span class="op" id="4608112">.</span><span class="ident" id="4608113">finishedHash</span><span class="op" id="4608125">.</span><span class="ident" id="4608126">Write</span><span class="op" id="4608131">(</span><span class="ident" id="4608132">skx</span><span class="op" id="4608135">.</span><span class="ident" id="4608136">marshal</span><span class="op" id="4608143">(</span><span class="op" id="4608144">)</span><span class="op" id="4608145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608149">c</span><span class="op" id="4608150">.</span><span class="ident" id="4608151">writeRecord</span><span class="op" id="4608162">(</span><span class="ident" id="4608163">recordTypeHandshake</span><span class="op" id="4608182">,</span>&nbsp;<span class="ident" id="4608184">skx</span><span class="op" id="4608187">.</span><span class="ident" id="4608188">marshal</span><span class="op" id="4608195">(</span><span class="op" id="4608196">)</span><span class="op" id="4608197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4608200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608204">if</span>&nbsp;<span class="ident" id="4608207">config</span><span class="op" id="4608213">.</span><span class="ident" id="4608214">ClientAuth</span>&nbsp;<span class="op" id="4608225">&gt;=</span>&nbsp;<span class="ident" id="4608228">RequestClientCert</span>&nbsp;<span class="op" id="4608246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4608250">//&nbsp;Request&nbsp;a&nbsp;client&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608284">certReq</span>&nbsp;<span class="op" id="4608292">:=</span>&nbsp;<span class="builtinfunc" id="4608295">new</span><span class="op" id="4608298">(</span><span class="ident" id="4608299">certificateRequestMsg</span><span class="op" id="4608320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608324">certReq</span><span class="op" id="4608331">.</span><span class="ident" id="4608332">certificateTypes</span>&nbsp;<span class="op" id="4608349">=</span>&nbsp;<span class="op" id="4608351">[</span><span class="op" id="4608352">]</span><span class="builtintype" id="4608353">byte</span><span class="op" id="4608357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4608362">byte</span><span class="op" id="4608366">(</span><span class="ident" id="4608367">certTypeRSASign</span><span class="op" id="4608382">)</span><span class="op" id="4608383">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4608388">byte</span><span class="op" id="4608392">(</span><span class="ident" id="4608393">certTypeECDSASign</span><span class="op" id="4608410">)</span><span class="op" id="4608411">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4608415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608419">if</span>&nbsp;<span class="ident" id="4608422">c</span><span class="op" id="4608423">.</span><span class="ident" id="4608424">vers</span>&nbsp;<span class="op" id="4608429">&gt;=</span>&nbsp;<span class="ident" id="4608432">VersionTLS12</span>&nbsp;<span class="op" id="4608445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608450">certReq</span><span class="op" id="4608457">.</span><span class="ident" id="4608458">hasSignatureAndHash</span>&nbsp;<span class="op" id="4608478">=</span>&nbsp;<span class="builtintype" id="4608480">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608488">certReq</span><span class="op" id="4608495">.</span><span class="ident" id="4608496">signatureAndHashes</span>&nbsp;<span class="op" id="4608515">=</span>&nbsp;<span class="ident" id="4608517">supportedClientCertSignatureAlgorithms</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4608558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4608563">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;of&nbsp;certificateAuthorities&nbsp;signals&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4608619">//&nbsp;the&nbsp;client&nbsp;that&nbsp;it&nbsp;may&nbsp;send&nbsp;any&nbsp;certificate&nbsp;in&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4608680">//&nbsp;to&nbsp;our&nbsp;request.&nbsp;When&nbsp;we&nbsp;know&nbsp;the&nbsp;CAs&nbsp;we&nbsp;trust,&nbsp;then</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4608737">//&nbsp;we&nbsp;can&nbsp;send&nbsp;them&nbsp;down,&nbsp;so&nbsp;that&nbsp;the&nbsp;client&nbsp;can&nbsp;choose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4608795">//&nbsp;an&nbsp;appropriate&nbsp;certificate&nbsp;to&nbsp;give&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608842">if</span>&nbsp;<span class="ident" id="4608845">config</span><span class="op" id="4608851">.</span><span class="ident" id="4608852">ClientCAs</span>&nbsp;<span class="op" id="4608862">!=</span>&nbsp;<span class="ident" id="4608865">nil</span>&nbsp;<span class="op" id="4608869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608874">certReq</span><span class="op" id="4608881">.</span><span class="ident" id="4608882">certificateAuthorities</span>&nbsp;<span class="op" id="4608905">=</span>&nbsp;<span class="ident" id="4608907">config</span><span class="op" id="4608913">.</span><span class="ident" id="4608914">ClientCAs</span><span class="op" id="4608923">.</span><span class="ident" id="4608924">Subjects</span><span class="op" id="4608932">(</span><span class="op" id="4608933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4608937">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608941">hs</span><span class="op" id="4608943">.</span><span class="ident" id="4608944">finishedHash</span><span class="op" id="4608956">.</span><span class="ident" id="4608957">Write</span><span class="op" id="4608962">(</span><span class="ident" id="4608963">certReq</span><span class="op" id="4608970">.</span><span class="ident" id="4608971">marshal</span><span class="op" id="4608978">(</span><span class="op" id="4608979">)</span><span class="op" id="4608980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608984">c</span><span class="op" id="4608985">.</span><span class="ident" id="4608986">writeRecord</span><span class="op" id="4608997">(</span><span class="ident" id="4608998">recordTypeHandshake</span><span class="op" id="4609017">,</span>&nbsp;<span class="ident" id="4609019">certReq</span><span class="op" id="4609026">.</span><span class="ident" id="4609027">marshal</span><span class="op" id="4609034">(</span><span class="op" id="4609035">)</span><span class="op" id="4609036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4609039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609043">helloDone</span>&nbsp;<span class="op" id="4609053">:=</span>&nbsp;<span class="builtinfunc" id="4609056">new</span><span class="op" id="4609059">(</span><span class="ident" id="4609060">serverHelloDoneMsg</span><span class="op" id="4609078">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609081">hs</span><span class="op" id="4609083">.</span><span class="ident" id="4609084">finishedHash</span><span class="op" id="4609096">.</span><span class="ident" id="4609097">Write</span><span class="op" id="4609102">(</span><span class="ident" id="4609103">helloDone</span><span class="op" id="4609112">.</span><span class="ident" id="4609113">marshal</span><span class="op" id="4609120">(</span><span class="op" id="4609121">)</span><span class="op" id="4609122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609125">c</span><span class="op" id="4609126">.</span><span class="ident" id="4609127">writeRecord</span><span class="op" id="4609138">(</span><span class="ident" id="4609139">recordTypeHandshake</span><span class="op" id="4609158">,</span>&nbsp;<span class="ident" id="4609160">helloDone</span><span class="op" id="4609169">.</span><span class="ident" id="4609170">marshal</span><span class="op" id="4609177">(</span><span class="op" id="4609178">)</span><span class="op" id="4609179">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609183">var</span>&nbsp;<span class="ident" id="4609187">pub</span>&nbsp;<span class="ident" id="4609191">crypto</span><span class="op" id="4609197">.</span><span class="ident" id="4609198">PublicKey</span>&nbsp;<span class="comment" id="4609208">//&nbsp;public&nbsp;key&nbsp;for&nbsp;client&nbsp;auth,&nbsp;if&nbsp;any</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609248">msg</span><span class="op" id="4609251">,</span>&nbsp;<span class="ident" id="4609253">err</span>&nbsp;<span class="op" id="4609257">:=</span>&nbsp;<span class="ident" id="4609260">c</span><span class="op" id="4609261">.</span><span class="ident" id="4609262">readHandshake</span><span class="op" id="4609275">(</span><span class="op" id="4609276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609279">if</span>&nbsp;<span class="ident" id="4609282">err</span>&nbsp;<span class="op" id="4609286">!=</span>&nbsp;<span class="ident" id="4609289">nil</span>&nbsp;<span class="op" id="4609293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609297">return</span>&nbsp;<span class="ident" id="4609304">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4609309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609313">var</span>&nbsp;<span class="ident" id="4609317">ok</span>&nbsp;<span class="builtintype" id="4609320">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4609326">//&nbsp;If&nbsp;we&nbsp;requested&nbsp;a&nbsp;client&nbsp;certificate,&nbsp;then&nbsp;the&nbsp;client&nbsp;must&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4609396">//&nbsp;certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609441">if</span>&nbsp;<span class="ident" id="4609444">config</span><span class="op" id="4609450">.</span><span class="ident" id="4609451">ClientAuth</span>&nbsp;<span class="op" id="4609462">&gt;=</span>&nbsp;<span class="ident" id="4609465">RequestClientCert</span>&nbsp;<span class="op" id="4609483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609487">if</span>&nbsp;<span class="ident" id="4609490">certMsg</span><span class="op" id="4609497">,</span>&nbsp;<span class="ident" id="4609499">ok</span>&nbsp;<span class="op" id="4609502">=</span>&nbsp;<span class="ident" id="4609504">msg</span><span class="op" id="4609507">.</span><span class="op" id="4609508">(</span><span class="op" id="4609509">*</span><span class="ident" id="4609510">certificateMsg</span><span class="op" id="4609524">)</span><span class="op" id="4609525">;</span>&nbsp;<span class="op" id="4609527">!</span><span class="ident" id="4609528">ok</span>&nbsp;<span class="op" id="4609531">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609536">c</span><span class="op" id="4609537">.</span><span class="ident" id="4609538">sendAlert</span><span class="op" id="4609547">(</span><span class="ident" id="4609548">alertUnexpectedMessage</span><span class="op" id="4609570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609575">return</span>&nbsp;<span class="ident" id="4609582">unexpectedMessageError</span><span class="op" id="4609604">(</span><span class="ident" id="4609605">certMsg</span><span class="op" id="4609612">,</span>&nbsp;<span class="ident" id="4609614">msg</span><span class="op" id="4609617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4609621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609625">hs</span><span class="op" id="4609627">.</span><span class="ident" id="4609628">finishedHash</span><span class="op" id="4609640">.</span><span class="ident" id="4609641">Write</span><span class="op" id="4609646">(</span><span class="ident" id="4609647">certMsg</span><span class="op" id="4609654">.</span><span class="ident" id="4609655">marshal</span><span class="op" id="4609662">(</span><span class="op" id="4609663">)</span><span class="op" id="4609664">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609669">if</span>&nbsp;<span class="builtinfunc" id="4609672">len</span><span class="op" id="4609675">(</span><span class="ident" id="4609676">certMsg</span><span class="op" id="4609683">.</span><span class="ident" id="4609684">certificates</span><span class="op" id="4609696">)</span>&nbsp;<span class="op" id="4609698">==</span>&nbsp;<span class="num" id="4609701">0</span>&nbsp;<span class="op" id="4609703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4609708">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;actually&nbsp;send&nbsp;a&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609760">switch</span>&nbsp;<span class="ident" id="4609767">config</span><span class="op" id="4609773">.</span><span class="ident" id="4609774">ClientAuth</span>&nbsp;<span class="op" id="4609785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609790">case</span>&nbsp;<span class="ident" id="4609795">RequireAnyClientCert</span><span class="op" id="4609815">,</span>&nbsp;<span class="ident" id="4609817">RequireAndVerifyClientCert</span><span class="op" id="4609843">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609849">c</span><span class="op" id="4609850">.</span><span class="ident" id="4609851">sendAlert</span><span class="op" id="4609860">(</span><span class="ident" id="4609861">alertBadCertificate</span><span class="op" id="4609880">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609886">return</span>&nbsp;<span class="ident" id="4609893">errors</span><span class="op" id="4609899">.</span><span class="ident" id="4609900">New</span><span class="op" id="4609903">(</span><span class="string" id="4609904">&#34;tls:&nbsp;client&nbsp;didn&#39;t&nbsp;provide&nbsp;a&nbsp;certificate&#34;</span><span class="op" id="4609946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4609951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4609955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609960">pub</span><span class="op" id="4609963">,</span>&nbsp;<span class="ident" id="4609965">err</span>&nbsp;<span class="op" id="4609969">=</span>&nbsp;<span class="ident" id="4609971">hs</span><span class="op" id="4609973">.</span><span class="ident" id="4609974">processCertsFromClient</span><span class="op" id="4609996">(</span><span class="ident" id="4609997">certMsg</span><span class="op" id="4610004">.</span><span class="ident" id="4610005">certificates</span><span class="op" id="4610017">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610021">if</span>&nbsp;<span class="ident" id="4610024">err</span>&nbsp;<span class="op" id="4610028">!=</span>&nbsp;<span class="ident" id="4610031">nil</span>&nbsp;<span class="op" id="4610035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610040">return</span>&nbsp;<span class="ident" id="4610047">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4610053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610058">msg</span><span class="op" id="4610061">,</span>&nbsp;<span class="ident" id="4610063">err</span>&nbsp;<span class="op" id="4610067">=</span>&nbsp;<span class="ident" id="4610069">c</span><span class="op" id="4610070">.</span><span class="ident" id="4610071">readHandshake</span><span class="op" id="4610084">(</span><span class="op" id="4610085">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610089">if</span>&nbsp;<span class="ident" id="4610092">err</span>&nbsp;<span class="op" id="4610096">!=</span>&nbsp;<span class="ident" id="4610099">nil</span>&nbsp;<span class="op" id="4610103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610108">return</span>&nbsp;<span class="ident" id="4610115">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4610121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4610124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4610128">//&nbsp;Get&nbsp;client&nbsp;key&nbsp;exchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610156">ckx</span><span class="op" id="4610159">,</span>&nbsp;<span class="ident" id="4610161">ok</span>&nbsp;<span class="op" id="4610164">:=</span>&nbsp;<span class="ident" id="4610167">msg</span><span class="op" id="4610170">.</span><span class="op" id="4610171">(</span><span class="op" id="4610172">*</span><span class="ident" id="4610173">clientKeyExchangeMsg</span><span class="op" id="4610193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610196">if</span>&nbsp;<span class="op" id="4610199">!</span><span class="ident" id="4610200">ok</span>&nbsp;<span class="op" id="4610203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610207">c</span><span class="op" id="4610208">.</span><span class="ident" id="4610209">sendAlert</span><span class="op" id="4610218">(</span><span class="ident" id="4610219">alertUnexpectedMessage</span><span class="op" id="4610241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610245">return</span>&nbsp;<span class="ident" id="4610252">unexpectedMessageError</span><span class="op" id="4610274">(</span><span class="ident" id="4610275">ckx</span><span class="op" id="4610278">,</span>&nbsp;<span class="ident" id="4610280">msg</span><span class="op" id="4610283">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4610286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610289">hs</span><span class="op" id="4610291">.</span><span class="ident" id="4610292">finishedHash</span><span class="op" id="4610304">.</span><span class="ident" id="4610305">Write</span><span class="op" id="4610310">(</span><span class="ident" id="4610311">ckx</span><span class="op" id="4610314">.</span><span class="ident" id="4610315">marshal</span><span class="op" id="4610322">(</span><span class="op" id="4610323">)</span><span class="op" id="4610324">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4610328">//&nbsp;If&nbsp;we&nbsp;received&nbsp;a&nbsp;client&nbsp;cert&nbsp;in&nbsp;response&nbsp;to&nbsp;our&nbsp;certificate&nbsp;request&nbsp;message,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4610409">//&nbsp;the&nbsp;client&nbsp;will&nbsp;send&nbsp;us&nbsp;a&nbsp;certificateVerifyMsg&nbsp;immediately&nbsp;after&nbsp;the</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4610482">//&nbsp;clientKeyExchangeMsg.&nbsp;&nbsp;This&nbsp;message&nbsp;is&nbsp;a&nbsp;digest&nbsp;of&nbsp;all&nbsp;preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4610551">//&nbsp;handshake-layer&nbsp;messages&nbsp;that&nbsp;is&nbsp;signed&nbsp;using&nbsp;the&nbsp;private&nbsp;key&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4610631">//&nbsp;to&nbsp;the&nbsp;client&#39;s&nbsp;certificate.&nbsp;This&nbsp;allows&nbsp;us&nbsp;to&nbsp;verify&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4610711">//&nbsp;possession&nbsp;of&nbsp;the&nbsp;private&nbsp;key&nbsp;of&nbsp;the&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610765">if</span>&nbsp;<span class="builtinfunc" id="4610768">len</span><span class="op" id="4610771">(</span><span class="ident" id="4610772">c</span><span class="op" id="4610773">.</span><span class="ident" id="4610774">peerCertificates</span><span class="op" id="4610790">)</span>&nbsp;<span class="op" id="4610792">&gt;</span>&nbsp;<span class="num" id="4610794">0</span>&nbsp;<span class="op" id="4610796">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610800">msg</span><span class="op" id="4610803">,</span>&nbsp;<span class="ident" id="4610805">err</span>&nbsp;<span class="op" id="4610809">=</span>&nbsp;<span class="ident" id="4610811">c</span><span class="op" id="4610812">.</span><span class="ident" id="4610813">readHandshake</span><span class="op" id="4610826">(</span><span class="op" id="4610827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610831">if</span>&nbsp;<span class="ident" id="4610834">err</span>&nbsp;<span class="op" id="4610838">!=</span>&nbsp;<span class="ident" id="4610841">nil</span>&nbsp;<span class="op" id="4610845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610850">return</span>&nbsp;<span class="ident" id="4610857">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4610863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610867">certVerify</span><span class="op" id="4610877">,</span>&nbsp;<span class="ident" id="4610879">ok</span>&nbsp;<span class="op" id="4610882">:=</span>&nbsp;<span class="ident" id="4610885">msg</span><span class="op" id="4610888">.</span><span class="op" id="4610889">(</span><span class="op" id="4610890">*</span><span class="ident" id="4610891">certificateVerifyMsg</span><span class="op" id="4610911">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610915">if</span>&nbsp;<span class="op" id="4610918">!</span><span class="ident" id="4610919">ok</span>&nbsp;<span class="op" id="4610922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610927">c</span><span class="op" id="4610928">.</span><span class="ident" id="4610929">sendAlert</span><span class="op" id="4610938">(</span><span class="ident" id="4610939">alertUnexpectedMessage</span><span class="op" id="4610961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610966">return</span>&nbsp;<span class="ident" id="4610973">unexpectedMessageError</span><span class="op" id="4610995">(</span><span class="ident" id="4610996">certVerify</span><span class="op" id="4611006">,</span>&nbsp;<span class="ident" id="4611008">msg</span><span class="op" id="4611011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4611015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611020">switch</span>&nbsp;<span class="ident" id="4611027">key</span>&nbsp;<span class="op" id="4611031">:=</span>&nbsp;<span class="ident" id="4611034">pub</span><span class="op" id="4611037">.</span><span class="op" id="4611038">(</span><span class="keyword" id="4611039">type</span><span class="op" id="4611043">)</span>&nbsp;<span class="op" id="4611045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611049">case</span>&nbsp;<span class="op" id="4611054">*</span><span class="ident" id="4611055">ecdsa</span><span class="op" id="4611060">.</span><span class="ident" id="4611061">PublicKey</span><span class="op" id="4611070">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611075">ecdsaSig</span>&nbsp;<span class="op" id="4611084">:=</span>&nbsp;<span class="builtinfunc" id="4611087">new</span><span class="op" id="4611090">(</span><span class="ident" id="4611091">ecdsaSignature</span><span class="op" id="4611105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611110">if</span>&nbsp;<span class="ident" id="4611113">_</span><span class="op" id="4611114">,</span>&nbsp;<span class="ident" id="4611116">err</span>&nbsp;<span class="op" id="4611120">=</span>&nbsp;<span class="ident" id="4611122">asn1</span><span class="op" id="4611126">.</span><span class="ident" id="4611127">Unmarshal</span><span class="op" id="4611136">(</span><span class="ident" id="4611137">certVerify</span><span class="op" id="4611147">.</span><span class="ident" id="4611148">signature</span><span class="op" id="4611157">,</span>&nbsp;<span class="ident" id="4611159">ecdsaSig</span><span class="op" id="4611167">)</span><span class="op" id="4611168">;</span>&nbsp;<span class="ident" id="4611170">err</span>&nbsp;<span class="op" id="4611174">!=</span>&nbsp;<span class="ident" id="4611177">nil</span>&nbsp;<span class="op" id="4611181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611187">break</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4611196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611201">if</span>&nbsp;<span class="ident" id="4611204">ecdsaSig</span><span class="op" id="4611212">.</span><span class="ident" id="4611213">R</span><span class="op" id="4611214">.</span><span class="ident" id="4611215">Sign</span><span class="op" id="4611219">(</span><span class="op" id="4611220">)</span>&nbsp;<span class="op" id="4611222">&lt;=</span>&nbsp;<span class="num" id="4611225">0</span>&nbsp;<span class="op" id="4611227">||</span>&nbsp;<span class="ident" id="4611230">ecdsaSig</span><span class="op" id="4611238">.</span><span class="ident" id="4611239">S</span><span class="op" id="4611240">.</span><span class="ident" id="4611241">Sign</span><span class="op" id="4611245">(</span><span class="op" id="4611246">)</span>&nbsp;<span class="op" id="4611248">&lt;=</span>&nbsp;<span class="num" id="4611251">0</span>&nbsp;<span class="op" id="4611253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611259">err</span>&nbsp;<span class="op" id="4611263">=</span>&nbsp;<span class="ident" id="4611265">errors</span><span class="op" id="4611271">.</span><span class="ident" id="4611272">New</span><span class="op" id="4611275">(</span><span class="string" id="4611276">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="4611327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611333">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4611342">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611347">digest</span><span class="op" id="4611353">,</span>&nbsp;<span class="ident" id="4611355">_</span><span class="op" id="4611356">,</span>&nbsp;<span class="ident" id="4611358">_</span>&nbsp;<span class="op" id="4611360">:=</span>&nbsp;<span class="ident" id="4611363">hs</span><span class="op" id="4611365">.</span><span class="ident" id="4611366">finishedHash</span><span class="op" id="4611378">.</span><span class="ident" id="4611379">hashForClientCertificate</span><span class="op" id="4611403">(</span><span class="ident" id="4611404">signatureECDSA</span><span class="op" id="4611418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611423">if</span>&nbsp;<span class="op" id="4611426">!</span><span class="ident" id="4611427">ecdsa</span><span class="op" id="4611432">.</span><span class="ident" id="4611433">Verify</span><span class="op" id="4611439">(</span><span class="ident" id="4611440">key</span><span class="op" id="4611443">,</span>&nbsp;<span class="ident" id="4611445">digest</span><span class="op" id="4611451">,</span>&nbsp;<span class="ident" id="4611453">ecdsaSig</span><span class="op" id="4611461">.</span><span class="ident" id="4611462">R</span><span class="op" id="4611463">,</span>&nbsp;<span class="ident" id="4611465">ecdsaSig</span><span class="op" id="4611473">.</span><span class="ident" id="4611474">S</span><span class="op" id="4611475">)</span>&nbsp;<span class="op" id="4611477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611483">err</span>&nbsp;<span class="op" id="4611487">=</span>&nbsp;<span class="ident" id="4611489">errors</span><span class="op" id="4611495">.</span><span class="ident" id="4611496">New</span><span class="op" id="4611499">(</span><span class="string" id="4611500">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="4611528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611534">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4611543">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611547">case</span>&nbsp;<span class="op" id="4611552">*</span><span class="ident" id="4611553">rsa</span><span class="op" id="4611556">.</span><span class="ident" id="4611557">PublicKey</span><span class="op" id="4611566">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611571">digest</span><span class="op" id="4611577">,</span>&nbsp;<span class="ident" id="4611579">hashFunc</span><span class="op" id="4611587">,</span>&nbsp;<span class="ident" id="4611589">_</span>&nbsp;<span class="op" id="4611591">:=</span>&nbsp;<span class="ident" id="4611594">hs</span><span class="op" id="4611596">.</span><span class="ident" id="4611597">finishedHash</span><span class="op" id="4611609">.</span><span class="ident" id="4611610">hashForClientCertificate</span><span class="op" id="4611634">(</span><span class="ident" id="4611635">signatureRSA</span><span class="op" id="4611647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611652">err</span>&nbsp;<span class="op" id="4611656">=</span>&nbsp;<span class="ident" id="4611658">rsa</span><span class="op" id="4611661">.</span><span class="ident" id="4611662">VerifyPKCS1v15</span><span class="op" id="4611676">(</span><span class="ident" id="4611677">key</span><span class="op" id="4611680">,</span>&nbsp;<span class="ident" id="4611682">hashFunc</span><span class="op" id="4611690">,</span>&nbsp;<span class="ident" id="4611692">digest</span><span class="op" id="4611698">,</span>&nbsp;<span class="ident" id="4611700">certVerify</span><span class="op" id="4611710">.</span><span class="ident" id="4611711">signature</span><span class="op" id="4611720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4611724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611728">if</span>&nbsp;<span class="ident" id="4611731">err</span>&nbsp;<span class="op" id="4611735">!=</span>&nbsp;<span class="ident" id="4611738">nil</span>&nbsp;<span class="op" id="4611742">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611747">c</span><span class="op" id="4611748">.</span><span class="ident" id="4611749">sendAlert</span><span class="op" id="4611758">(</span><span class="ident" id="4611759">alertBadCertificate</span><span class="op" id="4611778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611783">return</span>&nbsp;<span class="ident" id="4611790">errors</span><span class="op" id="4611796">.</span><span class="ident" id="4611797">New</span><span class="op" id="4611800">(</span><span class="string" id="4611801">&#34;could&nbsp;not&nbsp;validate&nbsp;signature&nbsp;of&nbsp;connection&nbsp;nonces:&nbsp;&#34;</span>&nbsp;<span class="op" id="4611855">+</span>&nbsp;<span class="ident" id="4611857">err</span><span class="op" id="4611860">.</span><span class="ident" id="4611861">Error</span><span class="op" id="4611866">(</span><span class="op" id="4611867">)</span><span class="op" id="4611868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4611872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611877">hs</span><span class="op" id="4611879">.</span><span class="ident" id="4611880">finishedHash</span><span class="op" id="4611892">.</span><span class="ident" id="4611893">Write</span><span class="op" id="4611898">(</span><span class="ident" id="4611899">certVerify</span><span class="op" id="4611909">.</span><span class="ident" id="4611910">marshal</span><span class="op" id="4611917">(</span><span class="op" id="4611918">)</span><span class="op" id="4611919">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4611922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611926">preMasterSecret</span><span class="op" id="4611941">,</span>&nbsp;<span class="ident" id="4611943">err</span>&nbsp;<span class="op" id="4611947">:=</span>&nbsp;<span class="ident" id="4611950">keyAgreement</span><span class="op" id="4611962">.</span><span class="ident" id="4611963">processClientKeyExchange</span><span class="op" id="4611987">(</span><span class="ident" id="4611988">config</span><span class="op" id="4611994">,</span>&nbsp;<span class="ident" id="4611996">hs</span><span class="op" id="4611998">.</span><span class="ident" id="4611999">cert</span><span class="op" id="4612003">,</span>&nbsp;<span class="ident" id="4612005">ckx</span><span class="op" id="4612008">,</span>&nbsp;<span class="ident" id="4612010">c</span><span class="op" id="4612011">.</span><span class="ident" id="4612012">vers</span><span class="op" id="4612016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4612019">if</span>&nbsp;<span class="ident" id="4612022">err</span>&nbsp;<span class="op" id="4612026">!=</span>&nbsp;<span class="ident" id="4612029">nil</span>&nbsp;<span class="op" id="4612033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4612037">c</span><span class="op" id="4612038">.</span><span class="ident" id="4612039">sendAlert</span><span class="op" id="4612048">(</span><span class="ident" id="4612049">alertHandshakeFailure</span><span class="op" id="4612070">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4612074">return</span>&nbsp;<span class="ident" id="4612081">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4612086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4612089">hs</span><span class="op" id="4612091">.</span><span class="ident" id="4612092">masterSecret</span>&nbsp;<span class="op" id="4612105">=</span>&nbsp;<span class="ident" id="4612107">masterFromPreMasterSecret</span><span class="op" id="4612132">(</span><span class="ident" id="4612133">c</span><span class="op" id="4612134">.</span><span class="ident" id="4612135">vers</span><span class="op" id="4612139">,</span>&nbsp;<span class="ident" id="4612141">preMasterSecret</span><span class="op" id="4612156">,</span>&nbsp;<span class="ident" id="4612158">hs</span><span class="op" id="4612160">.</span><span class="ident" id="4612161">clientHello</span><span class="op" id="4612172">.</span><span class="ident" id="4612173">random</span><span class="op" id="4612179">,</span>&nbsp;<span class="ident" id="4612181">hs</span><span class="op" id="4612183">.</span><span class="ident" id="4612184">hello</span><span class="op" id="4612189">.</span><span class="ident" id="4612190">random</span><span class="op" id="4612196">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4612200">return</span>&nbsp;<span class="ident" id="4612207">nil</span><br>
<span class="lineno">475</span><span class="op" id="4612211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4612214">func</span>&nbsp;<span class="op" id="4612219">(</span><span class="ident" id="4612220">hs</span>&nbsp;<span class="op" id="4612223">*</span><span class="ident" id="4612224">serverHandshakeState</span><span class="op" id="4612244">)</span>&nbsp;<span class="ident" id="4612246">establishKeys</span><span class="op" id="4612259">(</span><span class="op" id="4612260">)</span>&nbsp;<span class="builtintype" id="4612262">error</span>&nbsp;<span class="op" id="4612268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4612271">c</span>&nbsp;<span class="op" id="4612273">:=</span>&nbsp;<span class="ident" id="4612276">hs</span><span class="op" id="4612278">.</span><span class="ident" id="4612279">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4612283">clientMAC</span><span class="op" id="4612292">,</span>&nbsp;<span class="ident" id="4612294">serverMAC</span><span class="op" id="4612303">,</span>&nbsp;<span class="ident" id="4612305">clientKey</span><span class="op" id="4612314">,</span>&nbsp;<span class="ident" id="4612316">serverKey</span><span class="op" id="4612325">,</span>&nbsp;<span class="ident" id="4612327">clientIV</span><span class="op" id="4612335">,</span>&nbsp;<span class="ident" id="4612337">serverIV</span>&nbsp;<span class="op" id="4612346">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4612351">keysFromMasterSecret</span><span class="op" id="4612371">(</span><span class="ident" id="4612372">c</span><span class="op" id="4612373">.</span><span class="ident" id="4612374">vers</span><span class="op" id="4612378">,</span>&nbsp;<span class="ident" id="4612380">hs</span><span class="op" id="4612382">.</span><span class="ident" id="4612383">masterSecret</span><span class="op" id="4612395">,</span>&nbsp;<span class="ident" id="4612397">hs</span><span class="op" id="4612399">.</span><span class="ident" id="4612400">clientHello</span><span class="op" id="4612411">.</span><span class="ident" id="4612412">random</span><span class="op" id="4612418">,</span>&nbsp;<span class="ident" id="4612420">hs</span><span class="op" id="4612422">.</span><span class="ident" id="4612423">hello</span><span class="op" id="4612428">.</span><span class="ident" id="4612429">random</span><span class="op" id="4612435">,</span>&nbsp;<span class="ident" id="4612437">hs</span><span class="op" id="4612439">.</span><span class="ident" id="4612440">suite</span><span class="op" id="4612445">.</span><span class="ident" id="4612446">macLen</span><span class="op" id="4612452">,</span>&nbsp;<span class="ident" id="4612454">hs</span><span class="op" id="4612456">.</span><span class="ident" id="4612457">suite</span><span class="op" id="4612462">.</span><span class="ident" id="4612463">keyLen</span><span class="op" id="4612469">,</span>&nbsp;<span class="ident" id="4612471">hs</span><span class="op" id="4612473">.</span><span class="ident" id="4612474">suite</span><span class="op" id="4612479">.</span><span class="ident" id="4612480">ivLen</span><span class="op" id="4612485">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4612489">var</span>&nbsp;<span class="ident" id="4612493">clientCipher</span><span class="op" id="4612505">,</span>&nbsp;<span class="ident" id="4612507">serverCipher</span>&nbsp;<span class="keyword" id="4612520">interface</span><span class="op" id="4612529">{</span><span class="op" id="4612530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4612533">var</span>&nbsp;<span class="ident" id="4612537">clientHash</span><span class="op" id="4612547">,</span>&nbsp;<span class="ident" id="4612549">serverHash</span>&nbsp;<span class="ident" id="4612560">macFunction</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4612574">if</span>&nbsp;<span class="ident" id="4612577">hs</span><span class="op" id="4612579">.</span><span class="ident" id="4612580">suite</span><span class="op" id="4612585">.</span><span class="ident" id="4612586">aead</span>&nbsp;<span class="op" id="4612591">==</span>&nbsp;<span class="ident" id="4612594">nil</span>&nbsp;<span class="op" id="4612598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4612602">clientCipher</span>&nbsp;<span class="op" id="4612615">=</span>&nbsp;<span class="ident" id="4612617">hs</span><span class="op" id="4612619">.</span><span class="ident" id="4612620">suite</span><span class="op" id="4612625">.</span><span class="ident" id="4612626">cipher</span><span class="op" id="4612632">(</span><span class="ident" id="4612633">clientKey</span><span class="op" id="4612642">,</span>&nbsp;<span class="ident" id="4612644">clientIV</span><span class="op" id="4612652">,</span>&nbsp;<span class="builtintype" id="4612654">true</span>&nbsp;<span class="comment" id="4612659">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4612676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4612680">clientHash</span>&nbsp;<span class="op" id="4612691">=</span>&nbsp;<span class="ident" id="4612693">hs</span><span class="op" id="4612695">.</span><span class="ident" id="4612696">suite</span><span class="op" id="4612701">.</span><span class="ident" id="4612702">mac</span><span class="op" id="4612705">(</span><span class="ident" id="4612706">c</span><span class="op" id="4612707">.</span><span class="ident" id="4612708">vers</span><span class="op" id="4612712">,</span>&nbsp;<span class="ident" id="4612714">clientMAC</span><span class="op" id="4612723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4612727">serverCipher</span>&nbsp;<span class="op" id="4612740">=</span>&nbsp;<span class="ident" id="4612742">hs</span><span class="op" id="4612744">.</span><span class="ident" id="4612745">suite</span><span class="op" id="4612750">.</span><span class="ident" id="4612751">cipher</span><span class="op" id="4612757">(</span><span class="ident" id="4612758">serverKey</span><span class="op" id="4612767">,</span>&nbsp;<span class="ident" id="4612769">serverIV</span><span class="op" id="4612777">,</span>&nbsp;<span class="builtintype" id="4612779">false</span>&nbsp;<span class="comment" id="4612785">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4612806">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4612810">serverHash</span>&nbsp;<span class="op" id="4612821">=</span>&nbsp;<span class="ident" id="4612823">hs</span><span class="op" id="4612825">.</span><span class="ident" id="4612826">suite</span><span class="op" id="4612831">.</span><span class="ident" id="4612832">mac</span><span class="op" id="4612835">(</span><span class="ident" id="4612836">c</span><span class="op" id="4612837">.</span><span class="ident" id="4612838">vers</span><span class="op" id="4612842">,</span>&nbsp;<span class="ident" id="4612844">serverMAC</span><span class="op" id="4612853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4612856">}</span>&nbsp;<span class="keyword" id="4612858">else</span>&nbsp;<span class="op" id="4612863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4612867">clientCipher</span>&nbsp;<span class="op" id="4612880">=</span>&nbsp;<span class="ident" id="4612882">hs</span><span class="op" id="4612884">.</span><span class="ident" id="4612885">suite</span><span class="op" id="4612890">.</span><span class="ident" id="4612891">aead</span><span class="op" id="4612895">(</span><span class="ident" id="4612896">clientKey</span><span class="op" id="4612905">,</span>&nbsp;<span class="ident" id="4612907">clientIV</span><span class="op" id="4612915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4612919">serverCipher</span>&nbsp;<span class="op" id="4612932">=</span>&nbsp;<span class="ident" id="4612934">hs</span><span class="op" id="4612936">.</span><span class="ident" id="4612937">suite</span><span class="op" id="4612942">.</span><span class="ident" id="4612943">aead</span><span class="op" id="4612947">(</span><span class="ident" id="4612948">serverKey</span><span class="op" id="4612957">,</span>&nbsp;<span class="ident" id="4612959">serverIV</span><span class="op" id="4612967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4612970">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4612974">c</span><span class="op" id="4612975">.</span><span class="ident" id="4612976">in</span><span class="op" id="4612978">.</span><span class="ident" id="4612979">prepareCipherSpec</span><span class="op" id="4612996">(</span><span class="ident" id="4612997">c</span><span class="op" id="4612998">.</span><span class="ident" id="4612999">vers</span><span class="op" id="4613003">,</span>&nbsp;<span class="ident" id="4613005">clientCipher</span><span class="op" id="4613017">,</span>&nbsp;<span class="ident" id="4613019">clientHash</span><span class="op" id="4613029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613032">c</span><span class="op" id="4613033">.</span><span class="ident" id="4613034">out</span><span class="op" id="4613037">.</span><span class="ident" id="4613038">prepareCipherSpec</span><span class="op" id="4613055">(</span><span class="ident" id="4613056">c</span><span class="op" id="4613057">.</span><span class="ident" id="4613058">vers</span><span class="op" id="4613062">,</span>&nbsp;<span class="ident" id="4613064">serverCipher</span><span class="op" id="4613076">,</span>&nbsp;<span class="ident" id="4613078">serverHash</span><span class="op" id="4613088">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613092">return</span>&nbsp;<span class="ident" id="4613099">nil</span><br>
<span class="lineno">500</span><span class="op" id="4613103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4613106">func</span>&nbsp;<span class="op" id="4613111">(</span><span class="ident" id="4613112">hs</span>&nbsp;<span class="op" id="4613115">*</span><span class="ident" id="4613116">serverHandshakeState</span><span class="op" id="4613136">)</span>&nbsp;<span class="ident" id="4613138">readFinished</span><span class="op" id="4613150">(</span><span class="ident" id="4613151">out</span>&nbsp;<span class="op" id="4613155">[</span><span class="op" id="4613156">]</span><span class="builtintype" id="4613157">byte</span><span class="op" id="4613161">)</span>&nbsp;<span class="builtintype" id="4613163">error</span>&nbsp;<span class="op" id="4613169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613172">c</span>&nbsp;<span class="op" id="4613174">:=</span>&nbsp;<span class="ident" id="4613177">hs</span><span class="op" id="4613179">.</span><span class="ident" id="4613180">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613184">c</span><span class="op" id="4613185">.</span><span class="ident" id="4613186">readRecord</span><span class="op" id="4613196">(</span><span class="ident" id="4613197">recordTypeChangeCipherSpec</span><span class="op" id="4613223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613226">if</span>&nbsp;<span class="ident" id="4613229">err</span>&nbsp;<span class="op" id="4613233">:=</span>&nbsp;<span class="ident" id="4613236">c</span><span class="op" id="4613237">.</span><span class="ident" id="4613238">in</span><span class="op" id="4613240">.</span><span class="builtintype" id="4613241">error</span><span class="op" id="4613246">(</span><span class="op" id="4613247">)</span><span class="op" id="4613248">;</span>&nbsp;<span class="ident" id="4613250">err</span>&nbsp;<span class="op" id="4613254">!=</span>&nbsp;<span class="ident" id="4613257">nil</span>&nbsp;<span class="op" id="4613261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613265">return</span>&nbsp;<span class="ident" id="4613272">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4613277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613281">if</span>&nbsp;<span class="ident" id="4613284">hs</span><span class="op" id="4613286">.</span><span class="ident" id="4613287">hello</span><span class="op" id="4613292">.</span><span class="ident" id="4613293">nextProtoNeg</span>&nbsp;<span class="op" id="4613306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613310">msg</span><span class="op" id="4613313">,</span>&nbsp;<span class="ident" id="4613315">err</span>&nbsp;<span class="op" id="4613319">:=</span>&nbsp;<span class="ident" id="4613322">c</span><span class="op" id="4613323">.</span><span class="ident" id="4613324">readHandshake</span><span class="op" id="4613337">(</span><span class="op" id="4613338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613342">if</span>&nbsp;<span class="ident" id="4613345">err</span>&nbsp;<span class="op" id="4613349">!=</span>&nbsp;<span class="ident" id="4613352">nil</span>&nbsp;<span class="op" id="4613356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613361">return</span>&nbsp;<span class="ident" id="4613368">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4613374">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613378">nextProto</span><span class="op" id="4613387">,</span>&nbsp;<span class="ident" id="4613389">ok</span>&nbsp;<span class="op" id="4613392">:=</span>&nbsp;<span class="ident" id="4613395">msg</span><span class="op" id="4613398">.</span><span class="op" id="4613399">(</span><span class="op" id="4613400">*</span><span class="ident" id="4613401">nextProtoMsg</span><span class="op" id="4613413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613417">if</span>&nbsp;<span class="op" id="4613420">!</span><span class="ident" id="4613421">ok</span>&nbsp;<span class="op" id="4613424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613429">c</span><span class="op" id="4613430">.</span><span class="ident" id="4613431">sendAlert</span><span class="op" id="4613440">(</span><span class="ident" id="4613441">alertUnexpectedMessage</span><span class="op" id="4613463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613468">return</span>&nbsp;<span class="ident" id="4613475">unexpectedMessageError</span><span class="op" id="4613497">(</span><span class="ident" id="4613498">nextProto</span><span class="op" id="4613507">,</span>&nbsp;<span class="ident" id="4613509">msg</span><span class="op" id="4613512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4613516">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613520">hs</span><span class="op" id="4613522">.</span><span class="ident" id="4613523">finishedHash</span><span class="op" id="4613535">.</span><span class="ident" id="4613536">Write</span><span class="op" id="4613541">(</span><span class="ident" id="4613542">nextProto</span><span class="op" id="4613551">.</span><span class="ident" id="4613552">marshal</span><span class="op" id="4613559">(</span><span class="op" id="4613560">)</span><span class="op" id="4613561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613565">c</span><span class="op" id="4613566">.</span><span class="ident" id="4613567">clientProtocol</span>&nbsp;<span class="op" id="4613582">=</span>&nbsp;<span class="ident" id="4613584">nextProto</span><span class="op" id="4613593">.</span><span class="ident" id="4613594">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4613601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613605">msg</span><span class="op" id="4613608">,</span>&nbsp;<span class="ident" id="4613610">err</span>&nbsp;<span class="op" id="4613614">:=</span>&nbsp;<span class="ident" id="4613617">c</span><span class="op" id="4613618">.</span><span class="ident" id="4613619">readHandshake</span><span class="op" id="4613632">(</span><span class="op" id="4613633">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613636">if</span>&nbsp;<span class="ident" id="4613639">err</span>&nbsp;<span class="op" id="4613643">!=</span>&nbsp;<span class="ident" id="4613646">nil</span>&nbsp;<span class="op" id="4613650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613654">return</span>&nbsp;<span class="ident" id="4613661">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4613666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613669">clientFinished</span><span class="op" id="4613683">,</span>&nbsp;<span class="ident" id="4613685">ok</span>&nbsp;<span class="op" id="4613688">:=</span>&nbsp;<span class="ident" id="4613691">msg</span><span class="op" id="4613694">.</span><span class="op" id="4613695">(</span><span class="op" id="4613696">*</span><span class="ident" id="4613697">finishedMsg</span><span class="op" id="4613708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613711">if</span>&nbsp;<span class="op" id="4613714">!</span><span class="ident" id="4613715">ok</span>&nbsp;<span class="op" id="4613718">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613722">c</span><span class="op" id="4613723">.</span><span class="ident" id="4613724">sendAlert</span><span class="op" id="4613733">(</span><span class="ident" id="4613734">alertUnexpectedMessage</span><span class="op" id="4613756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613760">return</span>&nbsp;<span class="ident" id="4613767">unexpectedMessageError</span><span class="op" id="4613789">(</span><span class="ident" id="4613790">clientFinished</span><span class="op" id="4613804">,</span>&nbsp;<span class="ident" id="4613806">msg</span><span class="op" id="4613809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4613812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613816">verify</span>&nbsp;<span class="op" id="4613823">:=</span>&nbsp;<span class="ident" id="4613826">hs</span><span class="op" id="4613828">.</span><span class="ident" id="4613829">finishedHash</span><span class="op" id="4613841">.</span><span class="ident" id="4613842">clientSum</span><span class="op" id="4613851">(</span><span class="ident" id="4613852">hs</span><span class="op" id="4613854">.</span><span class="ident" id="4613855">masterSecret</span><span class="op" id="4613867">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613870">if</span>&nbsp;<span class="builtinfunc" id="4613873">len</span><span class="op" id="4613876">(</span><span class="ident" id="4613877">verify</span><span class="op" id="4613883">)</span>&nbsp;<span class="op" id="4613885">!=</span>&nbsp;<span class="builtinfunc" id="4613888">len</span><span class="op" id="4613891">(</span><span class="ident" id="4613892">clientFinished</span><span class="op" id="4613906">.</span><span class="ident" id="4613907">verifyData</span><span class="op" id="4613917">)</span>&nbsp;<span class="op" id="4613919">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613924">subtle</span><span class="op" id="4613930">.</span><span class="ident" id="4613931">ConstantTimeCompare</span><span class="op" id="4613950">(</span><span class="ident" id="4613951">verify</span><span class="op" id="4613957">,</span>&nbsp;<span class="ident" id="4613959">clientFinished</span><span class="op" id="4613973">.</span><span class="ident" id="4613974">verifyData</span><span class="op" id="4613984">)</span>&nbsp;<span class="op" id="4613986">!=</span>&nbsp;<span class="num" id="4613989">1</span>&nbsp;<span class="op" id="4613991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613995">c</span><span class="op" id="4613996">.</span><span class="ident" id="4613997">sendAlert</span><span class="op" id="4614006">(</span><span class="ident" id="4614007">alertHandshakeFailure</span><span class="op" id="4614028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4614032">return</span>&nbsp;<span class="ident" id="4614039">errors</span><span class="op" id="4614045">.</span><span class="ident" id="4614046">New</span><span class="op" id="4614049">(</span><span class="string" id="4614050">&#34;tls:&nbsp;client&#39;s&nbsp;Finished&nbsp;message&nbsp;is&nbsp;incorrect&#34;</span><span class="op" id="4614095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4614098">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4614102">hs</span><span class="op" id="4614104">.</span><span class="ident" id="4614105">finishedHash</span><span class="op" id="4614117">.</span><span class="ident" id="4614118">Write</span><span class="op" id="4614123">(</span><span class="ident" id="4614124">clientFinished</span><span class="op" id="4614138">.</span><span class="ident" id="4614139">marshal</span><span class="op" id="4614146">(</span><span class="op" id="4614147">)</span><span class="op" id="4614148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4614151">copy</span><span class="op" id="4614155">(</span><span class="ident" id="4614156">out</span><span class="op" id="4614159">,</span>&nbsp;<span class="ident" id="4614161">verify</span><span class="op" id="4614167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4614170">return</span>&nbsp;<span class="ident" id="4614177">nil</span><br>
<span class="lineno"></span><span class="op" id="4614181">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="keyword" id="4614184">func</span>&nbsp;<span class="op" id="4614189">(</span><span class="ident" id="4614190">hs</span>&nbsp;<span class="op" id="4614193">*</span><span class="ident" id="4614194">serverHandshakeState</span><span class="op" id="4614214">)</span>&nbsp;<span class="ident" id="4614216">sendSessionTicket</span><span class="op" id="4614233">(</span><span class="op" id="4614234">)</span>&nbsp;<span class="builtintype" id="4614236">error</span>&nbsp;<span class="op" id="4614242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4614245">if</span>&nbsp;<span class="op" id="4614248">!</span><span class="ident" id="4614249">hs</span><span class="op" id="4614251">.</span><span class="ident" id="4614252">hello</span><span class="op" id="4614257">.</span><span class="ident" id="4614258">ticketSupported</span>&nbsp;<span class="op" id="4614274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4614278">return</span>&nbsp;<span class="ident" id="4614285">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4614290">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4614294">c</span>&nbsp;<span class="op" id="4614296">:=</span>&nbsp;<span class="ident" id="4614299">hs</span><span class="op" id="4614301">.</span><span class="ident" id="4614302">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4614305">m</span>&nbsp;<span class="op" id="4614307">:=</span>&nbsp;<span class="builtinfunc" id="4614310">new</span><span class="op" id="4614313">(</span><span class="ident" id="4614314">newSessionTicketMsg</span><span class="op" id="4614333">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4614337">var</span>&nbsp;<span class="ident" id="4614341">err</span>&nbsp;<span class="builtintype" id="4614345">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4614352">state</span>&nbsp;<span class="op" id="4614358">:=</span>&nbsp;<span class="ident" id="4614361">sessionState</span><span class="op" id="4614373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4614377">vers</span><span class="op" id="4614381">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4614391">c</span><span class="op" id="4614392">.</span><span class="ident" id="4614393">vers</span><span class="op" id="4614397">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4614401">cipherSuite</span><span class="op" id="4614412">:</span>&nbsp;&nbsp;<span class="ident" id="4614415">hs</span><span class="op" id="4614417">.</span><span class="ident" id="4614418">suite</span><span class="op" id="4614423">.</span><span class="ident" id="4614424">id</span><span class="op" id="4614426">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4614430">masterSecret</span><span class="op" id="4614442">:</span>&nbsp;<span class="ident" id="4614444">hs</span><span class="op" id="4614446">.</span><span class="ident" id="4614447">masterSecret</span><span class="op" id="4614459">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4614463">certificates</span><span class="op" id="4614475">:</span>&nbsp;<span class="ident" id="4614477">hs</span><span class="op" id="4614479">.</span><span class="ident" id="4614480">certsFromClient</span><span class="op" id="4614495">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4614498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4614501">m</span><span class="op" id="4614502">.</span><span class="ident" id="4614503">ticket</span><span class="op" id="4614509">,</span>&nbsp;<span class="ident" id="4614511">err</span>&nbsp;<span class="op" id="4614515">=</span>&nbsp;<span class="ident" id="4614517">c</span><span class="op" id="4614518">.</span><span class="ident" id="4614519">encryptTicket</span><span class="op" id="4614532">(</span><span class="op" id="4614533">&amp;</span><span class="ident" id="4614534">state</span><span class="op" id="4614539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4614542">if</span>&nbsp;<span class="ident" id="4614545">err</span>&nbsp;<span class="op" id="4614549">!=</span>&nbsp;<span class="ident" id="4614552">nil</span>&nbsp;<span class="op" id="4614556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4614560">return</span>&nbsp;<span class="ident" id="4614567">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4614572">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4614576">hs</span><span class="op" id="4614578">.</span><span class="ident" id="4614579">finishedHash</span><span class="op" id="4614591">.</span><span class="ident" id="4614592">Write</span><span class="op" id="4614597">(</span><span class="ident" id="4614598">m</span><span class="op" id="4614599">.</span><span class="ident" id="4614600">marshal</span><span class="op" id="4614607">(</span><span class="op" id="4614608">)</span><span class="op" id="4614609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4614612">c</span><span class="op" id="4614613">.</span><span class="ident" id="4614614">writeRecord</span><span class="op" id="4614625">(</span><span class="ident" id="4614626">recordTypeHandshake</span><span class="op" id="4614645">,</span>&nbsp;<span class="ident" id="4614647">m</span><span class="op" id="4614648">.</span><span class="ident" id="4614649">marshal</span><span class="op" id="4614656">(</span><span class="op" id="4614657">)</span><span class="op" id="4614658">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4614662">return</span>&nbsp;<span class="ident" id="4614669">nil</span><br>
<span class="lineno">570</span><span class="op" id="4614673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4614676">func</span>&nbsp;<span class="op" id="4614681">(</span><span class="ident" id="4614682">hs</span>&nbsp;<span class="op" id="4614685">*</span><span class="ident" id="4614686">serverHandshakeState</span><span class="op" id="4614706">)</span>&nbsp;<span class="ident" id="4614708">sendFinished</span><span class="op" id="4614720">(</span><span class="ident" id="4614721">out</span>&nbsp;<span class="op" id="4614725">[</span><span class="op" id="4614726">]</span><span class="builtintype" id="4614727">byte</span><span class="op" id="4614731">)</span>&nbsp;<span class="builtintype" id="4614733">error</span>&nbsp;<span class="op" id="4614739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4614742">c</span>&nbsp;<span class="op" id="4614744">:=</span>&nbsp;<span class="ident" id="4614747">hs</span><span class="op" id="4614749">.</span><span class="ident" id="4614750">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4614754">c</span><span class="op" id="4614755">.</span><span class="ident" id="4614756">writeRecord</span><span class="op" id="4614767">(</span><span class="ident" id="4614768">recordTypeChangeCipherSpec</span><span class="op" id="4614794">,</span>&nbsp;<span class="op" id="4614796">[</span><span class="op" id="4614797">]</span><span class="builtintype" id="4614798">byte</span><span class="op" id="4614802">{</span><span class="num" id="4614803">1</span><span class="op" id="4614804">}</span><span class="op" id="4614805">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4614809">finished</span>&nbsp;<span class="op" id="4614818">:=</span>&nbsp;<span class="builtinfunc" id="4614821">new</span><span class="op" id="4614824">(</span><span class="ident" id="4614825">finishedMsg</span><span class="op" id="4614836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4614839">finished</span><span class="op" id="4614847">.</span><span class="ident" id="4614848">verifyData</span>&nbsp;<span class="op" id="4614859">=</span>&nbsp;<span class="ident" id="4614861">hs</span><span class="op" id="4614863">.</span><span class="ident" id="4614864">finishedHash</span><span class="op" id="4614876">.</span><span class="ident" id="4614877">serverSum</span><span class="op" id="4614886">(</span><span class="ident" id="4614887">hs</span><span class="op" id="4614889">.</span><span class="ident" id="4614890">masterSecret</span><span class="op" id="4614902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4614905">hs</span><span class="op" id="4614907">.</span><span class="ident" id="4614908">finishedHash</span><span class="op" id="4614920">.</span><span class="ident" id="4614921">Write</span><span class="op" id="4614926">(</span><span class="ident" id="4614927">finished</span><span class="op" id="4614935">.</span><span class="ident" id="4614936">marshal</span><span class="op" id="4614943">(</span><span class="op" id="4614944">)</span><span class="op" id="4614945">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4614948">c</span><span class="op" id="4614949">.</span><span class="ident" id="4614950">writeRecord</span><span class="op" id="4614961">(</span><span class="ident" id="4614962">recordTypeHandshake</span><span class="op" id="4614981">,</span>&nbsp;<span class="ident" id="4614983">finished</span><span class="op" id="4614991">.</span><span class="ident" id="4614992">marshal</span><span class="op" id="4614999">(</span><span class="op" id="4615000">)</span><span class="op" id="4615001">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4615005">c</span><span class="op" id="4615006">.</span><span class="ident" id="4615007">cipherSuite</span>&nbsp;<span class="op" id="4615019">=</span>&nbsp;<span class="ident" id="4615021">hs</span><span class="op" id="4615023">.</span><span class="ident" id="4615024">suite</span><span class="op" id="4615029">.</span><span class="ident" id="4615030">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4615034">copy</span><span class="op" id="4615038">(</span><span class="ident" id="4615039">out</span><span class="op" id="4615042">,</span>&nbsp;<span class="ident" id="4615044">finished</span><span class="op" id="4615052">.</span><span class="ident" id="4615053">verifyData</span><span class="op" id="4615063">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4615067">return</span>&nbsp;<span class="ident" id="4615074">nil</span><br>
<span class="lineno"></span><span class="op" id="4615078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4615081">//&nbsp;processCertsFromClient&nbsp;takes&nbsp;a&nbsp;chain&nbsp;of&nbsp;client&nbsp;certificates&nbsp;either&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4615158">//&nbsp;Certificates&nbsp;message&nbsp;or&nbsp;from&nbsp;a&nbsp;sessionState&nbsp;and&nbsp;verifies&nbsp;them.&nbsp;It&nbsp;returns</span><br>
<span class="lineno">590</span><span class="comment" id="4615235">//&nbsp;the&nbsp;public&nbsp;key&nbsp;of&nbsp;the&nbsp;leaf&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4615278">func</span>&nbsp;<span class="op" id="4615283">(</span><span class="ident" id="4615284">hs</span>&nbsp;<span class="op" id="4615287">*</span><span class="ident" id="4615288">serverHandshakeState</span><span class="op" id="4615308">)</span>&nbsp;<span class="ident" id="4615310">processCertsFromClient</span><span class="op" id="4615332">(</span><span class="ident" id="4615333">certificates</span>&nbsp;<span class="op" id="4615346">[</span><span class="op" id="4615347">]</span><span class="op" id="4615348">[</span><span class="op" id="4615349">]</span><span class="builtintype" id="4615350">byte</span><span class="op" id="4615354">)</span>&nbsp;<span class="op" id="4615356">(</span><span class="ident" id="4615357">crypto</span><span class="op" id="4615363">.</span><span class="ident" id="4615364">PublicKey</span><span class="op" id="4615373">,</span>&nbsp;<span class="builtintype" id="4615375">error</span><span class="op" id="4615380">)</span>&nbsp;<span class="op" id="4615382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4615385">c</span>&nbsp;<span class="op" id="4615387">:=</span>&nbsp;<span class="ident" id="4615390">hs</span><span class="op" id="4615392">.</span><span class="ident" id="4615393">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4615397">hs</span><span class="op" id="4615399">.</span><span class="ident" id="4615400">certsFromClient</span>&nbsp;<span class="op" id="4615416">=</span>&nbsp;<span class="ident" id="4615418">certificates</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4615432">certs</span>&nbsp;<span class="op" id="4615438">:=</span>&nbsp;<span class="builtinfunc" id="4615441">make</span><span class="op" id="4615445">(</span><span class="op" id="4615446">[</span><span class="op" id="4615447">]</span><span class="op" id="4615448">*</span><span class="ident" id="4615449">x509</span><span class="op" id="4615453">.</span><span class="ident" id="4615454">Certificate</span><span class="op" id="4615465">,</span>&nbsp;<span class="builtinfunc" id="4615467">len</span><span class="op" id="4615470">(</span><span class="ident" id="4615471">certificates</span><span class="op" id="4615483">)</span><span class="op" id="4615484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4615487">var</span>&nbsp;<span class="ident" id="4615491">err</span>&nbsp;<span class="builtintype" id="4615495">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4615502">for</span>&nbsp;<span class="ident" id="4615506">i</span><span class="op" id="4615507">,</span>&nbsp;<span class="ident" id="4615509">asn1Data</span>&nbsp;<span class="op" id="4615518">:=</span>&nbsp;<span class="keyword" id="4615521">range</span>&nbsp;<span class="ident" id="4615527">certificates</span>&nbsp;<span class="op" id="4615540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4615544">if</span>&nbsp;<span class="ident" id="4615547">certs</span><span class="op" id="4615552">[</span><span class="ident" id="4615553">i</span><span class="op" id="4615554">]</span><span class="op" id="4615555">,</span>&nbsp;<span class="ident" id="4615557">err</span>&nbsp;<span class="op" id="4615561">=</span>&nbsp;<span class="ident" id="4615563">x509</span><span class="op" id="4615567">.</span><span class="ident" id="4615568">ParseCertificate</span><span class="op" id="4615584">(</span><span class="ident" id="4615585">asn1Data</span><span class="op" id="4615593">)</span><span class="op" id="4615594">;</span>&nbsp;<span class="ident" id="4615596">err</span>&nbsp;<span class="op" id="4615600">!=</span>&nbsp;<span class="ident" id="4615603">nil</span>&nbsp;<span class="op" id="4615607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4615612">c</span><span class="op" id="4615613">.</span><span class="ident" id="4615614">sendAlert</span><span class="op" id="4615623">(</span><span class="ident" id="4615624">alertBadCertificate</span><span class="op" id="4615643">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4615648">return</span>&nbsp;<span class="ident" id="4615655">nil</span><span class="op" id="4615658">,</span>&nbsp;<span class="ident" id="4615660">errors</span><span class="op" id="4615666">.</span><span class="ident" id="4615667">New</span><span class="op" id="4615670">(</span><span class="string" id="4615671">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4615715">+</span>&nbsp;<span class="ident" id="4615717">err</span><span class="op" id="4615720">.</span><span class="ident" id="4615721">Error</span><span class="op" id="4615726">(</span><span class="op" id="4615727">)</span><span class="op" id="4615728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4615732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4615735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4615739">if</span>&nbsp;<span class="ident" id="4615742">c</span><span class="op" id="4615743">.</span><span class="ident" id="4615744">config</span><span class="op" id="4615750">.</span><span class="ident" id="4615751">ClientAuth</span>&nbsp;<span class="op" id="4615762">&gt;=</span>&nbsp;<span class="ident" id="4615765">VerifyClientCertIfGiven</span>&nbsp;<span class="op" id="4615789">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4615792">len</span><span class="op" id="4615795">(</span><span class="ident" id="4615796">certs</span><span class="op" id="4615801">)</span>&nbsp;<span class="op" id="4615803">&gt;</span>&nbsp;<span class="num" id="4615805">0</span>&nbsp;<span class="op" id="4615807">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4615811">opts</span>&nbsp;<span class="op" id="4615816">:=</span>&nbsp;<span class="ident" id="4615819">x509</span><span class="op" id="4615823">.</span><span class="ident" id="4615824">VerifyOptions</span><span class="op" id="4615837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4615842">Roots</span><span class="op" id="4615847">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4615857">c</span><span class="op" id="4615858">.</span><span class="ident" id="4615859">config</span><span class="op" id="4615865">.</span><span class="ident" id="4615866">ClientCAs</span><span class="op" id="4615875">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4615880">CurrentTime</span><span class="op" id="4615891">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4615895">c</span><span class="op" id="4615896">.</span><span class="ident" id="4615897">config</span><span class="op" id="4615903">.</span><span class="ident" id="4615904">time</span><span class="op" id="4615908">(</span><span class="op" id="4615909">)</span><span class="op" id="4615910">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4615915">Intermediates</span><span class="op" id="4615928">:</span>&nbsp;<span class="ident" id="4615930">x509</span><span class="op" id="4615934">.</span><span class="ident" id="4615935">NewCertPool</span><span class="op" id="4615946">(</span><span class="op" id="4615947">)</span><span class="op" id="4615948">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4615953">KeyUsages</span><span class="op" id="4615962">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4615968">[</span><span class="op" id="4615969">]</span><span class="ident" id="4615970">x509</span><span class="op" id="4615974">.</span><span class="ident" id="4615975">ExtKeyUsage</span><span class="op" id="4615986">{</span><span class="ident" id="4615987">x509</span><span class="op" id="4615991">.</span><span class="ident" id="4615992">ExtKeyUsageClientAuth</span><span class="op" id="4616013">}</span><span class="op" id="4616014">,</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4616018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4616023">for</span>&nbsp;<span class="ident" id="4616027">_</span><span class="op" id="4616028">,</span>&nbsp;<span class="ident" id="4616030">cert</span>&nbsp;<span class="op" id="4616035">:=</span>&nbsp;<span class="keyword" id="4616038">range</span>&nbsp;<span class="ident" id="4616044">certs</span><span class="op" id="4616049">[</span><span class="num" id="4616050">1</span><span class="op" id="4616051">:</span><span class="op" id="4616052">]</span>&nbsp;<span class="op" id="4616054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4616059">opts</span><span class="op" id="4616063">.</span><span class="ident" id="4616064">Intermediates</span><span class="op" id="4616077">.</span><span class="ident" id="4616078">AddCert</span><span class="op" id="4616085">(</span><span class="ident" id="4616086">cert</span><span class="op" id="4616090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4616094">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4616099">chains</span><span class="op" id="4616105">,</span>&nbsp;<span class="ident" id="4616107">err</span>&nbsp;<span class="op" id="4616111">:=</span>&nbsp;<span class="ident" id="4616114">certs</span><span class="op" id="4616119">[</span><span class="num" id="4616120">0</span><span class="op" id="4616121">]</span><span class="op" id="4616122">.</span><span class="ident" id="4616123">Verify</span><span class="op" id="4616129">(</span><span class="ident" id="4616130">opts</span><span class="op" id="4616134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4616138">if</span>&nbsp;<span class="ident" id="4616141">err</span>&nbsp;<span class="op" id="4616145">!=</span>&nbsp;<span class="ident" id="4616148">nil</span>&nbsp;<span class="op" id="4616152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4616157">c</span><span class="op" id="4616158">.</span><span class="ident" id="4616159">sendAlert</span><span class="op" id="4616168">(</span><span class="ident" id="4616169">alertBadCertificate</span><span class="op" id="4616188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4616193">return</span>&nbsp;<span class="ident" id="4616200">nil</span><span class="op" id="4616203">,</span>&nbsp;<span class="ident" id="4616205">errors</span><span class="op" id="4616211">.</span><span class="ident" id="4616212">New</span><span class="op" id="4616215">(</span><span class="string" id="4616216">&#34;tls:&nbsp;failed&nbsp;to&nbsp;verify&nbsp;client&#39;s&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4616263">+</span>&nbsp;<span class="ident" id="4616265">err</span><span class="op" id="4616268">.</span><span class="ident" id="4616269">Error</span><span class="op" id="4616274">(</span><span class="op" id="4616275">)</span><span class="op" id="4616276">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4616280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4616285">ok</span>&nbsp;<span class="op" id="4616288">:=</span>&nbsp;<span class="builtintype" id="4616291">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4616299">for</span>&nbsp;<span class="ident" id="4616303">_</span><span class="op" id="4616304">,</span>&nbsp;<span class="ident" id="4616306">ku</span>&nbsp;<span class="op" id="4616309">:=</span>&nbsp;<span class="keyword" id="4616312">range</span>&nbsp;<span class="ident" id="4616318">certs</span><span class="op" id="4616323">[</span><span class="num" id="4616324">0</span><span class="op" id="4616325">]</span><span class="op" id="4616326">.</span><span class="ident" id="4616327">ExtKeyUsage</span>&nbsp;<span class="op" id="4616339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4616344">if</span>&nbsp;<span class="ident" id="4616347">ku</span>&nbsp;<span class="op" id="4616350">==</span>&nbsp;<span class="ident" id="4616353">x509</span><span class="op" id="4616357">.</span><span class="ident" id="4616358">ExtKeyUsageClientAuth</span>&nbsp;<span class="op" id="4616380">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4616386">ok</span>&nbsp;<span class="op" id="4616389">=</span>&nbsp;<span class="builtintype" id="4616391">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4616400">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4616409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4616413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4616417">if</span>&nbsp;<span class="op" id="4616420">!</span><span class="ident" id="4616421">ok</span>&nbsp;<span class="op" id="4616424">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4616429">c</span><span class="op" id="4616430">.</span><span class="ident" id="4616431">sendAlert</span><span class="op" id="4616440">(</span><span class="ident" id="4616441">alertHandshakeFailure</span><span class="op" id="4616462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4616467">return</span>&nbsp;<span class="ident" id="4616474">nil</span><span class="op" id="4616477">,</span>&nbsp;<span class="ident" id="4616479">errors</span><span class="op" id="4616485">.</span><span class="ident" id="4616486">New</span><span class="op" id="4616489">(</span><span class="string" id="4616490">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&#39;s&nbsp;extended&nbsp;key&nbsp;usage&nbsp;doesn&#39;t&nbsp;permit&nbsp;it&nbsp;to&nbsp;be&nbsp;used&nbsp;for&nbsp;client&nbsp;authentication&#34;</span><span class="op" id="4616593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4616597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4616602">c</span><span class="op" id="4616603">.</span><span class="ident" id="4616604">verifiedChains</span>&nbsp;<span class="op" id="4616619">=</span>&nbsp;<span class="ident" id="4616621">chains</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4616629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4616633">if</span>&nbsp;<span class="builtinfunc" id="4616636">len</span><span class="op" id="4616639">(</span><span class="ident" id="4616640">certs</span><span class="op" id="4616645">)</span>&nbsp;<span class="op" id="4616647">&gt;</span>&nbsp;<span class="num" id="4616649">0</span>&nbsp;<span class="op" id="4616651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4616655">var</span>&nbsp;<span class="ident" id="4616659">pub</span>&nbsp;<span class="ident" id="4616663">crypto</span><span class="op" id="4616669">.</span><span class="ident" id="4616670">PublicKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4616682">switch</span>&nbsp;<span class="ident" id="4616689">key</span>&nbsp;<span class="op" id="4616693">:=</span>&nbsp;<span class="ident" id="4616696">certs</span><span class="op" id="4616701">[</span><span class="num" id="4616702">0</span><span class="op" id="4616703">]</span><span class="op" id="4616704">.</span><span class="ident" id="4616705">PublicKey</span><span class="op" id="4616714">.</span><span class="op" id="4616715">(</span><span class="keyword" id="4616716">type</span><span class="op" id="4616720">)</span>&nbsp;<span class="op" id="4616722">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4616726">case</span>&nbsp;<span class="op" id="4616731">*</span><span class="ident" id="4616732">ecdsa</span><span class="op" id="4616737">.</span><span class="ident" id="4616738">PublicKey</span><span class="op" id="4616747">,</span>&nbsp;<span class="op" id="4616749">*</span><span class="ident" id="4616750">rsa</span><span class="op" id="4616753">.</span><span class="ident" id="4616754">PublicKey</span><span class="op" id="4616763">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4616768">pub</span>&nbsp;<span class="op" id="4616772">=</span>&nbsp;<span class="ident" id="4616774">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4616780">default</span><span class="op" id="4616787">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4616792">c</span><span class="op" id="4616793">.</span><span class="ident" id="4616794">sendAlert</span><span class="op" id="4616803">(</span><span class="ident" id="4616804">alertUnsupportedCertificate</span><span class="op" id="4616831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4616836">return</span>&nbsp;<span class="ident" id="4616843">nil</span><span class="op" id="4616846">,</span>&nbsp;<span class="ident" id="4616848">fmt</span><span class="op" id="4616851">.</span><span class="ident" id="4616852">Errorf</span><span class="op" id="4616858">(</span><span class="string" id="4616859">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;public&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&#34;</span><span class="op" id="4616932">,</span>&nbsp;<span class="ident" id="4616934">certs</span><span class="op" id="4616939">[</span><span class="num" id="4616940">0</span><span class="op" id="4616941">]</span><span class="op" id="4616942">.</span><span class="ident" id="4616943">PublicKey</span><span class="op" id="4616952">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4616956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4616960">c</span><span class="op" id="4616961">.</span><span class="ident" id="4616962">peerCertificates</span>&nbsp;<span class="op" id="4616979">=</span>&nbsp;<span class="ident" id="4616981">certs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4616989">return</span>&nbsp;<span class="ident" id="4616996">pub</span><span class="op" id="4616999">,</span>&nbsp;<span class="ident" id="4617001">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4617006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4617010">return</span>&nbsp;<span class="ident" id="4617017">nil</span><span class="op" id="4617020">,</span>&nbsp;<span class="ident" id="4617022">nil</span><br>
<span class="lineno"></span><span class="op" id="4617026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4617029">//&nbsp;tryCipherSuite&nbsp;returns&nbsp;a&nbsp;cipherSuite&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;if&nbsp;that&nbsp;cipher&nbsp;suite</span><br>
<span class="lineno"></span><span class="comment" id="4617108">//&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;use.</span><br>
<span class="lineno">655</span><span class="keyword" id="4617133">func</span>&nbsp;<span class="op" id="4617138">(</span><span class="ident" id="4617139">c</span>&nbsp;<span class="op" id="4617141">*</span><span class="ident" id="4617142">Conn</span><span class="op" id="4617146">)</span>&nbsp;<span class="ident" id="4617148">tryCipherSuite</span><span class="op" id="4617162">(</span><span class="ident" id="4617163">id</span>&nbsp;<span class="builtintype" id="4617166">uint16</span><span class="op" id="4617172">,</span>&nbsp;<span class="ident" id="4617174">supportedCipherSuites</span>&nbsp;<span class="op" id="4617196">[</span><span class="op" id="4617197">]</span><span class="builtintype" id="4617198">uint16</span><span class="op" id="4617204">,</span>&nbsp;<span class="ident" id="4617206">version</span>&nbsp;<span class="builtintype" id="4617214">uint16</span><span class="op" id="4617220">,</span>&nbsp;<span class="ident" id="4617222">ellipticOk</span><span class="op" id="4617232">,</span>&nbsp;<span class="ident" id="4617234">ecdsaOk</span>&nbsp;<span class="builtintype" id="4617242">bool</span><span class="op" id="4617246">)</span>&nbsp;<span class="op" id="4617248">*</span><span class="ident" id="4617249">cipherSuite</span>&nbsp;<span class="op" id="4617261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4617264">for</span>&nbsp;<span class="ident" id="4617268">_</span><span class="op" id="4617269">,</span>&nbsp;<span class="ident" id="4617271">supported</span>&nbsp;<span class="op" id="4617281">:=</span>&nbsp;<span class="keyword" id="4617284">range</span>&nbsp;<span class="ident" id="4617290">supportedCipherSuites</span>&nbsp;<span class="op" id="4617312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4617316">if</span>&nbsp;<span class="ident" id="4617319">id</span>&nbsp;<span class="op" id="4617322">==</span>&nbsp;<span class="ident" id="4617325">supported</span>&nbsp;<span class="op" id="4617335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4617340">var</span>&nbsp;<span class="ident" id="4617344">candidate</span>&nbsp;<span class="op" id="4617354">*</span><span class="ident" id="4617355">cipherSuite</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4617371">for</span>&nbsp;<span class="ident" id="4617375">_</span><span class="op" id="4617376">,</span>&nbsp;<span class="ident" id="4617378">s</span>&nbsp;<span class="op" id="4617380">:=</span>&nbsp;<span class="keyword" id="4617383">range</span>&nbsp;<span class="ident" id="4617389">cipherSuites</span>&nbsp;<span class="op" id="4617402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4617408">if</span>&nbsp;<span class="ident" id="4617411">s</span><span class="op" id="4617412">.</span><span class="ident" id="4617413">id</span>&nbsp;<span class="op" id="4617416">==</span>&nbsp;<span class="ident" id="4617419">id</span>&nbsp;<span class="op" id="4617422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4617429">candidate</span>&nbsp;<span class="op" id="4617439">=</span>&nbsp;<span class="ident" id="4617441">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4617448">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4617458">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4617463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4617468">if</span>&nbsp;<span class="ident" id="4617471">candidate</span>&nbsp;<span class="op" id="4617481">==</span>&nbsp;<span class="ident" id="4617484">nil</span>&nbsp;<span class="op" id="4617488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4617494">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4617506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4617511">//&nbsp;Don&#39;t&nbsp;select&nbsp;a&nbsp;ciphersuite&nbsp;which&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4617559">//&nbsp;support&nbsp;for&nbsp;this&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4617590">if</span>&nbsp;<span class="op" id="4617593">(</span><span class="ident" id="4617594">candidate</span><span class="op" id="4617603">.</span><span class="ident" id="4617604">flags</span><span class="op" id="4617609">&amp;</span><span class="ident" id="4617610">suiteECDHE</span>&nbsp;<span class="op" id="4617621">!=</span>&nbsp;<span class="num" id="4617624">0</span><span class="op" id="4617625">)</span>&nbsp;<span class="op" id="4617627">&amp;&amp;</span>&nbsp;<span class="op" id="4617630">!</span><span class="ident" id="4617631">ellipticOk</span>&nbsp;<span class="op" id="4617642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4617648">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4617660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4617665">if</span>&nbsp;<span class="op" id="4617668">(</span><span class="ident" id="4617669">candidate</span><span class="op" id="4617678">.</span><span class="ident" id="4617679">flags</span><span class="op" id="4617684">&amp;</span><span class="ident" id="4617685">suiteECDSA</span>&nbsp;<span class="op" id="4617696">!=</span>&nbsp;<span class="num" id="4617699">0</span><span class="op" id="4617700">)</span>&nbsp;<span class="op" id="4617702">!=</span>&nbsp;<span class="ident" id="4617705">ecdsaOk</span>&nbsp;<span class="op" id="4617713">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4617719">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4617731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4617736">if</span>&nbsp;<span class="ident" id="4617739">version</span>&nbsp;<span class="op" id="4617747">&lt;</span>&nbsp;<span class="ident" id="4617749">VersionTLS12</span>&nbsp;<span class="op" id="4617762">&amp;&amp;</span>&nbsp;<span class="ident" id="4617765">candidate</span><span class="op" id="4617774">.</span><span class="ident" id="4617775">flags</span><span class="op" id="4617780">&amp;</span><span class="ident" id="4617781">suiteTLS12</span>&nbsp;<span class="op" id="4617792">!=</span>&nbsp;<span class="num" id="4617795">0</span>&nbsp;<span class="op" id="4617797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4617803">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4617815">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4617820">return</span>&nbsp;<span class="ident" id="4617827">candidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4617839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4617842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4617846">return</span>&nbsp;<span class="ident" id="4617853">nil</span><br>
<span class="lineno">685</span><span class="op" id="4617857">}</span>
</div>
</body>
</html>
