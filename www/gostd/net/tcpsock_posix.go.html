<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4166112">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4166168">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4166222">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4166273">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4166351">package</span>&nbsp;<span class="ident" id="4166359">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4166364">import</span>&nbsp;<span class="op" id="4166371">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4166374">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4166380">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4166386">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4166397">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4166404">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="4166407">//&nbsp;BUG(rsc):&nbsp;On&nbsp;OpenBSD,&nbsp;listening&nbsp;on&nbsp;the&nbsp;&#34;tcp&#34;&nbsp;network&nbsp;does&nbsp;not&nbsp;listen&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4166483">//&nbsp;both&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;connections.&nbsp;This&nbsp;is&nbsp;due&nbsp;to&nbsp;the&nbsp;fact&nbsp;that&nbsp;IPv4&nbsp;traffic</span><br>
<span class="lineno"></span><span class="comment" id="4166560">//&nbsp;will&nbsp;not&nbsp;be&nbsp;routed&nbsp;to&nbsp;an&nbsp;IPv6&nbsp;socket&nbsp;-&nbsp;two&nbsp;separate&nbsp;sockets&nbsp;are&nbsp;required</span><br>
<span class="lineno"></span><span class="comment" id="4166636">//&nbsp;if&nbsp;both&nbsp;AFs&nbsp;are&nbsp;to&nbsp;be&nbsp;supported.&nbsp;See&nbsp;inet6(4)&nbsp;on&nbsp;OpenBSD&nbsp;for&nbsp;details.</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4166710">func</span>&nbsp;<span class="ident" id="4166715">sockaddrToTCP</span><span class="op" id="4166728">(</span><span class="ident" id="4166729">sa</span>&nbsp;<span class="ident" id="4166732">syscall</span><span class="op" id="4166739">.</span><span class="ident" id="4166740">Sockaddr</span><span class="op" id="4166748">)</span>&nbsp;<span class="ident" id="4166750">Addr</span>&nbsp;<span class="op" id="4166755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4166758">switch</span>&nbsp;<span class="ident" id="4166765">sa</span>&nbsp;<span class="op" id="4166768">:=</span>&nbsp;<span class="ident" id="4166771">sa</span><span class="op" id="4166773">.</span><span class="op" id="4166774">(</span><span class="keyword" id="4166775">type</span><span class="op" id="4166779">)</span>&nbsp;<span class="op" id="4166781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4166784">case</span>&nbsp;<span class="op" id="4166789">*</span><span class="ident" id="4166790">syscall</span><span class="op" id="4166797">.</span><span class="ident" id="4166798">SockaddrInet4</span><span class="op" id="4166811">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4166815">return</span>&nbsp;<span class="op" id="4166822">&amp;</span><span class="ident" id="4166823">TCPAddr</span><span class="op" id="4166830">{</span><span class="ident" id="4166831">IP</span><span class="op" id="4166833">:</span>&nbsp;<span class="ident" id="4166835">sa</span><span class="op" id="4166837">.</span><span class="ident" id="4166838">Addr</span><span class="op" id="4166842">[</span><span class="num" id="4166843">0</span><span class="op" id="4166844">:</span><span class="op" id="4166845">]</span><span class="op" id="4166846">,</span>&nbsp;<span class="ident" id="4166848">Port</span><span class="op" id="4166852">:</span>&nbsp;<span class="ident" id="4166854">sa</span><span class="op" id="4166856">.</span><span class="ident" id="4166857">Port</span><span class="op" id="4166861">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4166864">case</span>&nbsp;<span class="op" id="4166869">*</span><span class="ident" id="4166870">syscall</span><span class="op" id="4166877">.</span><span class="ident" id="4166878">SockaddrInet6</span><span class="op" id="4166891">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4166895">return</span>&nbsp;<span class="op" id="4166902">&amp;</span><span class="ident" id="4166903">TCPAddr</span><span class="op" id="4166910">{</span><span class="ident" id="4166911">IP</span><span class="op" id="4166913">:</span>&nbsp;<span class="ident" id="4166915">sa</span><span class="op" id="4166917">.</span><span class="ident" id="4166918">Addr</span><span class="op" id="4166922">[</span><span class="num" id="4166923">0</span><span class="op" id="4166924">:</span><span class="op" id="4166925">]</span><span class="op" id="4166926">,</span>&nbsp;<span class="ident" id="4166928">Port</span><span class="op" id="4166932">:</span>&nbsp;<span class="ident" id="4166934">sa</span><span class="op" id="4166936">.</span><span class="ident" id="4166937">Port</span><span class="op" id="4166941">,</span>&nbsp;<span class="ident" id="4166943">Zone</span><span class="op" id="4166947">:</span>&nbsp;<span class="ident" id="4166949">zoneToString</span><span class="op" id="4166961">(</span><span class="builtintype" id="4166962">int</span><span class="op" id="4166965">(</span><span class="ident" id="4166966">sa</span><span class="op" id="4166968">.</span><span class="ident" id="4166969">ZoneId</span><span class="op" id="4166975">)</span><span class="op" id="4166976">)</span><span class="op" id="4166977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4166980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4166983">return</span>&nbsp;<span class="ident" id="4166990">nil</span><br>
<span class="lineno"></span><span class="op" id="4166994">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="4166997">func</span>&nbsp;<span class="op" id="4167002">(</span><span class="ident" id="4167003">a</span>&nbsp;<span class="op" id="4167005">*</span><span class="ident" id="4167006">TCPAddr</span><span class="op" id="4167013">)</span>&nbsp;<span class="ident" id="4167015">family</span><span class="op" id="4167021">(</span><span class="op" id="4167022">)</span>&nbsp;<span class="builtintype" id="4167024">int</span>&nbsp;<span class="op" id="4167028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167031">if</span>&nbsp;<span class="ident" id="4167034">a</span>&nbsp;<span class="op" id="4167036">==</span>&nbsp;<span class="ident" id="4167039">nil</span>&nbsp;<span class="op" id="4167043">||</span>&nbsp;<span class="builtinfunc" id="4167046">len</span><span class="op" id="4167049">(</span><span class="ident" id="4167050">a</span><span class="op" id="4167051">.</span><span class="ident" id="4167052">IP</span><span class="op" id="4167054">)</span>&nbsp;<span class="op" id="4167056">&lt;=</span>&nbsp;<span class="ident" id="4167059">IPv4len</span>&nbsp;<span class="op" id="4167067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167071">return</span>&nbsp;<span class="ident" id="4167078">syscall</span><span class="op" id="4167085">.</span><span class="ident" id="4167086">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167095">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167098">if</span>&nbsp;<span class="ident" id="4167101">a</span><span class="op" id="4167102">.</span><span class="ident" id="4167103">IP</span><span class="op" id="4167105">.</span><span class="ident" id="4167106">To4</span><span class="op" id="4167109">(</span><span class="op" id="4167110">)</span>&nbsp;<span class="op" id="4167112">!=</span>&nbsp;<span class="ident" id="4167115">nil</span>&nbsp;<span class="op" id="4167119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167123">return</span>&nbsp;<span class="ident" id="4167130">syscall</span><span class="op" id="4167137">.</span><span class="ident" id="4167138">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167150">return</span>&nbsp;<span class="ident" id="4167157">syscall</span><span class="op" id="4167164">.</span><span class="ident" id="4167165">AF_INET6</span><br>
<span class="lineno"></span><span class="op" id="4167174">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="4167177">func</span>&nbsp;<span class="op" id="4167182">(</span><span class="ident" id="4167183">a</span>&nbsp;<span class="op" id="4167185">*</span><span class="ident" id="4167186">TCPAddr</span><span class="op" id="4167193">)</span>&nbsp;<span class="ident" id="4167195">isWildcard</span><span class="op" id="4167205">(</span><span class="op" id="4167206">)</span>&nbsp;<span class="builtintype" id="4167208">bool</span>&nbsp;<span class="op" id="4167213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167216">if</span>&nbsp;<span class="ident" id="4167219">a</span>&nbsp;<span class="op" id="4167221">==</span>&nbsp;<span class="ident" id="4167224">nil</span>&nbsp;<span class="op" id="4167228">||</span>&nbsp;<span class="ident" id="4167231">a</span><span class="op" id="4167232">.</span><span class="ident" id="4167233">IP</span>&nbsp;<span class="op" id="4167236">==</span>&nbsp;<span class="ident" id="4167239">nil</span>&nbsp;<span class="op" id="4167243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167247">return</span>&nbsp;<span class="builtintype" id="4167254">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167260">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167263">return</span>&nbsp;<span class="ident" id="4167270">a</span><span class="op" id="4167271">.</span><span class="ident" id="4167272">IP</span><span class="op" id="4167274">.</span><span class="ident" id="4167275">IsUnspecified</span><span class="op" id="4167288">(</span><span class="op" id="4167289">)</span><br>
<span class="lineno"></span><span class="op" id="4167291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4167294">func</span>&nbsp;<span class="op" id="4167299">(</span><span class="ident" id="4167300">a</span>&nbsp;<span class="op" id="4167302">*</span><span class="ident" id="4167303">TCPAddr</span><span class="op" id="4167310">)</span>&nbsp;<span class="ident" id="4167312">sockaddr</span><span class="op" id="4167320">(</span><span class="ident" id="4167321">family</span>&nbsp;<span class="builtintype" id="4167328">int</span><span class="op" id="4167331">)</span>&nbsp;<span class="op" id="4167333">(</span><span class="ident" id="4167334">syscall</span><span class="op" id="4167341">.</span><span class="ident" id="4167342">Sockaddr</span><span class="op" id="4167350">,</span>&nbsp;<span class="builtintype" id="4167352">error</span><span class="op" id="4167357">)</span>&nbsp;<span class="op" id="4167359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167362">if</span>&nbsp;<span class="ident" id="4167365">a</span>&nbsp;<span class="op" id="4167367">==</span>&nbsp;<span class="ident" id="4167370">nil</span>&nbsp;<span class="op" id="4167374">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167378">return</span>&nbsp;<span class="ident" id="4167385">nil</span><span class="op" id="4167388">,</span>&nbsp;<span class="ident" id="4167390">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167398">return</span>&nbsp;<span class="ident" id="4167405">ipToSockaddr</span><span class="op" id="4167417">(</span><span class="ident" id="4167418">family</span><span class="op" id="4167424">,</span>&nbsp;<span class="ident" id="4167426">a</span><span class="op" id="4167427">.</span><span class="ident" id="4167428">IP</span><span class="op" id="4167430">,</span>&nbsp;<span class="ident" id="4167432">a</span><span class="op" id="4167433">.</span><span class="ident" id="4167434">Port</span><span class="op" id="4167438">,</span>&nbsp;<span class="ident" id="4167440">a</span><span class="op" id="4167441">.</span><span class="ident" id="4167442">Zone</span><span class="op" id="4167446">)</span><br>
<span class="lineno"></span><span class="op" id="4167448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="4167451">//&nbsp;TCPConn&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Conn&nbsp;interface&nbsp;for&nbsp;TCP&nbsp;network</span><br>
<span class="lineno"></span><span class="comment" id="4167521">//&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="4167537">type</span>&nbsp;<span class="ident" id="4167542">TCPConn</span>&nbsp;<span class="keyword" id="4167550">struct</span>&nbsp;<span class="op" id="4167557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4167560">conn</span><br>
<span class="lineno"></span><span class="op" id="4167565">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="4167568">func</span>&nbsp;<span class="ident" id="4167573">newTCPConn</span><span class="op" id="4167583">(</span><span class="ident" id="4167584">fd</span>&nbsp;<span class="op" id="4167587">*</span><span class="ident" id="4167588">netFD</span><span class="op" id="4167593">)</span>&nbsp;<span class="op" id="4167595">*</span><span class="ident" id="4167596">TCPConn</span>&nbsp;<span class="op" id="4167604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4167607">c</span>&nbsp;<span class="op" id="4167609">:=</span>&nbsp;<span class="op" id="4167612">&amp;</span><span class="ident" id="4167613">TCPConn</span><span class="op" id="4167620">{</span><span class="ident" id="4167621">conn</span><span class="op" id="4167625">{</span><span class="ident" id="4167626">fd</span><span class="op" id="4167628">}</span><span class="op" id="4167629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4167632">c</span><span class="op" id="4167633">.</span><span class="ident" id="4167634">SetNoDelay</span><span class="op" id="4167644">(</span><span class="builtintype" id="4167645">true</span><span class="op" id="4167649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167652">return</span>&nbsp;<span class="ident" id="4167659">c</span><br>
<span class="lineno">65</span><span class="op" id="4167661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4167664">//&nbsp;ReadFrom&nbsp;implements&nbsp;the&nbsp;io.ReaderFrom&nbsp;ReadFrom&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="4167722">func</span>&nbsp;<span class="op" id="4167727">(</span><span class="ident" id="4167728">c</span>&nbsp;<span class="op" id="4167730">*</span><span class="ident" id="4167731">TCPConn</span><span class="op" id="4167738">)</span>&nbsp;<span class="ident" id="4167740">ReadFrom</span><span class="op" id="4167748">(</span><span class="ident" id="4167749">r</span>&nbsp;<span class="ident" id="4167751">io</span><span class="op" id="4167753">.</span><span class="ident" id="4167754">Reader</span><span class="op" id="4167760">)</span>&nbsp;<span class="op" id="4167762">(</span><span class="ident" id="4167763">int64</span><span class="op" id="4167768">,</span>&nbsp;<span class="builtintype" id="4167770">error</span><span class="op" id="4167775">)</span>&nbsp;<span class="op" id="4167777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167780">if</span>&nbsp;<span class="ident" id="4167783">n</span><span class="op" id="4167784">,</span>&nbsp;<span class="ident" id="4167786">err</span><span class="op" id="4167789">,</span>&nbsp;<span class="ident" id="4167791">handled</span>&nbsp;<span class="op" id="4167799">:=</span>&nbsp;<span class="ident" id="4167802">sendFile</span><span class="op" id="4167810">(</span><span class="ident" id="4167811">c</span><span class="op" id="4167812">.</span><span class="ident" id="4167813">fd</span><span class="op" id="4167815">,</span>&nbsp;<span class="ident" id="4167817">r</span><span class="op" id="4167818">)</span><span class="op" id="4167819">;</span>&nbsp;<span class="ident" id="4167821">handled</span>&nbsp;<span class="op" id="4167829">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167833">return</span>&nbsp;<span class="ident" id="4167840">n</span><span class="op" id="4167841">,</span>&nbsp;<span class="ident" id="4167843">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167851">return</span>&nbsp;<span class="ident" id="4167858">genericReadFrom</span><span class="op" id="4167873">(</span><span class="ident" id="4167874">c</span><span class="op" id="4167875">,</span>&nbsp;<span class="ident" id="4167877">r</span><span class="op" id="4167878">)</span><br>
<span class="lineno"></span><span class="op" id="4167880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="4167883">//&nbsp;CloseRead&nbsp;shuts&nbsp;down&nbsp;the&nbsp;reading&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4167947">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="4167986">func</span>&nbsp;<span class="op" id="4167991">(</span><span class="ident" id="4167992">c</span>&nbsp;<span class="op" id="4167994">*</span><span class="ident" id="4167995">TCPConn</span><span class="op" id="4168002">)</span>&nbsp;<span class="ident" id="4168004">CloseRead</span><span class="op" id="4168013">(</span><span class="op" id="4168014">)</span>&nbsp;<span class="builtintype" id="4168016">error</span>&nbsp;<span class="op" id="4168022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168025">if</span>&nbsp;<span class="op" id="4168028">!</span><span class="ident" id="4168029">c</span><span class="op" id="4168030">.</span><span class="ident" id="4168031">ok</span><span class="op" id="4168033">(</span><span class="op" id="4168034">)</span>&nbsp;<span class="op" id="4168036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168040">return</span>&nbsp;<span class="ident" id="4168047">syscall</span><span class="op" id="4168054">.</span><span class="ident" id="4168055">EINVAL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4168063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168066">return</span>&nbsp;<span class="ident" id="4168073">c</span><span class="op" id="4168074">.</span><span class="ident" id="4168075">fd</span><span class="op" id="4168077">.</span><span class="ident" id="4168078">closeRead</span><span class="op" id="4168087">(</span><span class="op" id="4168088">)</span><br>
<span class="lineno"></span><span class="op" id="4168090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4168093">//&nbsp;CloseWrite&nbsp;shuts&nbsp;down&nbsp;the&nbsp;writing&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno">85</span><span class="comment" id="4168158">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="4168197">func</span>&nbsp;<span class="op" id="4168202">(</span><span class="ident" id="4168203">c</span>&nbsp;<span class="op" id="4168205">*</span><span class="ident" id="4168206">TCPConn</span><span class="op" id="4168213">)</span>&nbsp;<span class="ident" id="4168215">CloseWrite</span><span class="op" id="4168225">(</span><span class="op" id="4168226">)</span>&nbsp;<span class="builtintype" id="4168228">error</span>&nbsp;<span class="op" id="4168234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168237">if</span>&nbsp;<span class="op" id="4168240">!</span><span class="ident" id="4168241">c</span><span class="op" id="4168242">.</span><span class="ident" id="4168243">ok</span><span class="op" id="4168245">(</span><span class="op" id="4168246">)</span>&nbsp;<span class="op" id="4168248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168252">return</span>&nbsp;<span class="ident" id="4168259">syscall</span><span class="op" id="4168266">.</span><span class="ident" id="4168267">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4168275">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168278">return</span>&nbsp;<span class="ident" id="4168285">c</span><span class="op" id="4168286">.</span><span class="ident" id="4168287">fd</span><span class="op" id="4168289">.</span><span class="ident" id="4168290">closeWrite</span><span class="op" id="4168300">(</span><span class="op" id="4168301">)</span><br>
<span class="lineno"></span><span class="op" id="4168303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4168306">//&nbsp;SetLinger&nbsp;sets&nbsp;the&nbsp;behavior&nbsp;of&nbsp;Close&nbsp;on&nbsp;a&nbsp;connection&nbsp;which&nbsp;still</span><br>
<span class="lineno"></span><span class="comment" id="4168374">//&nbsp;has&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;sent&nbsp;or&nbsp;to&nbsp;be&nbsp;acknowledged.</span><br>
<span class="lineno">95</span><span class="comment" id="4168428">//</span><br>
<span class="lineno"></span><span class="comment" id="4168431">//&nbsp;If&nbsp;sec&nbsp;&lt;&nbsp;0&nbsp;(the&nbsp;default),&nbsp;the&nbsp;operating&nbsp;system&nbsp;finishes&nbsp;sending&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4168502">//&nbsp;data&nbsp;in&nbsp;the&nbsp;background.</span><br>
<span class="lineno"></span><span class="comment" id="4168529">//</span><br>
<span class="lineno"></span><span class="comment" id="4168532">//&nbsp;If&nbsp;sec&nbsp;==&nbsp;0,&nbsp;the&nbsp;operating&nbsp;system&nbsp;discards&nbsp;any&nbsp;unsent&nbsp;or</span><br>
<span class="lineno">100</span><span class="comment" id="4168592">//&nbsp;unacknowledged&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="4168616">//</span><br>
<span class="lineno"></span><span class="comment" id="4168619">//&nbsp;If&nbsp;sec&nbsp;&gt;&nbsp;0,&nbsp;the&nbsp;data&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;background&nbsp;as&nbsp;with&nbsp;sec&nbsp;&lt;&nbsp;0.&nbsp;On</span><br>
<span class="lineno"></span><span class="comment" id="4168689">//&nbsp;some&nbsp;operating&nbsp;systems&nbsp;after&nbsp;sec&nbsp;seconds&nbsp;have&nbsp;elapsed&nbsp;any&nbsp;remaining</span><br>
<span class="lineno"></span><span class="comment" id="4168760">//&nbsp;unsent&nbsp;data&nbsp;may&nbsp;be&nbsp;discarded.</span><br>
<span class="lineno">105</span><span class="keyword" id="4168793">func</span>&nbsp;<span class="op" id="4168798">(</span><span class="ident" id="4168799">c</span>&nbsp;<span class="op" id="4168801">*</span><span class="ident" id="4168802">TCPConn</span><span class="op" id="4168809">)</span>&nbsp;<span class="ident" id="4168811">SetLinger</span><span class="op" id="4168820">(</span><span class="ident" id="4168821">sec</span>&nbsp;<span class="builtintype" id="4168825">int</span><span class="op" id="4168828">)</span>&nbsp;<span class="builtintype" id="4168830">error</span>&nbsp;<span class="op" id="4168836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168839">if</span>&nbsp;<span class="op" id="4168842">!</span><span class="ident" id="4168843">c</span><span class="op" id="4168844">.</span><span class="ident" id="4168845">ok</span><span class="op" id="4168847">(</span><span class="op" id="4168848">)</span>&nbsp;<span class="op" id="4168850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168854">return</span>&nbsp;<span class="ident" id="4168861">syscall</span><span class="op" id="4168868">.</span><span class="ident" id="4168869">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4168877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168880">return</span>&nbsp;<span class="ident" id="4168887">setLinger</span><span class="op" id="4168896">(</span><span class="ident" id="4168897">c</span><span class="op" id="4168898">.</span><span class="ident" id="4168899">fd</span><span class="op" id="4168901">,</span>&nbsp;<span class="ident" id="4168903">sec</span><span class="op" id="4168906">)</span><br>
<span class="lineno">110</span><span class="op" id="4168908">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4168911">//&nbsp;SetKeepAlive&nbsp;sets&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;send</span><br>
<span class="lineno"></span><span class="comment" id="4168973">//&nbsp;keepalive&nbsp;messages&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4169014">func</span>&nbsp;<span class="op" id="4169019">(</span><span class="ident" id="4169020">c</span>&nbsp;<span class="op" id="4169022">*</span><span class="ident" id="4169023">TCPConn</span><span class="op" id="4169030">)</span>&nbsp;<span class="ident" id="4169032">SetKeepAlive</span><span class="op" id="4169044">(</span><span class="ident" id="4169045">keepalive</span>&nbsp;<span class="builtintype" id="4169055">bool</span><span class="op" id="4169059">)</span>&nbsp;<span class="builtintype" id="4169061">error</span>&nbsp;<span class="op" id="4169067">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169070">if</span>&nbsp;<span class="op" id="4169073">!</span><span class="ident" id="4169074">c</span><span class="op" id="4169075">.</span><span class="ident" id="4169076">ok</span><span class="op" id="4169078">(</span><span class="op" id="4169079">)</span>&nbsp;<span class="op" id="4169081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169085">return</span>&nbsp;<span class="ident" id="4169092">syscall</span><span class="op" id="4169099">.</span><span class="ident" id="4169100">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169111">return</span>&nbsp;<span class="ident" id="4169118">setKeepAlive</span><span class="op" id="4169130">(</span><span class="ident" id="4169131">c</span><span class="op" id="4169132">.</span><span class="ident" id="4169133">fd</span><span class="op" id="4169135">,</span>&nbsp;<span class="ident" id="4169137">keepalive</span><span class="op" id="4169146">)</span><br>
<span class="lineno"></span><span class="op" id="4169148">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="4169151">//&nbsp;SetKeepAlivePeriod&nbsp;sets&nbsp;period&nbsp;between&nbsp;keep&nbsp;alives.</span><br>
<span class="lineno"></span><span class="keyword" id="4169206">func</span>&nbsp;<span class="op" id="4169211">(</span><span class="ident" id="4169212">c</span>&nbsp;<span class="op" id="4169214">*</span><span class="ident" id="4169215">TCPConn</span><span class="op" id="4169222">)</span>&nbsp;<span class="ident" id="4169224">SetKeepAlivePeriod</span><span class="op" id="4169242">(</span><span class="ident" id="4169243">d</span>&nbsp;<span class="ident" id="4169245">time</span><span class="op" id="4169249">.</span><span class="ident" id="4169250">Duration</span><span class="op" id="4169258">)</span>&nbsp;<span class="builtintype" id="4169260">error</span>&nbsp;<span class="op" id="4169266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169269">if</span>&nbsp;<span class="op" id="4169272">!</span><span class="ident" id="4169273">c</span><span class="op" id="4169274">.</span><span class="ident" id="4169275">ok</span><span class="op" id="4169277">(</span><span class="op" id="4169278">)</span>&nbsp;<span class="op" id="4169280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169284">return</span>&nbsp;<span class="ident" id="4169291">syscall</span><span class="op" id="4169298">.</span><span class="ident" id="4169299">EINVAL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169310">return</span>&nbsp;<span class="ident" id="4169317">setKeepAlivePeriod</span><span class="op" id="4169335">(</span><span class="ident" id="4169336">c</span><span class="op" id="4169337">.</span><span class="ident" id="4169338">fd</span><span class="op" id="4169340">,</span>&nbsp;<span class="ident" id="4169342">d</span><span class="op" id="4169343">)</span><br>
<span class="lineno"></span><span class="op" id="4169345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4169348">//&nbsp;SetNoDelay&nbsp;controls&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;delay</span><br>
<span class="lineno">130</span><span class="comment" id="4169413">//&nbsp;packet&nbsp;transmission&nbsp;in&nbsp;hopes&nbsp;of&nbsp;sending&nbsp;fewer&nbsp;packets&nbsp;(Nagle&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4169479">//&nbsp;algorithm).&nbsp;&nbsp;The&nbsp;default&nbsp;is&nbsp;true&nbsp;(no&nbsp;delay),&nbsp;meaning&nbsp;that&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4169548">//&nbsp;sent&nbsp;as&nbsp;soon&nbsp;as&nbsp;possible&nbsp;after&nbsp;a&nbsp;Write.</span><br>
<span class="lineno"></span><span class="keyword" id="4169591">func</span>&nbsp;<span class="op" id="4169596">(</span><span class="ident" id="4169597">c</span>&nbsp;<span class="op" id="4169599">*</span><span class="ident" id="4169600">TCPConn</span><span class="op" id="4169607">)</span>&nbsp;<span class="ident" id="4169609">SetNoDelay</span><span class="op" id="4169619">(</span><span class="ident" id="4169620">noDelay</span>&nbsp;<span class="builtintype" id="4169628">bool</span><span class="op" id="4169632">)</span>&nbsp;<span class="builtintype" id="4169634">error</span>&nbsp;<span class="op" id="4169640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169643">if</span>&nbsp;<span class="op" id="4169646">!</span><span class="ident" id="4169647">c</span><span class="op" id="4169648">.</span><span class="ident" id="4169649">ok</span><span class="op" id="4169651">(</span><span class="op" id="4169652">)</span>&nbsp;<span class="op" id="4169654">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169658">return</span>&nbsp;<span class="ident" id="4169665">syscall</span><span class="op" id="4169672">.</span><span class="ident" id="4169673">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169684">return</span>&nbsp;<span class="ident" id="4169691">setNoDelay</span><span class="op" id="4169701">(</span><span class="ident" id="4169702">c</span><span class="op" id="4169703">.</span><span class="ident" id="4169704">fd</span><span class="op" id="4169706">,</span>&nbsp;<span class="ident" id="4169708">noDelay</span><span class="op" id="4169715">)</span><br>
<span class="lineno"></span><span class="op" id="4169717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="4169720">//&nbsp;DialTCP&nbsp;connects&nbsp;to&nbsp;the&nbsp;remote&nbsp;address&nbsp;raddr&nbsp;on&nbsp;the&nbsp;network&nbsp;net,</span><br>
<span class="lineno"></span><span class="comment" id="4169788">//&nbsp;which&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;is&nbsp;not&nbsp;nil,&nbsp;it&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4169859">//&nbsp;used&nbsp;as&nbsp;the&nbsp;local&nbsp;address&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4169908">func</span>&nbsp;<span class="ident" id="4169913">DialTCP</span><span class="op" id="4169920">(</span><span class="ident" id="4169921">net</span>&nbsp;<span class="builtintype" id="4169925">string</span><span class="op" id="4169931">,</span>&nbsp;<span class="ident" id="4169933">laddr</span><span class="op" id="4169938">,</span>&nbsp;<span class="ident" id="4169940">raddr</span>&nbsp;<span class="op" id="4169946">*</span><span class="ident" id="4169947">TCPAddr</span><span class="op" id="4169954">)</span>&nbsp;<span class="op" id="4169956">(</span><span class="op" id="4169957">*</span><span class="ident" id="4169958">TCPConn</span><span class="op" id="4169965">,</span>&nbsp;<span class="builtintype" id="4169967">error</span><span class="op" id="4169972">)</span>&nbsp;<span class="op" id="4169974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169977">switch</span>&nbsp;<span class="ident" id="4169984">net</span>&nbsp;<span class="op" id="4169988">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169991">case</span>&nbsp;<span class="string" id="4169996">&#34;tcp&#34;</span><span class="op" id="4170001">,</span>&nbsp;<span class="string" id="4170003">&#34;tcp4&#34;</span><span class="op" id="4170009">,</span>&nbsp;<span class="string" id="4170011">&#34;tcp6&#34;</span><span class="op" id="4170017">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170020">default</span><span class="op" id="4170027">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170031">return</span>&nbsp;<span class="ident" id="4170038">nil</span><span class="op" id="4170041">,</span>&nbsp;<span class="op" id="4170043">&amp;</span><span class="ident" id="4170044">OpError</span><span class="op" id="4170051">{</span><span class="ident" id="4170052">Op</span><span class="op" id="4170054">:</span>&nbsp;<span class="string" id="4170056">&#34;dial&#34;</span><span class="op" id="4170062">,</span>&nbsp;<span class="ident" id="4170064">Net</span><span class="op" id="4170067">:</span>&nbsp;<span class="ident" id="4170069">net</span><span class="op" id="4170072">,</span>&nbsp;<span class="ident" id="4170074">Addr</span><span class="op" id="4170078">:</span>&nbsp;<span class="ident" id="4170080">raddr</span><span class="op" id="4170085">,</span>&nbsp;<span class="ident" id="4170087">Err</span><span class="op" id="4170090">:</span>&nbsp;<span class="ident" id="4170092">UnknownNetworkError</span><span class="op" id="4170111">(</span><span class="ident" id="4170112">net</span><span class="op" id="4170115">)</span><span class="op" id="4170116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4170119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170122">if</span>&nbsp;<span class="ident" id="4170125">raddr</span>&nbsp;<span class="op" id="4170131">==</span>&nbsp;<span class="ident" id="4170134">nil</span>&nbsp;<span class="op" id="4170138">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170142">return</span>&nbsp;<span class="ident" id="4170149">nil</span><span class="op" id="4170152">,</span>&nbsp;<span class="op" id="4170154">&amp;</span><span class="ident" id="4170155">OpError</span><span class="op" id="4170162">{</span><span class="ident" id="4170163">Op</span><span class="op" id="4170165">:</span>&nbsp;<span class="string" id="4170167">&#34;dial&#34;</span><span class="op" id="4170173">,</span>&nbsp;<span class="ident" id="4170175">Net</span><span class="op" id="4170178">:</span>&nbsp;<span class="ident" id="4170180">net</span><span class="op" id="4170183">,</span>&nbsp;<span class="ident" id="4170185">Addr</span><span class="op" id="4170189">:</span>&nbsp;<span class="ident" id="4170191">nil</span><span class="op" id="4170194">,</span>&nbsp;<span class="ident" id="4170196">Err</span><span class="op" id="4170199">:</span>&nbsp;<span class="ident" id="4170201">errMissingAddress</span><span class="op" id="4170218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4170221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170224">return</span>&nbsp;<span class="ident" id="4170231">dialTCP</span><span class="op" id="4170238">(</span><span class="ident" id="4170239">net</span><span class="op" id="4170242">,</span>&nbsp;<span class="ident" id="4170244">laddr</span><span class="op" id="4170249">,</span>&nbsp;<span class="ident" id="4170251">raddr</span><span class="op" id="4170256">,</span>&nbsp;<span class="ident" id="4170258">noDeadline</span><span class="op" id="4170268">)</span><br>
<span class="lineno"></span><span class="op" id="4170270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="keyword" id="4170273">func</span>&nbsp;<span class="ident" id="4170278">dialTCP</span><span class="op" id="4170285">(</span><span class="ident" id="4170286">net</span>&nbsp;<span class="builtintype" id="4170290">string</span><span class="op" id="4170296">,</span>&nbsp;<span class="ident" id="4170298">laddr</span><span class="op" id="4170303">,</span>&nbsp;<span class="ident" id="4170305">raddr</span>&nbsp;<span class="op" id="4170311">*</span><span class="ident" id="4170312">TCPAddr</span><span class="op" id="4170319">,</span>&nbsp;<span class="ident" id="4170321">deadline</span>&nbsp;<span class="ident" id="4170330">time</span><span class="op" id="4170334">.</span><span class="ident" id="4170335">Time</span><span class="op" id="4170339">)</span>&nbsp;<span class="op" id="4170341">(</span><span class="op" id="4170342">*</span><span class="ident" id="4170343">TCPConn</span><span class="op" id="4170350">,</span>&nbsp;<span class="builtintype" id="4170352">error</span><span class="op" id="4170357">)</span>&nbsp;<span class="op" id="4170359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170362">fd</span><span class="op" id="4170364">,</span>&nbsp;<span class="ident" id="4170366">err</span>&nbsp;<span class="op" id="4170370">:=</span>&nbsp;<span class="ident" id="4170373">internetSocket</span><span class="op" id="4170387">(</span><span class="ident" id="4170388">net</span><span class="op" id="4170391">,</span>&nbsp;<span class="ident" id="4170393">laddr</span><span class="op" id="4170398">,</span>&nbsp;<span class="ident" id="4170400">raddr</span><span class="op" id="4170405">,</span>&nbsp;<span class="ident" id="4170407">deadline</span><span class="op" id="4170415">,</span>&nbsp;<span class="ident" id="4170417">syscall</span><span class="op" id="4170424">.</span><span class="ident" id="4170425">SOCK_STREAM</span><span class="op" id="4170436">,</span>&nbsp;<span class="num" id="4170438">0</span><span class="op" id="4170439">,</span>&nbsp;<span class="string" id="4170441">&#34;dial&#34;</span><span class="op" id="4170447">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4170451">//&nbsp;TCP&nbsp;has&nbsp;a&nbsp;rarely&nbsp;used&nbsp;mechanism&nbsp;called&nbsp;a&nbsp;&#39;simultaneous&nbsp;connection&#39;&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4170525">//&nbsp;which&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr1,&nbsp;addr2)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine&nbsp;at&nbsp;addr1&nbsp;can</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4170593">//&nbsp;connect&nbsp;to&nbsp;a&nbsp;simultaneous&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr2,&nbsp;addr1)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4170668">//&nbsp;at&nbsp;addr2,&nbsp;without&nbsp;either&nbsp;machine&nbsp;executing&nbsp;Listen.&nbsp;&nbsp;If&nbsp;laddr&nbsp;==&nbsp;nil,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4170741">//&nbsp;it&nbsp;means&nbsp;we&nbsp;want&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate&nbsp;originating&nbsp;local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4170814">//&nbsp;address.&nbsp;&nbsp;Some&nbsp;Linux&nbsp;kernels&nbsp;cycle&nbsp;blindly&nbsp;through&nbsp;a&nbsp;fixed&nbsp;range&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4170886">//&nbsp;local&nbsp;ports,&nbsp;regardless&nbsp;of&nbsp;destination&nbsp;port.&nbsp;&nbsp;If&nbsp;a&nbsp;kernel&nbsp;happens&nbsp;to</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4170959">//&nbsp;pick&nbsp;local&nbsp;port&nbsp;50001&nbsp;as&nbsp;the&nbsp;source&nbsp;for&nbsp;a&nbsp;Dial(&#34;tcp&#34;,&nbsp;&#34;&#34;,&nbsp;&#34;localhost:50001&#34;),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171041">//&nbsp;then&nbsp;the&nbsp;Dial&nbsp;will&nbsp;succeed,&nbsp;having&nbsp;simultaneously&nbsp;connected&nbsp;to&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171116">//&nbsp;This&nbsp;can&nbsp;only&nbsp;happen&nbsp;when&nbsp;we&nbsp;are&nbsp;letting&nbsp;the&nbsp;kernel&nbsp;pick&nbsp;a&nbsp;port&nbsp;(laddr&nbsp;==&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171199">//&nbsp;and&nbsp;when&nbsp;there&nbsp;is&nbsp;no&nbsp;listener&nbsp;for&nbsp;the&nbsp;destination&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171262">//&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;argue&nbsp;this&nbsp;is&nbsp;anything&nbsp;other&nbsp;than&nbsp;a&nbsp;kernel&nbsp;bug.&nbsp;&nbsp;If&nbsp;we</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171334">//&nbsp;see&nbsp;this&nbsp;happen,&nbsp;rather&nbsp;than&nbsp;expose&nbsp;the&nbsp;buggy&nbsp;effect&nbsp;to&nbsp;users,&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171404">//&nbsp;close&nbsp;the&nbsp;fd&nbsp;and&nbsp;try&nbsp;again.&nbsp;&nbsp;If&nbsp;it&nbsp;happens&nbsp;twice&nbsp;more,&nbsp;we&nbsp;relent&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171477">//&nbsp;use&nbsp;the&nbsp;result.&nbsp;&nbsp;See&nbsp;also:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171508">//&nbsp;&nbsp;&nbsp;&nbsphttp://golang.org/issue/2690</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171541">//&nbsp;&nbsp;&nbsp;&nbsphttp://stackoverflow.com/questions/4949858/</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171589">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171593">//&nbsp;The&nbsp;opposite&nbsp;can&nbsp;also&nbsp;happen:&nbsp;if&nbsp;we&nbsp;ask&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171671">//&nbsp;originating&nbsp;local&nbsp;address,&nbsp;sometimes&nbsp;it&nbsp;picks&nbsp;one&nbsp;that&nbsp;is&nbsp;already&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171749">//&nbsp;So&nbsp;if&nbsp;the&nbsp;error&nbsp;is&nbsp;EADDRNOTAVAIL,&nbsp;we&nbsp;have&nbsp;to&nbsp;try&nbsp;again&nbsp;too,&nbsp;just&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171822">//&nbsp;a&nbsp;different&nbsp;reason.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171846">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171850">//&nbsp;The&nbsp;kernel&nbsp;socket&nbsp;code&nbsp;is&nbsp;no&nbsp;doubt&nbsp;enjoying&nbsp;watching&nbsp;us&nbsp;squirm.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171918">for</span>&nbsp;<span class="ident" id="4171922">i</span>&nbsp;<span class="op" id="4171924">:=</span>&nbsp;<span class="num" id="4171927">0</span><span class="op" id="4171928">;</span>&nbsp;<span class="ident" id="4171930">i</span>&nbsp;<span class="op" id="4171932">&lt;</span>&nbsp;<span class="num" id="4171934">2</span>&nbsp;<span class="op" id="4171936">&amp;&amp;</span>&nbsp;<span class="op" id="4171939">(</span><span class="ident" id="4171940">laddr</span>&nbsp;<span class="op" id="4171946">==</span>&nbsp;<span class="ident" id="4171949">nil</span>&nbsp;<span class="op" id="4171953">||</span>&nbsp;<span class="ident" id="4171956">laddr</span><span class="op" id="4171961">.</span><span class="ident" id="4171962">Port</span>&nbsp;<span class="op" id="4171967">==</span>&nbsp;<span class="num" id="4171970">0</span><span class="op" id="4171971">)</span>&nbsp;<span class="op" id="4171973">&amp;&amp;</span>&nbsp;<span class="op" id="4171976">(</span><span class="ident" id="4171977">selfConnect</span><span class="op" id="4171988">(</span><span class="ident" id="4171989">fd</span><span class="op" id="4171991">,</span>&nbsp;<span class="ident" id="4171993">err</span><span class="op" id="4171996">)</span>&nbsp;<span class="op" id="4171998">||</span>&nbsp;<span class="ident" id="4172001">spuriousENOTAVAIL</span><span class="op" id="4172018">(</span><span class="ident" id="4172019">err</span><span class="op" id="4172022">)</span><span class="op" id="4172023">)</span><span class="op" id="4172024">;</span>&nbsp;<span class="ident" id="4172026">i</span><span class="op" id="4172027">++</span>&nbsp;<span class="op" id="4172030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172034">if</span>&nbsp;<span class="ident" id="4172037">err</span>&nbsp;<span class="op" id="4172041">==</span>&nbsp;<span class="ident" id="4172044">nil</span>&nbsp;<span class="op" id="4172048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172053">fd</span><span class="op" id="4172055">.</span><span class="ident" id="4172056">Close</span><span class="op" id="4172061">(</span><span class="op" id="4172062">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172070">fd</span><span class="op" id="4172072">,</span>&nbsp;<span class="ident" id="4172074">err</span>&nbsp;<span class="op" id="4172078">=</span>&nbsp;<span class="ident" id="4172080">internetSocket</span><span class="op" id="4172094">(</span><span class="ident" id="4172095">net</span><span class="op" id="4172098">,</span>&nbsp;<span class="ident" id="4172100">laddr</span><span class="op" id="4172105">,</span>&nbsp;<span class="ident" id="4172107">raddr</span><span class="op" id="4172112">,</span>&nbsp;<span class="ident" id="4172114">deadline</span><span class="op" id="4172122">,</span>&nbsp;<span class="ident" id="4172124">syscall</span><span class="op" id="4172131">.</span><span class="ident" id="4172132">SOCK_STREAM</span><span class="op" id="4172143">,</span>&nbsp;<span class="num" id="4172145">0</span><span class="op" id="4172146">,</span>&nbsp;<span class="string" id="4172148">&#34;dial&#34;</span><span class="op" id="4172154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172161">if</span>&nbsp;<span class="ident" id="4172164">err</span>&nbsp;<span class="op" id="4172168">!=</span>&nbsp;<span class="ident" id="4172171">nil</span>&nbsp;<span class="op" id="4172175">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172179">return</span>&nbsp;<span class="ident" id="4172186">nil</span><span class="op" id="4172189">,</span>&nbsp;<span class="op" id="4172191">&amp;</span><span class="ident" id="4172192">OpError</span><span class="op" id="4172199">{</span><span class="ident" id="4172200">Op</span><span class="op" id="4172202">:</span>&nbsp;<span class="string" id="4172204">&#34;dial&#34;</span><span class="op" id="4172210">,</span>&nbsp;<span class="ident" id="4172212">Net</span><span class="op" id="4172215">:</span>&nbsp;<span class="ident" id="4172217">net</span><span class="op" id="4172220">,</span>&nbsp;<span class="ident" id="4172222">Addr</span><span class="op" id="4172226">:</span>&nbsp;<span class="ident" id="4172228">raddr</span><span class="op" id="4172233">,</span>&nbsp;<span class="ident" id="4172235">Err</span><span class="op" id="4172238">:</span>&nbsp;<span class="ident" id="4172240">err</span><span class="op" id="4172243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172249">return</span>&nbsp;<span class="ident" id="4172256">newTCPConn</span><span class="op" id="4172266">(</span><span class="ident" id="4172267">fd</span><span class="op" id="4172269">)</span><span class="op" id="4172270">,</span>&nbsp;<span class="ident" id="4172272">nil</span><br>
<span class="lineno"></span><span class="op" id="4172276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="4172279">func</span>&nbsp;<span class="ident" id="4172284">selfConnect</span><span class="op" id="4172295">(</span><span class="ident" id="4172296">fd</span>&nbsp;<span class="op" id="4172299">*</span><span class="ident" id="4172300">netFD</span><span class="op" id="4172305">,</span>&nbsp;<span class="ident" id="4172307">err</span>&nbsp;<span class="builtintype" id="4172311">error</span><span class="op" id="4172316">)</span>&nbsp;<span class="builtintype" id="4172318">bool</span>&nbsp;<span class="op" id="4172323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172326">//&nbsp;If&nbsp;the&nbsp;connect&nbsp;failed,&nbsp;we&nbsp;clearly&nbsp;didn&#39;t&nbsp;connect&nbsp;to&nbsp;ourselves.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172393">if</span>&nbsp;<span class="ident" id="4172396">err</span>&nbsp;<span class="op" id="4172400">!=</span>&nbsp;<span class="ident" id="4172403">nil</span>&nbsp;<span class="op" id="4172407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172411">return</span>&nbsp;<span class="builtintype" id="4172418">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172425">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172429">//&nbsp;The&nbsp;socket&nbsp;constructor&nbsp;can&nbsp;return&nbsp;an&nbsp;fd&nbsp;with&nbsp;raddr&nbsp;nil&nbsp;under&nbsp;certain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172502">//&nbsp;unknown&nbsp;conditions.&nbsp;The&nbsp;errors&nbsp;in&nbsp;the&nbsp;calls&nbsp;there&nbsp;to&nbsp;Getpeername</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172571">//&nbsp;are&nbsp;discarded,&nbsp;but&nbsp;we&nbsp;can&#39;t&nbsp;catch&nbsp;the&nbsp;problem&nbsp;there&nbsp;because&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172641">//&nbsp;calls&nbsp;are&nbsp;sometimes&nbsp;legally&nbsp;erroneous&nbsp;with&nbsp;a&nbsp;&#34;socket&nbsp;not&nbsp;connected&#34;.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172714">//&nbsp;Since&nbsp;this&nbsp;code&nbsp;(selfConnect)&nbsp;is&nbsp;already&nbsp;trying&nbsp;to&nbsp;work&nbsp;around</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172781">//&nbsp;a&nbsp;problem,&nbsp;we&nbsp;make&nbsp;sure&nbsp;if&nbsp;this&nbsp;happens&nbsp;we&nbsp;recognize&nbsp;trouble&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172850">//&nbsp;ask&nbsp;the&nbsp;DialTCP&nbsp;routine&nbsp;to&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172892">//&nbsp;TODO:&nbsp;try&nbsp;to&nbsp;understand&nbsp;what&#39;s&nbsp;really&nbsp;going&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172944">if</span>&nbsp;<span class="ident" id="4172947">fd</span><span class="op" id="4172949">.</span><span class="ident" id="4172950">laddr</span>&nbsp;<span class="op" id="4172956">==</span>&nbsp;<span class="ident" id="4172959">nil</span>&nbsp;<span class="op" id="4172963">||</span>&nbsp;<span class="ident" id="4172966">fd</span><span class="op" id="4172968">.</span><span class="ident" id="4172969">raddr</span>&nbsp;<span class="op" id="4172975">==</span>&nbsp;<span class="ident" id="4172978">nil</span>&nbsp;<span class="op" id="4172982">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172986">return</span>&nbsp;<span class="builtintype" id="4172993">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173002">l</span>&nbsp;<span class="op" id="4173004">:=</span>&nbsp;<span class="ident" id="4173007">fd</span><span class="op" id="4173009">.</span><span class="ident" id="4173010">laddr</span><span class="op" id="4173015">.</span><span class="op" id="4173016">(</span><span class="op" id="4173017">*</span><span class="ident" id="4173018">TCPAddr</span><span class="op" id="4173025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173028">r</span>&nbsp;<span class="op" id="4173030">:=</span>&nbsp;<span class="ident" id="4173033">fd</span><span class="op" id="4173035">.</span><span class="ident" id="4173036">raddr</span><span class="op" id="4173041">.</span><span class="op" id="4173042">(</span><span class="op" id="4173043">*</span><span class="ident" id="4173044">TCPAddr</span><span class="op" id="4173051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173054">return</span>&nbsp;<span class="ident" id="4173061">l</span><span class="op" id="4173062">.</span><span class="ident" id="4173063">Port</span>&nbsp;<span class="op" id="4173068">==</span>&nbsp;<span class="ident" id="4173071">r</span><span class="op" id="4173072">.</span><span class="ident" id="4173073">Port</span>&nbsp;<span class="op" id="4173078">&amp;&amp;</span>&nbsp;<span class="ident" id="4173081">l</span><span class="op" id="4173082">.</span><span class="ident" id="4173083">IP</span><span class="op" id="4173085">.</span><span class="ident" id="4173086">Equal</span><span class="op" id="4173091">(</span><span class="ident" id="4173092">r</span><span class="op" id="4173093">.</span><span class="ident" id="4173094">IP</span><span class="op" id="4173096">)</span><br>
<span class="lineno">215</span><span class="op" id="4173098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4173101">func</span>&nbsp;<span class="ident" id="4173106">spuriousENOTAVAIL</span><span class="op" id="4173123">(</span><span class="ident" id="4173124">err</span>&nbsp;<span class="builtintype" id="4173128">error</span><span class="op" id="4173133">)</span>&nbsp;<span class="builtintype" id="4173135">bool</span>&nbsp;<span class="op" id="4173140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173143">e</span><span class="op" id="4173144">,</span>&nbsp;<span class="ident" id="4173146">ok</span>&nbsp;<span class="op" id="4173149">:=</span>&nbsp;<span class="ident" id="4173152">err</span><span class="op" id="4173155">.</span><span class="op" id="4173156">(</span><span class="op" id="4173157">*</span><span class="ident" id="4173158">OpError</span><span class="op" id="4173165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173168">return</span>&nbsp;<span class="ident" id="4173175">ok</span>&nbsp;<span class="op" id="4173178">&amp;&amp;</span>&nbsp;<span class="ident" id="4173181">e</span><span class="op" id="4173182">.</span><span class="ident" id="4173183">Err</span>&nbsp;<span class="op" id="4173187">==</span>&nbsp;<span class="ident" id="4173190">syscall</span><span class="op" id="4173197">.</span><span class="ident" id="4173198">EADDRNOTAVAIL</span><br>
<span class="lineno">220</span><span class="op" id="4173212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4173215">//&nbsp;TCPListener&nbsp;is&nbsp;a&nbsp;TCP&nbsp;network&nbsp;listener.&nbsp;&nbsp;Clients&nbsp;should&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="4173283">//&nbsp;use&nbsp;variables&nbsp;of&nbsp;type&nbsp;Listener&nbsp;instead&nbsp;of&nbsp;assuming&nbsp;TCP.</span><br>
<span class="lineno"></span><span class="keyword" id="4173342">type</span>&nbsp;<span class="ident" id="4173347">TCPListener</span>&nbsp;<span class="keyword" id="4173359">struct</span>&nbsp;<span class="op" id="4173366">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173369">fd</span>&nbsp;<span class="op" id="4173372">*</span><span class="ident" id="4173373">netFD</span><br>
<span class="lineno"></span><span class="op" id="4173379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4173382">//&nbsp;AcceptTCP&nbsp;accepts&nbsp;the&nbsp;next&nbsp;incoming&nbsp;call&nbsp;and&nbsp;returns&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="4173446">//&nbsp;connection.</span><br>
<span class="lineno">230</span><span class="keyword" id="4173461">func</span>&nbsp;<span class="op" id="4173466">(</span><span class="ident" id="4173467">l</span>&nbsp;<span class="op" id="4173469">*</span><span class="ident" id="4173470">TCPListener</span><span class="op" id="4173481">)</span>&nbsp;<span class="ident" id="4173483">AcceptTCP</span><span class="op" id="4173492">(</span><span class="op" id="4173493">)</span>&nbsp;<span class="op" id="4173495">(</span><span class="op" id="4173496">*</span><span class="ident" id="4173497">TCPConn</span><span class="op" id="4173504">,</span>&nbsp;<span class="builtintype" id="4173506">error</span><span class="op" id="4173511">)</span>&nbsp;<span class="op" id="4173513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173516">if</span>&nbsp;<span class="ident" id="4173519">l</span>&nbsp;<span class="op" id="4173521">==</span>&nbsp;<span class="ident" id="4173524">nil</span>&nbsp;<span class="op" id="4173528">||</span>&nbsp;<span class="ident" id="4173531">l</span><span class="op" id="4173532">.</span><span class="ident" id="4173533">fd</span>&nbsp;<span class="op" id="4173536">==</span>&nbsp;<span class="ident" id="4173539">nil</span>&nbsp;<span class="op" id="4173543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173547">return</span>&nbsp;<span class="ident" id="4173554">nil</span><span class="op" id="4173557">,</span>&nbsp;<span class="ident" id="4173559">syscall</span><span class="op" id="4173566">.</span><span class="ident" id="4173567">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173578">fd</span><span class="op" id="4173580">,</span>&nbsp;<span class="ident" id="4173582">err</span>&nbsp;<span class="op" id="4173586">:=</span>&nbsp;<span class="ident" id="4173589">l</span><span class="op" id="4173590">.</span><span class="ident" id="4173591">fd</span><span class="op" id="4173593">.</span><span class="ident" id="4173594">accept</span><span class="op" id="4173600">(</span><span class="op" id="4173601">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173604">if</span>&nbsp;<span class="ident" id="4173607">err</span>&nbsp;<span class="op" id="4173611">!=</span>&nbsp;<span class="ident" id="4173614">nil</span>&nbsp;<span class="op" id="4173618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173622">return</span>&nbsp;<span class="ident" id="4173629">nil</span><span class="op" id="4173632">,</span>&nbsp;<span class="ident" id="4173634">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173642">return</span>&nbsp;<span class="ident" id="4173649">newTCPConn</span><span class="op" id="4173659">(</span><span class="ident" id="4173660">fd</span><span class="op" id="4173662">)</span><span class="op" id="4173663">,</span>&nbsp;<span class="ident" id="4173665">nil</span><br>
<span class="lineno"></span><span class="op" id="4173669">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment" id="4173672">//&nbsp;Accept&nbsp;implements&nbsp;the&nbsp;Accept&nbsp;method&nbsp;in&nbsp;the&nbsp;Listener&nbsp;interface;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="4173741">//&nbsp;waits&nbsp;for&nbsp;the&nbsp;next&nbsp;call&nbsp;and&nbsp;returns&nbsp;a&nbsp;generic&nbsp;Conn.</span><br>
<span class="lineno"></span><span class="keyword" id="4173796">func</span>&nbsp;<span class="op" id="4173801">(</span><span class="ident" id="4173802">l</span>&nbsp;<span class="op" id="4173804">*</span><span class="ident" id="4173805">TCPListener</span><span class="op" id="4173816">)</span>&nbsp;<span class="ident" id="4173818">Accept</span><span class="op" id="4173824">(</span><span class="op" id="4173825">)</span>&nbsp;<span class="op" id="4173827">(</span><span class="ident" id="4173828">Conn</span><span class="op" id="4173832">,</span>&nbsp;<span class="builtintype" id="4173834">error</span><span class="op" id="4173839">)</span>&nbsp;<span class="op" id="4173841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173844">c</span><span class="op" id="4173845">,</span>&nbsp;<span class="ident" id="4173847">err</span>&nbsp;<span class="op" id="4173851">:=</span>&nbsp;<span class="ident" id="4173854">l</span><span class="op" id="4173855">.</span><span class="ident" id="4173856">AcceptTCP</span><span class="op" id="4173865">(</span><span class="op" id="4173866">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173869">if</span>&nbsp;<span class="ident" id="4173872">err</span>&nbsp;<span class="op" id="4173876">!=</span>&nbsp;<span class="ident" id="4173879">nil</span>&nbsp;<span class="op" id="4173883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173887">return</span>&nbsp;<span class="ident" id="4173894">nil</span><span class="op" id="4173897">,</span>&nbsp;<span class="ident" id="4173899">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173907">return</span>&nbsp;<span class="ident" id="4173914">c</span><span class="op" id="4173915">,</span>&nbsp;<span class="ident" id="4173917">nil</span><br>
<span class="lineno"></span><span class="op" id="4173921">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="4173924">//&nbsp;Close&nbsp;stops&nbsp;listening&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="4173969">//&nbsp;Already&nbsp;Accepted&nbsp;connections&nbsp;are&nbsp;not&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="4174017">func</span>&nbsp;<span class="op" id="4174022">(</span><span class="ident" id="4174023">l</span>&nbsp;<span class="op" id="4174025">*</span><span class="ident" id="4174026">TCPListener</span><span class="op" id="4174037">)</span>&nbsp;<span class="ident" id="4174039">Close</span><span class="op" id="4174044">(</span><span class="op" id="4174045">)</span>&nbsp;<span class="builtintype" id="4174047">error</span>&nbsp;<span class="op" id="4174053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174056">if</span>&nbsp;<span class="ident" id="4174059">l</span>&nbsp;<span class="op" id="4174061">==</span>&nbsp;<span class="ident" id="4174064">nil</span>&nbsp;<span class="op" id="4174068">||</span>&nbsp;<span class="ident" id="4174071">l</span><span class="op" id="4174072">.</span><span class="ident" id="4174073">fd</span>&nbsp;<span class="op" id="4174076">==</span>&nbsp;<span class="ident" id="4174079">nil</span>&nbsp;<span class="op" id="4174083">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174087">return</span>&nbsp;<span class="ident" id="4174094">syscall</span><span class="op" id="4174101">.</span><span class="ident" id="4174102">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4174110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174113">return</span>&nbsp;<span class="ident" id="4174120">l</span><span class="op" id="4174121">.</span><span class="ident" id="4174122">fd</span><span class="op" id="4174124">.</span><span class="ident" id="4174125">Close</span><span class="op" id="4174130">(</span><span class="op" id="4174131">)</span><br>
<span class="lineno"></span><span class="op" id="4174133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="comment" id="4174136">//&nbsp;Addr&nbsp;returns&nbsp;the&nbsp;listener&#39;s&nbsp;network&nbsp;address,&nbsp;a&nbsp;*TCPAddr.</span><br>
<span class="lineno"></span><span class="keyword" id="4174196">func</span>&nbsp;<span class="op" id="4174201">(</span><span class="ident" id="4174202">l</span>&nbsp;<span class="op" id="4174204">*</span><span class="ident" id="4174205">TCPListener</span><span class="op" id="4174216">)</span>&nbsp;<span class="ident" id="4174218">Addr</span><span class="op" id="4174222">(</span><span class="op" id="4174223">)</span>&nbsp;<span class="ident" id="4174225">Addr</span>&nbsp;<span class="op" id="4174230">{</span>&nbsp;<span class="keyword" id="4174232">return</span>&nbsp;<span class="ident" id="4174239">l</span><span class="op" id="4174240">.</span><span class="ident" id="4174241">fd</span><span class="op" id="4174243">.</span><span class="ident" id="4174244">laddr</span>&nbsp;<span class="op" id="4174250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4174253">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;deadline&nbsp;associated&nbsp;with&nbsp;the&nbsp;listener.</span><br>
<span class="lineno"></span><span class="comment" id="4174316">//&nbsp;A&nbsp;zero&nbsp;time&nbsp;value&nbsp;disables&nbsp;the&nbsp;deadline.</span><br>
<span class="lineno">265</span><span class="keyword" id="4174360">func</span>&nbsp;<span class="op" id="4174365">(</span><span class="ident" id="4174366">l</span>&nbsp;<span class="op" id="4174368">*</span><span class="ident" id="4174369">TCPListener</span><span class="op" id="4174380">)</span>&nbsp;<span class="ident" id="4174382">SetDeadline</span><span class="op" id="4174393">(</span><span class="ident" id="4174394">t</span>&nbsp;<span class="ident" id="4174396">time</span><span class="op" id="4174400">.</span><span class="ident" id="4174401">Time</span><span class="op" id="4174405">)</span>&nbsp;<span class="builtintype" id="4174407">error</span>&nbsp;<span class="op" id="4174413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174416">if</span>&nbsp;<span class="ident" id="4174419">l</span>&nbsp;<span class="op" id="4174421">==</span>&nbsp;<span class="ident" id="4174424">nil</span>&nbsp;<span class="op" id="4174428">||</span>&nbsp;<span class="ident" id="4174431">l</span><span class="op" id="4174432">.</span><span class="ident" id="4174433">fd</span>&nbsp;<span class="op" id="4174436">==</span>&nbsp;<span class="ident" id="4174439">nil</span>&nbsp;<span class="op" id="4174443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174447">return</span>&nbsp;<span class="ident" id="4174454">syscall</span><span class="op" id="4174461">.</span><span class="ident" id="4174462">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4174470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174473">return</span>&nbsp;<span class="ident" id="4174480">l</span><span class="op" id="4174481">.</span><span class="ident" id="4174482">fd</span><span class="op" id="4174484">.</span><span class="ident" id="4174485">setDeadline</span><span class="op" id="4174496">(</span><span class="ident" id="4174497">t</span><span class="op" id="4174498">)</span><br>
<span class="lineno">270</span><span class="op" id="4174500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4174503">//&nbsp;File&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;underlying&nbsp;os.File,&nbsp;set&nbsp;to&nbsp;blocking</span><br>
<span class="lineno"></span><span class="comment" id="4174569">//&nbsp;mode.&nbsp;&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;close&nbsp;f&nbsp;when&nbsp;finished.</span><br>
<span class="lineno"></span><span class="comment" id="4174639">//&nbsp;Closing&nbsp;l&nbsp;does&nbsp;not&nbsp;affect&nbsp;f,&nbsp;and&nbsp;closing&nbsp;f&nbsp;does&nbsp;not&nbsp;affect&nbsp;l.</span><br>
<span class="lineno">275</span><span class="comment" id="4174704">//</span><br>
<span class="lineno"></span><span class="comment" id="4174707">//&nbsp;The&nbsp;returned&nbsp;os.File&#39;s&nbsp;file&nbsp;descriptor&nbsp;is&nbsp;different&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4174771">//&nbsp;connection&#39;s.&nbsp;&nbsp;Attempting&nbsp;to&nbsp;change&nbsp;properties&nbsp;of&nbsp;the&nbsp;original</span><br>
<span class="lineno"></span><span class="comment" id="4174837">//&nbsp;using&nbsp;this&nbsp;duplicate&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;have&nbsp;the&nbsp;desired&nbsp;effect.</span><br>
<span class="lineno"></span><span class="keyword" id="4174901">func</span>&nbsp;<span class="op" id="4174906">(</span><span class="ident" id="4174907">l</span>&nbsp;<span class="op" id="4174909">*</span><span class="ident" id="4174910">TCPListener</span><span class="op" id="4174921">)</span>&nbsp;<span class="ident" id="4174923">File</span><span class="op" id="4174927">(</span><span class="op" id="4174928">)</span>&nbsp;<span class="op" id="4174930">(</span><span class="ident" id="4174931">f</span>&nbsp;<span class="op" id="4174933">*</span><span class="ident" id="4174934">os</span><span class="op" id="4174936">.</span><span class="ident" id="4174937">File</span><span class="op" id="4174941">,</span>&nbsp;<span class="ident" id="4174943">err</span>&nbsp;<span class="builtintype" id="4174947">error</span><span class="op" id="4174952">)</span>&nbsp;<span class="op" id="4174954">{</span>&nbsp;<span class="keyword" id="4174956">return</span>&nbsp;<span class="ident" id="4174963">l</span><span class="op" id="4174964">.</span><span class="ident" id="4174965">fd</span><span class="op" id="4174967">.</span><span class="ident" id="4174968">dup</span><span class="op" id="4174971">(</span><span class="op" id="4174972">)</span>&nbsp;<span class="op" id="4174974">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="4174977">//&nbsp;ListenTCP&nbsp;announces&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address&nbsp;laddr&nbsp;and&nbsp;returns&nbsp;a&nbsp;TCP</span><br>
<span class="lineno"></span><span class="comment" id="4175043">//&nbsp;listener.&nbsp;&nbsp;Net&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;has&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4175111">//&nbsp;port&nbsp;of&nbsp;0,&nbsp;ListenTCP&nbsp;will&nbsp;choose&nbsp;an&nbsp;available&nbsp;port.&nbsp;&nbsp;The&nbsp;caller&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="4175182">//&nbsp;use&nbsp;the&nbsp;Addr&nbsp;method&nbsp;of&nbsp;TCPListener&nbsp;to&nbsp;retrieve&nbsp;the&nbsp;chosen&nbsp;address.</span><br>
<span class="lineno">285</span><span class="keyword" id="4175252">func</span>&nbsp;<span class="ident" id="4175257">ListenTCP</span><span class="op" id="4175266">(</span><span class="ident" id="4175267">net</span>&nbsp;<span class="builtintype" id="4175271">string</span><span class="op" id="4175277">,</span>&nbsp;<span class="ident" id="4175279">laddr</span>&nbsp;<span class="op" id="4175285">*</span><span class="ident" id="4175286">TCPAddr</span><span class="op" id="4175293">)</span>&nbsp;<span class="op" id="4175295">(</span><span class="op" id="4175296">*</span><span class="ident" id="4175297">TCPListener</span><span class="op" id="4175308">,</span>&nbsp;<span class="builtintype" id="4175310">error</span><span class="op" id="4175315">)</span>&nbsp;<span class="op" id="4175317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175320">switch</span>&nbsp;<span class="ident" id="4175327">net</span>&nbsp;<span class="op" id="4175331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175334">case</span>&nbsp;<span class="string" id="4175339">&#34;tcp&#34;</span><span class="op" id="4175344">,</span>&nbsp;<span class="string" id="4175346">&#34;tcp4&#34;</span><span class="op" id="4175352">,</span>&nbsp;<span class="string" id="4175354">&#34;tcp6&#34;</span><span class="op" id="4175360">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175363">default</span><span class="op" id="4175370">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175374">return</span>&nbsp;<span class="ident" id="4175381">nil</span><span class="op" id="4175384">,</span>&nbsp;<span class="op" id="4175386">&amp;</span><span class="ident" id="4175387">OpError</span><span class="op" id="4175394">{</span><span class="ident" id="4175395">Op</span><span class="op" id="4175397">:</span>&nbsp;<span class="string" id="4175399">&#34;listen&#34;</span><span class="op" id="4175407">,</span>&nbsp;<span class="ident" id="4175409">Net</span><span class="op" id="4175412">:</span>&nbsp;<span class="ident" id="4175414">net</span><span class="op" id="4175417">,</span>&nbsp;<span class="ident" id="4175419">Addr</span><span class="op" id="4175423">:</span>&nbsp;<span class="ident" id="4175425">laddr</span><span class="op" id="4175430">,</span>&nbsp;<span class="ident" id="4175432">Err</span><span class="op" id="4175435">:</span>&nbsp;<span class="ident" id="4175437">UnknownNetworkError</span><span class="op" id="4175456">(</span><span class="ident" id="4175457">net</span><span class="op" id="4175460">)</span><span class="op" id="4175461">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4175464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175467">if</span>&nbsp;<span class="ident" id="4175470">laddr</span>&nbsp;<span class="op" id="4175476">==</span>&nbsp;<span class="ident" id="4175479">nil</span>&nbsp;<span class="op" id="4175483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175487">laddr</span>&nbsp;<span class="op" id="4175493">=</span>&nbsp;<span class="op" id="4175495">&amp;</span><span class="ident" id="4175496">TCPAddr</span><span class="op" id="4175503">{</span><span class="op" id="4175504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4175507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175510">fd</span><span class="op" id="4175512">,</span>&nbsp;<span class="ident" id="4175514">err</span>&nbsp;<span class="op" id="4175518">:=</span>&nbsp;<span class="ident" id="4175521">internetSocket</span><span class="op" id="4175535">(</span><span class="ident" id="4175536">net</span><span class="op" id="4175539">,</span>&nbsp;<span class="ident" id="4175541">laddr</span><span class="op" id="4175546">,</span>&nbsp;<span class="ident" id="4175548">nil</span><span class="op" id="4175551">,</span>&nbsp;<span class="ident" id="4175553">noDeadline</span><span class="op" id="4175563">,</span>&nbsp;<span class="ident" id="4175565">syscall</span><span class="op" id="4175572">.</span><span class="ident" id="4175573">SOCK_STREAM</span><span class="op" id="4175584">,</span>&nbsp;<span class="num" id="4175586">0</span><span class="op" id="4175587">,</span>&nbsp;<span class="string" id="4175589">&#34;listen&#34;</span><span class="op" id="4175597">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175600">if</span>&nbsp;<span class="ident" id="4175603">err</span>&nbsp;<span class="op" id="4175607">!=</span>&nbsp;<span class="ident" id="4175610">nil</span>&nbsp;<span class="op" id="4175614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175618">return</span>&nbsp;<span class="ident" id="4175625">nil</span><span class="op" id="4175628">,</span>&nbsp;<span class="op" id="4175630">&amp;</span><span class="ident" id="4175631">OpError</span><span class="op" id="4175638">{</span><span class="ident" id="4175639">Op</span><span class="op" id="4175641">:</span>&nbsp;<span class="string" id="4175643">&#34;listen&#34;</span><span class="op" id="4175651">,</span>&nbsp;<span class="ident" id="4175653">Net</span><span class="op" id="4175656">:</span>&nbsp;<span class="ident" id="4175658">net</span><span class="op" id="4175661">,</span>&nbsp;<span class="ident" id="4175663">Addr</span><span class="op" id="4175667">:</span>&nbsp;<span class="ident" id="4175669">laddr</span><span class="op" id="4175674">,</span>&nbsp;<span class="ident" id="4175676">Err</span><span class="op" id="4175679">:</span>&nbsp;<span class="ident" id="4175681">err</span><span class="op" id="4175684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4175687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175690">return</span>&nbsp;<span class="op" id="4175697">&amp;</span><span class="ident" id="4175698">TCPListener</span><span class="op" id="4175709">{</span><span class="ident" id="4175710">fd</span><span class="op" id="4175712">}</span><span class="op" id="4175713">,</span>&nbsp;<span class="ident" id="4175715">nil</span><br>
<span class="lineno"></span><span class="op" id="4175719">}</span>
</div>
</body>
</html>
