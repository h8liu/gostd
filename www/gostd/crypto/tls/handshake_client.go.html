<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html" class="current">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3773632">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3773687">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3773741">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3773792">package</span>&nbsp;<span class="ident" id="3773800">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3773805">import</span>&nbsp;<span class="op" id="3773812">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3773815">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3773824">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3773834">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3773850">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3773864">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3773881">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3773896">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3773906">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3773913">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3773919">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3773926">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="3773936">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3773939">type</span>&nbsp;<span class="ident" id="3773944">clientHandshakeState</span>&nbsp;<span class="keyword" id="3773965">struct</span>&nbsp;<span class="op" id="3773972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3773975">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3773988">*</span><span class="ident" id="3773989">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3773995">serverHello</span>&nbsp;&nbsp;<span class="op" id="3774008">*</span><span class="ident" id="3774009">serverHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3774025">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3774038">*</span><span class="ident" id="3774039">clientHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3774055">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3774068">*</span><span class="ident" id="3774069">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3774082">finishedHash</span>&nbsp;<span class="ident" id="3774095">finishedHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3774109">masterSecret</span>&nbsp;<span class="op" id="3774122">[</span><span class="op" id="3774123">]</span><span class="builtintype" id="3774124">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3774130">session</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3774143">*</span><span class="ident" id="3774144">ClientSessionState</span><br>
<span class="lineno"></span><span class="op" id="3774163">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="3774166">func</span>&nbsp;<span class="op" id="3774171">(</span><span class="ident" id="3774172">c</span>&nbsp;<span class="op" id="3774174">*</span><span class="ident" id="3774175">Conn</span><span class="op" id="3774179">)</span>&nbsp;<span class="ident" id="3774181">clientHandshake</span><span class="op" id="3774196">(</span><span class="op" id="3774197">)</span>&nbsp;<span class="builtintype" id="3774199">error</span>&nbsp;<span class="op" id="3774205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3774208">if</span>&nbsp;<span class="ident" id="3774211">c</span><span class="op" id="3774212">.</span><span class="ident" id="3774213">config</span>&nbsp;<span class="op" id="3774220">==</span>&nbsp;<span class="builtintype" id="3774223">nil</span>&nbsp;<span class="op" id="3774227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3774231">c</span><span class="op" id="3774232">.</span><span class="ident" id="3774233">config</span>&nbsp;<span class="op" id="3774240">=</span>&nbsp;<span class="ident" id="3774242">defaultConfig</span><span class="op" id="3774255">(</span><span class="op" id="3774256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3774259">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3774263">if</span>&nbsp;<span class="builtinfunc" id="3774266">len</span><span class="op" id="3774269">(</span><span class="ident" id="3774270">c</span><span class="op" id="3774271">.</span><span class="ident" id="3774272">config</span><span class="op" id="3774278">.</span><span class="ident" id="3774279">ServerName</span><span class="op" id="3774289">)</span>&nbsp;<span class="op" id="3774291">==</span>&nbsp;<span class="num" id="3774294">0</span>&nbsp;<span class="op" id="3774296">&amp;&amp;</span>&nbsp;<span class="op" id="3774299">!</span><span class="ident" id="3774300">c</span><span class="op" id="3774301">.</span><span class="ident" id="3774302">config</span><span class="op" id="3774308">.</span><span class="ident" id="3774309">InsecureSkipVerify</span>&nbsp;<span class="op" id="3774328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3774332">return</span>&nbsp;<span class="ident" id="3774339">errors</span><span class="op" id="3774345">.</span><span class="ident" id="3774346">New</span><span class="op" id="3774349">(</span><span class="string" id="3774350">&#34;tls:&nbsp;either&nbsp;ServerName&nbsp;or&nbsp;InsecureSkipVerify&nbsp;must&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;tls.Config&#34;</span><span class="op" id="3774432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3774435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3774439">nextProtosLength</span>&nbsp;<span class="op" id="3774456">:=</span>&nbsp;<span class="num" id="3774459">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3774462">for</span>&nbsp;<span class="ident" id="3774466">_</span><span class="op" id="3774467">,</span>&nbsp;<span class="ident" id="3774469">proto</span>&nbsp;<span class="op" id="3774475">:=</span>&nbsp;<span class="keyword" id="3774478">range</span>&nbsp;<span class="ident" id="3774484">c</span><span class="op" id="3774485">.</span><span class="ident" id="3774486">config</span><span class="op" id="3774492">.</span><span class="ident" id="3774493">NextProtos</span>&nbsp;<span class="op" id="3774504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3774508">if</span>&nbsp;<span class="ident" id="3774511">l</span>&nbsp;<span class="op" id="3774513">:=</span>&nbsp;<span class="builtinfunc" id="3774516">len</span><span class="op" id="3774519">(</span><span class="ident" id="3774520">proto</span><span class="op" id="3774525">)</span><span class="op" id="3774526">;</span>&nbsp;<span class="ident" id="3774528">l</span>&nbsp;<span class="op" id="3774530">==</span>&nbsp;<span class="num" id="3774533">0</span>&nbsp;<span class="op" id="3774535">||</span>&nbsp;<span class="ident" id="3774538">l</span>&nbsp;<span class="op" id="3774540">&gt;</span>&nbsp;<span class="num" id="3774542">255</span>&nbsp;<span class="op" id="3774546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3774551">return</span>&nbsp;<span class="ident" id="3774558">errors</span><span class="op" id="3774564">.</span><span class="ident" id="3774565">New</span><span class="op" id="3774568">(</span><span class="string" id="3774569">&#34;tls:&nbsp;invalid&nbsp;NextProtos&nbsp;value&#34;</span><span class="op" id="3774600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3774604">}</span>&nbsp;<span class="keyword" id="3774606">else</span>&nbsp;<span class="op" id="3774611">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3774616">nextProtosLength</span>&nbsp;<span class="op" id="3774633">+=</span>&nbsp;<span class="num" id="3774636">1</span>&nbsp;<span class="op" id="3774638">+</span>&nbsp;<span class="ident" id="3774640">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3774644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3774647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3774650">if</span>&nbsp;<span class="ident" id="3774653">nextProtosLength</span>&nbsp;<span class="op" id="3774670">&gt;</span>&nbsp;<span class="num" id="3774672">0xffff</span>&nbsp;<span class="op" id="3774679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3774683">return</span>&nbsp;<span class="ident" id="3774690">errors</span><span class="op" id="3774696">.</span><span class="ident" id="3774697">New</span><span class="op" id="3774700">(</span><span class="string" id="3774701">&#34;tls:&nbsp;NextProtos&nbsp;values&nbsp;too&nbsp;large&#34;</span><span class="op" id="3774735">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3774738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3774742">hello</span>&nbsp;<span class="op" id="3774748">:=</span>&nbsp;<span class="op" id="3774751">&amp;</span><span class="ident" id="3774752">clientHelloMsg</span><span class="op" id="3774766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3774770">vers</span><span class="op" id="3774774">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3774791">c</span><span class="op" id="3774792">.</span><span class="ident" id="3774793">config</span><span class="op" id="3774799">.</span><span class="ident" id="3774800">maxVersion</span><span class="op" id="3774810">(</span><span class="op" id="3774811">)</span><span class="op" id="3774812">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3774816">compressionMethods</span><span class="op" id="3774834">:</span>&nbsp;&nbsp;<span class="op" id="3774837">[</span><span class="op" id="3774838">]</span><span class="builtintype" id="3774839">uint8</span><span class="op" id="3774844">{</span><span class="ident" id="3774845">compressionNone</span><span class="op" id="3774860">}</span><span class="op" id="3774861">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3774865">random</span><span class="op" id="3774871">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3774886">make</span><span class="op" id="3774890">(</span><span class="op" id="3774891">[</span><span class="op" id="3774892">]</span><span class="builtintype" id="3774893">byte</span><span class="op" id="3774897">,</span>&nbsp;<span class="num" id="3774899">32</span><span class="op" id="3774901">)</span><span class="op" id="3774902">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3774906">ocspStapling</span><span class="op" id="3774918">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3774927">true</span><span class="op" id="3774931">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3774935">serverName</span><span class="op" id="3774945">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3774956">c</span><span class="op" id="3774957">.</span><span class="ident" id="3774958">config</span><span class="op" id="3774964">.</span><span class="ident" id="3774965">ServerName</span><span class="op" id="3774975">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3774979">supportedCurves</span><span class="op" id="3774994">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3775000">c</span><span class="op" id="3775001">.</span><span class="ident" id="3775002">config</span><span class="op" id="3775008">.</span><span class="ident" id="3775009">curvePreferences</span><span class="op" id="3775025">(</span><span class="op" id="3775026">)</span><span class="op" id="3775027">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3775031">supportedPoints</span><span class="op" id="3775046">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3775052">[</span><span class="op" id="3775053">]</span><span class="builtintype" id="3775054">uint8</span><span class="op" id="3775059">{</span><span class="ident" id="3775060">pointFormatUncompressed</span><span class="op" id="3775083">}</span><span class="op" id="3775084">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3775088">nextProtoNeg</span><span class="op" id="3775100">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3775109">len</span><span class="op" id="3775112">(</span><span class="ident" id="3775113">c</span><span class="op" id="3775114">.</span><span class="ident" id="3775115">config</span><span class="op" id="3775121">.</span><span class="ident" id="3775122">NextProtos</span><span class="op" id="3775132">)</span>&nbsp;<span class="op" id="3775134">&gt;</span>&nbsp;<span class="num" id="3775136">0</span><span class="op" id="3775137">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3775141">secureRenegotiation</span><span class="op" id="3775160">:</span>&nbsp;<span class="builtintype" id="3775162">true</span><span class="op" id="3775166">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3775170">alpnProtocols</span><span class="op" id="3775183">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3775191">c</span><span class="op" id="3775192">.</span><span class="ident" id="3775193">config</span><span class="op" id="3775199">.</span><span class="ident" id="3775200">NextProtos</span><span class="op" id="3775210">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3775213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3775217">possibleCipherSuites</span>&nbsp;<span class="op" id="3775238">:=</span>&nbsp;<span class="ident" id="3775241">c</span><span class="op" id="3775242">.</span><span class="ident" id="3775243">config</span><span class="op" id="3775249">.</span><span class="ident" id="3775250">cipherSuites</span><span class="op" id="3775262">(</span><span class="op" id="3775263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3775266">hello</span><span class="op" id="3775271">.</span><span class="ident" id="3775272">cipherSuites</span>&nbsp;<span class="op" id="3775285">=</span>&nbsp;<span class="builtinfunc" id="3775287">make</span><span class="op" id="3775291">(</span><span class="op" id="3775292">[</span><span class="op" id="3775293">]</span><span class="builtintype" id="3775294">uint16</span><span class="op" id="3775300">,</span>&nbsp;<span class="num" id="3775302">0</span><span class="op" id="3775303">,</span>&nbsp;<span class="builtinfunc" id="3775305">len</span><span class="op" id="3775308">(</span><span class="ident" id="3775309">possibleCipherSuites</span><span class="op" id="3775329">)</span><span class="op" id="3775330">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="3775333">NextCipherSuite</span><span class="op" id="3775348">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3775351">for</span>&nbsp;<span class="ident" id="3775355">_</span><span class="op" id="3775356">,</span>&nbsp;<span class="ident" id="3775358">suiteId</span>&nbsp;<span class="op" id="3775366">:=</span>&nbsp;<span class="keyword" id="3775369">range</span>&nbsp;<span class="ident" id="3775375">possibleCipherSuites</span>&nbsp;<span class="op" id="3775396">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3775400">for</span>&nbsp;<span class="ident" id="3775404">_</span><span class="op" id="3775405">,</span>&nbsp;<span class="ident" id="3775407">suite</span>&nbsp;<span class="op" id="3775413">:=</span>&nbsp;<span class="keyword" id="3775416">range</span>&nbsp;<span class="ident" id="3775422">cipherSuites</span>&nbsp;<span class="op" id="3775435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3775440">if</span>&nbsp;<span class="ident" id="3775443">suite</span><span class="op" id="3775448">.</span><span class="ident" id="3775449">id</span>&nbsp;<span class="op" id="3775452">!=</span>&nbsp;<span class="ident" id="3775455">suiteId</span>&nbsp;<span class="op" id="3775463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3775469">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3775481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3775486">//&nbsp;Don&#39;t&nbsp;advertise&nbsp;TLS&nbsp;1.2-only&nbsp;cipher&nbsp;suites&nbsp;unless</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3775542">//&nbsp;we&#39;re&nbsp;attempting&nbsp;TLS&nbsp;1.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3775574">if</span>&nbsp;<span class="ident" id="3775577">hello</span><span class="op" id="3775582">.</span><span class="ident" id="3775583">vers</span>&nbsp;<span class="op" id="3775588">&lt;</span>&nbsp;<span class="ident" id="3775590">VersionTLS12</span>&nbsp;<span class="op" id="3775603">&amp;&amp;</span>&nbsp;<span class="ident" id="3775606">suite</span><span class="op" id="3775611">.</span><span class="ident" id="3775612">flags</span><span class="op" id="3775617">&amp;</span><span class="ident" id="3775618">suiteTLS12</span>&nbsp;<span class="op" id="3775629">!=</span>&nbsp;<span class="num" id="3775632">0</span>&nbsp;<span class="op" id="3775634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3775640">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3775652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3775657">hello</span><span class="op" id="3775662">.</span><span class="ident" id="3775663">cipherSuites</span>&nbsp;<span class="op" id="3775676">=</span>&nbsp;<span class="builtinfunc" id="3775678">append</span><span class="op" id="3775684">(</span><span class="ident" id="3775685">hello</span><span class="op" id="3775690">.</span><span class="ident" id="3775691">cipherSuites</span><span class="op" id="3775703">,</span>&nbsp;<span class="ident" id="3775705">suiteId</span><span class="op" id="3775712">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3775717">continue</span>&nbsp;<span class="ident" id="3775726">NextCipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3775744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3775747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3775751">_</span><span class="op" id="3775752">,</span>&nbsp;<span class="ident" id="3775754">err</span>&nbsp;<span class="op" id="3775758">:=</span>&nbsp;<span class="ident" id="3775761">io</span><span class="op" id="3775763">.</span><span class="ident" id="3775764">ReadFull</span><span class="op" id="3775772">(</span><span class="ident" id="3775773">c</span><span class="op" id="3775774">.</span><span class="ident" id="3775775">config</span><span class="op" id="3775781">.</span><span class="ident" id="3775782">rand</span><span class="op" id="3775786">(</span><span class="op" id="3775787">)</span><span class="op" id="3775788">,</span>&nbsp;<span class="ident" id="3775790">hello</span><span class="op" id="3775795">.</span><span class="ident" id="3775796">random</span><span class="op" id="3775802">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3775805">if</span>&nbsp;<span class="ident" id="3775808">err</span>&nbsp;<span class="op" id="3775812">!=</span>&nbsp;<span class="builtintype" id="3775815">nil</span>&nbsp;<span class="op" id="3775819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3775823">c</span><span class="op" id="3775824">.</span><span class="ident" id="3775825">sendAlert</span><span class="op" id="3775834">(</span><span class="ident" id="3775835">alertInternalError</span><span class="op" id="3775853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3775857">return</span>&nbsp;<span class="ident" id="3775864">errors</span><span class="op" id="3775870">.</span><span class="ident" id="3775871">New</span><span class="op" id="3775874">(</span><span class="string" id="3775875">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="3775905">+</span>&nbsp;<span class="ident" id="3775907">err</span><span class="op" id="3775910">.</span><span class="ident" id="3775911">Error</span><span class="op" id="3775916">(</span><span class="op" id="3775917">)</span><span class="op" id="3775918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3775921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3775925">if</span>&nbsp;<span class="ident" id="3775928">hello</span><span class="op" id="3775933">.</span><span class="ident" id="3775934">vers</span>&nbsp;<span class="op" id="3775939">&gt;=</span>&nbsp;<span class="ident" id="3775942">VersionTLS12</span>&nbsp;<span class="op" id="3775955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3775959">hello</span><span class="op" id="3775964">.</span><span class="ident" id="3775965">signatureAndHashes</span>&nbsp;<span class="op" id="3775984">=</span>&nbsp;<span class="ident" id="3775986">supportedSKXSignatureAlgorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3776019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3776023">var</span>&nbsp;<span class="ident" id="3776027">session</span>&nbsp;<span class="op" id="3776035">*</span><span class="ident" id="3776036">ClientSessionState</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3776056">var</span>&nbsp;<span class="ident" id="3776060">cacheKey</span>&nbsp;<span class="builtintype" id="3776069">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3776077">sessionCache</span>&nbsp;<span class="op" id="3776090">:=</span>&nbsp;<span class="ident" id="3776093">c</span><span class="op" id="3776094">.</span><span class="ident" id="3776095">config</span><span class="op" id="3776101">.</span><span class="ident" id="3776102">ClientSessionCache</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3776122">if</span>&nbsp;<span class="ident" id="3776125">c</span><span class="op" id="3776126">.</span><span class="ident" id="3776127">config</span><span class="op" id="3776133">.</span><span class="ident" id="3776134">SessionTicketsDisabled</span>&nbsp;<span class="op" id="3776157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3776161">sessionCache</span>&nbsp;<span class="op" id="3776174">=</span>&nbsp;<span class="builtintype" id="3776176">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3776181">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3776185">if</span>&nbsp;<span class="ident" id="3776188">sessionCache</span>&nbsp;<span class="op" id="3776201">!=</span>&nbsp;<span class="builtintype" id="3776204">nil</span>&nbsp;<span class="op" id="3776208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3776212">hello</span><span class="op" id="3776217">.</span><span class="ident" id="3776218">ticketSupported</span>&nbsp;<span class="op" id="3776234">=</span>&nbsp;<span class="builtintype" id="3776236">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3776244">//&nbsp;Try&nbsp;to&nbsp;resume&nbsp;a&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;session,&nbsp;if</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3776303">//&nbsp;available.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3776319">cacheKey</span>&nbsp;<span class="op" id="3776328">=</span>&nbsp;<span class="ident" id="3776330">clientSessionCacheKey</span><span class="op" id="3776351">(</span><span class="ident" id="3776352">c</span><span class="op" id="3776353">.</span><span class="ident" id="3776354">conn</span><span class="op" id="3776358">.</span><span class="ident" id="3776359">RemoteAddr</span><span class="op" id="3776369">(</span><span class="op" id="3776370">)</span><span class="op" id="3776371">,</span>&nbsp;<span class="ident" id="3776373">c</span><span class="op" id="3776374">.</span><span class="ident" id="3776375">config</span><span class="op" id="3776381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3776385">candidateSession</span><span class="op" id="3776401">,</span>&nbsp;<span class="ident" id="3776403">ok</span>&nbsp;<span class="op" id="3776406">:=</span>&nbsp;<span class="ident" id="3776409">sessionCache</span><span class="op" id="3776421">.</span><span class="ident" id="3776422">Get</span><span class="op" id="3776425">(</span><span class="ident" id="3776426">cacheKey</span><span class="op" id="3776434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3776438">if</span>&nbsp;<span class="ident" id="3776441">ok</span>&nbsp;<span class="op" id="3776444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3776449">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;ciphersuite/version&nbsp;used&nbsp;for&nbsp;the</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3776503">//&nbsp;previous&nbsp;session&nbsp;are&nbsp;still&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3776543">cipherSuiteOk</span>&nbsp;<span class="op" id="3776557">:=</span>&nbsp;<span class="builtintype" id="3776560">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3776569">for</span>&nbsp;<span class="ident" id="3776573">_</span><span class="op" id="3776574">,</span>&nbsp;<span class="ident" id="3776576">id</span>&nbsp;<span class="op" id="3776579">:=</span>&nbsp;<span class="keyword" id="3776582">range</span>&nbsp;<span class="ident" id="3776588">hello</span><span class="op" id="3776593">.</span><span class="ident" id="3776594">cipherSuites</span>&nbsp;<span class="op" id="3776607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3776613">if</span>&nbsp;<span class="ident" id="3776616">id</span>&nbsp;<span class="op" id="3776619">==</span>&nbsp;<span class="ident" id="3776622">candidateSession</span><span class="op" id="3776638">.</span><span class="ident" id="3776639">cipherSuite</span>&nbsp;<span class="op" id="3776651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3776658">cipherSuiteOk</span>&nbsp;<span class="op" id="3776672">=</span>&nbsp;<span class="builtintype" id="3776674">true</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3776684">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3776694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3776699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3776705">versOk</span>&nbsp;<span class="op" id="3776712">:=</span>&nbsp;<span class="ident" id="3776715">candidateSession</span><span class="op" id="3776731">.</span><span class="ident" id="3776732">vers</span>&nbsp;<span class="op" id="3776737">&gt;=</span>&nbsp;<span class="ident" id="3776740">c</span><span class="op" id="3776741">.</span><span class="ident" id="3776742">config</span><span class="op" id="3776748">.</span><span class="ident" id="3776749">minVersion</span><span class="op" id="3776759">(</span><span class="op" id="3776760">)</span>&nbsp;<span class="op" id="3776762">&amp;&amp;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3776769">candidateSession</span><span class="op" id="3776785">.</span><span class="ident" id="3776786">vers</span>&nbsp;<span class="op" id="3776791">&lt;=</span>&nbsp;<span class="ident" id="3776794">c</span><span class="op" id="3776795">.</span><span class="ident" id="3776796">config</span><span class="op" id="3776802">.</span><span class="ident" id="3776803">maxVersion</span><span class="op" id="3776813">(</span><span class="op" id="3776814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3776819">if</span>&nbsp;<span class="ident" id="3776822">versOk</span>&nbsp;<span class="op" id="3776829">&amp;&amp;</span>&nbsp;<span class="ident" id="3776832">cipherSuiteOk</span>&nbsp;<span class="op" id="3776846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3776852">session</span>&nbsp;<span class="op" id="3776860">=</span>&nbsp;<span class="ident" id="3776862">candidateSession</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3776882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3776886">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3776889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3776893">if</span>&nbsp;<span class="ident" id="3776896">session</span>&nbsp;<span class="op" id="3776904">!=</span>&nbsp;<span class="builtintype" id="3776907">nil</span>&nbsp;<span class="op" id="3776911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3776915">hello</span><span class="op" id="3776920">.</span><span class="ident" id="3776921">sessionTicket</span>&nbsp;<span class="op" id="3776935">=</span>&nbsp;<span class="ident" id="3776937">session</span><span class="op" id="3776944">.</span><span class="ident" id="3776945">sessionTicket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3776961">//&nbsp;A&nbsp;random&nbsp;session&nbsp;ID&nbsp;is&nbsp;used&nbsp;to&nbsp;detect&nbsp;when&nbsp;the</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3777013">//&nbsp;server&nbsp;accepted&nbsp;the&nbsp;ticket&nbsp;and&nbsp;is&nbsp;resuming&nbsp;a&nbsp;session</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3777071">//&nbsp;(see&nbsp;RFC&nbsp;5077).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3777092">hello</span><span class="op" id="3777097">.</span><span class="ident" id="3777098">sessionId</span>&nbsp;<span class="op" id="3777108">=</span>&nbsp;<span class="builtinfunc" id="3777110">make</span><span class="op" id="3777114">(</span><span class="op" id="3777115">[</span><span class="op" id="3777116">]</span><span class="builtintype" id="3777117">byte</span><span class="op" id="3777121">,</span>&nbsp;<span class="num" id="3777123">16</span><span class="op" id="3777125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3777129">if</span>&nbsp;<span class="ident" id="3777132">_</span><span class="op" id="3777133">,</span>&nbsp;<span class="ident" id="3777135">err</span>&nbsp;<span class="op" id="3777139">:=</span>&nbsp;<span class="ident" id="3777142">io</span><span class="op" id="3777144">.</span><span class="ident" id="3777145">ReadFull</span><span class="op" id="3777153">(</span><span class="ident" id="3777154">c</span><span class="op" id="3777155">.</span><span class="ident" id="3777156">config</span><span class="op" id="3777162">.</span><span class="ident" id="3777163">rand</span><span class="op" id="3777167">(</span><span class="op" id="3777168">)</span><span class="op" id="3777169">,</span>&nbsp;<span class="ident" id="3777171">hello</span><span class="op" id="3777176">.</span><span class="ident" id="3777177">sessionId</span><span class="op" id="3777186">)</span><span class="op" id="3777187">;</span>&nbsp;<span class="ident" id="3777189">err</span>&nbsp;<span class="op" id="3777193">!=</span>&nbsp;<span class="builtintype" id="3777196">nil</span>&nbsp;<span class="op" id="3777200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3777205">c</span><span class="op" id="3777206">.</span><span class="ident" id="3777207">sendAlert</span><span class="op" id="3777216">(</span><span class="ident" id="3777217">alertInternalError</span><span class="op" id="3777235">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3777240">return</span>&nbsp;<span class="ident" id="3777247">errors</span><span class="op" id="3777253">.</span><span class="ident" id="3777254">New</span><span class="op" id="3777257">(</span><span class="string" id="3777258">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="3777288">+</span>&nbsp;<span class="ident" id="3777290">err</span><span class="op" id="3777293">.</span><span class="ident" id="3777294">Error</span><span class="op" id="3777299">(</span><span class="op" id="3777300">)</span><span class="op" id="3777301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3777305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3777308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3777312">c</span><span class="op" id="3777313">.</span><span class="ident" id="3777314">writeRecord</span><span class="op" id="3777325">(</span><span class="ident" id="3777326">recordTypeHandshake</span><span class="op" id="3777345">,</span>&nbsp;<span class="ident" id="3777347">hello</span><span class="op" id="3777352">.</span><span class="ident" id="3777353">marshal</span><span class="op" id="3777360">(</span><span class="op" id="3777361">)</span><span class="op" id="3777362">)</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3777366">msg</span><span class="op" id="3777369">,</span>&nbsp;<span class="ident" id="3777371">err</span>&nbsp;<span class="op" id="3777375">:=</span>&nbsp;<span class="ident" id="3777378">c</span><span class="op" id="3777379">.</span><span class="ident" id="3777380">readHandshake</span><span class="op" id="3777393">(</span><span class="op" id="3777394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3777397">if</span>&nbsp;<span class="ident" id="3777400">err</span>&nbsp;<span class="op" id="3777404">!=</span>&nbsp;<span class="builtintype" id="3777407">nil</span>&nbsp;<span class="op" id="3777411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3777415">return</span>&nbsp;<span class="ident" id="3777422">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3777427">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3777430">serverHello</span><span class="op" id="3777441">,</span>&nbsp;<span class="ident" id="3777443">ok</span>&nbsp;<span class="op" id="3777446">:=</span>&nbsp;<span class="ident" id="3777449">msg</span><span class="op" id="3777452">.</span><span class="op" id="3777453">(</span><span class="op" id="3777454">*</span><span class="ident" id="3777455">serverHelloMsg</span><span class="op" id="3777469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3777472">if</span>&nbsp;<span class="op" id="3777475">!</span><span class="ident" id="3777476">ok</span>&nbsp;<span class="op" id="3777479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3777483">c</span><span class="op" id="3777484">.</span><span class="ident" id="3777485">sendAlert</span><span class="op" id="3777494">(</span><span class="ident" id="3777495">alertUnexpectedMessage</span><span class="op" id="3777517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3777521">return</span>&nbsp;<span class="ident" id="3777528">unexpectedMessageError</span><span class="op" id="3777550">(</span><span class="ident" id="3777551">serverHello</span><span class="op" id="3777562">,</span>&nbsp;<span class="ident" id="3777564">msg</span><span class="op" id="3777567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3777570">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3777574">vers</span><span class="op" id="3777578">,</span>&nbsp;<span class="ident" id="3777580">ok</span>&nbsp;<span class="op" id="3777583">:=</span>&nbsp;<span class="ident" id="3777586">c</span><span class="op" id="3777587">.</span><span class="ident" id="3777588">config</span><span class="op" id="3777594">.</span><span class="ident" id="3777595">mutualVersion</span><span class="op" id="3777608">(</span><span class="ident" id="3777609">serverHello</span><span class="op" id="3777620">.</span><span class="ident" id="3777621">vers</span><span class="op" id="3777625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3777628">if</span>&nbsp;<span class="op" id="3777631">!</span><span class="ident" id="3777632">ok</span>&nbsp;<span class="op" id="3777635">||</span>&nbsp;<span class="ident" id="3777638">vers</span>&nbsp;<span class="op" id="3777643">&lt;</span>&nbsp;<span class="ident" id="3777645">VersionTLS10</span>&nbsp;<span class="op" id="3777658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3777662">//&nbsp;TLS&nbsp;1.0&nbsp;is&nbsp;the&nbsp;minimum&nbsp;version&nbsp;supported&nbsp;as&nbsp;a&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3777721">c</span><span class="op" id="3777722">.</span><span class="ident" id="3777723">sendAlert</span><span class="op" id="3777732">(</span><span class="ident" id="3777733">alertProtocolVersion</span><span class="op" id="3777753">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3777757">return</span>&nbsp;<span class="ident" id="3777764">fmt</span><span class="op" id="3777767">.</span><span class="ident" id="3777768">Errorf</span><span class="op" id="3777774">(</span><span class="string" id="3777775">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;protocol&nbsp;version&nbsp;%x&#34;</span><span class="op" id="3777829">,</span>&nbsp;<span class="ident" id="3777831">serverHello</span><span class="op" id="3777842">.</span><span class="ident" id="3777843">vers</span><span class="op" id="3777847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3777850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3777853">c</span><span class="op" id="3777854">.</span><span class="ident" id="3777855">vers</span>&nbsp;<span class="op" id="3777860">=</span>&nbsp;<span class="ident" id="3777862">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3777868">c</span><span class="op" id="3777869">.</span><span class="ident" id="3777870">haveVers</span>&nbsp;<span class="op" id="3777879">=</span>&nbsp;<span class="builtintype" id="3777881">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3777888">suite</span>&nbsp;<span class="op" id="3777894">:=</span>&nbsp;<span class="ident" id="3777897">mutualCipherSuite</span><span class="op" id="3777914">(</span><span class="ident" id="3777915">c</span><span class="op" id="3777916">.</span><span class="ident" id="3777917">config</span><span class="op" id="3777923">.</span><span class="ident" id="3777924">cipherSuites</span><span class="op" id="3777936">(</span><span class="op" id="3777937">)</span><span class="op" id="3777938">,</span>&nbsp;<span class="ident" id="3777940">serverHello</span><span class="op" id="3777951">.</span><span class="ident" id="3777952">cipherSuite</span><span class="op" id="3777963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3777966">if</span>&nbsp;<span class="ident" id="3777969">suite</span>&nbsp;<span class="op" id="3777975">==</span>&nbsp;<span class="builtintype" id="3777978">nil</span>&nbsp;<span class="op" id="3777982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3777986">c</span><span class="op" id="3777987">.</span><span class="ident" id="3777988">sendAlert</span><span class="op" id="3777997">(</span><span class="ident" id="3777998">alertHandshakeFailure</span><span class="op" id="3778019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778023">return</span>&nbsp;<span class="ident" id="3778030">fmt</span><span class="op" id="3778033">.</span><span class="ident" id="3778034">Errorf</span><span class="op" id="3778040">(</span><span class="string" id="3778041">&#34;tls:&nbsp;server&nbsp;selected&nbsp;an&nbsp;unsupported&nbsp;cipher&nbsp;suite&#34;</span><span class="op" id="3778091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3778094">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3778098">hs</span>&nbsp;<span class="op" id="3778101">:=</span>&nbsp;<span class="op" id="3778104">&amp;</span><span class="ident" id="3778105">clientHandshakeState</span><span class="op" id="3778125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3778129">c</span><span class="op" id="3778130">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3778143">c</span><span class="op" id="3778144">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3778148">serverHello</span><span class="op" id="3778159">:</span>&nbsp;&nbsp;<span class="ident" id="3778162">serverHello</span><span class="op" id="3778173">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3778177">hello</span><span class="op" id="3778182">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3778191">hello</span><span class="op" id="3778196">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3778200">suite</span><span class="op" id="3778205">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3778214">suite</span><span class="op" id="3778219">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3778223">finishedHash</span><span class="op" id="3778235">:</span>&nbsp;<span class="ident" id="3778237">newFinishedHash</span><span class="op" id="3778252">(</span><span class="ident" id="3778253">c</span><span class="op" id="3778254">.</span><span class="ident" id="3778255">vers</span><span class="op" id="3778259">)</span><span class="op" id="3778260">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3778264">session</span><span class="op" id="3778271">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3778278">session</span><span class="op" id="3778285">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3778288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3778292">hs</span><span class="op" id="3778294">.</span><span class="ident" id="3778295">finishedHash</span><span class="op" id="3778307">.</span><span class="ident" id="3778308">Write</span><span class="op" id="3778313">(</span><span class="ident" id="3778314">hs</span><span class="op" id="3778316">.</span><span class="ident" id="3778317">hello</span><span class="op" id="3778322">.</span><span class="ident" id="3778323">marshal</span><span class="op" id="3778330">(</span><span class="op" id="3778331">)</span><span class="op" id="3778332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3778335">hs</span><span class="op" id="3778337">.</span><span class="ident" id="3778338">finishedHash</span><span class="op" id="3778350">.</span><span class="ident" id="3778351">Write</span><span class="op" id="3778356">(</span><span class="ident" id="3778357">hs</span><span class="op" id="3778359">.</span><span class="ident" id="3778360">serverHello</span><span class="op" id="3778371">.</span><span class="ident" id="3778372">marshal</span><span class="op" id="3778379">(</span><span class="op" id="3778380">)</span><span class="op" id="3778381">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3778385">isResume</span><span class="op" id="3778393">,</span>&nbsp;<span class="ident" id="3778395">err</span>&nbsp;<span class="op" id="3778399">:=</span>&nbsp;<span class="ident" id="3778402">hs</span><span class="op" id="3778404">.</span><span class="ident" id="3778405">processServerHello</span><span class="op" id="3778423">(</span><span class="op" id="3778424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778427">if</span>&nbsp;<span class="ident" id="3778430">err</span>&nbsp;<span class="op" id="3778434">!=</span>&nbsp;<span class="builtintype" id="3778437">nil</span>&nbsp;<span class="op" id="3778441">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778445">return</span>&nbsp;<span class="ident" id="3778452">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3778457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778461">if</span>&nbsp;<span class="ident" id="3778464">isResume</span>&nbsp;<span class="op" id="3778473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778477">if</span>&nbsp;<span class="ident" id="3778480">err</span>&nbsp;<span class="op" id="3778484">:=</span>&nbsp;<span class="ident" id="3778487">hs</span><span class="op" id="3778489">.</span><span class="ident" id="3778490">establishKeys</span><span class="op" id="3778503">(</span><span class="op" id="3778504">)</span><span class="op" id="3778505">;</span>&nbsp;<span class="ident" id="3778507">err</span>&nbsp;<span class="op" id="3778511">!=</span>&nbsp;<span class="builtintype" id="3778514">nil</span>&nbsp;<span class="op" id="3778518">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778523">return</span>&nbsp;<span class="ident" id="3778530">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3778536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778540">if</span>&nbsp;<span class="ident" id="3778543">err</span>&nbsp;<span class="op" id="3778547">:=</span>&nbsp;<span class="ident" id="3778550">hs</span><span class="op" id="3778552">.</span><span class="ident" id="3778553">readSessionTicket</span><span class="op" id="3778570">(</span><span class="op" id="3778571">)</span><span class="op" id="3778572">;</span>&nbsp;<span class="ident" id="3778574">err</span>&nbsp;<span class="op" id="3778578">!=</span>&nbsp;<span class="builtintype" id="3778581">nil</span>&nbsp;<span class="op" id="3778585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778590">return</span>&nbsp;<span class="ident" id="3778597">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3778603">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778607">if</span>&nbsp;<span class="ident" id="3778610">err</span>&nbsp;<span class="op" id="3778614">:=</span>&nbsp;<span class="ident" id="3778617">hs</span><span class="op" id="3778619">.</span><span class="ident" id="3778620">readFinished</span><span class="op" id="3778632">(</span><span class="ident" id="3778633">c</span><span class="op" id="3778634">.</span><span class="ident" id="3778635">firstFinished</span><span class="op" id="3778648">[</span><span class="op" id="3778649">:</span><span class="op" id="3778650">]</span><span class="op" id="3778651">)</span><span class="op" id="3778652">;</span>&nbsp;<span class="ident" id="3778654">err</span>&nbsp;<span class="op" id="3778658">!=</span>&nbsp;<span class="builtintype" id="3778661">nil</span>&nbsp;<span class="op" id="3778665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778670">return</span>&nbsp;<span class="ident" id="3778677">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3778683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778687">if</span>&nbsp;<span class="ident" id="3778690">err</span>&nbsp;<span class="op" id="3778694">:=</span>&nbsp;<span class="ident" id="3778697">hs</span><span class="op" id="3778699">.</span><span class="ident" id="3778700">sendFinished</span><span class="op" id="3778712">(</span><span class="builtintype" id="3778713">nil</span><span class="op" id="3778716">)</span><span class="op" id="3778717">;</span>&nbsp;<span class="ident" id="3778719">err</span>&nbsp;<span class="op" id="3778723">!=</span>&nbsp;<span class="builtintype" id="3778726">nil</span>&nbsp;<span class="op" id="3778730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778735">return</span>&nbsp;<span class="ident" id="3778742">err</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3778748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3778751">}</span>&nbsp;<span class="keyword" id="3778753">else</span>&nbsp;<span class="op" id="3778758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778762">if</span>&nbsp;<span class="ident" id="3778765">err</span>&nbsp;<span class="op" id="3778769">:=</span>&nbsp;<span class="ident" id="3778772">hs</span><span class="op" id="3778774">.</span><span class="ident" id="3778775">doFullHandshake</span><span class="op" id="3778790">(</span><span class="op" id="3778791">)</span><span class="op" id="3778792">;</span>&nbsp;<span class="ident" id="3778794">err</span>&nbsp;<span class="op" id="3778798">!=</span>&nbsp;<span class="builtintype" id="3778801">nil</span>&nbsp;<span class="op" id="3778805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778810">return</span>&nbsp;<span class="ident" id="3778817">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3778823">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778827">if</span>&nbsp;<span class="ident" id="3778830">err</span>&nbsp;<span class="op" id="3778834">:=</span>&nbsp;<span class="ident" id="3778837">hs</span><span class="op" id="3778839">.</span><span class="ident" id="3778840">establishKeys</span><span class="op" id="3778853">(</span><span class="op" id="3778854">)</span><span class="op" id="3778855">;</span>&nbsp;<span class="ident" id="3778857">err</span>&nbsp;<span class="op" id="3778861">!=</span>&nbsp;<span class="builtintype" id="3778864">nil</span>&nbsp;<span class="op" id="3778868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778873">return</span>&nbsp;<span class="ident" id="3778880">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3778886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778890">if</span>&nbsp;<span class="ident" id="3778893">err</span>&nbsp;<span class="op" id="3778897">:=</span>&nbsp;<span class="ident" id="3778900">hs</span><span class="op" id="3778902">.</span><span class="ident" id="3778903">sendFinished</span><span class="op" id="3778915">(</span><span class="ident" id="3778916">c</span><span class="op" id="3778917">.</span><span class="ident" id="3778918">firstFinished</span><span class="op" id="3778931">[</span><span class="op" id="3778932">:</span><span class="op" id="3778933">]</span><span class="op" id="3778934">)</span><span class="op" id="3778935">;</span>&nbsp;<span class="ident" id="3778937">err</span>&nbsp;<span class="op" id="3778941">!=</span>&nbsp;<span class="builtintype" id="3778944">nil</span>&nbsp;<span class="op" id="3778948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778953">return</span>&nbsp;<span class="ident" id="3778960">err</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3778966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3778970">if</span>&nbsp;<span class="ident" id="3778973">err</span>&nbsp;<span class="op" id="3778977">:=</span>&nbsp;<span class="ident" id="3778980">hs</span><span class="op" id="3778982">.</span><span class="ident" id="3778983">readSessionTicket</span><span class="op" id="3779000">(</span><span class="op" id="3779001">)</span><span class="op" id="3779002">;</span>&nbsp;<span class="ident" id="3779004">err</span>&nbsp;<span class="op" id="3779008">!=</span>&nbsp;<span class="builtintype" id="3779011">nil</span>&nbsp;<span class="op" id="3779015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3779020">return</span>&nbsp;<span class="ident" id="3779027">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3779033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3779037">if</span>&nbsp;<span class="ident" id="3779040">err</span>&nbsp;<span class="op" id="3779044">:=</span>&nbsp;<span class="ident" id="3779047">hs</span><span class="op" id="3779049">.</span><span class="ident" id="3779050">readFinished</span><span class="op" id="3779062">(</span><span class="builtintype" id="3779063">nil</span><span class="op" id="3779066">)</span><span class="op" id="3779067">;</span>&nbsp;<span class="ident" id="3779069">err</span>&nbsp;<span class="op" id="3779073">!=</span>&nbsp;<span class="builtintype" id="3779076">nil</span>&nbsp;<span class="op" id="3779080">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3779085">return</span>&nbsp;<span class="ident" id="3779092">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3779098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3779101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3779105">if</span>&nbsp;<span class="ident" id="3779108">sessionCache</span>&nbsp;<span class="op" id="3779121">!=</span>&nbsp;<span class="builtintype" id="3779124">nil</span>&nbsp;<span class="op" id="3779128">&amp;&amp;</span>&nbsp;<span class="ident" id="3779131">hs</span><span class="op" id="3779133">.</span><span class="ident" id="3779134">session</span>&nbsp;<span class="op" id="3779142">!=</span>&nbsp;<span class="builtintype" id="3779145">nil</span>&nbsp;<span class="op" id="3779149">&amp;&amp;</span>&nbsp;<span class="ident" id="3779152">session</span>&nbsp;<span class="op" id="3779160">!=</span>&nbsp;<span class="ident" id="3779163">hs</span><span class="op" id="3779165">.</span><span class="ident" id="3779166">session</span>&nbsp;<span class="op" id="3779174">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3779178">sessionCache</span><span class="op" id="3779190">.</span><span class="ident" id="3779191">Put</span><span class="op" id="3779194">(</span><span class="ident" id="3779195">cacheKey</span><span class="op" id="3779203">,</span>&nbsp;<span class="ident" id="3779205">hs</span><span class="op" id="3779207">.</span><span class="ident" id="3779208">session</span><span class="op" id="3779215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3779218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3779222">c</span><span class="op" id="3779223">.</span><span class="ident" id="3779224">didResume</span>&nbsp;<span class="op" id="3779234">=</span>&nbsp;<span class="ident" id="3779236">isResume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3779246">c</span><span class="op" id="3779247">.</span><span class="ident" id="3779248">handshakeComplete</span>&nbsp;<span class="op" id="3779266">=</span>&nbsp;<span class="builtintype" id="3779268">true</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3779274">c</span><span class="op" id="3779275">.</span><span class="ident" id="3779276">cipherSuite</span>&nbsp;<span class="op" id="3779288">=</span>&nbsp;<span class="ident" id="3779290">suite</span><span class="op" id="3779295">.</span><span class="ident" id="3779296">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3779300">return</span>&nbsp;<span class="builtintype" id="3779307">nil</span><br>
<span class="lineno"></span><span class="op" id="3779311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3779314">func</span>&nbsp;<span class="op" id="3779319">(</span><span class="ident" id="3779320">hs</span>&nbsp;<span class="op" id="3779323">*</span><span class="ident" id="3779324">clientHandshakeState</span><span class="op" id="3779344">)</span>&nbsp;<span class="ident" id="3779346">doFullHandshake</span><span class="op" id="3779361">(</span><span class="op" id="3779362">)</span>&nbsp;<span class="builtintype" id="3779364">error</span>&nbsp;<span class="op" id="3779370">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3779373">c</span>&nbsp;<span class="op" id="3779375">:=</span>&nbsp;<span class="ident" id="3779378">hs</span><span class="op" id="3779380">.</span><span class="ident" id="3779381">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3779385">msg</span><span class="op" id="3779388">,</span>&nbsp;<span class="ident" id="3779390">err</span>&nbsp;<span class="op" id="3779394">:=</span>&nbsp;<span class="ident" id="3779397">c</span><span class="op" id="3779398">.</span><span class="ident" id="3779399">readHandshake</span><span class="op" id="3779412">(</span><span class="op" id="3779413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3779416">if</span>&nbsp;<span class="ident" id="3779419">err</span>&nbsp;<span class="op" id="3779423">!=</span>&nbsp;<span class="builtintype" id="3779426">nil</span>&nbsp;<span class="op" id="3779430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3779434">return</span>&nbsp;<span class="ident" id="3779441">err</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3779446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3779449">certMsg</span><span class="op" id="3779456">,</span>&nbsp;<span class="ident" id="3779458">ok</span>&nbsp;<span class="op" id="3779461">:=</span>&nbsp;<span class="ident" id="3779464">msg</span><span class="op" id="3779467">.</span><span class="op" id="3779468">(</span><span class="op" id="3779469">*</span><span class="ident" id="3779470">certificateMsg</span><span class="op" id="3779484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3779487">if</span>&nbsp;<span class="op" id="3779490">!</span><span class="ident" id="3779491">ok</span>&nbsp;<span class="op" id="3779494">||</span>&nbsp;<span class="builtinfunc" id="3779497">len</span><span class="op" id="3779500">(</span><span class="ident" id="3779501">certMsg</span><span class="op" id="3779508">.</span><span class="ident" id="3779509">certificates</span><span class="op" id="3779521">)</span>&nbsp;<span class="op" id="3779523">==</span>&nbsp;<span class="num" id="3779526">0</span>&nbsp;<span class="op" id="3779528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3779532">c</span><span class="op" id="3779533">.</span><span class="ident" id="3779534">sendAlert</span><span class="op" id="3779543">(</span><span class="ident" id="3779544">alertUnexpectedMessage</span><span class="op" id="3779566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3779570">return</span>&nbsp;<span class="ident" id="3779577">unexpectedMessageError</span><span class="op" id="3779599">(</span><span class="ident" id="3779600">certMsg</span><span class="op" id="3779607">,</span>&nbsp;<span class="ident" id="3779609">msg</span><span class="op" id="3779612">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3779615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3779618">hs</span><span class="op" id="3779620">.</span><span class="ident" id="3779621">finishedHash</span><span class="op" id="3779633">.</span><span class="ident" id="3779634">Write</span><span class="op" id="3779639">(</span><span class="ident" id="3779640">certMsg</span><span class="op" id="3779647">.</span><span class="ident" id="3779648">marshal</span><span class="op" id="3779655">(</span><span class="op" id="3779656">)</span><span class="op" id="3779657">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3779661">certs</span>&nbsp;<span class="op" id="3779667">:=</span>&nbsp;<span class="builtinfunc" id="3779670">make</span><span class="op" id="3779674">(</span><span class="op" id="3779675">[</span><span class="op" id="3779676">]</span><span class="op" id="3779677">*</span><span class="ident" id="3779678">x509</span><span class="op" id="3779682">.</span><span class="ident" id="3779683">Certificate</span><span class="op" id="3779694">,</span>&nbsp;<span class="builtinfunc" id="3779696">len</span><span class="op" id="3779699">(</span><span class="ident" id="3779700">certMsg</span><span class="op" id="3779707">.</span><span class="ident" id="3779708">certificates</span><span class="op" id="3779720">)</span><span class="op" id="3779721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3779724">for</span>&nbsp;<span class="ident" id="3779728">i</span><span class="op" id="3779729">,</span>&nbsp;<span class="ident" id="3779731">asn1Data</span>&nbsp;<span class="op" id="3779740">:=</span>&nbsp;<span class="keyword" id="3779743">range</span>&nbsp;<span class="ident" id="3779749">certMsg</span><span class="op" id="3779756">.</span><span class="ident" id="3779757">certificates</span>&nbsp;<span class="op" id="3779770">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3779774">cert</span><span class="op" id="3779778">,</span>&nbsp;<span class="ident" id="3779780">err</span>&nbsp;<span class="op" id="3779784">:=</span>&nbsp;<span class="ident" id="3779787">x509</span><span class="op" id="3779791">.</span><span class="ident" id="3779792">ParseCertificate</span><span class="op" id="3779808">(</span><span class="ident" id="3779809">asn1Data</span><span class="op" id="3779817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3779821">if</span>&nbsp;<span class="ident" id="3779824">err</span>&nbsp;<span class="op" id="3779828">!=</span>&nbsp;<span class="builtintype" id="3779831">nil</span>&nbsp;<span class="op" id="3779835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3779840">c</span><span class="op" id="3779841">.</span><span class="ident" id="3779842">sendAlert</span><span class="op" id="3779851">(</span><span class="ident" id="3779852">alertBadCertificate</span><span class="op" id="3779871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3779876">return</span>&nbsp;<span class="ident" id="3779883">errors</span><span class="op" id="3779889">.</span><span class="ident" id="3779890">New</span><span class="op" id="3779893">(</span><span class="string" id="3779894">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;from&nbsp;server:&nbsp;&#34;</span>&nbsp;<span class="op" id="3779943">+</span>&nbsp;<span class="ident" id="3779945">err</span><span class="op" id="3779948">.</span><span class="ident" id="3779949">Error</span><span class="op" id="3779954">(</span><span class="op" id="3779955">)</span><span class="op" id="3779956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3779960">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3779964">certs</span><span class="op" id="3779969">[</span><span class="ident" id="3779970">i</span><span class="op" id="3779971">]</span>&nbsp;<span class="op" id="3779973">=</span>&nbsp;<span class="ident" id="3779975">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3779981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3779985">if</span>&nbsp;<span class="op" id="3779988">!</span><span class="ident" id="3779989">c</span><span class="op" id="3779990">.</span><span class="ident" id="3779991">config</span><span class="op" id="3779997">.</span><span class="ident" id="3779998">InsecureSkipVerify</span>&nbsp;<span class="op" id="3780017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3780021">opts</span>&nbsp;<span class="op" id="3780026">:=</span>&nbsp;<span class="ident" id="3780029">x509</span><span class="op" id="3780033">.</span><span class="ident" id="3780034">VerifyOptions</span><span class="op" id="3780047">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3780052">Roots</span><span class="op" id="3780057">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3780067">c</span><span class="op" id="3780068">.</span><span class="ident" id="3780069">config</span><span class="op" id="3780075">.</span><span class="ident" id="3780076">RootCAs</span><span class="op" id="3780083">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3780088">CurrentTime</span><span class="op" id="3780099">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3780103">c</span><span class="op" id="3780104">.</span><span class="ident" id="3780105">config</span><span class="op" id="3780111">.</span><span class="ident" id="3780112">time</span><span class="op" id="3780116">(</span><span class="op" id="3780117">)</span><span class="op" id="3780118">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3780123">DNSName</span><span class="op" id="3780130">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3780138">c</span><span class="op" id="3780139">.</span><span class="ident" id="3780140">config</span><span class="op" id="3780146">.</span><span class="ident" id="3780147">ServerName</span><span class="op" id="3780157">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3780162">Intermediates</span><span class="op" id="3780175">:</span>&nbsp;<span class="ident" id="3780177">x509</span><span class="op" id="3780181">.</span><span class="ident" id="3780182">NewCertPool</span><span class="op" id="3780193">(</span><span class="op" id="3780194">)</span><span class="op" id="3780195">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3780199">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3780204">for</span>&nbsp;<span class="ident" id="3780208">i</span><span class="op" id="3780209">,</span>&nbsp;<span class="ident" id="3780211">cert</span>&nbsp;<span class="op" id="3780216">:=</span>&nbsp;<span class="keyword" id="3780219">range</span>&nbsp;<span class="ident" id="3780225">certs</span>&nbsp;<span class="op" id="3780231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3780236">if</span>&nbsp;<span class="ident" id="3780239">i</span>&nbsp;<span class="op" id="3780241">==</span>&nbsp;<span class="num" id="3780244">0</span>&nbsp;<span class="op" id="3780246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3780252">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3780264">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3780269">opts</span><span class="op" id="3780273">.</span><span class="ident" id="3780274">Intermediates</span><span class="op" id="3780287">.</span><span class="ident" id="3780288">AddCert</span><span class="op" id="3780295">(</span><span class="ident" id="3780296">cert</span><span class="op" id="3780300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3780304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3780308">c</span><span class="op" id="3780309">.</span><span class="ident" id="3780310">verifiedChains</span><span class="op" id="3780324">,</span>&nbsp;<span class="ident" id="3780326">err</span>&nbsp;<span class="op" id="3780330">=</span>&nbsp;<span class="ident" id="3780332">certs</span><span class="op" id="3780337">[</span><span class="num" id="3780338">0</span><span class="op" id="3780339">]</span><span class="op" id="3780340">.</span><span class="ident" id="3780341">Verify</span><span class="op" id="3780347">(</span><span class="ident" id="3780348">opts</span><span class="op" id="3780352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3780356">if</span>&nbsp;<span class="ident" id="3780359">err</span>&nbsp;<span class="op" id="3780363">!=</span>&nbsp;<span class="builtintype" id="3780366">nil</span>&nbsp;<span class="op" id="3780370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3780375">c</span><span class="op" id="3780376">.</span><span class="ident" id="3780377">sendAlert</span><span class="op" id="3780386">(</span><span class="ident" id="3780387">alertBadCertificate</span><span class="op" id="3780406">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3780411">return</span>&nbsp;<span class="ident" id="3780418">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3780424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3780427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3780431">switch</span>&nbsp;<span class="ident" id="3780438">certs</span><span class="op" id="3780443">[</span><span class="num" id="3780444">0</span><span class="op" id="3780445">]</span><span class="op" id="3780446">.</span><span class="ident" id="3780447">PublicKey</span><span class="op" id="3780456">.</span><span class="op" id="3780457">(</span><span class="keyword" id="3780458">type</span><span class="op" id="3780462">)</span>&nbsp;<span class="op" id="3780464">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3780467">case</span>&nbsp;<span class="op" id="3780472">*</span><span class="ident" id="3780473">rsa</span><span class="op" id="3780476">.</span><span class="ident" id="3780477">PublicKey</span><span class="op" id="3780486">,</span>&nbsp;<span class="op" id="3780488">*</span><span class="ident" id="3780489">ecdsa</span><span class="op" id="3780494">.</span><span class="ident" id="3780495">PublicKey</span><span class="op" id="3780504">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3780508">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3780515">default</span><span class="op" id="3780522">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3780526">c</span><span class="op" id="3780527">.</span><span class="ident" id="3780528">sendAlert</span><span class="op" id="3780537">(</span><span class="ident" id="3780538">alertUnsupportedCertificate</span><span class="op" id="3780565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3780569">return</span>&nbsp;<span class="ident" id="3780576">fmt</span><span class="op" id="3780579">.</span><span class="ident" id="3780580">Errorf</span><span class="op" id="3780586">(</span><span class="string" id="3780587">&#34;tls:&nbsp;server&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;type&nbsp;of&nbsp;public&nbsp;key:&nbsp;%T&#34;</span><span class="op" id="3780661">,</span>&nbsp;<span class="ident" id="3780663">certs</span><span class="op" id="3780668">[</span><span class="num" id="3780669">0</span><span class="op" id="3780670">]</span><span class="op" id="3780671">.</span><span class="ident" id="3780672">PublicKey</span><span class="op" id="3780681">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3780684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3780688">c</span><span class="op" id="3780689">.</span><span class="ident" id="3780690">peerCertificates</span>&nbsp;<span class="op" id="3780707">=</span>&nbsp;<span class="ident" id="3780709">certs</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3780717">if</span>&nbsp;<span class="ident" id="3780720">hs</span><span class="op" id="3780722">.</span><span class="ident" id="3780723">serverHello</span><span class="op" id="3780734">.</span><span class="ident" id="3780735">ocspStapling</span>&nbsp;<span class="op" id="3780748">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3780752">msg</span><span class="op" id="3780755">,</span>&nbsp;<span class="ident" id="3780757">err</span>&nbsp;<span class="op" id="3780761">=</span>&nbsp;<span class="ident" id="3780763">c</span><span class="op" id="3780764">.</span><span class="ident" id="3780765">readHandshake</span><span class="op" id="3780778">(</span><span class="op" id="3780779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3780783">if</span>&nbsp;<span class="ident" id="3780786">err</span>&nbsp;<span class="op" id="3780790">!=</span>&nbsp;<span class="builtintype" id="3780793">nil</span>&nbsp;<span class="op" id="3780797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3780802">return</span>&nbsp;<span class="ident" id="3780809">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3780815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3780819">cs</span><span class="op" id="3780821">,</span>&nbsp;<span class="ident" id="3780823">ok</span>&nbsp;<span class="op" id="3780826">:=</span>&nbsp;<span class="ident" id="3780829">msg</span><span class="op" id="3780832">.</span><span class="op" id="3780833">(</span><span class="op" id="3780834">*</span><span class="ident" id="3780835">certificateStatusMsg</span><span class="op" id="3780855">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3780859">if</span>&nbsp;<span class="op" id="3780862">!</span><span class="ident" id="3780863">ok</span>&nbsp;<span class="op" id="3780866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3780871">c</span><span class="op" id="3780872">.</span><span class="ident" id="3780873">sendAlert</span><span class="op" id="3780882">(</span><span class="ident" id="3780883">alertUnexpectedMessage</span><span class="op" id="3780905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3780910">return</span>&nbsp;<span class="ident" id="3780917">unexpectedMessageError</span><span class="op" id="3780939">(</span><span class="ident" id="3780940">cs</span><span class="op" id="3780942">,</span>&nbsp;<span class="ident" id="3780944">msg</span><span class="op" id="3780947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3780951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3780955">hs</span><span class="op" id="3780957">.</span><span class="ident" id="3780958">finishedHash</span><span class="op" id="3780970">.</span><span class="ident" id="3780971">Write</span><span class="op" id="3780976">(</span><span class="ident" id="3780977">cs</span><span class="op" id="3780979">.</span><span class="ident" id="3780980">marshal</span><span class="op" id="3780987">(</span><span class="op" id="3780988">)</span><span class="op" id="3780989">)</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3780994">if</span>&nbsp;<span class="ident" id="3780997">cs</span><span class="op" id="3780999">.</span><span class="ident" id="3781000">statusType</span>&nbsp;<span class="op" id="3781011">==</span>&nbsp;<span class="ident" id="3781014">statusTypeOCSP</span>&nbsp;<span class="op" id="3781029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3781034">c</span><span class="op" id="3781035">.</span><span class="ident" id="3781036">ocspResponse</span>&nbsp;<span class="op" id="3781049">=</span>&nbsp;<span class="ident" id="3781051">cs</span><span class="op" id="3781053">.</span><span class="ident" id="3781054">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3781065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3781068">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3781072">msg</span><span class="op" id="3781075">,</span>&nbsp;<span class="ident" id="3781077">err</span>&nbsp;<span class="op" id="3781081">=</span>&nbsp;<span class="ident" id="3781083">c</span><span class="op" id="3781084">.</span><span class="ident" id="3781085">readHandshake</span><span class="op" id="3781098">(</span><span class="op" id="3781099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3781102">if</span>&nbsp;<span class="ident" id="3781105">err</span>&nbsp;<span class="op" id="3781109">!=</span>&nbsp;<span class="builtintype" id="3781112">nil</span>&nbsp;<span class="op" id="3781116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3781120">return</span>&nbsp;<span class="ident" id="3781127">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3781132">}</span><br>
<span class="lineno">300</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3781136">keyAgreement</span>&nbsp;<span class="op" id="3781149">:=</span>&nbsp;<span class="ident" id="3781152">hs</span><span class="op" id="3781154">.</span><span class="ident" id="3781155">suite</span><span class="op" id="3781160">.</span><span class="ident" id="3781161">ka</span><span class="op" id="3781163">(</span><span class="ident" id="3781164">c</span><span class="op" id="3781165">.</span><span class="ident" id="3781166">vers</span><span class="op" id="3781170">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3781174">skx</span><span class="op" id="3781177">,</span>&nbsp;<span class="ident" id="3781179">ok</span>&nbsp;<span class="op" id="3781182">:=</span>&nbsp;<span class="ident" id="3781185">msg</span><span class="op" id="3781188">.</span><span class="op" id="3781189">(</span><span class="op" id="3781190">*</span><span class="ident" id="3781191">serverKeyExchangeMsg</span><span class="op" id="3781211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3781214">if</span>&nbsp;<span class="ident" id="3781217">ok</span>&nbsp;<span class="op" id="3781220">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3781224">hs</span><span class="op" id="3781226">.</span><span class="ident" id="3781227">finishedHash</span><span class="op" id="3781239">.</span><span class="ident" id="3781240">Write</span><span class="op" id="3781245">(</span><span class="ident" id="3781246">skx</span><span class="op" id="3781249">.</span><span class="ident" id="3781250">marshal</span><span class="op" id="3781257">(</span><span class="op" id="3781258">)</span><span class="op" id="3781259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3781263">err</span>&nbsp;<span class="op" id="3781267">=</span>&nbsp;<span class="ident" id="3781269">keyAgreement</span><span class="op" id="3781281">.</span><span class="ident" id="3781282">processServerKeyExchange</span><span class="op" id="3781306">(</span><span class="ident" id="3781307">c</span><span class="op" id="3781308">.</span><span class="ident" id="3781309">config</span><span class="op" id="3781315">,</span>&nbsp;<span class="ident" id="3781317">hs</span><span class="op" id="3781319">.</span><span class="ident" id="3781320">hello</span><span class="op" id="3781325">,</span>&nbsp;<span class="ident" id="3781327">hs</span><span class="op" id="3781329">.</span><span class="ident" id="3781330">serverHello</span><span class="op" id="3781341">,</span>&nbsp;<span class="ident" id="3781343">certs</span><span class="op" id="3781348">[</span><span class="num" id="3781349">0</span><span class="op" id="3781350">]</span><span class="op" id="3781351">,</span>&nbsp;<span class="ident" id="3781353">skx</span><span class="op" id="3781356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3781360">if</span>&nbsp;<span class="ident" id="3781363">err</span>&nbsp;<span class="op" id="3781367">!=</span>&nbsp;<span class="builtintype" id="3781370">nil</span>&nbsp;<span class="op" id="3781374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3781379">c</span><span class="op" id="3781380">.</span><span class="ident" id="3781381">sendAlert</span><span class="op" id="3781390">(</span><span class="ident" id="3781391">alertUnexpectedMessage</span><span class="op" id="3781413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3781418">return</span>&nbsp;<span class="ident" id="3781425">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3781431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3781436">msg</span><span class="op" id="3781439">,</span>&nbsp;<span class="ident" id="3781441">err</span>&nbsp;<span class="op" id="3781445">=</span>&nbsp;<span class="ident" id="3781447">c</span><span class="op" id="3781448">.</span><span class="ident" id="3781449">readHandshake</span><span class="op" id="3781462">(</span><span class="op" id="3781463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3781467">if</span>&nbsp;<span class="ident" id="3781470">err</span>&nbsp;<span class="op" id="3781474">!=</span>&nbsp;<span class="builtintype" id="3781477">nil</span>&nbsp;<span class="op" id="3781481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3781486">return</span>&nbsp;<span class="ident" id="3781493">err</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3781499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3781502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3781506">var</span>&nbsp;<span class="ident" id="3781510">chainToSend</span>&nbsp;<span class="op" id="3781522">*</span><span class="ident" id="3781523">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3781536">var</span>&nbsp;<span class="ident" id="3781540">certRequested</span>&nbsp;<span class="builtintype" id="3781554">bool</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3781560">certReq</span><span class="op" id="3781567">,</span>&nbsp;<span class="ident" id="3781569">ok</span>&nbsp;<span class="op" id="3781572">:=</span>&nbsp;<span class="ident" id="3781575">msg</span><span class="op" id="3781578">.</span><span class="op" id="3781579">(</span><span class="op" id="3781580">*</span><span class="ident" id="3781581">certificateRequestMsg</span><span class="op" id="3781602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3781605">if</span>&nbsp;<span class="ident" id="3781608">ok</span>&nbsp;<span class="op" id="3781611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3781615">certRequested</span>&nbsp;<span class="op" id="3781629">=</span>&nbsp;<span class="builtintype" id="3781631">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3781639">//&nbsp;RFC&nbsp;4346&nbsp;on&nbsp;the&nbsp;certificateAuthorities&nbsp;field:</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3781690">//&nbsp;A&nbsp;list&nbsp;of&nbsp;the&nbsp;distinguished&nbsp;names&nbsp;of&nbsp;acceptable&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3781755">//&nbsp;authorities.&nbsp;These&nbsp;distinguished&nbsp;names&nbsp;may&nbsp;specify&nbsp;a&nbsp;desired</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3781821">//&nbsp;distinguished&nbsp;name&nbsp;for&nbsp;a&nbsp;root&nbsp;CA&nbsp;or&nbsp;for&nbsp;a&nbsp;subordinate&nbsp;CA;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3781884">//&nbsp;thus,&nbsp;this&nbsp;message&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;describe&nbsp;both&nbsp;known&nbsp;roots</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3781949">//&nbsp;and&nbsp;a&nbsp;desired&nbsp;authorization&nbsp;space.&nbsp;If&nbsp;the</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3781996">//&nbsp;certificate_authorities&nbsp;list&nbsp;is&nbsp;empty&nbsp;then&nbsp;the&nbsp;client&nbsp;MAY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3782059">//&nbsp;send&nbsp;any&nbsp;certificate&nbsp;of&nbsp;the&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3782104">//&nbsp;ClientCertificateType,&nbsp;unless&nbsp;there&nbsp;is&nbsp;some&nbsp;external</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3782162">//&nbsp;arrangement&nbsp;to&nbsp;the&nbsp;contrary.</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3782197">hs</span><span class="op" id="3782199">.</span><span class="ident" id="3782200">finishedHash</span><span class="op" id="3782212">.</span><span class="ident" id="3782213">Write</span><span class="op" id="3782218">(</span><span class="ident" id="3782219">certReq</span><span class="op" id="3782226">.</span><span class="ident" id="3782227">marshal</span><span class="op" id="3782234">(</span><span class="op" id="3782235">)</span><span class="op" id="3782236">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3782241">var</span>&nbsp;<span class="ident" id="3782245">rsaAvail</span><span class="op" id="3782253">,</span>&nbsp;<span class="ident" id="3782255">ecdsaAvail</span>&nbsp;<span class="builtintype" id="3782266">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3782273">for</span>&nbsp;<span class="ident" id="3782277">_</span><span class="op" id="3782278">,</span>&nbsp;<span class="ident" id="3782280">certType</span>&nbsp;<span class="op" id="3782289">:=</span>&nbsp;<span class="keyword" id="3782292">range</span>&nbsp;<span class="ident" id="3782298">certReq</span><span class="op" id="3782305">.</span><span class="ident" id="3782306">certificateTypes</span>&nbsp;<span class="op" id="3782323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3782328">switch</span>&nbsp;<span class="ident" id="3782335">certType</span>&nbsp;<span class="op" id="3782344">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3782349">case</span>&nbsp;<span class="ident" id="3782354">certTypeRSASign</span><span class="op" id="3782369">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3782375">rsaAvail</span>&nbsp;<span class="op" id="3782384">=</span>&nbsp;<span class="builtintype" id="3782386">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3782394">case</span>&nbsp;<span class="ident" id="3782399">certTypeECDSASign</span><span class="op" id="3782416">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3782422">ecdsaAvail</span>&nbsp;<span class="op" id="3782433">=</span>&nbsp;<span class="builtintype" id="3782435">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3782443">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3782447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3782452">//&nbsp;We&nbsp;need&nbsp;to&nbsp;search&nbsp;our&nbsp;list&nbsp;of&nbsp;client&nbsp;certs&nbsp;for&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3782508">//&nbsp;where&nbsp;SignatureAlgorithm&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;the&nbsp;server&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3782574">//&nbsp;Issuer&nbsp;is&nbsp;in&nbsp;certReq.certificateAuthorities</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3782622">findCert</span><span class="op" id="3782630">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3782634">for</span>&nbsp;<span class="ident" id="3782638">i</span><span class="op" id="3782639">,</span>&nbsp;<span class="ident" id="3782641">chain</span>&nbsp;<span class="op" id="3782647">:=</span>&nbsp;<span class="keyword" id="3782650">range</span>&nbsp;<span class="ident" id="3782656">c</span><span class="op" id="3782657">.</span><span class="ident" id="3782658">config</span><span class="op" id="3782664">.</span><span class="ident" id="3782665">Certificates</span>&nbsp;<span class="op" id="3782678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3782683">if</span>&nbsp;<span class="op" id="3782686">!</span><span class="ident" id="3782687">rsaAvail</span>&nbsp;<span class="op" id="3782696">&amp;&amp;</span>&nbsp;<span class="op" id="3782699">!</span><span class="ident" id="3782700">ecdsaAvail</span>&nbsp;<span class="op" id="3782711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3782717">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3782729">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3782735">for</span>&nbsp;<span class="ident" id="3782739">j</span><span class="op" id="3782740">,</span>&nbsp;<span class="ident" id="3782742">cert</span>&nbsp;<span class="op" id="3782747">:=</span>&nbsp;<span class="keyword" id="3782750">range</span>&nbsp;<span class="ident" id="3782756">chain</span><span class="op" id="3782761">.</span><span class="ident" id="3782762">Certificate</span>&nbsp;<span class="op" id="3782774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3782780">x509Cert</span>&nbsp;<span class="op" id="3782789">:=</span>&nbsp;<span class="ident" id="3782792">chain</span><span class="op" id="3782797">.</span><span class="ident" id="3782798">Leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3782807">//&nbsp;parse&nbsp;the&nbsp;certificate&nbsp;if&nbsp;this&nbsp;isn&#39;t&nbsp;the&nbsp;leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3782859">//&nbsp;node,&nbsp;or&nbsp;if&nbsp;chain.Leaf&nbsp;was&nbsp;nil</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3782897">if</span>&nbsp;<span class="ident" id="3782900">j</span>&nbsp;<span class="op" id="3782902">!=</span>&nbsp;<span class="num" id="3782905">0</span>&nbsp;<span class="op" id="3782907">||</span>&nbsp;<span class="ident" id="3782910">x509Cert</span>&nbsp;<span class="op" id="3782919">==</span>&nbsp;<span class="builtintype" id="3782922">nil</span>&nbsp;<span class="op" id="3782926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3782933">if</span>&nbsp;<span class="ident" id="3782936">x509Cert</span><span class="op" id="3782944">,</span>&nbsp;<span class="ident" id="3782946">err</span>&nbsp;<span class="op" id="3782950">=</span>&nbsp;<span class="ident" id="3782952">x509</span><span class="op" id="3782956">.</span><span class="ident" id="3782957">ParseCertificate</span><span class="op" id="3782973">(</span><span class="ident" id="3782974">cert</span><span class="op" id="3782978">)</span><span class="op" id="3782979">;</span>&nbsp;<span class="ident" id="3782981">err</span>&nbsp;<span class="op" id="3782985">!=</span>&nbsp;<span class="builtintype" id="3782988">nil</span>&nbsp;<span class="op" id="3782992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3783000">c</span><span class="op" id="3783001">.</span><span class="ident" id="3783002">sendAlert</span><span class="op" id="3783011">(</span><span class="ident" id="3783012">alertInternalError</span><span class="op" id="3783030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3783038">return</span>&nbsp;<span class="ident" id="3783045">errors</span><span class="op" id="3783051">.</span><span class="ident" id="3783052">New</span><span class="op" id="3783055">(</span><span class="string" id="3783056">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate&nbsp;#&#34;</span>&nbsp;<span class="op" id="3783100">+</span>&nbsp;<span class="ident" id="3783102">strconv</span><span class="op" id="3783109">.</span><span class="ident" id="3783110">Itoa</span><span class="op" id="3783114">(</span><span class="ident" id="3783115">i</span><span class="op" id="3783116">)</span>&nbsp;<span class="op" id="3783118">+</span>&nbsp;<span class="string" id="3783120">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="3783125">+</span>&nbsp;<span class="ident" id="3783127">err</span><span class="op" id="3783130">.</span><span class="ident" id="3783131">Error</span><span class="op" id="3783136">(</span><span class="op" id="3783137">)</span><span class="op" id="3783138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3783145">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3783151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3783158">switch</span>&nbsp;<span class="op" id="3783165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3783171">case</span>&nbsp;<span class="ident" id="3783176">rsaAvail</span>&nbsp;<span class="op" id="3783185">&amp;&amp;</span>&nbsp;<span class="ident" id="3783188">x509Cert</span><span class="op" id="3783196">.</span><span class="ident" id="3783197">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="3783216">==</span>&nbsp;<span class="ident" id="3783219">x509</span><span class="op" id="3783223">.</span><span class="ident" id="3783224">RSA</span><span class="op" id="3783227">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3783233">case</span>&nbsp;<span class="ident" id="3783238">ecdsaAvail</span>&nbsp;<span class="op" id="3783249">&amp;&amp;</span>&nbsp;<span class="ident" id="3783252">x509Cert</span><span class="op" id="3783260">.</span><span class="ident" id="3783261">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="3783280">==</span>&nbsp;<span class="ident" id="3783283">x509</span><span class="op" id="3783287">.</span><span class="ident" id="3783288">ECDSA</span><span class="op" id="3783293">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3783299">default</span><span class="op" id="3783306">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3783313">continue</span>&nbsp;<span class="ident" id="3783322">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3783335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3783342">if</span>&nbsp;<span class="builtinfunc" id="3783345">len</span><span class="op" id="3783348">(</span><span class="ident" id="3783349">certReq</span><span class="op" id="3783356">.</span><span class="ident" id="3783357">certificateAuthorities</span><span class="op" id="3783379">)</span>&nbsp;<span class="op" id="3783381">==</span>&nbsp;<span class="num" id="3783384">0</span>&nbsp;<span class="op" id="3783386">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3783393">//&nbsp;they&nbsp;gave&nbsp;us&nbsp;an&nbsp;empty&nbsp;list,&nbsp;so&nbsp;just&nbsp;take&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3783446">//&nbsp;first&nbsp;cert&nbsp;from&nbsp;c.config.Certificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3783492">chainToSend</span>&nbsp;<span class="op" id="3783504">=</span>&nbsp;<span class="op" id="3783506">&amp;</span><span class="ident" id="3783507">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3783518">break</span>&nbsp;<span class="ident" id="3783524">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3783537">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3783544">for</span>&nbsp;<span class="ident" id="3783548">_</span><span class="op" id="3783549">,</span>&nbsp;<span class="ident" id="3783551">ca</span>&nbsp;<span class="op" id="3783554">:=</span>&nbsp;<span class="keyword" id="3783557">range</span>&nbsp;<span class="ident" id="3783563">certReq</span><span class="op" id="3783570">.</span><span class="ident" id="3783571">certificateAuthorities</span>&nbsp;<span class="op" id="3783594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3783601">if</span>&nbsp;<span class="ident" id="3783604">bytes</span><span class="op" id="3783609">.</span><span class="ident" id="3783610">Equal</span><span class="op" id="3783615">(</span><span class="ident" id="3783616">x509Cert</span><span class="op" id="3783624">.</span><span class="ident" id="3783625">RawIssuer</span><span class="op" id="3783634">,</span>&nbsp;<span class="ident" id="3783636">ca</span><span class="op" id="3783638">)</span>&nbsp;<span class="op" id="3783640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3783648">chainToSend</span>&nbsp;<span class="op" id="3783660">=</span>&nbsp;<span class="op" id="3783662">&amp;</span><span class="ident" id="3783663">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3783675">break</span>&nbsp;<span class="ident" id="3783681">findCert</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3783695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3783701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3783706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3783710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3783715">msg</span><span class="op" id="3783718">,</span>&nbsp;<span class="ident" id="3783720">err</span>&nbsp;<span class="op" id="3783724">=</span>&nbsp;<span class="ident" id="3783726">c</span><span class="op" id="3783727">.</span><span class="ident" id="3783728">readHandshake</span><span class="op" id="3783741">(</span><span class="op" id="3783742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3783746">if</span>&nbsp;<span class="ident" id="3783749">err</span>&nbsp;<span class="op" id="3783753">!=</span>&nbsp;<span class="builtintype" id="3783756">nil</span>&nbsp;<span class="op" id="3783760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3783765">return</span>&nbsp;<span class="ident" id="3783772">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3783778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3783781">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3783785">shd</span><span class="op" id="3783788">,</span>&nbsp;<span class="ident" id="3783790">ok</span>&nbsp;<span class="op" id="3783793">:=</span>&nbsp;<span class="ident" id="3783796">msg</span><span class="op" id="3783799">.</span><span class="op" id="3783800">(</span><span class="op" id="3783801">*</span><span class="ident" id="3783802">serverHelloDoneMsg</span><span class="op" id="3783820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3783823">if</span>&nbsp;<span class="op" id="3783826">!</span><span class="ident" id="3783827">ok</span>&nbsp;<span class="op" id="3783830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3783834">c</span><span class="op" id="3783835">.</span><span class="ident" id="3783836">sendAlert</span><span class="op" id="3783845">(</span><span class="ident" id="3783846">alertUnexpectedMessage</span><span class="op" id="3783868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3783872">return</span>&nbsp;<span class="ident" id="3783879">unexpectedMessageError</span><span class="op" id="3783901">(</span><span class="ident" id="3783902">shd</span><span class="op" id="3783905">,</span>&nbsp;<span class="ident" id="3783907">msg</span><span class="op" id="3783910">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3783913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3783916">hs</span><span class="op" id="3783918">.</span><span class="ident" id="3783919">finishedHash</span><span class="op" id="3783931">.</span><span class="ident" id="3783932">Write</span><span class="op" id="3783937">(</span><span class="ident" id="3783938">shd</span><span class="op" id="3783941">.</span><span class="ident" id="3783942">marshal</span><span class="op" id="3783949">(</span><span class="op" id="3783950">)</span><span class="op" id="3783951">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3783955">//&nbsp;If&nbsp;the&nbsp;server&nbsp;requested&nbsp;a&nbsp;certificate&nbsp;then&nbsp;we&nbsp;have&nbsp;to&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3784020">//&nbsp;Certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3784088">//&nbsp;certificate&nbsp;to&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3784113">if</span>&nbsp;<span class="ident" id="3784116">certRequested</span>&nbsp;<span class="op" id="3784130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3784134">certMsg</span>&nbsp;<span class="op" id="3784142">=</span>&nbsp;<span class="builtinfunc" id="3784144">new</span><span class="op" id="3784147">(</span><span class="ident" id="3784148">certificateMsg</span><span class="op" id="3784162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3784166">if</span>&nbsp;<span class="ident" id="3784169">chainToSend</span>&nbsp;<span class="op" id="3784181">!=</span>&nbsp;<span class="builtintype" id="3784184">nil</span>&nbsp;<span class="op" id="3784188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3784193">certMsg</span><span class="op" id="3784200">.</span><span class="ident" id="3784201">certificates</span>&nbsp;<span class="op" id="3784214">=</span>&nbsp;<span class="ident" id="3784216">chainToSend</span><span class="op" id="3784227">.</span><span class="ident" id="3784228">Certificate</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3784242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3784246">hs</span><span class="op" id="3784248">.</span><span class="ident" id="3784249">finishedHash</span><span class="op" id="3784261">.</span><span class="ident" id="3784262">Write</span><span class="op" id="3784267">(</span><span class="ident" id="3784268">certMsg</span><span class="op" id="3784275">.</span><span class="ident" id="3784276">marshal</span><span class="op" id="3784283">(</span><span class="op" id="3784284">)</span><span class="op" id="3784285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3784289">c</span><span class="op" id="3784290">.</span><span class="ident" id="3784291">writeRecord</span><span class="op" id="3784302">(</span><span class="ident" id="3784303">recordTypeHandshake</span><span class="op" id="3784322">,</span>&nbsp;<span class="ident" id="3784324">certMsg</span><span class="op" id="3784331">.</span><span class="ident" id="3784332">marshal</span><span class="op" id="3784339">(</span><span class="op" id="3784340">)</span><span class="op" id="3784341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3784344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3784348">preMasterSecret</span><span class="op" id="3784363">,</span>&nbsp;<span class="ident" id="3784365">ckx</span><span class="op" id="3784368">,</span>&nbsp;<span class="ident" id="3784370">err</span>&nbsp;<span class="op" id="3784374">:=</span>&nbsp;<span class="ident" id="3784377">keyAgreement</span><span class="op" id="3784389">.</span><span class="ident" id="3784390">generateClientKeyExchange</span><span class="op" id="3784415">(</span><span class="ident" id="3784416">c</span><span class="op" id="3784417">.</span><span class="ident" id="3784418">config</span><span class="op" id="3784424">,</span>&nbsp;<span class="ident" id="3784426">hs</span><span class="op" id="3784428">.</span><span class="ident" id="3784429">hello</span><span class="op" id="3784434">,</span>&nbsp;<span class="ident" id="3784436">certs</span><span class="op" id="3784441">[</span><span class="num" id="3784442">0</span><span class="op" id="3784443">]</span><span class="op" id="3784444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3784447">if</span>&nbsp;<span class="ident" id="3784450">err</span>&nbsp;<span class="op" id="3784454">!=</span>&nbsp;<span class="builtintype" id="3784457">nil</span>&nbsp;<span class="op" id="3784461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3784465">c</span><span class="op" id="3784466">.</span><span class="ident" id="3784467">sendAlert</span><span class="op" id="3784476">(</span><span class="ident" id="3784477">alertInternalError</span><span class="op" id="3784495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3784499">return</span>&nbsp;<span class="ident" id="3784506">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3784511">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3784514">if</span>&nbsp;<span class="ident" id="3784517">ckx</span>&nbsp;<span class="op" id="3784521">!=</span>&nbsp;<span class="builtintype" id="3784524">nil</span>&nbsp;<span class="op" id="3784528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3784532">hs</span><span class="op" id="3784534">.</span><span class="ident" id="3784535">finishedHash</span><span class="op" id="3784547">.</span><span class="ident" id="3784548">Write</span><span class="op" id="3784553">(</span><span class="ident" id="3784554">ckx</span><span class="op" id="3784557">.</span><span class="ident" id="3784558">marshal</span><span class="op" id="3784565">(</span><span class="op" id="3784566">)</span><span class="op" id="3784567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3784571">c</span><span class="op" id="3784572">.</span><span class="ident" id="3784573">writeRecord</span><span class="op" id="3784584">(</span><span class="ident" id="3784585">recordTypeHandshake</span><span class="op" id="3784604">,</span>&nbsp;<span class="ident" id="3784606">ckx</span><span class="op" id="3784609">.</span><span class="ident" id="3784610">marshal</span><span class="op" id="3784617">(</span><span class="op" id="3784618">)</span><span class="op" id="3784619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3784622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3784626">if</span>&nbsp;<span class="ident" id="3784629">chainToSend</span>&nbsp;<span class="op" id="3784641">!=</span>&nbsp;<span class="builtintype" id="3784644">nil</span>&nbsp;<span class="op" id="3784648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3784652">var</span>&nbsp;<span class="ident" id="3784656">signed</span>&nbsp;<span class="op" id="3784663">[</span><span class="op" id="3784664">]</span><span class="builtintype" id="3784665">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3784672">certVerify</span>&nbsp;<span class="op" id="3784683">:=</span>&nbsp;<span class="op" id="3784686">&amp;</span><span class="ident" id="3784687">certificateVerifyMsg</span><span class="op" id="3784707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3784712">hasSignatureAndHash</span><span class="op" id="3784731">:</span>&nbsp;<span class="ident" id="3784733">c</span><span class="op" id="3784734">.</span><span class="ident" id="3784735">vers</span>&nbsp;<span class="op" id="3784740">&gt;=</span>&nbsp;<span class="ident" id="3784743">VersionTLS12</span><span class="op" id="3784755">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3784759">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3784764">key</span><span class="op" id="3784767">,</span>&nbsp;<span class="ident" id="3784769">ok</span>&nbsp;<span class="op" id="3784772">:=</span>&nbsp;<span class="ident" id="3784775">chainToSend</span><span class="op" id="3784786">.</span><span class="ident" id="3784787">PrivateKey</span><span class="op" id="3784797">.</span><span class="op" id="3784798">(</span><span class="ident" id="3784799">crypto</span><span class="op" id="3784805">.</span><span class="ident" id="3784806">Signer</span><span class="op" id="3784812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3784816">if</span>&nbsp;<span class="op" id="3784819">!</span><span class="ident" id="3784820">ok</span>&nbsp;<span class="op" id="3784823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3784828">c</span><span class="op" id="3784829">.</span><span class="ident" id="3784830">sendAlert</span><span class="op" id="3784839">(</span><span class="ident" id="3784840">alertInternalError</span><span class="op" id="3784858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3784863">return</span>&nbsp;<span class="ident" id="3784870">fmt</span><span class="op" id="3784873">.</span><span class="ident" id="3784874">Errorf</span><span class="op" id="3784880">(</span><span class="string" id="3784881">&#34;tls:&nbsp;client&nbsp;certificate&nbsp;private&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&nbsp;does&nbsp;not&nbsp;implement&nbsp;crypto.Signer&#34;</span><span class="op" id="3784962">,</span>&nbsp;<span class="ident" id="3784964">chainToSend</span><span class="op" id="3784975">.</span><span class="ident" id="3784976">PrivateKey</span><span class="op" id="3784986">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3784990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3784994">switch</span>&nbsp;<span class="ident" id="3785001">key</span><span class="op" id="3785004">.</span><span class="ident" id="3785005">Public</span><span class="op" id="3785011">(</span><span class="op" id="3785012">)</span><span class="op" id="3785013">.</span><span class="op" id="3785014">(</span><span class="keyword" id="3785015">type</span><span class="op" id="3785019">)</span>&nbsp;<span class="op" id="3785021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3785025">case</span>&nbsp;<span class="op" id="3785030">*</span><span class="ident" id="3785031">ecdsa</span><span class="op" id="3785036">.</span><span class="ident" id="3785037">PublicKey</span><span class="op" id="3785046">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3785051">digest</span><span class="op" id="3785057">,</span>&nbsp;<span class="ident" id="3785059">hashFunc</span><span class="op" id="3785067">,</span>&nbsp;<span class="ident" id="3785069">hashId</span>&nbsp;<span class="op" id="3785076">:=</span>&nbsp;<span class="ident" id="3785079">hs</span><span class="op" id="3785081">.</span><span class="ident" id="3785082">finishedHash</span><span class="op" id="3785094">.</span><span class="ident" id="3785095">hashForClientCertificate</span><span class="op" id="3785119">(</span><span class="ident" id="3785120">signatureECDSA</span><span class="op" id="3785134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3785139">signed</span><span class="op" id="3785145">,</span>&nbsp;<span class="ident" id="3785147">err</span>&nbsp;<span class="op" id="3785151">=</span>&nbsp;<span class="ident" id="3785153">key</span><span class="op" id="3785156">.</span><span class="ident" id="3785157">Sign</span><span class="op" id="3785161">(</span><span class="ident" id="3785162">c</span><span class="op" id="3785163">.</span><span class="ident" id="3785164">config</span><span class="op" id="3785170">.</span><span class="ident" id="3785171">rand</span><span class="op" id="3785175">(</span><span class="op" id="3785176">)</span><span class="op" id="3785177">,</span>&nbsp;<span class="ident" id="3785179">digest</span><span class="op" id="3785185">,</span>&nbsp;<span class="ident" id="3785187">hashFunc</span><span class="op" id="3785195">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3785200">certVerify</span><span class="op" id="3785210">.</span><span class="ident" id="3785211">signatureAndHash</span><span class="op" id="3785227">.</span><span class="ident" id="3785228">signature</span>&nbsp;<span class="op" id="3785238">=</span>&nbsp;<span class="ident" id="3785240">signatureECDSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3785258">certVerify</span><span class="op" id="3785268">.</span><span class="ident" id="3785269">signatureAndHash</span><span class="op" id="3785285">.</span><span class="ident" id="3785286">hash</span>&nbsp;<span class="op" id="3785291">=</span>&nbsp;<span class="ident" id="3785293">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3785302">case</span>&nbsp;<span class="op" id="3785307">*</span><span class="ident" id="3785308">rsa</span><span class="op" id="3785311">.</span><span class="ident" id="3785312">PublicKey</span><span class="op" id="3785321">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3785326">digest</span><span class="op" id="3785332">,</span>&nbsp;<span class="ident" id="3785334">hashFunc</span><span class="op" id="3785342">,</span>&nbsp;<span class="ident" id="3785344">hashId</span>&nbsp;<span class="op" id="3785351">:=</span>&nbsp;<span class="ident" id="3785354">hs</span><span class="op" id="3785356">.</span><span class="ident" id="3785357">finishedHash</span><span class="op" id="3785369">.</span><span class="ident" id="3785370">hashForClientCertificate</span><span class="op" id="3785394">(</span><span class="ident" id="3785395">signatureRSA</span><span class="op" id="3785407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3785412">signed</span><span class="op" id="3785418">,</span>&nbsp;<span class="ident" id="3785420">err</span>&nbsp;<span class="op" id="3785424">=</span>&nbsp;<span class="ident" id="3785426">key</span><span class="op" id="3785429">.</span><span class="ident" id="3785430">Sign</span><span class="op" id="3785434">(</span><span class="ident" id="3785435">c</span><span class="op" id="3785436">.</span><span class="ident" id="3785437">config</span><span class="op" id="3785443">.</span><span class="ident" id="3785444">rand</span><span class="op" id="3785448">(</span><span class="op" id="3785449">)</span><span class="op" id="3785450">,</span>&nbsp;<span class="ident" id="3785452">digest</span><span class="op" id="3785458">,</span>&nbsp;<span class="ident" id="3785460">hashFunc</span><span class="op" id="3785468">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3785473">certVerify</span><span class="op" id="3785483">.</span><span class="ident" id="3785484">signatureAndHash</span><span class="op" id="3785500">.</span><span class="ident" id="3785501">signature</span>&nbsp;<span class="op" id="3785511">=</span>&nbsp;<span class="ident" id="3785513">signatureRSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3785529">certVerify</span><span class="op" id="3785539">.</span><span class="ident" id="3785540">signatureAndHash</span><span class="op" id="3785556">.</span><span class="ident" id="3785557">hash</span>&nbsp;<span class="op" id="3785562">=</span>&nbsp;<span class="ident" id="3785564">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3785573">default</span><span class="op" id="3785580">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3785585">err</span>&nbsp;<span class="op" id="3785589">=</span>&nbsp;<span class="ident" id="3785591">fmt</span><span class="op" id="3785594">.</span><span class="ident" id="3785595">Errorf</span><span class="op" id="3785601">(</span><span class="string" id="3785602">&#34;tls:&nbsp;unknown&nbsp;client&nbsp;certificate&nbsp;key&nbsp;type:&nbsp;%T&#34;</span><span class="op" id="3785648">,</span>&nbsp;<span class="ident" id="3785650">key</span><span class="op" id="3785653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3785657">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3785661">if</span>&nbsp;<span class="ident" id="3785664">err</span>&nbsp;<span class="op" id="3785668">!=</span>&nbsp;<span class="builtintype" id="3785671">nil</span>&nbsp;<span class="op" id="3785675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3785680">c</span><span class="op" id="3785681">.</span><span class="ident" id="3785682">sendAlert</span><span class="op" id="3785691">(</span><span class="ident" id="3785692">alertInternalError</span><span class="op" id="3785710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3785715">return</span>&nbsp;<span class="ident" id="3785722">errors</span><span class="op" id="3785728">.</span><span class="ident" id="3785729">New</span><span class="op" id="3785732">(</span><span class="string" id="3785733">&#34;tls:&nbsp;failed&nbsp;to&nbsp;sign&nbsp;handshake&nbsp;with&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3785791">+</span>&nbsp;<span class="ident" id="3785793">err</span><span class="op" id="3785796">.</span><span class="ident" id="3785797">Error</span><span class="op" id="3785802">(</span><span class="op" id="3785803">)</span><span class="op" id="3785804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3785808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3785812">certVerify</span><span class="op" id="3785822">.</span><span class="ident" id="3785823">signature</span>&nbsp;<span class="op" id="3785833">=</span>&nbsp;<span class="ident" id="3785835">signed</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3785845">hs</span><span class="op" id="3785847">.</span><span class="ident" id="3785848">finishedHash</span><span class="op" id="3785860">.</span><span class="ident" id="3785861">Write</span><span class="op" id="3785866">(</span><span class="ident" id="3785867">certVerify</span><span class="op" id="3785877">.</span><span class="ident" id="3785878">marshal</span><span class="op" id="3785885">(</span><span class="op" id="3785886">)</span><span class="op" id="3785887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3785891">c</span><span class="op" id="3785892">.</span><span class="ident" id="3785893">writeRecord</span><span class="op" id="3785904">(</span><span class="ident" id="3785905">recordTypeHandshake</span><span class="op" id="3785924">,</span>&nbsp;<span class="ident" id="3785926">certVerify</span><span class="op" id="3785936">.</span><span class="ident" id="3785937">marshal</span><span class="op" id="3785944">(</span><span class="op" id="3785945">)</span><span class="op" id="3785946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3785949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3785953">hs</span><span class="op" id="3785955">.</span><span class="ident" id="3785956">masterSecret</span>&nbsp;<span class="op" id="3785969">=</span>&nbsp;<span class="ident" id="3785971">masterFromPreMasterSecret</span><span class="op" id="3785996">(</span><span class="ident" id="3785997">c</span><span class="op" id="3785998">.</span><span class="ident" id="3785999">vers</span><span class="op" id="3786003">,</span>&nbsp;<span class="ident" id="3786005">preMasterSecret</span><span class="op" id="3786020">,</span>&nbsp;<span class="ident" id="3786022">hs</span><span class="op" id="3786024">.</span><span class="ident" id="3786025">hello</span><span class="op" id="3786030">.</span><span class="ident" id="3786031">random</span><span class="op" id="3786037">,</span>&nbsp;<span class="ident" id="3786039">hs</span><span class="op" id="3786041">.</span><span class="ident" id="3786042">serverHello</span><span class="op" id="3786053">.</span><span class="ident" id="3786054">random</span><span class="op" id="3786060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3786063">return</span>&nbsp;<span class="builtintype" id="3786070">nil</span><br>
<span class="lineno"></span><span class="op" id="3786074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3786077">func</span>&nbsp;<span class="op" id="3786082">(</span><span class="ident" id="3786083">hs</span>&nbsp;<span class="op" id="3786086">*</span><span class="ident" id="3786087">clientHandshakeState</span><span class="op" id="3786107">)</span>&nbsp;<span class="ident" id="3786109">establishKeys</span><span class="op" id="3786122">(</span><span class="op" id="3786123">)</span>&nbsp;<span class="builtintype" id="3786125">error</span>&nbsp;<span class="op" id="3786131">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3786134">c</span>&nbsp;<span class="op" id="3786136">:=</span>&nbsp;<span class="ident" id="3786139">hs</span><span class="op" id="3786141">.</span><span class="ident" id="3786142">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3786146">clientMAC</span><span class="op" id="3786155">,</span>&nbsp;<span class="ident" id="3786157">serverMAC</span><span class="op" id="3786166">,</span>&nbsp;<span class="ident" id="3786168">clientKey</span><span class="op" id="3786177">,</span>&nbsp;<span class="ident" id="3786179">serverKey</span><span class="op" id="3786188">,</span>&nbsp;<span class="ident" id="3786190">clientIV</span><span class="op" id="3786198">,</span>&nbsp;<span class="ident" id="3786200">serverIV</span>&nbsp;<span class="op" id="3786209">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3786214">keysFromMasterSecret</span><span class="op" id="3786234">(</span><span class="ident" id="3786235">c</span><span class="op" id="3786236">.</span><span class="ident" id="3786237">vers</span><span class="op" id="3786241">,</span>&nbsp;<span class="ident" id="3786243">hs</span><span class="op" id="3786245">.</span><span class="ident" id="3786246">masterSecret</span><span class="op" id="3786258">,</span>&nbsp;<span class="ident" id="3786260">hs</span><span class="op" id="3786262">.</span><span class="ident" id="3786263">hello</span><span class="op" id="3786268">.</span><span class="ident" id="3786269">random</span><span class="op" id="3786275">,</span>&nbsp;<span class="ident" id="3786277">hs</span><span class="op" id="3786279">.</span><span class="ident" id="3786280">serverHello</span><span class="op" id="3786291">.</span><span class="ident" id="3786292">random</span><span class="op" id="3786298">,</span>&nbsp;<span class="ident" id="3786300">hs</span><span class="op" id="3786302">.</span><span class="ident" id="3786303">suite</span><span class="op" id="3786308">.</span><span class="ident" id="3786309">macLen</span><span class="op" id="3786315">,</span>&nbsp;<span class="ident" id="3786317">hs</span><span class="op" id="3786319">.</span><span class="ident" id="3786320">suite</span><span class="op" id="3786325">.</span><span class="ident" id="3786326">keyLen</span><span class="op" id="3786332">,</span>&nbsp;<span class="ident" id="3786334">hs</span><span class="op" id="3786336">.</span><span class="ident" id="3786337">suite</span><span class="op" id="3786342">.</span><span class="ident" id="3786343">ivLen</span><span class="op" id="3786348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3786351">var</span>&nbsp;<span class="ident" id="3786355">clientCipher</span><span class="op" id="3786367">,</span>&nbsp;<span class="ident" id="3786369">serverCipher</span>&nbsp;<span class="keyword" id="3786382">interface</span><span class="op" id="3786391">{</span><span class="op" id="3786392">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3786395">var</span>&nbsp;<span class="ident" id="3786399">clientHash</span><span class="op" id="3786409">,</span>&nbsp;<span class="ident" id="3786411">serverHash</span>&nbsp;<span class="ident" id="3786422">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3786435">if</span>&nbsp;<span class="ident" id="3786438">hs</span><span class="op" id="3786440">.</span><span class="ident" id="3786441">suite</span><span class="op" id="3786446">.</span><span class="ident" id="3786447">cipher</span>&nbsp;<span class="op" id="3786454">!=</span>&nbsp;<span class="builtintype" id="3786457">nil</span>&nbsp;<span class="op" id="3786461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3786465">clientCipher</span>&nbsp;<span class="op" id="3786478">=</span>&nbsp;<span class="ident" id="3786480">hs</span><span class="op" id="3786482">.</span><span class="ident" id="3786483">suite</span><span class="op" id="3786488">.</span><span class="ident" id="3786489">cipher</span><span class="op" id="3786495">(</span><span class="ident" id="3786496">clientKey</span><span class="op" id="3786505">,</span>&nbsp;<span class="ident" id="3786507">clientIV</span><span class="op" id="3786515">,</span>&nbsp;<span class="builtintype" id="3786517">false</span>&nbsp;<span class="comment" id="3786523">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3786544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3786548">clientHash</span>&nbsp;<span class="op" id="3786559">=</span>&nbsp;<span class="ident" id="3786561">hs</span><span class="op" id="3786563">.</span><span class="ident" id="3786564">suite</span><span class="op" id="3786569">.</span><span class="ident" id="3786570">mac</span><span class="op" id="3786573">(</span><span class="ident" id="3786574">c</span><span class="op" id="3786575">.</span><span class="ident" id="3786576">vers</span><span class="op" id="3786580">,</span>&nbsp;<span class="ident" id="3786582">clientMAC</span><span class="op" id="3786591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3786595">serverCipher</span>&nbsp;<span class="op" id="3786608">=</span>&nbsp;<span class="ident" id="3786610">hs</span><span class="op" id="3786612">.</span><span class="ident" id="3786613">suite</span><span class="op" id="3786618">.</span><span class="ident" id="3786619">cipher</span><span class="op" id="3786625">(</span><span class="ident" id="3786626">serverKey</span><span class="op" id="3786635">,</span>&nbsp;<span class="ident" id="3786637">serverIV</span><span class="op" id="3786645">,</span>&nbsp;<span class="builtintype" id="3786647">true</span>&nbsp;<span class="comment" id="3786652">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3786669">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3786673">serverHash</span>&nbsp;<span class="op" id="3786684">=</span>&nbsp;<span class="ident" id="3786686">hs</span><span class="op" id="3786688">.</span><span class="ident" id="3786689">suite</span><span class="op" id="3786694">.</span><span class="ident" id="3786695">mac</span><span class="op" id="3786698">(</span><span class="ident" id="3786699">c</span><span class="op" id="3786700">.</span><span class="ident" id="3786701">vers</span><span class="op" id="3786705">,</span>&nbsp;<span class="ident" id="3786707">serverMAC</span><span class="op" id="3786716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3786719">}</span>&nbsp;<span class="keyword" id="3786721">else</span>&nbsp;<span class="op" id="3786726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3786730">clientCipher</span>&nbsp;<span class="op" id="3786743">=</span>&nbsp;<span class="ident" id="3786745">hs</span><span class="op" id="3786747">.</span><span class="ident" id="3786748">suite</span><span class="op" id="3786753">.</span><span class="ident" id="3786754">aead</span><span class="op" id="3786758">(</span><span class="ident" id="3786759">clientKey</span><span class="op" id="3786768">,</span>&nbsp;<span class="ident" id="3786770">clientIV</span><span class="op" id="3786778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3786782">serverCipher</span>&nbsp;<span class="op" id="3786795">=</span>&nbsp;<span class="ident" id="3786797">hs</span><span class="op" id="3786799">.</span><span class="ident" id="3786800">suite</span><span class="op" id="3786805">.</span><span class="ident" id="3786806">aead</span><span class="op" id="3786810">(</span><span class="ident" id="3786811">serverKey</span><span class="op" id="3786820">,</span>&nbsp;<span class="ident" id="3786822">serverIV</span><span class="op" id="3786830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3786833">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3786837">c</span><span class="op" id="3786838">.</span><span class="ident" id="3786839">in</span><span class="op" id="3786841">.</span><span class="ident" id="3786842">prepareCipherSpec</span><span class="op" id="3786859">(</span><span class="ident" id="3786860">c</span><span class="op" id="3786861">.</span><span class="ident" id="3786862">vers</span><span class="op" id="3786866">,</span>&nbsp;<span class="ident" id="3786868">serverCipher</span><span class="op" id="3786880">,</span>&nbsp;<span class="ident" id="3786882">serverHash</span><span class="op" id="3786892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3786895">c</span><span class="op" id="3786896">.</span><span class="ident" id="3786897">out</span><span class="op" id="3786900">.</span><span class="ident" id="3786901">prepareCipherSpec</span><span class="op" id="3786918">(</span><span class="ident" id="3786919">c</span><span class="op" id="3786920">.</span><span class="ident" id="3786921">vers</span><span class="op" id="3786925">,</span>&nbsp;<span class="ident" id="3786927">clientCipher</span><span class="op" id="3786939">,</span>&nbsp;<span class="ident" id="3786941">clientHash</span><span class="op" id="3786951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3786954">return</span>&nbsp;<span class="builtintype" id="3786961">nil</span><br>
<span class="lineno"></span><span class="op" id="3786965">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="3786968">func</span>&nbsp;<span class="op" id="3786973">(</span><span class="ident" id="3786974">hs</span>&nbsp;<span class="op" id="3786977">*</span><span class="ident" id="3786978">clientHandshakeState</span><span class="op" id="3786998">)</span>&nbsp;<span class="ident" id="3787000">serverResumedSession</span><span class="op" id="3787020">(</span><span class="op" id="3787021">)</span>&nbsp;<span class="builtintype" id="3787023">bool</span>&nbsp;<span class="op" id="3787028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3787031">//&nbsp;If&nbsp;the&nbsp;server&nbsp;responded&nbsp;with&nbsp;the&nbsp;same&nbsp;sessionId&nbsp;then&nbsp;it&nbsp;means&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3787101">//&nbsp;sessionTicket&nbsp;is&nbsp;being&nbsp;used&nbsp;to&nbsp;resume&nbsp;a&nbsp;TLS&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3787158">return</span>&nbsp;<span class="ident" id="3787165">hs</span><span class="op" id="3787167">.</span><span class="ident" id="3787168">session</span>&nbsp;<span class="op" id="3787176">!=</span>&nbsp;<span class="builtintype" id="3787179">nil</span>&nbsp;<span class="op" id="3787183">&amp;&amp;</span>&nbsp;<span class="ident" id="3787186">hs</span><span class="op" id="3787188">.</span><span class="ident" id="3787189">hello</span><span class="op" id="3787194">.</span><span class="ident" id="3787195">sessionId</span>&nbsp;<span class="op" id="3787205">!=</span>&nbsp;<span class="builtintype" id="3787208">nil</span>&nbsp;<span class="op" id="3787212">&amp;&amp;</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3787217">bytes</span><span class="op" id="3787222">.</span><span class="ident" id="3787223">Equal</span><span class="op" id="3787228">(</span><span class="ident" id="3787229">hs</span><span class="op" id="3787231">.</span><span class="ident" id="3787232">serverHello</span><span class="op" id="3787243">.</span><span class="ident" id="3787244">sessionId</span><span class="op" id="3787253">,</span>&nbsp;<span class="ident" id="3787255">hs</span><span class="op" id="3787257">.</span><span class="ident" id="3787258">hello</span><span class="op" id="3787263">.</span><span class="ident" id="3787264">sessionId</span><span class="op" id="3787273">)</span><br>
<span class="lineno"></span><span class="op" id="3787275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3787278">func</span>&nbsp;<span class="op" id="3787283">(</span><span class="ident" id="3787284">hs</span>&nbsp;<span class="op" id="3787287">*</span><span class="ident" id="3787288">clientHandshakeState</span><span class="op" id="3787308">)</span>&nbsp;<span class="ident" id="3787310">processServerHello</span><span class="op" id="3787328">(</span><span class="op" id="3787329">)</span>&nbsp;<span class="op" id="3787331">(</span><span class="builtintype" id="3787332">bool</span><span class="op" id="3787336">,</span>&nbsp;<span class="builtintype" id="3787338">error</span><span class="op" id="3787343">)</span>&nbsp;<span class="op" id="3787345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3787348">c</span>&nbsp;<span class="op" id="3787350">:=</span>&nbsp;<span class="ident" id="3787353">hs</span><span class="op" id="3787355">.</span><span class="ident" id="3787356">c</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3787360">if</span>&nbsp;<span class="ident" id="3787363">hs</span><span class="op" id="3787365">.</span><span class="ident" id="3787366">serverHello</span><span class="op" id="3787377">.</span><span class="ident" id="3787378">compressionMethod</span>&nbsp;<span class="op" id="3787396">!=</span>&nbsp;<span class="ident" id="3787399">compressionNone</span>&nbsp;<span class="op" id="3787415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3787419">c</span><span class="op" id="3787420">.</span><span class="ident" id="3787421">sendAlert</span><span class="op" id="3787430">(</span><span class="ident" id="3787431">alertUnexpectedMessage</span><span class="op" id="3787453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3787457">return</span>&nbsp;<span class="builtintype" id="3787464">false</span><span class="op" id="3787469">,</span>&nbsp;<span class="ident" id="3787471">errors</span><span class="op" id="3787477">.</span><span class="ident" id="3787478">New</span><span class="op" id="3787481">(</span><span class="string" id="3787482">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;compression&nbsp;format&#34;</span><span class="op" id="3787535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3787538">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3787542">clientDidNPN</span>&nbsp;<span class="op" id="3787555">:=</span>&nbsp;<span class="ident" id="3787558">hs</span><span class="op" id="3787560">.</span><span class="ident" id="3787561">hello</span><span class="op" id="3787566">.</span><span class="ident" id="3787567">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3787581">clientDidALPN</span>&nbsp;<span class="op" id="3787595">:=</span>&nbsp;<span class="builtinfunc" id="3787598">len</span><span class="op" id="3787601">(</span><span class="ident" id="3787602">hs</span><span class="op" id="3787604">.</span><span class="ident" id="3787605">hello</span><span class="op" id="3787610">.</span><span class="ident" id="3787611">alpnProtocols</span><span class="op" id="3787624">)</span>&nbsp;<span class="op" id="3787626">&gt;</span>&nbsp;<span class="num" id="3787628">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3787631">serverHasNPN</span>&nbsp;<span class="op" id="3787644">:=</span>&nbsp;<span class="ident" id="3787647">hs</span><span class="op" id="3787649">.</span><span class="ident" id="3787650">serverHello</span><span class="op" id="3787661">.</span><span class="ident" id="3787662">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3787676">serverHasALPN</span>&nbsp;<span class="op" id="3787690">:=</span>&nbsp;<span class="builtinfunc" id="3787693">len</span><span class="op" id="3787696">(</span><span class="ident" id="3787697">hs</span><span class="op" id="3787699">.</span><span class="ident" id="3787700">serverHello</span><span class="op" id="3787711">.</span><span class="ident" id="3787712">alpnProtocol</span><span class="op" id="3787724">)</span>&nbsp;<span class="op" id="3787726">&gt;</span>&nbsp;<span class="num" id="3787728">0</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3787732">if</span>&nbsp;<span class="op" id="3787735">!</span><span class="ident" id="3787736">clientDidNPN</span>&nbsp;<span class="op" id="3787749">&amp;&amp;</span>&nbsp;<span class="ident" id="3787752">serverHasNPN</span>&nbsp;<span class="op" id="3787765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3787769">c</span><span class="op" id="3787770">.</span><span class="ident" id="3787771">sendAlert</span><span class="op" id="3787780">(</span><span class="ident" id="3787781">alertHandshakeFailure</span><span class="op" id="3787802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3787806">return</span>&nbsp;<span class="builtintype" id="3787813">false</span><span class="op" id="3787818">,</span>&nbsp;<span class="ident" id="3787820">errors</span><span class="op" id="3787826">.</span><span class="ident" id="3787827">New</span><span class="op" id="3787830">(</span><span class="string" id="3787831">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;NPN&nbsp;extension&#34;</span><span class="op" id="3787876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3787879">}</span><br>
<span class="lineno">510</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3787883">if</span>&nbsp;<span class="op" id="3787886">!</span><span class="ident" id="3787887">clientDidALPN</span>&nbsp;<span class="op" id="3787901">&amp;&amp;</span>&nbsp;<span class="ident" id="3787904">serverHasALPN</span>&nbsp;<span class="op" id="3787918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3787922">c</span><span class="op" id="3787923">.</span><span class="ident" id="3787924">sendAlert</span><span class="op" id="3787933">(</span><span class="ident" id="3787934">alertHandshakeFailure</span><span class="op" id="3787955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3787959">return</span>&nbsp;<span class="builtintype" id="3787966">false</span><span class="op" id="3787971">,</span>&nbsp;<span class="ident" id="3787973">errors</span><span class="op" id="3787979">.</span><span class="ident" id="3787980">New</span><span class="op" id="3787983">(</span><span class="string" id="3787984">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;ALPN&nbsp;extension&#34;</span><span class="op" id="3788030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3788033">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3788037">if</span>&nbsp;<span class="ident" id="3788040">serverHasNPN</span>&nbsp;<span class="op" id="3788053">&amp;&amp;</span>&nbsp;<span class="ident" id="3788056">serverHasALPN</span>&nbsp;<span class="op" id="3788070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3788074">c</span><span class="op" id="3788075">.</span><span class="ident" id="3788076">sendAlert</span><span class="op" id="3788085">(</span><span class="ident" id="3788086">alertHandshakeFailure</span><span class="op" id="3788107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3788111">return</span>&nbsp;<span class="builtintype" id="3788118">false</span><span class="op" id="3788123">,</span>&nbsp;<span class="ident" id="3788125">errors</span><span class="op" id="3788131">.</span><span class="ident" id="3788132">New</span><span class="op" id="3788135">(</span><span class="string" id="3788136">&#34;server&nbsp;advertised&nbsp;both&nbsp;NPN&nbsp;and&nbsp;ALPN&nbsp;extensions&#34;</span><span class="op" id="3788184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3788187">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3788191">if</span>&nbsp;<span class="ident" id="3788194">serverHasALPN</span>&nbsp;<span class="op" id="3788208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3788212">c</span><span class="op" id="3788213">.</span><span class="ident" id="3788214">clientProtocol</span>&nbsp;<span class="op" id="3788229">=</span>&nbsp;<span class="ident" id="3788231">hs</span><span class="op" id="3788233">.</span><span class="ident" id="3788234">serverHello</span><span class="op" id="3788245">.</span><span class="ident" id="3788246">alpnProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3788261">c</span><span class="op" id="3788262">.</span><span class="ident" id="3788263">clientProtocolFallback</span>&nbsp;<span class="op" id="3788286">=</span>&nbsp;<span class="builtintype" id="3788288">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3788295">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3788299">if</span>&nbsp;<span class="ident" id="3788302">hs</span><span class="op" id="3788304">.</span><span class="ident" id="3788305">serverResumedSession</span><span class="op" id="3788325">(</span><span class="op" id="3788326">)</span>&nbsp;<span class="op" id="3788328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3788332">//&nbsp;Restore&nbsp;masterSecret&nbsp;and&nbsp;peerCerts&nbsp;from&nbsp;previous&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3788392">hs</span><span class="op" id="3788394">.</span><span class="ident" id="3788395">masterSecret</span>&nbsp;<span class="op" id="3788408">=</span>&nbsp;<span class="ident" id="3788410">hs</span><span class="op" id="3788412">.</span><span class="ident" id="3788413">session</span><span class="op" id="3788420">.</span><span class="ident" id="3788421">masterSecret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3788436">c</span><span class="op" id="3788437">.</span><span class="ident" id="3788438">peerCertificates</span>&nbsp;<span class="op" id="3788455">=</span>&nbsp;<span class="ident" id="3788457">hs</span><span class="op" id="3788459">.</span><span class="ident" id="3788460">session</span><span class="op" id="3788467">.</span><span class="ident" id="3788468">serverCertificates</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3788489">return</span>&nbsp;<span class="builtintype" id="3788496">true</span><span class="op" id="3788500">,</span>&nbsp;<span class="builtintype" id="3788502">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3788507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3788510">return</span>&nbsp;<span class="builtintype" id="3788517">false</span><span class="op" id="3788522">,</span>&nbsp;<span class="builtintype" id="3788524">nil</span><br>
<span class="lineno"></span><span class="op" id="3788528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="3788531">func</span>&nbsp;<span class="op" id="3788536">(</span><span class="ident" id="3788537">hs</span>&nbsp;<span class="op" id="3788540">*</span><span class="ident" id="3788541">clientHandshakeState</span><span class="op" id="3788561">)</span>&nbsp;<span class="ident" id="3788563">readFinished</span><span class="op" id="3788575">(</span><span class="ident" id="3788576">out</span>&nbsp;<span class="op" id="3788580">[</span><span class="op" id="3788581">]</span><span class="builtintype" id="3788582">byte</span><span class="op" id="3788586">)</span>&nbsp;<span class="builtintype" id="3788588">error</span>&nbsp;<span class="op" id="3788594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3788597">c</span>&nbsp;<span class="op" id="3788599">:=</span>&nbsp;<span class="ident" id="3788602">hs</span><span class="op" id="3788604">.</span><span class="ident" id="3788605">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3788609">c</span><span class="op" id="3788610">.</span><span class="ident" id="3788611">readRecord</span><span class="op" id="3788621">(</span><span class="ident" id="3788622">recordTypeChangeCipherSpec</span><span class="op" id="3788648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3788651">if</span>&nbsp;<span class="ident" id="3788654">err</span>&nbsp;<span class="op" id="3788658">:=</span>&nbsp;<span class="ident" id="3788661">c</span><span class="op" id="3788662">.</span><span class="ident" id="3788663">in</span><span class="op" id="3788665">.</span><span class="builtintype" id="3788666">error</span><span class="op" id="3788671">(</span><span class="op" id="3788672">)</span><span class="op" id="3788673">;</span>&nbsp;<span class="ident" id="3788675">err</span>&nbsp;<span class="op" id="3788679">!=</span>&nbsp;<span class="builtintype" id="3788682">nil</span>&nbsp;<span class="op" id="3788686">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3788690">return</span>&nbsp;<span class="ident" id="3788697">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3788702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3788706">msg</span><span class="op" id="3788709">,</span>&nbsp;<span class="ident" id="3788711">err</span>&nbsp;<span class="op" id="3788715">:=</span>&nbsp;<span class="ident" id="3788718">c</span><span class="op" id="3788719">.</span><span class="ident" id="3788720">readHandshake</span><span class="op" id="3788733">(</span><span class="op" id="3788734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3788737">if</span>&nbsp;<span class="ident" id="3788740">err</span>&nbsp;<span class="op" id="3788744">!=</span>&nbsp;<span class="builtintype" id="3788747">nil</span>&nbsp;<span class="op" id="3788751">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3788755">return</span>&nbsp;<span class="ident" id="3788762">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3788767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3788770">serverFinished</span><span class="op" id="3788784">,</span>&nbsp;<span class="ident" id="3788786">ok</span>&nbsp;<span class="op" id="3788789">:=</span>&nbsp;<span class="ident" id="3788792">msg</span><span class="op" id="3788795">.</span><span class="op" id="3788796">(</span><span class="op" id="3788797">*</span><span class="ident" id="3788798">finishedMsg</span><span class="op" id="3788809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3788812">if</span>&nbsp;<span class="op" id="3788815">!</span><span class="ident" id="3788816">ok</span>&nbsp;<span class="op" id="3788819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3788823">c</span><span class="op" id="3788824">.</span><span class="ident" id="3788825">sendAlert</span><span class="op" id="3788834">(</span><span class="ident" id="3788835">alertUnexpectedMessage</span><span class="op" id="3788857">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3788861">return</span>&nbsp;<span class="ident" id="3788868">unexpectedMessageError</span><span class="op" id="3788890">(</span><span class="ident" id="3788891">serverFinished</span><span class="op" id="3788905">,</span>&nbsp;<span class="ident" id="3788907">msg</span><span class="op" id="3788910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3788913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3788917">verify</span>&nbsp;<span class="op" id="3788924">:=</span>&nbsp;<span class="ident" id="3788927">hs</span><span class="op" id="3788929">.</span><span class="ident" id="3788930">finishedHash</span><span class="op" id="3788942">.</span><span class="ident" id="3788943">serverSum</span><span class="op" id="3788952">(</span><span class="ident" id="3788953">hs</span><span class="op" id="3788955">.</span><span class="ident" id="3788956">masterSecret</span><span class="op" id="3788968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3788971">if</span>&nbsp;<span class="builtinfunc" id="3788974">len</span><span class="op" id="3788977">(</span><span class="ident" id="3788978">verify</span><span class="op" id="3788984">)</span>&nbsp;<span class="op" id="3788986">!=</span>&nbsp;<span class="builtinfunc" id="3788989">len</span><span class="op" id="3788992">(</span><span class="ident" id="3788993">serverFinished</span><span class="op" id="3789007">.</span><span class="ident" id="3789008">verifyData</span><span class="op" id="3789018">)</span>&nbsp;<span class="op" id="3789020">||</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789025">subtle</span><span class="op" id="3789031">.</span><span class="ident" id="3789032">ConstantTimeCompare</span><span class="op" id="3789051">(</span><span class="ident" id="3789052">verify</span><span class="op" id="3789058">,</span>&nbsp;<span class="ident" id="3789060">serverFinished</span><span class="op" id="3789074">.</span><span class="ident" id="3789075">verifyData</span><span class="op" id="3789085">)</span>&nbsp;<span class="op" id="3789087">!=</span>&nbsp;<span class="num" id="3789090">1</span>&nbsp;<span class="op" id="3789092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789096">c</span><span class="op" id="3789097">.</span><span class="ident" id="3789098">sendAlert</span><span class="op" id="3789107">(</span><span class="ident" id="3789108">alertHandshakeFailure</span><span class="op" id="3789129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3789133">return</span>&nbsp;<span class="ident" id="3789140">errors</span><span class="op" id="3789146">.</span><span class="ident" id="3789147">New</span><span class="op" id="3789150">(</span><span class="string" id="3789151">&#34;tls:&nbsp;server&#39;s&nbsp;Finished&nbsp;message&nbsp;was&nbsp;incorrect&#34;</span><span class="op" id="3789197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3789200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789203">hs</span><span class="op" id="3789205">.</span><span class="ident" id="3789206">finishedHash</span><span class="op" id="3789218">.</span><span class="ident" id="3789219">Write</span><span class="op" id="3789224">(</span><span class="ident" id="3789225">serverFinished</span><span class="op" id="3789239">.</span><span class="ident" id="3789240">marshal</span><span class="op" id="3789247">(</span><span class="op" id="3789248">)</span><span class="op" id="3789249">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3789252">copy</span><span class="op" id="3789256">(</span><span class="ident" id="3789257">out</span><span class="op" id="3789260">,</span>&nbsp;<span class="ident" id="3789262">verify</span><span class="op" id="3789268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3789271">return</span>&nbsp;<span class="builtintype" id="3789278">nil</span><br>
<span class="lineno"></span><span class="op" id="3789282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3789285">func</span>&nbsp;<span class="op" id="3789290">(</span><span class="ident" id="3789291">hs</span>&nbsp;<span class="op" id="3789294">*</span><span class="ident" id="3789295">clientHandshakeState</span><span class="op" id="3789315">)</span>&nbsp;<span class="ident" id="3789317">readSessionTicket</span><span class="op" id="3789334">(</span><span class="op" id="3789335">)</span>&nbsp;<span class="builtintype" id="3789337">error</span>&nbsp;<span class="op" id="3789343">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3789346">if</span>&nbsp;<span class="op" id="3789349">!</span><span class="ident" id="3789350">hs</span><span class="op" id="3789352">.</span><span class="ident" id="3789353">serverHello</span><span class="op" id="3789364">.</span><span class="ident" id="3789365">ticketSupported</span>&nbsp;<span class="op" id="3789381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3789385">return</span>&nbsp;<span class="builtintype" id="3789392">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3789397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789401">c</span>&nbsp;<span class="op" id="3789403">:=</span>&nbsp;<span class="ident" id="3789406">hs</span><span class="op" id="3789408">.</span><span class="ident" id="3789409">c</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789412">msg</span><span class="op" id="3789415">,</span>&nbsp;<span class="ident" id="3789417">err</span>&nbsp;<span class="op" id="3789421">:=</span>&nbsp;<span class="ident" id="3789424">c</span><span class="op" id="3789425">.</span><span class="ident" id="3789426">readHandshake</span><span class="op" id="3789439">(</span><span class="op" id="3789440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3789443">if</span>&nbsp;<span class="ident" id="3789446">err</span>&nbsp;<span class="op" id="3789450">!=</span>&nbsp;<span class="builtintype" id="3789453">nil</span>&nbsp;<span class="op" id="3789457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3789461">return</span>&nbsp;<span class="ident" id="3789468">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3789473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789476">sessionTicketMsg</span><span class="op" id="3789492">,</span>&nbsp;<span class="ident" id="3789494">ok</span>&nbsp;<span class="op" id="3789497">:=</span>&nbsp;<span class="ident" id="3789500">msg</span><span class="op" id="3789503">.</span><span class="op" id="3789504">(</span><span class="op" id="3789505">*</span><span class="ident" id="3789506">newSessionTicketMsg</span><span class="op" id="3789525">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3789528">if</span>&nbsp;<span class="op" id="3789531">!</span><span class="ident" id="3789532">ok</span>&nbsp;<span class="op" id="3789535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789539">c</span><span class="op" id="3789540">.</span><span class="ident" id="3789541">sendAlert</span><span class="op" id="3789550">(</span><span class="ident" id="3789551">alertUnexpectedMessage</span><span class="op" id="3789573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3789577">return</span>&nbsp;<span class="ident" id="3789584">unexpectedMessageError</span><span class="op" id="3789606">(</span><span class="ident" id="3789607">sessionTicketMsg</span><span class="op" id="3789623">,</span>&nbsp;<span class="ident" id="3789625">msg</span><span class="op" id="3789628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3789631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789634">hs</span><span class="op" id="3789636">.</span><span class="ident" id="3789637">finishedHash</span><span class="op" id="3789649">.</span><span class="ident" id="3789650">Write</span><span class="op" id="3789655">(</span><span class="ident" id="3789656">sessionTicketMsg</span><span class="op" id="3789672">.</span><span class="ident" id="3789673">marshal</span><span class="op" id="3789680">(</span><span class="op" id="3789681">)</span><span class="op" id="3789682">)</span><br>
<span class="lineno">580</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789686">hs</span><span class="op" id="3789688">.</span><span class="ident" id="3789689">session</span>&nbsp;<span class="op" id="3789697">=</span>&nbsp;<span class="op" id="3789699">&amp;</span><span class="ident" id="3789700">ClientSessionState</span><span class="op" id="3789718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789722">sessionTicket</span><span class="op" id="3789735">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789742">sessionTicketMsg</span><span class="op" id="3789758">.</span><span class="ident" id="3789759">ticket</span><span class="op" id="3789765">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789769">vers</span><span class="op" id="3789773">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789789">c</span><span class="op" id="3789790">.</span><span class="ident" id="3789791">vers</span><span class="op" id="3789795">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789799">cipherSuite</span><span class="op" id="3789810">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789819">hs</span><span class="op" id="3789821">.</span><span class="ident" id="3789822">suite</span><span class="op" id="3789827">.</span><span class="ident" id="3789828">id</span><span class="op" id="3789830">,</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789834">masterSecret</span><span class="op" id="3789846">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789854">hs</span><span class="op" id="3789856">.</span><span class="ident" id="3789857">masterSecret</span><span class="op" id="3789869">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789873">serverCertificates</span><span class="op" id="3789891">:</span>&nbsp;<span class="ident" id="3789893">c</span><span class="op" id="3789894">.</span><span class="ident" id="3789895">peerCertificates</span><span class="op" id="3789911">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3789914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3789918">return</span>&nbsp;<span class="builtintype" id="3789925">nil</span><br>
<span class="lineno">590</span><span class="op" id="3789929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3789932">func</span>&nbsp;<span class="op" id="3789937">(</span><span class="ident" id="3789938">hs</span>&nbsp;<span class="op" id="3789941">*</span><span class="ident" id="3789942">clientHandshakeState</span><span class="op" id="3789962">)</span>&nbsp;<span class="ident" id="3789964">sendFinished</span><span class="op" id="3789976">(</span><span class="ident" id="3789977">out</span>&nbsp;<span class="op" id="3789981">[</span><span class="op" id="3789982">]</span><span class="builtintype" id="3789983">byte</span><span class="op" id="3789987">)</span>&nbsp;<span class="builtintype" id="3789989">error</span>&nbsp;<span class="op" id="3789995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3789998">c</span>&nbsp;<span class="op" id="3790000">:=</span>&nbsp;<span class="ident" id="3790003">hs</span><span class="op" id="3790005">.</span><span class="ident" id="3790006">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3790010">c</span><span class="op" id="3790011">.</span><span class="ident" id="3790012">writeRecord</span><span class="op" id="3790023">(</span><span class="ident" id="3790024">recordTypeChangeCipherSpec</span><span class="op" id="3790050">,</span>&nbsp;<span class="op" id="3790052">[</span><span class="op" id="3790053">]</span><span class="builtintype" id="3790054">byte</span><span class="op" id="3790058">{</span><span class="num" id="3790059">1</span><span class="op" id="3790060">}</span><span class="op" id="3790061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3790064">if</span>&nbsp;<span class="ident" id="3790067">hs</span><span class="op" id="3790069">.</span><span class="ident" id="3790070">serverHello</span><span class="op" id="3790081">.</span><span class="ident" id="3790082">nextProtoNeg</span>&nbsp;<span class="op" id="3790095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3790099">nextProto</span>&nbsp;<span class="op" id="3790109">:=</span>&nbsp;<span class="builtinfunc" id="3790112">new</span><span class="op" id="3790115">(</span><span class="ident" id="3790116">nextProtoMsg</span><span class="op" id="3790128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3790132">proto</span><span class="op" id="3790137">,</span>&nbsp;<span class="ident" id="3790139">fallback</span>&nbsp;<span class="op" id="3790148">:=</span>&nbsp;<span class="ident" id="3790151">mutualProtocol</span><span class="op" id="3790165">(</span><span class="ident" id="3790166">c</span><span class="op" id="3790167">.</span><span class="ident" id="3790168">config</span><span class="op" id="3790174">.</span><span class="ident" id="3790175">NextProtos</span><span class="op" id="3790185">,</span>&nbsp;<span class="ident" id="3790187">hs</span><span class="op" id="3790189">.</span><span class="ident" id="3790190">serverHello</span><span class="op" id="3790201">.</span><span class="ident" id="3790202">nextProtos</span><span class="op" id="3790212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3790216">nextProto</span><span class="op" id="3790225">.</span><span class="ident" id="3790226">proto</span>&nbsp;<span class="op" id="3790232">=</span>&nbsp;<span class="ident" id="3790234">proto</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3790242">c</span><span class="op" id="3790243">.</span><span class="ident" id="3790244">clientProtocol</span>&nbsp;<span class="op" id="3790259">=</span>&nbsp;<span class="ident" id="3790261">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3790269">c</span><span class="op" id="3790270">.</span><span class="ident" id="3790271">clientProtocolFallback</span>&nbsp;<span class="op" id="3790294">=</span>&nbsp;<span class="ident" id="3790296">fallback</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3790308">hs</span><span class="op" id="3790310">.</span><span class="ident" id="3790311">finishedHash</span><span class="op" id="3790323">.</span><span class="ident" id="3790324">Write</span><span class="op" id="3790329">(</span><span class="ident" id="3790330">nextProto</span><span class="op" id="3790339">.</span><span class="ident" id="3790340">marshal</span><span class="op" id="3790347">(</span><span class="op" id="3790348">)</span><span class="op" id="3790349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3790353">c</span><span class="op" id="3790354">.</span><span class="ident" id="3790355">writeRecord</span><span class="op" id="3790366">(</span><span class="ident" id="3790367">recordTypeHandshake</span><span class="op" id="3790386">,</span>&nbsp;<span class="ident" id="3790388">nextProto</span><span class="op" id="3790397">.</span><span class="ident" id="3790398">marshal</span><span class="op" id="3790405">(</span><span class="op" id="3790406">)</span><span class="op" id="3790407">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3790410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3790414">finished</span>&nbsp;<span class="op" id="3790423">:=</span>&nbsp;<span class="builtinfunc" id="3790426">new</span><span class="op" id="3790429">(</span><span class="ident" id="3790430">finishedMsg</span><span class="op" id="3790441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3790444">finished</span><span class="op" id="3790452">.</span><span class="ident" id="3790453">verifyData</span>&nbsp;<span class="op" id="3790464">=</span>&nbsp;<span class="ident" id="3790466">hs</span><span class="op" id="3790468">.</span><span class="ident" id="3790469">finishedHash</span><span class="op" id="3790481">.</span><span class="ident" id="3790482">clientSum</span><span class="op" id="3790491">(</span><span class="ident" id="3790492">hs</span><span class="op" id="3790494">.</span><span class="ident" id="3790495">masterSecret</span><span class="op" id="3790507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3790510">hs</span><span class="op" id="3790512">.</span><span class="ident" id="3790513">finishedHash</span><span class="op" id="3790525">.</span><span class="ident" id="3790526">Write</span><span class="op" id="3790531">(</span><span class="ident" id="3790532">finished</span><span class="op" id="3790540">.</span><span class="ident" id="3790541">marshal</span><span class="op" id="3790548">(</span><span class="op" id="3790549">)</span><span class="op" id="3790550">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3790553">c</span><span class="op" id="3790554">.</span><span class="ident" id="3790555">writeRecord</span><span class="op" id="3790566">(</span><span class="ident" id="3790567">recordTypeHandshake</span><span class="op" id="3790586">,</span>&nbsp;<span class="ident" id="3790588">finished</span><span class="op" id="3790596">.</span><span class="ident" id="3790597">marshal</span><span class="op" id="3790604">(</span><span class="op" id="3790605">)</span><span class="op" id="3790606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3790609">copy</span><span class="op" id="3790613">(</span><span class="ident" id="3790614">out</span><span class="op" id="3790617">,</span>&nbsp;<span class="ident" id="3790619">finished</span><span class="op" id="3790627">.</span><span class="ident" id="3790628">verifyData</span><span class="op" id="3790638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3790641">return</span>&nbsp;<span class="builtintype" id="3790648">nil</span><br>
<span class="lineno"></span><span class="op" id="3790652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="comment" id="3790655">//&nbsp;clientSessionCacheKey&nbsp;returns&nbsp;a&nbsp;key&nbsp;used&nbsp;to&nbsp;cache&nbsp;sessionTickets&nbsp;that&nbsp;could</span><br>
<span class="lineno"></span><span class="comment" id="3790734">//&nbsp;be&nbsp;used&nbsp;to&nbsp;resume&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;sessions&nbsp;with&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="3790805">func</span>&nbsp;<span class="ident" id="3790810">clientSessionCacheKey</span><span class="op" id="3790831">(</span><span class="ident" id="3790832">serverAddr</span>&nbsp;<span class="ident" id="3790843">net</span><span class="op" id="3790846">.</span><span class="ident" id="3790847">Addr</span><span class="op" id="3790851">,</span>&nbsp;<span class="ident" id="3790853">config</span>&nbsp;<span class="op" id="3790860">*</span><span class="ident" id="3790861">Config</span><span class="op" id="3790867">)</span>&nbsp;<span class="builtintype" id="3790869">string</span>&nbsp;<span class="op" id="3790876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3790879">if</span>&nbsp;<span class="builtinfunc" id="3790882">len</span><span class="op" id="3790885">(</span><span class="ident" id="3790886">config</span><span class="op" id="3790892">.</span><span class="ident" id="3790893">ServerName</span><span class="op" id="3790903">)</span>&nbsp;<span class="op" id="3790905">&gt;</span>&nbsp;<span class="num" id="3790907">0</span>&nbsp;<span class="op" id="3790909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3790913">return</span>&nbsp;<span class="ident" id="3790920">config</span><span class="op" id="3790926">.</span><span class="ident" id="3790927">ServerName</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3790939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3790942">return</span>&nbsp;<span class="ident" id="3790949">serverAddr</span><span class="op" id="3790959">.</span><span class="ident" id="3790960">String</span><span class="op" id="3790966">(</span><span class="op" id="3790967">)</span><br>
<span class="lineno"></span><span class="op" id="3790969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3790972">//&nbsp;mutualProtocol&nbsp;finds&nbsp;the&nbsp;mutual&nbsp;Next&nbsp;Protocol&nbsp;Negotiation&nbsp;or&nbsp;ALPN&nbsp;protocol</span><br>
<span class="lineno">625</span><span class="comment" id="3791050">//&nbsp;given&nbsp;list&nbsp;of&nbsp;possible&nbsp;protocols&nbsp;and&nbsp;a&nbsp;list&nbsp;of&nbsp;the&nbsp;preference&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="3791126">//&nbsp;first&nbsp;list&nbsp;must&nbsp;not&nbsp;be&nbsp;empty.&nbsp;It&nbsp;returns&nbsp;the&nbsp;resulting&nbsp;protocol&nbsp;and&nbsp;flag</span><br>
<span class="lineno"></span><span class="comment" id="3791202">//&nbsp;indicating&nbsp;if&nbsp;the&nbsp;fallback&nbsp;case&nbsp;was&nbsp;reached.</span><br>
<span class="lineno"></span><span class="keyword" id="3791250">func</span>&nbsp;<span class="ident" id="3791255">mutualProtocol</span><span class="op" id="3791269">(</span><span class="ident" id="3791270">protos</span><span class="op" id="3791276">,</span>&nbsp;<span class="ident" id="3791278">preferenceProtos</span>&nbsp;<span class="op" id="3791295">[</span><span class="op" id="3791296">]</span><span class="builtintype" id="3791297">string</span><span class="op" id="3791303">)</span>&nbsp;<span class="op" id="3791305">(</span><span class="builtintype" id="3791306">string</span><span class="op" id="3791312">,</span>&nbsp;<span class="builtintype" id="3791314">bool</span><span class="op" id="3791318">)</span>&nbsp;<span class="op" id="3791320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3791323">for</span>&nbsp;<span class="ident" id="3791327">_</span><span class="op" id="3791328">,</span>&nbsp;<span class="ident" id="3791330">s</span>&nbsp;<span class="op" id="3791332">:=</span>&nbsp;<span class="keyword" id="3791335">range</span>&nbsp;<span class="ident" id="3791341">preferenceProtos</span>&nbsp;<span class="op" id="3791358">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3791362">for</span>&nbsp;<span class="ident" id="3791366">_</span><span class="op" id="3791367">,</span>&nbsp;<span class="ident" id="3791369">c</span>&nbsp;<span class="op" id="3791371">:=</span>&nbsp;<span class="keyword" id="3791374">range</span>&nbsp;<span class="ident" id="3791380">protos</span>&nbsp;<span class="op" id="3791387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3791392">if</span>&nbsp;<span class="ident" id="3791395">s</span>&nbsp;<span class="op" id="3791397">==</span>&nbsp;<span class="ident" id="3791400">c</span>&nbsp;<span class="op" id="3791402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3791408">return</span>&nbsp;<span class="ident" id="3791415">s</span><span class="op" id="3791416">,</span>&nbsp;<span class="builtintype" id="3791418">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3791427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3791431">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3791434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3791438">return</span>&nbsp;<span class="ident" id="3791445">protos</span><span class="op" id="3791451">[</span><span class="num" id="3791452">0</span><span class="op" id="3791453">]</span><span class="op" id="3791454">,</span>&nbsp;<span class="builtintype" id="3791456">true</span><br>
<span class="lineno"></span><span class="op" id="3791461">}</span>
</div>
</body>
</html>
