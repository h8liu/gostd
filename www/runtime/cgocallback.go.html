<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1477738">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1477794">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1477848">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1477899">package</span>&nbsp;<span class="ident" id="1477907">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1477916">import</span>&nbsp;<span class="string" id="1477923">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1477933">//&nbsp;These&nbsp;functions&nbsp;are&nbsp;called&nbsp;from&nbsp;C&nbsp;code&nbsp;via&nbsp;cgo/callbacks.c.</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1477997">//&nbsp;Allocate&nbsp;memory.&nbsp;&nbsp;This&nbsp;allocates&nbsp;the&nbsp;requested&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1478066">//&nbsp;memory&nbsp;controlled&nbsp;by&nbsp;the&nbsp;Go&nbsp;runtime.&nbsp;&nbsp;The&nbsp;allocated&nbsp;memory&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1478136">//&nbsp;zeroed.&nbsp;&nbsp;You&nbsp;are&nbsp;responsible&nbsp;for&nbsp;ensuring&nbsp;that&nbsp;the&nbsp;Go&nbsp;garbage</span><br>
<span class="lineno"></span><span class="comment" id="1478201">//&nbsp;collector&nbsp;can&nbsp;see&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;allocated&nbsp;memory&nbsp;for&nbsp;as&nbsp;long&nbsp;as</span><br>
<span class="lineno">15</span><span class="comment" id="1478271">//&nbsp;it&nbsp;is&nbsp;valid,&nbsp;e.g.,&nbsp;by&nbsp;storing&nbsp;a&nbsp;pointer&nbsp;in&nbsp;a&nbsp;local&nbsp;variable&nbsp;in&nbsp;your</span><br>
<span class="lineno"></span><span class="comment" id="1478342">//&nbsp;C&nbsp;function,&nbsp;or&nbsp;in&nbsp;memory&nbsp;allocated&nbsp;by&nbsp;the&nbsp;Go&nbsp;runtime.&nbsp;&nbsp;If&nbsp;the&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="1478412">//&nbsp;pointers&nbsp;are&nbsp;in&nbsp;a&nbsp;C&nbsp;global&nbsp;variable&nbsp;or&nbsp;in&nbsp;memory&nbsp;allocated&nbsp;via</span><br>
<span class="lineno"></span><span class="comment" id="1478478">//&nbsp;malloc,&nbsp;then&nbsp;the&nbsp;Go&nbsp;garbage&nbsp;collector&nbsp;may&nbsp;collect&nbsp;the&nbsp;memory.</span><br>
<span class="lineno"></span><span class="comment" id="1478543">//</span><br>
<span class="lineno">20</span><span class="comment" id="1478546">//&nbsp;TODO(rsc,iant):&nbsp;This&nbsp;memory&nbsp;is&nbsp;untyped.</span><br>
<span class="lineno"></span><span class="comment" id="1478589">//&nbsp;Either&nbsp;we&nbsp;need&nbsp;to&nbsp;add&nbsp;types&nbsp;or&nbsp;we&nbsp;need&nbsp;to&nbsp;stop&nbsp;using&nbsp;it.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1478650">func</span>&nbsp;<span class="ident" id="1478655">_cgo_allocate_internal</span><span class="op" id="1478677">(</span><span class="builtinfunc" id="1478678">len</span>&nbsp;<span class="builtintype" id="1478682">uintptr</span><span class="op" id="1478689">)</span>&nbsp;<span class="ident" id="1478691">unsafe</span><span class="op" id="1478697">.</span><span class="ident" id="1478698">Pointer</span>&nbsp;<span class="op" id="1478706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1478709">if</span>&nbsp;<span class="builtinfunc" id="1478712">len</span>&nbsp;<span class="op" id="1478716">==</span>&nbsp;<span class="num" id="1478719">0</span>&nbsp;<span class="op" id="1478721">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1478725">len</span>&nbsp;<span class="op" id="1478729">=</span>&nbsp;<span class="num" id="1478731">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1478734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478737">ret</span>&nbsp;<span class="op" id="1478741">:=</span>&nbsp;<span class="ident" id="1478744">unsafe</span><span class="op" id="1478750">.</span><span class="ident" id="1478751">Pointer</span><span class="op" id="1478758">(</span><span class="op" id="1478759">&amp;</span><span class="builtinfunc" id="1478760">make</span><span class="op" id="1478764">(</span><span class="op" id="1478765">[</span><span class="op" id="1478766">]</span><span class="ident" id="1478767">unsafe</span><span class="op" id="1478773">.</span><span class="ident" id="1478774">Pointer</span><span class="op" id="1478781">,</span>&nbsp;<span class="op" id="1478783">(</span><span class="builtinfunc" id="1478784">len</span><span class="op" id="1478787">+</span><span class="ident" id="1478788">ptrSize</span><span class="op" id="1478795">-</span><span class="num" id="1478796">1</span><span class="op" id="1478797">)</span><span class="op" id="1478798">/</span><span class="ident" id="1478799">ptrSize</span><span class="op" id="1478806">)</span><span class="op" id="1478807">[</span><span class="num" id="1478808">0</span><span class="op" id="1478809">]</span><span class="op" id="1478810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478813">c</span>&nbsp;<span class="op" id="1478815">:=</span>&nbsp;<span class="builtinfunc" id="1478818">new</span><span class="op" id="1478821">(</span><span class="ident" id="1478822">cgomal</span><span class="op" id="1478828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478831">c</span><span class="op" id="1478832">.</span><span class="ident" id="1478833">alloc</span>&nbsp;<span class="op" id="1478839">=</span>&nbsp;<span class="ident" id="1478841">ret</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478846">gp</span>&nbsp;<span class="op" id="1478849">:=</span>&nbsp;<span class="ident" id="1478852">getg</span><span class="op" id="1478856">(</span><span class="op" id="1478857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478860">c</span><span class="op" id="1478861">.</span><span class="ident" id="1478862">next</span>&nbsp;<span class="op" id="1478867">=</span>&nbsp;<span class="ident" id="1478869">gp</span><span class="op" id="1478871">.</span><span class="ident" id="1478872">m</span><span class="op" id="1478873">.</span><span class="ident" id="1478874">cgomal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478882">gp</span><span class="op" id="1478884">.</span><span class="ident" id="1478885">m</span><span class="op" id="1478886">.</span><span class="ident" id="1478887">cgomal</span>&nbsp;<span class="op" id="1478894">=</span>&nbsp;<span class="ident" id="1478896">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1478899">return</span>&nbsp;<span class="ident" id="1478906">ret</span><br>
<span class="lineno"></span><span class="op" id="1478910">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="1478913">//&nbsp;Panic.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1478924">func</span>&nbsp;<span class="ident" id="1478929">_cgo_panic_internal</span><span class="op" id="1478948">(</span><span class="ident" id="1478949">p</span>&nbsp;<span class="op" id="1478951">*</span><span class="builtintype" id="1478952">byte</span><span class="op" id="1478956">)</span>&nbsp;<span class="op" id="1478958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1478961">panic</span><span class="op" id="1478966">(</span><span class="ident" id="1478967">gostringnocopy</span><span class="op" id="1478981">(</span><span class="ident" id="1478982">p</span><span class="op" id="1478983">)</span><span class="op" id="1478984">)</span><br>
<span class="lineno">40</span><span class="op" id="1478986">}</span>
</div>
</body>
</html>
