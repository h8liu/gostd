<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>expvar</h2>
<ul>
<li><a href="/gostd/expvar/expvar.go.html" class="current">expvar.go</a></li>
<li><a href="/gostd/expvar/expvar_test.go.html">expvar_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1335571">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1335626">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1335680">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1335731">//&nbsp;Package&nbsp;expvar&nbsp;provides&nbsp;a&nbsp;standardized&nbsp;interface&nbsp;to&nbsp;public&nbsp;variables,&nbsp;such</span><br>
<span class="lineno"></span><span class="comment" id="1335809">//&nbsp;as&nbsp;operation&nbsp;counters&nbsp;in&nbsp;servers.&nbsp;It&nbsp;exposes&nbsp;these&nbsp;variables&nbsp;via&nbsp;HTTP&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="1335885">//&nbsp;/debug/vars&nbsp;in&nbsp;JSON&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="1335916">//</span><br>
<span class="lineno"></span><span class="comment" id="1335919">//&nbsp;Operations&nbsp;to&nbsp;set&nbsp;or&nbsp;modify&nbsp;these&nbsp;public&nbsp;variables&nbsp;are&nbsp;atomic.</span><br>
<span class="lineno">10</span><span class="comment" id="1335985">//</span><br>
<span class="lineno"></span><span class="comment" id="1335988">//&nbsp;In&nbsp;addition&nbsp;to&nbsp;adding&nbsp;the&nbsp;HTTP&nbsp;handler,&nbsp;this&nbsp;package&nbsp;registers&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1336058">//&nbsp;following&nbsp;variables:</span><br>
<span class="lineno"></span><span class="comment" id="1336082">//</span><br>
<span class="lineno"></span><span class="comment" id="1336085">//&nbsp;&nbsp;&nbsp;&nbsp;cmdline&nbsp;&nbsp;&nbsp;os.Args</span><br>
<span class="lineno">15</span><span class="comment" id="1336106">//&nbsp;&nbsp;&nbsp;&nbsp;memstats&nbsp;&nbsp;runtime.Memstats</span><br>
<span class="lineno"></span><span class="comment" id="1336136">//</span><br>
<span class="lineno"></span><span class="comment" id="1336139">//&nbsp;The&nbsp;package&nbsp;is&nbsp;sometimes&nbsp;only&nbsp;imported&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1336204">//&nbsp;registering&nbsp;its&nbsp;HTTP&nbsp;handler&nbsp;and&nbsp;the&nbsp;above&nbsp;variables.&nbsp;&nbsp;To&nbsp;use&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="1336272">//&nbsp;this&nbsp;way,&nbsp;link&nbsp;this&nbsp;package&nbsp;into&nbsp;your&nbsp;program:</span><br>
<span class="lineno">20</span><span class="comment" id="1336322">//&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;_&nbsp;&#34;expvar&#34;</span><br>
<span class="lineno"></span><span class="comment" id="1336343">//</span><br>
<span class="lineno"></span><span class="keyword" id="1336346">package</span>&nbsp;<span class="ident" id="1336354">expvar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1336362">import</span>&nbsp;<span class="op" id="1336369">(</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1336372">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1336381">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1336398">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1336405">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1336412">&#34;net/http&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1336424">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1336430">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1336441">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1336449">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1336460">&#34;sync&#34;</span><br>
<span class="lineno">35</span><span class="op" id="1336467">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1336470">//&nbsp;Var&nbsp;is&nbsp;an&nbsp;abstract&nbsp;type&nbsp;for&nbsp;all&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="1336525">type</span>&nbsp;<span class="ident" id="1336530">Var</span>&nbsp;<span class="keyword" id="1336534">interface</span>&nbsp;<span class="op" id="1336544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1336547">String</span><span class="op" id="1336553">(</span><span class="op" id="1336554">)</span>&nbsp;<span class="builtintype" id="1336556">string</span><br>
<span class="lineno">40</span><span class="op" id="1336563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1336566">//&nbsp;Int&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;integer&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="1336636">type</span>&nbsp;<span class="ident" id="1336641">Int</span>&nbsp;<span class="keyword" id="1336645">struct</span>&nbsp;<span class="op" id="1336652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1336655">mu</span>&nbsp;<span class="ident" id="1336658">sync</span><span class="op" id="1336662">.</span><span class="ident" id="1336663">RWMutex</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1336672">i</span>&nbsp;&nbsp;<span class="ident" id="1336675">int64</span><br>
<span class="lineno"></span><span class="op" id="1336681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1336684">func</span>&nbsp;<span class="op" id="1336689">(</span><span class="ident" id="1336690">v</span>&nbsp;<span class="op" id="1336692">*</span><span class="ident" id="1336693">Int</span><span class="op" id="1336696">)</span>&nbsp;<span class="ident" id="1336698">String</span><span class="op" id="1336704">(</span><span class="op" id="1336705">)</span>&nbsp;<span class="builtintype" id="1336707">string</span>&nbsp;<span class="op" id="1336714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1336717">v</span><span class="op" id="1336718">.</span><span class="ident" id="1336719">mu</span><span class="op" id="1336721">.</span><span class="ident" id="1336722">RLock</span><span class="op" id="1336727">(</span><span class="op" id="1336728">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1336731">defer</span>&nbsp;<span class="ident" id="1336737">v</span><span class="op" id="1336738">.</span><span class="ident" id="1336739">mu</span><span class="op" id="1336741">.</span><span class="ident" id="1336742">RUnlock</span><span class="op" id="1336749">(</span><span class="op" id="1336750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1336753">return</span>&nbsp;<span class="ident" id="1336760">strconv</span><span class="op" id="1336767">.</span><span class="ident" id="1336768">FormatInt</span><span class="op" id="1336777">(</span><span class="ident" id="1336778">v</span><span class="op" id="1336779">.</span><span class="ident" id="1336780">i</span><span class="op" id="1336781">,</span>&nbsp;<span class="num" id="1336783">10</span><span class="op" id="1336785">)</span><br>
<span class="lineno"></span><span class="op" id="1336787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1336790">func</span>&nbsp;<span class="op" id="1336795">(</span><span class="ident" id="1336796">v</span>&nbsp;<span class="op" id="1336798">*</span><span class="ident" id="1336799">Int</span><span class="op" id="1336802">)</span>&nbsp;<span class="ident" id="1336804">Add</span><span class="op" id="1336807">(</span><span class="ident" id="1336808">delta</span>&nbsp;<span class="ident" id="1336814">int64</span><span class="op" id="1336819">)</span>&nbsp;<span class="op" id="1336821">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1336824">v</span><span class="op" id="1336825">.</span><span class="ident" id="1336826">mu</span><span class="op" id="1336828">.</span><span class="ident" id="1336829">Lock</span><span class="op" id="1336833">(</span><span class="op" id="1336834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1336837">defer</span>&nbsp;<span class="ident" id="1336843">v</span><span class="op" id="1336844">.</span><span class="ident" id="1336845">mu</span><span class="op" id="1336847">.</span><span class="ident" id="1336848">Unlock</span><span class="op" id="1336854">(</span><span class="op" id="1336855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1336858">v</span><span class="op" id="1336859">.</span><span class="ident" id="1336860">i</span>&nbsp;<span class="op" id="1336862">+=</span>&nbsp;<span class="ident" id="1336865">delta</span><br>
<span class="lineno"></span><span class="op" id="1336871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="1336874">func</span>&nbsp;<span class="op" id="1336879">(</span><span class="ident" id="1336880">v</span>&nbsp;<span class="op" id="1336882">*</span><span class="ident" id="1336883">Int</span><span class="op" id="1336886">)</span>&nbsp;<span class="ident" id="1336888">Set</span><span class="op" id="1336891">(</span><span class="ident" id="1336892">value</span>&nbsp;<span class="ident" id="1336898">int64</span><span class="op" id="1336903">)</span>&nbsp;<span class="op" id="1336905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1336908">v</span><span class="op" id="1336909">.</span><span class="ident" id="1336910">mu</span><span class="op" id="1336912">.</span><span class="ident" id="1336913">Lock</span><span class="op" id="1336917">(</span><span class="op" id="1336918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1336921">defer</span>&nbsp;<span class="ident" id="1336927">v</span><span class="op" id="1336928">.</span><span class="ident" id="1336929">mu</span><span class="op" id="1336931">.</span><span class="ident" id="1336932">Unlock</span><span class="op" id="1336938">(</span><span class="op" id="1336939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1336942">v</span><span class="op" id="1336943">.</span><span class="ident" id="1336944">i</span>&nbsp;<span class="op" id="1336946">=</span>&nbsp;<span class="ident" id="1336948">value</span><br>
<span class="lineno"></span><span class="op" id="1336954">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="1336957">//&nbsp;Float&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;float&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="1337027">type</span>&nbsp;<span class="ident" id="1337032">Float</span>&nbsp;<span class="keyword" id="1337038">struct</span>&nbsp;<span class="op" id="1337045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337048">mu</span>&nbsp;<span class="ident" id="1337051">sync</span><span class="op" id="1337055">.</span><span class="ident" id="1337056">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337065">f</span>&nbsp;&nbsp;<span class="builtintype" id="1337068">float64</span><br>
<span class="lineno">70</span><span class="op" id="1337076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1337079">func</span>&nbsp;<span class="op" id="1337084">(</span><span class="ident" id="1337085">v</span>&nbsp;<span class="op" id="1337087">*</span><span class="ident" id="1337088">Float</span><span class="op" id="1337093">)</span>&nbsp;<span class="ident" id="1337095">String</span><span class="op" id="1337101">(</span><span class="op" id="1337102">)</span>&nbsp;<span class="builtintype" id="1337104">string</span>&nbsp;<span class="op" id="1337111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337114">v</span><span class="op" id="1337115">.</span><span class="ident" id="1337116">mu</span><span class="op" id="1337118">.</span><span class="ident" id="1337119">RLock</span><span class="op" id="1337124">(</span><span class="op" id="1337125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1337128">defer</span>&nbsp;<span class="ident" id="1337134">v</span><span class="op" id="1337135">.</span><span class="ident" id="1337136">mu</span><span class="op" id="1337138">.</span><span class="ident" id="1337139">RUnlock</span><span class="op" id="1337146">(</span><span class="op" id="1337147">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1337150">return</span>&nbsp;<span class="ident" id="1337157">strconv</span><span class="op" id="1337164">.</span><span class="ident" id="1337165">FormatFloat</span><span class="op" id="1337176">(</span><span class="ident" id="1337177">v</span><span class="op" id="1337178">.</span><span class="ident" id="1337179">f</span><span class="op" id="1337180">,</span>&nbsp;<span class="string" id="1337182">&#39;g&#39;</span><span class="op" id="1337185">,</span>&nbsp;<span class="op" id="1337187">-</span><span class="num" id="1337188">1</span><span class="op" id="1337189">,</span>&nbsp;<span class="num" id="1337191">64</span><span class="op" id="1337193">)</span><br>
<span class="lineno"></span><span class="op" id="1337195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1337198">//&nbsp;Add&nbsp;adds&nbsp;delta&nbsp;to&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="1337222">func</span>&nbsp;<span class="op" id="1337227">(</span><span class="ident" id="1337228">v</span>&nbsp;<span class="op" id="1337230">*</span><span class="ident" id="1337231">Float</span><span class="op" id="1337236">)</span>&nbsp;<span class="ident" id="1337238">Add</span><span class="op" id="1337241">(</span><span class="ident" id="1337242">delta</span>&nbsp;<span class="builtintype" id="1337248">float64</span><span class="op" id="1337255">)</span>&nbsp;<span class="op" id="1337257">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337260">v</span><span class="op" id="1337261">.</span><span class="ident" id="1337262">mu</span><span class="op" id="1337264">.</span><span class="ident" id="1337265">Lock</span><span class="op" id="1337269">(</span><span class="op" id="1337270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1337273">defer</span>&nbsp;<span class="ident" id="1337279">v</span><span class="op" id="1337280">.</span><span class="ident" id="1337281">mu</span><span class="op" id="1337283">.</span><span class="ident" id="1337284">Unlock</span><span class="op" id="1337290">(</span><span class="op" id="1337291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337294">v</span><span class="op" id="1337295">.</span><span class="ident" id="1337296">f</span>&nbsp;<span class="op" id="1337298">+=</span>&nbsp;<span class="ident" id="1337301">delta</span><br>
<span class="lineno"></span><span class="op" id="1337307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="1337310">//&nbsp;Set&nbsp;sets&nbsp;v&nbsp;to&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="1337334">func</span>&nbsp;<span class="op" id="1337339">(</span><span class="ident" id="1337340">v</span>&nbsp;<span class="op" id="1337342">*</span><span class="ident" id="1337343">Float</span><span class="op" id="1337348">)</span>&nbsp;<span class="ident" id="1337350">Set</span><span class="op" id="1337353">(</span><span class="ident" id="1337354">value</span>&nbsp;<span class="builtintype" id="1337360">float64</span><span class="op" id="1337367">)</span>&nbsp;<span class="op" id="1337369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337372">v</span><span class="op" id="1337373">.</span><span class="ident" id="1337374">mu</span><span class="op" id="1337376">.</span><span class="ident" id="1337377">Lock</span><span class="op" id="1337381">(</span><span class="op" id="1337382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1337385">defer</span>&nbsp;<span class="ident" id="1337391">v</span><span class="op" id="1337392">.</span><span class="ident" id="1337393">mu</span><span class="op" id="1337395">.</span><span class="ident" id="1337396">Unlock</span><span class="op" id="1337402">(</span><span class="op" id="1337403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337406">v</span><span class="op" id="1337407">.</span><span class="ident" id="1337408">f</span>&nbsp;<span class="op" id="1337410">=</span>&nbsp;<span class="ident" id="1337412">value</span><br>
<span class="lineno">90</span><span class="op" id="1337418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1337421">//&nbsp;Map&nbsp;is&nbsp;a&nbsp;string-to-Var&nbsp;map&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="1337494">type</span>&nbsp;<span class="ident" id="1337499">Map</span>&nbsp;<span class="keyword" id="1337503">struct</span>&nbsp;<span class="op" id="1337510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337513">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1337518">sync</span><span class="op" id="1337522">.</span><span class="ident" id="1337523">RWMutex</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337532">m</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1337537">map</span><span class="op" id="1337540">[</span><span class="builtintype" id="1337541">string</span><span class="op" id="1337547">]</span><span class="ident" id="1337548">Var</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337553">keys</span>&nbsp;<span class="op" id="1337558">[</span><span class="op" id="1337559">]</span><span class="builtintype" id="1337560">string</span>&nbsp;<span class="comment" id="1337567">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="1337577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1337580">//&nbsp;KeyValue&nbsp;represents&nbsp;a&nbsp;single&nbsp;entry&nbsp;in&nbsp;a&nbsp;Map.</span><br>
<span class="lineno">100</span><span class="keyword" id="1337628">type</span>&nbsp;<span class="ident" id="1337633">KeyValue</span>&nbsp;<span class="keyword" id="1337642">struct</span>&nbsp;<span class="op" id="1337649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337652">Key</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1337658">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337666">Value</span>&nbsp;<span class="ident" id="1337672">Var</span><br>
<span class="lineno"></span><span class="op" id="1337676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="1337679">func</span>&nbsp;<span class="op" id="1337684">(</span><span class="ident" id="1337685">v</span>&nbsp;<span class="op" id="1337687">*</span><span class="ident" id="1337688">Map</span><span class="op" id="1337691">)</span>&nbsp;<span class="ident" id="1337693">String</span><span class="op" id="1337699">(</span><span class="op" id="1337700">)</span>&nbsp;<span class="builtintype" id="1337702">string</span>&nbsp;<span class="op" id="1337709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337712">v</span><span class="op" id="1337713">.</span><span class="ident" id="1337714">mu</span><span class="op" id="1337716">.</span><span class="ident" id="1337717">RLock</span><span class="op" id="1337722">(</span><span class="op" id="1337723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1337726">defer</span>&nbsp;<span class="ident" id="1337732">v</span><span class="op" id="1337733">.</span><span class="ident" id="1337734">mu</span><span class="op" id="1337736">.</span><span class="ident" id="1337737">RUnlock</span><span class="op" id="1337744">(</span><span class="op" id="1337745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1337748">var</span>&nbsp;<span class="ident" id="1337752">b</span>&nbsp;<span class="ident" id="1337754">bytes</span><span class="op" id="1337759">.</span><span class="ident" id="1337760">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337768">fmt</span><span class="op" id="1337771">.</span><span class="ident" id="1337772">Fprintf</span><span class="op" id="1337779">(</span><span class="op" id="1337780">&amp;</span><span class="ident" id="1337781">b</span><span class="op" id="1337782">,</span>&nbsp;<span class="string" id="1337784">&#34;{&#34;</span><span class="op" id="1337787">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337790">first</span>&nbsp;<span class="op" id="1337796">:=</span>&nbsp;<span class="builtintype" id="1337799">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337805">v</span><span class="op" id="1337806">.</span><span class="ident" id="1337807">doLocked</span><span class="op" id="1337815">(</span><span class="keyword" id="1337816">func</span><span class="op" id="1337820">(</span><span class="ident" id="1337821">kv</span>&nbsp;<span class="ident" id="1337824">KeyValue</span><span class="op" id="1337832">)</span>&nbsp;<span class="op" id="1337834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1337838">if</span>&nbsp;<span class="op" id="1337841">!</span><span class="ident" id="1337842">first</span>&nbsp;<span class="op" id="1337848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337853">fmt</span><span class="op" id="1337856">.</span><span class="ident" id="1337857">Fprintf</span><span class="op" id="1337864">(</span><span class="op" id="1337865">&amp;</span><span class="ident" id="1337866">b</span><span class="op" id="1337867">,</span>&nbsp;<span class="string" id="1337869">&#34;,&nbsp;&#34;</span><span class="op" id="1337873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1337877">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337881">fmt</span><span class="op" id="1337884">.</span><span class="ident" id="1337885">Fprintf</span><span class="op" id="1337892">(</span><span class="op" id="1337893">&amp;</span><span class="ident" id="1337894">b</span><span class="op" id="1337895">,</span>&nbsp;<span class="string" id="1337897">&#34;%q:&nbsp;%v&#34;</span><span class="op" id="1337905">,</span>&nbsp;<span class="ident" id="1337907">kv</span><span class="op" id="1337909">.</span><span class="ident" id="1337910">Key</span><span class="op" id="1337913">,</span>&nbsp;<span class="ident" id="1337915">kv</span><span class="op" id="1337917">.</span><span class="ident" id="1337918">Value</span><span class="op" id="1337923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337927">first</span>&nbsp;<span class="op" id="1337933">=</span>&nbsp;<span class="builtintype" id="1337935">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1337942">}</span><span class="op" id="1337943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1337946">fmt</span><span class="op" id="1337949">.</span><span class="ident" id="1337950">Fprintf</span><span class="op" id="1337957">(</span><span class="op" id="1337958">&amp;</span><span class="ident" id="1337959">b</span><span class="op" id="1337960">,</span>&nbsp;<span class="string" id="1337962">&#34;}&#34;</span><span class="op" id="1337965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1337968">return</span>&nbsp;<span class="ident" id="1337975">b</span><span class="op" id="1337976">.</span><span class="ident" id="1337977">String</span><span class="op" id="1337983">(</span><span class="op" id="1337984">)</span><br>
<span class="lineno">120</span><span class="op" id="1337986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1337989">func</span>&nbsp;<span class="op" id="1337994">(</span><span class="ident" id="1337995">v</span>&nbsp;<span class="op" id="1337997">*</span><span class="ident" id="1337998">Map</span><span class="op" id="1338001">)</span>&nbsp;<span class="ident" id="1338003">Init</span><span class="op" id="1338007">(</span><span class="op" id="1338008">)</span>&nbsp;<span class="op" id="1338010">*</span><span class="ident" id="1338011">Map</span>&nbsp;<span class="op" id="1338015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338018">v</span><span class="op" id="1338019">.</span><span class="ident" id="1338020">m</span>&nbsp;<span class="op" id="1338022">=</span>&nbsp;<span class="builtinfunc" id="1338024">make</span><span class="op" id="1338028">(</span><span class="keyword" id="1338029">map</span><span class="op" id="1338032">[</span><span class="builtintype" id="1338033">string</span><span class="op" id="1338039">]</span><span class="ident" id="1338040">Var</span><span class="op" id="1338043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1338046">return</span>&nbsp;<span class="ident" id="1338053">v</span><br>
<span class="lineno">125</span><span class="op" id="1338055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1338058">//&nbsp;updateKeys&nbsp;updates&nbsp;the&nbsp;sorted&nbsp;list&nbsp;of&nbsp;keys&nbsp;in&nbsp;v.keys.</span><br>
<span class="lineno"></span><span class="comment" id="1338115">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;v.mu&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="1338149">func</span>&nbsp;<span class="op" id="1338154">(</span><span class="ident" id="1338155">v</span>&nbsp;<span class="op" id="1338157">*</span><span class="ident" id="1338158">Map</span><span class="op" id="1338161">)</span>&nbsp;<span class="ident" id="1338163">updateKeys</span><span class="op" id="1338173">(</span><span class="op" id="1338174">)</span>&nbsp;<span class="op" id="1338176">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1338179">if</span>&nbsp;<span class="builtinfunc" id="1338182">len</span><span class="op" id="1338185">(</span><span class="ident" id="1338186">v</span><span class="op" id="1338187">.</span><span class="ident" id="1338188">m</span><span class="op" id="1338189">)</span>&nbsp;<span class="op" id="1338191">==</span>&nbsp;<span class="builtinfunc" id="1338194">len</span><span class="op" id="1338197">(</span><span class="ident" id="1338198">v</span><span class="op" id="1338199">.</span><span class="ident" id="1338200">keys</span><span class="op" id="1338204">)</span>&nbsp;<span class="op" id="1338206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1338210">//&nbsp;No&nbsp;new&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1338227">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1338235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338238">v</span><span class="op" id="1338239">.</span><span class="ident" id="1338240">keys</span>&nbsp;<span class="op" id="1338245">=</span>&nbsp;<span class="ident" id="1338247">v</span><span class="op" id="1338248">.</span><span class="ident" id="1338249">keys</span><span class="op" id="1338253">[</span><span class="op" id="1338254">:</span><span class="num" id="1338255">0</span><span class="op" id="1338256">]</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1338259">for</span>&nbsp;<span class="ident" id="1338263">k</span>&nbsp;<span class="op" id="1338265">:=</span>&nbsp;<span class="keyword" id="1338268">range</span>&nbsp;<span class="ident" id="1338274">v</span><span class="op" id="1338275">.</span><span class="ident" id="1338276">m</span>&nbsp;<span class="op" id="1338278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338282">v</span><span class="op" id="1338283">.</span><span class="ident" id="1338284">keys</span>&nbsp;<span class="op" id="1338289">=</span>&nbsp;<span class="builtinfunc" id="1338291">append</span><span class="op" id="1338297">(</span><span class="ident" id="1338298">v</span><span class="op" id="1338299">.</span><span class="ident" id="1338300">keys</span><span class="op" id="1338304">,</span>&nbsp;<span class="ident" id="1338306">k</span><span class="op" id="1338307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1338310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338313">sort</span><span class="op" id="1338317">.</span><span class="ident" id="1338318">Strings</span><span class="op" id="1338325">(</span><span class="ident" id="1338326">v</span><span class="op" id="1338327">.</span><span class="ident" id="1338328">keys</span><span class="op" id="1338332">)</span><br>
<span class="lineno"></span><span class="op" id="1338334">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="1338337">func</span>&nbsp;<span class="op" id="1338342">(</span><span class="ident" id="1338343">v</span>&nbsp;<span class="op" id="1338345">*</span><span class="ident" id="1338346">Map</span><span class="op" id="1338349">)</span>&nbsp;<span class="ident" id="1338351">Get</span><span class="op" id="1338354">(</span><span class="ident" id="1338355">key</span>&nbsp;<span class="builtintype" id="1338359">string</span><span class="op" id="1338365">)</span>&nbsp;<span class="ident" id="1338367">Var</span>&nbsp;<span class="op" id="1338371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338374">v</span><span class="op" id="1338375">.</span><span class="ident" id="1338376">mu</span><span class="op" id="1338378">.</span><span class="ident" id="1338379">RLock</span><span class="op" id="1338384">(</span><span class="op" id="1338385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1338388">defer</span>&nbsp;<span class="ident" id="1338394">v</span><span class="op" id="1338395">.</span><span class="ident" id="1338396">mu</span><span class="op" id="1338398">.</span><span class="ident" id="1338399">RUnlock</span><span class="op" id="1338406">(</span><span class="op" id="1338407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1338410">return</span>&nbsp;<span class="ident" id="1338417">v</span><span class="op" id="1338418">.</span><span class="ident" id="1338419">m</span><span class="op" id="1338420">[</span><span class="ident" id="1338421">key</span><span class="op" id="1338424">]</span><br>
<span class="lineno">145</span><span class="op" id="1338426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1338429">func</span>&nbsp;<span class="op" id="1338434">(</span><span class="ident" id="1338435">v</span>&nbsp;<span class="op" id="1338437">*</span><span class="ident" id="1338438">Map</span><span class="op" id="1338441">)</span>&nbsp;<span class="ident" id="1338443">Set</span><span class="op" id="1338446">(</span><span class="ident" id="1338447">key</span>&nbsp;<span class="builtintype" id="1338451">string</span><span class="op" id="1338457">,</span>&nbsp;<span class="ident" id="1338459">av</span>&nbsp;<span class="ident" id="1338462">Var</span><span class="op" id="1338465">)</span>&nbsp;<span class="op" id="1338467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338470">v</span><span class="op" id="1338471">.</span><span class="ident" id="1338472">mu</span><span class="op" id="1338474">.</span><span class="ident" id="1338475">Lock</span><span class="op" id="1338479">(</span><span class="op" id="1338480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1338483">defer</span>&nbsp;<span class="ident" id="1338489">v</span><span class="op" id="1338490">.</span><span class="ident" id="1338491">mu</span><span class="op" id="1338493">.</span><span class="ident" id="1338494">Unlock</span><span class="op" id="1338500">(</span><span class="op" id="1338501">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338504">v</span><span class="op" id="1338505">.</span><span class="ident" id="1338506">m</span><span class="op" id="1338507">[</span><span class="ident" id="1338508">key</span><span class="op" id="1338511">]</span>&nbsp;<span class="op" id="1338513">=</span>&nbsp;<span class="ident" id="1338515">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338519">v</span><span class="op" id="1338520">.</span><span class="ident" id="1338521">updateKeys</span><span class="op" id="1338531">(</span><span class="op" id="1338532">)</span><br>
<span class="lineno"></span><span class="op" id="1338534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1338537">func</span>&nbsp;<span class="op" id="1338542">(</span><span class="ident" id="1338543">v</span>&nbsp;<span class="op" id="1338545">*</span><span class="ident" id="1338546">Map</span><span class="op" id="1338549">)</span>&nbsp;<span class="ident" id="1338551">Add</span><span class="op" id="1338554">(</span><span class="ident" id="1338555">key</span>&nbsp;<span class="builtintype" id="1338559">string</span><span class="op" id="1338565">,</span>&nbsp;<span class="ident" id="1338567">delta</span>&nbsp;<span class="ident" id="1338573">int64</span><span class="op" id="1338578">)</span>&nbsp;<span class="op" id="1338580">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338583">v</span><span class="op" id="1338584">.</span><span class="ident" id="1338585">mu</span><span class="op" id="1338587">.</span><span class="ident" id="1338588">RLock</span><span class="op" id="1338593">(</span><span class="op" id="1338594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338597">av</span><span class="op" id="1338599">,</span>&nbsp;<span class="ident" id="1338601">ok</span>&nbsp;<span class="op" id="1338604">:=</span>&nbsp;<span class="ident" id="1338607">v</span><span class="op" id="1338608">.</span><span class="ident" id="1338609">m</span><span class="op" id="1338610">[</span><span class="ident" id="1338611">key</span><span class="op" id="1338614">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338617">v</span><span class="op" id="1338618">.</span><span class="ident" id="1338619">mu</span><span class="op" id="1338621">.</span><span class="ident" id="1338622">RUnlock</span><span class="op" id="1338629">(</span><span class="op" id="1338630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1338633">if</span>&nbsp;<span class="op" id="1338636">!</span><span class="ident" id="1338637">ok</span>&nbsp;<span class="op" id="1338640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1338644">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338682">v</span><span class="op" id="1338683">.</span><span class="ident" id="1338684">mu</span><span class="op" id="1338686">.</span><span class="ident" id="1338687">Lock</span><span class="op" id="1338691">(</span><span class="op" id="1338692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338696">av</span><span class="op" id="1338698">,</span>&nbsp;<span class="ident" id="1338700">ok</span>&nbsp;<span class="op" id="1338703">=</span>&nbsp;<span class="ident" id="1338705">v</span><span class="op" id="1338706">.</span><span class="ident" id="1338707">m</span><span class="op" id="1338708">[</span><span class="ident" id="1338709">key</span><span class="op" id="1338712">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1338716">if</span>&nbsp;<span class="op" id="1338719">!</span><span class="ident" id="1338720">ok</span>&nbsp;<span class="op" id="1338723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338728">av</span>&nbsp;<span class="op" id="1338731">=</span>&nbsp;<span class="builtinfunc" id="1338733">new</span><span class="op" id="1338736">(</span><span class="ident" id="1338737">Int</span><span class="op" id="1338740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338745">v</span><span class="op" id="1338746">.</span><span class="ident" id="1338747">m</span><span class="op" id="1338748">[</span><span class="ident" id="1338749">key</span><span class="op" id="1338752">]</span>&nbsp;<span class="op" id="1338754">=</span>&nbsp;<span class="ident" id="1338756">av</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338762">v</span><span class="op" id="1338763">.</span><span class="ident" id="1338764">updateKeys</span><span class="op" id="1338774">(</span><span class="op" id="1338775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1338779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338783">v</span><span class="op" id="1338784">.</span><span class="ident" id="1338785">mu</span><span class="op" id="1338787">.</span><span class="ident" id="1338788">Unlock</span><span class="op" id="1338794">(</span><span class="op" id="1338795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1338798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1338802">//&nbsp;Add&nbsp;to&nbsp;Int;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1338836">if</span>&nbsp;<span class="ident" id="1338839">iv</span><span class="op" id="1338841">,</span>&nbsp;<span class="ident" id="1338843">ok</span>&nbsp;<span class="op" id="1338846">:=</span>&nbsp;<span class="ident" id="1338849">av</span><span class="op" id="1338851">.</span><span class="op" id="1338852">(</span><span class="op" id="1338853">*</span><span class="ident" id="1338854">Int</span><span class="op" id="1338857">)</span><span class="op" id="1338858">;</span>&nbsp;<span class="ident" id="1338860">ok</span>&nbsp;<span class="op" id="1338863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1338867">iv</span><span class="op" id="1338869">.</span><span class="ident" id="1338870">Add</span><span class="op" id="1338873">(</span><span class="ident" id="1338874">delta</span><span class="op" id="1338879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1338882">}</span><br>
<span class="lineno"></span><span class="op" id="1338884">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span><span class="comment" id="1338887">//&nbsp;AddFloat&nbsp;adds&nbsp;delta&nbsp;to&nbsp;the&nbsp;*Float&nbsp;value&nbsp;stored&nbsp;under&nbsp;the&nbsp;given&nbsp;map&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="1338962">func</span>&nbsp;<span class="op" id="1338967">(</span><span class="ident" id="1338968">v</span>&nbsp;<span class="op" id="1338970">*</span><span class="ident" id="1338971">Map</span><span class="op" id="1338974">)</span>&nbsp;<span class="ident" id="1338976">AddFloat</span><span class="op" id="1338984">(</span><span class="ident" id="1338985">key</span>&nbsp;<span class="builtintype" id="1338989">string</span><span class="op" id="1338995">,</span>&nbsp;<span class="ident" id="1338997">delta</span>&nbsp;<span class="builtintype" id="1339003">float64</span><span class="op" id="1339010">)</span>&nbsp;<span class="op" id="1339012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1339015">v</span><span class="op" id="1339016">.</span><span class="ident" id="1339017">mu</span><span class="op" id="1339019">.</span><span class="ident" id="1339020">RLock</span><span class="op" id="1339025">(</span><span class="op" id="1339026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1339029">av</span><span class="op" id="1339031">,</span>&nbsp;<span class="ident" id="1339033">ok</span>&nbsp;<span class="op" id="1339036">:=</span>&nbsp;<span class="ident" id="1339039">v</span><span class="op" id="1339040">.</span><span class="ident" id="1339041">m</span><span class="op" id="1339042">[</span><span class="ident" id="1339043">key</span><span class="op" id="1339046">]</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1339049">v</span><span class="op" id="1339050">.</span><span class="ident" id="1339051">mu</span><span class="op" id="1339053">.</span><span class="ident" id="1339054">RUnlock</span><span class="op" id="1339061">(</span><span class="op" id="1339062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1339065">if</span>&nbsp;<span class="op" id="1339068">!</span><span class="ident" id="1339069">ok</span>&nbsp;<span class="op" id="1339072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1339076">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1339114">v</span><span class="op" id="1339115">.</span><span class="ident" id="1339116">mu</span><span class="op" id="1339118">.</span><span class="ident" id="1339119">Lock</span><span class="op" id="1339123">(</span><span class="op" id="1339124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1339128">av</span><span class="op" id="1339130">,</span>&nbsp;<span class="ident" id="1339132">ok</span>&nbsp;<span class="op" id="1339135">=</span>&nbsp;<span class="ident" id="1339137">v</span><span class="op" id="1339138">.</span><span class="ident" id="1339139">m</span><span class="op" id="1339140">[</span><span class="ident" id="1339141">key</span><span class="op" id="1339144">]</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1339148">if</span>&nbsp;<span class="op" id="1339151">!</span><span class="ident" id="1339152">ok</span>&nbsp;<span class="op" id="1339155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1339160">av</span>&nbsp;<span class="op" id="1339163">=</span>&nbsp;<span class="builtinfunc" id="1339165">new</span><span class="op" id="1339168">(</span><span class="ident" id="1339169">Float</span><span class="op" id="1339174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1339179">v</span><span class="op" id="1339180">.</span><span class="ident" id="1339181">m</span><span class="op" id="1339182">[</span><span class="ident" id="1339183">key</span><span class="op" id="1339186">]</span>&nbsp;<span class="op" id="1339188">=</span>&nbsp;<span class="ident" id="1339190">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1339196">v</span><span class="op" id="1339197">.</span><span class="ident" id="1339198">updateKeys</span><span class="op" id="1339208">(</span><span class="op" id="1339209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1339213">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1339217">v</span><span class="op" id="1339218">.</span><span class="ident" id="1339219">mu</span><span class="op" id="1339221">.</span><span class="ident" id="1339222">Unlock</span><span class="op" id="1339228">(</span><span class="op" id="1339229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1339232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1339236">//&nbsp;Add&nbsp;to&nbsp;Float;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1339272">if</span>&nbsp;<span class="ident" id="1339275">iv</span><span class="op" id="1339277">,</span>&nbsp;<span class="ident" id="1339279">ok</span>&nbsp;<span class="op" id="1339282">:=</span>&nbsp;<span class="ident" id="1339285">av</span><span class="op" id="1339287">.</span><span class="op" id="1339288">(</span><span class="op" id="1339289">*</span><span class="ident" id="1339290">Float</span><span class="op" id="1339295">)</span><span class="op" id="1339296">;</span>&nbsp;<span class="ident" id="1339298">ok</span>&nbsp;<span class="op" id="1339301">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1339305">iv</span><span class="op" id="1339307">.</span><span class="ident" id="1339308">Add</span><span class="op" id="1339311">(</span><span class="ident" id="1339312">delta</span><span class="op" id="1339317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1339320">}</span><br>
<span class="lineno"></span><span class="op" id="1339322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1339325">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">200</span><span class="comment" id="1339366">//&nbsp;The&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="1339409">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="1339462">func</span>&nbsp;<span class="op" id="1339467">(</span><span class="ident" id="1339468">v</span>&nbsp;<span class="op" id="1339470">*</span><span class="ident" id="1339471">Map</span><span class="op" id="1339474">)</span>&nbsp;<span class="ident" id="1339476">Do</span><span class="op" id="1339478">(</span><span class="ident" id="1339479">f</span>&nbsp;<span class="keyword" id="1339481">func</span><span class="op" id="1339485">(</span><span class="ident" id="1339486">KeyValue</span><span class="op" id="1339494">)</span><span class="op" id="1339495">)</span>&nbsp;<span class="op" id="1339497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1339500">v</span><span class="op" id="1339501">.</span><span class="ident" id="1339502">mu</span><span class="op" id="1339504">.</span><span class="ident" id="1339505">RLock</span><span class="op" id="1339510">(</span><span class="op" id="1339511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1339514">defer</span>&nbsp;<span class="ident" id="1339520">v</span><span class="op" id="1339521">.</span><span class="ident" id="1339522">mu</span><span class="op" id="1339524">.</span><span class="ident" id="1339525">RUnlock</span><span class="op" id="1339532">(</span><span class="op" id="1339533">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1339536">v</span><span class="op" id="1339537">.</span><span class="ident" id="1339538">doLocked</span><span class="op" id="1339546">(</span><span class="ident" id="1339547">f</span><span class="op" id="1339548">)</span><br>
<span class="lineno"></span><span class="op" id="1339550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1339553">//&nbsp;doLocked&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="1339600">//&nbsp;v.mu&nbsp;must&nbsp;be&nbsp;held&nbsp;for&nbsp;reads.</span><br>
<span class="lineno">210</span><span class="keyword" id="1339632">func</span>&nbsp;<span class="op" id="1339637">(</span><span class="ident" id="1339638">v</span>&nbsp;<span class="op" id="1339640">*</span><span class="ident" id="1339641">Map</span><span class="op" id="1339644">)</span>&nbsp;<span class="ident" id="1339646">doLocked</span><span class="op" id="1339654">(</span><span class="ident" id="1339655">f</span>&nbsp;<span class="keyword" id="1339657">func</span><span class="op" id="1339661">(</span><span class="ident" id="1339662">KeyValue</span><span class="op" id="1339670">)</span><span class="op" id="1339671">)</span>&nbsp;<span class="op" id="1339673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1339676">for</span>&nbsp;<span class="ident" id="1339680">_</span><span class="op" id="1339681">,</span>&nbsp;<span class="ident" id="1339683">k</span>&nbsp;<span class="op" id="1339685">:=</span>&nbsp;<span class="keyword" id="1339688">range</span>&nbsp;<span class="ident" id="1339694">v</span><span class="op" id="1339695">.</span><span class="ident" id="1339696">keys</span>&nbsp;<span class="op" id="1339701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1339705">f</span><span class="op" id="1339706">(</span><span class="ident" id="1339707">KeyValue</span><span class="op" id="1339715">{</span><span class="ident" id="1339716">k</span><span class="op" id="1339717">,</span>&nbsp;<span class="ident" id="1339719">v</span><span class="op" id="1339720">.</span><span class="ident" id="1339721">m</span><span class="op" id="1339722">[</span><span class="ident" id="1339723">k</span><span class="op" id="1339724">]</span><span class="op" id="1339725">}</span><span class="op" id="1339726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1339729">}</span><br>
<span class="lineno"></span><span class="op" id="1339731">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="1339734">//&nbsp;String&nbsp;is&nbsp;a&nbsp;string&nbsp;variable,&nbsp;and&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="1339799">type</span>&nbsp;<span class="ident" id="1339804">String</span>&nbsp;<span class="keyword" id="1339811">struct</span>&nbsp;<span class="op" id="1339818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1339821">mu</span>&nbsp;<span class="ident" id="1339824">sync</span><span class="op" id="1339828">.</span><span class="ident" id="1339829">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1339838">s</span>&nbsp;&nbsp;<span class="builtintype" id="1339841">string</span><br>
<span class="lineno">220</span><span class="op" id="1339848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1339851">func</span>&nbsp;<span class="op" id="1339856">(</span><span class="ident" id="1339857">v</span>&nbsp;<span class="op" id="1339859">*</span><span class="ident" id="1339860">String</span><span class="op" id="1339866">)</span>&nbsp;<span class="ident" id="1339868">String</span><span class="op" id="1339874">(</span><span class="op" id="1339875">)</span>&nbsp;<span class="builtintype" id="1339877">string</span>&nbsp;<span class="op" id="1339884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1339887">v</span><span class="op" id="1339888">.</span><span class="ident" id="1339889">mu</span><span class="op" id="1339891">.</span><span class="ident" id="1339892">RLock</span><span class="op" id="1339897">(</span><span class="op" id="1339898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1339901">defer</span>&nbsp;<span class="ident" id="1339907">v</span><span class="op" id="1339908">.</span><span class="ident" id="1339909">mu</span><span class="op" id="1339911">.</span><span class="ident" id="1339912">RUnlock</span><span class="op" id="1339919">(</span><span class="op" id="1339920">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1339923">return</span>&nbsp;<span class="ident" id="1339930">strconv</span><span class="op" id="1339937">.</span><span class="ident" id="1339938">Quote</span><span class="op" id="1339943">(</span><span class="ident" id="1339944">v</span><span class="op" id="1339945">.</span><span class="ident" id="1339946">s</span><span class="op" id="1339947">)</span><br>
<span class="lineno"></span><span class="op" id="1339949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1339952">func</span>&nbsp;<span class="op" id="1339957">(</span><span class="ident" id="1339958">v</span>&nbsp;<span class="op" id="1339960">*</span><span class="ident" id="1339961">String</span><span class="op" id="1339967">)</span>&nbsp;<span class="ident" id="1339969">Set</span><span class="op" id="1339972">(</span><span class="ident" id="1339973">value</span>&nbsp;<span class="builtintype" id="1339979">string</span><span class="op" id="1339985">)</span>&nbsp;<span class="op" id="1339987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1339990">v</span><span class="op" id="1339991">.</span><span class="ident" id="1339992">mu</span><span class="op" id="1339994">.</span><span class="ident" id="1339995">Lock</span><span class="op" id="1339999">(</span><span class="op" id="1340000">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1340003">defer</span>&nbsp;<span class="ident" id="1340009">v</span><span class="op" id="1340010">.</span><span class="ident" id="1340011">mu</span><span class="op" id="1340013">.</span><span class="ident" id="1340014">Unlock</span><span class="op" id="1340020">(</span><span class="op" id="1340021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1340024">v</span><span class="op" id="1340025">.</span><span class="ident" id="1340026">s</span>&nbsp;<span class="op" id="1340028">=</span>&nbsp;<span class="ident" id="1340030">value</span><br>
<span class="lineno"></span><span class="op" id="1340036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1340039">//&nbsp;Func&nbsp;implements&nbsp;Var&nbsp;by&nbsp;calling&nbsp;the&nbsp;function</span><br>
<span class="lineno">235</span><span class="comment" id="1340086">//&nbsp;and&nbsp;formatting&nbsp;the&nbsp;returned&nbsp;value&nbsp;using&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="1340135">type</span>&nbsp;<span class="ident" id="1340140">Func</span>&nbsp;<span class="keyword" id="1340145">func</span><span class="op" id="1340149">(</span><span class="op" id="1340150">)</span>&nbsp;<span class="keyword" id="1340152">interface</span><span class="op" id="1340161">{</span><span class="op" id="1340162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1340165">func</span>&nbsp;<span class="op" id="1340170">(</span><span class="ident" id="1340171">f</span>&nbsp;<span class="ident" id="1340173">Func</span><span class="op" id="1340177">)</span>&nbsp;<span class="ident" id="1340179">String</span><span class="op" id="1340185">(</span><span class="op" id="1340186">)</span>&nbsp;<span class="builtintype" id="1340188">string</span>&nbsp;<span class="op" id="1340195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1340198">v</span><span class="op" id="1340199">,</span>&nbsp;<span class="ident" id="1340201">_</span>&nbsp;<span class="op" id="1340203">:=</span>&nbsp;<span class="ident" id="1340206">json</span><span class="op" id="1340210">.</span><span class="ident" id="1340211">Marshal</span><span class="op" id="1340218">(</span><span class="ident" id="1340219">f</span><span class="op" id="1340220">(</span><span class="op" id="1340221">)</span><span class="op" id="1340222">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1340225">return</span>&nbsp;<span class="builtintype" id="1340232">string</span><span class="op" id="1340238">(</span><span class="ident" id="1340239">v</span><span class="op" id="1340240">)</span><br>
<span class="lineno"></span><span class="op" id="1340242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1340245">//&nbsp;All&nbsp;published&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="1340273">var</span>&nbsp;<span class="op" id="1340277">(</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1340280">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1340288">sync</span><span class="op" id="1340292">.</span><span class="ident" id="1340293">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1340302">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1340310">=</span>&nbsp;<span class="builtinfunc" id="1340312">make</span><span class="op" id="1340316">(</span><span class="keyword" id="1340317">map</span><span class="op" id="1340320">[</span><span class="builtintype" id="1340321">string</span><span class="op" id="1340327">]</span><span class="ident" id="1340328">Var</span><span class="op" id="1340331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1340334">varKeys</span>&nbsp;<span class="op" id="1340342">[</span><span class="op" id="1340343">]</span><span class="builtintype" id="1340344">string</span>&nbsp;<span class="comment" id="1340351">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="1340361">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="comment" id="1340364">//&nbsp;Publish&nbsp;declares&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.&nbsp;This&nbsp;should&nbsp;be&nbsp;called&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1340440">//&nbsp;package&#39;s&nbsp;init&nbsp;function&nbsp;when&nbsp;it&nbsp;creates&nbsp;its&nbsp;Vars.&nbsp;If&nbsp;the&nbsp;name&nbsp;is&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="1340516">//&nbsp;registered&nbsp;then&nbsp;this&nbsp;will&nbsp;log.Panic.</span><br>
<span class="lineno"></span><span class="keyword" id="1340556">func</span>&nbsp;<span class="ident" id="1340561">Publish</span><span class="op" id="1340568">(</span><span class="ident" id="1340569">name</span>&nbsp;<span class="builtintype" id="1340574">string</span><span class="op" id="1340580">,</span>&nbsp;<span class="ident" id="1340582">v</span>&nbsp;<span class="ident" id="1340584">Var</span><span class="op" id="1340587">)</span>&nbsp;<span class="op" id="1340589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1340592">mutex</span><span class="op" id="1340597">.</span><span class="ident" id="1340598">Lock</span><span class="op" id="1340602">(</span><span class="op" id="1340603">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1340606">defer</span>&nbsp;<span class="ident" id="1340612">mutex</span><span class="op" id="1340617">.</span><span class="ident" id="1340618">Unlock</span><span class="op" id="1340624">(</span><span class="op" id="1340625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1340628">if</span>&nbsp;<span class="ident" id="1340631">_</span><span class="op" id="1340632">,</span>&nbsp;<span class="ident" id="1340634">existing</span>&nbsp;<span class="op" id="1340643">:=</span>&nbsp;<span class="ident" id="1340646">vars</span><span class="op" id="1340650">[</span><span class="ident" id="1340651">name</span><span class="op" id="1340655">]</span><span class="op" id="1340656">;</span>&nbsp;<span class="ident" id="1340658">existing</span>&nbsp;<span class="op" id="1340667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1340671">log</span><span class="op" id="1340674">.</span><span class="ident" id="1340675">Panicln</span><span class="op" id="1340682">(</span><span class="string" id="1340683">&#34;Reuse&nbsp;of&nbsp;exported&nbsp;var&nbsp;name:&#34;</span><span class="op" id="1340712">,</span>&nbsp;<span class="ident" id="1340714">name</span><span class="op" id="1340718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1340721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1340724">vars</span><span class="op" id="1340728">[</span><span class="ident" id="1340729">name</span><span class="op" id="1340733">]</span>&nbsp;<span class="op" id="1340735">=</span>&nbsp;<span class="ident" id="1340737">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1340740">varKeys</span>&nbsp;<span class="op" id="1340748">=</span>&nbsp;<span class="builtinfunc" id="1340750">append</span><span class="op" id="1340756">(</span><span class="ident" id="1340757">varKeys</span><span class="op" id="1340764">,</span>&nbsp;<span class="ident" id="1340766">name</span><span class="op" id="1340770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1340773">sort</span><span class="op" id="1340777">.</span><span class="ident" id="1340778">Strings</span><span class="op" id="1340785">(</span><span class="ident" id="1340786">varKeys</span><span class="op" id="1340793">)</span><br>
<span class="lineno"></span><span class="op" id="1340795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1340798">//&nbsp;Get&nbsp;retrieves&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno">265</span><span class="keyword" id="1340842">func</span>&nbsp;<span class="ident" id="1340847">Get</span><span class="op" id="1340850">(</span><span class="ident" id="1340851">name</span>&nbsp;<span class="builtintype" id="1340856">string</span><span class="op" id="1340862">)</span>&nbsp;<span class="ident" id="1340864">Var</span>&nbsp;<span class="op" id="1340868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1340871">mutex</span><span class="op" id="1340876">.</span><span class="ident" id="1340877">RLock</span><span class="op" id="1340882">(</span><span class="op" id="1340883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1340886">defer</span>&nbsp;<span class="ident" id="1340892">mutex</span><span class="op" id="1340897">.</span><span class="ident" id="1340898">RUnlock</span><span class="op" id="1340905">(</span><span class="op" id="1340906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1340909">return</span>&nbsp;<span class="ident" id="1340916">vars</span><span class="op" id="1340920">[</span><span class="ident" id="1340921">name</span><span class="op" id="1340925">]</span><br>
<span class="lineno"></span><span class="op" id="1340927">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="comment" id="1340930">//&nbsp;Convenience&nbsp;functions&nbsp;for&nbsp;creating&nbsp;new&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1340993">func</span>&nbsp;<span class="ident" id="1340998">NewInt</span><span class="op" id="1341004">(</span><span class="ident" id="1341005">name</span>&nbsp;<span class="builtintype" id="1341010">string</span><span class="op" id="1341016">)</span>&nbsp;<span class="op" id="1341018">*</span><span class="ident" id="1341019">Int</span>&nbsp;<span class="op" id="1341023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341026">v</span>&nbsp;<span class="op" id="1341028">:=</span>&nbsp;<span class="builtinfunc" id="1341031">new</span><span class="op" id="1341034">(</span><span class="ident" id="1341035">Int</span><span class="op" id="1341038">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341041">Publish</span><span class="op" id="1341048">(</span><span class="ident" id="1341049">name</span><span class="op" id="1341053">,</span>&nbsp;<span class="ident" id="1341055">v</span><span class="op" id="1341056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1341059">return</span>&nbsp;<span class="ident" id="1341066">v</span><br>
<span class="lineno"></span><span class="op" id="1341068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1341071">func</span>&nbsp;<span class="ident" id="1341076">NewFloat</span><span class="op" id="1341084">(</span><span class="ident" id="1341085">name</span>&nbsp;<span class="builtintype" id="1341090">string</span><span class="op" id="1341096">)</span>&nbsp;<span class="op" id="1341098">*</span><span class="ident" id="1341099">Float</span>&nbsp;<span class="op" id="1341105">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341108">v</span>&nbsp;<span class="op" id="1341110">:=</span>&nbsp;<span class="builtinfunc" id="1341113">new</span><span class="op" id="1341116">(</span><span class="ident" id="1341117">Float</span><span class="op" id="1341122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341125">Publish</span><span class="op" id="1341132">(</span><span class="ident" id="1341133">name</span><span class="op" id="1341137">,</span>&nbsp;<span class="ident" id="1341139">v</span><span class="op" id="1341140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1341143">return</span>&nbsp;<span class="ident" id="1341150">v</span><br>
<span class="lineno"></span><span class="op" id="1341152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="1341155">func</span>&nbsp;<span class="ident" id="1341160">NewMap</span><span class="op" id="1341166">(</span><span class="ident" id="1341167">name</span>&nbsp;<span class="builtintype" id="1341172">string</span><span class="op" id="1341178">)</span>&nbsp;<span class="op" id="1341180">*</span><span class="ident" id="1341181">Map</span>&nbsp;<span class="op" id="1341185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341188">v</span>&nbsp;<span class="op" id="1341190">:=</span>&nbsp;<span class="builtinfunc" id="1341193">new</span><span class="op" id="1341196">(</span><span class="ident" id="1341197">Map</span><span class="op" id="1341200">)</span><span class="op" id="1341201">.</span><span class="ident" id="1341202">Init</span><span class="op" id="1341206">(</span><span class="op" id="1341207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341210">Publish</span><span class="op" id="1341217">(</span><span class="ident" id="1341218">name</span><span class="op" id="1341222">,</span>&nbsp;<span class="ident" id="1341224">v</span><span class="op" id="1341225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1341228">return</span>&nbsp;<span class="ident" id="1341235">v</span><br>
<span class="lineno"></span><span class="op" id="1341237">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span><span class="keyword" id="1341240">func</span>&nbsp;<span class="ident" id="1341245">NewString</span><span class="op" id="1341254">(</span><span class="ident" id="1341255">name</span>&nbsp;<span class="builtintype" id="1341260">string</span><span class="op" id="1341266">)</span>&nbsp;<span class="op" id="1341268">*</span><span class="ident" id="1341269">String</span>&nbsp;<span class="op" id="1341276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341279">v</span>&nbsp;<span class="op" id="1341281">:=</span>&nbsp;<span class="builtinfunc" id="1341284">new</span><span class="op" id="1341287">(</span><span class="ident" id="1341288">String</span><span class="op" id="1341294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341297">Publish</span><span class="op" id="1341304">(</span><span class="ident" id="1341305">name</span><span class="op" id="1341309">,</span>&nbsp;<span class="ident" id="1341311">v</span><span class="op" id="1341312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1341315">return</span>&nbsp;<span class="ident" id="1341322">v</span><br>
<span class="lineno">295</span><span class="op" id="1341324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1341327">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="1341369">//&nbsp;The&nbsp;global&nbsp;variable&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="1341428">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno">300</span><span class="keyword" id="1341481">func</span>&nbsp;<span class="ident" id="1341486">Do</span><span class="op" id="1341488">(</span><span class="ident" id="1341489">f</span>&nbsp;<span class="keyword" id="1341491">func</span><span class="op" id="1341495">(</span><span class="ident" id="1341496">KeyValue</span><span class="op" id="1341504">)</span><span class="op" id="1341505">)</span>&nbsp;<span class="op" id="1341507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341510">mutex</span><span class="op" id="1341515">.</span><span class="ident" id="1341516">RLock</span><span class="op" id="1341521">(</span><span class="op" id="1341522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1341525">defer</span>&nbsp;<span class="ident" id="1341531">mutex</span><span class="op" id="1341536">.</span><span class="ident" id="1341537">RUnlock</span><span class="op" id="1341544">(</span><span class="op" id="1341545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1341548">for</span>&nbsp;<span class="ident" id="1341552">_</span><span class="op" id="1341553">,</span>&nbsp;<span class="ident" id="1341555">k</span>&nbsp;<span class="op" id="1341557">:=</span>&nbsp;<span class="keyword" id="1341560">range</span>&nbsp;<span class="ident" id="1341566">varKeys</span>&nbsp;<span class="op" id="1341574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341578">f</span><span class="op" id="1341579">(</span><span class="ident" id="1341580">KeyValue</span><span class="op" id="1341588">{</span><span class="ident" id="1341589">k</span><span class="op" id="1341590">,</span>&nbsp;<span class="ident" id="1341592">vars</span><span class="op" id="1341596">[</span><span class="ident" id="1341597">k</span><span class="op" id="1341598">]</span><span class="op" id="1341599">}</span><span class="op" id="1341600">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1341603">}</span><br>
<span class="lineno"></span><span class="op" id="1341605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1341608">func</span>&nbsp;<span class="ident" id="1341613">expvarHandler</span><span class="op" id="1341626">(</span><span class="ident" id="1341627">w</span>&nbsp;<span class="ident" id="1341629">http</span><span class="op" id="1341633">.</span><span class="ident" id="1341634">ResponseWriter</span><span class="op" id="1341648">,</span>&nbsp;<span class="ident" id="1341650">r</span>&nbsp;<span class="op" id="1341652">*</span><span class="ident" id="1341653">http</span><span class="op" id="1341657">.</span><span class="ident" id="1341658">Request</span><span class="op" id="1341665">)</span>&nbsp;<span class="op" id="1341667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341670">w</span><span class="op" id="1341671">.</span><span class="ident" id="1341672">Header</span><span class="op" id="1341678">(</span><span class="op" id="1341679">)</span><span class="op" id="1341680">.</span><span class="ident" id="1341681">Set</span><span class="op" id="1341684">(</span><span class="string" id="1341685">&#34;Content-Type&#34;</span><span class="op" id="1341699">,</span>&nbsp;<span class="string" id="1341701">&#34;application/json;&nbsp;charset=utf-8&#34;</span><span class="op" id="1341734">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341737">fmt</span><span class="op" id="1341740">.</span><span class="ident" id="1341741">Fprintf</span><span class="op" id="1341748">(</span><span class="ident" id="1341749">w</span><span class="op" id="1341750">,</span>&nbsp;<span class="string" id="1341752">&#34;{\n&#34;</span><span class="op" id="1341757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341760">first</span>&nbsp;<span class="op" id="1341766">:=</span>&nbsp;<span class="builtintype" id="1341769">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341775">Do</span><span class="op" id="1341777">(</span><span class="keyword" id="1341778">func</span><span class="op" id="1341782">(</span><span class="ident" id="1341783">kv</span>&nbsp;<span class="ident" id="1341786">KeyValue</span><span class="op" id="1341794">)</span>&nbsp;<span class="op" id="1341796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1341800">if</span>&nbsp;<span class="op" id="1341803">!</span><span class="ident" id="1341804">first</span>&nbsp;<span class="op" id="1341810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341815">fmt</span><span class="op" id="1341818">.</span><span class="ident" id="1341819">Fprintf</span><span class="op" id="1341826">(</span><span class="ident" id="1341827">w</span><span class="op" id="1341828">,</span>&nbsp;<span class="string" id="1341830">&#34;,\n&#34;</span><span class="op" id="1341835">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1341839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341843">first</span>&nbsp;<span class="op" id="1341849">=</span>&nbsp;<span class="builtintype" id="1341851">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341859">fmt</span><span class="op" id="1341862">.</span><span class="ident" id="1341863">Fprintf</span><span class="op" id="1341870">(</span><span class="ident" id="1341871">w</span><span class="op" id="1341872">,</span>&nbsp;<span class="string" id="1341874">&#34;%q:&nbsp;%s&#34;</span><span class="op" id="1341882">,</span>&nbsp;<span class="ident" id="1341884">kv</span><span class="op" id="1341886">.</span><span class="ident" id="1341887">Key</span><span class="op" id="1341890">,</span>&nbsp;<span class="ident" id="1341892">kv</span><span class="op" id="1341894">.</span><span class="ident" id="1341895">Value</span><span class="op" id="1341900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1341903">}</span><span class="op" id="1341904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1341907">fmt</span><span class="op" id="1341910">.</span><span class="ident" id="1341911">Fprintf</span><span class="op" id="1341918">(</span><span class="ident" id="1341919">w</span><span class="op" id="1341920">,</span>&nbsp;<span class="string" id="1341922">&#34;\n}\n&#34;</span><span class="op" id="1341929">)</span><br>
<span class="lineno">320</span><span class="op" id="1341931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1341934">func</span>&nbsp;<span class="ident" id="1341939">cmdline</span><span class="op" id="1341946">(</span><span class="op" id="1341947">)</span>&nbsp;<span class="keyword" id="1341949">interface</span><span class="op" id="1341958">{</span><span class="op" id="1341959">}</span>&nbsp;<span class="op" id="1341961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1341964">return</span>&nbsp;<span class="ident" id="1341971">os</span><span class="op" id="1341973">.</span><span class="ident" id="1341974">Args</span><br>
<span class="lineno"></span><span class="op" id="1341979">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="1341982">func</span>&nbsp;<span class="ident" id="1341987">memstats</span><span class="op" id="1341995">(</span><span class="op" id="1341996">)</span>&nbsp;<span class="keyword" id="1341998">interface</span><span class="op" id="1342007">{</span><span class="op" id="1342008">}</span>&nbsp;<span class="op" id="1342010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1342013">stats</span>&nbsp;<span class="op" id="1342019">:=</span>&nbsp;<span class="builtinfunc" id="1342022">new</span><span class="op" id="1342025">(</span><span class="ident" id="1342026">runtime</span><span class="op" id="1342033">.</span><span class="ident" id="1342034">MemStats</span><span class="op" id="1342042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1342045">runtime</span><span class="op" id="1342052">.</span><span class="ident" id="1342053">ReadMemStats</span><span class="op" id="1342065">(</span><span class="ident" id="1342066">stats</span><span class="op" id="1342071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1342074">return</span>&nbsp;<span class="op" id="1342081">*</span><span class="ident" id="1342082">stats</span><br>
<span class="lineno">330</span><span class="op" id="1342088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1342091">func</span>&nbsp;<span class="ident" id="1342096">init</span><span class="op" id="1342100">(</span><span class="op" id="1342101">)</span>&nbsp;<span class="op" id="1342103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1342106">http</span><span class="op" id="1342110">.</span><span class="ident" id="1342111">HandleFunc</span><span class="op" id="1342121">(</span><span class="string" id="1342122">&#34;/debug/vars&#34;</span><span class="op" id="1342135">,</span>&nbsp;<span class="ident" id="1342137">expvarHandler</span><span class="op" id="1342150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1342153">Publish</span><span class="op" id="1342160">(</span><span class="string" id="1342161">&#34;cmdline&#34;</span><span class="op" id="1342170">,</span>&nbsp;<span class="ident" id="1342172">Func</span><span class="op" id="1342176">(</span><span class="ident" id="1342177">cmdline</span><span class="op" id="1342184">)</span><span class="op" id="1342185">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1342188">Publish</span><span class="op" id="1342195">(</span><span class="string" id="1342196">&#34;memstats&#34;</span><span class="op" id="1342206">,</span>&nbsp;<span class="ident" id="1342208">Func</span><span class="op" id="1342212">(</span><span class="ident" id="1342213">memstats</span><span class="op" id="1342221">)</span><span class="op" id="1342222">)</span><br>
<span class="lineno"></span><span class="op" id="1342224">}</span>
</div>
</body>
</html>
