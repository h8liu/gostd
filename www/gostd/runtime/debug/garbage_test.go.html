<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime/debug</h2>
<ul>
<li><a href="/gostd/runtime/debug/garbage.go.html">garbage.go</a></li>
<li><a href="/gostd/runtime/debug/garbage_test.go.html">garbage_test.go</a></li>
<li><a href="/gostd/runtime/debug/heapdump_test.go.html">heapdump_test.go</a></li>
<li><a href="/gostd/runtime/debug/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/debug/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/debug/stubs.go.html">stubs.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7029431">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7029487">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7029541">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7029592">package</span>&nbsp;<span class="ident" id="7029600">debug</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7029607">import</span>&nbsp;<span class="op" id="7029614">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7029617">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7029628">&#34;testing&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7029639">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7029646">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7029649">func</span>&nbsp;<span class="ident" id="7029654">TestReadGCStats</span><span class="op" id="7029669">(</span><span class="ident" id="7029670">t</span>&nbsp;<span class="op" id="7029672">*</span><span class="ident" id="7029673">testing</span><span class="op" id="7029680">.</span><span class="ident" id="7029681">T</span><span class="op" id="7029682">)</span>&nbsp;<span class="op" id="7029684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7029687">defer</span>&nbsp;<span class="ident" id="7029693">SetGCPercent</span><span class="op" id="7029705">(</span><span class="ident" id="7029706">SetGCPercent</span><span class="op" id="7029718">(</span><span class="op" id="7029719">-</span><span class="num" id="7029720">1</span><span class="op" id="7029721">)</span><span class="op" id="7029722">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7029726">var</span>&nbsp;<span class="ident" id="7029730">stats</span>&nbsp;<span class="ident" id="7029736">GCStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7029745">var</span>&nbsp;<span class="ident" id="7029749">mstats</span>&nbsp;<span class="ident" id="7029756">runtime</span><span class="op" id="7029763">.</span><span class="ident" id="7029764">MemStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7029774">var</span>&nbsp;<span class="ident" id="7029778">min</span><span class="op" id="7029781">,</span>&nbsp;<span class="ident" id="7029783">max</span>&nbsp;<span class="ident" id="7029787">time</span><span class="op" id="7029791">.</span><span class="ident" id="7029792">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7029803">//&nbsp;First&nbsp;ReadGCStats&nbsp;will&nbsp;allocate,&nbsp;second&nbsp;should&nbsp;not,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7029859">//&nbsp;especially&nbsp;if&nbsp;we&nbsp;follow&nbsp;up&nbsp;with&nbsp;an&nbsp;explicit&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7029927">stats</span><span class="op" id="7029932">.</span><span class="ident" id="7029933">PauseQuantiles</span>&nbsp;<span class="op" id="7029948">=</span>&nbsp;<span class="builtinfunc" id="7029950">make</span><span class="op" id="7029954">(</span><span class="op" id="7029955">[</span><span class="op" id="7029956">]</span><span class="ident" id="7029957">time</span><span class="op" id="7029961">.</span><span class="ident" id="7029962">Duration</span><span class="op" id="7029970">,</span>&nbsp;<span class="num" id="7029972">10</span><span class="op" id="7029974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7029977">ReadGCStats</span><span class="op" id="7029988">(</span><span class="op" id="7029989">&amp;</span><span class="ident" id="7029990">stats</span><span class="op" id="7029995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7029998">runtime</span><span class="op" id="7030005">.</span><span class="ident" id="7030006">GC</span><span class="op" id="7030008">(</span><span class="op" id="7030009">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7030013">//&nbsp;Assume&nbsp;these&nbsp;will&nbsp;return&nbsp;same&nbsp;data:&nbsp;no&nbsp;GC&nbsp;during&nbsp;ReadGCStats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030079">ReadGCStats</span><span class="op" id="7030090">(</span><span class="op" id="7030091">&amp;</span><span class="ident" id="7030092">stats</span><span class="op" id="7030097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030100">runtime</span><span class="op" id="7030107">.</span><span class="ident" id="7030108">ReadMemStats</span><span class="op" id="7030120">(</span><span class="op" id="7030121">&amp;</span><span class="ident" id="7030122">mstats</span><span class="op" id="7030128">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7030132">if</span>&nbsp;<span class="ident" id="7030135">stats</span><span class="op" id="7030140">.</span><span class="ident" id="7030141">NumGC</span>&nbsp;<span class="op" id="7030147">!=</span>&nbsp;<span class="ident" id="7030150">int64</span><span class="op" id="7030155">(</span><span class="ident" id="7030156">mstats</span><span class="op" id="7030162">.</span><span class="ident" id="7030163">NumGC</span><span class="op" id="7030168">)</span>&nbsp;<span class="op" id="7030170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030174">t</span><span class="op" id="7030175">.</span><span class="ident" id="7030176">Errorf</span><span class="op" id="7030182">(</span><span class="string" id="7030183">&#34;stats.NumGC&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.NumGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7030224">,</span>&nbsp;<span class="ident" id="7030226">stats</span><span class="op" id="7030231">.</span><span class="ident" id="7030232">NumGC</span><span class="op" id="7030237">,</span>&nbsp;<span class="ident" id="7030239">mstats</span><span class="op" id="7030245">.</span><span class="ident" id="7030246">NumGC</span><span class="op" id="7030251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7030254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7030257">if</span>&nbsp;<span class="ident" id="7030260">stats</span><span class="op" id="7030265">.</span><span class="ident" id="7030266">PauseTotal</span>&nbsp;<span class="op" id="7030277">!=</span>&nbsp;<span class="ident" id="7030280">time</span><span class="op" id="7030284">.</span><span class="ident" id="7030285">Duration</span><span class="op" id="7030293">(</span><span class="ident" id="7030294">mstats</span><span class="op" id="7030300">.</span><span class="ident" id="7030301">PauseTotalNs</span><span class="op" id="7030313">)</span>&nbsp;<span class="op" id="7030315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030319">t</span><span class="op" id="7030320">.</span><span class="ident" id="7030321">Errorf</span><span class="op" id="7030327">(</span><span class="string" id="7030328">&#34;stats.PauseTotal&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.PauseTotalNs&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7030381">,</span>&nbsp;<span class="ident" id="7030383">stats</span><span class="op" id="7030388">.</span><span class="ident" id="7030389">PauseTotal</span><span class="op" id="7030399">,</span>&nbsp;<span class="ident" id="7030401">mstats</span><span class="op" id="7030407">.</span><span class="ident" id="7030408">PauseTotalNs</span><span class="op" id="7030420">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7030423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7030426">if</span>&nbsp;<span class="ident" id="7030429">stats</span><span class="op" id="7030434">.</span><span class="ident" id="7030435">LastGC</span><span class="op" id="7030441">.</span><span class="ident" id="7030442">UnixNano</span><span class="op" id="7030450">(</span><span class="op" id="7030451">)</span>&nbsp;<span class="op" id="7030453">!=</span>&nbsp;<span class="ident" id="7030456">int64</span><span class="op" id="7030461">(</span><span class="ident" id="7030462">mstats</span><span class="op" id="7030468">.</span><span class="ident" id="7030469">LastGC</span><span class="op" id="7030475">)</span>&nbsp;<span class="op" id="7030477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030481">t</span><span class="op" id="7030482">.</span><span class="ident" id="7030483">Errorf</span><span class="op" id="7030489">(</span><span class="string" id="7030490">&#34;stats.LastGC.UnixNano&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.LastGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7030542">,</span>&nbsp;<span class="ident" id="7030544">stats</span><span class="op" id="7030549">.</span><span class="ident" id="7030550">LastGC</span><span class="op" id="7030556">.</span><span class="ident" id="7030557">UnixNano</span><span class="op" id="7030565">(</span><span class="op" id="7030566">)</span><span class="op" id="7030567">,</span>&nbsp;<span class="ident" id="7030569">mstats</span><span class="op" id="7030575">.</span><span class="ident" id="7030576">LastGC</span><span class="op" id="7030582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7030585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030588">n</span>&nbsp;<span class="op" id="7030590">:=</span>&nbsp;<span class="builtintype" id="7030593">int</span><span class="op" id="7030596">(</span><span class="ident" id="7030597">mstats</span><span class="op" id="7030603">.</span><span class="ident" id="7030604">NumGC</span><span class="op" id="7030609">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7030612">if</span>&nbsp;<span class="ident" id="7030615">n</span>&nbsp;<span class="op" id="7030617">&gt;</span>&nbsp;<span class="builtinfunc" id="7030619">len</span><span class="op" id="7030622">(</span><span class="ident" id="7030623">mstats</span><span class="op" id="7030629">.</span><span class="ident" id="7030630">PauseNs</span><span class="op" id="7030637">)</span>&nbsp;<span class="op" id="7030639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030643">n</span>&nbsp;<span class="op" id="7030645">=</span>&nbsp;<span class="builtinfunc" id="7030647">len</span><span class="op" id="7030650">(</span><span class="ident" id="7030651">mstats</span><span class="op" id="7030657">.</span><span class="ident" id="7030658">PauseNs</span><span class="op" id="7030665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7030668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7030671">if</span>&nbsp;<span class="builtinfunc" id="7030674">len</span><span class="op" id="7030677">(</span><span class="ident" id="7030678">stats</span><span class="op" id="7030683">.</span><span class="ident" id="7030684">Pause</span><span class="op" id="7030689">)</span>&nbsp;<span class="op" id="7030691">!=</span>&nbsp;<span class="ident" id="7030694">n</span>&nbsp;<span class="op" id="7030696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030700">t</span><span class="op" id="7030701">.</span><span class="ident" id="7030702">Errorf</span><span class="op" id="7030708">(</span><span class="string" id="7030709">&#34;len(stats.Pause)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7030741">,</span>&nbsp;<span class="builtinfunc" id="7030743">len</span><span class="op" id="7030746">(</span><span class="ident" id="7030747">stats</span><span class="op" id="7030752">.</span><span class="ident" id="7030753">Pause</span><span class="op" id="7030758">)</span><span class="op" id="7030759">,</span>&nbsp;<span class="ident" id="7030761">n</span><span class="op" id="7030762">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7030765">}</span>&nbsp;<span class="keyword" id="7030767">else</span>&nbsp;<span class="op" id="7030772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030776">off</span>&nbsp;<span class="op" id="7030780">:=</span>&nbsp;<span class="op" id="7030783">(</span><span class="builtintype" id="7030784">int</span><span class="op" id="7030787">(</span><span class="ident" id="7030788">mstats</span><span class="op" id="7030794">.</span><span class="ident" id="7030795">NumGC</span><span class="op" id="7030800">)</span>&nbsp;<span class="op" id="7030802">+</span>&nbsp;<span class="builtinfunc" id="7030804">len</span><span class="op" id="7030807">(</span><span class="ident" id="7030808">mstats</span><span class="op" id="7030814">.</span><span class="ident" id="7030815">PauseNs</span><span class="op" id="7030822">)</span>&nbsp;<span class="op" id="7030824">-</span>&nbsp;<span class="num" id="7030826">1</span><span class="op" id="7030827">)</span>&nbsp;<span class="op" id="7030829">%</span>&nbsp;<span class="builtinfunc" id="7030831">len</span><span class="op" id="7030834">(</span><span class="ident" id="7030835">mstats</span><span class="op" id="7030841">.</span><span class="ident" id="7030842">PauseNs</span><span class="op" id="7030849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7030853">for</span>&nbsp;<span class="ident" id="7030857">i</span>&nbsp;<span class="op" id="7030859">:=</span>&nbsp;<span class="num" id="7030862">0</span><span class="op" id="7030863">;</span>&nbsp;<span class="ident" id="7030865">i</span>&nbsp;<span class="op" id="7030867">&lt;</span>&nbsp;<span class="ident" id="7030869">n</span><span class="op" id="7030870">;</span>&nbsp;<span class="ident" id="7030872">i</span><span class="op" id="7030873">++</span>&nbsp;<span class="op" id="7030876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030881">dt</span>&nbsp;<span class="op" id="7030884">:=</span>&nbsp;<span class="ident" id="7030887">stats</span><span class="op" id="7030892">.</span><span class="ident" id="7030893">Pause</span><span class="op" id="7030898">[</span><span class="ident" id="7030899">i</span><span class="op" id="7030900">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7030905">if</span>&nbsp;<span class="ident" id="7030908">dt</span>&nbsp;<span class="op" id="7030911">!=</span>&nbsp;<span class="ident" id="7030914">time</span><span class="op" id="7030918">.</span><span class="ident" id="7030919">Duration</span><span class="op" id="7030927">(</span><span class="ident" id="7030928">mstats</span><span class="op" id="7030934">.</span><span class="ident" id="7030935">PauseNs</span><span class="op" id="7030942">[</span><span class="ident" id="7030943">off</span><span class="op" id="7030946">]</span><span class="op" id="7030947">)</span>&nbsp;<span class="op" id="7030949">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030955">t</span><span class="op" id="7030956">.</span><span class="ident" id="7030957">Errorf</span><span class="op" id="7030963">(</span><span class="string" id="7030964">&#34;stats.Pause[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7030995">,</span>&nbsp;<span class="ident" id="7030997">i</span><span class="op" id="7030998">,</span>&nbsp;<span class="ident" id="7031000">dt</span><span class="op" id="7031002">,</span>&nbsp;<span class="ident" id="7031004">mstats</span><span class="op" id="7031010">.</span><span class="ident" id="7031011">PauseNs</span><span class="op" id="7031018">[</span><span class="ident" id="7031019">off</span><span class="op" id="7031022">]</span><span class="op" id="7031023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031033">if</span>&nbsp;<span class="ident" id="7031036">max</span>&nbsp;<span class="op" id="7031040">&lt;</span>&nbsp;<span class="ident" id="7031042">dt</span>&nbsp;<span class="op" id="7031045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031051">max</span>&nbsp;<span class="op" id="7031055">=</span>&nbsp;<span class="ident" id="7031057">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031063">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031068">if</span>&nbsp;<span class="ident" id="7031071">min</span>&nbsp;<span class="op" id="7031075">&gt;</span>&nbsp;<span class="ident" id="7031077">dt</span>&nbsp;<span class="op" id="7031080">||</span>&nbsp;<span class="ident" id="7031083">i</span>&nbsp;<span class="op" id="7031085">==</span>&nbsp;<span class="num" id="7031088">0</span>&nbsp;<span class="op" id="7031090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031096">min</span>&nbsp;<span class="op" id="7031100">=</span>&nbsp;<span class="ident" id="7031102">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031113">off</span>&nbsp;<span class="op" id="7031117">=</span>&nbsp;<span class="op" id="7031119">(</span><span class="ident" id="7031120">off</span>&nbsp;<span class="op" id="7031124">+</span>&nbsp;<span class="builtinfunc" id="7031126">len</span><span class="op" id="7031129">(</span><span class="ident" id="7031130">mstats</span><span class="op" id="7031136">.</span><span class="ident" id="7031137">PauseNs</span><span class="op" id="7031144">)</span>&nbsp;<span class="op" id="7031146">-</span>&nbsp;<span class="num" id="7031148">1</span><span class="op" id="7031149">)</span>&nbsp;<span class="op" id="7031151">%</span>&nbsp;<span class="builtinfunc" id="7031153">len</span><span class="op" id="7031156">(</span><span class="ident" id="7031157">mstats</span><span class="op" id="7031163">.</span><span class="ident" id="7031164">PauseNs</span><span class="op" id="7031171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031175">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031182">q</span>&nbsp;<span class="op" id="7031184">:=</span>&nbsp;<span class="ident" id="7031187">stats</span><span class="op" id="7031192">.</span><span class="ident" id="7031193">PauseQuantiles</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031209">nq</span>&nbsp;<span class="op" id="7031212">:=</span>&nbsp;<span class="builtinfunc" id="7031215">len</span><span class="op" id="7031218">(</span><span class="ident" id="7031219">q</span><span class="op" id="7031220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031223">if</span>&nbsp;<span class="ident" id="7031226">q</span><span class="op" id="7031227">[</span><span class="num" id="7031228">0</span><span class="op" id="7031229">]</span>&nbsp;<span class="op" id="7031231">!=</span>&nbsp;<span class="ident" id="7031234">min</span>&nbsp;<span class="op" id="7031238">||</span>&nbsp;<span class="ident" id="7031241">q</span><span class="op" id="7031242">[</span><span class="ident" id="7031243">nq</span><span class="op" id="7031245">-</span><span class="num" id="7031246">1</span><span class="op" id="7031247">]</span>&nbsp;<span class="op" id="7031249">!=</span>&nbsp;<span class="ident" id="7031252">max</span>&nbsp;<span class="op" id="7031256">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031260">t</span><span class="op" id="7031261">.</span><span class="ident" id="7031262">Errorf</span><span class="op" id="7031268">(</span><span class="string" id="7031269">&#34;stats.PauseQuantiles&nbsp;=&nbsp;[%d,&nbsp;...,&nbsp;%d],&nbsp;want&nbsp;[%d,&nbsp;...,&nbsp;%d]&#34;</span><span class="op" id="7031327">,</span>&nbsp;<span class="ident" id="7031329">q</span><span class="op" id="7031330">[</span><span class="num" id="7031331">0</span><span class="op" id="7031332">]</span><span class="op" id="7031333">,</span>&nbsp;<span class="ident" id="7031335">q</span><span class="op" id="7031336">[</span><span class="ident" id="7031337">nq</span><span class="op" id="7031339">-</span><span class="num" id="7031340">1</span><span class="op" id="7031341">]</span><span class="op" id="7031342">,</span>&nbsp;<span class="ident" id="7031344">min</span><span class="op" id="7031347">,</span>&nbsp;<span class="ident" id="7031349">max</span><span class="op" id="7031352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031359">for</span>&nbsp;<span class="ident" id="7031363">i</span>&nbsp;<span class="op" id="7031365">:=</span>&nbsp;<span class="num" id="7031368">0</span><span class="op" id="7031369">;</span>&nbsp;<span class="ident" id="7031371">i</span>&nbsp;<span class="op" id="7031373">&lt;</span>&nbsp;<span class="ident" id="7031375">nq</span><span class="op" id="7031377">-</span><span class="num" id="7031378">1</span><span class="op" id="7031379">;</span>&nbsp;<span class="ident" id="7031381">i</span><span class="op" id="7031382">++</span>&nbsp;<span class="op" id="7031385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031389">if</span>&nbsp;<span class="ident" id="7031392">q</span><span class="op" id="7031393">[</span><span class="ident" id="7031394">i</span><span class="op" id="7031395">]</span>&nbsp;<span class="op" id="7031397">&gt;</span>&nbsp;<span class="ident" id="7031399">q</span><span class="op" id="7031400">[</span><span class="ident" id="7031401">i</span><span class="op" id="7031402">+</span><span class="num" id="7031403">1</span><span class="op" id="7031404">]</span>&nbsp;<span class="op" id="7031406">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031411">t</span><span class="op" id="7031412">.</span><span class="ident" id="7031413">Errorf</span><span class="op" id="7031419">(</span><span class="string" id="7031420">&#34;stats.PauseQuantiles[%d]=%d&nbsp;&gt;&nbsp;stats.PauseQuantiles[%d]=%d&#34;</span><span class="op" id="7031479">,</span>&nbsp;<span class="ident" id="7031481">i</span><span class="op" id="7031482">,</span>&nbsp;<span class="ident" id="7031484">q</span><span class="op" id="7031485">[</span><span class="ident" id="7031486">i</span><span class="op" id="7031487">]</span><span class="op" id="7031488">,</span>&nbsp;<span class="ident" id="7031490">i</span><span class="op" id="7031491">+</span><span class="num" id="7031492">1</span><span class="op" id="7031493">,</span>&nbsp;<span class="ident" id="7031495">q</span><span class="op" id="7031496">[</span><span class="ident" id="7031497">i</span><span class="op" id="7031498">+</span><span class="num" id="7031499">1</span><span class="op" id="7031500">]</span><span class="op" id="7031501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7031512">//&nbsp;compare&nbsp;memory&nbsp;stats&nbsp;with&nbsp;gc&nbsp;stats:</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031552">if</span>&nbsp;<span class="builtinfunc" id="7031555">len</span><span class="op" id="7031558">(</span><span class="ident" id="7031559">stats</span><span class="op" id="7031564">.</span><span class="ident" id="7031565">PauseEnd</span><span class="op" id="7031573">)</span>&nbsp;<span class="op" id="7031575">!=</span>&nbsp;<span class="ident" id="7031578">n</span>&nbsp;<span class="op" id="7031580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031584">t</span><span class="op" id="7031585">.</span><span class="ident" id="7031586">Fatalf</span><span class="op" id="7031592">(</span><span class="string" id="7031593">&#34;len(stats.PauseEnd)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7031628">,</span>&nbsp;<span class="builtinfunc" id="7031630">len</span><span class="op" id="7031633">(</span><span class="ident" id="7031634">stats</span><span class="op" id="7031639">.</span><span class="ident" id="7031640">PauseEnd</span><span class="op" id="7031648">)</span><span class="op" id="7031649">,</span>&nbsp;<span class="ident" id="7031651">n</span><span class="op" id="7031652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031658">off</span>&nbsp;<span class="op" id="7031662">:=</span>&nbsp;<span class="op" id="7031665">(</span><span class="builtintype" id="7031666">int</span><span class="op" id="7031669">(</span><span class="ident" id="7031670">mstats</span><span class="op" id="7031676">.</span><span class="ident" id="7031677">NumGC</span><span class="op" id="7031682">)</span>&nbsp;<span class="op" id="7031684">+</span>&nbsp;<span class="builtinfunc" id="7031686">len</span><span class="op" id="7031689">(</span><span class="ident" id="7031690">mstats</span><span class="op" id="7031696">.</span><span class="ident" id="7031697">PauseEnd</span><span class="op" id="7031705">)</span>&nbsp;<span class="op" id="7031707">-</span>&nbsp;<span class="num" id="7031709">1</span><span class="op" id="7031710">)</span>&nbsp;<span class="op" id="7031712">%</span>&nbsp;<span class="builtinfunc" id="7031714">len</span><span class="op" id="7031717">(</span><span class="ident" id="7031718">mstats</span><span class="op" id="7031724">.</span><span class="ident" id="7031725">PauseEnd</span><span class="op" id="7031733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031736">for</span>&nbsp;<span class="ident" id="7031740">i</span>&nbsp;<span class="op" id="7031742">:=</span>&nbsp;<span class="num" id="7031745">0</span><span class="op" id="7031746">;</span>&nbsp;<span class="ident" id="7031748">i</span>&nbsp;<span class="op" id="7031750">&lt;</span>&nbsp;<span class="ident" id="7031752">n</span><span class="op" id="7031753">;</span>&nbsp;<span class="ident" id="7031755">i</span><span class="op" id="7031756">++</span>&nbsp;<span class="op" id="7031759">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031763">dt</span>&nbsp;<span class="op" id="7031766">:=</span>&nbsp;<span class="ident" id="7031769">stats</span><span class="op" id="7031774">.</span><span class="ident" id="7031775">PauseEnd</span><span class="op" id="7031783">[</span><span class="ident" id="7031784">i</span><span class="op" id="7031785">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031789">if</span>&nbsp;<span class="ident" id="7031792">dt</span><span class="op" id="7031794">.</span><span class="ident" id="7031795">UnixNano</span><span class="op" id="7031803">(</span><span class="op" id="7031804">)</span>&nbsp;<span class="op" id="7031806">!=</span>&nbsp;<span class="ident" id="7031809">int64</span><span class="op" id="7031814">(</span><span class="ident" id="7031815">mstats</span><span class="op" id="7031821">.</span><span class="ident" id="7031822">PauseEnd</span><span class="op" id="7031830">[</span><span class="ident" id="7031831">off</span><span class="op" id="7031834">]</span><span class="op" id="7031835">)</span>&nbsp;<span class="op" id="7031837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031842">t</span><span class="op" id="7031843">.</span><span class="ident" id="7031844">Errorf</span><span class="op" id="7031850">(</span><span class="string" id="7031851">&#34;stats.PauseEnd[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7031885">,</span>&nbsp;<span class="ident" id="7031887">i</span><span class="op" id="7031888">,</span>&nbsp;<span class="ident" id="7031890">dt</span><span class="op" id="7031892">,</span>&nbsp;<span class="ident" id="7031894">mstats</span><span class="op" id="7031900">.</span><span class="ident" id="7031901">PauseEnd</span><span class="op" id="7031909">[</span><span class="ident" id="7031910">off</span><span class="op" id="7031913">]</span><span class="op" id="7031914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031922">off</span>&nbsp;<span class="op" id="7031926">=</span>&nbsp;<span class="op" id="7031928">(</span><span class="ident" id="7031929">off</span>&nbsp;<span class="op" id="7031933">+</span>&nbsp;<span class="builtinfunc" id="7031935">len</span><span class="op" id="7031938">(</span><span class="ident" id="7031939">mstats</span><span class="op" id="7031945">.</span><span class="ident" id="7031946">PauseEnd</span><span class="op" id="7031954">)</span>&nbsp;<span class="op" id="7031956">-</span>&nbsp;<span class="num" id="7031958">1</span><span class="op" id="7031959">)</span>&nbsp;<span class="op" id="7031961">%</span>&nbsp;<span class="builtinfunc" id="7031963">len</span><span class="op" id="7031966">(</span><span class="ident" id="7031967">mstats</span><span class="op" id="7031973">.</span><span class="ident" id="7031974">PauseEnd</span><span class="op" id="7031982">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031985">}</span><br>
<span class="lineno"></span><span class="op" id="7031987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7031990">var</span>&nbsp;<span class="ident" id="7031994">big</span>&nbsp;<span class="op" id="7031998">=</span>&nbsp;<span class="builtinfunc" id="7032000">make</span><span class="op" id="7032004">(</span><span class="op" id="7032005">[</span><span class="op" id="7032006">]</span><span class="builtintype" id="7032007">byte</span><span class="op" id="7032011">,</span>&nbsp;<span class="num" id="7032013">1</span><span class="op" id="7032014">&lt;&lt;</span><span class="num" id="7032016">20</span><span class="op" id="7032018">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="7032021">func</span>&nbsp;<span class="ident" id="7032026">TestFreeOSMemory</span><span class="op" id="7032042">(</span><span class="ident" id="7032043">t</span>&nbsp;<span class="op" id="7032045">*</span><span class="ident" id="7032046">testing</span><span class="op" id="7032053">.</span><span class="ident" id="7032054">T</span><span class="op" id="7032055">)</span>&nbsp;<span class="op" id="7032057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7032060">var</span>&nbsp;<span class="ident" id="7032064">ms1</span><span class="op" id="7032067">,</span>&nbsp;<span class="ident" id="7032069">ms2</span>&nbsp;<span class="ident" id="7032073">runtime</span><span class="op" id="7032080">.</span><span class="ident" id="7032081">MemStats</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7032092">if</span>&nbsp;<span class="ident" id="7032095">big</span>&nbsp;<span class="op" id="7032099">==</span>&nbsp;<span class="ident" id="7032102">nil</span>&nbsp;<span class="op" id="7032106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032110">t</span><span class="op" id="7032111">.</span><span class="ident" id="7032112">Skip</span><span class="op" id="7032116">(</span><span class="string" id="7032117">&#34;test&nbsp;is&nbsp;not&nbsp;reliable&nbsp;when&nbsp;run&nbsp;multiple&nbsp;times&#34;</span><span class="op" id="7032163">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7032166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032169">big</span>&nbsp;<span class="op" id="7032173">=</span>&nbsp;<span class="ident" id="7032175">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032180">runtime</span><span class="op" id="7032187">.</span><span class="ident" id="7032188">GC</span><span class="op" id="7032190">(</span><span class="op" id="7032191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032194">runtime</span><span class="op" id="7032201">.</span><span class="ident" id="7032202">ReadMemStats</span><span class="op" id="7032214">(</span><span class="op" id="7032215">&amp;</span><span class="ident" id="7032216">ms1</span><span class="op" id="7032219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032222">FreeOSMemory</span><span class="op" id="7032234">(</span><span class="op" id="7032235">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032238">runtime</span><span class="op" id="7032245">.</span><span class="ident" id="7032246">ReadMemStats</span><span class="op" id="7032258">(</span><span class="op" id="7032259">&amp;</span><span class="ident" id="7032260">ms2</span><span class="op" id="7032263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7032266">if</span>&nbsp;<span class="ident" id="7032269">ms1</span><span class="op" id="7032272">.</span><span class="ident" id="7032273">HeapReleased</span>&nbsp;<span class="op" id="7032286">&gt;=</span>&nbsp;<span class="ident" id="7032289">ms2</span><span class="op" id="7032292">.</span><span class="ident" id="7032293">HeapReleased</span>&nbsp;<span class="op" id="7032306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032310">t</span><span class="op" id="7032311">.</span><span class="ident" id="7032312">Errorf</span><span class="op" id="7032318">(</span><span class="string" id="7032319">&#34;released&nbsp;before=%d;&nbsp;released&nbsp;after=%d;&nbsp;did&nbsp;not&nbsp;go&nbsp;up&#34;</span><span class="op" id="7032373">,</span>&nbsp;<span class="ident" id="7032375">ms1</span><span class="op" id="7032378">.</span><span class="ident" id="7032379">HeapReleased</span><span class="op" id="7032391">,</span>&nbsp;<span class="ident" id="7032393">ms2</span><span class="op" id="7032396">.</span><span class="ident" id="7032397">HeapReleased</span><span class="op" id="7032409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7032412">}</span><br>
<span class="lineno"></span><span class="op" id="7032414">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="7032417">func</span>&nbsp;<span class="ident" id="7032422">TestSetGCPercent</span><span class="op" id="7032438">(</span><span class="ident" id="7032439">t</span>&nbsp;<span class="op" id="7032441">*</span><span class="ident" id="7032442">testing</span><span class="op" id="7032449">.</span><span class="ident" id="7032450">T</span><span class="op" id="7032451">)</span>&nbsp;<span class="op" id="7032453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7032456">//&nbsp;Test&nbsp;that&nbsp;the&nbsp;variable&nbsp;is&nbsp;being&nbsp;set&nbsp;and&nbsp;returned&nbsp;correctly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7032520">//&nbsp;Assume&nbsp;the&nbsp;percentage&nbsp;itself&nbsp;is&nbsp;implemented&nbsp;fine&nbsp;during&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7032584">//&nbsp;which&nbsp;is&nbsp;harder&nbsp;to&nbsp;test.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032613">old</span>&nbsp;<span class="op" id="7032617">:=</span>&nbsp;<span class="ident" id="7032620">SetGCPercent</span><span class="op" id="7032632">(</span><span class="num" id="7032633">123</span><span class="op" id="7032636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7032639">new</span>&nbsp;<span class="op" id="7032643">:=</span>&nbsp;<span class="ident" id="7032646">SetGCPercent</span><span class="op" id="7032658">(</span><span class="ident" id="7032659">old</span><span class="op" id="7032662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7032665">if</span>&nbsp;<span class="builtinfunc" id="7032668">new</span>&nbsp;<span class="op" id="7032672">!=</span>&nbsp;<span class="num" id="7032675">123</span>&nbsp;<span class="op" id="7032679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032683">t</span><span class="op" id="7032684">.</span><span class="ident" id="7032685">Errorf</span><span class="op" id="7032691">(</span><span class="string" id="7032692">&#34;SetGCPercent(123);&nbsp;SetGCPercent(x)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;123&#34;</span><span class="op" id="7032743">,</span>&nbsp;<span class="builtinfunc" id="7032745">new</span><span class="op" id="7032748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7032751">}</span><br>
<span class="lineno">115</span><span class="op" id="7032753">}</span>
</div>
</body>
</html>
