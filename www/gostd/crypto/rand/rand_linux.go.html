<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rand</h2>
<ul>
<li><a href="/gostd/crypto/rand/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand.go.html">rand.go</a></li>
<li><a href="/gostd/crypto/rand/rand_linux.go.html">rand_linux.go</a></li>
<li><a href="/gostd/crypto/rand/rand_test.go.html">rand_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand_unix.go.html">rand_unix.go</a></li>
<li><a href="/gostd/crypto/rand/util.go.html">util.go</a></li>
<li><a href="/gostd/crypto/rand/util_test.go.html">util_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3870917">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3870973">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3871027">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3871078">package</span>&nbsp;<span class="ident" id="3871086">rand</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3871092">import</span>&nbsp;<span class="op" id="3871099">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3871102">&#34;internal/syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3871122">&#34;sync&#34;</span><br>
<span class="lineno">10</span><span class="op" id="3871129">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3871132">func</span>&nbsp;<span class="ident" id="3871137">init</span><span class="op" id="3871141">(</span><span class="op" id="3871142">)</span>&nbsp;<span class="op" id="3871144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871147">altGetRandom</span>&nbsp;<span class="op" id="3871160">=</span>&nbsp;<span class="ident" id="3871162">getRandomLinux</span><br>
<span class="lineno"></span><span class="op" id="3871177">}</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3871180">var</span>&nbsp;<span class="op" id="3871184">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871187">once</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3871198">sync</span><span class="op" id="3871202">.</span><span class="ident" id="3871203">Once</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871209">useSyscall</span>&nbsp;<span class="builtintype" id="3871220">bool</span><br>
<span class="lineno"></span><span class="op" id="3871225">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3871228">func</span>&nbsp;<span class="ident" id="3871233">pickStrategy</span><span class="op" id="3871245">(</span><span class="op" id="3871246">)</span>&nbsp;<span class="op" id="3871248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871251">//&nbsp;Test&nbsp;whether&nbsp;we&nbsp;should&nbsp;use&nbsp;the&nbsp;system&nbsp;call&nbsp;or&nbsp;/dev/urandom.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871315">//&nbsp;We&#39;ll&nbsp;fall&nbsp;back&nbsp;to&nbsp;urandom&nbsp;if:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871350">//&nbsp;-&nbsp;the&nbsp;kernel&nbsp;is&nbsp;too&nbsp;old&nbsp;(before&nbsp;3.17)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871392">//&nbsp;-&nbsp;the&nbsp;machine&nbsp;has&nbsp;no&nbsp;entropy&nbsp;available&nbsp;(early&nbsp;boot&nbsp;+&nbsp;no&nbsp;hardware</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871461">//&nbsp;&nbsp;&nbsp;entropy&nbsp;source?)&nbsp;and&nbsp;we&nbsp;want&nbsp;to&nbsp;avoid&nbsp;blocking&nbsp;later.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871521">var</span>&nbsp;<span class="ident" id="3871525">buf</span>&nbsp;<span class="op" id="3871529">[</span><span class="num" id="3871530">1</span><span class="op" id="3871531">]</span><span class="builtintype" id="3871532">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871538">n</span><span class="op" id="3871539">,</span>&nbsp;<span class="ident" id="3871541">err</span>&nbsp;<span class="op" id="3871545">:=</span>&nbsp;<span class="ident" id="3871548">syscall</span><span class="op" id="3871555">.</span><span class="ident" id="3871556">GetRandom</span><span class="op" id="3871565">(</span><span class="ident" id="3871566">buf</span><span class="op" id="3871569">[</span><span class="op" id="3871570">:</span><span class="op" id="3871571">]</span><span class="op" id="3871572">,</span>&nbsp;<span class="ident" id="3871574">syscall</span><span class="op" id="3871581">.</span><span class="ident" id="3871582">GRND_NONBLOCK</span><span class="op" id="3871595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871598">useSyscall</span>&nbsp;<span class="op" id="3871609">=</span>&nbsp;<span class="ident" id="3871611">n</span>&nbsp;<span class="op" id="3871613">==</span>&nbsp;<span class="num" id="3871616">1</span>&nbsp;<span class="op" id="3871618">&amp;&amp;</span>&nbsp;<span class="ident" id="3871621">err</span>&nbsp;<span class="op" id="3871625">==</span>&nbsp;<span class="ident" id="3871628">nil</span><br>
<span class="lineno">30</span><span class="op" id="3871632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3871635">func</span>&nbsp;<span class="ident" id="3871640">getRandomLinux</span><span class="op" id="3871654">(</span><span class="ident" id="3871655">p</span>&nbsp;<span class="op" id="3871657">[</span><span class="op" id="3871658">]</span><span class="builtintype" id="3871659">byte</span><span class="op" id="3871663">)</span>&nbsp;<span class="op" id="3871665">(</span><span class="ident" id="3871666">ok</span>&nbsp;<span class="builtintype" id="3871669">bool</span><span class="op" id="3871673">)</span>&nbsp;<span class="op" id="3871675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871678">once</span><span class="op" id="3871682">.</span><span class="ident" id="3871683">Do</span><span class="op" id="3871685">(</span><span class="ident" id="3871686">pickStrategy</span><span class="op" id="3871698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871701">if</span>&nbsp;<span class="op" id="3871704">!</span><span class="ident" id="3871705">useSyscall</span>&nbsp;<span class="op" id="3871716">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871720">return</span>&nbsp;<span class="builtintype" id="3871727">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3871734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871737">n</span><span class="op" id="3871738">,</span>&nbsp;<span class="ident" id="3871740">err</span>&nbsp;<span class="op" id="3871744">:=</span>&nbsp;<span class="ident" id="3871747">syscall</span><span class="op" id="3871754">.</span><span class="ident" id="3871755">GetRandom</span><span class="op" id="3871764">(</span><span class="ident" id="3871765">p</span><span class="op" id="3871766">,</span>&nbsp;<span class="num" id="3871768">0</span><span class="op" id="3871769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871772">return</span>&nbsp;<span class="ident" id="3871779">n</span>&nbsp;<span class="op" id="3871781">==</span>&nbsp;<span class="builtinfunc" id="3871784">len</span><span class="op" id="3871787">(</span><span class="ident" id="3871788">p</span><span class="op" id="3871789">)</span>&nbsp;<span class="op" id="3871791">&amp;&amp;</span>&nbsp;<span class="ident" id="3871794">err</span>&nbsp;<span class="op" id="3871798">==</span>&nbsp;<span class="ident" id="3871801">nil</span><br>
<span class="lineno"></span><span class="op" id="3871805">}</span>
</div>
</body>
</html>
