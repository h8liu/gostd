<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1641957">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1642012">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1642066">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1642117">package</span>&nbsp;<span class="ident" id="1642125">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1642134">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;select&nbsp;statements.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1642201">import</span>&nbsp;<span class="string" id="1642208">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1642218">const</span>&nbsp;<span class="op" id="1642224">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642227">debugSelect</span>&nbsp;<span class="op" id="1642239">=</span>&nbsp;<span class="builtintype" id="1642241">false</span><br>
<span class="lineno"></span><span class="op" id="1642247">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="1642250">var</span>&nbsp;<span class="op" id="1642254">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642257">chansendpc</span>&nbsp;<span class="op" id="1642268">=</span>&nbsp;<span class="ident" id="1642270">funcPC</span><span class="op" id="1642276">(</span><span class="ident" id="1642277">chansend</span><span class="op" id="1642285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642288">chanrecvpc</span>&nbsp;<span class="op" id="1642299">=</span>&nbsp;<span class="ident" id="1642301">funcPC</span><span class="op" id="1642307">(</span><span class="ident" id="1642308">chanrecv</span><span class="op" id="1642316">)</span><br>
<span class="lineno"></span><span class="op" id="1642318">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1642321">func</span>&nbsp;<span class="ident" id="1642326">selectsize</span><span class="op" id="1642336">(</span><span class="ident" id="1642337">size</span>&nbsp;<span class="builtintype" id="1642342">uintptr</span><span class="op" id="1642349">)</span>&nbsp;<span class="builtintype" id="1642351">uintptr</span>&nbsp;<span class="op" id="1642359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642362">selsize</span>&nbsp;<span class="op" id="1642370">:=</span>&nbsp;<span class="ident" id="1642373">unsafe</span><span class="op" id="1642379">.</span><span class="ident" id="1642380">Sizeof</span><span class="op" id="1642386">(</span><span class="ident" id="1642387">_select</span><span class="op" id="1642394">{</span><span class="op" id="1642395">}</span><span class="op" id="1642396">)</span>&nbsp;<span class="op" id="1642398">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1642402">(</span><span class="ident" id="1642403">size</span><span class="op" id="1642407">-</span><span class="num" id="1642408">1</span><span class="op" id="1642409">)</span><span class="op" id="1642410">*</span><span class="ident" id="1642411">unsafe</span><span class="op" id="1642417">.</span><span class="ident" id="1642418">Sizeof</span><span class="op" id="1642424">(</span><span class="ident" id="1642425">_select</span><span class="op" id="1642432">{</span><span class="op" id="1642433">}</span><span class="op" id="1642434">.</span><span class="ident" id="1642435">scase</span><span class="op" id="1642440">[</span><span class="num" id="1642441">0</span><span class="op" id="1642442">]</span><span class="op" id="1642443">)</span>&nbsp;<span class="op" id="1642445">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642449">size</span><span class="op" id="1642453">*</span><span class="ident" id="1642454">unsafe</span><span class="op" id="1642460">.</span><span class="ident" id="1642461">Sizeof</span><span class="op" id="1642467">(</span><span class="op" id="1642468">*</span><span class="ident" id="1642469">_select</span><span class="op" id="1642476">{</span><span class="op" id="1642477">}</span><span class="op" id="1642478">.</span><span class="ident" id="1642479">lockorder</span><span class="op" id="1642488">)</span>&nbsp;<span class="op" id="1642490">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642494">size</span><span class="op" id="1642498">*</span><span class="ident" id="1642499">unsafe</span><span class="op" id="1642505">.</span><span class="ident" id="1642506">Sizeof</span><span class="op" id="1642512">(</span><span class="op" id="1642513">*</span><span class="ident" id="1642514">_select</span><span class="op" id="1642521">{</span><span class="op" id="1642522">}</span><span class="op" id="1642523">.</span><span class="ident" id="1642524">pollorder</span><span class="op" id="1642533">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642536">return</span>&nbsp;<span class="ident" id="1642543">round</span><span class="op" id="1642548">(</span><span class="ident" id="1642549">selsize</span><span class="op" id="1642556">,</span>&nbsp;<span class="ident" id="1642558">_Int64Align</span><span class="op" id="1642569">)</span><br>
<span class="lineno"></span><span class="op" id="1642571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1642574">func</span>&nbsp;<span class="ident" id="1642579">newselect</span><span class="op" id="1642588">(</span><span class="ident" id="1642589">sel</span>&nbsp;<span class="op" id="1642593">*</span><span class="ident" id="1642594">_select</span><span class="op" id="1642601">,</span>&nbsp;<span class="ident" id="1642603">selsize</span>&nbsp;<span class="ident" id="1642611">int64</span><span class="op" id="1642616">,</span>&nbsp;<span class="ident" id="1642618">size</span>&nbsp;<span class="builtintype" id="1642623">int32</span><span class="op" id="1642628">)</span>&nbsp;<span class="op" id="1642630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642633">if</span>&nbsp;<span class="ident" id="1642636">selsize</span>&nbsp;<span class="op" id="1642644">!=</span>&nbsp;<span class="ident" id="1642647">int64</span><span class="op" id="1642652">(</span><span class="ident" id="1642653">selectsize</span><span class="op" id="1642663">(</span><span class="builtintype" id="1642664">uintptr</span><span class="op" id="1642671">(</span><span class="ident" id="1642672">size</span><span class="op" id="1642676">)</span><span class="op" id="1642677">)</span><span class="op" id="1642678">)</span>&nbsp;<span class="op" id="1642680">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1642684">print</span><span class="op" id="1642689">(</span><span class="string" id="1642690">&#34;runtime:&nbsp;bad&nbsp;select&nbsp;size&nbsp;&#34;</span><span class="op" id="1642717">,</span>&nbsp;<span class="ident" id="1642719">selsize</span><span class="op" id="1642726">,</span>&nbsp;<span class="string" id="1642728">&#34;,&nbsp;want&nbsp;&#34;</span><span class="op" id="1642737">,</span>&nbsp;<span class="ident" id="1642739">selectsize</span><span class="op" id="1642749">(</span><span class="builtintype" id="1642750">uintptr</span><span class="op" id="1642757">(</span><span class="ident" id="1642758">size</span><span class="op" id="1642762">)</span><span class="op" id="1642763">)</span><span class="op" id="1642764">,</span>&nbsp;<span class="string" id="1642766">&#34;\n&#34;</span><span class="op" id="1642770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642774">gothrow</span><span class="op" id="1642781">(</span><span class="string" id="1642782">&#34;bad&nbsp;select&nbsp;size&#34;</span><span class="op" id="1642799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1642802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642805">sel</span><span class="op" id="1642808">.</span><span class="ident" id="1642809">tcase</span>&nbsp;<span class="op" id="1642815">=</span>&nbsp;<span class="builtintype" id="1642817">uint16</span><span class="op" id="1642823">(</span><span class="ident" id="1642824">size</span><span class="op" id="1642828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642831">sel</span><span class="op" id="1642834">.</span><span class="ident" id="1642835">ncase</span>&nbsp;<span class="op" id="1642841">=</span>&nbsp;<span class="num" id="1642843">0</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642846">sel</span><span class="op" id="1642849">.</span><span class="ident" id="1642850">lockorder</span>&nbsp;<span class="op" id="1642860">=</span>&nbsp;<span class="op" id="1642862">(</span><span class="op" id="1642863">*</span><span class="op" id="1642864">*</span><span class="ident" id="1642865">hchan</span><span class="op" id="1642870">)</span><span class="op" id="1642871">(</span><span class="ident" id="1642872">add</span><span class="op" id="1642875">(</span><span class="ident" id="1642876">unsafe</span><span class="op" id="1642882">.</span><span class="ident" id="1642883">Pointer</span><span class="op" id="1642890">(</span><span class="op" id="1642891">&amp;</span><span class="ident" id="1642892">sel</span><span class="op" id="1642895">.</span><span class="ident" id="1642896">scase</span><span class="op" id="1642901">)</span><span class="op" id="1642902">,</span>&nbsp;<span class="builtintype" id="1642904">uintptr</span><span class="op" id="1642911">(</span><span class="ident" id="1642912">size</span><span class="op" id="1642916">)</span><span class="op" id="1642917">*</span><span class="ident" id="1642918">unsafe</span><span class="op" id="1642924">.</span><span class="ident" id="1642925">Sizeof</span><span class="op" id="1642931">(</span><span class="ident" id="1642932">_select</span><span class="op" id="1642939">{</span><span class="op" id="1642940">}</span><span class="op" id="1642941">.</span><span class="ident" id="1642942">scase</span><span class="op" id="1642947">[</span><span class="num" id="1642948">0</span><span class="op" id="1642949">]</span><span class="op" id="1642950">)</span><span class="op" id="1642951">)</span><span class="op" id="1642952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642955">sel</span><span class="op" id="1642958">.</span><span class="ident" id="1642959">pollorder</span>&nbsp;<span class="op" id="1642969">=</span>&nbsp;<span class="op" id="1642971">(</span><span class="op" id="1642972">*</span><span class="builtintype" id="1642973">uint16</span><span class="op" id="1642979">)</span><span class="op" id="1642980">(</span><span class="ident" id="1642981">add</span><span class="op" id="1642984">(</span><span class="ident" id="1642985">unsafe</span><span class="op" id="1642991">.</span><span class="ident" id="1642992">Pointer</span><span class="op" id="1642999">(</span><span class="ident" id="1643000">sel</span><span class="op" id="1643003">.</span><span class="ident" id="1643004">lockorder</span><span class="op" id="1643013">)</span><span class="op" id="1643014">,</span>&nbsp;<span class="builtintype" id="1643016">uintptr</span><span class="op" id="1643023">(</span><span class="ident" id="1643024">size</span><span class="op" id="1643028">)</span><span class="op" id="1643029">*</span><span class="ident" id="1643030">unsafe</span><span class="op" id="1643036">.</span><span class="ident" id="1643037">Sizeof</span><span class="op" id="1643043">(</span><span class="op" id="1643044">*</span><span class="ident" id="1643045">_select</span><span class="op" id="1643052">{</span><span class="op" id="1643053">}</span><span class="op" id="1643054">.</span><span class="ident" id="1643055">lockorder</span><span class="op" id="1643064">)</span><span class="op" id="1643065">)</span><span class="op" id="1643066">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643070">if</span>&nbsp;<span class="ident" id="1643073">debugSelect</span>&nbsp;<span class="op" id="1643085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1643089">print</span><span class="op" id="1643094">(</span><span class="string" id="1643095">&#34;newselect&nbsp;s=&#34;</span><span class="op" id="1643109">,</span>&nbsp;<span class="ident" id="1643111">sel</span><span class="op" id="1643114">,</span>&nbsp;<span class="string" id="1643116">&#34;&nbsp;size=&#34;</span><span class="op" id="1643124">,</span>&nbsp;<span class="ident" id="1643126">size</span><span class="op" id="1643130">,</span>&nbsp;<span class="string" id="1643132">&#34;\n&#34;</span><span class="op" id="1643136">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643139">}</span><br>
<span class="lineno"></span><span class="op" id="1643141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1643144">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1643157">func</span>&nbsp;<span class="ident" id="1643162">selectsend</span><span class="op" id="1643172">(</span><span class="ident" id="1643173">sel</span>&nbsp;<span class="op" id="1643177">*</span><span class="ident" id="1643178">_select</span><span class="op" id="1643185">,</span>&nbsp;<span class="ident" id="1643187">c</span>&nbsp;<span class="op" id="1643189">*</span><span class="ident" id="1643190">hchan</span><span class="op" id="1643195">,</span>&nbsp;<span class="ident" id="1643197">elem</span>&nbsp;<span class="ident" id="1643202">unsafe</span><span class="op" id="1643208">.</span><span class="ident" id="1643209">Pointer</span><span class="op" id="1643216">)</span>&nbsp;<span class="op" id="1643218">(</span><span class="ident" id="1643219">selected</span>&nbsp;<span class="builtintype" id="1643228">bool</span><span class="op" id="1643232">)</span>&nbsp;<span class="op" id="1643234">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1643237">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643266">if</span>&nbsp;<span class="ident" id="1643269">c</span>&nbsp;<span class="op" id="1643271">!=</span>&nbsp;<span class="ident" id="1643274">nil</span>&nbsp;<span class="op" id="1643278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643282">selectsendImpl</span><span class="op" id="1643296">(</span><span class="ident" id="1643297">sel</span><span class="op" id="1643300">,</span>&nbsp;<span class="ident" id="1643302">c</span><span class="op" id="1643303">,</span>&nbsp;<span class="ident" id="1643305">getcallerpc</span><span class="op" id="1643316">(</span><span class="ident" id="1643317">unsafe</span><span class="op" id="1643323">.</span><span class="ident" id="1643324">Pointer</span><span class="op" id="1643331">(</span><span class="op" id="1643332">&amp;</span><span class="ident" id="1643333">sel</span><span class="op" id="1643336">)</span><span class="op" id="1643337">)</span><span class="op" id="1643338">,</span>&nbsp;<span class="ident" id="1643340">elem</span><span class="op" id="1643344">,</span>&nbsp;<span class="builtintype" id="1643346">uintptr</span><span class="op" id="1643353">(</span><span class="ident" id="1643354">unsafe</span><span class="op" id="1643360">.</span><span class="ident" id="1643361">Pointer</span><span class="op" id="1643368">(</span><span class="op" id="1643369">&amp;</span><span class="ident" id="1643370">selected</span><span class="op" id="1643378">)</span><span class="op" id="1643379">)</span><span class="op" id="1643380">-</span><span class="builtintype" id="1643381">uintptr</span><span class="op" id="1643388">(</span><span class="ident" id="1643389">unsafe</span><span class="op" id="1643395">.</span><span class="ident" id="1643396">Pointer</span><span class="op" id="1643403">(</span><span class="op" id="1643404">&amp;</span><span class="ident" id="1643405">sel</span><span class="op" id="1643408">)</span><span class="op" id="1643409">)</span><span class="op" id="1643410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643416">return</span><br>
<span class="lineno">50</span><span class="op" id="1643423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1643426">//&nbsp;cut&nbsp;in&nbsp;half&nbsp;to&nbsp;give&nbsp;stack&nbsp;a&nbsp;chance&nbsp;to&nbsp;split</span><br>
<span class="lineno"></span><span class="keyword" id="1643473">func</span>&nbsp;<span class="ident" id="1643478">selectsendImpl</span><span class="op" id="1643492">(</span><span class="ident" id="1643493">sel</span>&nbsp;<span class="op" id="1643497">*</span><span class="ident" id="1643498">_select</span><span class="op" id="1643505">,</span>&nbsp;<span class="ident" id="1643507">c</span>&nbsp;<span class="op" id="1643509">*</span><span class="ident" id="1643510">hchan</span><span class="op" id="1643515">,</span>&nbsp;<span class="ident" id="1643517">pc</span>&nbsp;<span class="builtintype" id="1643520">uintptr</span><span class="op" id="1643527">,</span>&nbsp;<span class="ident" id="1643529">elem</span>&nbsp;<span class="ident" id="1643534">unsafe</span><span class="op" id="1643540">.</span><span class="ident" id="1643541">Pointer</span><span class="op" id="1643548">,</span>&nbsp;<span class="ident" id="1643550">so</span>&nbsp;<span class="builtintype" id="1643553">uintptr</span><span class="op" id="1643560">)</span>&nbsp;<span class="op" id="1643562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643565">i</span>&nbsp;<span class="op" id="1643567">:=</span>&nbsp;<span class="ident" id="1643570">sel</span><span class="op" id="1643573">.</span><span class="ident" id="1643574">ncase</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643581">if</span>&nbsp;<span class="ident" id="1643584">i</span>&nbsp;<span class="op" id="1643586">&gt;=</span>&nbsp;<span class="ident" id="1643589">sel</span><span class="op" id="1643592">.</span><span class="ident" id="1643593">tcase</span>&nbsp;<span class="op" id="1643599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643603">gothrow</span><span class="op" id="1643610">(</span><span class="string" id="1643611">&#34;selectsend:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1643639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643645">sel</span><span class="op" id="1643648">.</span><span class="ident" id="1643649">ncase</span>&nbsp;<span class="op" id="1643655">=</span>&nbsp;<span class="ident" id="1643657">i</span>&nbsp;<span class="op" id="1643659">+</span>&nbsp;<span class="num" id="1643661">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643664">cas</span>&nbsp;<span class="op" id="1643668">:=</span>&nbsp;<span class="op" id="1643671">(</span><span class="op" id="1643672">*</span><span class="ident" id="1643673">scase</span><span class="op" id="1643678">)</span><span class="op" id="1643679">(</span><span class="ident" id="1643680">add</span><span class="op" id="1643683">(</span><span class="ident" id="1643684">unsafe</span><span class="op" id="1643690">.</span><span class="ident" id="1643691">Pointer</span><span class="op" id="1643698">(</span><span class="op" id="1643699">&amp;</span><span class="ident" id="1643700">sel</span><span class="op" id="1643703">.</span><span class="ident" id="1643704">scase</span><span class="op" id="1643709">)</span><span class="op" id="1643710">,</span>&nbsp;<span class="builtintype" id="1643712">uintptr</span><span class="op" id="1643719">(</span><span class="ident" id="1643720">i</span><span class="op" id="1643721">)</span><span class="op" id="1643722">*</span><span class="ident" id="1643723">unsafe</span><span class="op" id="1643729">.</span><span class="ident" id="1643730">Sizeof</span><span class="op" id="1643736">(</span><span class="ident" id="1643737">sel</span><span class="op" id="1643740">.</span><span class="ident" id="1643741">scase</span><span class="op" id="1643746">[</span><span class="num" id="1643747">0</span><span class="op" id="1643748">]</span><span class="op" id="1643749">)</span><span class="op" id="1643750">)</span><span class="op" id="1643751">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643755">cas</span><span class="op" id="1643758">.</span><span class="ident" id="1643759">pc</span>&nbsp;<span class="op" id="1643762">=</span>&nbsp;<span class="ident" id="1643764">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643768">cas</span><span class="op" id="1643771">.</span><span class="ident" id="1643772">_chan</span>&nbsp;<span class="op" id="1643778">=</span>&nbsp;<span class="ident" id="1643780">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643783">cas</span><span class="op" id="1643786">.</span><span class="ident" id="1643787">so</span>&nbsp;<span class="op" id="1643790">=</span>&nbsp;<span class="builtintype" id="1643792">uint16</span><span class="op" id="1643798">(</span><span class="ident" id="1643799">so</span><span class="op" id="1643801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643804">cas</span><span class="op" id="1643807">.</span><span class="ident" id="1643808">kind</span>&nbsp;<span class="op" id="1643813">=</span>&nbsp;<span class="ident" id="1643815">_CaseSend</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643826">cas</span><span class="op" id="1643829">.</span><span class="ident" id="1643830">elem</span>&nbsp;<span class="op" id="1643835">=</span>&nbsp;<span class="ident" id="1643837">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643844">if</span>&nbsp;<span class="ident" id="1643847">debugSelect</span>&nbsp;<span class="op" id="1643859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1643863">print</span><span class="op" id="1643868">(</span><span class="string" id="1643869">&#34;selectsend&nbsp;s=&#34;</span><span class="op" id="1643884">,</span>&nbsp;<span class="ident" id="1643886">sel</span><span class="op" id="1643889">,</span>&nbsp;<span class="string" id="1643891">&#34;&nbsp;pc=&#34;</span><span class="op" id="1643897">,</span>&nbsp;<span class="ident" id="1643899">hex</span><span class="op" id="1643902">(</span><span class="ident" id="1643903">cas</span><span class="op" id="1643906">.</span><span class="ident" id="1643907">pc</span><span class="op" id="1643909">)</span><span class="op" id="1643910">,</span>&nbsp;<span class="string" id="1643912">&#34;&nbsp;chan=&#34;</span><span class="op" id="1643920">,</span>&nbsp;<span class="ident" id="1643922">cas</span><span class="op" id="1643925">.</span><span class="ident" id="1643926">_chan</span><span class="op" id="1643931">,</span>&nbsp;<span class="string" id="1643933">&#34;&nbsp;so=&#34;</span><span class="op" id="1643939">,</span>&nbsp;<span class="ident" id="1643941">cas</span><span class="op" id="1643944">.</span><span class="ident" id="1643945">so</span><span class="op" id="1643947">,</span>&nbsp;<span class="string" id="1643949">&#34;\n&#34;</span><span class="op" id="1643953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643956">}</span><br>
<span class="lineno">70</span><span class="op" id="1643958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1643961">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1643974">func</span>&nbsp;<span class="ident" id="1643979">selectrecv</span><span class="op" id="1643989">(</span><span class="ident" id="1643990">sel</span>&nbsp;<span class="op" id="1643994">*</span><span class="ident" id="1643995">_select</span><span class="op" id="1644002">,</span>&nbsp;<span class="ident" id="1644004">c</span>&nbsp;<span class="op" id="1644006">*</span><span class="ident" id="1644007">hchan</span><span class="op" id="1644012">,</span>&nbsp;<span class="ident" id="1644014">elem</span>&nbsp;<span class="ident" id="1644019">unsafe</span><span class="op" id="1644025">.</span><span class="ident" id="1644026">Pointer</span><span class="op" id="1644033">)</span>&nbsp;<span class="op" id="1644035">(</span><span class="ident" id="1644036">selected</span>&nbsp;<span class="builtintype" id="1644045">bool</span><span class="op" id="1644049">)</span>&nbsp;<span class="op" id="1644051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1644054">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644083">if</span>&nbsp;<span class="ident" id="1644086">c</span>&nbsp;<span class="op" id="1644088">!=</span>&nbsp;<span class="ident" id="1644091">nil</span>&nbsp;<span class="op" id="1644095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644099">selectrecvImpl</span><span class="op" id="1644113">(</span><span class="ident" id="1644114">sel</span><span class="op" id="1644117">,</span>&nbsp;<span class="ident" id="1644119">c</span><span class="op" id="1644120">,</span>&nbsp;<span class="ident" id="1644122">getcallerpc</span><span class="op" id="1644133">(</span><span class="ident" id="1644134">unsafe</span><span class="op" id="1644140">.</span><span class="ident" id="1644141">Pointer</span><span class="op" id="1644148">(</span><span class="op" id="1644149">&amp;</span><span class="ident" id="1644150">sel</span><span class="op" id="1644153">)</span><span class="op" id="1644154">)</span><span class="op" id="1644155">,</span>&nbsp;<span class="ident" id="1644157">elem</span><span class="op" id="1644161">,</span>&nbsp;<span class="ident" id="1644163">nil</span><span class="op" id="1644166">,</span>&nbsp;<span class="builtintype" id="1644168">uintptr</span><span class="op" id="1644175">(</span><span class="ident" id="1644176">unsafe</span><span class="op" id="1644182">.</span><span class="ident" id="1644183">Pointer</span><span class="op" id="1644190">(</span><span class="op" id="1644191">&amp;</span><span class="ident" id="1644192">selected</span><span class="op" id="1644200">)</span><span class="op" id="1644201">)</span><span class="op" id="1644202">-</span><span class="builtintype" id="1644203">uintptr</span><span class="op" id="1644210">(</span><span class="ident" id="1644211">unsafe</span><span class="op" id="1644217">.</span><span class="ident" id="1644218">Pointer</span><span class="op" id="1644225">(</span><span class="op" id="1644226">&amp;</span><span class="ident" id="1644227">sel</span><span class="op" id="1644230">)</span><span class="op" id="1644231">)</span><span class="op" id="1644232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1644235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644238">return</span><br>
<span class="lineno"></span><span class="op" id="1644245">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="comment" id="1644248">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1644261">func</span>&nbsp;<span class="ident" id="1644266">selectrecv2</span><span class="op" id="1644277">(</span><span class="ident" id="1644278">sel</span>&nbsp;<span class="op" id="1644282">*</span><span class="ident" id="1644283">_select</span><span class="op" id="1644290">,</span>&nbsp;<span class="ident" id="1644292">c</span>&nbsp;<span class="op" id="1644294">*</span><span class="ident" id="1644295">hchan</span><span class="op" id="1644300">,</span>&nbsp;<span class="ident" id="1644302">elem</span>&nbsp;<span class="ident" id="1644307">unsafe</span><span class="op" id="1644313">.</span><span class="ident" id="1644314">Pointer</span><span class="op" id="1644321">,</span>&nbsp;<span class="ident" id="1644323">received</span>&nbsp;<span class="op" id="1644332">*</span><span class="builtintype" id="1644333">bool</span><span class="op" id="1644337">)</span>&nbsp;<span class="op" id="1644339">(</span><span class="ident" id="1644340">selected</span>&nbsp;<span class="builtintype" id="1644349">bool</span><span class="op" id="1644353">)</span>&nbsp;<span class="op" id="1644355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1644358">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644387">if</span>&nbsp;<span class="ident" id="1644390">c</span>&nbsp;<span class="op" id="1644392">!=</span>&nbsp;<span class="ident" id="1644395">nil</span>&nbsp;<span class="op" id="1644399">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644403">selectrecvImpl</span><span class="op" id="1644417">(</span><span class="ident" id="1644418">sel</span><span class="op" id="1644421">,</span>&nbsp;<span class="ident" id="1644423">c</span><span class="op" id="1644424">,</span>&nbsp;<span class="ident" id="1644426">getcallerpc</span><span class="op" id="1644437">(</span><span class="ident" id="1644438">unsafe</span><span class="op" id="1644444">.</span><span class="ident" id="1644445">Pointer</span><span class="op" id="1644452">(</span><span class="op" id="1644453">&amp;</span><span class="ident" id="1644454">sel</span><span class="op" id="1644457">)</span><span class="op" id="1644458">)</span><span class="op" id="1644459">,</span>&nbsp;<span class="ident" id="1644461">elem</span><span class="op" id="1644465">,</span>&nbsp;<span class="ident" id="1644467">received</span><span class="op" id="1644475">,</span>&nbsp;<span class="builtintype" id="1644477">uintptr</span><span class="op" id="1644484">(</span><span class="ident" id="1644485">unsafe</span><span class="op" id="1644491">.</span><span class="ident" id="1644492">Pointer</span><span class="op" id="1644499">(</span><span class="op" id="1644500">&amp;</span><span class="ident" id="1644501">selected</span><span class="op" id="1644509">)</span><span class="op" id="1644510">)</span><span class="op" id="1644511">-</span><span class="builtintype" id="1644512">uintptr</span><span class="op" id="1644519">(</span><span class="ident" id="1644520">unsafe</span><span class="op" id="1644526">.</span><span class="ident" id="1644527">Pointer</span><span class="op" id="1644534">(</span><span class="op" id="1644535">&amp;</span><span class="ident" id="1644536">sel</span><span class="op" id="1644539">)</span><span class="op" id="1644540">)</span><span class="op" id="1644541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1644544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644547">return</span><br>
<span class="lineno"></span><span class="op" id="1644554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="1644557">func</span>&nbsp;<span class="ident" id="1644562">selectrecvImpl</span><span class="op" id="1644576">(</span><span class="ident" id="1644577">sel</span>&nbsp;<span class="op" id="1644581">*</span><span class="ident" id="1644582">_select</span><span class="op" id="1644589">,</span>&nbsp;<span class="ident" id="1644591">c</span>&nbsp;<span class="op" id="1644593">*</span><span class="ident" id="1644594">hchan</span><span class="op" id="1644599">,</span>&nbsp;<span class="ident" id="1644601">pc</span>&nbsp;<span class="builtintype" id="1644604">uintptr</span><span class="op" id="1644611">,</span>&nbsp;<span class="ident" id="1644613">elem</span>&nbsp;<span class="ident" id="1644618">unsafe</span><span class="op" id="1644624">.</span><span class="ident" id="1644625">Pointer</span><span class="op" id="1644632">,</span>&nbsp;<span class="ident" id="1644634">received</span>&nbsp;<span class="op" id="1644643">*</span><span class="builtintype" id="1644644">bool</span><span class="op" id="1644648">,</span>&nbsp;<span class="ident" id="1644650">so</span>&nbsp;<span class="builtintype" id="1644653">uintptr</span><span class="op" id="1644660">)</span>&nbsp;<span class="op" id="1644662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644665">i</span>&nbsp;<span class="op" id="1644667">:=</span>&nbsp;<span class="ident" id="1644670">sel</span><span class="op" id="1644673">.</span><span class="ident" id="1644674">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644681">if</span>&nbsp;<span class="ident" id="1644684">i</span>&nbsp;<span class="op" id="1644686">&gt;=</span>&nbsp;<span class="ident" id="1644689">sel</span><span class="op" id="1644692">.</span><span class="ident" id="1644693">tcase</span>&nbsp;<span class="op" id="1644699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644703">gothrow</span><span class="op" id="1644710">(</span><span class="string" id="1644711">&#34;selectrecv:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1644739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1644742">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644745">sel</span><span class="op" id="1644748">.</span><span class="ident" id="1644749">ncase</span>&nbsp;<span class="op" id="1644755">=</span>&nbsp;<span class="ident" id="1644757">i</span>&nbsp;<span class="op" id="1644759">+</span>&nbsp;<span class="num" id="1644761">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644764">cas</span>&nbsp;<span class="op" id="1644768">:=</span>&nbsp;<span class="op" id="1644771">(</span><span class="op" id="1644772">*</span><span class="ident" id="1644773">scase</span><span class="op" id="1644778">)</span><span class="op" id="1644779">(</span><span class="ident" id="1644780">add</span><span class="op" id="1644783">(</span><span class="ident" id="1644784">unsafe</span><span class="op" id="1644790">.</span><span class="ident" id="1644791">Pointer</span><span class="op" id="1644798">(</span><span class="op" id="1644799">&amp;</span><span class="ident" id="1644800">sel</span><span class="op" id="1644803">.</span><span class="ident" id="1644804">scase</span><span class="op" id="1644809">)</span><span class="op" id="1644810">,</span>&nbsp;<span class="builtintype" id="1644812">uintptr</span><span class="op" id="1644819">(</span><span class="ident" id="1644820">i</span><span class="op" id="1644821">)</span><span class="op" id="1644822">*</span><span class="ident" id="1644823">unsafe</span><span class="op" id="1644829">.</span><span class="ident" id="1644830">Sizeof</span><span class="op" id="1644836">(</span><span class="ident" id="1644837">sel</span><span class="op" id="1644840">.</span><span class="ident" id="1644841">scase</span><span class="op" id="1644846">[</span><span class="num" id="1644847">0</span><span class="op" id="1644848">]</span><span class="op" id="1644849">)</span><span class="op" id="1644850">)</span><span class="op" id="1644851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644854">cas</span><span class="op" id="1644857">.</span><span class="ident" id="1644858">pc</span>&nbsp;<span class="op" id="1644861">=</span>&nbsp;<span class="ident" id="1644863">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644867">cas</span><span class="op" id="1644870">.</span><span class="ident" id="1644871">_chan</span>&nbsp;<span class="op" id="1644877">=</span>&nbsp;<span class="ident" id="1644879">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644882">cas</span><span class="op" id="1644885">.</span><span class="ident" id="1644886">so</span>&nbsp;<span class="op" id="1644889">=</span>&nbsp;<span class="builtintype" id="1644891">uint16</span><span class="op" id="1644897">(</span><span class="ident" id="1644898">so</span><span class="op" id="1644900">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644903">cas</span><span class="op" id="1644906">.</span><span class="ident" id="1644907">kind</span>&nbsp;<span class="op" id="1644912">=</span>&nbsp;<span class="ident" id="1644914">_CaseRecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644925">cas</span><span class="op" id="1644928">.</span><span class="ident" id="1644929">elem</span>&nbsp;<span class="op" id="1644934">=</span>&nbsp;<span class="ident" id="1644936">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644942">cas</span><span class="op" id="1644945">.</span><span class="ident" id="1644946">receivedp</span>&nbsp;<span class="op" id="1644956">=</span>&nbsp;<span class="ident" id="1644958">received</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644969">if</span>&nbsp;<span class="ident" id="1644972">debugSelect</span>&nbsp;<span class="op" id="1644984">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1644988">print</span><span class="op" id="1644993">(</span><span class="string" id="1644994">&#34;selectrecv&nbsp;s=&#34;</span><span class="op" id="1645009">,</span>&nbsp;<span class="ident" id="1645011">sel</span><span class="op" id="1645014">,</span>&nbsp;<span class="string" id="1645016">&#34;&nbsp;pc=&#34;</span><span class="op" id="1645022">,</span>&nbsp;<span class="ident" id="1645024">hex</span><span class="op" id="1645027">(</span><span class="ident" id="1645028">cas</span><span class="op" id="1645031">.</span><span class="ident" id="1645032">pc</span><span class="op" id="1645034">)</span><span class="op" id="1645035">,</span>&nbsp;<span class="string" id="1645037">&#34;&nbsp;chan=&#34;</span><span class="op" id="1645045">,</span>&nbsp;<span class="ident" id="1645047">cas</span><span class="op" id="1645050">.</span><span class="ident" id="1645051">_chan</span><span class="op" id="1645056">,</span>&nbsp;<span class="string" id="1645058">&#34;&nbsp;so=&#34;</span><span class="op" id="1645064">,</span>&nbsp;<span class="ident" id="1645066">cas</span><span class="op" id="1645069">.</span><span class="ident" id="1645070">so</span><span class="op" id="1645072">,</span>&nbsp;<span class="string" id="1645074">&#34;\n&#34;</span><span class="op" id="1645078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1645081">}</span><br>
<span class="lineno"></span><span class="op" id="1645083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1645086">//go:nosplit</span><br>
<span class="lineno">110</span><span class="keyword" id="1645099">func</span>&nbsp;<span class="ident" id="1645104">selectdefault</span><span class="op" id="1645117">(</span><span class="ident" id="1645118">sel</span>&nbsp;<span class="op" id="1645122">*</span><span class="ident" id="1645123">_select</span><span class="op" id="1645130">)</span>&nbsp;<span class="op" id="1645132">(</span><span class="ident" id="1645133">selected</span>&nbsp;<span class="builtintype" id="1645142">bool</span><span class="op" id="1645146">)</span>&nbsp;<span class="op" id="1645148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645151">selectdefaultImpl</span><span class="op" id="1645168">(</span><span class="ident" id="1645169">sel</span><span class="op" id="1645172">,</span>&nbsp;<span class="ident" id="1645174">getcallerpc</span><span class="op" id="1645185">(</span><span class="ident" id="1645186">unsafe</span><span class="op" id="1645192">.</span><span class="ident" id="1645193">Pointer</span><span class="op" id="1645200">(</span><span class="op" id="1645201">&amp;</span><span class="ident" id="1645202">sel</span><span class="op" id="1645205">)</span><span class="op" id="1645206">)</span><span class="op" id="1645207">,</span>&nbsp;<span class="builtintype" id="1645209">uintptr</span><span class="op" id="1645216">(</span><span class="ident" id="1645217">unsafe</span><span class="op" id="1645223">.</span><span class="ident" id="1645224">Pointer</span><span class="op" id="1645231">(</span><span class="op" id="1645232">&amp;</span><span class="ident" id="1645233">selected</span><span class="op" id="1645241">)</span><span class="op" id="1645242">)</span><span class="op" id="1645243">-</span><span class="builtintype" id="1645244">uintptr</span><span class="op" id="1645251">(</span><span class="ident" id="1645252">unsafe</span><span class="op" id="1645258">.</span><span class="ident" id="1645259">Pointer</span><span class="op" id="1645266">(</span><span class="op" id="1645267">&amp;</span><span class="ident" id="1645268">sel</span><span class="op" id="1645271">)</span><span class="op" id="1645272">)</span><span class="op" id="1645273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1645276">return</span><br>
<span class="lineno"></span><span class="op" id="1645283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="1645286">func</span>&nbsp;<span class="ident" id="1645291">selectdefaultImpl</span><span class="op" id="1645308">(</span><span class="ident" id="1645309">sel</span>&nbsp;<span class="op" id="1645313">*</span><span class="ident" id="1645314">_select</span><span class="op" id="1645321">,</span>&nbsp;<span class="ident" id="1645323">callerpc</span>&nbsp;<span class="builtintype" id="1645332">uintptr</span><span class="op" id="1645339">,</span>&nbsp;<span class="ident" id="1645341">so</span>&nbsp;<span class="builtintype" id="1645344">uintptr</span><span class="op" id="1645351">)</span>&nbsp;<span class="op" id="1645353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645356">i</span>&nbsp;<span class="op" id="1645358">:=</span>&nbsp;<span class="ident" id="1645361">sel</span><span class="op" id="1645364">.</span><span class="ident" id="1645365">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1645372">if</span>&nbsp;<span class="ident" id="1645375">i</span>&nbsp;<span class="op" id="1645377">&gt;=</span>&nbsp;<span class="ident" id="1645380">sel</span><span class="op" id="1645383">.</span><span class="ident" id="1645384">tcase</span>&nbsp;<span class="op" id="1645390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645394">gothrow</span><span class="op" id="1645401">(</span><span class="string" id="1645402">&#34;selectdefault:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1645433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1645436">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645439">sel</span><span class="op" id="1645442">.</span><span class="ident" id="1645443">ncase</span>&nbsp;<span class="op" id="1645449">=</span>&nbsp;<span class="ident" id="1645451">i</span>&nbsp;<span class="op" id="1645453">+</span>&nbsp;<span class="num" id="1645455">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645458">cas</span>&nbsp;<span class="op" id="1645462">:=</span>&nbsp;<span class="op" id="1645465">(</span><span class="op" id="1645466">*</span><span class="ident" id="1645467">scase</span><span class="op" id="1645472">)</span><span class="op" id="1645473">(</span><span class="ident" id="1645474">add</span><span class="op" id="1645477">(</span><span class="ident" id="1645478">unsafe</span><span class="op" id="1645484">.</span><span class="ident" id="1645485">Pointer</span><span class="op" id="1645492">(</span><span class="op" id="1645493">&amp;</span><span class="ident" id="1645494">sel</span><span class="op" id="1645497">.</span><span class="ident" id="1645498">scase</span><span class="op" id="1645503">)</span><span class="op" id="1645504">,</span>&nbsp;<span class="builtintype" id="1645506">uintptr</span><span class="op" id="1645513">(</span><span class="ident" id="1645514">i</span><span class="op" id="1645515">)</span><span class="op" id="1645516">*</span><span class="ident" id="1645517">unsafe</span><span class="op" id="1645523">.</span><span class="ident" id="1645524">Sizeof</span><span class="op" id="1645530">(</span><span class="ident" id="1645531">sel</span><span class="op" id="1645534">.</span><span class="ident" id="1645535">scase</span><span class="op" id="1645540">[</span><span class="num" id="1645541">0</span><span class="op" id="1645542">]</span><span class="op" id="1645543">)</span><span class="op" id="1645544">)</span><span class="op" id="1645545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645548">cas</span><span class="op" id="1645551">.</span><span class="ident" id="1645552">pc</span>&nbsp;<span class="op" id="1645555">=</span>&nbsp;<span class="ident" id="1645557">callerpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645567">cas</span><span class="op" id="1645570">.</span><span class="ident" id="1645571">_chan</span>&nbsp;<span class="op" id="1645577">=</span>&nbsp;<span class="ident" id="1645579">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645584">cas</span><span class="op" id="1645587">.</span><span class="ident" id="1645588">so</span>&nbsp;<span class="op" id="1645591">=</span>&nbsp;<span class="builtintype" id="1645593">uint16</span><span class="op" id="1645599">(</span><span class="ident" id="1645600">so</span><span class="op" id="1645602">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645605">cas</span><span class="op" id="1645608">.</span><span class="ident" id="1645609">kind</span>&nbsp;<span class="op" id="1645614">=</span>&nbsp;<span class="ident" id="1645616">_CaseDefault</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1645631">if</span>&nbsp;<span class="ident" id="1645634">debugSelect</span>&nbsp;<span class="op" id="1645646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1645650">print</span><span class="op" id="1645655">(</span><span class="string" id="1645656">&#34;selectdefault&nbsp;s=&#34;</span><span class="op" id="1645674">,</span>&nbsp;<span class="ident" id="1645676">sel</span><span class="op" id="1645679">,</span>&nbsp;<span class="string" id="1645681">&#34;&nbsp;pc=&#34;</span><span class="op" id="1645687">,</span>&nbsp;<span class="ident" id="1645689">hex</span><span class="op" id="1645692">(</span><span class="ident" id="1645693">cas</span><span class="op" id="1645696">.</span><span class="ident" id="1645697">pc</span><span class="op" id="1645699">)</span><span class="op" id="1645700">,</span>&nbsp;<span class="string" id="1645702">&#34;&nbsp;so=&#34;</span><span class="op" id="1645708">,</span>&nbsp;<span class="ident" id="1645710">cas</span><span class="op" id="1645713">.</span><span class="ident" id="1645714">so</span><span class="op" id="1645716">,</span>&nbsp;<span class="string" id="1645718">&#34;\n&#34;</span><span class="op" id="1645722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1645725">}</span><br>
<span class="lineno">130</span><span class="op" id="1645727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1645730">func</span>&nbsp;<span class="ident" id="1645735">sellock</span><span class="op" id="1645742">(</span><span class="ident" id="1645743">sel</span>&nbsp;<span class="op" id="1645747">*</span><span class="ident" id="1645748">_select</span><span class="op" id="1645755">)</span>&nbsp;<span class="op" id="1645757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645760">lockslice</span>&nbsp;<span class="op" id="1645770">:=</span>&nbsp;<span class="ident" id="1645773">sliceStruct</span><span class="op" id="1645784">{</span><span class="ident" id="1645785">unsafe</span><span class="op" id="1645791">.</span><span class="ident" id="1645792">Pointer</span><span class="op" id="1645799">(</span><span class="ident" id="1645800">sel</span><span class="op" id="1645803">.</span><span class="ident" id="1645804">lockorder</span><span class="op" id="1645813">)</span><span class="op" id="1645814">,</span>&nbsp;<span class="builtintype" id="1645816">int</span><span class="op" id="1645819">(</span><span class="ident" id="1645820">sel</span><span class="op" id="1645823">.</span><span class="ident" id="1645824">ncase</span><span class="op" id="1645829">)</span><span class="op" id="1645830">,</span>&nbsp;<span class="builtintype" id="1645832">int</span><span class="op" id="1645835">(</span><span class="ident" id="1645836">sel</span><span class="op" id="1645839">.</span><span class="ident" id="1645840">ncase</span><span class="op" id="1645845">)</span><span class="op" id="1645846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645849">lockorder</span>&nbsp;<span class="op" id="1645859">:=</span>&nbsp;<span class="op" id="1645862">*</span><span class="op" id="1645863">(</span><span class="op" id="1645864">*</span><span class="op" id="1645865">[</span><span class="op" id="1645866">]</span><span class="op" id="1645867">*</span><span class="ident" id="1645868">hchan</span><span class="op" id="1645873">)</span><span class="op" id="1645874">(</span><span class="ident" id="1645875">unsafe</span><span class="op" id="1645881">.</span><span class="ident" id="1645882">Pointer</span><span class="op" id="1645889">(</span><span class="op" id="1645890">&amp;</span><span class="ident" id="1645891">lockslice</span><span class="op" id="1645900">)</span><span class="op" id="1645901">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1645904">var</span>&nbsp;<span class="ident" id="1645908">c</span>&nbsp;<span class="op" id="1645910">*</span><span class="ident" id="1645911">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1645918">for</span>&nbsp;<span class="ident" id="1645922">_</span><span class="op" id="1645923">,</span>&nbsp;<span class="ident" id="1645925">c0</span>&nbsp;<span class="op" id="1645928">:=</span>&nbsp;<span class="keyword" id="1645931">range</span>&nbsp;<span class="ident" id="1645937">lockorder</span>&nbsp;<span class="op" id="1645947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1645951">if</span>&nbsp;<span class="ident" id="1645954">c0</span>&nbsp;<span class="op" id="1645957">!=</span>&nbsp;<span class="ident" id="1645960">nil</span>&nbsp;<span class="op" id="1645964">&amp;&amp;</span>&nbsp;<span class="ident" id="1645967">c0</span>&nbsp;<span class="op" id="1645970">!=</span>&nbsp;<span class="ident" id="1645973">c</span>&nbsp;<span class="op" id="1645975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645980">c</span>&nbsp;<span class="op" id="1645982">=</span>&nbsp;<span class="ident" id="1645984">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645990">lock</span><span class="op" id="1645994">(</span><span class="op" id="1645995">&amp;</span><span class="ident" id="1645996">c</span><span class="op" id="1645997">.</span><span class="ident" id="1645998">lock</span><span class="op" id="1646002">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1646006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1646009">}</span><br>
<span class="lineno"></span><span class="op" id="1646011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1646014">func</span>&nbsp;<span class="ident" id="1646019">selunlock</span><span class="op" id="1646028">(</span><span class="ident" id="1646029">sel</span>&nbsp;<span class="op" id="1646033">*</span><span class="ident" id="1646034">_select</span><span class="op" id="1646041">)</span>&nbsp;<span class="op" id="1646043">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1646046">//&nbsp;We&nbsp;must&nbsp;be&nbsp;very&nbsp;careful&nbsp;here&nbsp;to&nbsp;not&nbsp;touch&nbsp;sel&nbsp;after&nbsp;we&nbsp;have&nbsp;unlocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1646119">//&nbsp;the&nbsp;last&nbsp;lock,&nbsp;because&nbsp;sel&nbsp;can&nbsp;be&nbsp;freed&nbsp;right&nbsp;after&nbsp;the&nbsp;last&nbsp;unlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1646192">//&nbsp;Consider&nbsp;the&nbsp;following&nbsp;situation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1646230">//&nbsp;First&nbsp;M&nbsp;calls&nbsp;runtime·park()&nbsp;in&nbsp;runtime·selectgo()&nbsp;passing&nbsp;the&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1646304">//&nbsp;Once&nbsp;runtime·park()&nbsp;has&nbsp;unlocked&nbsp;the&nbsp;last&nbsp;lock,&nbsp;another&nbsp;M&nbsp;makes</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1646373">//&nbsp;the&nbsp;G&nbsp;that&nbsp;calls&nbsp;select&nbsp;runnable&nbsp;again&nbsp;and&nbsp;schedules&nbsp;it&nbsp;for&nbsp;execution.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1646448">//&nbsp;When&nbsp;the&nbsp;G&nbsp;runs&nbsp;on&nbsp;another&nbsp;M,&nbsp;it&nbsp;locks&nbsp;all&nbsp;the&nbsp;locks&nbsp;and&nbsp;frees&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1646520">//&nbsp;Now&nbsp;if&nbsp;the&nbsp;first&nbsp;M&nbsp;touches&nbsp;sel,&nbsp;it&nbsp;will&nbsp;access&nbsp;freed&nbsp;memory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646585">n</span>&nbsp;<span class="op" id="1646587">:=</span>&nbsp;<span class="builtintype" id="1646590">int</span><span class="op" id="1646593">(</span><span class="ident" id="1646594">sel</span><span class="op" id="1646597">.</span><span class="ident" id="1646598">ncase</span><span class="op" id="1646603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646606">r</span>&nbsp;<span class="op" id="1646608">:=</span>&nbsp;<span class="num" id="1646611">0</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646614">lockslice</span>&nbsp;<span class="op" id="1646624">:=</span>&nbsp;<span class="ident" id="1646627">sliceStruct</span><span class="op" id="1646638">{</span><span class="ident" id="1646639">unsafe</span><span class="op" id="1646645">.</span><span class="ident" id="1646646">Pointer</span><span class="op" id="1646653">(</span><span class="ident" id="1646654">sel</span><span class="op" id="1646657">.</span><span class="ident" id="1646658">lockorder</span><span class="op" id="1646667">)</span><span class="op" id="1646668">,</span>&nbsp;<span class="ident" id="1646670">n</span><span class="op" id="1646671">,</span>&nbsp;<span class="ident" id="1646673">n</span><span class="op" id="1646674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646677">lockorder</span>&nbsp;<span class="op" id="1646687">:=</span>&nbsp;<span class="op" id="1646690">*</span><span class="op" id="1646691">(</span><span class="op" id="1646692">*</span><span class="op" id="1646693">[</span><span class="op" id="1646694">]</span><span class="op" id="1646695">*</span><span class="ident" id="1646696">hchan</span><span class="op" id="1646701">)</span><span class="op" id="1646702">(</span><span class="ident" id="1646703">unsafe</span><span class="op" id="1646709">.</span><span class="ident" id="1646710">Pointer</span><span class="op" id="1646717">(</span><span class="op" id="1646718">&amp;</span><span class="ident" id="1646719">lockslice</span><span class="op" id="1646728">)</span><span class="op" id="1646729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1646732">//&nbsp;skip&nbsp;the&nbsp;default&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1646758">if</span>&nbsp;<span class="ident" id="1646761">n</span>&nbsp;<span class="op" id="1646763">&gt;</span>&nbsp;<span class="num" id="1646765">0</span>&nbsp;<span class="op" id="1646767">&amp;&amp;</span>&nbsp;<span class="ident" id="1646770">lockorder</span><span class="op" id="1646779">[</span><span class="num" id="1646780">0</span><span class="op" id="1646781">]</span>&nbsp;<span class="op" id="1646783">==</span>&nbsp;<span class="ident" id="1646786">nil</span>&nbsp;<span class="op" id="1646790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646794">r</span>&nbsp;<span class="op" id="1646796">=</span>&nbsp;<span class="num" id="1646798">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1646801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1646804">for</span>&nbsp;<span class="ident" id="1646808">i</span>&nbsp;<span class="op" id="1646810">:=</span>&nbsp;<span class="ident" id="1646813">n</span>&nbsp;<span class="op" id="1646815">-</span>&nbsp;<span class="num" id="1646817">1</span><span class="op" id="1646818">;</span>&nbsp;<span class="ident" id="1646820">i</span>&nbsp;<span class="op" id="1646822">&gt;=</span>&nbsp;<span class="ident" id="1646825">r</span><span class="op" id="1646826">;</span>&nbsp;<span class="ident" id="1646828">i</span><span class="op" id="1646829">--</span>&nbsp;<span class="op" id="1646832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646836">c</span>&nbsp;<span class="op" id="1646838">:=</span>&nbsp;<span class="ident" id="1646841">lockorder</span><span class="op" id="1646850">[</span><span class="ident" id="1646851">i</span><span class="op" id="1646852">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1646856">if</span>&nbsp;<span class="ident" id="1646859">i</span>&nbsp;<span class="op" id="1646861">&gt;</span>&nbsp;<span class="num" id="1646863">0</span>&nbsp;<span class="op" id="1646865">&amp;&amp;</span>&nbsp;<span class="ident" id="1646868">c</span>&nbsp;<span class="op" id="1646870">==</span>&nbsp;<span class="ident" id="1646873">lockorder</span><span class="op" id="1646882">[</span><span class="ident" id="1646883">i</span><span class="op" id="1646884">-</span><span class="num" id="1646885">1</span><span class="op" id="1646886">]</span>&nbsp;<span class="op" id="1646888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1646893">continue</span>&nbsp;<span class="comment" id="1646902">//&nbsp;will&nbsp;unlock&nbsp;it&nbsp;on&nbsp;the&nbsp;next&nbsp;iteration</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1646944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646948">unlock</span><span class="op" id="1646954">(</span><span class="op" id="1646955">&amp;</span><span class="ident" id="1646956">c</span><span class="op" id="1646957">.</span><span class="ident" id="1646958">lock</span><span class="op" id="1646962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1646965">}</span><br>
<span class="lineno"></span><span class="op" id="1646967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="keyword" id="1646970">func</span>&nbsp;<span class="ident" id="1646975">selparkcommit</span><span class="op" id="1646988">(</span><span class="ident" id="1646989">gp</span>&nbsp;<span class="op" id="1646992">*</span><span class="ident" id="1646993">g</span><span class="op" id="1646994">,</span>&nbsp;<span class="ident" id="1646996">sel</span>&nbsp;<span class="op" id="1647000">*</span><span class="ident" id="1647001">_select</span><span class="op" id="1647008">)</span>&nbsp;<span class="builtintype" id="1647010">bool</span>&nbsp;<span class="op" id="1647015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647018">selunlock</span><span class="op" id="1647027">(</span><span class="ident" id="1647028">sel</span><span class="op" id="1647031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1647034">return</span>&nbsp;<span class="builtintype" id="1647041">true</span><br>
<span class="lineno"></span><span class="op" id="1647046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="1647049">func</span>&nbsp;<span class="ident" id="1647054">block</span><span class="op" id="1647059">(</span><span class="op" id="1647060">)</span>&nbsp;<span class="op" id="1647062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647065">gopark</span><span class="op" id="1647071">(</span><span class="ident" id="1647072">nil</span><span class="op" id="1647075">,</span>&nbsp;<span class="ident" id="1647077">nil</span><span class="op" id="1647080">,</span>&nbsp;<span class="string" id="1647082">&#34;select&nbsp;(no&nbsp;cases)&#34;</span><span class="op" id="1647101">)</span>&nbsp;<span class="comment" id="1647103">//&nbsp;forever</span><br>
<span class="lineno"></span><span class="op" id="1647114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1647117">//&nbsp;overwrites&nbsp;return&nbsp;pc&nbsp;on&nbsp;stack&nbsp;to&nbsp;signal&nbsp;which&nbsp;case&nbsp;of&nbsp;the&nbsp;select</span><br>
<span class="lineno">180</span><span class="comment" id="1647185">//&nbsp;to&nbsp;run,&nbsp;so&nbsp;cannot&nbsp;appear&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;a&nbsp;split&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1647242">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1647255">func</span>&nbsp;<span class="ident" id="1647260">selectgo</span><span class="op" id="1647268">(</span><span class="ident" id="1647269">sel</span>&nbsp;<span class="op" id="1647273">*</span><span class="ident" id="1647274">_select</span><span class="op" id="1647281">)</span>&nbsp;<span class="op" id="1647283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647286">pc</span><span class="op" id="1647288">,</span>&nbsp;<span class="ident" id="1647290">offset</span>&nbsp;<span class="op" id="1647297">:=</span>&nbsp;<span class="ident" id="1647300">selectgoImpl</span><span class="op" id="1647312">(</span><span class="ident" id="1647313">sel</span><span class="op" id="1647316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1647319">*</span><span class="op" id="1647320">(</span><span class="op" id="1647321">*</span><span class="builtintype" id="1647322">bool</span><span class="op" id="1647326">)</span><span class="op" id="1647327">(</span><span class="ident" id="1647328">add</span><span class="op" id="1647331">(</span><span class="ident" id="1647332">unsafe</span><span class="op" id="1647338">.</span><span class="ident" id="1647339">Pointer</span><span class="op" id="1647346">(</span><span class="op" id="1647347">&amp;</span><span class="ident" id="1647348">sel</span><span class="op" id="1647351">)</span><span class="op" id="1647352">,</span>&nbsp;<span class="builtintype" id="1647354">uintptr</span><span class="op" id="1647361">(</span><span class="ident" id="1647362">offset</span><span class="op" id="1647368">)</span><span class="op" id="1647369">)</span><span class="op" id="1647370">)</span>&nbsp;<span class="op" id="1647372">=</span>&nbsp;<span class="builtintype" id="1647374">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647380">setcallerpc</span><span class="op" id="1647391">(</span><span class="ident" id="1647392">unsafe</span><span class="op" id="1647398">.</span><span class="ident" id="1647399">Pointer</span><span class="op" id="1647406">(</span><span class="op" id="1647407">&amp;</span><span class="ident" id="1647408">sel</span><span class="op" id="1647411">)</span><span class="op" id="1647412">,</span>&nbsp;<span class="ident" id="1647414">pc</span><span class="op" id="1647416">)</span><br>
<span class="lineno"></span><span class="op" id="1647418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1647421">//&nbsp;selectgoImpl&nbsp;returns&nbsp;scase.pc&nbsp;and&nbsp;scase.so&nbsp;for&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span><span class="comment" id="1647482">//&nbsp;case&nbsp;which&nbsp;fired.</span><br>
<span class="lineno">190</span><span class="keyword" id="1647503">func</span>&nbsp;<span class="ident" id="1647508">selectgoImpl</span><span class="op" id="1647520">(</span><span class="ident" id="1647521">sel</span>&nbsp;<span class="op" id="1647525">*</span><span class="ident" id="1647526">_select</span><span class="op" id="1647533">)</span>&nbsp;<span class="op" id="1647535">(</span><span class="builtintype" id="1647536">uintptr</span><span class="op" id="1647543">,</span>&nbsp;<span class="builtintype" id="1647545">uint16</span><span class="op" id="1647551">)</span>&nbsp;<span class="op" id="1647553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1647556">if</span>&nbsp;<span class="ident" id="1647559">debugSelect</span>&nbsp;<span class="op" id="1647571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1647575">print</span><span class="op" id="1647580">(</span><span class="string" id="1647581">&#34;select:&nbsp;sel=&#34;</span><span class="op" id="1647595">,</span>&nbsp;<span class="ident" id="1647597">sel</span><span class="op" id="1647600">,</span>&nbsp;<span class="string" id="1647602">&#34;\n&#34;</span><span class="op" id="1647606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1647609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647613">scaseslice</span>&nbsp;<span class="op" id="1647624">:=</span>&nbsp;<span class="ident" id="1647627">sliceStruct</span><span class="op" id="1647638">{</span><span class="ident" id="1647639">unsafe</span><span class="op" id="1647645">.</span><span class="ident" id="1647646">Pointer</span><span class="op" id="1647653">(</span><span class="op" id="1647654">&amp;</span><span class="ident" id="1647655">sel</span><span class="op" id="1647658">.</span><span class="ident" id="1647659">scase</span><span class="op" id="1647664">)</span><span class="op" id="1647665">,</span>&nbsp;<span class="builtintype" id="1647667">int</span><span class="op" id="1647670">(</span><span class="ident" id="1647671">sel</span><span class="op" id="1647674">.</span><span class="ident" id="1647675">ncase</span><span class="op" id="1647680">)</span><span class="op" id="1647681">,</span>&nbsp;<span class="builtintype" id="1647683">int</span><span class="op" id="1647686">(</span><span class="ident" id="1647687">sel</span><span class="op" id="1647690">.</span><span class="ident" id="1647691">ncase</span><span class="op" id="1647696">)</span><span class="op" id="1647697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647700">scases</span>&nbsp;<span class="op" id="1647707">:=</span>&nbsp;<span class="op" id="1647710">*</span><span class="op" id="1647711">(</span><span class="op" id="1647712">*</span><span class="op" id="1647713">[</span><span class="op" id="1647714">]</span><span class="ident" id="1647715">scase</span><span class="op" id="1647720">)</span><span class="op" id="1647721">(</span><span class="ident" id="1647722">unsafe</span><span class="op" id="1647728">.</span><span class="ident" id="1647729">Pointer</span><span class="op" id="1647736">(</span><span class="op" id="1647737">&amp;</span><span class="ident" id="1647738">scaseslice</span><span class="op" id="1647748">)</span><span class="op" id="1647749">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1647753">var</span>&nbsp;<span class="ident" id="1647757">t0</span>&nbsp;<span class="ident" id="1647760">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1647767">if</span>&nbsp;<span class="ident" id="1647770">blockprofilerate</span>&nbsp;<span class="op" id="1647787">&gt;</span>&nbsp;<span class="num" id="1647789">0</span>&nbsp;<span class="op" id="1647791">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647795">t0</span>&nbsp;<span class="op" id="1647798">=</span>&nbsp;<span class="ident" id="1647800">cputicks</span><span class="op" id="1647808">(</span><span class="op" id="1647809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1647813">for</span>&nbsp;<span class="ident" id="1647817">i</span>&nbsp;<span class="op" id="1647819">:=</span>&nbsp;<span class="num" id="1647822">0</span><span class="op" id="1647823">;</span>&nbsp;<span class="ident" id="1647825">i</span>&nbsp;<span class="op" id="1647827">&lt;</span>&nbsp;<span class="builtintype" id="1647829">int</span><span class="op" id="1647832">(</span><span class="ident" id="1647833">sel</span><span class="op" id="1647836">.</span><span class="ident" id="1647837">ncase</span><span class="op" id="1647842">)</span><span class="op" id="1647843">;</span>&nbsp;<span class="ident" id="1647845">i</span><span class="op" id="1647846">++</span>&nbsp;<span class="op" id="1647849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647854">scases</span><span class="op" id="1647860">[</span><span class="ident" id="1647861">i</span><span class="op" id="1647862">]</span><span class="op" id="1647863">.</span><span class="ident" id="1647864">releasetime</span>&nbsp;<span class="op" id="1647876">=</span>&nbsp;<span class="op" id="1647878">-</span><span class="num" id="1647879">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1647883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1647886">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1647890">//&nbsp;The&nbsp;compiler&nbsp;rewrites&nbsp;selects&nbsp;that&nbsp;statically&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1647945">//&nbsp;only&nbsp;0&nbsp;or&nbsp;1&nbsp;cases&nbsp;plus&nbsp;default&nbsp;into&nbsp;simpler&nbsp;constructs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1648005">//&nbsp;The&nbsp;only&nbsp;way&nbsp;we&nbsp;can&nbsp;end&nbsp;up&nbsp;with&nbsp;such&nbsp;small&nbsp;sel.ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1648062">//&nbsp;values&nbsp;here&nbsp;is&nbsp;for&nbsp;a&nbsp;larger&nbsp;select&nbsp;in&nbsp;which&nbsp;most&nbsp;channels</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1648124">//&nbsp;have&nbsp;been&nbsp;nilled&nbsp;out.&nbsp;&nbsp;The&nbsp;general&nbsp;code&nbsp;handles&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1648182">//&nbsp;cases&nbsp;correctly,&nbsp;and&nbsp;they&nbsp;are&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1648242">//&nbsp;optimizing&nbsp;(and&nbsp;needing&nbsp;to&nbsp;test).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1648281">//&nbsp;generate&nbsp;permuted&nbsp;order</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648309">pollslice</span>&nbsp;<span class="op" id="1648319">:=</span>&nbsp;<span class="ident" id="1648322">sliceStruct</span><span class="op" id="1648333">{</span><span class="ident" id="1648334">unsafe</span><span class="op" id="1648340">.</span><span class="ident" id="1648341">Pointer</span><span class="op" id="1648348">(</span><span class="ident" id="1648349">sel</span><span class="op" id="1648352">.</span><span class="ident" id="1648353">pollorder</span><span class="op" id="1648362">)</span><span class="op" id="1648363">,</span>&nbsp;<span class="builtintype" id="1648365">int</span><span class="op" id="1648368">(</span><span class="ident" id="1648369">sel</span><span class="op" id="1648372">.</span><span class="ident" id="1648373">ncase</span><span class="op" id="1648378">)</span><span class="op" id="1648379">,</span>&nbsp;<span class="builtintype" id="1648381">int</span><span class="op" id="1648384">(</span><span class="ident" id="1648385">sel</span><span class="op" id="1648388">.</span><span class="ident" id="1648389">ncase</span><span class="op" id="1648394">)</span><span class="op" id="1648395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648398">pollorder</span>&nbsp;<span class="op" id="1648408">:=</span>&nbsp;<span class="op" id="1648411">*</span><span class="op" id="1648412">(</span><span class="op" id="1648413">*</span><span class="op" id="1648414">[</span><span class="op" id="1648415">]</span><span class="builtintype" id="1648416">uint16</span><span class="op" id="1648422">)</span><span class="op" id="1648423">(</span><span class="ident" id="1648424">unsafe</span><span class="op" id="1648430">.</span><span class="ident" id="1648431">Pointer</span><span class="op" id="1648438">(</span><span class="op" id="1648439">&amp;</span><span class="ident" id="1648440">pollslice</span><span class="op" id="1648449">)</span><span class="op" id="1648450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1648453">for</span>&nbsp;<span class="ident" id="1648457">i</span>&nbsp;<span class="op" id="1648459">:=</span>&nbsp;<span class="num" id="1648462">0</span><span class="op" id="1648463">;</span>&nbsp;<span class="ident" id="1648465">i</span>&nbsp;<span class="op" id="1648467">&lt;</span>&nbsp;<span class="builtintype" id="1648469">int</span><span class="op" id="1648472">(</span><span class="ident" id="1648473">sel</span><span class="op" id="1648476">.</span><span class="ident" id="1648477">ncase</span><span class="op" id="1648482">)</span><span class="op" id="1648483">;</span>&nbsp;<span class="ident" id="1648485">i</span><span class="op" id="1648486">++</span>&nbsp;<span class="op" id="1648489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648493">pollorder</span><span class="op" id="1648502">[</span><span class="ident" id="1648503">i</span><span class="op" id="1648504">]</span>&nbsp;<span class="op" id="1648506">=</span>&nbsp;<span class="builtintype" id="1648508">uint16</span><span class="op" id="1648514">(</span><span class="ident" id="1648515">i</span><span class="op" id="1648516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1648519">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1648522">for</span>&nbsp;<span class="ident" id="1648526">i</span>&nbsp;<span class="op" id="1648528">:=</span>&nbsp;<span class="num" id="1648531">1</span><span class="op" id="1648532">;</span>&nbsp;<span class="ident" id="1648534">i</span>&nbsp;<span class="op" id="1648536">&lt;</span>&nbsp;<span class="builtintype" id="1648538">int</span><span class="op" id="1648541">(</span><span class="ident" id="1648542">sel</span><span class="op" id="1648545">.</span><span class="ident" id="1648546">ncase</span><span class="op" id="1648551">)</span><span class="op" id="1648552">;</span>&nbsp;<span class="ident" id="1648554">i</span><span class="op" id="1648555">++</span>&nbsp;<span class="op" id="1648558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648562">o</span>&nbsp;<span class="op" id="1648564">:=</span>&nbsp;<span class="ident" id="1648567">pollorder</span><span class="op" id="1648576">[</span><span class="ident" id="1648577">i</span><span class="op" id="1648578">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648582">j</span>&nbsp;<span class="op" id="1648584">:=</span>&nbsp;<span class="builtintype" id="1648587">int</span><span class="op" id="1648590">(</span><span class="ident" id="1648591">fastrand1</span><span class="op" id="1648600">(</span><span class="op" id="1648601">)</span><span class="op" id="1648602">)</span>&nbsp;<span class="op" id="1648604">%</span>&nbsp;<span class="op" id="1648606">(</span><span class="ident" id="1648607">i</span>&nbsp;<span class="op" id="1648609">+</span>&nbsp;<span class="num" id="1648611">1</span><span class="op" id="1648612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648616">pollorder</span><span class="op" id="1648625">[</span><span class="ident" id="1648626">i</span><span class="op" id="1648627">]</span>&nbsp;<span class="op" id="1648629">=</span>&nbsp;<span class="ident" id="1648631">pollorder</span><span class="op" id="1648640">[</span><span class="ident" id="1648641">j</span><span class="op" id="1648642">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648646">pollorder</span><span class="op" id="1648655">[</span><span class="ident" id="1648656">j</span><span class="op" id="1648657">]</span>&nbsp;<span class="op" id="1648659">=</span>&nbsp;<span class="ident" id="1648661">o</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1648664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1648668">//&nbsp;sort&nbsp;the&nbsp;cases&nbsp;by&nbsp;Hchan&nbsp;address&nbsp;to&nbsp;get&nbsp;the&nbsp;locking&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1648730">//&nbsp;simple&nbsp;heap&nbsp;sort,&nbsp;to&nbsp;guarantee&nbsp;n&nbsp;log&nbsp;n&nbsp;time&nbsp;and&nbsp;constant&nbsp;stack&nbsp;footprint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648808">lockslice</span>&nbsp;<span class="op" id="1648818">:=</span>&nbsp;<span class="ident" id="1648821">sliceStruct</span><span class="op" id="1648832">{</span><span class="ident" id="1648833">unsafe</span><span class="op" id="1648839">.</span><span class="ident" id="1648840">Pointer</span><span class="op" id="1648847">(</span><span class="ident" id="1648848">sel</span><span class="op" id="1648851">.</span><span class="ident" id="1648852">lockorder</span><span class="op" id="1648861">)</span><span class="op" id="1648862">,</span>&nbsp;<span class="builtintype" id="1648864">int</span><span class="op" id="1648867">(</span><span class="ident" id="1648868">sel</span><span class="op" id="1648871">.</span><span class="ident" id="1648872">ncase</span><span class="op" id="1648877">)</span><span class="op" id="1648878">,</span>&nbsp;<span class="builtintype" id="1648880">int</span><span class="op" id="1648883">(</span><span class="ident" id="1648884">sel</span><span class="op" id="1648887">.</span><span class="ident" id="1648888">ncase</span><span class="op" id="1648893">)</span><span class="op" id="1648894">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648897">lockorder</span>&nbsp;<span class="op" id="1648907">:=</span>&nbsp;<span class="op" id="1648910">*</span><span class="op" id="1648911">(</span><span class="op" id="1648912">*</span><span class="op" id="1648913">[</span><span class="op" id="1648914">]</span><span class="op" id="1648915">*</span><span class="ident" id="1648916">hchan</span><span class="op" id="1648921">)</span><span class="op" id="1648922">(</span><span class="ident" id="1648923">unsafe</span><span class="op" id="1648929">.</span><span class="ident" id="1648930">Pointer</span><span class="op" id="1648937">(</span><span class="op" id="1648938">&amp;</span><span class="ident" id="1648939">lockslice</span><span class="op" id="1648948">)</span><span class="op" id="1648949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1648952">for</span>&nbsp;<span class="ident" id="1648956">i</span>&nbsp;<span class="op" id="1648958">:=</span>&nbsp;<span class="num" id="1648961">0</span><span class="op" id="1648962">;</span>&nbsp;<span class="ident" id="1648964">i</span>&nbsp;<span class="op" id="1648966">&lt;</span>&nbsp;<span class="builtintype" id="1648968">int</span><span class="op" id="1648971">(</span><span class="ident" id="1648972">sel</span><span class="op" id="1648975">.</span><span class="ident" id="1648976">ncase</span><span class="op" id="1648981">)</span><span class="op" id="1648982">;</span>&nbsp;<span class="ident" id="1648984">i</span><span class="op" id="1648985">++</span>&nbsp;<span class="op" id="1648988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648992">j</span>&nbsp;<span class="op" id="1648994">:=</span>&nbsp;<span class="ident" id="1648997">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649001">c</span>&nbsp;<span class="op" id="1649003">:=</span>&nbsp;<span class="ident" id="1649006">scases</span><span class="op" id="1649012">[</span><span class="ident" id="1649013">j</span><span class="op" id="1649014">]</span><span class="op" id="1649015">.</span><span class="ident" id="1649016">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1649024">for</span>&nbsp;<span class="ident" id="1649028">j</span>&nbsp;<span class="op" id="1649030">&gt;</span>&nbsp;<span class="num" id="1649032">0</span>&nbsp;<span class="op" id="1649034">&amp;&amp;</span>&nbsp;<span class="ident" id="1649037">lockorder</span><span class="op" id="1649046">[</span><span class="op" id="1649047">(</span><span class="ident" id="1649048">j</span><span class="op" id="1649049">-</span><span class="num" id="1649050">1</span><span class="op" id="1649051">)</span><span class="op" id="1649052">/</span><span class="num" id="1649053">2</span><span class="op" id="1649054">]</span><span class="op" id="1649055">.</span><span class="ident" id="1649056">sortkey</span><span class="op" id="1649063">(</span><span class="op" id="1649064">)</span>&nbsp;<span class="op" id="1649066">&lt;</span>&nbsp;<span class="ident" id="1649068">c</span><span class="op" id="1649069">.</span><span class="ident" id="1649070">sortkey</span><span class="op" id="1649077">(</span><span class="op" id="1649078">)</span>&nbsp;<span class="op" id="1649080">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649085">k</span>&nbsp;<span class="op" id="1649087">:=</span>&nbsp;<span class="op" id="1649090">(</span><span class="ident" id="1649091">j</span>&nbsp;<span class="op" id="1649093">-</span>&nbsp;<span class="num" id="1649095">1</span><span class="op" id="1649096">)</span>&nbsp;<span class="op" id="1649098">/</span>&nbsp;<span class="num" id="1649100">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649105">lockorder</span><span class="op" id="1649114">[</span><span class="ident" id="1649115">j</span><span class="op" id="1649116">]</span>&nbsp;<span class="op" id="1649118">=</span>&nbsp;<span class="ident" id="1649120">lockorder</span><span class="op" id="1649129">[</span><span class="ident" id="1649130">k</span><span class="op" id="1649131">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649136">j</span>&nbsp;<span class="op" id="1649138">=</span>&nbsp;<span class="ident" id="1649140">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1649144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649148">lockorder</span><span class="op" id="1649157">[</span><span class="ident" id="1649158">j</span><span class="op" id="1649159">]</span>&nbsp;<span class="op" id="1649161">=</span>&nbsp;<span class="ident" id="1649163">c</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1649166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1649169">for</span>&nbsp;<span class="ident" id="1649173">i</span>&nbsp;<span class="op" id="1649175">:=</span>&nbsp;<span class="builtintype" id="1649178">int</span><span class="op" id="1649181">(</span><span class="ident" id="1649182">sel</span><span class="op" id="1649185">.</span><span class="ident" id="1649186">ncase</span><span class="op" id="1649191">)</span>&nbsp;<span class="op" id="1649193">-</span>&nbsp;<span class="num" id="1649195">1</span><span class="op" id="1649196">;</span>&nbsp;<span class="ident" id="1649198">i</span>&nbsp;<span class="op" id="1649200">&gt;=</span>&nbsp;<span class="num" id="1649203">0</span><span class="op" id="1649204">;</span>&nbsp;<span class="ident" id="1649206">i</span><span class="op" id="1649207">--</span>&nbsp;<span class="op" id="1649210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649214">c</span>&nbsp;<span class="op" id="1649216">:=</span>&nbsp;<span class="ident" id="1649219">lockorder</span><span class="op" id="1649228">[</span><span class="ident" id="1649229">i</span><span class="op" id="1649230">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649234">lockorder</span><span class="op" id="1649243">[</span><span class="ident" id="1649244">i</span><span class="op" id="1649245">]</span>&nbsp;<span class="op" id="1649247">=</span>&nbsp;<span class="ident" id="1649249">lockorder</span><span class="op" id="1649258">[</span><span class="num" id="1649259">0</span><span class="op" id="1649260">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649264">j</span>&nbsp;<span class="op" id="1649266">:=</span>&nbsp;<span class="num" id="1649269">0</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1649273">for</span>&nbsp;<span class="op" id="1649277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649282">k</span>&nbsp;<span class="op" id="1649284">:=</span>&nbsp;<span class="ident" id="1649287">j</span><span class="op" id="1649288">*</span><span class="num" id="1649289">2</span>&nbsp;<span class="op" id="1649291">+</span>&nbsp;<span class="num" id="1649293">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1649298">if</span>&nbsp;<span class="ident" id="1649301">k</span>&nbsp;<span class="op" id="1649303">&gt;=</span>&nbsp;<span class="ident" id="1649306">i</span>&nbsp;<span class="op" id="1649308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1649314">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1649323">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1649328">if</span>&nbsp;<span class="ident" id="1649331">k</span><span class="op" id="1649332">+</span><span class="num" id="1649333">1</span>&nbsp;<span class="op" id="1649335">&lt;</span>&nbsp;<span class="ident" id="1649337">i</span>&nbsp;<span class="op" id="1649339">&amp;&amp;</span>&nbsp;<span class="ident" id="1649342">lockorder</span><span class="op" id="1649351">[</span><span class="ident" id="1649352">k</span><span class="op" id="1649353">]</span><span class="op" id="1649354">.</span><span class="ident" id="1649355">sortkey</span><span class="op" id="1649362">(</span><span class="op" id="1649363">)</span>&nbsp;<span class="op" id="1649365">&lt;</span>&nbsp;<span class="ident" id="1649367">lockorder</span><span class="op" id="1649376">[</span><span class="ident" id="1649377">k</span><span class="op" id="1649378">+</span><span class="num" id="1649379">1</span><span class="op" id="1649380">]</span><span class="op" id="1649381">.</span><span class="ident" id="1649382">sortkey</span><span class="op" id="1649389">(</span><span class="op" id="1649390">)</span>&nbsp;<span class="op" id="1649392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649398">k</span><span class="op" id="1649399">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1649405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1649410">if</span>&nbsp;<span class="ident" id="1649413">c</span><span class="op" id="1649414">.</span><span class="ident" id="1649415">sortkey</span><span class="op" id="1649422">(</span><span class="op" id="1649423">)</span>&nbsp;<span class="op" id="1649425">&lt;</span>&nbsp;<span class="ident" id="1649427">lockorder</span><span class="op" id="1649436">[</span><span class="ident" id="1649437">k</span><span class="op" id="1649438">]</span><span class="op" id="1649439">.</span><span class="ident" id="1649440">sortkey</span><span class="op" id="1649447">(</span><span class="op" id="1649448">)</span>&nbsp;<span class="op" id="1649450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649456">lockorder</span><span class="op" id="1649465">[</span><span class="ident" id="1649466">j</span><span class="op" id="1649467">]</span>&nbsp;<span class="op" id="1649469">=</span>&nbsp;<span class="ident" id="1649471">lockorder</span><span class="op" id="1649480">[</span><span class="ident" id="1649481">k</span><span class="op" id="1649482">]</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649488">j</span>&nbsp;<span class="op" id="1649490">=</span>&nbsp;<span class="ident" id="1649492">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1649498">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1649510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1649515">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1649523">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649527">lockorder</span><span class="op" id="1649536">[</span><span class="ident" id="1649537">j</span><span class="op" id="1649538">]</span>&nbsp;<span class="op" id="1649540">=</span>&nbsp;<span class="ident" id="1649542">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1649545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1649548">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfor&nbsp;i&nbsp;:=&nbsp;0;&nbsp;i+1&nbsp;&lt;&nbsp;int(sel.ncase);&nbsp;i++&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;lockorder[i].sortkey()&nbsp;&gt;&nbsp;lockorder[i+1].sortkey()&nbsp;{<br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspprint(&#34;i=&#34;,&nbsp;i,&nbsp;&#34;&nbsp;x=&#34;,&nbsp;lockorder[i],&nbsp;&#34;&nbsp;y=&#34;,&nbsp;lockorder[i+1],&nbsp;&#34;\n&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspgothrow(&#34;select:&nbsp;broken&nbsp;sort&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp*/</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1649770">//&nbsp;lock&nbsp;all&nbsp;the&nbsp;channels&nbsp;involved&nbsp;in&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649819">sellock</span><span class="op" id="1649826">(</span><span class="ident" id="1649827">sel</span><span class="op" id="1649830">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1649834">var</span>&nbsp;<span class="op" id="1649838">(</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649842">gp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1649849">*</span><span class="ident" id="1649850">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649854">done</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1649861">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649870">sg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1649877">*</span><span class="ident" id="1649878">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649886">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1649893">*</span><span class="ident" id="1649894">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649902">k</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1649909">*</span><span class="ident" id="1649910">scase</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649918">sglist</span>&nbsp;<span class="op" id="1649925">*</span><span class="ident" id="1649926">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649934">sgnext</span>&nbsp;<span class="op" id="1649941">*</span><span class="ident" id="1649942">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1649949">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1649952">loop</span><span class="op" id="1649956">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1649959">//&nbsp;pass&nbsp;1&nbsp;-&nbsp;look&nbsp;for&nbsp;something&nbsp;already&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650007">var</span>&nbsp;<span class="ident" id="1650011">dfl</span>&nbsp;<span class="op" id="1650015">*</span><span class="ident" id="1650016">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650023">var</span>&nbsp;<span class="ident" id="1650027">cas</span>&nbsp;<span class="op" id="1650031">*</span><span class="ident" id="1650032">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650039">for</span>&nbsp;<span class="ident" id="1650043">i</span>&nbsp;<span class="op" id="1650045">:=</span>&nbsp;<span class="num" id="1650048">0</span><span class="op" id="1650049">;</span>&nbsp;<span class="ident" id="1650051">i</span>&nbsp;<span class="op" id="1650053">&lt;</span>&nbsp;<span class="builtintype" id="1650055">int</span><span class="op" id="1650058">(</span><span class="ident" id="1650059">sel</span><span class="op" id="1650062">.</span><span class="ident" id="1650063">ncase</span><span class="op" id="1650068">)</span><span class="op" id="1650069">;</span>&nbsp;<span class="ident" id="1650071">i</span><span class="op" id="1650072">++</span>&nbsp;<span class="op" id="1650075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650079">cas</span>&nbsp;<span class="op" id="1650083">=</span>&nbsp;<span class="op" id="1650085">&amp;</span><span class="ident" id="1650086">scases</span><span class="op" id="1650092">[</span><span class="ident" id="1650093">pollorder</span><span class="op" id="1650102">[</span><span class="ident" id="1650103">i</span><span class="op" id="1650104">]</span><span class="op" id="1650105">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650109">c</span>&nbsp;<span class="op" id="1650111">=</span>&nbsp;<span class="ident" id="1650113">cas</span><span class="op" id="1650116">.</span><span class="ident" id="1650117">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650126">switch</span>&nbsp;<span class="ident" id="1650133">cas</span><span class="op" id="1650136">.</span><span class="ident" id="1650137">kind</span>&nbsp;<span class="op" id="1650142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650146">case</span>&nbsp;<span class="ident" id="1650151">_CaseRecv</span><span class="op" id="1650160">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650165">if</span>&nbsp;<span class="ident" id="1650168">c</span><span class="op" id="1650169">.</span><span class="ident" id="1650170">dataqsiz</span>&nbsp;<span class="op" id="1650179">&gt;</span>&nbsp;<span class="num" id="1650181">0</span>&nbsp;<span class="op" id="1650183">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650189">if</span>&nbsp;<span class="ident" id="1650192">c</span><span class="op" id="1650193">.</span><span class="ident" id="1650194">qcount</span>&nbsp;<span class="op" id="1650201">&gt;</span>&nbsp;<span class="num" id="1650203">0</span>&nbsp;<span class="op" id="1650205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650212">goto</span>&nbsp;<span class="ident" id="1650217">asyncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1650231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1650236">}</span>&nbsp;<span class="keyword" id="1650238">else</span>&nbsp;<span class="op" id="1650243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650249">sg</span>&nbsp;<span class="op" id="1650252">=</span>&nbsp;<span class="ident" id="1650254">c</span><span class="op" id="1650255">.</span><span class="ident" id="1650256">sendq</span><span class="op" id="1650261">.</span><span class="ident" id="1650262">dequeue</span><span class="op" id="1650269">(</span><span class="op" id="1650270">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650276">if</span>&nbsp;<span class="ident" id="1650279">sg</span>&nbsp;<span class="op" id="1650282">!=</span>&nbsp;<span class="ident" id="1650285">nil</span>&nbsp;<span class="op" id="1650289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650296">goto</span>&nbsp;<span class="ident" id="1650301">syncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1650314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1650319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650324">if</span>&nbsp;<span class="ident" id="1650327">c</span><span class="op" id="1650328">.</span><span class="ident" id="1650329">closed</span>&nbsp;<span class="op" id="1650336">!=</span>&nbsp;<span class="num" id="1650339">0</span>&nbsp;<span class="op" id="1650341">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650347">goto</span>&nbsp;<span class="ident" id="1650352">rclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1650362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650367">case</span>&nbsp;<span class="ident" id="1650372">_CaseSend</span><span class="op" id="1650381">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650386">if</span>&nbsp;<span class="ident" id="1650389">raceenabled</span>&nbsp;<span class="op" id="1650401">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650407">racereadpc</span><span class="op" id="1650417">(</span><span class="ident" id="1650418">unsafe</span><span class="op" id="1650424">.</span><span class="ident" id="1650425">Pointer</span><span class="op" id="1650432">(</span><span class="ident" id="1650433">c</span><span class="op" id="1650434">)</span><span class="op" id="1650435">,</span>&nbsp;<span class="ident" id="1650437">cas</span><span class="op" id="1650440">.</span><span class="ident" id="1650441">pc</span><span class="op" id="1650443">,</span>&nbsp;<span class="ident" id="1650445">chansendpc</span><span class="op" id="1650455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1650460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650465">if</span>&nbsp;<span class="ident" id="1650468">c</span><span class="op" id="1650469">.</span><span class="ident" id="1650470">closed</span>&nbsp;<span class="op" id="1650477">!=</span>&nbsp;<span class="num" id="1650480">0</span>&nbsp;<span class="op" id="1650482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650488">goto</span>&nbsp;<span class="ident" id="1650493">sclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1650503">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650508">if</span>&nbsp;<span class="ident" id="1650511">c</span><span class="op" id="1650512">.</span><span class="ident" id="1650513">dataqsiz</span>&nbsp;<span class="op" id="1650522">&gt;</span>&nbsp;<span class="num" id="1650524">0</span>&nbsp;<span class="op" id="1650526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650532">if</span>&nbsp;<span class="ident" id="1650535">c</span><span class="op" id="1650536">.</span><span class="ident" id="1650537">qcount</span>&nbsp;<span class="op" id="1650544">&lt;</span>&nbsp;<span class="ident" id="1650546">c</span><span class="op" id="1650547">.</span><span class="ident" id="1650548">dataqsiz</span>&nbsp;<span class="op" id="1650557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650564">goto</span>&nbsp;<span class="ident" id="1650569">asyncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1650583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1650588">}</span>&nbsp;<span class="keyword" id="1650590">else</span>&nbsp;<span class="op" id="1650595">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650601">sg</span>&nbsp;<span class="op" id="1650604">=</span>&nbsp;<span class="ident" id="1650606">c</span><span class="op" id="1650607">.</span><span class="ident" id="1650608">recvq</span><span class="op" id="1650613">.</span><span class="ident" id="1650614">dequeue</span><span class="op" id="1650621">(</span><span class="op" id="1650622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650628">if</span>&nbsp;<span class="ident" id="1650631">sg</span>&nbsp;<span class="op" id="1650634">!=</span>&nbsp;<span class="ident" id="1650637">nil</span>&nbsp;<span class="op" id="1650641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650648">goto</span>&nbsp;<span class="ident" id="1650653">syncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1650666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1650671">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650676">case</span>&nbsp;<span class="ident" id="1650681">_CaseDefault</span><span class="op" id="1650693">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650698">dfl</span>&nbsp;<span class="op" id="1650702">=</span>&nbsp;<span class="ident" id="1650704">cas</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1650710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1650713">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650717">if</span>&nbsp;<span class="ident" id="1650720">dfl</span>&nbsp;<span class="op" id="1650724">!=</span>&nbsp;<span class="ident" id="1650727">nil</span>&nbsp;<span class="op" id="1650731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650735">selunlock</span><span class="op" id="1650744">(</span><span class="ident" id="1650745">sel</span><span class="op" id="1650748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650752">cas</span>&nbsp;<span class="op" id="1650756">=</span>&nbsp;<span class="ident" id="1650758">dfl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650764">goto</span>&nbsp;<span class="ident" id="1650769">retc</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1650775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1650779">//&nbsp;pass&nbsp;2&nbsp;-&nbsp;enqueue&nbsp;on&nbsp;all&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650813">gp</span>&nbsp;<span class="op" id="1650816">=</span>&nbsp;<span class="ident" id="1650818">getg</span><span class="op" id="1650822">(</span><span class="op" id="1650823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650826">done</span>&nbsp;<span class="op" id="1650831">=</span>&nbsp;<span class="num" id="1650833">0</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650836">for</span>&nbsp;<span class="ident" id="1650840">i</span>&nbsp;<span class="op" id="1650842">:=</span>&nbsp;<span class="num" id="1650845">0</span><span class="op" id="1650846">;</span>&nbsp;<span class="ident" id="1650848">i</span>&nbsp;<span class="op" id="1650850">&lt;</span>&nbsp;<span class="builtintype" id="1650852">int</span><span class="op" id="1650855">(</span><span class="ident" id="1650856">sel</span><span class="op" id="1650859">.</span><span class="ident" id="1650860">ncase</span><span class="op" id="1650865">)</span><span class="op" id="1650866">;</span>&nbsp;<span class="ident" id="1650868">i</span><span class="op" id="1650869">++</span>&nbsp;<span class="op" id="1650872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650876">cas</span>&nbsp;<span class="op" id="1650880">=</span>&nbsp;<span class="op" id="1650882">&amp;</span><span class="ident" id="1650883">scases</span><span class="op" id="1650889">[</span><span class="ident" id="1650890">pollorder</span><span class="op" id="1650899">[</span><span class="ident" id="1650900">i</span><span class="op" id="1650901">]</span><span class="op" id="1650902">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650906">c</span>&nbsp;<span class="op" id="1650908">=</span>&nbsp;<span class="ident" id="1650910">cas</span><span class="op" id="1650913">.</span><span class="ident" id="1650914">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650922">sg</span>&nbsp;<span class="op" id="1650925">:=</span>&nbsp;<span class="ident" id="1650928">acquireSudog</span><span class="op" id="1650940">(</span><span class="op" id="1650941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650945">sg</span><span class="op" id="1650947">.</span><span class="ident" id="1650948">g</span>&nbsp;<span class="op" id="1650950">=</span>&nbsp;<span class="ident" id="1650952">gp</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1650957">//&nbsp;Note:&nbsp;selectdone&nbsp;is&nbsp;adjusted&nbsp;for&nbsp;stack&nbsp;copies&nbsp;in&nbsp;stack.c:adjustsudogs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651032">sg</span><span class="op" id="1651034">.</span><span class="ident" id="1651035">selectdone</span>&nbsp;<span class="op" id="1651046">=</span>&nbsp;<span class="op" id="1651048">(</span><span class="op" id="1651049">*</span><span class="builtintype" id="1651050">uint32</span><span class="op" id="1651056">)</span><span class="op" id="1651057">(</span><span class="ident" id="1651058">noescape</span><span class="op" id="1651066">(</span><span class="ident" id="1651067">unsafe</span><span class="op" id="1651073">.</span><span class="ident" id="1651074">Pointer</span><span class="op" id="1651081">(</span><span class="op" id="1651082">&amp;</span><span class="ident" id="1651083">done</span><span class="op" id="1651087">)</span><span class="op" id="1651088">)</span><span class="op" id="1651089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651093">sg</span><span class="op" id="1651095">.</span><span class="ident" id="1651096">elem</span>&nbsp;<span class="op" id="1651101">=</span>&nbsp;<span class="ident" id="1651103">cas</span><span class="op" id="1651106">.</span><span class="ident" id="1651107">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651114">sg</span><span class="op" id="1651116">.</span><span class="ident" id="1651117">releasetime</span>&nbsp;<span class="op" id="1651129">=</span>&nbsp;<span class="num" id="1651131">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1651135">if</span>&nbsp;<span class="ident" id="1651138">t0</span>&nbsp;<span class="op" id="1651141">!=</span>&nbsp;<span class="num" id="1651144">0</span>&nbsp;<span class="op" id="1651146">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651151">sg</span><span class="op" id="1651153">.</span><span class="ident" id="1651154">releasetime</span>&nbsp;<span class="op" id="1651166">=</span>&nbsp;<span class="op" id="1651168">-</span><span class="num" id="1651169">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1651173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651177">sg</span><span class="op" id="1651179">.</span><span class="ident" id="1651180">waitlink</span>&nbsp;<span class="op" id="1651189">=</span>&nbsp;<span class="ident" id="1651191">gp</span><span class="op" id="1651193">.</span><span class="ident" id="1651194">waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651204">gp</span><span class="op" id="1651206">.</span><span class="ident" id="1651207">waiting</span>&nbsp;<span class="op" id="1651215">=</span>&nbsp;<span class="ident" id="1651217">sg</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1651223">switch</span>&nbsp;<span class="ident" id="1651230">cas</span><span class="op" id="1651233">.</span><span class="ident" id="1651234">kind</span>&nbsp;<span class="op" id="1651239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1651243">case</span>&nbsp;<span class="ident" id="1651248">_CaseRecv</span><span class="op" id="1651257">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651262">c</span><span class="op" id="1651263">.</span><span class="ident" id="1651264">recvq</span><span class="op" id="1651269">.</span><span class="ident" id="1651270">enqueue</span><span class="op" id="1651277">(</span><span class="ident" id="1651278">sg</span><span class="op" id="1651280">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1651285">case</span>&nbsp;<span class="ident" id="1651290">_CaseSend</span><span class="op" id="1651299">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651304">c</span><span class="op" id="1651305">.</span><span class="ident" id="1651306">sendq</span><span class="op" id="1651311">.</span><span class="ident" id="1651312">enqueue</span><span class="op" id="1651319">(</span><span class="ident" id="1651320">sg</span><span class="op" id="1651322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1651326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1651329">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1651333">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;wake&nbsp;us&nbsp;up</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651368">gp</span><span class="op" id="1651370">.</span><span class="ident" id="1651371">param</span>&nbsp;<span class="op" id="1651377">=</span>&nbsp;<span class="ident" id="1651379">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651384">gopark</span><span class="op" id="1651390">(</span><span class="ident" id="1651391">unsafe</span><span class="op" id="1651397">.</span><span class="ident" id="1651398">Pointer</span><span class="op" id="1651405">(</span><span class="ident" id="1651406">funcPC</span><span class="op" id="1651412">(</span><span class="ident" id="1651413">selparkcommit</span><span class="op" id="1651426">)</span><span class="op" id="1651427">)</span><span class="op" id="1651428">,</span>&nbsp;<span class="ident" id="1651430">unsafe</span><span class="op" id="1651436">.</span><span class="ident" id="1651437">Pointer</span><span class="op" id="1651444">(</span><span class="ident" id="1651445">sel</span><span class="op" id="1651448">)</span><span class="op" id="1651449">,</span>&nbsp;<span class="string" id="1651451">&#34;select&#34;</span><span class="op" id="1651459">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1651463">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651486">sellock</span><span class="op" id="1651493">(</span><span class="ident" id="1651494">sel</span><span class="op" id="1651497">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651500">sg</span>&nbsp;<span class="op" id="1651503">=</span>&nbsp;<span class="op" id="1651505">(</span><span class="op" id="1651506">*</span><span class="ident" id="1651507">sudog</span><span class="op" id="1651512">)</span><span class="op" id="1651513">(</span><span class="ident" id="1651514">gp</span><span class="op" id="1651516">.</span><span class="ident" id="1651517">param</span><span class="op" id="1651522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651525">gp</span><span class="op" id="1651527">.</span><span class="ident" id="1651528">param</span>&nbsp;<span class="op" id="1651534">=</span>&nbsp;<span class="ident" id="1651536">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1651542">//&nbsp;pass&nbsp;3&nbsp;-&nbsp;dequeue&nbsp;from&nbsp;unsuccessful&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1651587">//&nbsp;otherwise&nbsp;they&nbsp;stack&nbsp;up&nbsp;on&nbsp;quiet&nbsp;channels</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1651633">//&nbsp;record&nbsp;the&nbsp;successful&nbsp;case,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1651673">//&nbsp;We&nbsp;singly-linked&nbsp;up&nbsp;the&nbsp;SudoGs&nbsp;in&nbsp;case&nbsp;order,&nbsp;so&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1651731">//&nbsp;iterating&nbsp;through&nbsp;the&nbsp;linked&nbsp;list&nbsp;they&nbsp;are&nbsp;in&nbsp;reverse&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651796">cas</span>&nbsp;<span class="op" id="1651800">=</span>&nbsp;<span class="ident" id="1651802">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651807">sglist</span>&nbsp;<span class="op" id="1651814">=</span>&nbsp;<span class="ident" id="1651816">gp</span><span class="op" id="1651818">.</span><span class="ident" id="1651819">waiting</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1651828">//&nbsp;Clear&nbsp;all&nbsp;selectdone&nbsp;and&nbsp;elem&nbsp;before&nbsp;unlinking&nbsp;from&nbsp;gp.waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1651896">//&nbsp;They&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;being&nbsp;put&nbsp;back&nbsp;into&nbsp;the&nbsp;sudog&nbsp;cache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1651965">//&nbsp;Clear&nbsp;before&nbsp;unlinking,&nbsp;because&nbsp;if&nbsp;a&nbsp;stack&nbsp;copy&nbsp;happens&nbsp;after&nbsp;the&nbsp;unlink,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1652043">//&nbsp;they&nbsp;will&nbsp;not&nbsp;be&nbsp;updated,&nbsp;they&nbsp;will&nbsp;be&nbsp;left&nbsp;pointing&nbsp;to&nbsp;the&nbsp;old&nbsp;stack,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1652118">//&nbsp;which&nbsp;creates&nbsp;dangling&nbsp;pointers,&nbsp;which&nbsp;may&nbsp;be&nbsp;detected&nbsp;by&nbsp;the</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1652184">//&nbsp;garbage&nbsp;collector.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1652207">for</span>&nbsp;<span class="ident" id="1652211">sg1</span>&nbsp;<span class="op" id="1652215">:=</span>&nbsp;<span class="ident" id="1652218">gp</span><span class="op" id="1652220">.</span><span class="ident" id="1652221">waiting</span><span class="op" id="1652228">;</span>&nbsp;<span class="ident" id="1652230">sg1</span>&nbsp;<span class="op" id="1652234">!=</span>&nbsp;<span class="ident" id="1652237">nil</span><span class="op" id="1652240">;</span>&nbsp;<span class="ident" id="1652242">sg1</span>&nbsp;<span class="op" id="1652246">=</span>&nbsp;<span class="ident" id="1652248">sg1</span><span class="op" id="1652251">.</span><span class="ident" id="1652252">waitlink</span>&nbsp;<span class="op" id="1652261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1652265">sg1</span><span class="op" id="1652268">.</span><span class="ident" id="1652269">selectdone</span>&nbsp;<span class="op" id="1652280">=</span>&nbsp;<span class="ident" id="1652282">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1652288">sg1</span><span class="op" id="1652291">.</span><span class="ident" id="1652292">elem</span>&nbsp;<span class="op" id="1652297">=</span>&nbsp;<span class="ident" id="1652299">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1652304">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1652307">gp</span><span class="op" id="1652309">.</span><span class="ident" id="1652310">waiting</span>&nbsp;<span class="op" id="1652318">=</span>&nbsp;<span class="ident" id="1652320">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1652325">for</span>&nbsp;<span class="ident" id="1652329">i</span>&nbsp;<span class="op" id="1652331">:=</span>&nbsp;<span class="builtintype" id="1652334">int</span><span class="op" id="1652337">(</span><span class="ident" id="1652338">sel</span><span class="op" id="1652341">.</span><span class="ident" id="1652342">ncase</span><span class="op" id="1652347">)</span>&nbsp;<span class="op" id="1652349">-</span>&nbsp;<span class="num" id="1652351">1</span><span class="op" id="1652352">;</span>&nbsp;<span class="ident" id="1652354">i</span>&nbsp;<span class="op" id="1652356">&gt;=</span>&nbsp;<span class="num" id="1652359">0</span><span class="op" id="1652360">;</span>&nbsp;<span class="ident" id="1652362">i</span><span class="op" id="1652363">--</span>&nbsp;<span class="op" id="1652366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1652370">k</span>&nbsp;<span class="op" id="1652372">=</span>&nbsp;<span class="op" id="1652374">&amp;</span><span class="ident" id="1652375">scases</span><span class="op" id="1652381">[</span><span class="ident" id="1652382">pollorder</span><span class="op" id="1652391">[</span><span class="ident" id="1652392">i</span><span class="op" id="1652393">]</span><span class="op" id="1652394">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1652398">if</span>&nbsp;<span class="ident" id="1652401">sglist</span><span class="op" id="1652407">.</span><span class="ident" id="1652408">releasetime</span>&nbsp;<span class="op" id="1652420">&gt;</span>&nbsp;<span class="num" id="1652422">0</span>&nbsp;<span class="op" id="1652424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1652429">k</span><span class="op" id="1652430">.</span><span class="ident" id="1652431">releasetime</span>&nbsp;<span class="op" id="1652443">=</span>&nbsp;<span class="ident" id="1652445">sglist</span><span class="op" id="1652451">.</span><span class="ident" id="1652452">releasetime</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1652466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1652470">if</span>&nbsp;<span class="ident" id="1652473">sg</span>&nbsp;<span class="op" id="1652476">==</span>&nbsp;<span class="ident" id="1652479">sglist</span>&nbsp;<span class="op" id="1652486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1652491">cas</span>&nbsp;<span class="op" id="1652495">=</span>&nbsp;<span class="ident" id="1652497">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1652501">}</span>&nbsp;<span class="keyword" id="1652503">else</span>&nbsp;<span class="op" id="1652508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1652513">c</span>&nbsp;<span class="op" id="1652515">=</span>&nbsp;<span class="ident" id="1652517">k</span><span class="op" id="1652518">.</span><span class="ident" id="1652519">_chan</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1652528">if</span>&nbsp;<span class="ident" id="1652531">k</span><span class="op" id="1652532">.</span><span class="ident" id="1652533">kind</span>&nbsp;<span class="op" id="1652538">==</span>&nbsp;<span class="ident" id="1652541">_CaseSend</span>&nbsp;<span class="op" id="1652551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1652557">c</span><span class="op" id="1652558">.</span><span class="ident" id="1652559">sendq</span><span class="op" id="1652564">.</span><span class="ident" id="1652565">dequeueSudoG</span><span class="op" id="1652577">(</span><span class="ident" id="1652578">sglist</span><span class="op" id="1652584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1652589">}</span>&nbsp;<span class="keyword" id="1652591">else</span>&nbsp;<span class="op" id="1652596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1652602">c</span><span class="op" id="1652603">.</span><span class="ident" id="1652604">recvq</span><span class="op" id="1652609">.</span><span class="ident" id="1652610">dequeueSudoG</span><span class="op" id="1652622">(</span><span class="ident" id="1652623">sglist</span><span class="op" id="1652629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1652634">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1652638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1652642">sgnext</span>&nbsp;<span class="op" id="1652649">=</span>&nbsp;<span class="ident" id="1652651">sglist</span><span class="op" id="1652657">.</span><span class="ident" id="1652658">waitlink</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1652669">sglist</span><span class="op" id="1652675">.</span><span class="ident" id="1652676">waitlink</span>&nbsp;<span class="op" id="1652685">=</span>&nbsp;<span class="ident" id="1652687">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1652693">releaseSudog</span><span class="op" id="1652705">(</span><span class="ident" id="1652706">sglist</span><span class="op" id="1652712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1652716">sglist</span>&nbsp;<span class="op" id="1652723">=</span>&nbsp;<span class="ident" id="1652725">sgnext</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1652733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1652737">if</span>&nbsp;<span class="ident" id="1652740">cas</span>&nbsp;<span class="op" id="1652744">==</span>&nbsp;<span class="ident" id="1652747">nil</span>&nbsp;<span class="op" id="1652751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1652755">goto</span>&nbsp;<span class="ident" id="1652760">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1652766">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1652770">c</span>&nbsp;<span class="op" id="1652772">=</span>&nbsp;<span class="ident" id="1652774">cas</span><span class="op" id="1652777">.</span><span class="ident" id="1652778">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1652786">if</span>&nbsp;<span class="ident" id="1652789">c</span><span class="op" id="1652790">.</span><span class="ident" id="1652791">dataqsiz</span>&nbsp;<span class="op" id="1652800">&gt;</span>&nbsp;<span class="num" id="1652802">0</span>&nbsp;<span class="op" id="1652804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1652808">gothrow</span><span class="op" id="1652815">(</span><span class="string" id="1652816">&#34;selectgo:&nbsp;shouldn&#39;t&nbsp;happen&#34;</span><span class="op" id="1652844">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1652847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1652851">if</span>&nbsp;<span class="ident" id="1652854">debugSelect</span>&nbsp;<span class="op" id="1652866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1652870">print</span><span class="op" id="1652875">(</span><span class="string" id="1652876">&#34;wait-return:&nbsp;sel=&#34;</span><span class="op" id="1652895">,</span>&nbsp;<span class="ident" id="1652897">sel</span><span class="op" id="1652900">,</span>&nbsp;<span class="string" id="1652902">&#34;&nbsp;c=&#34;</span><span class="op" id="1652907">,</span>&nbsp;<span class="ident" id="1652909">c</span><span class="op" id="1652910">,</span>&nbsp;<span class="string" id="1652912">&#34;&nbsp;cas=&#34;</span><span class="op" id="1652919">,</span>&nbsp;<span class="ident" id="1652921">cas</span><span class="op" id="1652924">,</span>&nbsp;<span class="string" id="1652926">&#34;&nbsp;kind=&#34;</span><span class="op" id="1652934">,</span>&nbsp;<span class="ident" id="1652936">cas</span><span class="op" id="1652939">.</span><span class="ident" id="1652940">kind</span><span class="op" id="1652944">,</span>&nbsp;<span class="string" id="1652946">&#34;\n&#34;</span><span class="op" id="1652950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1652953">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1652957">if</span>&nbsp;<span class="ident" id="1652960">cas</span><span class="op" id="1652963">.</span><span class="ident" id="1652964">kind</span>&nbsp;<span class="op" id="1652969">==</span>&nbsp;<span class="ident" id="1652972">_CaseRecv</span>&nbsp;<span class="op" id="1652982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1652986">if</span>&nbsp;<span class="ident" id="1652989">cas</span><span class="op" id="1652992">.</span><span class="ident" id="1652993">receivedp</span>&nbsp;<span class="op" id="1653003">!=</span>&nbsp;<span class="ident" id="1653006">nil</span>&nbsp;<span class="op" id="1653010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1653015">*</span><span class="ident" id="1653016">cas</span><span class="op" id="1653019">.</span><span class="ident" id="1653020">receivedp</span>&nbsp;<span class="op" id="1653030">=</span>&nbsp;<span class="builtintype" id="1653032">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1653039">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1653042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1653046">if</span>&nbsp;<span class="ident" id="1653049">raceenabled</span>&nbsp;<span class="op" id="1653061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1653065">if</span>&nbsp;<span class="ident" id="1653068">cas</span><span class="op" id="1653071">.</span><span class="ident" id="1653072">kind</span>&nbsp;<span class="op" id="1653077">==</span>&nbsp;<span class="ident" id="1653080">_CaseRecv</span>&nbsp;<span class="op" id="1653090">&amp;&amp;</span>&nbsp;<span class="ident" id="1653093">cas</span><span class="op" id="1653096">.</span><span class="ident" id="1653097">elem</span>&nbsp;<span class="op" id="1653102">!=</span>&nbsp;<span class="ident" id="1653105">nil</span>&nbsp;<span class="op" id="1653109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1653114">raceWriteObjectPC</span><span class="op" id="1653131">(</span><span class="ident" id="1653132">c</span><span class="op" id="1653133">.</span><span class="ident" id="1653134">elemtype</span><span class="op" id="1653142">,</span>&nbsp;<span class="ident" id="1653144">cas</span><span class="op" id="1653147">.</span><span class="ident" id="1653148">elem</span><span class="op" id="1653152">,</span>&nbsp;<span class="ident" id="1653154">cas</span><span class="op" id="1653157">.</span><span class="ident" id="1653158">pc</span><span class="op" id="1653160">,</span>&nbsp;<span class="ident" id="1653162">chanrecvpc</span><span class="op" id="1653172">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1653176">}</span>&nbsp;<span class="keyword" id="1653178">else</span>&nbsp;<span class="keyword" id="1653183">if</span>&nbsp;<span class="ident" id="1653186">cas</span><span class="op" id="1653189">.</span><span class="ident" id="1653190">kind</span>&nbsp;<span class="op" id="1653195">==</span>&nbsp;<span class="ident" id="1653198">_CaseSend</span>&nbsp;<span class="op" id="1653208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1653213">raceReadObjectPC</span><span class="op" id="1653229">(</span><span class="ident" id="1653230">c</span><span class="op" id="1653231">.</span><span class="ident" id="1653232">elemtype</span><span class="op" id="1653240">,</span>&nbsp;<span class="ident" id="1653242">cas</span><span class="op" id="1653245">.</span><span class="ident" id="1653246">elem</span><span class="op" id="1653250">,</span>&nbsp;<span class="ident" id="1653252">cas</span><span class="op" id="1653255">.</span><span class="ident" id="1653256">pc</span><span class="op" id="1653258">,</span>&nbsp;<span class="ident" id="1653260">chansendpc</span><span class="op" id="1653270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1653274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1653277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1653281">selunlock</span><span class="op" id="1653290">(</span><span class="ident" id="1653291">sel</span><span class="op" id="1653294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1653297">goto</span>&nbsp;<span class="ident" id="1653302">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1653308">asyncrecv</span><span class="op" id="1653317">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1653320">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;buffer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1653348">if</span>&nbsp;<span class="ident" id="1653351">raceenabled</span>&nbsp;<span class="op" id="1653363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1653367">if</span>&nbsp;<span class="ident" id="1653370">cas</span><span class="op" id="1653373">.</span><span class="ident" id="1653374">elem</span>&nbsp;<span class="op" id="1653379">!=</span>&nbsp;<span class="ident" id="1653382">nil</span>&nbsp;<span class="op" id="1653386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1653391">raceWriteObjectPC</span><span class="op" id="1653408">(</span><span class="ident" id="1653409">c</span><span class="op" id="1653410">.</span><span class="ident" id="1653411">elemtype</span><span class="op" id="1653419">,</span>&nbsp;<span class="ident" id="1653421">cas</span><span class="op" id="1653424">.</span><span class="ident" id="1653425">elem</span><span class="op" id="1653429">,</span>&nbsp;<span class="ident" id="1653431">cas</span><span class="op" id="1653434">.</span><span class="ident" id="1653435">pc</span><span class="op" id="1653437">,</span>&nbsp;<span class="ident" id="1653439">chanrecvpc</span><span class="op" id="1653449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1653453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1653457">raceacquire</span><span class="op" id="1653468">(</span><span class="ident" id="1653469">chanbuf</span><span class="op" id="1653476">(</span><span class="ident" id="1653477">c</span><span class="op" id="1653478">,</span>&nbsp;<span class="ident" id="1653480">c</span><span class="op" id="1653481">.</span><span class="ident" id="1653482">recvx</span><span class="op" id="1653487">)</span><span class="op" id="1653488">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1653492">racerelease</span><span class="op" id="1653503">(</span><span class="ident" id="1653504">chanbuf</span><span class="op" id="1653511">(</span><span class="ident" id="1653512">c</span><span class="op" id="1653513">,</span>&nbsp;<span class="ident" id="1653515">c</span><span class="op" id="1653516">.</span><span class="ident" id="1653517">recvx</span><span class="op" id="1653522">)</span><span class="op" id="1653523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1653526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1653529">if</span>&nbsp;<span class="ident" id="1653532">cas</span><span class="op" id="1653535">.</span><span class="ident" id="1653536">receivedp</span>&nbsp;<span class="op" id="1653546">!=</span>&nbsp;<span class="ident" id="1653549">nil</span>&nbsp;<span class="op" id="1653553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1653557">*</span><span class="ident" id="1653558">cas</span><span class="op" id="1653561">.</span><span class="ident" id="1653562">receivedp</span>&nbsp;<span class="op" id="1653572">=</span>&nbsp;<span class="builtintype" id="1653574">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1653580">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1653583">if</span>&nbsp;<span class="ident" id="1653586">cas</span><span class="op" id="1653589">.</span><span class="ident" id="1653590">elem</span>&nbsp;<span class="op" id="1653595">!=</span>&nbsp;<span class="ident" id="1653598">nil</span>&nbsp;<span class="op" id="1653602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1653606">memmove</span><span class="op" id="1653613">(</span><span class="ident" id="1653614">cas</span><span class="op" id="1653617">.</span><span class="ident" id="1653618">elem</span><span class="op" id="1653622">,</span>&nbsp;<span class="ident" id="1653624">chanbuf</span><span class="op" id="1653631">(</span><span class="ident" id="1653632">c</span><span class="op" id="1653633">,</span>&nbsp;<span class="ident" id="1653635">c</span><span class="op" id="1653636">.</span><span class="ident" id="1653637">recvx</span><span class="op" id="1653642">)</span><span class="op" id="1653643">,</span>&nbsp;<span class="builtintype" id="1653645">uintptr</span><span class="op" id="1653652">(</span><span class="ident" id="1653653">c</span><span class="op" id="1653654">.</span><span class="ident" id="1653655">elemsize</span><span class="op" id="1653663">)</span><span class="op" id="1653664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1653667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1653670">memclr</span><span class="op" id="1653676">(</span><span class="ident" id="1653677">chanbuf</span><span class="op" id="1653684">(</span><span class="ident" id="1653685">c</span><span class="op" id="1653686">,</span>&nbsp;<span class="ident" id="1653688">c</span><span class="op" id="1653689">.</span><span class="ident" id="1653690">recvx</span><span class="op" id="1653695">)</span><span class="op" id="1653696">,</span>&nbsp;<span class="builtintype" id="1653698">uintptr</span><span class="op" id="1653705">(</span><span class="ident" id="1653706">c</span><span class="op" id="1653707">.</span><span class="ident" id="1653708">elemsize</span><span class="op" id="1653716">)</span><span class="op" id="1653717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1653720">c</span><span class="op" id="1653721">.</span><span class="ident" id="1653722">recvx</span><span class="op" id="1653727">++</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1653731">if</span>&nbsp;<span class="ident" id="1653734">c</span><span class="op" id="1653735">.</span><span class="ident" id="1653736">recvx</span>&nbsp;<span class="op" id="1653742">==</span>&nbsp;<span class="ident" id="1653745">c</span><span class="op" id="1653746">.</span><span class="ident" id="1653747">dataqsiz</span>&nbsp;<span class="op" id="1653756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1653760">c</span><span class="op" id="1653761">.</span><span class="ident" id="1653762">recvx</span>&nbsp;<span class="op" id="1653768">=</span>&nbsp;<span class="num" id="1653770">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1653773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1653776">c</span><span class="op" id="1653777">.</span><span class="ident" id="1653778">qcount</span><span class="op" id="1653784">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1653788">sg</span>&nbsp;<span class="op" id="1653791">=</span>&nbsp;<span class="ident" id="1653793">c</span><span class="op" id="1653794">.</span><span class="ident" id="1653795">sendq</span><span class="op" id="1653800">.</span><span class="ident" id="1653801">dequeue</span><span class="op" id="1653808">(</span><span class="op" id="1653809">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1653812">if</span>&nbsp;<span class="ident" id="1653815">sg</span>&nbsp;<span class="op" id="1653818">!=</span>&nbsp;<span class="ident" id="1653821">nil</span>&nbsp;<span class="op" id="1653825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1653829">gp</span>&nbsp;<span class="op" id="1653832">=</span>&nbsp;<span class="ident" id="1653834">sg</span><span class="op" id="1653836">.</span><span class="ident" id="1653837">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1653841">selunlock</span><span class="op" id="1653850">(</span><span class="ident" id="1653851">sel</span><span class="op" id="1653854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1653858">if</span>&nbsp;<span class="ident" id="1653861">sg</span><span class="op" id="1653863">.</span><span class="ident" id="1653864">releasetime</span>&nbsp;<span class="op" id="1653876">!=</span>&nbsp;<span class="num" id="1653879">0</span>&nbsp;<span class="op" id="1653881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1653886">sg</span><span class="op" id="1653888">.</span><span class="ident" id="1653889">releasetime</span>&nbsp;<span class="op" id="1653901">=</span>&nbsp;<span class="ident" id="1653903">cputicks</span><span class="op" id="1653911">(</span><span class="op" id="1653912">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1653916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1653920">goready</span><span class="op" id="1653927">(</span><span class="ident" id="1653928">gp</span><span class="op" id="1653930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1653933">}</span>&nbsp;<span class="keyword" id="1653935">else</span>&nbsp;<span class="op" id="1653940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1653944">selunlock</span><span class="op" id="1653953">(</span><span class="ident" id="1653954">sel</span><span class="op" id="1653957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1653960">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1653963">goto</span>&nbsp;<span class="ident" id="1653968">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1653974">asyncsend</span><span class="op" id="1653983">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1653986">//&nbsp;can&nbsp;send&nbsp;to&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1654009">if</span>&nbsp;<span class="ident" id="1654012">raceenabled</span>&nbsp;<span class="op" id="1654024">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654028">raceacquire</span><span class="op" id="1654039">(</span><span class="ident" id="1654040">chanbuf</span><span class="op" id="1654047">(</span><span class="ident" id="1654048">c</span><span class="op" id="1654049">,</span>&nbsp;<span class="ident" id="1654051">c</span><span class="op" id="1654052">.</span><span class="ident" id="1654053">sendx</span><span class="op" id="1654058">)</span><span class="op" id="1654059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654063">racerelease</span><span class="op" id="1654074">(</span><span class="ident" id="1654075">chanbuf</span><span class="op" id="1654082">(</span><span class="ident" id="1654083">c</span><span class="op" id="1654084">,</span>&nbsp;<span class="ident" id="1654086">c</span><span class="op" id="1654087">.</span><span class="ident" id="1654088">sendx</span><span class="op" id="1654093">)</span><span class="op" id="1654094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654098">raceReadObjectPC</span><span class="op" id="1654114">(</span><span class="ident" id="1654115">c</span><span class="op" id="1654116">.</span><span class="ident" id="1654117">elemtype</span><span class="op" id="1654125">,</span>&nbsp;<span class="ident" id="1654127">cas</span><span class="op" id="1654130">.</span><span class="ident" id="1654131">elem</span><span class="op" id="1654135">,</span>&nbsp;<span class="ident" id="1654137">cas</span><span class="op" id="1654140">.</span><span class="ident" id="1654141">pc</span><span class="op" id="1654143">,</span>&nbsp;<span class="ident" id="1654145">chansendpc</span><span class="op" id="1654155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1654158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654161">memmove</span><span class="op" id="1654168">(</span><span class="ident" id="1654169">chanbuf</span><span class="op" id="1654176">(</span><span class="ident" id="1654177">c</span><span class="op" id="1654178">,</span>&nbsp;<span class="ident" id="1654180">c</span><span class="op" id="1654181">.</span><span class="ident" id="1654182">sendx</span><span class="op" id="1654187">)</span><span class="op" id="1654188">,</span>&nbsp;<span class="ident" id="1654190">cas</span><span class="op" id="1654193">.</span><span class="ident" id="1654194">elem</span><span class="op" id="1654198">,</span>&nbsp;<span class="builtintype" id="1654200">uintptr</span><span class="op" id="1654207">(</span><span class="ident" id="1654208">c</span><span class="op" id="1654209">.</span><span class="ident" id="1654210">elemsize</span><span class="op" id="1654218">)</span><span class="op" id="1654219">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654222">c</span><span class="op" id="1654223">.</span><span class="ident" id="1654224">sendx</span><span class="op" id="1654229">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1654233">if</span>&nbsp;<span class="ident" id="1654236">c</span><span class="op" id="1654237">.</span><span class="ident" id="1654238">sendx</span>&nbsp;<span class="op" id="1654244">==</span>&nbsp;<span class="ident" id="1654247">c</span><span class="op" id="1654248">.</span><span class="ident" id="1654249">dataqsiz</span>&nbsp;<span class="op" id="1654258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654262">c</span><span class="op" id="1654263">.</span><span class="ident" id="1654264">sendx</span>&nbsp;<span class="op" id="1654270">=</span>&nbsp;<span class="num" id="1654272">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1654275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654278">c</span><span class="op" id="1654279">.</span><span class="ident" id="1654280">qcount</span><span class="op" id="1654286">++</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654290">sg</span>&nbsp;<span class="op" id="1654293">=</span>&nbsp;<span class="ident" id="1654295">c</span><span class="op" id="1654296">.</span><span class="ident" id="1654297">recvq</span><span class="op" id="1654302">.</span><span class="ident" id="1654303">dequeue</span><span class="op" id="1654310">(</span><span class="op" id="1654311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1654314">if</span>&nbsp;<span class="ident" id="1654317">sg</span>&nbsp;<span class="op" id="1654320">!=</span>&nbsp;<span class="ident" id="1654323">nil</span>&nbsp;<span class="op" id="1654327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654331">gp</span>&nbsp;<span class="op" id="1654334">=</span>&nbsp;<span class="ident" id="1654336">sg</span><span class="op" id="1654338">.</span><span class="ident" id="1654339">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654343">selunlock</span><span class="op" id="1654352">(</span><span class="ident" id="1654353">sel</span><span class="op" id="1654356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1654360">if</span>&nbsp;<span class="ident" id="1654363">sg</span><span class="op" id="1654365">.</span><span class="ident" id="1654366">releasetime</span>&nbsp;<span class="op" id="1654378">!=</span>&nbsp;<span class="num" id="1654381">0</span>&nbsp;<span class="op" id="1654383">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654388">sg</span><span class="op" id="1654390">.</span><span class="ident" id="1654391">releasetime</span>&nbsp;<span class="op" id="1654403">=</span>&nbsp;<span class="ident" id="1654405">cputicks</span><span class="op" id="1654413">(</span><span class="op" id="1654414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1654418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654422">goready</span><span class="op" id="1654429">(</span><span class="ident" id="1654430">gp</span><span class="op" id="1654432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1654435">}</span>&nbsp;<span class="keyword" id="1654437">else</span>&nbsp;<span class="op" id="1654442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654446">selunlock</span><span class="op" id="1654455">(</span><span class="ident" id="1654456">sel</span><span class="op" id="1654459">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1654462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1654465">goto</span>&nbsp;<span class="ident" id="1654470">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1654476">syncrecv</span><span class="op" id="1654484">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1654487">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;sleeping&nbsp;sender&nbsp;(sg)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1654529">if</span>&nbsp;<span class="ident" id="1654532">raceenabled</span>&nbsp;<span class="op" id="1654544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1654548">if</span>&nbsp;<span class="ident" id="1654551">cas</span><span class="op" id="1654554">.</span><span class="ident" id="1654555">elem</span>&nbsp;<span class="op" id="1654560">!=</span>&nbsp;<span class="ident" id="1654563">nil</span>&nbsp;<span class="op" id="1654567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654572">raceWriteObjectPC</span><span class="op" id="1654589">(</span><span class="ident" id="1654590">c</span><span class="op" id="1654591">.</span><span class="ident" id="1654592">elemtype</span><span class="op" id="1654600">,</span>&nbsp;<span class="ident" id="1654602">cas</span><span class="op" id="1654605">.</span><span class="ident" id="1654606">elem</span><span class="op" id="1654610">,</span>&nbsp;<span class="ident" id="1654612">cas</span><span class="op" id="1654615">.</span><span class="ident" id="1654616">pc</span><span class="op" id="1654618">,</span>&nbsp;<span class="ident" id="1654620">chanrecvpc</span><span class="op" id="1654630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1654634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654638">racesync</span><span class="op" id="1654646">(</span><span class="ident" id="1654647">c</span><span class="op" id="1654648">,</span>&nbsp;<span class="ident" id="1654650">sg</span><span class="op" id="1654652">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1654655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654658">selunlock</span><span class="op" id="1654667">(</span><span class="ident" id="1654668">sel</span><span class="op" id="1654671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1654674">if</span>&nbsp;<span class="ident" id="1654677">debugSelect</span>&nbsp;<span class="op" id="1654689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1654693">print</span><span class="op" id="1654698">(</span><span class="string" id="1654699">&#34;syncrecv:&nbsp;sel=&#34;</span><span class="op" id="1654715">,</span>&nbsp;<span class="ident" id="1654717">sel</span><span class="op" id="1654720">,</span>&nbsp;<span class="string" id="1654722">&#34;&nbsp;c=&#34;</span><span class="op" id="1654727">,</span>&nbsp;<span class="ident" id="1654729">c</span><span class="op" id="1654730">,</span>&nbsp;<span class="string" id="1654732">&#34;\n&#34;</span><span class="op" id="1654736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1654739">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1654742">if</span>&nbsp;<span class="ident" id="1654745">cas</span><span class="op" id="1654748">.</span><span class="ident" id="1654749">receivedp</span>&nbsp;<span class="op" id="1654759">!=</span>&nbsp;<span class="ident" id="1654762">nil</span>&nbsp;<span class="op" id="1654766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1654770">*</span><span class="ident" id="1654771">cas</span><span class="op" id="1654774">.</span><span class="ident" id="1654775">receivedp</span>&nbsp;<span class="op" id="1654785">=</span>&nbsp;<span class="builtintype" id="1654787">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1654793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1654796">if</span>&nbsp;<span class="ident" id="1654799">cas</span><span class="op" id="1654802">.</span><span class="ident" id="1654803">elem</span>&nbsp;<span class="op" id="1654808">!=</span>&nbsp;<span class="ident" id="1654811">nil</span>&nbsp;<span class="op" id="1654815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654819">memmove</span><span class="op" id="1654826">(</span><span class="ident" id="1654827">cas</span><span class="op" id="1654830">.</span><span class="ident" id="1654831">elem</span><span class="op" id="1654835">,</span>&nbsp;<span class="ident" id="1654837">sg</span><span class="op" id="1654839">.</span><span class="ident" id="1654840">elem</span><span class="op" id="1654844">,</span>&nbsp;<span class="builtintype" id="1654846">uintptr</span><span class="op" id="1654853">(</span><span class="ident" id="1654854">c</span><span class="op" id="1654855">.</span><span class="ident" id="1654856">elemsize</span><span class="op" id="1654864">)</span><span class="op" id="1654865">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1654868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654871">sg</span><span class="op" id="1654873">.</span><span class="ident" id="1654874">elem</span>&nbsp;<span class="op" id="1654879">=</span>&nbsp;<span class="ident" id="1654881">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654886">gp</span>&nbsp;<span class="op" id="1654889">=</span>&nbsp;<span class="ident" id="1654891">sg</span><span class="op" id="1654893">.</span><span class="ident" id="1654894">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654897">gp</span><span class="op" id="1654899">.</span><span class="ident" id="1654900">param</span>&nbsp;<span class="op" id="1654906">=</span>&nbsp;<span class="ident" id="1654908">unsafe</span><span class="op" id="1654914">.</span><span class="ident" id="1654915">Pointer</span><span class="op" id="1654922">(</span><span class="ident" id="1654923">sg</span><span class="op" id="1654925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1654928">if</span>&nbsp;<span class="ident" id="1654931">sg</span><span class="op" id="1654933">.</span><span class="ident" id="1654934">releasetime</span>&nbsp;<span class="op" id="1654946">!=</span>&nbsp;<span class="num" id="1654949">0</span>&nbsp;<span class="op" id="1654951">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654955">sg</span><span class="op" id="1654957">.</span><span class="ident" id="1654958">releasetime</span>&nbsp;<span class="op" id="1654970">=</span>&nbsp;<span class="ident" id="1654972">cputicks</span><span class="op" id="1654980">(</span><span class="op" id="1654981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1654984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1654987">goready</span><span class="op" id="1654994">(</span><span class="ident" id="1654995">gp</span><span class="op" id="1654997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1655000">goto</span>&nbsp;<span class="ident" id="1655005">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="ident" id="1655011">rclose</span><span class="op" id="1655017">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1655020">//&nbsp;read&nbsp;at&nbsp;end&nbsp;of&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1655054">selunlock</span><span class="op" id="1655063">(</span><span class="ident" id="1655064">sel</span><span class="op" id="1655067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1655070">if</span>&nbsp;<span class="ident" id="1655073">cas</span><span class="op" id="1655076">.</span><span class="ident" id="1655077">receivedp</span>&nbsp;<span class="op" id="1655087">!=</span>&nbsp;<span class="ident" id="1655090">nil</span>&nbsp;<span class="op" id="1655094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1655098">*</span><span class="ident" id="1655099">cas</span><span class="op" id="1655102">.</span><span class="ident" id="1655103">receivedp</span>&nbsp;<span class="op" id="1655113">=</span>&nbsp;<span class="builtintype" id="1655115">false</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1655122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1655125">if</span>&nbsp;<span class="ident" id="1655128">cas</span><span class="op" id="1655131">.</span><span class="ident" id="1655132">elem</span>&nbsp;<span class="op" id="1655137">!=</span>&nbsp;<span class="ident" id="1655140">nil</span>&nbsp;<span class="op" id="1655144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1655148">memclr</span><span class="op" id="1655154">(</span><span class="ident" id="1655155">cas</span><span class="op" id="1655158">.</span><span class="ident" id="1655159">elem</span><span class="op" id="1655163">,</span>&nbsp;<span class="builtintype" id="1655165">uintptr</span><span class="op" id="1655172">(</span><span class="ident" id="1655173">c</span><span class="op" id="1655174">.</span><span class="ident" id="1655175">elemsize</span><span class="op" id="1655183">)</span><span class="op" id="1655184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1655187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1655190">if</span>&nbsp;<span class="ident" id="1655193">raceenabled</span>&nbsp;<span class="op" id="1655205">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1655209">raceacquire</span><span class="op" id="1655220">(</span><span class="ident" id="1655221">unsafe</span><span class="op" id="1655227">.</span><span class="ident" id="1655228">Pointer</span><span class="op" id="1655235">(</span><span class="ident" id="1655236">c</span><span class="op" id="1655237">)</span><span class="op" id="1655238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1655241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1655244">goto</span>&nbsp;<span class="ident" id="1655249">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1655255">syncsend</span><span class="op" id="1655263">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1655266">//&nbsp;can&nbsp;send&nbsp;to&nbsp;sleeping&nbsp;receiver&nbsp;(sg)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1655305">if</span>&nbsp;<span class="ident" id="1655308">raceenabled</span>&nbsp;<span class="op" id="1655320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1655324">raceReadObjectPC</span><span class="op" id="1655340">(</span><span class="ident" id="1655341">c</span><span class="op" id="1655342">.</span><span class="ident" id="1655343">elemtype</span><span class="op" id="1655351">,</span>&nbsp;<span class="ident" id="1655353">cas</span><span class="op" id="1655356">.</span><span class="ident" id="1655357">elem</span><span class="op" id="1655361">,</span>&nbsp;<span class="ident" id="1655363">cas</span><span class="op" id="1655366">.</span><span class="ident" id="1655367">pc</span><span class="op" id="1655369">,</span>&nbsp;<span class="ident" id="1655371">chansendpc</span><span class="op" id="1655381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1655385">racesync</span><span class="op" id="1655393">(</span><span class="ident" id="1655394">c</span><span class="op" id="1655395">,</span>&nbsp;<span class="ident" id="1655397">sg</span><span class="op" id="1655399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1655402">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1655405">selunlock</span><span class="op" id="1655414">(</span><span class="ident" id="1655415">sel</span><span class="op" id="1655418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1655421">if</span>&nbsp;<span class="ident" id="1655424">debugSelect</span>&nbsp;<span class="op" id="1655436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1655440">print</span><span class="op" id="1655445">(</span><span class="string" id="1655446">&#34;syncsend:&nbsp;sel=&#34;</span><span class="op" id="1655462">,</span>&nbsp;<span class="ident" id="1655464">sel</span><span class="op" id="1655467">,</span>&nbsp;<span class="string" id="1655469">&#34;&nbsp;c=&#34;</span><span class="op" id="1655474">,</span>&nbsp;<span class="ident" id="1655476">c</span><span class="op" id="1655477">,</span>&nbsp;<span class="string" id="1655479">&#34;\n&#34;</span><span class="op" id="1655483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1655486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1655489">if</span>&nbsp;<span class="ident" id="1655492">sg</span><span class="op" id="1655494">.</span><span class="ident" id="1655495">elem</span>&nbsp;<span class="op" id="1655500">!=</span>&nbsp;<span class="ident" id="1655503">nil</span>&nbsp;<span class="op" id="1655507">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1655511">memmove</span><span class="op" id="1655518">(</span><span class="ident" id="1655519">sg</span><span class="op" id="1655521">.</span><span class="ident" id="1655522">elem</span><span class="op" id="1655526">,</span>&nbsp;<span class="ident" id="1655528">cas</span><span class="op" id="1655531">.</span><span class="ident" id="1655532">elem</span><span class="op" id="1655536">,</span>&nbsp;<span class="builtintype" id="1655538">uintptr</span><span class="op" id="1655545">(</span><span class="ident" id="1655546">c</span><span class="op" id="1655547">.</span><span class="ident" id="1655548">elemsize</span><span class="op" id="1655556">)</span><span class="op" id="1655557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1655560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1655563">sg</span><span class="op" id="1655565">.</span><span class="ident" id="1655566">elem</span>&nbsp;<span class="op" id="1655571">=</span>&nbsp;<span class="ident" id="1655573">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1655578">gp</span>&nbsp;<span class="op" id="1655581">=</span>&nbsp;<span class="ident" id="1655583">sg</span><span class="op" id="1655585">.</span><span class="ident" id="1655586">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1655589">gp</span><span class="op" id="1655591">.</span><span class="ident" id="1655592">param</span>&nbsp;<span class="op" id="1655598">=</span>&nbsp;<span class="ident" id="1655600">unsafe</span><span class="op" id="1655606">.</span><span class="ident" id="1655607">Pointer</span><span class="op" id="1655614">(</span><span class="ident" id="1655615">sg</span><span class="op" id="1655617">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1655620">if</span>&nbsp;<span class="ident" id="1655623">sg</span><span class="op" id="1655625">.</span><span class="ident" id="1655626">releasetime</span>&nbsp;<span class="op" id="1655638">!=</span>&nbsp;<span class="num" id="1655641">0</span>&nbsp;<span class="op" id="1655643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1655647">sg</span><span class="op" id="1655649">.</span><span class="ident" id="1655650">releasetime</span>&nbsp;<span class="op" id="1655662">=</span>&nbsp;<span class="ident" id="1655664">cputicks</span><span class="op" id="1655672">(</span><span class="op" id="1655673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1655676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1655679">goready</span><span class="op" id="1655686">(</span><span class="ident" id="1655687">gp</span><span class="op" id="1655689">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span><span class="ident" id="1655692">retc</span><span class="op" id="1655696">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1655699">if</span>&nbsp;<span class="ident" id="1655702">cas</span><span class="op" id="1655705">.</span><span class="ident" id="1655706">releasetime</span>&nbsp;<span class="op" id="1655718">&gt;</span>&nbsp;<span class="num" id="1655720">0</span>&nbsp;<span class="op" id="1655722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1655726">blockevent</span><span class="op" id="1655736">(</span><span class="ident" id="1655737">cas</span><span class="op" id="1655740">.</span><span class="ident" id="1655741">releasetime</span><span class="op" id="1655752">-</span><span class="ident" id="1655753">t0</span><span class="op" id="1655755">,</span>&nbsp;<span class="num" id="1655757">2</span><span class="op" id="1655758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1655761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1655764">return</span>&nbsp;<span class="ident" id="1655771">cas</span><span class="op" id="1655774">.</span><span class="ident" id="1655775">pc</span><span class="op" id="1655777">,</span>&nbsp;<span class="ident" id="1655779">cas</span><span class="op" id="1655782">.</span><span class="ident" id="1655783">so</span><br>
<span class="lineno">570</span><br>
<span class="lineno"></span><span class="ident" id="1655787">sclose</span><span class="op" id="1655793">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1655796">//&nbsp;send&nbsp;on&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1655823">selunlock</span><span class="op" id="1655832">(</span><span class="ident" id="1655833">sel</span><span class="op" id="1655836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1655839">panic</span><span class="op" id="1655844">(</span><span class="string" id="1655845">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1655869">)</span><br>
<span class="lineno">575</span><span class="op" id="1655871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1655874">func</span>&nbsp;<span class="op" id="1655879">(</span><span class="ident" id="1655880">c</span>&nbsp;<span class="op" id="1655882">*</span><span class="ident" id="1655883">hchan</span><span class="op" id="1655888">)</span>&nbsp;<span class="ident" id="1655890">sortkey</span><span class="op" id="1655897">(</span><span class="op" id="1655898">)</span>&nbsp;<span class="builtintype" id="1655900">uintptr</span>&nbsp;<span class="op" id="1655908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1655911">//&nbsp;TODO(khr):&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;moving&nbsp;garbage&nbsp;collector,&nbsp;we&#39;ll&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1655979">//&nbsp;change&nbsp;this&nbsp;function.</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1656005">return</span>&nbsp;<span class="builtintype" id="1656012">uintptr</span><span class="op" id="1656019">(</span><span class="ident" id="1656020">unsafe</span><span class="op" id="1656026">.</span><span class="ident" id="1656027">Pointer</span><span class="op" id="1656034">(</span><span class="ident" id="1656035">c</span><span class="op" id="1656036">)</span><span class="op" id="1656037">)</span><br>
<span class="lineno"></span><span class="op" id="1656039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1656042">//&nbsp;A&nbsp;runtimeSelect&nbsp;is&nbsp;a&nbsp;single&nbsp;case&nbsp;passed&nbsp;to&nbsp;rselect.</span><br>
<span class="lineno"></span><span class="comment" id="1656097">//&nbsp;This&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/runtimeSelect</span><br>
<span class="lineno">585</span><span class="keyword" id="1656151">type</span>&nbsp;<span class="ident" id="1656156">runtimeSelect</span>&nbsp;<span class="keyword" id="1656170">struct</span>&nbsp;<span class="op" id="1656177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1656180">dir</span>&nbsp;<span class="ident" id="1656184">selectDir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1656195">typ</span>&nbsp;<span class="ident" id="1656199">unsafe</span><span class="op" id="1656205">.</span><span class="ident" id="1656206">Pointer</span>&nbsp;<span class="comment" id="1656214">//&nbsp;channel&nbsp;type&nbsp;(not&nbsp;used&nbsp;here)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1656247">ch</span>&nbsp;&nbsp;<span class="op" id="1656251">*</span><span class="ident" id="1656252">hchan</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1656266">//&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1656278">val</span>&nbsp;<span class="ident" id="1656282">unsafe</span><span class="op" id="1656288">.</span><span class="ident" id="1656289">Pointer</span>&nbsp;<span class="comment" id="1656297">//&nbsp;ptr&nbsp;to&nbsp;data&nbsp;(SendDir)&nbsp;or&nbsp;ptr&nbsp;to&nbsp;receive&nbsp;buffer&nbsp;(RecvDir)</span><br>
<span class="lineno">590</span><span class="op" id="1656357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1656360">//&nbsp;These&nbsp;values&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/SelectDir.</span><br>
<span class="lineno"></span><span class="keyword" id="1656419">type</span>&nbsp;<span class="ident" id="1656424">selectDir</span>&nbsp;<span class="builtintype" id="1656434">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span><span class="keyword" id="1656439">const</span>&nbsp;<span class="op" id="1656445">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1656448">_</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656462">selectDir</span>&nbsp;<span class="op" id="1656472">=</span>&nbsp;<span class="ident" id="1656474">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1656480">selectSend</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1656504">//&nbsp;case&nbsp;Chan&nbsp;&lt;-&nbsp;Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1656526">selectRecv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1656550">//&nbsp;case&nbsp;&lt;-Chan:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1656567">selectDefault</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1656591">//&nbsp;default</span><br>
<span class="lineno">600</span><span class="op" id="1656602">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1656605">func</span>&nbsp;<span class="ident" id="1656610">reflect_rselect</span><span class="op" id="1656625">(</span><span class="ident" id="1656626">cases</span>&nbsp;<span class="op" id="1656632">[</span><span class="op" id="1656633">]</span><span class="ident" id="1656634">runtimeSelect</span><span class="op" id="1656647">)</span>&nbsp;<span class="op" id="1656649">(</span><span class="ident" id="1656650">chosen</span>&nbsp;<span class="builtintype" id="1656657">int</span><span class="op" id="1656660">,</span>&nbsp;<span class="ident" id="1656662">recvOK</span>&nbsp;<span class="builtintype" id="1656669">bool</span><span class="op" id="1656673">)</span>&nbsp;<span class="op" id="1656675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1656678">//&nbsp;flagNoScan&nbsp;is&nbsp;safe&nbsp;here,&nbsp;because&nbsp;all&nbsp;objects&nbsp;are&nbsp;also&nbsp;referenced&nbsp;from&nbsp;cases.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1656759">size</span>&nbsp;<span class="op" id="1656764">:=</span>&nbsp;<span class="ident" id="1656767">selectsize</span><span class="op" id="1656777">(</span><span class="builtintype" id="1656778">uintptr</span><span class="op" id="1656785">(</span><span class="builtinfunc" id="1656786">len</span><span class="op" id="1656789">(</span><span class="ident" id="1656790">cases</span><span class="op" id="1656795">)</span><span class="op" id="1656796">)</span><span class="op" id="1656797">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1656800">sel</span>&nbsp;<span class="op" id="1656804">:=</span>&nbsp;<span class="op" id="1656807">(</span><span class="op" id="1656808">*</span><span class="ident" id="1656809">_select</span><span class="op" id="1656816">)</span><span class="op" id="1656817">(</span><span class="ident" id="1656818">mallocgc</span><span class="op" id="1656826">(</span><span class="ident" id="1656827">size</span><span class="op" id="1656831">,</span>&nbsp;<span class="ident" id="1656833">nil</span><span class="op" id="1656836">,</span>&nbsp;<span class="ident" id="1656838">flagNoScan</span><span class="op" id="1656848">)</span><span class="op" id="1656849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1656852">newselect</span><span class="op" id="1656861">(</span><span class="ident" id="1656862">sel</span><span class="op" id="1656865">,</span>&nbsp;<span class="ident" id="1656867">int64</span><span class="op" id="1656872">(</span><span class="ident" id="1656873">size</span><span class="op" id="1656877">)</span><span class="op" id="1656878">,</span>&nbsp;<span class="builtintype" id="1656880">int32</span><span class="op" id="1656885">(</span><span class="builtinfunc" id="1656886">len</span><span class="op" id="1656889">(</span><span class="ident" id="1656890">cases</span><span class="op" id="1656895">)</span><span class="op" id="1656896">)</span><span class="op" id="1656897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1656900">r</span>&nbsp;<span class="op" id="1656902">:=</span>&nbsp;<span class="builtinfunc" id="1656905">new</span><span class="op" id="1656908">(</span><span class="builtintype" id="1656909">bool</span><span class="op" id="1656913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1656916">for</span>&nbsp;<span class="ident" id="1656920">i</span>&nbsp;<span class="op" id="1656922">:=</span>&nbsp;<span class="keyword" id="1656925">range</span>&nbsp;<span class="ident" id="1656931">cases</span>&nbsp;<span class="op" id="1656937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1656941">rc</span>&nbsp;<span class="op" id="1656944">:=</span>&nbsp;<span class="op" id="1656947">&amp;</span><span class="ident" id="1656948">cases</span><span class="op" id="1656953">[</span><span class="ident" id="1656954">i</span><span class="op" id="1656955">]</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1656959">switch</span>&nbsp;<span class="ident" id="1656966">rc</span><span class="op" id="1656968">.</span><span class="ident" id="1656969">dir</span>&nbsp;<span class="op" id="1656973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1656977">case</span>&nbsp;<span class="ident" id="1656982">selectDefault</span><span class="op" id="1656995">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1657000">selectdefaultImpl</span><span class="op" id="1657017">(</span><span class="ident" id="1657018">sel</span><span class="op" id="1657021">,</span>&nbsp;<span class="builtintype" id="1657023">uintptr</span><span class="op" id="1657030">(</span><span class="ident" id="1657031">i</span><span class="op" id="1657032">)</span><span class="op" id="1657033">,</span>&nbsp;<span class="num" id="1657035">0</span><span class="op" id="1657036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1657040">case</span>&nbsp;<span class="ident" id="1657045">selectSend</span><span class="op" id="1657055">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1657060">if</span>&nbsp;<span class="ident" id="1657063">rc</span><span class="op" id="1657065">.</span><span class="ident" id="1657066">ch</span>&nbsp;<span class="op" id="1657069">==</span>&nbsp;<span class="ident" id="1657072">nil</span>&nbsp;<span class="op" id="1657076">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1657082">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1657091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1657096">selectsendImpl</span><span class="op" id="1657110">(</span><span class="ident" id="1657111">sel</span><span class="op" id="1657114">,</span>&nbsp;<span class="ident" id="1657116">rc</span><span class="op" id="1657118">.</span><span class="ident" id="1657119">ch</span><span class="op" id="1657121">,</span>&nbsp;<span class="builtintype" id="1657123">uintptr</span><span class="op" id="1657130">(</span><span class="ident" id="1657131">i</span><span class="op" id="1657132">)</span><span class="op" id="1657133">,</span>&nbsp;<span class="ident" id="1657135">rc</span><span class="op" id="1657137">.</span><span class="ident" id="1657138">val</span><span class="op" id="1657141">,</span>&nbsp;<span class="num" id="1657143">0</span><span class="op" id="1657144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1657148">case</span>&nbsp;<span class="ident" id="1657153">selectRecv</span><span class="op" id="1657163">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1657168">if</span>&nbsp;<span class="ident" id="1657171">rc</span><span class="op" id="1657173">.</span><span class="ident" id="1657174">ch</span>&nbsp;<span class="op" id="1657177">==</span>&nbsp;<span class="ident" id="1657180">nil</span>&nbsp;<span class="op" id="1657184">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1657190">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1657199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1657204">selectrecvImpl</span><span class="op" id="1657218">(</span><span class="ident" id="1657219">sel</span><span class="op" id="1657222">,</span>&nbsp;<span class="ident" id="1657224">rc</span><span class="op" id="1657226">.</span><span class="ident" id="1657227">ch</span><span class="op" id="1657229">,</span>&nbsp;<span class="builtintype" id="1657231">uintptr</span><span class="op" id="1657238">(</span><span class="ident" id="1657239">i</span><span class="op" id="1657240">)</span><span class="op" id="1657241">,</span>&nbsp;<span class="ident" id="1657243">rc</span><span class="op" id="1657245">.</span><span class="ident" id="1657246">val</span><span class="op" id="1657249">,</span>&nbsp;<span class="ident" id="1657251">r</span><span class="op" id="1657252">,</span>&nbsp;<span class="num" id="1657254">0</span><span class="op" id="1657255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1657259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1657262">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1657266">pc</span><span class="op" id="1657268">,</span>&nbsp;<span class="ident" id="1657270">_</span>&nbsp;<span class="op" id="1657272">:=</span>&nbsp;<span class="ident" id="1657275">selectgoImpl</span><span class="op" id="1657287">(</span><span class="ident" id="1657288">sel</span><span class="op" id="1657291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1657294">chosen</span>&nbsp;<span class="op" id="1657301">=</span>&nbsp;<span class="builtintype" id="1657303">int</span><span class="op" id="1657306">(</span><span class="ident" id="1657307">pc</span><span class="op" id="1657309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1657312">recvOK</span>&nbsp;<span class="op" id="1657319">=</span>&nbsp;<span class="op" id="1657321">*</span><span class="ident" id="1657322">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1657325">return</span><br>
<span class="lineno">630</span><span class="op" id="1657332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1657335">func</span>&nbsp;<span class="op" id="1657340">(</span><span class="ident" id="1657341">q</span>&nbsp;<span class="op" id="1657343">*</span><span class="ident" id="1657344">waitq</span><span class="op" id="1657349">)</span>&nbsp;<span class="ident" id="1657351">dequeueSudoG</span><span class="op" id="1657363">(</span><span class="ident" id="1657364">s</span>&nbsp;<span class="op" id="1657366">*</span><span class="ident" id="1657367">sudog</span><span class="op" id="1657372">)</span>&nbsp;<span class="op" id="1657374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1657377">var</span>&nbsp;<span class="ident" id="1657381">prevsgp</span>&nbsp;<span class="op" id="1657389">*</span><span class="ident" id="1657390">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1657397">l</span>&nbsp;<span class="op" id="1657399">:=</span>&nbsp;<span class="op" id="1657402">&amp;</span><span class="ident" id="1657403">q</span><span class="op" id="1657404">.</span><span class="ident" id="1657405">first</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1657412">for</span>&nbsp;<span class="op" id="1657416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1657420">sgp</span>&nbsp;<span class="op" id="1657424">:=</span>&nbsp;<span class="op" id="1657427">*</span><span class="ident" id="1657428">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1657432">if</span>&nbsp;<span class="ident" id="1657435">sgp</span>&nbsp;<span class="op" id="1657439">==</span>&nbsp;<span class="ident" id="1657442">nil</span>&nbsp;<span class="op" id="1657446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1657451">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1657460">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1657464">if</span>&nbsp;<span class="ident" id="1657467">sgp</span>&nbsp;<span class="op" id="1657471">==</span>&nbsp;<span class="ident" id="1657474">s</span>&nbsp;<span class="op" id="1657476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1657481">*</span><span class="ident" id="1657482">l</span>&nbsp;<span class="op" id="1657484">=</span>&nbsp;<span class="ident" id="1657486">sgp</span><span class="op" id="1657489">.</span><span class="ident" id="1657490">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1657498">if</span>&nbsp;<span class="ident" id="1657501">q</span><span class="op" id="1657502">.</span><span class="ident" id="1657503">last</span>&nbsp;<span class="op" id="1657508">==</span>&nbsp;<span class="ident" id="1657511">sgp</span>&nbsp;<span class="op" id="1657515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1657521">q</span><span class="op" id="1657522">.</span><span class="ident" id="1657523">last</span>&nbsp;<span class="op" id="1657528">=</span>&nbsp;<span class="ident" id="1657530">prevsgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1657541">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1657546">s</span><span class="op" id="1657547">.</span><span class="ident" id="1657548">next</span>&nbsp;<span class="op" id="1657553">=</span>&nbsp;<span class="ident" id="1657555">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1657562">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1657571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1657575">l</span>&nbsp;<span class="op" id="1657577">=</span>&nbsp;<span class="op" id="1657579">&amp;</span><span class="ident" id="1657580">sgp</span><span class="op" id="1657583">.</span><span class="ident" id="1657584">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1657591">prevsgp</span>&nbsp;<span class="op" id="1657599">=</span>&nbsp;<span class="ident" id="1657601">sgp</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1657606">}</span><br>
<span class="lineno"></span><span class="op" id="1657608">}</span>
</div>
</body>
</html>
