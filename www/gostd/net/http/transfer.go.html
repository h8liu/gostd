<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5166408">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5166463">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5166517">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5166568">package</span>&nbsp;<span class="ident" id="5166576">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5166582">import</span>&nbsp;<span class="op" id="5166589">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5166592">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5166601">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5166610">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5166620">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5166627">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5166633">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5166646">&#34;net/http/internal&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5166667">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5166684">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5166692">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5166703">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5166714">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="5166721">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5166724">//&nbsp;ErrLineTooLong&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;request&nbsp;or&nbsp;response&nbsp;bodies</span><br>
<span class="lineno"></span><span class="comment" id="5166794">//&nbsp;with&nbsp;malformed&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="keyword" id="5166830">var</span>&nbsp;<span class="ident" id="5166834">ErrLineTooLong</span>&nbsp;<span class="op" id="5166849">=</span>&nbsp;<span class="ident" id="5166851">internal</span><span class="op" id="5166859">.</span><span class="ident" id="5166860">ErrLineTooLong</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="5166876">type</span>&nbsp;<span class="ident" id="5166881">errorReader</span>&nbsp;<span class="keyword" id="5166893">struct</span>&nbsp;<span class="op" id="5166900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5166903">err</span>&nbsp;<span class="builtintype" id="5166907">error</span><br>
<span class="lineno"></span><span class="op" id="5166913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="5166916">func</span>&nbsp;<span class="op" id="5166921">(</span><span class="ident" id="5166922">r</span>&nbsp;<span class="op" id="5166924">*</span><span class="ident" id="5166925">errorReader</span><span class="op" id="5166936">)</span>&nbsp;<span class="ident" id="5166938">Read</span><span class="op" id="5166942">(</span><span class="ident" id="5166943">p</span>&nbsp;<span class="op" id="5166945">[</span><span class="op" id="5166946">]</span><span class="builtintype" id="5166947">byte</span><span class="op" id="5166951">)</span>&nbsp;<span class="op" id="5166953">(</span><span class="ident" id="5166954">n</span>&nbsp;<span class="builtintype" id="5166956">int</span><span class="op" id="5166959">,</span>&nbsp;<span class="ident" id="5166961">err</span>&nbsp;<span class="builtintype" id="5166965">error</span><span class="op" id="5166970">)</span>&nbsp;<span class="op" id="5166972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5166975">return</span>&nbsp;<span class="num" id="5166982">0</span><span class="op" id="5166983">,</span>&nbsp;<span class="ident" id="5166985">r</span><span class="op" id="5166986">.</span><span class="ident" id="5166987">err</span><br>
<span class="lineno"></span><span class="op" id="5166991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5166994">//&nbsp;transferWriter&nbsp;inspects&nbsp;the&nbsp;fields&nbsp;of&nbsp;a&nbsp;user-supplied&nbsp;Request&nbsp;or&nbsp;Response,</span><br>
<span class="lineno">35</span><span class="comment" id="5167072">//&nbsp;sanitizes&nbsp;them&nbsp;without&nbsp;changing&nbsp;the&nbsp;user&nbsp;object&nbsp;and&nbsp;provides&nbsp;methods&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5167148">//&nbsp;writing&nbsp;the&nbsp;respective&nbsp;header,&nbsp;body&nbsp;and&nbsp;trailer&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="5167215">type</span>&nbsp;<span class="ident" id="5167220">transferWriter</span>&nbsp;<span class="keyword" id="5167235">struct</span>&nbsp;<span class="op" id="5167242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167245">Method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5167262">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167270">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167287">io</span><span class="op" id="5167289">.</span><span class="ident" id="5167290">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167298">BodyCloser</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167315">io</span><span class="op" id="5167317">.</span><span class="ident" id="5167318">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167326">ResponseToHEAD</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5167343">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167349">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167366">int64</span>&nbsp;<span class="comment" id="5167372">//&nbsp;-1&nbsp;means&nbsp;unknown,&nbsp;0&nbsp;means&nbsp;exactly&nbsp;none</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167415">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5167432">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167438">TransferEncoding</span>&nbsp;<span class="op" id="5167455">[</span><span class="op" id="5167456">]</span><span class="builtintype" id="5167457">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167465">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167482">Header</span><br>
<span class="lineno"></span><span class="op" id="5167489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5167492">func</span>&nbsp;<span class="ident" id="5167497">newTransferWriter</span><span class="op" id="5167514">(</span><span class="ident" id="5167515">r</span>&nbsp;<span class="keyword" id="5167517">interface</span><span class="op" id="5167526">{</span><span class="op" id="5167527">}</span><span class="op" id="5167528">)</span>&nbsp;<span class="op" id="5167530">(</span><span class="ident" id="5167531">t</span>&nbsp;<span class="op" id="5167533">*</span><span class="ident" id="5167534">transferWriter</span><span class="op" id="5167548">,</span>&nbsp;<span class="ident" id="5167550">err</span>&nbsp;<span class="builtintype" id="5167554">error</span><span class="op" id="5167559">)</span>&nbsp;<span class="op" id="5167561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167564">t</span>&nbsp;<span class="op" id="5167566">=</span>&nbsp;<span class="op" id="5167568">&amp;</span><span class="ident" id="5167569">transferWriter</span><span class="op" id="5167583">{</span><span class="op" id="5167584">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5167588">//&nbsp;Extract&nbsp;relevant&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167616">atLeastHTTP11</span>&nbsp;<span class="op" id="5167630">:=</span>&nbsp;<span class="builtintype" id="5167633">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5167640">switch</span>&nbsp;<span class="ident" id="5167647">rr</span>&nbsp;<span class="op" id="5167650">:=</span>&nbsp;<span class="ident" id="5167653">r</span><span class="op" id="5167654">.</span><span class="op" id="5167655">(</span><span class="keyword" id="5167656">type</span><span class="op" id="5167660">)</span>&nbsp;<span class="op" id="5167662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5167665">case</span>&nbsp;<span class="op" id="5167670">*</span><span class="ident" id="5167671">Request</span><span class="op" id="5167678">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5167682">if</span>&nbsp;<span class="ident" id="5167685">rr</span><span class="op" id="5167687">.</span><span class="ident" id="5167688">ContentLength</span>&nbsp;<span class="op" id="5167702">!=</span>&nbsp;<span class="num" id="5167705">0</span>&nbsp;<span class="op" id="5167707">&amp;&amp;</span>&nbsp;<span class="ident" id="5167710">rr</span><span class="op" id="5167712">.</span><span class="ident" id="5167713">Body</span>&nbsp;<span class="op" id="5167718">==</span>&nbsp;<span class="ident" id="5167721">nil</span>&nbsp;<span class="op" id="5167725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5167730">return</span>&nbsp;<span class="ident" id="5167737">nil</span><span class="op" id="5167740">,</span>&nbsp;<span class="ident" id="5167742">fmt</span><span class="op" id="5167745">.</span><span class="ident" id="5167746">Errorf</span><span class="op" id="5167752">(</span><span class="string" id="5167753">&#34;http:&nbsp;Request.ContentLength=%d&nbsp;with&nbsp;nil&nbsp;Body&#34;</span><span class="op" id="5167799">,</span>&nbsp;<span class="ident" id="5167801">rr</span><span class="op" id="5167803">.</span><span class="ident" id="5167804">ContentLength</span><span class="op" id="5167817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5167821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167825">t</span><span class="op" id="5167826">.</span><span class="ident" id="5167827">Method</span>&nbsp;<span class="op" id="5167834">=</span>&nbsp;<span class="ident" id="5167836">rr</span><span class="op" id="5167838">.</span><span class="ident" id="5167839">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167848">t</span><span class="op" id="5167849">.</span><span class="ident" id="5167850">Body</span>&nbsp;<span class="op" id="5167855">=</span>&nbsp;<span class="ident" id="5167857">rr</span><span class="op" id="5167859">.</span><span class="ident" id="5167860">Body</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167867">t</span><span class="op" id="5167868">.</span><span class="ident" id="5167869">BodyCloser</span>&nbsp;<span class="op" id="5167880">=</span>&nbsp;<span class="ident" id="5167882">rr</span><span class="op" id="5167884">.</span><span class="ident" id="5167885">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167892">t</span><span class="op" id="5167893">.</span><span class="ident" id="5167894">ContentLength</span>&nbsp;<span class="op" id="5167908">=</span>&nbsp;<span class="ident" id="5167910">rr</span><span class="op" id="5167912">.</span><span class="ident" id="5167913">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167929">t</span><span class="op" id="5167930">.</span><span class="ident" id="5167931">Close</span>&nbsp;<span class="op" id="5167937">=</span>&nbsp;<span class="ident" id="5167939">rr</span><span class="op" id="5167941">.</span><span class="ident" id="5167942">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167950">t</span><span class="op" id="5167951">.</span><span class="ident" id="5167952">TransferEncoding</span>&nbsp;<span class="op" id="5167969">=</span>&nbsp;<span class="ident" id="5167971">rr</span><span class="op" id="5167973">.</span><span class="ident" id="5167974">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167993">t</span><span class="op" id="5167994">.</span><span class="ident" id="5167995">Trailer</span>&nbsp;<span class="op" id="5168003">=</span>&nbsp;<span class="ident" id="5168005">rr</span><span class="op" id="5168007">.</span><span class="ident" id="5168008">Trailer</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5168018">atLeastHTTP11</span>&nbsp;<span class="op" id="5168032">=</span>&nbsp;<span class="ident" id="5168034">rr</span><span class="op" id="5168036">.</span><span class="ident" id="5168037">ProtoAtLeast</span><span class="op" id="5168049">(</span><span class="num" id="5168050">1</span><span class="op" id="5168051">,</span>&nbsp;<span class="num" id="5168053">1</span><span class="op" id="5168054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5168058">if</span>&nbsp;<span class="ident" id="5168061">t</span><span class="op" id="5168062">.</span><span class="ident" id="5168063">Body</span>&nbsp;<span class="op" id="5168068">!=</span>&nbsp;<span class="ident" id="5168071">nil</span>&nbsp;<span class="op" id="5168075">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5168078">len</span><span class="op" id="5168081">(</span><span class="ident" id="5168082">t</span><span class="op" id="5168083">.</span><span class="ident" id="5168084">TransferEncoding</span><span class="op" id="5168100">)</span>&nbsp;<span class="op" id="5168102">==</span>&nbsp;<span class="num" id="5168105">0</span>&nbsp;<span class="op" id="5168107">&amp;&amp;</span>&nbsp;<span class="ident" id="5168110">atLeastHTTP11</span>&nbsp;<span class="op" id="5168124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5168129">if</span>&nbsp;<span class="ident" id="5168132">t</span><span class="op" id="5168133">.</span><span class="ident" id="5168134">ContentLength</span>&nbsp;<span class="op" id="5168148">==</span>&nbsp;<span class="num" id="5168151">0</span>&nbsp;<span class="op" id="5168153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5168159">//&nbsp;Test&nbsp;to&nbsp;see&nbsp;if&nbsp;it&#39;s&nbsp;actually&nbsp;zero&nbsp;or&nbsp;just&nbsp;unset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5168215">var</span>&nbsp;<span class="ident" id="5168219">buf</span>&nbsp;<span class="op" id="5168223">[</span><span class="num" id="5168224">1</span><span class="op" id="5168225">]</span><span class="builtintype" id="5168226">byte</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5168235">n</span><span class="op" id="5168236">,</span>&nbsp;<span class="ident" id="5168238">rerr</span>&nbsp;<span class="op" id="5168243">:=</span>&nbsp;<span class="ident" id="5168246">io</span><span class="op" id="5168248">.</span><span class="ident" id="5168249">ReadFull</span><span class="op" id="5168257">(</span><span class="ident" id="5168258">t</span><span class="op" id="5168259">.</span><span class="ident" id="5168260">Body</span><span class="op" id="5168264">,</span>&nbsp;<span class="ident" id="5168266">buf</span><span class="op" id="5168269">[</span><span class="op" id="5168270">:</span><span class="op" id="5168271">]</span><span class="op" id="5168272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5168278">if</span>&nbsp;<span class="ident" id="5168281">rerr</span>&nbsp;<span class="op" id="5168286">!=</span>&nbsp;<span class="ident" id="5168289">nil</span>&nbsp;<span class="op" id="5168293">&amp;&amp;</span>&nbsp;<span class="ident" id="5168296">rerr</span>&nbsp;<span class="op" id="5168301">!=</span>&nbsp;<span class="ident" id="5168304">io</span><span class="op" id="5168306">.</span><span class="ident" id="5168307">EOF</span>&nbsp;<span class="op" id="5168311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5168318">t</span><span class="op" id="5168319">.</span><span class="ident" id="5168320">ContentLength</span>&nbsp;<span class="op" id="5168334">=</span>&nbsp;<span class="op" id="5168336">-</span><span class="num" id="5168337">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5168344">t</span><span class="op" id="5168345">.</span><span class="ident" id="5168346">Body</span>&nbsp;<span class="op" id="5168351">=</span>&nbsp;<span class="op" id="5168353">&amp;</span><span class="ident" id="5168354">errorReader</span><span class="op" id="5168365">{</span><span class="ident" id="5168366">rerr</span><span class="op" id="5168370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5168376">}</span>&nbsp;<span class="keyword" id="5168378">else</span>&nbsp;<span class="keyword" id="5168383">if</span>&nbsp;<span class="ident" id="5168386">n</span>&nbsp;<span class="op" id="5168388">==</span>&nbsp;<span class="num" id="5168391">1</span>&nbsp;<span class="op" id="5168393">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5168400">//&nbsp;Oh,&nbsp;guess&nbsp;there&nbsp;is&nbsp;data&nbsp;in&nbsp;this&nbsp;Body&nbsp;Reader&nbsp;after&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5168463">//&nbsp;The&nbsp;ContentLength&nbsp;field&nbsp;just&nbsp;wasn&#39;t&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5168512">//&nbsp;Stich&nbsp;the&nbsp;Body&nbsp;back&nbsp;together&nbsp;again,&nbsp;re-attaching&nbsp;our</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5168573">//&nbsp;consumed&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5168596">t</span><span class="op" id="5168597">.</span><span class="ident" id="5168598">ContentLength</span>&nbsp;<span class="op" id="5168612">=</span>&nbsp;<span class="op" id="5168614">-</span><span class="num" id="5168615">1</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5168622">t</span><span class="op" id="5168623">.</span><span class="ident" id="5168624">Body</span>&nbsp;<span class="op" id="5168629">=</span>&nbsp;<span class="ident" id="5168631">io</span><span class="op" id="5168633">.</span><span class="ident" id="5168634">MultiReader</span><span class="op" id="5168645">(</span><span class="ident" id="5168646">bytes</span><span class="op" id="5168651">.</span><span class="ident" id="5168652">NewReader</span><span class="op" id="5168661">(</span><span class="ident" id="5168662">buf</span><span class="op" id="5168665">[</span><span class="op" id="5168666">:</span><span class="op" id="5168667">]</span><span class="op" id="5168668">)</span><span class="op" id="5168669">,</span>&nbsp;<span class="ident" id="5168671">t</span><span class="op" id="5168672">.</span><span class="ident" id="5168673">Body</span><span class="op" id="5168677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5168683">}</span>&nbsp;<span class="keyword" id="5168685">else</span>&nbsp;<span class="op" id="5168690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5168697">//&nbsp;Body&nbsp;is&nbsp;actually&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5168729">t</span><span class="op" id="5168730">.</span><span class="ident" id="5168731">Body</span>&nbsp;<span class="op" id="5168736">=</span>&nbsp;<span class="ident" id="5168738">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5168747">t</span><span class="op" id="5168748">.</span><span class="ident" id="5168749">BodyCloser</span>&nbsp;<span class="op" id="5168760">=</span>&nbsp;<span class="ident" id="5168762">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5168770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5168775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5168780">if</span>&nbsp;<span class="ident" id="5168783">t</span><span class="op" id="5168784">.</span><span class="ident" id="5168785">ContentLength</span>&nbsp;<span class="op" id="5168799">&lt;</span>&nbsp;<span class="num" id="5168801">0</span>&nbsp;<span class="op" id="5168803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5168809">t</span><span class="op" id="5168810">.</span><span class="ident" id="5168811">TransferEncoding</span>&nbsp;<span class="op" id="5168828">=</span>&nbsp;<span class="op" id="5168830">[</span><span class="op" id="5168831">]</span><span class="builtintype" id="5168832">string</span><span class="op" id="5168838">{</span><span class="string" id="5168839">&#34;chunked&#34;</span><span class="op" id="5168848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5168853">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5168857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5168860">case</span>&nbsp;<span class="op" id="5168865">*</span><span class="ident" id="5168866">Response</span><span class="op" id="5168874">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5168878">if</span>&nbsp;<span class="ident" id="5168881">rr</span><span class="op" id="5168883">.</span><span class="ident" id="5168884">Request</span>&nbsp;<span class="op" id="5168892">!=</span>&nbsp;<span class="ident" id="5168895">nil</span>&nbsp;<span class="op" id="5168899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5168904">t</span><span class="op" id="5168905">.</span><span class="ident" id="5168906">Method</span>&nbsp;<span class="op" id="5168913">=</span>&nbsp;<span class="ident" id="5168915">rr</span><span class="op" id="5168917">.</span><span class="ident" id="5168918">Request</span><span class="op" id="5168925">.</span><span class="ident" id="5168926">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5168935">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5168939">t</span><span class="op" id="5168940">.</span><span class="ident" id="5168941">Body</span>&nbsp;<span class="op" id="5168946">=</span>&nbsp;<span class="ident" id="5168948">rr</span><span class="op" id="5168950">.</span><span class="ident" id="5168951">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5168958">t</span><span class="op" id="5168959">.</span><span class="ident" id="5168960">BodyCloser</span>&nbsp;<span class="op" id="5168971">=</span>&nbsp;<span class="ident" id="5168973">rr</span><span class="op" id="5168975">.</span><span class="ident" id="5168976">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5168983">t</span><span class="op" id="5168984">.</span><span class="ident" id="5168985">ContentLength</span>&nbsp;<span class="op" id="5168999">=</span>&nbsp;<span class="ident" id="5169001">rr</span><span class="op" id="5169003">.</span><span class="ident" id="5169004">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5169020">t</span><span class="op" id="5169021">.</span><span class="ident" id="5169022">Close</span>&nbsp;<span class="op" id="5169028">=</span>&nbsp;<span class="ident" id="5169030">rr</span><span class="op" id="5169032">.</span><span class="ident" id="5169033">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5169041">t</span><span class="op" id="5169042">.</span><span class="ident" id="5169043">TransferEncoding</span>&nbsp;<span class="op" id="5169060">=</span>&nbsp;<span class="ident" id="5169062">rr</span><span class="op" id="5169064">.</span><span class="ident" id="5169065">TransferEncoding</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5169084">t</span><span class="op" id="5169085">.</span><span class="ident" id="5169086">Trailer</span>&nbsp;<span class="op" id="5169094">=</span>&nbsp;<span class="ident" id="5169096">rr</span><span class="op" id="5169098">.</span><span class="ident" id="5169099">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5169109">atLeastHTTP11</span>&nbsp;<span class="op" id="5169123">=</span>&nbsp;<span class="ident" id="5169125">rr</span><span class="op" id="5169127">.</span><span class="ident" id="5169128">ProtoAtLeast</span><span class="op" id="5169140">(</span><span class="num" id="5169141">1</span><span class="op" id="5169142">,</span>&nbsp;<span class="num" id="5169144">1</span><span class="op" id="5169145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5169149">t</span><span class="op" id="5169150">.</span><span class="ident" id="5169151">ResponseToHEAD</span>&nbsp;<span class="op" id="5169166">=</span>&nbsp;<span class="ident" id="5169168">noBodyExpected</span><span class="op" id="5169182">(</span><span class="ident" id="5169183">t</span><span class="op" id="5169184">.</span><span class="ident" id="5169185">Method</span><span class="op" id="5169191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5169194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5169198">//&nbsp;Sanitize&nbsp;Body,ContentLength,TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5169247">if</span>&nbsp;<span class="ident" id="5169250">t</span><span class="op" id="5169251">.</span><span class="ident" id="5169252">ResponseToHEAD</span>&nbsp;<span class="op" id="5169267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5169271">t</span><span class="op" id="5169272">.</span><span class="ident" id="5169273">Body</span>&nbsp;<span class="op" id="5169278">=</span>&nbsp;<span class="ident" id="5169280">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5169286">if</span>&nbsp;<span class="ident" id="5169289">chunked</span><span class="op" id="5169296">(</span><span class="ident" id="5169297">t</span><span class="op" id="5169298">.</span><span class="ident" id="5169299">TransferEncoding</span><span class="op" id="5169315">)</span>&nbsp;<span class="op" id="5169317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5169322">t</span><span class="op" id="5169323">.</span><span class="ident" id="5169324">ContentLength</span>&nbsp;<span class="op" id="5169338">=</span>&nbsp;<span class="op" id="5169340">-</span><span class="num" id="5169341">1</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5169345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5169348">}</span>&nbsp;<span class="keyword" id="5169350">else</span>&nbsp;<span class="op" id="5169355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5169359">if</span>&nbsp;<span class="op" id="5169362">!</span><span class="ident" id="5169363">atLeastHTTP11</span>&nbsp;<span class="op" id="5169377">||</span>&nbsp;<span class="ident" id="5169380">t</span><span class="op" id="5169381">.</span><span class="ident" id="5169382">Body</span>&nbsp;<span class="op" id="5169387">==</span>&nbsp;<span class="ident" id="5169390">nil</span>&nbsp;<span class="op" id="5169394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5169399">t</span><span class="op" id="5169400">.</span><span class="ident" id="5169401">TransferEncoding</span>&nbsp;<span class="op" id="5169418">=</span>&nbsp;<span class="ident" id="5169420">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5169426">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5169430">if</span>&nbsp;<span class="ident" id="5169433">chunked</span><span class="op" id="5169440">(</span><span class="ident" id="5169441">t</span><span class="op" id="5169442">.</span><span class="ident" id="5169443">TransferEncoding</span><span class="op" id="5169459">)</span>&nbsp;<span class="op" id="5169461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5169466">t</span><span class="op" id="5169467">.</span><span class="ident" id="5169468">ContentLength</span>&nbsp;<span class="op" id="5169482">=</span>&nbsp;<span class="op" id="5169484">-</span><span class="num" id="5169485">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5169489">}</span>&nbsp;<span class="keyword" id="5169491">else</span>&nbsp;<span class="keyword" id="5169496">if</span>&nbsp;<span class="ident" id="5169499">t</span><span class="op" id="5169500">.</span><span class="ident" id="5169501">Body</span>&nbsp;<span class="op" id="5169506">==</span>&nbsp;<span class="ident" id="5169509">nil</span>&nbsp;<span class="op" id="5169513">{</span>&nbsp;<span class="comment" id="5169515">//&nbsp;no&nbsp;chunking,&nbsp;no&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5169542">t</span><span class="op" id="5169543">.</span><span class="ident" id="5169544">ContentLength</span>&nbsp;<span class="op" id="5169558">=</span>&nbsp;<span class="num" id="5169560">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5169564">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5169567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5169571">//&nbsp;Sanitize&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5169592">if</span>&nbsp;<span class="op" id="5169595">!</span><span class="ident" id="5169596">chunked</span><span class="op" id="5169603">(</span><span class="ident" id="5169604">t</span><span class="op" id="5169605">.</span><span class="ident" id="5169606">TransferEncoding</span><span class="op" id="5169622">)</span>&nbsp;<span class="op" id="5169624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5169628">t</span><span class="op" id="5169629">.</span><span class="ident" id="5169630">Trailer</span>&nbsp;<span class="op" id="5169638">=</span>&nbsp;<span class="ident" id="5169640">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5169645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5169649">return</span>&nbsp;<span class="ident" id="5169656">t</span><span class="op" id="5169657">,</span>&nbsp;<span class="ident" id="5169659">nil</span><br>
<span class="lineno"></span><span class="op" id="5169663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="5169666">func</span>&nbsp;<span class="ident" id="5169671">noBodyExpected</span><span class="op" id="5169685">(</span><span class="ident" id="5169686">requestMethod</span>&nbsp;<span class="builtintype" id="5169700">string</span><span class="op" id="5169706">)</span>&nbsp;<span class="builtintype" id="5169708">bool</span>&nbsp;<span class="op" id="5169713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5169716">return</span>&nbsp;<span class="ident" id="5169723">requestMethod</span>&nbsp;<span class="op" id="5169737">==</span>&nbsp;<span class="string" id="5169740">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><span class="op" id="5169747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5169750">func</span>&nbsp;<span class="op" id="5169755">(</span><span class="ident" id="5169756">t</span>&nbsp;<span class="op" id="5169758">*</span><span class="ident" id="5169759">transferWriter</span><span class="op" id="5169773">)</span>&nbsp;<span class="ident" id="5169775">shouldSendContentLength</span><span class="op" id="5169798">(</span><span class="op" id="5169799">)</span>&nbsp;<span class="builtintype" id="5169801">bool</span>&nbsp;<span class="op" id="5169806">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5169809">if</span>&nbsp;<span class="ident" id="5169812">chunked</span><span class="op" id="5169819">(</span><span class="ident" id="5169820">t</span><span class="op" id="5169821">.</span><span class="ident" id="5169822">TransferEncoding</span><span class="op" id="5169838">)</span>&nbsp;<span class="op" id="5169840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5169844">return</span>&nbsp;<span class="builtintype" id="5169851">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5169858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5169861">if</span>&nbsp;<span class="ident" id="5169864">t</span><span class="op" id="5169865">.</span><span class="ident" id="5169866">ContentLength</span>&nbsp;<span class="op" id="5169880">&gt;</span>&nbsp;<span class="num" id="5169882">0</span>&nbsp;<span class="op" id="5169884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5169888">return</span>&nbsp;<span class="builtintype" id="5169895">true</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5169901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5169904">//&nbsp;Many&nbsp;servers&nbsp;expect&nbsp;a&nbsp;Content-Length&nbsp;for&nbsp;these&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5169963">if</span>&nbsp;<span class="ident" id="5169966">t</span><span class="op" id="5169967">.</span><span class="ident" id="5169968">Method</span>&nbsp;<span class="op" id="5169975">==</span>&nbsp;<span class="string" id="5169978">&#34;POST&#34;</span>&nbsp;<span class="op" id="5169985">||</span>&nbsp;<span class="ident" id="5169988">t</span><span class="op" id="5169989">.</span><span class="ident" id="5169990">Method</span>&nbsp;<span class="op" id="5169997">==</span>&nbsp;<span class="string" id="5170000">&#34;PUT&#34;</span>&nbsp;<span class="op" id="5170006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170010">return</span>&nbsp;<span class="builtintype" id="5170017">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5170023">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170026">if</span>&nbsp;<span class="ident" id="5170029">t</span><span class="op" id="5170030">.</span><span class="ident" id="5170031">ContentLength</span>&nbsp;<span class="op" id="5170045">==</span>&nbsp;<span class="num" id="5170048">0</span>&nbsp;<span class="op" id="5170050">&amp;&amp;</span>&nbsp;<span class="ident" id="5170053">isIdentity</span><span class="op" id="5170063">(</span><span class="ident" id="5170064">t</span><span class="op" id="5170065">.</span><span class="ident" id="5170066">TransferEncoding</span><span class="op" id="5170082">)</span>&nbsp;<span class="op" id="5170084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170088">return</span>&nbsp;<span class="builtintype" id="5170095">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5170101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170105">return</span>&nbsp;<span class="builtintype" id="5170112">false</span><br>
<span class="lineno">150</span><span class="op" id="5170118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5170121">func</span>&nbsp;<span class="op" id="5170126">(</span><span class="ident" id="5170127">t</span>&nbsp;<span class="op" id="5170129">*</span><span class="ident" id="5170130">transferWriter</span><span class="op" id="5170144">)</span>&nbsp;<span class="ident" id="5170146">WriteHeader</span><span class="op" id="5170157">(</span><span class="ident" id="5170158">w</span>&nbsp;<span class="ident" id="5170160">io</span><span class="op" id="5170162">.</span><span class="ident" id="5170163">Writer</span><span class="op" id="5170169">)</span>&nbsp;<span class="builtintype" id="5170171">error</span>&nbsp;<span class="op" id="5170177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170180">if</span>&nbsp;<span class="ident" id="5170183">t</span><span class="op" id="5170184">.</span><span class="ident" id="5170185">Close</span>&nbsp;<span class="op" id="5170191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170195">if</span>&nbsp;<span class="ident" id="5170198">_</span><span class="op" id="5170199">,</span>&nbsp;<span class="ident" id="5170201">err</span>&nbsp;<span class="op" id="5170205">:=</span>&nbsp;<span class="ident" id="5170208">io</span><span class="op" id="5170210">.</span><span class="ident" id="5170211">WriteString</span><span class="op" id="5170222">(</span><span class="ident" id="5170223">w</span><span class="op" id="5170224">,</span>&nbsp;<span class="string" id="5170226">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="5170249">)</span><span class="op" id="5170250">;</span>&nbsp;<span class="ident" id="5170252">err</span>&nbsp;<span class="op" id="5170256">!=</span>&nbsp;<span class="ident" id="5170259">nil</span>&nbsp;<span class="op" id="5170263">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170268">return</span>&nbsp;<span class="ident" id="5170275">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5170281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5170284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5170288">//&nbsp;Write&nbsp;Content-Length&nbsp;and/or&nbsp;Transfer-Encoding&nbsp;whose&nbsp;values&nbsp;are&nbsp;a</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5170357">//&nbsp;function&nbsp;of&nbsp;the&nbsp;sanitized&nbsp;field&nbsp;triple&nbsp;(Body,&nbsp;ContentLength,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5170422">//&nbsp;TransferEncoding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170444">if</span>&nbsp;<span class="ident" id="5170447">t</span><span class="op" id="5170448">.</span><span class="ident" id="5170449">shouldSendContentLength</span><span class="op" id="5170472">(</span><span class="op" id="5170473">)</span>&nbsp;<span class="op" id="5170475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170479">if</span>&nbsp;<span class="ident" id="5170482">_</span><span class="op" id="5170483">,</span>&nbsp;<span class="ident" id="5170485">err</span>&nbsp;<span class="op" id="5170489">:=</span>&nbsp;<span class="ident" id="5170492">io</span><span class="op" id="5170494">.</span><span class="ident" id="5170495">WriteString</span><span class="op" id="5170506">(</span><span class="ident" id="5170507">w</span><span class="op" id="5170508">,</span>&nbsp;<span class="string" id="5170510">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="5170528">)</span><span class="op" id="5170529">;</span>&nbsp;<span class="ident" id="5170531">err</span>&nbsp;<span class="op" id="5170535">!=</span>&nbsp;<span class="ident" id="5170538">nil</span>&nbsp;<span class="op" id="5170542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170547">return</span>&nbsp;<span class="ident" id="5170554">err</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5170560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170564">if</span>&nbsp;<span class="ident" id="5170567">_</span><span class="op" id="5170568">,</span>&nbsp;<span class="ident" id="5170570">err</span>&nbsp;<span class="op" id="5170574">:=</span>&nbsp;<span class="ident" id="5170577">io</span><span class="op" id="5170579">.</span><span class="ident" id="5170580">WriteString</span><span class="op" id="5170591">(</span><span class="ident" id="5170592">w</span><span class="op" id="5170593">,</span>&nbsp;<span class="ident" id="5170595">strconv</span><span class="op" id="5170602">.</span><span class="ident" id="5170603">FormatInt</span><span class="op" id="5170612">(</span><span class="ident" id="5170613">t</span><span class="op" id="5170614">.</span><span class="ident" id="5170615">ContentLength</span><span class="op" id="5170628">,</span>&nbsp;<span class="num" id="5170630">10</span><span class="op" id="5170632">)</span><span class="op" id="5170633">+</span><span class="string" id="5170634">&#34;\r\n&#34;</span><span class="op" id="5170640">)</span><span class="op" id="5170641">;</span>&nbsp;<span class="ident" id="5170643">err</span>&nbsp;<span class="op" id="5170647">!=</span>&nbsp;<span class="ident" id="5170650">nil</span>&nbsp;<span class="op" id="5170654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170659">return</span>&nbsp;<span class="ident" id="5170666">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5170672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5170675">}</span>&nbsp;<span class="keyword" id="5170677">else</span>&nbsp;<span class="keyword" id="5170682">if</span>&nbsp;<span class="ident" id="5170685">chunked</span><span class="op" id="5170692">(</span><span class="ident" id="5170693">t</span><span class="op" id="5170694">.</span><span class="ident" id="5170695">TransferEncoding</span><span class="op" id="5170711">)</span>&nbsp;<span class="op" id="5170713">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170717">if</span>&nbsp;<span class="ident" id="5170720">_</span><span class="op" id="5170721">,</span>&nbsp;<span class="ident" id="5170723">err</span>&nbsp;<span class="op" id="5170727">:=</span>&nbsp;<span class="ident" id="5170730">io</span><span class="op" id="5170732">.</span><span class="ident" id="5170733">WriteString</span><span class="op" id="5170744">(</span><span class="ident" id="5170745">w</span><span class="op" id="5170746">,</span>&nbsp;<span class="string" id="5170748">&#34;Transfer-Encoding:&nbsp;chunked\r\n&#34;</span><span class="op" id="5170780">)</span><span class="op" id="5170781">;</span>&nbsp;<span class="ident" id="5170783">err</span>&nbsp;<span class="op" id="5170787">!=</span>&nbsp;<span class="ident" id="5170790">nil</span>&nbsp;<span class="op" id="5170794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170799">return</span>&nbsp;<span class="ident" id="5170806">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5170812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5170815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5170819">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170844">if</span>&nbsp;<span class="ident" id="5170847">t</span><span class="op" id="5170848">.</span><span class="ident" id="5170849">Trailer</span>&nbsp;<span class="op" id="5170857">!=</span>&nbsp;<span class="ident" id="5170860">nil</span>&nbsp;<span class="op" id="5170864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5170868">keys</span>&nbsp;<span class="op" id="5170873">:=</span>&nbsp;<span class="builtinfunc" id="5170876">make</span><span class="op" id="5170880">(</span><span class="op" id="5170881">[</span><span class="op" id="5170882">]</span><span class="builtintype" id="5170883">string</span><span class="op" id="5170889">,</span>&nbsp;<span class="num" id="5170891">0</span><span class="op" id="5170892">,</span>&nbsp;<span class="builtinfunc" id="5170894">len</span><span class="op" id="5170897">(</span><span class="ident" id="5170898">t</span><span class="op" id="5170899">.</span><span class="ident" id="5170900">Trailer</span><span class="op" id="5170907">)</span><span class="op" id="5170908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170912">for</span>&nbsp;<span class="ident" id="5170916">k</span>&nbsp;<span class="op" id="5170918">:=</span>&nbsp;<span class="keyword" id="5170921">range</span>&nbsp;<span class="ident" id="5170927">t</span><span class="op" id="5170928">.</span><span class="ident" id="5170929">Trailer</span>&nbsp;<span class="op" id="5170937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5170942">k</span>&nbsp;<span class="op" id="5170944">=</span>&nbsp;<span class="ident" id="5170946">CanonicalHeaderKey</span><span class="op" id="5170964">(</span><span class="ident" id="5170965">k</span><span class="op" id="5170966">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170971">switch</span>&nbsp;<span class="ident" id="5170978">k</span>&nbsp;<span class="op" id="5170980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5170985">case</span>&nbsp;<span class="string" id="5170990">&#34;Transfer-Encoding&#34;</span><span class="op" id="5171009">,</span>&nbsp;<span class="string" id="5171011">&#34;Trailer&#34;</span><span class="op" id="5171020">,</span>&nbsp;<span class="string" id="5171022">&#34;Content-Length&#34;</span><span class="op" id="5171038">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5171044">return</span>&nbsp;<span class="op" id="5171051">&amp;</span><span class="ident" id="5171052">badStringError</span><span class="op" id="5171066">{</span><span class="string" id="5171067">&#34;invalid&nbsp;Trailer&nbsp;key&#34;</span><span class="op" id="5171088">,</span>&nbsp;<span class="ident" id="5171090">k</span><span class="op" id="5171091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5171096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5171101">keys</span>&nbsp;<span class="op" id="5171106">=</span>&nbsp;<span class="builtinfunc" id="5171108">append</span><span class="op" id="5171114">(</span><span class="ident" id="5171115">keys</span><span class="op" id="5171119">,</span>&nbsp;<span class="ident" id="5171121">k</span><span class="op" id="5171122">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5171126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5171130">if</span>&nbsp;<span class="builtinfunc" id="5171133">len</span><span class="op" id="5171136">(</span><span class="ident" id="5171137">keys</span><span class="op" id="5171141">)</span>&nbsp;<span class="op" id="5171143">&gt;</span>&nbsp;<span class="num" id="5171145">0</span>&nbsp;<span class="op" id="5171147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5171152">sort</span><span class="op" id="5171156">.</span><span class="ident" id="5171157">Strings</span><span class="op" id="5171164">(</span><span class="ident" id="5171165">keys</span><span class="op" id="5171169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5171174">//&nbsp;TODO:&nbsp;could&nbsp;do&nbsp;better&nbsp;allocation-wise&nbsp;here,&nbsp;but&nbsp;trailers&nbsp;are&nbsp;rare,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5171247">//&nbsp;so&nbsp;being&nbsp;lazy&nbsp;for&nbsp;now.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5171276">if</span>&nbsp;<span class="ident" id="5171279">_</span><span class="op" id="5171280">,</span>&nbsp;<span class="ident" id="5171282">err</span>&nbsp;<span class="op" id="5171286">:=</span>&nbsp;<span class="ident" id="5171289">io</span><span class="op" id="5171291">.</span><span class="ident" id="5171292">WriteString</span><span class="op" id="5171303">(</span><span class="ident" id="5171304">w</span><span class="op" id="5171305">,</span>&nbsp;<span class="string" id="5171307">&#34;Trailer:&nbsp;&#34;</span><span class="op" id="5171318">+</span><span class="ident" id="5171319">strings</span><span class="op" id="5171326">.</span><span class="ident" id="5171327">Join</span><span class="op" id="5171331">(</span><span class="ident" id="5171332">keys</span><span class="op" id="5171336">,</span>&nbsp;<span class="string" id="5171338">&#34;,&#34;</span><span class="op" id="5171341">)</span><span class="op" id="5171342">+</span><span class="string" id="5171343">&#34;\r\n&#34;</span><span class="op" id="5171349">)</span><span class="op" id="5171350">;</span>&nbsp;<span class="ident" id="5171352">err</span>&nbsp;<span class="op" id="5171356">!=</span>&nbsp;<span class="ident" id="5171359">nil</span>&nbsp;<span class="op" id="5171363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5171369">return</span>&nbsp;<span class="ident" id="5171376">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5171383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5171387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5171390">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5171394">return</span>&nbsp;<span class="ident" id="5171401">nil</span><br>
<span class="lineno"></span><span class="op" id="5171405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5171408">func</span>&nbsp;<span class="op" id="5171413">(</span><span class="ident" id="5171414">t</span>&nbsp;<span class="op" id="5171416">*</span><span class="ident" id="5171417">transferWriter</span><span class="op" id="5171431">)</span>&nbsp;<span class="ident" id="5171433">WriteBody</span><span class="op" id="5171442">(</span><span class="ident" id="5171443">w</span>&nbsp;<span class="ident" id="5171445">io</span><span class="op" id="5171447">.</span><span class="ident" id="5171448">Writer</span><span class="op" id="5171454">)</span>&nbsp;<span class="builtintype" id="5171456">error</span>&nbsp;<span class="op" id="5171462">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5171465">var</span>&nbsp;<span class="ident" id="5171469">err</span>&nbsp;<span class="builtintype" id="5171473">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5171480">var</span>&nbsp;<span class="ident" id="5171484">ncopy</span>&nbsp;<span class="ident" id="5171490">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5171498">//&nbsp;Write&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5171513">if</span>&nbsp;<span class="ident" id="5171516">t</span><span class="op" id="5171517">.</span><span class="ident" id="5171518">Body</span>&nbsp;<span class="op" id="5171523">!=</span>&nbsp;<span class="ident" id="5171526">nil</span>&nbsp;<span class="op" id="5171530">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5171534">if</span>&nbsp;<span class="ident" id="5171537">chunked</span><span class="op" id="5171544">(</span><span class="ident" id="5171545">t</span><span class="op" id="5171546">.</span><span class="ident" id="5171547">TransferEncoding</span><span class="op" id="5171563">)</span>&nbsp;<span class="op" id="5171565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5171570">cw</span>&nbsp;<span class="op" id="5171573">:=</span>&nbsp;<span class="ident" id="5171576">internal</span><span class="op" id="5171584">.</span><span class="ident" id="5171585">NewChunkedWriter</span><span class="op" id="5171601">(</span><span class="ident" id="5171602">w</span><span class="op" id="5171603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5171608">_</span><span class="op" id="5171609">,</span>&nbsp;<span class="ident" id="5171611">err</span>&nbsp;<span class="op" id="5171615">=</span>&nbsp;<span class="ident" id="5171617">io</span><span class="op" id="5171619">.</span><span class="ident" id="5171620">Copy</span><span class="op" id="5171624">(</span><span class="ident" id="5171625">cw</span><span class="op" id="5171627">,</span>&nbsp;<span class="ident" id="5171629">t</span><span class="op" id="5171630">.</span><span class="ident" id="5171631">Body</span><span class="op" id="5171635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5171640">if</span>&nbsp;<span class="ident" id="5171643">err</span>&nbsp;<span class="op" id="5171647">==</span>&nbsp;<span class="ident" id="5171650">nil</span>&nbsp;<span class="op" id="5171654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5171660">err</span>&nbsp;<span class="op" id="5171664">=</span>&nbsp;<span class="ident" id="5171666">cw</span><span class="op" id="5171668">.</span><span class="ident" id="5171669">Close</span><span class="op" id="5171674">(</span><span class="op" id="5171675">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5171680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5171684">}</span>&nbsp;<span class="keyword" id="5171686">else</span>&nbsp;<span class="keyword" id="5171691">if</span>&nbsp;<span class="ident" id="5171694">t</span><span class="op" id="5171695">.</span><span class="ident" id="5171696">ContentLength</span>&nbsp;<span class="op" id="5171710">==</span>&nbsp;<span class="op" id="5171713">-</span><span class="num" id="5171714">1</span>&nbsp;<span class="op" id="5171716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5171721">ncopy</span><span class="op" id="5171726">,</span>&nbsp;<span class="ident" id="5171728">err</span>&nbsp;<span class="op" id="5171732">=</span>&nbsp;<span class="ident" id="5171734">io</span><span class="op" id="5171736">.</span><span class="ident" id="5171737">Copy</span><span class="op" id="5171741">(</span><span class="ident" id="5171742">w</span><span class="op" id="5171743">,</span>&nbsp;<span class="ident" id="5171745">t</span><span class="op" id="5171746">.</span><span class="ident" id="5171747">Body</span><span class="op" id="5171751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5171755">}</span>&nbsp;<span class="keyword" id="5171757">else</span>&nbsp;<span class="op" id="5171762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5171767">ncopy</span><span class="op" id="5171772">,</span>&nbsp;<span class="ident" id="5171774">err</span>&nbsp;<span class="op" id="5171778">=</span>&nbsp;<span class="ident" id="5171780">io</span><span class="op" id="5171782">.</span><span class="ident" id="5171783">Copy</span><span class="op" id="5171787">(</span><span class="ident" id="5171788">w</span><span class="op" id="5171789">,</span>&nbsp;<span class="ident" id="5171791">io</span><span class="op" id="5171793">.</span><span class="ident" id="5171794">LimitReader</span><span class="op" id="5171805">(</span><span class="ident" id="5171806">t</span><span class="op" id="5171807">.</span><span class="ident" id="5171808">Body</span><span class="op" id="5171812">,</span>&nbsp;<span class="ident" id="5171814">t</span><span class="op" id="5171815">.</span><span class="ident" id="5171816">ContentLength</span><span class="op" id="5171829">)</span><span class="op" id="5171830">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5171835">if</span>&nbsp;<span class="ident" id="5171838">err</span>&nbsp;<span class="op" id="5171842">!=</span>&nbsp;<span class="ident" id="5171845">nil</span>&nbsp;<span class="op" id="5171849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5171855">return</span>&nbsp;<span class="ident" id="5171862">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5171869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5171874">var</span>&nbsp;<span class="ident" id="5171878">nextra</span>&nbsp;<span class="ident" id="5171885">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5171894">nextra</span><span class="op" id="5171900">,</span>&nbsp;<span class="ident" id="5171902">err</span>&nbsp;<span class="op" id="5171906">=</span>&nbsp;<span class="ident" id="5171908">io</span><span class="op" id="5171910">.</span><span class="ident" id="5171911">Copy</span><span class="op" id="5171915">(</span><span class="ident" id="5171916">ioutil</span><span class="op" id="5171922">.</span><span class="ident" id="5171923">Discard</span><span class="op" id="5171930">,</span>&nbsp;<span class="ident" id="5171932">t</span><span class="op" id="5171933">.</span><span class="ident" id="5171934">Body</span><span class="op" id="5171938">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5171943">ncopy</span>&nbsp;<span class="op" id="5171949">+=</span>&nbsp;<span class="ident" id="5171952">nextra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5171961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5171965">if</span>&nbsp;<span class="ident" id="5171968">err</span>&nbsp;<span class="op" id="5171972">!=</span>&nbsp;<span class="ident" id="5171975">nil</span>&nbsp;<span class="op" id="5171979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5171984">return</span>&nbsp;<span class="ident" id="5171991">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5171997">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172001">if</span>&nbsp;<span class="ident" id="5172004">err</span>&nbsp;<span class="op" id="5172008">=</span>&nbsp;<span class="ident" id="5172010">t</span><span class="op" id="5172011">.</span><span class="ident" id="5172012">BodyCloser</span><span class="op" id="5172022">.</span><span class="ident" id="5172023">Close</span><span class="op" id="5172028">(</span><span class="op" id="5172029">)</span><span class="op" id="5172030">;</span>&nbsp;<span class="ident" id="5172032">err</span>&nbsp;<span class="op" id="5172036">!=</span>&nbsp;<span class="ident" id="5172039">nil</span>&nbsp;<span class="op" id="5172043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172048">return</span>&nbsp;<span class="ident" id="5172055">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5172061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5172064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172068">if</span>&nbsp;<span class="op" id="5172071">!</span><span class="ident" id="5172072">t</span><span class="op" id="5172073">.</span><span class="ident" id="5172074">ResponseToHEAD</span>&nbsp;<span class="op" id="5172089">&amp;&amp;</span>&nbsp;<span class="ident" id="5172092">t</span><span class="op" id="5172093">.</span><span class="ident" id="5172094">ContentLength</span>&nbsp;<span class="op" id="5172108">!=</span>&nbsp;<span class="op" id="5172111">-</span><span class="num" id="5172112">1</span>&nbsp;<span class="op" id="5172114">&amp;&amp;</span>&nbsp;<span class="ident" id="5172117">t</span><span class="op" id="5172118">.</span><span class="ident" id="5172119">ContentLength</span>&nbsp;<span class="op" id="5172133">!=</span>&nbsp;<span class="ident" id="5172136">ncopy</span>&nbsp;<span class="op" id="5172142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172146">return</span>&nbsp;<span class="ident" id="5172153">fmt</span><span class="op" id="5172156">.</span><span class="ident" id="5172157">Errorf</span><span class="op" id="5172163">(</span><span class="string" id="5172164">&#34;http:&nbsp;ContentLength=%d&nbsp;with&nbsp;Body&nbsp;length&nbsp;%d&#34;</span><span class="op" id="5172208">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172213">t</span><span class="op" id="5172214">.</span><span class="ident" id="5172215">ContentLength</span><span class="op" id="5172228">,</span>&nbsp;<span class="ident" id="5172230">ncopy</span><span class="op" id="5172235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5172238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5172242">//&nbsp;TODO(petar):&nbsp;Place&nbsp;trailer&nbsp;writer&nbsp;code&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172291">if</span>&nbsp;<span class="ident" id="5172294">chunked</span><span class="op" id="5172301">(</span><span class="ident" id="5172302">t</span><span class="op" id="5172303">.</span><span class="ident" id="5172304">TransferEncoding</span><span class="op" id="5172320">)</span>&nbsp;<span class="op" id="5172322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5172326">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172352">if</span>&nbsp;<span class="ident" id="5172355">t</span><span class="op" id="5172356">.</span><span class="ident" id="5172357">Trailer</span>&nbsp;<span class="op" id="5172365">!=</span>&nbsp;<span class="ident" id="5172368">nil</span>&nbsp;<span class="op" id="5172372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172377">if</span>&nbsp;<span class="ident" id="5172380">err</span>&nbsp;<span class="op" id="5172384">:=</span>&nbsp;<span class="ident" id="5172387">t</span><span class="op" id="5172388">.</span><span class="ident" id="5172389">Trailer</span><span class="op" id="5172396">.</span><span class="ident" id="5172397">Write</span><span class="op" id="5172402">(</span><span class="ident" id="5172403">w</span><span class="op" id="5172404">)</span><span class="op" id="5172405">;</span>&nbsp;<span class="ident" id="5172407">err</span>&nbsp;<span class="op" id="5172411">!=</span>&nbsp;<span class="ident" id="5172414">nil</span>&nbsp;<span class="op" id="5172418">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172424">return</span>&nbsp;<span class="ident" id="5172431">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5172438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5172442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5172446">//&nbsp;Last&nbsp;chunk,&nbsp;empty&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172477">_</span><span class="op" id="5172478">,</span>&nbsp;<span class="ident" id="5172480">err</span>&nbsp;<span class="op" id="5172484">=</span>&nbsp;<span class="ident" id="5172486">io</span><span class="op" id="5172488">.</span><span class="ident" id="5172489">WriteString</span><span class="op" id="5172500">(</span><span class="ident" id="5172501">w</span><span class="op" id="5172502">,</span>&nbsp;<span class="string" id="5172504">&#34;\r\n&#34;</span><span class="op" id="5172510">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5172513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172516">return</span>&nbsp;<span class="ident" id="5172523">err</span><br>
<span class="lineno"></span><span class="op" id="5172527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5172530">type</span>&nbsp;<span class="ident" id="5172535">transferReader</span>&nbsp;<span class="keyword" id="5172550">struct</span>&nbsp;<span class="op" id="5172557">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5172560">//&nbsp;Input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172570">Header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5172584">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172592">StatusCode</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5172606">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172611">RequestMethod</span>&nbsp;<span class="builtintype" id="5172625">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172633">ProtoMajor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5172647">int</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172652">ProtoMinor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5172666">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5172671">//&nbsp;Output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172682">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5172699">io</span><span class="op" id="5172701">.</span><span class="ident" id="5172702">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172714">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5172731">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172738">TransferEncoding</span>&nbsp;<span class="op" id="5172755">[</span><span class="op" id="5172756">]</span><span class="builtintype" id="5172757">string</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172765">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5172782">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172788">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5172805">Header</span><br>
<span class="lineno"></span><span class="op" id="5172812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5172815">//&nbsp;bodyAllowedForStatus&nbsp;reports&nbsp;whether&nbsp;a&nbsp;given&nbsp;response&nbsp;status&nbsp;code</span><br>
<span class="lineno">265</span><span class="comment" id="5172884">//&nbsp;permits&nbsp;a&nbsp;body.&nbsp;&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span><span class="keyword" id="5172930">func</span>&nbsp;<span class="ident" id="5172935">bodyAllowedForStatus</span><span class="op" id="5172955">(</span><span class="ident" id="5172956">status</span>&nbsp;<span class="builtintype" id="5172963">int</span><span class="op" id="5172966">)</span>&nbsp;<span class="builtintype" id="5172968">bool</span>&nbsp;<span class="op" id="5172973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172976">switch</span>&nbsp;<span class="op" id="5172983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172986">case</span>&nbsp;<span class="ident" id="5172991">status</span>&nbsp;<span class="op" id="5172998">&gt;=</span>&nbsp;<span class="num" id="5173001">100</span>&nbsp;<span class="op" id="5173005">&amp;&amp;</span>&nbsp;<span class="ident" id="5173008">status</span>&nbsp;<span class="op" id="5173015">&lt;=</span>&nbsp;<span class="num" id="5173018">199</span><span class="op" id="5173021">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173025">return</span>&nbsp;<span class="builtintype" id="5173032">false</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173039">case</span>&nbsp;<span class="ident" id="5173044">status</span>&nbsp;<span class="op" id="5173051">==</span>&nbsp;<span class="num" id="5173054">204</span><span class="op" id="5173057">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173061">return</span>&nbsp;<span class="builtintype" id="5173068">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173075">case</span>&nbsp;<span class="ident" id="5173080">status</span>&nbsp;<span class="op" id="5173087">==</span>&nbsp;<span class="num" id="5173090">304</span><span class="op" id="5173093">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173097">return</span>&nbsp;<span class="builtintype" id="5173104">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5173111">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173114">return</span>&nbsp;<span class="builtintype" id="5173121">true</span><br>
<span class="lineno"></span><span class="op" id="5173126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5173129">var</span>&nbsp;<span class="op" id="5173133">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173136">suppressedHeaders304</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173160">=</span>&nbsp;<span class="op" id="5173162">[</span><span class="op" id="5173163">]</span><span class="builtintype" id="5173164">string</span><span class="op" id="5173170">{</span><span class="string" id="5173171">&#34;Content-Type&#34;</span><span class="op" id="5173185">,</span>&nbsp;<span class="string" id="5173187">&#34;Content-Length&#34;</span><span class="op" id="5173203">,</span>&nbsp;<span class="string" id="5173205">&#34;Transfer-Encoding&#34;</span><span class="op" id="5173224">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173227">suppressedHeadersNoBody</span>&nbsp;<span class="op" id="5173251">=</span>&nbsp;<span class="op" id="5173253">[</span><span class="op" id="5173254">]</span><span class="builtintype" id="5173255">string</span><span class="op" id="5173261">{</span><span class="string" id="5173262">&#34;Content-Length&#34;</span><span class="op" id="5173278">,</span>&nbsp;<span class="string" id="5173280">&#34;Transfer-Encoding&#34;</span><span class="op" id="5173299">}</span><br>
<span class="lineno"></span><span class="op" id="5173301">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5173304">func</span>&nbsp;<span class="ident" id="5173309">suppressedHeaders</span><span class="op" id="5173326">(</span><span class="ident" id="5173327">status</span>&nbsp;<span class="builtintype" id="5173334">int</span><span class="op" id="5173337">)</span>&nbsp;<span class="op" id="5173339">[</span><span class="op" id="5173340">]</span><span class="builtintype" id="5173341">string</span>&nbsp;<span class="op" id="5173348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173351">switch</span>&nbsp;<span class="op" id="5173358">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173361">case</span>&nbsp;<span class="ident" id="5173366">status</span>&nbsp;<span class="op" id="5173373">==</span>&nbsp;<span class="num" id="5173376">304</span><span class="op" id="5173379">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5173383">//&nbsp;RFC&nbsp;2616&nbsp;section&nbsp;10.3.5:&nbsp;&#34;the&nbsp;response&nbsp;MUST&nbsp;NOT&nbsp;include&nbsp;other&nbsp;entity-headers&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173466">return</span>&nbsp;<span class="ident" id="5173473">suppressedHeaders304</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173495">case</span>&nbsp;<span class="op" id="5173500">!</span><span class="ident" id="5173501">bodyAllowedForStatus</span><span class="op" id="5173521">(</span><span class="ident" id="5173522">status</span><span class="op" id="5173528">)</span><span class="op" id="5173529">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173533">return</span>&nbsp;<span class="ident" id="5173540">suppressedHeadersNoBody</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5173565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173568">return</span>&nbsp;<span class="ident" id="5173575">nil</span><br>
<span class="lineno"></span><span class="op" id="5173579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5173582">//&nbsp;msg&nbsp;is&nbsp;*Request&nbsp;or&nbsp;*Response.</span><br>
<span class="lineno">295</span><span class="keyword" id="5173615">func</span>&nbsp;<span class="ident" id="5173620">readTransfer</span><span class="op" id="5173632">(</span><span class="ident" id="5173633">msg</span>&nbsp;<span class="keyword" id="5173637">interface</span><span class="op" id="5173646">{</span><span class="op" id="5173647">}</span><span class="op" id="5173648">,</span>&nbsp;<span class="ident" id="5173650">r</span>&nbsp;<span class="op" id="5173652">*</span><span class="ident" id="5173653">bufio</span><span class="op" id="5173658">.</span><span class="ident" id="5173659">Reader</span><span class="op" id="5173665">)</span>&nbsp;<span class="op" id="5173667">(</span><span class="ident" id="5173668">err</span>&nbsp;<span class="builtintype" id="5173672">error</span><span class="op" id="5173677">)</span>&nbsp;<span class="op" id="5173679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173682">t</span>&nbsp;<span class="op" id="5173684">:=</span>&nbsp;<span class="op" id="5173687">&amp;</span><span class="ident" id="5173688">transferReader</span><span class="op" id="5173702">{</span><span class="ident" id="5173703">RequestMethod</span><span class="op" id="5173716">:</span>&nbsp;<span class="string" id="5173718">&#34;GET&#34;</span><span class="op" id="5173723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5173727">//&nbsp;Unify&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173743">isResponse</span>&nbsp;<span class="op" id="5173754">:=</span>&nbsp;<span class="builtintype" id="5173757">false</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173764">switch</span>&nbsp;<span class="ident" id="5173771">rr</span>&nbsp;<span class="op" id="5173774">:=</span>&nbsp;<span class="ident" id="5173777">msg</span><span class="op" id="5173780">.</span><span class="op" id="5173781">(</span><span class="keyword" id="5173782">type</span><span class="op" id="5173786">)</span>&nbsp;<span class="op" id="5173788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173791">case</span>&nbsp;<span class="op" id="5173796">*</span><span class="ident" id="5173797">Response</span><span class="op" id="5173805">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173809">t</span><span class="op" id="5173810">.</span><span class="ident" id="5173811">Header</span>&nbsp;<span class="op" id="5173818">=</span>&nbsp;<span class="ident" id="5173820">rr</span><span class="op" id="5173822">.</span><span class="ident" id="5173823">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173832">t</span><span class="op" id="5173833">.</span><span class="ident" id="5173834">StatusCode</span>&nbsp;<span class="op" id="5173845">=</span>&nbsp;<span class="ident" id="5173847">rr</span><span class="op" id="5173849">.</span><span class="ident" id="5173850">StatusCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173863">t</span><span class="op" id="5173864">.</span><span class="ident" id="5173865">ProtoMajor</span>&nbsp;<span class="op" id="5173876">=</span>&nbsp;<span class="ident" id="5173878">rr</span><span class="op" id="5173880">.</span><span class="ident" id="5173881">ProtoMajor</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173894">t</span><span class="op" id="5173895">.</span><span class="ident" id="5173896">ProtoMinor</span>&nbsp;<span class="op" id="5173907">=</span>&nbsp;<span class="ident" id="5173909">rr</span><span class="op" id="5173911">.</span><span class="ident" id="5173912">ProtoMinor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173925">t</span><span class="op" id="5173926">.</span><span class="ident" id="5173927">Close</span>&nbsp;<span class="op" id="5173933">=</span>&nbsp;<span class="ident" id="5173935">shouldClose</span><span class="op" id="5173946">(</span><span class="ident" id="5173947">t</span><span class="op" id="5173948">.</span><span class="ident" id="5173949">ProtoMajor</span><span class="op" id="5173959">,</span>&nbsp;<span class="ident" id="5173961">t</span><span class="op" id="5173962">.</span><span class="ident" id="5173963">ProtoMinor</span><span class="op" id="5173973">,</span>&nbsp;<span class="ident" id="5173975">t</span><span class="op" id="5173976">.</span><span class="ident" id="5173977">Header</span><span class="op" id="5173983">,</span>&nbsp;<span class="builtintype" id="5173985">true</span><span class="op" id="5173989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173993">isResponse</span>&nbsp;<span class="op" id="5174004">=</span>&nbsp;<span class="builtintype" id="5174006">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174013">if</span>&nbsp;<span class="ident" id="5174016">rr</span><span class="op" id="5174018">.</span><span class="ident" id="5174019">Request</span>&nbsp;<span class="op" id="5174027">!=</span>&nbsp;<span class="ident" id="5174030">nil</span>&nbsp;<span class="op" id="5174034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174039">t</span><span class="op" id="5174040">.</span><span class="ident" id="5174041">RequestMethod</span>&nbsp;<span class="op" id="5174055">=</span>&nbsp;<span class="ident" id="5174057">rr</span><span class="op" id="5174059">.</span><span class="ident" id="5174060">Request</span><span class="op" id="5174067">.</span><span class="ident" id="5174068">Method</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174080">case</span>&nbsp;<span class="op" id="5174085">*</span><span class="ident" id="5174086">Request</span><span class="op" id="5174093">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174097">t</span><span class="op" id="5174098">.</span><span class="ident" id="5174099">Header</span>&nbsp;<span class="op" id="5174106">=</span>&nbsp;<span class="ident" id="5174108">rr</span><span class="op" id="5174110">.</span><span class="ident" id="5174111">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174120">t</span><span class="op" id="5174121">.</span><span class="ident" id="5174122">ProtoMajor</span>&nbsp;<span class="op" id="5174133">=</span>&nbsp;<span class="ident" id="5174135">rr</span><span class="op" id="5174137">.</span><span class="ident" id="5174138">ProtoMajor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174151">t</span><span class="op" id="5174152">.</span><span class="ident" id="5174153">ProtoMinor</span>&nbsp;<span class="op" id="5174164">=</span>&nbsp;<span class="ident" id="5174166">rr</span><span class="op" id="5174168">.</span><span class="ident" id="5174169">ProtoMinor</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5174182">//&nbsp;Transfer&nbsp;semantics&nbsp;for&nbsp;Requests&nbsp;are&nbsp;exactly&nbsp;like&nbsp;those&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5174246">//&nbsp;Responses&nbsp;with&nbsp;status&nbsp;code&nbsp;200,&nbsp;responding&nbsp;to&nbsp;a&nbsp;GET&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174310">t</span><span class="op" id="5174311">.</span><span class="ident" id="5174312">StatusCode</span>&nbsp;<span class="op" id="5174323">=</span>&nbsp;<span class="num" id="5174325">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174330">default</span><span class="op" id="5174337">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5174341">panic</span><span class="op" id="5174346">(</span><span class="string" id="5174347">&#34;unexpected&nbsp;type&#34;</span><span class="op" id="5174364">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5174371">//&nbsp;Default&nbsp;to&nbsp;HTTP/1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174395">if</span>&nbsp;<span class="ident" id="5174398">t</span><span class="op" id="5174399">.</span><span class="ident" id="5174400">ProtoMajor</span>&nbsp;<span class="op" id="5174411">==</span>&nbsp;<span class="num" id="5174414">0</span>&nbsp;<span class="op" id="5174416">&amp;&amp;</span>&nbsp;<span class="ident" id="5174419">t</span><span class="op" id="5174420">.</span><span class="ident" id="5174421">ProtoMinor</span>&nbsp;<span class="op" id="5174432">==</span>&nbsp;<span class="num" id="5174435">0</span>&nbsp;<span class="op" id="5174437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174441">t</span><span class="op" id="5174442">.</span><span class="ident" id="5174443">ProtoMajor</span><span class="op" id="5174453">,</span>&nbsp;<span class="ident" id="5174455">t</span><span class="op" id="5174456">.</span><span class="ident" id="5174457">ProtoMinor</span>&nbsp;<span class="op" id="5174468">=</span>&nbsp;<span class="num" id="5174470">1</span><span class="op" id="5174471">,</span>&nbsp;<span class="num" id="5174473">1</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5174480">//&nbsp;Transfer&nbsp;encoding,&nbsp;content&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174518">t</span><span class="op" id="5174519">.</span><span class="ident" id="5174520">TransferEncoding</span><span class="op" id="5174536">,</span>&nbsp;<span class="ident" id="5174538">err</span>&nbsp;<span class="op" id="5174542">=</span>&nbsp;<span class="ident" id="5174544">fixTransferEncoding</span><span class="op" id="5174563">(</span><span class="ident" id="5174564">t</span><span class="op" id="5174565">.</span><span class="ident" id="5174566">RequestMethod</span><span class="op" id="5174579">,</span>&nbsp;<span class="ident" id="5174581">t</span><span class="op" id="5174582">.</span><span class="ident" id="5174583">Header</span><span class="op" id="5174589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174592">if</span>&nbsp;<span class="ident" id="5174595">err</span>&nbsp;<span class="op" id="5174599">!=</span>&nbsp;<span class="ident" id="5174602">nil</span>&nbsp;<span class="op" id="5174606">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174610">return</span>&nbsp;<span class="ident" id="5174617">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174626">realLength</span><span class="op" id="5174636">,</span>&nbsp;<span class="ident" id="5174638">err</span>&nbsp;<span class="op" id="5174642">:=</span>&nbsp;<span class="ident" id="5174645">fixLength</span><span class="op" id="5174654">(</span><span class="ident" id="5174655">isResponse</span><span class="op" id="5174665">,</span>&nbsp;<span class="ident" id="5174667">t</span><span class="op" id="5174668">.</span><span class="ident" id="5174669">StatusCode</span><span class="op" id="5174679">,</span>&nbsp;<span class="ident" id="5174681">t</span><span class="op" id="5174682">.</span><span class="ident" id="5174683">RequestMethod</span><span class="op" id="5174696">,</span>&nbsp;<span class="ident" id="5174698">t</span><span class="op" id="5174699">.</span><span class="ident" id="5174700">Header</span><span class="op" id="5174706">,</span>&nbsp;<span class="ident" id="5174708">t</span><span class="op" id="5174709">.</span><span class="ident" id="5174710">TransferEncoding</span><span class="op" id="5174726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174729">if</span>&nbsp;<span class="ident" id="5174732">err</span>&nbsp;<span class="op" id="5174736">!=</span>&nbsp;<span class="ident" id="5174739">nil</span>&nbsp;<span class="op" id="5174743">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174747">return</span>&nbsp;<span class="ident" id="5174754">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174762">if</span>&nbsp;<span class="ident" id="5174765">isResponse</span>&nbsp;<span class="op" id="5174776">&amp;&amp;</span>&nbsp;<span class="ident" id="5174779">t</span><span class="op" id="5174780">.</span><span class="ident" id="5174781">RequestMethod</span>&nbsp;<span class="op" id="5174795">==</span>&nbsp;<span class="string" id="5174798">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="5174805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174809">if</span>&nbsp;<span class="ident" id="5174812">n</span><span class="op" id="5174813">,</span>&nbsp;<span class="ident" id="5174815">err</span>&nbsp;<span class="op" id="5174819">:=</span>&nbsp;<span class="ident" id="5174822">parseContentLength</span><span class="op" id="5174840">(</span><span class="ident" id="5174841">t</span><span class="op" id="5174842">.</span><span class="ident" id="5174843">Header</span><span class="op" id="5174849">.</span><span class="ident" id="5174850">get</span><span class="op" id="5174853">(</span><span class="string" id="5174854">&#34;Content-Length&#34;</span><span class="op" id="5174870">)</span><span class="op" id="5174871">)</span><span class="op" id="5174872">;</span>&nbsp;<span class="ident" id="5174874">err</span>&nbsp;<span class="op" id="5174878">!=</span>&nbsp;<span class="ident" id="5174881">nil</span>&nbsp;<span class="op" id="5174885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174890">return</span>&nbsp;<span class="ident" id="5174897">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174903">}</span>&nbsp;<span class="keyword" id="5174905">else</span>&nbsp;<span class="op" id="5174910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174915">t</span><span class="op" id="5174916">.</span><span class="ident" id="5174917">ContentLength</span>&nbsp;<span class="op" id="5174931">=</span>&nbsp;<span class="ident" id="5174933">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174940">}</span>&nbsp;<span class="keyword" id="5174942">else</span>&nbsp;<span class="op" id="5174947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174951">t</span><span class="op" id="5174952">.</span><span class="ident" id="5174953">ContentLength</span>&nbsp;<span class="op" id="5174967">=</span>&nbsp;<span class="ident" id="5174969">realLength</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5174985">//&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174997">t</span><span class="op" id="5174998">.</span><span class="ident" id="5174999">Trailer</span><span class="op" id="5175006">,</span>&nbsp;<span class="ident" id="5175008">err</span>&nbsp;<span class="op" id="5175012">=</span>&nbsp;<span class="ident" id="5175014">fixTrailer</span><span class="op" id="5175024">(</span><span class="ident" id="5175025">t</span><span class="op" id="5175026">.</span><span class="ident" id="5175027">Header</span><span class="op" id="5175033">,</span>&nbsp;<span class="ident" id="5175035">t</span><span class="op" id="5175036">.</span><span class="ident" id="5175037">TransferEncoding</span><span class="op" id="5175053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175056">if</span>&nbsp;<span class="ident" id="5175059">err</span>&nbsp;<span class="op" id="5175063">!=</span>&nbsp;<span class="ident" id="5175066">nil</span>&nbsp;<span class="op" id="5175070">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175074">return</span>&nbsp;<span class="ident" id="5175081">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5175086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175090">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;Content-Length&nbsp;or&nbsp;chunked&nbsp;Transfer-Encoding&nbsp;on&nbsp;a&nbsp;*Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175168">//&nbsp;and&nbsp;the&nbsp;status&nbsp;is&nbsp;not&nbsp;1xx,&nbsp;204&nbsp;or&nbsp;304,&nbsp;then&nbsp;the&nbsp;body&nbsp;is&nbsp;unbounded.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175239">//&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175269">switch</span>&nbsp;<span class="ident" id="5175276">msg</span><span class="op" id="5175279">.</span><span class="op" id="5175280">(</span><span class="keyword" id="5175281">type</span><span class="op" id="5175285">)</span>&nbsp;<span class="op" id="5175287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175290">case</span>&nbsp;<span class="op" id="5175295">*</span><span class="ident" id="5175296">Response</span><span class="op" id="5175304">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175308">if</span>&nbsp;<span class="ident" id="5175311">realLength</span>&nbsp;<span class="op" id="5175322">==</span>&nbsp;<span class="op" id="5175325">-</span><span class="num" id="5175326">1</span>&nbsp;<span class="op" id="5175328">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5175334">!</span><span class="ident" id="5175335">chunked</span><span class="op" id="5175342">(</span><span class="ident" id="5175343">t</span><span class="op" id="5175344">.</span><span class="ident" id="5175345">TransferEncoding</span><span class="op" id="5175361">)</span>&nbsp;<span class="op" id="5175363">&amp;&amp;</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175369">bodyAllowedForStatus</span><span class="op" id="5175389">(</span><span class="ident" id="5175390">t</span><span class="op" id="5175391">.</span><span class="ident" id="5175392">StatusCode</span><span class="op" id="5175402">)</span>&nbsp;<span class="op" id="5175404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175409">//&nbsp;Unbounded&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175431">t</span><span class="op" id="5175432">.</span><span class="ident" id="5175433">Close</span>&nbsp;<span class="op" id="5175439">=</span>&nbsp;<span class="builtintype" id="5175441">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5175448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5175451">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175455">//&nbsp;Prepare&nbsp;body&nbsp;reader.&nbsp;&nbsp;ContentLength&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;chunked&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175522">//&nbsp;or&nbsp;close&nbsp;connection&nbsp;when&nbsp;finished,&nbsp;since&nbsp;multipart&nbsp;is&nbsp;not&nbsp;supported&nbsp;yet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175598">switch</span>&nbsp;<span class="op" id="5175605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175608">case</span>&nbsp;<span class="ident" id="5175613">chunked</span><span class="op" id="5175620">(</span><span class="ident" id="5175621">t</span><span class="op" id="5175622">.</span><span class="ident" id="5175623">TransferEncoding</span><span class="op" id="5175639">)</span><span class="op" id="5175640">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175644">if</span>&nbsp;<span class="ident" id="5175647">noBodyExpected</span><span class="op" id="5175661">(</span><span class="ident" id="5175662">t</span><span class="op" id="5175663">.</span><span class="ident" id="5175664">RequestMethod</span><span class="op" id="5175677">)</span>&nbsp;<span class="op" id="5175679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175684">t</span><span class="op" id="5175685">.</span><span class="ident" id="5175686">Body</span>&nbsp;<span class="op" id="5175691">=</span>&nbsp;<span class="ident" id="5175693">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5175705">}</span>&nbsp;<span class="keyword" id="5175707">else</span>&nbsp;<span class="op" id="5175712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175717">t</span><span class="op" id="5175718">.</span><span class="ident" id="5175719">Body</span>&nbsp;<span class="op" id="5175724">=</span>&nbsp;<span class="op" id="5175726">&amp;</span><span class="ident" id="5175727">body</span><span class="op" id="5175731">{</span><span class="ident" id="5175732">src</span><span class="op" id="5175735">:</span>&nbsp;<span class="ident" id="5175737">internal</span><span class="op" id="5175745">.</span><span class="ident" id="5175746">NewChunkedReader</span><span class="op" id="5175762">(</span><span class="ident" id="5175763">r</span><span class="op" id="5175764">)</span><span class="op" id="5175765">,</span>&nbsp;<span class="ident" id="5175767">hdr</span><span class="op" id="5175770">:</span>&nbsp;<span class="ident" id="5175772">msg</span><span class="op" id="5175775">,</span>&nbsp;<span class="ident" id="5175777">r</span><span class="op" id="5175778">:</span>&nbsp;<span class="ident" id="5175780">r</span><span class="op" id="5175781">,</span>&nbsp;<span class="ident" id="5175783">closing</span><span class="op" id="5175790">:</span>&nbsp;<span class="ident" id="5175792">t</span><span class="op" id="5175793">.</span><span class="ident" id="5175794">Close</span><span class="op" id="5175799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5175803">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175806">case</span>&nbsp;<span class="ident" id="5175811">realLength</span>&nbsp;<span class="op" id="5175822">==</span>&nbsp;<span class="num" id="5175825">0</span><span class="op" id="5175826">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175830">t</span><span class="op" id="5175831">.</span><span class="ident" id="5175832">Body</span>&nbsp;<span class="op" id="5175837">=</span>&nbsp;<span class="ident" id="5175839">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175850">case</span>&nbsp;<span class="ident" id="5175855">realLength</span>&nbsp;<span class="op" id="5175866">&gt;</span>&nbsp;<span class="num" id="5175868">0</span><span class="op" id="5175869">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175873">t</span><span class="op" id="5175874">.</span><span class="ident" id="5175875">Body</span>&nbsp;<span class="op" id="5175880">=</span>&nbsp;<span class="op" id="5175882">&amp;</span><span class="ident" id="5175883">body</span><span class="op" id="5175887">{</span><span class="ident" id="5175888">src</span><span class="op" id="5175891">:</span>&nbsp;<span class="ident" id="5175893">io</span><span class="op" id="5175895">.</span><span class="ident" id="5175896">LimitReader</span><span class="op" id="5175907">(</span><span class="ident" id="5175908">r</span><span class="op" id="5175909">,</span>&nbsp;<span class="ident" id="5175911">realLength</span><span class="op" id="5175921">)</span><span class="op" id="5175922">,</span>&nbsp;<span class="ident" id="5175924">closing</span><span class="op" id="5175931">:</span>&nbsp;<span class="ident" id="5175933">t</span><span class="op" id="5175934">.</span><span class="ident" id="5175935">Close</span><span class="op" id="5175940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175943">default</span><span class="op" id="5175950">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175954">//&nbsp;realLength&nbsp;&lt;&nbsp;0,&nbsp;i.e.&nbsp;&#34;Content-Length&#34;&nbsp;not&nbsp;mentioned&nbsp;in&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176021">if</span>&nbsp;<span class="ident" id="5176024">t</span><span class="op" id="5176025">.</span><span class="ident" id="5176026">Close</span>&nbsp;<span class="op" id="5176032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5176037">//&nbsp;Close&nbsp;semantics&nbsp;(i.e.&nbsp;HTTP/1.0)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176075">t</span><span class="op" id="5176076">.</span><span class="ident" id="5176077">Body</span>&nbsp;<span class="op" id="5176082">=</span>&nbsp;<span class="op" id="5176084">&amp;</span><span class="ident" id="5176085">body</span><span class="op" id="5176089">{</span><span class="ident" id="5176090">src</span><span class="op" id="5176093">:</span>&nbsp;<span class="ident" id="5176095">r</span><span class="op" id="5176096">,</span>&nbsp;<span class="ident" id="5176098">closing</span><span class="op" id="5176105">:</span>&nbsp;<span class="ident" id="5176107">t</span><span class="op" id="5176108">.</span><span class="ident" id="5176109">Close</span><span class="op" id="5176114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176118">}</span>&nbsp;<span class="keyword" id="5176120">else</span>&nbsp;<span class="op" id="5176125">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5176130">//&nbsp;Persistent&nbsp;connection&nbsp;(i.e.&nbsp;HTTP/1.1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176174">t</span><span class="op" id="5176175">.</span><span class="ident" id="5176176">Body</span>&nbsp;<span class="op" id="5176181">=</span>&nbsp;<span class="ident" id="5176183">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5176202">//&nbsp;Unify&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176219">switch</span>&nbsp;<span class="ident" id="5176226">rr</span>&nbsp;<span class="op" id="5176229">:=</span>&nbsp;<span class="ident" id="5176232">msg</span><span class="op" id="5176235">.</span><span class="op" id="5176236">(</span><span class="keyword" id="5176237">type</span><span class="op" id="5176241">)</span>&nbsp;<span class="op" id="5176243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176246">case</span>&nbsp;<span class="op" id="5176251">*</span><span class="ident" id="5176252">Request</span><span class="op" id="5176259">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176263">rr</span><span class="op" id="5176265">.</span><span class="ident" id="5176266">Body</span>&nbsp;<span class="op" id="5176271">=</span>&nbsp;<span class="ident" id="5176273">t</span><span class="op" id="5176274">.</span><span class="ident" id="5176275">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176282">rr</span><span class="op" id="5176284">.</span><span class="ident" id="5176285">ContentLength</span>&nbsp;<span class="op" id="5176299">=</span>&nbsp;<span class="ident" id="5176301">t</span><span class="op" id="5176302">.</span><span class="ident" id="5176303">ContentLength</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176319">rr</span><span class="op" id="5176321">.</span><span class="ident" id="5176322">TransferEncoding</span>&nbsp;<span class="op" id="5176339">=</span>&nbsp;<span class="ident" id="5176341">t</span><span class="op" id="5176342">.</span><span class="ident" id="5176343">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176362">rr</span><span class="op" id="5176364">.</span><span class="ident" id="5176365">Close</span>&nbsp;<span class="op" id="5176371">=</span>&nbsp;<span class="ident" id="5176373">t</span><span class="op" id="5176374">.</span><span class="ident" id="5176375">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176383">rr</span><span class="op" id="5176385">.</span><span class="ident" id="5176386">Trailer</span>&nbsp;<span class="op" id="5176394">=</span>&nbsp;<span class="ident" id="5176396">t</span><span class="op" id="5176397">.</span><span class="ident" id="5176398">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176407">case</span>&nbsp;<span class="op" id="5176412">*</span><span class="ident" id="5176413">Response</span><span class="op" id="5176421">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176425">rr</span><span class="op" id="5176427">.</span><span class="ident" id="5176428">Body</span>&nbsp;<span class="op" id="5176433">=</span>&nbsp;<span class="ident" id="5176435">t</span><span class="op" id="5176436">.</span><span class="ident" id="5176437">Body</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176444">rr</span><span class="op" id="5176446">.</span><span class="ident" id="5176447">ContentLength</span>&nbsp;<span class="op" id="5176461">=</span>&nbsp;<span class="ident" id="5176463">t</span><span class="op" id="5176464">.</span><span class="ident" id="5176465">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176481">rr</span><span class="op" id="5176483">.</span><span class="ident" id="5176484">TransferEncoding</span>&nbsp;<span class="op" id="5176501">=</span>&nbsp;<span class="ident" id="5176503">t</span><span class="op" id="5176504">.</span><span class="ident" id="5176505">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176524">rr</span><span class="op" id="5176526">.</span><span class="ident" id="5176527">Close</span>&nbsp;<span class="op" id="5176533">=</span>&nbsp;<span class="ident" id="5176535">t</span><span class="op" id="5176536">.</span><span class="ident" id="5176537">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176545">rr</span><span class="op" id="5176547">.</span><span class="ident" id="5176548">Trailer</span>&nbsp;<span class="op" id="5176556">=</span>&nbsp;<span class="ident" id="5176558">t</span><span class="op" id="5176559">.</span><span class="ident" id="5176560">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176569">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176573">return</span>&nbsp;<span class="ident" id="5176580">nil</span><br>
<span class="lineno"></span><span class="op" id="5176584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5176587">//&nbsp;Checks&nbsp;whether&nbsp;chunked&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;encodings&nbsp;stack</span><br>
<span class="lineno">410</span><span class="keyword" id="5176644">func</span>&nbsp;<span class="ident" id="5176649">chunked</span><span class="op" id="5176656">(</span><span class="ident" id="5176657">te</span>&nbsp;<span class="op" id="5176660">[</span><span class="op" id="5176661">]</span><span class="builtintype" id="5176662">string</span><span class="op" id="5176668">)</span>&nbsp;<span class="builtintype" id="5176670">bool</span>&nbsp;<span class="op" id="5176675">{</span>&nbsp;<span class="keyword" id="5176677">return</span>&nbsp;<span class="builtinfunc" id="5176684">len</span><span class="op" id="5176687">(</span><span class="ident" id="5176688">te</span><span class="op" id="5176690">)</span>&nbsp;<span class="op" id="5176692">&gt;</span>&nbsp;<span class="num" id="5176694">0</span>&nbsp;<span class="op" id="5176696">&amp;&amp;</span>&nbsp;<span class="ident" id="5176699">te</span><span class="op" id="5176701">[</span><span class="num" id="5176702">0</span><span class="op" id="5176703">]</span>&nbsp;<span class="op" id="5176705">==</span>&nbsp;<span class="string" id="5176708">&#34;chunked&#34;</span>&nbsp;<span class="op" id="5176718">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5176721">//&nbsp;Checks&nbsp;whether&nbsp;the&nbsp;encoding&nbsp;is&nbsp;explicitly&nbsp;&#34;identity&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="5176778">func</span>&nbsp;<span class="ident" id="5176783">isIdentity</span><span class="op" id="5176793">(</span><span class="ident" id="5176794">te</span>&nbsp;<span class="op" id="5176797">[</span><span class="op" id="5176798">]</span><span class="builtintype" id="5176799">string</span><span class="op" id="5176805">)</span>&nbsp;<span class="builtintype" id="5176807">bool</span>&nbsp;<span class="op" id="5176812">{</span>&nbsp;<span class="keyword" id="5176814">return</span>&nbsp;<span class="builtinfunc" id="5176821">len</span><span class="op" id="5176824">(</span><span class="ident" id="5176825">te</span><span class="op" id="5176827">)</span>&nbsp;<span class="op" id="5176829">==</span>&nbsp;<span class="num" id="5176832">1</span>&nbsp;<span class="op" id="5176834">&amp;&amp;</span>&nbsp;<span class="ident" id="5176837">te</span><span class="op" id="5176839">[</span><span class="num" id="5176840">0</span><span class="op" id="5176841">]</span>&nbsp;<span class="op" id="5176843">==</span>&nbsp;<span class="string" id="5176846">&#34;identity&#34;</span>&nbsp;<span class="op" id="5176857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="5176860">//&nbsp;Sanitize&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno"></span><span class="keyword" id="5176890">func</span>&nbsp;<span class="ident" id="5176895">fixTransferEncoding</span><span class="op" id="5176914">(</span><span class="ident" id="5176915">requestMethod</span>&nbsp;<span class="builtintype" id="5176929">string</span><span class="op" id="5176935">,</span>&nbsp;<span class="ident" id="5176937">header</span>&nbsp;<span class="ident" id="5176944">Header</span><span class="op" id="5176950">)</span>&nbsp;<span class="op" id="5176952">(</span><span class="op" id="5176953">[</span><span class="op" id="5176954">]</span><span class="builtintype" id="5176955">string</span><span class="op" id="5176961">,</span>&nbsp;<span class="builtintype" id="5176963">error</span><span class="op" id="5176968">)</span>&nbsp;<span class="op" id="5176970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176973">raw</span><span class="op" id="5176976">,</span>&nbsp;<span class="ident" id="5176978">present</span>&nbsp;<span class="op" id="5176986">:=</span>&nbsp;<span class="ident" id="5176989">header</span><span class="op" id="5176995">[</span><span class="string" id="5176996">&#34;Transfer-Encoding&#34;</span><span class="op" id="5177015">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177018">if</span>&nbsp;<span class="op" id="5177021">!</span><span class="ident" id="5177022">present</span>&nbsp;<span class="op" id="5177030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177034">return</span>&nbsp;<span class="ident" id="5177041">nil</span><span class="op" id="5177044">,</span>&nbsp;<span class="ident" id="5177046">nil</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5177055">delete</span><span class="op" id="5177061">(</span><span class="ident" id="5177062">header</span><span class="op" id="5177068">,</span>&nbsp;<span class="string" id="5177070">&#34;Transfer-Encoding&#34;</span><span class="op" id="5177089">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177093">encodings</span>&nbsp;<span class="op" id="5177103">:=</span>&nbsp;<span class="ident" id="5177106">strings</span><span class="op" id="5177113">.</span><span class="ident" id="5177114">Split</span><span class="op" id="5177119">(</span><span class="ident" id="5177120">raw</span><span class="op" id="5177123">[</span><span class="num" id="5177124">0</span><span class="op" id="5177125">]</span><span class="op" id="5177126">,</span>&nbsp;<span class="string" id="5177128">&#34;,&#34;</span><span class="op" id="5177131">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177134">te</span>&nbsp;<span class="op" id="5177137">:=</span>&nbsp;<span class="builtinfunc" id="5177140">make</span><span class="op" id="5177144">(</span><span class="op" id="5177145">[</span><span class="op" id="5177146">]</span><span class="builtintype" id="5177147">string</span><span class="op" id="5177153">,</span>&nbsp;<span class="num" id="5177155">0</span><span class="op" id="5177156">,</span>&nbsp;<span class="builtinfunc" id="5177158">len</span><span class="op" id="5177161">(</span><span class="ident" id="5177162">encodings</span><span class="op" id="5177171">)</span><span class="op" id="5177172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177175">//&nbsp;TODO:&nbsp;Even&nbsp;though&nbsp;we&nbsp;only&nbsp;support&nbsp;&#34;identity&#34;&nbsp;and&nbsp;&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177238">//&nbsp;encodings,&nbsp;the&nbsp;loop&nbsp;below&nbsp;is&nbsp;designed&nbsp;with&nbsp;foresight.&nbsp;One</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177300">//&nbsp;invariant&nbsp;that&nbsp;must&nbsp;be&nbsp;maintained&nbsp;is&nbsp;that,&nbsp;if&nbsp;present,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177359">//&nbsp;chunked&nbsp;encoding&nbsp;must&nbsp;always&nbsp;come&nbsp;first.</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177404">for</span>&nbsp;<span class="ident" id="5177408">_</span><span class="op" id="5177409">,</span>&nbsp;<span class="ident" id="5177411">encoding</span>&nbsp;<span class="op" id="5177420">:=</span>&nbsp;<span class="keyword" id="5177423">range</span>&nbsp;<span class="ident" id="5177429">encodings</span>&nbsp;<span class="op" id="5177439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177443">encoding</span>&nbsp;<span class="op" id="5177452">=</span>&nbsp;<span class="ident" id="5177454">strings</span><span class="op" id="5177461">.</span><span class="ident" id="5177462">ToLower</span><span class="op" id="5177469">(</span><span class="ident" id="5177470">strings</span><span class="op" id="5177477">.</span><span class="ident" id="5177478">TrimSpace</span><span class="op" id="5177487">(</span><span class="ident" id="5177488">encoding</span><span class="op" id="5177496">)</span><span class="op" id="5177497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177501">//&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;not&nbsp;recorded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177542">if</span>&nbsp;<span class="ident" id="5177545">encoding</span>&nbsp;<span class="op" id="5177554">==</span>&nbsp;<span class="string" id="5177557">&#34;identity&#34;</span>&nbsp;<span class="op" id="5177568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177573">break</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177585">if</span>&nbsp;<span class="ident" id="5177588">encoding</span>&nbsp;<span class="op" id="5177597">!=</span>&nbsp;<span class="string" id="5177600">&#34;chunked&#34;</span>&nbsp;<span class="op" id="5177610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177615">return</span>&nbsp;<span class="ident" id="5177622">nil</span><span class="op" id="5177625">,</span>&nbsp;<span class="op" id="5177627">&amp;</span><span class="ident" id="5177628">badStringError</span><span class="op" id="5177642">{</span><span class="string" id="5177643">&#34;unsupported&nbsp;transfer&nbsp;encoding&#34;</span><span class="op" id="5177674">,</span>&nbsp;<span class="ident" id="5177676">encoding</span><span class="op" id="5177684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177692">te</span>&nbsp;<span class="op" id="5177695">=</span>&nbsp;<span class="ident" id="5177697">te</span><span class="op" id="5177699">[</span><span class="num" id="5177700">0</span>&nbsp;<span class="op" id="5177702">:</span>&nbsp;<span class="builtinfunc" id="5177704">len</span><span class="op" id="5177707">(</span><span class="ident" id="5177708">te</span><span class="op" id="5177710">)</span><span class="op" id="5177711">+</span><span class="num" id="5177712">1</span><span class="op" id="5177713">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177717">te</span><span class="op" id="5177719">[</span><span class="builtinfunc" id="5177720">len</span><span class="op" id="5177723">(</span><span class="ident" id="5177724">te</span><span class="op" id="5177726">)</span><span class="op" id="5177727">-</span><span class="num" id="5177728">1</span><span class="op" id="5177729">]</span>&nbsp;<span class="op" id="5177731">=</span>&nbsp;<span class="ident" id="5177733">encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177746">if</span>&nbsp;<span class="builtinfunc" id="5177749">len</span><span class="op" id="5177752">(</span><span class="ident" id="5177753">te</span><span class="op" id="5177755">)</span>&nbsp;<span class="op" id="5177757">&gt;</span>&nbsp;<span class="num" id="5177759">1</span>&nbsp;<span class="op" id="5177761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177765">return</span>&nbsp;<span class="ident" id="5177772">nil</span><span class="op" id="5177775">,</span>&nbsp;<span class="op" id="5177777">&amp;</span><span class="ident" id="5177778">badStringError</span><span class="op" id="5177792">{</span><span class="string" id="5177793">&#34;too&nbsp;many&nbsp;transfer&nbsp;encodings&#34;</span><span class="op" id="5177822">,</span>&nbsp;<span class="ident" id="5177824">strings</span><span class="op" id="5177831">.</span><span class="ident" id="5177832">Join</span><span class="op" id="5177836">(</span><span class="ident" id="5177837">te</span><span class="op" id="5177839">,</span>&nbsp;<span class="string" id="5177841">&#34;,&#34;</span><span class="op" id="5177844">)</span><span class="op" id="5177845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177848">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177851">if</span>&nbsp;<span class="builtinfunc" id="5177854">len</span><span class="op" id="5177857">(</span><span class="ident" id="5177858">te</span><span class="op" id="5177860">)</span>&nbsp;<span class="op" id="5177862">&gt;</span>&nbsp;<span class="num" id="5177864">0</span>&nbsp;<span class="op" id="5177866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177870">//&nbsp;Chunked&nbsp;encoding&nbsp;trumps&nbsp;Content-Length.&nbsp;See&nbsp;RFC&nbsp;2616</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177928">//&nbsp;Section&nbsp;4.4.&nbsp;Currently&nbsp;len(te)&nbsp;&gt;&nbsp;0&nbsp;implies&nbsp;chunked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177984">//&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5177999">delete</span><span class="op" id="5178005">(</span><span class="ident" id="5178006">header</span><span class="op" id="5178012">,</span>&nbsp;<span class="string" id="5178014">&#34;Content-Length&#34;</span><span class="op" id="5178030">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178034">return</span>&nbsp;<span class="ident" id="5178041">te</span><span class="op" id="5178043">,</span>&nbsp;<span class="ident" id="5178045">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178054">return</span>&nbsp;<span class="ident" id="5178061">nil</span><span class="op" id="5178064">,</span>&nbsp;<span class="ident" id="5178066">nil</span><br>
<span class="lineno"></span><span class="op" id="5178070">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="5178073">//&nbsp;Determine&nbsp;the&nbsp;expected&nbsp;body&nbsp;length,&nbsp;using&nbsp;RFC&nbsp;2616&nbsp;Section&nbsp;4.4.&nbsp;This</span><br>
<span class="lineno"></span><span class="comment" id="5178145">//&nbsp;function&nbsp;is&nbsp;not&nbsp;a&nbsp;method,&nbsp;because&nbsp;ultimately&nbsp;it&nbsp;should&nbsp;be&nbsp;shared&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5178216">//&nbsp;ReadResponse&nbsp;and&nbsp;ReadRequest.</span><br>
<span class="lineno"></span><span class="keyword" id="5178249">func</span>&nbsp;<span class="ident" id="5178254">fixLength</span><span class="op" id="5178263">(</span><span class="ident" id="5178264">isResponse</span>&nbsp;<span class="builtintype" id="5178275">bool</span><span class="op" id="5178279">,</span>&nbsp;<span class="ident" id="5178281">status</span>&nbsp;<span class="builtintype" id="5178288">int</span><span class="op" id="5178291">,</span>&nbsp;<span class="ident" id="5178293">requestMethod</span>&nbsp;<span class="builtintype" id="5178307">string</span><span class="op" id="5178313">,</span>&nbsp;<span class="ident" id="5178315">header</span>&nbsp;<span class="ident" id="5178322">Header</span><span class="op" id="5178328">,</span>&nbsp;<span class="ident" id="5178330">te</span>&nbsp;<span class="op" id="5178333">[</span><span class="op" id="5178334">]</span><span class="builtintype" id="5178335">string</span><span class="op" id="5178341">)</span>&nbsp;<span class="op" id="5178343">(</span><span class="ident" id="5178344">int64</span><span class="op" id="5178349">,</span>&nbsp;<span class="builtintype" id="5178351">error</span><span class="op" id="5178356">)</span>&nbsp;<span class="op" id="5178358">{</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5178362">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;response&nbsp;type&nbsp;or&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178405">if</span>&nbsp;<span class="ident" id="5178408">noBodyExpected</span><span class="op" id="5178422">(</span><span class="ident" id="5178423">requestMethod</span><span class="op" id="5178436">)</span>&nbsp;<span class="op" id="5178438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178442">return</span>&nbsp;<span class="num" id="5178449">0</span><span class="op" id="5178450">,</span>&nbsp;<span class="ident" id="5178452">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178457">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178460">if</span>&nbsp;<span class="ident" id="5178463">status</span><span class="op" id="5178469">/</span><span class="num" id="5178470">100</span>&nbsp;<span class="op" id="5178474">==</span>&nbsp;<span class="num" id="5178477">1</span>&nbsp;<span class="op" id="5178479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178483">return</span>&nbsp;<span class="num" id="5178490">0</span><span class="op" id="5178491">,</span>&nbsp;<span class="ident" id="5178493">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178501">switch</span>&nbsp;<span class="ident" id="5178508">status</span>&nbsp;<span class="op" id="5178515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178518">case</span>&nbsp;<span class="num" id="5178523">204</span><span class="op" id="5178526">,</span>&nbsp;<span class="num" id="5178528">304</span><span class="op" id="5178531">:</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178535">return</span>&nbsp;<span class="num" id="5178542">0</span><span class="op" id="5178543">,</span>&nbsp;<span class="ident" id="5178545">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5178554">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178591">if</span>&nbsp;<span class="ident" id="5178594">chunked</span><span class="op" id="5178601">(</span><span class="ident" id="5178602">te</span><span class="op" id="5178604">)</span>&nbsp;<span class="op" id="5178606">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178610">return</span>&nbsp;<span class="op" id="5178617">-</span><span class="num" id="5178618">1</span><span class="op" id="5178619">,</span>&nbsp;<span class="ident" id="5178621">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5178630">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178664">cl</span>&nbsp;<span class="op" id="5178667">:=</span>&nbsp;<span class="ident" id="5178670">strings</span><span class="op" id="5178677">.</span><span class="ident" id="5178678">TrimSpace</span><span class="op" id="5178687">(</span><span class="ident" id="5178688">header</span><span class="op" id="5178694">.</span><span class="ident" id="5178695">get</span><span class="op" id="5178698">(</span><span class="string" id="5178699">&#34;Content-Length&#34;</span><span class="op" id="5178715">)</span><span class="op" id="5178716">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178719">if</span>&nbsp;<span class="ident" id="5178722">cl</span>&nbsp;<span class="op" id="5178725">!=</span>&nbsp;<span class="string" id="5178728">&#34;&#34;</span>&nbsp;<span class="op" id="5178731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178735">n</span><span class="op" id="5178736">,</span>&nbsp;<span class="ident" id="5178738">err</span>&nbsp;<span class="op" id="5178742">:=</span>&nbsp;<span class="ident" id="5178745">parseContentLength</span><span class="op" id="5178763">(</span><span class="ident" id="5178764">cl</span><span class="op" id="5178766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178770">if</span>&nbsp;<span class="ident" id="5178773">err</span>&nbsp;<span class="op" id="5178777">!=</span>&nbsp;<span class="ident" id="5178780">nil</span>&nbsp;<span class="op" id="5178784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178789">return</span>&nbsp;<span class="op" id="5178796">-</span><span class="num" id="5178797">1</span><span class="op" id="5178798">,</span>&nbsp;<span class="ident" id="5178800">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178806">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178810">return</span>&nbsp;<span class="ident" id="5178817">n</span><span class="op" id="5178818">,</span>&nbsp;<span class="ident" id="5178820">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178825">}</span>&nbsp;<span class="keyword" id="5178827">else</span>&nbsp;<span class="op" id="5178832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178836">header</span><span class="op" id="5178842">.</span><span class="ident" id="5178843">Del</span><span class="op" id="5178846">(</span><span class="string" id="5178847">&#34;Content-Length&#34;</span><span class="op" id="5178863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178870">if</span>&nbsp;<span class="op" id="5178873">!</span><span class="ident" id="5178874">isResponse</span>&nbsp;<span class="op" id="5178885">&amp;&amp;</span>&nbsp;<span class="ident" id="5178888">requestMethod</span>&nbsp;<span class="op" id="5178902">==</span>&nbsp;<span class="string" id="5178905">&#34;GET&#34;</span>&nbsp;<span class="op" id="5178911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5178915">//&nbsp;RFC&nbsp;2616&nbsp;doesn&#39;t&nbsp;explicitly&nbsp;permit&nbsp;nor&nbsp;forbid&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5178969">//&nbsp;entity-body&nbsp;on&nbsp;a&nbsp;GET&nbsp;request&nbsp;so&nbsp;we&nbsp;permit&nbsp;one&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5179023">//&nbsp;declared,&nbsp;but&nbsp;we&nbsp;default&nbsp;to&nbsp;0&nbsp;here&nbsp;(not&nbsp;-1&nbsp;below)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5179078">//&nbsp;if&nbsp;there&#39;s&nbsp;no&nbsp;mention&nbsp;of&nbsp;a&nbsp;body.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179116">return</span>&nbsp;<span class="num" id="5179123">0</span><span class="op" id="5179124">,</span>&nbsp;<span class="ident" id="5179126">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5179131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5179135">//&nbsp;Body-EOF&nbsp;logic&nbsp;based&nbsp;on&nbsp;other&nbsp;methods&nbsp;(like&nbsp;closing,&nbsp;or&nbsp;chunked&nbsp;coding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179211">return</span>&nbsp;<span class="op" id="5179218">-</span><span class="num" id="5179219">1</span><span class="op" id="5179220">,</span>&nbsp;<span class="ident" id="5179222">nil</span><br>
<span class="lineno">500</span><span class="op" id="5179226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5179229">//&nbsp;Determine&nbsp;whether&nbsp;to&nbsp;hang&nbsp;up&nbsp;after&nbsp;sending&nbsp;a&nbsp;request&nbsp;and&nbsp;body,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5179298">//&nbsp;receiving&nbsp;a&nbsp;response&nbsp;and&nbsp;body</span><br>
<span class="lineno"></span><span class="comment" id="5179331">//&nbsp;&#39;header&#39;&nbsp;is&nbsp;the&nbsp;request&nbsp;headers</span><br>
<span class="lineno">505</span><span class="keyword" id="5179366">func</span>&nbsp;<span class="ident" id="5179371">shouldClose</span><span class="op" id="5179382">(</span><span class="ident" id="5179383">major</span><span class="op" id="5179388">,</span>&nbsp;<span class="ident" id="5179390">minor</span>&nbsp;<span class="builtintype" id="5179396">int</span><span class="op" id="5179399">,</span>&nbsp;<span class="ident" id="5179401">header</span>&nbsp;<span class="ident" id="5179408">Header</span><span class="op" id="5179414">,</span>&nbsp;<span class="ident" id="5179416">removeCloseHeader</span>&nbsp;<span class="builtintype" id="5179434">bool</span><span class="op" id="5179438">)</span>&nbsp;<span class="builtintype" id="5179440">bool</span>&nbsp;<span class="op" id="5179445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179448">if</span>&nbsp;<span class="ident" id="5179451">major</span>&nbsp;<span class="op" id="5179457">&lt;</span>&nbsp;<span class="num" id="5179459">1</span>&nbsp;<span class="op" id="5179461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179465">return</span>&nbsp;<span class="builtintype" id="5179472">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5179478">}</span>&nbsp;<span class="keyword" id="5179480">else</span>&nbsp;<span class="keyword" id="5179485">if</span>&nbsp;<span class="ident" id="5179488">major</span>&nbsp;<span class="op" id="5179494">==</span>&nbsp;<span class="num" id="5179497">1</span>&nbsp;<span class="op" id="5179499">&amp;&amp;</span>&nbsp;<span class="ident" id="5179502">minor</span>&nbsp;<span class="op" id="5179508">==</span>&nbsp;<span class="num" id="5179511">0</span>&nbsp;<span class="op" id="5179513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179517">if</span>&nbsp;<span class="op" id="5179520">!</span><span class="ident" id="5179521">strings</span><span class="op" id="5179528">.</span><span class="ident" id="5179529">Contains</span><span class="op" id="5179537">(</span><span class="ident" id="5179538">strings</span><span class="op" id="5179545">.</span><span class="ident" id="5179546">ToLower</span><span class="op" id="5179553">(</span><span class="ident" id="5179554">header</span><span class="op" id="5179560">.</span><span class="ident" id="5179561">get</span><span class="op" id="5179564">(</span><span class="string" id="5179565">&#34;Connection&#34;</span><span class="op" id="5179577">)</span><span class="op" id="5179578">)</span><span class="op" id="5179579">,</span>&nbsp;<span class="string" id="5179581">&#34;keep-alive&#34;</span><span class="op" id="5179593">)</span>&nbsp;<span class="op" id="5179595">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179600">return</span>&nbsp;<span class="builtintype" id="5179607">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5179614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179618">return</span>&nbsp;<span class="builtintype" id="5179625">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5179632">}</span>&nbsp;<span class="keyword" id="5179634">else</span>&nbsp;<span class="op" id="5179639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5179643">//&nbsp;TODO:&nbsp;Should&nbsp;split&nbsp;on&nbsp;commas,&nbsp;toss&nbsp;surrounding&nbsp;white&nbsp;space,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5179708">//&nbsp;and&nbsp;check&nbsp;each&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179735">if</span>&nbsp;<span class="ident" id="5179738">strings</span><span class="op" id="5179745">.</span><span class="ident" id="5179746">ToLower</span><span class="op" id="5179753">(</span><span class="ident" id="5179754">header</span><span class="op" id="5179760">.</span><span class="ident" id="5179761">get</span><span class="op" id="5179764">(</span><span class="string" id="5179765">&#34;Connection&#34;</span><span class="op" id="5179777">)</span><span class="op" id="5179778">)</span>&nbsp;<span class="op" id="5179780">==</span>&nbsp;<span class="string" id="5179783">&#34;close&#34;</span>&nbsp;<span class="op" id="5179791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179796">if</span>&nbsp;<span class="ident" id="5179799">removeCloseHeader</span>&nbsp;<span class="op" id="5179817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5179823">header</span><span class="op" id="5179829">.</span><span class="ident" id="5179830">Del</span><span class="op" id="5179833">(</span><span class="string" id="5179834">&#34;Connection&#34;</span><span class="op" id="5179846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5179851">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179856">return</span>&nbsp;<span class="builtintype" id="5179863">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5179870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5179873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179876">return</span>&nbsp;<span class="builtintype" id="5179883">false</span><br>
<span class="lineno"></span><span class="op" id="5179889">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="comment" id="5179892">//&nbsp;Parse&nbsp;the&nbsp;trailer&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="5179920">func</span>&nbsp;<span class="ident" id="5179925">fixTrailer</span><span class="op" id="5179935">(</span><span class="ident" id="5179936">header</span>&nbsp;<span class="ident" id="5179943">Header</span><span class="op" id="5179949">,</span>&nbsp;<span class="ident" id="5179951">te</span>&nbsp;<span class="op" id="5179954">[</span><span class="op" id="5179955">]</span><span class="builtintype" id="5179956">string</span><span class="op" id="5179962">)</span>&nbsp;<span class="op" id="5179964">(</span><span class="ident" id="5179965">Header</span><span class="op" id="5179971">,</span>&nbsp;<span class="builtintype" id="5179973">error</span><span class="op" id="5179978">)</span>&nbsp;<span class="op" id="5179980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5179983">raw</span>&nbsp;<span class="op" id="5179987">:=</span>&nbsp;<span class="ident" id="5179990">header</span><span class="op" id="5179996">.</span><span class="ident" id="5179997">get</span><span class="op" id="5180000">(</span><span class="string" id="5180001">&#34;Trailer&#34;</span><span class="op" id="5180010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180013">if</span>&nbsp;<span class="ident" id="5180016">raw</span>&nbsp;<span class="op" id="5180020">==</span>&nbsp;<span class="string" id="5180023">&#34;&#34;</span>&nbsp;<span class="op" id="5180026">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180030">return</span>&nbsp;<span class="ident" id="5180037">nil</span><span class="op" id="5180040">,</span>&nbsp;<span class="ident" id="5180042">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180051">header</span><span class="op" id="5180057">.</span><span class="ident" id="5180058">Del</span><span class="op" id="5180061">(</span><span class="string" id="5180062">&#34;Trailer&#34;</span><span class="op" id="5180071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180074">trailer</span>&nbsp;<span class="op" id="5180082">:=</span>&nbsp;<span class="builtinfunc" id="5180085">make</span><span class="op" id="5180089">(</span><span class="ident" id="5180090">Header</span><span class="op" id="5180096">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180099">keys</span>&nbsp;<span class="op" id="5180104">:=</span>&nbsp;<span class="ident" id="5180107">strings</span><span class="op" id="5180114">.</span><span class="ident" id="5180115">Split</span><span class="op" id="5180120">(</span><span class="ident" id="5180121">raw</span><span class="op" id="5180124">,</span>&nbsp;<span class="string" id="5180126">&#34;,&#34;</span><span class="op" id="5180129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180132">for</span>&nbsp;<span class="ident" id="5180136">_</span><span class="op" id="5180137">,</span>&nbsp;<span class="ident" id="5180139">key</span>&nbsp;<span class="op" id="5180143">:=</span>&nbsp;<span class="keyword" id="5180146">range</span>&nbsp;<span class="ident" id="5180152">keys</span>&nbsp;<span class="op" id="5180157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180161">key</span>&nbsp;<span class="op" id="5180165">=</span>&nbsp;<span class="ident" id="5180167">CanonicalHeaderKey</span><span class="op" id="5180185">(</span><span class="ident" id="5180186">strings</span><span class="op" id="5180193">.</span><span class="ident" id="5180194">TrimSpace</span><span class="op" id="5180203">(</span><span class="ident" id="5180204">key</span><span class="op" id="5180207">)</span><span class="op" id="5180208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180212">switch</span>&nbsp;<span class="ident" id="5180219">key</span>&nbsp;<span class="op" id="5180223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180227">case</span>&nbsp;<span class="string" id="5180232">&#34;Transfer-Encoding&#34;</span><span class="op" id="5180251">,</span>&nbsp;<span class="string" id="5180253">&#34;Trailer&#34;</span><span class="op" id="5180262">,</span>&nbsp;<span class="string" id="5180264">&#34;Content-Length&#34;</span><span class="op" id="5180280">:</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180285">return</span>&nbsp;<span class="ident" id="5180292">nil</span><span class="op" id="5180295">,</span>&nbsp;<span class="op" id="5180297">&amp;</span><span class="ident" id="5180298">badStringError</span><span class="op" id="5180312">{</span><span class="string" id="5180313">&#34;bad&nbsp;trailer&nbsp;key&#34;</span><span class="op" id="5180330">,</span>&nbsp;<span class="ident" id="5180332">key</span><span class="op" id="5180335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180343">trailer</span><span class="op" id="5180350">[</span><span class="ident" id="5180351">key</span><span class="op" id="5180354">]</span>&nbsp;<span class="op" id="5180356">=</span>&nbsp;<span class="ident" id="5180358">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180366">if</span>&nbsp;<span class="builtinfunc" id="5180369">len</span><span class="op" id="5180372">(</span><span class="ident" id="5180373">trailer</span><span class="op" id="5180380">)</span>&nbsp;<span class="op" id="5180382">==</span>&nbsp;<span class="num" id="5180385">0</span>&nbsp;<span class="op" id="5180387">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180391">return</span>&nbsp;<span class="ident" id="5180398">nil</span><span class="op" id="5180401">,</span>&nbsp;<span class="ident" id="5180403">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180411">if</span>&nbsp;<span class="op" id="5180414">!</span><span class="ident" id="5180415">chunked</span><span class="op" id="5180422">(</span><span class="ident" id="5180423">te</span><span class="op" id="5180425">)</span>&nbsp;<span class="op" id="5180427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5180431">//&nbsp;Trailer&nbsp;and&nbsp;no&nbsp;chunking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180460">return</span>&nbsp;<span class="ident" id="5180467">nil</span><span class="op" id="5180470">,</span>&nbsp;<span class="ident" id="5180472">ErrUnexpectedTrailer</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180497">return</span>&nbsp;<span class="ident" id="5180504">trailer</span><span class="op" id="5180511">,</span>&nbsp;<span class="ident" id="5180513">nil</span><br>
<span class="lineno"></span><span class="op" id="5180517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5180520">//&nbsp;body&nbsp;turns&nbsp;a&nbsp;Reader&nbsp;into&nbsp;a&nbsp;ReadCloser.</span><br>
<span class="lineno">555</span><span class="comment" id="5180562">//&nbsp;Close&nbsp;ensures&nbsp;that&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;fully&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="5180613">//&nbsp;and&nbsp;then&nbsp;reads&nbsp;the&nbsp;trailer&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="5180657">type</span>&nbsp;<span class="ident" id="5180662">body</span>&nbsp;<span class="keyword" id="5180667">struct</span>&nbsp;<span class="op" id="5180674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180677">src</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180685">io</span><span class="op" id="5180687">.</span><span class="ident" id="5180688">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180696">hdr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180704">interface</span><span class="op" id="5180713">{</span><span class="op" id="5180714">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5180718">//&nbsp;non-nil&nbsp;(Response&nbsp;or&nbsp;Request)&nbsp;value&nbsp;means&nbsp;read&nbsp;trailer</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180777">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5180785">*</span><span class="ident" id="5180786">bufio</span><span class="op" id="5180791">.</span><span class="ident" id="5180792">Reader</span>&nbsp;<span class="comment" id="5180799">//&nbsp;underlying&nbsp;wire-format&nbsp;reader&nbsp;for&nbsp;the&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180849">closing</span>&nbsp;<span class="builtintype" id="5180857">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5180871">//&nbsp;is&nbsp;the&nbsp;connection&nbsp;to&nbsp;be&nbsp;closed&nbsp;after&nbsp;reading&nbsp;body?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180927">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180934">sync</span><span class="op" id="5180938">.</span><span class="ident" id="5180939">Mutex</span>&nbsp;<span class="comment" id="5180945">//&nbsp;guards&nbsp;closed,&nbsp;and&nbsp;calls&nbsp;to&nbsp;Read&nbsp;and&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180992">closed</span>&nbsp;<span class="builtintype" id="5180999">bool</span><br>
<span class="lineno">565</span><span class="op" id="5181004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5181007">//&nbsp;ErrBodyReadAfterClose&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;a&nbsp;Request&nbsp;or&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="5181079">//&nbsp;Body&nbsp;after&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;closed.&nbsp;This&nbsp;typically&nbsp;happens&nbsp;when&nbsp;the&nbsp;body&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5181159">//&nbsp;read&nbsp;after&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;calls&nbsp;WriteHeader&nbsp;or&nbsp;Write&nbsp;on&nbsp;its</span><br>
<span class="lineno">570</span><span class="comment" id="5181223">//&nbsp;ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="5181242">var</span>&nbsp;<span class="ident" id="5181246">ErrBodyReadAfterClose</span>&nbsp;<span class="op" id="5181268">=</span>&nbsp;<span class="ident" id="5181270">errors</span><span class="op" id="5181276">.</span><span class="ident" id="5181277">New</span><span class="op" id="5181280">(</span><span class="string" id="5181281">&#34;http:&nbsp;invalid&nbsp;Read&nbsp;on&nbsp;closed&nbsp;Body&#34;</span><span class="op" id="5181316">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5181319">func</span>&nbsp;<span class="op" id="5181324">(</span><span class="ident" id="5181325">b</span>&nbsp;<span class="op" id="5181327">*</span><span class="ident" id="5181328">body</span><span class="op" id="5181332">)</span>&nbsp;<span class="ident" id="5181334">Read</span><span class="op" id="5181338">(</span><span class="ident" id="5181339">p</span>&nbsp;<span class="op" id="5181341">[</span><span class="op" id="5181342">]</span><span class="builtintype" id="5181343">byte</span><span class="op" id="5181347">)</span>&nbsp;<span class="op" id="5181349">(</span><span class="ident" id="5181350">n</span>&nbsp;<span class="builtintype" id="5181352">int</span><span class="op" id="5181355">,</span>&nbsp;<span class="ident" id="5181357">err</span>&nbsp;<span class="builtintype" id="5181361">error</span><span class="op" id="5181366">)</span>&nbsp;<span class="op" id="5181368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181371">b</span><span class="op" id="5181372">.</span><span class="ident" id="5181373">mu</span><span class="op" id="5181375">.</span><span class="ident" id="5181376">Lock</span><span class="op" id="5181380">(</span><span class="op" id="5181381">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181384">defer</span>&nbsp;<span class="ident" id="5181390">b</span><span class="op" id="5181391">.</span><span class="ident" id="5181392">mu</span><span class="op" id="5181394">.</span><span class="ident" id="5181395">Unlock</span><span class="op" id="5181401">(</span><span class="op" id="5181402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181405">if</span>&nbsp;<span class="ident" id="5181408">b</span><span class="op" id="5181409">.</span><span class="ident" id="5181410">closed</span>&nbsp;<span class="op" id="5181417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181421">return</span>&nbsp;<span class="num" id="5181428">0</span><span class="op" id="5181429">,</span>&nbsp;<span class="ident" id="5181431">ErrBodyReadAfterClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5181454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181457">return</span>&nbsp;<span class="ident" id="5181464">b</span><span class="op" id="5181465">.</span><span class="ident" id="5181466">readLocked</span><span class="op" id="5181476">(</span><span class="ident" id="5181477">p</span><span class="op" id="5181478">)</span><br>
<span class="lineno">580</span><span class="op" id="5181480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5181483">//&nbsp;Must&nbsp;hold&nbsp;b.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="5181502">func</span>&nbsp;<span class="op" id="5181507">(</span><span class="ident" id="5181508">b</span>&nbsp;<span class="op" id="5181510">*</span><span class="ident" id="5181511">body</span><span class="op" id="5181515">)</span>&nbsp;<span class="ident" id="5181517">readLocked</span><span class="op" id="5181527">(</span><span class="ident" id="5181528">p</span>&nbsp;<span class="op" id="5181530">[</span><span class="op" id="5181531">]</span><span class="builtintype" id="5181532">byte</span><span class="op" id="5181536">)</span>&nbsp;<span class="op" id="5181538">(</span><span class="ident" id="5181539">n</span>&nbsp;<span class="builtintype" id="5181541">int</span><span class="op" id="5181544">,</span>&nbsp;<span class="ident" id="5181546">err</span>&nbsp;<span class="builtintype" id="5181550">error</span><span class="op" id="5181555">)</span>&nbsp;<span class="op" id="5181557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181560">n</span><span class="op" id="5181561">,</span>&nbsp;<span class="ident" id="5181563">err</span>&nbsp;<span class="op" id="5181567">=</span>&nbsp;<span class="ident" id="5181569">b</span><span class="op" id="5181570">.</span><span class="ident" id="5181571">src</span><span class="op" id="5181574">.</span><span class="ident" id="5181575">Read</span><span class="op" id="5181579">(</span><span class="ident" id="5181580">p</span><span class="op" id="5181581">)</span><br>
<span class="lineno">585</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181585">if</span>&nbsp;<span class="ident" id="5181588">err</span>&nbsp;<span class="op" id="5181592">==</span>&nbsp;<span class="ident" id="5181595">io</span><span class="op" id="5181597">.</span><span class="ident" id="5181598">EOF</span>&nbsp;<span class="op" id="5181602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5181606">//&nbsp;Chunked&nbsp;case.&nbsp;Read&nbsp;the&nbsp;trailer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181643">if</span>&nbsp;<span class="ident" id="5181646">b</span><span class="op" id="5181647">.</span><span class="ident" id="5181648">hdr</span>&nbsp;<span class="op" id="5181652">!=</span>&nbsp;<span class="ident" id="5181655">nil</span>&nbsp;<span class="op" id="5181659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181664">if</span>&nbsp;<span class="ident" id="5181667">e</span>&nbsp;<span class="op" id="5181669">:=</span>&nbsp;<span class="ident" id="5181672">b</span><span class="op" id="5181673">.</span><span class="ident" id="5181674">readTrailer</span><span class="op" id="5181685">(</span><span class="op" id="5181686">)</span><span class="op" id="5181687">;</span>&nbsp;<span class="ident" id="5181689">e</span>&nbsp;<span class="op" id="5181691">!=</span>&nbsp;<span class="ident" id="5181694">nil</span>&nbsp;<span class="op" id="5181698">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181704">err</span>&nbsp;<span class="op" id="5181708">=</span>&nbsp;<span class="ident" id="5181710">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5181715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181720">b</span><span class="op" id="5181721">.</span><span class="ident" id="5181722">hdr</span>&nbsp;<span class="op" id="5181726">=</span>&nbsp;<span class="ident" id="5181728">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5181734">}</span>&nbsp;<span class="keyword" id="5181736">else</span>&nbsp;<span class="op" id="5181741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5181746">//&nbsp;If&nbsp;the&nbsp;server&nbsp;declared&nbsp;the&nbsp;Content-Length,&nbsp;our&nbsp;body&nbsp;is&nbsp;a&nbsp;LimitedReader</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5181823">//&nbsp;and&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;whether&nbsp;this&nbsp;EOF&nbsp;arrived&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181882">if</span>&nbsp;<span class="ident" id="5181885">lr</span><span class="op" id="5181887">,</span>&nbsp;<span class="ident" id="5181889">ok</span>&nbsp;<span class="op" id="5181892">:=</span>&nbsp;<span class="ident" id="5181895">b</span><span class="op" id="5181896">.</span><span class="ident" id="5181897">src</span><span class="op" id="5181900">.</span><span class="op" id="5181901">(</span><span class="op" id="5181902">*</span><span class="ident" id="5181903">io</span><span class="op" id="5181905">.</span><span class="ident" id="5181906">LimitedReader</span><span class="op" id="5181919">)</span><span class="op" id="5181920">;</span>&nbsp;<span class="ident" id="5181922">ok</span>&nbsp;<span class="op" id="5181925">&amp;&amp;</span>&nbsp;<span class="ident" id="5181928">lr</span><span class="op" id="5181930">.</span><span class="ident" id="5181931">N</span>&nbsp;<span class="op" id="5181933">&gt;</span>&nbsp;<span class="num" id="5181935">0</span>&nbsp;<span class="op" id="5181937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181943">err</span>&nbsp;<span class="op" id="5181947">=</span>&nbsp;<span class="ident" id="5181949">io</span><span class="op" id="5181951">.</span><span class="ident" id="5181952">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5181972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5181976">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5181979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5181983">//&nbsp;If&nbsp;we&nbsp;can&nbsp;return&nbsp;an&nbsp;EOF&nbsp;here&nbsp;along&nbsp;with&nbsp;the&nbsp;read&nbsp;data,&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5182045">//&nbsp;so.&nbsp;This&nbsp;is&nbsp;optional&nbsp;per&nbsp;the&nbsp;io.Reader&nbsp;contract,&nbsp;but&nbsp;doing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5182108">//&nbsp;so&nbsp;helps&nbsp;the&nbsp;HTTP&nbsp;transport&nbsp;code&nbsp;recycle&nbsp;its&nbsp;connection</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5182168">//&nbsp;earlier&nbsp;(since&nbsp;it&nbsp;will&nbsp;see&nbsp;this&nbsp;EOF&nbsp;itself),&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5182229">//&nbsp;client&nbsp;doesn&#39;t&nbsp;do&nbsp;future&nbsp;reads&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182274">if</span>&nbsp;<span class="ident" id="5182277">err</span>&nbsp;<span class="op" id="5182281">==</span>&nbsp;<span class="ident" id="5182284">nil</span>&nbsp;<span class="op" id="5182288">&amp;&amp;</span>&nbsp;<span class="ident" id="5182291">n</span>&nbsp;<span class="op" id="5182293">&gt;</span>&nbsp;<span class="num" id="5182295">0</span>&nbsp;<span class="op" id="5182297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182301">if</span>&nbsp;<span class="ident" id="5182304">lr</span><span class="op" id="5182306">,</span>&nbsp;<span class="ident" id="5182308">ok</span>&nbsp;<span class="op" id="5182311">:=</span>&nbsp;<span class="ident" id="5182314">b</span><span class="op" id="5182315">.</span><span class="ident" id="5182316">src</span><span class="op" id="5182319">.</span><span class="op" id="5182320">(</span><span class="op" id="5182321">*</span><span class="ident" id="5182322">io</span><span class="op" id="5182324">.</span><span class="ident" id="5182325">LimitedReader</span><span class="op" id="5182338">)</span><span class="op" id="5182339">;</span>&nbsp;<span class="ident" id="5182341">ok</span>&nbsp;<span class="op" id="5182344">&amp;&amp;</span>&nbsp;<span class="ident" id="5182347">lr</span><span class="op" id="5182349">.</span><span class="ident" id="5182350">N</span>&nbsp;<span class="op" id="5182352">==</span>&nbsp;<span class="num" id="5182355">0</span>&nbsp;<span class="op" id="5182357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182362">err</span>&nbsp;<span class="op" id="5182366">=</span>&nbsp;<span class="ident" id="5182368">io</span><span class="op" id="5182370">.</span><span class="ident" id="5182371">EOF</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182380">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182384">return</span>&nbsp;<span class="ident" id="5182391">n</span><span class="op" id="5182392">,</span>&nbsp;<span class="ident" id="5182394">err</span><br>
<span class="lineno"></span><span class="op" id="5182398">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="keyword" id="5182401">var</span>&nbsp;<span class="op" id="5182405">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182408">singleCRLF</span>&nbsp;<span class="op" id="5182419">=</span>&nbsp;<span class="op" id="5182421">[</span><span class="op" id="5182422">]</span><span class="builtintype" id="5182423">byte</span><span class="op" id="5182427">(</span><span class="string" id="5182428">&#34;\r\n&#34;</span><span class="op" id="5182434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182437">doubleCRLF</span>&nbsp;<span class="op" id="5182448">=</span>&nbsp;<span class="op" id="5182450">[</span><span class="op" id="5182451">]</span><span class="builtintype" id="5182452">byte</span><span class="op" id="5182456">(</span><span class="string" id="5182457">&#34;\r\n\r\n&#34;</span><span class="op" id="5182467">)</span><br>
<span class="lineno"></span><span class="op" id="5182469">)</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="5182472">func</span>&nbsp;<span class="ident" id="5182477">seeUpcomingDoubleCRLF</span><span class="op" id="5182498">(</span><span class="ident" id="5182499">r</span>&nbsp;<span class="op" id="5182501">*</span><span class="ident" id="5182502">bufio</span><span class="op" id="5182507">.</span><span class="ident" id="5182508">Reader</span><span class="op" id="5182514">)</span>&nbsp;<span class="builtintype" id="5182516">bool</span>&nbsp;<span class="op" id="5182521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182524">for</span>&nbsp;<span class="ident" id="5182528">peekSize</span>&nbsp;<span class="op" id="5182537">:=</span>&nbsp;<span class="num" id="5182540">4</span><span class="op" id="5182541">;</span>&nbsp;<span class="op" id="5182543">;</span>&nbsp;<span class="ident" id="5182545">peekSize</span><span class="op" id="5182553">++</span>&nbsp;<span class="op" id="5182556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5182560">//&nbsp;This&nbsp;loop&nbsp;stops&nbsp;when&nbsp;Peek&nbsp;returns&nbsp;an&nbsp;error,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5182609">//&nbsp;which&nbsp;it&nbsp;does&nbsp;when&nbsp;r&#39;s&nbsp;buffer&nbsp;has&nbsp;been&nbsp;filled.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182661">buf</span><span class="op" id="5182664">,</span>&nbsp;<span class="ident" id="5182666">err</span>&nbsp;<span class="op" id="5182670">:=</span>&nbsp;<span class="ident" id="5182673">r</span><span class="op" id="5182674">.</span><span class="ident" id="5182675">Peek</span><span class="op" id="5182679">(</span><span class="ident" id="5182680">peekSize</span><span class="op" id="5182688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182692">if</span>&nbsp;<span class="ident" id="5182695">bytes</span><span class="op" id="5182700">.</span><span class="ident" id="5182701">HasSuffix</span><span class="op" id="5182710">(</span><span class="ident" id="5182711">buf</span><span class="op" id="5182714">,</span>&nbsp;<span class="ident" id="5182716">doubleCRLF</span><span class="op" id="5182726">)</span>&nbsp;<span class="op" id="5182728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182733">return</span>&nbsp;<span class="builtintype" id="5182740">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182751">if</span>&nbsp;<span class="ident" id="5182754">err</span>&nbsp;<span class="op" id="5182758">!=</span>&nbsp;<span class="ident" id="5182761">nil</span>&nbsp;<span class="op" id="5182765">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182770">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182784">return</span>&nbsp;<span class="builtintype" id="5182791">false</span><br>
<span class="lineno"></span><span class="op" id="5182797">}</span><br>
<span class="lineno">635</span><br>
<span class="lineno"></span><span class="keyword" id="5182800">var</span>&nbsp;<span class="ident" id="5182804">errTrailerEOF</span>&nbsp;<span class="op" id="5182818">=</span>&nbsp;<span class="ident" id="5182820">errors</span><span class="op" id="5182826">.</span><span class="ident" id="5182827">New</span><span class="op" id="5182830">(</span><span class="string" id="5182831">&#34;http:&nbsp;unexpected&nbsp;EOF&nbsp;reading&nbsp;trailer&#34;</span><span class="op" id="5182869">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5182872">func</span>&nbsp;<span class="op" id="5182877">(</span><span class="ident" id="5182878">b</span>&nbsp;<span class="op" id="5182880">*</span><span class="ident" id="5182881">body</span><span class="op" id="5182885">)</span>&nbsp;<span class="ident" id="5182887">readTrailer</span><span class="op" id="5182898">(</span><span class="op" id="5182899">)</span>&nbsp;<span class="builtintype" id="5182901">error</span>&nbsp;<span class="op" id="5182907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5182910">//&nbsp;The&nbsp;common&nbsp;case,&nbsp;since&nbsp;nobody&nbsp;uses&nbsp;trailers.</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182959">buf</span><span class="op" id="5182962">,</span>&nbsp;<span class="ident" id="5182964">err</span>&nbsp;<span class="op" id="5182968">:=</span>&nbsp;<span class="ident" id="5182971">b</span><span class="op" id="5182972">.</span><span class="ident" id="5182973">r</span><span class="op" id="5182974">.</span><span class="ident" id="5182975">Peek</span><span class="op" id="5182979">(</span><span class="num" id="5182980">2</span><span class="op" id="5182981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182984">if</span>&nbsp;<span class="ident" id="5182987">bytes</span><span class="op" id="5182992">.</span><span class="ident" id="5182993">Equal</span><span class="op" id="5182998">(</span><span class="ident" id="5182999">buf</span><span class="op" id="5183002">,</span>&nbsp;<span class="ident" id="5183004">singleCRLF</span><span class="op" id="5183014">)</span>&nbsp;<span class="op" id="5183016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183020">b</span><span class="op" id="5183021">.</span><span class="ident" id="5183022">r</span><span class="op" id="5183023">.</span><span class="ident" id="5183024">ReadByte</span><span class="op" id="5183032">(</span><span class="op" id="5183033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183037">b</span><span class="op" id="5183038">.</span><span class="ident" id="5183039">r</span><span class="op" id="5183040">.</span><span class="ident" id="5183041">ReadByte</span><span class="op" id="5183049">(</span><span class="op" id="5183050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183054">return</span>&nbsp;<span class="ident" id="5183061">nil</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183069">if</span>&nbsp;<span class="builtinfunc" id="5183072">len</span><span class="op" id="5183075">(</span><span class="ident" id="5183076">buf</span><span class="op" id="5183079">)</span>&nbsp;<span class="op" id="5183081">&lt;</span>&nbsp;<span class="num" id="5183083">2</span>&nbsp;<span class="op" id="5183085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183089">return</span>&nbsp;<span class="ident" id="5183096">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183114">if</span>&nbsp;<span class="ident" id="5183117">err</span>&nbsp;<span class="op" id="5183121">!=</span>&nbsp;<span class="ident" id="5183124">nil</span>&nbsp;<span class="op" id="5183128">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183132">return</span>&nbsp;<span class="ident" id="5183139">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5183148">//&nbsp;Make&nbsp;sure&nbsp;there&#39;s&nbsp;a&nbsp;header&nbsp;terminator&nbsp;coming&nbsp;up,&nbsp;to&nbsp;prevent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5183212">//&nbsp;a&nbsp;DoS&nbsp;with&nbsp;an&nbsp;unbounded&nbsp;size&nbsp;Trailer.&nbsp;&nbsp;It&#39;s&nbsp;not&nbsp;easy&nbsp;to</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5183272">//&nbsp;slip&nbsp;in&nbsp;a&nbsp;LimitReader&nbsp;here,&nbsp;as&nbsp;textproto.NewReader&nbsp;requires</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5183336">//&nbsp;a&nbsp;concrete&nbsp;*bufio.Reader.&nbsp;&nbsp;Also,&nbsp;we&nbsp;can&#39;t&nbsp;get&nbsp;all&nbsp;the&nbsp;way</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5183398">//&nbsp;back&nbsp;up&nbsp;to&nbsp;our&nbsp;conn&#39;s&nbsp;LimitedReader&nbsp;that&nbsp;*might*&nbsp;be&nbsp;backing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5183462">//&nbsp;this&nbsp;bufio.Reader.&nbsp;&nbsp;Instead,&nbsp;a&nbsp;hack:&nbsp;we&nbsp;iteratively&nbsp;Peek&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5183526">//&nbsp;to&nbsp;the&nbsp;bufio.Reader&#39;s&nbsp;max&nbsp;size,&nbsp;looking&nbsp;for&nbsp;a&nbsp;double&nbsp;CRLF.</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5183589">//&nbsp;This&nbsp;limits&nbsp;the&nbsp;trailer&nbsp;to&nbsp;the&nbsp;underlying&nbsp;buffer&nbsp;size,&nbsp;typically&nbsp;4kB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183663">if</span>&nbsp;<span class="op" id="5183666">!</span><span class="ident" id="5183667">seeUpcomingDoubleCRLF</span><span class="op" id="5183688">(</span><span class="ident" id="5183689">b</span><span class="op" id="5183690">.</span><span class="ident" id="5183691">r</span><span class="op" id="5183692">)</span>&nbsp;<span class="op" id="5183694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183698">return</span>&nbsp;<span class="ident" id="5183705">errors</span><span class="op" id="5183711">.</span><span class="ident" id="5183712">New</span><span class="op" id="5183715">(</span><span class="string" id="5183716">&#34;http:&nbsp;suspiciously&nbsp;long&nbsp;trailer&nbsp;after&nbsp;chunked&nbsp;body&#34;</span><span class="op" id="5183768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183775">hdr</span><span class="op" id="5183778">,</span>&nbsp;<span class="ident" id="5183780">err</span>&nbsp;<span class="op" id="5183784">:=</span>&nbsp;<span class="ident" id="5183787">textproto</span><span class="op" id="5183796">.</span><span class="ident" id="5183797">NewReader</span><span class="op" id="5183806">(</span><span class="ident" id="5183807">b</span><span class="op" id="5183808">.</span><span class="ident" id="5183809">r</span><span class="op" id="5183810">)</span><span class="op" id="5183811">.</span><span class="ident" id="5183812">ReadMIMEHeader</span><span class="op" id="5183826">(</span><span class="op" id="5183827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183830">if</span>&nbsp;<span class="ident" id="5183833">err</span>&nbsp;<span class="op" id="5183837">!=</span>&nbsp;<span class="ident" id="5183840">nil</span>&nbsp;<span class="op" id="5183844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183848">if</span>&nbsp;<span class="ident" id="5183851">err</span>&nbsp;<span class="op" id="5183855">==</span>&nbsp;<span class="ident" id="5183858">io</span><span class="op" id="5183860">.</span><span class="ident" id="5183861">EOF</span>&nbsp;<span class="op" id="5183865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183870">return</span>&nbsp;<span class="ident" id="5183877">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183893">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183897">return</span>&nbsp;<span class="ident" id="5183904">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183912">switch</span>&nbsp;<span class="ident" id="5183919">rr</span>&nbsp;<span class="op" id="5183922">:=</span>&nbsp;<span class="ident" id="5183925">b</span><span class="op" id="5183926">.</span><span class="ident" id="5183927">hdr</span><span class="op" id="5183930">.</span><span class="op" id="5183931">(</span><span class="keyword" id="5183932">type</span><span class="op" id="5183936">)</span>&nbsp;<span class="op" id="5183938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183941">case</span>&nbsp;<span class="op" id="5183946">*</span><span class="ident" id="5183947">Request</span><span class="op" id="5183954">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183958">mergeSetHeader</span><span class="op" id="5183972">(</span><span class="op" id="5183973">&amp;</span><span class="ident" id="5183974">rr</span><span class="op" id="5183976">.</span><span class="ident" id="5183977">Trailer</span><span class="op" id="5183984">,</span>&nbsp;<span class="ident" id="5183986">Header</span><span class="op" id="5183992">(</span><span class="ident" id="5183993">hdr</span><span class="op" id="5183996">)</span><span class="op" id="5183997">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184000">case</span>&nbsp;<span class="op" id="5184005">*</span><span class="ident" id="5184006">Response</span><span class="op" id="5184014">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184018">mergeSetHeader</span><span class="op" id="5184032">(</span><span class="op" id="5184033">&amp;</span><span class="ident" id="5184034">rr</span><span class="op" id="5184036">.</span><span class="ident" id="5184037">Trailer</span><span class="op" id="5184044">,</span>&nbsp;<span class="ident" id="5184046">Header</span><span class="op" id="5184052">(</span><span class="ident" id="5184053">hdr</span><span class="op" id="5184056">)</span><span class="op" id="5184057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5184060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184063">return</span>&nbsp;<span class="ident" id="5184070">nil</span><br>
<span class="lineno"></span><span class="op" id="5184074">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="5184077">func</span>&nbsp;<span class="ident" id="5184082">mergeSetHeader</span><span class="op" id="5184096">(</span><span class="ident" id="5184097">dst</span>&nbsp;<span class="op" id="5184101">*</span><span class="ident" id="5184102">Header</span><span class="op" id="5184108">,</span>&nbsp;<span class="ident" id="5184110">src</span>&nbsp;<span class="ident" id="5184114">Header</span><span class="op" id="5184120">)</span>&nbsp;<span class="op" id="5184122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184125">if</span>&nbsp;<span class="op" id="5184128">*</span><span class="ident" id="5184129">dst</span>&nbsp;<span class="op" id="5184133">==</span>&nbsp;<span class="ident" id="5184136">nil</span>&nbsp;<span class="op" id="5184140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5184144">*</span><span class="ident" id="5184145">dst</span>&nbsp;<span class="op" id="5184149">=</span>&nbsp;<span class="ident" id="5184151">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184157">return</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5184165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184168">for</span>&nbsp;<span class="ident" id="5184172">k</span><span class="op" id="5184173">,</span>&nbsp;<span class="ident" id="5184175">vv</span>&nbsp;<span class="op" id="5184178">:=</span>&nbsp;<span class="keyword" id="5184181">range</span>&nbsp;<span class="ident" id="5184187">src</span>&nbsp;<span class="op" id="5184191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5184195">(</span><span class="op" id="5184196">*</span><span class="ident" id="5184197">dst</span><span class="op" id="5184200">)</span><span class="op" id="5184201">[</span><span class="ident" id="5184202">k</span><span class="op" id="5184203">]</span>&nbsp;<span class="op" id="5184205">=</span>&nbsp;<span class="ident" id="5184207">vv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5184211">}</span><br>
<span class="lineno"></span><span class="op" id="5184213">}</span><br>
<span class="lineno">690</span><br>
<span class="lineno"></span><span class="keyword" id="5184216">func</span>&nbsp;<span class="op" id="5184221">(</span><span class="ident" id="5184222">b</span>&nbsp;<span class="op" id="5184224">*</span><span class="ident" id="5184225">body</span><span class="op" id="5184229">)</span>&nbsp;<span class="ident" id="5184231">Close</span><span class="op" id="5184236">(</span><span class="op" id="5184237">)</span>&nbsp;<span class="builtintype" id="5184239">error</span>&nbsp;<span class="op" id="5184245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184248">b</span><span class="op" id="5184249">.</span><span class="ident" id="5184250">mu</span><span class="op" id="5184252">.</span><span class="ident" id="5184253">Lock</span><span class="op" id="5184257">(</span><span class="op" id="5184258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184261">defer</span>&nbsp;<span class="ident" id="5184267">b</span><span class="op" id="5184268">.</span><span class="ident" id="5184269">mu</span><span class="op" id="5184271">.</span><span class="ident" id="5184272">Unlock</span><span class="op" id="5184278">(</span><span class="op" id="5184279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184282">if</span>&nbsp;<span class="ident" id="5184285">b</span><span class="op" id="5184286">.</span><span class="ident" id="5184287">closed</span>&nbsp;<span class="op" id="5184294">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184298">return</span>&nbsp;<span class="ident" id="5184305">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5184310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184313">var</span>&nbsp;<span class="ident" id="5184317">err</span>&nbsp;<span class="builtintype" id="5184321">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184328">switch</span>&nbsp;<span class="op" id="5184335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184338">case</span>&nbsp;<span class="ident" id="5184343">b</span><span class="op" id="5184344">.</span><span class="ident" id="5184345">hdr</span>&nbsp;<span class="op" id="5184349">==</span>&nbsp;<span class="ident" id="5184352">nil</span>&nbsp;<span class="op" id="5184356">&amp;&amp;</span>&nbsp;<span class="ident" id="5184359">b</span><span class="op" id="5184360">.</span><span class="ident" id="5184361">closing</span><span class="op" id="5184368">:</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5184372">//&nbsp;no&nbsp;trailer&nbsp;and&nbsp;closing&nbsp;the&nbsp;connection&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5184421">//&nbsp;no&nbsp;point&nbsp;in&nbsp;reading&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184453">default</span><span class="op" id="5184460">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5184464">//&nbsp;Fully&nbsp;consume&nbsp;the&nbsp;body,&nbsp;which&nbsp;will&nbsp;also&nbsp;lead&nbsp;to&nbsp;us&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5184528">//&nbsp;the&nbsp;trailer&nbsp;headers&nbsp;after&nbsp;the&nbsp;body,&nbsp;if&nbsp;present.</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184581">_</span><span class="op" id="5184582">,</span>&nbsp;<span class="ident" id="5184584">err</span>&nbsp;<span class="op" id="5184588">=</span>&nbsp;<span class="ident" id="5184590">io</span><span class="op" id="5184592">.</span><span class="ident" id="5184593">Copy</span><span class="op" id="5184597">(</span><span class="ident" id="5184598">ioutil</span><span class="op" id="5184604">.</span><span class="ident" id="5184605">Discard</span><span class="op" id="5184612">,</span>&nbsp;<span class="ident" id="5184614">bodyLocked</span><span class="op" id="5184624">{</span><span class="ident" id="5184625">b</span><span class="op" id="5184626">}</span><span class="op" id="5184627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5184630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184633">b</span><span class="op" id="5184634">.</span><span class="ident" id="5184635">closed</span>&nbsp;<span class="op" id="5184642">=</span>&nbsp;<span class="builtintype" id="5184644">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184650">return</span>&nbsp;<span class="ident" id="5184657">err</span><br>
<span class="lineno"></span><span class="op" id="5184661">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="5184664">//&nbsp;bodyLocked&nbsp;is&nbsp;a&nbsp;io.Reader&nbsp;reading&nbsp;from&nbsp;a&nbsp;*body&nbsp;when&nbsp;its&nbsp;mutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5184732">//&nbsp;already&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="5184749">type</span>&nbsp;<span class="ident" id="5184754">bodyLocked</span>&nbsp;<span class="keyword" id="5184765">struct</span>&nbsp;<span class="op" id="5184772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184775">b</span>&nbsp;<span class="op" id="5184777">*</span><span class="ident" id="5184778">body</span><br>
<span class="lineno">715</span><span class="op" id="5184783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5184786">func</span>&nbsp;<span class="op" id="5184791">(</span><span class="ident" id="5184792">bl</span>&nbsp;<span class="ident" id="5184795">bodyLocked</span><span class="op" id="5184805">)</span>&nbsp;<span class="ident" id="5184807">Read</span><span class="op" id="5184811">(</span><span class="ident" id="5184812">p</span>&nbsp;<span class="op" id="5184814">[</span><span class="op" id="5184815">]</span><span class="builtintype" id="5184816">byte</span><span class="op" id="5184820">)</span>&nbsp;<span class="op" id="5184822">(</span><span class="ident" id="5184823">n</span>&nbsp;<span class="builtintype" id="5184825">int</span><span class="op" id="5184828">,</span>&nbsp;<span class="ident" id="5184830">err</span>&nbsp;<span class="builtintype" id="5184834">error</span><span class="op" id="5184839">)</span>&nbsp;<span class="op" id="5184841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184844">if</span>&nbsp;<span class="ident" id="5184847">bl</span><span class="op" id="5184849">.</span><span class="ident" id="5184850">b</span><span class="op" id="5184851">.</span><span class="ident" id="5184852">closed</span>&nbsp;<span class="op" id="5184859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184863">return</span>&nbsp;<span class="num" id="5184870">0</span><span class="op" id="5184871">,</span>&nbsp;<span class="ident" id="5184873">ErrBodyReadAfterClose</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5184896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184899">return</span>&nbsp;<span class="ident" id="5184906">bl</span><span class="op" id="5184908">.</span><span class="ident" id="5184909">b</span><span class="op" id="5184910">.</span><span class="ident" id="5184911">readLocked</span><span class="op" id="5184921">(</span><span class="ident" id="5184922">p</span><span class="op" id="5184923">)</span><br>
<span class="lineno"></span><span class="op" id="5184925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5184928">//&nbsp;parseContentLength&nbsp;trims&nbsp;whitespace&nbsp;from&nbsp;s&nbsp;and&nbsp;returns&nbsp;-1&nbsp;if&nbsp;no&nbsp;value</span><br>
<span class="lineno">725</span><span class="comment" id="5185001">//&nbsp;is&nbsp;set,&nbsp;or&nbsp;the&nbsp;value&nbsp;if&nbsp;it&#39;s&nbsp;&gt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="5185039">func</span>&nbsp;<span class="ident" id="5185044">parseContentLength</span><span class="op" id="5185062">(</span><span class="ident" id="5185063">cl</span>&nbsp;<span class="builtintype" id="5185066">string</span><span class="op" id="5185072">)</span>&nbsp;<span class="op" id="5185074">(</span><span class="ident" id="5185075">int64</span><span class="op" id="5185080">,</span>&nbsp;<span class="builtintype" id="5185082">error</span><span class="op" id="5185087">)</span>&nbsp;<span class="op" id="5185089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185092">cl</span>&nbsp;<span class="op" id="5185095">=</span>&nbsp;<span class="ident" id="5185097">strings</span><span class="op" id="5185104">.</span><span class="ident" id="5185105">TrimSpace</span><span class="op" id="5185114">(</span><span class="ident" id="5185115">cl</span><span class="op" id="5185117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185120">if</span>&nbsp;<span class="ident" id="5185123">cl</span>&nbsp;<span class="op" id="5185126">==</span>&nbsp;<span class="string" id="5185129">&#34;&#34;</span>&nbsp;<span class="op" id="5185132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185136">return</span>&nbsp;<span class="op" id="5185143">-</span><span class="num" id="5185144">1</span><span class="op" id="5185145">,</span>&nbsp;<span class="ident" id="5185147">nil</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5185152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185155">n</span><span class="op" id="5185156">,</span>&nbsp;<span class="ident" id="5185158">err</span>&nbsp;<span class="op" id="5185162">:=</span>&nbsp;<span class="ident" id="5185165">strconv</span><span class="op" id="5185172">.</span><span class="ident" id="5185173">ParseInt</span><span class="op" id="5185181">(</span><span class="ident" id="5185182">cl</span><span class="op" id="5185184">,</span>&nbsp;<span class="num" id="5185186">10</span><span class="op" id="5185188">,</span>&nbsp;<span class="num" id="5185190">64</span><span class="op" id="5185192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185195">if</span>&nbsp;<span class="ident" id="5185198">err</span>&nbsp;<span class="op" id="5185202">!=</span>&nbsp;<span class="ident" id="5185205">nil</span>&nbsp;<span class="op" id="5185209">||</span>&nbsp;<span class="ident" id="5185212">n</span>&nbsp;<span class="op" id="5185214">&lt;</span>&nbsp;<span class="num" id="5185216">0</span>&nbsp;<span class="op" id="5185218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185222">return</span>&nbsp;<span class="num" id="5185229">0</span><span class="op" id="5185230">,</span>&nbsp;<span class="op" id="5185232">&amp;</span><span class="ident" id="5185233">badStringError</span><span class="op" id="5185247">{</span><span class="string" id="5185248">&#34;bad&nbsp;Content-Length&#34;</span><span class="op" id="5185268">,</span>&nbsp;<span class="ident" id="5185270">cl</span><span class="op" id="5185272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5185275">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185278">return</span>&nbsp;<span class="ident" id="5185285">n</span><span class="op" id="5185286">,</span>&nbsp;<span class="ident" id="5185288">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="5185293">}</span>
</div>
</body>
</html>
