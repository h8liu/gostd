<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html" class="current">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6142753">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6142808">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6142862">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6142913">package</span>&nbsp;<span class="ident" id="6142921">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6142927">import</span>&nbsp;<span class="op" id="6142934">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6142937">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6142942">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="6142945">//&nbsp;maxCodeLength&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="6143023">const</span>&nbsp;<span class="ident" id="6143029">maxCodeLength</span>&nbsp;<span class="op" id="6143043">=</span>&nbsp;<span class="num" id="6143045">16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6143049">//&nbsp;maxNCodes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;tree.</span><br>
<span class="lineno">15</span><span class="keyword" id="6143124">const</span>&nbsp;<span class="ident" id="6143130">maxNCodes</span>&nbsp;<span class="op" id="6143140">=</span>&nbsp;<span class="num" id="6143142">256</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6143147">//&nbsp;lutSize&nbsp;is&nbsp;the&nbsp;log-2&nbsp;size&nbsp;of&nbsp;the&nbsp;Huffman&nbsp;decoder&#39;s&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="6143216">const</span>&nbsp;<span class="ident" id="6143222">lutSize</span>&nbsp;<span class="op" id="6143230">=</span>&nbsp;<span class="num" id="6143232">8</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6143235">//&nbsp;huffman&nbsp;is&nbsp;a&nbsp;Huffman&nbsp;decoder,&nbsp;specified&nbsp;in&nbsp;section&nbsp;C.</span><br>
<span class="lineno"></span><span class="keyword" id="6143292">type</span>&nbsp;<span class="ident" id="6143297">huffman</span>&nbsp;<span class="keyword" id="6143305">struct</span>&nbsp;<span class="op" id="6143312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6143315">//&nbsp;length&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6143362">nCodes</span>&nbsp;<span class="builtintype" id="6143369">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6143376">//&nbsp;lut&nbsp;is&nbsp;the&nbsp;look-up&nbsp;table&nbsp;for&nbsp;the&nbsp;next&nbsp;lutSize&nbsp;bits&nbsp;in&nbsp;the&nbsp;bit-stream.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6143450">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;the&nbsp;uint16&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.&nbsp;The&nbsp;low&nbsp;8&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6143522">//&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;code&nbsp;length,&nbsp;or&nbsp;0&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;fit&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6143595">//&nbsp;lutSize&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6143613">lut</span>&nbsp;<span class="op" id="6143617">[</span><span class="num" id="6143618">1</span>&nbsp;<span class="op" id="6143620">&lt;&lt;</span>&nbsp;<span class="ident" id="6143623">lutSize</span><span class="op" id="6143630">]</span><span class="builtintype" id="6143631">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6143639">//&nbsp;vals&nbsp;are&nbsp;the&nbsp;decoded&nbsp;values,&nbsp;sorted&nbsp;by&nbsp;their&nbsp;encoding.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6143698">vals</span>&nbsp;<span class="op" id="6143703">[</span><span class="ident" id="6143704">maxNCodes</span><span class="op" id="6143713">]</span><span class="builtintype" id="6143714">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6143721">//&nbsp;minCodes[i]&nbsp;is&nbsp;the&nbsp;minimum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6143792">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6143818">minCodes</span>&nbsp;<span class="op" id="6143827">[</span><span class="ident" id="6143828">maxCodeLength</span><span class="op" id="6143841">]</span><span class="builtintype" id="6143842">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6143849">//&nbsp;maxCodes[i]&nbsp;is&nbsp;the&nbsp;maximum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6143920">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6143946">maxCodes</span>&nbsp;<span class="op" id="6143955">[</span><span class="ident" id="6143956">maxCodeLength</span><span class="op" id="6143969">]</span><span class="builtintype" id="6143970">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6143977">//&nbsp;valsIndices[i]&nbsp;is&nbsp;the&nbsp;index&nbsp;into&nbsp;vals&nbsp;of&nbsp;minCodes[i].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6144035">valsIndices</span>&nbsp;<span class="op" id="6144047">[</span><span class="ident" id="6144048">maxCodeLength</span><span class="op" id="6144061">]</span><span class="builtintype" id="6144062">int32</span><br>
<span class="lineno"></span><span class="op" id="6144068">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="6144071">//&nbsp;errShortHuffmanData&nbsp;means&nbsp;that&nbsp;an&nbsp;unexpected&nbsp;EOF&nbsp;occurred&nbsp;while&nbsp;decoding</span><br>
<span class="lineno"></span><span class="comment" id="6144147">//&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6144164">var</span>&nbsp;<span class="ident" id="6144168">errShortHuffmanData</span>&nbsp;<span class="op" id="6144188">=</span>&nbsp;<span class="ident" id="6144190">FormatError</span><span class="op" id="6144201">(</span><span class="string" id="6144202">&#34;short&nbsp;Huffman&nbsp;data&#34;</span><span class="op" id="6144222">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="6144225">//&nbsp;ensureNBits&nbsp;reads&nbsp;bytes&nbsp;from&nbsp;the&nbsp;byte&nbsp;buffer&nbsp;to&nbsp;ensure&nbsp;that&nbsp;d.bits.n&nbsp;is&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="6144303">//&nbsp;least&nbsp;n.&nbsp;For&nbsp;best&nbsp;performance&nbsp;(avoiding&nbsp;function&nbsp;calls&nbsp;inside&nbsp;hot&nbsp;loops),</span><br>
<span class="lineno"></span><span class="comment" id="6144380">//&nbsp;the&nbsp;caller&nbsp;is&nbsp;the&nbsp;one&nbsp;responsible&nbsp;for&nbsp;first&nbsp;checking&nbsp;that&nbsp;d.bits.n&nbsp;&lt;&nbsp;n.</span><br>
<span class="lineno"></span><span class="keyword" id="6144455">func</span>&nbsp;<span class="op" id="6144460">(</span><span class="ident" id="6144461">d</span>&nbsp;<span class="op" id="6144463">*</span><span class="ident" id="6144464">decoder</span><span class="op" id="6144471">)</span>&nbsp;<span class="ident" id="6144473">ensureNBits</span><span class="op" id="6144484">(</span><span class="ident" id="6144485">n</span>&nbsp;<span class="builtintype" id="6144487">int32</span><span class="op" id="6144492">)</span>&nbsp;<span class="builtintype" id="6144494">error</span>&nbsp;<span class="op" id="6144500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6144503">for</span>&nbsp;<span class="op" id="6144507">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6144511">c</span><span class="op" id="6144512">,</span>&nbsp;<span class="ident" id="6144514">err</span>&nbsp;<span class="op" id="6144518">:=</span>&nbsp;<span class="ident" id="6144521">d</span><span class="op" id="6144522">.</span><span class="ident" id="6144523">readByteStuffedByte</span><span class="op" id="6144542">(</span><span class="op" id="6144543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6144547">if</span>&nbsp;<span class="ident" id="6144550">err</span>&nbsp;<span class="op" id="6144554">!=</span>&nbsp;<span class="ident" id="6144557">nil</span>&nbsp;<span class="op" id="6144561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6144566">if</span>&nbsp;<span class="ident" id="6144569">err</span>&nbsp;<span class="op" id="6144573">==</span>&nbsp;<span class="ident" id="6144576">io</span><span class="op" id="6144578">.</span><span class="ident" id="6144579">EOF</span>&nbsp;<span class="op" id="6144583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6144589">return</span>&nbsp;<span class="ident" id="6144596">errShortHuffmanData</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6144619">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6144624">return</span>&nbsp;<span class="ident" id="6144631">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6144637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6144641">d</span><span class="op" id="6144642">.</span><span class="ident" id="6144643">bits</span><span class="op" id="6144647">.</span><span class="ident" id="6144648">a</span>&nbsp;<span class="op" id="6144650">=</span>&nbsp;<span class="ident" id="6144652">d</span><span class="op" id="6144653">.</span><span class="ident" id="6144654">bits</span><span class="op" id="6144658">.</span><span class="ident" id="6144659">a</span><span class="op" id="6144660">&lt;&lt;</span><span class="num" id="6144662">8</span>&nbsp;<span class="op" id="6144664">|</span>&nbsp;<span class="builtintype" id="6144666">uint32</span><span class="op" id="6144672">(</span><span class="ident" id="6144673">c</span><span class="op" id="6144674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6144678">d</span><span class="op" id="6144679">.</span><span class="ident" id="6144680">bits</span><span class="op" id="6144684">.</span><span class="ident" id="6144685">n</span>&nbsp;<span class="op" id="6144687">+=</span>&nbsp;<span class="num" id="6144690">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6144694">if</span>&nbsp;<span class="ident" id="6144697">d</span><span class="op" id="6144698">.</span><span class="ident" id="6144699">bits</span><span class="op" id="6144703">.</span><span class="ident" id="6144704">m</span>&nbsp;<span class="op" id="6144706">==</span>&nbsp;<span class="num" id="6144709">0</span>&nbsp;<span class="op" id="6144711">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6144716">d</span><span class="op" id="6144717">.</span><span class="ident" id="6144718">bits</span><span class="op" id="6144722">.</span><span class="ident" id="6144723">m</span>&nbsp;<span class="op" id="6144725">=</span>&nbsp;<span class="num" id="6144727">1</span>&nbsp;<span class="op" id="6144729">&lt;&lt;</span>&nbsp;<span class="num" id="6144732">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6144736">}</span>&nbsp;<span class="keyword" id="6144738">else</span>&nbsp;<span class="op" id="6144743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6144748">d</span><span class="op" id="6144749">.</span><span class="ident" id="6144750">bits</span><span class="op" id="6144754">.</span><span class="ident" id="6144755">m</span>&nbsp;<span class="op" id="6144757">&lt;&lt;=</span>&nbsp;<span class="num" id="6144761">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6144765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6144769">if</span>&nbsp;<span class="ident" id="6144772">d</span><span class="op" id="6144773">.</span><span class="ident" id="6144774">bits</span><span class="op" id="6144778">.</span><span class="ident" id="6144779">n</span>&nbsp;<span class="op" id="6144781">&gt;=</span>&nbsp;<span class="ident" id="6144784">n</span>&nbsp;<span class="op" id="6144786">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6144791">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6144799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6144802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6144805">return</span>&nbsp;<span class="ident" id="6144812">nil</span><br>
<span class="lineno"></span><span class="op" id="6144816">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="6144819">//&nbsp;receiveExtend&nbsp;is&nbsp;the&nbsp;composition&nbsp;of&nbsp;RECEIVE&nbsp;and&nbsp;EXTEND,&nbsp;specified&nbsp;in&nbsp;section</span><br>
<span class="lineno"></span><span class="comment" id="6144899">//&nbsp;F.2.2.1.</span><br>
<span class="lineno"></span><span class="keyword" id="6144911">func</span>&nbsp;<span class="op" id="6144916">(</span><span class="ident" id="6144917">d</span>&nbsp;<span class="op" id="6144919">*</span><span class="ident" id="6144920">decoder</span><span class="op" id="6144927">)</span>&nbsp;<span class="ident" id="6144929">receiveExtend</span><span class="op" id="6144942">(</span><span class="ident" id="6144943">t</span>&nbsp;<span class="builtintype" id="6144945">uint8</span><span class="op" id="6144950">)</span>&nbsp;<span class="op" id="6144952">(</span><span class="builtintype" id="6144953">int32</span><span class="op" id="6144958">,</span>&nbsp;<span class="builtintype" id="6144960">error</span><span class="op" id="6144965">)</span>&nbsp;<span class="op" id="6144967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6144970">if</span>&nbsp;<span class="ident" id="6144973">d</span><span class="op" id="6144974">.</span><span class="ident" id="6144975">bits</span><span class="op" id="6144979">.</span><span class="ident" id="6144980">n</span>&nbsp;<span class="op" id="6144982">&lt;</span>&nbsp;<span class="builtintype" id="6144984">int32</span><span class="op" id="6144989">(</span><span class="ident" id="6144990">t</span><span class="op" id="6144991">)</span>&nbsp;<span class="op" id="6144993">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6144997">if</span>&nbsp;<span class="ident" id="6145000">err</span>&nbsp;<span class="op" id="6145004">:=</span>&nbsp;<span class="ident" id="6145007">d</span><span class="op" id="6145008">.</span><span class="ident" id="6145009">ensureNBits</span><span class="op" id="6145020">(</span><span class="builtintype" id="6145021">int32</span><span class="op" id="6145026">(</span><span class="ident" id="6145027">t</span><span class="op" id="6145028">)</span><span class="op" id="6145029">)</span><span class="op" id="6145030">;</span>&nbsp;<span class="ident" id="6145032">err</span>&nbsp;<span class="op" id="6145036">!=</span>&nbsp;<span class="ident" id="6145039">nil</span>&nbsp;<span class="op" id="6145043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6145048">return</span>&nbsp;<span class="num" id="6145055">0</span><span class="op" id="6145056">,</span>&nbsp;<span class="ident" id="6145058">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6145064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6145067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6145070">d</span><span class="op" id="6145071">.</span><span class="ident" id="6145072">bits</span><span class="op" id="6145076">.</span><span class="ident" id="6145077">n</span>&nbsp;<span class="op" id="6145079">-=</span>&nbsp;<span class="builtintype" id="6145082">int32</span><span class="op" id="6145087">(</span><span class="ident" id="6145088">t</span><span class="op" id="6145089">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6145092">d</span><span class="op" id="6145093">.</span><span class="ident" id="6145094">bits</span><span class="op" id="6145098">.</span><span class="ident" id="6145099">m</span>&nbsp;<span class="op" id="6145101">&gt;&gt;=</span>&nbsp;<span class="ident" id="6145105">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6145108">s</span>&nbsp;<span class="op" id="6145110">:=</span>&nbsp;<span class="builtintype" id="6145113">int32</span><span class="op" id="6145118">(</span><span class="num" id="6145119">1</span><span class="op" id="6145120">)</span>&nbsp;<span class="op" id="6145122">&lt;&lt;</span>&nbsp;<span class="ident" id="6145125">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6145128">x</span>&nbsp;<span class="op" id="6145130">:=</span>&nbsp;<span class="builtintype" id="6145133">int32</span><span class="op" id="6145138">(</span><span class="ident" id="6145139">d</span><span class="op" id="6145140">.</span><span class="ident" id="6145141">bits</span><span class="op" id="6145145">.</span><span class="ident" id="6145146">a</span><span class="op" id="6145147">&gt;&gt;</span><span class="builtintype" id="6145149">uint8</span><span class="op" id="6145154">(</span><span class="ident" id="6145155">d</span><span class="op" id="6145156">.</span><span class="ident" id="6145157">bits</span><span class="op" id="6145161">.</span><span class="ident" id="6145162">n</span><span class="op" id="6145163">)</span><span class="op" id="6145164">)</span>&nbsp;<span class="op" id="6145166">&amp;</span>&nbsp;<span class="op" id="6145168">(</span><span class="ident" id="6145169">s</span>&nbsp;<span class="op" id="6145171">-</span>&nbsp;<span class="num" id="6145173">1</span><span class="op" id="6145174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6145177">if</span>&nbsp;<span class="ident" id="6145180">x</span>&nbsp;<span class="op" id="6145182">&lt;</span>&nbsp;<span class="ident" id="6145184">s</span><span class="op" id="6145185">&gt;&gt;</span><span class="num" id="6145187">1</span>&nbsp;<span class="op" id="6145189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6145193">x</span>&nbsp;<span class="op" id="6145195">+=</span>&nbsp;<span class="op" id="6145198">(</span><span class="op" id="6145199">(</span><span class="op" id="6145200">-</span><span class="num" id="6145201">1</span><span class="op" id="6145202">)</span>&nbsp;<span class="op" id="6145204">&lt;&lt;</span>&nbsp;<span class="ident" id="6145207">t</span><span class="op" id="6145208">)</span>&nbsp;<span class="op" id="6145210">+</span>&nbsp;<span class="num" id="6145212">1</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6145215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6145218">return</span>&nbsp;<span class="ident" id="6145225">x</span><span class="op" id="6145226">,</span>&nbsp;<span class="ident" id="6145228">nil</span><br>
<span class="lineno"></span><span class="op" id="6145232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6145235">//&nbsp;processDHT&nbsp;processes&nbsp;a&nbsp;Define&nbsp;Huffman&nbsp;Table&nbsp;marker,&nbsp;and&nbsp;initializes&nbsp;a&nbsp;huffman</span><br>
<span class="lineno">90</span><span class="comment" id="6145316">//&nbsp;struct&nbsp;from&nbsp;its&nbsp;contents.&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.2.</span><br>
<span class="lineno"></span><span class="keyword" id="6145375">func</span>&nbsp;<span class="op" id="6145380">(</span><span class="ident" id="6145381">d</span>&nbsp;<span class="op" id="6145383">*</span><span class="ident" id="6145384">decoder</span><span class="op" id="6145391">)</span>&nbsp;<span class="ident" id="6145393">processDHT</span><span class="op" id="6145403">(</span><span class="ident" id="6145404">n</span>&nbsp;<span class="builtintype" id="6145406">int</span><span class="op" id="6145409">)</span>&nbsp;<span class="builtintype" id="6145411">error</span>&nbsp;<span class="op" id="6145417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6145420">for</span>&nbsp;<span class="ident" id="6145424">n</span>&nbsp;<span class="op" id="6145426">&gt;</span>&nbsp;<span class="num" id="6145428">0</span>&nbsp;<span class="op" id="6145430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6145434">if</span>&nbsp;<span class="ident" id="6145437">n</span>&nbsp;<span class="op" id="6145439">&lt;</span>&nbsp;<span class="num" id="6145441">17</span>&nbsp;<span class="op" id="6145444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6145449">return</span>&nbsp;<span class="ident" id="6145456">FormatError</span><span class="op" id="6145467">(</span><span class="string" id="6145468">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6145490">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6145494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6145498">if</span>&nbsp;<span class="ident" id="6145501">err</span>&nbsp;<span class="op" id="6145505">:=</span>&nbsp;<span class="ident" id="6145508">d</span><span class="op" id="6145509">.</span><span class="ident" id="6145510">readFull</span><span class="op" id="6145518">(</span><span class="ident" id="6145519">d</span><span class="op" id="6145520">.</span><span class="ident" id="6145521">tmp</span><span class="op" id="6145524">[</span><span class="op" id="6145525">:</span><span class="num" id="6145526">17</span><span class="op" id="6145528">]</span><span class="op" id="6145529">)</span><span class="op" id="6145530">;</span>&nbsp;<span class="ident" id="6145532">err</span>&nbsp;<span class="op" id="6145536">!=</span>&nbsp;<span class="ident" id="6145539">nil</span>&nbsp;<span class="op" id="6145543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6145548">return</span>&nbsp;<span class="ident" id="6145555">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6145561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6145565">tc</span>&nbsp;<span class="op" id="6145568">:=</span>&nbsp;<span class="ident" id="6145571">d</span><span class="op" id="6145572">.</span><span class="ident" id="6145573">tmp</span><span class="op" id="6145576">[</span><span class="num" id="6145577">0</span><span class="op" id="6145578">]</span>&nbsp;<span class="op" id="6145580">&gt;&gt;</span>&nbsp;<span class="num" id="6145583">4</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6145587">if</span>&nbsp;<span class="ident" id="6145590">tc</span>&nbsp;<span class="op" id="6145593">&gt;</span>&nbsp;<span class="ident" id="6145595">maxTc</span>&nbsp;<span class="op" id="6145601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6145606">return</span>&nbsp;<span class="ident" id="6145613">FormatError</span><span class="op" id="6145624">(</span><span class="string" id="6145625">&#34;bad&nbsp;Tc&nbsp;value&#34;</span><span class="op" id="6145639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6145643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6145647">th</span>&nbsp;<span class="op" id="6145650">:=</span>&nbsp;<span class="ident" id="6145653">d</span><span class="op" id="6145654">.</span><span class="ident" id="6145655">tmp</span><span class="op" id="6145658">[</span><span class="num" id="6145659">0</span><span class="op" id="6145660">]</span>&nbsp;<span class="op" id="6145662">&amp;</span>&nbsp;<span class="num" id="6145664">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6145671">if</span>&nbsp;<span class="ident" id="6145674">th</span>&nbsp;<span class="op" id="6145677">&gt;</span>&nbsp;<span class="ident" id="6145679">maxTh</span>&nbsp;<span class="op" id="6145685">||</span>&nbsp;<span class="op" id="6145688">!</span><span class="ident" id="6145689">d</span><span class="op" id="6145690">.</span><span class="ident" id="6145691">progressive</span>&nbsp;<span class="op" id="6145703">&amp;&amp;</span>&nbsp;<span class="ident" id="6145706">th</span>&nbsp;<span class="op" id="6145709">&gt;</span>&nbsp;<span class="num" id="6145711">1</span>&nbsp;<span class="op" id="6145713">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6145718">return</span>&nbsp;<span class="ident" id="6145725">FormatError</span><span class="op" id="6145736">(</span><span class="string" id="6145737">&#34;bad&nbsp;Th&nbsp;value&#34;</span><span class="op" id="6145751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6145755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6145759">h</span>&nbsp;<span class="op" id="6145761">:=</span>&nbsp;<span class="op" id="6145764">&amp;</span><span class="ident" id="6145765">d</span><span class="op" id="6145766">.</span><span class="ident" id="6145767">huff</span><span class="op" id="6145771">[</span><span class="ident" id="6145772">tc</span><span class="op" id="6145774">]</span><span class="op" id="6145775">[</span><span class="ident" id="6145776">th</span><span class="op" id="6145778">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6145783">//&nbsp;Read&nbsp;nCodes&nbsp;and&nbsp;h.vals&nbsp;(and&nbsp;derive&nbsp;h.nCodes).</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6145834">//&nbsp;nCodes[i]&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;with&nbsp;code&nbsp;length&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6145892">//&nbsp;h.nCodes&nbsp;is&nbsp;the&nbsp;total&nbsp;number&nbsp;of&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6145936">h</span><span class="op" id="6145937">.</span><span class="ident" id="6145938">nCodes</span>&nbsp;<span class="op" id="6145945">=</span>&nbsp;<span class="num" id="6145947">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6145951">var</span>&nbsp;<span class="ident" id="6145955">nCodes</span>&nbsp;<span class="op" id="6145962">[</span><span class="ident" id="6145963">maxCodeLength</span><span class="op" id="6145976">]</span><span class="builtintype" id="6145977">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6145985">for</span>&nbsp;<span class="ident" id="6145989">i</span>&nbsp;<span class="op" id="6145991">:=</span>&nbsp;<span class="keyword" id="6145994">range</span>&nbsp;<span class="ident" id="6146000">nCodes</span>&nbsp;<span class="op" id="6146007">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6146012">nCodes</span><span class="op" id="6146018">[</span><span class="ident" id="6146019">i</span><span class="op" id="6146020">]</span>&nbsp;<span class="op" id="6146022">=</span>&nbsp;<span class="builtintype" id="6146024">int32</span><span class="op" id="6146029">(</span><span class="ident" id="6146030">d</span><span class="op" id="6146031">.</span><span class="ident" id="6146032">tmp</span><span class="op" id="6146035">[</span><span class="ident" id="6146036">i</span><span class="op" id="6146037">+</span><span class="num" id="6146038">1</span><span class="op" id="6146039">]</span><span class="op" id="6146040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6146045">h</span><span class="op" id="6146046">.</span><span class="ident" id="6146047">nCodes</span>&nbsp;<span class="op" id="6146054">+=</span>&nbsp;<span class="ident" id="6146057">nCodes</span><span class="op" id="6146063">[</span><span class="ident" id="6146064">i</span><span class="op" id="6146065">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6146069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6146073">if</span>&nbsp;<span class="ident" id="6146076">h</span><span class="op" id="6146077">.</span><span class="ident" id="6146078">nCodes</span>&nbsp;<span class="op" id="6146085">==</span>&nbsp;<span class="num" id="6146088">0</span>&nbsp;<span class="op" id="6146090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6146095">return</span>&nbsp;<span class="ident" id="6146102">FormatError</span><span class="op" id="6146113">(</span><span class="string" id="6146114">&#34;Huffman&nbsp;table&nbsp;has&nbsp;zero&nbsp;length&#34;</span><span class="op" id="6146145">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6146149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6146153">if</span>&nbsp;<span class="ident" id="6146156">h</span><span class="op" id="6146157">.</span><span class="ident" id="6146158">nCodes</span>&nbsp;<span class="op" id="6146165">&gt;</span>&nbsp;<span class="ident" id="6146167">maxNCodes</span>&nbsp;<span class="op" id="6146177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6146182">return</span>&nbsp;<span class="ident" id="6146189">FormatError</span><span class="op" id="6146200">(</span><span class="string" id="6146201">&#34;Huffman&nbsp;table&nbsp;has&nbsp;excessive&nbsp;length&#34;</span><span class="op" id="6146237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6146241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6146245">n</span>&nbsp;<span class="op" id="6146247">-=</span>&nbsp;<span class="builtintype" id="6146250">int</span><span class="op" id="6146253">(</span><span class="ident" id="6146254">h</span><span class="op" id="6146255">.</span><span class="ident" id="6146256">nCodes</span><span class="op" id="6146262">)</span>&nbsp;<span class="op" id="6146264">+</span>&nbsp;<span class="num" id="6146266">17</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6146271">if</span>&nbsp;<span class="ident" id="6146274">n</span>&nbsp;<span class="op" id="6146276">&lt;</span>&nbsp;<span class="num" id="6146278">0</span>&nbsp;<span class="op" id="6146280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6146285">return</span>&nbsp;<span class="ident" id="6146292">FormatError</span><span class="op" id="6146303">(</span><span class="string" id="6146304">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6146326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6146330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6146334">if</span>&nbsp;<span class="ident" id="6146337">err</span>&nbsp;<span class="op" id="6146341">:=</span>&nbsp;<span class="ident" id="6146344">d</span><span class="op" id="6146345">.</span><span class="ident" id="6146346">readFull</span><span class="op" id="6146354">(</span><span class="ident" id="6146355">h</span><span class="op" id="6146356">.</span><span class="ident" id="6146357">vals</span><span class="op" id="6146361">[</span><span class="op" id="6146362">:</span><span class="ident" id="6146363">h</span><span class="op" id="6146364">.</span><span class="ident" id="6146365">nCodes</span><span class="op" id="6146371">]</span><span class="op" id="6146372">)</span><span class="op" id="6146373">;</span>&nbsp;<span class="ident" id="6146375">err</span>&nbsp;<span class="op" id="6146379">!=</span>&nbsp;<span class="ident" id="6146382">nil</span>&nbsp;<span class="op" id="6146386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6146391">return</span>&nbsp;<span class="ident" id="6146398">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6146404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6146409">//&nbsp;Derive&nbsp;the&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6146440">for</span>&nbsp;<span class="ident" id="6146444">i</span>&nbsp;<span class="op" id="6146446">:=</span>&nbsp;<span class="keyword" id="6146449">range</span>&nbsp;<span class="ident" id="6146455">h</span><span class="op" id="6146456">.</span><span class="ident" id="6146457">lut</span>&nbsp;<span class="op" id="6146461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6146466">h</span><span class="op" id="6146467">.</span><span class="ident" id="6146468">lut</span><span class="op" id="6146471">[</span><span class="ident" id="6146472">i</span><span class="op" id="6146473">]</span>&nbsp;<span class="op" id="6146475">=</span>&nbsp;<span class="num" id="6146477">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6146481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6146485">var</span>&nbsp;<span class="ident" id="6146489">x</span><span class="op" id="6146490">,</span>&nbsp;<span class="ident" id="6146492">code</span>&nbsp;<span class="builtintype" id="6146497">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6146506">for</span>&nbsp;<span class="ident" id="6146510">i</span>&nbsp;<span class="op" id="6146512">:=</span>&nbsp;<span class="builtintype" id="6146515">uint32</span><span class="op" id="6146521">(</span><span class="num" id="6146522">0</span><span class="op" id="6146523">)</span><span class="op" id="6146524">;</span>&nbsp;<span class="ident" id="6146526">i</span>&nbsp;<span class="op" id="6146528">&lt;</span>&nbsp;<span class="ident" id="6146530">lutSize</span><span class="op" id="6146537">;</span>&nbsp;<span class="ident" id="6146539">i</span><span class="op" id="6146540">++</span>&nbsp;<span class="op" id="6146543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6146548">code</span>&nbsp;<span class="op" id="6146553">&lt;&lt;=</span>&nbsp;<span class="num" id="6146557">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6146562">for</span>&nbsp;<span class="ident" id="6146566">j</span>&nbsp;<span class="op" id="6146568">:=</span>&nbsp;<span class="builtintype" id="6146571">int32</span><span class="op" id="6146576">(</span><span class="num" id="6146577">0</span><span class="op" id="6146578">)</span><span class="op" id="6146579">;</span>&nbsp;<span class="ident" id="6146581">j</span>&nbsp;<span class="op" id="6146583">&lt;</span>&nbsp;<span class="ident" id="6146585">nCodes</span><span class="op" id="6146591">[</span><span class="ident" id="6146592">i</span><span class="op" id="6146593">]</span><span class="op" id="6146594">;</span>&nbsp;<span class="ident" id="6146596">j</span><span class="op" id="6146597">++</span>&nbsp;<span class="op" id="6146600">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6146606">//&nbsp;The&nbsp;codeLength&nbsp;is&nbsp;1+i,&nbsp;so&nbsp;shift&nbsp;code&nbsp;by&nbsp;8-(1+i)&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6146664">//&nbsp;calculate&nbsp;the&nbsp;high&nbsp;bits&nbsp;for&nbsp;every&nbsp;8-bit&nbsp;sequence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6146720">//&nbsp;whose&nbsp;codeLength&#39;s&nbsp;high&nbsp;bits&nbsp;matches&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6146770">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;lutValue&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6146828">//&nbsp;The&nbsp;low&nbsp;8&nbsp;bits&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;codeLength.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6146877">base</span>&nbsp;<span class="op" id="6146882">:=</span>&nbsp;<span class="builtintype" id="6146885">uint8</span><span class="op" id="6146890">(</span><span class="ident" id="6146891">code</span>&nbsp;<span class="op" id="6146896">&lt;&lt;</span>&nbsp;<span class="op" id="6146899">(</span><span class="num" id="6146900">7</span>&nbsp;<span class="op" id="6146902">-</span>&nbsp;<span class="ident" id="6146904">i</span><span class="op" id="6146905">)</span><span class="op" id="6146906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6146912">lutValue</span>&nbsp;<span class="op" id="6146921">:=</span>&nbsp;<span class="builtintype" id="6146924">uint16</span><span class="op" id="6146930">(</span><span class="ident" id="6146931">h</span><span class="op" id="6146932">.</span><span class="ident" id="6146933">vals</span><span class="op" id="6146937">[</span><span class="ident" id="6146938">x</span><span class="op" id="6146939">]</span><span class="op" id="6146940">)</span><span class="op" id="6146941">&lt;&lt;</span><span class="num" id="6146943">8</span>&nbsp;<span class="op" id="6146945">|</span>&nbsp;<span class="builtintype" id="6146947">uint16</span><span class="op" id="6146953">(</span><span class="num" id="6146954">2</span><span class="op" id="6146955">+</span><span class="ident" id="6146956">i</span><span class="op" id="6146957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6146963">for</span>&nbsp;<span class="ident" id="6146967">k</span>&nbsp;<span class="op" id="6146969">:=</span>&nbsp;<span class="builtintype" id="6146972">uint8</span><span class="op" id="6146977">(</span><span class="num" id="6146978">0</span><span class="op" id="6146979">)</span><span class="op" id="6146980">;</span>&nbsp;<span class="ident" id="6146982">k</span>&nbsp;<span class="op" id="6146984">&lt;</span>&nbsp;<span class="num" id="6146986">1</span><span class="op" id="6146987">&lt;&lt;</span><span class="op" id="6146989">(</span><span class="num" id="6146990">7</span><span class="op" id="6146991">-</span><span class="ident" id="6146992">i</span><span class="op" id="6146993">)</span><span class="op" id="6146994">;</span>&nbsp;<span class="ident" id="6146996">k</span><span class="op" id="6146997">++</span>&nbsp;<span class="op" id="6147000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6147007">h</span><span class="op" id="6147008">.</span><span class="ident" id="6147009">lut</span><span class="op" id="6147012">[</span><span class="ident" id="6147013">base</span><span class="op" id="6147017">|</span><span class="ident" id="6147018">k</span><span class="op" id="6147019">]</span>&nbsp;<span class="op" id="6147021">=</span>&nbsp;<span class="ident" id="6147023">lutValue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6147036">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6147042">code</span><span class="op" id="6147046">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6147053">x</span><span class="op" id="6147054">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6147060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6147064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6147069">//&nbsp;Derive&nbsp;minCodes,&nbsp;maxCodes,&nbsp;and&nbsp;valsIndices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6147118">var</span>&nbsp;<span class="ident" id="6147122">c</span><span class="op" id="6147123">,</span>&nbsp;<span class="ident" id="6147125">index</span>&nbsp;<span class="builtintype" id="6147131">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6147139">for</span>&nbsp;<span class="ident" id="6147143">i</span><span class="op" id="6147144">,</span>&nbsp;<span class="ident" id="6147146">n</span>&nbsp;<span class="op" id="6147148">:=</span>&nbsp;<span class="keyword" id="6147151">range</span>&nbsp;<span class="ident" id="6147157">nCodes</span>&nbsp;<span class="op" id="6147164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6147169">if</span>&nbsp;<span class="ident" id="6147172">n</span>&nbsp;<span class="op" id="6147174">==</span>&nbsp;<span class="num" id="6147177">0</span>&nbsp;<span class="op" id="6147179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6147185">h</span><span class="op" id="6147186">.</span><span class="ident" id="6147187">minCodes</span><span class="op" id="6147195">[</span><span class="ident" id="6147196">i</span><span class="op" id="6147197">]</span>&nbsp;<span class="op" id="6147199">=</span>&nbsp;<span class="op" id="6147201">-</span><span class="num" id="6147202">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6147208">h</span><span class="op" id="6147209">.</span><span class="ident" id="6147210">maxCodes</span><span class="op" id="6147218">[</span><span class="ident" id="6147219">i</span><span class="op" id="6147220">]</span>&nbsp;<span class="op" id="6147222">=</span>&nbsp;<span class="op" id="6147224">-</span><span class="num" id="6147225">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6147231">h</span><span class="op" id="6147232">.</span><span class="ident" id="6147233">valsIndices</span><span class="op" id="6147244">[</span><span class="ident" id="6147245">i</span><span class="op" id="6147246">]</span>&nbsp;<span class="op" id="6147248">=</span>&nbsp;<span class="op" id="6147250">-</span><span class="num" id="6147251">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6147256">}</span>&nbsp;<span class="keyword" id="6147258">else</span>&nbsp;<span class="op" id="6147263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6147269">h</span><span class="op" id="6147270">.</span><span class="ident" id="6147271">minCodes</span><span class="op" id="6147279">[</span><span class="ident" id="6147280">i</span><span class="op" id="6147281">]</span>&nbsp;<span class="op" id="6147283">=</span>&nbsp;<span class="ident" id="6147285">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6147291">h</span><span class="op" id="6147292">.</span><span class="ident" id="6147293">maxCodes</span><span class="op" id="6147301">[</span><span class="ident" id="6147302">i</span><span class="op" id="6147303">]</span>&nbsp;<span class="op" id="6147305">=</span>&nbsp;<span class="ident" id="6147307">c</span>&nbsp;<span class="op" id="6147309">+</span>&nbsp;<span class="ident" id="6147311">n</span>&nbsp;<span class="op" id="6147313">-</span>&nbsp;<span class="num" id="6147315">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6147321">h</span><span class="op" id="6147322">.</span><span class="ident" id="6147323">valsIndices</span><span class="op" id="6147334">[</span><span class="ident" id="6147335">i</span><span class="op" id="6147336">]</span>&nbsp;<span class="op" id="6147338">=</span>&nbsp;<span class="ident" id="6147340">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6147350">c</span>&nbsp;<span class="op" id="6147352">+=</span>&nbsp;<span class="ident" id="6147355">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6147361">index</span>&nbsp;<span class="op" id="6147367">+=</span>&nbsp;<span class="ident" id="6147370">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6147375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6147380">c</span>&nbsp;<span class="op" id="6147382">&lt;&lt;=</span>&nbsp;<span class="num" id="6147386">1</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6147390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6147393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6147396">return</span>&nbsp;<span class="ident" id="6147403">nil</span><br>
<span class="lineno"></span><span class="op" id="6147407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="6147410">//&nbsp;decodeHuffman&nbsp;returns&nbsp;the&nbsp;next&nbsp;Huffman-coded&nbsp;value&nbsp;from&nbsp;the&nbsp;bit-stream,</span><br>
<span class="lineno"></span><span class="comment" id="6147485">//&nbsp;decoded&nbsp;according&nbsp;to&nbsp;h.</span><br>
<span class="lineno"></span><span class="keyword" id="6147512">func</span>&nbsp;<span class="op" id="6147517">(</span><span class="ident" id="6147518">d</span>&nbsp;<span class="op" id="6147520">*</span><span class="ident" id="6147521">decoder</span><span class="op" id="6147528">)</span>&nbsp;<span class="ident" id="6147530">decodeHuffman</span><span class="op" id="6147543">(</span><span class="ident" id="6147544">h</span>&nbsp;<span class="op" id="6147546">*</span><span class="ident" id="6147547">huffman</span><span class="op" id="6147554">)</span>&nbsp;<span class="op" id="6147556">(</span><span class="builtintype" id="6147557">uint8</span><span class="op" id="6147562">,</span>&nbsp;<span class="builtintype" id="6147564">error</span><span class="op" id="6147569">)</span>&nbsp;<span class="op" id="6147571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6147574">if</span>&nbsp;<span class="ident" id="6147577">h</span><span class="op" id="6147578">.</span><span class="ident" id="6147579">nCodes</span>&nbsp;<span class="op" id="6147586">==</span>&nbsp;<span class="num" id="6147589">0</span>&nbsp;<span class="op" id="6147591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6147595">return</span>&nbsp;<span class="num" id="6147602">0</span><span class="op" id="6147603">,</span>&nbsp;<span class="ident" id="6147605">FormatError</span><span class="op" id="6147616">(</span><span class="string" id="6147617">&#34;uninitialized&nbsp;Huffman&nbsp;table&#34;</span><span class="op" id="6147646">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6147649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6147653">if</span>&nbsp;<span class="ident" id="6147656">d</span><span class="op" id="6147657">.</span><span class="ident" id="6147658">bits</span><span class="op" id="6147662">.</span><span class="ident" id="6147663">n</span>&nbsp;<span class="op" id="6147665">&lt;</span>&nbsp;<span class="num" id="6147667">8</span>&nbsp;<span class="op" id="6147669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6147673">if</span>&nbsp;<span class="ident" id="6147676">err</span>&nbsp;<span class="op" id="6147680">:=</span>&nbsp;<span class="ident" id="6147683">d</span><span class="op" id="6147684">.</span><span class="ident" id="6147685">ensureNBits</span><span class="op" id="6147696">(</span><span class="num" id="6147697">8</span><span class="op" id="6147698">)</span><span class="op" id="6147699">;</span>&nbsp;<span class="ident" id="6147701">err</span>&nbsp;<span class="op" id="6147705">!=</span>&nbsp;<span class="ident" id="6147708">nil</span>&nbsp;<span class="op" id="6147712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6147717">if</span>&nbsp;<span class="ident" id="6147720">err</span>&nbsp;<span class="op" id="6147724">!=</span>&nbsp;<span class="ident" id="6147727">errMissingFF00</span>&nbsp;<span class="op" id="6147742">&amp;&amp;</span>&nbsp;<span class="ident" id="6147745">err</span>&nbsp;<span class="op" id="6147749">!=</span>&nbsp;<span class="ident" id="6147752">errShortHuffmanData</span>&nbsp;<span class="op" id="6147772">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6147778">return</span>&nbsp;<span class="num" id="6147785">0</span><span class="op" id="6147786">,</span>&nbsp;<span class="ident" id="6147788">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6147795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6147800">//&nbsp;There&nbsp;are&nbsp;no&nbsp;more&nbsp;bytes&nbsp;of&nbsp;data&nbsp;in&nbsp;this&nbsp;segment,&nbsp;but&nbsp;we&nbsp;may&nbsp;still</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6147872">//&nbsp;be&nbsp;able&nbsp;to&nbsp;read&nbsp;the&nbsp;next&nbsp;symbol&nbsp;out&nbsp;of&nbsp;the&nbsp;previously&nbsp;read&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6147943">//&nbsp;First,&nbsp;undo&nbsp;the&nbsp;readByte&nbsp;that&nbsp;the&nbsp;ensureNBits&nbsp;call&nbsp;made.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6148006">d</span><span class="op" id="6148007">.</span><span class="ident" id="6148008">unreadByteStuffedByte</span><span class="op" id="6148029">(</span><span class="op" id="6148030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148035">goto</span>&nbsp;<span class="ident" id="6148040">slowPath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6148051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6148054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148057">if</span>&nbsp;<span class="ident" id="6148060">v</span>&nbsp;<span class="op" id="6148062">:=</span>&nbsp;<span class="ident" id="6148065">h</span><span class="op" id="6148066">.</span><span class="ident" id="6148067">lut</span><span class="op" id="6148070">[</span><span class="op" id="6148071">(</span><span class="ident" id="6148072">d</span><span class="op" id="6148073">.</span><span class="ident" id="6148074">bits</span><span class="op" id="6148078">.</span><span class="ident" id="6148079">a</span><span class="op" id="6148080">&gt;&gt;</span><span class="builtintype" id="6148082">uint32</span><span class="op" id="6148088">(</span><span class="ident" id="6148089">d</span><span class="op" id="6148090">.</span><span class="ident" id="6148091">bits</span><span class="op" id="6148095">.</span><span class="ident" id="6148096">n</span><span class="op" id="6148097">-</span><span class="ident" id="6148098">lutSize</span><span class="op" id="6148105">)</span><span class="op" id="6148106">)</span><span class="op" id="6148107">&amp;</span><span class="num" id="6148108">0xff</span><span class="op" id="6148112">]</span><span class="op" id="6148113">;</span>&nbsp;<span class="ident" id="6148115">v</span>&nbsp;<span class="op" id="6148117">!=</span>&nbsp;<span class="num" id="6148120">0</span>&nbsp;<span class="op" id="6148122">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6148126">n</span>&nbsp;<span class="op" id="6148128">:=</span>&nbsp;<span class="op" id="6148131">(</span><span class="ident" id="6148132">v</span>&nbsp;<span class="op" id="6148134">&amp;</span>&nbsp;<span class="num" id="6148136">0xff</span><span class="op" id="6148140">)</span>&nbsp;<span class="op" id="6148142">-</span>&nbsp;<span class="num" id="6148144">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6148148">d</span><span class="op" id="6148149">.</span><span class="ident" id="6148150">bits</span><span class="op" id="6148154">.</span><span class="ident" id="6148155">n</span>&nbsp;<span class="op" id="6148157">-=</span>&nbsp;<span class="builtintype" id="6148160">int32</span><span class="op" id="6148165">(</span><span class="ident" id="6148166">n</span><span class="op" id="6148167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6148171">d</span><span class="op" id="6148172">.</span><span class="ident" id="6148173">bits</span><span class="op" id="6148177">.</span><span class="ident" id="6148178">m</span>&nbsp;<span class="op" id="6148180">&gt;&gt;=</span>&nbsp;<span class="ident" id="6148184">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148188">return</span>&nbsp;<span class="builtintype" id="6148195">uint8</span><span class="op" id="6148200">(</span><span class="ident" id="6148201">v</span>&nbsp;<span class="op" id="6148203">&gt;&gt;</span>&nbsp;<span class="num" id="6148206">8</span><span class="op" id="6148207">)</span><span class="op" id="6148208">,</span>&nbsp;<span class="ident" id="6148210">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6148215">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="ident" id="6148218">slowPath</span><span class="op" id="6148226">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148229">for</span>&nbsp;<span class="ident" id="6148233">i</span><span class="op" id="6148234">,</span>&nbsp;<span class="ident" id="6148236">code</span>&nbsp;<span class="op" id="6148241">:=</span>&nbsp;<span class="num" id="6148244">0</span><span class="op" id="6148245">,</span>&nbsp;<span class="builtintype" id="6148247">int32</span><span class="op" id="6148252">(</span><span class="num" id="6148253">0</span><span class="op" id="6148254">)</span><span class="op" id="6148255">;</span>&nbsp;<span class="ident" id="6148257">i</span>&nbsp;<span class="op" id="6148259">&lt;</span>&nbsp;<span class="ident" id="6148261">maxCodeLength</span><span class="op" id="6148274">;</span>&nbsp;<span class="ident" id="6148276">i</span><span class="op" id="6148277">++</span>&nbsp;<span class="op" id="6148280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148284">if</span>&nbsp;<span class="ident" id="6148287">d</span><span class="op" id="6148288">.</span><span class="ident" id="6148289">bits</span><span class="op" id="6148293">.</span><span class="ident" id="6148294">n</span>&nbsp;<span class="op" id="6148296">==</span>&nbsp;<span class="num" id="6148299">0</span>&nbsp;<span class="op" id="6148301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148306">if</span>&nbsp;<span class="ident" id="6148309">err</span>&nbsp;<span class="op" id="6148313">:=</span>&nbsp;<span class="ident" id="6148316">d</span><span class="op" id="6148317">.</span><span class="ident" id="6148318">ensureNBits</span><span class="op" id="6148329">(</span><span class="num" id="6148330">1</span><span class="op" id="6148331">)</span><span class="op" id="6148332">;</span>&nbsp;<span class="ident" id="6148334">err</span>&nbsp;<span class="op" id="6148338">!=</span>&nbsp;<span class="ident" id="6148341">nil</span>&nbsp;<span class="op" id="6148345">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148351">return</span>&nbsp;<span class="num" id="6148358">0</span><span class="op" id="6148359">,</span>&nbsp;<span class="ident" id="6148361">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6148368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6148372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148376">if</span>&nbsp;<span class="ident" id="6148379">d</span><span class="op" id="6148380">.</span><span class="ident" id="6148381">bits</span><span class="op" id="6148385">.</span><span class="ident" id="6148386">a</span><span class="op" id="6148387">&amp;</span><span class="ident" id="6148388">d</span><span class="op" id="6148389">.</span><span class="ident" id="6148390">bits</span><span class="op" id="6148394">.</span><span class="ident" id="6148395">m</span>&nbsp;<span class="op" id="6148397">!=</span>&nbsp;<span class="num" id="6148400">0</span>&nbsp;<span class="op" id="6148402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6148407">code</span>&nbsp;<span class="op" id="6148412">|=</span>&nbsp;<span class="num" id="6148415">1</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6148419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6148423">d</span><span class="op" id="6148424">.</span><span class="ident" id="6148425">bits</span><span class="op" id="6148429">.</span><span class="ident" id="6148430">n</span><span class="op" id="6148431">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6148436">d</span><span class="op" id="6148437">.</span><span class="ident" id="6148438">bits</span><span class="op" id="6148442">.</span><span class="ident" id="6148443">m</span>&nbsp;<span class="op" id="6148445">&gt;&gt;=</span>&nbsp;<span class="num" id="6148449">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148453">if</span>&nbsp;<span class="ident" id="6148456">code</span>&nbsp;<span class="op" id="6148461">&lt;=</span>&nbsp;<span class="ident" id="6148464">h</span><span class="op" id="6148465">.</span><span class="ident" id="6148466">maxCodes</span><span class="op" id="6148474">[</span><span class="ident" id="6148475">i</span><span class="op" id="6148476">]</span>&nbsp;<span class="op" id="6148478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148483">return</span>&nbsp;<span class="ident" id="6148490">h</span><span class="op" id="6148491">.</span><span class="ident" id="6148492">vals</span><span class="op" id="6148496">[</span><span class="ident" id="6148497">h</span><span class="op" id="6148498">.</span><span class="ident" id="6148499">valsIndices</span><span class="op" id="6148510">[</span><span class="ident" id="6148511">i</span><span class="op" id="6148512">]</span><span class="op" id="6148513">+</span><span class="ident" id="6148514">code</span><span class="op" id="6148518">-</span><span class="ident" id="6148519">h</span><span class="op" id="6148520">.</span><span class="ident" id="6148521">minCodes</span><span class="op" id="6148529">[</span><span class="ident" id="6148530">i</span><span class="op" id="6148531">]</span><span class="op" id="6148532">]</span><span class="op" id="6148533">,</span>&nbsp;<span class="ident" id="6148535">nil</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6148541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6148545">code</span>&nbsp;<span class="op" id="6148550">&lt;&lt;=</span>&nbsp;<span class="num" id="6148554">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6148557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148560">return</span>&nbsp;<span class="num" id="6148567">0</span><span class="op" id="6148568">,</span>&nbsp;<span class="ident" id="6148570">FormatError</span><span class="op" id="6148581">(</span><span class="string" id="6148582">&#34;bad&nbsp;Huffman&nbsp;code&#34;</span><span class="op" id="6148600">)</span><br>
<span class="lineno"></span><span class="op" id="6148602">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="6148605">func</span>&nbsp;<span class="op" id="6148610">(</span><span class="ident" id="6148611">d</span>&nbsp;<span class="op" id="6148613">*</span><span class="ident" id="6148614">decoder</span><span class="op" id="6148621">)</span>&nbsp;<span class="ident" id="6148623">decodeBit</span><span class="op" id="6148632">(</span><span class="op" id="6148633">)</span>&nbsp;<span class="op" id="6148635">(</span><span class="builtintype" id="6148636">bool</span><span class="op" id="6148640">,</span>&nbsp;<span class="builtintype" id="6148642">error</span><span class="op" id="6148647">)</span>&nbsp;<span class="op" id="6148649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148652">if</span>&nbsp;<span class="ident" id="6148655">d</span><span class="op" id="6148656">.</span><span class="ident" id="6148657">bits</span><span class="op" id="6148661">.</span><span class="ident" id="6148662">n</span>&nbsp;<span class="op" id="6148664">==</span>&nbsp;<span class="num" id="6148667">0</span>&nbsp;<span class="op" id="6148669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148673">if</span>&nbsp;<span class="ident" id="6148676">err</span>&nbsp;<span class="op" id="6148680">:=</span>&nbsp;<span class="ident" id="6148683">d</span><span class="op" id="6148684">.</span><span class="ident" id="6148685">ensureNBits</span><span class="op" id="6148696">(</span><span class="num" id="6148697">1</span><span class="op" id="6148698">)</span><span class="op" id="6148699">;</span>&nbsp;<span class="ident" id="6148701">err</span>&nbsp;<span class="op" id="6148705">!=</span>&nbsp;<span class="ident" id="6148708">nil</span>&nbsp;<span class="op" id="6148712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148717">return</span>&nbsp;<span class="builtintype" id="6148724">false</span><span class="op" id="6148729">,</span>&nbsp;<span class="ident" id="6148731">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6148737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6148740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6148743">ret</span>&nbsp;<span class="op" id="6148747">:=</span>&nbsp;<span class="ident" id="6148750">d</span><span class="op" id="6148751">.</span><span class="ident" id="6148752">bits</span><span class="op" id="6148756">.</span><span class="ident" id="6148757">a</span><span class="op" id="6148758">&amp;</span><span class="ident" id="6148759">d</span><span class="op" id="6148760">.</span><span class="ident" id="6148761">bits</span><span class="op" id="6148765">.</span><span class="ident" id="6148766">m</span>&nbsp;<span class="op" id="6148768">!=</span>&nbsp;<span class="num" id="6148771">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6148774">d</span><span class="op" id="6148775">.</span><span class="ident" id="6148776">bits</span><span class="op" id="6148780">.</span><span class="ident" id="6148781">n</span><span class="op" id="6148782">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6148786">d</span><span class="op" id="6148787">.</span><span class="ident" id="6148788">bits</span><span class="op" id="6148792">.</span><span class="ident" id="6148793">m</span>&nbsp;<span class="op" id="6148795">&gt;&gt;=</span>&nbsp;<span class="num" id="6148799">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148802">return</span>&nbsp;<span class="ident" id="6148809">ret</span><span class="op" id="6148812">,</span>&nbsp;<span class="ident" id="6148814">nil</span><br>
<span class="lineno"></span><span class="op" id="6148818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6148821">func</span>&nbsp;<span class="op" id="6148826">(</span><span class="ident" id="6148827">d</span>&nbsp;<span class="op" id="6148829">*</span><span class="ident" id="6148830">decoder</span><span class="op" id="6148837">)</span>&nbsp;<span class="ident" id="6148839">decodeBits</span><span class="op" id="6148849">(</span><span class="ident" id="6148850">n</span>&nbsp;<span class="builtintype" id="6148852">int32</span><span class="op" id="6148857">)</span>&nbsp;<span class="op" id="6148859">(</span><span class="builtintype" id="6148860">uint32</span><span class="op" id="6148866">,</span>&nbsp;<span class="builtintype" id="6148868">error</span><span class="op" id="6148873">)</span>&nbsp;<span class="op" id="6148875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148878">if</span>&nbsp;<span class="ident" id="6148881">d</span><span class="op" id="6148882">.</span><span class="ident" id="6148883">bits</span><span class="op" id="6148887">.</span><span class="ident" id="6148888">n</span>&nbsp;<span class="op" id="6148890">&lt;</span>&nbsp;<span class="ident" id="6148892">n</span>&nbsp;<span class="op" id="6148894">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148898">if</span>&nbsp;<span class="ident" id="6148901">err</span>&nbsp;<span class="op" id="6148905">:=</span>&nbsp;<span class="ident" id="6148908">d</span><span class="op" id="6148909">.</span><span class="ident" id="6148910">ensureNBits</span><span class="op" id="6148921">(</span><span class="ident" id="6148922">n</span><span class="op" id="6148923">)</span><span class="op" id="6148924">;</span>&nbsp;<span class="ident" id="6148926">err</span>&nbsp;<span class="op" id="6148930">!=</span>&nbsp;<span class="ident" id="6148933">nil</span>&nbsp;<span class="op" id="6148937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6148942">return</span>&nbsp;<span class="num" id="6148949">0</span><span class="op" id="6148950">,</span>&nbsp;<span class="ident" id="6148952">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6148958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6148961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6148964">ret</span>&nbsp;<span class="op" id="6148968">:=</span>&nbsp;<span class="ident" id="6148971">d</span><span class="op" id="6148972">.</span><span class="ident" id="6148973">bits</span><span class="op" id="6148977">.</span><span class="ident" id="6148978">a</span>&nbsp;<span class="op" id="6148980">&gt;&gt;</span>&nbsp;<span class="builtintype" id="6148983">uint32</span><span class="op" id="6148989">(</span><span class="ident" id="6148990">d</span><span class="op" id="6148991">.</span><span class="ident" id="6148992">bits</span><span class="op" id="6148996">.</span><span class="ident" id="6148997">n</span><span class="op" id="6148998">-</span><span class="ident" id="6148999">n</span><span class="op" id="6149000">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6149003">ret</span>&nbsp;<span class="op" id="6149007">&amp;=</span>&nbsp;<span class="op" id="6149010">(</span><span class="num" id="6149011">1</span>&nbsp;<span class="op" id="6149013">&lt;&lt;</span>&nbsp;<span class="builtintype" id="6149016">uint32</span><span class="op" id="6149022">(</span><span class="ident" id="6149023">n</span><span class="op" id="6149024">)</span><span class="op" id="6149025">)</span>&nbsp;<span class="op" id="6149027">-</span>&nbsp;<span class="num" id="6149029">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6149032">d</span><span class="op" id="6149033">.</span><span class="ident" id="6149034">bits</span><span class="op" id="6149038">.</span><span class="ident" id="6149039">n</span>&nbsp;<span class="op" id="6149041">-=</span>&nbsp;<span class="ident" id="6149044">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6149047">d</span><span class="op" id="6149048">.</span><span class="ident" id="6149049">bits</span><span class="op" id="6149053">.</span><span class="ident" id="6149054">m</span>&nbsp;<span class="op" id="6149056">&gt;&gt;=</span>&nbsp;<span class="builtintype" id="6149060">uint32</span><span class="op" id="6149066">(</span><span class="ident" id="6149067">n</span><span class="op" id="6149068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6149071">return</span>&nbsp;<span class="ident" id="6149078">ret</span><span class="op" id="6149081">,</span>&nbsp;<span class="ident" id="6149083">nil</span><br>
<span class="lineno"></span><span class="op" id="6149087">}</span>
</div>
</body>
</html>
