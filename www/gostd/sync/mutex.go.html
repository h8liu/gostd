<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1776055">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1776110">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1776164">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1776215">//&nbsp;Package&nbsp;sync&nbsp;provides&nbsp;basic&nbsp;synchronization&nbsp;primitives&nbsp;such&nbsp;as&nbsp;mutual</span><br>
<span class="lineno"></span><span class="comment" id="1776288">//&nbsp;exclusion&nbsp;locks.&nbsp;&nbsp;Other&nbsp;than&nbsp;the&nbsp;Once&nbsp;and&nbsp;WaitGroup&nbsp;types,&nbsp;most&nbsp;are&nbsp;intended</span><br>
<span class="lineno"></span><span class="comment" id="1776368">//&nbsp;for&nbsp;use&nbsp;by&nbsp;low-level&nbsp;library&nbsp;routines.&nbsp;&nbsp;Higher-level&nbsp;synchronization&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1776443">//&nbsp;better&nbsp;done&nbsp;via&nbsp;channels&nbsp;and&nbsp;communication.</span><br>
<span class="lineno"></span><span class="comment" id="1776490">//</span><br>
<span class="lineno">10</span><span class="comment" id="1776493">//&nbsp;Values&nbsp;containing&nbsp;the&nbsp;types&nbsp;defined&nbsp;in&nbsp;this&nbsp;package&nbsp;should&nbsp;not&nbsp;be&nbsp;copied.</span><br>
<span class="lineno"></span><span class="keyword" id="1776570">package</span>&nbsp;<span class="ident" id="1776578">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1776584">import</span>&nbsp;<span class="op" id="1776591">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1776594">&#34;sync/atomic&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1776609">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1776618">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1776621">//&nbsp;A&nbsp;Mutex&nbsp;is&nbsp;a&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1776660">//&nbsp;Mutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;structures;</span><br>
<span class="lineno">20</span><span class="comment" id="1776715">//&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;Mutex&nbsp;is&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1776767">type</span>&nbsp;<span class="ident" id="1776772">Mutex</span>&nbsp;<span class="keyword" id="1776778">struct</span>&nbsp;<span class="op" id="1776785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776788">state</span>&nbsp;<span class="builtintype" id="1776794">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776801">sema</span>&nbsp;&nbsp;<span class="builtintype" id="1776807">uint32</span><br>
<span class="lineno"></span><span class="op" id="1776814">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="1776817">//&nbsp;A&nbsp;Locker&nbsp;represents&nbsp;an&nbsp;object&nbsp;that&nbsp;can&nbsp;be&nbsp;locked&nbsp;and&nbsp;unlocked.</span><br>
<span class="lineno"></span><span class="keyword" id="1776883">type</span>&nbsp;<span class="ident" id="1776888">Locker</span>&nbsp;<span class="keyword" id="1776895">interface</span>&nbsp;<span class="op" id="1776905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776908">Lock</span><span class="op" id="1776912">(</span><span class="op" id="1776913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776916">Unlock</span><span class="op" id="1776922">(</span><span class="op" id="1776923">)</span><br>
<span class="lineno">30</span><span class="op" id="1776925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1776928">const</span>&nbsp;<span class="op" id="1776934">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776937">mutexLocked</span>&nbsp;<span class="op" id="1776949">=</span>&nbsp;<span class="num" id="1776951">1</span>&nbsp;<span class="op" id="1776953">&lt;&lt;</span>&nbsp;<span class="ident" id="1776956">iota</span>&nbsp;<span class="comment" id="1776961">//&nbsp;mutex&nbsp;is&nbsp;locked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776981">mutexWoken</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776993">mutexWaiterShift</span>&nbsp;<span class="op" id="1777010">=</span>&nbsp;<span class="ident" id="1777012">iota</span><br>
<span class="lineno"></span><span class="op" id="1777017">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1777020">//&nbsp;Lock&nbsp;locks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1777037">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;in&nbsp;use,&nbsp;the&nbsp;calling&nbsp;goroutine</span><br>
<span class="lineno">40</span><span class="comment" id="1777093">//&nbsp;blocks&nbsp;until&nbsp;the&nbsp;mutex&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1777133">func</span>&nbsp;<span class="op" id="1777138">(</span><span class="ident" id="1777139">m</span>&nbsp;<span class="op" id="1777141">*</span><span class="ident" id="1777142">Mutex</span><span class="op" id="1777147">)</span>&nbsp;<span class="ident" id="1777149">Lock</span><span class="op" id="1777153">(</span><span class="op" id="1777154">)</span>&nbsp;<span class="op" id="1777156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1777159">//&nbsp;Fast&nbsp;path:&nbsp;grab&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777195">if</span>&nbsp;<span class="ident" id="1777198">atomic</span><span class="op" id="1777204">.</span><span class="ident" id="1777205">CompareAndSwapInt32</span><span class="op" id="1777224">(</span><span class="op" id="1777225">&amp;</span><span class="ident" id="1777226">m</span><span class="op" id="1777227">.</span><span class="ident" id="1777228">state</span><span class="op" id="1777233">,</span>&nbsp;<span class="num" id="1777235">0</span><span class="op" id="1777236">,</span>&nbsp;<span class="ident" id="1777238">mutexLocked</span><span class="op" id="1777249">)</span>&nbsp;<span class="op" id="1777251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777255">if</span>&nbsp;<span class="ident" id="1777258">raceenabled</span>&nbsp;<span class="op" id="1777270">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1777275">raceAcquire</span><span class="op" id="1777286">(</span><span class="ident" id="1777287">unsafe</span><span class="op" id="1777293">.</span><span class="ident" id="1777294">Pointer</span><span class="op" id="1777301">(</span><span class="ident" id="1777302">m</span><span class="op" id="1777303">)</span><span class="op" id="1777304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1777308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777312">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1777320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1777324">awoke</span>&nbsp;<span class="op" id="1777330">:=</span>&nbsp;<span class="builtintype" id="1777333">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777340">for</span>&nbsp;<span class="op" id="1777344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1777348">old</span>&nbsp;<span class="op" id="1777352">:=</span>&nbsp;<span class="ident" id="1777355">m</span><span class="op" id="1777356">.</span><span class="ident" id="1777357">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1777365">new</span>&nbsp;<span class="op" id="1777369">:=</span>&nbsp;<span class="ident" id="1777372">old</span>&nbsp;<span class="op" id="1777376">|</span>&nbsp;<span class="ident" id="1777378">mutexLocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777392">if</span>&nbsp;<span class="ident" id="1777395">old</span><span class="op" id="1777398">&amp;</span><span class="ident" id="1777399">mutexLocked</span>&nbsp;<span class="op" id="1777411">!=</span>&nbsp;<span class="num" id="1777414">0</span>&nbsp;<span class="op" id="1777416">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1777421">new</span>&nbsp;<span class="op" id="1777425">=</span>&nbsp;<span class="ident" id="1777427">old</span>&nbsp;<span class="op" id="1777431">+</span>&nbsp;<span class="num" id="1777433">1</span><span class="op" id="1777434">&lt;&lt;</span><span class="ident" id="1777436">mutexWaiterShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1777455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777459">if</span>&nbsp;<span class="ident" id="1777462">awoke</span>&nbsp;<span class="op" id="1777468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1777473">//&nbsp;The&nbsp;goroutine&nbsp;has&nbsp;been&nbsp;woken&nbsp;from&nbsp;sleep,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1777520">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;reset&nbsp;the&nbsp;flag&nbsp;in&nbsp;either&nbsp;case.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1777571">new</span>&nbsp;<span class="op" id="1777575">&amp;^=</span>&nbsp;<span class="ident" id="1777579">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1777592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777596">if</span>&nbsp;<span class="ident" id="1777599">atomic</span><span class="op" id="1777605">.</span><span class="ident" id="1777606">CompareAndSwapInt32</span><span class="op" id="1777625">(</span><span class="op" id="1777626">&amp;</span><span class="ident" id="1777627">m</span><span class="op" id="1777628">.</span><span class="ident" id="1777629">state</span><span class="op" id="1777634">,</span>&nbsp;<span class="ident" id="1777636">old</span><span class="op" id="1777639">,</span>&nbsp;<span class="builtinfunc" id="1777641">new</span><span class="op" id="1777644">)</span>&nbsp;<span class="op" id="1777646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777651">if</span>&nbsp;<span class="ident" id="1777654">old</span><span class="op" id="1777657">&amp;</span><span class="ident" id="1777658">mutexLocked</span>&nbsp;<span class="op" id="1777670">==</span>&nbsp;<span class="num" id="1777673">0</span>&nbsp;<span class="op" id="1777675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777681">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1777690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1777695">runtime_Semacquire</span><span class="op" id="1777713">(</span><span class="op" id="1777714">&amp;</span><span class="ident" id="1777715">m</span><span class="op" id="1777716">.</span><span class="ident" id="1777717">sema</span><span class="op" id="1777721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1777726">awoke</span>&nbsp;<span class="op" id="1777732">=</span>&nbsp;<span class="builtintype" id="1777734">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1777741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1777744">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777748">if</span>&nbsp;<span class="ident" id="1777751">raceenabled</span>&nbsp;<span class="op" id="1777763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1777767">raceAcquire</span><span class="op" id="1777778">(</span><span class="ident" id="1777779">unsafe</span><span class="op" id="1777785">.</span><span class="ident" id="1777786">Pointer</span><span class="op" id="1777793">(</span><span class="ident" id="1777794">m</span><span class="op" id="1777795">)</span><span class="op" id="1777796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1777799">}</span><br>
<span class="lineno"></span><span class="op" id="1777801">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="1777804">//&nbsp;Unlock&nbsp;unlocks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1777825">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;m&nbsp;is&nbsp;not&nbsp;locked&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1777890">//</span><br>
<span class="lineno"></span><span class="comment" id="1777893">//&nbsp;A&nbsp;locked&nbsp;Mutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular&nbsp;goroutine.</span><br>
<span class="lineno">80</span><span class="comment" id="1777958">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;for&nbsp;one&nbsp;goroutine&nbsp;to&nbsp;lock&nbsp;a&nbsp;Mutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1778018">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;unlock&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1778065">func</span>&nbsp;<span class="op" id="1778070">(</span><span class="ident" id="1778071">m</span>&nbsp;<span class="op" id="1778073">*</span><span class="ident" id="1778074">Mutex</span><span class="op" id="1778079">)</span>&nbsp;<span class="ident" id="1778081">Unlock</span><span class="op" id="1778087">(</span><span class="op" id="1778088">)</span>&nbsp;<span class="op" id="1778090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1778093">if</span>&nbsp;<span class="ident" id="1778096">raceenabled</span>&nbsp;<span class="op" id="1778108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778112">_</span>&nbsp;<span class="op" id="1778114">=</span>&nbsp;<span class="ident" id="1778116">m</span><span class="op" id="1778117">.</span><span class="ident" id="1778118">state</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778126">raceRelease</span><span class="op" id="1778137">(</span><span class="ident" id="1778138">unsafe</span><span class="op" id="1778144">.</span><span class="ident" id="1778145">Pointer</span><span class="op" id="1778152">(</span><span class="ident" id="1778153">m</span><span class="op" id="1778154">)</span><span class="op" id="1778155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1778158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1778162">//&nbsp;Fast&nbsp;path:&nbsp;drop&nbsp;lock&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1778192">new</span>&nbsp;<span class="op" id="1778196">:=</span>&nbsp;<span class="ident" id="1778199">atomic</span><span class="op" id="1778205">.</span><span class="ident" id="1778206">AddInt32</span><span class="op" id="1778214">(</span><span class="op" id="1778215">&amp;</span><span class="ident" id="1778216">m</span><span class="op" id="1778217">.</span><span class="ident" id="1778218">state</span><span class="op" id="1778223">,</span>&nbsp;<span class="op" id="1778225">-</span><span class="ident" id="1778226">mutexLocked</span><span class="op" id="1778237">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1778240">if</span>&nbsp;<span class="op" id="1778243">(</span><span class="builtinfunc" id="1778244">new</span><span class="op" id="1778247">+</span><span class="ident" id="1778248">mutexLocked</span><span class="op" id="1778259">)</span><span class="op" id="1778260">&amp;</span><span class="ident" id="1778261">mutexLocked</span>&nbsp;<span class="op" id="1778273">==</span>&nbsp;<span class="num" id="1778276">0</span>&nbsp;<span class="op" id="1778278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1778282">panic</span><span class="op" id="1778287">(</span><span class="string" id="1778288">&#34;sync:&nbsp;unlock&nbsp;of&nbsp;unlocked&nbsp;mutex&#34;</span><span class="op" id="1778320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1778323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778327">old</span>&nbsp;<span class="op" id="1778331">:=</span>&nbsp;<span class="builtinfunc" id="1778334">new</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1778339">for</span>&nbsp;<span class="op" id="1778343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1778347">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;waiters&nbsp;or&nbsp;a&nbsp;goroutine&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1778403">//&nbsp;been&nbsp;woken&nbsp;or&nbsp;grabbed&nbsp;the&nbsp;lock,&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;anyone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1778464">if</span>&nbsp;<span class="ident" id="1778467">old</span><span class="op" id="1778470">&gt;&gt;</span><span class="ident" id="1778472">mutexWaiterShift</span>&nbsp;<span class="op" id="1778489">==</span>&nbsp;<span class="num" id="1778492">0</span>&nbsp;<span class="op" id="1778494">||</span>&nbsp;<span class="ident" id="1778497">old</span><span class="op" id="1778500">&amp;</span><span class="op" id="1778501">(</span><span class="ident" id="1778502">mutexLocked</span><span class="op" id="1778513">|</span><span class="ident" id="1778514">mutexWoken</span><span class="op" id="1778524">)</span>&nbsp;<span class="op" id="1778526">!=</span>&nbsp;<span class="num" id="1778529">0</span>&nbsp;<span class="op" id="1778531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1778536">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1778545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1778549">//&nbsp;Grab&nbsp;the&nbsp;right&nbsp;to&nbsp;wake&nbsp;someone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1778586">new</span>&nbsp;<span class="op" id="1778590">=</span>&nbsp;<span class="op" id="1778592">(</span><span class="ident" id="1778593">old</span>&nbsp;<span class="op" id="1778597">-</span>&nbsp;<span class="num" id="1778599">1</span><span class="op" id="1778600">&lt;&lt;</span><span class="ident" id="1778602">mutexWaiterShift</span><span class="op" id="1778618">)</span>&nbsp;<span class="op" id="1778620">|</span>&nbsp;<span class="ident" id="1778622">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1778635">if</span>&nbsp;<span class="ident" id="1778638">atomic</span><span class="op" id="1778644">.</span><span class="ident" id="1778645">CompareAndSwapInt32</span><span class="op" id="1778664">(</span><span class="op" id="1778665">&amp;</span><span class="ident" id="1778666">m</span><span class="op" id="1778667">.</span><span class="ident" id="1778668">state</span><span class="op" id="1778673">,</span>&nbsp;<span class="ident" id="1778675">old</span><span class="op" id="1778678">,</span>&nbsp;<span class="builtinfunc" id="1778680">new</span><span class="op" id="1778683">)</span>&nbsp;<span class="op" id="1778685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778690">runtime_Semrelease</span><span class="op" id="1778708">(</span><span class="op" id="1778709">&amp;</span><span class="ident" id="1778710">m</span><span class="op" id="1778711">.</span><span class="ident" id="1778712">sema</span><span class="op" id="1778716">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1778721">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1778730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778734">old</span>&nbsp;<span class="op" id="1778738">=</span>&nbsp;<span class="ident" id="1778740">m</span><span class="op" id="1778741">.</span><span class="ident" id="1778742">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1778749">}</span><br>
<span class="lineno"></span><span class="op" id="1778751">}</span>
</div>
</body>
</html>
