<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/smtp</h2>
<ul>
<li><a href="/gostd/net/smtp/auth.go.html">auth.go</a></li>
<li><a href="/gostd/net/smtp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/smtp/smtp.go.html">smtp.go</a></li>
<li><a href="/gostd/net/smtp/smtp_test.go.html" class="current">smtp_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6763130">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6763185">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6763239">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6763290">package</span>&nbsp;<span class="ident" id="6763298">smtp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6763304">import</span>&nbsp;<span class="op" id="6763311">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6763314">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6763323">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6763332">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6763346">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6763361">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6763367">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6763374">&#34;net/textproto&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6763391">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6763402">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6763413">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6763420">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="6763423">type</span>&nbsp;<span class="ident" id="6763428">authTest</span>&nbsp;<span class="keyword" id="6763437">struct</span>&nbsp;<span class="op" id="6763444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6763447">auth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6763458">Auth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6763464">challenges</span>&nbsp;<span class="op" id="6763475">[</span><span class="op" id="6763476">]</span><span class="builtintype" id="6763477">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6763485">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6763496">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6763504">responses</span>&nbsp;&nbsp;<span class="op" id="6763515">[</span><span class="op" id="6763516">]</span><span class="builtintype" id="6763517">string</span><br>
<span class="lineno">25</span><span class="op" id="6763524">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6763527">var</span>&nbsp;<span class="ident" id="6763531">authTests</span>&nbsp;<span class="op" id="6763541">=</span>&nbsp;<span class="op" id="6763543">[</span><span class="op" id="6763544">]</span><span class="ident" id="6763545">authTest</span><span class="op" id="6763553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6763556">{</span><span class="ident" id="6763557">PlainAuth</span><span class="op" id="6763566">(</span><span class="string" id="6763567">&#34;&#34;</span><span class="op" id="6763569">,</span>&nbsp;<span class="string" id="6763571">&#34;user&#34;</span><span class="op" id="6763577">,</span>&nbsp;<span class="string" id="6763579">&#34;pass&#34;</span><span class="op" id="6763585">,</span>&nbsp;<span class="string" id="6763587">&#34;testserver&#34;</span><span class="op" id="6763599">)</span><span class="op" id="6763600">,</span>&nbsp;<span class="op" id="6763602">[</span><span class="op" id="6763603">]</span><span class="builtintype" id="6763604">string</span><span class="op" id="6763610">{</span><span class="op" id="6763611">}</span><span class="op" id="6763612">,</span>&nbsp;<span class="string" id="6763614">&#34;PLAIN&#34;</span><span class="op" id="6763621">,</span>&nbsp;<span class="op" id="6763623">[</span><span class="op" id="6763624">]</span><span class="builtintype" id="6763625">string</span><span class="op" id="6763631">{</span><span class="string" id="6763632">&#34;\x00user\x00pass&#34;</span><span class="op" id="6763650">}</span><span class="op" id="6763651">}</span><span class="op" id="6763652">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6763655">{</span><span class="ident" id="6763656">PlainAuth</span><span class="op" id="6763665">(</span><span class="string" id="6763666">&#34;foo&#34;</span><span class="op" id="6763671">,</span>&nbsp;<span class="string" id="6763673">&#34;bar&#34;</span><span class="op" id="6763678">,</span>&nbsp;<span class="string" id="6763680">&#34;baz&#34;</span><span class="op" id="6763685">,</span>&nbsp;<span class="string" id="6763687">&#34;testserver&#34;</span><span class="op" id="6763699">)</span><span class="op" id="6763700">,</span>&nbsp;<span class="op" id="6763702">[</span><span class="op" id="6763703">]</span><span class="builtintype" id="6763704">string</span><span class="op" id="6763710">{</span><span class="op" id="6763711">}</span><span class="op" id="6763712">,</span>&nbsp;<span class="string" id="6763714">&#34;PLAIN&#34;</span><span class="op" id="6763721">,</span>&nbsp;<span class="op" id="6763723">[</span><span class="op" id="6763724">]</span><span class="builtintype" id="6763725">string</span><span class="op" id="6763731">{</span><span class="string" id="6763732">&#34;foo\x00bar\x00baz&#34;</span><span class="op" id="6763751">}</span><span class="op" id="6763752">}</span><span class="op" id="6763753">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6763756">{</span><span class="ident" id="6763757">CRAMMD5Auth</span><span class="op" id="6763768">(</span><span class="string" id="6763769">&#34;user&#34;</span><span class="op" id="6763775">,</span>&nbsp;<span class="string" id="6763777">&#34;pass&#34;</span><span class="op" id="6763783">)</span><span class="op" id="6763784">,</span>&nbsp;<span class="op" id="6763786">[</span><span class="op" id="6763787">]</span><span class="builtintype" id="6763788">string</span><span class="op" id="6763794">{</span><span class="string" id="6763795">&#34;&lt;123456.1322876914@testserver&gt;&#34;</span><span class="op" id="6763827">}</span><span class="op" id="6763828">,</span>&nbsp;<span class="string" id="6763830">&#34;CRAM-MD5&#34;</span><span class="op" id="6763840">,</span>&nbsp;<span class="op" id="6763842">[</span><span class="op" id="6763843">]</span><span class="builtintype" id="6763844">string</span><span class="op" id="6763850">{</span><span class="string" id="6763851">&#34;&#34;</span><span class="op" id="6763853">,</span>&nbsp;<span class="string" id="6763855">&#34;user&nbsp;287eb355114cf5c471c26a875f1ca4ae&#34;</span><span class="op" id="6763894">}</span><span class="op" id="6763895">}</span><span class="op" id="6763896">,</span><br>
<span class="lineno"></span><span class="op" id="6763898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6763901">func</span>&nbsp;<span class="ident" id="6763906">TestAuth</span><span class="op" id="6763914">(</span><span class="ident" id="6763915">t</span>&nbsp;<span class="op" id="6763917">*</span><span class="ident" id="6763918">testing</span><span class="op" id="6763925">.</span><span class="ident" id="6763926">T</span><span class="op" id="6763927">)</span>&nbsp;<span class="op" id="6763929">{</span><br>
<span class="lineno"></span><span class="ident" id="6763931">testLoop</span><span class="op" id="6763939">:</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763942">for</span>&nbsp;<span class="ident" id="6763946">i</span><span class="op" id="6763947">,</span>&nbsp;<span class="ident" id="6763949">test</span>&nbsp;<span class="op" id="6763954">:=</span>&nbsp;<span class="keyword" id="6763957">range</span>&nbsp;<span class="ident" id="6763963">authTests</span>&nbsp;<span class="op" id="6763973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6763977">name</span><span class="op" id="6763981">,</span>&nbsp;<span class="ident" id="6763983">resp</span><span class="op" id="6763987">,</span>&nbsp;<span class="ident" id="6763989">err</span>&nbsp;<span class="op" id="6763993">:=</span>&nbsp;<span class="ident" id="6763996">test</span><span class="op" id="6764000">.</span><span class="ident" id="6764001">auth</span><span class="op" id="6764005">.</span><span class="ident" id="6764006">Start</span><span class="op" id="6764011">(</span><span class="op" id="6764012">&amp;</span><span class="ident" id="6764013">ServerInfo</span><span class="op" id="6764023">{</span><span class="string" id="6764024">&#34;testserver&#34;</span><span class="op" id="6764036">,</span>&nbsp;<span class="builtintype" id="6764038">true</span><span class="op" id="6764042">,</span>&nbsp;<span class="builtintype" id="6764044">nil</span><span class="op" id="6764047">}</span><span class="op" id="6764048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6764052">if</span>&nbsp;<span class="ident" id="6764055">name</span>&nbsp;<span class="op" id="6764060">!=</span>&nbsp;<span class="ident" id="6764063">test</span><span class="op" id="6764067">.</span><span class="ident" id="6764068">name</span>&nbsp;<span class="op" id="6764073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764078">t</span><span class="op" id="6764079">.</span><span class="ident" id="6764080">Errorf</span><span class="op" id="6764086">(</span><span class="string" id="6764087">&#34;#%d&nbsp;got&nbsp;name&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="6764117">,</span>&nbsp;<span class="ident" id="6764119">i</span><span class="op" id="6764120">,</span>&nbsp;<span class="ident" id="6764122">name</span><span class="op" id="6764126">,</span>&nbsp;<span class="ident" id="6764128">test</span><span class="op" id="6764132">.</span><span class="ident" id="6764133">name</span><span class="op" id="6764137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6764141">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6764145">if</span>&nbsp;<span class="op" id="6764148">!</span><span class="ident" id="6764149">bytes</span><span class="op" id="6764154">.</span><span class="ident" id="6764155">Equal</span><span class="op" id="6764160">(</span><span class="ident" id="6764161">resp</span><span class="op" id="6764165">,</span>&nbsp;<span class="op" id="6764167">[</span><span class="op" id="6764168">]</span><span class="builtintype" id="6764169">byte</span><span class="op" id="6764173">(</span><span class="ident" id="6764174">test</span><span class="op" id="6764178">.</span><span class="ident" id="6764179">responses</span><span class="op" id="6764188">[</span><span class="num" id="6764189">0</span><span class="op" id="6764190">]</span><span class="op" id="6764191">)</span><span class="op" id="6764192">)</span>&nbsp;<span class="op" id="6764194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764199">t</span><span class="op" id="6764200">.</span><span class="ident" id="6764201">Errorf</span><span class="op" id="6764207">(</span><span class="string" id="6764208">&#34;#%d&nbsp;got&nbsp;response&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="6764242">,</span>&nbsp;<span class="ident" id="6764244">i</span><span class="op" id="6764245">,</span>&nbsp;<span class="ident" id="6764247">resp</span><span class="op" id="6764251">,</span>&nbsp;<span class="ident" id="6764253">test</span><span class="op" id="6764257">.</span><span class="ident" id="6764258">responses</span><span class="op" id="6764267">[</span><span class="num" id="6764268">0</span><span class="op" id="6764269">]</span><span class="op" id="6764270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6764274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6764278">if</span>&nbsp;<span class="ident" id="6764281">err</span>&nbsp;<span class="op" id="6764285">!=</span>&nbsp;<span class="builtintype" id="6764288">nil</span>&nbsp;<span class="op" id="6764292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764297">t</span><span class="op" id="6764298">.</span><span class="ident" id="6764299">Errorf</span><span class="op" id="6764305">(</span><span class="string" id="6764306">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="6764321">,</span>&nbsp;<span class="ident" id="6764323">i</span><span class="op" id="6764324">,</span>&nbsp;<span class="ident" id="6764326">err</span><span class="op" id="6764329">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6764333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6764337">for</span>&nbsp;<span class="ident" id="6764341">j</span>&nbsp;<span class="op" id="6764343">:=</span>&nbsp;<span class="keyword" id="6764346">range</span>&nbsp;<span class="ident" id="6764352">test</span><span class="op" id="6764356">.</span><span class="ident" id="6764357">challenges</span>&nbsp;<span class="op" id="6764368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764373">challenge</span>&nbsp;<span class="op" id="6764383">:=</span>&nbsp;<span class="op" id="6764386">[</span><span class="op" id="6764387">]</span><span class="builtintype" id="6764388">byte</span><span class="op" id="6764392">(</span><span class="ident" id="6764393">test</span><span class="op" id="6764397">.</span><span class="ident" id="6764398">challenges</span><span class="op" id="6764408">[</span><span class="ident" id="6764409">j</span><span class="op" id="6764410">]</span><span class="op" id="6764411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764416">expected</span>&nbsp;<span class="op" id="6764425">:=</span>&nbsp;<span class="op" id="6764428">[</span><span class="op" id="6764429">]</span><span class="builtintype" id="6764430">byte</span><span class="op" id="6764434">(</span><span class="ident" id="6764435">test</span><span class="op" id="6764439">.</span><span class="ident" id="6764440">responses</span><span class="op" id="6764449">[</span><span class="ident" id="6764450">j</span><span class="op" id="6764451">+</span><span class="num" id="6764452">1</span><span class="op" id="6764453">]</span><span class="op" id="6764454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764459">resp</span><span class="op" id="6764463">,</span>&nbsp;<span class="ident" id="6764465">err</span>&nbsp;<span class="op" id="6764469">:=</span>&nbsp;<span class="ident" id="6764472">test</span><span class="op" id="6764476">.</span><span class="ident" id="6764477">auth</span><span class="op" id="6764481">.</span><span class="ident" id="6764482">Next</span><span class="op" id="6764486">(</span><span class="ident" id="6764487">challenge</span><span class="op" id="6764496">,</span>&nbsp;<span class="builtintype" id="6764498">true</span><span class="op" id="6764502">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6764507">if</span>&nbsp;<span class="ident" id="6764510">err</span>&nbsp;<span class="op" id="6764514">!=</span>&nbsp;<span class="builtintype" id="6764517">nil</span>&nbsp;<span class="op" id="6764521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764527">t</span><span class="op" id="6764528">.</span><span class="ident" id="6764529">Errorf</span><span class="op" id="6764535">(</span><span class="string" id="6764536">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="6764551">,</span>&nbsp;<span class="ident" id="6764553">i</span><span class="op" id="6764554">,</span>&nbsp;<span class="ident" id="6764556">err</span><span class="op" id="6764559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6764565">continue</span>&nbsp;<span class="ident" id="6764574">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6764586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6764591">if</span>&nbsp;<span class="op" id="6764594">!</span><span class="ident" id="6764595">bytes</span><span class="op" id="6764600">.</span><span class="ident" id="6764601">Equal</span><span class="op" id="6764606">(</span><span class="ident" id="6764607">resp</span><span class="op" id="6764611">,</span>&nbsp;<span class="ident" id="6764613">expected</span><span class="op" id="6764621">)</span>&nbsp;<span class="op" id="6764623">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764629">t</span><span class="op" id="6764630">.</span><span class="ident" id="6764631">Errorf</span><span class="op" id="6764637">(</span><span class="string" id="6764638">&#34;#%d&nbsp;got&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="6764663">,</span>&nbsp;<span class="ident" id="6764665">i</span><span class="op" id="6764666">,</span>&nbsp;<span class="ident" id="6764668">resp</span><span class="op" id="6764672">,</span>&nbsp;<span class="ident" id="6764674">expected</span><span class="op" id="6764682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6764688">continue</span>&nbsp;<span class="ident" id="6764697">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6764709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6764713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6764716">}</span><br>
<span class="lineno">60</span><span class="op" id="6764718">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6764721">func</span>&nbsp;<span class="ident" id="6764726">TestAuthPlain</span><span class="op" id="6764739">(</span><span class="ident" id="6764740">t</span>&nbsp;<span class="op" id="6764742">*</span><span class="ident" id="6764743">testing</span><span class="op" id="6764750">.</span><span class="ident" id="6764751">T</span><span class="op" id="6764752">)</span>&nbsp;<span class="op" id="6764754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764757">auth</span>&nbsp;<span class="op" id="6764762">:=</span>&nbsp;<span class="ident" id="6764765">PlainAuth</span><span class="op" id="6764774">(</span><span class="string" id="6764775">&#34;foo&#34;</span><span class="op" id="6764780">,</span>&nbsp;<span class="string" id="6764782">&#34;bar&#34;</span><span class="op" id="6764787">,</span>&nbsp;<span class="string" id="6764789">&#34;baz&#34;</span><span class="op" id="6764794">,</span>&nbsp;<span class="string" id="6764796">&#34;servername&#34;</span><span class="op" id="6764808">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764812">tests</span>&nbsp;<span class="op" id="6764818">:=</span>&nbsp;<span class="op" id="6764821">[</span><span class="op" id="6764822">]</span><span class="keyword" id="6764823">struct</span>&nbsp;<span class="op" id="6764830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764834">server</span>&nbsp;<span class="op" id="6764841">*</span><span class="ident" id="6764842">ServerInfo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764855">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6764862">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6764870">}</span><span class="op" id="6764871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6764875">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764880">server</span><span class="op" id="6764886">:</span>&nbsp;<span class="op" id="6764888">&amp;</span><span class="ident" id="6764889">ServerInfo</span><span class="op" id="6764899">{</span><span class="ident" id="6764900">Name</span><span class="op" id="6764904">:</span>&nbsp;<span class="string" id="6764906">&#34;servername&#34;</span><span class="op" id="6764918">,</span>&nbsp;<span class="ident" id="6764920">TLS</span><span class="op" id="6764923">:</span>&nbsp;<span class="builtintype" id="6764925">true</span><span class="op" id="6764929">}</span><span class="op" id="6764930">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6764934">}</span><span class="op" id="6764935">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6764939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6764944">//&nbsp;Okay;&nbsp;explicitly&nbsp;advertised&nbsp;by&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764989">server</span><span class="op" id="6764995">:</span>&nbsp;<span class="op" id="6764997">&amp;</span><span class="ident" id="6764998">ServerInfo</span><span class="op" id="6765008">{</span><span class="ident" id="6765009">Name</span><span class="op" id="6765013">:</span>&nbsp;<span class="string" id="6765015">&#34;servername&#34;</span><span class="op" id="6765027">,</span>&nbsp;<span class="ident" id="6765029">Auth</span><span class="op" id="6765033">:</span>&nbsp;<span class="op" id="6765035">[</span><span class="op" id="6765036">]</span><span class="builtintype" id="6765037">string</span><span class="op" id="6765043">{</span><span class="string" id="6765044">&#34;PLAIN&#34;</span><span class="op" id="6765051">}</span><span class="op" id="6765052">}</span><span class="op" id="6765053">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765057">}</span><span class="op" id="6765058">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765067">server</span><span class="op" id="6765073">:</span>&nbsp;<span class="op" id="6765075">&amp;</span><span class="ident" id="6765076">ServerInfo</span><span class="op" id="6765086">{</span><span class="ident" id="6765087">Name</span><span class="op" id="6765091">:</span>&nbsp;<span class="string" id="6765093">&#34;servername&#34;</span><span class="op" id="6765105">,</span>&nbsp;<span class="ident" id="6765107">Auth</span><span class="op" id="6765111">:</span>&nbsp;<span class="op" id="6765113">[</span><span class="op" id="6765114">]</span><span class="builtintype" id="6765115">string</span><span class="op" id="6765121">{</span><span class="string" id="6765122">&#34;CRAM-MD5&#34;</span><span class="op" id="6765132">}</span><span class="op" id="6765133">}</span><span class="op" id="6765134">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765139">err</span><span class="op" id="6765142">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6765147">&#34;unencrypted&nbsp;connection&#34;</span><span class="op" id="6765171">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765175">}</span><span class="op" id="6765176">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765185">server</span><span class="op" id="6765191">:</span>&nbsp;<span class="op" id="6765193">&amp;</span><span class="ident" id="6765194">ServerInfo</span><span class="op" id="6765204">{</span><span class="ident" id="6765205">Name</span><span class="op" id="6765209">:</span>&nbsp;<span class="string" id="6765211">&#34;attacker&#34;</span><span class="op" id="6765221">,</span>&nbsp;<span class="ident" id="6765223">TLS</span><span class="op" id="6765226">:</span>&nbsp;<span class="builtintype" id="6765228">true</span><span class="op" id="6765232">}</span><span class="op" id="6765233">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765238">err</span><span class="op" id="6765241">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6765246">&#34;wrong&nbsp;host&nbsp;name&#34;</span><span class="op" id="6765263">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765267">}</span><span class="op" id="6765268">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765271">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765274">for</span>&nbsp;<span class="ident" id="6765278">i</span><span class="op" id="6765279">,</span>&nbsp;<span class="ident" id="6765281">tt</span>&nbsp;<span class="op" id="6765284">:=</span>&nbsp;<span class="keyword" id="6765287">range</span>&nbsp;<span class="ident" id="6765293">tests</span>&nbsp;<span class="op" id="6765299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765303">_</span><span class="op" id="6765304">,</span>&nbsp;<span class="ident" id="6765306">_</span><span class="op" id="6765307">,</span>&nbsp;<span class="ident" id="6765309">err</span>&nbsp;<span class="op" id="6765313">:=</span>&nbsp;<span class="ident" id="6765316">auth</span><span class="op" id="6765320">.</span><span class="ident" id="6765321">Start</span><span class="op" id="6765326">(</span><span class="ident" id="6765327">tt</span><span class="op" id="6765329">.</span><span class="ident" id="6765330">server</span><span class="op" id="6765336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765340">got</span>&nbsp;<span class="op" id="6765344">:=</span>&nbsp;<span class="string" id="6765347">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765352">if</span>&nbsp;<span class="ident" id="6765355">err</span>&nbsp;<span class="op" id="6765359">!=</span>&nbsp;<span class="builtintype" id="6765362">nil</span>&nbsp;<span class="op" id="6765366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765371">got</span>&nbsp;<span class="op" id="6765375">=</span>&nbsp;<span class="ident" id="6765377">err</span><span class="op" id="6765380">.</span><span class="ident" id="6765381">Error</span><span class="op" id="6765386">(</span><span class="op" id="6765387">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765395">if</span>&nbsp;<span class="ident" id="6765398">got</span>&nbsp;<span class="op" id="6765402">!=</span>&nbsp;<span class="ident" id="6765405">tt</span><span class="op" id="6765407">.</span><span class="ident" id="6765408">err</span>&nbsp;<span class="op" id="6765412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765417">t</span><span class="op" id="6765418">.</span><span class="ident" id="6765419">Errorf</span><span class="op" id="6765425">(</span><span class="string" id="6765426">&#34;%d.&nbsp;got&nbsp;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6765455">,</span>&nbsp;<span class="ident" id="6765457">i</span><span class="op" id="6765458">,</span>&nbsp;<span class="ident" id="6765460">got</span><span class="op" id="6765463">,</span>&nbsp;<span class="ident" id="6765465">tt</span><span class="op" id="6765467">.</span><span class="ident" id="6765468">err</span><span class="op" id="6765471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765478">}</span><br>
<span class="lineno">95</span><span class="op" id="6765480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6765483">type</span>&nbsp;<span class="ident" id="6765488">faker</span>&nbsp;<span class="keyword" id="6765494">struct</span>&nbsp;<span class="op" id="6765501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765504">io</span><span class="op" id="6765506">.</span><span class="ident" id="6765507">ReadWriter</span><br>
<span class="lineno"></span><span class="op" id="6765518">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="6765521">func</span>&nbsp;<span class="op" id="6765526">(</span><span class="ident" id="6765527">f</span>&nbsp;<span class="ident" id="6765529">faker</span><span class="op" id="6765534">)</span>&nbsp;<span class="ident" id="6765536">Close</span><span class="op" id="6765541">(</span><span class="op" id="6765542">)</span>&nbsp;<span class="builtintype" id="6765544">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765570">{</span>&nbsp;<span class="keyword" id="6765572">return</span>&nbsp;<span class="builtintype" id="6765579">nil</span>&nbsp;<span class="op" id="6765583">}</span><br>
<span class="lineno"></span><span class="keyword" id="6765585">func</span>&nbsp;<span class="op" id="6765590">(</span><span class="ident" id="6765591">f</span>&nbsp;<span class="ident" id="6765593">faker</span><span class="op" id="6765598">)</span>&nbsp;<span class="ident" id="6765600">LocalAddr</span><span class="op" id="6765609">(</span><span class="op" id="6765610">)</span>&nbsp;<span class="ident" id="6765612">net</span><span class="op" id="6765615">.</span><span class="ident" id="6765616">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765634">{</span>&nbsp;<span class="keyword" id="6765636">return</span>&nbsp;<span class="builtintype" id="6765643">nil</span>&nbsp;<span class="op" id="6765647">}</span><br>
<span class="lineno"></span><span class="keyword" id="6765649">func</span>&nbsp;<span class="op" id="6765654">(</span><span class="ident" id="6765655">f</span>&nbsp;<span class="ident" id="6765657">faker</span><span class="op" id="6765662">)</span>&nbsp;<span class="ident" id="6765664">RemoteAddr</span><span class="op" id="6765674">(</span><span class="op" id="6765675">)</span>&nbsp;<span class="ident" id="6765677">net</span><span class="op" id="6765680">.</span><span class="ident" id="6765681">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765698">{</span>&nbsp;<span class="keyword" id="6765700">return</span>&nbsp;<span class="builtintype" id="6765707">nil</span>&nbsp;<span class="op" id="6765711">}</span><br>
<span class="lineno"></span><span class="keyword" id="6765713">func</span>&nbsp;<span class="op" id="6765718">(</span><span class="ident" id="6765719">f</span>&nbsp;<span class="ident" id="6765721">faker</span><span class="op" id="6765726">)</span>&nbsp;<span class="ident" id="6765728">SetDeadline</span><span class="op" id="6765739">(</span><span class="ident" id="6765740">time</span><span class="op" id="6765744">.</span><span class="ident" id="6765745">Time</span><span class="op" id="6765749">)</span>&nbsp;<span class="builtintype" id="6765751">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765762">{</span>&nbsp;<span class="keyword" id="6765764">return</span>&nbsp;<span class="builtintype" id="6765771">nil</span>&nbsp;<span class="op" id="6765775">}</span><br>
<span class="lineno">105</span><span class="keyword" id="6765777">func</span>&nbsp;<span class="op" id="6765782">(</span><span class="ident" id="6765783">f</span>&nbsp;<span class="ident" id="6765785">faker</span><span class="op" id="6765790">)</span>&nbsp;<span class="ident" id="6765792">SetReadDeadline</span><span class="op" id="6765807">(</span><span class="ident" id="6765808">time</span><span class="op" id="6765812">.</span><span class="ident" id="6765813">Time</span><span class="op" id="6765817">)</span>&nbsp;<span class="builtintype" id="6765819">error</span>&nbsp;&nbsp;<span class="op" id="6765826">{</span>&nbsp;<span class="keyword" id="6765828">return</span>&nbsp;<span class="builtintype" id="6765835">nil</span>&nbsp;<span class="op" id="6765839">}</span><br>
<span class="lineno"></span><span class="keyword" id="6765841">func</span>&nbsp;<span class="op" id="6765846">(</span><span class="ident" id="6765847">f</span>&nbsp;<span class="ident" id="6765849">faker</span><span class="op" id="6765854">)</span>&nbsp;<span class="ident" id="6765856">SetWriteDeadline</span><span class="op" id="6765872">(</span><span class="ident" id="6765873">time</span><span class="op" id="6765877">.</span><span class="ident" id="6765878">Time</span><span class="op" id="6765882">)</span>&nbsp;<span class="builtintype" id="6765884">error</span>&nbsp;<span class="op" id="6765890">{</span>&nbsp;<span class="keyword" id="6765892">return</span>&nbsp;<span class="builtintype" id="6765899">nil</span>&nbsp;<span class="op" id="6765903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6765906">func</span>&nbsp;<span class="ident" id="6765911">TestBasic</span><span class="op" id="6765920">(</span><span class="ident" id="6765921">t</span>&nbsp;<span class="op" id="6765923">*</span><span class="ident" id="6765924">testing</span><span class="op" id="6765931">.</span><span class="ident" id="6765932">T</span><span class="op" id="6765933">)</span>&nbsp;<span class="op" id="6765935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765938">server</span>&nbsp;<span class="op" id="6765945">:=</span>&nbsp;<span class="ident" id="6765948">strings</span><span class="op" id="6765955">.</span><span class="ident" id="6765956">Join</span><span class="op" id="6765960">(</span><span class="ident" id="6765961">strings</span><span class="op" id="6765968">.</span><span class="ident" id="6765969">Split</span><span class="op" id="6765974">(</span><span class="ident" id="6765975">basicServer</span><span class="op" id="6765986">,</span>&nbsp;<span class="string" id="6765988">&#34;\n&#34;</span><span class="op" id="6765992">)</span><span class="op" id="6765993">,</span>&nbsp;<span class="string" id="6765995">&#34;\r\n&#34;</span><span class="op" id="6766001">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766004">client</span>&nbsp;<span class="op" id="6766011">:=</span>&nbsp;<span class="ident" id="6766014">strings</span><span class="op" id="6766021">.</span><span class="ident" id="6766022">Join</span><span class="op" id="6766026">(</span><span class="ident" id="6766027">strings</span><span class="op" id="6766034">.</span><span class="ident" id="6766035">Split</span><span class="op" id="6766040">(</span><span class="ident" id="6766041">basicClient</span><span class="op" id="6766052">,</span>&nbsp;<span class="string" id="6766054">&#34;\n&#34;</span><span class="op" id="6766058">)</span><span class="op" id="6766059">,</span>&nbsp;<span class="string" id="6766061">&#34;\r\n&#34;</span><span class="op" id="6766067">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766071">var</span>&nbsp;<span class="ident" id="6766075">cmdbuf</span>&nbsp;<span class="ident" id="6766082">bytes</span><span class="op" id="6766087">.</span><span class="ident" id="6766088">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766096">bcmdbuf</span>&nbsp;<span class="op" id="6766104">:=</span>&nbsp;<span class="ident" id="6766107">bufio</span><span class="op" id="6766112">.</span><span class="ident" id="6766113">NewWriter</span><span class="op" id="6766122">(</span><span class="op" id="6766123">&amp;</span><span class="ident" id="6766124">cmdbuf</span><span class="op" id="6766130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766133">var</span>&nbsp;<span class="ident" id="6766137">fake</span>&nbsp;<span class="ident" id="6766142">faker</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766149">fake</span><span class="op" id="6766153">.</span><span class="ident" id="6766154">ReadWriter</span>&nbsp;<span class="op" id="6766165">=</span>&nbsp;<span class="ident" id="6766167">bufio</span><span class="op" id="6766172">.</span><span class="ident" id="6766173">NewReadWriter</span><span class="op" id="6766186">(</span><span class="ident" id="6766187">bufio</span><span class="op" id="6766192">.</span><span class="ident" id="6766193">NewReader</span><span class="op" id="6766202">(</span><span class="ident" id="6766203">strings</span><span class="op" id="6766210">.</span><span class="ident" id="6766211">NewReader</span><span class="op" id="6766220">(</span><span class="ident" id="6766221">server</span><span class="op" id="6766227">)</span><span class="op" id="6766228">)</span><span class="op" id="6766229">,</span>&nbsp;<span class="ident" id="6766231">bcmdbuf</span><span class="op" id="6766238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766241">c</span>&nbsp;<span class="op" id="6766243">:=</span>&nbsp;<span class="op" id="6766246">&amp;</span><span class="ident" id="6766247">Client</span><span class="op" id="6766253">{</span><span class="ident" id="6766254">Text</span><span class="op" id="6766258">:</span>&nbsp;<span class="ident" id="6766260">textproto</span><span class="op" id="6766269">.</span><span class="ident" id="6766270">NewConn</span><span class="op" id="6766277">(</span><span class="ident" id="6766278">fake</span><span class="op" id="6766282">)</span><span class="op" id="6766283">,</span>&nbsp;<span class="ident" id="6766285">localName</span><span class="op" id="6766294">:</span>&nbsp;<span class="string" id="6766296">&#34;localhost&#34;</span><span class="op" id="6766307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766311">if</span>&nbsp;<span class="ident" id="6766314">err</span>&nbsp;<span class="op" id="6766318">:=</span>&nbsp;<span class="ident" id="6766321">c</span><span class="op" id="6766322">.</span><span class="ident" id="6766323">helo</span><span class="op" id="6766327">(</span><span class="op" id="6766328">)</span><span class="op" id="6766329">;</span>&nbsp;<span class="ident" id="6766331">err</span>&nbsp;<span class="op" id="6766335">!=</span>&nbsp;<span class="builtintype" id="6766338">nil</span>&nbsp;<span class="op" id="6766342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766346">t</span><span class="op" id="6766347">.</span><span class="ident" id="6766348">Fatalf</span><span class="op" id="6766354">(</span><span class="string" id="6766355">&#34;HELO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6766372">,</span>&nbsp;<span class="ident" id="6766374">err</span><span class="op" id="6766377">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766383">if</span>&nbsp;<span class="ident" id="6766386">err</span>&nbsp;<span class="op" id="6766390">:=</span>&nbsp;<span class="ident" id="6766393">c</span><span class="op" id="6766394">.</span><span class="ident" id="6766395">ehlo</span><span class="op" id="6766399">(</span><span class="op" id="6766400">)</span><span class="op" id="6766401">;</span>&nbsp;<span class="ident" id="6766403">err</span>&nbsp;<span class="op" id="6766407">==</span>&nbsp;<span class="builtintype" id="6766410">nil</span>&nbsp;<span class="op" id="6766414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766418">t</span><span class="op" id="6766419">.</span><span class="ident" id="6766420">Fatalf</span><span class="op" id="6766426">(</span><span class="string" id="6766427">&#34;Expected&nbsp;first&nbsp;EHLO&nbsp;to&nbsp;fail&#34;</span><span class="op" id="6766456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766462">if</span>&nbsp;<span class="ident" id="6766465">err</span>&nbsp;<span class="op" id="6766469">:=</span>&nbsp;<span class="ident" id="6766472">c</span><span class="op" id="6766473">.</span><span class="ident" id="6766474">ehlo</span><span class="op" id="6766478">(</span><span class="op" id="6766479">)</span><span class="op" id="6766480">;</span>&nbsp;<span class="ident" id="6766482">err</span>&nbsp;<span class="op" id="6766486">!=</span>&nbsp;<span class="builtintype" id="6766489">nil</span>&nbsp;<span class="op" id="6766493">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766497">t</span><span class="op" id="6766498">.</span><span class="ident" id="6766499">Fatalf</span><span class="op" id="6766505">(</span><span class="string" id="6766506">&#34;Second&nbsp;EHLO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6766530">,</span>&nbsp;<span class="ident" id="6766532">err</span><span class="op" id="6766535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766542">c</span><span class="op" id="6766543">.</span><span class="ident" id="6766544">didHello</span>&nbsp;<span class="op" id="6766553">=</span>&nbsp;<span class="builtintype" id="6766555">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766561">if</span>&nbsp;<span class="ident" id="6766564">ok</span><span class="op" id="6766566">,</span>&nbsp;<span class="ident" id="6766568">args</span>&nbsp;<span class="op" id="6766573">:=</span>&nbsp;<span class="ident" id="6766576">c</span><span class="op" id="6766577">.</span><span class="ident" id="6766578">Extension</span><span class="op" id="6766587">(</span><span class="string" id="6766588">&#34;aUtH&#34;</span><span class="op" id="6766594">)</span><span class="op" id="6766595">;</span>&nbsp;<span class="op" id="6766597">!</span><span class="ident" id="6766598">ok</span>&nbsp;<span class="op" id="6766601">||</span>&nbsp;<span class="ident" id="6766604">args</span>&nbsp;<span class="op" id="6766609">!=</span>&nbsp;<span class="string" id="6766612">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="6766626">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766630">t</span><span class="op" id="6766631">.</span><span class="ident" id="6766632">Fatalf</span><span class="op" id="6766638">(</span><span class="string" id="6766639">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="6766664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766670">if</span>&nbsp;<span class="ident" id="6766673">ok</span><span class="op" id="6766675">,</span>&nbsp;<span class="ident" id="6766677">_</span>&nbsp;<span class="op" id="6766679">:=</span>&nbsp;<span class="ident" id="6766682">c</span><span class="op" id="6766683">.</span><span class="ident" id="6766684">Extension</span><span class="op" id="6766693">(</span><span class="string" id="6766694">&#34;DSN&#34;</span><span class="op" id="6766699">)</span><span class="op" id="6766700">;</span>&nbsp;<span class="ident" id="6766702">ok</span>&nbsp;<span class="op" id="6766705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766709">t</span><span class="op" id="6766710">.</span><span class="ident" id="6766711">Fatalf</span><span class="op" id="6766717">(</span><span class="string" id="6766718">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="6766741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766744">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766748">if</span>&nbsp;<span class="ident" id="6766751">err</span>&nbsp;<span class="op" id="6766755">:=</span>&nbsp;<span class="ident" id="6766758">c</span><span class="op" id="6766759">.</span><span class="ident" id="6766760">Mail</span><span class="op" id="6766764">(</span><span class="string" id="6766765">&#34;user@gmail.com&#34;</span><span class="op" id="6766781">)</span><span class="op" id="6766782">;</span>&nbsp;<span class="ident" id="6766784">err</span>&nbsp;<span class="op" id="6766788">==</span>&nbsp;<span class="builtintype" id="6766791">nil</span>&nbsp;<span class="op" id="6766795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766799">t</span><span class="op" id="6766800">.</span><span class="ident" id="6766801">Fatalf</span><span class="op" id="6766807">(</span><span class="string" id="6766808">&#34;MAIL&nbsp;should&nbsp;require&nbsp;authentication&#34;</span><span class="op" id="6766844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766851">if</span>&nbsp;<span class="ident" id="6766854">err</span>&nbsp;<span class="op" id="6766858">:=</span>&nbsp;<span class="ident" id="6766861">c</span><span class="op" id="6766862">.</span><span class="ident" id="6766863">Verify</span><span class="op" id="6766869">(</span><span class="string" id="6766870">&#34;user1@gmail.com&#34;</span><span class="op" id="6766887">)</span><span class="op" id="6766888">;</span>&nbsp;<span class="ident" id="6766890">err</span>&nbsp;<span class="op" id="6766894">==</span>&nbsp;<span class="builtintype" id="6766897">nil</span>&nbsp;<span class="op" id="6766901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766905">t</span><span class="op" id="6766906">.</span><span class="ident" id="6766907">Fatalf</span><span class="op" id="6766913">(</span><span class="string" id="6766914">&#34;First&nbsp;VRFY:&nbsp;expected&nbsp;no&nbsp;verification&#34;</span><span class="op" id="6766952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766958">if</span>&nbsp;<span class="ident" id="6766961">err</span>&nbsp;<span class="op" id="6766965">:=</span>&nbsp;<span class="ident" id="6766968">c</span><span class="op" id="6766969">.</span><span class="ident" id="6766970">Verify</span><span class="op" id="6766976">(</span><span class="string" id="6766977">&#34;user2@gmail.com&#34;</span><span class="op" id="6766994">)</span><span class="op" id="6766995">;</span>&nbsp;<span class="ident" id="6766997">err</span>&nbsp;<span class="op" id="6767001">!=</span>&nbsp;<span class="builtintype" id="6767004">nil</span>&nbsp;<span class="op" id="6767008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6767012">t</span><span class="op" id="6767013">.</span><span class="ident" id="6767014">Fatalf</span><span class="op" id="6767020">(</span><span class="string" id="6767021">&#34;Second&nbsp;VRFY:&nbsp;expected&nbsp;verification,&nbsp;got&nbsp;%s&#34;</span><span class="op" id="6767065">,</span>&nbsp;<span class="ident" id="6767067">err</span><span class="op" id="6767070">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6767077">//&nbsp;fake&nbsp;TLS&nbsp;so&nbsp;authentication&nbsp;won&#39;t&nbsp;complain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6767123">c</span><span class="op" id="6767124">.</span><span class="ident" id="6767125">tls</span>&nbsp;<span class="op" id="6767129">=</span>&nbsp;<span class="builtintype" id="6767131">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6767137">c</span><span class="op" id="6767138">.</span><span class="ident" id="6767139">serverName</span>&nbsp;<span class="op" id="6767150">=</span>&nbsp;<span class="string" id="6767152">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6767171">if</span>&nbsp;<span class="ident" id="6767174">err</span>&nbsp;<span class="op" id="6767178">:=</span>&nbsp;<span class="ident" id="6767181">c</span><span class="op" id="6767182">.</span><span class="ident" id="6767183">Auth</span><span class="op" id="6767187">(</span><span class="ident" id="6767188">PlainAuth</span><span class="op" id="6767197">(</span><span class="string" id="6767198">&#34;&#34;</span><span class="op" id="6767200">,</span>&nbsp;<span class="string" id="6767202">&#34;user&#34;</span><span class="op" id="6767208">,</span>&nbsp;<span class="string" id="6767210">&#34;pass&#34;</span><span class="op" id="6767216">,</span>&nbsp;<span class="string" id="6767218">&#34;smtp.google.com&#34;</span><span class="op" id="6767235">)</span><span class="op" id="6767236">)</span><span class="op" id="6767237">;</span>&nbsp;<span class="ident" id="6767239">err</span>&nbsp;<span class="op" id="6767243">!=</span>&nbsp;<span class="builtintype" id="6767246">nil</span>&nbsp;<span class="op" id="6767250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6767254">t</span><span class="op" id="6767255">.</span><span class="ident" id="6767256">Fatalf</span><span class="op" id="6767262">(</span><span class="string" id="6767263">&#34;AUTH&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6767280">,</span>&nbsp;<span class="ident" id="6767282">err</span><span class="op" id="6767285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6767292">if</span>&nbsp;<span class="ident" id="6767295">err</span>&nbsp;<span class="op" id="6767299">:=</span>&nbsp;<span class="ident" id="6767302">c</span><span class="op" id="6767303">.</span><span class="ident" id="6767304">Mail</span><span class="op" id="6767308">(</span><span class="string" id="6767309">&#34;user@gmail.com&#34;</span><span class="op" id="6767325">)</span><span class="op" id="6767326">;</span>&nbsp;<span class="ident" id="6767328">err</span>&nbsp;<span class="op" id="6767332">!=</span>&nbsp;<span class="builtintype" id="6767335">nil</span>&nbsp;<span class="op" id="6767339">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6767343">t</span><span class="op" id="6767344">.</span><span class="ident" id="6767345">Fatalf</span><span class="op" id="6767351">(</span><span class="string" id="6767352">&#34;MAIL&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6767369">,</span>&nbsp;<span class="ident" id="6767371">err</span><span class="op" id="6767374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6767380">if</span>&nbsp;<span class="ident" id="6767383">err</span>&nbsp;<span class="op" id="6767387">:=</span>&nbsp;<span class="ident" id="6767390">c</span><span class="op" id="6767391">.</span><span class="ident" id="6767392">Rcpt</span><span class="op" id="6767396">(</span><span class="string" id="6767397">&#34;golang-nuts@googlegroups.com&#34;</span><span class="op" id="6767427">)</span><span class="op" id="6767428">;</span>&nbsp;<span class="ident" id="6767430">err</span>&nbsp;<span class="op" id="6767434">!=</span>&nbsp;<span class="builtintype" id="6767437">nil</span>&nbsp;<span class="op" id="6767441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6767445">t</span><span class="op" id="6767446">.</span><span class="ident" id="6767447">Fatalf</span><span class="op" id="6767453">(</span><span class="string" id="6767454">&#34;RCPT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6767471">,</span>&nbsp;<span class="ident" id="6767473">err</span><span class="op" id="6767476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767479">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6767482">msg</span>&nbsp;<span class="op" id="6767486">:=</span>&nbsp;<span class="string" id="6767489">`From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno"></span>Line&nbsp;1<br>
<span class="lineno">165</span>.Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6767606">w</span><span class="op" id="6767607">,</span>&nbsp;<span class="ident" id="6767609">err</span>&nbsp;<span class="op" id="6767613">:=</span>&nbsp;<span class="ident" id="6767616">c</span><span class="op" id="6767617">.</span><span class="ident" id="6767618">Data</span><span class="op" id="6767622">(</span><span class="op" id="6767623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6767626">if</span>&nbsp;<span class="ident" id="6767629">err</span>&nbsp;<span class="op" id="6767633">!=</span>&nbsp;<span class="builtintype" id="6767636">nil</span>&nbsp;<span class="op" id="6767640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6767644">t</span><span class="op" id="6767645">.</span><span class="ident" id="6767646">Fatalf</span><span class="op" id="6767652">(</span><span class="string" id="6767653">&#34;DATA&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6767670">,</span>&nbsp;<span class="ident" id="6767672">err</span><span class="op" id="6767675">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6767681">if</span>&nbsp;<span class="ident" id="6767684">_</span><span class="op" id="6767685">,</span>&nbsp;<span class="ident" id="6767687">err</span>&nbsp;<span class="op" id="6767691">:=</span>&nbsp;<span class="ident" id="6767694">w</span><span class="op" id="6767695">.</span><span class="ident" id="6767696">Write</span><span class="op" id="6767701">(</span><span class="op" id="6767702">[</span><span class="op" id="6767703">]</span><span class="builtintype" id="6767704">byte</span><span class="op" id="6767708">(</span><span class="ident" id="6767709">msg</span><span class="op" id="6767712">)</span><span class="op" id="6767713">)</span><span class="op" id="6767714">;</span>&nbsp;<span class="ident" id="6767716">err</span>&nbsp;<span class="op" id="6767720">!=</span>&nbsp;<span class="builtintype" id="6767723">nil</span>&nbsp;<span class="op" id="6767727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6767731">t</span><span class="op" id="6767732">.</span><span class="ident" id="6767733">Fatalf</span><span class="op" id="6767739">(</span><span class="string" id="6767740">&#34;Data&nbsp;write&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6767763">,</span>&nbsp;<span class="ident" id="6767765">err</span><span class="op" id="6767768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6767774">if</span>&nbsp;<span class="ident" id="6767777">err</span>&nbsp;<span class="op" id="6767781">:=</span>&nbsp;<span class="ident" id="6767784">w</span><span class="op" id="6767785">.</span><span class="ident" id="6767786">Close</span><span class="op" id="6767791">(</span><span class="op" id="6767792">)</span><span class="op" id="6767793">;</span>&nbsp;<span class="ident" id="6767795">err</span>&nbsp;<span class="op" id="6767799">!=</span>&nbsp;<span class="builtintype" id="6767802">nil</span>&nbsp;<span class="op" id="6767806">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6767810">t</span><span class="op" id="6767811">.</span><span class="ident" id="6767812">Fatalf</span><span class="op" id="6767818">(</span><span class="string" id="6767819">&#34;Bad&nbsp;data&nbsp;response:&nbsp;%s&#34;</span><span class="op" id="6767842">,</span>&nbsp;<span class="ident" id="6767844">err</span><span class="op" id="6767847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6767854">if</span>&nbsp;<span class="ident" id="6767857">err</span>&nbsp;<span class="op" id="6767861">:=</span>&nbsp;<span class="ident" id="6767864">c</span><span class="op" id="6767865">.</span><span class="ident" id="6767866">Quit</span><span class="op" id="6767870">(</span><span class="op" id="6767871">)</span><span class="op" id="6767872">;</span>&nbsp;<span class="ident" id="6767874">err</span>&nbsp;<span class="op" id="6767878">!=</span>&nbsp;<span class="builtintype" id="6767881">nil</span>&nbsp;<span class="op" id="6767885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6767889">t</span><span class="op" id="6767890">.</span><span class="ident" id="6767891">Fatalf</span><span class="op" id="6767897">(</span><span class="string" id="6767898">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6767915">,</span>&nbsp;<span class="ident" id="6767917">err</span><span class="op" id="6767920">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6767927">bcmdbuf</span><span class="op" id="6767934">.</span><span class="ident" id="6767935">Flush</span><span class="op" id="6767940">(</span><span class="op" id="6767941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6767944">actualcmds</span>&nbsp;<span class="op" id="6767955">:=</span>&nbsp;<span class="ident" id="6767958">cmdbuf</span><span class="op" id="6767964">.</span><span class="ident" id="6767965">String</span><span class="op" id="6767971">(</span><span class="op" id="6767972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6767975">if</span>&nbsp;<span class="ident" id="6767978">client</span>&nbsp;<span class="op" id="6767985">!=</span>&nbsp;<span class="ident" id="6767988">actualcmds</span>&nbsp;<span class="op" id="6767999">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6768003">t</span><span class="op" id="6768004">.</span><span class="ident" id="6768005">Fatalf</span><span class="op" id="6768011">(</span><span class="string" id="6768012">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6768037">,</span>&nbsp;<span class="ident" id="6768039">actualcmds</span><span class="op" id="6768049">,</span>&nbsp;<span class="ident" id="6768051">client</span><span class="op" id="6768057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6768060">}</span><br>
<span class="lineno"></span><span class="op" id="6768062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6768065">var</span>&nbsp;<span class="ident" id="6768069">basicServer</span>&nbsp;<span class="op" id="6768081">=</span>&nbsp;<span class="string" id="6768083">`250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno">190</span>502&nbsp;Unrecognized&nbsp;command.<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">195</span>530&nbsp;Authentication&nbsp;required<br>
<span class="lineno"></span>252&nbsp;Send&nbsp;some&nbsp;mail,&nbsp;I&#39;ll&nbsp;try&nbsp;my&nbsp;best<br>
<span class="lineno"></span>250&nbsp;User&nbsp;is&nbsp;valid<br>
<span class="lineno"></span>235&nbsp;Accepted<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;OK<br>
<span class="lineno">200</span>250&nbsp;Receiver&nbsp;OK<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;OK<br>
<span class="lineno"></span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="6768391">var</span>&nbsp;<span class="ident" id="6768395">basicClient</span>&nbsp;<span class="op" id="6768407">=</span>&nbsp;<span class="string" id="6768409">`HELO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno">210</span>VRFY&nbsp;user1@gmail.com<br>
<span class="lineno"></span>VRFY&nbsp;user2@gmail.com<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;golang-nuts@googlegroups.com&gt;<br>
<span class="lineno">215</span>DATA<br>
<span class="lineno"></span>From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno">220</span>Line&nbsp;1<br>
<span class="lineno"></span>..Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">225</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6768776">func</span>&nbsp;<span class="ident" id="6768781">TestNewClient</span><span class="op" id="6768794">(</span><span class="ident" id="6768795">t</span>&nbsp;<span class="op" id="6768797">*</span><span class="ident" id="6768798">testing</span><span class="op" id="6768805">.</span><span class="ident" id="6768806">T</span><span class="op" id="6768807">)</span>&nbsp;<span class="op" id="6768809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6768812">server</span>&nbsp;<span class="op" id="6768819">:=</span>&nbsp;<span class="ident" id="6768822">strings</span><span class="op" id="6768829">.</span><span class="ident" id="6768830">Join</span><span class="op" id="6768834">(</span><span class="ident" id="6768835">strings</span><span class="op" id="6768842">.</span><span class="ident" id="6768843">Split</span><span class="op" id="6768848">(</span><span class="ident" id="6768849">newClientServer</span><span class="op" id="6768864">,</span>&nbsp;<span class="string" id="6768866">&#34;\n&#34;</span><span class="op" id="6768870">)</span><span class="op" id="6768871">,</span>&nbsp;<span class="string" id="6768873">&#34;\r\n&#34;</span><span class="op" id="6768879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6768882">client</span>&nbsp;<span class="op" id="6768889">:=</span>&nbsp;<span class="ident" id="6768892">strings</span><span class="op" id="6768899">.</span><span class="ident" id="6768900">Join</span><span class="op" id="6768904">(</span><span class="ident" id="6768905">strings</span><span class="op" id="6768912">.</span><span class="ident" id="6768913">Split</span><span class="op" id="6768918">(</span><span class="ident" id="6768919">newClientClient</span><span class="op" id="6768934">,</span>&nbsp;<span class="string" id="6768936">&#34;\n&#34;</span><span class="op" id="6768940">)</span><span class="op" id="6768941">,</span>&nbsp;<span class="string" id="6768943">&#34;\r\n&#34;</span><span class="op" id="6768949">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6768953">var</span>&nbsp;<span class="ident" id="6768957">cmdbuf</span>&nbsp;<span class="ident" id="6768964">bytes</span><span class="op" id="6768969">.</span><span class="ident" id="6768970">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6768978">bcmdbuf</span>&nbsp;<span class="op" id="6768986">:=</span>&nbsp;<span class="ident" id="6768989">bufio</span><span class="op" id="6768994">.</span><span class="ident" id="6768995">NewWriter</span><span class="op" id="6769004">(</span><span class="op" id="6769005">&amp;</span><span class="ident" id="6769006">cmdbuf</span><span class="op" id="6769012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769015">out</span>&nbsp;<span class="op" id="6769019">:=</span>&nbsp;<span class="keyword" id="6769022">func</span><span class="op" id="6769026">(</span><span class="op" id="6769027">)</span>&nbsp;<span class="builtintype" id="6769029">string</span>&nbsp;<span class="op" id="6769036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769040">bcmdbuf</span><span class="op" id="6769047">.</span><span class="ident" id="6769048">Flush</span><span class="op" id="6769053">(</span><span class="op" id="6769054">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6769058">return</span>&nbsp;<span class="ident" id="6769065">cmdbuf</span><span class="op" id="6769071">.</span><span class="ident" id="6769072">String</span><span class="op" id="6769078">(</span><span class="op" id="6769079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6769082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6769085">var</span>&nbsp;<span class="ident" id="6769089">fake</span>&nbsp;<span class="ident" id="6769094">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769101">fake</span><span class="op" id="6769105">.</span><span class="ident" id="6769106">ReadWriter</span>&nbsp;<span class="op" id="6769117">=</span>&nbsp;<span class="ident" id="6769119">bufio</span><span class="op" id="6769124">.</span><span class="ident" id="6769125">NewReadWriter</span><span class="op" id="6769138">(</span><span class="ident" id="6769139">bufio</span><span class="op" id="6769144">.</span><span class="ident" id="6769145">NewReader</span><span class="op" id="6769154">(</span><span class="ident" id="6769155">strings</span><span class="op" id="6769162">.</span><span class="ident" id="6769163">NewReader</span><span class="op" id="6769172">(</span><span class="ident" id="6769173">server</span><span class="op" id="6769179">)</span><span class="op" id="6769180">)</span><span class="op" id="6769181">,</span>&nbsp;<span class="ident" id="6769183">bcmdbuf</span><span class="op" id="6769190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769193">c</span><span class="op" id="6769194">,</span>&nbsp;<span class="ident" id="6769196">err</span>&nbsp;<span class="op" id="6769200">:=</span>&nbsp;<span class="ident" id="6769203">NewClient</span><span class="op" id="6769212">(</span><span class="ident" id="6769213">fake</span><span class="op" id="6769217">,</span>&nbsp;<span class="string" id="6769219">&#34;fake.host&#34;</span><span class="op" id="6769230">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6769233">if</span>&nbsp;<span class="ident" id="6769236">err</span>&nbsp;<span class="op" id="6769240">!=</span>&nbsp;<span class="builtintype" id="6769243">nil</span>&nbsp;<span class="op" id="6769247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769251">t</span><span class="op" id="6769252">.</span><span class="ident" id="6769253">Fatalf</span><span class="op" id="6769259">(</span><span class="string" id="6769260">&#34;NewClient:&nbsp;%v\n(after&nbsp;%v)&#34;</span><span class="op" id="6769287">,</span>&nbsp;<span class="ident" id="6769289">err</span><span class="op" id="6769292">,</span>&nbsp;<span class="ident" id="6769294">out</span><span class="op" id="6769297">(</span><span class="op" id="6769298">)</span><span class="op" id="6769299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6769302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6769305">defer</span>&nbsp;<span class="ident" id="6769311">c</span><span class="op" id="6769312">.</span><span class="ident" id="6769313">Close</span><span class="op" id="6769318">(</span><span class="op" id="6769319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6769322">if</span>&nbsp;<span class="ident" id="6769325">ok</span><span class="op" id="6769327">,</span>&nbsp;<span class="ident" id="6769329">args</span>&nbsp;<span class="op" id="6769334">:=</span>&nbsp;<span class="ident" id="6769337">c</span><span class="op" id="6769338">.</span><span class="ident" id="6769339">Extension</span><span class="op" id="6769348">(</span><span class="string" id="6769349">&#34;aUtH&#34;</span><span class="op" id="6769355">)</span><span class="op" id="6769356">;</span>&nbsp;<span class="op" id="6769358">!</span><span class="ident" id="6769359">ok</span>&nbsp;<span class="op" id="6769362">||</span>&nbsp;<span class="ident" id="6769365">args</span>&nbsp;<span class="op" id="6769370">!=</span>&nbsp;<span class="string" id="6769373">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="6769387">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769391">t</span><span class="op" id="6769392">.</span><span class="ident" id="6769393">Fatalf</span><span class="op" id="6769399">(</span><span class="string" id="6769400">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="6769425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6769428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6769431">if</span>&nbsp;<span class="ident" id="6769434">ok</span><span class="op" id="6769436">,</span>&nbsp;<span class="ident" id="6769438">_</span>&nbsp;<span class="op" id="6769440">:=</span>&nbsp;<span class="ident" id="6769443">c</span><span class="op" id="6769444">.</span><span class="ident" id="6769445">Extension</span><span class="op" id="6769454">(</span><span class="string" id="6769455">&#34;DSN&#34;</span><span class="op" id="6769460">)</span><span class="op" id="6769461">;</span>&nbsp;<span class="ident" id="6769463">ok</span>&nbsp;<span class="op" id="6769466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769470">t</span><span class="op" id="6769471">.</span><span class="ident" id="6769472">Fatalf</span><span class="op" id="6769478">(</span><span class="string" id="6769479">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="6769502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6769505">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6769508">if</span>&nbsp;<span class="ident" id="6769511">err</span>&nbsp;<span class="op" id="6769515">:=</span>&nbsp;<span class="ident" id="6769518">c</span><span class="op" id="6769519">.</span><span class="ident" id="6769520">Quit</span><span class="op" id="6769524">(</span><span class="op" id="6769525">)</span><span class="op" id="6769526">;</span>&nbsp;<span class="ident" id="6769528">err</span>&nbsp;<span class="op" id="6769532">!=</span>&nbsp;<span class="builtintype" id="6769535">nil</span>&nbsp;<span class="op" id="6769539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769543">t</span><span class="op" id="6769544">.</span><span class="ident" id="6769545">Fatalf</span><span class="op" id="6769551">(</span><span class="string" id="6769552">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6769569">,</span>&nbsp;<span class="ident" id="6769571">err</span><span class="op" id="6769574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6769577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769581">actualcmds</span>&nbsp;<span class="op" id="6769592">:=</span>&nbsp;<span class="ident" id="6769595">out</span><span class="op" id="6769598">(</span><span class="op" id="6769599">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6769602">if</span>&nbsp;<span class="ident" id="6769605">client</span>&nbsp;<span class="op" id="6769612">!=</span>&nbsp;<span class="ident" id="6769615">actualcmds</span>&nbsp;<span class="op" id="6769626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769630">t</span><span class="op" id="6769631">.</span><span class="ident" id="6769632">Fatalf</span><span class="op" id="6769638">(</span><span class="string" id="6769639">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6769664">,</span>&nbsp;<span class="ident" id="6769666">actualcmds</span><span class="op" id="6769676">,</span>&nbsp;<span class="ident" id="6769678">client</span><span class="op" id="6769684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6769687">}</span><br>
<span class="lineno"></span><span class="op" id="6769689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="keyword" id="6769692">var</span>&nbsp;<span class="ident" id="6769696">newClientServer</span>&nbsp;<span class="op" id="6769712">=</span>&nbsp;<span class="string" id="6769714">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">265</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6769827">var</span>&nbsp;<span class="ident" id="6769831">newClientClient</span>&nbsp;<span class="op" id="6769847">=</span>&nbsp;<span class="string" id="6769849">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">270</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6769873">func</span>&nbsp;<span class="ident" id="6769878">TestNewClient2</span><span class="op" id="6769892">(</span><span class="ident" id="6769893">t</span>&nbsp;<span class="op" id="6769895">*</span><span class="ident" id="6769896">testing</span><span class="op" id="6769903">.</span><span class="ident" id="6769904">T</span><span class="op" id="6769905">)</span>&nbsp;<span class="op" id="6769907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769910">server</span>&nbsp;<span class="op" id="6769917">:=</span>&nbsp;<span class="ident" id="6769920">strings</span><span class="op" id="6769927">.</span><span class="ident" id="6769928">Join</span><span class="op" id="6769932">(</span><span class="ident" id="6769933">strings</span><span class="op" id="6769940">.</span><span class="ident" id="6769941">Split</span><span class="op" id="6769946">(</span><span class="ident" id="6769947">newClient2Server</span><span class="op" id="6769963">,</span>&nbsp;<span class="string" id="6769965">&#34;\n&#34;</span><span class="op" id="6769969">)</span><span class="op" id="6769970">,</span>&nbsp;<span class="string" id="6769972">&#34;\r\n&#34;</span><span class="op" id="6769978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769981">client</span>&nbsp;<span class="op" id="6769988">:=</span>&nbsp;<span class="ident" id="6769991">strings</span><span class="op" id="6769998">.</span><span class="ident" id="6769999">Join</span><span class="op" id="6770003">(</span><span class="ident" id="6770004">strings</span><span class="op" id="6770011">.</span><span class="ident" id="6770012">Split</span><span class="op" id="6770017">(</span><span class="ident" id="6770018">newClient2Client</span><span class="op" id="6770034">,</span>&nbsp;<span class="string" id="6770036">&#34;\n&#34;</span><span class="op" id="6770040">)</span><span class="op" id="6770041">,</span>&nbsp;<span class="string" id="6770043">&#34;\r\n&#34;</span><span class="op" id="6770049">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770053">var</span>&nbsp;<span class="ident" id="6770057">cmdbuf</span>&nbsp;<span class="ident" id="6770064">bytes</span><span class="op" id="6770069">.</span><span class="ident" id="6770070">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770078">bcmdbuf</span>&nbsp;<span class="op" id="6770086">:=</span>&nbsp;<span class="ident" id="6770089">bufio</span><span class="op" id="6770094">.</span><span class="ident" id="6770095">NewWriter</span><span class="op" id="6770104">(</span><span class="op" id="6770105">&amp;</span><span class="ident" id="6770106">cmdbuf</span><span class="op" id="6770112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770115">var</span>&nbsp;<span class="ident" id="6770119">fake</span>&nbsp;<span class="ident" id="6770124">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770131">fake</span><span class="op" id="6770135">.</span><span class="ident" id="6770136">ReadWriter</span>&nbsp;<span class="op" id="6770147">=</span>&nbsp;<span class="ident" id="6770149">bufio</span><span class="op" id="6770154">.</span><span class="ident" id="6770155">NewReadWriter</span><span class="op" id="6770168">(</span><span class="ident" id="6770169">bufio</span><span class="op" id="6770174">.</span><span class="ident" id="6770175">NewReader</span><span class="op" id="6770184">(</span><span class="ident" id="6770185">strings</span><span class="op" id="6770192">.</span><span class="ident" id="6770193">NewReader</span><span class="op" id="6770202">(</span><span class="ident" id="6770203">server</span><span class="op" id="6770209">)</span><span class="op" id="6770210">)</span><span class="op" id="6770211">,</span>&nbsp;<span class="ident" id="6770213">bcmdbuf</span><span class="op" id="6770220">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770223">c</span><span class="op" id="6770224">,</span>&nbsp;<span class="ident" id="6770226">err</span>&nbsp;<span class="op" id="6770230">:=</span>&nbsp;<span class="ident" id="6770233">NewClient</span><span class="op" id="6770242">(</span><span class="ident" id="6770243">fake</span><span class="op" id="6770247">,</span>&nbsp;<span class="string" id="6770249">&#34;fake.host&#34;</span><span class="op" id="6770260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770263">if</span>&nbsp;<span class="ident" id="6770266">err</span>&nbsp;<span class="op" id="6770270">!=</span>&nbsp;<span class="builtintype" id="6770273">nil</span>&nbsp;<span class="op" id="6770277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770281">t</span><span class="op" id="6770282">.</span><span class="ident" id="6770283">Fatalf</span><span class="op" id="6770289">(</span><span class="string" id="6770290">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="6770305">,</span>&nbsp;<span class="ident" id="6770307">err</span><span class="op" id="6770310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770316">defer</span>&nbsp;<span class="ident" id="6770322">c</span><span class="op" id="6770323">.</span><span class="ident" id="6770324">Close</span><span class="op" id="6770329">(</span><span class="op" id="6770330">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770333">if</span>&nbsp;<span class="ident" id="6770336">ok</span><span class="op" id="6770338">,</span>&nbsp;<span class="ident" id="6770340">_</span>&nbsp;<span class="op" id="6770342">:=</span>&nbsp;<span class="ident" id="6770345">c</span><span class="op" id="6770346">.</span><span class="ident" id="6770347">Extension</span><span class="op" id="6770356">(</span><span class="string" id="6770357">&#34;DSN&#34;</span><span class="op" id="6770362">)</span><span class="op" id="6770363">;</span>&nbsp;<span class="ident" id="6770365">ok</span>&nbsp;<span class="op" id="6770368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770372">t</span><span class="op" id="6770373">.</span><span class="ident" id="6770374">Fatalf</span><span class="op" id="6770380">(</span><span class="string" id="6770381">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="6770404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770410">if</span>&nbsp;<span class="ident" id="6770413">err</span>&nbsp;<span class="op" id="6770417">:=</span>&nbsp;<span class="ident" id="6770420">c</span><span class="op" id="6770421">.</span><span class="ident" id="6770422">Quit</span><span class="op" id="6770426">(</span><span class="op" id="6770427">)</span><span class="op" id="6770428">;</span>&nbsp;<span class="ident" id="6770430">err</span>&nbsp;<span class="op" id="6770434">!=</span>&nbsp;<span class="builtintype" id="6770437">nil</span>&nbsp;<span class="op" id="6770441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770445">t</span><span class="op" id="6770446">.</span><span class="ident" id="6770447">Fatalf</span><span class="op" id="6770453">(</span><span class="string" id="6770454">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6770471">,</span>&nbsp;<span class="ident" id="6770473">err</span><span class="op" id="6770476">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770483">bcmdbuf</span><span class="op" id="6770490">.</span><span class="ident" id="6770491">Flush</span><span class="op" id="6770496">(</span><span class="op" id="6770497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770500">actualcmds</span>&nbsp;<span class="op" id="6770511">:=</span>&nbsp;<span class="ident" id="6770514">cmdbuf</span><span class="op" id="6770520">.</span><span class="ident" id="6770521">String</span><span class="op" id="6770527">(</span><span class="op" id="6770528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770531">if</span>&nbsp;<span class="ident" id="6770534">client</span>&nbsp;<span class="op" id="6770541">!=</span>&nbsp;<span class="ident" id="6770544">actualcmds</span>&nbsp;<span class="op" id="6770555">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770559">t</span><span class="op" id="6770560">.</span><span class="ident" id="6770561">Fatalf</span><span class="op" id="6770567">(</span><span class="string" id="6770568">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6770593">,</span>&nbsp;<span class="ident" id="6770595">actualcmds</span><span class="op" id="6770605">,</span>&nbsp;<span class="ident" id="6770607">client</span><span class="op" id="6770613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770616">}</span><br>
<span class="lineno"></span><span class="op" id="6770618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6770621">var</span>&nbsp;<span class="ident" id="6770625">newClient2Server</span>&nbsp;<span class="op" id="6770642">=</span>&nbsp;<span class="string" id="6770644">`220&nbsp;hello&nbsp;world<br>
<span class="lineno">300</span>502&nbsp;EH?<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">305</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6770765">var</span>&nbsp;<span class="ident" id="6770769">newClient2Client</span>&nbsp;<span class="op" id="6770786">=</span>&nbsp;<span class="string" id="6770788">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno">310</span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6770827">func</span>&nbsp;<span class="ident" id="6770832">TestHello</span><span class="op" id="6770841">(</span><span class="ident" id="6770842">t</span>&nbsp;<span class="op" id="6770844">*</span><span class="ident" id="6770845">testing</span><span class="op" id="6770852">.</span><span class="ident" id="6770853">T</span><span class="op" id="6770854">)</span>&nbsp;<span class="op" id="6770856">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770860">if</span>&nbsp;<span class="builtinfunc" id="6770863">len</span><span class="op" id="6770866">(</span><span class="ident" id="6770867">helloServer</span><span class="op" id="6770878">)</span>&nbsp;<span class="op" id="6770880">!=</span>&nbsp;<span class="builtinfunc" id="6770883">len</span><span class="op" id="6770886">(</span><span class="ident" id="6770887">helloClient</span><span class="op" id="6770898">)</span>&nbsp;<span class="op" id="6770900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770904">t</span><span class="op" id="6770905">.</span><span class="ident" id="6770906">Fatalf</span><span class="op" id="6770912">(</span><span class="string" id="6770913">&#34;Hello&nbsp;server&nbsp;and&nbsp;client&nbsp;size&nbsp;mismatch&#34;</span><span class="op" id="6770952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770959">for</span>&nbsp;<span class="ident" id="6770963">i</span>&nbsp;<span class="op" id="6770965">:=</span>&nbsp;<span class="num" id="6770968">0</span><span class="op" id="6770969">;</span>&nbsp;<span class="ident" id="6770971">i</span>&nbsp;<span class="op" id="6770973">&lt;</span>&nbsp;<span class="builtinfunc" id="6770975">len</span><span class="op" id="6770978">(</span><span class="ident" id="6770979">helloServer</span><span class="op" id="6770990">)</span><span class="op" id="6770991">;</span>&nbsp;<span class="ident" id="6770993">i</span><span class="op" id="6770994">++</span>&nbsp;<span class="op" id="6770997">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771001">server</span>&nbsp;<span class="op" id="6771008">:=</span>&nbsp;<span class="ident" id="6771011">strings</span><span class="op" id="6771018">.</span><span class="ident" id="6771019">Join</span><span class="op" id="6771023">(</span><span class="ident" id="6771024">strings</span><span class="op" id="6771031">.</span><span class="ident" id="6771032">Split</span><span class="op" id="6771037">(</span><span class="ident" id="6771038">baseHelloServer</span><span class="op" id="6771053">+</span><span class="ident" id="6771054">helloServer</span><span class="op" id="6771065">[</span><span class="ident" id="6771066">i</span><span class="op" id="6771067">]</span><span class="op" id="6771068">,</span>&nbsp;<span class="string" id="6771070">&#34;\n&#34;</span><span class="op" id="6771074">)</span><span class="op" id="6771075">,</span>&nbsp;<span class="string" id="6771077">&#34;\r\n&#34;</span><span class="op" id="6771083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771087">client</span>&nbsp;<span class="op" id="6771094">:=</span>&nbsp;<span class="ident" id="6771097">strings</span><span class="op" id="6771104">.</span><span class="ident" id="6771105">Join</span><span class="op" id="6771109">(</span><span class="ident" id="6771110">strings</span><span class="op" id="6771117">.</span><span class="ident" id="6771118">Split</span><span class="op" id="6771123">(</span><span class="ident" id="6771124">baseHelloClient</span><span class="op" id="6771139">+</span><span class="ident" id="6771140">helloClient</span><span class="op" id="6771151">[</span><span class="ident" id="6771152">i</span><span class="op" id="6771153">]</span><span class="op" id="6771154">,</span>&nbsp;<span class="string" id="6771156">&#34;\n&#34;</span><span class="op" id="6771160">)</span><span class="op" id="6771161">,</span>&nbsp;<span class="string" id="6771163">&#34;\r\n&#34;</span><span class="op" id="6771169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771173">var</span>&nbsp;<span class="ident" id="6771177">cmdbuf</span>&nbsp;<span class="ident" id="6771184">bytes</span><span class="op" id="6771189">.</span><span class="ident" id="6771190">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771199">bcmdbuf</span>&nbsp;<span class="op" id="6771207">:=</span>&nbsp;<span class="ident" id="6771210">bufio</span><span class="op" id="6771215">.</span><span class="ident" id="6771216">NewWriter</span><span class="op" id="6771225">(</span><span class="op" id="6771226">&amp;</span><span class="ident" id="6771227">cmdbuf</span><span class="op" id="6771233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771237">var</span>&nbsp;<span class="ident" id="6771241">fake</span>&nbsp;<span class="ident" id="6771246">faker</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771254">fake</span><span class="op" id="6771258">.</span><span class="ident" id="6771259">ReadWriter</span>&nbsp;<span class="op" id="6771270">=</span>&nbsp;<span class="ident" id="6771272">bufio</span><span class="op" id="6771277">.</span><span class="ident" id="6771278">NewReadWriter</span><span class="op" id="6771291">(</span><span class="ident" id="6771292">bufio</span><span class="op" id="6771297">.</span><span class="ident" id="6771298">NewReader</span><span class="op" id="6771307">(</span><span class="ident" id="6771308">strings</span><span class="op" id="6771315">.</span><span class="ident" id="6771316">NewReader</span><span class="op" id="6771325">(</span><span class="ident" id="6771326">server</span><span class="op" id="6771332">)</span><span class="op" id="6771333">)</span><span class="op" id="6771334">,</span>&nbsp;<span class="ident" id="6771336">bcmdbuf</span><span class="op" id="6771343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771347">c</span><span class="op" id="6771348">,</span>&nbsp;<span class="ident" id="6771350">err</span>&nbsp;<span class="op" id="6771354">:=</span>&nbsp;<span class="ident" id="6771357">NewClient</span><span class="op" id="6771366">(</span><span class="ident" id="6771367">fake</span><span class="op" id="6771371">,</span>&nbsp;<span class="string" id="6771373">&#34;fake.host&#34;</span><span class="op" id="6771384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771388">if</span>&nbsp;<span class="ident" id="6771391">err</span>&nbsp;<span class="op" id="6771395">!=</span>&nbsp;<span class="builtintype" id="6771398">nil</span>&nbsp;<span class="op" id="6771402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771407">t</span><span class="op" id="6771408">.</span><span class="ident" id="6771409">Fatalf</span><span class="op" id="6771415">(</span><span class="string" id="6771416">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="6771431">,</span>&nbsp;<span class="ident" id="6771433">err</span><span class="op" id="6771436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6771440">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771444">defer</span>&nbsp;<span class="ident" id="6771450">c</span><span class="op" id="6771451">.</span><span class="ident" id="6771452">Close</span><span class="op" id="6771457">(</span><span class="op" id="6771458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771462">c</span><span class="op" id="6771463">.</span><span class="ident" id="6771464">localName</span>&nbsp;<span class="op" id="6771474">=</span>&nbsp;<span class="string" id="6771476">&#34;customhost&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771491">err</span>&nbsp;<span class="op" id="6771495">=</span>&nbsp;<span class="builtintype" id="6771497">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771504">switch</span>&nbsp;<span class="ident" id="6771511">i</span>&nbsp;<span class="op" id="6771513">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771517">case</span>&nbsp;<span class="num" id="6771522">0</span><span class="op" id="6771523">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771528">err</span>&nbsp;<span class="op" id="6771532">=</span>&nbsp;<span class="ident" id="6771534">c</span><span class="op" id="6771535">.</span><span class="ident" id="6771536">Hello</span><span class="op" id="6771541">(</span><span class="string" id="6771542">&#34;customhost&#34;</span><span class="op" id="6771554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771558">case</span>&nbsp;<span class="num" id="6771563">1</span><span class="op" id="6771564">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771569">err</span>&nbsp;<span class="op" id="6771573">=</span>&nbsp;<span class="ident" id="6771575">c</span><span class="op" id="6771576">.</span><span class="ident" id="6771577">StartTLS</span><span class="op" id="6771585">(</span><span class="builtintype" id="6771586">nil</span><span class="op" id="6771589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771594">if</span>&nbsp;<span class="ident" id="6771597">err</span><span class="op" id="6771600">.</span><span class="ident" id="6771601">Error</span><span class="op" id="6771606">(</span><span class="op" id="6771607">)</span>&nbsp;<span class="op" id="6771609">==</span>&nbsp;<span class="string" id="6771612">&#34;502&nbsp;Not&nbsp;implemented&#34;</span>&nbsp;<span class="op" id="6771634">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771640">err</span>&nbsp;<span class="op" id="6771644">=</span>&nbsp;<span class="builtintype" id="6771646">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6771653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771657">case</span>&nbsp;<span class="num" id="6771662">2</span><span class="op" id="6771663">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771668">err</span>&nbsp;<span class="op" id="6771672">=</span>&nbsp;<span class="ident" id="6771674">c</span><span class="op" id="6771675">.</span><span class="ident" id="6771676">Verify</span><span class="op" id="6771682">(</span><span class="string" id="6771683">&#34;test@example.com&#34;</span><span class="op" id="6771701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771705">case</span>&nbsp;<span class="num" id="6771710">3</span><span class="op" id="6771711">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771716">c</span><span class="op" id="6771717">.</span><span class="ident" id="6771718">tls</span>&nbsp;<span class="op" id="6771722">=</span>&nbsp;<span class="builtintype" id="6771724">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771732">c</span><span class="op" id="6771733">.</span><span class="ident" id="6771734">serverName</span>&nbsp;<span class="op" id="6771745">=</span>&nbsp;<span class="string" id="6771747">&#34;smtp.google.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771768">err</span>&nbsp;<span class="op" id="6771772">=</span>&nbsp;<span class="ident" id="6771774">c</span><span class="op" id="6771775">.</span><span class="ident" id="6771776">Auth</span><span class="op" id="6771780">(</span><span class="ident" id="6771781">PlainAuth</span><span class="op" id="6771790">(</span><span class="string" id="6771791">&#34;&#34;</span><span class="op" id="6771793">,</span>&nbsp;<span class="string" id="6771795">&#34;user&#34;</span><span class="op" id="6771801">,</span>&nbsp;<span class="string" id="6771803">&#34;pass&#34;</span><span class="op" id="6771809">,</span>&nbsp;<span class="string" id="6771811">&#34;smtp.google.com&#34;</span><span class="op" id="6771828">)</span><span class="op" id="6771829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771833">case</span>&nbsp;<span class="num" id="6771838">4</span><span class="op" id="6771839">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771844">err</span>&nbsp;<span class="op" id="6771848">=</span>&nbsp;<span class="ident" id="6771850">c</span><span class="op" id="6771851">.</span><span class="ident" id="6771852">Mail</span><span class="op" id="6771856">(</span><span class="string" id="6771857">&#34;test@example.com&#34;</span><span class="op" id="6771875">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771879">case</span>&nbsp;<span class="num" id="6771884">5</span><span class="op" id="6771885">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771890">ok</span><span class="op" id="6771892">,</span>&nbsp;<span class="ident" id="6771894">_</span>&nbsp;<span class="op" id="6771896">:=</span>&nbsp;<span class="ident" id="6771899">c</span><span class="op" id="6771900">.</span><span class="ident" id="6771901">Extension</span><span class="op" id="6771910">(</span><span class="string" id="6771911">&#34;feature&#34;</span><span class="op" id="6771920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771925">if</span>&nbsp;<span class="ident" id="6771928">ok</span>&nbsp;<span class="op" id="6771931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771937">t</span><span class="op" id="6771938">.</span><span class="ident" id="6771939">Errorf</span><span class="op" id="6771945">(</span><span class="string" id="6771946">&#34;Expected&nbsp;FEATURE&nbsp;not&nbsp;to&nbsp;be&nbsp;supported&#34;</span><span class="op" id="6771984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6771989">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771993">case</span>&nbsp;<span class="num" id="6771998">6</span><span class="op" id="6771999">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772004">err</span>&nbsp;<span class="op" id="6772008">=</span>&nbsp;<span class="ident" id="6772010">c</span><span class="op" id="6772011">.</span><span class="ident" id="6772012">Reset</span><span class="op" id="6772017">(</span><span class="op" id="6772018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772022">case</span>&nbsp;<span class="num" id="6772027">7</span><span class="op" id="6772028">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772033">err</span>&nbsp;<span class="op" id="6772037">=</span>&nbsp;<span class="ident" id="6772039">c</span><span class="op" id="6772040">.</span><span class="ident" id="6772041">Quit</span><span class="op" id="6772045">(</span><span class="op" id="6772046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772050">case</span>&nbsp;<span class="num" id="6772055">8</span><span class="op" id="6772056">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772061">err</span>&nbsp;<span class="op" id="6772065">=</span>&nbsp;<span class="ident" id="6772067">c</span><span class="op" id="6772068">.</span><span class="ident" id="6772069">Verify</span><span class="op" id="6772075">(</span><span class="string" id="6772076">&#34;test@example.com&#34;</span><span class="op" id="6772094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772099">if</span>&nbsp;<span class="ident" id="6772102">err</span>&nbsp;<span class="op" id="6772106">!=</span>&nbsp;<span class="builtintype" id="6772109">nil</span>&nbsp;<span class="op" id="6772113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772119">err</span>&nbsp;<span class="op" id="6772123">=</span>&nbsp;<span class="ident" id="6772125">c</span><span class="op" id="6772126">.</span><span class="ident" id="6772127">Hello</span><span class="op" id="6772132">(</span><span class="string" id="6772133">&#34;customhost&#34;</span><span class="op" id="6772145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772151">if</span>&nbsp;<span class="ident" id="6772154">err</span>&nbsp;<span class="op" id="6772158">!=</span>&nbsp;<span class="builtintype" id="6772161">nil</span>&nbsp;<span class="op" id="6772165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772172">t</span><span class="op" id="6772173">.</span><span class="ident" id="6772174">Errorf</span><span class="op" id="6772180">(</span><span class="string" id="6772181">&#34;Want&nbsp;error,&nbsp;got&nbsp;none&#34;</span><span class="op" id="6772203">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772218">default</span><span class="op" id="6772225">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772230">t</span><span class="op" id="6772231">.</span><span class="ident" id="6772232">Fatalf</span><span class="op" id="6772238">(</span><span class="string" id="6772239">&#34;Unhandled&nbsp;command&#34;</span><span class="op" id="6772258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772262">}</span><br>
<span class="lineno">370</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772267">if</span>&nbsp;<span class="ident" id="6772270">err</span>&nbsp;<span class="op" id="6772274">!=</span>&nbsp;<span class="builtintype" id="6772277">nil</span>&nbsp;<span class="op" id="6772281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772286">t</span><span class="op" id="6772287">.</span><span class="ident" id="6772288">Errorf</span><span class="op" id="6772294">(</span><span class="string" id="6772295">&#34;Command&nbsp;%d&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6772318">,</span>&nbsp;<span class="ident" id="6772320">i</span><span class="op" id="6772321">,</span>&nbsp;<span class="ident" id="6772323">err</span><span class="op" id="6772326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772335">bcmdbuf</span><span class="op" id="6772342">.</span><span class="ident" id="6772343">Flush</span><span class="op" id="6772348">(</span><span class="op" id="6772349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772353">actualcmds</span>&nbsp;<span class="op" id="6772364">:=</span>&nbsp;<span class="ident" id="6772367">cmdbuf</span><span class="op" id="6772373">.</span><span class="ident" id="6772374">String</span><span class="op" id="6772380">(</span><span class="op" id="6772381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772385">if</span>&nbsp;<span class="ident" id="6772388">client</span>&nbsp;<span class="op" id="6772395">!=</span>&nbsp;<span class="ident" id="6772398">actualcmds</span>&nbsp;<span class="op" id="6772409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772414">t</span><span class="op" id="6772415">.</span><span class="ident" id="6772416">Errorf</span><span class="op" id="6772422">(</span><span class="string" id="6772423">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6772448">,</span>&nbsp;<span class="ident" id="6772450">actualcmds</span><span class="op" id="6772460">,</span>&nbsp;<span class="ident" id="6772462">client</span><span class="op" id="6772468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772472">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772475">}</span><br>
<span class="lineno"></span><span class="op" id="6772477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6772480">var</span>&nbsp;<span class="ident" id="6772484">baseHelloServer</span>&nbsp;<span class="op" id="6772500">=</span>&nbsp;<span class="string" id="6772502">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno">385</span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;FEATURE<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6772576">var</span>&nbsp;<span class="ident" id="6772580">helloServer</span>&nbsp;<span class="op" id="6772592">=</span>&nbsp;<span class="op" id="6772594">[</span><span class="op" id="6772595">]</span><span class="builtintype" id="6772596">string</span><span class="op" id="6772602">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772605">&#34;&#34;</span><span class="op" id="6772607">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772610">&#34;502&nbsp;Not&nbsp;implemented\n&#34;</span><span class="op" id="6772633">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772636">&#34;250&nbsp;User&nbsp;is&nbsp;valid\n&#34;</span><span class="op" id="6772657">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772660">&#34;235&nbsp;Accepted\n&#34;</span><span class="op" id="6772676">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772679">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="6772696">,</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772699">&#34;&#34;</span><span class="op" id="6772701">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772704">&#34;250&nbsp;Reset&nbsp;ok\n&#34;</span><span class="op" id="6772720">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772723">&#34;221&nbsp;Goodbye\n&#34;</span><span class="op" id="6772738">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772741">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="6772758">,</span><br>
<span class="lineno"></span><span class="op" id="6772760">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="6772763">var</span>&nbsp;<span class="ident" id="6772767">baseHelloClient</span>&nbsp;<span class="op" id="6772783">=</span>&nbsp;<span class="string" id="6772785">`EHLO&nbsp;customhost<br>
<span class="lineno"></span>HELO&nbsp;customhost<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="6772821">var</span>&nbsp;<span class="ident" id="6772825">helloClient</span>&nbsp;<span class="op" id="6772837">=</span>&nbsp;<span class="op" id="6772839">[</span><span class="op" id="6772840">]</span><span class="builtintype" id="6772841">string</span><span class="op" id="6772847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772850">&#34;&#34;</span><span class="op" id="6772852">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772855">&#34;STARTTLS\n&#34;</span><span class="op" id="6772867">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772870">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="6772895">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772898">&#34;AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==\n&#34;</span><span class="op" id="6772929">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772932">&#34;MAIL&nbsp;FROM:&lt;test@example.com&gt;\n&#34;</span><span class="op" id="6772964">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772967">&#34;&#34;</span><span class="op" id="6772969">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772972">&#34;RSET\n&#34;</span><span class="op" id="6772980">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772983">&#34;QUIT\n&#34;</span><span class="op" id="6772991">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6772994">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="6773019">,</span><br>
<span class="lineno">415</span><span class="op" id="6773021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6773024">func</span>&nbsp;<span class="ident" id="6773029">TestSendMail</span><span class="op" id="6773041">(</span><span class="ident" id="6773042">t</span>&nbsp;<span class="op" id="6773044">*</span><span class="ident" id="6773045">testing</span><span class="op" id="6773052">.</span><span class="ident" id="6773053">T</span><span class="op" id="6773054">)</span>&nbsp;<span class="op" id="6773056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773059">server</span>&nbsp;<span class="op" id="6773066">:=</span>&nbsp;<span class="ident" id="6773069">strings</span><span class="op" id="6773076">.</span><span class="ident" id="6773077">Join</span><span class="op" id="6773081">(</span><span class="ident" id="6773082">strings</span><span class="op" id="6773089">.</span><span class="ident" id="6773090">Split</span><span class="op" id="6773095">(</span><span class="ident" id="6773096">sendMailServer</span><span class="op" id="6773110">,</span>&nbsp;<span class="string" id="6773112">&#34;\n&#34;</span><span class="op" id="6773116">)</span><span class="op" id="6773117">,</span>&nbsp;<span class="string" id="6773119">&#34;\r\n&#34;</span><span class="op" id="6773125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773128">client</span>&nbsp;<span class="op" id="6773135">:=</span>&nbsp;<span class="ident" id="6773138">strings</span><span class="op" id="6773145">.</span><span class="ident" id="6773146">Join</span><span class="op" id="6773150">(</span><span class="ident" id="6773151">strings</span><span class="op" id="6773158">.</span><span class="ident" id="6773159">Split</span><span class="op" id="6773164">(</span><span class="ident" id="6773165">sendMailClient</span><span class="op" id="6773179">,</span>&nbsp;<span class="string" id="6773181">&#34;\n&#34;</span><span class="op" id="6773185">)</span><span class="op" id="6773186">,</span>&nbsp;<span class="string" id="6773188">&#34;\r\n&#34;</span><span class="op" id="6773194">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773197">var</span>&nbsp;<span class="ident" id="6773201">cmdbuf</span>&nbsp;<span class="ident" id="6773208">bytes</span><span class="op" id="6773213">.</span><span class="ident" id="6773214">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773222">bcmdbuf</span>&nbsp;<span class="op" id="6773230">:=</span>&nbsp;<span class="ident" id="6773233">bufio</span><span class="op" id="6773238">.</span><span class="ident" id="6773239">NewWriter</span><span class="op" id="6773248">(</span><span class="op" id="6773249">&amp;</span><span class="ident" id="6773250">cmdbuf</span><span class="op" id="6773256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773259">l</span><span class="op" id="6773260">,</span>&nbsp;<span class="ident" id="6773262">err</span>&nbsp;<span class="op" id="6773266">:=</span>&nbsp;<span class="ident" id="6773269">net</span><span class="op" id="6773272">.</span><span class="ident" id="6773273">Listen</span><span class="op" id="6773279">(</span><span class="string" id="6773280">&#34;tcp&#34;</span><span class="op" id="6773285">,</span>&nbsp;<span class="string" id="6773287">&#34;127.0.0.1:0&#34;</span><span class="op" id="6773300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773303">if</span>&nbsp;<span class="ident" id="6773306">err</span>&nbsp;<span class="op" id="6773310">!=</span>&nbsp;<span class="builtintype" id="6773313">nil</span>&nbsp;<span class="op" id="6773317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773321">t</span><span class="op" id="6773322">.</span><span class="ident" id="6773323">Fatalf</span><span class="op" id="6773329">(</span><span class="string" id="6773330">&#34;Unable&nbsp;to&nbsp;to&nbsp;create&nbsp;listener:&nbsp;%v&#34;</span><span class="op" id="6773364">,</span>&nbsp;<span class="ident" id="6773366">err</span><span class="op" id="6773369">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6773372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773375">defer</span>&nbsp;<span class="ident" id="6773381">l</span><span class="op" id="6773382">.</span><span class="ident" id="6773383">Close</span><span class="op" id="6773388">(</span><span class="op" id="6773389">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6773393">//&nbsp;prevent&nbsp;data&nbsp;race&nbsp;on&nbsp;bcmdbuf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773426">var</span>&nbsp;<span class="ident" id="6773430">done</span>&nbsp;<span class="op" id="6773435">=</span>&nbsp;<span class="builtinfunc" id="6773437">make</span><span class="op" id="6773441">(</span><span class="keyword" id="6773442">chan</span>&nbsp;<span class="keyword" id="6773447">struct</span><span class="op" id="6773453">{</span><span class="op" id="6773454">}</span><span class="op" id="6773455">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773458">go</span>&nbsp;<span class="keyword" id="6773461">func</span><span class="op" id="6773465">(</span><span class="ident" id="6773466">data</span>&nbsp;<span class="op" id="6773471">[</span><span class="op" id="6773472">]</span><span class="builtintype" id="6773473">string</span><span class="op" id="6773479">)</span>&nbsp;<span class="op" id="6773481">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773486">defer</span>&nbsp;<span class="builtinfunc" id="6773492">close</span><span class="op" id="6773497">(</span><span class="ident" id="6773498">done</span><span class="op" id="6773502">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773507">conn</span><span class="op" id="6773511">,</span>&nbsp;<span class="ident" id="6773513">err</span>&nbsp;<span class="op" id="6773517">:=</span>&nbsp;<span class="ident" id="6773520">l</span><span class="op" id="6773521">.</span><span class="ident" id="6773522">Accept</span><span class="op" id="6773528">(</span><span class="op" id="6773529">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773533">if</span>&nbsp;<span class="ident" id="6773536">err</span>&nbsp;<span class="op" id="6773540">!=</span>&nbsp;<span class="builtintype" id="6773543">nil</span>&nbsp;<span class="op" id="6773547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773552">t</span><span class="op" id="6773553">.</span><span class="ident" id="6773554">Errorf</span><span class="op" id="6773560">(</span><span class="string" id="6773561">&#34;Accept&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6773579">,</span>&nbsp;<span class="ident" id="6773581">err</span><span class="op" id="6773584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773589">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6773598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773602">defer</span>&nbsp;<span class="ident" id="6773608">conn</span><span class="op" id="6773612">.</span><span class="ident" id="6773613">Close</span><span class="op" id="6773618">(</span><span class="op" id="6773619">)</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773624">tc</span>&nbsp;<span class="op" id="6773627">:=</span>&nbsp;<span class="ident" id="6773630">textproto</span><span class="op" id="6773639">.</span><span class="ident" id="6773640">NewConn</span><span class="op" id="6773647">(</span><span class="ident" id="6773648">conn</span><span class="op" id="6773652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773656">for</span>&nbsp;<span class="ident" id="6773660">i</span>&nbsp;<span class="op" id="6773662">:=</span>&nbsp;<span class="num" id="6773665">0</span><span class="op" id="6773666">;</span>&nbsp;<span class="ident" id="6773668">i</span>&nbsp;<span class="op" id="6773670">&lt;</span>&nbsp;<span class="builtinfunc" id="6773672">len</span><span class="op" id="6773675">(</span><span class="ident" id="6773676">data</span><span class="op" id="6773680">)</span>&nbsp;<span class="op" id="6773682">&amp;&amp;</span>&nbsp;<span class="ident" id="6773685">data</span><span class="op" id="6773689">[</span><span class="ident" id="6773690">i</span><span class="op" id="6773691">]</span>&nbsp;<span class="op" id="6773693">!=</span>&nbsp;<span class="string" id="6773696">&#34;&#34;</span><span class="op" id="6773698">;</span>&nbsp;<span class="ident" id="6773700">i</span><span class="op" id="6773701">++</span>&nbsp;<span class="op" id="6773704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773709">tc</span><span class="op" id="6773711">.</span><span class="ident" id="6773712">PrintfLine</span><span class="op" id="6773722">(</span><span class="ident" id="6773723">data</span><span class="op" id="6773727">[</span><span class="ident" id="6773728">i</span><span class="op" id="6773729">]</span><span class="op" id="6773730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773735">for</span>&nbsp;<span class="builtinfunc" id="6773739">len</span><span class="op" id="6773742">(</span><span class="ident" id="6773743">data</span><span class="op" id="6773747">[</span><span class="ident" id="6773748">i</span><span class="op" id="6773749">]</span><span class="op" id="6773750">)</span>&nbsp;<span class="op" id="6773752">&gt;=</span>&nbsp;<span class="num" id="6773755">4</span>&nbsp;<span class="op" id="6773757">&amp;&amp;</span>&nbsp;<span class="ident" id="6773760">data</span><span class="op" id="6773764">[</span><span class="ident" id="6773765">i</span><span class="op" id="6773766">]</span><span class="op" id="6773767">[</span><span class="num" id="6773768">3</span><span class="op" id="6773769">]</span>&nbsp;<span class="op" id="6773771">==</span>&nbsp;<span class="string" id="6773774">&#39;-&#39;</span>&nbsp;<span class="op" id="6773778">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773784">i</span><span class="op" id="6773785">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773792">tc</span><span class="op" id="6773794">.</span><span class="ident" id="6773795">PrintfLine</span><span class="op" id="6773805">(</span><span class="ident" id="6773806">data</span><span class="op" id="6773810">[</span><span class="ident" id="6773811">i</span><span class="op" id="6773812">]</span><span class="op" id="6773813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6773818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773823">if</span>&nbsp;<span class="ident" id="6773826">data</span><span class="op" id="6773830">[</span><span class="ident" id="6773831">i</span><span class="op" id="6773832">]</span>&nbsp;<span class="op" id="6773834">==</span>&nbsp;<span class="string" id="6773837">&#34;221&nbsp;Goodbye&#34;</span>&nbsp;<span class="op" id="6773851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773857">return</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6773867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773872">read</span>&nbsp;<span class="op" id="6773877">:=</span>&nbsp;<span class="builtintype" id="6773880">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773889">for</span>&nbsp;<span class="op" id="6773893">!</span><span class="ident" id="6773894">read</span>&nbsp;<span class="op" id="6773899">||</span>&nbsp;<span class="ident" id="6773902">data</span><span class="op" id="6773906">[</span><span class="ident" id="6773907">i</span><span class="op" id="6773908">]</span>&nbsp;<span class="op" id="6773910">==</span>&nbsp;<span class="string" id="6773913">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="6773928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773934">msg</span><span class="op" id="6773937">,</span>&nbsp;<span class="ident" id="6773939">err</span>&nbsp;<span class="op" id="6773943">:=</span>&nbsp;<span class="ident" id="6773946">tc</span><span class="op" id="6773948">.</span><span class="ident" id="6773949">ReadLine</span><span class="op" id="6773957">(</span><span class="op" id="6773958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773964">bcmdbuf</span><span class="op" id="6773971">.</span><span class="ident" id="6773972">Write</span><span class="op" id="6773977">(</span><span class="op" id="6773978">[</span><span class="op" id="6773979">]</span><span class="builtintype" id="6773980">byte</span><span class="op" id="6773984">(</span><span class="ident" id="6773985">msg</span>&nbsp;<span class="op" id="6773989">+</span>&nbsp;<span class="string" id="6773991">&#34;\r\n&#34;</span><span class="op" id="6773997">)</span><span class="op" id="6773998">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6774004">read</span>&nbsp;<span class="op" id="6774009">=</span>&nbsp;<span class="builtintype" id="6774011">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774020">if</span>&nbsp;<span class="ident" id="6774023">err</span>&nbsp;<span class="op" id="6774027">!=</span>&nbsp;<span class="builtintype" id="6774030">nil</span>&nbsp;<span class="op" id="6774034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6774041">t</span><span class="op" id="6774042">.</span><span class="ident" id="6774043">Errorf</span><span class="op" id="6774049">(</span><span class="string" id="6774050">&#34;Read&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6774066">,</span>&nbsp;<span class="ident" id="6774068">err</span><span class="op" id="6774071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774078">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774089">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774095">if</span>&nbsp;<span class="ident" id="6774098">data</span><span class="op" id="6774102">[</span><span class="ident" id="6774103">i</span><span class="op" id="6774104">]</span>&nbsp;<span class="op" id="6774106">==</span>&nbsp;<span class="string" id="6774109">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="6774124">&amp;&amp;</span>&nbsp;<span class="ident" id="6774127">msg</span>&nbsp;<span class="op" id="6774131">==</span>&nbsp;<span class="string" id="6774134">&#34;.&#34;</span>&nbsp;<span class="op" id="6774138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774145">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774164">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774167">}</span><span class="op" id="6774168">(</span><span class="ident" id="6774169">strings</span><span class="op" id="6774176">.</span><span class="ident" id="6774177">Split</span><span class="op" id="6774182">(</span><span class="ident" id="6774183">server</span><span class="op" id="6774189">,</span>&nbsp;<span class="string" id="6774191">&#34;\r\n&#34;</span><span class="op" id="6774197">)</span><span class="op" id="6774198">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6774202">err</span>&nbsp;<span class="op" id="6774206">=</span>&nbsp;<span class="ident" id="6774208">SendMail</span><span class="op" id="6774216">(</span><span class="ident" id="6774217">l</span><span class="op" id="6774218">.</span><span class="ident" id="6774219">Addr</span><span class="op" id="6774223">(</span><span class="op" id="6774224">)</span><span class="op" id="6774225">.</span><span class="ident" id="6774226">String</span><span class="op" id="6774232">(</span><span class="op" id="6774233">)</span><span class="op" id="6774234">,</span>&nbsp;<span class="builtintype" id="6774236">nil</span><span class="op" id="6774239">,</span>&nbsp;<span class="string" id="6774241">&#34;test@example.com&#34;</span><span class="op" id="6774259">,</span>&nbsp;<span class="op" id="6774261">[</span><span class="op" id="6774262">]</span><span class="builtintype" id="6774263">string</span><span class="op" id="6774269">{</span><span class="string" id="6774270">&#34;other@example.com&#34;</span><span class="op" id="6774289">}</span><span class="op" id="6774290">,</span>&nbsp;<span class="op" id="6774292">[</span><span class="op" id="6774293">]</span><span class="builtintype" id="6774294">byte</span><span class="op" id="6774298">(</span><span class="ident" id="6774299">strings</span><span class="op" id="6774306">.</span><span class="ident" id="6774307">Replace</span><span class="op" id="6774314">(</span><span class="string" id="6774315">`From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno">470</span><br>
<span class="lineno"></span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>`</span><span class="op" id="6774414">,</span>&nbsp;<span class="string" id="6774416">&#34;\n&#34;</span><span class="op" id="6774420">,</span>&nbsp;<span class="string" id="6774422">&#34;\r\n&#34;</span><span class="op" id="6774428">,</span>&nbsp;<span class="op" id="6774430">-</span><span class="num" id="6774431">1</span><span class="op" id="6774432">)</span><span class="op" id="6774433">)</span><span class="op" id="6774434">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774438">if</span>&nbsp;<span class="ident" id="6774441">err</span>&nbsp;<span class="op" id="6774445">!=</span>&nbsp;<span class="builtintype" id="6774448">nil</span>&nbsp;<span class="op" id="6774452">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6774456">t</span><span class="op" id="6774457">.</span><span class="ident" id="6774458">Errorf</span><span class="op" id="6774464">(</span><span class="string" id="6774465">&#34;%v&#34;</span><span class="op" id="6774469">,</span>&nbsp;<span class="ident" id="6774471">err</span><span class="op" id="6774474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774481">&lt;-</span><span class="ident" id="6774483">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6774489">bcmdbuf</span><span class="op" id="6774496">.</span><span class="ident" id="6774497">Flush</span><span class="op" id="6774502">(</span><span class="op" id="6774503">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6774506">actualcmds</span>&nbsp;<span class="op" id="6774517">:=</span>&nbsp;<span class="ident" id="6774520">cmdbuf</span><span class="op" id="6774526">.</span><span class="ident" id="6774527">String</span><span class="op" id="6774533">(</span><span class="op" id="6774534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774537">if</span>&nbsp;<span class="ident" id="6774540">client</span>&nbsp;<span class="op" id="6774547">!=</span>&nbsp;<span class="ident" id="6774550">actualcmds</span>&nbsp;<span class="op" id="6774561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6774565">t</span><span class="op" id="6774566">.</span><span class="ident" id="6774567">Errorf</span><span class="op" id="6774573">(</span><span class="string" id="6774574">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6774599">,</span>&nbsp;<span class="ident" id="6774601">actualcmds</span><span class="op" id="6774611">,</span>&nbsp;<span class="ident" id="6774613">client</span><span class="op" id="6774619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774622">}</span><br>
<span class="lineno"></span><span class="op" id="6774624">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="6774627">var</span>&nbsp;<span class="ident" id="6774631">sendMailServer</span>&nbsp;<span class="op" id="6774646">=</span>&nbsp;<span class="string" id="6774648">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno"></span>250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;ok<br>
<span class="lineno">490</span>250&nbsp;Receiver&nbsp;ok<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;ok<br>
<span class="lineno"></span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="keyword" id="6774777">var</span>&nbsp;<span class="ident" id="6774781">sendMailClient</span>&nbsp;<span class="op" id="6774796">=</span>&nbsp;<span class="string" id="6774798">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;test@example.com&gt;<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;other@example.com&gt;<br>
<span class="lineno">500</span>DATA<br>
<span class="lineno"></span>From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno"></span><br>
<span class="lineno">505</span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="6774998">func</span>&nbsp;<span class="ident" id="6775003">TestAuthFailed</span><span class="op" id="6775017">(</span><span class="ident" id="6775018">t</span>&nbsp;<span class="op" id="6775020">*</span><span class="ident" id="6775021">testing</span><span class="op" id="6775028">.</span><span class="ident" id="6775029">T</span><span class="op" id="6775030">)</span>&nbsp;<span class="op" id="6775032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6775035">server</span>&nbsp;<span class="op" id="6775042">:=</span>&nbsp;<span class="ident" id="6775045">strings</span><span class="op" id="6775052">.</span><span class="ident" id="6775053">Join</span><span class="op" id="6775057">(</span><span class="ident" id="6775058">strings</span><span class="op" id="6775065">.</span><span class="ident" id="6775066">Split</span><span class="op" id="6775071">(</span><span class="ident" id="6775072">authFailedServer</span><span class="op" id="6775088">,</span>&nbsp;<span class="string" id="6775090">&#34;\n&#34;</span><span class="op" id="6775094">)</span><span class="op" id="6775095">,</span>&nbsp;<span class="string" id="6775097">&#34;\r\n&#34;</span><span class="op" id="6775103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6775106">client</span>&nbsp;<span class="op" id="6775113">:=</span>&nbsp;<span class="ident" id="6775116">strings</span><span class="op" id="6775123">.</span><span class="ident" id="6775124">Join</span><span class="op" id="6775128">(</span><span class="ident" id="6775129">strings</span><span class="op" id="6775136">.</span><span class="ident" id="6775137">Split</span><span class="op" id="6775142">(</span><span class="ident" id="6775143">authFailedClient</span><span class="op" id="6775159">,</span>&nbsp;<span class="string" id="6775161">&#34;\n&#34;</span><span class="op" id="6775165">)</span><span class="op" id="6775166">,</span>&nbsp;<span class="string" id="6775168">&#34;\r\n&#34;</span><span class="op" id="6775174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6775177">var</span>&nbsp;<span class="ident" id="6775181">cmdbuf</span>&nbsp;<span class="ident" id="6775188">bytes</span><span class="op" id="6775193">.</span><span class="ident" id="6775194">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6775202">bcmdbuf</span>&nbsp;<span class="op" id="6775210">:=</span>&nbsp;<span class="ident" id="6775213">bufio</span><span class="op" id="6775218">.</span><span class="ident" id="6775219">NewWriter</span><span class="op" id="6775228">(</span><span class="op" id="6775229">&amp;</span><span class="ident" id="6775230">cmdbuf</span><span class="op" id="6775236">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6775239">var</span>&nbsp;<span class="ident" id="6775243">fake</span>&nbsp;<span class="ident" id="6775248">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6775255">fake</span><span class="op" id="6775259">.</span><span class="ident" id="6775260">ReadWriter</span>&nbsp;<span class="op" id="6775271">=</span>&nbsp;<span class="ident" id="6775273">bufio</span><span class="op" id="6775278">.</span><span class="ident" id="6775279">NewReadWriter</span><span class="op" id="6775292">(</span><span class="ident" id="6775293">bufio</span><span class="op" id="6775298">.</span><span class="ident" id="6775299">NewReader</span><span class="op" id="6775308">(</span><span class="ident" id="6775309">strings</span><span class="op" id="6775316">.</span><span class="ident" id="6775317">NewReader</span><span class="op" id="6775326">(</span><span class="ident" id="6775327">server</span><span class="op" id="6775333">)</span><span class="op" id="6775334">)</span><span class="op" id="6775335">,</span>&nbsp;<span class="ident" id="6775337">bcmdbuf</span><span class="op" id="6775344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6775347">c</span><span class="op" id="6775348">,</span>&nbsp;<span class="ident" id="6775350">err</span>&nbsp;<span class="op" id="6775354">:=</span>&nbsp;<span class="ident" id="6775357">NewClient</span><span class="op" id="6775366">(</span><span class="ident" id="6775367">fake</span><span class="op" id="6775371">,</span>&nbsp;<span class="string" id="6775373">&#34;fake.host&#34;</span><span class="op" id="6775384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6775387">if</span>&nbsp;<span class="ident" id="6775390">err</span>&nbsp;<span class="op" id="6775394">!=</span>&nbsp;<span class="builtintype" id="6775397">nil</span>&nbsp;<span class="op" id="6775401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6775405">t</span><span class="op" id="6775406">.</span><span class="ident" id="6775407">Fatalf</span><span class="op" id="6775413">(</span><span class="string" id="6775414">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="6775429">,</span>&nbsp;<span class="ident" id="6775431">err</span><span class="op" id="6775434">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6775437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6775440">defer</span>&nbsp;<span class="ident" id="6775446">c</span><span class="op" id="6775447">.</span><span class="ident" id="6775448">Close</span><span class="op" id="6775453">(</span><span class="op" id="6775454">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6775458">c</span><span class="op" id="6775459">.</span><span class="ident" id="6775460">tls</span>&nbsp;<span class="op" id="6775464">=</span>&nbsp;<span class="builtintype" id="6775466">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6775472">c</span><span class="op" id="6775473">.</span><span class="ident" id="6775474">serverName</span>&nbsp;<span class="op" id="6775485">=</span>&nbsp;<span class="string" id="6775487">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6775506">err</span>&nbsp;<span class="op" id="6775510">=</span>&nbsp;<span class="ident" id="6775512">c</span><span class="op" id="6775513">.</span><span class="ident" id="6775514">Auth</span><span class="op" id="6775518">(</span><span class="ident" id="6775519">PlainAuth</span><span class="op" id="6775528">(</span><span class="string" id="6775529">&#34;&#34;</span><span class="op" id="6775531">,</span>&nbsp;<span class="string" id="6775533">&#34;user&#34;</span><span class="op" id="6775539">,</span>&nbsp;<span class="string" id="6775541">&#34;pass&#34;</span><span class="op" id="6775547">,</span>&nbsp;<span class="string" id="6775549">&#34;smtp.google.com&#34;</span><span class="op" id="6775566">)</span><span class="op" id="6775567">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6775571">if</span>&nbsp;<span class="ident" id="6775574">err</span>&nbsp;<span class="op" id="6775578">==</span>&nbsp;<span class="builtintype" id="6775581">nil</span>&nbsp;<span class="op" id="6775585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6775589">t</span><span class="op" id="6775590">.</span><span class="ident" id="6775591">Error</span><span class="op" id="6775596">(</span><span class="string" id="6775597">&#34;Auth:&nbsp;expected&nbsp;error;&nbsp;got&nbsp;none&#34;</span><span class="op" id="6775629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6775632">}</span>&nbsp;<span class="keyword" id="6775634">else</span>&nbsp;<span class="keyword" id="6775639">if</span>&nbsp;<span class="ident" id="6775642">err</span><span class="op" id="6775645">.</span><span class="ident" id="6775646">Error</span><span class="op" id="6775651">(</span><span class="op" id="6775652">)</span>&nbsp;<span class="op" id="6775654">!=</span>&nbsp;<span class="string" id="6775657">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span>&nbsp;<span class="op" id="6775711">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6775715">t</span><span class="op" id="6775716">.</span><span class="ident" id="6775717">Errorf</span><span class="op" id="6775723">(</span><span class="string" id="6775724">&#34;Auth:&nbsp;got&nbsp;error:&nbsp;%v,&nbsp;want:&nbsp;%s&#34;</span><span class="op" id="6775755">,</span>&nbsp;<span class="ident" id="6775757">err</span><span class="op" id="6775760">,</span>&nbsp;<span class="string" id="6775762">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span><span class="op" id="6775815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6775818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6775822">bcmdbuf</span><span class="op" id="6775829">.</span><span class="ident" id="6775830">Flush</span><span class="op" id="6775835">(</span><span class="op" id="6775836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6775839">actualcmds</span>&nbsp;<span class="op" id="6775850">:=</span>&nbsp;<span class="ident" id="6775853">cmdbuf</span><span class="op" id="6775859">.</span><span class="ident" id="6775860">String</span><span class="op" id="6775866">(</span><span class="op" id="6775867">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6775870">if</span>&nbsp;<span class="ident" id="6775873">client</span>&nbsp;<span class="op" id="6775880">!=</span>&nbsp;<span class="ident" id="6775883">actualcmds</span>&nbsp;<span class="op" id="6775894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6775898">t</span><span class="op" id="6775899">.</span><span class="ident" id="6775900">Errorf</span><span class="op" id="6775906">(</span><span class="string" id="6775907">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6775932">,</span>&nbsp;<span class="ident" id="6775934">actualcmds</span><span class="op" id="6775944">,</span>&nbsp;<span class="ident" id="6775946">client</span><span class="op" id="6775952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6775955">}</span><br>
<span class="lineno"></span><span class="op" id="6775957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">540</span><span class="keyword" id="6775960">var</span>&nbsp;<span class="ident" id="6775964">authFailedServer</span>&nbsp;<span class="op" id="6775981">=</span>&nbsp;<span class="string" id="6775983">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>535-Invalid&nbsp;credentials<br>
<span class="lineno"></span>535&nbsp;please&nbsp;see&nbsp;www.example.com<br>
<span class="lineno">545</span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6776125">var</span>&nbsp;<span class="ident" id="6776129">authFailedClient</span>&nbsp;<span class="op" id="6776146">=</span>&nbsp;<span class="string" id="6776148">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno">550</span>*<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6776202">func</span>&nbsp;<span class="ident" id="6776207">TestTLSClient</span><span class="op" id="6776220">(</span><span class="ident" id="6776221">t</span>&nbsp;<span class="op" id="6776223">*</span><span class="ident" id="6776224">testing</span><span class="op" id="6776231">.</span><span class="ident" id="6776232">T</span><span class="op" id="6776233">)</span>&nbsp;<span class="op" id="6776235">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776238">ln</span>&nbsp;<span class="op" id="6776241">:=</span>&nbsp;<span class="ident" id="6776244">newLocalListener</span><span class="op" id="6776260">(</span><span class="ident" id="6776261">t</span><span class="op" id="6776262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6776265">defer</span>&nbsp;<span class="ident" id="6776271">ln</span><span class="op" id="6776273">.</span><span class="ident" id="6776274">Close</span><span class="op" id="6776279">(</span><span class="op" id="6776280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776283">errc</span>&nbsp;<span class="op" id="6776288">:=</span>&nbsp;<span class="builtinfunc" id="6776291">make</span><span class="op" id="6776295">(</span><span class="keyword" id="6776296">chan</span>&nbsp;<span class="builtintype" id="6776301">error</span><span class="op" id="6776306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6776309">go</span>&nbsp;<span class="keyword" id="6776312">func</span><span class="op" id="6776316">(</span><span class="op" id="6776317">)</span>&nbsp;<span class="op" id="6776319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776323">errc</span>&nbsp;<span class="op" id="6776328">&lt;-</span>&nbsp;<span class="ident" id="6776331">sendMail</span><span class="op" id="6776339">(</span><span class="ident" id="6776340">ln</span><span class="op" id="6776342">.</span><span class="ident" id="6776343">Addr</span><span class="op" id="6776347">(</span><span class="op" id="6776348">)</span><span class="op" id="6776349">.</span><span class="ident" id="6776350">String</span><span class="op" id="6776356">(</span><span class="op" id="6776357">)</span><span class="op" id="6776358">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6776361">}</span><span class="op" id="6776362">(</span><span class="op" id="6776363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776366">conn</span><span class="op" id="6776370">,</span>&nbsp;<span class="ident" id="6776372">err</span>&nbsp;<span class="op" id="6776376">:=</span>&nbsp;<span class="ident" id="6776379">ln</span><span class="op" id="6776381">.</span><span class="ident" id="6776382">Accept</span><span class="op" id="6776388">(</span><span class="op" id="6776389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6776392">if</span>&nbsp;<span class="ident" id="6776395">err</span>&nbsp;<span class="op" id="6776399">!=</span>&nbsp;<span class="builtintype" id="6776402">nil</span>&nbsp;<span class="op" id="6776406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776410">t</span><span class="op" id="6776411">.</span><span class="ident" id="6776412">Fatalf</span><span class="op" id="6776418">(</span><span class="string" id="6776419">&#34;failed&nbsp;to&nbsp;accept&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="6776452">,</span>&nbsp;<span class="ident" id="6776454">err</span><span class="op" id="6776457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6776460">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6776463">defer</span>&nbsp;<span class="ident" id="6776469">conn</span><span class="op" id="6776473">.</span><span class="ident" id="6776474">Close</span><span class="op" id="6776479">(</span><span class="op" id="6776480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6776483">if</span>&nbsp;<span class="ident" id="6776486">err</span>&nbsp;<span class="op" id="6776490">:=</span>&nbsp;<span class="ident" id="6776493">serverHandle</span><span class="op" id="6776505">(</span><span class="ident" id="6776506">conn</span><span class="op" id="6776510">,</span>&nbsp;<span class="ident" id="6776512">t</span><span class="op" id="6776513">)</span><span class="op" id="6776514">;</span>&nbsp;<span class="ident" id="6776516">err</span>&nbsp;<span class="op" id="6776520">!=</span>&nbsp;<span class="builtintype" id="6776523">nil</span>&nbsp;<span class="op" id="6776527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776531">t</span><span class="op" id="6776532">.</span><span class="ident" id="6776533">Fatalf</span><span class="op" id="6776539">(</span><span class="string" id="6776540">&#34;failed&nbsp;to&nbsp;handle&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="6776573">,</span>&nbsp;<span class="ident" id="6776575">err</span><span class="op" id="6776578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6776581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6776584">if</span>&nbsp;<span class="ident" id="6776587">err</span>&nbsp;<span class="op" id="6776591">:=</span>&nbsp;<span class="op" id="6776594">&lt;-</span><span class="ident" id="6776596">errc</span><span class="op" id="6776600">;</span>&nbsp;<span class="ident" id="6776602">err</span>&nbsp;<span class="op" id="6776606">!=</span>&nbsp;<span class="builtintype" id="6776609">nil</span>&nbsp;<span class="op" id="6776613">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776617">t</span><span class="op" id="6776618">.</span><span class="ident" id="6776619">Fatalf</span><span class="op" id="6776625">(</span><span class="string" id="6776626">&#34;client&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6776644">,</span>&nbsp;<span class="ident" id="6776646">err</span><span class="op" id="6776649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6776652">}</span><br>
<span class="lineno"></span><span class="op" id="6776654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6776657">func</span>&nbsp;<span class="ident" id="6776662">newLocalListener</span><span class="op" id="6776678">(</span><span class="ident" id="6776679">t</span>&nbsp;<span class="op" id="6776681">*</span><span class="ident" id="6776682">testing</span><span class="op" id="6776689">.</span><span class="ident" id="6776690">T</span><span class="op" id="6776691">)</span>&nbsp;<span class="ident" id="6776693">net</span><span class="op" id="6776696">.</span><span class="ident" id="6776697">Listener</span>&nbsp;<span class="op" id="6776706">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776709">ln</span><span class="op" id="6776711">,</span>&nbsp;<span class="ident" id="6776713">err</span>&nbsp;<span class="op" id="6776717">:=</span>&nbsp;<span class="ident" id="6776720">net</span><span class="op" id="6776723">.</span><span class="ident" id="6776724">Listen</span><span class="op" id="6776730">(</span><span class="string" id="6776731">&#34;tcp&#34;</span><span class="op" id="6776736">,</span>&nbsp;<span class="string" id="6776738">&#34;127.0.0.1:0&#34;</span><span class="op" id="6776751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6776754">if</span>&nbsp;<span class="ident" id="6776757">err</span>&nbsp;<span class="op" id="6776761">!=</span>&nbsp;<span class="builtintype" id="6776764">nil</span>&nbsp;<span class="op" id="6776768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776772">ln</span><span class="op" id="6776774">,</span>&nbsp;<span class="ident" id="6776776">err</span>&nbsp;<span class="op" id="6776780">=</span>&nbsp;<span class="ident" id="6776782">net</span><span class="op" id="6776785">.</span><span class="ident" id="6776786">Listen</span><span class="op" id="6776792">(</span><span class="string" id="6776793">&#34;tcp6&#34;</span><span class="op" id="6776799">,</span>&nbsp;<span class="string" id="6776801">&#34;[::1]:0&#34;</span><span class="op" id="6776810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6776813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6776816">if</span>&nbsp;<span class="ident" id="6776819">err</span>&nbsp;<span class="op" id="6776823">!=</span>&nbsp;<span class="builtintype" id="6776826">nil</span>&nbsp;<span class="op" id="6776830">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776834">t</span><span class="op" id="6776835">.</span><span class="ident" id="6776836">Fatal</span><span class="op" id="6776841">(</span><span class="ident" id="6776842">err</span><span class="op" id="6776845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6776848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6776851">return</span>&nbsp;<span class="ident" id="6776858">ln</span><br>
<span class="lineno"></span><span class="op" id="6776861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span><span class="keyword" id="6776864">type</span>&nbsp;<span class="ident" id="6776869">smtpSender</span>&nbsp;<span class="keyword" id="6776880">struct</span>&nbsp;<span class="op" id="6776887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776890">w</span>&nbsp;<span class="ident" id="6776892">io</span><span class="op" id="6776894">.</span><span class="ident" id="6776895">Writer</span><br>
<span class="lineno"></span><span class="op" id="6776902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6776905">func</span>&nbsp;<span class="op" id="6776910">(</span><span class="ident" id="6776911">s</span>&nbsp;<span class="ident" id="6776913">smtpSender</span><span class="op" id="6776923">)</span>&nbsp;<span class="ident" id="6776925">send</span><span class="op" id="6776929">(</span><span class="ident" id="6776930">f</span>&nbsp;<span class="builtintype" id="6776932">string</span><span class="op" id="6776938">)</span>&nbsp;<span class="op" id="6776940">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776943">s</span><span class="op" id="6776944">.</span><span class="ident" id="6776945">w</span><span class="op" id="6776946">.</span><span class="ident" id="6776947">Write</span><span class="op" id="6776952">(</span><span class="op" id="6776953">[</span><span class="op" id="6776954">]</span><span class="builtintype" id="6776955">byte</span><span class="op" id="6776959">(</span><span class="ident" id="6776960">f</span>&nbsp;<span class="op" id="6776962">+</span>&nbsp;<span class="string" id="6776964">&#34;\r\n&#34;</span><span class="op" id="6776970">)</span><span class="op" id="6776971">)</span><br>
<span class="lineno"></span><span class="op" id="6776973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6776976">//&nbsp;smtp&nbsp;server,&nbsp;finely&nbsp;tailored&nbsp;to&nbsp;deal&nbsp;with&nbsp;our&nbsp;own&nbsp;client&nbsp;only!</span><br>
<span class="lineno"></span><span class="keyword" id="6777042">func</span>&nbsp;<span class="ident" id="6777047">serverHandle</span><span class="op" id="6777059">(</span><span class="ident" id="6777060">c</span>&nbsp;<span class="ident" id="6777062">net</span><span class="op" id="6777065">.</span><span class="ident" id="6777066">Conn</span><span class="op" id="6777070">,</span>&nbsp;<span class="ident" id="6777072">t</span>&nbsp;<span class="op" id="6777074">*</span><span class="ident" id="6777075">testing</span><span class="op" id="6777082">.</span><span class="ident" id="6777083">T</span><span class="op" id="6777084">)</span>&nbsp;<span class="builtintype" id="6777086">error</span>&nbsp;<span class="op" id="6777092">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777095">send</span>&nbsp;<span class="op" id="6777100">:=</span>&nbsp;<span class="ident" id="6777103">smtpSender</span><span class="op" id="6777113">{</span><span class="ident" id="6777114">c</span><span class="op" id="6777115">}</span><span class="op" id="6777116">.</span><span class="ident" id="6777117">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777123">send</span><span class="op" id="6777127">(</span><span class="string" id="6777128">&#34;220&nbsp;127.0.0.1&nbsp;ESMTP&nbsp;service&nbsp;ready&#34;</span><span class="op" id="6777163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777166">s</span>&nbsp;<span class="op" id="6777168">:=</span>&nbsp;<span class="ident" id="6777171">bufio</span><span class="op" id="6777176">.</span><span class="ident" id="6777177">NewScanner</span><span class="op" id="6777187">(</span><span class="ident" id="6777188">c</span><span class="op" id="6777189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777192">for</span>&nbsp;<span class="ident" id="6777196">s</span><span class="op" id="6777197">.</span><span class="ident" id="6777198">Scan</span><span class="op" id="6777202">(</span><span class="op" id="6777203">)</span>&nbsp;<span class="op" id="6777205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777209">switch</span>&nbsp;<span class="ident" id="6777216">s</span><span class="op" id="6777217">.</span><span class="ident" id="6777218">Text</span><span class="op" id="6777222">(</span><span class="op" id="6777223">)</span>&nbsp;<span class="op" id="6777225">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777229">case</span>&nbsp;<span class="string" id="6777234">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="6777250">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777255">send</span><span class="op" id="6777259">(</span><span class="string" id="6777260">&#34;250-127.0.0.1&nbsp;ESMTP&nbsp;offers&nbsp;a&nbsp;warm&nbsp;hug&nbsp;of&nbsp;welcome&#34;</span><span class="op" id="6777310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777315">send</span><span class="op" id="6777319">(</span><span class="string" id="6777320">&#34;250-STARTTLS&#34;</span><span class="op" id="6777334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777339">send</span><span class="op" id="6777343">(</span><span class="string" id="6777344">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6777352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777356">case</span>&nbsp;<span class="string" id="6777361">&#34;STARTTLS&#34;</span><span class="op" id="6777371">:</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777376">send</span><span class="op" id="6777380">(</span><span class="string" id="6777381">&#34;220&nbsp;Go&nbsp;ahead&#34;</span><span class="op" id="6777395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777400">keypair</span><span class="op" id="6777407">,</span>&nbsp;<span class="ident" id="6777409">err</span>&nbsp;<span class="op" id="6777413">:=</span>&nbsp;<span class="ident" id="6777416">tls</span><span class="op" id="6777419">.</span><span class="ident" id="6777420">X509KeyPair</span><span class="op" id="6777431">(</span><span class="ident" id="6777432">localhostCert</span><span class="op" id="6777445">,</span>&nbsp;<span class="ident" id="6777447">localhostKey</span><span class="op" id="6777459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777464">if</span>&nbsp;<span class="ident" id="6777467">err</span>&nbsp;<span class="op" id="6777471">!=</span>&nbsp;<span class="builtintype" id="6777474">nil</span>&nbsp;<span class="op" id="6777478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777484">return</span>&nbsp;<span class="ident" id="6777491">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6777498">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777503">config</span>&nbsp;<span class="op" id="6777510">:=</span>&nbsp;<span class="op" id="6777513">&amp;</span><span class="ident" id="6777514">tls</span><span class="op" id="6777517">.</span><span class="ident" id="6777518">Config</span><span class="op" id="6777524">{</span><span class="ident" id="6777525">Certificates</span><span class="op" id="6777537">:</span>&nbsp;<span class="op" id="6777539">[</span><span class="op" id="6777540">]</span><span class="ident" id="6777541">tls</span><span class="op" id="6777544">.</span><span class="ident" id="6777545">Certificate</span><span class="op" id="6777556">{</span><span class="ident" id="6777557">keypair</span><span class="op" id="6777564">}</span><span class="op" id="6777565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777570">c</span>&nbsp;<span class="op" id="6777572">=</span>&nbsp;<span class="ident" id="6777574">tls</span><span class="op" id="6777577">.</span><span class="ident" id="6777578">Server</span><span class="op" id="6777584">(</span><span class="ident" id="6777585">c</span><span class="op" id="6777586">,</span>&nbsp;<span class="ident" id="6777588">config</span><span class="op" id="6777594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777599">defer</span>&nbsp;<span class="ident" id="6777605">c</span><span class="op" id="6777606">.</span><span class="ident" id="6777607">Close</span><span class="op" id="6777612">(</span><span class="op" id="6777613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777618">return</span>&nbsp;<span class="ident" id="6777625">serverHandleTLS</span><span class="op" id="6777640">(</span><span class="ident" id="6777641">c</span><span class="op" id="6777642">,</span>&nbsp;<span class="ident" id="6777644">t</span><span class="op" id="6777645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777649">default</span><span class="op" id="6777656">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777661">t</span><span class="op" id="6777662">.</span><span class="ident" id="6777663">Fatalf</span><span class="op" id="6777669">(</span><span class="string" id="6777670">&#34;unrecognized&nbsp;command:&nbsp;%q&#34;</span><span class="op" id="6777696">,</span>&nbsp;<span class="ident" id="6777698">s</span><span class="op" id="6777699">.</span><span class="ident" id="6777700">Text</span><span class="op" id="6777704">(</span><span class="op" id="6777705">)</span><span class="op" id="6777706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6777710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6777713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777716">return</span>&nbsp;<span class="ident" id="6777723">s</span><span class="op" id="6777724">.</span><span class="ident" id="6777725">Err</span><span class="op" id="6777728">(</span><span class="op" id="6777729">)</span><br>
<span class="lineno"></span><span class="op" id="6777731">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="6777734">func</span>&nbsp;<span class="ident" id="6777739">serverHandleTLS</span><span class="op" id="6777754">(</span><span class="ident" id="6777755">c</span>&nbsp;<span class="ident" id="6777757">net</span><span class="op" id="6777760">.</span><span class="ident" id="6777761">Conn</span><span class="op" id="6777765">,</span>&nbsp;<span class="ident" id="6777767">t</span>&nbsp;<span class="op" id="6777769">*</span><span class="ident" id="6777770">testing</span><span class="op" id="6777777">.</span><span class="ident" id="6777778">T</span><span class="op" id="6777779">)</span>&nbsp;<span class="builtintype" id="6777781">error</span>&nbsp;<span class="op" id="6777787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777790">send</span>&nbsp;<span class="op" id="6777795">:=</span>&nbsp;<span class="ident" id="6777798">smtpSender</span><span class="op" id="6777808">{</span><span class="ident" id="6777809">c</span><span class="op" id="6777810">}</span><span class="op" id="6777811">.</span><span class="ident" id="6777812">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777818">s</span>&nbsp;<span class="op" id="6777820">:=</span>&nbsp;<span class="ident" id="6777823">bufio</span><span class="op" id="6777828">.</span><span class="ident" id="6777829">NewScanner</span><span class="op" id="6777839">(</span><span class="ident" id="6777840">c</span><span class="op" id="6777841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777844">for</span>&nbsp;<span class="ident" id="6777848">s</span><span class="op" id="6777849">.</span><span class="ident" id="6777850">Scan</span><span class="op" id="6777854">(</span><span class="op" id="6777855">)</span>&nbsp;<span class="op" id="6777857">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777861">switch</span>&nbsp;<span class="ident" id="6777868">s</span><span class="op" id="6777869">.</span><span class="ident" id="6777870">Text</span><span class="op" id="6777874">(</span><span class="op" id="6777875">)</span>&nbsp;<span class="op" id="6777877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777881">case</span>&nbsp;<span class="string" id="6777886">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="6777902">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777907">send</span><span class="op" id="6777911">(</span><span class="string" id="6777912">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6777920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777924">case</span>&nbsp;<span class="string" id="6777929">&#34;MAIL&nbsp;FROM:&lt;joe1@example.com&gt;&#34;</span><span class="op" id="6777959">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777964">send</span><span class="op" id="6777968">(</span><span class="string" id="6777969">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6777977">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777981">case</span>&nbsp;<span class="string" id="6777986">&#34;RCPT&nbsp;TO:&lt;joe2@example.com&gt;&#34;</span><span class="op" id="6778014">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778019">send</span><span class="op" id="6778023">(</span><span class="string" id="6778024">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6778032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778036">case</span>&nbsp;<span class="string" id="6778041">&#34;DATA&#34;</span><span class="op" id="6778047">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778052">send</span><span class="op" id="6778056">(</span><span class="string" id="6778057">&#34;354&nbsp;send&nbsp;the&nbsp;mail&nbsp;data,&nbsp;end&nbsp;with&nbsp;.&#34;</span><span class="op" id="6778093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778098">send</span><span class="op" id="6778102">(</span><span class="string" id="6778103">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6778111">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778115">case</span>&nbsp;<span class="string" id="6778120">&#34;Subject:&nbsp;test&#34;</span><span class="op" id="6778135">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778139">case</span>&nbsp;<span class="string" id="6778144">&#34;&#34;</span><span class="op" id="6778146">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778150">case</span>&nbsp;<span class="string" id="6778155">&#34;howdy!&#34;</span><span class="op" id="6778163">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778167">case</span>&nbsp;<span class="string" id="6778172">&#34;.&#34;</span><span class="op" id="6778175">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778179">case</span>&nbsp;<span class="string" id="6778184">&#34;QUIT&#34;</span><span class="op" id="6778190">:</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778195">send</span><span class="op" id="6778199">(</span><span class="string" id="6778200">&#34;221&nbsp;127.0.0.1&nbsp;Service&nbsp;closing&nbsp;transmission&nbsp;channel&#34;</span><span class="op" id="6778252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778257">return</span>&nbsp;<span class="builtintype" id="6778264">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778270">default</span><span class="op" id="6778277">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778282">t</span><span class="op" id="6778283">.</span><span class="ident" id="6778284">Fatalf</span><span class="op" id="6778290">(</span><span class="string" id="6778291">&#34;unrecognized&nbsp;command&nbsp;during&nbsp;TLS:&nbsp;%q&#34;</span><span class="op" id="6778328">,</span>&nbsp;<span class="ident" id="6778330">s</span><span class="op" id="6778331">.</span><span class="ident" id="6778332">Text</span><span class="op" id="6778336">(</span><span class="op" id="6778337">)</span><span class="op" id="6778338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778342">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778348">return</span>&nbsp;<span class="ident" id="6778355">s</span><span class="op" id="6778356">.</span><span class="ident" id="6778357">Err</span><span class="op" id="6778360">(</span><span class="op" id="6778361">)</span><br>
<span class="lineno"></span><span class="op" id="6778363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6778366">func</span>&nbsp;<span class="ident" id="6778371">init</span><span class="op" id="6778375">(</span><span class="op" id="6778376">)</span>&nbsp;<span class="op" id="6778378">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778381">testRootCAs</span>&nbsp;<span class="op" id="6778393">:=</span>&nbsp;<span class="ident" id="6778396">x509</span><span class="op" id="6778400">.</span><span class="ident" id="6778401">NewCertPool</span><span class="op" id="6778412">(</span><span class="op" id="6778413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778416">testRootCAs</span><span class="op" id="6778427">.</span><span class="ident" id="6778428">AppendCertsFromPEM</span><span class="op" id="6778446">(</span><span class="ident" id="6778447">localhostCert</span><span class="op" id="6778460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778463">testHookStartTLS</span>&nbsp;<span class="op" id="6778480">=</span>&nbsp;<span class="keyword" id="6778482">func</span><span class="op" id="6778486">(</span><span class="ident" id="6778487">config</span>&nbsp;<span class="op" id="6778494">*</span><span class="ident" id="6778495">tls</span><span class="op" id="6778498">.</span><span class="ident" id="6778499">Config</span><span class="op" id="6778505">)</span>&nbsp;<span class="op" id="6778507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778511">config</span><span class="op" id="6778517">.</span><span class="ident" id="6778518">RootCAs</span>&nbsp;<span class="op" id="6778526">=</span>&nbsp;<span class="ident" id="6778528">testRootCAs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778541">}</span><br>
<span class="lineno">655</span><span class="op" id="6778543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6778546">func</span>&nbsp;<span class="ident" id="6778551">sendMail</span><span class="op" id="6778559">(</span><span class="ident" id="6778560">hostPort</span>&nbsp;<span class="builtintype" id="6778569">string</span><span class="op" id="6778575">)</span>&nbsp;<span class="builtintype" id="6778577">error</span>&nbsp;<span class="op" id="6778583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778586">host</span><span class="op" id="6778590">,</span>&nbsp;<span class="ident" id="6778592">_</span><span class="op" id="6778593">,</span>&nbsp;<span class="ident" id="6778595">err</span>&nbsp;<span class="op" id="6778599">:=</span>&nbsp;<span class="ident" id="6778602">net</span><span class="op" id="6778605">.</span><span class="ident" id="6778606">SplitHostPort</span><span class="op" id="6778619">(</span><span class="ident" id="6778620">hostPort</span><span class="op" id="6778628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778631">if</span>&nbsp;<span class="ident" id="6778634">err</span>&nbsp;<span class="op" id="6778638">!=</span>&nbsp;<span class="builtintype" id="6778641">nil</span>&nbsp;<span class="op" id="6778645">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778649">return</span>&nbsp;<span class="ident" id="6778656">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778664">auth</span>&nbsp;<span class="op" id="6778669">:=</span>&nbsp;<span class="ident" id="6778672">PlainAuth</span><span class="op" id="6778681">(</span><span class="string" id="6778682">&#34;&#34;</span><span class="op" id="6778684">,</span>&nbsp;<span class="string" id="6778686">&#34;&#34;</span><span class="op" id="6778688">,</span>&nbsp;<span class="string" id="6778690">&#34;&#34;</span><span class="op" id="6778692">,</span>&nbsp;<span class="ident" id="6778694">host</span><span class="op" id="6778698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778701">from</span>&nbsp;<span class="op" id="6778706">:=</span>&nbsp;<span class="string" id="6778709">&#34;joe1@example.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778729">to</span>&nbsp;<span class="op" id="6778732">:=</span>&nbsp;<span class="op" id="6778735">[</span><span class="op" id="6778736">]</span><span class="builtintype" id="6778737">string</span><span class="op" id="6778743">{</span><span class="string" id="6778744">&#34;joe2@example.com&#34;</span><span class="op" id="6778762">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778765">return</span>&nbsp;<span class="ident" id="6778772">SendMail</span><span class="op" id="6778780">(</span><span class="ident" id="6778781">hostPort</span><span class="op" id="6778789">,</span>&nbsp;<span class="ident" id="6778791">auth</span><span class="op" id="6778795">,</span>&nbsp;<span class="ident" id="6778797">from</span><span class="op" id="6778801">,</span>&nbsp;<span class="ident" id="6778803">to</span><span class="op" id="6778805">,</span>&nbsp;<span class="op" id="6778807">[</span><span class="op" id="6778808">]</span><span class="builtintype" id="6778809">byte</span><span class="op" id="6778813">(</span><span class="string" id="6778814">&#34;Subject:&nbsp;test\n\nhowdy!&#34;</span><span class="op" id="6778839">)</span><span class="op" id="6778840">)</span><br>
<span class="lineno"></span><span class="op" id="6778842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6778845">//&nbsp;(copied&nbsp;from&nbsp;net/http/httptest)</span><br>
<span class="lineno"></span><span class="comment" id="6778880">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno">670</span><span class="comment" id="6778936">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno"></span><span class="comment" id="6779009">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="6779028">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="6779062">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="6779198">var</span>&nbsp;<span class="ident" id="6779202">localhostCert</span>&nbsp;<span class="op" id="6779216">=</span>&nbsp;<span class="op" id="6779218">[</span><span class="op" id="6779219">]</span><span class="builtintype" id="6779220">byte</span><span class="op" id="6779224">(</span><span class="string" id="6779225">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno">675</span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno"></span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno">680</span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno"></span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="6779796">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span><span class="comment" id="6779799">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno"></span><span class="keyword" id="6779853">var</span>&nbsp;<span class="ident" id="6779857">localhostKey</span>&nbsp;<span class="op" id="6779870">=</span>&nbsp;<span class="op" id="6779872">[</span><span class="op" id="6779873">]</span><span class="builtintype" id="6779874">byte</span><span class="op" id="6779878">(</span><span class="string" id="6779879">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno">690</span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno"></span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="6780377">)</span>
</div>
</body>
</html>
