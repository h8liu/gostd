<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html" class="current">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1543477">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1543532">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1543586">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1543637">//&nbsp;+build&nbsp;dragonfly&nbsp;freebsd&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1543672">package</span>&nbsp;<span class="ident" id="1543680">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1543689">import</span>&nbsp;<span class="string" id="1543696">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1543706">//&nbsp;This&nbsp;implementation&nbsp;depends&nbsp;on&nbsp;OS-specific&nbsp;implementations&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1543771">//</span><br>
<span class="lineno"></span><span class="comment" id="1543774">//&nbsp;&nbsp;&nbsp;&nbsp;runtime路futexsleep(uint32&nbsp;*addr,&nbsp;uint32&nbsp;val,&nbsp;int64&nbsp;ns)</span><br>
<span class="lineno"></span><span class="comment" id="1543833">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Atomically,</span><br>
<span class="lineno">15</span><span class="comment" id="1543849">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(*addr&nbsp;==&nbsp;val)&nbsp;sleep</span><br>
<span class="lineno"></span><span class="comment" id="1543877">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Might&nbsp;be&nbsp;woken&nbsp;up&nbsp;spuriously;&nbsp;that&#39;s&nbsp;allowed.</span><br>
<span class="lineno"></span><span class="comment" id="1543927">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Don&#39;t&nbsp;sleep&nbsp;longer&nbsp;than&nbsp;ns;&nbsp;ns&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;forever.</span><br>
<span class="lineno"></span><span class="comment" id="1543981">//</span><br>
<span class="lineno"></span><span class="comment" id="1543984">//&nbsp;&nbsp;&nbsp;&nbsp;runtime路futexwakeup(uint32&nbsp;*addr,&nbsp;uint32&nbsp;cnt)</span><br>
<span class="lineno">20</span><span class="comment" id="1544034">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;any&nbsp;procs&nbsp;are&nbsp;sleeping&nbsp;on&nbsp;addr,&nbsp;wake&nbsp;up&nbsp;at&nbsp;most&nbsp;cnt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1544095">const</span>&nbsp;<span class="op" id="1544101">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544104">mutex_unlocked</span>&nbsp;<span class="op" id="1544119">=</span>&nbsp;<span class="num" id="1544121">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544124">mutex_locked</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1544139">=</span>&nbsp;<span class="num" id="1544141">1</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544144">mutex_sleeping</span>&nbsp;<span class="op" id="1544159">=</span>&nbsp;<span class="num" id="1544161">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544165">active_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544181">=</span>&nbsp;<span class="num" id="1544183">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544186">active_spin_cnt</span>&nbsp;<span class="op" id="1544202">=</span>&nbsp;<span class="num" id="1544204">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544208">passive_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544224">=</span>&nbsp;<span class="num" id="1544226">1</span><br>
<span class="lineno">30</span><span class="op" id="1544228">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1544231">//&nbsp;Possible&nbsp;lock&nbsp;states&nbsp;are&nbsp;mutex_unlocked,&nbsp;mutex_locked&nbsp;and&nbsp;mutex_sleeping.</span><br>
<span class="lineno"></span><span class="comment" id="1544308">//&nbsp;mutex_sleeping&nbsp;means&nbsp;that&nbsp;there&nbsp;is&nbsp;presumably&nbsp;at&nbsp;least&nbsp;one&nbsp;sleeping&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1544387">//&nbsp;Note&nbsp;that&nbsp;there&nbsp;can&nbsp;be&nbsp;spinning&nbsp;threads&nbsp;during&nbsp;all&nbsp;states&nbsp;-&nbsp;they&nbsp;do&nbsp;not</span><br>
<span class="lineno">35</span><span class="comment" id="1544462">//&nbsp;affect&nbsp;mutex&#39;s&nbsp;state.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1544488">func</span>&nbsp;<span class="ident" id="1544493">futexsleep</span><span class="op" id="1544503">(</span><span class="ident" id="1544504">addr</span>&nbsp;<span class="op" id="1544509">*</span><span class="builtintype" id="1544510">uint32</span><span class="op" id="1544516">,</span>&nbsp;<span class="ident" id="1544518">val</span>&nbsp;<span class="builtintype" id="1544522">uint32</span><span class="op" id="1544528">,</span>&nbsp;<span class="ident" id="1544530">ns</span>&nbsp;<span class="ident" id="1544533">int64</span><span class="op" id="1544538">)</span><br>
<span class="lineno"></span><span class="keyword" id="1544540">func</span>&nbsp;<span class="ident" id="1544545">futexwakeup</span><span class="op" id="1544556">(</span><span class="ident" id="1544557">addr</span>&nbsp;<span class="op" id="1544562">*</span><span class="builtintype" id="1544563">uint32</span><span class="op" id="1544569">,</span>&nbsp;<span class="ident" id="1544571">cnt</span>&nbsp;<span class="builtintype" id="1544575">uint32</span><span class="op" id="1544581">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1544584">//&nbsp;We&nbsp;use&nbsp;the&nbsp;uintptr&nbsp;mutex.key&nbsp;and&nbsp;note.key&nbsp;as&nbsp;a&nbsp;uint32.</span><br>
<span class="lineno"></span><span class="keyword" id="1544642">func</span>&nbsp;<span class="ident" id="1544647">key32</span><span class="op" id="1544652">(</span><span class="ident" id="1544653">p</span>&nbsp;<span class="op" id="1544655">*</span><span class="builtintype" id="1544656">uintptr</span><span class="op" id="1544663">)</span>&nbsp;<span class="op" id="1544665">*</span><span class="builtintype" id="1544666">uint32</span>&nbsp;<span class="op" id="1544673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544676">return</span>&nbsp;<span class="op" id="1544683">(</span><span class="op" id="1544684">*</span><span class="builtintype" id="1544685">uint32</span><span class="op" id="1544691">)</span><span class="op" id="1544692">(</span><span class="ident" id="1544693">unsafe</span><span class="op" id="1544699">.</span><span class="ident" id="1544700">Pointer</span><span class="op" id="1544707">(</span><span class="ident" id="1544708">p</span><span class="op" id="1544709">)</span><span class="op" id="1544710">)</span><br>
<span class="lineno"></span><span class="op" id="1544712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1544715">func</span>&nbsp;<span class="ident" id="1544720">lock</span><span class="op" id="1544724">(</span><span class="ident" id="1544725">l</span>&nbsp;<span class="op" id="1544727">*</span><span class="ident" id="1544728">mutex</span><span class="op" id="1544733">)</span>&nbsp;<span class="op" id="1544735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544738">gp</span>&nbsp;<span class="op" id="1544741">:=</span>&nbsp;<span class="ident" id="1544744">getg</span><span class="op" id="1544748">(</span><span class="op" id="1544749">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544753">if</span>&nbsp;<span class="ident" id="1544756">gp</span><span class="op" id="1544758">.</span><span class="ident" id="1544759">m</span><span class="op" id="1544760">.</span><span class="ident" id="1544761">locks</span>&nbsp;<span class="op" id="1544767">&lt;</span>&nbsp;<span class="num" id="1544769">0</span>&nbsp;<span class="op" id="1544771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544775">gothrow</span><span class="op" id="1544782">(</span><span class="string" id="1544783">&#34;runtime路lock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1544810">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544816">gp</span><span class="op" id="1544818">.</span><span class="ident" id="1544819">m</span><span class="op" id="1544820">.</span><span class="ident" id="1544821">locks</span><span class="op" id="1544826">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1544831">//&nbsp;Speculative&nbsp;grab&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544862">v</span>&nbsp;<span class="op" id="1544864">:=</span>&nbsp;<span class="ident" id="1544867">xchg</span><span class="op" id="1544871">(</span><span class="ident" id="1544872">key32</span><span class="op" id="1544877">(</span><span class="op" id="1544878">&amp;</span><span class="ident" id="1544879">l</span><span class="op" id="1544880">.</span><span class="ident" id="1544881">key</span><span class="op" id="1544884">)</span><span class="op" id="1544885">,</span>&nbsp;<span class="ident" id="1544887">mutex_locked</span><span class="op" id="1544899">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544902">if</span>&nbsp;<span class="ident" id="1544905">v</span>&nbsp;<span class="op" id="1544907">==</span>&nbsp;<span class="ident" id="1544910">mutex_unlocked</span>&nbsp;<span class="op" id="1544925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544929">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1544941">//&nbsp;wait&nbsp;is&nbsp;either&nbsp;MUTEX_LOCKED&nbsp;or&nbsp;MUTEX_SLEEPING</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1544991">//&nbsp;depending&nbsp;on&nbsp;whether&nbsp;there&nbsp;is&nbsp;a&nbsp;thread&nbsp;sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1545043">//&nbsp;on&nbsp;this&nbsp;mutex.&nbsp;&nbsp;If&nbsp;we&nbsp;ever&nbsp;change&nbsp;l-&gt;key&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1545093">//&nbsp;MUTEX_SLEEPING&nbsp;to&nbsp;some&nbsp;other&nbsp;value,&nbsp;we&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1545144">//&nbsp;careful&nbsp;to&nbsp;change&nbsp;it&nbsp;back&nbsp;to&nbsp;MUTEX_SLEEPING&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1545199">//&nbsp;returning,&nbsp;to&nbsp;ensure&nbsp;that&nbsp;the&nbsp;sleeping&nbsp;thread&nbsp;gets</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1545254">//&nbsp;its&nbsp;wakeup&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545275">wait</span>&nbsp;<span class="op" id="1545280">:=</span>&nbsp;<span class="ident" id="1545283">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1545287">//&nbsp;On&nbsp;uniprocessors,&nbsp;no&nbsp;point&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1545328">//&nbsp;On&nbsp;multiprocessors,&nbsp;spin&nbsp;for&nbsp;ACTIVE_SPIN&nbsp;attempts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545383">spin</span>&nbsp;<span class="op" id="1545388">:=</span>&nbsp;<span class="num" id="1545391">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545394">if</span>&nbsp;<span class="ident" id="1545397">ncpu</span>&nbsp;<span class="op" id="1545402">&gt;</span>&nbsp;<span class="num" id="1545404">1</span>&nbsp;<span class="op" id="1545406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545410">spin</span>&nbsp;<span class="op" id="1545415">=</span>&nbsp;<span class="ident" id="1545417">active_spin</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545433">for</span>&nbsp;<span class="op" id="1545437">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1545441">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545470">for</span>&nbsp;<span class="ident" id="1545474">i</span>&nbsp;<span class="op" id="1545476">:=</span>&nbsp;<span class="num" id="1545479">0</span><span class="op" id="1545480">;</span>&nbsp;<span class="ident" id="1545482">i</span>&nbsp;<span class="op" id="1545484">&lt;</span>&nbsp;<span class="ident" id="1545486">spin</span><span class="op" id="1545490">;</span>&nbsp;<span class="ident" id="1545492">i</span><span class="op" id="1545493">++</span>&nbsp;<span class="op" id="1545496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545501">for</span>&nbsp;<span class="ident" id="1545505">l</span><span class="op" id="1545506">.</span><span class="ident" id="1545507">key</span>&nbsp;<span class="op" id="1545511">==</span>&nbsp;<span class="ident" id="1545514">mutex_unlocked</span>&nbsp;<span class="op" id="1545529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545535">if</span>&nbsp;<span class="ident" id="1545538">cas</span><span class="op" id="1545541">(</span><span class="ident" id="1545542">key32</span><span class="op" id="1545547">(</span><span class="op" id="1545548">&amp;</span><span class="ident" id="1545549">l</span><span class="op" id="1545550">.</span><span class="ident" id="1545551">key</span><span class="op" id="1545554">)</span><span class="op" id="1545555">,</span>&nbsp;<span class="ident" id="1545557">mutex_unlocked</span><span class="op" id="1545571">,</span>&nbsp;<span class="ident" id="1545573">wait</span><span class="op" id="1545577">)</span>&nbsp;<span class="op" id="1545579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545586">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545607">procyield</span><span class="op" id="1545616">(</span><span class="ident" id="1545617">active_spin_cnt</span><span class="op" id="1545632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1545641">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;rescheduling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545674">for</span>&nbsp;<span class="ident" id="1545678">i</span>&nbsp;<span class="op" id="1545680">:=</span>&nbsp;<span class="num" id="1545683">0</span><span class="op" id="1545684">;</span>&nbsp;<span class="ident" id="1545686">i</span>&nbsp;<span class="op" id="1545688">&lt;</span>&nbsp;<span class="ident" id="1545690">passive_spin</span><span class="op" id="1545702">;</span>&nbsp;<span class="ident" id="1545704">i</span><span class="op" id="1545705">++</span>&nbsp;<span class="op" id="1545708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545713">for</span>&nbsp;<span class="ident" id="1545717">l</span><span class="op" id="1545718">.</span><span class="ident" id="1545719">key</span>&nbsp;<span class="op" id="1545723">==</span>&nbsp;<span class="ident" id="1545726">mutex_unlocked</span>&nbsp;<span class="op" id="1545741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545747">if</span>&nbsp;<span class="ident" id="1545750">cas</span><span class="op" id="1545753">(</span><span class="ident" id="1545754">key32</span><span class="op" id="1545759">(</span><span class="op" id="1545760">&amp;</span><span class="ident" id="1545761">l</span><span class="op" id="1545762">.</span><span class="ident" id="1545763">key</span><span class="op" id="1545766">)</span><span class="op" id="1545767">,</span>&nbsp;<span class="ident" id="1545769">mutex_unlocked</span><span class="op" id="1545783">,</span>&nbsp;<span class="ident" id="1545785">wait</span><span class="op" id="1545789">)</span>&nbsp;<span class="op" id="1545791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545798">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545819">osyield</span><span class="op" id="1545826">(</span><span class="op" id="1545827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1545836">//&nbsp;Sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545848">v</span>&nbsp;<span class="op" id="1545850">=</span>&nbsp;<span class="ident" id="1545852">xchg</span><span class="op" id="1545856">(</span><span class="ident" id="1545857">key32</span><span class="op" id="1545862">(</span><span class="op" id="1545863">&amp;</span><span class="ident" id="1545864">l</span><span class="op" id="1545865">.</span><span class="ident" id="1545866">key</span><span class="op" id="1545869">)</span><span class="op" id="1545870">,</span>&nbsp;<span class="ident" id="1545872">mutex_sleeping</span><span class="op" id="1545886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545890">if</span>&nbsp;<span class="ident" id="1545893">v</span>&nbsp;<span class="op" id="1545895">==</span>&nbsp;<span class="ident" id="1545898">mutex_unlocked</span>&nbsp;<span class="op" id="1545913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545918">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545927">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545931">wait</span>&nbsp;<span class="op" id="1545936">=</span>&nbsp;<span class="ident" id="1545938">mutex_sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545955">futexsleep</span><span class="op" id="1545965">(</span><span class="ident" id="1545966">key32</span><span class="op" id="1545971">(</span><span class="op" id="1545972">&amp;</span><span class="ident" id="1545973">l</span><span class="op" id="1545974">.</span><span class="ident" id="1545975">key</span><span class="op" id="1545978">)</span><span class="op" id="1545979">,</span>&nbsp;<span class="ident" id="1545981">mutex_sleeping</span><span class="op" id="1545995">,</span>&nbsp;<span class="op" id="1545997">-</span><span class="num" id="1545998">1</span><span class="op" id="1545999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546002">}</span><br>
<span class="lineno"></span><span class="op" id="1546004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="1546007">func</span>&nbsp;<span class="ident" id="1546012">unlock</span><span class="op" id="1546018">(</span><span class="ident" id="1546019">l</span>&nbsp;<span class="op" id="1546021">*</span><span class="ident" id="1546022">mutex</span><span class="op" id="1546027">)</span>&nbsp;<span class="op" id="1546029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546032">v</span>&nbsp;<span class="op" id="1546034">:=</span>&nbsp;<span class="ident" id="1546037">xchg</span><span class="op" id="1546041">(</span><span class="ident" id="1546042">key32</span><span class="op" id="1546047">(</span><span class="op" id="1546048">&amp;</span><span class="ident" id="1546049">l</span><span class="op" id="1546050">.</span><span class="ident" id="1546051">key</span><span class="op" id="1546054">)</span><span class="op" id="1546055">,</span>&nbsp;<span class="ident" id="1546057">mutex_unlocked</span><span class="op" id="1546071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546074">if</span>&nbsp;<span class="ident" id="1546077">v</span>&nbsp;<span class="op" id="1546079">==</span>&nbsp;<span class="ident" id="1546082">mutex_unlocked</span>&nbsp;<span class="op" id="1546097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546101">gothrow</span><span class="op" id="1546108">(</span><span class="string" id="1546109">&#34;unlock&nbsp;of&nbsp;unlocked&nbsp;lock&#34;</span><span class="op" id="1546134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546137">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546140">if</span>&nbsp;<span class="ident" id="1546143">v</span>&nbsp;<span class="op" id="1546145">==</span>&nbsp;<span class="ident" id="1546148">mutex_sleeping</span>&nbsp;<span class="op" id="1546163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546167">futexwakeup</span><span class="op" id="1546178">(</span><span class="ident" id="1546179">key32</span><span class="op" id="1546184">(</span><span class="op" id="1546185">&amp;</span><span class="ident" id="1546186">l</span><span class="op" id="1546187">.</span><span class="ident" id="1546188">key</span><span class="op" id="1546191">)</span><span class="op" id="1546192">,</span>&nbsp;<span class="num" id="1546194">1</span><span class="op" id="1546195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546202">gp</span>&nbsp;<span class="op" id="1546205">:=</span>&nbsp;<span class="ident" id="1546208">getg</span><span class="op" id="1546212">(</span><span class="op" id="1546213">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546216">gp</span><span class="op" id="1546218">.</span><span class="ident" id="1546219">m</span><span class="op" id="1546220">.</span><span class="ident" id="1546221">locks</span><span class="op" id="1546226">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546230">if</span>&nbsp;<span class="ident" id="1546233">gp</span><span class="op" id="1546235">.</span><span class="ident" id="1546236">m</span><span class="op" id="1546237">.</span><span class="ident" id="1546238">locks</span>&nbsp;<span class="op" id="1546244">&lt;</span>&nbsp;<span class="num" id="1546246">0</span>&nbsp;<span class="op" id="1546248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546252">gothrow</span><span class="op" id="1546259">(</span><span class="string" id="1546260">&#34;runtime路unlock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1546289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546295">if</span>&nbsp;<span class="ident" id="1546298">gp</span><span class="op" id="1546300">.</span><span class="ident" id="1546301">m</span><span class="op" id="1546302">.</span><span class="ident" id="1546303">locks</span>&nbsp;<span class="op" id="1546309">==</span>&nbsp;<span class="num" id="1546312">0</span>&nbsp;<span class="op" id="1546314">&amp;&amp;</span>&nbsp;<span class="ident" id="1546317">gp</span><span class="op" id="1546319">.</span><span class="ident" id="1546320">preempt</span>&nbsp;<span class="op" id="1546328">{</span>&nbsp;<span class="comment" id="1546330">//&nbsp;restore&nbsp;the&nbsp;preemption&nbsp;request&nbsp;in&nbsp;case&nbsp;we&#39;ve&nbsp;cleared&nbsp;it&nbsp;in&nbsp;newstack</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546403">gp</span><span class="op" id="1546405">.</span><span class="ident" id="1546406">stackguard0</span>&nbsp;<span class="op" id="1546418">=</span>&nbsp;<span class="ident" id="1546420">stackPreempt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546434">}</span><br>
<span class="lineno"></span><span class="op" id="1546436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1546439">//&nbsp;One-time&nbsp;notifications.</span><br>
<span class="lineno">125</span><span class="keyword" id="1546466">func</span>&nbsp;<span class="ident" id="1546471">noteclear</span><span class="op" id="1546480">(</span><span class="ident" id="1546481">n</span>&nbsp;<span class="op" id="1546483">*</span><span class="ident" id="1546484">note</span><span class="op" id="1546488">)</span>&nbsp;<span class="op" id="1546490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546493">n</span><span class="op" id="1546494">.</span><span class="ident" id="1546495">key</span>&nbsp;<span class="op" id="1546499">=</span>&nbsp;<span class="num" id="1546501">0</span><br>
<span class="lineno"></span><span class="op" id="1546503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1546506">func</span>&nbsp;<span class="ident" id="1546511">notewakeup</span><span class="op" id="1546521">(</span><span class="ident" id="1546522">n</span>&nbsp;<span class="op" id="1546524">*</span><span class="ident" id="1546525">note</span><span class="op" id="1546529">)</span>&nbsp;<span class="op" id="1546531">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546534">old</span>&nbsp;<span class="op" id="1546538">:=</span>&nbsp;<span class="ident" id="1546541">xchg</span><span class="op" id="1546545">(</span><span class="ident" id="1546546">key32</span><span class="op" id="1546551">(</span><span class="op" id="1546552">&amp;</span><span class="ident" id="1546553">n</span><span class="op" id="1546554">.</span><span class="ident" id="1546555">key</span><span class="op" id="1546558">)</span><span class="op" id="1546559">,</span>&nbsp;<span class="num" id="1546561">1</span><span class="op" id="1546562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546565">if</span>&nbsp;<span class="ident" id="1546568">old</span>&nbsp;<span class="op" id="1546572">!=</span>&nbsp;<span class="num" id="1546575">0</span>&nbsp;<span class="op" id="1546577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1546581">print</span><span class="op" id="1546586">(</span><span class="string" id="1546587">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&nbsp;(&#34;</span><span class="op" id="1546617">,</span>&nbsp;<span class="ident" id="1546619">old</span><span class="op" id="1546622">,</span>&nbsp;<span class="string" id="1546624">&#34;)\n&#34;</span><span class="op" id="1546629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546633">gothrow</span><span class="op" id="1546640">(</span><span class="string" id="1546641">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&#34;</span><span class="op" id="1546669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546672">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546675">futexwakeup</span><span class="op" id="1546686">(</span><span class="ident" id="1546687">key32</span><span class="op" id="1546692">(</span><span class="op" id="1546693">&amp;</span><span class="ident" id="1546694">n</span><span class="op" id="1546695">.</span><span class="ident" id="1546696">key</span><span class="op" id="1546699">)</span><span class="op" id="1546700">,</span>&nbsp;<span class="num" id="1546702">1</span><span class="op" id="1546703">)</span><br>
<span class="lineno"></span><span class="op" id="1546705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1546708">func</span>&nbsp;<span class="ident" id="1546713">notesleep</span><span class="op" id="1546722">(</span><span class="ident" id="1546723">n</span>&nbsp;<span class="op" id="1546725">*</span><span class="ident" id="1546726">note</span><span class="op" id="1546730">)</span>&nbsp;<span class="op" id="1546732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546735">gp</span>&nbsp;<span class="op" id="1546738">:=</span>&nbsp;<span class="ident" id="1546741">getg</span><span class="op" id="1546745">(</span><span class="op" id="1546746">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546749">if</span>&nbsp;<span class="ident" id="1546752">gp</span>&nbsp;<span class="op" id="1546755">!=</span>&nbsp;<span class="ident" id="1546758">gp</span><span class="op" id="1546760">.</span><span class="ident" id="1546761">m</span><span class="op" id="1546762">.</span><span class="ident" id="1546763">g0</span>&nbsp;<span class="op" id="1546766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546770">gothrow</span><span class="op" id="1546777">(</span><span class="string" id="1546778">&#34;notesleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1546799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546805">for</span>&nbsp;<span class="ident" id="1546809">atomicload</span><span class="op" id="1546819">(</span><span class="ident" id="1546820">key32</span><span class="op" id="1546825">(</span><span class="op" id="1546826">&amp;</span><span class="ident" id="1546827">n</span><span class="op" id="1546828">.</span><span class="ident" id="1546829">key</span><span class="op" id="1546832">)</span><span class="op" id="1546833">)</span>&nbsp;<span class="op" id="1546835">==</span>&nbsp;<span class="num" id="1546838">0</span>&nbsp;<span class="op" id="1546840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546844">gp</span><span class="op" id="1546846">.</span><span class="ident" id="1546847">m</span><span class="op" id="1546848">.</span><span class="ident" id="1546849">blocked</span>&nbsp;<span class="op" id="1546857">=</span>&nbsp;<span class="builtintype" id="1546859">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546866">futexsleep</span><span class="op" id="1546876">(</span><span class="ident" id="1546877">key32</span><span class="op" id="1546882">(</span><span class="op" id="1546883">&amp;</span><span class="ident" id="1546884">n</span><span class="op" id="1546885">.</span><span class="ident" id="1546886">key</span><span class="op" id="1546889">)</span><span class="op" id="1546890">,</span>&nbsp;<span class="num" id="1546892">0</span><span class="op" id="1546893">,</span>&nbsp;<span class="op" id="1546895">-</span><span class="num" id="1546896">1</span><span class="op" id="1546897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546901">gp</span><span class="op" id="1546903">.</span><span class="ident" id="1546904">m</span><span class="op" id="1546905">.</span><span class="ident" id="1546906">blocked</span>&nbsp;<span class="op" id="1546914">=</span>&nbsp;<span class="builtintype" id="1546916">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546923">}</span><br>
<span class="lineno"></span><span class="op" id="1546925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1546928">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1546941">func</span>&nbsp;<span class="ident" id="1546946">notetsleep_internal</span><span class="op" id="1546965">(</span><span class="ident" id="1546966">n</span>&nbsp;<span class="op" id="1546968">*</span><span class="ident" id="1546969">note</span><span class="op" id="1546973">,</span>&nbsp;<span class="ident" id="1546975">ns</span>&nbsp;<span class="ident" id="1546978">int64</span><span class="op" id="1546983">)</span>&nbsp;<span class="builtintype" id="1546985">bool</span>&nbsp;<span class="op" id="1546990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546993">gp</span>&nbsp;<span class="op" id="1546996">:=</span>&nbsp;<span class="ident" id="1546999">getg</span><span class="op" id="1547003">(</span><span class="op" id="1547004">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547008">if</span>&nbsp;<span class="ident" id="1547011">ns</span>&nbsp;<span class="op" id="1547014">&lt;</span>&nbsp;<span class="num" id="1547016">0</span>&nbsp;<span class="op" id="1547018">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547022">for</span>&nbsp;<span class="ident" id="1547026">atomicload</span><span class="op" id="1547036">(</span><span class="ident" id="1547037">key32</span><span class="op" id="1547042">(</span><span class="op" id="1547043">&amp;</span><span class="ident" id="1547044">n</span><span class="op" id="1547045">.</span><span class="ident" id="1547046">key</span><span class="op" id="1547049">)</span><span class="op" id="1547050">)</span>&nbsp;<span class="op" id="1547052">==</span>&nbsp;<span class="num" id="1547055">0</span>&nbsp;<span class="op" id="1547057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547062">gp</span><span class="op" id="1547064">.</span><span class="ident" id="1547065">m</span><span class="op" id="1547066">.</span><span class="ident" id="1547067">blocked</span>&nbsp;<span class="op" id="1547075">=</span>&nbsp;<span class="builtintype" id="1547077">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547085">futexsleep</span><span class="op" id="1547095">(</span><span class="ident" id="1547096">key32</span><span class="op" id="1547101">(</span><span class="op" id="1547102">&amp;</span><span class="ident" id="1547103">n</span><span class="op" id="1547104">.</span><span class="ident" id="1547105">key</span><span class="op" id="1547108">)</span><span class="op" id="1547109">,</span>&nbsp;<span class="num" id="1547111">0</span><span class="op" id="1547112">,</span>&nbsp;<span class="op" id="1547114">-</span><span class="num" id="1547115">1</span><span class="op" id="1547116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547121">gp</span><span class="op" id="1547123">.</span><span class="ident" id="1547124">m</span><span class="op" id="1547125">.</span><span class="ident" id="1547126">blocked</span>&nbsp;<span class="op" id="1547134">=</span>&nbsp;<span class="builtintype" id="1547136">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1547144">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547148">return</span>&nbsp;<span class="builtintype" id="1547155">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1547161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547165">if</span>&nbsp;<span class="ident" id="1547168">atomicload</span><span class="op" id="1547178">(</span><span class="ident" id="1547179">key32</span><span class="op" id="1547184">(</span><span class="op" id="1547185">&amp;</span><span class="ident" id="1547186">n</span><span class="op" id="1547187">.</span><span class="ident" id="1547188">key</span><span class="op" id="1547191">)</span><span class="op" id="1547192">)</span>&nbsp;<span class="op" id="1547194">!=</span>&nbsp;<span class="num" id="1547197">0</span>&nbsp;<span class="op" id="1547199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547203">return</span>&nbsp;<span class="builtintype" id="1547210">true</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1547216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547220">deadline</span>&nbsp;<span class="op" id="1547229">:=</span>&nbsp;<span class="ident" id="1547232">nanotime</span><span class="op" id="1547240">(</span><span class="op" id="1547241">)</span>&nbsp;<span class="op" id="1547243">+</span>&nbsp;<span class="ident" id="1547245">ns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547249">for</span>&nbsp;<span class="op" id="1547253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547257">gp</span><span class="op" id="1547259">.</span><span class="ident" id="1547260">m</span><span class="op" id="1547261">.</span><span class="ident" id="1547262">blocked</span>&nbsp;<span class="op" id="1547270">=</span>&nbsp;<span class="builtintype" id="1547272">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547279">futexsleep</span><span class="op" id="1547289">(</span><span class="ident" id="1547290">key32</span><span class="op" id="1547295">(</span><span class="op" id="1547296">&amp;</span><span class="ident" id="1547297">n</span><span class="op" id="1547298">.</span><span class="ident" id="1547299">key</span><span class="op" id="1547302">)</span><span class="op" id="1547303">,</span>&nbsp;<span class="num" id="1547305">0</span><span class="op" id="1547306">,</span>&nbsp;<span class="ident" id="1547308">ns</span><span class="op" id="1547310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547314">gp</span><span class="op" id="1547316">.</span><span class="ident" id="1547317">m</span><span class="op" id="1547318">.</span><span class="ident" id="1547319">blocked</span>&nbsp;<span class="op" id="1547327">=</span>&nbsp;<span class="builtintype" id="1547329">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547337">if</span>&nbsp;<span class="ident" id="1547340">atomicload</span><span class="op" id="1547350">(</span><span class="ident" id="1547351">key32</span><span class="op" id="1547356">(</span><span class="op" id="1547357">&amp;</span><span class="ident" id="1547358">n</span><span class="op" id="1547359">.</span><span class="ident" id="1547360">key</span><span class="op" id="1547363">)</span><span class="op" id="1547364">)</span>&nbsp;<span class="op" id="1547366">!=</span>&nbsp;<span class="num" id="1547369">0</span>&nbsp;<span class="op" id="1547371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547376">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1547384">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547388">now</span>&nbsp;<span class="op" id="1547392">:=</span>&nbsp;<span class="ident" id="1547395">nanotime</span><span class="op" id="1547403">(</span><span class="op" id="1547404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547408">if</span>&nbsp;<span class="ident" id="1547411">now</span>&nbsp;<span class="op" id="1547415">&gt;=</span>&nbsp;<span class="ident" id="1547418">deadline</span>&nbsp;<span class="op" id="1547427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547432">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1547440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547444">ns</span>&nbsp;<span class="op" id="1547447">=</span>&nbsp;<span class="ident" id="1547449">deadline</span>&nbsp;<span class="op" id="1547458">-</span>&nbsp;<span class="ident" id="1547460">now</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1547465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547468">return</span>&nbsp;<span class="ident" id="1547475">atomicload</span><span class="op" id="1547485">(</span><span class="ident" id="1547486">key32</span><span class="op" id="1547491">(</span><span class="op" id="1547492">&amp;</span><span class="ident" id="1547493">n</span><span class="op" id="1547494">.</span><span class="ident" id="1547495">key</span><span class="op" id="1547498">)</span><span class="op" id="1547499">)</span>&nbsp;<span class="op" id="1547501">!=</span>&nbsp;<span class="num" id="1547504">0</span><br>
<span class="lineno"></span><span class="op" id="1547506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1547509">func</span>&nbsp;<span class="ident" id="1547514">notetsleep</span><span class="op" id="1547524">(</span><span class="ident" id="1547525">n</span>&nbsp;<span class="op" id="1547527">*</span><span class="ident" id="1547528">note</span><span class="op" id="1547532">,</span>&nbsp;<span class="ident" id="1547534">ns</span>&nbsp;<span class="ident" id="1547537">int64</span><span class="op" id="1547542">)</span>&nbsp;<span class="builtintype" id="1547544">bool</span>&nbsp;<span class="op" id="1547549">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547552">gp</span>&nbsp;<span class="op" id="1547555">:=</span>&nbsp;<span class="ident" id="1547558">getg</span><span class="op" id="1547562">(</span><span class="op" id="1547563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547566">if</span>&nbsp;<span class="ident" id="1547569">gp</span>&nbsp;<span class="op" id="1547572">!=</span>&nbsp;<span class="ident" id="1547575">gp</span><span class="op" id="1547577">.</span><span class="ident" id="1547578">m</span><span class="op" id="1547579">.</span><span class="ident" id="1547580">g0</span>&nbsp;<span class="op" id="1547583">&amp;&amp;</span>&nbsp;<span class="ident" id="1547586">gp</span><span class="op" id="1547588">.</span><span class="ident" id="1547589">m</span><span class="op" id="1547590">.</span><span class="ident" id="1547591">gcing</span>&nbsp;<span class="op" id="1547597">==</span>&nbsp;<span class="num" id="1547600">0</span>&nbsp;<span class="op" id="1547602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547606">gothrow</span><span class="op" id="1547613">(</span><span class="string" id="1547614">&#34;notetsleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1547636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1547639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547643">return</span>&nbsp;<span class="ident" id="1547650">notetsleep_internal</span><span class="op" id="1547669">(</span><span class="ident" id="1547670">n</span><span class="op" id="1547671">,</span>&nbsp;<span class="ident" id="1547673">ns</span><span class="op" id="1547675">)</span><br>
<span class="lineno"></span><span class="op" id="1547677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1547680">//&nbsp;same&nbsp;as&nbsp;runtime路notetsleep,&nbsp;but&nbsp;called&nbsp;on&nbsp;user&nbsp;g&nbsp;(not&nbsp;g0)</span><br>
<span class="lineno"></span><span class="comment" id="1547742">//&nbsp;calls&nbsp;only&nbsp;nosplit&nbsp;functions&nbsp;between&nbsp;entersyscallblock/exitsyscall</span><br>
<span class="lineno">195</span><span class="keyword" id="1547812">func</span>&nbsp;<span class="ident" id="1547817">notetsleepg</span><span class="op" id="1547828">(</span><span class="ident" id="1547829">n</span>&nbsp;<span class="op" id="1547831">*</span><span class="ident" id="1547832">note</span><span class="op" id="1547836">,</span>&nbsp;<span class="ident" id="1547838">ns</span>&nbsp;<span class="ident" id="1547841">int64</span><span class="op" id="1547846">)</span>&nbsp;<span class="builtintype" id="1547848">bool</span>&nbsp;<span class="op" id="1547853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547856">gp</span>&nbsp;<span class="op" id="1547859">:=</span>&nbsp;<span class="ident" id="1547862">getg</span><span class="op" id="1547866">(</span><span class="op" id="1547867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547870">if</span>&nbsp;<span class="ident" id="1547873">gp</span>&nbsp;<span class="op" id="1547876">==</span>&nbsp;<span class="ident" id="1547879">gp</span><span class="op" id="1547881">.</span><span class="ident" id="1547882">m</span><span class="op" id="1547883">.</span><span class="ident" id="1547884">g0</span>&nbsp;<span class="op" id="1547887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547891">gothrow</span><span class="op" id="1547898">(</span><span class="string" id="1547899">&#34;notetsleepg&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1547918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1547921">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547925">entersyscallblock</span><span class="op" id="1547942">(</span><span class="op" id="1547943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547946">ok</span>&nbsp;<span class="op" id="1547949">:=</span>&nbsp;<span class="ident" id="1547952">notetsleep_internal</span><span class="op" id="1547971">(</span><span class="ident" id="1547972">n</span><span class="op" id="1547973">,</span>&nbsp;<span class="ident" id="1547975">ns</span><span class="op" id="1547977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547980">exitsyscall</span><span class="op" id="1547991">(</span><span class="op" id="1547992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547995">return</span>&nbsp;<span class="ident" id="1548002">ok</span><br>
<span class="lineno">205</span><span class="op" id="1548005">}</span>
</div>
</body>
</html>
