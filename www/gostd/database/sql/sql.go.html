<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5521066">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5521121">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5521175">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5521226">//&nbsp;Package&nbsp;sql&nbsp;provides&nbsp;a&nbsp;generic&nbsp;interface&nbsp;around&nbsp;SQL&nbsp;(or&nbsp;SQL-like)</span><br>
<span class="lineno"></span><span class="comment" id="5521295">//&nbsp;databases.</span><br>
<span class="lineno"></span><span class="comment" id="5521309">//</span><br>
<span class="lineno"></span><span class="comment" id="5521312">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;must&nbsp;be&nbsp;used&nbsp;in&nbsp;conjunction&nbsp;with&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="5521383">//&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for&nbsp;a&nbsp;list&nbsp;of&nbsp;drivers.</span><br>
<span class="lineno">10</span><span class="comment" id="5521444">//</span><br>
<span class="lineno"></span><span class="comment" id="5521447">//&nbsp;For&nbsp;more&nbsp;usage&nbsp;examples,&nbsp;see&nbsp;the&nbsp;wiki&nbsp;page&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5521496">//&nbsp;http://golang.org/s/sqlwiki.</span><br>
<span class="lineno"></span><span class="keyword" id="5521528">package</span>&nbsp;<span class="ident" id="5521536">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5521541">import</span>&nbsp;<span class="op" id="5521548">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5521551">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5521574">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5521584">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5521591">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5521597">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5521608">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5521616">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5521623">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5521626">var</span>&nbsp;<span class="ident" id="5521630">drivers</span>&nbsp;<span class="op" id="5521638">=</span>&nbsp;<span class="builtinfunc" id="5521640">make</span><span class="op" id="5521644">(</span><span class="keyword" id="5521645">map</span><span class="op" id="5521648">[</span><span class="builtintype" id="5521649">string</span><span class="op" id="5521655">]</span><span class="ident" id="5521656">driver</span><span class="op" id="5521662">.</span><span class="ident" id="5521663">Driver</span><span class="op" id="5521669">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5521672">//&nbsp;Register&nbsp;makes&nbsp;a&nbsp;database&nbsp;driver&nbsp;available&nbsp;by&nbsp;the&nbsp;provided&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="5521740">//&nbsp;If&nbsp;Register&nbsp;is&nbsp;called&nbsp;twice&nbsp;with&nbsp;the&nbsp;same&nbsp;name&nbsp;or&nbsp;if&nbsp;driver&nbsp;is&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="5521811">//&nbsp;it&nbsp;panics.</span><br>
<span class="lineno">30</span><span class="keyword" id="5521825">func</span>&nbsp;<span class="ident" id="5521830">Register</span><span class="op" id="5521838">(</span><span class="ident" id="5521839">name</span>&nbsp;<span class="builtintype" id="5521844">string</span><span class="op" id="5521850">,</span>&nbsp;<span class="ident" id="5521852">driver</span>&nbsp;<span class="ident" id="5521859">driver</span><span class="op" id="5521865">.</span><span class="ident" id="5521866">Driver</span><span class="op" id="5521872">)</span>&nbsp;<span class="op" id="5521874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5521877">if</span>&nbsp;<span class="ident" id="5521880">driver</span>&nbsp;<span class="op" id="5521887">==</span>&nbsp;<span class="ident" id="5521890">nil</span>&nbsp;<span class="op" id="5521894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5521898">panic</span><span class="op" id="5521903">(</span><span class="string" id="5521904">&#34;sql:&nbsp;Register&nbsp;driver&nbsp;is&nbsp;nil&#34;</span><span class="op" id="5521933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5521936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5521939">if</span>&nbsp;<span class="ident" id="5521942">_</span><span class="op" id="5521943">,</span>&nbsp;<span class="ident" id="5521945">dup</span>&nbsp;<span class="op" id="5521949">:=</span>&nbsp;<span class="ident" id="5521952">drivers</span><span class="op" id="5521959">[</span><span class="ident" id="5521960">name</span><span class="op" id="5521964">]</span><span class="op" id="5521965">;</span>&nbsp;<span class="ident" id="5521967">dup</span>&nbsp;<span class="op" id="5521971">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5521975">panic</span><span class="op" id="5521980">(</span><span class="string" id="5521981">&#34;sql:&nbsp;Register&nbsp;called&nbsp;twice&nbsp;for&nbsp;driver&nbsp;&#34;</span>&nbsp;<span class="op" id="5522022">+</span>&nbsp;<span class="ident" id="5522024">name</span><span class="op" id="5522028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5522031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5522034">drivers</span><span class="op" id="5522041">[</span><span class="ident" id="5522042">name</span><span class="op" id="5522046">]</span>&nbsp;<span class="op" id="5522048">=</span>&nbsp;<span class="ident" id="5522050">driver</span><br>
<span class="lineno"></span><span class="op" id="5522057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="5522060">func</span>&nbsp;<span class="ident" id="5522065">unregisterAllDrivers</span><span class="op" id="5522085">(</span><span class="op" id="5522086">)</span>&nbsp;<span class="op" id="5522088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5522091">//&nbsp;For&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5522106">drivers</span>&nbsp;<span class="op" id="5522114">=</span>&nbsp;<span class="builtinfunc" id="5522116">make</span><span class="op" id="5522120">(</span><span class="keyword" id="5522121">map</span><span class="op" id="5522124">[</span><span class="builtintype" id="5522125">string</span><span class="op" id="5522131">]</span><span class="ident" id="5522132">driver</span><span class="op" id="5522138">.</span><span class="ident" id="5522139">Driver</span><span class="op" id="5522145">)</span><br>
<span class="lineno"></span><span class="op" id="5522147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5522150">//&nbsp;Drivers&nbsp;returns&nbsp;a&nbsp;sorted&nbsp;list&nbsp;of&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;registered&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="keyword" id="5522223">func</span>&nbsp;<span class="ident" id="5522228">Drivers</span><span class="op" id="5522235">(</span><span class="op" id="5522236">)</span>&nbsp;<span class="op" id="5522238">[</span><span class="op" id="5522239">]</span><span class="builtintype" id="5522240">string</span>&nbsp;<span class="op" id="5522247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5522250">var</span>&nbsp;<span class="ident" id="5522254">list</span>&nbsp;<span class="op" id="5522259">[</span><span class="op" id="5522260">]</span><span class="builtintype" id="5522261">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5522269">for</span>&nbsp;<span class="ident" id="5522273">name</span>&nbsp;<span class="op" id="5522278">:=</span>&nbsp;<span class="keyword" id="5522281">range</span>&nbsp;<span class="ident" id="5522287">drivers</span>&nbsp;<span class="op" id="5522295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5522299">list</span>&nbsp;<span class="op" id="5522304">=</span>&nbsp;<span class="builtinfunc" id="5522306">append</span><span class="op" id="5522312">(</span><span class="ident" id="5522313">list</span><span class="op" id="5522317">,</span>&nbsp;<span class="ident" id="5522319">name</span><span class="op" id="5522323">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5522326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5522329">sort</span><span class="op" id="5522333">.</span><span class="ident" id="5522334">Strings</span><span class="op" id="5522341">(</span><span class="ident" id="5522342">list</span><span class="op" id="5522346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5522349">return</span>&nbsp;<span class="ident" id="5522356">list</span><br>
<span class="lineno"></span><span class="op" id="5522361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5522364">//&nbsp;RawBytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;slice&nbsp;that&nbsp;holds&nbsp;a&nbsp;reference&nbsp;to&nbsp;memory&nbsp;owned&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5522434">//&nbsp;the&nbsp;database&nbsp;itself.&nbsp;After&nbsp;a&nbsp;Scan&nbsp;into&nbsp;a&nbsp;RawBytes,&nbsp;the&nbsp;slice&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="5522506">//&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;call&nbsp;to&nbsp;Next,&nbsp;Scan,&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="5522560">type</span>&nbsp;<span class="ident" id="5522565">RawBytes</span>&nbsp;<span class="op" id="5522574">[</span><span class="op" id="5522575">]</span><span class="builtintype" id="5522576">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="5522582">//&nbsp;NullString&nbsp;represents&nbsp;a&nbsp;string&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5522634">//&nbsp;NullString&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5522684">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination:</span><br>
<span class="lineno"></span><span class="comment" id="5522725">//</span><br>
<span class="lineno"></span><span class="comment" id="5522728">//&nbsp;&nbsp;var&nbsp;s&nbsp;NullString</span><br>
<span class="lineno">65</span><span class="comment" id="5522749">//&nbsp;&nbsp;err&nbsp;:=&nbsp;db.QueryRow(&#34;SELECT&nbsp;name&nbsp;FROM&nbsp;foo&nbsp;WHERE&nbsp;id=?&#34;,&nbsp;id).Scan(&amp;s)</span><br>
<span class="lineno"></span><span class="comment" id="5522820">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5522828">//&nbsp;&nbsp;if&nbsp;s.Valid&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="5522845">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;use&nbsp;s.String</span><br>
<span class="lineno"></span><span class="comment" id="5522868">//&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno">70</span><span class="comment" id="5522881">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;NULL&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5522902">//&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="5522908">//</span><br>
<span class="lineno"></span><span class="keyword" id="5522911">type</span>&nbsp;<span class="ident" id="5522916">NullString</span>&nbsp;<span class="keyword" id="5522927">struct</span>&nbsp;<span class="op" id="5522934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5522937">String</span>&nbsp;<span class="builtintype" id="5522944">string</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5522952">Valid</span>&nbsp;&nbsp;<span class="builtintype" id="5522959">bool</span>&nbsp;<span class="comment" id="5522964">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;String&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5523003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5523006">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5523048">func</span>&nbsp;<span class="op" id="5523053">(</span><span class="ident" id="5523054">ns</span>&nbsp;<span class="op" id="5523057">*</span><span class="ident" id="5523058">NullString</span><span class="op" id="5523068">)</span>&nbsp;<span class="ident" id="5523070">Scan</span><span class="op" id="5523074">(</span><span class="ident" id="5523075">value</span>&nbsp;<span class="keyword" id="5523081">interface</span><span class="op" id="5523090">{</span><span class="op" id="5523091">}</span><span class="op" id="5523092">)</span>&nbsp;<span class="builtintype" id="5523094">error</span>&nbsp;<span class="op" id="5523100">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5523103">if</span>&nbsp;<span class="ident" id="5523106">value</span>&nbsp;<span class="op" id="5523112">==</span>&nbsp;<span class="ident" id="5523115">nil</span>&nbsp;<span class="op" id="5523119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5523123">ns</span><span class="op" id="5523125">.</span><span class="ident" id="5523126">String</span><span class="op" id="5523132">,</span>&nbsp;<span class="ident" id="5523134">ns</span><span class="op" id="5523136">.</span><span class="ident" id="5523137">Valid</span>&nbsp;<span class="op" id="5523143">=</span>&nbsp;<span class="string" id="5523145">&#34;&#34;</span><span class="op" id="5523147">,</span>&nbsp;<span class="builtintype" id="5523149">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5523157">return</span>&nbsp;<span class="ident" id="5523164">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5523169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5523172">ns</span><span class="op" id="5523174">.</span><span class="ident" id="5523175">Valid</span>&nbsp;<span class="op" id="5523181">=</span>&nbsp;<span class="builtintype" id="5523183">true</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5523189">return</span>&nbsp;<span class="ident" id="5523196">convertAssign</span><span class="op" id="5523209">(</span><span class="op" id="5523210">&amp;</span><span class="ident" id="5523211">ns</span><span class="op" id="5523213">.</span><span class="ident" id="5523214">String</span><span class="op" id="5523220">,</span>&nbsp;<span class="ident" id="5523222">value</span><span class="op" id="5523227">)</span><br>
<span class="lineno"></span><span class="op" id="5523229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5523232">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5523281">func</span>&nbsp;<span class="op" id="5523286">(</span><span class="ident" id="5523287">ns</span>&nbsp;<span class="ident" id="5523290">NullString</span><span class="op" id="5523300">)</span>&nbsp;<span class="ident" id="5523302">Value</span><span class="op" id="5523307">(</span><span class="op" id="5523308">)</span>&nbsp;<span class="op" id="5523310">(</span><span class="ident" id="5523311">driver</span><span class="op" id="5523317">.</span><span class="ident" id="5523318">Value</span><span class="op" id="5523323">,</span>&nbsp;<span class="builtintype" id="5523325">error</span><span class="op" id="5523330">)</span>&nbsp;<span class="op" id="5523332">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5523335">if</span>&nbsp;<span class="op" id="5523338">!</span><span class="ident" id="5523339">ns</span><span class="op" id="5523341">.</span><span class="ident" id="5523342">Valid</span>&nbsp;<span class="op" id="5523348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5523352">return</span>&nbsp;<span class="ident" id="5523359">nil</span><span class="op" id="5523362">,</span>&nbsp;<span class="ident" id="5523364">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5523369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5523372">return</span>&nbsp;<span class="ident" id="5523379">ns</span><span class="op" id="5523381">.</span><span class="ident" id="5523382">String</span><span class="op" id="5523388">,</span>&nbsp;<span class="ident" id="5523390">nil</span><br>
<span class="lineno"></span><span class="op" id="5523394">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="5523397">//&nbsp;NullInt64&nbsp;represents&nbsp;an&nbsp;int64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5523448">//&nbsp;NullInt64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5523497">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="5523561">type</span>&nbsp;<span class="ident" id="5523566">NullInt64</span>&nbsp;<span class="keyword" id="5523576">struct</span>&nbsp;<span class="op" id="5523583">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5523586">Int64</span>&nbsp;<span class="ident" id="5523592">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5523599">Valid</span>&nbsp;<span class="builtintype" id="5523605">bool</span>&nbsp;<span class="comment" id="5523610">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Int64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5523648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5523651">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno">105</span><span class="keyword" id="5523693">func</span>&nbsp;<span class="op" id="5523698">(</span><span class="ident" id="5523699">n</span>&nbsp;<span class="op" id="5523701">*</span><span class="ident" id="5523702">NullInt64</span><span class="op" id="5523711">)</span>&nbsp;<span class="ident" id="5523713">Scan</span><span class="op" id="5523717">(</span><span class="ident" id="5523718">value</span>&nbsp;<span class="keyword" id="5523724">interface</span><span class="op" id="5523733">{</span><span class="op" id="5523734">}</span><span class="op" id="5523735">)</span>&nbsp;<span class="builtintype" id="5523737">error</span>&nbsp;<span class="op" id="5523743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5523746">if</span>&nbsp;<span class="ident" id="5523749">value</span>&nbsp;<span class="op" id="5523755">==</span>&nbsp;<span class="ident" id="5523758">nil</span>&nbsp;<span class="op" id="5523762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5523766">n</span><span class="op" id="5523767">.</span><span class="ident" id="5523768">Int64</span><span class="op" id="5523773">,</span>&nbsp;<span class="ident" id="5523775">n</span><span class="op" id="5523776">.</span><span class="ident" id="5523777">Valid</span>&nbsp;<span class="op" id="5523783">=</span>&nbsp;<span class="num" id="5523785">0</span><span class="op" id="5523786">,</span>&nbsp;<span class="builtintype" id="5523788">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5523796">return</span>&nbsp;<span class="ident" id="5523803">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5523808">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5523811">n</span><span class="op" id="5523812">.</span><span class="ident" id="5523813">Valid</span>&nbsp;<span class="op" id="5523819">=</span>&nbsp;<span class="builtintype" id="5523821">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5523827">return</span>&nbsp;<span class="ident" id="5523834">convertAssign</span><span class="op" id="5523847">(</span><span class="op" id="5523848">&amp;</span><span class="ident" id="5523849">n</span><span class="op" id="5523850">.</span><span class="ident" id="5523851">Int64</span><span class="op" id="5523856">,</span>&nbsp;<span class="ident" id="5523858">value</span><span class="op" id="5523863">)</span><br>
<span class="lineno"></span><span class="op" id="5523865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5523868">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno">115</span><span class="keyword" id="5523917">func</span>&nbsp;<span class="op" id="5523922">(</span><span class="ident" id="5523923">n</span>&nbsp;<span class="ident" id="5523925">NullInt64</span><span class="op" id="5523934">)</span>&nbsp;<span class="ident" id="5523936">Value</span><span class="op" id="5523941">(</span><span class="op" id="5523942">)</span>&nbsp;<span class="op" id="5523944">(</span><span class="ident" id="5523945">driver</span><span class="op" id="5523951">.</span><span class="ident" id="5523952">Value</span><span class="op" id="5523957">,</span>&nbsp;<span class="builtintype" id="5523959">error</span><span class="op" id="5523964">)</span>&nbsp;<span class="op" id="5523966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5523969">if</span>&nbsp;<span class="op" id="5523972">!</span><span class="ident" id="5523973">n</span><span class="op" id="5523974">.</span><span class="ident" id="5523975">Valid</span>&nbsp;<span class="op" id="5523981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5523985">return</span>&nbsp;<span class="ident" id="5523992">nil</span><span class="op" id="5523995">,</span>&nbsp;<span class="ident" id="5523997">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5524002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5524005">return</span>&nbsp;<span class="ident" id="5524012">n</span><span class="op" id="5524013">.</span><span class="ident" id="5524014">Int64</span><span class="op" id="5524019">,</span>&nbsp;<span class="ident" id="5524021">nil</span><br>
<span class="lineno">120</span><span class="op" id="5524025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5524028">//&nbsp;NullFloat64&nbsp;represents&nbsp;a&nbsp;float64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5524082">//&nbsp;NullFloat64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5524133">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno">125</span><span class="keyword" id="5524197">type</span>&nbsp;<span class="ident" id="5524202">NullFloat64</span>&nbsp;<span class="keyword" id="5524214">struct</span>&nbsp;<span class="op" id="5524221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5524224">Float64</span>&nbsp;<span class="builtintype" id="5524232">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5524241">Valid</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5524249">bool</span>&nbsp;<span class="comment" id="5524254">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Float64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5524294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="5524297">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5524339">func</span>&nbsp;<span class="op" id="5524344">(</span><span class="ident" id="5524345">n</span>&nbsp;<span class="op" id="5524347">*</span><span class="ident" id="5524348">NullFloat64</span><span class="op" id="5524359">)</span>&nbsp;<span class="ident" id="5524361">Scan</span><span class="op" id="5524365">(</span><span class="ident" id="5524366">value</span>&nbsp;<span class="keyword" id="5524372">interface</span><span class="op" id="5524381">{</span><span class="op" id="5524382">}</span><span class="op" id="5524383">)</span>&nbsp;<span class="builtintype" id="5524385">error</span>&nbsp;<span class="op" id="5524391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5524394">if</span>&nbsp;<span class="ident" id="5524397">value</span>&nbsp;<span class="op" id="5524403">==</span>&nbsp;<span class="ident" id="5524406">nil</span>&nbsp;<span class="op" id="5524410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5524414">n</span><span class="op" id="5524415">.</span><span class="ident" id="5524416">Float64</span><span class="op" id="5524423">,</span>&nbsp;<span class="ident" id="5524425">n</span><span class="op" id="5524426">.</span><span class="ident" id="5524427">Valid</span>&nbsp;<span class="op" id="5524433">=</span>&nbsp;<span class="num" id="5524435">0</span><span class="op" id="5524436">,</span>&nbsp;<span class="builtintype" id="5524438">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5524446">return</span>&nbsp;<span class="ident" id="5524453">nil</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5524458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5524461">n</span><span class="op" id="5524462">.</span><span class="ident" id="5524463">Valid</span>&nbsp;<span class="op" id="5524469">=</span>&nbsp;<span class="builtintype" id="5524471">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5524477">return</span>&nbsp;<span class="ident" id="5524484">convertAssign</span><span class="op" id="5524497">(</span><span class="op" id="5524498">&amp;</span><span class="ident" id="5524499">n</span><span class="op" id="5524500">.</span><span class="ident" id="5524501">Float64</span><span class="op" id="5524508">,</span>&nbsp;<span class="ident" id="5524510">value</span><span class="op" id="5524515">)</span><br>
<span class="lineno"></span><span class="op" id="5524517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="5524520">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5524569">func</span>&nbsp;<span class="op" id="5524574">(</span><span class="ident" id="5524575">n</span>&nbsp;<span class="ident" id="5524577">NullFloat64</span><span class="op" id="5524588">)</span>&nbsp;<span class="ident" id="5524590">Value</span><span class="op" id="5524595">(</span><span class="op" id="5524596">)</span>&nbsp;<span class="op" id="5524598">(</span><span class="ident" id="5524599">driver</span><span class="op" id="5524605">.</span><span class="ident" id="5524606">Value</span><span class="op" id="5524611">,</span>&nbsp;<span class="builtintype" id="5524613">error</span><span class="op" id="5524618">)</span>&nbsp;<span class="op" id="5524620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5524623">if</span>&nbsp;<span class="op" id="5524626">!</span><span class="ident" id="5524627">n</span><span class="op" id="5524628">.</span><span class="ident" id="5524629">Valid</span>&nbsp;<span class="op" id="5524635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5524639">return</span>&nbsp;<span class="ident" id="5524646">nil</span><span class="op" id="5524649">,</span>&nbsp;<span class="ident" id="5524651">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5524656">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5524659">return</span>&nbsp;<span class="ident" id="5524666">n</span><span class="op" id="5524667">.</span><span class="ident" id="5524668">Float64</span><span class="op" id="5524675">,</span>&nbsp;<span class="ident" id="5524677">nil</span><br>
<span class="lineno"></span><span class="op" id="5524681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5524684">//&nbsp;NullBool&nbsp;represents&nbsp;a&nbsp;bool&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5524732">//&nbsp;NullBool&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="5524780">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="5524844">type</span>&nbsp;<span class="ident" id="5524849">NullBool</span>&nbsp;<span class="keyword" id="5524858">struct</span>&nbsp;<span class="op" id="5524865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5524868">Bool</span>&nbsp;&nbsp;<span class="builtintype" id="5524874">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5524880">Valid</span>&nbsp;<span class="builtintype" id="5524886">bool</span>&nbsp;<span class="comment" id="5524891">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Bool&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5524928">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5524931">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5524973">func</span>&nbsp;<span class="op" id="5524978">(</span><span class="ident" id="5524979">n</span>&nbsp;<span class="op" id="5524981">*</span><span class="ident" id="5524982">NullBool</span><span class="op" id="5524990">)</span>&nbsp;<span class="ident" id="5524992">Scan</span><span class="op" id="5524996">(</span><span class="ident" id="5524997">value</span>&nbsp;<span class="keyword" id="5525003">interface</span><span class="op" id="5525012">{</span><span class="op" id="5525013">}</span><span class="op" id="5525014">)</span>&nbsp;<span class="builtintype" id="5525016">error</span>&nbsp;<span class="op" id="5525022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5525025">if</span>&nbsp;<span class="ident" id="5525028">value</span>&nbsp;<span class="op" id="5525034">==</span>&nbsp;<span class="ident" id="5525037">nil</span>&nbsp;<span class="op" id="5525041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525045">n</span><span class="op" id="5525046">.</span><span class="ident" id="5525047">Bool</span><span class="op" id="5525051">,</span>&nbsp;<span class="ident" id="5525053">n</span><span class="op" id="5525054">.</span><span class="ident" id="5525055">Valid</span>&nbsp;<span class="op" id="5525061">=</span>&nbsp;<span class="builtintype" id="5525063">false</span><span class="op" id="5525068">,</span>&nbsp;<span class="builtintype" id="5525070">false</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5525078">return</span>&nbsp;<span class="ident" id="5525085">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5525090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525093">n</span><span class="op" id="5525094">.</span><span class="ident" id="5525095">Valid</span>&nbsp;<span class="op" id="5525101">=</span>&nbsp;<span class="builtintype" id="5525103">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5525109">return</span>&nbsp;<span class="ident" id="5525116">convertAssign</span><span class="op" id="5525129">(</span><span class="op" id="5525130">&amp;</span><span class="ident" id="5525131">n</span><span class="op" id="5525132">.</span><span class="ident" id="5525133">Bool</span><span class="op" id="5525137">,</span>&nbsp;<span class="ident" id="5525139">value</span><span class="op" id="5525144">)</span><br>
<span class="lineno"></span><span class="op" id="5525146">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="5525149">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5525198">func</span>&nbsp;<span class="op" id="5525203">(</span><span class="ident" id="5525204">n</span>&nbsp;<span class="ident" id="5525206">NullBool</span><span class="op" id="5525214">)</span>&nbsp;<span class="ident" id="5525216">Value</span><span class="op" id="5525221">(</span><span class="op" id="5525222">)</span>&nbsp;<span class="op" id="5525224">(</span><span class="ident" id="5525225">driver</span><span class="op" id="5525231">.</span><span class="ident" id="5525232">Value</span><span class="op" id="5525237">,</span>&nbsp;<span class="builtintype" id="5525239">error</span><span class="op" id="5525244">)</span>&nbsp;<span class="op" id="5525246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5525249">if</span>&nbsp;<span class="op" id="5525252">!</span><span class="ident" id="5525253">n</span><span class="op" id="5525254">.</span><span class="ident" id="5525255">Valid</span>&nbsp;<span class="op" id="5525261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5525265">return</span>&nbsp;<span class="ident" id="5525272">nil</span><span class="op" id="5525275">,</span>&nbsp;<span class="ident" id="5525277">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5525282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5525285">return</span>&nbsp;<span class="ident" id="5525292">n</span><span class="op" id="5525293">.</span><span class="ident" id="5525294">Bool</span><span class="op" id="5525298">,</span>&nbsp;<span class="ident" id="5525300">nil</span><br>
<span class="lineno"></span><span class="op" id="5525304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5525307">//&nbsp;Scanner&nbsp;is&nbsp;an&nbsp;interface&nbsp;used&nbsp;by&nbsp;Scan.</span><br>
<span class="lineno">175</span><span class="keyword" id="5525348">type</span>&nbsp;<span class="ident" id="5525353">Scanner</span>&nbsp;<span class="keyword" id="5525361">interface</span>&nbsp;<span class="op" id="5525371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5525374">//&nbsp;Scan&nbsp;assigns&nbsp;a&nbsp;value&nbsp;from&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5525423">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5525427">//&nbsp;The&nbsp;src&nbsp;value&nbsp;will&nbsp;be&nbsp;of&nbsp;one&nbsp;of&nbsp;the&nbsp;following&nbsp;restricted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5525488">//&nbsp;set&nbsp;of&nbsp;types:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5525506">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5525510">//&nbsp;&nbsp;&nbsp;&nbsp;int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5525523">//&nbsp;&nbsp;&nbsp;&nbsp;float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5525538">//&nbsp;&nbsp;&nbsp;&nbsp;bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5525550">//&nbsp;&nbsp;&nbsp;&nbsp;[]byte</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5525564">//&nbsp;&nbsp;&nbsp;&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5525578">//&nbsp;&nbsp;&nbsp;&nbsp;time.Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5525595">//&nbsp;&nbsp;&nbsp;&nbsp;nil&nbsp;-&nbsp;for&nbsp;NULL&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5525624">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5525628">//&nbsp;An&nbsp;error&nbsp;should&nbsp;be&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;can&nbsp;not&nbsp;be&nbsp;stored</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5525691">//&nbsp;without&nbsp;loss&nbsp;of&nbsp;information.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525724">Scan</span><span class="op" id="5525728">(</span><span class="ident" id="5525729">src</span>&nbsp;<span class="keyword" id="5525733">interface</span><span class="op" id="5525742">{</span><span class="op" id="5525743">}</span><span class="op" id="5525744">)</span>&nbsp;<span class="builtintype" id="5525746">error</span><br>
<span class="lineno"></span><span class="op" id="5525752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5525755">//&nbsp;ErrNoRows&nbsp;is&nbsp;returned&nbsp;by&nbsp;Scan&nbsp;when&nbsp;QueryRow&nbsp;doesn&#39;t&nbsp;return&nbsp;a</span><br>
<span class="lineno">195</span><span class="comment" id="5525819">//&nbsp;row.&nbsp;In&nbsp;such&nbsp;a&nbsp;case,&nbsp;QueryRow&nbsp;returns&nbsp;a&nbsp;placeholder&nbsp;*Row&nbsp;value&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5525890">//&nbsp;defers&nbsp;this&nbsp;error&nbsp;until&nbsp;a&nbsp;Scan.</span><br>
<span class="lineno"></span><span class="keyword" id="5525925">var</span>&nbsp;<span class="ident" id="5525929">ErrNoRows</span>&nbsp;<span class="op" id="5525939">=</span>&nbsp;<span class="ident" id="5525941">errors</span><span class="op" id="5525947">.</span><span class="ident" id="5525948">New</span><span class="op" id="5525951">(</span><span class="string" id="5525952">&#34;sql:&nbsp;no&nbsp;rows&nbsp;in&nbsp;result&nbsp;set&#34;</span><span class="op" id="5525980">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5525983">//&nbsp;DB&nbsp;is&nbsp;a&nbsp;database&nbsp;handle&nbsp;representing&nbsp;a&nbsp;pool&nbsp;of&nbsp;zero&nbsp;or&nbsp;more</span><br>
<span class="lineno">200</span><span class="comment" id="5526046">//&nbsp;underlying&nbsp;connections.&nbsp;It&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple</span><br>
<span class="lineno"></span><span class="comment" id="5526114">//&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="5526129">//</span><br>
<span class="lineno"></span><span class="comment" id="5526132">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;creates&nbsp;and&nbsp;frees&nbsp;connections&nbsp;automatically;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5526199">//&nbsp;also&nbsp;maintains&nbsp;a&nbsp;free&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;If&nbsp;the&nbsp;database&nbsp;has</span><br>
<span class="lineno">205</span><span class="comment" id="5526270">//&nbsp;a&nbsp;concept&nbsp;of&nbsp;per-connection&nbsp;state,&nbsp;such&nbsp;state&nbsp;can&nbsp;only&nbsp;be&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="5526340">//&nbsp;observed&nbsp;within&nbsp;a&nbsp;transaction.&nbsp;Once&nbsp;DB.Begin&nbsp;is&nbsp;called,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5526403">//&nbsp;returned&nbsp;Tx&nbsp;is&nbsp;bound&nbsp;to&nbsp;a&nbsp;single&nbsp;connection.&nbsp;Once&nbsp;Commit&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5526466">//&nbsp;Rollback&nbsp;is&nbsp;called&nbsp;on&nbsp;the&nbsp;transaction,&nbsp;that&nbsp;transaction&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="5526527">//&nbsp;connection&nbsp;is&nbsp;returned&nbsp;to&nbsp;DB&#39;s&nbsp;idle&nbsp;connection&nbsp;pool.&nbsp;The&nbsp;pool&nbsp;size</span><br>
<span class="lineno">210</span><span class="comment" id="5526597">//&nbsp;can&nbsp;be&nbsp;controlled&nbsp;with&nbsp;SetMaxIdleConns.</span><br>
<span class="lineno"></span><span class="keyword" id="5526640">type</span>&nbsp;<span class="ident" id="5526645">DB</span>&nbsp;<span class="keyword" id="5526648">struct</span>&nbsp;<span class="op" id="5526655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526658">driver</span>&nbsp;<span class="ident" id="5526665">driver</span><span class="op" id="5526671">.</span><span class="ident" id="5526672">Driver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526680">dsn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5526687">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526696">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5526709">sync</span><span class="op" id="5526713">.</span><span class="ident" id="5526714">Mutex</span>&nbsp;<span class="comment" id="5526720">//&nbsp;protects&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526750">freeConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5526763">[</span><span class="op" id="5526764">]</span><span class="op" id="5526765">*</span><span class="ident" id="5526766">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526778">connRequests</span>&nbsp;<span class="op" id="5526791">[</span><span class="op" id="5526792">]</span><span class="keyword" id="5526793">chan</span>&nbsp;<span class="ident" id="5526798">connRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526811">numOpen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5526824">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526829">pendingOpens</span>&nbsp;<span class="builtintype" id="5526842">int</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5526847">//&nbsp;Used&nbsp;to&nbsp;signal&nbsp;the&nbsp;need&nbsp;for&nbsp;new&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5526895">//&nbsp;a&nbsp;goroutine&nbsp;running&nbsp;connectionOpener()&nbsp;reads&nbsp;on&nbsp;this&nbsp;chan&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5526961">//&nbsp;maybeOpenNewConnections&nbsp;sends&nbsp;on&nbsp;the&nbsp;chan&nbsp;(one&nbsp;send&nbsp;per&nbsp;needed&nbsp;connection)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5527040">//&nbsp;It&nbsp;is&nbsp;closed&nbsp;during&nbsp;db.Close().&nbsp;The&nbsp;close&nbsp;tells&nbsp;the&nbsp;connectionOpener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5527113">//&nbsp;goroutine&nbsp;to&nbsp;exit.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527136">openerCh</span>&nbsp;<span class="keyword" id="5527145">chan</span>&nbsp;<span class="keyword" id="5527150">struct</span><span class="op" id="5527156">{</span><span class="op" id="5527157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527160">closed</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5527169">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527175">dep</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5527184">map</span><span class="op" id="5527187">[</span><span class="ident" id="5527188">finalCloser</span><span class="op" id="5527199">]</span><span class="ident" id="5527200">depSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527208">lastPut</span>&nbsp;&nbsp;<span class="keyword" id="5527217">map</span><span class="op" id="5527220">[</span><span class="op" id="5527221">*</span><span class="ident" id="5527222">driverConn</span><span class="op" id="5527232">]</span><span class="builtintype" id="5527233">string</span>&nbsp;<span class="comment" id="5527240">//&nbsp;stacktrace&nbsp;of&nbsp;last&nbsp;conn&#39;s&nbsp;put;&nbsp;debug&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527286">maxIdle</span>&nbsp;&nbsp;<span class="builtintype" id="5527295">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5527318">//&nbsp;zero&nbsp;means&nbsp;defaultMaxIdleConns;&nbsp;negative&nbsp;means&nbsp;0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527371">maxOpen</span>&nbsp;&nbsp;<span class="builtintype" id="5527380">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5527403">//&nbsp;&lt;=&nbsp;0&nbsp;means&nbsp;unlimited</span><br>
<span class="lineno"></span><span class="op" id="5527427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5527430">//&nbsp;driverConn&nbsp;wraps&nbsp;a&nbsp;driver.Conn&nbsp;with&nbsp;a&nbsp;mutex,&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5527481">//&nbsp;be&nbsp;held&nbsp;during&nbsp;all&nbsp;calls&nbsp;into&nbsp;the&nbsp;Conn.&nbsp;(including&nbsp;any&nbsp;calls&nbsp;onto</span><br>
<span class="lineno">235</span><span class="comment" id="5527550">//&nbsp;interfaces&nbsp;returned&nbsp;via&nbsp;that&nbsp;Conn,&nbsp;such&nbsp;as&nbsp;calls&nbsp;on&nbsp;Tx,&nbsp;Stmt,</span><br>
<span class="lineno"></span><span class="comment" id="5527615">//&nbsp;Result,&nbsp;Rows)</span><br>
<span class="lineno"></span><span class="keyword" id="5527632">type</span>&nbsp;<span class="ident" id="5527637">driverConn</span>&nbsp;<span class="keyword" id="5527648">struct</span>&nbsp;<span class="op" id="5527655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527658">db</span>&nbsp;<span class="op" id="5527661">*</span><span class="ident" id="5527662">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527667">sync</span><span class="op" id="5527671">.</span><span class="ident" id="5527672">Mutex</span>&nbsp;&nbsp;<span class="comment" id="5527679">//&nbsp;guards&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527700">ci</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5527712">driver</span><span class="op" id="5527718">.</span><span class="ident" id="5527719">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527725">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5527737">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527743">finalClosed</span>&nbsp;<span class="builtintype" id="5527755">bool</span>&nbsp;<span class="comment" id="5527760">//&nbsp;ci.Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527789">openStmt</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5527801">map</span><span class="op" id="5527804">[</span><span class="ident" id="5527805">driver</span><span class="op" id="5527811">.</span><span class="ident" id="5527812">Stmt</span><span class="op" id="5527816">]</span><span class="builtintype" id="5527817">bool</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5527824">//&nbsp;guarded&nbsp;by&nbsp;db.mu</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527845">inUse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5527856">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527862">onPut</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5527873">[</span><span class="op" id="5527874">]</span><span class="keyword" id="5527875">func</span><span class="op" id="5527879">(</span><span class="op" id="5527880">)</span>&nbsp;<span class="comment" id="5527882">//&nbsp;code&nbsp;(with&nbsp;db.mu&nbsp;held)&nbsp;run&nbsp;when&nbsp;conn&nbsp;is&nbsp;next&nbsp;returned</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527940">dbmuClosed</span>&nbsp;<span class="builtintype" id="5527951">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5527960">//&nbsp;same&nbsp;as&nbsp;closed,&nbsp;but&nbsp;guarded&nbsp;by&nbsp;db.mu,&nbsp;for&nbsp;connIfFree</span><br>
<span class="lineno">250</span><span class="op" id="5528016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5528019">func</span>&nbsp;<span class="op" id="5528024">(</span><span class="ident" id="5528025">dc</span>&nbsp;<span class="op" id="5528028">*</span><span class="ident" id="5528029">driverConn</span><span class="op" id="5528039">)</span>&nbsp;<span class="ident" id="5528041">releaseConn</span><span class="op" id="5528052">(</span><span class="ident" id="5528053">err</span>&nbsp;<span class="builtintype" id="5528057">error</span><span class="op" id="5528062">)</span>&nbsp;<span class="op" id="5528064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528067">dc</span><span class="op" id="5528069">.</span><span class="ident" id="5528070">db</span><span class="op" id="5528072">.</span><span class="ident" id="5528073">putConn</span><span class="op" id="5528080">(</span><span class="ident" id="5528081">dc</span><span class="op" id="5528083">,</span>&nbsp;<span class="ident" id="5528085">err</span><span class="op" id="5528088">)</span><br>
<span class="lineno"></span><span class="op" id="5528090">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="5528093">func</span>&nbsp;<span class="op" id="5528098">(</span><span class="ident" id="5528099">dc</span>&nbsp;<span class="op" id="5528102">*</span><span class="ident" id="5528103">driverConn</span><span class="op" id="5528113">)</span>&nbsp;<span class="ident" id="5528115">removeOpenStmt</span><span class="op" id="5528129">(</span><span class="ident" id="5528130">si</span>&nbsp;<span class="ident" id="5528133">driver</span><span class="op" id="5528139">.</span><span class="ident" id="5528140">Stmt</span><span class="op" id="5528144">)</span>&nbsp;<span class="op" id="5528146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528149">dc</span><span class="op" id="5528151">.</span><span class="ident" id="5528152">Lock</span><span class="op" id="5528156">(</span><span class="op" id="5528157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5528160">defer</span>&nbsp;<span class="ident" id="5528166">dc</span><span class="op" id="5528168">.</span><span class="ident" id="5528169">Unlock</span><span class="op" id="5528175">(</span><span class="op" id="5528176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5528179">delete</span><span class="op" id="5528185">(</span><span class="ident" id="5528186">dc</span><span class="op" id="5528188">.</span><span class="ident" id="5528189">openStmt</span><span class="op" id="5528197">,</span>&nbsp;<span class="ident" id="5528199">si</span><span class="op" id="5528201">)</span><br>
<span class="lineno">260</span><span class="op" id="5528203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5528206">func</span>&nbsp;<span class="op" id="5528211">(</span><span class="ident" id="5528212">dc</span>&nbsp;<span class="op" id="5528215">*</span><span class="ident" id="5528216">driverConn</span><span class="op" id="5528226">)</span>&nbsp;<span class="ident" id="5528228">prepareLocked</span><span class="op" id="5528241">(</span><span class="ident" id="5528242">query</span>&nbsp;<span class="builtintype" id="5528248">string</span><span class="op" id="5528254">)</span>&nbsp;<span class="op" id="5528256">(</span><span class="ident" id="5528257">driver</span><span class="op" id="5528263">.</span><span class="ident" id="5528264">Stmt</span><span class="op" id="5528268">,</span>&nbsp;<span class="builtintype" id="5528270">error</span><span class="op" id="5528275">)</span>&nbsp;<span class="op" id="5528277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528280">si</span><span class="op" id="5528282">,</span>&nbsp;<span class="ident" id="5528284">err</span>&nbsp;<span class="op" id="5528288">:=</span>&nbsp;<span class="ident" id="5528291">dc</span><span class="op" id="5528293">.</span><span class="ident" id="5528294">ci</span><span class="op" id="5528296">.</span><span class="ident" id="5528297">Prepare</span><span class="op" id="5528304">(</span><span class="ident" id="5528305">query</span><span class="op" id="5528310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5528313">if</span>&nbsp;<span class="ident" id="5528316">err</span>&nbsp;<span class="op" id="5528320">==</span>&nbsp;<span class="ident" id="5528323">nil</span>&nbsp;<span class="op" id="5528327">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5528331">//&nbsp;Track&nbsp;each&nbsp;driverConn&#39;s&nbsp;open&nbsp;statements,&nbsp;so&nbsp;we&nbsp;can&nbsp;close&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5528398">//&nbsp;before&nbsp;closing&nbsp;the&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5528428">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5528433">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;drivers&nbsp;opt&nbsp;out&nbsp;of&nbsp;caring&nbsp;about</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5528490">//&nbsp;stmt&nbsp;closes&nbsp;if&nbsp;the&nbsp;conn&nbsp;is&nbsp;about&nbsp;to&nbsp;close&nbsp;anyway?&nbsp;For&nbsp;now</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5528553">//&nbsp;do&nbsp;the&nbsp;safe&nbsp;thing,&nbsp;in&nbsp;case&nbsp;stmts&nbsp;need&nbsp;to&nbsp;be&nbsp;closed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5528610">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5528615">//&nbsp;TODO(bradfitz):&nbsp;after&nbsp;Go&nbsp;1.2,&nbsp;closing&nbsp;driver.Stmts</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5528671">//&nbsp;should&nbsp;be&nbsp;moved&nbsp;to&nbsp;driverStmt,&nbsp;using&nbsp;unique</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5528720">//&nbsp;*driverStmts&nbsp;everywhere&nbsp;(including&nbsp;from</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5528765">//&nbsp;*Stmt.connStmt,&nbsp;instead&nbsp;of&nbsp;returning&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5528809">//&nbsp;driver.Stmt),&nbsp;using&nbsp;driverStmt&nbsp;as&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5528858">//&nbsp;everywhere,&nbsp;and&nbsp;making&nbsp;it&nbsp;a&nbsp;finalCloser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5528904">if</span>&nbsp;<span class="ident" id="5528907">dc</span><span class="op" id="5528909">.</span><span class="ident" id="5528910">openStmt</span>&nbsp;<span class="op" id="5528919">==</span>&nbsp;<span class="ident" id="5528922">nil</span>&nbsp;<span class="op" id="5528926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528931">dc</span><span class="op" id="5528933">.</span><span class="ident" id="5528934">openStmt</span>&nbsp;<span class="op" id="5528943">=</span>&nbsp;<span class="builtinfunc" id="5528945">make</span><span class="op" id="5528949">(</span><span class="keyword" id="5528950">map</span><span class="op" id="5528953">[</span><span class="ident" id="5528954">driver</span><span class="op" id="5528960">.</span><span class="ident" id="5528961">Stmt</span><span class="op" id="5528965">]</span><span class="builtintype" id="5528966">bool</span><span class="op" id="5528970">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5528974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528978">dc</span><span class="op" id="5528980">.</span><span class="ident" id="5528981">openStmt</span><span class="op" id="5528989">[</span><span class="ident" id="5528990">si</span><span class="op" id="5528992">]</span>&nbsp;<span class="op" id="5528994">=</span>&nbsp;<span class="builtintype" id="5528996">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5529002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529005">return</span>&nbsp;<span class="ident" id="5529012">si</span><span class="op" id="5529014">,</span>&nbsp;<span class="ident" id="5529016">err</span><br>
<span class="lineno"></span><span class="op" id="5529020">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="5529023">//&nbsp;the&nbsp;dc.db&#39;s&nbsp;Mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="5529053">func</span>&nbsp;<span class="op" id="5529058">(</span><span class="ident" id="5529059">dc</span>&nbsp;<span class="op" id="5529062">*</span><span class="ident" id="5529063">driverConn</span><span class="op" id="5529073">)</span>&nbsp;<span class="ident" id="5529075">closeDBLocked</span><span class="op" id="5529088">(</span><span class="op" id="5529089">)</span>&nbsp;<span class="keyword" id="5529091">func</span><span class="op" id="5529095">(</span><span class="op" id="5529096">)</span>&nbsp;<span class="builtintype" id="5529098">error</span>&nbsp;<span class="op" id="5529104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529107">dc</span><span class="op" id="5529109">.</span><span class="ident" id="5529110">Lock</span><span class="op" id="5529114">(</span><span class="op" id="5529115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529118">defer</span>&nbsp;<span class="ident" id="5529124">dc</span><span class="op" id="5529126">.</span><span class="ident" id="5529127">Unlock</span><span class="op" id="5529133">(</span><span class="op" id="5529134">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529137">if</span>&nbsp;<span class="ident" id="5529140">dc</span><span class="op" id="5529142">.</span><span class="ident" id="5529143">closed</span>&nbsp;<span class="op" id="5529150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529154">return</span>&nbsp;<span class="keyword" id="5529161">func</span><span class="op" id="5529165">(</span><span class="op" id="5529166">)</span>&nbsp;<span class="builtintype" id="5529168">error</span>&nbsp;<span class="op" id="5529174">{</span>&nbsp;<span class="keyword" id="5529176">return</span>&nbsp;<span class="ident" id="5529183">errors</span><span class="op" id="5529189">.</span><span class="ident" id="5529190">New</span><span class="op" id="5529193">(</span><span class="string" id="5529194">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="5529227">)</span>&nbsp;<span class="op" id="5529229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5529232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529235">dc</span><span class="op" id="5529237">.</span><span class="ident" id="5529238">closed</span>&nbsp;<span class="op" id="5529245">=</span>&nbsp;<span class="builtintype" id="5529247">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529253">return</span>&nbsp;<span class="ident" id="5529260">dc</span><span class="op" id="5529262">.</span><span class="ident" id="5529263">db</span><span class="op" id="5529265">.</span><span class="ident" id="5529266">removeDepLocked</span><span class="op" id="5529281">(</span><span class="ident" id="5529282">dc</span><span class="op" id="5529284">,</span>&nbsp;<span class="ident" id="5529286">dc</span><span class="op" id="5529288">)</span><br>
<span class="lineno">295</span><span class="op" id="5529290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5529293">func</span>&nbsp;<span class="op" id="5529298">(</span><span class="ident" id="5529299">dc</span>&nbsp;<span class="op" id="5529302">*</span><span class="ident" id="5529303">driverConn</span><span class="op" id="5529313">)</span>&nbsp;<span class="ident" id="5529315">Close</span><span class="op" id="5529320">(</span><span class="op" id="5529321">)</span>&nbsp;<span class="builtintype" id="5529323">error</span>&nbsp;<span class="op" id="5529329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529332">dc</span><span class="op" id="5529334">.</span><span class="ident" id="5529335">Lock</span><span class="op" id="5529339">(</span><span class="op" id="5529340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529343">if</span>&nbsp;<span class="ident" id="5529346">dc</span><span class="op" id="5529348">.</span><span class="ident" id="5529349">closed</span>&nbsp;<span class="op" id="5529356">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529360">dc</span><span class="op" id="5529362">.</span><span class="ident" id="5529363">Unlock</span><span class="op" id="5529369">(</span><span class="op" id="5529370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529374">return</span>&nbsp;<span class="ident" id="5529381">errors</span><span class="op" id="5529387">.</span><span class="ident" id="5529388">New</span><span class="op" id="5529391">(</span><span class="string" id="5529392">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="5529425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5529428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529431">dc</span><span class="op" id="5529433">.</span><span class="ident" id="5529434">closed</span>&nbsp;<span class="op" id="5529441">=</span>&nbsp;<span class="builtintype" id="5529443">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529449">dc</span><span class="op" id="5529451">.</span><span class="ident" id="5529452">Unlock</span><span class="op" id="5529458">(</span><span class="op" id="5529459">)</span>&nbsp;<span class="comment" id="5529461">//&nbsp;not&nbsp;defer;&nbsp;removeDep&nbsp;finalClose&nbsp;calls&nbsp;may&nbsp;need&nbsp;to&nbsp;lock</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5529521">//&nbsp;And&nbsp;now&nbsp;updates&nbsp;that&nbsp;require&nbsp;holding&nbsp;dc.mu.Lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529574">dc</span><span class="op" id="5529576">.</span><span class="ident" id="5529577">db</span><span class="op" id="5529579">.</span><span class="ident" id="5529580">mu</span><span class="op" id="5529582">.</span><span class="ident" id="5529583">Lock</span><span class="op" id="5529587">(</span><span class="op" id="5529588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529591">dc</span><span class="op" id="5529593">.</span><span class="ident" id="5529594">dbmuClosed</span>&nbsp;<span class="op" id="5529605">=</span>&nbsp;<span class="builtintype" id="5529607">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529613">fn</span>&nbsp;<span class="op" id="5529616">:=</span>&nbsp;<span class="ident" id="5529619">dc</span><span class="op" id="5529621">.</span><span class="ident" id="5529622">db</span><span class="op" id="5529624">.</span><span class="ident" id="5529625">removeDepLocked</span><span class="op" id="5529640">(</span><span class="ident" id="5529641">dc</span><span class="op" id="5529643">,</span>&nbsp;<span class="ident" id="5529645">dc</span><span class="op" id="5529647">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529650">dc</span><span class="op" id="5529652">.</span><span class="ident" id="5529653">db</span><span class="op" id="5529655">.</span><span class="ident" id="5529656">mu</span><span class="op" id="5529658">.</span><span class="ident" id="5529659">Unlock</span><span class="op" id="5529665">(</span><span class="op" id="5529666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529669">return</span>&nbsp;<span class="ident" id="5529676">fn</span><span class="op" id="5529678">(</span><span class="op" id="5529679">)</span><br>
<span class="lineno"></span><span class="op" id="5529681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5529684">func</span>&nbsp;<span class="op" id="5529689">(</span><span class="ident" id="5529690">dc</span>&nbsp;<span class="op" id="5529693">*</span><span class="ident" id="5529694">driverConn</span><span class="op" id="5529704">)</span>&nbsp;<span class="ident" id="5529706">finalClose</span><span class="op" id="5529716">(</span><span class="op" id="5529717">)</span>&nbsp;<span class="builtintype" id="5529719">error</span>&nbsp;<span class="op" id="5529725">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529728">dc</span><span class="op" id="5529730">.</span><span class="ident" id="5529731">Lock</span><span class="op" id="5529735">(</span><span class="op" id="5529736">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529740">for</span>&nbsp;<span class="ident" id="5529744">si</span>&nbsp;<span class="op" id="5529747">:=</span>&nbsp;<span class="keyword" id="5529750">range</span>&nbsp;<span class="ident" id="5529756">dc</span><span class="op" id="5529758">.</span><span class="ident" id="5529759">openStmt</span>&nbsp;<span class="op" id="5529768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529772">si</span><span class="op" id="5529774">.</span><span class="ident" id="5529775">Close</span><span class="op" id="5529780">(</span><span class="op" id="5529781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5529784">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529787">dc</span><span class="op" id="5529789">.</span><span class="ident" id="5529790">openStmt</span>&nbsp;<span class="op" id="5529799">=</span>&nbsp;<span class="ident" id="5529801">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529807">err</span>&nbsp;<span class="op" id="5529811">:=</span>&nbsp;<span class="ident" id="5529814">dc</span><span class="op" id="5529816">.</span><span class="ident" id="5529817">ci</span><span class="op" id="5529819">.</span><span class="ident" id="5529820">Close</span><span class="op" id="5529825">(</span><span class="op" id="5529826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529829">dc</span><span class="op" id="5529831">.</span><span class="ident" id="5529832">ci</span>&nbsp;<span class="op" id="5529835">=</span>&nbsp;<span class="ident" id="5529837">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529842">dc</span><span class="op" id="5529844">.</span><span class="ident" id="5529845">finalClosed</span>&nbsp;<span class="op" id="5529857">=</span>&nbsp;<span class="builtintype" id="5529859">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529865">dc</span><span class="op" id="5529867">.</span><span class="ident" id="5529868">Unlock</span><span class="op" id="5529874">(</span><span class="op" id="5529875">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529879">dc</span><span class="op" id="5529881">.</span><span class="ident" id="5529882">db</span><span class="op" id="5529884">.</span><span class="ident" id="5529885">mu</span><span class="op" id="5529887">.</span><span class="ident" id="5529888">Lock</span><span class="op" id="5529892">(</span><span class="op" id="5529893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529896">dc</span><span class="op" id="5529898">.</span><span class="ident" id="5529899">db</span><span class="op" id="5529901">.</span><span class="ident" id="5529902">numOpen</span><span class="op" id="5529909">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529913">dc</span><span class="op" id="5529915">.</span><span class="ident" id="5529916">db</span><span class="op" id="5529918">.</span><span class="ident" id="5529919">maybeOpenNewConnections</span><span class="op" id="5529942">(</span><span class="op" id="5529943">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529946">dc</span><span class="op" id="5529948">.</span><span class="ident" id="5529949">db</span><span class="op" id="5529951">.</span><span class="ident" id="5529952">mu</span><span class="op" id="5529954">.</span><span class="ident" id="5529955">Unlock</span><span class="op" id="5529961">(</span><span class="op" id="5529962">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529966">return</span>&nbsp;<span class="ident" id="5529973">err</span><br>
<span class="lineno"></span><span class="op" id="5529977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="5529980">//&nbsp;driverStmt&nbsp;associates&nbsp;a&nbsp;driver.Stmt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5530028">//&nbsp;*driverConn&nbsp;from&nbsp;which&nbsp;it&nbsp;came,&nbsp;so&nbsp;the&nbsp;driverConn&#39;s&nbsp;lock&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5530095">//&nbsp;held&nbsp;during&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="5530117">type</span>&nbsp;<span class="ident" id="5530122">driverStmt</span>&nbsp;<span class="keyword" id="5530133">struct</span>&nbsp;<span class="op" id="5530140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530143">sync</span><span class="op" id="5530147">.</span><span class="ident" id="5530148">Locker</span>&nbsp;<span class="comment" id="5530155">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530175">si</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5530187">driver</span><span class="op" id="5530193">.</span><span class="ident" id="5530194">Stmt</span><br>
<span class="lineno"></span><span class="op" id="5530199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5530202">func</span>&nbsp;<span class="op" id="5530207">(</span><span class="ident" id="5530208">ds</span>&nbsp;<span class="op" id="5530211">*</span><span class="ident" id="5530212">driverStmt</span><span class="op" id="5530222">)</span>&nbsp;<span class="ident" id="5530224">Close</span><span class="op" id="5530229">(</span><span class="op" id="5530230">)</span>&nbsp;<span class="builtintype" id="5530232">error</span>&nbsp;<span class="op" id="5530238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530241">ds</span><span class="op" id="5530243">.</span><span class="ident" id="5530244">Lock</span><span class="op" id="5530248">(</span><span class="op" id="5530249">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5530252">defer</span>&nbsp;<span class="ident" id="5530258">ds</span><span class="op" id="5530260">.</span><span class="ident" id="5530261">Unlock</span><span class="op" id="5530267">(</span><span class="op" id="5530268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5530271">return</span>&nbsp;<span class="ident" id="5530278">ds</span><span class="op" id="5530280">.</span><span class="ident" id="5530281">si</span><span class="op" id="5530283">.</span><span class="ident" id="5530284">Close</span><span class="op" id="5530289">(</span><span class="op" id="5530290">)</span><br>
<span class="lineno"></span><span class="op" id="5530292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5530295">//&nbsp;depSet&nbsp;is&nbsp;a&nbsp;finalCloser&#39;s&nbsp;outstanding&nbsp;dependencies</span><br>
<span class="lineno">350</span><span class="keyword" id="5530349">type</span>&nbsp;<span class="ident" id="5530354">depSet</span>&nbsp;<span class="keyword" id="5530361">map</span><span class="op" id="5530364">[</span><span class="keyword" id="5530365">interface</span><span class="op" id="5530374">{</span><span class="op" id="5530375">}</span><span class="op" id="5530376">]</span><span class="builtintype" id="5530377">bool</span>&nbsp;<span class="comment" id="5530382">//&nbsp;set&nbsp;of&nbsp;true&nbsp;bools</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5530404">//&nbsp;The&nbsp;finalCloser&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;(*DB).addDep&nbsp;and&nbsp;related</span><br>
<span class="lineno"></span><span class="comment" id="5530469">//&nbsp;dependency&nbsp;reference&nbsp;counting.</span><br>
<span class="lineno"></span><span class="keyword" id="5530503">type</span>&nbsp;<span class="ident" id="5530508">finalCloser</span>&nbsp;<span class="keyword" id="5530520">interface</span>&nbsp;<span class="op" id="5530530">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5530533">//&nbsp;finalClose&nbsp;is&nbsp;called&nbsp;when&nbsp;the&nbsp;reference&nbsp;count&nbsp;of&nbsp;an&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5530596">//&nbsp;goes&nbsp;to&nbsp;zero.&nbsp;(*DB).mu&nbsp;is&nbsp;not&nbsp;held&nbsp;while&nbsp;calling&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530653">finalClose</span><span class="op" id="5530663">(</span><span class="op" id="5530664">)</span>&nbsp;<span class="builtintype" id="5530666">error</span><br>
<span class="lineno"></span><span class="op" id="5530672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="comment" id="5530675">//&nbsp;addDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;now&nbsp;depends&nbsp;on&nbsp;dep,&nbsp;and&nbsp;x&#39;s&nbsp;finalClose&nbsp;won&#39;t&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5530746">//&nbsp;called&nbsp;until&nbsp;all&nbsp;of&nbsp;x&#39;s&nbsp;dependencies&nbsp;are&nbsp;removed&nbsp;with&nbsp;removeDep.</span><br>
<span class="lineno"></span><span class="keyword" id="5530814">func</span>&nbsp;<span class="op" id="5530819">(</span><span class="ident" id="5530820">db</span>&nbsp;<span class="op" id="5530823">*</span><span class="ident" id="5530824">DB</span><span class="op" id="5530826">)</span>&nbsp;<span class="ident" id="5530828">addDep</span><span class="op" id="5530834">(</span><span class="ident" id="5530835">x</span>&nbsp;<span class="ident" id="5530837">finalCloser</span><span class="op" id="5530848">,</span>&nbsp;<span class="ident" id="5530850">dep</span>&nbsp;<span class="keyword" id="5530854">interface</span><span class="op" id="5530863">{</span><span class="op" id="5530864">}</span><span class="op" id="5530865">)</span>&nbsp;<span class="op" id="5530867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5530870">//println(fmt.Sprintf(&#34;addDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530934">db</span><span class="op" id="5530936">.</span><span class="ident" id="5530937">mu</span><span class="op" id="5530939">.</span><span class="ident" id="5530940">Lock</span><span class="op" id="5530944">(</span><span class="op" id="5530945">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5530948">defer</span>&nbsp;<span class="ident" id="5530954">db</span><span class="op" id="5530956">.</span><span class="ident" id="5530957">mu</span><span class="op" id="5530959">.</span><span class="ident" id="5530960">Unlock</span><span class="op" id="5530966">(</span><span class="op" id="5530967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530970">db</span><span class="op" id="5530972">.</span><span class="ident" id="5530973">addDepLocked</span><span class="op" id="5530985">(</span><span class="ident" id="5530986">x</span><span class="op" id="5530987">,</span>&nbsp;<span class="ident" id="5530989">dep</span><span class="op" id="5530992">)</span><br>
<span class="lineno"></span><span class="op" id="5530994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5530997">func</span>&nbsp;<span class="op" id="5531002">(</span><span class="ident" id="5531003">db</span>&nbsp;<span class="op" id="5531006">*</span><span class="ident" id="5531007">DB</span><span class="op" id="5531009">)</span>&nbsp;<span class="ident" id="5531011">addDepLocked</span><span class="op" id="5531023">(</span><span class="ident" id="5531024">x</span>&nbsp;<span class="ident" id="5531026">finalCloser</span><span class="op" id="5531037">,</span>&nbsp;<span class="ident" id="5531039">dep</span>&nbsp;<span class="keyword" id="5531043">interface</span><span class="op" id="5531052">{</span><span class="op" id="5531053">}</span><span class="op" id="5531054">)</span>&nbsp;<span class="op" id="5531056">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531059">if</span>&nbsp;<span class="ident" id="5531062">db</span><span class="op" id="5531064">.</span><span class="ident" id="5531065">dep</span>&nbsp;<span class="op" id="5531069">==</span>&nbsp;<span class="ident" id="5531072">nil</span>&nbsp;<span class="op" id="5531076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531080">db</span><span class="op" id="5531082">.</span><span class="ident" id="5531083">dep</span>&nbsp;<span class="op" id="5531087">=</span>&nbsp;<span class="builtinfunc" id="5531089">make</span><span class="op" id="5531093">(</span><span class="keyword" id="5531094">map</span><span class="op" id="5531097">[</span><span class="ident" id="5531098">finalCloser</span><span class="op" id="5531109">]</span><span class="ident" id="5531110">depSet</span><span class="op" id="5531116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5531119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531122">xdep</span>&nbsp;<span class="op" id="5531127">:=</span>&nbsp;<span class="ident" id="5531130">db</span><span class="op" id="5531132">.</span><span class="ident" id="5531133">dep</span><span class="op" id="5531136">[</span><span class="ident" id="5531137">x</span><span class="op" id="5531138">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531141">if</span>&nbsp;<span class="ident" id="5531144">xdep</span>&nbsp;<span class="op" id="5531149">==</span>&nbsp;<span class="ident" id="5531152">nil</span>&nbsp;<span class="op" id="5531156">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531160">xdep</span>&nbsp;<span class="op" id="5531165">=</span>&nbsp;<span class="builtinfunc" id="5531167">make</span><span class="op" id="5531171">(</span><span class="ident" id="5531172">depSet</span><span class="op" id="5531178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531182">db</span><span class="op" id="5531184">.</span><span class="ident" id="5531185">dep</span><span class="op" id="5531188">[</span><span class="ident" id="5531189">x</span><span class="op" id="5531190">]</span>&nbsp;<span class="op" id="5531192">=</span>&nbsp;<span class="ident" id="5531194">xdep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5531200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531203">xdep</span><span class="op" id="5531207">[</span><span class="ident" id="5531208">dep</span><span class="op" id="5531211">]</span>&nbsp;<span class="op" id="5531213">=</span>&nbsp;<span class="builtintype" id="5531215">true</span><br>
<span class="lineno"></span><span class="op" id="5531220">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="5531223">//&nbsp;removeDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;no&nbsp;longer&nbsp;depends&nbsp;on&nbsp;dep.</span><br>
<span class="lineno"></span><span class="comment" id="5531275">//&nbsp;If&nbsp;x&nbsp;still&nbsp;has&nbsp;dependencies,&nbsp;nil&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="5531324">//&nbsp;If&nbsp;x&nbsp;no&nbsp;longer&nbsp;has&nbsp;any&nbsp;dependencies,&nbsp;its&nbsp;finalClose&nbsp;method&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5531394">//&nbsp;called&nbsp;and&nbsp;its&nbsp;error&nbsp;value&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno">385</span><span class="keyword" id="5531442">func</span>&nbsp;<span class="op" id="5531447">(</span><span class="ident" id="5531448">db</span>&nbsp;<span class="op" id="5531451">*</span><span class="ident" id="5531452">DB</span><span class="op" id="5531454">)</span>&nbsp;<span class="ident" id="5531456">removeDep</span><span class="op" id="5531465">(</span><span class="ident" id="5531466">x</span>&nbsp;<span class="ident" id="5531468">finalCloser</span><span class="op" id="5531479">,</span>&nbsp;<span class="ident" id="5531481">dep</span>&nbsp;<span class="keyword" id="5531485">interface</span><span class="op" id="5531494">{</span><span class="op" id="5531495">}</span><span class="op" id="5531496">)</span>&nbsp;<span class="builtintype" id="5531498">error</span>&nbsp;<span class="op" id="5531504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531507">db</span><span class="op" id="5531509">.</span><span class="ident" id="5531510">mu</span><span class="op" id="5531512">.</span><span class="ident" id="5531513">Lock</span><span class="op" id="5531517">(</span><span class="op" id="5531518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531521">fn</span>&nbsp;<span class="op" id="5531524">:=</span>&nbsp;<span class="ident" id="5531527">db</span><span class="op" id="5531529">.</span><span class="ident" id="5531530">removeDepLocked</span><span class="op" id="5531545">(</span><span class="ident" id="5531546">x</span><span class="op" id="5531547">,</span>&nbsp;<span class="ident" id="5531549">dep</span><span class="op" id="5531552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531555">db</span><span class="op" id="5531557">.</span><span class="ident" id="5531558">mu</span><span class="op" id="5531560">.</span><span class="ident" id="5531561">Unlock</span><span class="op" id="5531567">(</span><span class="op" id="5531568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531571">return</span>&nbsp;<span class="ident" id="5531578">fn</span><span class="op" id="5531580">(</span><span class="op" id="5531581">)</span><br>
<span class="lineno">390</span><span class="op" id="5531583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5531586">func</span>&nbsp;<span class="op" id="5531591">(</span><span class="ident" id="5531592">db</span>&nbsp;<span class="op" id="5531595">*</span><span class="ident" id="5531596">DB</span><span class="op" id="5531598">)</span>&nbsp;<span class="ident" id="5531600">removeDepLocked</span><span class="op" id="5531615">(</span><span class="ident" id="5531616">x</span>&nbsp;<span class="ident" id="5531618">finalCloser</span><span class="op" id="5531629">,</span>&nbsp;<span class="ident" id="5531631">dep</span>&nbsp;<span class="keyword" id="5531635">interface</span><span class="op" id="5531644">{</span><span class="op" id="5531645">}</span><span class="op" id="5531646">)</span>&nbsp;<span class="keyword" id="5531648">func</span><span class="op" id="5531652">(</span><span class="op" id="5531653">)</span>&nbsp;<span class="builtintype" id="5531655">error</span>&nbsp;<span class="op" id="5531661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5531664">//println(fmt.Sprintf(&#34;removeDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531732">xdep</span><span class="op" id="5531736">,</span>&nbsp;<span class="ident" id="5531738">ok</span>&nbsp;<span class="op" id="5531741">:=</span>&nbsp;<span class="ident" id="5531744">db</span><span class="op" id="5531746">.</span><span class="ident" id="5531747">dep</span><span class="op" id="5531750">[</span><span class="ident" id="5531751">x</span><span class="op" id="5531752">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531755">if</span>&nbsp;<span class="op" id="5531758">!</span><span class="ident" id="5531759">ok</span>&nbsp;<span class="op" id="5531762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5531766">panic</span><span class="op" id="5531771">(</span><span class="ident" id="5531772">fmt</span><span class="op" id="5531775">.</span><span class="ident" id="5531776">Sprintf</span><span class="op" id="5531783">(</span><span class="string" id="5531784">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;deps&nbsp;for&nbsp;%T&#34;</span><span class="op" id="5531820">,</span>&nbsp;<span class="ident" id="5531822">x</span><span class="op" id="5531823">)</span><span class="op" id="5531824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5531827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531831">l0</span>&nbsp;<span class="op" id="5531834">:=</span>&nbsp;<span class="builtinfunc" id="5531837">len</span><span class="op" id="5531840">(</span><span class="ident" id="5531841">xdep</span><span class="op" id="5531845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5531848">delete</span><span class="op" id="5531854">(</span><span class="ident" id="5531855">xdep</span><span class="op" id="5531859">,</span>&nbsp;<span class="ident" id="5531861">dep</span><span class="op" id="5531864">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531868">switch</span>&nbsp;<span class="builtinfunc" id="5531875">len</span><span class="op" id="5531878">(</span><span class="ident" id="5531879">xdep</span><span class="op" id="5531883">)</span>&nbsp;<span class="op" id="5531885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531888">case</span>&nbsp;<span class="ident" id="5531893">l0</span><span class="op" id="5531895">:</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5531899">//&nbsp;Nothing&nbsp;removed.&nbsp;Shouldn&#39;t&nbsp;happen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5531939">panic</span><span class="op" id="5531944">(</span><span class="ident" id="5531945">fmt</span><span class="op" id="5531948">.</span><span class="ident" id="5531949">Sprintf</span><span class="op" id="5531956">(</span><span class="string" id="5531957">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;%T&nbsp;dep&nbsp;on&nbsp;%T&#34;</span><span class="op" id="5531994">,</span>&nbsp;<span class="ident" id="5531996">dep</span><span class="op" id="5531999">,</span>&nbsp;<span class="ident" id="5532001">x</span><span class="op" id="5532002">)</span><span class="op" id="5532003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5532006">case</span>&nbsp;<span class="num" id="5532011">0</span><span class="op" id="5532012">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5532016">//&nbsp;No&nbsp;more&nbsp;dependencies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5532043">delete</span><span class="op" id="5532049">(</span><span class="ident" id="5532050">db</span><span class="op" id="5532052">.</span><span class="ident" id="5532053">dep</span><span class="op" id="5532056">,</span>&nbsp;<span class="ident" id="5532058">x</span><span class="op" id="5532059">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5532063">return</span>&nbsp;<span class="ident" id="5532070">x</span><span class="op" id="5532071">.</span><span class="ident" id="5532072">finalClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5532084">default</span><span class="op" id="5532091">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5532095">//&nbsp;Dependencies&nbsp;remain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5532121">return</span>&nbsp;<span class="keyword" id="5532128">func</span><span class="op" id="5532132">(</span><span class="op" id="5532133">)</span>&nbsp;<span class="builtintype" id="5532135">error</span>&nbsp;<span class="op" id="5532141">{</span>&nbsp;<span class="keyword" id="5532143">return</span>&nbsp;<span class="ident" id="5532150">nil</span>&nbsp;<span class="op" id="5532154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5532157">}</span><br>
<span class="lineno">415</span><span class="op" id="5532159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5532162">//&nbsp;This&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;connectionOpener&nbsp;request&nbsp;chan&nbsp;(dn.openerCh).</span><br>
<span class="lineno"></span><span class="comment" id="5532234">//&nbsp;This&nbsp;value&nbsp;should&nbsp;be&nbsp;larger&nbsp;than&nbsp;the&nbsp;maximum&nbsp;typical&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5532296">//&nbsp;used&nbsp;for&nbsp;db.maxOpen.&nbsp;If&nbsp;maxOpen&nbsp;is&nbsp;significantly&nbsp;larger&nbsp;than</span><br>
<span class="lineno">420</span><span class="comment" id="5532360">//&nbsp;connectionRequestQueueSize&nbsp;then&nbsp;it&nbsp;is&nbsp;possible&nbsp;for&nbsp;ALL&nbsp;calls&nbsp;into&nbsp;the&nbsp;*DB</span><br>
<span class="lineno"></span><span class="comment" id="5532437">//&nbsp;to&nbsp;block&nbsp;until&nbsp;the&nbsp;connectionOpener&nbsp;can&nbsp;satisfy&nbsp;the&nbsp;backlog&nbsp;of&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="5532513">var</span>&nbsp;<span class="ident" id="5532517">connectionRequestQueueSize</span>&nbsp;<span class="op" id="5532544">=</span>&nbsp;<span class="num" id="5532546">1000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5532555">//&nbsp;Open&nbsp;opens&nbsp;a&nbsp;database&nbsp;specified&nbsp;by&nbsp;its&nbsp;database&nbsp;driver&nbsp;name&nbsp;and&nbsp;a</span><br>
<span class="lineno">425</span><span class="comment" id="5532624">//&nbsp;driver-specific&nbsp;data&nbsp;source&nbsp;name,&nbsp;usually&nbsp;consisting&nbsp;of&nbsp;at&nbsp;least&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5532694">//&nbsp;database&nbsp;name&nbsp;and&nbsp;connection&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="5532739">//</span><br>
<span class="lineno"></span><span class="comment" id="5532742">//&nbsp;Most&nbsp;users&nbsp;will&nbsp;open&nbsp;a&nbsp;database&nbsp;via&nbsp;a&nbsp;driver-specific&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5532810">//&nbsp;helper&nbsp;function&nbsp;that&nbsp;returns&nbsp;a&nbsp;*DB.&nbsp;No&nbsp;database&nbsp;drivers&nbsp;are&nbsp;included</span><br>
<span class="lineno">430</span><span class="comment" id="5532882">//&nbsp;in&nbsp;the&nbsp;Go&nbsp;standard&nbsp;library.&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5532952">//&nbsp;a&nbsp;list&nbsp;of&nbsp;third-party&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="comment" id="5532986">//</span><br>
<span class="lineno"></span><span class="comment" id="5532989">//&nbsp;Open&nbsp;may&nbsp;just&nbsp;validate&nbsp;its&nbsp;arguments&nbsp;without&nbsp;creating&nbsp;a&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5533059">//&nbsp;to&nbsp;the&nbsp;database.&nbsp;To&nbsp;verify&nbsp;that&nbsp;the&nbsp;data&nbsp;source&nbsp;name&nbsp;is&nbsp;valid,&nbsp;call</span><br>
<span class="lineno">435</span><span class="comment" id="5533130">//&nbsp;Ping.</span><br>
<span class="lineno"></span><span class="comment" id="5533139">//</span><br>
<span class="lineno"></span><span class="comment" id="5533142">//&nbsp;The&nbsp;returned&nbsp;DB&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="5533211">//&nbsp;and&nbsp;maintains&nbsp;its&nbsp;own&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;Thus,&nbsp;the&nbsp;Open</span><br>
<span class="lineno"></span><span class="comment" id="5533277">//&nbsp;function&nbsp;should&nbsp;be&nbsp;called&nbsp;just&nbsp;once.&nbsp;It&nbsp;is&nbsp;rarely&nbsp;necessary&nbsp;to</span><br>
<span class="lineno">440</span><span class="comment" id="5533343">//&nbsp;close&nbsp;a&nbsp;DB.</span><br>
<span class="lineno"></span><span class="keyword" id="5533358">func</span>&nbsp;<span class="ident" id="5533363">Open</span><span class="op" id="5533367">(</span><span class="ident" id="5533368">driverName</span><span class="op" id="5533378">,</span>&nbsp;<span class="ident" id="5533380">dataSourceName</span>&nbsp;<span class="builtintype" id="5533395">string</span><span class="op" id="5533401">)</span>&nbsp;<span class="op" id="5533403">(</span><span class="op" id="5533404">*</span><span class="ident" id="5533405">DB</span><span class="op" id="5533407">,</span>&nbsp;<span class="builtintype" id="5533409">error</span><span class="op" id="5533414">)</span>&nbsp;<span class="op" id="5533416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5533419">driveri</span><span class="op" id="5533426">,</span>&nbsp;<span class="ident" id="5533428">ok</span>&nbsp;<span class="op" id="5533431">:=</span>&nbsp;<span class="ident" id="5533434">drivers</span><span class="op" id="5533441">[</span><span class="ident" id="5533442">driverName</span><span class="op" id="5533452">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5533455">if</span>&nbsp;<span class="op" id="5533458">!</span><span class="ident" id="5533459">ok</span>&nbsp;<span class="op" id="5533462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5533466">return</span>&nbsp;<span class="ident" id="5533473">nil</span><span class="op" id="5533476">,</span>&nbsp;<span class="ident" id="5533478">fmt</span><span class="op" id="5533481">.</span><span class="ident" id="5533482">Errorf</span><span class="op" id="5533488">(</span><span class="string" id="5533489">&#34;sql:&nbsp;unknown&nbsp;driver&nbsp;%q&nbsp;(forgotten&nbsp;import?)&#34;</span><span class="op" id="5533533">,</span>&nbsp;<span class="ident" id="5533535">driverName</span><span class="op" id="5533545">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5533548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5533551">db</span>&nbsp;<span class="op" id="5533554">:=</span>&nbsp;<span class="op" id="5533557">&amp;</span><span class="ident" id="5533558">DB</span><span class="op" id="5533560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5533564">driver</span><span class="op" id="5533570">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5533574">driveri</span><span class="op" id="5533581">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5533585">dsn</span><span class="op" id="5533588">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5533595">dataSourceName</span><span class="op" id="5533609">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5533613">openerCh</span><span class="op" id="5533621">:</span>&nbsp;<span class="builtinfunc" id="5533623">make</span><span class="op" id="5533627">(</span><span class="keyword" id="5533628">chan</span>&nbsp;<span class="keyword" id="5533633">struct</span><span class="op" id="5533639">{</span><span class="op" id="5533640">}</span><span class="op" id="5533641">,</span>&nbsp;<span class="ident" id="5533643">connectionRequestQueueSize</span><span class="op" id="5533669">)</span><span class="op" id="5533670">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5533674">lastPut</span><span class="op" id="5533681">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5533684">make</span><span class="op" id="5533688">(</span><span class="keyword" id="5533689">map</span><span class="op" id="5533692">[</span><span class="op" id="5533693">*</span><span class="ident" id="5533694">driverConn</span><span class="op" id="5533704">]</span><span class="builtintype" id="5533705">string</span><span class="op" id="5533711">)</span><span class="op" id="5533712">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5533715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5533718">go</span>&nbsp;<span class="ident" id="5533721">db</span><span class="op" id="5533723">.</span><span class="ident" id="5533724">connectionOpener</span><span class="op" id="5533740">(</span><span class="op" id="5533741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5533744">return</span>&nbsp;<span class="ident" id="5533751">db</span><span class="op" id="5533753">,</span>&nbsp;<span class="ident" id="5533755">nil</span><br>
<span class="lineno"></span><span class="op" id="5533759">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="5533762">//&nbsp;Ping&nbsp;verifies&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;database&nbsp;is&nbsp;still&nbsp;alive,</span><br>
<span class="lineno"></span><span class="comment" id="5533824">//&nbsp;establishing&nbsp;a&nbsp;connection&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="5533867">func</span>&nbsp;<span class="op" id="5533872">(</span><span class="ident" id="5533873">db</span>&nbsp;<span class="op" id="5533876">*</span><span class="ident" id="5533877">DB</span><span class="op" id="5533879">)</span>&nbsp;<span class="ident" id="5533881">Ping</span><span class="op" id="5533885">(</span><span class="op" id="5533886">)</span>&nbsp;<span class="builtintype" id="5533888">error</span>&nbsp;<span class="op" id="5533894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5533897">//&nbsp;TODO(bradfitz):&nbsp;give&nbsp;drivers&nbsp;an&nbsp;optional&nbsp;hook&nbsp;to&nbsp;implement</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5533960">//&nbsp;this&nbsp;in&nbsp;a&nbsp;more&nbsp;efficient&nbsp;or&nbsp;more&nbsp;reliable&nbsp;way,&nbsp;if&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5534019">//&nbsp;have&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534033">dc</span><span class="op" id="5534035">,</span>&nbsp;<span class="ident" id="5534037">err</span>&nbsp;<span class="op" id="5534041">:=</span>&nbsp;<span class="ident" id="5534044">db</span><span class="op" id="5534046">.</span><span class="ident" id="5534047">conn</span><span class="op" id="5534051">(</span><span class="op" id="5534052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534055">if</span>&nbsp;<span class="ident" id="5534058">err</span>&nbsp;<span class="op" id="5534062">!=</span>&nbsp;<span class="ident" id="5534065">nil</span>&nbsp;<span class="op" id="5534069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534073">return</span>&nbsp;<span class="ident" id="5534080">err</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5534085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534088">db</span><span class="op" id="5534090">.</span><span class="ident" id="5534091">putConn</span><span class="op" id="5534098">(</span><span class="ident" id="5534099">dc</span><span class="op" id="5534101">,</span>&nbsp;<span class="ident" id="5534103">nil</span><span class="op" id="5534106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534109">return</span>&nbsp;<span class="ident" id="5534116">nil</span><br>
<span class="lineno"></span><span class="op" id="5534120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="comment" id="5534123">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;database,&nbsp;releasing&nbsp;any&nbsp;open&nbsp;resources.</span><br>
<span class="lineno"></span><span class="comment" id="5534183">//</span><br>
<span class="lineno"></span><span class="comment" id="5534186">//&nbsp;It&nbsp;is&nbsp;rare&nbsp;to&nbsp;Close&nbsp;a&nbsp;DB,&nbsp;as&nbsp;the&nbsp;DB&nbsp;handle&nbsp;is&nbsp;meant&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5534247">//&nbsp;long-lived&nbsp;and&nbsp;shared&nbsp;between&nbsp;many&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="5534297">func</span>&nbsp;<span class="op" id="5534302">(</span><span class="ident" id="5534303">db</span>&nbsp;<span class="op" id="5534306">*</span><span class="ident" id="5534307">DB</span><span class="op" id="5534309">)</span>&nbsp;<span class="ident" id="5534311">Close</span><span class="op" id="5534316">(</span><span class="op" id="5534317">)</span>&nbsp;<span class="builtintype" id="5534319">error</span>&nbsp;<span class="op" id="5534325">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534328">db</span><span class="op" id="5534330">.</span><span class="ident" id="5534331">mu</span><span class="op" id="5534333">.</span><span class="ident" id="5534334">Lock</span><span class="op" id="5534338">(</span><span class="op" id="5534339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534342">if</span>&nbsp;<span class="ident" id="5534345">db</span><span class="op" id="5534347">.</span><span class="ident" id="5534348">closed</span>&nbsp;<span class="op" id="5534355">{</span>&nbsp;<span class="comment" id="5534357">//&nbsp;Make&nbsp;DB.Close&nbsp;idempotent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534387">db</span><span class="op" id="5534389">.</span><span class="ident" id="5534390">mu</span><span class="op" id="5534392">.</span><span class="ident" id="5534393">Unlock</span><span class="op" id="5534399">(</span><span class="op" id="5534400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534404">return</span>&nbsp;<span class="ident" id="5534411">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5534416">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5534419">close</span><span class="op" id="5534424">(</span><span class="ident" id="5534425">db</span><span class="op" id="5534427">.</span><span class="ident" id="5534428">openerCh</span><span class="op" id="5534436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534439">var</span>&nbsp;<span class="ident" id="5534443">err</span>&nbsp;<span class="builtintype" id="5534447">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534454">fns</span>&nbsp;<span class="op" id="5534458">:=</span>&nbsp;<span class="builtinfunc" id="5534461">make</span><span class="op" id="5534465">(</span><span class="op" id="5534466">[</span><span class="op" id="5534467">]</span><span class="keyword" id="5534468">func</span><span class="op" id="5534472">(</span><span class="op" id="5534473">)</span>&nbsp;<span class="builtintype" id="5534475">error</span><span class="op" id="5534480">,</span>&nbsp;<span class="num" id="5534482">0</span><span class="op" id="5534483">,</span>&nbsp;<span class="builtinfunc" id="5534485">len</span><span class="op" id="5534488">(</span><span class="ident" id="5534489">db</span><span class="op" id="5534491">.</span><span class="ident" id="5534492">freeConn</span><span class="op" id="5534500">)</span><span class="op" id="5534501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534504">for</span>&nbsp;<span class="ident" id="5534508">_</span><span class="op" id="5534509">,</span>&nbsp;<span class="ident" id="5534511">dc</span>&nbsp;<span class="op" id="5534514">:=</span>&nbsp;<span class="keyword" id="5534517">range</span>&nbsp;<span class="ident" id="5534523">db</span><span class="op" id="5534525">.</span><span class="ident" id="5534526">freeConn</span>&nbsp;<span class="op" id="5534535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534539">fns</span>&nbsp;<span class="op" id="5534543">=</span>&nbsp;<span class="builtinfunc" id="5534545">append</span><span class="op" id="5534551">(</span><span class="ident" id="5534552">fns</span><span class="op" id="5534555">,</span>&nbsp;<span class="ident" id="5534557">dc</span><span class="op" id="5534559">.</span><span class="ident" id="5534560">closeDBLocked</span><span class="op" id="5534573">(</span><span class="op" id="5534574">)</span><span class="op" id="5534575">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5534578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534581">db</span><span class="op" id="5534583">.</span><span class="ident" id="5534584">freeConn</span>&nbsp;<span class="op" id="5534593">=</span>&nbsp;<span class="ident" id="5534595">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534600">db</span><span class="op" id="5534602">.</span><span class="ident" id="5534603">closed</span>&nbsp;<span class="op" id="5534610">=</span>&nbsp;<span class="builtintype" id="5534612">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534618">for</span>&nbsp;<span class="ident" id="5534622">_</span><span class="op" id="5534623">,</span>&nbsp;<span class="ident" id="5534625">req</span>&nbsp;<span class="op" id="5534629">:=</span>&nbsp;<span class="keyword" id="5534632">range</span>&nbsp;<span class="ident" id="5534638">db</span><span class="op" id="5534640">.</span><span class="ident" id="5534641">connRequests</span>&nbsp;<span class="op" id="5534654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5534658">close</span><span class="op" id="5534663">(</span><span class="ident" id="5534664">req</span><span class="op" id="5534667">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5534670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534673">db</span><span class="op" id="5534675">.</span><span class="ident" id="5534676">mu</span><span class="op" id="5534678">.</span><span class="ident" id="5534679">Unlock</span><span class="op" id="5534685">(</span><span class="op" id="5534686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534689">for</span>&nbsp;<span class="ident" id="5534693">_</span><span class="op" id="5534694">,</span>&nbsp;<span class="ident" id="5534696">fn</span>&nbsp;<span class="op" id="5534699">:=</span>&nbsp;<span class="keyword" id="5534702">range</span>&nbsp;<span class="ident" id="5534708">fns</span>&nbsp;<span class="op" id="5534712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534716">err1</span>&nbsp;<span class="op" id="5534721">:=</span>&nbsp;<span class="ident" id="5534724">fn</span><span class="op" id="5534726">(</span><span class="op" id="5534727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534731">if</span>&nbsp;<span class="ident" id="5534734">err1</span>&nbsp;<span class="op" id="5534739">!=</span>&nbsp;<span class="ident" id="5534742">nil</span>&nbsp;<span class="op" id="5534746">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534751">err</span>&nbsp;<span class="op" id="5534755">=</span>&nbsp;<span class="ident" id="5534757">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5534764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5534767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534770">return</span>&nbsp;<span class="ident" id="5534777">err</span><br>
<span class="lineno"></span><span class="op" id="5534781">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="5534784">const</span>&nbsp;<span class="ident" id="5534790">defaultMaxIdleConns</span>&nbsp;<span class="op" id="5534810">=</span>&nbsp;<span class="num" id="5534812">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5534815">func</span>&nbsp;<span class="op" id="5534820">(</span><span class="ident" id="5534821">db</span>&nbsp;<span class="op" id="5534824">*</span><span class="ident" id="5534825">DB</span><span class="op" id="5534827">)</span>&nbsp;<span class="ident" id="5534829">maxIdleConnsLocked</span><span class="op" id="5534847">(</span><span class="op" id="5534848">)</span>&nbsp;<span class="builtintype" id="5534850">int</span>&nbsp;<span class="op" id="5534854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534857">n</span>&nbsp;<span class="op" id="5534859">:=</span>&nbsp;<span class="ident" id="5534862">db</span><span class="op" id="5534864">.</span><span class="ident" id="5534865">maxIdle</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534874">switch</span>&nbsp;<span class="op" id="5534881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534884">case</span>&nbsp;<span class="ident" id="5534889">n</span>&nbsp;<span class="op" id="5534891">==</span>&nbsp;<span class="num" id="5534894">0</span><span class="op" id="5534895">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5534899">//&nbsp;TODO(bradfitz):&nbsp;ask&nbsp;driver,&nbsp;if&nbsp;supported,&nbsp;for&nbsp;its&nbsp;default&nbsp;preference</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534973">return</span>&nbsp;<span class="ident" id="5534980">defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535001">case</span>&nbsp;<span class="ident" id="5535006">n</span>&nbsp;<span class="op" id="5535008">&lt;</span>&nbsp;<span class="num" id="5535010">0</span><span class="op" id="5535011">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535015">return</span>&nbsp;<span class="num" id="5535022">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535025">default</span><span class="op" id="5535032">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535036">return</span>&nbsp;<span class="ident" id="5535043">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5535046">}</span><br>
<span class="lineno"></span><span class="op" id="5535048">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span><span class="comment" id="5535051">//&nbsp;SetMaxIdleConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;connections&nbsp;in&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="5535121">//&nbsp;connection&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="5535141">//</span><br>
<span class="lineno"></span><span class="comment" id="5535144">//&nbsp;If&nbsp;MaxOpenConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;but&nbsp;less&nbsp;than&nbsp;the&nbsp;new&nbsp;MaxIdleConns</span><br>
<span class="lineno">520</span><span class="comment" id="5535216">//&nbsp;then&nbsp;the&nbsp;new&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="5535293">//</span><br>
<span class="lineno"></span><span class="comment" id="5535296">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;no&nbsp;idle&nbsp;connections&nbsp;are&nbsp;retained.</span><br>
<span class="lineno"></span><span class="keyword" id="5535344">func</span>&nbsp;<span class="op" id="5535349">(</span><span class="ident" id="5535350">db</span>&nbsp;<span class="op" id="5535353">*</span><span class="ident" id="5535354">DB</span><span class="op" id="5535356">)</span>&nbsp;<span class="ident" id="5535358">SetMaxIdleConns</span><span class="op" id="5535373">(</span><span class="ident" id="5535374">n</span>&nbsp;<span class="builtintype" id="5535376">int</span><span class="op" id="5535379">)</span>&nbsp;<span class="op" id="5535381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535384">db</span><span class="op" id="5535386">.</span><span class="ident" id="5535387">mu</span><span class="op" id="5535389">.</span><span class="ident" id="5535390">Lock</span><span class="op" id="5535394">(</span><span class="op" id="5535395">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535398">if</span>&nbsp;<span class="ident" id="5535401">n</span>&nbsp;<span class="op" id="5535403">&gt;</span>&nbsp;<span class="num" id="5535405">0</span>&nbsp;<span class="op" id="5535407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535411">db</span><span class="op" id="5535413">.</span><span class="ident" id="5535414">maxIdle</span>&nbsp;<span class="op" id="5535422">=</span>&nbsp;<span class="ident" id="5535424">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5535427">}</span>&nbsp;<span class="keyword" id="5535429">else</span>&nbsp;<span class="op" id="5535434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5535438">//&nbsp;No&nbsp;idle&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535464">db</span><span class="op" id="5535466">.</span><span class="ident" id="5535467">maxIdle</span>&nbsp;<span class="op" id="5535475">=</span>&nbsp;<span class="op" id="5535477">-</span><span class="num" id="5535478">1</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5535481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5535484">//&nbsp;Make&nbsp;sure&nbsp;maxIdle&nbsp;doesn&#39;t&nbsp;exceed&nbsp;maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535529">if</span>&nbsp;<span class="ident" id="5535532">db</span><span class="op" id="5535534">.</span><span class="ident" id="5535535">maxOpen</span>&nbsp;<span class="op" id="5535543">&gt;</span>&nbsp;<span class="num" id="5535545">0</span>&nbsp;<span class="op" id="5535547">&amp;&amp;</span>&nbsp;<span class="ident" id="5535550">db</span><span class="op" id="5535552">.</span><span class="ident" id="5535553">maxIdleConnsLocked</span><span class="op" id="5535571">(</span><span class="op" id="5535572">)</span>&nbsp;<span class="op" id="5535574">&gt;</span>&nbsp;<span class="ident" id="5535576">db</span><span class="op" id="5535578">.</span><span class="ident" id="5535579">maxOpen</span>&nbsp;<span class="op" id="5535587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535591">db</span><span class="op" id="5535593">.</span><span class="ident" id="5535594">maxIdle</span>&nbsp;<span class="op" id="5535602">=</span>&nbsp;<span class="ident" id="5535604">db</span><span class="op" id="5535606">.</span><span class="ident" id="5535607">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5535616">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535619">var</span>&nbsp;<span class="ident" id="5535623">closing</span>&nbsp;<span class="op" id="5535631">[</span><span class="op" id="5535632">]</span><span class="op" id="5535633">*</span><span class="ident" id="5535634">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535646">idleCount</span>&nbsp;<span class="op" id="5535656">:=</span>&nbsp;<span class="builtinfunc" id="5535659">len</span><span class="op" id="5535662">(</span><span class="ident" id="5535663">db</span><span class="op" id="5535665">.</span><span class="ident" id="5535666">freeConn</span><span class="op" id="5535674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535677">maxIdle</span>&nbsp;<span class="op" id="5535685">:=</span>&nbsp;<span class="ident" id="5535688">db</span><span class="op" id="5535690">.</span><span class="ident" id="5535691">maxIdleConnsLocked</span><span class="op" id="5535709">(</span><span class="op" id="5535710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535713">if</span>&nbsp;<span class="ident" id="5535716">idleCount</span>&nbsp;<span class="op" id="5535726">&gt;</span>&nbsp;<span class="ident" id="5535728">maxIdle</span>&nbsp;<span class="op" id="5535736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535740">closing</span>&nbsp;<span class="op" id="5535748">=</span>&nbsp;<span class="ident" id="5535750">db</span><span class="op" id="5535752">.</span><span class="ident" id="5535753">freeConn</span><span class="op" id="5535761">[</span><span class="ident" id="5535762">maxIdle</span><span class="op" id="5535769">:</span><span class="op" id="5535770">]</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535774">db</span><span class="op" id="5535776">.</span><span class="ident" id="5535777">freeConn</span>&nbsp;<span class="op" id="5535786">=</span>&nbsp;<span class="ident" id="5535788">db</span><span class="op" id="5535790">.</span><span class="ident" id="5535791">freeConn</span><span class="op" id="5535799">[</span><span class="op" id="5535800">:</span><span class="ident" id="5535801">maxIdle</span><span class="op" id="5535808">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5535811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535814">db</span><span class="op" id="5535816">.</span><span class="ident" id="5535817">mu</span><span class="op" id="5535819">.</span><span class="ident" id="5535820">Unlock</span><span class="op" id="5535826">(</span><span class="op" id="5535827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535830">for</span>&nbsp;<span class="ident" id="5535834">_</span><span class="op" id="5535835">,</span>&nbsp;<span class="ident" id="5535837">c</span>&nbsp;<span class="op" id="5535839">:=</span>&nbsp;<span class="keyword" id="5535842">range</span>&nbsp;<span class="ident" id="5535848">closing</span>&nbsp;<span class="op" id="5535856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535860">c</span><span class="op" id="5535861">.</span><span class="ident" id="5535862">Close</span><span class="op" id="5535867">(</span><span class="op" id="5535868">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5535871">}</span><br>
<span class="lineno"></span><span class="op" id="5535873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5535876">//&nbsp;SetMaxOpenConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;the&nbsp;database.</span><br>
<span class="lineno"></span><span class="comment" id="5535956">//</span><br>
<span class="lineno">550</span><span class="comment" id="5535959">//&nbsp;If&nbsp;MaxIdleConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;and&nbsp;the&nbsp;new&nbsp;MaxOpenConns&nbsp;is&nbsp;less&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="5536034">//&nbsp;MaxIdleConns,&nbsp;then&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="5536102">//&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="5536124">//</span><br>
<span class="lineno"></span><span class="comment" id="5536127">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;then&nbsp;there&nbsp;is&nbsp;no&nbsp;limit&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections.</span><br>
<span class="lineno">555</span><span class="comment" id="5536199">//&nbsp;The&nbsp;default&nbsp;is&nbsp;0&nbsp;(unlimited).</span><br>
<span class="lineno"></span><span class="keyword" id="5536232">func</span>&nbsp;<span class="op" id="5536237">(</span><span class="ident" id="5536238">db</span>&nbsp;<span class="op" id="5536241">*</span><span class="ident" id="5536242">DB</span><span class="op" id="5536244">)</span>&nbsp;<span class="ident" id="5536246">SetMaxOpenConns</span><span class="op" id="5536261">(</span><span class="ident" id="5536262">n</span>&nbsp;<span class="builtintype" id="5536264">int</span><span class="op" id="5536267">)</span>&nbsp;<span class="op" id="5536269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536272">db</span><span class="op" id="5536274">.</span><span class="ident" id="5536275">mu</span><span class="op" id="5536277">.</span><span class="ident" id="5536278">Lock</span><span class="op" id="5536282">(</span><span class="op" id="5536283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536286">db</span><span class="op" id="5536288">.</span><span class="ident" id="5536289">maxOpen</span>&nbsp;<span class="op" id="5536297">=</span>&nbsp;<span class="ident" id="5536299">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5536302">if</span>&nbsp;<span class="ident" id="5536305">n</span>&nbsp;<span class="op" id="5536307">&lt;</span>&nbsp;<span class="num" id="5536309">0</span>&nbsp;<span class="op" id="5536311">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536315">db</span><span class="op" id="5536317">.</span><span class="ident" id="5536318">maxOpen</span>&nbsp;<span class="op" id="5536326">=</span>&nbsp;<span class="num" id="5536328">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5536331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536334">syncMaxIdle</span>&nbsp;<span class="op" id="5536346">:=</span>&nbsp;<span class="ident" id="5536349">db</span><span class="op" id="5536351">.</span><span class="ident" id="5536352">maxOpen</span>&nbsp;<span class="op" id="5536360">&gt;</span>&nbsp;<span class="num" id="5536362">0</span>&nbsp;<span class="op" id="5536364">&amp;&amp;</span>&nbsp;<span class="ident" id="5536367">db</span><span class="op" id="5536369">.</span><span class="ident" id="5536370">maxIdleConnsLocked</span><span class="op" id="5536388">(</span><span class="op" id="5536389">)</span>&nbsp;<span class="op" id="5536391">&gt;</span>&nbsp;<span class="ident" id="5536393">db</span><span class="op" id="5536395">.</span><span class="ident" id="5536396">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536405">db</span><span class="op" id="5536407">.</span><span class="ident" id="5536408">mu</span><span class="op" id="5536410">.</span><span class="ident" id="5536411">Unlock</span><span class="op" id="5536417">(</span><span class="op" id="5536418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5536421">if</span>&nbsp;<span class="ident" id="5536424">syncMaxIdle</span>&nbsp;<span class="op" id="5536436">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536440">db</span><span class="op" id="5536442">.</span><span class="ident" id="5536443">SetMaxIdleConns</span><span class="op" id="5536458">(</span><span class="ident" id="5536459">n</span><span class="op" id="5536460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5536463">}</span><br>
<span class="lineno"></span><span class="op" id="5536465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5536468">//&nbsp;Assumes&nbsp;db.mu&nbsp;is&nbsp;locked.</span><br>
<span class="lineno">570</span><span class="comment" id="5536496">//&nbsp;If&nbsp;there&nbsp;are&nbsp;connRequests&nbsp;and&nbsp;the&nbsp;connection&nbsp;limit&nbsp;hasn&#39;t&nbsp;been&nbsp;reached,</span><br>
<span class="lineno"></span><span class="comment" id="5536571">//&nbsp;then&nbsp;tell&nbsp;the&nbsp;connectionOpener&nbsp;to&nbsp;open&nbsp;new&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="5536630">func</span>&nbsp;<span class="op" id="5536635">(</span><span class="ident" id="5536636">db</span>&nbsp;<span class="op" id="5536639">*</span><span class="ident" id="5536640">DB</span><span class="op" id="5536642">)</span>&nbsp;<span class="ident" id="5536644">maybeOpenNewConnections</span><span class="op" id="5536667">(</span><span class="op" id="5536668">)</span>&nbsp;<span class="op" id="5536670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536673">numRequests</span>&nbsp;<span class="op" id="5536685">:=</span>&nbsp;<span class="builtinfunc" id="5536688">len</span><span class="op" id="5536691">(</span><span class="ident" id="5536692">db</span><span class="op" id="5536694">.</span><span class="ident" id="5536695">connRequests</span><span class="op" id="5536707">)</span>&nbsp;<span class="op" id="5536709">-</span>&nbsp;<span class="ident" id="5536711">db</span><span class="op" id="5536713">.</span><span class="ident" id="5536714">pendingOpens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5536728">if</span>&nbsp;<span class="ident" id="5536731">db</span><span class="op" id="5536733">.</span><span class="ident" id="5536734">maxOpen</span>&nbsp;<span class="op" id="5536742">&gt;</span>&nbsp;<span class="num" id="5536744">0</span>&nbsp;<span class="op" id="5536746">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536750">numCanOpen</span>&nbsp;<span class="op" id="5536761">:=</span>&nbsp;<span class="ident" id="5536764">db</span><span class="op" id="5536766">.</span><span class="ident" id="5536767">maxOpen</span>&nbsp;<span class="op" id="5536775">-</span>&nbsp;<span class="op" id="5536777">(</span><span class="ident" id="5536778">db</span><span class="op" id="5536780">.</span><span class="ident" id="5536781">numOpen</span>&nbsp;<span class="op" id="5536789">+</span>&nbsp;<span class="ident" id="5536791">db</span><span class="op" id="5536793">.</span><span class="ident" id="5536794">pendingOpens</span><span class="op" id="5536806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5536810">if</span>&nbsp;<span class="ident" id="5536813">numRequests</span>&nbsp;<span class="op" id="5536825">&gt;</span>&nbsp;<span class="ident" id="5536827">numCanOpen</span>&nbsp;<span class="op" id="5536838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536843">numRequests</span>&nbsp;<span class="op" id="5536855">=</span>&nbsp;<span class="ident" id="5536857">numCanOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5536870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5536873">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5536876">for</span>&nbsp;<span class="ident" id="5536880">numRequests</span>&nbsp;<span class="op" id="5536892">&gt;</span>&nbsp;<span class="num" id="5536894">0</span>&nbsp;<span class="op" id="5536896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536900">db</span><span class="op" id="5536902">.</span><span class="ident" id="5536903">pendingOpens</span><span class="op" id="5536915">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536920">numRequests</span><span class="op" id="5536931">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536936">db</span><span class="op" id="5536938">.</span><span class="ident" id="5536939">openerCh</span>&nbsp;<span class="op" id="5536948">&lt;-</span>&nbsp;<span class="keyword" id="5536951">struct</span><span class="op" id="5536957">{</span><span class="op" id="5536958">}</span><span class="op" id="5536959">{</span><span class="op" id="5536960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5536963">}</span><br>
<span class="lineno">585</span><span class="op" id="5536965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5536968">//&nbsp;Runs&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine,&nbsp;opens&nbsp;new&nbsp;connections&nbsp;when&nbsp;requested.</span><br>
<span class="lineno"></span><span class="keyword" id="5537039">func</span>&nbsp;<span class="op" id="5537044">(</span><span class="ident" id="5537045">db</span>&nbsp;<span class="op" id="5537048">*</span><span class="ident" id="5537049">DB</span><span class="op" id="5537051">)</span>&nbsp;<span class="ident" id="5537053">connectionOpener</span><span class="op" id="5537069">(</span><span class="op" id="5537070">)</span>&nbsp;<span class="op" id="5537072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537075">for</span>&nbsp;<span class="keyword" id="5537079">range</span>&nbsp;<span class="ident" id="5537085">db</span><span class="op" id="5537087">.</span><span class="ident" id="5537088">openerCh</span>&nbsp;<span class="op" id="5537097">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537101">db</span><span class="op" id="5537103">.</span><span class="ident" id="5537104">openNewConnection</span><span class="op" id="5537121">(</span><span class="op" id="5537122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5537125">}</span><br>
<span class="lineno"></span><span class="op" id="5537127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5537130">//&nbsp;Open&nbsp;one&nbsp;new&nbsp;connection</span><br>
<span class="lineno">595</span><span class="keyword" id="5537157">func</span>&nbsp;<span class="op" id="5537162">(</span><span class="ident" id="5537163">db</span>&nbsp;<span class="op" id="5537166">*</span><span class="ident" id="5537167">DB</span><span class="op" id="5537169">)</span>&nbsp;<span class="ident" id="5537171">openNewConnection</span><span class="op" id="5537188">(</span><span class="op" id="5537189">)</span>&nbsp;<span class="op" id="5537191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537194">ci</span><span class="op" id="5537196">,</span>&nbsp;<span class="ident" id="5537198">err</span>&nbsp;<span class="op" id="5537202">:=</span>&nbsp;<span class="ident" id="5537205">db</span><span class="op" id="5537207">.</span><span class="ident" id="5537208">driver</span><span class="op" id="5537214">.</span><span class="ident" id="5537215">Open</span><span class="op" id="5537219">(</span><span class="ident" id="5537220">db</span><span class="op" id="5537222">.</span><span class="ident" id="5537223">dsn</span><span class="op" id="5537226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537229">db</span><span class="op" id="5537231">.</span><span class="ident" id="5537232">mu</span><span class="op" id="5537234">.</span><span class="ident" id="5537235">Lock</span><span class="op" id="5537239">(</span><span class="op" id="5537240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537243">defer</span>&nbsp;<span class="ident" id="5537249">db</span><span class="op" id="5537251">.</span><span class="ident" id="5537252">mu</span><span class="op" id="5537254">.</span><span class="ident" id="5537255">Unlock</span><span class="op" id="5537261">(</span><span class="op" id="5537262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537265">if</span>&nbsp;<span class="ident" id="5537268">db</span><span class="op" id="5537270">.</span><span class="ident" id="5537271">closed</span>&nbsp;<span class="op" id="5537278">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537282">if</span>&nbsp;<span class="ident" id="5537285">err</span>&nbsp;<span class="op" id="5537289">==</span>&nbsp;<span class="ident" id="5537292">nil</span>&nbsp;<span class="op" id="5537296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537301">ci</span><span class="op" id="5537303">.</span><span class="ident" id="5537304">Close</span><span class="op" id="5537309">(</span><span class="op" id="5537310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5537314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537318">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5537326">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537329">db</span><span class="op" id="5537331">.</span><span class="ident" id="5537332">pendingOpens</span><span class="op" id="5537344">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537348">if</span>&nbsp;<span class="ident" id="5537351">err</span>&nbsp;<span class="op" id="5537355">!=</span>&nbsp;<span class="ident" id="5537358">nil</span>&nbsp;<span class="op" id="5537362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537366">db</span><span class="op" id="5537368">.</span><span class="ident" id="5537369">putConnDBLocked</span><span class="op" id="5537384">(</span><span class="ident" id="5537385">nil</span><span class="op" id="5537388">,</span>&nbsp;<span class="ident" id="5537390">err</span><span class="op" id="5537393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537397">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5537405">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537408">dc</span>&nbsp;<span class="op" id="5537411">:=</span>&nbsp;<span class="op" id="5537414">&amp;</span><span class="ident" id="5537415">driverConn</span><span class="op" id="5537425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537429">db</span><span class="op" id="5537431">:</span>&nbsp;<span class="ident" id="5537433">db</span><span class="op" id="5537435">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537439">ci</span><span class="op" id="5537441">:</span>&nbsp;<span class="ident" id="5537443">ci</span><span class="op" id="5537445">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5537448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537451">if</span>&nbsp;<span class="ident" id="5537454">db</span><span class="op" id="5537456">.</span><span class="ident" id="5537457">putConnDBLocked</span><span class="op" id="5537472">(</span><span class="ident" id="5537473">dc</span><span class="op" id="5537475">,</span>&nbsp;<span class="ident" id="5537477">err</span><span class="op" id="5537480">)</span>&nbsp;<span class="op" id="5537482">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537486">db</span><span class="op" id="5537488">.</span><span class="ident" id="5537489">addDepLocked</span><span class="op" id="5537501">(</span><span class="ident" id="5537502">dc</span><span class="op" id="5537504">,</span>&nbsp;<span class="ident" id="5537506">dc</span><span class="op" id="5537508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537512">db</span><span class="op" id="5537514">.</span><span class="ident" id="5537515">numOpen</span><span class="op" id="5537522">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5537526">}</span>&nbsp;<span class="keyword" id="5537528">else</span>&nbsp;<span class="op" id="5537533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537537">ci</span><span class="op" id="5537539">.</span><span class="ident" id="5537540">Close</span><span class="op" id="5537545">(</span><span class="op" id="5537546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5537549">}</span><br>
<span class="lineno">620</span><span class="op" id="5537551">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5537554">//&nbsp;connRequest&nbsp;represents&nbsp;one&nbsp;request&nbsp;for&nbsp;a&nbsp;new&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5537613">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;idle&nbsp;connections&nbsp;available,&nbsp;DB.conn&nbsp;will&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="5537682">//&nbsp;a&nbsp;new&nbsp;connRequest&nbsp;and&nbsp;put&nbsp;it&nbsp;on&nbsp;the&nbsp;db.connRequests&nbsp;list.</span><br>
<span class="lineno">625</span><span class="keyword" id="5537743">type</span>&nbsp;<span class="ident" id="5537748">connRequest</span>&nbsp;<span class="keyword" id="5537760">struct</span>&nbsp;<span class="op" id="5537767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537770">conn</span>&nbsp;<span class="op" id="5537775">*</span><span class="ident" id="5537776">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537788">err</span>&nbsp;&nbsp;<span class="builtintype" id="5537793">error</span><br>
<span class="lineno"></span><span class="op" id="5537799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="5537802">var</span>&nbsp;<span class="ident" id="5537806">errDBClosed</span>&nbsp;<span class="op" id="5537818">=</span>&nbsp;<span class="ident" id="5537820">errors</span><span class="op" id="5537826">.</span><span class="ident" id="5537827">New</span><span class="op" id="5537830">(</span><span class="string" id="5537831">&#34;sql:&nbsp;database&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5537856">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5537859">//&nbsp;conn&nbsp;returns&nbsp;a&nbsp;newly-opened&nbsp;or&nbsp;cached&nbsp;*driverConn</span><br>
<span class="lineno"></span><span class="keyword" id="5537912">func</span>&nbsp;<span class="op" id="5537917">(</span><span class="ident" id="5537918">db</span>&nbsp;<span class="op" id="5537921">*</span><span class="ident" id="5537922">DB</span><span class="op" id="5537924">)</span>&nbsp;<span class="ident" id="5537926">conn</span><span class="op" id="5537930">(</span><span class="op" id="5537931">)</span>&nbsp;<span class="op" id="5537933">(</span><span class="op" id="5537934">*</span><span class="ident" id="5537935">driverConn</span><span class="op" id="5537945">,</span>&nbsp;<span class="builtintype" id="5537947">error</span><span class="op" id="5537952">)</span>&nbsp;<span class="op" id="5537954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537957">db</span><span class="op" id="5537959">.</span><span class="ident" id="5537960">mu</span><span class="op" id="5537962">.</span><span class="ident" id="5537963">Lock</span><span class="op" id="5537967">(</span><span class="op" id="5537968">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537971">if</span>&nbsp;<span class="ident" id="5537974">db</span><span class="op" id="5537976">.</span><span class="ident" id="5537977">closed</span>&nbsp;<span class="op" id="5537984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537988">db</span><span class="op" id="5537990">.</span><span class="ident" id="5537991">mu</span><span class="op" id="5537993">.</span><span class="ident" id="5537994">Unlock</span><span class="op" id="5538000">(</span><span class="op" id="5538001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5538005">return</span>&nbsp;<span class="ident" id="5538012">nil</span><span class="op" id="5538015">,</span>&nbsp;<span class="ident" id="5538017">errDBClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5538030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538034">//&nbsp;If&nbsp;db.maxOpen&nbsp;&gt;&nbsp;0&nbsp;and&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;is&nbsp;over&nbsp;the&nbsp;limit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538109">//&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;free&nbsp;connection,&nbsp;make&nbsp;a&nbsp;request&nbsp;and&nbsp;wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5538172">if</span>&nbsp;<span class="ident" id="5538175">db</span><span class="op" id="5538177">.</span><span class="ident" id="5538178">maxOpen</span>&nbsp;<span class="op" id="5538186">&gt;</span>&nbsp;<span class="num" id="5538188">0</span>&nbsp;<span class="op" id="5538190">&amp;&amp;</span>&nbsp;<span class="ident" id="5538193">db</span><span class="op" id="5538195">.</span><span class="ident" id="5538196">numOpen</span>&nbsp;<span class="op" id="5538204">&gt;=</span>&nbsp;<span class="ident" id="5538207">db</span><span class="op" id="5538209">.</span><span class="ident" id="5538210">maxOpen</span>&nbsp;<span class="op" id="5538218">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5538221">len</span><span class="op" id="5538224">(</span><span class="ident" id="5538225">db</span><span class="op" id="5538227">.</span><span class="ident" id="5538228">freeConn</span><span class="op" id="5538236">)</span>&nbsp;<span class="op" id="5538238">==</span>&nbsp;<span class="num" id="5538241">0</span>&nbsp;<span class="op" id="5538243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538247">//&nbsp;Make&nbsp;the&nbsp;connRequest&nbsp;channel.&nbsp;It&#39;s&nbsp;buffered&nbsp;so&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538308">//&nbsp;connectionOpener&nbsp;doesn&#39;t&nbsp;block&nbsp;while&nbsp;waiting&nbsp;for&nbsp;the&nbsp;req&nbsp;to&nbsp;be&nbsp;read.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538382">req</span>&nbsp;<span class="op" id="5538386">:=</span>&nbsp;<span class="builtinfunc" id="5538389">make</span><span class="op" id="5538393">(</span><span class="keyword" id="5538394">chan</span>&nbsp;<span class="ident" id="5538399">connRequest</span><span class="op" id="5538410">,</span>&nbsp;<span class="num" id="5538412">1</span><span class="op" id="5538413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538417">db</span><span class="op" id="5538419">.</span><span class="ident" id="5538420">connRequests</span>&nbsp;<span class="op" id="5538433">=</span>&nbsp;<span class="builtinfunc" id="5538435">append</span><span class="op" id="5538441">(</span><span class="ident" id="5538442">db</span><span class="op" id="5538444">.</span><span class="ident" id="5538445">connRequests</span><span class="op" id="5538457">,</span>&nbsp;<span class="ident" id="5538459">req</span><span class="op" id="5538462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538466">db</span><span class="op" id="5538468">.</span><span class="ident" id="5538469">maybeOpenNewConnections</span><span class="op" id="5538492">(</span><span class="op" id="5538493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538497">db</span><span class="op" id="5538499">.</span><span class="ident" id="5538500">mu</span><span class="op" id="5538502">.</span><span class="ident" id="5538503">Unlock</span><span class="op" id="5538509">(</span><span class="op" id="5538510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538514">ret</span>&nbsp;<span class="op" id="5538518">:=</span>&nbsp;<span class="op" id="5538521">&lt;-</span><span class="ident" id="5538523">req</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5538529">return</span>&nbsp;<span class="ident" id="5538536">ret</span><span class="op" id="5538539">.</span><span class="ident" id="5538540">conn</span><span class="op" id="5538544">,</span>&nbsp;<span class="ident" id="5538546">ret</span><span class="op" id="5538549">.</span><span class="ident" id="5538550">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5538555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5538559">if</span>&nbsp;<span class="ident" id="5538562">c</span>&nbsp;<span class="op" id="5538564">:=</span>&nbsp;<span class="builtinfunc" id="5538567">len</span><span class="op" id="5538570">(</span><span class="ident" id="5538571">db</span><span class="op" id="5538573">.</span><span class="ident" id="5538574">freeConn</span><span class="op" id="5538582">)</span><span class="op" id="5538583">;</span>&nbsp;<span class="ident" id="5538585">c</span>&nbsp;<span class="op" id="5538587">&gt;</span>&nbsp;<span class="num" id="5538589">0</span>&nbsp;<span class="op" id="5538591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538595">conn</span>&nbsp;<span class="op" id="5538600">:=</span>&nbsp;<span class="ident" id="5538603">db</span><span class="op" id="5538605">.</span><span class="ident" id="5538606">freeConn</span><span class="op" id="5538614">[</span><span class="num" id="5538615">0</span><span class="op" id="5538616">]</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5538620">copy</span><span class="op" id="5538624">(</span><span class="ident" id="5538625">db</span><span class="op" id="5538627">.</span><span class="ident" id="5538628">freeConn</span><span class="op" id="5538636">,</span>&nbsp;<span class="ident" id="5538638">db</span><span class="op" id="5538640">.</span><span class="ident" id="5538641">freeConn</span><span class="op" id="5538649">[</span><span class="num" id="5538650">1</span><span class="op" id="5538651">:</span><span class="op" id="5538652">]</span><span class="op" id="5538653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538657">db</span><span class="op" id="5538659">.</span><span class="ident" id="5538660">freeConn</span>&nbsp;<span class="op" id="5538669">=</span>&nbsp;<span class="ident" id="5538671">db</span><span class="op" id="5538673">.</span><span class="ident" id="5538674">freeConn</span><span class="op" id="5538682">[</span><span class="op" id="5538683">:</span><span class="ident" id="5538684">c</span><span class="op" id="5538685">-</span><span class="num" id="5538686">1</span><span class="op" id="5538687">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538691">conn</span><span class="op" id="5538695">.</span><span class="ident" id="5538696">inUse</span>&nbsp;<span class="op" id="5538702">=</span>&nbsp;<span class="builtintype" id="5538704">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538711">db</span><span class="op" id="5538713">.</span><span class="ident" id="5538714">mu</span><span class="op" id="5538716">.</span><span class="ident" id="5538717">Unlock</span><span class="op" id="5538723">(</span><span class="op" id="5538724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5538728">return</span>&nbsp;<span class="ident" id="5538735">conn</span><span class="op" id="5538739">,</span>&nbsp;<span class="ident" id="5538741">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5538746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538750">db</span><span class="op" id="5538752">.</span><span class="ident" id="5538753">numOpen</span><span class="op" id="5538760">++</span>&nbsp;<span class="comment" id="5538763">//&nbsp;optimistically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538782">db</span><span class="op" id="5538784">.</span><span class="ident" id="5538785">mu</span><span class="op" id="5538787">.</span><span class="ident" id="5538788">Unlock</span><span class="op" id="5538794">(</span><span class="op" id="5538795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538798">ci</span><span class="op" id="5538800">,</span>&nbsp;<span class="ident" id="5538802">err</span>&nbsp;<span class="op" id="5538806">:=</span>&nbsp;<span class="ident" id="5538809">db</span><span class="op" id="5538811">.</span><span class="ident" id="5538812">driver</span><span class="op" id="5538818">.</span><span class="ident" id="5538819">Open</span><span class="op" id="5538823">(</span><span class="ident" id="5538824">db</span><span class="op" id="5538826">.</span><span class="ident" id="5538827">dsn</span><span class="op" id="5538830">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5538833">if</span>&nbsp;<span class="ident" id="5538836">err</span>&nbsp;<span class="op" id="5538840">!=</span>&nbsp;<span class="ident" id="5538843">nil</span>&nbsp;<span class="op" id="5538847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538851">db</span><span class="op" id="5538853">.</span><span class="ident" id="5538854">mu</span><span class="op" id="5538856">.</span><span class="ident" id="5538857">Lock</span><span class="op" id="5538861">(</span><span class="op" id="5538862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538866">db</span><span class="op" id="5538868">.</span><span class="ident" id="5538869">numOpen</span><span class="op" id="5538876">--</span>&nbsp;<span class="comment" id="5538879">//&nbsp;correct&nbsp;for&nbsp;earlier&nbsp;optimism</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538913">db</span><span class="op" id="5538915">.</span><span class="ident" id="5538916">mu</span><span class="op" id="5538918">.</span><span class="ident" id="5538919">Unlock</span><span class="op" id="5538925">(</span><span class="op" id="5538926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5538930">return</span>&nbsp;<span class="ident" id="5538937">nil</span><span class="op" id="5538940">,</span>&nbsp;<span class="ident" id="5538942">err</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5538947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538950">db</span><span class="op" id="5538952">.</span><span class="ident" id="5538953">mu</span><span class="op" id="5538955">.</span><span class="ident" id="5538956">Lock</span><span class="op" id="5538960">(</span><span class="op" id="5538961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538964">dc</span>&nbsp;<span class="op" id="5538967">:=</span>&nbsp;<span class="op" id="5538970">&amp;</span><span class="ident" id="5538971">driverConn</span><span class="op" id="5538981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538985">db</span><span class="op" id="5538987">:</span>&nbsp;<span class="ident" id="5538989">db</span><span class="op" id="5538991">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538995">ci</span><span class="op" id="5538997">:</span>&nbsp;<span class="ident" id="5538999">ci</span><span class="op" id="5539001">,</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5539004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539007">db</span><span class="op" id="5539009">.</span><span class="ident" id="5539010">addDepLocked</span><span class="op" id="5539022">(</span><span class="ident" id="5539023">dc</span><span class="op" id="5539025">,</span>&nbsp;<span class="ident" id="5539027">dc</span><span class="op" id="5539029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539032">dc</span><span class="op" id="5539034">.</span><span class="ident" id="5539035">inUse</span>&nbsp;<span class="op" id="5539041">=</span>&nbsp;<span class="builtintype" id="5539043">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539049">db</span><span class="op" id="5539051">.</span><span class="ident" id="5539052">mu</span><span class="op" id="5539054">.</span><span class="ident" id="5539055">Unlock</span><span class="op" id="5539061">(</span><span class="op" id="5539062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539065">return</span>&nbsp;<span class="ident" id="5539072">dc</span><span class="op" id="5539074">,</span>&nbsp;<span class="ident" id="5539076">nil</span><br>
<span class="lineno">680</span><span class="op" id="5539080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5539083">var</span>&nbsp;<span class="op" id="5539087">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539090">errConnClosed</span>&nbsp;<span class="op" id="5539104">=</span>&nbsp;<span class="ident" id="5539106">errors</span><span class="op" id="5539112">.</span><span class="ident" id="5539113">New</span><span class="op" id="5539116">(</span><span class="string" id="5539117">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5539172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539175">errConnBusy</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5539189">=</span>&nbsp;<span class="ident" id="5539191">errors</span><span class="op" id="5539197">.</span><span class="ident" id="5539198">New</span><span class="op" id="5539201">(</span><span class="string" id="5539202">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;busy&#34;</span><span class="op" id="5539255">)</span><br>
<span class="lineno">685</span><span class="op" id="5539257">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5539260">//&nbsp;connIfFree&nbsp;returns&nbsp;(wanted,&nbsp;nil)&nbsp;if&nbsp;wanted&nbsp;is&nbsp;still&nbsp;a&nbsp;valid&nbsp;conn&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5539332">//&nbsp;isn&#39;t&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="comment" id="5539349">//</span><br>
<span class="lineno">690</span><span class="comment" id="5539352">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnClosed&nbsp;if&nbsp;the&nbsp;connection&nbsp;if&nbsp;the&nbsp;requested&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5539428">//&nbsp;is&nbsp;invalid&nbsp;because&nbsp;it&#39;s&nbsp;been&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="5539468">//</span><br>
<span class="lineno"></span><span class="comment" id="5539471">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnBusy&nbsp;if&nbsp;the&nbsp;connection&nbsp;is&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="5539528">func</span>&nbsp;<span class="op" id="5539533">(</span><span class="ident" id="5539534">db</span>&nbsp;<span class="op" id="5539537">*</span><span class="ident" id="5539538">DB</span><span class="op" id="5539540">)</span>&nbsp;<span class="ident" id="5539542">connIfFree</span><span class="op" id="5539552">(</span><span class="ident" id="5539553">wanted</span>&nbsp;<span class="op" id="5539560">*</span><span class="ident" id="5539561">driverConn</span><span class="op" id="5539571">)</span>&nbsp;<span class="op" id="5539573">(</span><span class="op" id="5539574">*</span><span class="ident" id="5539575">driverConn</span><span class="op" id="5539585">,</span>&nbsp;<span class="builtintype" id="5539587">error</span><span class="op" id="5539592">)</span>&nbsp;<span class="op" id="5539594">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539597">db</span><span class="op" id="5539599">.</span><span class="ident" id="5539600">mu</span><span class="op" id="5539602">.</span><span class="ident" id="5539603">Lock</span><span class="op" id="5539607">(</span><span class="op" id="5539608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539611">defer</span>&nbsp;<span class="ident" id="5539617">db</span><span class="op" id="5539619">.</span><span class="ident" id="5539620">mu</span><span class="op" id="5539622">.</span><span class="ident" id="5539623">Unlock</span><span class="op" id="5539629">(</span><span class="op" id="5539630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539633">if</span>&nbsp;<span class="ident" id="5539636">wanted</span><span class="op" id="5539642">.</span><span class="ident" id="5539643">dbmuClosed</span>&nbsp;<span class="op" id="5539654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539658">return</span>&nbsp;<span class="ident" id="5539665">nil</span><span class="op" id="5539668">,</span>&nbsp;<span class="ident" id="5539670">errConnClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5539685">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539688">if</span>&nbsp;<span class="ident" id="5539691">wanted</span><span class="op" id="5539697">.</span><span class="ident" id="5539698">inUse</span>&nbsp;<span class="op" id="5539704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539708">return</span>&nbsp;<span class="ident" id="5539715">nil</span><span class="op" id="5539718">,</span>&nbsp;<span class="ident" id="5539720">errConnBusy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5539733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539736">idx</span>&nbsp;<span class="op" id="5539740">:=</span>&nbsp;<span class="op" id="5539743">-</span><span class="num" id="5539744">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539747">for</span>&nbsp;<span class="ident" id="5539751">ii</span><span class="op" id="5539753">,</span>&nbsp;<span class="ident" id="5539755">v</span>&nbsp;<span class="op" id="5539757">:=</span>&nbsp;<span class="keyword" id="5539760">range</span>&nbsp;<span class="ident" id="5539766">db</span><span class="op" id="5539768">.</span><span class="ident" id="5539769">freeConn</span>&nbsp;<span class="op" id="5539778">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539782">if</span>&nbsp;<span class="ident" id="5539785">v</span>&nbsp;<span class="op" id="5539787">==</span>&nbsp;<span class="ident" id="5539790">wanted</span>&nbsp;<span class="op" id="5539797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539802">idx</span>&nbsp;<span class="op" id="5539806">=</span>&nbsp;<span class="ident" id="5539808">ii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539814">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5539822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5539825">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539828">if</span>&nbsp;<span class="ident" id="5539831">idx</span>&nbsp;<span class="op" id="5539835">&gt;=</span>&nbsp;<span class="num" id="5539838">0</span>&nbsp;<span class="op" id="5539840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539844">db</span><span class="op" id="5539846">.</span><span class="ident" id="5539847">freeConn</span>&nbsp;<span class="op" id="5539856">=</span>&nbsp;<span class="builtinfunc" id="5539858">append</span><span class="op" id="5539864">(</span><span class="ident" id="5539865">db</span><span class="op" id="5539867">.</span><span class="ident" id="5539868">freeConn</span><span class="op" id="5539876">[</span><span class="op" id="5539877">:</span><span class="ident" id="5539878">idx</span><span class="op" id="5539881">]</span><span class="op" id="5539882">,</span>&nbsp;<span class="ident" id="5539884">db</span><span class="op" id="5539886">.</span><span class="ident" id="5539887">freeConn</span><span class="op" id="5539895">[</span><span class="ident" id="5539896">idx</span><span class="op" id="5539899">+</span><span class="num" id="5539900">1</span><span class="op" id="5539901">:</span><span class="op" id="5539902">]</span><span class="op" id="5539903">...</span><span class="op" id="5539906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539910">wanted</span><span class="op" id="5539916">.</span><span class="ident" id="5539917">inUse</span>&nbsp;<span class="op" id="5539923">=</span>&nbsp;<span class="builtintype" id="5539925">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539932">return</span>&nbsp;<span class="ident" id="5539939">wanted</span><span class="op" id="5539945">,</span>&nbsp;<span class="ident" id="5539947">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5539952">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5539955">//&nbsp;TODO(bradfitz):&nbsp;shouldn&#39;t&nbsp;get&nbsp;here.&nbsp;After&nbsp;Go&nbsp;1.1,&nbsp;change&nbsp;this&nbsp;to:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5540025">//&nbsp;panic(&#34;connIfFree&nbsp;call&nbsp;requested&nbsp;a&nbsp;non-closed,&nbsp;non-busy,&nbsp;non-free&nbsp;conn&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5540102">//&nbsp;Which&nbsp;passes&nbsp;all&nbsp;the&nbsp;tests,&nbsp;but&nbsp;I&#39;m&nbsp;too&nbsp;paranoid&nbsp;to&nbsp;include&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5540171">//&nbsp;late&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5540191">//&nbsp;Instead,&nbsp;treat&nbsp;it&nbsp;like&nbsp;a&nbsp;busy&nbsp;connection:</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5540237">return</span>&nbsp;<span class="ident" id="5540244">nil</span><span class="op" id="5540247">,</span>&nbsp;<span class="ident" id="5540249">errConnBusy</span><br>
<span class="lineno"></span><span class="op" id="5540261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5540264">//&nbsp;putConnHook&nbsp;is&nbsp;a&nbsp;hook&nbsp;for&nbsp;testing.</span><br>
<span class="lineno"></span><span class="keyword" id="5540302">var</span>&nbsp;<span class="ident" id="5540306">putConnHook</span>&nbsp;<span class="keyword" id="5540318">func</span><span class="op" id="5540322">(</span><span class="op" id="5540323">*</span><span class="ident" id="5540324">DB</span><span class="op" id="5540326">,</span>&nbsp;<span class="op" id="5540328">*</span><span class="ident" id="5540329">driverConn</span><span class="op" id="5540339">)</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="5540342">//&nbsp;noteUnusedDriverStatement&nbsp;notes&nbsp;that&nbsp;si&nbsp;is&nbsp;no&nbsp;longer&nbsp;used&nbsp;and&nbsp;should</span><br>
<span class="lineno"></span><span class="comment" id="5540414">//&nbsp;be&nbsp;closed&nbsp;whenever&nbsp;possible&nbsp;(when&nbsp;c&nbsp;is&nbsp;next&nbsp;not&nbsp;in&nbsp;use),&nbsp;unless&nbsp;c&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5540486">//&nbsp;already&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="5540505">func</span>&nbsp;<span class="op" id="5540510">(</span><span class="ident" id="5540511">db</span>&nbsp;<span class="op" id="5540514">*</span><span class="ident" id="5540515">DB</span><span class="op" id="5540517">)</span>&nbsp;<span class="ident" id="5540519">noteUnusedDriverStatement</span><span class="op" id="5540544">(</span><span class="ident" id="5540545">c</span>&nbsp;<span class="op" id="5540547">*</span><span class="ident" id="5540548">driverConn</span><span class="op" id="5540558">,</span>&nbsp;<span class="ident" id="5540560">si</span>&nbsp;<span class="ident" id="5540563">driver</span><span class="op" id="5540569">.</span><span class="ident" id="5540570">Stmt</span><span class="op" id="5540574">)</span>&nbsp;<span class="op" id="5540576">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5540579">db</span><span class="op" id="5540581">.</span><span class="ident" id="5540582">mu</span><span class="op" id="5540584">.</span><span class="ident" id="5540585">Lock</span><span class="op" id="5540589">(</span><span class="op" id="5540590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5540593">defer</span>&nbsp;<span class="ident" id="5540599">db</span><span class="op" id="5540601">.</span><span class="ident" id="5540602">mu</span><span class="op" id="5540604">.</span><span class="ident" id="5540605">Unlock</span><span class="op" id="5540611">(</span><span class="op" id="5540612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5540615">if</span>&nbsp;<span class="ident" id="5540618">c</span><span class="op" id="5540619">.</span><span class="ident" id="5540620">inUse</span>&nbsp;<span class="op" id="5540626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5540630">c</span><span class="op" id="5540631">.</span><span class="ident" id="5540632">onPut</span>&nbsp;<span class="op" id="5540638">=</span>&nbsp;<span class="builtinfunc" id="5540640">append</span><span class="op" id="5540646">(</span><span class="ident" id="5540647">c</span><span class="op" id="5540648">.</span><span class="ident" id="5540649">onPut</span><span class="op" id="5540654">,</span>&nbsp;<span class="keyword" id="5540656">func</span><span class="op" id="5540660">(</span><span class="op" id="5540661">)</span>&nbsp;<span class="op" id="5540663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5540668">si</span><span class="op" id="5540670">.</span><span class="ident" id="5540671">Close</span><span class="op" id="5540676">(</span><span class="op" id="5540677">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5540681">}</span><span class="op" id="5540682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5540685">}</span>&nbsp;<span class="keyword" id="5540687">else</span>&nbsp;<span class="op" id="5540692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5540696">c</span><span class="op" id="5540697">.</span><span class="ident" id="5540698">Lock</span><span class="op" id="5540702">(</span><span class="op" id="5540703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5540707">defer</span>&nbsp;<span class="ident" id="5540713">c</span><span class="op" id="5540714">.</span><span class="ident" id="5540715">Unlock</span><span class="op" id="5540721">(</span><span class="op" id="5540722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5540726">if</span>&nbsp;<span class="op" id="5540729">!</span><span class="ident" id="5540730">c</span><span class="op" id="5540731">.</span><span class="ident" id="5540732">finalClosed</span>&nbsp;<span class="op" id="5540744">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5540749">si</span><span class="op" id="5540751">.</span><span class="ident" id="5540752">Close</span><span class="op" id="5540757">(</span><span class="op" id="5540758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5540762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5540765">}</span><br>
<span class="lineno"></span><span class="op" id="5540767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">745</span><span class="comment" id="5540770">//&nbsp;debugGetPut&nbsp;determines&nbsp;whether&nbsp;getConn&nbsp;&amp;&nbsp;putConn&nbsp;calls&#39;&nbsp;stack&nbsp;traces</span><br>
<span class="lineno"></span><span class="comment" id="5540842">//&nbsp;are&nbsp;returned&nbsp;for&nbsp;more&nbsp;verbose&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="5540884">const</span>&nbsp;<span class="ident" id="5540890">debugGetPut</span>&nbsp;<span class="op" id="5540902">=</span>&nbsp;<span class="builtintype" id="5540904">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5540911">//&nbsp;putConn&nbsp;adds&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;db&#39;s&nbsp;free&nbsp;pool.</span><br>
<span class="lineno">750</span><span class="comment" id="5540963">//&nbsp;err&nbsp;is&nbsp;optionally&nbsp;the&nbsp;last&nbsp;error&nbsp;that&nbsp;occurred&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5541033">func</span>&nbsp;<span class="op" id="5541038">(</span><span class="ident" id="5541039">db</span>&nbsp;<span class="op" id="5541042">*</span><span class="ident" id="5541043">DB</span><span class="op" id="5541045">)</span>&nbsp;<span class="ident" id="5541047">putConn</span><span class="op" id="5541054">(</span><span class="ident" id="5541055">dc</span>&nbsp;<span class="op" id="5541058">*</span><span class="ident" id="5541059">driverConn</span><span class="op" id="5541069">,</span>&nbsp;<span class="ident" id="5541071">err</span>&nbsp;<span class="builtintype" id="5541075">error</span><span class="op" id="5541080">)</span>&nbsp;<span class="op" id="5541082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541085">db</span><span class="op" id="5541087">.</span><span class="ident" id="5541088">mu</span><span class="op" id="5541090">.</span><span class="ident" id="5541091">Lock</span><span class="op" id="5541095">(</span><span class="op" id="5541096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5541099">if</span>&nbsp;<span class="op" id="5541102">!</span><span class="ident" id="5541103">dc</span><span class="op" id="5541105">.</span><span class="ident" id="5541106">inUse</span>&nbsp;<span class="op" id="5541112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5541116">if</span>&nbsp;<span class="ident" id="5541119">debugGetPut</span>&nbsp;<span class="op" id="5541131">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541136">fmt</span><span class="op" id="5541139">.</span><span class="ident" id="5541140">Printf</span><span class="op" id="5541146">(</span><span class="string" id="5541147">&#34;putConn(%v)&nbsp;DUPLICATE&nbsp;was:&nbsp;%s\n\nPREVIOUS&nbsp;was:&nbsp;%s&#34;</span><span class="op" id="5541198">,</span>&nbsp;<span class="ident" id="5541200">dc</span><span class="op" id="5541202">,</span>&nbsp;<span class="ident" id="5541204">stack</span><span class="op" id="5541209">(</span><span class="op" id="5541210">)</span><span class="op" id="5541211">,</span>&nbsp;<span class="ident" id="5541213">db</span><span class="op" id="5541215">.</span><span class="ident" id="5541216">lastPut</span><span class="op" id="5541223">[</span><span class="ident" id="5541224">dc</span><span class="op" id="5541226">]</span><span class="op" id="5541227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5541231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5541235">panic</span><span class="op" id="5541240">(</span><span class="string" id="5541241">&#34;sql:&nbsp;connection&nbsp;returned&nbsp;that&nbsp;was&nbsp;never&nbsp;out&#34;</span><span class="op" id="5541286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5541289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5541292">if</span>&nbsp;<span class="ident" id="5541295">debugGetPut</span>&nbsp;<span class="op" id="5541307">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541311">db</span><span class="op" id="5541313">.</span><span class="ident" id="5541314">lastPut</span><span class="op" id="5541321">[</span><span class="ident" id="5541322">dc</span><span class="op" id="5541324">]</span>&nbsp;<span class="op" id="5541326">=</span>&nbsp;<span class="ident" id="5541328">stack</span><span class="op" id="5541333">(</span><span class="op" id="5541334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5541337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541340">dc</span><span class="op" id="5541342">.</span><span class="ident" id="5541343">inUse</span>&nbsp;<span class="op" id="5541349">=</span>&nbsp;<span class="builtintype" id="5541351">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5541359">for</span>&nbsp;<span class="ident" id="5541363">_</span><span class="op" id="5541364">,</span>&nbsp;<span class="ident" id="5541366">fn</span>&nbsp;<span class="op" id="5541369">:=</span>&nbsp;<span class="keyword" id="5541372">range</span>&nbsp;<span class="ident" id="5541378">dc</span><span class="op" id="5541380">.</span><span class="ident" id="5541381">onPut</span>&nbsp;<span class="op" id="5541387">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541391">fn</span><span class="op" id="5541393">(</span><span class="op" id="5541394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5541397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541400">dc</span><span class="op" id="5541402">.</span><span class="ident" id="5541403">onPut</span>&nbsp;<span class="op" id="5541409">=</span>&nbsp;<span class="ident" id="5541411">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5541417">if</span>&nbsp;<span class="ident" id="5541420">err</span>&nbsp;<span class="op" id="5541424">==</span>&nbsp;<span class="ident" id="5541427">driver</span><span class="op" id="5541433">.</span><span class="ident" id="5541434">ErrBadConn</span>&nbsp;<span class="op" id="5541445">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5541449">//&nbsp;Don&#39;t&nbsp;reuse&nbsp;bad&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5541483">//&nbsp;Since&nbsp;the&nbsp;conn&nbsp;is&nbsp;considered&nbsp;bad&nbsp;and&nbsp;is&nbsp;being&nbsp;discarded,&nbsp;treat&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5541554">//&nbsp;as&nbsp;closed.&nbsp;Don&#39;t&nbsp;decrement&nbsp;the&nbsp;open&nbsp;count&nbsp;here,&nbsp;finalClose&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5541623">//&nbsp;take&nbsp;care&nbsp;of&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541647">db</span><span class="op" id="5541649">.</span><span class="ident" id="5541650">maybeOpenNewConnections</span><span class="op" id="5541673">(</span><span class="op" id="5541674">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541678">db</span><span class="op" id="5541680">.</span><span class="ident" id="5541681">mu</span><span class="op" id="5541683">.</span><span class="ident" id="5541684">Unlock</span><span class="op" id="5541690">(</span><span class="op" id="5541691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541695">dc</span><span class="op" id="5541697">.</span><span class="ident" id="5541698">Close</span><span class="op" id="5541703">(</span><span class="op" id="5541704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5541708">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5541716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5541719">if</span>&nbsp;<span class="ident" id="5541722">putConnHook</span>&nbsp;<span class="op" id="5541734">!=</span>&nbsp;<span class="ident" id="5541737">nil</span>&nbsp;<span class="op" id="5541741">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541745">putConnHook</span><span class="op" id="5541756">(</span><span class="ident" id="5541757">db</span><span class="op" id="5541759">,</span>&nbsp;<span class="ident" id="5541761">dc</span><span class="op" id="5541763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5541766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541769">added</span>&nbsp;<span class="op" id="5541775">:=</span>&nbsp;<span class="ident" id="5541778">db</span><span class="op" id="5541780">.</span><span class="ident" id="5541781">putConnDBLocked</span><span class="op" id="5541796">(</span><span class="ident" id="5541797">dc</span><span class="op" id="5541799">,</span>&nbsp;<span class="ident" id="5541801">nil</span><span class="op" id="5541804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541807">db</span><span class="op" id="5541809">.</span><span class="ident" id="5541810">mu</span><span class="op" id="5541812">.</span><span class="ident" id="5541813">Unlock</span><span class="op" id="5541819">(</span><span class="op" id="5541820">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5541824">if</span>&nbsp;<span class="op" id="5541827">!</span><span class="ident" id="5541828">added</span>&nbsp;<span class="op" id="5541834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541838">dc</span><span class="op" id="5541840">.</span><span class="ident" id="5541841">Close</span><span class="op" id="5541846">(</span><span class="op" id="5541847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5541850">}</span><br>
<span class="lineno"></span><span class="op" id="5541852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">790</span><span class="comment" id="5541855">//&nbsp;Satisfy&nbsp;a&nbsp;connRequest&nbsp;or&nbsp;put&nbsp;the&nbsp;driverConn&nbsp;in&nbsp;the&nbsp;idle&nbsp;pool&nbsp;and&nbsp;return&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="5541935">//&nbsp;or&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="5541955">//&nbsp;putConnDBLocked&nbsp;will&nbsp;satisfy&nbsp;a&nbsp;connRequest&nbsp;if&nbsp;there&nbsp;is&nbsp;one,&nbsp;or&nbsp;it&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="5542029">//&nbsp;return&nbsp;the&nbsp;*driverConn&nbsp;to&nbsp;the&nbsp;freeConn&nbsp;list&nbsp;if&nbsp;err&nbsp;==&nbsp;nil&nbsp;and&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="5542103">//&nbsp;connection&nbsp;limit&nbsp;will&nbsp;not&nbsp;be&nbsp;exceeded.</span><br>
<span class="lineno">795</span><span class="comment" id="5542145">//&nbsp;If&nbsp;err&nbsp;!=&nbsp;nil,&nbsp;the&nbsp;value&nbsp;of&nbsp;dc&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="5542191">//&nbsp;If&nbsp;err&nbsp;==&nbsp;nil,&nbsp;then&nbsp;dc&nbsp;must&nbsp;not&nbsp;equal&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="5542237">//&nbsp;If&nbsp;a&nbsp;connRequest&nbsp;was&nbsp;fulfilled&nbsp;or&nbsp;the&nbsp;*driverConn&nbsp;was&nbsp;placed&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5542308">//&nbsp;freeConn&nbsp;list,&nbsp;then&nbsp;true&nbsp;is&nbsp;returned,&nbsp;otherwise&nbsp;false&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="5542378">func</span>&nbsp;<span class="op" id="5542383">(</span><span class="ident" id="5542384">db</span>&nbsp;<span class="op" id="5542387">*</span><span class="ident" id="5542388">DB</span><span class="op" id="5542390">)</span>&nbsp;<span class="ident" id="5542392">putConnDBLocked</span><span class="op" id="5542407">(</span><span class="ident" id="5542408">dc</span>&nbsp;<span class="op" id="5542411">*</span><span class="ident" id="5542412">driverConn</span><span class="op" id="5542422">,</span>&nbsp;<span class="ident" id="5542424">err</span>&nbsp;<span class="builtintype" id="5542428">error</span><span class="op" id="5542433">)</span>&nbsp;<span class="builtintype" id="5542435">bool</span>&nbsp;<span class="op" id="5542440">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5542443">if</span>&nbsp;<span class="ident" id="5542446">c</span>&nbsp;<span class="op" id="5542448">:=</span>&nbsp;<span class="builtinfunc" id="5542451">len</span><span class="op" id="5542454">(</span><span class="ident" id="5542455">db</span><span class="op" id="5542457">.</span><span class="ident" id="5542458">connRequests</span><span class="op" id="5542470">)</span><span class="op" id="5542471">;</span>&nbsp;<span class="ident" id="5542473">c</span>&nbsp;<span class="op" id="5542475">&gt;</span>&nbsp;<span class="num" id="5542477">0</span>&nbsp;<span class="op" id="5542479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542483">req</span>&nbsp;<span class="op" id="5542487">:=</span>&nbsp;<span class="ident" id="5542490">db</span><span class="op" id="5542492">.</span><span class="ident" id="5542493">connRequests</span><span class="op" id="5542505">[</span><span class="num" id="5542506">0</span><span class="op" id="5542507">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5542511">//&nbsp;This&nbsp;copy&nbsp;is&nbsp;O(n)&nbsp;but&nbsp;in&nbsp;practice&nbsp;faster&nbsp;than&nbsp;a&nbsp;linked&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5542577">//&nbsp;TODO:&nbsp;consider&nbsp;compacting&nbsp;it&nbsp;down&nbsp;less&nbsp;often&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5542631">//&nbsp;moving&nbsp;the&nbsp;base&nbsp;instead?</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5542661">copy</span><span class="op" id="5542665">(</span><span class="ident" id="5542666">db</span><span class="op" id="5542668">.</span><span class="ident" id="5542669">connRequests</span><span class="op" id="5542681">,</span>&nbsp;<span class="ident" id="5542683">db</span><span class="op" id="5542685">.</span><span class="ident" id="5542686">connRequests</span><span class="op" id="5542698">[</span><span class="num" id="5542699">1</span><span class="op" id="5542700">:</span><span class="op" id="5542701">]</span><span class="op" id="5542702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542706">db</span><span class="op" id="5542708">.</span><span class="ident" id="5542709">connRequests</span>&nbsp;<span class="op" id="5542722">=</span>&nbsp;<span class="ident" id="5542724">db</span><span class="op" id="5542726">.</span><span class="ident" id="5542727">connRequests</span><span class="op" id="5542739">[</span><span class="op" id="5542740">:</span><span class="ident" id="5542741">c</span><span class="op" id="5542742">-</span><span class="num" id="5542743">1</span><span class="op" id="5542744">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5542748">if</span>&nbsp;<span class="ident" id="5542751">err</span>&nbsp;<span class="op" id="5542755">==</span>&nbsp;<span class="ident" id="5542758">nil</span>&nbsp;<span class="op" id="5542762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542767">dc</span><span class="op" id="5542769">.</span><span class="ident" id="5542770">inUse</span>&nbsp;<span class="op" id="5542776">=</span>&nbsp;<span class="builtintype" id="5542778">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5542785">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542789">req</span>&nbsp;<span class="op" id="5542793">&lt;-</span>&nbsp;<span class="ident" id="5542796">connRequest</span><span class="op" id="5542807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542812">conn</span><span class="op" id="5542816">:</span>&nbsp;<span class="ident" id="5542818">dc</span><span class="op" id="5542820">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542825">err</span><span class="op" id="5542828">:</span>&nbsp;&nbsp;<span class="ident" id="5542831">err</span><span class="op" id="5542834">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5542838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5542842">return</span>&nbsp;<span class="builtintype" id="5542849">true</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5542855">}</span>&nbsp;<span class="keyword" id="5542857">else</span>&nbsp;<span class="keyword" id="5542862">if</span>&nbsp;<span class="ident" id="5542865">err</span>&nbsp;<span class="op" id="5542869">==</span>&nbsp;<span class="ident" id="5542872">nil</span>&nbsp;<span class="op" id="5542876">&amp;&amp;</span>&nbsp;<span class="op" id="5542879">!</span><span class="ident" id="5542880">db</span><span class="op" id="5542882">.</span><span class="ident" id="5542883">closed</span>&nbsp;<span class="op" id="5542890">&amp;&amp;</span>&nbsp;<span class="ident" id="5542893">db</span><span class="op" id="5542895">.</span><span class="ident" id="5542896">maxIdleConnsLocked</span><span class="op" id="5542914">(</span><span class="op" id="5542915">)</span>&nbsp;<span class="op" id="5542917">&gt;</span>&nbsp;<span class="builtinfunc" id="5542919">len</span><span class="op" id="5542922">(</span><span class="ident" id="5542923">db</span><span class="op" id="5542925">.</span><span class="ident" id="5542926">freeConn</span><span class="op" id="5542934">)</span>&nbsp;<span class="op" id="5542936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542940">db</span><span class="op" id="5542942">.</span><span class="ident" id="5542943">freeConn</span>&nbsp;<span class="op" id="5542952">=</span>&nbsp;<span class="builtinfunc" id="5542954">append</span><span class="op" id="5542960">(</span><span class="ident" id="5542961">db</span><span class="op" id="5542963">.</span><span class="ident" id="5542964">freeConn</span><span class="op" id="5542972">,</span>&nbsp;<span class="ident" id="5542974">dc</span><span class="op" id="5542976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5542980">return</span>&nbsp;<span class="builtintype" id="5542987">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5542993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5542996">return</span>&nbsp;<span class="builtintype" id="5543003">false</span><br>
<span class="lineno">820</span><span class="op" id="5543009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5543012">//&nbsp;maxBadConnRetries&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;maximum&nbsp;retries&nbsp;if&nbsp;the&nbsp;driver&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5543088">//&nbsp;driver.ErrBadConn&nbsp;to&nbsp;signal&nbsp;a&nbsp;broken&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5543140">const</span>&nbsp;<span class="ident" id="5543146">maxBadConnRetries</span>&nbsp;<span class="op" id="5543164">=</span>&nbsp;<span class="num" id="5543166">10</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="comment" id="5543170">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;later&nbsp;queries&nbsp;or&nbsp;executions.</span><br>
<span class="lineno"></span><span class="comment" id="5543243">//&nbsp;Multiple&nbsp;queries&nbsp;or&nbsp;executions&nbsp;may&nbsp;be&nbsp;run&nbsp;concurrently&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5543310">//&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5543333">func</span>&nbsp;<span class="op" id="5543338">(</span><span class="ident" id="5543339">db</span>&nbsp;<span class="op" id="5543342">*</span><span class="ident" id="5543343">DB</span><span class="op" id="5543345">)</span>&nbsp;<span class="ident" id="5543347">Prepare</span><span class="op" id="5543354">(</span><span class="ident" id="5543355">query</span>&nbsp;<span class="builtintype" id="5543361">string</span><span class="op" id="5543367">)</span>&nbsp;<span class="op" id="5543369">(</span><span class="op" id="5543370">*</span><span class="ident" id="5543371">Stmt</span><span class="op" id="5543375">,</span>&nbsp;<span class="builtintype" id="5543377">error</span><span class="op" id="5543382">)</span>&nbsp;<span class="op" id="5543384">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5543387">var</span>&nbsp;<span class="ident" id="5543391">stmt</span>&nbsp;<span class="op" id="5543396">*</span><span class="ident" id="5543397">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5543403">var</span>&nbsp;<span class="ident" id="5543407">err</span>&nbsp;<span class="builtintype" id="5543411">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5543418">for</span>&nbsp;<span class="ident" id="5543422">i</span>&nbsp;<span class="op" id="5543424">:=</span>&nbsp;<span class="num" id="5543427">0</span><span class="op" id="5543428">;</span>&nbsp;<span class="ident" id="5543430">i</span>&nbsp;<span class="op" id="5543432">&lt;</span>&nbsp;<span class="ident" id="5543434">maxBadConnRetries</span><span class="op" id="5543451">;</span>&nbsp;<span class="ident" id="5543453">i</span><span class="op" id="5543454">++</span>&nbsp;<span class="op" id="5543457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5543461">stmt</span><span class="op" id="5543465">,</span>&nbsp;<span class="ident" id="5543467">err</span>&nbsp;<span class="op" id="5543471">=</span>&nbsp;<span class="ident" id="5543473">db</span><span class="op" id="5543475">.</span><span class="ident" id="5543476">prepare</span><span class="op" id="5543483">(</span><span class="ident" id="5543484">query</span><span class="op" id="5543489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5543493">if</span>&nbsp;<span class="ident" id="5543496">err</span>&nbsp;<span class="op" id="5543500">!=</span>&nbsp;<span class="ident" id="5543503">driver</span><span class="op" id="5543509">.</span><span class="ident" id="5543510">ErrBadConn</span>&nbsp;<span class="op" id="5543521">{</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5543526">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5543534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5543537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5543540">return</span>&nbsp;<span class="ident" id="5543547">stmt</span><span class="op" id="5543551">,</span>&nbsp;<span class="ident" id="5543553">err</span><br>
<span class="lineno"></span><span class="op" id="5543557">}</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span><span class="keyword" id="5543560">func</span>&nbsp;<span class="op" id="5543565">(</span><span class="ident" id="5543566">db</span>&nbsp;<span class="op" id="5543569">*</span><span class="ident" id="5543570">DB</span><span class="op" id="5543572">)</span>&nbsp;<span class="ident" id="5543574">prepare</span><span class="op" id="5543581">(</span><span class="ident" id="5543582">query</span>&nbsp;<span class="builtintype" id="5543588">string</span><span class="op" id="5543594">)</span>&nbsp;<span class="op" id="5543596">(</span><span class="op" id="5543597">*</span><span class="ident" id="5543598">Stmt</span><span class="op" id="5543602">,</span>&nbsp;<span class="builtintype" id="5543604">error</span><span class="op" id="5543609">)</span>&nbsp;<span class="op" id="5543611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5543614">//&nbsp;TODO:&nbsp;check&nbsp;if&nbsp;db.driver&nbsp;supports&nbsp;an&nbsp;optional</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5543664">//&nbsp;driver.Preparer&nbsp;interface&nbsp;and&nbsp;call&nbsp;that&nbsp;instead,&nbsp;if&nbsp;so,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5543724">//&nbsp;otherwise&nbsp;we&nbsp;make&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;that&#39;s&nbsp;bound</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5543780">//&nbsp;to&nbsp;a&nbsp;connection,&nbsp;and&nbsp;to&nbsp;execute&nbsp;this&nbsp;prepared&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5543840">//&nbsp;we&nbsp;either&nbsp;need&nbsp;to&nbsp;use&nbsp;this&nbsp;connection&nbsp;(if&nbsp;it&#39;s&nbsp;free),&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5543903">//&nbsp;get&nbsp;a&nbsp;new&nbsp;connection&nbsp;+&nbsp;re-prepare&nbsp;+&nbsp;execute&nbsp;on&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5543964">dc</span><span class="op" id="5543966">,</span>&nbsp;<span class="ident" id="5543968">err</span>&nbsp;<span class="op" id="5543972">:=</span>&nbsp;<span class="ident" id="5543975">db</span><span class="op" id="5543977">.</span><span class="ident" id="5543978">conn</span><span class="op" id="5543982">(</span><span class="op" id="5543983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5543986">if</span>&nbsp;<span class="ident" id="5543989">err</span>&nbsp;<span class="op" id="5543993">!=</span>&nbsp;<span class="ident" id="5543996">nil</span>&nbsp;<span class="op" id="5544000">{</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5544004">return</span>&nbsp;<span class="ident" id="5544011">nil</span><span class="op" id="5544014">,</span>&nbsp;<span class="ident" id="5544016">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5544021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5544024">dc</span><span class="op" id="5544026">.</span><span class="ident" id="5544027">Lock</span><span class="op" id="5544031">(</span><span class="op" id="5544032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5544035">si</span><span class="op" id="5544037">,</span>&nbsp;<span class="ident" id="5544039">err</span>&nbsp;<span class="op" id="5544043">:=</span>&nbsp;<span class="ident" id="5544046">dc</span><span class="op" id="5544048">.</span><span class="ident" id="5544049">prepareLocked</span><span class="op" id="5544062">(</span><span class="ident" id="5544063">query</span><span class="op" id="5544068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5544071">dc</span><span class="op" id="5544073">.</span><span class="ident" id="5544074">Unlock</span><span class="op" id="5544080">(</span><span class="op" id="5544081">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5544084">if</span>&nbsp;<span class="ident" id="5544087">err</span>&nbsp;<span class="op" id="5544091">!=</span>&nbsp;<span class="ident" id="5544094">nil</span>&nbsp;<span class="op" id="5544098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5544102">db</span><span class="op" id="5544104">.</span><span class="ident" id="5544105">putConn</span><span class="op" id="5544112">(</span><span class="ident" id="5544113">dc</span><span class="op" id="5544115">,</span>&nbsp;<span class="ident" id="5544117">err</span><span class="op" id="5544120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5544124">return</span>&nbsp;<span class="ident" id="5544131">nil</span><span class="op" id="5544134">,</span>&nbsp;<span class="ident" id="5544136">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5544141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5544144">stmt</span>&nbsp;<span class="op" id="5544149">:=</span>&nbsp;<span class="op" id="5544152">&amp;</span><span class="ident" id="5544153">Stmt</span><span class="op" id="5544157">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5544161">db</span><span class="op" id="5544163">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5544168">db</span><span class="op" id="5544170">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5544174">query</span><span class="op" id="5544179">:</span>&nbsp;<span class="ident" id="5544181">query</span><span class="op" id="5544186">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5544190">css</span><span class="op" id="5544193">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5544197">[</span><span class="op" id="5544198">]</span><span class="ident" id="5544199">connStmt</span><span class="op" id="5544207">{</span><span class="op" id="5544208">{</span><span class="ident" id="5544209">dc</span><span class="op" id="5544211">,</span>&nbsp;<span class="ident" id="5544213">si</span><span class="op" id="5544215">}</span><span class="op" id="5544216">}</span><span class="op" id="5544217">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5544220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5544223">db</span><span class="op" id="5544225">.</span><span class="ident" id="5544226">addDep</span><span class="op" id="5544232">(</span><span class="ident" id="5544233">stmt</span><span class="op" id="5544237">,</span>&nbsp;<span class="ident" id="5544239">stmt</span><span class="op" id="5544243">)</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5544246">db</span><span class="op" id="5544248">.</span><span class="ident" id="5544249">putConn</span><span class="op" id="5544256">(</span><span class="ident" id="5544257">dc</span><span class="op" id="5544259">,</span>&nbsp;<span class="ident" id="5544261">nil</span><span class="op" id="5544264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5544267">return</span>&nbsp;<span class="ident" id="5544274">stmt</span><span class="op" id="5544278">,</span>&nbsp;<span class="ident" id="5544280">nil</span><br>
<span class="lineno"></span><span class="op" id="5544284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5544287">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;without&nbsp;returning&nbsp;any&nbsp;rows.</span><br>
<span class="lineno">870</span><span class="comment" id="5544340">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno"></span><span class="keyword" id="5544401">func</span>&nbsp;<span class="op" id="5544406">(</span><span class="ident" id="5544407">db</span>&nbsp;<span class="op" id="5544410">*</span><span class="ident" id="5544411">DB</span><span class="op" id="5544413">)</span>&nbsp;<span class="ident" id="5544415">Exec</span><span class="op" id="5544419">(</span><span class="ident" id="5544420">query</span>&nbsp;<span class="builtintype" id="5544426">string</span><span class="op" id="5544432">,</span>&nbsp;<span class="ident" id="5544434">args</span>&nbsp;<span class="op" id="5544439">...</span><span class="keyword" id="5544442">interface</span><span class="op" id="5544451">{</span><span class="op" id="5544452">}</span><span class="op" id="5544453">)</span>&nbsp;<span class="op" id="5544455">(</span><span class="ident" id="5544456">Result</span><span class="op" id="5544462">,</span>&nbsp;<span class="builtintype" id="5544464">error</span><span class="op" id="5544469">)</span>&nbsp;<span class="op" id="5544471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5544474">var</span>&nbsp;<span class="ident" id="5544478">res</span>&nbsp;<span class="ident" id="5544482">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5544490">var</span>&nbsp;<span class="ident" id="5544494">err</span>&nbsp;<span class="builtintype" id="5544498">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5544505">for</span>&nbsp;<span class="ident" id="5544509">i</span>&nbsp;<span class="op" id="5544511">:=</span>&nbsp;<span class="num" id="5544514">0</span><span class="op" id="5544515">;</span>&nbsp;<span class="ident" id="5544517">i</span>&nbsp;<span class="op" id="5544519">&lt;</span>&nbsp;<span class="ident" id="5544521">maxBadConnRetries</span><span class="op" id="5544538">;</span>&nbsp;<span class="ident" id="5544540">i</span><span class="op" id="5544541">++</span>&nbsp;<span class="op" id="5544544">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5544548">res</span><span class="op" id="5544551">,</span>&nbsp;<span class="ident" id="5544553">err</span>&nbsp;<span class="op" id="5544557">=</span>&nbsp;<span class="ident" id="5544559">db</span><span class="op" id="5544561">.</span><span class="ident" id="5544562">exec</span><span class="op" id="5544566">(</span><span class="ident" id="5544567">query</span><span class="op" id="5544572">,</span>&nbsp;<span class="ident" id="5544574">args</span><span class="op" id="5544578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5544582">if</span>&nbsp;<span class="ident" id="5544585">err</span>&nbsp;<span class="op" id="5544589">!=</span>&nbsp;<span class="ident" id="5544592">driver</span><span class="op" id="5544598">.</span><span class="ident" id="5544599">ErrBadConn</span>&nbsp;<span class="op" id="5544610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5544615">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5544623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5544626">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5544629">return</span>&nbsp;<span class="ident" id="5544636">res</span><span class="op" id="5544639">,</span>&nbsp;<span class="ident" id="5544641">err</span><br>
<span class="lineno"></span><span class="op" id="5544645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5544648">func</span>&nbsp;<span class="op" id="5544653">(</span><span class="ident" id="5544654">db</span>&nbsp;<span class="op" id="5544657">*</span><span class="ident" id="5544658">DB</span><span class="op" id="5544660">)</span>&nbsp;<span class="ident" id="5544662">exec</span><span class="op" id="5544666">(</span><span class="ident" id="5544667">query</span>&nbsp;<span class="builtintype" id="5544673">string</span><span class="op" id="5544679">,</span>&nbsp;<span class="ident" id="5544681">args</span>&nbsp;<span class="op" id="5544686">[</span><span class="op" id="5544687">]</span><span class="keyword" id="5544688">interface</span><span class="op" id="5544697">{</span><span class="op" id="5544698">}</span><span class="op" id="5544699">)</span>&nbsp;<span class="op" id="5544701">(</span><span class="ident" id="5544702">res</span>&nbsp;<span class="ident" id="5544706">Result</span><span class="op" id="5544712">,</span>&nbsp;<span class="ident" id="5544714">err</span>&nbsp;<span class="builtintype" id="5544718">error</span><span class="op" id="5544723">)</span>&nbsp;<span class="op" id="5544725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5544728">dc</span><span class="op" id="5544730">,</span>&nbsp;<span class="ident" id="5544732">err</span>&nbsp;<span class="op" id="5544736">:=</span>&nbsp;<span class="ident" id="5544739">db</span><span class="op" id="5544741">.</span><span class="ident" id="5544742">conn</span><span class="op" id="5544746">(</span><span class="op" id="5544747">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5544750">if</span>&nbsp;<span class="ident" id="5544753">err</span>&nbsp;<span class="op" id="5544757">!=</span>&nbsp;<span class="ident" id="5544760">nil</span>&nbsp;<span class="op" id="5544764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5544768">return</span>&nbsp;<span class="ident" id="5544775">nil</span><span class="op" id="5544778">,</span>&nbsp;<span class="ident" id="5544780">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5544785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5544788">defer</span>&nbsp;<span class="keyword" id="5544794">func</span><span class="op" id="5544798">(</span><span class="op" id="5544799">)</span>&nbsp;<span class="op" id="5544801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5544805">db</span><span class="op" id="5544807">.</span><span class="ident" id="5544808">putConn</span><span class="op" id="5544815">(</span><span class="ident" id="5544816">dc</span><span class="op" id="5544818">,</span>&nbsp;<span class="ident" id="5544820">err</span><span class="op" id="5544823">)</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5544826">}</span><span class="op" id="5544827">(</span><span class="op" id="5544828">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5544832">if</span>&nbsp;<span class="ident" id="5544835">execer</span><span class="op" id="5544841">,</span>&nbsp;<span class="ident" id="5544843">ok</span>&nbsp;<span class="op" id="5544846">:=</span>&nbsp;<span class="ident" id="5544849">dc</span><span class="op" id="5544851">.</span><span class="ident" id="5544852">ci</span><span class="op" id="5544854">.</span><span class="op" id="5544855">(</span><span class="ident" id="5544856">driver</span><span class="op" id="5544862">.</span><span class="ident" id="5544863">Execer</span><span class="op" id="5544869">)</span><span class="op" id="5544870">;</span>&nbsp;<span class="ident" id="5544872">ok</span>&nbsp;<span class="op" id="5544875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5544879">dargs</span><span class="op" id="5544884">,</span>&nbsp;<span class="ident" id="5544886">err</span>&nbsp;<span class="op" id="5544890">:=</span>&nbsp;<span class="ident" id="5544893">driverArgs</span><span class="op" id="5544903">(</span><span class="ident" id="5544904">nil</span><span class="op" id="5544907">,</span>&nbsp;<span class="ident" id="5544909">args</span><span class="op" id="5544913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5544917">if</span>&nbsp;<span class="ident" id="5544920">err</span>&nbsp;<span class="op" id="5544924">!=</span>&nbsp;<span class="ident" id="5544927">nil</span>&nbsp;<span class="op" id="5544931">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5544936">return</span>&nbsp;<span class="ident" id="5544943">nil</span><span class="op" id="5544946">,</span>&nbsp;<span class="ident" id="5544948">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5544954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5544958">dc</span><span class="op" id="5544960">.</span><span class="ident" id="5544961">Lock</span><span class="op" id="5544965">(</span><span class="op" id="5544966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5544970">resi</span><span class="op" id="5544974">,</span>&nbsp;<span class="ident" id="5544976">err</span>&nbsp;<span class="op" id="5544980">:=</span>&nbsp;<span class="ident" id="5544983">execer</span><span class="op" id="5544989">.</span><span class="ident" id="5544990">Exec</span><span class="op" id="5544994">(</span><span class="ident" id="5544995">query</span><span class="op" id="5545000">,</span>&nbsp;<span class="ident" id="5545002">dargs</span><span class="op" id="5545007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5545011">dc</span><span class="op" id="5545013">.</span><span class="ident" id="5545014">Unlock</span><span class="op" id="5545020">(</span><span class="op" id="5545021">)</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5545025">if</span>&nbsp;<span class="ident" id="5545028">err</span>&nbsp;<span class="op" id="5545032">!=</span>&nbsp;<span class="ident" id="5545035">driver</span><span class="op" id="5545041">.</span><span class="ident" id="5545042">ErrSkip</span>&nbsp;<span class="op" id="5545050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5545055">if</span>&nbsp;<span class="ident" id="5545058">err</span>&nbsp;<span class="op" id="5545062">!=</span>&nbsp;<span class="ident" id="5545065">nil</span>&nbsp;<span class="op" id="5545069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5545075">return</span>&nbsp;<span class="ident" id="5545082">nil</span><span class="op" id="5545085">,</span>&nbsp;<span class="ident" id="5545087">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5545094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5545099">return</span>&nbsp;<span class="ident" id="5545106">driverResult</span><span class="op" id="5545118">{</span><span class="ident" id="5545119">dc</span><span class="op" id="5545121">,</span>&nbsp;<span class="ident" id="5545123">resi</span><span class="op" id="5545127">}</span><span class="op" id="5545128">,</span>&nbsp;<span class="ident" id="5545130">nil</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5545136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5545139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5545143">dc</span><span class="op" id="5545145">.</span><span class="ident" id="5545146">Lock</span><span class="op" id="5545150">(</span><span class="op" id="5545151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5545154">si</span><span class="op" id="5545156">,</span>&nbsp;<span class="ident" id="5545158">err</span>&nbsp;<span class="op" id="5545162">:=</span>&nbsp;<span class="ident" id="5545165">dc</span><span class="op" id="5545167">.</span><span class="ident" id="5545168">ci</span><span class="op" id="5545170">.</span><span class="ident" id="5545171">Prepare</span><span class="op" id="5545178">(</span><span class="ident" id="5545179">query</span><span class="op" id="5545184">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5545187">dc</span><span class="op" id="5545189">.</span><span class="ident" id="5545190">Unlock</span><span class="op" id="5545196">(</span><span class="op" id="5545197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5545200">if</span>&nbsp;<span class="ident" id="5545203">err</span>&nbsp;<span class="op" id="5545207">!=</span>&nbsp;<span class="ident" id="5545210">nil</span>&nbsp;<span class="op" id="5545214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5545218">return</span>&nbsp;<span class="ident" id="5545225">nil</span><span class="op" id="5545228">,</span>&nbsp;<span class="ident" id="5545230">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5545235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5545238">defer</span>&nbsp;<span class="ident" id="5545244">withLock</span><span class="op" id="5545252">(</span><span class="ident" id="5545253">dc</span><span class="op" id="5545255">,</span>&nbsp;<span class="keyword" id="5545257">func</span><span class="op" id="5545261">(</span><span class="op" id="5545262">)</span>&nbsp;<span class="op" id="5545264">{</span>&nbsp;<span class="ident" id="5545266">si</span><span class="op" id="5545268">.</span><span class="ident" id="5545269">Close</span><span class="op" id="5545274">(</span><span class="op" id="5545275">)</span>&nbsp;<span class="op" id="5545277">}</span><span class="op" id="5545278">)</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5545281">return</span>&nbsp;<span class="ident" id="5545288">resultFromStatement</span><span class="op" id="5545307">(</span><span class="ident" id="5545308">driverStmt</span><span class="op" id="5545318">{</span><span class="ident" id="5545319">dc</span><span class="op" id="5545321">,</span>&nbsp;<span class="ident" id="5545323">si</span><span class="op" id="5545325">}</span><span class="op" id="5545326">,</span>&nbsp;<span class="ident" id="5545328">args</span><span class="op" id="5545332">...</span><span class="op" id="5545335">)</span><br>
<span class="lineno"></span><span class="op" id="5545337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5545340">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="comment" id="5545405">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno">920</span><span class="keyword" id="5545466">func</span>&nbsp;<span class="op" id="5545471">(</span><span class="ident" id="5545472">db</span>&nbsp;<span class="op" id="5545475">*</span><span class="ident" id="5545476">DB</span><span class="op" id="5545478">)</span>&nbsp;<span class="ident" id="5545480">Query</span><span class="op" id="5545485">(</span><span class="ident" id="5545486">query</span>&nbsp;<span class="builtintype" id="5545492">string</span><span class="op" id="5545498">,</span>&nbsp;<span class="ident" id="5545500">args</span>&nbsp;<span class="op" id="5545505">...</span><span class="keyword" id="5545508">interface</span><span class="op" id="5545517">{</span><span class="op" id="5545518">}</span><span class="op" id="5545519">)</span>&nbsp;<span class="op" id="5545521">(</span><span class="op" id="5545522">*</span><span class="ident" id="5545523">Rows</span><span class="op" id="5545527">,</span>&nbsp;<span class="builtintype" id="5545529">error</span><span class="op" id="5545534">)</span>&nbsp;<span class="op" id="5545536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5545539">var</span>&nbsp;<span class="ident" id="5545543">rows</span>&nbsp;<span class="op" id="5545548">*</span><span class="ident" id="5545549">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5545555">var</span>&nbsp;<span class="ident" id="5545559">err</span>&nbsp;<span class="builtintype" id="5545563">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5545570">for</span>&nbsp;<span class="ident" id="5545574">i</span>&nbsp;<span class="op" id="5545576">:=</span>&nbsp;<span class="num" id="5545579">0</span><span class="op" id="5545580">;</span>&nbsp;<span class="ident" id="5545582">i</span>&nbsp;<span class="op" id="5545584">&lt;</span>&nbsp;<span class="ident" id="5545586">maxBadConnRetries</span><span class="op" id="5545603">;</span>&nbsp;<span class="ident" id="5545605">i</span><span class="op" id="5545606">++</span>&nbsp;<span class="op" id="5545609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5545613">rows</span><span class="op" id="5545617">,</span>&nbsp;<span class="ident" id="5545619">err</span>&nbsp;<span class="op" id="5545623">=</span>&nbsp;<span class="ident" id="5545625">db</span><span class="op" id="5545627">.</span><span class="ident" id="5545628">query</span><span class="op" id="5545633">(</span><span class="ident" id="5545634">query</span><span class="op" id="5545639">,</span>&nbsp;<span class="ident" id="5545641">args</span><span class="op" id="5545645">)</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5545649">if</span>&nbsp;<span class="ident" id="5545652">err</span>&nbsp;<span class="op" id="5545656">!=</span>&nbsp;<span class="ident" id="5545659">driver</span><span class="op" id="5545665">.</span><span class="ident" id="5545666">ErrBadConn</span>&nbsp;<span class="op" id="5545677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5545682">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5545690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5545693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5545696">return</span>&nbsp;<span class="ident" id="5545703">rows</span><span class="op" id="5545707">,</span>&nbsp;<span class="ident" id="5545709">err</span><br>
<span class="lineno">930</span><span class="op" id="5545713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5545716">func</span>&nbsp;<span class="op" id="5545721">(</span><span class="ident" id="5545722">db</span>&nbsp;<span class="op" id="5545725">*</span><span class="ident" id="5545726">DB</span><span class="op" id="5545728">)</span>&nbsp;<span class="ident" id="5545730">query</span><span class="op" id="5545735">(</span><span class="ident" id="5545736">query</span>&nbsp;<span class="builtintype" id="5545742">string</span><span class="op" id="5545748">,</span>&nbsp;<span class="ident" id="5545750">args</span>&nbsp;<span class="op" id="5545755">[</span><span class="op" id="5545756">]</span><span class="keyword" id="5545757">interface</span><span class="op" id="5545766">{</span><span class="op" id="5545767">}</span><span class="op" id="5545768">)</span>&nbsp;<span class="op" id="5545770">(</span><span class="op" id="5545771">*</span><span class="ident" id="5545772">Rows</span><span class="op" id="5545776">,</span>&nbsp;<span class="builtintype" id="5545778">error</span><span class="op" id="5545783">)</span>&nbsp;<span class="op" id="5545785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5545788">ci</span><span class="op" id="5545790">,</span>&nbsp;<span class="ident" id="5545792">err</span>&nbsp;<span class="op" id="5545796">:=</span>&nbsp;<span class="ident" id="5545799">db</span><span class="op" id="5545801">.</span><span class="ident" id="5545802">conn</span><span class="op" id="5545806">(</span><span class="op" id="5545807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5545810">if</span>&nbsp;<span class="ident" id="5545813">err</span>&nbsp;<span class="op" id="5545817">!=</span>&nbsp;<span class="ident" id="5545820">nil</span>&nbsp;<span class="op" id="5545824">{</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5545828">return</span>&nbsp;<span class="ident" id="5545835">nil</span><span class="op" id="5545838">,</span>&nbsp;<span class="ident" id="5545840">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5545845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5545849">return</span>&nbsp;<span class="ident" id="5545856">db</span><span class="op" id="5545858">.</span><span class="ident" id="5545859">queryConn</span><span class="op" id="5545868">(</span><span class="ident" id="5545869">ci</span><span class="op" id="5545871">,</span>&nbsp;<span class="ident" id="5545873">ci</span><span class="op" id="5545875">.</span><span class="ident" id="5545876">releaseConn</span><span class="op" id="5545887">,</span>&nbsp;<span class="ident" id="5545889">query</span><span class="op" id="5545894">,</span>&nbsp;<span class="ident" id="5545896">args</span><span class="op" id="5545900">)</span><br>
<span class="lineno"></span><span class="op" id="5545902">}</span><br>
<span class="lineno">940</span><br>
<span class="lineno"></span><span class="comment" id="5545905">//&nbsp;queryConn&nbsp;executes&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;given&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5545960">//&nbsp;The&nbsp;connection&nbsp;gets&nbsp;released&nbsp;by&nbsp;the&nbsp;releaseConn&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="5546021">func</span>&nbsp;<span class="op" id="5546026">(</span><span class="ident" id="5546027">db</span>&nbsp;<span class="op" id="5546030">*</span><span class="ident" id="5546031">DB</span><span class="op" id="5546033">)</span>&nbsp;<span class="ident" id="5546035">queryConn</span><span class="op" id="5546044">(</span><span class="ident" id="5546045">dc</span>&nbsp;<span class="op" id="5546048">*</span><span class="ident" id="5546049">driverConn</span><span class="op" id="5546059">,</span>&nbsp;<span class="ident" id="5546061">releaseConn</span>&nbsp;<span class="keyword" id="5546073">func</span><span class="op" id="5546077">(</span><span class="builtintype" id="5546078">error</span><span class="op" id="5546083">)</span><span class="op" id="5546084">,</span>&nbsp;<span class="ident" id="5546086">query</span>&nbsp;<span class="builtintype" id="5546092">string</span><span class="op" id="5546098">,</span>&nbsp;<span class="ident" id="5546100">args</span>&nbsp;<span class="op" id="5546105">[</span><span class="op" id="5546106">]</span><span class="keyword" id="5546107">interface</span><span class="op" id="5546116">{</span><span class="op" id="5546117">}</span><span class="op" id="5546118">)</span>&nbsp;<span class="op" id="5546120">(</span><span class="op" id="5546121">*</span><span class="ident" id="5546122">Rows</span><span class="op" id="5546126">,</span>&nbsp;<span class="builtintype" id="5546128">error</span><span class="op" id="5546133">)</span>&nbsp;<span class="op" id="5546135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5546138">if</span>&nbsp;<span class="ident" id="5546141">queryer</span><span class="op" id="5546148">,</span>&nbsp;<span class="ident" id="5546150">ok</span>&nbsp;<span class="op" id="5546153">:=</span>&nbsp;<span class="ident" id="5546156">dc</span><span class="op" id="5546158">.</span><span class="ident" id="5546159">ci</span><span class="op" id="5546161">.</span><span class="op" id="5546162">(</span><span class="ident" id="5546163">driver</span><span class="op" id="5546169">.</span><span class="ident" id="5546170">Queryer</span><span class="op" id="5546177">)</span><span class="op" id="5546178">;</span>&nbsp;<span class="ident" id="5546180">ok</span>&nbsp;<span class="op" id="5546183">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546187">dargs</span><span class="op" id="5546192">,</span>&nbsp;<span class="ident" id="5546194">err</span>&nbsp;<span class="op" id="5546198">:=</span>&nbsp;<span class="ident" id="5546201">driverArgs</span><span class="op" id="5546211">(</span><span class="ident" id="5546212">nil</span><span class="op" id="5546215">,</span>&nbsp;<span class="ident" id="5546217">args</span><span class="op" id="5546221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5546225">if</span>&nbsp;<span class="ident" id="5546228">err</span>&nbsp;<span class="op" id="5546232">!=</span>&nbsp;<span class="ident" id="5546235">nil</span>&nbsp;<span class="op" id="5546239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546244">releaseConn</span><span class="op" id="5546255">(</span><span class="ident" id="5546256">err</span><span class="op" id="5546259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5546264">return</span>&nbsp;<span class="ident" id="5546271">nil</span><span class="op" id="5546274">,</span>&nbsp;<span class="ident" id="5546276">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5546282">}</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546286">dc</span><span class="op" id="5546288">.</span><span class="ident" id="5546289">Lock</span><span class="op" id="5546293">(</span><span class="op" id="5546294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546298">rowsi</span><span class="op" id="5546303">,</span>&nbsp;<span class="ident" id="5546305">err</span>&nbsp;<span class="op" id="5546309">:=</span>&nbsp;<span class="ident" id="5546312">queryer</span><span class="op" id="5546319">.</span><span class="ident" id="5546320">Query</span><span class="op" id="5546325">(</span><span class="ident" id="5546326">query</span><span class="op" id="5546331">,</span>&nbsp;<span class="ident" id="5546333">dargs</span><span class="op" id="5546338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546342">dc</span><span class="op" id="5546344">.</span><span class="ident" id="5546345">Unlock</span><span class="op" id="5546351">(</span><span class="op" id="5546352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5546356">if</span>&nbsp;<span class="ident" id="5546359">err</span>&nbsp;<span class="op" id="5546363">!=</span>&nbsp;<span class="ident" id="5546366">driver</span><span class="op" id="5546372">.</span><span class="ident" id="5546373">ErrSkip</span>&nbsp;<span class="op" id="5546381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5546386">if</span>&nbsp;<span class="ident" id="5546389">err</span>&nbsp;<span class="op" id="5546393">!=</span>&nbsp;<span class="ident" id="5546396">nil</span>&nbsp;<span class="op" id="5546400">{</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546406">releaseConn</span><span class="op" id="5546417">(</span><span class="ident" id="5546418">err</span><span class="op" id="5546421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5546427">return</span>&nbsp;<span class="ident" id="5546434">nil</span><span class="op" id="5546437">,</span>&nbsp;<span class="ident" id="5546439">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5546446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5546451">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;dc&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5546512">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546536">rows</span>&nbsp;<span class="op" id="5546541">:=</span>&nbsp;<span class="op" id="5546544">&amp;</span><span class="ident" id="5546545">Rows</span><span class="op" id="5546549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546555">dc</span><span class="op" id="5546557">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5546568">dc</span><span class="op" id="5546570">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546576">releaseConn</span><span class="op" id="5546587">:</span>&nbsp;<span class="ident" id="5546589">releaseConn</span><span class="op" id="5546600">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546606">rowsi</span><span class="op" id="5546611">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5546619">rowsi</span><span class="op" id="5546624">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5546629">}</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5546634">return</span>&nbsp;<span class="ident" id="5546641">rows</span><span class="op" id="5546645">,</span>&nbsp;<span class="ident" id="5546647">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5546653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5546656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546660">dc</span><span class="op" id="5546662">.</span><span class="ident" id="5546663">Lock</span><span class="op" id="5546667">(</span><span class="op" id="5546668">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546671">si</span><span class="op" id="5546673">,</span>&nbsp;<span class="ident" id="5546675">err</span>&nbsp;<span class="op" id="5546679">:=</span>&nbsp;<span class="ident" id="5546682">dc</span><span class="op" id="5546684">.</span><span class="ident" id="5546685">ci</span><span class="op" id="5546687">.</span><span class="ident" id="5546688">Prepare</span><span class="op" id="5546695">(</span><span class="ident" id="5546696">query</span><span class="op" id="5546701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546704">dc</span><span class="op" id="5546706">.</span><span class="ident" id="5546707">Unlock</span><span class="op" id="5546713">(</span><span class="op" id="5546714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5546717">if</span>&nbsp;<span class="ident" id="5546720">err</span>&nbsp;<span class="op" id="5546724">!=</span>&nbsp;<span class="ident" id="5546727">nil</span>&nbsp;<span class="op" id="5546731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546735">releaseConn</span><span class="op" id="5546746">(</span><span class="ident" id="5546747">err</span><span class="op" id="5546750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5546754">return</span>&nbsp;<span class="ident" id="5546761">nil</span><span class="op" id="5546764">,</span>&nbsp;<span class="ident" id="5546766">err</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5546771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546775">ds</span>&nbsp;<span class="op" id="5546778">:=</span>&nbsp;<span class="ident" id="5546781">driverStmt</span><span class="op" id="5546791">{</span><span class="ident" id="5546792">dc</span><span class="op" id="5546794">,</span>&nbsp;<span class="ident" id="5546796">si</span><span class="op" id="5546798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546801">rowsi</span><span class="op" id="5546806">,</span>&nbsp;<span class="ident" id="5546808">err</span>&nbsp;<span class="op" id="5546812">:=</span>&nbsp;<span class="ident" id="5546815">rowsiFromStatement</span><span class="op" id="5546833">(</span><span class="ident" id="5546834">ds</span><span class="op" id="5546836">,</span>&nbsp;<span class="ident" id="5546838">args</span><span class="op" id="5546842">...</span><span class="op" id="5546845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5546848">if</span>&nbsp;<span class="ident" id="5546851">err</span>&nbsp;<span class="op" id="5546855">!=</span>&nbsp;<span class="ident" id="5546858">nil</span>&nbsp;<span class="op" id="5546862">{</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546866">dc</span><span class="op" id="5546868">.</span><span class="ident" id="5546869">Lock</span><span class="op" id="5546873">(</span><span class="op" id="5546874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546878">si</span><span class="op" id="5546880">.</span><span class="ident" id="5546881">Close</span><span class="op" id="5546886">(</span><span class="op" id="5546887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546891">dc</span><span class="op" id="5546893">.</span><span class="ident" id="5546894">Unlock</span><span class="op" id="5546900">(</span><span class="op" id="5546901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5546905">releaseConn</span><span class="op" id="5546916">(</span><span class="ident" id="5546917">err</span><span class="op" id="5546920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5546924">return</span>&nbsp;<span class="ident" id="5546931">nil</span><span class="op" id="5546934">,</span>&nbsp;<span class="ident" id="5546936">err</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5546941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5546945">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5547004">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5547026">rows</span>&nbsp;<span class="op" id="5547031">:=</span>&nbsp;<span class="op" id="5547034">&amp;</span><span class="ident" id="5547035">Rows</span><span class="op" id="5547039">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5547043">dc</span><span class="op" id="5547045">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5547056">dc</span><span class="op" id="5547058">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5547062">releaseConn</span><span class="op" id="5547073">:</span>&nbsp;<span class="ident" id="5547075">releaseConn</span><span class="op" id="5547086">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5547090">rowsi</span><span class="op" id="5547095">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5547103">rowsi</span><span class="op" id="5547108">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5547112">closeStmt</span><span class="op" id="5547121">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5547125">si</span><span class="op" id="5547127">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5547130">}</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5547133">return</span>&nbsp;<span class="ident" id="5547140">rows</span><span class="op" id="5547144">,</span>&nbsp;<span class="ident" id="5547146">nil</span><br>
<span class="lineno"></span><span class="op" id="5547150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5547153">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="5547226">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno">1000</span><span class="comment" id="5547295">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="5547327">func</span>&nbsp;<span class="op" id="5547332">(</span><span class="ident" id="5547333">db</span>&nbsp;<span class="op" id="5547336">*</span><span class="ident" id="5547337">DB</span><span class="op" id="5547339">)</span>&nbsp;<span class="ident" id="5547341">QueryRow</span><span class="op" id="5547349">(</span><span class="ident" id="5547350">query</span>&nbsp;<span class="builtintype" id="5547356">string</span><span class="op" id="5547362">,</span>&nbsp;<span class="ident" id="5547364">args</span>&nbsp;<span class="op" id="5547369">...</span><span class="keyword" id="5547372">interface</span><span class="op" id="5547381">{</span><span class="op" id="5547382">}</span><span class="op" id="5547383">)</span>&nbsp;<span class="op" id="5547385">*</span><span class="ident" id="5547386">Row</span>&nbsp;<span class="op" id="5547390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5547393">rows</span><span class="op" id="5547397">,</span>&nbsp;<span class="ident" id="5547399">err</span>&nbsp;<span class="op" id="5547403">:=</span>&nbsp;<span class="ident" id="5547406">db</span><span class="op" id="5547408">.</span><span class="ident" id="5547409">Query</span><span class="op" id="5547414">(</span><span class="ident" id="5547415">query</span><span class="op" id="5547420">,</span>&nbsp;<span class="ident" id="5547422">args</span><span class="op" id="5547426">...</span><span class="op" id="5547429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5547432">return</span>&nbsp;<span class="op" id="5547439">&amp;</span><span class="ident" id="5547440">Row</span><span class="op" id="5547443">{</span><span class="ident" id="5547444">rows</span><span class="op" id="5547448">:</span>&nbsp;<span class="ident" id="5547450">rows</span><span class="op" id="5547454">,</span>&nbsp;<span class="ident" id="5547456">err</span><span class="op" id="5547459">:</span>&nbsp;<span class="ident" id="5547461">err</span><span class="op" id="5547464">}</span><br>
<span class="lineno"></span><span class="op" id="5547466">}</span><br>
<span class="lineno">1005</span><br>
<span class="lineno"></span><span class="comment" id="5547469">//&nbsp;Begin&nbsp;starts&nbsp;a&nbsp;transaction.&nbsp;The&nbsp;isolation&nbsp;level&nbsp;is&nbsp;dependent&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="5547536">//&nbsp;the&nbsp;driver.</span><br>
<span class="lineno"></span><span class="keyword" id="5547551">func</span>&nbsp;<span class="op" id="5547556">(</span><span class="ident" id="5547557">db</span>&nbsp;<span class="op" id="5547560">*</span><span class="ident" id="5547561">DB</span><span class="op" id="5547563">)</span>&nbsp;<span class="ident" id="5547565">Begin</span><span class="op" id="5547570">(</span><span class="op" id="5547571">)</span>&nbsp;<span class="op" id="5547573">(</span><span class="op" id="5547574">*</span><span class="ident" id="5547575">Tx</span><span class="op" id="5547577">,</span>&nbsp;<span class="builtintype" id="5547579">error</span><span class="op" id="5547584">)</span>&nbsp;<span class="op" id="5547586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5547589">var</span>&nbsp;<span class="ident" id="5547593">tx</span>&nbsp;<span class="op" id="5547596">*</span><span class="ident" id="5547597">Tx</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5547601">var</span>&nbsp;<span class="ident" id="5547605">err</span>&nbsp;<span class="builtintype" id="5547609">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5547616">for</span>&nbsp;<span class="ident" id="5547620">i</span>&nbsp;<span class="op" id="5547622">:=</span>&nbsp;<span class="num" id="5547625">0</span><span class="op" id="5547626">;</span>&nbsp;<span class="ident" id="5547628">i</span>&nbsp;<span class="op" id="5547630">&lt;</span>&nbsp;<span class="ident" id="5547632">maxBadConnRetries</span><span class="op" id="5547649">;</span>&nbsp;<span class="ident" id="5547651">i</span><span class="op" id="5547652">++</span>&nbsp;<span class="op" id="5547655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5547659">tx</span><span class="op" id="5547661">,</span>&nbsp;<span class="ident" id="5547663">err</span>&nbsp;<span class="op" id="5547667">=</span>&nbsp;<span class="ident" id="5547669">db</span><span class="op" id="5547671">.</span><span class="ident" id="5547672">begin</span><span class="op" id="5547677">(</span><span class="op" id="5547678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5547682">if</span>&nbsp;<span class="ident" id="5547685">err</span>&nbsp;<span class="op" id="5547689">!=</span>&nbsp;<span class="ident" id="5547692">driver</span><span class="op" id="5547698">.</span><span class="ident" id="5547699">ErrBadConn</span>&nbsp;<span class="op" id="5547710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5547715">break</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5547723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5547726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5547729">return</span>&nbsp;<span class="ident" id="5547736">tx</span><span class="op" id="5547738">,</span>&nbsp;<span class="ident" id="5547740">err</span><br>
<span class="lineno"></span><span class="op" id="5547744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1020</span><span class="keyword" id="5547747">func</span>&nbsp;<span class="op" id="5547752">(</span><span class="ident" id="5547753">db</span>&nbsp;<span class="op" id="5547756">*</span><span class="ident" id="5547757">DB</span><span class="op" id="5547759">)</span>&nbsp;<span class="ident" id="5547761">begin</span><span class="op" id="5547766">(</span><span class="op" id="5547767">)</span>&nbsp;<span class="op" id="5547769">(</span><span class="ident" id="5547770">tx</span>&nbsp;<span class="op" id="5547773">*</span><span class="ident" id="5547774">Tx</span><span class="op" id="5547776">,</span>&nbsp;<span class="ident" id="5547778">err</span>&nbsp;<span class="builtintype" id="5547782">error</span><span class="op" id="5547787">)</span>&nbsp;<span class="op" id="5547789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5547792">dc</span><span class="op" id="5547794">,</span>&nbsp;<span class="ident" id="5547796">err</span>&nbsp;<span class="op" id="5547800">:=</span>&nbsp;<span class="ident" id="5547803">db</span><span class="op" id="5547805">.</span><span class="ident" id="5547806">conn</span><span class="op" id="5547810">(</span><span class="op" id="5547811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5547814">if</span>&nbsp;<span class="ident" id="5547817">err</span>&nbsp;<span class="op" id="5547821">!=</span>&nbsp;<span class="ident" id="5547824">nil</span>&nbsp;<span class="op" id="5547828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5547832">return</span>&nbsp;<span class="ident" id="5547839">nil</span><span class="op" id="5547842">,</span>&nbsp;<span class="ident" id="5547844">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5547849">}</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5547852">dc</span><span class="op" id="5547854">.</span><span class="ident" id="5547855">Lock</span><span class="op" id="5547859">(</span><span class="op" id="5547860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5547863">txi</span><span class="op" id="5547866">,</span>&nbsp;<span class="ident" id="5547868">err</span>&nbsp;<span class="op" id="5547872">:=</span>&nbsp;<span class="ident" id="5547875">dc</span><span class="op" id="5547877">.</span><span class="ident" id="5547878">ci</span><span class="op" id="5547880">.</span><span class="ident" id="5547881">Begin</span><span class="op" id="5547886">(</span><span class="op" id="5547887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5547890">dc</span><span class="op" id="5547892">.</span><span class="ident" id="5547893">Unlock</span><span class="op" id="5547899">(</span><span class="op" id="5547900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5547903">if</span>&nbsp;<span class="ident" id="5547906">err</span>&nbsp;<span class="op" id="5547910">!=</span>&nbsp;<span class="ident" id="5547913">nil</span>&nbsp;<span class="op" id="5547917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5547921">db</span><span class="op" id="5547923">.</span><span class="ident" id="5547924">putConn</span><span class="op" id="5547931">(</span><span class="ident" id="5547932">dc</span><span class="op" id="5547934">,</span>&nbsp;<span class="ident" id="5547936">err</span><span class="op" id="5547939">)</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5547943">return</span>&nbsp;<span class="ident" id="5547950">nil</span><span class="op" id="5547953">,</span>&nbsp;<span class="ident" id="5547955">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5547960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5547963">return</span>&nbsp;<span class="op" id="5547970">&amp;</span><span class="ident" id="5547971">Tx</span><span class="op" id="5547973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5547977">db</span><span class="op" id="5547979">:</span>&nbsp;&nbsp;<span class="ident" id="5547982">db</span><span class="op" id="5547984">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5547988">dc</span><span class="op" id="5547990">:</span>&nbsp;&nbsp;<span class="ident" id="5547993">dc</span><span class="op" id="5547995">,</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5547999">txi</span><span class="op" id="5548002">:</span>&nbsp;<span class="ident" id="5548004">txi</span><span class="op" id="5548007">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5548010">}</span><span class="op" id="5548011">,</span>&nbsp;<span class="ident" id="5548013">nil</span><br>
<span class="lineno"></span><span class="op" id="5548017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5548020">//&nbsp;Driver&nbsp;returns&nbsp;the&nbsp;database&#39;s&nbsp;underlying&nbsp;driver.</span><br>
<span class="lineno">1040</span><span class="keyword" id="5548072">func</span>&nbsp;<span class="op" id="5548077">(</span><span class="ident" id="5548078">db</span>&nbsp;<span class="op" id="5548081">*</span><span class="ident" id="5548082">DB</span><span class="op" id="5548084">)</span>&nbsp;<span class="ident" id="5548086">Driver</span><span class="op" id="5548092">(</span><span class="op" id="5548093">)</span>&nbsp;<span class="ident" id="5548095">driver</span><span class="op" id="5548101">.</span><span class="ident" id="5548102">Driver</span>&nbsp;<span class="op" id="5548109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5548112">return</span>&nbsp;<span class="ident" id="5548119">db</span><span class="op" id="5548121">.</span><span class="ident" id="5548122">driver</span><br>
<span class="lineno"></span><span class="op" id="5548129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5548132">//&nbsp;Tx&nbsp;is&nbsp;an&nbsp;in-progress&nbsp;database&nbsp;transaction.</span><br>
<span class="lineno">1045</span><span class="comment" id="5548178">//</span><br>
<span class="lineno"></span><span class="comment" id="5548181">//&nbsp;A&nbsp;transaction&nbsp;must&nbsp;end&nbsp;with&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback.</span><br>
<span class="lineno"></span><span class="comment" id="5548242">//</span><br>
<span class="lineno"></span><span class="comment" id="5548245">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;all&nbsp;operations&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5548306">//&nbsp;transaction&nbsp;fail&nbsp;with&nbsp;ErrTxDone.</span><br>
<span class="lineno">1050</span><span class="keyword" id="5548342">type</span>&nbsp;<span class="ident" id="5548347">Tx</span>&nbsp;<span class="keyword" id="5548350">struct</span>&nbsp;<span class="op" id="5548357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5548360">db</span>&nbsp;<span class="op" id="5548363">*</span><span class="ident" id="5548364">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5548369">//&nbsp;dc&nbsp;is&nbsp;owned&nbsp;exclusively&nbsp;until&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;at&nbsp;which&nbsp;point</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5548438">//&nbsp;it&#39;s&nbsp;returned&nbsp;with&nbsp;putConn.</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5548470">dc</span>&nbsp;&nbsp;<span class="op" id="5548474">*</span><span class="ident" id="5548475">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5548487">txi</span>&nbsp;<span class="ident" id="5548491">driver</span><span class="op" id="5548497">.</span><span class="ident" id="5548498">Tx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5548503">//&nbsp;done&nbsp;transitions&nbsp;from&nbsp;false&nbsp;to&nbsp;true&nbsp;exactly&nbsp;once,&nbsp;on&nbsp;Commit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5548567">//&nbsp;or&nbsp;Rollback.&nbsp;once&nbsp;done,&nbsp;all&nbsp;operations&nbsp;fail&nbsp;with</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5548620">//&nbsp;ErrTxDone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5548635">done</span>&nbsp;<span class="builtintype" id="5548640">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5548647">//&nbsp;All&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.&nbsp;&nbsp;These&nbsp;will&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5548724">//&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5548775">stmts</span>&nbsp;<span class="keyword" id="5548781">struct</span>&nbsp;<span class="op" id="5548788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5548792">sync</span><span class="op" id="5548796">.</span><span class="ident" id="5548797">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5548805">v</span>&nbsp;<span class="op" id="5548807">[</span><span class="op" id="5548808">]</span><span class="op" id="5548809">*</span><span class="ident" id="5548810">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5548816">}</span><br>
<span class="lineno"></span><span class="op" id="5548818">}</span><br>
<span class="lineno">1070</span><br>
<span class="lineno"></span><span class="keyword" id="5548821">var</span>&nbsp;<span class="ident" id="5548825">ErrTxDone</span>&nbsp;<span class="op" id="5548835">=</span>&nbsp;<span class="ident" id="5548837">errors</span><span class="op" id="5548843">.</span><span class="ident" id="5548844">New</span><span class="op" id="5548847">(</span><span class="string" id="5548848">&#34;sql:&nbsp;Transaction&nbsp;has&nbsp;already&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back&#34;</span><span class="op" id="5548908">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5548911">func</span>&nbsp;<span class="op" id="5548916">(</span><span class="ident" id="5548917">tx</span>&nbsp;<span class="op" id="5548920">*</span><span class="ident" id="5548921">Tx</span><span class="op" id="5548923">)</span>&nbsp;<span class="builtinfunc" id="5548925">close</span><span class="op" id="5548930">(</span><span class="op" id="5548931">)</span>&nbsp;<span class="op" id="5548933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5548936">if</span>&nbsp;<span class="ident" id="5548939">tx</span><span class="op" id="5548941">.</span><span class="ident" id="5548942">done</span>&nbsp;<span class="op" id="5548947">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5548951">panic</span><span class="op" id="5548956">(</span><span class="string" id="5548957">&#34;double&nbsp;close&#34;</span><span class="op" id="5548971">)</span>&nbsp;<span class="comment" id="5548973">//&nbsp;internal&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5548992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5548995">tx</span><span class="op" id="5548997">.</span><span class="ident" id="5548998">done</span>&nbsp;<span class="op" id="5549003">=</span>&nbsp;<span class="builtintype" id="5549005">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549011">tx</span><span class="op" id="5549013">.</span><span class="ident" id="5549014">db</span><span class="op" id="5549016">.</span><span class="ident" id="5549017">putConn</span><span class="op" id="5549024">(</span><span class="ident" id="5549025">tx</span><span class="op" id="5549027">.</span><span class="ident" id="5549028">dc</span><span class="op" id="5549030">,</span>&nbsp;<span class="ident" id="5549032">nil</span><span class="op" id="5549035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549038">tx</span><span class="op" id="5549040">.</span><span class="ident" id="5549041">dc</span>&nbsp;<span class="op" id="5549044">=</span>&nbsp;<span class="ident" id="5549046">nil</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549051">tx</span><span class="op" id="5549053">.</span><span class="ident" id="5549054">txi</span>&nbsp;<span class="op" id="5549058">=</span>&nbsp;<span class="ident" id="5549060">nil</span><br>
<span class="lineno"></span><span class="op" id="5549064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5549067">func</span>&nbsp;<span class="op" id="5549072">(</span><span class="ident" id="5549073">tx</span>&nbsp;<span class="op" id="5549076">*</span><span class="ident" id="5549077">Tx</span><span class="op" id="5549079">)</span>&nbsp;<span class="ident" id="5549081">grabConn</span><span class="op" id="5549089">(</span><span class="op" id="5549090">)</span>&nbsp;<span class="op" id="5549092">(</span><span class="op" id="5549093">*</span><span class="ident" id="5549094">driverConn</span><span class="op" id="5549104">,</span>&nbsp;<span class="builtintype" id="5549106">error</span><span class="op" id="5549111">)</span>&nbsp;<span class="op" id="5549113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549116">if</span>&nbsp;<span class="ident" id="5549119">tx</span><span class="op" id="5549121">.</span><span class="ident" id="5549122">done</span>&nbsp;<span class="op" id="5549127">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549131">return</span>&nbsp;<span class="ident" id="5549138">nil</span><span class="op" id="5549141">,</span>&nbsp;<span class="ident" id="5549143">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5549154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549157">return</span>&nbsp;<span class="ident" id="5549164">tx</span><span class="op" id="5549166">.</span><span class="ident" id="5549167">dc</span><span class="op" id="5549169">,</span>&nbsp;<span class="ident" id="5549171">nil</span><br>
<span class="lineno"></span><span class="op" id="5549175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1090</span><span class="comment" id="5549178">//&nbsp;Closes&nbsp;all&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.</span><br>
<span class="lineno"></span><span class="keyword" id="5549229">func</span>&nbsp;<span class="op" id="5549234">(</span><span class="ident" id="5549235">tx</span>&nbsp;<span class="op" id="5549238">*</span><span class="ident" id="5549239">Tx</span><span class="op" id="5549241">)</span>&nbsp;<span class="ident" id="5549243">closePrepared</span><span class="op" id="5549256">(</span><span class="op" id="5549257">)</span>&nbsp;<span class="op" id="5549259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549262">tx</span><span class="op" id="5549264">.</span><span class="ident" id="5549265">stmts</span><span class="op" id="5549270">.</span><span class="ident" id="5549271">Lock</span><span class="op" id="5549275">(</span><span class="op" id="5549276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549279">for</span>&nbsp;<span class="ident" id="5549283">_</span><span class="op" id="5549284">,</span>&nbsp;<span class="ident" id="5549286">stmt</span>&nbsp;<span class="op" id="5549291">:=</span>&nbsp;<span class="keyword" id="5549294">range</span>&nbsp;<span class="ident" id="5549300">tx</span><span class="op" id="5549302">.</span><span class="ident" id="5549303">stmts</span><span class="op" id="5549308">.</span><span class="ident" id="5549309">v</span>&nbsp;<span class="op" id="5549311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549315">stmt</span><span class="op" id="5549319">.</span><span class="ident" id="5549320">Close</span><span class="op" id="5549325">(</span><span class="op" id="5549326">)</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5549329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549332">tx</span><span class="op" id="5549334">.</span><span class="ident" id="5549335">stmts</span><span class="op" id="5549340">.</span><span class="ident" id="5549341">Unlock</span><span class="op" id="5549347">(</span><span class="op" id="5549348">)</span><br>
<span class="lineno"></span><span class="op" id="5549350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5549353">//&nbsp;Commit&nbsp;commits&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1100</span><span class="keyword" id="5549388">func</span>&nbsp;<span class="op" id="5549393">(</span><span class="ident" id="5549394">tx</span>&nbsp;<span class="op" id="5549397">*</span><span class="ident" id="5549398">Tx</span><span class="op" id="5549400">)</span>&nbsp;<span class="ident" id="5549402">Commit</span><span class="op" id="5549408">(</span><span class="op" id="5549409">)</span>&nbsp;<span class="builtintype" id="5549411">error</span>&nbsp;<span class="op" id="5549417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549420">if</span>&nbsp;<span class="ident" id="5549423">tx</span><span class="op" id="5549425">.</span><span class="ident" id="5549426">done</span>&nbsp;<span class="op" id="5549431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549435">return</span>&nbsp;<span class="ident" id="5549442">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5549453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549456">defer</span>&nbsp;<span class="ident" id="5549462">tx</span><span class="op" id="5549464">.</span><span class="builtinfunc" id="5549465">close</span><span class="op" id="5549470">(</span><span class="op" id="5549471">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549474">tx</span><span class="op" id="5549476">.</span><span class="ident" id="5549477">dc</span><span class="op" id="5549479">.</span><span class="ident" id="5549480">Lock</span><span class="op" id="5549484">(</span><span class="op" id="5549485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549488">err</span>&nbsp;<span class="op" id="5549492">:=</span>&nbsp;<span class="ident" id="5549495">tx</span><span class="op" id="5549497">.</span><span class="ident" id="5549498">txi</span><span class="op" id="5549501">.</span><span class="ident" id="5549502">Commit</span><span class="op" id="5549508">(</span><span class="op" id="5549509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549512">tx</span><span class="op" id="5549514">.</span><span class="ident" id="5549515">dc</span><span class="op" id="5549517">.</span><span class="ident" id="5549518">Unlock</span><span class="op" id="5549524">(</span><span class="op" id="5549525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549528">if</span>&nbsp;<span class="ident" id="5549531">err</span>&nbsp;<span class="op" id="5549535">!=</span>&nbsp;<span class="ident" id="5549538">driver</span><span class="op" id="5549544">.</span><span class="ident" id="5549545">ErrBadConn</span>&nbsp;<span class="op" id="5549556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549560">tx</span><span class="op" id="5549562">.</span><span class="ident" id="5549563">closePrepared</span><span class="op" id="5549576">(</span><span class="op" id="5549577">)</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5549580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549583">return</span>&nbsp;<span class="ident" id="5549590">err</span><br>
<span class="lineno"></span><span class="op" id="5549594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5549597">//&nbsp;Rollback&nbsp;aborts&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1115</span><span class="keyword" id="5549633">func</span>&nbsp;<span class="op" id="5549638">(</span><span class="ident" id="5549639">tx</span>&nbsp;<span class="op" id="5549642">*</span><span class="ident" id="5549643">Tx</span><span class="op" id="5549645">)</span>&nbsp;<span class="ident" id="5549647">Rollback</span><span class="op" id="5549655">(</span><span class="op" id="5549656">)</span>&nbsp;<span class="builtintype" id="5549658">error</span>&nbsp;<span class="op" id="5549664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549667">if</span>&nbsp;<span class="ident" id="5549670">tx</span><span class="op" id="5549672">.</span><span class="ident" id="5549673">done</span>&nbsp;<span class="op" id="5549678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549682">return</span>&nbsp;<span class="ident" id="5549689">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5549700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549703">defer</span>&nbsp;<span class="ident" id="5549709">tx</span><span class="op" id="5549711">.</span><span class="builtinfunc" id="5549712">close</span><span class="op" id="5549717">(</span><span class="op" id="5549718">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549721">tx</span><span class="op" id="5549723">.</span><span class="ident" id="5549724">dc</span><span class="op" id="5549726">.</span><span class="ident" id="5549727">Lock</span><span class="op" id="5549731">(</span><span class="op" id="5549732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549735">err</span>&nbsp;<span class="op" id="5549739">:=</span>&nbsp;<span class="ident" id="5549742">tx</span><span class="op" id="5549744">.</span><span class="ident" id="5549745">txi</span><span class="op" id="5549748">.</span><span class="ident" id="5549749">Rollback</span><span class="op" id="5549757">(</span><span class="op" id="5549758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549761">tx</span><span class="op" id="5549763">.</span><span class="ident" id="5549764">dc</span><span class="op" id="5549766">.</span><span class="ident" id="5549767">Unlock</span><span class="op" id="5549773">(</span><span class="op" id="5549774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549777">if</span>&nbsp;<span class="ident" id="5549780">err</span>&nbsp;<span class="op" id="5549784">!=</span>&nbsp;<span class="ident" id="5549787">driver</span><span class="op" id="5549793">.</span><span class="ident" id="5549794">ErrBadConn</span>&nbsp;<span class="op" id="5549805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549809">tx</span><span class="op" id="5549811">.</span><span class="ident" id="5549812">closePrepared</span><span class="op" id="5549825">(</span><span class="op" id="5549826">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5549829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549832">return</span>&nbsp;<span class="ident" id="5549839">err</span><br>
<span class="lineno"></span><span class="op" id="5549843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5549846">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;use&nbsp;within&nbsp;a&nbsp;transaction.</span><br>
<span class="lineno">1130</span><span class="comment" id="5549916">//</span><br>
<span class="lineno"></span><span class="comment" id="5549919">//&nbsp;The&nbsp;returned&nbsp;statement&nbsp;operates&nbsp;within&nbsp;the&nbsp;transaction&nbsp;and&nbsp;can&nbsp;no&nbsp;longer</span><br>
<span class="lineno"></span><span class="comment" id="5549995">//&nbsp;be&nbsp;used&nbsp;once&nbsp;the&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno"></span><span class="comment" id="5550062">//</span><br>
<span class="lineno"></span><span class="comment" id="5550065">//&nbsp;To&nbsp;use&nbsp;an&nbsp;existing&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;this&nbsp;transaction,&nbsp;see&nbsp;Tx.Stmt.</span><br>
<span class="lineno">1135</span><span class="keyword" id="5550140">func</span>&nbsp;<span class="op" id="5550145">(</span><span class="ident" id="5550146">tx</span>&nbsp;<span class="op" id="5550149">*</span><span class="ident" id="5550150">Tx</span><span class="op" id="5550152">)</span>&nbsp;<span class="ident" id="5550154">Prepare</span><span class="op" id="5550161">(</span><span class="ident" id="5550162">query</span>&nbsp;<span class="builtintype" id="5550168">string</span><span class="op" id="5550174">)</span>&nbsp;<span class="op" id="5550176">(</span><span class="op" id="5550177">*</span><span class="ident" id="5550178">Stmt</span><span class="op" id="5550182">,</span>&nbsp;<span class="builtintype" id="5550184">error</span><span class="op" id="5550189">)</span>&nbsp;<span class="op" id="5550191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5550194">//&nbsp;TODO(bradfitz):&nbsp;We&nbsp;could&nbsp;be&nbsp;more&nbsp;efficient&nbsp;here&nbsp;and&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5550257">//&nbsp;provide&nbsp;a&nbsp;method&nbsp;to&nbsp;take&nbsp;an&nbsp;existing&nbsp;Stmt&nbsp;(created&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5550315">//&nbsp;perhaps&nbsp;a&nbsp;different&nbsp;Conn),&nbsp;and&nbsp;re-create&nbsp;it&nbsp;on&nbsp;this&nbsp;Conn&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5550379">//&nbsp;necessary.&nbsp;Or,&nbsp;better:&nbsp;keep&nbsp;a&nbsp;map&nbsp;in&nbsp;DB&nbsp;of&nbsp;query&nbsp;string&nbsp;to</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5550442">//&nbsp;Stmts,&nbsp;and&nbsp;have&nbsp;Stmt.Execute&nbsp;do&nbsp;the&nbsp;right&nbsp;thing&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5550498">//&nbsp;re-prepare&nbsp;if&nbsp;the&nbsp;Conn&nbsp;in&nbsp;use&nbsp;doesn&#39;t&nbsp;have&nbsp;that&nbsp;prepared</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5550559">//&nbsp;statement.&nbsp;&nbsp;But&nbsp;we&#39;ll&nbsp;want&nbsp;to&nbsp;avoid&nbsp;caching&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5550621">//&nbsp;in&nbsp;the&nbsp;case&nbsp;where&nbsp;we&nbsp;only&nbsp;call&nbsp;conn.Prepare&nbsp;implicitly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5550680">//&nbsp;(such&nbsp;as&nbsp;in&nbsp;db.Exec&nbsp;or&nbsp;tx.Exec),&nbsp;but&nbsp;the&nbsp;caller&nbsp;package</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5550740">//&nbsp;can&#39;t&nbsp;be&nbsp;holding&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5550800">//&nbsp;Perhaps&nbsp;just&nbsp;looking&nbsp;at&nbsp;the&nbsp;reference&nbsp;count&nbsp;(by&nbsp;noting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5550859">//&nbsp;Stmt.Close)&nbsp;would&nbsp;be&nbsp;enough.&nbsp;We&nbsp;might&nbsp;also&nbsp;want&nbsp;a&nbsp;finalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5550923">//&nbsp;on&nbsp;Stmt&nbsp;to&nbsp;drop&nbsp;the&nbsp;reference&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5550964">dc</span><span class="op" id="5550966">,</span>&nbsp;<span class="ident" id="5550968">err</span>&nbsp;<span class="op" id="5550972">:=</span>&nbsp;<span class="ident" id="5550975">tx</span><span class="op" id="5550977">.</span><span class="ident" id="5550978">grabConn</span><span class="op" id="5550986">(</span><span class="op" id="5550987">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5550990">if</span>&nbsp;<span class="ident" id="5550993">err</span>&nbsp;<span class="op" id="5550997">!=</span>&nbsp;<span class="ident" id="5551000">nil</span>&nbsp;<span class="op" id="5551004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5551008">return</span>&nbsp;<span class="ident" id="5551015">nil</span><span class="op" id="5551018">,</span>&nbsp;<span class="ident" id="5551020">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5551025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551029">dc</span><span class="op" id="5551031">.</span><span class="ident" id="5551032">Lock</span><span class="op" id="5551036">(</span><span class="op" id="5551037">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551040">si</span><span class="op" id="5551042">,</span>&nbsp;<span class="ident" id="5551044">err</span>&nbsp;<span class="op" id="5551048">:=</span>&nbsp;<span class="ident" id="5551051">dc</span><span class="op" id="5551053">.</span><span class="ident" id="5551054">ci</span><span class="op" id="5551056">.</span><span class="ident" id="5551057">Prepare</span><span class="op" id="5551064">(</span><span class="ident" id="5551065">query</span><span class="op" id="5551070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551073">dc</span><span class="op" id="5551075">.</span><span class="ident" id="5551076">Unlock</span><span class="op" id="5551082">(</span><span class="op" id="5551083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5551086">if</span>&nbsp;<span class="ident" id="5551089">err</span>&nbsp;<span class="op" id="5551093">!=</span>&nbsp;<span class="ident" id="5551096">nil</span>&nbsp;<span class="op" id="5551100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5551104">return</span>&nbsp;<span class="ident" id="5551111">nil</span><span class="op" id="5551114">,</span>&nbsp;<span class="ident" id="5551116">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5551121">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551125">stmt</span>&nbsp;<span class="op" id="5551130">:=</span>&nbsp;<span class="op" id="5551133">&amp;</span><span class="ident" id="5551134">Stmt</span><span class="op" id="5551138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551142">db</span><span class="op" id="5551144">:</span>&nbsp;<span class="ident" id="5551146">tx</span><span class="op" id="5551148">.</span><span class="ident" id="5551149">db</span><span class="op" id="5551151">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551155">tx</span><span class="op" id="5551157">:</span>&nbsp;<span class="ident" id="5551159">tx</span><span class="op" id="5551161">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551165">txsi</span><span class="op" id="5551169">:</span>&nbsp;<span class="op" id="5551171">&amp;</span><span class="ident" id="5551172">driverStmt</span><span class="op" id="5551182">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551187">Locker</span><span class="op" id="5551193">:</span>&nbsp;<span class="ident" id="5551195">dc</span><span class="op" id="5551197">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551202">si</span><span class="op" id="5551204">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5551210">si</span><span class="op" id="5551212">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5551216">}</span><span class="op" id="5551217">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551221">query</span><span class="op" id="5551226">:</span>&nbsp;<span class="ident" id="5551228">query</span><span class="op" id="5551233">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5551236">}</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551239">tx</span><span class="op" id="5551241">.</span><span class="ident" id="5551242">stmts</span><span class="op" id="5551247">.</span><span class="ident" id="5551248">Lock</span><span class="op" id="5551252">(</span><span class="op" id="5551253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551256">tx</span><span class="op" id="5551258">.</span><span class="ident" id="5551259">stmts</span><span class="op" id="5551264">.</span><span class="ident" id="5551265">v</span>&nbsp;<span class="op" id="5551267">=</span>&nbsp;<span class="builtinfunc" id="5551269">append</span><span class="op" id="5551275">(</span><span class="ident" id="5551276">tx</span><span class="op" id="5551278">.</span><span class="ident" id="5551279">stmts</span><span class="op" id="5551284">.</span><span class="ident" id="5551285">v</span><span class="op" id="5551286">,</span>&nbsp;<span class="ident" id="5551288">stmt</span><span class="op" id="5551292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551295">tx</span><span class="op" id="5551297">.</span><span class="ident" id="5551298">stmts</span><span class="op" id="5551303">.</span><span class="ident" id="5551304">Unlock</span><span class="op" id="5551310">(</span><span class="op" id="5551311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5551314">return</span>&nbsp;<span class="ident" id="5551321">stmt</span><span class="op" id="5551325">,</span>&nbsp;<span class="ident" id="5551327">nil</span><br>
<span class="lineno"></span><span class="op" id="5551331">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span><span class="comment" id="5551334">//&nbsp;Stmt&nbsp;returns&nbsp;a&nbsp;transaction-specific&nbsp;prepared&nbsp;statement&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="5551397">//&nbsp;an&nbsp;existing&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5551423">//</span><br>
<span class="lineno"></span><span class="comment" id="5551426">//&nbsp;Example:</span><br>
<span class="lineno">1180</span><span class="comment" id="5551438">//&nbsp;&nbsp;updateMoney,&nbsp;err&nbsp;:=&nbsp;db.Prepare(&#34;UPDATE&nbsp;balance&nbsp;SET&nbsp;money=money+?&nbsp;WHERE&nbsp;id=?&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="5551520">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5551528">//&nbsp;&nbsp;tx,&nbsp;err&nbsp;:=&nbsp;db.Begin()</span><br>
<span class="lineno"></span><span class="comment" id="5551554">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5551562">//&nbsp;&nbsp;res,&nbsp;err&nbsp;:=&nbsp;tx.Stmt(updateMoney).Exec(123.45,&nbsp;98293203)</span><br>
<span class="lineno">1185</span><span class="keyword" id="5551622">func</span>&nbsp;<span class="op" id="5551627">(</span><span class="ident" id="5551628">tx</span>&nbsp;<span class="op" id="5551631">*</span><span class="ident" id="5551632">Tx</span><span class="op" id="5551634">)</span>&nbsp;<span class="ident" id="5551636">Stmt</span><span class="op" id="5551640">(</span><span class="ident" id="5551641">stmt</span>&nbsp;<span class="op" id="5551646">*</span><span class="ident" id="5551647">Stmt</span><span class="op" id="5551651">)</span>&nbsp;<span class="op" id="5551653">*</span><span class="ident" id="5551654">Stmt</span>&nbsp;<span class="op" id="5551659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5551662">//&nbsp;TODO(bradfitz):&nbsp;optimize&nbsp;this.&nbsp;Currently&nbsp;this&nbsp;re-prepares</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5551724">//&nbsp;each&nbsp;time.&nbsp;&nbsp;This&nbsp;is&nbsp;fine&nbsp;for&nbsp;now&nbsp;to&nbsp;illustrate&nbsp;the&nbsp;API&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5551787">//&nbsp;we&nbsp;should&nbsp;really&nbsp;cache&nbsp;already-prepared&nbsp;statements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5551842">//&nbsp;per-Conn.&nbsp;See&nbsp;also&nbsp;the&nbsp;big&nbsp;comment&nbsp;in&nbsp;Tx.Prepare.</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5551897">if</span>&nbsp;<span class="ident" id="5551900">tx</span><span class="op" id="5551902">.</span><span class="ident" id="5551903">db</span>&nbsp;<span class="op" id="5551906">!=</span>&nbsp;<span class="ident" id="5551909">stmt</span><span class="op" id="5551913">.</span><span class="ident" id="5551914">db</span>&nbsp;<span class="op" id="5551917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5551921">return</span>&nbsp;<span class="op" id="5551928">&amp;</span><span class="ident" id="5551929">Stmt</span><span class="op" id="5551933">{</span><span class="ident" id="5551934">stickyErr</span><span class="op" id="5551943">:</span>&nbsp;<span class="ident" id="5551945">errors</span><span class="op" id="5551951">.</span><span class="ident" id="5551952">New</span><span class="op" id="5551955">(</span><span class="string" id="5551956">&#34;sql:&nbsp;Tx.Stmt:&nbsp;statement&nbsp;from&nbsp;different&nbsp;database&nbsp;used&#34;</span><span class="op" id="5552010">)</span><span class="op" id="5552011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5552014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552017">dc</span><span class="op" id="5552019">,</span>&nbsp;<span class="ident" id="5552021">err</span>&nbsp;<span class="op" id="5552025">:=</span>&nbsp;<span class="ident" id="5552028">tx</span><span class="op" id="5552030">.</span><span class="ident" id="5552031">grabConn</span><span class="op" id="5552039">(</span><span class="op" id="5552040">)</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552043">if</span>&nbsp;<span class="ident" id="5552046">err</span>&nbsp;<span class="op" id="5552050">!=</span>&nbsp;<span class="ident" id="5552053">nil</span>&nbsp;<span class="op" id="5552057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552061">return</span>&nbsp;<span class="op" id="5552068">&amp;</span><span class="ident" id="5552069">Stmt</span><span class="op" id="5552073">{</span><span class="ident" id="5552074">stickyErr</span><span class="op" id="5552083">:</span>&nbsp;<span class="ident" id="5552085">err</span><span class="op" id="5552088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5552091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552094">dc</span><span class="op" id="5552096">.</span><span class="ident" id="5552097">Lock</span><span class="op" id="5552101">(</span><span class="op" id="5552102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552105">si</span><span class="op" id="5552107">,</span>&nbsp;<span class="ident" id="5552109">err</span>&nbsp;<span class="op" id="5552113">:=</span>&nbsp;<span class="ident" id="5552116">dc</span><span class="op" id="5552118">.</span><span class="ident" id="5552119">ci</span><span class="op" id="5552121">.</span><span class="ident" id="5552122">Prepare</span><span class="op" id="5552129">(</span><span class="ident" id="5552130">stmt</span><span class="op" id="5552134">.</span><span class="ident" id="5552135">query</span><span class="op" id="5552140">)</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552143">dc</span><span class="op" id="5552145">.</span><span class="ident" id="5552146">Unlock</span><span class="op" id="5552152">(</span><span class="op" id="5552153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552156">txs</span>&nbsp;<span class="op" id="5552160">:=</span>&nbsp;<span class="op" id="5552163">&amp;</span><span class="ident" id="5552164">Stmt</span><span class="op" id="5552168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552172">db</span><span class="op" id="5552174">:</span>&nbsp;<span class="ident" id="5552176">tx</span><span class="op" id="5552178">.</span><span class="ident" id="5552179">db</span><span class="op" id="5552181">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552185">tx</span><span class="op" id="5552187">:</span>&nbsp;<span class="ident" id="5552189">tx</span><span class="op" id="5552191">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552195">txsi</span><span class="op" id="5552199">:</span>&nbsp;<span class="op" id="5552201">&amp;</span><span class="ident" id="5552202">driverStmt</span><span class="op" id="5552212">{</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552217">Locker</span><span class="op" id="5552223">:</span>&nbsp;<span class="ident" id="5552225">dc</span><span class="op" id="5552227">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552232">si</span><span class="op" id="5552234">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5552240">si</span><span class="op" id="5552242">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5552246">}</span><span class="op" id="5552247">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552251">query</span><span class="op" id="5552256">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5552262">stmt</span><span class="op" id="5552266">.</span><span class="ident" id="5552267">query</span><span class="op" id="5552272">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552276">stickyErr</span><span class="op" id="5552285">:</span>&nbsp;<span class="ident" id="5552287">err</span><span class="op" id="5552290">,</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5552293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552296">tx</span><span class="op" id="5552298">.</span><span class="ident" id="5552299">stmts</span><span class="op" id="5552304">.</span><span class="ident" id="5552305">Lock</span><span class="op" id="5552309">(</span><span class="op" id="5552310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552313">tx</span><span class="op" id="5552315">.</span><span class="ident" id="5552316">stmts</span><span class="op" id="5552321">.</span><span class="ident" id="5552322">v</span>&nbsp;<span class="op" id="5552324">=</span>&nbsp;<span class="builtinfunc" id="5552326">append</span><span class="op" id="5552332">(</span><span class="ident" id="5552333">tx</span><span class="op" id="5552335">.</span><span class="ident" id="5552336">stmts</span><span class="op" id="5552341">.</span><span class="ident" id="5552342">v</span><span class="op" id="5552343">,</span>&nbsp;<span class="ident" id="5552345">txs</span><span class="op" id="5552348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552351">tx</span><span class="op" id="5552353">.</span><span class="ident" id="5552354">stmts</span><span class="op" id="5552359">.</span><span class="ident" id="5552360">Unlock</span><span class="op" id="5552366">(</span><span class="op" id="5552367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552370">return</span>&nbsp;<span class="ident" id="5552377">txs</span><br>
<span class="lineno">1215</span><span class="op" id="5552381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5552384">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;doesn&#39;t&nbsp;return&nbsp;rows.</span><br>
<span class="lineno"></span><span class="comment" id="5552435">//&nbsp;For&nbsp;example:&nbsp;an&nbsp;INSERT&nbsp;and&nbsp;UPDATE.</span><br>
<span class="lineno"></span><span class="keyword" id="5552473">func</span>&nbsp;<span class="op" id="5552478">(</span><span class="ident" id="5552479">tx</span>&nbsp;<span class="op" id="5552482">*</span><span class="ident" id="5552483">Tx</span><span class="op" id="5552485">)</span>&nbsp;<span class="ident" id="5552487">Exec</span><span class="op" id="5552491">(</span><span class="ident" id="5552492">query</span>&nbsp;<span class="builtintype" id="5552498">string</span><span class="op" id="5552504">,</span>&nbsp;<span class="ident" id="5552506">args</span>&nbsp;<span class="op" id="5552511">...</span><span class="keyword" id="5552514">interface</span><span class="op" id="5552523">{</span><span class="op" id="5552524">}</span><span class="op" id="5552525">)</span>&nbsp;<span class="op" id="5552527">(</span><span class="ident" id="5552528">Result</span><span class="op" id="5552534">,</span>&nbsp;<span class="builtintype" id="5552536">error</span><span class="op" id="5552541">)</span>&nbsp;<span class="op" id="5552543">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552546">dc</span><span class="op" id="5552548">,</span>&nbsp;<span class="ident" id="5552550">err</span>&nbsp;<span class="op" id="5552554">:=</span>&nbsp;<span class="ident" id="5552557">tx</span><span class="op" id="5552559">.</span><span class="ident" id="5552560">grabConn</span><span class="op" id="5552568">(</span><span class="op" id="5552569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552572">if</span>&nbsp;<span class="ident" id="5552575">err</span>&nbsp;<span class="op" id="5552579">!=</span>&nbsp;<span class="ident" id="5552582">nil</span>&nbsp;<span class="op" id="5552586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552590">return</span>&nbsp;<span class="ident" id="5552597">nil</span><span class="op" id="5552600">,</span>&nbsp;<span class="ident" id="5552602">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5552607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552611">if</span>&nbsp;<span class="ident" id="5552614">execer</span><span class="op" id="5552620">,</span>&nbsp;<span class="ident" id="5552622">ok</span>&nbsp;<span class="op" id="5552625">:=</span>&nbsp;<span class="ident" id="5552628">dc</span><span class="op" id="5552630">.</span><span class="ident" id="5552631">ci</span><span class="op" id="5552633">.</span><span class="op" id="5552634">(</span><span class="ident" id="5552635">driver</span><span class="op" id="5552641">.</span><span class="ident" id="5552642">Execer</span><span class="op" id="5552648">)</span><span class="op" id="5552649">;</span>&nbsp;<span class="ident" id="5552651">ok</span>&nbsp;<span class="op" id="5552654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552658">dargs</span><span class="op" id="5552663">,</span>&nbsp;<span class="ident" id="5552665">err</span>&nbsp;<span class="op" id="5552669">:=</span>&nbsp;<span class="ident" id="5552672">driverArgs</span><span class="op" id="5552682">(</span><span class="ident" id="5552683">nil</span><span class="op" id="5552686">,</span>&nbsp;<span class="ident" id="5552688">args</span><span class="op" id="5552692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552696">if</span>&nbsp;<span class="ident" id="5552699">err</span>&nbsp;<span class="op" id="5552703">!=</span>&nbsp;<span class="ident" id="5552706">nil</span>&nbsp;<span class="op" id="5552710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552715">return</span>&nbsp;<span class="ident" id="5552722">nil</span><span class="op" id="5552725">,</span>&nbsp;<span class="ident" id="5552727">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5552733">}</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552737">dc</span><span class="op" id="5552739">.</span><span class="ident" id="5552740">Lock</span><span class="op" id="5552744">(</span><span class="op" id="5552745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552749">resi</span><span class="op" id="5552753">,</span>&nbsp;<span class="ident" id="5552755">err</span>&nbsp;<span class="op" id="5552759">:=</span>&nbsp;<span class="ident" id="5552762">execer</span><span class="op" id="5552768">.</span><span class="ident" id="5552769">Exec</span><span class="op" id="5552773">(</span><span class="ident" id="5552774">query</span><span class="op" id="5552779">,</span>&nbsp;<span class="ident" id="5552781">dargs</span><span class="op" id="5552786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552790">dc</span><span class="op" id="5552792">.</span><span class="ident" id="5552793">Unlock</span><span class="op" id="5552799">(</span><span class="op" id="5552800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552804">if</span>&nbsp;<span class="ident" id="5552807">err</span>&nbsp;<span class="op" id="5552811">==</span>&nbsp;<span class="ident" id="5552814">nil</span>&nbsp;<span class="op" id="5552818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552823">return</span>&nbsp;<span class="ident" id="5552830">driverResult</span><span class="op" id="5552842">{</span><span class="ident" id="5552843">dc</span><span class="op" id="5552845">,</span>&nbsp;<span class="ident" id="5552847">resi</span><span class="op" id="5552851">}</span><span class="op" id="5552852">,</span>&nbsp;<span class="ident" id="5552854">nil</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5552860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552864">if</span>&nbsp;<span class="ident" id="5552867">err</span>&nbsp;<span class="op" id="5552871">!=</span>&nbsp;<span class="ident" id="5552874">driver</span><span class="op" id="5552880">.</span><span class="ident" id="5552881">ErrSkip</span>&nbsp;<span class="op" id="5552889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552894">return</span>&nbsp;<span class="ident" id="5552901">nil</span><span class="op" id="5552904">,</span>&nbsp;<span class="ident" id="5552906">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5552912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5552915">}</span><br>
<span class="lineno">1240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552919">dc</span><span class="op" id="5552921">.</span><span class="ident" id="5552922">Lock</span><span class="op" id="5552926">(</span><span class="op" id="5552927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552930">si</span><span class="op" id="5552932">,</span>&nbsp;<span class="ident" id="5552934">err</span>&nbsp;<span class="op" id="5552938">:=</span>&nbsp;<span class="ident" id="5552941">dc</span><span class="op" id="5552943">.</span><span class="ident" id="5552944">ci</span><span class="op" id="5552946">.</span><span class="ident" id="5552947">Prepare</span><span class="op" id="5552954">(</span><span class="ident" id="5552955">query</span><span class="op" id="5552960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552963">dc</span><span class="op" id="5552965">.</span><span class="ident" id="5552966">Unlock</span><span class="op" id="5552972">(</span><span class="op" id="5552973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552976">if</span>&nbsp;<span class="ident" id="5552979">err</span>&nbsp;<span class="op" id="5552983">!=</span>&nbsp;<span class="ident" id="5552986">nil</span>&nbsp;<span class="op" id="5552990">{</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552994">return</span>&nbsp;<span class="ident" id="5553001">nil</span><span class="op" id="5553004">,</span>&nbsp;<span class="ident" id="5553006">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5553011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5553014">defer</span>&nbsp;<span class="ident" id="5553020">withLock</span><span class="op" id="5553028">(</span><span class="ident" id="5553029">dc</span><span class="op" id="5553031">,</span>&nbsp;<span class="keyword" id="5553033">func</span><span class="op" id="5553037">(</span><span class="op" id="5553038">)</span>&nbsp;<span class="op" id="5553040">{</span>&nbsp;<span class="ident" id="5553042">si</span><span class="op" id="5553044">.</span><span class="ident" id="5553045">Close</span><span class="op" id="5553050">(</span><span class="op" id="5553051">)</span>&nbsp;<span class="op" id="5553053">}</span><span class="op" id="5553054">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5553058">return</span>&nbsp;<span class="ident" id="5553065">resultFromStatement</span><span class="op" id="5553084">(</span><span class="ident" id="5553085">driverStmt</span><span class="op" id="5553095">{</span><span class="ident" id="5553096">dc</span><span class="op" id="5553098">,</span>&nbsp;<span class="ident" id="5553100">si</span><span class="op" id="5553102">}</span><span class="op" id="5553103">,</span>&nbsp;<span class="ident" id="5553105">args</span><span class="op" id="5553109">...</span><span class="op" id="5553112">)</span><br>
<span class="lineno">1250</span><span class="op" id="5553114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5553117">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="keyword" id="5553182">func</span>&nbsp;<span class="op" id="5553187">(</span><span class="ident" id="5553188">tx</span>&nbsp;<span class="op" id="5553191">*</span><span class="ident" id="5553192">Tx</span><span class="op" id="5553194">)</span>&nbsp;<span class="ident" id="5553196">Query</span><span class="op" id="5553201">(</span><span class="ident" id="5553202">query</span>&nbsp;<span class="builtintype" id="5553208">string</span><span class="op" id="5553214">,</span>&nbsp;<span class="ident" id="5553216">args</span>&nbsp;<span class="op" id="5553221">...</span><span class="keyword" id="5553224">interface</span><span class="op" id="5553233">{</span><span class="op" id="5553234">}</span><span class="op" id="5553235">)</span>&nbsp;<span class="op" id="5553237">(</span><span class="op" id="5553238">*</span><span class="ident" id="5553239">Rows</span><span class="op" id="5553243">,</span>&nbsp;<span class="builtintype" id="5553245">error</span><span class="op" id="5553250">)</span>&nbsp;<span class="op" id="5553252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5553255">dc</span><span class="op" id="5553257">,</span>&nbsp;<span class="ident" id="5553259">err</span>&nbsp;<span class="op" id="5553263">:=</span>&nbsp;<span class="ident" id="5553266">tx</span><span class="op" id="5553268">.</span><span class="ident" id="5553269">grabConn</span><span class="op" id="5553277">(</span><span class="op" id="5553278">)</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5553281">if</span>&nbsp;<span class="ident" id="5553284">err</span>&nbsp;<span class="op" id="5553288">!=</span>&nbsp;<span class="ident" id="5553291">nil</span>&nbsp;<span class="op" id="5553295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5553299">return</span>&nbsp;<span class="ident" id="5553306">nil</span><span class="op" id="5553309">,</span>&nbsp;<span class="ident" id="5553311">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5553316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5553319">releaseConn</span>&nbsp;<span class="op" id="5553331">:=</span>&nbsp;<span class="keyword" id="5553334">func</span><span class="op" id="5553338">(</span><span class="builtintype" id="5553339">error</span><span class="op" id="5553344">)</span>&nbsp;<span class="op" id="5553346">{</span><span class="op" id="5553347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5553350">return</span>&nbsp;<span class="ident" id="5553357">tx</span><span class="op" id="5553359">.</span><span class="ident" id="5553360">db</span><span class="op" id="5553362">.</span><span class="ident" id="5553363">queryConn</span><span class="op" id="5553372">(</span><span class="ident" id="5553373">dc</span><span class="op" id="5553375">,</span>&nbsp;<span class="ident" id="5553377">releaseConn</span><span class="op" id="5553388">,</span>&nbsp;<span class="ident" id="5553390">query</span><span class="op" id="5553395">,</span>&nbsp;<span class="ident" id="5553397">args</span><span class="op" id="5553401">)</span><br>
<span class="lineno">1260</span><span class="op" id="5553403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5553406">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="5553479">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="5553548">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno">1265</span><span class="keyword" id="5553580">func</span>&nbsp;<span class="op" id="5553585">(</span><span class="ident" id="5553586">tx</span>&nbsp;<span class="op" id="5553589">*</span><span class="ident" id="5553590">Tx</span><span class="op" id="5553592">)</span>&nbsp;<span class="ident" id="5553594">QueryRow</span><span class="op" id="5553602">(</span><span class="ident" id="5553603">query</span>&nbsp;<span class="builtintype" id="5553609">string</span><span class="op" id="5553615">,</span>&nbsp;<span class="ident" id="5553617">args</span>&nbsp;<span class="op" id="5553622">...</span><span class="keyword" id="5553625">interface</span><span class="op" id="5553634">{</span><span class="op" id="5553635">}</span><span class="op" id="5553636">)</span>&nbsp;<span class="op" id="5553638">*</span><span class="ident" id="5553639">Row</span>&nbsp;<span class="op" id="5553643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5553646">rows</span><span class="op" id="5553650">,</span>&nbsp;<span class="ident" id="5553652">err</span>&nbsp;<span class="op" id="5553656">:=</span>&nbsp;<span class="ident" id="5553659">tx</span><span class="op" id="5553661">.</span><span class="ident" id="5553662">Query</span><span class="op" id="5553667">(</span><span class="ident" id="5553668">query</span><span class="op" id="5553673">,</span>&nbsp;<span class="ident" id="5553675">args</span><span class="op" id="5553679">...</span><span class="op" id="5553682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5553685">return</span>&nbsp;<span class="op" id="5553692">&amp;</span><span class="ident" id="5553693">Row</span><span class="op" id="5553696">{</span><span class="ident" id="5553697">rows</span><span class="op" id="5553701">:</span>&nbsp;<span class="ident" id="5553703">rows</span><span class="op" id="5553707">,</span>&nbsp;<span class="ident" id="5553709">err</span><span class="op" id="5553712">:</span>&nbsp;<span class="ident" id="5553714">err</span><span class="op" id="5553717">}</span><br>
<span class="lineno"></span><span class="op" id="5553719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="5553722">//&nbsp;connStmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;a&nbsp;particular&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5553786">type</span>&nbsp;<span class="ident" id="5553791">connStmt</span>&nbsp;<span class="keyword" id="5553800">struct</span>&nbsp;<span class="op" id="5553807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5553810">dc</span>&nbsp;<span class="op" id="5553813">*</span><span class="ident" id="5553814">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5553826">si</span>&nbsp;<span class="ident" id="5553829">driver</span><span class="op" id="5553835">.</span><span class="ident" id="5553836">Stmt</span><br>
<span class="lineno"></span><span class="op" id="5553841">}</span><br>
<span class="lineno">1275</span><br>
<span class="lineno"></span><span class="comment" id="5553844">//&nbsp;Stmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement.&nbsp;Stmt&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="5553933">type</span>&nbsp;<span class="ident" id="5553938">Stmt</span>&nbsp;<span class="keyword" id="5553943">struct</span>&nbsp;<span class="op" id="5553950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5553953">//&nbsp;Immutable:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5553968">db</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5553978">*</span><span class="ident" id="5553979">DB</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5553985">//&nbsp;where&nbsp;we&nbsp;came&nbsp;from</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554008">query</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5554018">string</span>&nbsp;<span class="comment" id="5554025">//&nbsp;that&nbsp;created&nbsp;the&nbsp;Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554051">stickyErr</span>&nbsp;<span class="builtintype" id="5554061">error</span>&nbsp;&nbsp;<span class="comment" id="5554068">//&nbsp;if&nbsp;non-nil,&nbsp;this&nbsp;error&nbsp;is&nbsp;returned&nbsp;for&nbsp;all&nbsp;operations</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554127">closemu</span>&nbsp;<span class="ident" id="5554135">sync</span><span class="op" id="5554139">.</span><span class="ident" id="5554140">RWMutex</span>&nbsp;<span class="comment" id="5554148">//&nbsp;held&nbsp;exclusively&nbsp;during&nbsp;close,&nbsp;for&nbsp;read&nbsp;otherwise.</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5554204">//&nbsp;If&nbsp;in&nbsp;a&nbsp;transaction,&nbsp;else&nbsp;both&nbsp;nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554244">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5554249">*</span><span class="ident" id="5554250">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554254">txsi</span>&nbsp;<span class="op" id="5554259">*</span><span class="ident" id="5554260">driverStmt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554273">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5554280">sync</span><span class="op" id="5554284">.</span><span class="ident" id="5554285">Mutex</span>&nbsp;<span class="comment" id="5554291">//&nbsp;protects&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;fields</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554327">closed</span>&nbsp;<span class="builtintype" id="5554334">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5554341">//&nbsp;css&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;underlying&nbsp;driver&nbsp;statement&nbsp;interfaces</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5554401">//&nbsp;that&nbsp;are&nbsp;valid&nbsp;on&nbsp;particular&nbsp;connections.&nbsp;&nbsp;This&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5554461">//&nbsp;used&nbsp;if&nbsp;tx&nbsp;==&nbsp;nil&nbsp;and&nbsp;one&nbsp;is&nbsp;found&nbsp;that&nbsp;has&nbsp;idle</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5554514">//&nbsp;connections.&nbsp;&nbsp;If&nbsp;tx&nbsp;!=&nbsp;nil,&nbsp;txsi&nbsp;is&nbsp;always&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554567">css</span>&nbsp;<span class="op" id="5554571">[</span><span class="op" id="5554572">]</span><span class="ident" id="5554573">connStmt</span><br>
<span class="lineno"></span><span class="op" id="5554582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5554585">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments&nbsp;and</span><br>
<span class="lineno">1300</span><span class="comment" id="5554652">//&nbsp;returns&nbsp;a&nbsp;Result&nbsp;summarizing&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5554713">func</span>&nbsp;<span class="op" id="5554718">(</span><span class="ident" id="5554719">s</span>&nbsp;<span class="op" id="5554721">*</span><span class="ident" id="5554722">Stmt</span><span class="op" id="5554726">)</span>&nbsp;<span class="ident" id="5554728">Exec</span><span class="op" id="5554732">(</span><span class="ident" id="5554733">args</span>&nbsp;<span class="op" id="5554738">...</span><span class="keyword" id="5554741">interface</span><span class="op" id="5554750">{</span><span class="op" id="5554751">}</span><span class="op" id="5554752">)</span>&nbsp;<span class="op" id="5554754">(</span><span class="ident" id="5554755">Result</span><span class="op" id="5554761">,</span>&nbsp;<span class="builtintype" id="5554763">error</span><span class="op" id="5554768">)</span>&nbsp;<span class="op" id="5554770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554773">s</span><span class="op" id="5554774">.</span><span class="ident" id="5554775">closemu</span><span class="op" id="5554782">.</span><span class="ident" id="5554783">RLock</span><span class="op" id="5554788">(</span><span class="op" id="5554789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554792">defer</span>&nbsp;<span class="ident" id="5554798">s</span><span class="op" id="5554799">.</span><span class="ident" id="5554800">closemu</span><span class="op" id="5554807">.</span><span class="ident" id="5554808">RUnlock</span><span class="op" id="5554815">(</span><span class="op" id="5554816">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554820">var</span>&nbsp;<span class="ident" id="5554824">res</span>&nbsp;<span class="ident" id="5554828">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554836">for</span>&nbsp;<span class="ident" id="5554840">i</span>&nbsp;<span class="op" id="5554842">:=</span>&nbsp;<span class="num" id="5554845">0</span><span class="op" id="5554846">;</span>&nbsp;<span class="ident" id="5554848">i</span>&nbsp;<span class="op" id="5554850">&lt;</span>&nbsp;<span class="ident" id="5554852">maxBadConnRetries</span><span class="op" id="5554869">;</span>&nbsp;<span class="ident" id="5554871">i</span><span class="op" id="5554872">++</span>&nbsp;<span class="op" id="5554875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554879">dc</span><span class="op" id="5554881">,</span>&nbsp;<span class="ident" id="5554883">releaseConn</span><span class="op" id="5554894">,</span>&nbsp;<span class="ident" id="5554896">si</span><span class="op" id="5554898">,</span>&nbsp;<span class="ident" id="5554900">err</span>&nbsp;<span class="op" id="5554904">:=</span>&nbsp;<span class="ident" id="5554907">s</span><span class="op" id="5554908">.</span><span class="ident" id="5554909">connStmt</span><span class="op" id="5554917">(</span><span class="op" id="5554918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554922">if</span>&nbsp;<span class="ident" id="5554925">err</span>&nbsp;<span class="op" id="5554929">!=</span>&nbsp;<span class="ident" id="5554932">nil</span>&nbsp;<span class="op" id="5554936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554941">if</span>&nbsp;<span class="ident" id="5554944">err</span>&nbsp;<span class="op" id="5554948">==</span>&nbsp;<span class="ident" id="5554951">driver</span><span class="op" id="5554957">.</span><span class="ident" id="5554958">ErrBadConn</span>&nbsp;<span class="op" id="5554969">{</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554975">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5554987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554992">return</span>&nbsp;<span class="ident" id="5554999">nil</span><span class="op" id="5555002">,</span>&nbsp;<span class="ident" id="5555004">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5555010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555015">res</span><span class="op" id="5555018">,</span>&nbsp;<span class="ident" id="5555020">err</span>&nbsp;<span class="op" id="5555024">=</span>&nbsp;<span class="ident" id="5555026">resultFromStatement</span><span class="op" id="5555045">(</span><span class="ident" id="5555046">driverStmt</span><span class="op" id="5555056">{</span><span class="ident" id="5555057">dc</span><span class="op" id="5555059">,</span>&nbsp;<span class="ident" id="5555061">si</span><span class="op" id="5555063">}</span><span class="op" id="5555064">,</span>&nbsp;<span class="ident" id="5555066">args</span><span class="op" id="5555070">...</span><span class="op" id="5555073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555077">releaseConn</span><span class="op" id="5555088">(</span><span class="ident" id="5555089">err</span><span class="op" id="5555092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555096">if</span>&nbsp;<span class="ident" id="5555099">err</span>&nbsp;<span class="op" id="5555103">!=</span>&nbsp;<span class="ident" id="5555106">driver</span><span class="op" id="5555112">.</span><span class="ident" id="5555113">ErrBadConn</span>&nbsp;<span class="op" id="5555124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555129">return</span>&nbsp;<span class="ident" id="5555136">res</span><span class="op" id="5555139">,</span>&nbsp;<span class="ident" id="5555141">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5555147">}</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5555150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555153">return</span>&nbsp;<span class="ident" id="5555160">nil</span><span class="op" id="5555163">,</span>&nbsp;<span class="ident" id="5555165">driver</span><span class="op" id="5555171">.</span><span class="ident" id="5555172">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="5555183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5555186">func</span>&nbsp;<span class="ident" id="5555191">resultFromStatement</span><span class="op" id="5555210">(</span><span class="ident" id="5555211">ds</span>&nbsp;<span class="ident" id="5555214">driverStmt</span><span class="op" id="5555224">,</span>&nbsp;<span class="ident" id="5555226">args</span>&nbsp;<span class="op" id="5555231">...</span><span class="keyword" id="5555234">interface</span><span class="op" id="5555243">{</span><span class="op" id="5555244">}</span><span class="op" id="5555245">)</span>&nbsp;<span class="op" id="5555247">(</span><span class="ident" id="5555248">Result</span><span class="op" id="5555254">,</span>&nbsp;<span class="builtintype" id="5555256">error</span><span class="op" id="5555261">)</span>&nbsp;<span class="op" id="5555263">{</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555266">ds</span><span class="op" id="5555268">.</span><span class="ident" id="5555269">Lock</span><span class="op" id="5555273">(</span><span class="op" id="5555274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555277">want</span>&nbsp;<span class="op" id="5555282">:=</span>&nbsp;<span class="ident" id="5555285">ds</span><span class="op" id="5555287">.</span><span class="ident" id="5555288">si</span><span class="op" id="5555290">.</span><span class="ident" id="5555291">NumInput</span><span class="op" id="5555299">(</span><span class="op" id="5555300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555303">ds</span><span class="op" id="5555305">.</span><span class="ident" id="5555306">Unlock</span><span class="op" id="5555312">(</span><span class="op" id="5555313">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5555317">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5555381">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5555455">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555484">if</span>&nbsp;<span class="ident" id="5555487">want</span>&nbsp;<span class="op" id="5555492">!=</span>&nbsp;<span class="op" id="5555495">-</span><span class="num" id="5555496">1</span>&nbsp;<span class="op" id="5555498">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5555501">len</span><span class="op" id="5555504">(</span><span class="ident" id="5555505">args</span><span class="op" id="5555509">)</span>&nbsp;<span class="op" id="5555511">!=</span>&nbsp;<span class="ident" id="5555514">want</span>&nbsp;<span class="op" id="5555519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555523">return</span>&nbsp;<span class="ident" id="5555530">nil</span><span class="op" id="5555533">,</span>&nbsp;<span class="ident" id="5555535">fmt</span><span class="op" id="5555538">.</span><span class="ident" id="5555539">Errorf</span><span class="op" id="5555545">(</span><span class="string" id="5555546">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;arguments,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="5555582">,</span>&nbsp;<span class="ident" id="5555584">want</span><span class="op" id="5555588">,</span>&nbsp;<span class="builtinfunc" id="5555590">len</span><span class="op" id="5555593">(</span><span class="ident" id="5555594">args</span><span class="op" id="5555598">)</span><span class="op" id="5555599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5555602">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555606">dargs</span><span class="op" id="5555611">,</span>&nbsp;<span class="ident" id="5555613">err</span>&nbsp;<span class="op" id="5555617">:=</span>&nbsp;<span class="ident" id="5555620">driverArgs</span><span class="op" id="5555630">(</span><span class="op" id="5555631">&amp;</span><span class="ident" id="5555632">ds</span><span class="op" id="5555634">,</span>&nbsp;<span class="ident" id="5555636">args</span><span class="op" id="5555640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555643">if</span>&nbsp;<span class="ident" id="5555646">err</span>&nbsp;<span class="op" id="5555650">!=</span>&nbsp;<span class="ident" id="5555653">nil</span>&nbsp;<span class="op" id="5555657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555661">return</span>&nbsp;<span class="ident" id="5555668">nil</span><span class="op" id="5555671">,</span>&nbsp;<span class="ident" id="5555673">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5555678">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555682">ds</span><span class="op" id="5555684">.</span><span class="ident" id="5555685">Lock</span><span class="op" id="5555689">(</span><span class="op" id="5555690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555693">resi</span><span class="op" id="5555697">,</span>&nbsp;<span class="ident" id="5555699">err</span>&nbsp;<span class="op" id="5555703">:=</span>&nbsp;<span class="ident" id="5555706">ds</span><span class="op" id="5555708">.</span><span class="ident" id="5555709">si</span><span class="op" id="5555711">.</span><span class="ident" id="5555712">Exec</span><span class="op" id="5555716">(</span><span class="ident" id="5555717">dargs</span><span class="op" id="5555722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555725">ds</span><span class="op" id="5555727">.</span><span class="ident" id="5555728">Unlock</span><span class="op" id="5555734">(</span><span class="op" id="5555735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555738">if</span>&nbsp;<span class="ident" id="5555741">err</span>&nbsp;<span class="op" id="5555745">!=</span>&nbsp;<span class="ident" id="5555748">nil</span>&nbsp;<span class="op" id="5555752">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555756">return</span>&nbsp;<span class="ident" id="5555763">nil</span><span class="op" id="5555766">,</span>&nbsp;<span class="ident" id="5555768">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5555773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555776">return</span>&nbsp;<span class="ident" id="5555783">driverResult</span><span class="op" id="5555795">{</span><span class="ident" id="5555796">ds</span><span class="op" id="5555798">.</span><span class="ident" id="5555799">Locker</span><span class="op" id="5555805">,</span>&nbsp;<span class="ident" id="5555807">resi</span><span class="op" id="5555811">}</span><span class="op" id="5555812">,</span>&nbsp;<span class="ident" id="5555814">nil</span><br>
<span class="lineno"></span><span class="op" id="5555818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1350</span><span class="comment" id="5555821">//&nbsp;connStmt&nbsp;returns&nbsp;a&nbsp;free&nbsp;driver&nbsp;connection&nbsp;on&nbsp;which&nbsp;to&nbsp;execute&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5555890">//&nbsp;statement,&nbsp;a&nbsp;function&nbsp;to&nbsp;call&nbsp;to&nbsp;release&nbsp;the&nbsp;connection,&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5555956">//&nbsp;statement&nbsp;bound&nbsp;to&nbsp;that&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5555995">func</span>&nbsp;<span class="op" id="5556000">(</span><span class="ident" id="5556001">s</span>&nbsp;<span class="op" id="5556003">*</span><span class="ident" id="5556004">Stmt</span><span class="op" id="5556008">)</span>&nbsp;<span class="ident" id="5556010">connStmt</span><span class="op" id="5556018">(</span><span class="op" id="5556019">)</span>&nbsp;<span class="op" id="5556021">(</span><span class="ident" id="5556022">ci</span>&nbsp;<span class="op" id="5556025">*</span><span class="ident" id="5556026">driverConn</span><span class="op" id="5556036">,</span>&nbsp;<span class="ident" id="5556038">releaseConn</span>&nbsp;<span class="keyword" id="5556050">func</span><span class="op" id="5556054">(</span><span class="builtintype" id="5556055">error</span><span class="op" id="5556060">)</span><span class="op" id="5556061">,</span>&nbsp;<span class="ident" id="5556063">si</span>&nbsp;<span class="ident" id="5556066">driver</span><span class="op" id="5556072">.</span><span class="ident" id="5556073">Stmt</span><span class="op" id="5556077">,</span>&nbsp;<span class="ident" id="5556079">err</span>&nbsp;<span class="builtintype" id="5556083">error</span><span class="op" id="5556088">)</span>&nbsp;<span class="op" id="5556090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556093">if</span>&nbsp;<span class="ident" id="5556096">err</span>&nbsp;<span class="op" id="5556100">=</span>&nbsp;<span class="ident" id="5556102">s</span><span class="op" id="5556103">.</span><span class="ident" id="5556104">stickyErr</span><span class="op" id="5556113">;</span>&nbsp;<span class="ident" id="5556115">err</span>&nbsp;<span class="op" id="5556119">!=</span>&nbsp;<span class="ident" id="5556122">nil</span>&nbsp;<span class="op" id="5556126">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556130">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5556138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556141">s</span><span class="op" id="5556142">.</span><span class="ident" id="5556143">mu</span><span class="op" id="5556145">.</span><span class="ident" id="5556146">Lock</span><span class="op" id="5556150">(</span><span class="op" id="5556151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556154">if</span>&nbsp;<span class="ident" id="5556157">s</span><span class="op" id="5556158">.</span><span class="ident" id="5556159">closed</span>&nbsp;<span class="op" id="5556166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556170">s</span><span class="op" id="5556171">.</span><span class="ident" id="5556172">mu</span><span class="op" id="5556174">.</span><span class="ident" id="5556175">Unlock</span><span class="op" id="5556181">(</span><span class="op" id="5556182">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556186">err</span>&nbsp;<span class="op" id="5556190">=</span>&nbsp;<span class="ident" id="5556192">errors</span><span class="op" id="5556198">.</span><span class="ident" id="5556199">New</span><span class="op" id="5556202">(</span><span class="string" id="5556203">&#34;sql:&nbsp;statement&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5556229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556233">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5556241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5556245">//&nbsp;In&nbsp;a&nbsp;transaction,&nbsp;we&nbsp;always&nbsp;use&nbsp;the&nbsp;connection&nbsp;that&nbsp;the</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5556305">//&nbsp;transaction&nbsp;was&nbsp;created&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556337">if</span>&nbsp;<span class="ident" id="5556340">s</span><span class="op" id="5556341">.</span><span class="ident" id="5556342">tx</span>&nbsp;<span class="op" id="5556345">!=</span>&nbsp;<span class="ident" id="5556348">nil</span>&nbsp;<span class="op" id="5556352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556356">s</span><span class="op" id="5556357">.</span><span class="ident" id="5556358">mu</span><span class="op" id="5556360">.</span><span class="ident" id="5556361">Unlock</span><span class="op" id="5556367">(</span><span class="op" id="5556368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556372">ci</span><span class="op" id="5556374">,</span>&nbsp;<span class="ident" id="5556376">err</span>&nbsp;<span class="op" id="5556380">=</span>&nbsp;<span class="ident" id="5556382">s</span><span class="op" id="5556383">.</span><span class="ident" id="5556384">tx</span><span class="op" id="5556386">.</span><span class="ident" id="5556387">grabConn</span><span class="op" id="5556395">(</span><span class="op" id="5556396">)</span>&nbsp;<span class="comment" id="5556398">//&nbsp;blocks,&nbsp;waiting&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556439">if</span>&nbsp;<span class="ident" id="5556442">err</span>&nbsp;<span class="op" id="5556446">!=</span>&nbsp;<span class="ident" id="5556449">nil</span>&nbsp;<span class="op" id="5556453">{</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556458">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5556467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556471">releaseConn</span>&nbsp;<span class="op" id="5556483">=</span>&nbsp;<span class="keyword" id="5556485">func</span><span class="op" id="5556489">(</span><span class="builtintype" id="5556490">error</span><span class="op" id="5556495">)</span>&nbsp;<span class="op" id="5556497">{</span><span class="op" id="5556498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556502">return</span>&nbsp;<span class="ident" id="5556509">ci</span><span class="op" id="5556511">,</span>&nbsp;<span class="ident" id="5556513">releaseConn</span><span class="op" id="5556524">,</span>&nbsp;<span class="ident" id="5556526">s</span><span class="op" id="5556527">.</span><span class="ident" id="5556528">txsi</span><span class="op" id="5556532">.</span><span class="ident" id="5556533">si</span><span class="op" id="5556535">,</span>&nbsp;<span class="ident" id="5556537">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5556542">}</span><br>
<span class="lineno">1375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556546">for</span>&nbsp;<span class="ident" id="5556550">i</span>&nbsp;<span class="op" id="5556552">:=</span>&nbsp;<span class="num" id="5556555">0</span><span class="op" id="5556556">;</span>&nbsp;<span class="ident" id="5556558">i</span>&nbsp;<span class="op" id="5556560">&lt;</span>&nbsp;<span class="builtinfunc" id="5556562">len</span><span class="op" id="5556565">(</span><span class="ident" id="5556566">s</span><span class="op" id="5556567">.</span><span class="ident" id="5556568">css</span><span class="op" id="5556571">)</span><span class="op" id="5556572">;</span>&nbsp;<span class="ident" id="5556574">i</span><span class="op" id="5556575">++</span>&nbsp;<span class="op" id="5556578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556582">v</span>&nbsp;<span class="op" id="5556584">:=</span>&nbsp;<span class="ident" id="5556587">s</span><span class="op" id="5556588">.</span><span class="ident" id="5556589">css</span><span class="op" id="5556592">[</span><span class="ident" id="5556593">i</span><span class="op" id="5556594">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556598">_</span><span class="op" id="5556599">,</span>&nbsp;<span class="ident" id="5556601">err</span>&nbsp;<span class="op" id="5556605">:=</span>&nbsp;<span class="ident" id="5556608">s</span><span class="op" id="5556609">.</span><span class="ident" id="5556610">db</span><span class="op" id="5556612">.</span><span class="ident" id="5556613">connIfFree</span><span class="op" id="5556623">(</span><span class="ident" id="5556624">v</span><span class="op" id="5556625">.</span><span class="ident" id="5556626">dc</span><span class="op" id="5556628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556632">if</span>&nbsp;<span class="ident" id="5556635">err</span>&nbsp;<span class="op" id="5556639">==</span>&nbsp;<span class="ident" id="5556642">nil</span>&nbsp;<span class="op" id="5556646">{</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556651">s</span><span class="op" id="5556652">.</span><span class="ident" id="5556653">mu</span><span class="op" id="5556655">.</span><span class="ident" id="5556656">Unlock</span><span class="op" id="5556662">(</span><span class="op" id="5556663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556668">return</span>&nbsp;<span class="ident" id="5556675">v</span><span class="op" id="5556676">.</span><span class="ident" id="5556677">dc</span><span class="op" id="5556679">,</span>&nbsp;<span class="ident" id="5556681">v</span><span class="op" id="5556682">.</span><span class="ident" id="5556683">dc</span><span class="op" id="5556685">.</span><span class="ident" id="5556686">releaseConn</span><span class="op" id="5556697">,</span>&nbsp;<span class="ident" id="5556699">v</span><span class="op" id="5556700">.</span><span class="ident" id="5556701">si</span><span class="op" id="5556703">,</span>&nbsp;<span class="ident" id="5556705">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5556711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556715">if</span>&nbsp;<span class="ident" id="5556718">err</span>&nbsp;<span class="op" id="5556722">==</span>&nbsp;<span class="ident" id="5556725">errConnClosed</span>&nbsp;<span class="op" id="5556739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5556744">//&nbsp;Lazily&nbsp;remove&nbsp;dead&nbsp;conn&nbsp;from&nbsp;our&nbsp;freelist.</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556793">s</span><span class="op" id="5556794">.</span><span class="ident" id="5556795">css</span><span class="op" id="5556798">[</span><span class="ident" id="5556799">i</span><span class="op" id="5556800">]</span>&nbsp;<span class="op" id="5556802">=</span>&nbsp;<span class="ident" id="5556804">s</span><span class="op" id="5556805">.</span><span class="ident" id="5556806">css</span><span class="op" id="5556809">[</span><span class="builtinfunc" id="5556810">len</span><span class="op" id="5556813">(</span><span class="ident" id="5556814">s</span><span class="op" id="5556815">.</span><span class="ident" id="5556816">css</span><span class="op" id="5556819">)</span><span class="op" id="5556820">-</span><span class="num" id="5556821">1</span><span class="op" id="5556822">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556827">s</span><span class="op" id="5556828">.</span><span class="ident" id="5556829">css</span>&nbsp;<span class="op" id="5556833">=</span>&nbsp;<span class="ident" id="5556835">s</span><span class="op" id="5556836">.</span><span class="ident" id="5556837">css</span><span class="op" id="5556840">[</span><span class="op" id="5556841">:</span><span class="builtinfunc" id="5556842">len</span><span class="op" id="5556845">(</span><span class="ident" id="5556846">s</span><span class="op" id="5556847">.</span><span class="ident" id="5556848">css</span><span class="op" id="5556851">)</span><span class="op" id="5556852">-</span><span class="num" id="5556853">1</span><span class="op" id="5556854">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556859">i</span><span class="op" id="5556860">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5556865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5556869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556872">s</span><span class="op" id="5556873">.</span><span class="ident" id="5556874">mu</span><span class="op" id="5556876">.</span><span class="ident" id="5556877">Unlock</span><span class="op" id="5556883">(</span><span class="op" id="5556884">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5556888">//&nbsp;If&nbsp;all&nbsp;connections&nbsp;are&nbsp;busy,&nbsp;either&nbsp;wait&nbsp;for&nbsp;one&nbsp;to&nbsp;become&nbsp;available&nbsp;(if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5556965">//&nbsp;we&#39;ve&nbsp;already&nbsp;hit&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections)&nbsp;or&nbsp;create&nbsp;a</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5557039">//&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5557052">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5557056">//&nbsp;TODO(bradfitz):&nbsp;or&nbsp;always&nbsp;wait&nbsp;for&nbsp;one?&nbsp;make&nbsp;configurable&nbsp;later?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5557125">dc</span><span class="op" id="5557127">,</span>&nbsp;<span class="ident" id="5557129">err</span>&nbsp;<span class="op" id="5557133">:=</span>&nbsp;<span class="ident" id="5557136">s</span><span class="op" id="5557137">.</span><span class="ident" id="5557138">db</span><span class="op" id="5557140">.</span><span class="ident" id="5557141">conn</span><span class="op" id="5557145">(</span><span class="op" id="5557146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557149">if</span>&nbsp;<span class="ident" id="5557152">err</span>&nbsp;<span class="op" id="5557156">!=</span>&nbsp;<span class="ident" id="5557159">nil</span>&nbsp;<span class="op" id="5557163">{</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557167">return</span>&nbsp;<span class="ident" id="5557174">nil</span><span class="op" id="5557177">,</span>&nbsp;<span class="ident" id="5557179">nil</span><span class="op" id="5557182">,</span>&nbsp;<span class="ident" id="5557184">nil</span><span class="op" id="5557187">,</span>&nbsp;<span class="ident" id="5557189">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5557194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5557198">//&nbsp;Do&nbsp;another&nbsp;pass&nbsp;over&nbsp;the&nbsp;list&nbsp;to&nbsp;see&nbsp;whether&nbsp;this&nbsp;statement&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5557266">//&nbsp;already&nbsp;been&nbsp;prepared&nbsp;on&nbsp;the&nbsp;connection&nbsp;assigned&nbsp;to&nbsp;us.</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5557326">s</span><span class="op" id="5557327">.</span><span class="ident" id="5557328">mu</span><span class="op" id="5557330">.</span><span class="ident" id="5557331">Lock</span><span class="op" id="5557335">(</span><span class="op" id="5557336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557339">for</span>&nbsp;<span class="ident" id="5557343">_</span><span class="op" id="5557344">,</span>&nbsp;<span class="ident" id="5557346">v</span>&nbsp;<span class="op" id="5557348">:=</span>&nbsp;<span class="keyword" id="5557351">range</span>&nbsp;<span class="ident" id="5557357">s</span><span class="op" id="5557358">.</span><span class="ident" id="5557359">css</span>&nbsp;<span class="op" id="5557363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557367">if</span>&nbsp;<span class="ident" id="5557370">v</span><span class="op" id="5557371">.</span><span class="ident" id="5557372">dc</span>&nbsp;<span class="op" id="5557375">==</span>&nbsp;<span class="ident" id="5557378">dc</span>&nbsp;<span class="op" id="5557381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5557386">s</span><span class="op" id="5557387">.</span><span class="ident" id="5557388">mu</span><span class="op" id="5557390">.</span><span class="ident" id="5557391">Unlock</span><span class="op" id="5557397">(</span><span class="op" id="5557398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557403">return</span>&nbsp;<span class="ident" id="5557410">dc</span><span class="op" id="5557412">,</span>&nbsp;<span class="ident" id="5557414">dc</span><span class="op" id="5557416">.</span><span class="ident" id="5557417">releaseConn</span><span class="op" id="5557428">,</span>&nbsp;<span class="ident" id="5557430">v</span><span class="op" id="5557431">.</span><span class="ident" id="5557432">si</span><span class="op" id="5557434">,</span>&nbsp;<span class="ident" id="5557436">nil</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5557442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5557445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5557448">s</span><span class="op" id="5557449">.</span><span class="ident" id="5557450">mu</span><span class="op" id="5557452">.</span><span class="ident" id="5557453">Unlock</span><span class="op" id="5557459">(</span><span class="op" id="5557460">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5557464">//&nbsp;No&nbsp;luck;&nbsp;we&nbsp;need&nbsp;to&nbsp;prepare&nbsp;the&nbsp;statement&nbsp;on&nbsp;this&nbsp;connection</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5557529">dc</span><span class="op" id="5557531">.</span><span class="ident" id="5557532">Lock</span><span class="op" id="5557536">(</span><span class="op" id="5557537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5557540">si</span><span class="op" id="5557542">,</span>&nbsp;<span class="ident" id="5557544">err</span>&nbsp;<span class="op" id="5557548">=</span>&nbsp;<span class="ident" id="5557550">dc</span><span class="op" id="5557552">.</span><span class="ident" id="5557553">prepareLocked</span><span class="op" id="5557566">(</span><span class="ident" id="5557567">s</span><span class="op" id="5557568">.</span><span class="ident" id="5557569">query</span><span class="op" id="5557574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5557577">dc</span><span class="op" id="5557579">.</span><span class="ident" id="5557580">Unlock</span><span class="op" id="5557586">(</span><span class="op" id="5557587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557590">if</span>&nbsp;<span class="ident" id="5557593">err</span>&nbsp;<span class="op" id="5557597">!=</span>&nbsp;<span class="ident" id="5557600">nil</span>&nbsp;<span class="op" id="5557604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5557608">s</span><span class="op" id="5557609">.</span><span class="ident" id="5557610">db</span><span class="op" id="5557612">.</span><span class="ident" id="5557613">putConn</span><span class="op" id="5557620">(</span><span class="ident" id="5557621">dc</span><span class="op" id="5557623">,</span>&nbsp;<span class="ident" id="5557625">err</span><span class="op" id="5557628">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557632">return</span>&nbsp;<span class="ident" id="5557639">nil</span><span class="op" id="5557642">,</span>&nbsp;<span class="ident" id="5557644">nil</span><span class="op" id="5557647">,</span>&nbsp;<span class="ident" id="5557649">nil</span><span class="op" id="5557652">,</span>&nbsp;<span class="ident" id="5557654">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5557659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5557662">s</span><span class="op" id="5557663">.</span><span class="ident" id="5557664">mu</span><span class="op" id="5557666">.</span><span class="ident" id="5557667">Lock</span><span class="op" id="5557671">(</span><span class="op" id="5557672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5557675">cs</span>&nbsp;<span class="op" id="5557678">:=</span>&nbsp;<span class="ident" id="5557681">connStmt</span><span class="op" id="5557689">{</span><span class="ident" id="5557690">dc</span><span class="op" id="5557692">,</span>&nbsp;<span class="ident" id="5557694">si</span><span class="op" id="5557696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5557699">s</span><span class="op" id="5557700">.</span><span class="ident" id="5557701">css</span>&nbsp;<span class="op" id="5557705">=</span>&nbsp;<span class="builtinfunc" id="5557707">append</span><span class="op" id="5557713">(</span><span class="ident" id="5557714">s</span><span class="op" id="5557715">.</span><span class="ident" id="5557716">css</span><span class="op" id="5557719">,</span>&nbsp;<span class="ident" id="5557721">cs</span><span class="op" id="5557723">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5557726">s</span><span class="op" id="5557727">.</span><span class="ident" id="5557728">mu</span><span class="op" id="5557730">.</span><span class="ident" id="5557731">Unlock</span><span class="op" id="5557737">(</span><span class="op" id="5557738">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557742">return</span>&nbsp;<span class="ident" id="5557749">dc</span><span class="op" id="5557751">,</span>&nbsp;<span class="ident" id="5557753">dc</span><span class="op" id="5557755">.</span><span class="ident" id="5557756">releaseConn</span><span class="op" id="5557767">,</span>&nbsp;<span class="ident" id="5557769">si</span><span class="op" id="5557771">,</span>&nbsp;<span class="ident" id="5557773">nil</span><br>
<span class="lineno"></span><span class="op" id="5557777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1430</span><span class="comment" id="5557780">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments</span><br>
<span class="lineno"></span><span class="comment" id="5557850">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;query&nbsp;results&nbsp;as&nbsp;a&nbsp;*Rows.</span><br>
<span class="lineno"></span><span class="keyword" id="5557895">func</span>&nbsp;<span class="op" id="5557900">(</span><span class="ident" id="5557901">s</span>&nbsp;<span class="op" id="5557903">*</span><span class="ident" id="5557904">Stmt</span><span class="op" id="5557908">)</span>&nbsp;<span class="ident" id="5557910">Query</span><span class="op" id="5557915">(</span><span class="ident" id="5557916">args</span>&nbsp;<span class="op" id="5557921">...</span><span class="keyword" id="5557924">interface</span><span class="op" id="5557933">{</span><span class="op" id="5557934">}</span><span class="op" id="5557935">)</span>&nbsp;<span class="op" id="5557937">(</span><span class="op" id="5557938">*</span><span class="ident" id="5557939">Rows</span><span class="op" id="5557943">,</span>&nbsp;<span class="builtintype" id="5557945">error</span><span class="op" id="5557950">)</span>&nbsp;<span class="op" id="5557952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5557955">s</span><span class="op" id="5557956">.</span><span class="ident" id="5557957">closemu</span><span class="op" id="5557964">.</span><span class="ident" id="5557965">RLock</span><span class="op" id="5557970">(</span><span class="op" id="5557971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557974">defer</span>&nbsp;<span class="ident" id="5557980">s</span><span class="op" id="5557981">.</span><span class="ident" id="5557982">closemu</span><span class="op" id="5557989">.</span><span class="ident" id="5557990">RUnlock</span><span class="op" id="5557997">(</span><span class="op" id="5557998">)</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558002">var</span>&nbsp;<span class="ident" id="5558006">rowsi</span>&nbsp;<span class="ident" id="5558012">driver</span><span class="op" id="5558018">.</span><span class="ident" id="5558019">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558025">for</span>&nbsp;<span class="ident" id="5558029">i</span>&nbsp;<span class="op" id="5558031">:=</span>&nbsp;<span class="num" id="5558034">0</span><span class="op" id="5558035">;</span>&nbsp;<span class="ident" id="5558037">i</span>&nbsp;<span class="op" id="5558039">&lt;</span>&nbsp;<span class="ident" id="5558041">maxBadConnRetries</span><span class="op" id="5558058">;</span>&nbsp;<span class="ident" id="5558060">i</span><span class="op" id="5558061">++</span>&nbsp;<span class="op" id="5558064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558068">dc</span><span class="op" id="5558070">,</span>&nbsp;<span class="ident" id="5558072">releaseConn</span><span class="op" id="5558083">,</span>&nbsp;<span class="ident" id="5558085">si</span><span class="op" id="5558087">,</span>&nbsp;<span class="ident" id="5558089">err</span>&nbsp;<span class="op" id="5558093">:=</span>&nbsp;<span class="ident" id="5558096">s</span><span class="op" id="5558097">.</span><span class="ident" id="5558098">connStmt</span><span class="op" id="5558106">(</span><span class="op" id="5558107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558111">if</span>&nbsp;<span class="ident" id="5558114">err</span>&nbsp;<span class="op" id="5558118">!=</span>&nbsp;<span class="ident" id="5558121">nil</span>&nbsp;<span class="op" id="5558125">{</span><br>
<span class="lineno">1440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558130">if</span>&nbsp;<span class="ident" id="5558133">err</span>&nbsp;<span class="op" id="5558137">==</span>&nbsp;<span class="ident" id="5558140">driver</span><span class="op" id="5558146">.</span><span class="ident" id="5558147">ErrBadConn</span>&nbsp;<span class="op" id="5558158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558164">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5558176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558181">return</span>&nbsp;<span class="ident" id="5558188">nil</span><span class="op" id="5558191">,</span>&nbsp;<span class="ident" id="5558193">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5558199">}</span><br>
<span class="lineno">1445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558204">rowsi</span><span class="op" id="5558209">,</span>&nbsp;<span class="ident" id="5558211">err</span>&nbsp;<span class="op" id="5558215">=</span>&nbsp;<span class="ident" id="5558217">rowsiFromStatement</span><span class="op" id="5558235">(</span><span class="ident" id="5558236">driverStmt</span><span class="op" id="5558246">{</span><span class="ident" id="5558247">dc</span><span class="op" id="5558249">,</span>&nbsp;<span class="ident" id="5558251">si</span><span class="op" id="5558253">}</span><span class="op" id="5558254">,</span>&nbsp;<span class="ident" id="5558256">args</span><span class="op" id="5558260">...</span><span class="op" id="5558263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558267">if</span>&nbsp;<span class="ident" id="5558270">err</span>&nbsp;<span class="op" id="5558274">==</span>&nbsp;<span class="ident" id="5558277">nil</span>&nbsp;<span class="op" id="5558281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5558286">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5558347">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558371">rows</span>&nbsp;<span class="op" id="5558376">:=</span>&nbsp;<span class="op" id="5558379">&amp;</span><span class="ident" id="5558380">Rows</span><span class="op" id="5558384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558390">dc</span><span class="op" id="5558392">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558397">dc</span><span class="op" id="5558399">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558405">rowsi</span><span class="op" id="5558410">:</span>&nbsp;<span class="ident" id="5558412">rowsi</span><span class="op" id="5558417">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5558423">//&nbsp;releaseConn&nbsp;set&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5558451">}</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558456">s</span><span class="op" id="5558457">.</span><span class="ident" id="5558458">db</span><span class="op" id="5558460">.</span><span class="ident" id="5558461">addDep</span><span class="op" id="5558467">(</span><span class="ident" id="5558468">s</span><span class="op" id="5558469">,</span>&nbsp;<span class="ident" id="5558471">rows</span><span class="op" id="5558475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558480">rows</span><span class="op" id="5558484">.</span><span class="ident" id="5558485">releaseConn</span>&nbsp;<span class="op" id="5558497">=</span>&nbsp;<span class="keyword" id="5558499">func</span><span class="op" id="5558503">(</span><span class="ident" id="5558504">err</span>&nbsp;<span class="builtintype" id="5558508">error</span><span class="op" id="5558513">)</span>&nbsp;<span class="op" id="5558515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558521">releaseConn</span><span class="op" id="5558532">(</span><span class="ident" id="5558533">err</span><span class="op" id="5558536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558542">s</span><span class="op" id="5558543">.</span><span class="ident" id="5558544">db</span><span class="op" id="5558546">.</span><span class="ident" id="5558547">removeDep</span><span class="op" id="5558556">(</span><span class="ident" id="5558557">s</span><span class="op" id="5558558">,</span>&nbsp;<span class="ident" id="5558560">rows</span><span class="op" id="5558564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5558569">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558574">return</span>&nbsp;<span class="ident" id="5558581">rows</span><span class="op" id="5558585">,</span>&nbsp;<span class="ident" id="5558587">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5558593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558598">releaseConn</span><span class="op" id="5558609">(</span><span class="ident" id="5558610">err</span><span class="op" id="5558613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558617">if</span>&nbsp;<span class="ident" id="5558620">err</span>&nbsp;<span class="op" id="5558624">!=</span>&nbsp;<span class="ident" id="5558627">driver</span><span class="op" id="5558633">.</span><span class="ident" id="5558634">ErrBadConn</span>&nbsp;<span class="op" id="5558645">{</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558650">return</span>&nbsp;<span class="ident" id="5558657">nil</span><span class="op" id="5558660">,</span>&nbsp;<span class="ident" id="5558662">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5558668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5558671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558674">return</span>&nbsp;<span class="ident" id="5558681">nil</span><span class="op" id="5558684">,</span>&nbsp;<span class="ident" id="5558686">driver</span><span class="op" id="5558692">.</span><span class="ident" id="5558693">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="5558704">}</span><br>
<span class="lineno">1470</span><br>
<span class="lineno"></span><span class="keyword" id="5558707">func</span>&nbsp;<span class="ident" id="5558712">rowsiFromStatement</span><span class="op" id="5558730">(</span><span class="ident" id="5558731">ds</span>&nbsp;<span class="ident" id="5558734">driverStmt</span><span class="op" id="5558744">,</span>&nbsp;<span class="ident" id="5558746">args</span>&nbsp;<span class="op" id="5558751">...</span><span class="keyword" id="5558754">interface</span><span class="op" id="5558763">{</span><span class="op" id="5558764">}</span><span class="op" id="5558765">)</span>&nbsp;<span class="op" id="5558767">(</span><span class="ident" id="5558768">driver</span><span class="op" id="5558774">.</span><span class="ident" id="5558775">Rows</span><span class="op" id="5558779">,</span>&nbsp;<span class="builtintype" id="5558781">error</span><span class="op" id="5558786">)</span>&nbsp;<span class="op" id="5558788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558791">ds</span><span class="op" id="5558793">.</span><span class="ident" id="5558794">Lock</span><span class="op" id="5558798">(</span><span class="op" id="5558799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558802">want</span>&nbsp;<span class="op" id="5558807">:=</span>&nbsp;<span class="ident" id="5558810">ds</span><span class="op" id="5558812">.</span><span class="ident" id="5558813">si</span><span class="op" id="5558815">.</span><span class="ident" id="5558816">NumInput</span><span class="op" id="5558824">(</span><span class="op" id="5558825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558828">ds</span><span class="op" id="5558830">.</span><span class="ident" id="5558831">Unlock</span><span class="op" id="5558837">(</span><span class="op" id="5558838">)</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5558842">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5558906">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5558980">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559009">if</span>&nbsp;<span class="ident" id="5559012">want</span>&nbsp;<span class="op" id="5559017">!=</span>&nbsp;<span class="op" id="5559020">-</span><span class="num" id="5559021">1</span>&nbsp;<span class="op" id="5559023">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5559026">len</span><span class="op" id="5559029">(</span><span class="ident" id="5559030">args</span><span class="op" id="5559034">)</span>&nbsp;<span class="op" id="5559036">!=</span>&nbsp;<span class="ident" id="5559039">want</span>&nbsp;<span class="op" id="5559044">{</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559048">return</span>&nbsp;<span class="ident" id="5559055">nil</span><span class="op" id="5559058">,</span>&nbsp;<span class="ident" id="5559060">fmt</span><span class="op" id="5559063">.</span><span class="ident" id="5559064">Errorf</span><span class="op" id="5559070">(</span><span class="string" id="5559071">&#34;sql:&nbsp;statement&nbsp;expects&nbsp;%d&nbsp;inputs;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="5559113">,</span>&nbsp;<span class="ident" id="5559115">want</span><span class="op" id="5559119">,</span>&nbsp;<span class="builtinfunc" id="5559121">len</span><span class="op" id="5559124">(</span><span class="ident" id="5559125">args</span><span class="op" id="5559129">)</span><span class="op" id="5559130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5559133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5559137">dargs</span><span class="op" id="5559142">,</span>&nbsp;<span class="ident" id="5559144">err</span>&nbsp;<span class="op" id="5559148">:=</span>&nbsp;<span class="ident" id="5559151">driverArgs</span><span class="op" id="5559161">(</span><span class="op" id="5559162">&amp;</span><span class="ident" id="5559163">ds</span><span class="op" id="5559165">,</span>&nbsp;<span class="ident" id="5559167">args</span><span class="op" id="5559171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559174">if</span>&nbsp;<span class="ident" id="5559177">err</span>&nbsp;<span class="op" id="5559181">!=</span>&nbsp;<span class="ident" id="5559184">nil</span>&nbsp;<span class="op" id="5559188">{</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559192">return</span>&nbsp;<span class="ident" id="5559199">nil</span><span class="op" id="5559202">,</span>&nbsp;<span class="ident" id="5559204">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5559209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5559213">ds</span><span class="op" id="5559215">.</span><span class="ident" id="5559216">Lock</span><span class="op" id="5559220">(</span><span class="op" id="5559221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5559224">rowsi</span><span class="op" id="5559229">,</span>&nbsp;<span class="ident" id="5559231">err</span>&nbsp;<span class="op" id="5559235">:=</span>&nbsp;<span class="ident" id="5559238">ds</span><span class="op" id="5559240">.</span><span class="ident" id="5559241">si</span><span class="op" id="5559243">.</span><span class="ident" id="5559244">Query</span><span class="op" id="5559249">(</span><span class="ident" id="5559250">dargs</span><span class="op" id="5559255">)</span><br>
<span class="lineno">1490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5559258">ds</span><span class="op" id="5559260">.</span><span class="ident" id="5559261">Unlock</span><span class="op" id="5559267">(</span><span class="op" id="5559268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559271">if</span>&nbsp;<span class="ident" id="5559274">err</span>&nbsp;<span class="op" id="5559278">!=</span>&nbsp;<span class="ident" id="5559281">nil</span>&nbsp;<span class="op" id="5559285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559289">return</span>&nbsp;<span class="ident" id="5559296">nil</span><span class="op" id="5559299">,</span>&nbsp;<span class="ident" id="5559301">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5559306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559309">return</span>&nbsp;<span class="ident" id="5559316">rowsi</span><span class="op" id="5559321">,</span>&nbsp;<span class="ident" id="5559323">nil</span><br>
<span class="lineno">1495</span><span class="op" id="5559327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5559330">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="5559404">//&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;during&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;statement,&nbsp;that&nbsp;error&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="5559481">//&nbsp;be&nbsp;returned&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Scan&nbsp;on&nbsp;the&nbsp;returned&nbsp;*Row,&nbsp;which&nbsp;is&nbsp;always&nbsp;non-nil.</span><br>
<span class="lineno">1500</span><span class="comment" id="5559561">//&nbsp;If&nbsp;the&nbsp;query&nbsp;selects&nbsp;no&nbsp;rows,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;will&nbsp;return&nbsp;ErrNoRows.</span><br>
<span class="lineno"></span><span class="comment" id="5559633">//&nbsp;Otherwise,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;scans&nbsp;the&nbsp;first&nbsp;selected&nbsp;row&nbsp;and&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="5559705">//&nbsp;the&nbsp;rest.</span><br>
<span class="lineno"></span><span class="comment" id="5559718">//</span><br>
<span class="lineno"></span><span class="comment" id="5559721">//&nbsp;Example&nbsp;usage:</span><br>
<span class="lineno">1505</span><span class="comment" id="5559739">//</span><br>
<span class="lineno"></span><span class="comment" id="5559742">//&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5559762">//&nbsp;&nbsp;err&nbsp;:=&nbsp;nameByUseridStmt.QueryRow(id).Scan(&amp;name)</span><br>
<span class="lineno"></span><span class="keyword" id="5559815">func</span>&nbsp;<span class="op" id="5559820">(</span><span class="ident" id="5559821">s</span>&nbsp;<span class="op" id="5559823">*</span><span class="ident" id="5559824">Stmt</span><span class="op" id="5559828">)</span>&nbsp;<span class="ident" id="5559830">QueryRow</span><span class="op" id="5559838">(</span><span class="ident" id="5559839">args</span>&nbsp;<span class="op" id="5559844">...</span><span class="keyword" id="5559847">interface</span><span class="op" id="5559856">{</span><span class="op" id="5559857">}</span><span class="op" id="5559858">)</span>&nbsp;<span class="op" id="5559860">*</span><span class="ident" id="5559861">Row</span>&nbsp;<span class="op" id="5559865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5559868">rows</span><span class="op" id="5559872">,</span>&nbsp;<span class="ident" id="5559874">err</span>&nbsp;<span class="op" id="5559878">:=</span>&nbsp;<span class="ident" id="5559881">s</span><span class="op" id="5559882">.</span><span class="ident" id="5559883">Query</span><span class="op" id="5559888">(</span><span class="ident" id="5559889">args</span><span class="op" id="5559893">...</span><span class="op" id="5559896">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559899">if</span>&nbsp;<span class="ident" id="5559902">err</span>&nbsp;<span class="op" id="5559906">!=</span>&nbsp;<span class="ident" id="5559909">nil</span>&nbsp;<span class="op" id="5559913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559917">return</span>&nbsp;<span class="op" id="5559924">&amp;</span><span class="ident" id="5559925">Row</span><span class="op" id="5559928">{</span><span class="ident" id="5559929">err</span><span class="op" id="5559932">:</span>&nbsp;<span class="ident" id="5559934">err</span><span class="op" id="5559937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5559940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559943">return</span>&nbsp;<span class="op" id="5559950">&amp;</span><span class="ident" id="5559951">Row</span><span class="op" id="5559954">{</span><span class="ident" id="5559955">rows</span><span class="op" id="5559959">:</span>&nbsp;<span class="ident" id="5559961">rows</span><span class="op" id="5559965">}</span><br>
<span class="lineno"></span><span class="op" id="5559967">}</span><br>
<span class="lineno">1515</span><br>
<span class="lineno"></span><span class="comment" id="5559970">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5560001">func</span>&nbsp;<span class="op" id="5560006">(</span><span class="ident" id="5560007">s</span>&nbsp;<span class="op" id="5560009">*</span><span class="ident" id="5560010">Stmt</span><span class="op" id="5560014">)</span>&nbsp;<span class="ident" id="5560016">Close</span><span class="op" id="5560021">(</span><span class="op" id="5560022">)</span>&nbsp;<span class="builtintype" id="5560024">error</span>&nbsp;<span class="op" id="5560030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5560033">s</span><span class="op" id="5560034">.</span><span class="ident" id="5560035">closemu</span><span class="op" id="5560042">.</span><span class="ident" id="5560043">Lock</span><span class="op" id="5560047">(</span><span class="op" id="5560048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5560051">defer</span>&nbsp;<span class="ident" id="5560057">s</span><span class="op" id="5560058">.</span><span class="ident" id="5560059">closemu</span><span class="op" id="5560066">.</span><span class="ident" id="5560067">Unlock</span><span class="op" id="5560073">(</span><span class="op" id="5560074">)</span><br>
<span class="lineno">1520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5560078">if</span>&nbsp;<span class="ident" id="5560081">s</span><span class="op" id="5560082">.</span><span class="ident" id="5560083">stickyErr</span>&nbsp;<span class="op" id="5560093">!=</span>&nbsp;<span class="ident" id="5560096">nil</span>&nbsp;<span class="op" id="5560100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5560104">return</span>&nbsp;<span class="ident" id="5560111">s</span><span class="op" id="5560112">.</span><span class="ident" id="5560113">stickyErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5560124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5560127">s</span><span class="op" id="5560128">.</span><span class="ident" id="5560129">mu</span><span class="op" id="5560131">.</span><span class="ident" id="5560132">Lock</span><span class="op" id="5560136">(</span><span class="op" id="5560137">)</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5560140">if</span>&nbsp;<span class="ident" id="5560143">s</span><span class="op" id="5560144">.</span><span class="ident" id="5560145">closed</span>&nbsp;<span class="op" id="5560152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5560156">s</span><span class="op" id="5560157">.</span><span class="ident" id="5560158">mu</span><span class="op" id="5560160">.</span><span class="ident" id="5560161">Unlock</span><span class="op" id="5560167">(</span><span class="op" id="5560168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5560172">return</span>&nbsp;<span class="ident" id="5560179">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5560184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5560187">s</span><span class="op" id="5560188">.</span><span class="ident" id="5560189">closed</span>&nbsp;<span class="op" id="5560196">=</span>&nbsp;<span class="builtintype" id="5560198">true</span><br>
<span class="lineno">1530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5560205">if</span>&nbsp;<span class="ident" id="5560208">s</span><span class="op" id="5560209">.</span><span class="ident" id="5560210">tx</span>&nbsp;<span class="op" id="5560213">!=</span>&nbsp;<span class="ident" id="5560216">nil</span>&nbsp;<span class="op" id="5560220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5560224">s</span><span class="op" id="5560225">.</span><span class="ident" id="5560226">txsi</span><span class="op" id="5560230">.</span><span class="ident" id="5560231">Close</span><span class="op" id="5560236">(</span><span class="op" id="5560237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5560241">s</span><span class="op" id="5560242">.</span><span class="ident" id="5560243">mu</span><span class="op" id="5560245">.</span><span class="ident" id="5560246">Unlock</span><span class="op" id="5560252">(</span><span class="op" id="5560253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5560257">return</span>&nbsp;<span class="ident" id="5560264">nil</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5560269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5560272">s</span><span class="op" id="5560273">.</span><span class="ident" id="5560274">mu</span><span class="op" id="5560276">.</span><span class="ident" id="5560277">Unlock</span><span class="op" id="5560283">(</span><span class="op" id="5560284">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5560288">return</span>&nbsp;<span class="ident" id="5560295">s</span><span class="op" id="5560296">.</span><span class="ident" id="5560297">db</span><span class="op" id="5560299">.</span><span class="ident" id="5560300">removeDep</span><span class="op" id="5560309">(</span><span class="ident" id="5560310">s</span><span class="op" id="5560311">,</span>&nbsp;<span class="ident" id="5560313">s</span><span class="op" id="5560314">)</span><br>
<span class="lineno"></span><span class="op" id="5560316">}</span><br>
<span class="lineno">1540</span><br>
<span class="lineno"></span><span class="keyword" id="5560319">func</span>&nbsp;<span class="op" id="5560324">(</span><span class="ident" id="5560325">s</span>&nbsp;<span class="op" id="5560327">*</span><span class="ident" id="5560328">Stmt</span><span class="op" id="5560332">)</span>&nbsp;<span class="ident" id="5560334">finalClose</span><span class="op" id="5560344">(</span><span class="op" id="5560345">)</span>&nbsp;<span class="builtintype" id="5560347">error</span>&nbsp;<span class="op" id="5560353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5560356">s</span><span class="op" id="5560357">.</span><span class="ident" id="5560358">mu</span><span class="op" id="5560360">.</span><span class="ident" id="5560361">Lock</span><span class="op" id="5560365">(</span><span class="op" id="5560366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5560369">defer</span>&nbsp;<span class="ident" id="5560375">s</span><span class="op" id="5560376">.</span><span class="ident" id="5560377">mu</span><span class="op" id="5560379">.</span><span class="ident" id="5560380">Unlock</span><span class="op" id="5560386">(</span><span class="op" id="5560387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5560390">if</span>&nbsp;<span class="ident" id="5560393">s</span><span class="op" id="5560394">.</span><span class="ident" id="5560395">css</span>&nbsp;<span class="op" id="5560399">!=</span>&nbsp;<span class="ident" id="5560402">nil</span>&nbsp;<span class="op" id="5560406">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5560410">for</span>&nbsp;<span class="ident" id="5560414">_</span><span class="op" id="5560415">,</span>&nbsp;<span class="ident" id="5560417">v</span>&nbsp;<span class="op" id="5560419">:=</span>&nbsp;<span class="keyword" id="5560422">range</span>&nbsp;<span class="ident" id="5560428">s</span><span class="op" id="5560429">.</span><span class="ident" id="5560430">css</span>&nbsp;<span class="op" id="5560434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5560439">s</span><span class="op" id="5560440">.</span><span class="ident" id="5560441">db</span><span class="op" id="5560443">.</span><span class="ident" id="5560444">noteUnusedDriverStatement</span><span class="op" id="5560469">(</span><span class="ident" id="5560470">v</span><span class="op" id="5560471">.</span><span class="ident" id="5560472">dc</span><span class="op" id="5560474">,</span>&nbsp;<span class="ident" id="5560476">v</span><span class="op" id="5560477">.</span><span class="ident" id="5560478">si</span><span class="op" id="5560480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5560485">v</span><span class="op" id="5560486">.</span><span class="ident" id="5560487">dc</span><span class="op" id="5560489">.</span><span class="ident" id="5560490">removeOpenStmt</span><span class="op" id="5560504">(</span><span class="ident" id="5560505">v</span><span class="op" id="5560506">.</span><span class="ident" id="5560507">si</span><span class="op" id="5560509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5560513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5560517">s</span><span class="op" id="5560518">.</span><span class="ident" id="5560519">css</span>&nbsp;<span class="op" id="5560523">=</span>&nbsp;<span class="ident" id="5560525">nil</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5560530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5560533">return</span>&nbsp;<span class="ident" id="5560540">nil</span><br>
<span class="lineno"></span><span class="op" id="5560544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5560547">//&nbsp;Rows&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;query.&nbsp;Its&nbsp;cursor&nbsp;starts&nbsp;before&nbsp;the&nbsp;first&nbsp;row</span><br>
<span class="lineno">1555</span><span class="comment" id="5560620">//&nbsp;of&nbsp;the&nbsp;result&nbsp;set.&nbsp;Use&nbsp;Next&nbsp;to&nbsp;advance&nbsp;through&nbsp;the&nbsp;rows:</span><br>
<span class="lineno"></span><span class="comment" id="5560680">//</span><br>
<span class="lineno"></span><span class="comment" id="5560683">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rows,&nbsp;err&nbsp;:=&nbsp;db.Query(&#34;SELECT&nbsp;...&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="5560726">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5560737">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defer&nbsp;rows.Close()</span><br>
<span class="lineno">1560</span><span class="comment" id="5560763">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;rows.Next()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="5560788">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;id&nbsp;int</span><br>
<span class="lineno"></span><span class="comment" id="5560810">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5560837">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Scan(&amp;id,&nbsp;&amp;name)</span><br>
<span class="lineno"></span><span class="comment" id="5560876">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno">1565</span><span class="comment" id="5560891">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="5560900">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Err()&nbsp;//&nbsp;get&nbsp;any&nbsp;error&nbsp;encountered&nbsp;during&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="5560970">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="keyword" id="5560981">type</span>&nbsp;<span class="ident" id="5560986">Rows</span>&nbsp;<span class="keyword" id="5560991">struct</span>&nbsp;<span class="op" id="5560998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5561001">dc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5561013">*</span><span class="ident" id="5561014">driverConn</span>&nbsp;<span class="comment" id="5561025">//&nbsp;owned;&nbsp;must&nbsp;call&nbsp;releaseConn&nbsp;when&nbsp;closed&nbsp;to&nbsp;release</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5561081">releaseConn</span>&nbsp;<span class="keyword" id="5561093">func</span><span class="op" id="5561097">(</span><span class="builtintype" id="5561098">error</span><span class="op" id="5561103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5561106">rowsi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5561118">driver</span><span class="op" id="5561124">.</span><span class="ident" id="5561125">Rows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5561132">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5561142">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5561148">lastcols</span>&nbsp;&nbsp;<span class="op" id="5561158">[</span><span class="op" id="5561159">]</span><span class="ident" id="5561160">driver</span><span class="op" id="5561166">.</span><span class="ident" id="5561167">Value</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5561174">lasterr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5561184">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5561196">//&nbsp;non-nil&nbsp;only&nbsp;if&nbsp;closed&nbsp;is&nbsp;true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5561231">closeStmt</span>&nbsp;<span class="ident" id="5561241">driver</span><span class="op" id="5561247">.</span><span class="ident" id="5561248">Stmt</span>&nbsp;<span class="comment" id="5561253">//&nbsp;if&nbsp;non-nil,&nbsp;statement&nbsp;to&nbsp;Close&nbsp;on&nbsp;close</span><br>
<span class="lineno"></span><span class="op" id="5561296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5561299">//&nbsp;Next&nbsp;prepares&nbsp;the&nbsp;next&nbsp;result&nbsp;row&nbsp;for&nbsp;reading&nbsp;with&nbsp;the&nbsp;Scan&nbsp;method.&nbsp;&nbsp;It</span><br>
<span class="lineno">1580</span><span class="comment" id="5561374">//&nbsp;returns&nbsp;true&nbsp;on&nbsp;success,&nbsp;or&nbsp;false&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;next&nbsp;result&nbsp;row&nbsp;or&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5561454">//&nbsp;happened&nbsp;while&nbsp;preparing&nbsp;it.&nbsp;&nbsp;Err&nbsp;should&nbsp;be&nbsp;consulted&nbsp;to&nbsp;distinguish&nbsp;between</span><br>
<span class="lineno"></span><span class="comment" id="5561534">//&nbsp;the&nbsp;two&nbsp;cases.</span><br>
<span class="lineno"></span><span class="comment" id="5561552">//</span><br>
<span class="lineno"></span><span class="comment" id="5561555">//&nbsp;Every&nbsp;call&nbsp;to&nbsp;Scan,&nbsp;even&nbsp;the&nbsp;first&nbsp;one,&nbsp;must&nbsp;be&nbsp;preceded&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Next.</span><br>
<span class="lineno">1585</span><span class="keyword" id="5561634">func</span>&nbsp;<span class="op" id="5561639">(</span><span class="ident" id="5561640">rs</span>&nbsp;<span class="op" id="5561643">*</span><span class="ident" id="5561644">Rows</span><span class="op" id="5561648">)</span>&nbsp;<span class="ident" id="5561650">Next</span><span class="op" id="5561654">(</span><span class="op" id="5561655">)</span>&nbsp;<span class="builtintype" id="5561657">bool</span>&nbsp;<span class="op" id="5561662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5561665">if</span>&nbsp;<span class="ident" id="5561668">rs</span><span class="op" id="5561670">.</span><span class="ident" id="5561671">closed</span>&nbsp;<span class="op" id="5561678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5561682">return</span>&nbsp;<span class="builtintype" id="5561689">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5561696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5561699">if</span>&nbsp;<span class="ident" id="5561702">rs</span><span class="op" id="5561704">.</span><span class="ident" id="5561705">lastcols</span>&nbsp;<span class="op" id="5561714">==</span>&nbsp;<span class="ident" id="5561717">nil</span>&nbsp;<span class="op" id="5561721">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5561725">rs</span><span class="op" id="5561727">.</span><span class="ident" id="5561728">lastcols</span>&nbsp;<span class="op" id="5561737">=</span>&nbsp;<span class="builtinfunc" id="5561739">make</span><span class="op" id="5561743">(</span><span class="op" id="5561744">[</span><span class="op" id="5561745">]</span><span class="ident" id="5561746">driver</span><span class="op" id="5561752">.</span><span class="ident" id="5561753">Value</span><span class="op" id="5561758">,</span>&nbsp;<span class="builtinfunc" id="5561760">len</span><span class="op" id="5561763">(</span><span class="ident" id="5561764">rs</span><span class="op" id="5561766">.</span><span class="ident" id="5561767">rowsi</span><span class="op" id="5561772">.</span><span class="ident" id="5561773">Columns</span><span class="op" id="5561780">(</span><span class="op" id="5561781">)</span><span class="op" id="5561782">)</span><span class="op" id="5561783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5561786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5561789">rs</span><span class="op" id="5561791">.</span><span class="ident" id="5561792">lasterr</span>&nbsp;<span class="op" id="5561800">=</span>&nbsp;<span class="ident" id="5561802">rs</span><span class="op" id="5561804">.</span><span class="ident" id="5561805">rowsi</span><span class="op" id="5561810">.</span><span class="ident" id="5561811">Next</span><span class="op" id="5561815">(</span><span class="ident" id="5561816">rs</span><span class="op" id="5561818">.</span><span class="ident" id="5561819">lastcols</span><span class="op" id="5561827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5561830">if</span>&nbsp;<span class="ident" id="5561833">rs</span><span class="op" id="5561835">.</span><span class="ident" id="5561836">lasterr</span>&nbsp;<span class="op" id="5561844">!=</span>&nbsp;<span class="ident" id="5561847">nil</span>&nbsp;<span class="op" id="5561851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5561855">rs</span><span class="op" id="5561857">.</span><span class="ident" id="5561858">Close</span><span class="op" id="5561863">(</span><span class="op" id="5561864">)</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5561868">return</span>&nbsp;<span class="builtintype" id="5561875">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5561882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5561885">return</span>&nbsp;<span class="builtintype" id="5561892">true</span><br>
<span class="lineno"></span><span class="op" id="5561897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="5561900">//&nbsp;Err&nbsp;returns&nbsp;the&nbsp;error,&nbsp;if&nbsp;any,&nbsp;that&nbsp;was&nbsp;encountered&nbsp;during&nbsp;iteration.</span><br>
<span class="lineno"></span><span class="comment" id="5561973">//&nbsp;Err&nbsp;may&nbsp;be&nbsp;called&nbsp;after&nbsp;an&nbsp;explicit&nbsp;or&nbsp;implicit&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="5562031">func</span>&nbsp;<span class="op" id="5562036">(</span><span class="ident" id="5562037">rs</span>&nbsp;<span class="op" id="5562040">*</span><span class="ident" id="5562041">Rows</span><span class="op" id="5562045">)</span>&nbsp;<span class="ident" id="5562047">Err</span><span class="op" id="5562050">(</span><span class="op" id="5562051">)</span>&nbsp;<span class="builtintype" id="5562053">error</span>&nbsp;<span class="op" id="5562059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562062">if</span>&nbsp;<span class="ident" id="5562065">rs</span><span class="op" id="5562067">.</span><span class="ident" id="5562068">lasterr</span>&nbsp;<span class="op" id="5562076">==</span>&nbsp;<span class="ident" id="5562079">io</span><span class="op" id="5562081">.</span><span class="ident" id="5562082">EOF</span>&nbsp;<span class="op" id="5562086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562090">return</span>&nbsp;<span class="ident" id="5562097">nil</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5562102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562105">return</span>&nbsp;<span class="ident" id="5562112">rs</span><span class="op" id="5562114">.</span><span class="ident" id="5562115">lasterr</span><br>
<span class="lineno"></span><span class="op" id="5562123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5562126">//&nbsp;Columns&nbsp;returns&nbsp;the&nbsp;column&nbsp;names.</span><br>
<span class="lineno">1610</span><span class="comment" id="5562163">//&nbsp;Columns&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;rows&nbsp;are&nbsp;closed,&nbsp;or&nbsp;if&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span><span class="comment" id="5562230">//&nbsp;are&nbsp;from&nbsp;QueryRow&nbsp;and&nbsp;there&nbsp;was&nbsp;a&nbsp;deferred&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="5562283">func</span>&nbsp;<span class="op" id="5562288">(</span><span class="ident" id="5562289">rs</span>&nbsp;<span class="op" id="5562292">*</span><span class="ident" id="5562293">Rows</span><span class="op" id="5562297">)</span>&nbsp;<span class="ident" id="5562299">Columns</span><span class="op" id="5562306">(</span><span class="op" id="5562307">)</span>&nbsp;<span class="op" id="5562309">(</span><span class="op" id="5562310">[</span><span class="op" id="5562311">]</span><span class="builtintype" id="5562312">string</span><span class="op" id="5562318">,</span>&nbsp;<span class="builtintype" id="5562320">error</span><span class="op" id="5562325">)</span>&nbsp;<span class="op" id="5562327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562330">if</span>&nbsp;<span class="ident" id="5562333">rs</span><span class="op" id="5562335">.</span><span class="ident" id="5562336">closed</span>&nbsp;<span class="op" id="5562343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562347">return</span>&nbsp;<span class="ident" id="5562354">nil</span><span class="op" id="5562357">,</span>&nbsp;<span class="ident" id="5562359">errors</span><span class="op" id="5562365">.</span><span class="ident" id="5562366">New</span><span class="op" id="5562369">(</span><span class="string" id="5562370">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="5562392">)</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5562395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562398">if</span>&nbsp;<span class="ident" id="5562401">rs</span><span class="op" id="5562403">.</span><span class="ident" id="5562404">rowsi</span>&nbsp;<span class="op" id="5562410">==</span>&nbsp;<span class="ident" id="5562413">nil</span>&nbsp;<span class="op" id="5562417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562421">return</span>&nbsp;<span class="ident" id="5562428">nil</span><span class="op" id="5562431">,</span>&nbsp;<span class="ident" id="5562433">errors</span><span class="op" id="5562439">.</span><span class="ident" id="5562440">New</span><span class="op" id="5562443">(</span><span class="string" id="5562444">&#34;sql:&nbsp;no&nbsp;Rows&nbsp;available&#34;</span><span class="op" id="5562468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5562471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562474">return</span>&nbsp;<span class="ident" id="5562481">rs</span><span class="op" id="5562483">.</span><span class="ident" id="5562484">rowsi</span><span class="op" id="5562489">.</span><span class="ident" id="5562490">Columns</span><span class="op" id="5562497">(</span><span class="op" id="5562498">)</span><span class="op" id="5562499">,</span>&nbsp;<span class="ident" id="5562501">nil</span><br>
<span class="lineno">1620</span><span class="op" id="5562505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5562508">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;in&nbsp;the&nbsp;current&nbsp;row&nbsp;into&nbsp;the&nbsp;values&nbsp;pointed</span><br>
<span class="lineno"></span><span class="comment" id="5562578">//&nbsp;at&nbsp;by&nbsp;dest.</span><br>
<span class="lineno"></span><span class="comment" id="5562593">//</span><br>
<span class="lineno">1625</span><span class="comment" id="5562596">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*[]byte,&nbsp;Scan&nbsp;saves&nbsp;in&nbsp;that&nbsp;argument&nbsp;a&nbsp;copy</span><br>
<span class="lineno"></span><span class="comment" id="5562667">//&nbsp;of&nbsp;the&nbsp;corresponding&nbsp;data.&nbsp;The&nbsp;copy&nbsp;is&nbsp;owned&nbsp;by&nbsp;the&nbsp;caller&nbsp;and&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="5562737">//&nbsp;be&nbsp;modified&nbsp;and&nbsp;held&nbsp;indefinitely.&nbsp;The&nbsp;copy&nbsp;can&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using</span><br>
<span class="lineno"></span><span class="comment" id="5562808">//&nbsp;an&nbsp;argument&nbsp;of&nbsp;type&nbsp;*RawBytes&nbsp;instead;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5562876">//&nbsp;RawBytes&nbsp;for&nbsp;restrictions&nbsp;on&nbsp;its&nbsp;use.</span><br>
<span class="lineno">1630</span><span class="comment" id="5562917">//</span><br>
<span class="lineno"></span><span class="comment" id="5562920">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*interface{},&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5562983">//&nbsp;provided&nbsp;by&nbsp;the&nbsp;underlying&nbsp;driver&nbsp;without&nbsp;conversion.&nbsp;If&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5563053">//&nbsp;is&nbsp;of&nbsp;type&nbsp;[]byte,&nbsp;a&nbsp;copy&nbsp;is&nbsp;made&nbsp;and&nbsp;the&nbsp;caller&nbsp;owns&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span><span class="keyword" id="5563122">func</span>&nbsp;<span class="op" id="5563127">(</span><span class="ident" id="5563128">rs</span>&nbsp;<span class="op" id="5563131">*</span><span class="ident" id="5563132">Rows</span><span class="op" id="5563136">)</span>&nbsp;<span class="ident" id="5563138">Scan</span><span class="op" id="5563142">(</span><span class="ident" id="5563143">dest</span>&nbsp;<span class="op" id="5563148">...</span><span class="keyword" id="5563151">interface</span><span class="op" id="5563160">{</span><span class="op" id="5563161">}</span><span class="op" id="5563162">)</span>&nbsp;<span class="builtintype" id="5563164">error</span>&nbsp;<span class="op" id="5563170">{</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563173">if</span>&nbsp;<span class="ident" id="5563176">rs</span><span class="op" id="5563178">.</span><span class="ident" id="5563179">closed</span>&nbsp;<span class="op" id="5563186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563190">return</span>&nbsp;<span class="ident" id="5563197">errors</span><span class="op" id="5563203">.</span><span class="ident" id="5563204">New</span><span class="op" id="5563207">(</span><span class="string" id="5563208">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="5563230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5563233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563236">if</span>&nbsp;<span class="ident" id="5563239">rs</span><span class="op" id="5563241">.</span><span class="ident" id="5563242">lastcols</span>&nbsp;<span class="op" id="5563251">==</span>&nbsp;<span class="ident" id="5563254">nil</span>&nbsp;<span class="op" id="5563258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563262">return</span>&nbsp;<span class="ident" id="5563269">errors</span><span class="op" id="5563275">.</span><span class="ident" id="5563276">New</span><span class="op" id="5563279">(</span><span class="string" id="5563280">&#34;sql:&nbsp;Scan&nbsp;called&nbsp;without&nbsp;calling&nbsp;Next&#34;</span><span class="op" id="5563319">)</span><br>
<span class="lineno">1640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5563322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563325">if</span>&nbsp;<span class="builtinfunc" id="5563328">len</span><span class="op" id="5563331">(</span><span class="ident" id="5563332">dest</span><span class="op" id="5563336">)</span>&nbsp;<span class="op" id="5563338">!=</span>&nbsp;<span class="builtinfunc" id="5563341">len</span><span class="op" id="5563344">(</span><span class="ident" id="5563345">rs</span><span class="op" id="5563347">.</span><span class="ident" id="5563348">lastcols</span><span class="op" id="5563356">)</span>&nbsp;<span class="op" id="5563358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563362">return</span>&nbsp;<span class="ident" id="5563369">fmt</span><span class="op" id="5563372">.</span><span class="ident" id="5563373">Errorf</span><span class="op" id="5563379">(</span><span class="string" id="5563380">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;destination&nbsp;arguments&nbsp;in&nbsp;Scan,&nbsp;not&nbsp;%d&#34;</span><span class="op" id="5563436">,</span>&nbsp;<span class="builtinfunc" id="5563438">len</span><span class="op" id="5563441">(</span><span class="ident" id="5563442">rs</span><span class="op" id="5563444">.</span><span class="ident" id="5563445">lastcols</span><span class="op" id="5563453">)</span><span class="op" id="5563454">,</span>&nbsp;<span class="builtinfunc" id="5563456">len</span><span class="op" id="5563459">(</span><span class="ident" id="5563460">dest</span><span class="op" id="5563464">)</span><span class="op" id="5563465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5563468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563471">for</span>&nbsp;<span class="ident" id="5563475">i</span><span class="op" id="5563476">,</span>&nbsp;<span class="ident" id="5563478">sv</span>&nbsp;<span class="op" id="5563481">:=</span>&nbsp;<span class="keyword" id="5563484">range</span>&nbsp;<span class="ident" id="5563490">rs</span><span class="op" id="5563492">.</span><span class="ident" id="5563493">lastcols</span>&nbsp;<span class="op" id="5563502">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5563506">err</span>&nbsp;<span class="op" id="5563510">:=</span>&nbsp;<span class="ident" id="5563513">convertAssign</span><span class="op" id="5563526">(</span><span class="ident" id="5563527">dest</span><span class="op" id="5563531">[</span><span class="ident" id="5563532">i</span><span class="op" id="5563533">]</span><span class="op" id="5563534">,</span>&nbsp;<span class="ident" id="5563536">sv</span><span class="op" id="5563538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563542">if</span>&nbsp;<span class="ident" id="5563545">err</span>&nbsp;<span class="op" id="5563549">!=</span>&nbsp;<span class="ident" id="5563552">nil</span>&nbsp;<span class="op" id="5563556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563561">return</span>&nbsp;<span class="ident" id="5563568">fmt</span><span class="op" id="5563571">.</span><span class="ident" id="5563572">Errorf</span><span class="op" id="5563578">(</span><span class="string" id="5563579">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="5563619">,</span>&nbsp;<span class="ident" id="5563621">i</span><span class="op" id="5563622">,</span>&nbsp;<span class="ident" id="5563624">err</span><span class="op" id="5563627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5563631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5563634">}</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563637">return</span>&nbsp;<span class="ident" id="5563644">nil</span><br>
<span class="lineno"></span><span class="op" id="5563648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5563651">var</span>&nbsp;<span class="ident" id="5563655">rowsCloseHook</span>&nbsp;<span class="keyword" id="5563669">func</span><span class="op" id="5563673">(</span><span class="op" id="5563674">*</span><span class="ident" id="5563675">Rows</span><span class="op" id="5563679">,</span>&nbsp;<span class="op" id="5563681">*</span><span class="builtintype" id="5563682">error</span><span class="op" id="5563687">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1655</span><span class="comment" id="5563690">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;Rows,&nbsp;preventing&nbsp;further&nbsp;enumeration.&nbsp;If&nbsp;Next&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5563764">//&nbsp;false,&nbsp;the&nbsp;Rows&nbsp;are&nbsp;closed&nbsp;automatically&nbsp;and&nbsp;it&nbsp;will&nbsp;suffice&nbsp;to&nbsp;check&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5563841">//&nbsp;result&nbsp;of&nbsp;Err.&nbsp;Close&nbsp;is&nbsp;idempotent&nbsp;and&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;result&nbsp;of&nbsp;Err.</span><br>
<span class="lineno"></span><span class="keyword" id="5563918">func</span>&nbsp;<span class="op" id="5563923">(</span><span class="ident" id="5563924">rs</span>&nbsp;<span class="op" id="5563927">*</span><span class="ident" id="5563928">Rows</span><span class="op" id="5563932">)</span>&nbsp;<span class="ident" id="5563934">Close</span><span class="op" id="5563939">(</span><span class="op" id="5563940">)</span>&nbsp;<span class="builtintype" id="5563942">error</span>&nbsp;<span class="op" id="5563948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563951">if</span>&nbsp;<span class="ident" id="5563954">rs</span><span class="op" id="5563956">.</span><span class="ident" id="5563957">closed</span>&nbsp;<span class="op" id="5563964">{</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563968">return</span>&nbsp;<span class="ident" id="5563975">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5563980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5563983">rs</span><span class="op" id="5563985">.</span><span class="ident" id="5563986">closed</span>&nbsp;<span class="op" id="5563993">=</span>&nbsp;<span class="builtintype" id="5563995">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5564001">err</span>&nbsp;<span class="op" id="5564005">:=</span>&nbsp;<span class="ident" id="5564008">rs</span><span class="op" id="5564010">.</span><span class="ident" id="5564011">rowsi</span><span class="op" id="5564016">.</span><span class="ident" id="5564017">Close</span><span class="op" id="5564022">(</span><span class="op" id="5564023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564026">if</span>&nbsp;<span class="ident" id="5564029">fn</span>&nbsp;<span class="op" id="5564032">:=</span>&nbsp;<span class="ident" id="5564035">rowsCloseHook</span><span class="op" id="5564048">;</span>&nbsp;<span class="ident" id="5564050">fn</span>&nbsp;<span class="op" id="5564053">!=</span>&nbsp;<span class="ident" id="5564056">nil</span>&nbsp;<span class="op" id="5564060">{</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5564064">fn</span><span class="op" id="5564066">(</span><span class="ident" id="5564067">rs</span><span class="op" id="5564069">,</span>&nbsp;<span class="op" id="5564071">&amp;</span><span class="ident" id="5564072">err</span><span class="op" id="5564075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5564078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564081">if</span>&nbsp;<span class="ident" id="5564084">rs</span><span class="op" id="5564086">.</span><span class="ident" id="5564087">closeStmt</span>&nbsp;<span class="op" id="5564097">!=</span>&nbsp;<span class="ident" id="5564100">nil</span>&nbsp;<span class="op" id="5564104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5564108">rs</span><span class="op" id="5564110">.</span><span class="ident" id="5564111">closeStmt</span><span class="op" id="5564120">.</span><span class="ident" id="5564121">Close</span><span class="op" id="5564126">(</span><span class="op" id="5564127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5564130">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5564133">rs</span><span class="op" id="5564135">.</span><span class="ident" id="5564136">releaseConn</span><span class="op" id="5564147">(</span><span class="ident" id="5564148">err</span><span class="op" id="5564151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564154">return</span>&nbsp;<span class="ident" id="5564161">err</span><br>
<span class="lineno"></span><span class="op" id="5564165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5564168">//&nbsp;Row&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;QueryRow&nbsp;to&nbsp;select&nbsp;a&nbsp;single&nbsp;row.</span><br>
<span class="lineno">1675</span><span class="keyword" id="5564233">type</span>&nbsp;<span class="ident" id="5564238">Row</span>&nbsp;<span class="keyword" id="5564242">struct</span>&nbsp;<span class="op" id="5564249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5564252">//&nbsp;One&nbsp;of&nbsp;these&nbsp;two&nbsp;will&nbsp;be&nbsp;non-nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5564290">err</span>&nbsp;&nbsp;<span class="builtintype" id="5564295">error</span>&nbsp;<span class="comment" id="5564301">//&nbsp;deferred&nbsp;error&nbsp;for&nbsp;easy&nbsp;chaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5564338">rows</span>&nbsp;<span class="op" id="5564343">*</span><span class="ident" id="5564344">Rows</span><br>
<span class="lineno"></span><span class="op" id="5564349">}</span><br>
<span class="lineno">1680</span><br>
<span class="lineno"></span><span class="comment" id="5564352">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;from&nbsp;the&nbsp;matched&nbsp;row&nbsp;into&nbsp;the&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="5564416">//&nbsp;pointed&nbsp;at&nbsp;by&nbsp;dest.&nbsp;&nbsp;If&nbsp;more&nbsp;than&nbsp;one&nbsp;row&nbsp;matches&nbsp;the&nbsp;query,</span><br>
<span class="lineno"></span><span class="comment" id="5564480">//&nbsp;Scan&nbsp;uses&nbsp;the&nbsp;first&nbsp;row&nbsp;and&nbsp;discards&nbsp;the&nbsp;rest.&nbsp;&nbsp;If&nbsp;no&nbsp;row&nbsp;matches</span><br>
<span class="lineno"></span><span class="comment" id="5564549">//&nbsp;the&nbsp;query,&nbsp;Scan&nbsp;returns&nbsp;ErrNoRows.</span><br>
<span class="lineno">1685</span><span class="keyword" id="5564587">func</span>&nbsp;<span class="op" id="5564592">(</span><span class="ident" id="5564593">r</span>&nbsp;<span class="op" id="5564595">*</span><span class="ident" id="5564596">Row</span><span class="op" id="5564599">)</span>&nbsp;<span class="ident" id="5564601">Scan</span><span class="op" id="5564605">(</span><span class="ident" id="5564606">dest</span>&nbsp;<span class="op" id="5564611">...</span><span class="keyword" id="5564614">interface</span><span class="op" id="5564623">{</span><span class="op" id="5564624">}</span><span class="op" id="5564625">)</span>&nbsp;<span class="builtintype" id="5564627">error</span>&nbsp;<span class="op" id="5564633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564636">if</span>&nbsp;<span class="ident" id="5564639">r</span><span class="op" id="5564640">.</span><span class="ident" id="5564641">err</span>&nbsp;<span class="op" id="5564645">!=</span>&nbsp;<span class="ident" id="5564648">nil</span>&nbsp;<span class="op" id="5564652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564656">return</span>&nbsp;<span class="ident" id="5564663">r</span><span class="op" id="5564664">.</span><span class="ident" id="5564665">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5564670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5564674">//&nbsp;TODO(bradfitz):&nbsp;for&nbsp;now&nbsp;we&nbsp;need&nbsp;to&nbsp;defensively&nbsp;clone&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5564735">//&nbsp;[]byte&nbsp;that&nbsp;the&nbsp;driver&nbsp;returned&nbsp;(not&nbsp;permitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5564787">//&nbsp;*RawBytes&nbsp;in&nbsp;Rows.Scan),&nbsp;since&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5564843">//&nbsp;the&nbsp;Rows&nbsp;in&nbsp;our&nbsp;defer,&nbsp;when&nbsp;we&nbsp;return&nbsp;from&nbsp;this&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5564905">//&nbsp;the&nbsp;contract&nbsp;with&nbsp;the&nbsp;driver.Next(...)&nbsp;interface&nbsp;is&nbsp;that&nbsp;it</span><br>
<span class="lineno">1695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5564969">//&nbsp;can&nbsp;return&nbsp;slices&nbsp;into&nbsp;read-only&nbsp;temporary&nbsp;memory&nbsp;that&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5565030">//&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;Scan/Close.&nbsp;&nbsp;But&nbsp;the&nbsp;TODO&nbsp;is&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5565094">//&nbsp;for&nbsp;a&nbsp;lot&nbsp;of&nbsp;drivers,&nbsp;this&nbsp;copy&nbsp;will&nbsp;be&nbsp;unnecessary.&nbsp;&nbsp;We</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5565155">//&nbsp;should&nbsp;provide&nbsp;an&nbsp;optional&nbsp;interface&nbsp;for&nbsp;drivers&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5565211">//&nbsp;implement&nbsp;to&nbsp;say,&nbsp;&#34;don&#39;t&nbsp;worry,&nbsp;the&nbsp;[]bytes&nbsp;that&nbsp;I&nbsp;return</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5565273">//&nbsp;from&nbsp;Next&nbsp;will&nbsp;not&nbsp;be&nbsp;modified&nbsp;again.&#34;&nbsp;(for&nbsp;instance,&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5565334">//&nbsp;they&nbsp;were&nbsp;obtained&nbsp;from&nbsp;the&nbsp;network&nbsp;anyway)&nbsp;But&nbsp;for&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5565397">//&nbsp;don&#39;t&nbsp;care.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565413">defer</span>&nbsp;<span class="ident" id="5565419">r</span><span class="op" id="5565420">.</span><span class="ident" id="5565421">rows</span><span class="op" id="5565425">.</span><span class="ident" id="5565426">Close</span><span class="op" id="5565431">(</span><span class="op" id="5565432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565435">for</span>&nbsp;<span class="ident" id="5565439">_</span><span class="op" id="5565440">,</span>&nbsp;<span class="ident" id="5565442">dp</span>&nbsp;<span class="op" id="5565445">:=</span>&nbsp;<span class="keyword" id="5565448">range</span>&nbsp;<span class="ident" id="5565454">dest</span>&nbsp;<span class="op" id="5565459">{</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565463">if</span>&nbsp;<span class="ident" id="5565466">_</span><span class="op" id="5565467">,</span>&nbsp;<span class="ident" id="5565469">ok</span>&nbsp;<span class="op" id="5565472">:=</span>&nbsp;<span class="ident" id="5565475">dp</span><span class="op" id="5565477">.</span><span class="op" id="5565478">(</span><span class="op" id="5565479">*</span><span class="ident" id="5565480">RawBytes</span><span class="op" id="5565488">)</span><span class="op" id="5565489">;</span>&nbsp;<span class="ident" id="5565491">ok</span>&nbsp;<span class="op" id="5565494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565499">return</span>&nbsp;<span class="ident" id="5565506">errors</span><span class="op" id="5565512">.</span><span class="ident" id="5565513">New</span><span class="op" id="5565516">(</span><span class="string" id="5565517">&#34;sql:&nbsp;RawBytes&nbsp;isn&#39;t&nbsp;allowed&nbsp;on&nbsp;Row.Scan&#34;</span><span class="op" id="5565558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5565562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5565565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565569">if</span>&nbsp;<span class="op" id="5565572">!</span><span class="ident" id="5565573">r</span><span class="op" id="5565574">.</span><span class="ident" id="5565575">rows</span><span class="op" id="5565579">.</span><span class="ident" id="5565580">Next</span><span class="op" id="5565584">(</span><span class="op" id="5565585">)</span>&nbsp;<span class="op" id="5565587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565591">if</span>&nbsp;<span class="ident" id="5565594">err</span>&nbsp;<span class="op" id="5565598">:=</span>&nbsp;<span class="ident" id="5565601">r</span><span class="op" id="5565602">.</span><span class="ident" id="5565603">rows</span><span class="op" id="5565607">.</span><span class="ident" id="5565608">Err</span><span class="op" id="5565611">(</span><span class="op" id="5565612">)</span><span class="op" id="5565613">;</span>&nbsp;<span class="ident" id="5565615">err</span>&nbsp;<span class="op" id="5565619">!=</span>&nbsp;<span class="ident" id="5565622">nil</span>&nbsp;<span class="op" id="5565626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565631">return</span>&nbsp;<span class="ident" id="5565638">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5565644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565648">return</span>&nbsp;<span class="ident" id="5565655">ErrNoRows</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5565666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5565669">err</span>&nbsp;<span class="op" id="5565673">:=</span>&nbsp;<span class="ident" id="5565676">r</span><span class="op" id="5565677">.</span><span class="ident" id="5565678">rows</span><span class="op" id="5565682">.</span><span class="ident" id="5565683">Scan</span><span class="op" id="5565687">(</span><span class="ident" id="5565688">dest</span><span class="op" id="5565692">...</span><span class="op" id="5565695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565698">if</span>&nbsp;<span class="ident" id="5565701">err</span>&nbsp;<span class="op" id="5565705">!=</span>&nbsp;<span class="ident" id="5565708">nil</span>&nbsp;<span class="op" id="5565712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565716">return</span>&nbsp;<span class="ident" id="5565723">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5565728">}</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5565731">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;query&nbsp;can&nbsp;be&nbsp;processed&nbsp;to&nbsp;completion&nbsp;with&nbsp;no&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565802">if</span>&nbsp;<span class="ident" id="5565805">err</span>&nbsp;<span class="op" id="5565809">:=</span>&nbsp;<span class="ident" id="5565812">r</span><span class="op" id="5565813">.</span><span class="ident" id="5565814">rows</span><span class="op" id="5565818">.</span><span class="ident" id="5565819">Close</span><span class="op" id="5565824">(</span><span class="op" id="5565825">)</span><span class="op" id="5565826">;</span>&nbsp;<span class="ident" id="5565828">err</span>&nbsp;<span class="op" id="5565832">!=</span>&nbsp;<span class="ident" id="5565835">nil</span>&nbsp;<span class="op" id="5565839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565843">return</span>&nbsp;<span class="ident" id="5565850">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5565855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565859">return</span>&nbsp;<span class="ident" id="5565866">nil</span><br>
<span class="lineno"></span><span class="op" id="5565870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5565873">//&nbsp;A&nbsp;Result&nbsp;summarizes&nbsp;an&nbsp;executed&nbsp;SQL&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="5565921">type</span>&nbsp;<span class="ident" id="5565926">Result</span>&nbsp;<span class="keyword" id="5565933">interface</span>&nbsp;<span class="op" id="5565943">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5565946">//&nbsp;LastInsertId&nbsp;returns&nbsp;the&nbsp;integer&nbsp;generated&nbsp;by&nbsp;the&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5566009">//&nbsp;in&nbsp;response&nbsp;to&nbsp;a&nbsp;command.&nbsp;Typically&nbsp;this&nbsp;will&nbsp;be&nbsp;from&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5566070">//&nbsp;&#34;auto&nbsp;increment&#34;&nbsp;column&nbsp;when&nbsp;inserting&nbsp;a&nbsp;new&nbsp;row.&nbsp;Not&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5566132">//&nbsp;databases&nbsp;support&nbsp;this&nbsp;feature,&nbsp;and&nbsp;the&nbsp;syntax&nbsp;of&nbsp;such</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5566191">//&nbsp;statements&nbsp;varies.</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5566214">LastInsertId</span><span class="op" id="5566226">(</span><span class="op" id="5566227">)</span>&nbsp;<span class="op" id="5566229">(</span><span class="ident" id="5566230">int64</span><span class="op" id="5566235">,</span>&nbsp;<span class="builtintype" id="5566237">error</span><span class="op" id="5566242">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5566246">//&nbsp;RowsAffected&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;rows&nbsp;affected&nbsp;by&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5566305">//&nbsp;update,&nbsp;insert,&nbsp;or&nbsp;delete.&nbsp;Not&nbsp;every&nbsp;database&nbsp;or&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5566367">//&nbsp;driver&nbsp;may&nbsp;support&nbsp;this.</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5566396">RowsAffected</span><span class="op" id="5566408">(</span><span class="op" id="5566409">)</span>&nbsp;<span class="op" id="5566411">(</span><span class="ident" id="5566412">int64</span><span class="op" id="5566417">,</span>&nbsp;<span class="builtintype" id="5566419">error</span><span class="op" id="5566424">)</span><br>
<span class="lineno"></span><span class="op" id="5566426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5566429">type</span>&nbsp;<span class="ident" id="5566434">driverResult</span>&nbsp;<span class="keyword" id="5566447">struct</span>&nbsp;<span class="op" id="5566454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5566457">sync</span><span class="op" id="5566461">.</span><span class="ident" id="5566462">Locker</span>&nbsp;<span class="comment" id="5566469">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5566489">resi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5566501">driver</span><span class="op" id="5566507">.</span><span class="ident" id="5566508">Result</span><br>
<span class="lineno"></span><span class="op" id="5566515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5566518">func</span>&nbsp;<span class="op" id="5566523">(</span><span class="ident" id="5566524">dr</span>&nbsp;<span class="ident" id="5566527">driverResult</span><span class="op" id="5566539">)</span>&nbsp;<span class="ident" id="5566541">LastInsertId</span><span class="op" id="5566553">(</span><span class="op" id="5566554">)</span>&nbsp;<span class="op" id="5566556">(</span><span class="ident" id="5566557">int64</span><span class="op" id="5566562">,</span>&nbsp;<span class="builtintype" id="5566564">error</span><span class="op" id="5566569">)</span>&nbsp;<span class="op" id="5566571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5566574">dr</span><span class="op" id="5566576">.</span><span class="ident" id="5566577">Lock</span><span class="op" id="5566581">(</span><span class="op" id="5566582">)</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5566585">defer</span>&nbsp;<span class="ident" id="5566591">dr</span><span class="op" id="5566593">.</span><span class="ident" id="5566594">Unlock</span><span class="op" id="5566600">(</span><span class="op" id="5566601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5566604">return</span>&nbsp;<span class="ident" id="5566611">dr</span><span class="op" id="5566613">.</span><span class="ident" id="5566614">resi</span><span class="op" id="5566618">.</span><span class="ident" id="5566619">LastInsertId</span><span class="op" id="5566631">(</span><span class="op" id="5566632">)</span><br>
<span class="lineno"></span><span class="op" id="5566634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5566637">func</span>&nbsp;<span class="op" id="5566642">(</span><span class="ident" id="5566643">dr</span>&nbsp;<span class="ident" id="5566646">driverResult</span><span class="op" id="5566658">)</span>&nbsp;<span class="ident" id="5566660">RowsAffected</span><span class="op" id="5566672">(</span><span class="op" id="5566673">)</span>&nbsp;<span class="op" id="5566675">(</span><span class="ident" id="5566676">int64</span><span class="op" id="5566681">,</span>&nbsp;<span class="builtintype" id="5566683">error</span><span class="op" id="5566688">)</span>&nbsp;<span class="op" id="5566690">{</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5566693">dr</span><span class="op" id="5566695">.</span><span class="ident" id="5566696">Lock</span><span class="op" id="5566700">(</span><span class="op" id="5566701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5566704">defer</span>&nbsp;<span class="ident" id="5566710">dr</span><span class="op" id="5566712">.</span><span class="ident" id="5566713">Unlock</span><span class="op" id="5566719">(</span><span class="op" id="5566720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5566723">return</span>&nbsp;<span class="ident" id="5566730">dr</span><span class="op" id="5566732">.</span><span class="ident" id="5566733">resi</span><span class="op" id="5566737">.</span><span class="ident" id="5566738">RowsAffected</span><span class="op" id="5566750">(</span><span class="op" id="5566751">)</span><br>
<span class="lineno"></span><span class="op" id="5566753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span><span class="keyword" id="5566756">func</span>&nbsp;<span class="ident" id="5566761">stack</span><span class="op" id="5566766">(</span><span class="op" id="5566767">)</span>&nbsp;<span class="builtintype" id="5566769">string</span>&nbsp;<span class="op" id="5566776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5566779">var</span>&nbsp;<span class="ident" id="5566783">buf</span>&nbsp;<span class="op" id="5566787">[</span><span class="num" id="5566788">2</span>&nbsp;<span class="op" id="5566790">&lt;&lt;</span>&nbsp;<span class="num" id="5566793">10</span><span class="op" id="5566795">]</span><span class="builtintype" id="5566796">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5566802">return</span>&nbsp;<span class="builtintype" id="5566809">string</span><span class="op" id="5566815">(</span><span class="ident" id="5566816">buf</span><span class="op" id="5566819">[</span><span class="op" id="5566820">:</span><span class="ident" id="5566821">runtime</span><span class="op" id="5566828">.</span><span class="ident" id="5566829">Stack</span><span class="op" id="5566834">(</span><span class="ident" id="5566835">buf</span><span class="op" id="5566838">[</span><span class="op" id="5566839">:</span><span class="op" id="5566840">]</span><span class="op" id="5566841">,</span>&nbsp;<span class="builtintype" id="5566843">false</span><span class="op" id="5566848">)</span><span class="op" id="5566849">]</span><span class="op" id="5566850">)</span><br>
<span class="lineno"></span><span class="op" id="5566852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1765</span><span class="comment" id="5566855">//&nbsp;withLock&nbsp;runs&nbsp;while&nbsp;holding&nbsp;lk.</span><br>
<span class="lineno"></span><span class="keyword" id="5566890">func</span>&nbsp;<span class="ident" id="5566895">withLock</span><span class="op" id="5566903">(</span><span class="ident" id="5566904">lk</span>&nbsp;<span class="ident" id="5566907">sync</span><span class="op" id="5566911">.</span><span class="ident" id="5566912">Locker</span><span class="op" id="5566918">,</span>&nbsp;<span class="ident" id="5566920">fn</span>&nbsp;<span class="keyword" id="5566923">func</span><span class="op" id="5566927">(</span><span class="op" id="5566928">)</span><span class="op" id="5566929">)</span>&nbsp;<span class="op" id="5566931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5566934">lk</span><span class="op" id="5566936">.</span><span class="ident" id="5566937">Lock</span><span class="op" id="5566941">(</span><span class="op" id="5566942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5566945">fn</span><span class="op" id="5566947">(</span><span class="op" id="5566948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5566951">lk</span><span class="op" id="5566953">.</span><span class="ident" id="5566954">Unlock</span><span class="op" id="5566960">(</span><span class="op" id="5566961">)</span><br>
<span class="lineno">1770</span><span class="op" id="5566963">}</span>
</div>
</body>
</html>
