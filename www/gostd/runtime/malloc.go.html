<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html" class="current">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1553798">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1553853">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1553907">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1553958">package</span>&nbsp;<span class="ident" id="1553966">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1553975">import</span>&nbsp;<span class="op" id="1553982">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1553985">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1553994">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1553997">const</span>&nbsp;<span class="op" id="1554003">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554006">debugMalloc</span>&nbsp;<span class="op" id="1554018">=</span>&nbsp;<span class="builtintype" id="1554020">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554028">flagNoScan</span>&nbsp;<span class="op" id="1554039">=</span>&nbsp;<span class="ident" id="1554041">_FlagNoScan</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554054">flagNoZero</span>&nbsp;<span class="op" id="1554065">=</span>&nbsp;<span class="ident" id="1554067">_FlagNoZero</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554081">maxTinySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1554095">=</span>&nbsp;<span class="ident" id="1554097">_TinySize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554108">tinySizeClass</span>&nbsp;<span class="op" id="1554122">=</span>&nbsp;<span class="ident" id="1554124">_TinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554140">maxSmallSize</span>&nbsp;&nbsp;<span class="op" id="1554154">=</span>&nbsp;<span class="ident" id="1554156">_MaxSmallSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554172">pageShift</span>&nbsp;<span class="op" id="1554182">=</span>&nbsp;<span class="ident" id="1554184">_PageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554196">pageSize</span>&nbsp;&nbsp;<span class="op" id="1554206">=</span>&nbsp;<span class="ident" id="1554208">_PageSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554219">pageMask</span>&nbsp;&nbsp;<span class="op" id="1554229">=</span>&nbsp;<span class="ident" id="1554231">_PageMask</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554243">bitsPerPointer</span>&nbsp;&nbsp;<span class="op" id="1554259">=</span>&nbsp;<span class="ident" id="1554261">_BitsPerPointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554278">bitsMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554294">=</span>&nbsp;<span class="ident" id="1554296">_BitsMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554307">pointersPerByte</span>&nbsp;<span class="op" id="1554323">=</span>&nbsp;<span class="ident" id="1554325">_PointersPerByte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554343">maxGCMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554359">=</span>&nbsp;<span class="ident" id="1554361">_MaxGCMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554373">bitsDead</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554389">=</span>&nbsp;<span class="ident" id="1554391">_BitsDead</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554402">bitsPointer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554418">=</span>&nbsp;<span class="ident" id="1554420">_BitsPointer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554435">mSpanInUse</span>&nbsp;<span class="op" id="1554446">=</span>&nbsp;<span class="ident" id="1554448">_MSpanInUse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554462">concurrentSweep</span>&nbsp;<span class="op" id="1554478">=</span>&nbsp;<span class="ident" id="1554480">_ConcurrentSweep</span>&nbsp;<span class="op" id="1554497">!=</span>&nbsp;<span class="num" id="1554500">0</span><br>
<span class="lineno">35</span><span class="op" id="1554502">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1554505">//&nbsp;Page&nbsp;number&nbsp;(address&gt;&gt;pageShift)</span><br>
<span class="lineno"></span><span class="keyword" id="1554541">type</span>&nbsp;<span class="ident" id="1554546">pageID</span>&nbsp;<span class="builtintype" id="1554553">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1554562">//&nbsp;base&nbsp;address&nbsp;for&nbsp;all&nbsp;0-byte&nbsp;allocations</span><br>
<span class="lineno"></span><span class="keyword" id="1554605">var</span>&nbsp;<span class="ident" id="1554609">zerobase</span>&nbsp;<span class="builtintype" id="1554618">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1554627">//&nbsp;Allocate&nbsp;an&nbsp;object&nbsp;of&nbsp;size&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="1554664">//&nbsp;Small&nbsp;objects&nbsp;are&nbsp;allocated&nbsp;from&nbsp;the&nbsp;per-P&nbsp;cache&#39;s&nbsp;free&nbsp;lists.</span><br>
<span class="lineno">45</span><span class="comment" id="1554730">//&nbsp;Large&nbsp;objects&nbsp;(&gt;&nbsp;32&nbsp;kB)&nbsp;are&nbsp;allocated&nbsp;straight&nbsp;from&nbsp;the&nbsp;heap.</span><br>
<span class="lineno"></span><span class="keyword" id="1554795">func</span>&nbsp;<span class="ident" id="1554800">mallocgc</span><span class="op" id="1554808">(</span><span class="ident" id="1554809">size</span>&nbsp;<span class="builtintype" id="1554814">uintptr</span><span class="op" id="1554821">,</span>&nbsp;<span class="ident" id="1554823">typ</span>&nbsp;<span class="op" id="1554827">*</span><span class="ident" id="1554828">_type</span><span class="op" id="1554833">,</span>&nbsp;<span class="ident" id="1554835">flags</span>&nbsp;<span class="builtintype" id="1554841">uint32</span><span class="op" id="1554847">)</span>&nbsp;<span class="ident" id="1554849">unsafe</span><span class="op" id="1554855">.</span><span class="ident" id="1554856">Pointer</span>&nbsp;<span class="op" id="1554864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554867">if</span>&nbsp;<span class="ident" id="1554870">size</span>&nbsp;<span class="op" id="1554875">==</span>&nbsp;<span class="num" id="1554878">0</span>&nbsp;<span class="op" id="1554880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554884">return</span>&nbsp;<span class="ident" id="1554891">unsafe</span><span class="op" id="1554897">.</span><span class="ident" id="1554898">Pointer</span><span class="op" id="1554905">(</span><span class="op" id="1554906">&amp;</span><span class="ident" id="1554907">zerobase</span><span class="op" id="1554915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554918">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554921">size0</span>&nbsp;<span class="op" id="1554927">:=</span>&nbsp;<span class="ident" id="1554930">size</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554937">if</span>&nbsp;<span class="ident" id="1554940">flags</span><span class="op" id="1554945">&amp;</span><span class="ident" id="1554946">flagNoScan</span>&nbsp;<span class="op" id="1554957">==</span>&nbsp;<span class="num" id="1554960">0</span>&nbsp;<span class="op" id="1554962">&amp;&amp;</span>&nbsp;<span class="ident" id="1554965">typ</span>&nbsp;<span class="op" id="1554969">==</span>&nbsp;<span class="builtintype" id="1554972">nil</span>&nbsp;<span class="op" id="1554976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554980">gothrow</span><span class="op" id="1554987">(</span><span class="string" id="1554988">&#34;malloc&nbsp;missing&nbsp;type&#34;</span><span class="op" id="1555009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555012">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555016">//&nbsp;This&nbsp;function&nbsp;must&nbsp;be&nbsp;atomic&nbsp;wrt&nbsp;GC,&nbsp;but&nbsp;for&nbsp;performance&nbsp;reasons</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555085">//&nbsp;we&nbsp;don&#39;t&nbsp;acquirem/releasem&nbsp;on&nbsp;fast&nbsp;path.&nbsp;The&nbsp;code&nbsp;below&nbsp;does&nbsp;not&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555159">//&nbsp;split&nbsp;stack&nbsp;checks,&nbsp;so&nbsp;it&nbsp;can&#39;t&nbsp;be&nbsp;preempted&nbsp;by&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555215">//&nbsp;Functions&nbsp;like&nbsp;roundup/add&nbsp;are&nbsp;inlined.&nbsp;And&nbsp;onM/racemalloc&nbsp;are&nbsp;nosplit.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555291">//&nbsp;If&nbsp;debugMalloc&nbsp;=&nbsp;true,&nbsp;these&nbsp;assumptions&nbsp;are&nbsp;checked&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555355">if</span>&nbsp;<span class="ident" id="1555358">debugMalloc</span>&nbsp;<span class="op" id="1555370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555374">mp</span>&nbsp;<span class="op" id="1555377">:=</span>&nbsp;<span class="ident" id="1555380">acquirem</span><span class="op" id="1555388">(</span><span class="op" id="1555389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555393">if</span>&nbsp;<span class="ident" id="1555396">mp</span><span class="op" id="1555398">.</span><span class="ident" id="1555399">mallocing</span>&nbsp;<span class="op" id="1555409">!=</span>&nbsp;<span class="num" id="1555412">0</span>&nbsp;<span class="op" id="1555414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555419">gothrow</span><span class="op" id="1555426">(</span><span class="string" id="1555427">&#34;malloc&nbsp;deadlock&#34;</span><span class="op" id="1555444">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555452">mp</span><span class="op" id="1555454">.</span><span class="ident" id="1555455">mallocing</span>&nbsp;<span class="op" id="1555465">=</span>&nbsp;<span class="num" id="1555467">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555471">if</span>&nbsp;<span class="ident" id="1555474">mp</span><span class="op" id="1555476">.</span><span class="ident" id="1555477">curg</span>&nbsp;<span class="op" id="1555482">!=</span>&nbsp;<span class="builtintype" id="1555485">nil</span>&nbsp;<span class="op" id="1555489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555494">mp</span><span class="op" id="1555496">.</span><span class="ident" id="1555497">curg</span><span class="op" id="1555501">.</span><span class="ident" id="1555502">stackguard0</span>&nbsp;<span class="op" id="1555514">=</span>&nbsp;<span class="op" id="1555516">^</span><span class="builtintype" id="1555517">uintptr</span><span class="op" id="1555524">(</span><span class="num" id="1555525">0xfff</span><span class="op" id="1555530">)</span>&nbsp;<span class="op" id="1555532">|</span>&nbsp;<span class="num" id="1555534">0xbad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555542">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555549">c</span>&nbsp;<span class="op" id="1555551">:=</span>&nbsp;<span class="ident" id="1555554">gomcache</span><span class="op" id="1555562">(</span><span class="op" id="1555563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555566">var</span>&nbsp;<span class="ident" id="1555570">s</span>&nbsp;<span class="op" id="1555572">*</span><span class="ident" id="1555573">mspan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555580">var</span>&nbsp;<span class="ident" id="1555584">x</span>&nbsp;<span class="ident" id="1555586">unsafe</span><span class="op" id="1555592">.</span><span class="ident" id="1555593">Pointer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555602">if</span>&nbsp;<span class="ident" id="1555605">size</span>&nbsp;<span class="op" id="1555610">&lt;=</span>&nbsp;<span class="ident" id="1555613">maxSmallSize</span>&nbsp;<span class="op" id="1555626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555630">if</span>&nbsp;<span class="ident" id="1555633">flags</span><span class="op" id="1555638">&amp;</span><span class="ident" id="1555639">flagNoScan</span>&nbsp;<span class="op" id="1555650">!=</span>&nbsp;<span class="num" id="1555653">0</span>&nbsp;<span class="op" id="1555655">&amp;&amp;</span>&nbsp;<span class="ident" id="1555658">size</span>&nbsp;<span class="op" id="1555663">&lt;</span>&nbsp;<span class="ident" id="1555665">maxTinySize</span>&nbsp;<span class="op" id="1555677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555682">//&nbsp;Tiny&nbsp;allocator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555704">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555710">//&nbsp;Tiny&nbsp;allocator&nbsp;combines&nbsp;several&nbsp;tiny&nbsp;allocation&nbsp;requests</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555773">//&nbsp;into&nbsp;a&nbsp;single&nbsp;memory&nbsp;block.&nbsp;The&nbsp;resulting&nbsp;memory&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555834">//&nbsp;is&nbsp;freed&nbsp;when&nbsp;all&nbsp;subobjects&nbsp;are&nbsp;unreachable.&nbsp;The&nbsp;subobjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555901">//&nbsp;must&nbsp;be&nbsp;FlagNoScan&nbsp;(don&#39;t&nbsp;have&nbsp;pointers),&nbsp;this&nbsp;ensures&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555967">//&nbsp;the&nbsp;amount&nbsp;of&nbsp;potentially&nbsp;wasted&nbsp;memory&nbsp;is&nbsp;bounded.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556025">//</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556031">//&nbsp;Size&nbsp;of&nbsp;the&nbsp;memory&nbsp;block&nbsp;used&nbsp;for&nbsp;combining&nbsp;(maxTinySize)&nbsp;is&nbsp;tunable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556107">//&nbsp;Current&nbsp;setting&nbsp;is&nbsp;16&nbsp;bytes,&nbsp;which&nbsp;relates&nbsp;to&nbsp;2x&nbsp;worst&nbsp;case&nbsp;memory</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556180">//&nbsp;wastage&nbsp;(when&nbsp;all&nbsp;but&nbsp;one&nbsp;subobjects&nbsp;are&nbsp;unreachable).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556241">//&nbsp;8&nbsp;bytes&nbsp;would&nbsp;result&nbsp;in&nbsp;no&nbsp;wastage&nbsp;at&nbsp;all,&nbsp;but&nbsp;provides&nbsp;less</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556308">//&nbsp;opportunities&nbsp;for&nbsp;combining.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556343">//&nbsp;32&nbsp;bytes&nbsp;provides&nbsp;more&nbsp;opportunities&nbsp;for&nbsp;combining,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556401">//&nbsp;but&nbsp;can&nbsp;lead&nbsp;to&nbsp;4x&nbsp;worst&nbsp;case&nbsp;wastage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556446">//&nbsp;The&nbsp;best&nbsp;case&nbsp;winning&nbsp;is&nbsp;8x&nbsp;regardless&nbsp;of&nbsp;block&nbsp;size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556506">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556512">//&nbsp;Objects&nbsp;obtained&nbsp;from&nbsp;tiny&nbsp;allocator&nbsp;must&nbsp;not&nbsp;be&nbsp;freed&nbsp;explicitly.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556585">//&nbsp;So&nbsp;when&nbsp;an&nbsp;object&nbsp;will&nbsp;be&nbsp;freed&nbsp;explicitly,&nbsp;we&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556650">//&nbsp;its&nbsp;size&nbsp;&gt;=&nbsp;maxTinySize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556681">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556687">//&nbsp;SetFinalizer&nbsp;has&nbsp;a&nbsp;special&nbsp;case&nbsp;for&nbsp;objects&nbsp;potentially&nbsp;coming</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556756">//&nbsp;from&nbsp;tiny&nbsp;allocator,&nbsp;it&nbsp;such&nbsp;case&nbsp;it&nbsp;allows&nbsp;to&nbsp;set&nbsp;finalizers</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556824">//&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte&nbsp;of&nbsp;a&nbsp;memory&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556867">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556873">//&nbsp;The&nbsp;main&nbsp;targets&nbsp;of&nbsp;tiny&nbsp;allocator&nbsp;are&nbsp;small&nbsp;strings&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556936">//&nbsp;standalone&nbsp;escaping&nbsp;variables.&nbsp;On&nbsp;a&nbsp;json&nbsp;benchmark</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556993">//&nbsp;the&nbsp;allocator&nbsp;reduces&nbsp;number&nbsp;of&nbsp;allocations&nbsp;by&nbsp;~12%&nbsp;and</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1557055">//&nbsp;reduces&nbsp;heap&nbsp;size&nbsp;by&nbsp;~20%.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557088">tinysize</span>&nbsp;<span class="op" id="1557097">:=</span>&nbsp;<span class="builtintype" id="1557100">uintptr</span><span class="op" id="1557107">(</span><span class="ident" id="1557108">c</span><span class="op" id="1557109">.</span><span class="ident" id="1557110">tinysize</span><span class="op" id="1557118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557123">if</span>&nbsp;<span class="ident" id="1557126">size</span>&nbsp;<span class="op" id="1557131">&lt;=</span>&nbsp;<span class="ident" id="1557134">tinysize</span>&nbsp;<span class="op" id="1557143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557149">tiny</span>&nbsp;<span class="op" id="1557154">:=</span>&nbsp;<span class="ident" id="1557157">unsafe</span><span class="op" id="1557163">.</span><span class="ident" id="1557164">Pointer</span><span class="op" id="1557171">(</span><span class="ident" id="1557172">c</span><span class="op" id="1557173">.</span><span class="ident" id="1557174">tiny</span><span class="op" id="1557178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1557184">//&nbsp;Align&nbsp;tiny&nbsp;pointer&nbsp;for&nbsp;required&nbsp;(conservative)&nbsp;alignment.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557249">if</span>&nbsp;<span class="ident" id="1557252">size</span><span class="op" id="1557256">&amp;</span><span class="num" id="1557257">7</span>&nbsp;<span class="op" id="1557259">==</span>&nbsp;<span class="num" id="1557262">0</span>&nbsp;<span class="op" id="1557264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557271">tiny</span>&nbsp;<span class="op" id="1557276">=</span>&nbsp;<span class="ident" id="1557278">roundup</span><span class="op" id="1557285">(</span><span class="ident" id="1557286">tiny</span><span class="op" id="1557290">,</span>&nbsp;<span class="num" id="1557292">8</span><span class="op" id="1557293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557299">}</span>&nbsp;<span class="keyword" id="1557301">else</span>&nbsp;<span class="keyword" id="1557306">if</span>&nbsp;<span class="ident" id="1557309">size</span><span class="op" id="1557313">&amp;</span><span class="num" id="1557314">3</span>&nbsp;<span class="op" id="1557316">==</span>&nbsp;<span class="num" id="1557319">0</span>&nbsp;<span class="op" id="1557321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557328">tiny</span>&nbsp;<span class="op" id="1557333">=</span>&nbsp;<span class="ident" id="1557335">roundup</span><span class="op" id="1557342">(</span><span class="ident" id="1557343">tiny</span><span class="op" id="1557347">,</span>&nbsp;<span class="num" id="1557349">4</span><span class="op" id="1557350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557356">}</span>&nbsp;<span class="keyword" id="1557358">else</span>&nbsp;<span class="keyword" id="1557363">if</span>&nbsp;<span class="ident" id="1557366">size</span><span class="op" id="1557370">&amp;</span><span class="num" id="1557371">1</span>&nbsp;<span class="op" id="1557373">==</span>&nbsp;<span class="num" id="1557376">0</span>&nbsp;<span class="op" id="1557378">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557385">tiny</span>&nbsp;<span class="op" id="1557390">=</span>&nbsp;<span class="ident" id="1557392">roundup</span><span class="op" id="1557399">(</span><span class="ident" id="1557400">tiny</span><span class="op" id="1557404">,</span>&nbsp;<span class="num" id="1557406">2</span><span class="op" id="1557407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557419">size1</span>&nbsp;<span class="op" id="1557425">:=</span>&nbsp;<span class="ident" id="1557428">size</span>&nbsp;<span class="op" id="1557433">+</span>&nbsp;<span class="op" id="1557435">(</span><span class="builtintype" id="1557436">uintptr</span><span class="op" id="1557443">(</span><span class="ident" id="1557444">tiny</span><span class="op" id="1557448">)</span>&nbsp;<span class="op" id="1557450">-</span>&nbsp;<span class="builtintype" id="1557452">uintptr</span><span class="op" id="1557459">(</span><span class="ident" id="1557460">unsafe</span><span class="op" id="1557466">.</span><span class="ident" id="1557467">Pointer</span><span class="op" id="1557474">(</span><span class="ident" id="1557475">c</span><span class="op" id="1557476">.</span><span class="ident" id="1557477">tiny</span><span class="op" id="1557481">)</span><span class="op" id="1557482">)</span><span class="op" id="1557483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557489">if</span>&nbsp;<span class="ident" id="1557492">size1</span>&nbsp;<span class="op" id="1557498">&lt;=</span>&nbsp;<span class="ident" id="1557501">tinysize</span>&nbsp;<span class="op" id="1557510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1557517">//&nbsp;The&nbsp;object&nbsp;fits&nbsp;into&nbsp;existing&nbsp;tiny&nbsp;block.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557567">x</span>&nbsp;<span class="op" id="1557569">=</span>&nbsp;<span class="ident" id="1557571">tiny</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557581">c</span><span class="op" id="1557582">.</span><span class="ident" id="1557583">tiny</span>&nbsp;<span class="op" id="1557588">=</span>&nbsp;<span class="op" id="1557590">(</span><span class="op" id="1557591">*</span><span class="builtintype" id="1557592">byte</span><span class="op" id="1557596">)</span><span class="op" id="1557597">(</span><span class="ident" id="1557598">add</span><span class="op" id="1557601">(</span><span class="ident" id="1557602">x</span><span class="op" id="1557603">,</span>&nbsp;<span class="ident" id="1557605">size</span><span class="op" id="1557609">)</span><span class="op" id="1557610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557617">c</span><span class="op" id="1557618">.</span><span class="ident" id="1557619">tinysize</span>&nbsp;<span class="op" id="1557628">-=</span>&nbsp;<span class="builtintype" id="1557631">uintptr</span><span class="op" id="1557638">(</span><span class="ident" id="1557639">size1</span><span class="op" id="1557644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557651">c</span><span class="op" id="1557652">.</span><span class="ident" id="1557653">local_tinyallocs</span><span class="op" id="1557669">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557677">if</span>&nbsp;<span class="ident" id="1557680">debugMalloc</span>&nbsp;<span class="op" id="1557692">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557700">mp</span>&nbsp;<span class="op" id="1557703">:=</span>&nbsp;<span class="ident" id="1557706">acquirem</span><span class="op" id="1557714">(</span><span class="op" id="1557715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557723">if</span>&nbsp;<span class="ident" id="1557726">mp</span><span class="op" id="1557728">.</span><span class="ident" id="1557729">mallocing</span>&nbsp;<span class="op" id="1557739">==</span>&nbsp;<span class="num" id="1557742">0</span>&nbsp;<span class="op" id="1557744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557753">gothrow</span><span class="op" id="1557760">(</span><span class="string" id="1557761">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1557773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557789">mp</span><span class="op" id="1557791">.</span><span class="ident" id="1557792">mallocing</span>&nbsp;<span class="op" id="1557802">=</span>&nbsp;<span class="num" id="1557804">0</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557812">if</span>&nbsp;<span class="ident" id="1557815">mp</span><span class="op" id="1557817">.</span><span class="ident" id="1557818">curg</span>&nbsp;<span class="op" id="1557823">!=</span>&nbsp;<span class="builtintype" id="1557826">nil</span>&nbsp;<span class="op" id="1557830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557839">mp</span><span class="op" id="1557841">.</span><span class="ident" id="1557842">curg</span><span class="op" id="1557846">.</span><span class="ident" id="1557847">stackguard0</span>&nbsp;<span class="op" id="1557859">=</span>&nbsp;<span class="ident" id="1557861">mp</span><span class="op" id="1557863">.</span><span class="ident" id="1557864">curg</span><span class="op" id="1557868">.</span><span class="ident" id="1557869">stack</span><span class="op" id="1557874">.</span><span class="ident" id="1557875">lo</span>&nbsp;<span class="op" id="1557878">+</span>&nbsp;<span class="ident" id="1557880">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1557906">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1557963">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558019">releasem</span><span class="op" id="1558027">(</span><span class="ident" id="1558028">mp</span><span class="op" id="1558030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558038">releasem</span><span class="op" id="1558046">(</span><span class="ident" id="1558047">mp</span><span class="op" id="1558049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558063">return</span>&nbsp;<span class="ident" id="1558070">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558076">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1558086">//&nbsp;Allocate&nbsp;a&nbsp;new&nbsp;maxTinySize&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558126">s</span>&nbsp;<span class="op" id="1558128">=</span>&nbsp;<span class="ident" id="1558130">c</span><span class="op" id="1558131">.</span><span class="ident" id="1558132">alloc</span><span class="op" id="1558137">[</span><span class="ident" id="1558138">tinySizeClass</span><span class="op" id="1558151">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558156">v</span>&nbsp;<span class="op" id="1558158">:=</span>&nbsp;<span class="ident" id="1558161">s</span><span class="op" id="1558162">.</span><span class="ident" id="1558163">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558175">if</span>&nbsp;<span class="ident" id="1558178">v</span>&nbsp;<span class="op" id="1558180">==</span>&nbsp;<span class="builtintype" id="1558183">nil</span>&nbsp;<span class="op" id="1558187">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558193">mp</span>&nbsp;<span class="op" id="1558196">:=</span>&nbsp;<span class="ident" id="1558199">acquirem</span><span class="op" id="1558207">(</span><span class="op" id="1558208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558214">mp</span><span class="op" id="1558216">.</span><span class="ident" id="1558217">scalararg</span><span class="op" id="1558226">[</span><span class="num" id="1558227">0</span><span class="op" id="1558228">]</span>&nbsp;<span class="op" id="1558230">=</span>&nbsp;<span class="ident" id="1558232">tinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558250">onM</span><span class="op" id="1558253">(</span><span class="ident" id="1558254">mcacheRefill_m</span><span class="op" id="1558268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558274">releasem</span><span class="op" id="1558282">(</span><span class="ident" id="1558283">mp</span><span class="op" id="1558285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558291">s</span>&nbsp;<span class="op" id="1558293">=</span>&nbsp;<span class="ident" id="1558295">c</span><span class="op" id="1558296">.</span><span class="ident" id="1558297">alloc</span><span class="op" id="1558302">[</span><span class="ident" id="1558303">tinySizeClass</span><span class="op" id="1558316">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558322">v</span>&nbsp;<span class="op" id="1558324">=</span>&nbsp;<span class="ident" id="1558326">s</span><span class="op" id="1558327">.</span><span class="ident" id="1558328">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558345">s</span><span class="op" id="1558346">.</span><span class="ident" id="1558347">freelist</span>&nbsp;<span class="op" id="1558356">=</span>&nbsp;<span class="ident" id="1558358">v</span><span class="op" id="1558359">.</span><span class="ident" id="1558360">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558368">s</span><span class="op" id="1558369">.</span><span class="ident" id="1558370">ref</span><span class="op" id="1558373">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1558379">//TODO:&nbsp;prefetch&nbsp;v.next</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558406">x</span>&nbsp;<span class="op" id="1558408">=</span>&nbsp;<span class="ident" id="1558410">unsafe</span><span class="op" id="1558416">.</span><span class="ident" id="1558417">Pointer</span><span class="op" id="1558424">(</span><span class="ident" id="1558425">v</span><span class="op" id="1558426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558431">(</span><span class="op" id="1558432">*</span><span class="op" id="1558433">[</span><span class="num" id="1558434">2</span><span class="op" id="1558435">]</span><span class="ident" id="1558436">uint64</span><span class="op" id="1558442">)</span><span class="op" id="1558443">(</span><span class="ident" id="1558444">x</span><span class="op" id="1558445">)</span><span class="op" id="1558446">[</span><span class="num" id="1558447">0</span><span class="op" id="1558448">]</span>&nbsp;<span class="op" id="1558450">=</span>&nbsp;<span class="num" id="1558452">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558457">(</span><span class="op" id="1558458">*</span><span class="op" id="1558459">[</span><span class="num" id="1558460">2</span><span class="op" id="1558461">]</span><span class="ident" id="1558462">uint64</span><span class="op" id="1558468">)</span><span class="op" id="1558469">(</span><span class="ident" id="1558470">x</span><span class="op" id="1558471">)</span><span class="op" id="1558472">[</span><span class="num" id="1558473">1</span><span class="op" id="1558474">]</span>&nbsp;<span class="op" id="1558476">=</span>&nbsp;<span class="num" id="1558478">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1558483">//&nbsp;See&nbsp;if&nbsp;we&nbsp;need&nbsp;to&nbsp;replace&nbsp;the&nbsp;existing&nbsp;tiny&nbsp;block&nbsp;with&nbsp;the&nbsp;new&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1558556">//&nbsp;based&nbsp;on&nbsp;amount&nbsp;of&nbsp;remaining&nbsp;free&nbsp;space.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558603">if</span>&nbsp;<span class="ident" id="1558606">maxTinySize</span><span class="op" id="1558617">-</span><span class="ident" id="1558618">size</span>&nbsp;<span class="op" id="1558623">&gt;</span>&nbsp;<span class="ident" id="1558625">tinysize</span>&nbsp;<span class="op" id="1558634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558640">c</span><span class="op" id="1558641">.</span><span class="ident" id="1558642">tiny</span>&nbsp;<span class="op" id="1558647">=</span>&nbsp;<span class="op" id="1558649">(</span><span class="op" id="1558650">*</span><span class="builtintype" id="1558651">byte</span><span class="op" id="1558655">)</span><span class="op" id="1558656">(</span><span class="ident" id="1558657">add</span><span class="op" id="1558660">(</span><span class="ident" id="1558661">x</span><span class="op" id="1558662">,</span>&nbsp;<span class="ident" id="1558664">size</span><span class="op" id="1558668">)</span><span class="op" id="1558669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558675">c</span><span class="op" id="1558676">.</span><span class="ident" id="1558677">tinysize</span>&nbsp;<span class="op" id="1558686">=</span>&nbsp;<span class="builtintype" id="1558688">uintptr</span><span class="op" id="1558695">(</span><span class="ident" id="1558696">maxTinySize</span>&nbsp;<span class="op" id="1558708">-</span>&nbsp;<span class="ident" id="1558710">size</span><span class="op" id="1558714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558724">size</span>&nbsp;<span class="op" id="1558729">=</span>&nbsp;<span class="ident" id="1558731">maxTinySize</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558745">}</span>&nbsp;<span class="keyword" id="1558747">else</span>&nbsp;<span class="op" id="1558752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558757">var</span>&nbsp;<span class="ident" id="1558761">sizeclass</span>&nbsp;<span class="builtintype" id="1558771">int8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558779">if</span>&nbsp;<span class="ident" id="1558782">size</span>&nbsp;<span class="op" id="1558787">&lt;=</span>&nbsp;<span class="num" id="1558790">1024</span><span class="op" id="1558794">-</span><span class="num" id="1558795">8</span>&nbsp;<span class="op" id="1558797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558803">sizeclass</span>&nbsp;<span class="op" id="1558813">=</span>&nbsp;<span class="ident" id="1558815">size_to_class8</span><span class="op" id="1558829">[</span><span class="op" id="1558830">(</span><span class="ident" id="1558831">size</span><span class="op" id="1558835">+</span><span class="num" id="1558836">7</span><span class="op" id="1558837">)</span><span class="op" id="1558838">&gt;&gt;</span><span class="num" id="1558840">3</span><span class="op" id="1558841">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558846">}</span>&nbsp;<span class="keyword" id="1558848">else</span>&nbsp;<span class="op" id="1558853">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558859">sizeclass</span>&nbsp;<span class="op" id="1558869">=</span>&nbsp;<span class="ident" id="1558871">size_to_class128</span><span class="op" id="1558887">[</span><span class="op" id="1558888">(</span><span class="ident" id="1558889">size</span><span class="op" id="1558893">-</span><span class="num" id="1558894">1024</span><span class="op" id="1558898">+</span><span class="num" id="1558899">127</span><span class="op" id="1558902">)</span><span class="op" id="1558903">&gt;&gt;</span><span class="num" id="1558905">7</span><span class="op" id="1558906">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558916">size</span>&nbsp;<span class="op" id="1558921">=</span>&nbsp;<span class="builtintype" id="1558923">uintptr</span><span class="op" id="1558930">(</span><span class="ident" id="1558931">class_to_size</span><span class="op" id="1558944">[</span><span class="ident" id="1558945">sizeclass</span><span class="op" id="1558954">]</span><span class="op" id="1558955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558960">s</span>&nbsp;<span class="op" id="1558962">=</span>&nbsp;<span class="ident" id="1558964">c</span><span class="op" id="1558965">.</span><span class="ident" id="1558966">alloc</span><span class="op" id="1558971">[</span><span class="ident" id="1558972">sizeclass</span><span class="op" id="1558981">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558986">v</span>&nbsp;<span class="op" id="1558988">:=</span>&nbsp;<span class="ident" id="1558991">s</span><span class="op" id="1558992">.</span><span class="ident" id="1558993">freelist</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559005">if</span>&nbsp;<span class="ident" id="1559008">v</span>&nbsp;<span class="op" id="1559010">==</span>&nbsp;<span class="builtintype" id="1559013">nil</span>&nbsp;<span class="op" id="1559017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559023">mp</span>&nbsp;<span class="op" id="1559026">:=</span>&nbsp;<span class="ident" id="1559029">acquirem</span><span class="op" id="1559037">(</span><span class="op" id="1559038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559044">mp</span><span class="op" id="1559046">.</span><span class="ident" id="1559047">scalararg</span><span class="op" id="1559056">[</span><span class="num" id="1559057">0</span><span class="op" id="1559058">]</span>&nbsp;<span class="op" id="1559060">=</span>&nbsp;<span class="builtintype" id="1559062">uintptr</span><span class="op" id="1559069">(</span><span class="ident" id="1559070">sizeclass</span><span class="op" id="1559079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559085">onM</span><span class="op" id="1559088">(</span><span class="ident" id="1559089">mcacheRefill_m</span><span class="op" id="1559103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559109">releasem</span><span class="op" id="1559117">(</span><span class="ident" id="1559118">mp</span><span class="op" id="1559120">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559126">s</span>&nbsp;<span class="op" id="1559128">=</span>&nbsp;<span class="ident" id="1559130">c</span><span class="op" id="1559131">.</span><span class="ident" id="1559132">alloc</span><span class="op" id="1559137">[</span><span class="ident" id="1559138">sizeclass</span><span class="op" id="1559147">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559153">v</span>&nbsp;<span class="op" id="1559155">=</span>&nbsp;<span class="ident" id="1559157">s</span><span class="op" id="1559158">.</span><span class="ident" id="1559159">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559176">s</span><span class="op" id="1559177">.</span><span class="ident" id="1559178">freelist</span>&nbsp;<span class="op" id="1559187">=</span>&nbsp;<span class="ident" id="1559189">v</span><span class="op" id="1559190">.</span><span class="ident" id="1559191">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559199">s</span><span class="op" id="1559200">.</span><span class="ident" id="1559201">ref</span><span class="op" id="1559204">++</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559210">//TODO:&nbsp;prefetch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559230">x</span>&nbsp;<span class="op" id="1559232">=</span>&nbsp;<span class="ident" id="1559234">unsafe</span><span class="op" id="1559240">.</span><span class="ident" id="1559241">Pointer</span><span class="op" id="1559248">(</span><span class="ident" id="1559249">v</span><span class="op" id="1559250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559255">if</span>&nbsp;<span class="ident" id="1559258">flags</span><span class="op" id="1559263">&amp;</span><span class="ident" id="1559264">flagNoZero</span>&nbsp;<span class="op" id="1559275">==</span>&nbsp;<span class="num" id="1559278">0</span>&nbsp;<span class="op" id="1559280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559286">v</span><span class="op" id="1559287">.</span><span class="ident" id="1559288">next</span>&nbsp;<span class="op" id="1559293">=</span>&nbsp;<span class="builtintype" id="1559295">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559303">if</span>&nbsp;<span class="ident" id="1559306">size</span>&nbsp;<span class="op" id="1559311">&gt;</span>&nbsp;<span class="num" id="1559313">2</span><span class="op" id="1559314">*</span><span class="ident" id="1559315">ptrSize</span>&nbsp;<span class="op" id="1559323">&amp;&amp;</span>&nbsp;<span class="op" id="1559326">(</span><span class="op" id="1559327">(</span><span class="op" id="1559328">*</span><span class="op" id="1559329">[</span><span class="num" id="1559330">2</span><span class="op" id="1559331">]</span><span class="builtintype" id="1559332">uintptr</span><span class="op" id="1559339">)</span><span class="op" id="1559340">(</span><span class="ident" id="1559341">x</span><span class="op" id="1559342">)</span><span class="op" id="1559343">)</span><span class="op" id="1559344">[</span><span class="num" id="1559345">1</span><span class="op" id="1559346">]</span>&nbsp;<span class="op" id="1559348">!=</span>&nbsp;<span class="num" id="1559351">0</span>&nbsp;<span class="op" id="1559353">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559360">memclr</span><span class="op" id="1559366">(</span><span class="ident" id="1559367">unsafe</span><span class="op" id="1559373">.</span><span class="ident" id="1559374">Pointer</span><span class="op" id="1559381">(</span><span class="ident" id="1559382">v</span><span class="op" id="1559383">)</span><span class="op" id="1559384">,</span>&nbsp;<span class="ident" id="1559386">size</span><span class="op" id="1559390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559409">c</span><span class="op" id="1559410">.</span><span class="ident" id="1559411">local_cachealloc</span>&nbsp;<span class="op" id="1559428">+=</span>&nbsp;<span class="ident" id="1559431">intptr</span><span class="op" id="1559437">(</span><span class="ident" id="1559438">size</span><span class="op" id="1559442">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559445">}</span>&nbsp;<span class="keyword" id="1559447">else</span>&nbsp;<span class="op" id="1559452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559456">mp</span>&nbsp;<span class="op" id="1559459">:=</span>&nbsp;<span class="ident" id="1559462">acquirem</span><span class="op" id="1559470">(</span><span class="op" id="1559471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559475">mp</span><span class="op" id="1559477">.</span><span class="ident" id="1559478">scalararg</span><span class="op" id="1559487">[</span><span class="num" id="1559488">0</span><span class="op" id="1559489">]</span>&nbsp;<span class="op" id="1559491">=</span>&nbsp;<span class="builtintype" id="1559493">uintptr</span><span class="op" id="1559500">(</span><span class="ident" id="1559501">size</span><span class="op" id="1559505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559509">mp</span><span class="op" id="1559511">.</span><span class="ident" id="1559512">scalararg</span><span class="op" id="1559521">[</span><span class="num" id="1559522">1</span><span class="op" id="1559523">]</span>&nbsp;<span class="op" id="1559525">=</span>&nbsp;<span class="builtintype" id="1559527">uintptr</span><span class="op" id="1559534">(</span><span class="ident" id="1559535">flags</span><span class="op" id="1559540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559544">onM</span><span class="op" id="1559547">(</span><span class="ident" id="1559548">largeAlloc_m</span><span class="op" id="1559560">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559564">s</span>&nbsp;<span class="op" id="1559566">=</span>&nbsp;<span class="op" id="1559568">(</span><span class="op" id="1559569">*</span><span class="ident" id="1559570">mspan</span><span class="op" id="1559575">)</span><span class="op" id="1559576">(</span><span class="ident" id="1559577">mp</span><span class="op" id="1559579">.</span><span class="ident" id="1559580">ptrarg</span><span class="op" id="1559586">[</span><span class="num" id="1559587">0</span><span class="op" id="1559588">]</span><span class="op" id="1559589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559593">mp</span><span class="op" id="1559595">.</span><span class="ident" id="1559596">ptrarg</span><span class="op" id="1559602">[</span><span class="num" id="1559603">0</span><span class="op" id="1559604">]</span>&nbsp;<span class="op" id="1559606">=</span>&nbsp;<span class="builtintype" id="1559608">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559614">releasem</span><span class="op" id="1559622">(</span><span class="ident" id="1559623">mp</span><span class="op" id="1559625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559629">x</span>&nbsp;<span class="op" id="1559631">=</span>&nbsp;<span class="ident" id="1559633">unsafe</span><span class="op" id="1559639">.</span><span class="ident" id="1559640">Pointer</span><span class="op" id="1559647">(</span><span class="builtintype" id="1559648">uintptr</span><span class="op" id="1559655">(</span><span class="ident" id="1559656">s</span><span class="op" id="1559657">.</span><span class="ident" id="1559658">start</span>&nbsp;<span class="op" id="1559664">&lt;&lt;</span>&nbsp;<span class="ident" id="1559667">pageShift</span><span class="op" id="1559676">)</span><span class="op" id="1559677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559681">size</span>&nbsp;<span class="op" id="1559686">=</span>&nbsp;<span class="builtintype" id="1559688">uintptr</span><span class="op" id="1559695">(</span><span class="ident" id="1559696">s</span><span class="op" id="1559697">.</span><span class="ident" id="1559698">elemsize</span><span class="op" id="1559706">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559713">if</span>&nbsp;<span class="ident" id="1559716">flags</span><span class="op" id="1559721">&amp;</span><span class="ident" id="1559722">flagNoScan</span>&nbsp;<span class="op" id="1559733">!=</span>&nbsp;<span class="num" id="1559736">0</span>&nbsp;<span class="op" id="1559738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559742">//&nbsp;All&nbsp;objects&nbsp;are&nbsp;pre-marked&nbsp;as&nbsp;noscan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559785">goto</span>&nbsp;<span class="ident" id="1559790">marked</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559802">//&nbsp;If&nbsp;allocating&nbsp;a&nbsp;defer+arg&nbsp;block,&nbsp;now&nbsp;that&nbsp;we&#39;ve&nbsp;picked&nbsp;a&nbsp;malloc&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559875">//&nbsp;large&nbsp;enough&nbsp;to&nbsp;hold&nbsp;everything,&nbsp;cut&nbsp;the&nbsp;&#34;asked&nbsp;for&#34;&nbsp;size&nbsp;down&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559945">//&nbsp;just&nbsp;the&nbsp;defer&nbsp;header,&nbsp;so&nbsp;that&nbsp;the&nbsp;GC&nbsp;bitmap&nbsp;will&nbsp;record&nbsp;the&nbsp;arg&nbsp;block</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560020">//&nbsp;as&nbsp;containing&nbsp;nothing&nbsp;at&nbsp;all&nbsp;(as&nbsp;if&nbsp;it&nbsp;were&nbsp;unused&nbsp;space&nbsp;at&nbsp;the&nbsp;end&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560095">//&nbsp;a&nbsp;malloc&nbsp;block&nbsp;caused&nbsp;by&nbsp;size&nbsp;rounding).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560140">//&nbsp;The&nbsp;defer&nbsp;arg&nbsp;areas&nbsp;are&nbsp;scanned&nbsp;as&nbsp;part&nbsp;of&nbsp;scanstack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560198">if</span>&nbsp;<span class="ident" id="1560201">typ</span>&nbsp;<span class="op" id="1560205">==</span>&nbsp;<span class="ident" id="1560208">deferType</span>&nbsp;<span class="op" id="1560218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560222">size0</span>&nbsp;<span class="op" id="1560228">=</span>&nbsp;<span class="ident" id="1560230">unsafe</span><span class="op" id="1560236">.</span><span class="ident" id="1560237">Sizeof</span><span class="op" id="1560243">(</span><span class="ident" id="1560244">_defer</span><span class="op" id="1560250">{</span><span class="op" id="1560251">}</span><span class="op" id="1560252">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1560255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560259">//&nbsp;From&nbsp;here&nbsp;till&nbsp;marked&nbsp;label&nbsp;marking&nbsp;the&nbsp;object&nbsp;as&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560323">//&nbsp;and&nbsp;storing&nbsp;type&nbsp;info&nbsp;in&nbsp;the&nbsp;GC&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1560367">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560371">arena_start</span>&nbsp;<span class="op" id="1560383">:=</span>&nbsp;<span class="builtintype" id="1560386">uintptr</span><span class="op" id="1560393">(</span><span class="ident" id="1560394">unsafe</span><span class="op" id="1560400">.</span><span class="ident" id="1560401">Pointer</span><span class="op" id="1560408">(</span><span class="ident" id="1560409">mheap_</span><span class="op" id="1560415">.</span><span class="ident" id="1560416">arena_start</span><span class="op" id="1560427">)</span><span class="op" id="1560428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560432">off</span>&nbsp;<span class="op" id="1560436">:=</span>&nbsp;<span class="op" id="1560439">(</span><span class="builtintype" id="1560440">uintptr</span><span class="op" id="1560447">(</span><span class="ident" id="1560448">x</span><span class="op" id="1560449">)</span>&nbsp;<span class="op" id="1560451">-</span>&nbsp;<span class="ident" id="1560453">arena_start</span><span class="op" id="1560464">)</span>&nbsp;<span class="op" id="1560466">/</span>&nbsp;<span class="ident" id="1560468">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560478">xbits</span>&nbsp;<span class="op" id="1560484">:=</span>&nbsp;<span class="op" id="1560487">(</span><span class="op" id="1560488">*</span><span class="builtintype" id="1560489">uint8</span><span class="op" id="1560494">)</span><span class="op" id="1560495">(</span><span class="ident" id="1560496">unsafe</span><span class="op" id="1560502">.</span><span class="ident" id="1560503">Pointer</span><span class="op" id="1560510">(</span><span class="ident" id="1560511">arena_start</span>&nbsp;<span class="op" id="1560523">-</span>&nbsp;<span class="ident" id="1560525">off</span><span class="op" id="1560528">/</span><span class="ident" id="1560529">wordsPerBitmapByte</span>&nbsp;<span class="op" id="1560548">-</span>&nbsp;<span class="num" id="1560550">1</span><span class="op" id="1560551">)</span><span class="op" id="1560552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560556">shift</span>&nbsp;<span class="op" id="1560562">:=</span>&nbsp;<span class="op" id="1560565">(</span><span class="ident" id="1560566">off</span>&nbsp;<span class="op" id="1560570">%</span>&nbsp;<span class="ident" id="1560572">wordsPerBitmapByte</span><span class="op" id="1560590">)</span>&nbsp;<span class="op" id="1560592">*</span>&nbsp;<span class="ident" id="1560594">gcBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560603">if</span>&nbsp;<span class="ident" id="1560606">debugMalloc</span>&nbsp;<span class="op" id="1560618">&amp;&amp;</span>&nbsp;<span class="op" id="1560621">(</span><span class="op" id="1560622">(</span><span class="op" id="1560623">*</span><span class="ident" id="1560624">xbits</span><span class="op" id="1560629">&gt;&gt;</span><span class="ident" id="1560631">shift</span><span class="op" id="1560636">)</span><span class="op" id="1560637">&amp;</span><span class="op" id="1560638">(</span><span class="ident" id="1560639">bitMask</span><span class="op" id="1560646">|</span><span class="ident" id="1560647">bitPtrMask</span><span class="op" id="1560657">)</span><span class="op" id="1560658">)</span>&nbsp;<span class="op" id="1560660">!=</span>&nbsp;<span class="ident" id="1560663">bitBoundary</span>&nbsp;<span class="op" id="1560675">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1560680">println</span><span class="op" id="1560687">(</span><span class="string" id="1560688">&#34;runtime:&nbsp;bits&nbsp;=&#34;</span><span class="op" id="1560705">,</span>&nbsp;<span class="op" id="1560707">(</span><span class="op" id="1560708">*</span><span class="ident" id="1560709">xbits</span><span class="op" id="1560714">&gt;&gt;</span><span class="ident" id="1560716">shift</span><span class="op" id="1560721">)</span><span class="op" id="1560722">&amp;</span><span class="op" id="1560723">(</span><span class="ident" id="1560724">bitMask</span><span class="op" id="1560731">|</span><span class="ident" id="1560732">bitPtrMask</span><span class="op" id="1560742">)</span><span class="op" id="1560743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560748">gothrow</span><span class="op" id="1560755">(</span><span class="string" id="1560756">&#34;bad&nbsp;bits&nbsp;in&nbsp;markallocated&#34;</span><span class="op" id="1560783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1560787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560792">var</span>&nbsp;<span class="ident" id="1560796">ti</span><span class="op" id="1560798">,</span>&nbsp;<span class="ident" id="1560800">te</span>&nbsp;<span class="builtintype" id="1560803">uintptr</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560813">var</span>&nbsp;<span class="ident" id="1560817">ptrmask</span>&nbsp;<span class="op" id="1560825">*</span><span class="builtintype" id="1560826">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560834">if</span>&nbsp;<span class="ident" id="1560837">size</span>&nbsp;<span class="op" id="1560842">==</span>&nbsp;<span class="ident" id="1560845">ptrSize</span>&nbsp;<span class="op" id="1560853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560858">//&nbsp;It&#39;s&nbsp;one&nbsp;word&nbsp;and&nbsp;it&nbsp;has&nbsp;pointers,&nbsp;it&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1560921">*</span><span class="ident" id="1560922">xbits</span>&nbsp;<span class="op" id="1560928">|=</span>&nbsp;<span class="op" id="1560931">(</span><span class="ident" id="1560932">bitsPointer</span>&nbsp;<span class="op" id="1560944">&lt;&lt;</span>&nbsp;<span class="num" id="1560947">2</span><span class="op" id="1560948">)</span>&nbsp;<span class="op" id="1560950">&lt;&lt;</span>&nbsp;<span class="ident" id="1560953">shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560962">goto</span>&nbsp;<span class="ident" id="1560967">marked</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1560976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560980">if</span>&nbsp;<span class="ident" id="1560983">typ</span><span class="op" id="1560986">.</span><span class="ident" id="1560987">kind</span><span class="op" id="1560991">&amp;</span><span class="ident" id="1560992">kindGCProg</span>&nbsp;<span class="op" id="1561003">!=</span>&nbsp;<span class="num" id="1561006">0</span>&nbsp;<span class="op" id="1561008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561013">nptr</span>&nbsp;<span class="op" id="1561018">:=</span>&nbsp;<span class="op" id="1561021">(</span><span class="builtintype" id="1561022">uintptr</span><span class="op" id="1561029">(</span><span class="ident" id="1561030">typ</span><span class="op" id="1561033">.</span><span class="ident" id="1561034">size</span><span class="op" id="1561038">)</span>&nbsp;<span class="op" id="1561040">+</span>&nbsp;<span class="ident" id="1561042">ptrSize</span>&nbsp;<span class="op" id="1561050">-</span>&nbsp;<span class="num" id="1561052">1</span><span class="op" id="1561053">)</span>&nbsp;<span class="op" id="1561055">/</span>&nbsp;<span class="ident" id="1561057">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561068">masksize</span>&nbsp;<span class="op" id="1561077">:=</span>&nbsp;<span class="ident" id="1561080">nptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1561088">if</span>&nbsp;<span class="ident" id="1561091">masksize</span><span class="op" id="1561099">%</span><span class="num" id="1561100">2</span>&nbsp;<span class="op" id="1561102">!=</span>&nbsp;<span class="num" id="1561105">0</span>&nbsp;<span class="op" id="1561107">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561113">masksize</span>&nbsp;<span class="op" id="1561122">*=</span>&nbsp;<span class="num" id="1561125">2</span>&nbsp;<span class="comment" id="1561127">//&nbsp;repeated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1561142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561147">masksize</span>&nbsp;<span class="op" id="1561156">=</span>&nbsp;<span class="ident" id="1561158">masksize</span>&nbsp;<span class="op" id="1561167">*</span>&nbsp;<span class="ident" id="1561169">pointersPerByte</span>&nbsp;<span class="op" id="1561185">/</span>&nbsp;<span class="num" id="1561187">8</span>&nbsp;<span class="comment" id="1561189">//&nbsp;4&nbsp;bits&nbsp;per&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561211">masksize</span><span class="op" id="1561219">++</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1561253">//&nbsp;unroll&nbsp;flag&nbsp;in&nbsp;the&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1561288">if</span>&nbsp;<span class="ident" id="1561291">masksize</span>&nbsp;<span class="op" id="1561300">&gt;</span>&nbsp;<span class="ident" id="1561302">maxGCMask</span>&nbsp;<span class="op" id="1561312">&amp;&amp;</span>&nbsp;<span class="ident" id="1561315">typ</span><span class="op" id="1561318">.</span><span class="ident" id="1561319">gc</span><span class="op" id="1561321">[</span><span class="num" id="1561322">1</span><span class="op" id="1561323">]</span>&nbsp;<span class="op" id="1561325">!=</span>&nbsp;<span class="num" id="1561328">0</span>&nbsp;<span class="op" id="1561330">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1561336">//&nbsp;If&nbsp;the&nbsp;mask&nbsp;is&nbsp;too&nbsp;large,&nbsp;unroll&nbsp;the&nbsp;program&nbsp;directly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1561397">//&nbsp;into&nbsp;the&nbsp;GC&nbsp;bitmap.&nbsp;It&#39;s&nbsp;7&nbsp;times&nbsp;slower&nbsp;than&nbsp;copying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1561457">//&nbsp;from&nbsp;the&nbsp;pre-unrolled&nbsp;mask,&nbsp;but&nbsp;saves&nbsp;1/16&nbsp;of&nbsp;type&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1561520">//&nbsp;memory&nbsp;for&nbsp;the&nbsp;mask.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561548">mp</span>&nbsp;<span class="op" id="1561551">:=</span>&nbsp;<span class="ident" id="1561554">acquirem</span><span class="op" id="1561562">(</span><span class="op" id="1561563">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561569">mp</span><span class="op" id="1561571">.</span><span class="ident" id="1561572">ptrarg</span><span class="op" id="1561578">[</span><span class="num" id="1561579">0</span><span class="op" id="1561580">]</span>&nbsp;<span class="op" id="1561582">=</span>&nbsp;<span class="ident" id="1561584">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561590">mp</span><span class="op" id="1561592">.</span><span class="ident" id="1561593">ptrarg</span><span class="op" id="1561599">[</span><span class="num" id="1561600">1</span><span class="op" id="1561601">]</span>&nbsp;<span class="op" id="1561603">=</span>&nbsp;<span class="ident" id="1561605">unsafe</span><span class="op" id="1561611">.</span><span class="ident" id="1561612">Pointer</span><span class="op" id="1561619">(</span><span class="ident" id="1561620">typ</span><span class="op" id="1561623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561629">mp</span><span class="op" id="1561631">.</span><span class="ident" id="1561632">scalararg</span><span class="op" id="1561641">[</span><span class="num" id="1561642">0</span><span class="op" id="1561643">]</span>&nbsp;<span class="op" id="1561645">=</span>&nbsp;<span class="builtintype" id="1561647">uintptr</span><span class="op" id="1561654">(</span><span class="ident" id="1561655">size</span><span class="op" id="1561659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561665">mp</span><span class="op" id="1561667">.</span><span class="ident" id="1561668">scalararg</span><span class="op" id="1561677">[</span><span class="num" id="1561678">1</span><span class="op" id="1561679">]</span>&nbsp;<span class="op" id="1561681">=</span>&nbsp;<span class="builtintype" id="1561683">uintptr</span><span class="op" id="1561690">(</span><span class="ident" id="1561691">size0</span><span class="op" id="1561696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561702">onM</span><span class="op" id="1561705">(</span><span class="ident" id="1561706">unrollgcproginplace_m</span><span class="op" id="1561727">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561733">releasem</span><span class="op" id="1561741">(</span><span class="ident" id="1561742">mp</span><span class="op" id="1561744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1561750">goto</span>&nbsp;<span class="ident" id="1561755">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1561765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561770">ptrmask</span>&nbsp;<span class="op" id="1561778">=</span>&nbsp;<span class="op" id="1561780">(</span><span class="op" id="1561781">*</span><span class="builtintype" id="1561782">uint8</span><span class="op" id="1561787">)</span><span class="op" id="1561788">(</span><span class="ident" id="1561789">unsafe</span><span class="op" id="1561795">.</span><span class="ident" id="1561796">Pointer</span><span class="op" id="1561803">(</span><span class="builtintype" id="1561804">uintptr</span><span class="op" id="1561811">(</span><span class="ident" id="1561812">typ</span><span class="op" id="1561815">.</span><span class="ident" id="1561816">gc</span><span class="op" id="1561818">[</span><span class="num" id="1561819">0</span><span class="op" id="1561820">]</span><span class="op" id="1561821">)</span><span class="op" id="1561822">)</span><span class="op" id="1561823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1561828">//&nbsp;Check&nbsp;whether&nbsp;the&nbsp;program&nbsp;is&nbsp;already&nbsp;unrolled.</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1561881">if</span>&nbsp;<span class="builtintype" id="1561884">uintptr</span><span class="op" id="1561891">(</span><span class="ident" id="1561892">atomicloadp</span><span class="op" id="1561903">(</span><span class="ident" id="1561904">unsafe</span><span class="op" id="1561910">.</span><span class="ident" id="1561911">Pointer</span><span class="op" id="1561918">(</span><span class="ident" id="1561919">ptrmask</span><span class="op" id="1561926">)</span><span class="op" id="1561927">)</span><span class="op" id="1561928">)</span><span class="op" id="1561929">&amp;</span><span class="num" id="1561930">0xff</span>&nbsp;<span class="op" id="1561935">==</span>&nbsp;<span class="num" id="1561938">0</span>&nbsp;<span class="op" id="1561940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561946">mp</span>&nbsp;<span class="op" id="1561949">:=</span>&nbsp;<span class="ident" id="1561952">acquirem</span><span class="op" id="1561960">(</span><span class="op" id="1561961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561967">mp</span><span class="op" id="1561969">.</span><span class="ident" id="1561970">ptrarg</span><span class="op" id="1561976">[</span><span class="num" id="1561977">0</span><span class="op" id="1561978">]</span>&nbsp;<span class="op" id="1561980">=</span>&nbsp;<span class="ident" id="1561982">unsafe</span><span class="op" id="1561988">.</span><span class="ident" id="1561989">Pointer</span><span class="op" id="1561996">(</span><span class="ident" id="1561997">typ</span><span class="op" id="1562000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1562006">onM</span><span class="op" id="1562009">(</span><span class="ident" id="1562010">unrollgcprog_m</span><span class="op" id="1562024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1562030">releasem</span><span class="op" id="1562038">(</span><span class="ident" id="1562039">mp</span><span class="op" id="1562041">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1562046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1562051">ptrmask</span>&nbsp;<span class="op" id="1562059">=</span>&nbsp;<span class="op" id="1562061">(</span><span class="op" id="1562062">*</span><span class="builtintype" id="1562063">uint8</span><span class="op" id="1562068">)</span><span class="op" id="1562069">(</span><span class="ident" id="1562070">add</span><span class="op" id="1562073">(</span><span class="ident" id="1562074">unsafe</span><span class="op" id="1562080">.</span><span class="ident" id="1562081">Pointer</span><span class="op" id="1562088">(</span><span class="ident" id="1562089">ptrmask</span><span class="op" id="1562096">)</span><span class="op" id="1562097">,</span>&nbsp;<span class="num" id="1562099">1</span><span class="op" id="1562100">)</span><span class="op" id="1562101">)</span>&nbsp;<span class="comment" id="1562103">//&nbsp;skip&nbsp;the&nbsp;unroll&nbsp;flag&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1562134">}</span>&nbsp;<span class="keyword" id="1562136">else</span>&nbsp;<span class="op" id="1562141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1562146">ptrmask</span>&nbsp;<span class="op" id="1562154">=</span>&nbsp;<span class="op" id="1562156">(</span><span class="op" id="1562157">*</span><span class="builtintype" id="1562158">uint8</span><span class="op" id="1562163">)</span><span class="op" id="1562164">(</span><span class="ident" id="1562165">unsafe</span><span class="op" id="1562171">.</span><span class="ident" id="1562172">Pointer</span><span class="op" id="1562179">(</span><span class="ident" id="1562180">typ</span><span class="op" id="1562183">.</span><span class="ident" id="1562184">gc</span><span class="op" id="1562186">[</span><span class="num" id="1562187">0</span><span class="op" id="1562188">]</span><span class="op" id="1562189">)</span><span class="op" id="1562190">)</span>&nbsp;<span class="comment" id="1562192">//&nbsp;pointer&nbsp;to&nbsp;unrolled&nbsp;mask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1562222">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1562226">if</span>&nbsp;<span class="ident" id="1562229">size</span>&nbsp;<span class="op" id="1562234">==</span>&nbsp;<span class="num" id="1562237">2</span><span class="op" id="1562238">*</span><span class="ident" id="1562239">ptrSize</span>&nbsp;<span class="op" id="1562247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1562252">*</span><span class="ident" id="1562253">xbits</span>&nbsp;<span class="op" id="1562259">=</span>&nbsp;<span class="op" id="1562261">*</span><span class="ident" id="1562262">ptrmask</span>&nbsp;<span class="op" id="1562270">|</span>&nbsp;<span class="ident" id="1562272">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1562287">goto</span>&nbsp;<span class="ident" id="1562292">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1562301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1562305">te</span>&nbsp;<span class="op" id="1562308">=</span>&nbsp;<span class="builtintype" id="1562310">uintptr</span><span class="op" id="1562317">(</span><span class="ident" id="1562318">typ</span><span class="op" id="1562321">.</span><span class="ident" id="1562322">size</span><span class="op" id="1562326">)</span>&nbsp;<span class="op" id="1562328">/</span>&nbsp;<span class="ident" id="1562330">ptrSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1562340">//&nbsp;If&nbsp;the&nbsp;type&nbsp;occupies&nbsp;odd&nbsp;number&nbsp;of&nbsp;words,&nbsp;its&nbsp;mask&nbsp;is&nbsp;repeated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1562409">if</span>&nbsp;<span class="ident" id="1562412">te</span><span class="op" id="1562414">%</span><span class="num" id="1562415">2</span>&nbsp;<span class="op" id="1562417">==</span>&nbsp;<span class="num" id="1562420">0</span>&nbsp;<span class="op" id="1562422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1562427">te</span>&nbsp;<span class="op" id="1562430">/=</span>&nbsp;<span class="num" id="1562433">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1562437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1562441">//&nbsp;Copy&nbsp;pointer&nbsp;bitmask&nbsp;into&nbsp;the&nbsp;bitmap.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1562484">for</span>&nbsp;<span class="ident" id="1562488">i</span>&nbsp;<span class="op" id="1562490">:=</span>&nbsp;<span class="builtintype" id="1562493">uintptr</span><span class="op" id="1562500">(</span><span class="num" id="1562501">0</span><span class="op" id="1562502">)</span><span class="op" id="1562503">;</span>&nbsp;<span class="ident" id="1562505">i</span>&nbsp;<span class="op" id="1562507">&lt;</span>&nbsp;<span class="ident" id="1562509">size0</span><span class="op" id="1562514">;</span>&nbsp;<span class="ident" id="1562516">i</span>&nbsp;<span class="op" id="1562518">+=</span>&nbsp;<span class="num" id="1562521">2</span>&nbsp;<span class="op" id="1562523">*</span>&nbsp;<span class="ident" id="1562525">ptrSize</span>&nbsp;<span class="op" id="1562533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1562538">v</span>&nbsp;<span class="op" id="1562540">:=</span>&nbsp;<span class="op" id="1562543">*</span><span class="op" id="1562544">(</span><span class="op" id="1562545">*</span><span class="builtintype" id="1562546">uint8</span><span class="op" id="1562551">)</span><span class="op" id="1562552">(</span><span class="ident" id="1562553">add</span><span class="op" id="1562556">(</span><span class="ident" id="1562557">unsafe</span><span class="op" id="1562563">.</span><span class="ident" id="1562564">Pointer</span><span class="op" id="1562571">(</span><span class="ident" id="1562572">ptrmask</span><span class="op" id="1562579">)</span><span class="op" id="1562580">,</span>&nbsp;<span class="ident" id="1562582">ti</span><span class="op" id="1562584">)</span><span class="op" id="1562585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1562590">ti</span><span class="op" id="1562592">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1562598">if</span>&nbsp;<span class="ident" id="1562601">ti</span>&nbsp;<span class="op" id="1562604">==</span>&nbsp;<span class="ident" id="1562607">te</span>&nbsp;<span class="op" id="1562610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1562616">ti</span>&nbsp;<span class="op" id="1562619">=</span>&nbsp;<span class="num" id="1562621">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1562626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1562631">if</span>&nbsp;<span class="ident" id="1562634">i</span>&nbsp;<span class="op" id="1562636">==</span>&nbsp;<span class="num" id="1562639">0</span>&nbsp;<span class="op" id="1562641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1562647">v</span>&nbsp;<span class="op" id="1562649">|=</span>&nbsp;<span class="ident" id="1562652">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1562667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1562672">if</span>&nbsp;<span class="ident" id="1562675">i</span><span class="op" id="1562676">+</span><span class="ident" id="1562677">ptrSize</span>&nbsp;<span class="op" id="1562685">==</span>&nbsp;<span class="ident" id="1562688">size0</span>&nbsp;<span class="op" id="1562694">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1562700">v</span>&nbsp;<span class="op" id="1562702">&amp;^=</span>&nbsp;<span class="builtintype" id="1562706">uint8</span><span class="op" id="1562711">(</span><span class="ident" id="1562712">bitPtrMask</span>&nbsp;<span class="op" id="1562723">&lt;&lt;</span>&nbsp;<span class="num" id="1562726">4</span><span class="op" id="1562727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1562732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1562738">*</span><span class="ident" id="1562739">xbits</span>&nbsp;<span class="op" id="1562745">=</span>&nbsp;<span class="ident" id="1562747">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1562752">xbits</span>&nbsp;<span class="op" id="1562758">=</span>&nbsp;<span class="op" id="1562760">(</span><span class="op" id="1562761">*</span><span class="builtintype" id="1562762">byte</span><span class="op" id="1562766">)</span><span class="op" id="1562767">(</span><span class="ident" id="1562768">add</span><span class="op" id="1562771">(</span><span class="ident" id="1562772">unsafe</span><span class="op" id="1562778">.</span><span class="ident" id="1562779">Pointer</span><span class="op" id="1562786">(</span><span class="ident" id="1562787">xbits</span><span class="op" id="1562792">)</span><span class="op" id="1562793">,</span>&nbsp;<span class="op" id="1562795">^</span><span class="builtintype" id="1562796">uintptr</span><span class="op" id="1562803">(</span><span class="num" id="1562804">0</span><span class="op" id="1562805">)</span><span class="op" id="1562806">)</span><span class="op" id="1562807">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1562811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1562815">if</span>&nbsp;<span class="ident" id="1562818">size0</span><span class="op" id="1562823">%</span><span class="op" id="1562824">(</span><span class="num" id="1562825">2</span><span class="op" id="1562826">*</span><span class="ident" id="1562827">ptrSize</span><span class="op" id="1562834">)</span>&nbsp;<span class="op" id="1562836">==</span>&nbsp;<span class="num" id="1562839">0</span>&nbsp;<span class="op" id="1562841">&amp;&amp;</span>&nbsp;<span class="ident" id="1562844">size0</span>&nbsp;<span class="op" id="1562850">&lt;</span>&nbsp;<span class="ident" id="1562852">size</span>&nbsp;<span class="op" id="1562857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1562862">//&nbsp;Mark&nbsp;the&nbsp;word&nbsp;after&nbsp;last&nbsp;object&#39;s&nbsp;word&nbsp;as&nbsp;bitsDead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1562920">*</span><span class="ident" id="1562921">xbits</span>&nbsp;<span class="op" id="1562927">=</span>&nbsp;<span class="ident" id="1562929">bitsDead</span>&nbsp;<span class="op" id="1562938">&lt;&lt;</span>&nbsp;<span class="num" id="1562941">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1562945">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1562948">}</span><br>
<span class="lineno"></span><span class="ident" id="1562950">marked</span><span class="op" id="1562956">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1562959">if</span>&nbsp;<span class="ident" id="1562962">raceenabled</span>&nbsp;<span class="op" id="1562974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1562978">racemalloc</span><span class="op" id="1562988">(</span><span class="ident" id="1562989">x</span><span class="op" id="1562990">,</span>&nbsp;<span class="ident" id="1562992">size</span><span class="op" id="1562996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1562999">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1563003">if</span>&nbsp;<span class="ident" id="1563006">debugMalloc</span>&nbsp;<span class="op" id="1563018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1563022">mp</span>&nbsp;<span class="op" id="1563025">:=</span>&nbsp;<span class="ident" id="1563028">acquirem</span><span class="op" id="1563036">(</span><span class="op" id="1563037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1563041">if</span>&nbsp;<span class="ident" id="1563044">mp</span><span class="op" id="1563046">.</span><span class="ident" id="1563047">mallocing</span>&nbsp;<span class="op" id="1563057">==</span>&nbsp;<span class="num" id="1563060">0</span>&nbsp;<span class="op" id="1563062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1563067">gothrow</span><span class="op" id="1563074">(</span><span class="string" id="1563075">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1563087">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1563091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1563095">mp</span><span class="op" id="1563097">.</span><span class="ident" id="1563098">mallocing</span>&nbsp;<span class="op" id="1563108">=</span>&nbsp;<span class="num" id="1563110">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1563114">if</span>&nbsp;<span class="ident" id="1563117">mp</span><span class="op" id="1563119">.</span><span class="ident" id="1563120">curg</span>&nbsp;<span class="op" id="1563125">!=</span>&nbsp;<span class="builtintype" id="1563128">nil</span>&nbsp;<span class="op" id="1563132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1563137">mp</span><span class="op" id="1563139">.</span><span class="ident" id="1563140">curg</span><span class="op" id="1563144">.</span><span class="ident" id="1563145">stackguard0</span>&nbsp;<span class="op" id="1563157">=</span>&nbsp;<span class="ident" id="1563159">mp</span><span class="op" id="1563161">.</span><span class="ident" id="1563162">curg</span><span class="op" id="1563166">.</span><span class="ident" id="1563167">stack</span><span class="op" id="1563172">.</span><span class="ident" id="1563173">lo</span>&nbsp;<span class="op" id="1563176">+</span>&nbsp;<span class="ident" id="1563178">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1563192">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1563196">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1563249">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1563301">releasem</span><span class="op" id="1563309">(</span><span class="ident" id="1563310">mp</span><span class="op" id="1563312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1563316">releasem</span><span class="op" id="1563324">(</span><span class="ident" id="1563325">mp</span><span class="op" id="1563327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1563330">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1563334">if</span>&nbsp;<span class="ident" id="1563337">debug</span><span class="op" id="1563342">.</span><span class="ident" id="1563343">allocfreetrace</span>&nbsp;<span class="op" id="1563358">!=</span>&nbsp;<span class="num" id="1563361">0</span>&nbsp;<span class="op" id="1563363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1563367">tracealloc</span><span class="op" id="1563377">(</span><span class="ident" id="1563378">x</span><span class="op" id="1563379">,</span>&nbsp;<span class="ident" id="1563381">size</span><span class="op" id="1563385">,</span>&nbsp;<span class="ident" id="1563387">typ</span><span class="op" id="1563390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1563393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1563397">if</span>&nbsp;<span class="ident" id="1563400">rate</span>&nbsp;<span class="op" id="1563405">:=</span>&nbsp;<span class="ident" id="1563408">MemProfileRate</span><span class="op" id="1563422">;</span>&nbsp;<span class="ident" id="1563424">rate</span>&nbsp;<span class="op" id="1563429">&gt;</span>&nbsp;<span class="num" id="1563431">0</span>&nbsp;<span class="op" id="1563433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1563437">if</span>&nbsp;<span class="ident" id="1563440">size</span>&nbsp;<span class="op" id="1563445">&lt;</span>&nbsp;<span class="builtintype" id="1563447">uintptr</span><span class="op" id="1563454">(</span><span class="ident" id="1563455">rate</span><span class="op" id="1563459">)</span>&nbsp;<span class="op" id="1563461">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1563464">int32</span><span class="op" id="1563469">(</span><span class="ident" id="1563470">size</span><span class="op" id="1563474">)</span>&nbsp;<span class="op" id="1563476">&lt;</span>&nbsp;<span class="ident" id="1563478">c</span><span class="op" id="1563479">.</span><span class="ident" id="1563480">next_sample</span>&nbsp;<span class="op" id="1563492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1563497">c</span><span class="op" id="1563498">.</span><span class="ident" id="1563499">next_sample</span>&nbsp;<span class="op" id="1563511">-=</span>&nbsp;<span class="builtintype" id="1563514">int32</span><span class="op" id="1563519">(</span><span class="ident" id="1563520">size</span><span class="op" id="1563524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1563528">}</span>&nbsp;<span class="keyword" id="1563530">else</span>&nbsp;<span class="op" id="1563535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1563540">mp</span>&nbsp;<span class="op" id="1563543">:=</span>&nbsp;<span class="ident" id="1563546">acquirem</span><span class="op" id="1563554">(</span><span class="op" id="1563555">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1563560">profilealloc</span><span class="op" id="1563572">(</span><span class="ident" id="1563573">mp</span><span class="op" id="1563575">,</span>&nbsp;<span class="ident" id="1563577">x</span><span class="op" id="1563578">,</span>&nbsp;<span class="ident" id="1563580">size</span><span class="op" id="1563584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1563589">releasem</span><span class="op" id="1563597">(</span><span class="ident" id="1563598">mp</span><span class="op" id="1563600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1563604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1563607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1563611">if</span>&nbsp;<span class="ident" id="1563614">memstats</span><span class="op" id="1563622">.</span><span class="ident" id="1563623">heap_alloc</span>&nbsp;<span class="op" id="1563634">&gt;=</span>&nbsp;<span class="ident" id="1563637">memstats</span><span class="op" id="1563645">.</span><span class="ident" id="1563646">next_gc</span>&nbsp;<span class="op" id="1563654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1563658">gogc</span><span class="op" id="1563662">(</span><span class="num" id="1563663">0</span><span class="op" id="1563664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1563667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1563671">return</span>&nbsp;<span class="ident" id="1563678">x</span><br>
<span class="lineno">345</span><span class="op" id="1563680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1563683">//&nbsp;implementation&nbsp;of&nbsp;new&nbsp;builtin</span><br>
<span class="lineno"></span><span class="keyword" id="1563716">func</span>&nbsp;<span class="ident" id="1563721">newobject</span><span class="op" id="1563730">(</span><span class="ident" id="1563731">typ</span>&nbsp;<span class="op" id="1563735">*</span><span class="ident" id="1563736">_type</span><span class="op" id="1563741">)</span>&nbsp;<span class="ident" id="1563743">unsafe</span><span class="op" id="1563749">.</span><span class="ident" id="1563750">Pointer</span>&nbsp;<span class="op" id="1563758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1563761">flags</span>&nbsp;<span class="op" id="1563767">:=</span>&nbsp;<span class="builtintype" id="1563770">uint32</span><span class="op" id="1563776">(</span><span class="num" id="1563777">0</span><span class="op" id="1563778">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1563781">if</span>&nbsp;<span class="ident" id="1563784">typ</span><span class="op" id="1563787">.</span><span class="ident" id="1563788">kind</span><span class="op" id="1563792">&amp;</span><span class="ident" id="1563793">kindNoPointers</span>&nbsp;<span class="op" id="1563808">!=</span>&nbsp;<span class="num" id="1563811">0</span>&nbsp;<span class="op" id="1563813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1563817">flags</span>&nbsp;<span class="op" id="1563823">|=</span>&nbsp;<span class="ident" id="1563826">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1563838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1563841">return</span>&nbsp;<span class="ident" id="1563848">mallocgc</span><span class="op" id="1563856">(</span><span class="builtintype" id="1563857">uintptr</span><span class="op" id="1563864">(</span><span class="ident" id="1563865">typ</span><span class="op" id="1563868">.</span><span class="ident" id="1563869">size</span><span class="op" id="1563873">)</span><span class="op" id="1563874">,</span>&nbsp;<span class="ident" id="1563876">typ</span><span class="op" id="1563879">,</span>&nbsp;<span class="ident" id="1563881">flags</span><span class="op" id="1563886">)</span><br>
<span class="lineno"></span><span class="op" id="1563888">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="1563891">//&nbsp;implementation&nbsp;of&nbsp;make&nbsp;builtin&nbsp;for&nbsp;slices</span><br>
<span class="lineno"></span><span class="keyword" id="1563936">func</span>&nbsp;<span class="ident" id="1563941">newarray</span><span class="op" id="1563949">(</span><span class="ident" id="1563950">typ</span>&nbsp;<span class="op" id="1563954">*</span><span class="ident" id="1563955">_type</span><span class="op" id="1563960">,</span>&nbsp;<span class="ident" id="1563962">n</span>&nbsp;<span class="builtintype" id="1563964">uintptr</span><span class="op" id="1563971">)</span>&nbsp;<span class="ident" id="1563973">unsafe</span><span class="op" id="1563979">.</span><span class="ident" id="1563980">Pointer</span>&nbsp;<span class="op" id="1563988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1563991">flags</span>&nbsp;<span class="op" id="1563997">:=</span>&nbsp;<span class="builtintype" id="1564000">uint32</span><span class="op" id="1564006">(</span><span class="num" id="1564007">0</span><span class="op" id="1564008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564011">if</span>&nbsp;<span class="ident" id="1564014">typ</span><span class="op" id="1564017">.</span><span class="ident" id="1564018">kind</span><span class="op" id="1564022">&amp;</span><span class="ident" id="1564023">kindNoPointers</span>&nbsp;<span class="op" id="1564038">!=</span>&nbsp;<span class="num" id="1564041">0</span>&nbsp;<span class="op" id="1564043">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1564047">flags</span>&nbsp;<span class="op" id="1564053">|=</span>&nbsp;<span class="ident" id="1564056">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1564068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564071">if</span>&nbsp;<span class="builtintype" id="1564074">int</span><span class="op" id="1564077">(</span><span class="ident" id="1564078">n</span><span class="op" id="1564079">)</span>&nbsp;<span class="op" id="1564081">&lt;</span>&nbsp;<span class="num" id="1564083">0</span>&nbsp;<span class="op" id="1564085">||</span>&nbsp;<span class="op" id="1564088">(</span><span class="ident" id="1564089">typ</span><span class="op" id="1564092">.</span><span class="ident" id="1564093">size</span>&nbsp;<span class="op" id="1564098">&gt;</span>&nbsp;<span class="num" id="1564100">0</span>&nbsp;<span class="op" id="1564102">&amp;&amp;</span>&nbsp;<span class="ident" id="1564105">n</span>&nbsp;<span class="op" id="1564107">&gt;</span>&nbsp;<span class="ident" id="1564109">maxmem</span><span class="op" id="1564115">/</span><span class="builtintype" id="1564116">uintptr</span><span class="op" id="1564123">(</span><span class="ident" id="1564124">typ</span><span class="op" id="1564127">.</span><span class="ident" id="1564128">size</span><span class="op" id="1564132">)</span><span class="op" id="1564133">)</span>&nbsp;<span class="op" id="1564135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1564139">panic</span><span class="op" id="1564144">(</span><span class="string" id="1564145">&#34;runtime:&nbsp;allocation&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1564184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1564187">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564190">return</span>&nbsp;<span class="ident" id="1564197">mallocgc</span><span class="op" id="1564205">(</span><span class="builtintype" id="1564206">uintptr</span><span class="op" id="1564213">(</span><span class="ident" id="1564214">typ</span><span class="op" id="1564217">.</span><span class="ident" id="1564218">size</span><span class="op" id="1564222">)</span><span class="op" id="1564223">*</span><span class="ident" id="1564224">n</span><span class="op" id="1564225">,</span>&nbsp;<span class="ident" id="1564227">typ</span><span class="op" id="1564230">,</span>&nbsp;<span class="ident" id="1564232">flags</span><span class="op" id="1564237">)</span><br>
<span class="lineno"></span><span class="op" id="1564239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1564242">//&nbsp;rawmem&nbsp;returns&nbsp;a&nbsp;chunk&nbsp;of&nbsp;pointerless&nbsp;memory.&nbsp;&nbsp;It&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1564298">//&nbsp;not&nbsp;zeroed.</span><br>
<span class="lineno">370</span><span class="keyword" id="1564313">func</span>&nbsp;<span class="ident" id="1564318">rawmem</span><span class="op" id="1564324">(</span><span class="ident" id="1564325">size</span>&nbsp;<span class="builtintype" id="1564330">uintptr</span><span class="op" id="1564337">)</span>&nbsp;<span class="ident" id="1564339">unsafe</span><span class="op" id="1564345">.</span><span class="ident" id="1564346">Pointer</span>&nbsp;<span class="op" id="1564354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564357">return</span>&nbsp;<span class="ident" id="1564364">mallocgc</span><span class="op" id="1564372">(</span><span class="ident" id="1564373">size</span><span class="op" id="1564377">,</span>&nbsp;<span class="builtintype" id="1564379">nil</span><span class="op" id="1564382">,</span>&nbsp;<span class="ident" id="1564384">flagNoScan</span><span class="op" id="1564394">|</span><span class="ident" id="1564395">flagNoZero</span><span class="op" id="1564405">)</span><br>
<span class="lineno"></span><span class="op" id="1564407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1564410">//&nbsp;round&nbsp;size&nbsp;up&nbsp;to&nbsp;next&nbsp;size&nbsp;class</span><br>
<span class="lineno">375</span><span class="keyword" id="1564446">func</span>&nbsp;<span class="ident" id="1564451">goroundupsize</span><span class="op" id="1564464">(</span><span class="ident" id="1564465">size</span>&nbsp;<span class="builtintype" id="1564470">uintptr</span><span class="op" id="1564477">)</span>&nbsp;<span class="builtintype" id="1564479">uintptr</span>&nbsp;<span class="op" id="1564487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564490">if</span>&nbsp;<span class="ident" id="1564493">size</span>&nbsp;<span class="op" id="1564498">&lt;</span>&nbsp;<span class="ident" id="1564500">maxSmallSize</span>&nbsp;<span class="op" id="1564513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564517">if</span>&nbsp;<span class="ident" id="1564520">size</span>&nbsp;<span class="op" id="1564525">&lt;=</span>&nbsp;<span class="num" id="1564528">1024</span><span class="op" id="1564532">-</span><span class="num" id="1564533">8</span>&nbsp;<span class="op" id="1564535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564540">return</span>&nbsp;<span class="builtintype" id="1564547">uintptr</span><span class="op" id="1564554">(</span><span class="ident" id="1564555">class_to_size</span><span class="op" id="1564568">[</span><span class="ident" id="1564569">size_to_class8</span><span class="op" id="1564583">[</span><span class="op" id="1564584">(</span><span class="ident" id="1564585">size</span><span class="op" id="1564589">+</span><span class="num" id="1564590">7</span><span class="op" id="1564591">)</span><span class="op" id="1564592">&gt;&gt;</span><span class="num" id="1564594">3</span><span class="op" id="1564595">]</span><span class="op" id="1564596">]</span><span class="op" id="1564597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1564601">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564605">return</span>&nbsp;<span class="builtintype" id="1564612">uintptr</span><span class="op" id="1564619">(</span><span class="ident" id="1564620">class_to_size</span><span class="op" id="1564633">[</span><span class="ident" id="1564634">size_to_class128</span><span class="op" id="1564650">[</span><span class="op" id="1564651">(</span><span class="ident" id="1564652">size</span><span class="op" id="1564656">-</span><span class="num" id="1564657">1024</span><span class="op" id="1564661">+</span><span class="num" id="1564662">127</span><span class="op" id="1564665">)</span><span class="op" id="1564666">&gt;&gt;</span><span class="num" id="1564668">7</span><span class="op" id="1564669">]</span><span class="op" id="1564670">]</span><span class="op" id="1564671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1564674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564677">if</span>&nbsp;<span class="ident" id="1564680">size</span><span class="op" id="1564684">+</span><span class="ident" id="1564685">pageSize</span>&nbsp;<span class="op" id="1564694">&lt;</span>&nbsp;<span class="ident" id="1564696">size</span>&nbsp;<span class="op" id="1564701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564705">return</span>&nbsp;<span class="ident" id="1564712">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1564718">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564721">return</span>&nbsp;<span class="op" id="1564728">(</span><span class="ident" id="1564729">size</span>&nbsp;<span class="op" id="1564734">+</span>&nbsp;<span class="ident" id="1564736">pageSize</span>&nbsp;<span class="op" id="1564745">-</span>&nbsp;<span class="num" id="1564747">1</span><span class="op" id="1564748">)</span>&nbsp;<span class="op" id="1564750">&amp;^</span>&nbsp;<span class="ident" id="1564753">pageMask</span><br>
<span class="lineno"></span><span class="op" id="1564762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1564765">func</span>&nbsp;<span class="ident" id="1564770">profilealloc</span><span class="op" id="1564782">(</span><span class="ident" id="1564783">mp</span>&nbsp;<span class="op" id="1564786">*</span><span class="ident" id="1564787">m</span><span class="op" id="1564788">,</span>&nbsp;<span class="ident" id="1564790">x</span>&nbsp;<span class="ident" id="1564792">unsafe</span><span class="op" id="1564798">.</span><span class="ident" id="1564799">Pointer</span><span class="op" id="1564806">,</span>&nbsp;<span class="ident" id="1564808">size</span>&nbsp;<span class="builtintype" id="1564813">uintptr</span><span class="op" id="1564820">)</span>&nbsp;<span class="op" id="1564822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1564825">c</span>&nbsp;<span class="op" id="1564827">:=</span>&nbsp;<span class="ident" id="1564830">mp</span><span class="op" id="1564832">.</span><span class="ident" id="1564833">mcache</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1564841">rate</span>&nbsp;<span class="op" id="1564846">:=</span>&nbsp;<span class="ident" id="1564849">MemProfileRate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564865">if</span>&nbsp;<span class="ident" id="1564868">size</span>&nbsp;<span class="op" id="1564873">&lt;</span>&nbsp;<span class="builtintype" id="1564875">uintptr</span><span class="op" id="1564882">(</span><span class="ident" id="1564883">rate</span><span class="op" id="1564887">)</span>&nbsp;<span class="op" id="1564889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1564893">//&nbsp;pick&nbsp;next&nbsp;profile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1564921">//&nbsp;If&nbsp;you&nbsp;change&nbsp;this,&nbsp;also&nbsp;change&nbsp;allocmcache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564971">if</span>&nbsp;<span class="ident" id="1564974">rate</span>&nbsp;<span class="op" id="1564979">&gt;</span>&nbsp;<span class="num" id="1564981">0x3fffffff</span>&nbsp;<span class="op" id="1564992">{</span>&nbsp;<span class="comment" id="1564994">//&nbsp;make&nbsp;2*rate&nbsp;not&nbsp;overflow</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1565025">rate</span>&nbsp;<span class="op" id="1565030">=</span>&nbsp;<span class="num" id="1565032">0x3fffffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1565045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1565049">next</span>&nbsp;<span class="op" id="1565054">:=</span>&nbsp;<span class="builtintype" id="1565057">int32</span><span class="op" id="1565062">(</span><span class="ident" id="1565063">fastrand1</span><span class="op" id="1565072">(</span><span class="op" id="1565073">)</span><span class="op" id="1565074">)</span>&nbsp;<span class="op" id="1565076">%</span>&nbsp;<span class="op" id="1565078">(</span><span class="num" id="1565079">2</span>&nbsp;<span class="op" id="1565081">*</span>&nbsp;<span class="builtintype" id="1565083">int32</span><span class="op" id="1565088">(</span><span class="ident" id="1565089">rate</span><span class="op" id="1565093">)</span><span class="op" id="1565094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1565098">//&nbsp;Subtract&nbsp;the&nbsp;&#34;remainder&#34;&nbsp;of&nbsp;the&nbsp;current&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1565155">//&nbsp;Otherwise&nbsp;objects&nbsp;that&nbsp;are&nbsp;close&nbsp;in&nbsp;size&nbsp;to&nbsp;sampling&nbsp;rate</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1565218">//&nbsp;will&nbsp;be&nbsp;under-sampled,&nbsp;because&nbsp;we&nbsp;consistently&nbsp;discard&nbsp;this&nbsp;remainder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1565294">next</span>&nbsp;<span class="op" id="1565299">-=</span>&nbsp;<span class="op" id="1565302">(</span><span class="builtintype" id="1565303">int32</span><span class="op" id="1565308">(</span><span class="ident" id="1565309">size</span><span class="op" id="1565313">)</span>&nbsp;<span class="op" id="1565315">-</span>&nbsp;<span class="ident" id="1565317">c</span><span class="op" id="1565318">.</span><span class="ident" id="1565319">next_sample</span><span class="op" id="1565330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1565334">if</span>&nbsp;<span class="ident" id="1565337">next</span>&nbsp;<span class="op" id="1565342">&lt;</span>&nbsp;<span class="num" id="1565344">0</span>&nbsp;<span class="op" id="1565346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1565351">next</span>&nbsp;<span class="op" id="1565356">=</span>&nbsp;<span class="num" id="1565358">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1565362">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1565366">c</span><span class="op" id="1565367">.</span><span class="ident" id="1565368">next_sample</span>&nbsp;<span class="op" id="1565380">=</span>&nbsp;<span class="ident" id="1565382">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1565388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1565392">mProf_Malloc</span><span class="op" id="1565404">(</span><span class="ident" id="1565405">x</span><span class="op" id="1565406">,</span>&nbsp;<span class="ident" id="1565408">size</span><span class="op" id="1565412">)</span><br>
<span class="lineno"></span><span class="op" id="1565414">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="1565417">//&nbsp;force&nbsp;=&nbsp;1&nbsp;-&nbsp;do&nbsp;GC&nbsp;regardless&nbsp;of&nbsp;current&nbsp;heap&nbsp;usage</span><br>
<span class="lineno"></span><span class="comment" id="1565471">//&nbsp;force&nbsp;=&nbsp;2&nbsp;-&nbsp;go&nbsp;GC&nbsp;and&nbsp;eager&nbsp;sweep</span><br>
<span class="lineno"></span><span class="keyword" id="1565508">func</span>&nbsp;<span class="ident" id="1565513">gogc</span><span class="op" id="1565517">(</span><span class="ident" id="1565518">force</span>&nbsp;<span class="builtintype" id="1565524">int32</span><span class="op" id="1565529">)</span>&nbsp;<span class="op" id="1565531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1565534">//&nbsp;The&nbsp;gc&nbsp;is&nbsp;turned&nbsp;off&nbsp;(via&nbsp;enablegc)&nbsp;until&nbsp;the&nbsp;bootstrap&nbsp;has&nbsp;completed.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1565609">//&nbsp;Also,&nbsp;malloc&nbsp;gets&nbsp;called&nbsp;in&nbsp;the&nbsp;guts&nbsp;of&nbsp;a&nbsp;number&nbsp;of&nbsp;libraries&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1565689">//&nbsp;holding&nbsp;locks.&nbsp;To&nbsp;avoid&nbsp;deadlocks&nbsp;during&nbsp;stoptheworld,&nbsp;don&#39;t&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1565761">//&nbsp;trying&nbsp;to&nbsp;run&nbsp;gc&nbsp;while&nbsp;holding&nbsp;a&nbsp;lock.&nbsp;The&nbsp;next&nbsp;mallocgc&nbsp;without&nbsp;a&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1565837">//&nbsp;will&nbsp;do&nbsp;the&nbsp;gc&nbsp;instead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1565865">mp</span>&nbsp;<span class="op" id="1565868">:=</span>&nbsp;<span class="ident" id="1565871">acquirem</span><span class="op" id="1565879">(</span><span class="op" id="1565880">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1565883">if</span>&nbsp;<span class="ident" id="1565886">gp</span>&nbsp;<span class="op" id="1565889">:=</span>&nbsp;<span class="ident" id="1565892">getg</span><span class="op" id="1565896">(</span><span class="op" id="1565897">)</span><span class="op" id="1565898">;</span>&nbsp;<span class="ident" id="1565900">gp</span>&nbsp;<span class="op" id="1565903">==</span>&nbsp;<span class="ident" id="1565906">mp</span><span class="op" id="1565908">.</span><span class="ident" id="1565909">g0</span>&nbsp;<span class="op" id="1565912">||</span>&nbsp;<span class="ident" id="1565915">mp</span><span class="op" id="1565917">.</span><span class="ident" id="1565918">locks</span>&nbsp;<span class="op" id="1565924">&gt;</span>&nbsp;<span class="num" id="1565926">1</span>&nbsp;<span class="op" id="1565928">||</span>&nbsp;<span class="op" id="1565931">!</span><span class="ident" id="1565932">memstats</span><span class="op" id="1565940">.</span><span class="ident" id="1565941">enablegc</span>&nbsp;<span class="op" id="1565950">||</span>&nbsp;<span class="ident" id="1565953">panicking</span>&nbsp;<span class="op" id="1565963">!=</span>&nbsp;<span class="num" id="1565966">0</span>&nbsp;<span class="op" id="1565968">||</span>&nbsp;<span class="ident" id="1565971">gcpercent</span>&nbsp;<span class="op" id="1565981">&lt;</span>&nbsp;<span class="num" id="1565983">0</span>&nbsp;<span class="op" id="1565985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1565989">releasem</span><span class="op" id="1565997">(</span><span class="ident" id="1565998">mp</span><span class="op" id="1566000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566004">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1566012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566015">releasem</span><span class="op" id="1566023">(</span><span class="ident" id="1566024">mp</span><span class="op" id="1566026">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566029">mp</span>&nbsp;<span class="op" id="1566032">=</span>&nbsp;<span class="builtintype" id="1566034">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566040">semacquire</span><span class="op" id="1566050">(</span><span class="op" id="1566051">&amp;</span><span class="ident" id="1566052">worldsema</span><span class="op" id="1566061">,</span>&nbsp;<span class="builtintype" id="1566063">false</span><span class="op" id="1566068">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566072">if</span>&nbsp;<span class="ident" id="1566075">force</span>&nbsp;<span class="op" id="1566081">==</span>&nbsp;<span class="num" id="1566084">0</span>&nbsp;<span class="op" id="1566086">&amp;&amp;</span>&nbsp;<span class="ident" id="1566089">memstats</span><span class="op" id="1566097">.</span><span class="ident" id="1566098">heap_alloc</span>&nbsp;<span class="op" id="1566109">&lt;</span>&nbsp;<span class="ident" id="1566111">memstats</span><span class="op" id="1566119">.</span><span class="ident" id="1566120">next_gc</span>&nbsp;<span class="op" id="1566128">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1566132">//&nbsp;typically&nbsp;threads&nbsp;which&nbsp;lost&nbsp;the&nbsp;race&nbsp;to&nbsp;grab</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1566183">//&nbsp;worldsema&nbsp;exit&nbsp;here&nbsp;when&nbsp;gc&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566225">semrelease</span><span class="op" id="1566235">(</span><span class="op" id="1566236">&amp;</span><span class="ident" id="1566237">worldsema</span><span class="op" id="1566246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566250">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1566258">}</span><br>
<span class="lineno">435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1566262">//&nbsp;Ok,&nbsp;we&#39;re&nbsp;doing&nbsp;it!&nbsp;&nbsp;Stop&nbsp;everybody&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566307">startTime</span>&nbsp;<span class="op" id="1566317">:=</span>&nbsp;<span class="ident" id="1566320">nanotime</span><span class="op" id="1566328">(</span><span class="op" id="1566329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566332">mp</span>&nbsp;<span class="op" id="1566335">=</span>&nbsp;<span class="ident" id="1566337">acquirem</span><span class="op" id="1566345">(</span><span class="op" id="1566346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566349">mp</span><span class="op" id="1566351">.</span><span class="ident" id="1566352">gcing</span>&nbsp;<span class="op" id="1566358">=</span>&nbsp;<span class="num" id="1566360">1</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566363">releasem</span><span class="op" id="1566371">(</span><span class="ident" id="1566372">mp</span><span class="op" id="1566374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566377">onM</span><span class="op" id="1566380">(</span><span class="ident" id="1566381">stoptheworld</span><span class="op" id="1566393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566396">if</span>&nbsp;<span class="ident" id="1566399">mp</span>&nbsp;<span class="op" id="1566402">!=</span>&nbsp;<span class="ident" id="1566405">acquirem</span><span class="op" id="1566413">(</span><span class="op" id="1566414">)</span>&nbsp;<span class="op" id="1566416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566420">gothrow</span><span class="op" id="1566427">(</span><span class="string" id="1566428">&#34;gogc:&nbsp;rescheduled&#34;</span><span class="op" id="1566447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1566450">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566454">clearpools</span><span class="op" id="1566464">(</span><span class="op" id="1566465">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1566469">//&nbsp;Run&nbsp;gc&nbsp;on&nbsp;the&nbsp;g0&nbsp;stack.&nbsp;&nbsp;We&nbsp;do&nbsp;this&nbsp;so&nbsp;that&nbsp;the&nbsp;g&nbsp;stack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1566529">//&nbsp;we&#39;re&nbsp;currently&nbsp;running&nbsp;on&nbsp;will&nbsp;no&nbsp;longer&nbsp;change.&nbsp;&nbsp;Cuts</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1566589">//&nbsp;the&nbsp;root&nbsp;set&nbsp;down&nbsp;a&nbsp;bit&nbsp;(g0&nbsp;stacks&nbsp;are&nbsp;not&nbsp;scanned,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1566649">//&nbsp;we&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;scan&nbsp;gc&#39;s&nbsp;internal&nbsp;state).&nbsp;&nbsp;We&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1566706">//&nbsp;need&nbsp;to&nbsp;switch&nbsp;to&nbsp;g0&nbsp;so&nbsp;we&nbsp;can&nbsp;shrink&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566759">n</span>&nbsp;<span class="op" id="1566761">:=</span>&nbsp;<span class="num" id="1566764">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566767">if</span>&nbsp;<span class="ident" id="1566770">debug</span><span class="op" id="1566775">.</span><span class="ident" id="1566776">gctrace</span>&nbsp;<span class="op" id="1566784">&gt;</span>&nbsp;<span class="num" id="1566786">1</span>&nbsp;<span class="op" id="1566788">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566792">n</span>&nbsp;<span class="op" id="1566794">=</span>&nbsp;<span class="num" id="1566796">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1566799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566802">for</span>&nbsp;<span class="ident" id="1566806">i</span>&nbsp;<span class="op" id="1566808">:=</span>&nbsp;<span class="num" id="1566811">0</span><span class="op" id="1566812">;</span>&nbsp;<span class="ident" id="1566814">i</span>&nbsp;<span class="op" id="1566816">&lt;</span>&nbsp;<span class="ident" id="1566818">n</span><span class="op" id="1566819">;</span>&nbsp;<span class="ident" id="1566821">i</span><span class="op" id="1566822">++</span>&nbsp;<span class="op" id="1566825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566829">if</span>&nbsp;<span class="ident" id="1566832">i</span>&nbsp;<span class="op" id="1566834">&gt;</span>&nbsp;<span class="num" id="1566836">0</span>&nbsp;<span class="op" id="1566838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566843">startTime</span>&nbsp;<span class="op" id="1566853">=</span>&nbsp;<span class="ident" id="1566855">nanotime</span><span class="op" id="1566863">(</span><span class="op" id="1566864">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1566868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1566872">//&nbsp;switch&nbsp;to&nbsp;g0,&nbsp;call&nbsp;gc,&nbsp;then&nbsp;switch&nbsp;back</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566917">mp</span><span class="op" id="1566919">.</span><span class="ident" id="1566920">scalararg</span><span class="op" id="1566929">[</span><span class="num" id="1566930">0</span><span class="op" id="1566931">]</span>&nbsp;<span class="op" id="1566933">=</span>&nbsp;<span class="builtintype" id="1566935">uintptr</span><span class="op" id="1566942">(</span><span class="builtintype" id="1566943">uint32</span><span class="op" id="1566949">(</span><span class="ident" id="1566950">startTime</span><span class="op" id="1566959">)</span><span class="op" id="1566960">)</span>&nbsp;<span class="comment" id="1566962">//&nbsp;low&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566979">mp</span><span class="op" id="1566981">.</span><span class="ident" id="1566982">scalararg</span><span class="op" id="1566991">[</span><span class="num" id="1566992">1</span><span class="op" id="1566993">]</span>&nbsp;<span class="op" id="1566995">=</span>&nbsp;<span class="builtintype" id="1566997">uintptr</span><span class="op" id="1567004">(</span><span class="ident" id="1567005">startTime</span>&nbsp;<span class="op" id="1567015">&gt;&gt;</span>&nbsp;<span class="num" id="1567018">32</span><span class="op" id="1567020">)</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1567024">//&nbsp;high&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1567042">if</span>&nbsp;<span class="ident" id="1567045">force</span>&nbsp;<span class="op" id="1567051">&gt;=</span>&nbsp;<span class="num" id="1567054">2</span>&nbsp;<span class="op" id="1567056">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567061">mp</span><span class="op" id="1567063">.</span><span class="ident" id="1567064">scalararg</span><span class="op" id="1567073">[</span><span class="num" id="1567074">2</span><span class="op" id="1567075">]</span>&nbsp;<span class="op" id="1567077">=</span>&nbsp;<span class="num" id="1567079">1</span>&nbsp;<span class="comment" id="1567081">//&nbsp;eagersweep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1567097">}</span>&nbsp;<span class="keyword" id="1567099">else</span>&nbsp;<span class="op" id="1567104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567109">mp</span><span class="op" id="1567111">.</span><span class="ident" id="1567112">scalararg</span><span class="op" id="1567121">[</span><span class="num" id="1567122">2</span><span class="op" id="1567123">]</span>&nbsp;<span class="op" id="1567125">=</span>&nbsp;<span class="num" id="1567127">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1567131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567135">onM</span><span class="op" id="1567138">(</span><span class="ident" id="1567139">gc_m</span><span class="op" id="1567143">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1567146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567150">//&nbsp;all&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567163">mp</span><span class="op" id="1567165">.</span><span class="ident" id="1567166">gcing</span>&nbsp;<span class="op" id="1567172">=</span>&nbsp;<span class="num" id="1567174">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567177">semrelease</span><span class="op" id="1567187">(</span><span class="op" id="1567188">&amp;</span><span class="ident" id="1567189">worldsema</span><span class="op" id="1567198">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567201">onM</span><span class="op" id="1567204">(</span><span class="ident" id="1567205">starttheworld</span><span class="op" id="1567218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567221">releasem</span><span class="op" id="1567229">(</span><span class="ident" id="1567230">mp</span><span class="op" id="1567232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567235">mp</span>&nbsp;<span class="op" id="1567238">=</span>&nbsp;<span class="builtintype" id="1567240">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567246">//&nbsp;now&nbsp;that&nbsp;gc&nbsp;is&nbsp;done,&nbsp;kick&nbsp;off&nbsp;finalizer&nbsp;thread&nbsp;if&nbsp;needed</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1567307">if</span>&nbsp;<span class="op" id="1567310">!</span><span class="ident" id="1567311">concurrentSweep</span>&nbsp;<span class="op" id="1567327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567331">//&nbsp;give&nbsp;the&nbsp;queued&nbsp;finalizers,&nbsp;if&nbsp;any,&nbsp;a&nbsp;chance&nbsp;to&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567388">Gosched</span><span class="op" id="1567395">(</span><span class="op" id="1567396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1567399">}</span><br>
<span class="lineno"></span><span class="op" id="1567401">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="1567404">//&nbsp;GC&nbsp;runs&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span><span class="keyword" id="1567437">func</span>&nbsp;<span class="ident" id="1567442">GC</span><span class="op" id="1567444">(</span><span class="op" id="1567445">)</span>&nbsp;<span class="op" id="1567447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567450">gogc</span><span class="op" id="1567454">(</span><span class="num" id="1567455">2</span><span class="op" id="1567456">)</span><br>
<span class="lineno"></span><span class="op" id="1567458">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="comment" id="1567461">//&nbsp;linker-provided</span><br>
<span class="lineno"></span><span class="keyword" id="1567480">var</span>&nbsp;<span class="ident" id="1567484">noptrdata</span>&nbsp;<span class="keyword" id="1567494">struct</span><span class="op" id="1567500">{</span><span class="op" id="1567501">}</span><br>
<span class="lineno"></span><span class="keyword" id="1567503">var</span>&nbsp;<span class="ident" id="1567507">enoptrdata</span>&nbsp;<span class="keyword" id="1567518">struct</span><span class="op" id="1567524">{</span><span class="op" id="1567525">}</span><br>
<span class="lineno"></span><span class="keyword" id="1567527">var</span>&nbsp;<span class="ident" id="1567531">noptrbss</span>&nbsp;<span class="keyword" id="1567540">struct</span><span class="op" id="1567546">{</span><span class="op" id="1567547">}</span><br>
<span class="lineno">495</span><span class="keyword" id="1567549">var</span>&nbsp;<span class="ident" id="1567553">enoptrbss</span>&nbsp;<span class="keyword" id="1567563">struct</span><span class="op" id="1567569">{</span><span class="op" id="1567570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1567573">//&nbsp;SetFinalizer&nbsp;sets&nbsp;the&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span><span class="comment" id="1567632">//&nbsp;When&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;finds&nbsp;an&nbsp;unreachable&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="1567689">//&nbsp;with&nbsp;an&nbsp;associated&nbsp;finalizer,&nbsp;it&nbsp;clears&nbsp;the&nbsp;association&nbsp;and&nbsp;runs</span><br>
<span class="lineno">500</span><span class="comment" id="1567757">//&nbsp;f(x)&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine.&nbsp;&nbsp;This&nbsp;makes&nbsp;x&nbsp;reachable&nbsp;again,&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="1567825">//&nbsp;now&nbsp;without&nbsp;an&nbsp;associated&nbsp;finalizer.&nbsp;&nbsp;Assuming&nbsp;that&nbsp;SetFinalizer</span><br>
<span class="lineno"></span><span class="comment" id="1567893">//&nbsp;is&nbsp;not&nbsp;called&nbsp;again,&nbsp;the&nbsp;next&nbsp;time&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;sees</span><br>
<span class="lineno"></span><span class="comment" id="1567958">//&nbsp;that&nbsp;x&nbsp;is&nbsp;unreachable,&nbsp;it&nbsp;will&nbsp;free&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1568000">//</span><br>
<span class="lineno">505</span><span class="comment" id="1568003">//&nbsp;SetFinalizer(x,&nbsp;nil)&nbsp;clears&nbsp;any&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1568067">//</span><br>
<span class="lineno"></span><span class="comment" id="1568070">//&nbsp;The&nbsp;argument&nbsp;x&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer&nbsp;to&nbsp;an&nbsp;object&nbsp;allocated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="1568132">//&nbsp;calling&nbsp;new&nbsp;or&nbsp;by&nbsp;taking&nbsp;the&nbsp;address&nbsp;of&nbsp;a&nbsp;composite&nbsp;literal.</span><br>
<span class="lineno"></span><span class="comment" id="1568196">//&nbsp;The&nbsp;argument&nbsp;f&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;that&nbsp;takes&nbsp;a&nbsp;single&nbsp;argument</span><br>
<span class="lineno">510</span><span class="comment" id="1568262">//&nbsp;to&nbsp;which&nbsp;x&#39;s&nbsp;type&nbsp;can&nbsp;be&nbsp;assigned,&nbsp;and&nbsp;can&nbsp;have&nbsp;arbitrary&nbsp;ignored&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="1568338">//&nbsp;values.&nbsp;If&nbsp;either&nbsp;of&nbsp;these&nbsp;is&nbsp;not&nbsp;true,&nbsp;SetFinalizer&nbsp;aborts&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1568405">//&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1568417">//</span><br>
<span class="lineno"></span><span class="comment" id="1568420">//&nbsp;Finalizers&nbsp;are&nbsp;run&nbsp;in&nbsp;dependency&nbsp;order:&nbsp;if&nbsp;A&nbsp;points&nbsp;at&nbsp;B,&nbsp;both&nbsp;have</span><br>
<span class="lineno">515</span><span class="comment" id="1568491">//&nbsp;finalizers,&nbsp;and&nbsp;they&nbsp;are&nbsp;otherwise&nbsp;unreachable,&nbsp;only&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1568561">//&nbsp;for&nbsp;A&nbsp;runs;&nbsp;once&nbsp;A&nbsp;is&nbsp;freed,&nbsp;the&nbsp;finalizer&nbsp;for&nbsp;B&nbsp;can&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="1568622">//&nbsp;If&nbsp;a&nbsp;cyclic&nbsp;structure&nbsp;includes&nbsp;a&nbsp;block&nbsp;with&nbsp;a&nbsp;finalizer,&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1568687">//&nbsp;cycle&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;and&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1568756">//&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;run,&nbsp;because&nbsp;there&nbsp;is&nbsp;no&nbsp;ordering&nbsp;that</span><br>
<span class="lineno">520</span><span class="comment" id="1568819">//&nbsp;respects&nbsp;the&nbsp;dependencies.</span><br>
<span class="lineno"></span><span class="comment" id="1568849">//</span><br>
<span class="lineno"></span><span class="comment" id="1568852">//&nbsp;The&nbsp;finalizer&nbsp;for&nbsp;x&nbsp;is&nbsp;scheduled&nbsp;to&nbsp;run&nbsp;at&nbsp;some&nbsp;arbitrary&nbsp;time&nbsp;after</span><br>
<span class="lineno"></span><span class="comment" id="1568924">//&nbsp;x&nbsp;becomes&nbsp;unreachable.</span><br>
<span class="lineno"></span><span class="comment" id="1568950">//&nbsp;There&nbsp;is&nbsp;no&nbsp;guarantee&nbsp;that&nbsp;finalizers&nbsp;will&nbsp;run&nbsp;before&nbsp;a&nbsp;program&nbsp;exits,</span><br>
<span class="lineno">525</span><span class="comment" id="1569024">//&nbsp;so&nbsp;typically&nbsp;they&nbsp;are&nbsp;useful&nbsp;only&nbsp;for&nbsp;releasing&nbsp;non-memory&nbsp;resources</span><br>
<span class="lineno"></span><span class="comment" id="1569096">//&nbsp;associated&nbsp;with&nbsp;an&nbsp;object&nbsp;during&nbsp;a&nbsp;long-running&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1569156">//&nbsp;For&nbsp;example,&nbsp;an&nbsp;os.File&nbsp;object&nbsp;could&nbsp;use&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;close&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1569225">//&nbsp;associated&nbsp;operating&nbsp;system&nbsp;file&nbsp;descriptor&nbsp;when&nbsp;a&nbsp;program&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="1569296">//&nbsp;an&nbsp;os.File&nbsp;without&nbsp;calling&nbsp;Close,&nbsp;but&nbsp;it&nbsp;would&nbsp;be&nbsp;a&nbsp;mistake</span><br>
<span class="lineno">530</span><span class="comment" id="1569359">//&nbsp;to&nbsp;depend&nbsp;on&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;flush&nbsp;an&nbsp;in-memory&nbsp;I/O&nbsp;buffer&nbsp;such&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1569430">//&nbsp;bufio.Writer,&nbsp;because&nbsp;the&nbsp;buffer&nbsp;would&nbsp;not&nbsp;be&nbsp;flushed&nbsp;at&nbsp;program&nbsp;exit.</span><br>
<span class="lineno"></span><span class="comment" id="1569504">//</span><br>
<span class="lineno"></span><span class="comment" id="1569507">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;if&nbsp;the&nbsp;size&nbsp;of&nbsp;*x&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1569578">//&nbsp;zero&nbsp;bytes.</span><br>
<span class="lineno">535</span><span class="comment" id="1569593">//</span><br>
<span class="lineno"></span><span class="comment" id="1569596">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;for&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1569668">//&nbsp;in&nbsp;initializers&nbsp;for&nbsp;package-level&nbsp;variables.&nbsp;Such&nbsp;objects&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1569736">//&nbsp;linker-allocated,&nbsp;not&nbsp;heap-allocated.</span><br>
<span class="lineno"></span><span class="comment" id="1569777">//</span><br>
<span class="lineno">540</span><span class="comment" id="1569780">//&nbsp;A&nbsp;single&nbsp;goroutine&nbsp;runs&nbsp;all&nbsp;finalizers&nbsp;for&nbsp;a&nbsp;program,&nbsp;sequentially.</span><br>
<span class="lineno"></span><span class="comment" id="1569851">//&nbsp;If&nbsp;a&nbsp;finalizer&nbsp;must&nbsp;run&nbsp;for&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;should&nbsp;do&nbsp;so&nbsp;by&nbsp;starting</span><br>
<span class="lineno"></span><span class="comment" id="1569923">//&nbsp;a&nbsp;new&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1569943">func</span>&nbsp;<span class="ident" id="1569948">SetFinalizer</span><span class="op" id="1569960">(</span><span class="ident" id="1569961">obj</span>&nbsp;<span class="keyword" id="1569965">interface</span><span class="op" id="1569974">{</span><span class="op" id="1569975">}</span><span class="op" id="1569976">,</span>&nbsp;<span class="ident" id="1569978">finalizer</span>&nbsp;<span class="keyword" id="1569988">interface</span><span class="op" id="1569997">{</span><span class="op" id="1569998">}</span><span class="op" id="1569999">)</span>&nbsp;<span class="op" id="1570001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570004">e</span>&nbsp;<span class="op" id="1570006">:=</span>&nbsp;<span class="op" id="1570009">(</span><span class="op" id="1570010">*</span><span class="ident" id="1570011">eface</span><span class="op" id="1570016">)</span><span class="op" id="1570017">(</span><span class="ident" id="1570018">unsafe</span><span class="op" id="1570024">.</span><span class="ident" id="1570025">Pointer</span><span class="op" id="1570032">(</span><span class="op" id="1570033">&amp;</span><span class="ident" id="1570034">obj</span><span class="op" id="1570037">)</span><span class="op" id="1570038">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570041">etyp</span>&nbsp;<span class="op" id="1570046">:=</span>&nbsp;<span class="ident" id="1570049">e</span><span class="op" id="1570050">.</span><span class="ident" id="1570051">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570058">if</span>&nbsp;<span class="ident" id="1570061">etyp</span>&nbsp;<span class="op" id="1570066">==</span>&nbsp;<span class="builtintype" id="1570069">nil</span>&nbsp;<span class="op" id="1570073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570077">gothrow</span><span class="op" id="1570084">(</span><span class="string" id="1570085">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;nil&#34;</span><span class="op" id="1570130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570136">if</span>&nbsp;<span class="ident" id="1570139">etyp</span><span class="op" id="1570143">.</span><span class="ident" id="1570144">kind</span><span class="op" id="1570148">&amp;</span><span class="ident" id="1570149">kindMask</span>&nbsp;<span class="op" id="1570158">!=</span>&nbsp;<span class="ident" id="1570161">kindPtr</span>&nbsp;<span class="op" id="1570169">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570173">gothrow</span><span class="op" id="1570180">(</span><span class="string" id="1570181">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1570224">+</span>&nbsp;<span class="op" id="1570226">*</span><span class="ident" id="1570227">etyp</span><span class="op" id="1570231">.</span><span class="ident" id="1570232">_string</span>&nbsp;<span class="op" id="1570240">+</span>&nbsp;<span class="string" id="1570242">&#34;,&nbsp;not&nbsp;pointer&#34;</span><span class="op" id="1570257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570263">ot</span>&nbsp;<span class="op" id="1570266">:=</span>&nbsp;<span class="op" id="1570269">(</span><span class="op" id="1570270">*</span><span class="ident" id="1570271">ptrtype</span><span class="op" id="1570278">)</span><span class="op" id="1570279">(</span><span class="ident" id="1570280">unsafe</span><span class="op" id="1570286">.</span><span class="ident" id="1570287">Pointer</span><span class="op" id="1570294">(</span><span class="ident" id="1570295">etyp</span><span class="op" id="1570299">)</span><span class="op" id="1570300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570303">if</span>&nbsp;<span class="ident" id="1570306">ot</span><span class="op" id="1570308">.</span><span class="ident" id="1570309">elem</span>&nbsp;<span class="op" id="1570314">==</span>&nbsp;<span class="builtintype" id="1570317">nil</span>&nbsp;<span class="op" id="1570321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570325">gothrow</span><span class="op" id="1570332">(</span><span class="string" id="1570333">&#34;nil&nbsp;elem&nbsp;type!&#34;</span><span class="op" id="1570349">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570356">//&nbsp;find&nbsp;the&nbsp;containing&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570387">_</span><span class="op" id="1570388">,</span>&nbsp;<span class="ident" id="1570390">base</span><span class="op" id="1570394">,</span>&nbsp;<span class="ident" id="1570396">_</span>&nbsp;<span class="op" id="1570398">:=</span>&nbsp;<span class="ident" id="1570401">findObject</span><span class="op" id="1570411">(</span><span class="ident" id="1570412">e</span><span class="op" id="1570413">.</span><span class="ident" id="1570414">data</span><span class="op" id="1570418">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570422">if</span>&nbsp;<span class="ident" id="1570425">base</span>&nbsp;<span class="op" id="1570430">==</span>&nbsp;<span class="builtintype" id="1570433">nil</span>&nbsp;<span class="op" id="1570437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570441">//&nbsp;0-length&nbsp;objects&nbsp;are&nbsp;okay.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570473">if</span>&nbsp;<span class="ident" id="1570476">e</span><span class="op" id="1570477">.</span><span class="ident" id="1570478">data</span>&nbsp;<span class="op" id="1570483">==</span>&nbsp;<span class="ident" id="1570486">unsafe</span><span class="op" id="1570492">.</span><span class="ident" id="1570493">Pointer</span><span class="op" id="1570500">(</span><span class="op" id="1570501">&amp;</span><span class="ident" id="1570502">zerobase</span><span class="op" id="1570510">)</span>&nbsp;<span class="op" id="1570512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570517">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570526">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570531">//&nbsp;Global&nbsp;initializers&nbsp;might&nbsp;be&nbsp;linker-allocated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570583">//&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;Foo&nbsp;=&nbsp;&amp;Object{}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570608">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;main()&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570627">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;runtime.SetFinalizer(Foo,&nbsp;nil)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570664">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570671">//&nbsp;The&nbsp;relevant&nbsp;segments&nbsp;are:&nbsp;noptrdata,&nbsp;data,&nbsp;bss,&nbsp;noptrbss.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570735">//&nbsp;We&nbsp;cannot&nbsp;assume&nbsp;they&nbsp;are&nbsp;in&nbsp;any&nbsp;order&nbsp;or&nbsp;even&nbsp;contiguous,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570799">//&nbsp;due&nbsp;to&nbsp;external&nbsp;linking.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570829">if</span>&nbsp;<span class="builtintype" id="1570832">uintptr</span><span class="op" id="1570839">(</span><span class="ident" id="1570840">unsafe</span><span class="op" id="1570846">.</span><span class="ident" id="1570847">Pointer</span><span class="op" id="1570854">(</span><span class="op" id="1570855">&amp;</span><span class="ident" id="1570856">noptrdata</span><span class="op" id="1570865">)</span><span class="op" id="1570866">)</span>&nbsp;<span class="op" id="1570868">&lt;=</span>&nbsp;<span class="builtintype" id="1570871">uintptr</span><span class="op" id="1570878">(</span><span class="ident" id="1570879">e</span><span class="op" id="1570880">.</span><span class="ident" id="1570881">data</span><span class="op" id="1570885">)</span>&nbsp;<span class="op" id="1570887">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1570890">uintptr</span><span class="op" id="1570897">(</span><span class="ident" id="1570898">e</span><span class="op" id="1570899">.</span><span class="ident" id="1570900">data</span><span class="op" id="1570904">)</span>&nbsp;<span class="op" id="1570906">&lt;</span>&nbsp;<span class="builtintype" id="1570908">uintptr</span><span class="op" id="1570915">(</span><span class="ident" id="1570916">unsafe</span><span class="op" id="1570922">.</span><span class="ident" id="1570923">Pointer</span><span class="op" id="1570930">(</span><span class="op" id="1570931">&amp;</span><span class="ident" id="1570932">enoptrdata</span><span class="op" id="1570942">)</span><span class="op" id="1570943">)</span>&nbsp;<span class="op" id="1570945">||</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1570951">uintptr</span><span class="op" id="1570958">(</span><span class="ident" id="1570959">unsafe</span><span class="op" id="1570965">.</span><span class="ident" id="1570966">Pointer</span><span class="op" id="1570973">(</span><span class="op" id="1570974">&amp;</span><span class="ident" id="1570975">data</span><span class="op" id="1570979">)</span><span class="op" id="1570980">)</span>&nbsp;<span class="op" id="1570982">&lt;=</span>&nbsp;<span class="builtintype" id="1570985">uintptr</span><span class="op" id="1570992">(</span><span class="ident" id="1570993">e</span><span class="op" id="1570994">.</span><span class="ident" id="1570995">data</span><span class="op" id="1570999">)</span>&nbsp;<span class="op" id="1571001">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1571004">uintptr</span><span class="op" id="1571011">(</span><span class="ident" id="1571012">e</span><span class="op" id="1571013">.</span><span class="ident" id="1571014">data</span><span class="op" id="1571018">)</span>&nbsp;<span class="op" id="1571020">&lt;</span>&nbsp;<span class="builtintype" id="1571022">uintptr</span><span class="op" id="1571029">(</span><span class="ident" id="1571030">unsafe</span><span class="op" id="1571036">.</span><span class="ident" id="1571037">Pointer</span><span class="op" id="1571044">(</span><span class="op" id="1571045">&amp;</span><span class="ident" id="1571046">edata</span><span class="op" id="1571051">)</span><span class="op" id="1571052">)</span>&nbsp;<span class="op" id="1571054">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1571060">uintptr</span><span class="op" id="1571067">(</span><span class="ident" id="1571068">unsafe</span><span class="op" id="1571074">.</span><span class="ident" id="1571075">Pointer</span><span class="op" id="1571082">(</span><span class="op" id="1571083">&amp;</span><span class="ident" id="1571084">bss</span><span class="op" id="1571087">)</span><span class="op" id="1571088">)</span>&nbsp;<span class="op" id="1571090">&lt;=</span>&nbsp;<span class="builtintype" id="1571093">uintptr</span><span class="op" id="1571100">(</span><span class="ident" id="1571101">e</span><span class="op" id="1571102">.</span><span class="ident" id="1571103">data</span><span class="op" id="1571107">)</span>&nbsp;<span class="op" id="1571109">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1571112">uintptr</span><span class="op" id="1571119">(</span><span class="ident" id="1571120">e</span><span class="op" id="1571121">.</span><span class="ident" id="1571122">data</span><span class="op" id="1571126">)</span>&nbsp;<span class="op" id="1571128">&lt;</span>&nbsp;<span class="builtintype" id="1571130">uintptr</span><span class="op" id="1571137">(</span><span class="ident" id="1571138">unsafe</span><span class="op" id="1571144">.</span><span class="ident" id="1571145">Pointer</span><span class="op" id="1571152">(</span><span class="op" id="1571153">&amp;</span><span class="ident" id="1571154">ebss</span><span class="op" id="1571158">)</span><span class="op" id="1571159">)</span>&nbsp;<span class="op" id="1571161">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1571167">uintptr</span><span class="op" id="1571174">(</span><span class="ident" id="1571175">unsafe</span><span class="op" id="1571181">.</span><span class="ident" id="1571182">Pointer</span><span class="op" id="1571189">(</span><span class="op" id="1571190">&amp;</span><span class="ident" id="1571191">noptrbss</span><span class="op" id="1571199">)</span><span class="op" id="1571200">)</span>&nbsp;<span class="op" id="1571202">&lt;=</span>&nbsp;<span class="builtintype" id="1571205">uintptr</span><span class="op" id="1571212">(</span><span class="ident" id="1571213">e</span><span class="op" id="1571214">.</span><span class="ident" id="1571215">data</span><span class="op" id="1571219">)</span>&nbsp;<span class="op" id="1571221">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1571224">uintptr</span><span class="op" id="1571231">(</span><span class="ident" id="1571232">e</span><span class="op" id="1571233">.</span><span class="ident" id="1571234">data</span><span class="op" id="1571238">)</span>&nbsp;<span class="op" id="1571240">&lt;</span>&nbsp;<span class="builtintype" id="1571242">uintptr</span><span class="op" id="1571249">(</span><span class="ident" id="1571250">unsafe</span><span class="op" id="1571256">.</span><span class="ident" id="1571257">Pointer</span><span class="op" id="1571264">(</span><span class="op" id="1571265">&amp;</span><span class="ident" id="1571266">enoptrbss</span><span class="op" id="1571275">)</span><span class="op" id="1571276">)</span>&nbsp;<span class="op" id="1571278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571283">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571292">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571296">gothrow</span><span class="op" id="1571303">(</span><span class="string" id="1571304">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;in&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1571358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571365">if</span>&nbsp;<span class="ident" id="1571368">e</span><span class="op" id="1571369">.</span><span class="ident" id="1571370">data</span>&nbsp;<span class="op" id="1571375">!=</span>&nbsp;<span class="ident" id="1571378">base</span>&nbsp;<span class="op" id="1571383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1571387">//&nbsp;As&nbsp;an&nbsp;implementation&nbsp;detail&nbsp;we&nbsp;allow&nbsp;to&nbsp;set&nbsp;finalizers&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1571465">//&nbsp;of&nbsp;an&nbsp;object&nbsp;if&nbsp;it&nbsp;could&nbsp;come&nbsp;from&nbsp;tiny&nbsp;alloc&nbsp;(see&nbsp;mallocgc&nbsp;for&nbsp;details).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571544">if</span>&nbsp;<span class="ident" id="1571547">ot</span><span class="op" id="1571549">.</span><span class="ident" id="1571550">elem</span>&nbsp;<span class="op" id="1571555">==</span>&nbsp;<span class="builtintype" id="1571558">nil</span>&nbsp;<span class="op" id="1571562">||</span>&nbsp;<span class="ident" id="1571565">ot</span><span class="op" id="1571567">.</span><span class="ident" id="1571568">elem</span><span class="op" id="1571572">.</span><span class="ident" id="1571573">kind</span><span class="op" id="1571577">&amp;</span><span class="ident" id="1571578">kindNoPointers</span>&nbsp;<span class="op" id="1571593">==</span>&nbsp;<span class="num" id="1571596">0</span>&nbsp;<span class="op" id="1571598">||</span>&nbsp;<span class="ident" id="1571601">ot</span><span class="op" id="1571603">.</span><span class="ident" id="1571604">elem</span><span class="op" id="1571608">.</span><span class="ident" id="1571609">size</span>&nbsp;<span class="op" id="1571614">&gt;=</span>&nbsp;<span class="ident" id="1571617">maxTinySize</span>&nbsp;<span class="op" id="1571629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571634">gothrow</span><span class="op" id="1571641">(</span><span class="string" id="1571642">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;at&nbsp;beginning&nbsp;of&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1571709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571716">}</span><br>
<span class="lineno">590</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571720">f</span>&nbsp;<span class="op" id="1571722">:=</span>&nbsp;<span class="op" id="1571725">(</span><span class="op" id="1571726">*</span><span class="ident" id="1571727">eface</span><span class="op" id="1571732">)</span><span class="op" id="1571733">(</span><span class="ident" id="1571734">unsafe</span><span class="op" id="1571740">.</span><span class="ident" id="1571741">Pointer</span><span class="op" id="1571748">(</span><span class="op" id="1571749">&amp;</span><span class="ident" id="1571750">finalizer</span><span class="op" id="1571759">)</span><span class="op" id="1571760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571763">ftyp</span>&nbsp;<span class="op" id="1571768">:=</span>&nbsp;<span class="ident" id="1571771">f</span><span class="op" id="1571772">.</span><span class="ident" id="1571773">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571780">if</span>&nbsp;<span class="ident" id="1571783">ftyp</span>&nbsp;<span class="op" id="1571788">==</span>&nbsp;<span class="builtintype" id="1571791">nil</span>&nbsp;<span class="op" id="1571795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1571799">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;and&nbsp;remove&nbsp;finalizer</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571843">mp</span>&nbsp;<span class="op" id="1571846">:=</span>&nbsp;<span class="ident" id="1571849">acquirem</span><span class="op" id="1571857">(</span><span class="op" id="1571858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571862">mp</span><span class="op" id="1571864">.</span><span class="ident" id="1571865">ptrarg</span><span class="op" id="1571871">[</span><span class="num" id="1571872">0</span><span class="op" id="1571873">]</span>&nbsp;<span class="op" id="1571875">=</span>&nbsp;<span class="ident" id="1571877">e</span><span class="op" id="1571878">.</span><span class="ident" id="1571879">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571886">onM</span><span class="op" id="1571889">(</span><span class="ident" id="1571890">removeFinalizer_m</span><span class="op" id="1571907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571911">releasem</span><span class="op" id="1571919">(</span><span class="ident" id="1571920">mp</span><span class="op" id="1571922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571926">return</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571938">if</span>&nbsp;<span class="ident" id="1571941">ftyp</span><span class="op" id="1571945">.</span><span class="ident" id="1571946">kind</span><span class="op" id="1571950">&amp;</span><span class="ident" id="1571951">kindMask</span>&nbsp;<span class="op" id="1571960">!=</span>&nbsp;<span class="ident" id="1571963">kindFunc</span>&nbsp;<span class="op" id="1571972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571976">gothrow</span><span class="op" id="1571983">(</span><span class="string" id="1571984">&#34;runtime.SetFinalizer:&nbsp;second&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1572028">+</span>&nbsp;<span class="op" id="1572030">*</span><span class="ident" id="1572031">ftyp</span><span class="op" id="1572035">.</span><span class="ident" id="1572036">_string</span>&nbsp;<span class="op" id="1572044">+</span>&nbsp;<span class="string" id="1572046">&#34;,&nbsp;not&nbsp;a&nbsp;function&#34;</span><span class="op" id="1572064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1572067">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572070">ft</span>&nbsp;<span class="op" id="1572073">:=</span>&nbsp;<span class="op" id="1572076">(</span><span class="op" id="1572077">*</span><span class="ident" id="1572078">functype</span><span class="op" id="1572086">)</span><span class="op" id="1572087">(</span><span class="ident" id="1572088">unsafe</span><span class="op" id="1572094">.</span><span class="ident" id="1572095">Pointer</span><span class="op" id="1572102">(</span><span class="ident" id="1572103">ftyp</span><span class="op" id="1572107">)</span><span class="op" id="1572108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572111">ins</span>&nbsp;<span class="op" id="1572115">:=</span>&nbsp;<span class="op" id="1572118">*</span><span class="op" id="1572119">(</span><span class="op" id="1572120">*</span><span class="op" id="1572121">[</span><span class="op" id="1572122">]</span><span class="op" id="1572123">*</span><span class="ident" id="1572124">_type</span><span class="op" id="1572129">)</span><span class="op" id="1572130">(</span><span class="ident" id="1572131">unsafe</span><span class="op" id="1572137">.</span><span class="ident" id="1572138">Pointer</span><span class="op" id="1572145">(</span><span class="op" id="1572146">&amp;</span><span class="ident" id="1572147">ft</span><span class="op" id="1572149">.</span><span class="ident" id="1572150">in</span><span class="op" id="1572152">)</span><span class="op" id="1572153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1572156">if</span>&nbsp;<span class="ident" id="1572159">ft</span><span class="op" id="1572161">.</span><span class="ident" id="1572162">dotdotdot</span>&nbsp;<span class="op" id="1572172">||</span>&nbsp;<span class="builtinfunc" id="1572175">len</span><span class="op" id="1572178">(</span><span class="ident" id="1572179">ins</span><span class="op" id="1572182">)</span>&nbsp;<span class="op" id="1572184">!=</span>&nbsp;<span class="num" id="1572187">1</span>&nbsp;<span class="op" id="1572189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572193">gothrow</span><span class="op" id="1572200">(</span><span class="string" id="1572201">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1572238">+</span>&nbsp;<span class="op" id="1572240">*</span><span class="ident" id="1572241">etyp</span><span class="op" id="1572245">.</span><span class="ident" id="1572246">_string</span>&nbsp;<span class="op" id="1572254">+</span>&nbsp;<span class="string" id="1572256">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1572273">+</span>&nbsp;<span class="op" id="1572275">*</span><span class="ident" id="1572276">ftyp</span><span class="op" id="1572280">.</span><span class="ident" id="1572281">_string</span><span class="op" id="1572288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1572291">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572294">fint</span>&nbsp;<span class="op" id="1572299">:=</span>&nbsp;<span class="ident" id="1572302">ins</span><span class="op" id="1572305">[</span><span class="num" id="1572306">0</span><span class="op" id="1572307">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1572310">switch</span>&nbsp;<span class="op" id="1572317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1572320">case</span>&nbsp;<span class="ident" id="1572325">fint</span>&nbsp;<span class="op" id="1572330">==</span>&nbsp;<span class="ident" id="1572333">etyp</span><span class="op" id="1572337">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1572341">//&nbsp;ok&nbsp;-&nbsp;same&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1572361">goto</span>&nbsp;<span class="ident" id="1572366">okarg</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1572373">case</span>&nbsp;<span class="ident" id="1572378">fint</span><span class="op" id="1572382">.</span><span class="ident" id="1572383">kind</span><span class="op" id="1572387">&amp;</span><span class="ident" id="1572388">kindMask</span>&nbsp;<span class="op" id="1572397">==</span>&nbsp;<span class="ident" id="1572400">kindPtr</span><span class="op" id="1572407">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1572411">if</span>&nbsp;<span class="op" id="1572414">(</span><span class="ident" id="1572415">fint</span><span class="op" id="1572419">.</span><span class="ident" id="1572420">x</span>&nbsp;<span class="op" id="1572422">==</span>&nbsp;<span class="builtintype" id="1572425">nil</span>&nbsp;<span class="op" id="1572429">||</span>&nbsp;<span class="ident" id="1572432">fint</span><span class="op" id="1572436">.</span><span class="ident" id="1572437">x</span><span class="op" id="1572438">.</span><span class="ident" id="1572439">name</span>&nbsp;<span class="op" id="1572444">==</span>&nbsp;<span class="builtintype" id="1572447">nil</span>&nbsp;<span class="op" id="1572451">||</span>&nbsp;<span class="ident" id="1572454">etyp</span><span class="op" id="1572458">.</span><span class="ident" id="1572459">x</span>&nbsp;<span class="op" id="1572461">==</span>&nbsp;<span class="builtintype" id="1572464">nil</span>&nbsp;<span class="op" id="1572468">||</span>&nbsp;<span class="ident" id="1572471">etyp</span><span class="op" id="1572475">.</span><span class="ident" id="1572476">x</span><span class="op" id="1572477">.</span><span class="ident" id="1572478">name</span>&nbsp;<span class="op" id="1572483">==</span>&nbsp;<span class="builtintype" id="1572486">nil</span><span class="op" id="1572489">)</span>&nbsp;<span class="op" id="1572491">&amp;&amp;</span>&nbsp;<span class="op" id="1572494">(</span><span class="op" id="1572495">*</span><span class="ident" id="1572496">ptrtype</span><span class="op" id="1572503">)</span><span class="op" id="1572504">(</span><span class="ident" id="1572505">unsafe</span><span class="op" id="1572511">.</span><span class="ident" id="1572512">Pointer</span><span class="op" id="1572519">(</span><span class="ident" id="1572520">fint</span><span class="op" id="1572524">)</span><span class="op" id="1572525">)</span><span class="op" id="1572526">.</span><span class="ident" id="1572527">elem</span>&nbsp;<span class="op" id="1572532">==</span>&nbsp;<span class="ident" id="1572535">ot</span><span class="op" id="1572537">.</span><span class="ident" id="1572538">elem</span>&nbsp;<span class="op" id="1572543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1572548">//&nbsp;ok&nbsp;-&nbsp;not&nbsp;same&nbsp;type,&nbsp;but&nbsp;both&nbsp;pointers,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1572593">//&nbsp;one&nbsp;or&nbsp;the&nbsp;other&nbsp;is&nbsp;unnamed,&nbsp;and&nbsp;same&nbsp;element&nbsp;type,&nbsp;so&nbsp;assignable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1572666">goto</span>&nbsp;<span class="ident" id="1572671">okarg</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1572679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1572682">case</span>&nbsp;<span class="ident" id="1572687">fint</span><span class="op" id="1572691">.</span><span class="ident" id="1572692">kind</span><span class="op" id="1572696">&amp;</span><span class="ident" id="1572697">kindMask</span>&nbsp;<span class="op" id="1572706">==</span>&nbsp;<span class="ident" id="1572709">kindInterface</span><span class="op" id="1572722">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572726">ityp</span>&nbsp;<span class="op" id="1572731">:=</span>&nbsp;<span class="op" id="1572734">(</span><span class="op" id="1572735">*</span><span class="ident" id="1572736">interfacetype</span><span class="op" id="1572749">)</span><span class="op" id="1572750">(</span><span class="ident" id="1572751">unsafe</span><span class="op" id="1572757">.</span><span class="ident" id="1572758">Pointer</span><span class="op" id="1572765">(</span><span class="ident" id="1572766">fint</span><span class="op" id="1572770">)</span><span class="op" id="1572771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1572775">if</span>&nbsp;<span class="builtinfunc" id="1572778">len</span><span class="op" id="1572781">(</span><span class="ident" id="1572782">ityp</span><span class="op" id="1572786">.</span><span class="ident" id="1572787">mhdr</span><span class="op" id="1572791">)</span>&nbsp;<span class="op" id="1572793">==</span>&nbsp;<span class="num" id="1572796">0</span>&nbsp;<span class="op" id="1572798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1572803">//&nbsp;ok&nbsp;-&nbsp;satisfies&nbsp;empty&nbsp;interface</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1572840">goto</span>&nbsp;<span class="ident" id="1572845">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1572853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1572857">if</span>&nbsp;<span class="ident" id="1572860">_</span><span class="op" id="1572861">,</span>&nbsp;<span class="ident" id="1572863">ok</span>&nbsp;<span class="op" id="1572866">:=</span>&nbsp;<span class="ident" id="1572869">assertE2I2</span><span class="op" id="1572879">(</span><span class="ident" id="1572880">ityp</span><span class="op" id="1572884">,</span>&nbsp;<span class="ident" id="1572886">obj</span><span class="op" id="1572889">)</span><span class="op" id="1572890">;</span>&nbsp;<span class="ident" id="1572892">ok</span>&nbsp;<span class="op" id="1572895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1572900">goto</span>&nbsp;<span class="ident" id="1572905">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1572913">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1572916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572919">gothrow</span><span class="op" id="1572926">(</span><span class="string" id="1572927">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1572964">+</span>&nbsp;<span class="op" id="1572966">*</span><span class="ident" id="1572967">etyp</span><span class="op" id="1572971">.</span><span class="ident" id="1572972">_string</span>&nbsp;<span class="op" id="1572980">+</span>&nbsp;<span class="string" id="1572982">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1572999">+</span>&nbsp;<span class="op" id="1573001">*</span><span class="ident" id="1573002">ftyp</span><span class="op" id="1573006">.</span><span class="ident" id="1573007">_string</span><span class="op" id="1573014">)</span><br>
<span class="lineno"></span><span class="ident" id="1573016">okarg</span><span class="op" id="1573021">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1573024">//&nbsp;compute&nbsp;size&nbsp;needed&nbsp;for&nbsp;return&nbsp;parameters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573070">nret</span>&nbsp;<span class="op" id="1573075">:=</span>&nbsp;<span class="builtintype" id="1573078">uintptr</span><span class="op" id="1573085">(</span><span class="num" id="1573086">0</span><span class="op" id="1573087">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1573090">for</span>&nbsp;<span class="ident" id="1573094">_</span><span class="op" id="1573095">,</span>&nbsp;<span class="ident" id="1573097">t</span>&nbsp;<span class="op" id="1573099">:=</span>&nbsp;<span class="keyword" id="1573102">range</span>&nbsp;<span class="op" id="1573108">*</span><span class="op" id="1573109">(</span><span class="op" id="1573110">*</span><span class="op" id="1573111">[</span><span class="op" id="1573112">]</span><span class="op" id="1573113">*</span><span class="ident" id="1573114">_type</span><span class="op" id="1573119">)</span><span class="op" id="1573120">(</span><span class="ident" id="1573121">unsafe</span><span class="op" id="1573127">.</span><span class="ident" id="1573128">Pointer</span><span class="op" id="1573135">(</span><span class="op" id="1573136">&amp;</span><span class="ident" id="1573137">ft</span><span class="op" id="1573139">.</span><span class="ident" id="1573140">out</span><span class="op" id="1573143">)</span><span class="op" id="1573144">)</span>&nbsp;<span class="op" id="1573146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573150">nret</span>&nbsp;<span class="op" id="1573155">=</span>&nbsp;<span class="ident" id="1573157">round</span><span class="op" id="1573162">(</span><span class="ident" id="1573163">nret</span><span class="op" id="1573167">,</span>&nbsp;<span class="builtintype" id="1573169">uintptr</span><span class="op" id="1573176">(</span><span class="ident" id="1573177">t</span><span class="op" id="1573178">.</span><span class="ident" id="1573179">align</span><span class="op" id="1573184">)</span><span class="op" id="1573185">)</span>&nbsp;<span class="op" id="1573187">+</span>&nbsp;<span class="builtintype" id="1573189">uintptr</span><span class="op" id="1573196">(</span><span class="ident" id="1573197">t</span><span class="op" id="1573198">.</span><span class="ident" id="1573199">size</span><span class="op" id="1573203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1573206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573209">nret</span>&nbsp;<span class="op" id="1573214">=</span>&nbsp;<span class="ident" id="1573216">round</span><span class="op" id="1573221">(</span><span class="ident" id="1573222">nret</span><span class="op" id="1573226">,</span>&nbsp;<span class="ident" id="1573228">ptrSize</span><span class="op" id="1573235">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1573239">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;have&nbsp;a&nbsp;finalizer&nbsp;goroutine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573283">createfing</span><span class="op" id="1573293">(</span><span class="op" id="1573294">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1573298">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;to&nbsp;add&nbsp;finalizer&nbsp;record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573344">mp</span>&nbsp;<span class="op" id="1573347">:=</span>&nbsp;<span class="ident" id="1573350">acquirem</span><span class="op" id="1573358">(</span><span class="op" id="1573359">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573362">mp</span><span class="op" id="1573364">.</span><span class="ident" id="1573365">ptrarg</span><span class="op" id="1573371">[</span><span class="num" id="1573372">0</span><span class="op" id="1573373">]</span>&nbsp;<span class="op" id="1573375">=</span>&nbsp;<span class="ident" id="1573377">f</span><span class="op" id="1573378">.</span><span class="ident" id="1573379">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573385">mp</span><span class="op" id="1573387">.</span><span class="ident" id="1573388">ptrarg</span><span class="op" id="1573394">[</span><span class="num" id="1573395">1</span><span class="op" id="1573396">]</span>&nbsp;<span class="op" id="1573398">=</span>&nbsp;<span class="ident" id="1573400">e</span><span class="op" id="1573401">.</span><span class="ident" id="1573402">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573408">mp</span><span class="op" id="1573410">.</span><span class="ident" id="1573411">scalararg</span><span class="op" id="1573420">[</span><span class="num" id="1573421">0</span><span class="op" id="1573422">]</span>&nbsp;<span class="op" id="1573424">=</span>&nbsp;<span class="ident" id="1573426">nret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573432">mp</span><span class="op" id="1573434">.</span><span class="ident" id="1573435">ptrarg</span><span class="op" id="1573441">[</span><span class="num" id="1573442">2</span><span class="op" id="1573443">]</span>&nbsp;<span class="op" id="1573445">=</span>&nbsp;<span class="ident" id="1573447">unsafe</span><span class="op" id="1573453">.</span><span class="ident" id="1573454">Pointer</span><span class="op" id="1573461">(</span><span class="ident" id="1573462">fint</span><span class="op" id="1573466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573469">mp</span><span class="op" id="1573471">.</span><span class="ident" id="1573472">ptrarg</span><span class="op" id="1573478">[</span><span class="num" id="1573479">3</span><span class="op" id="1573480">]</span>&nbsp;<span class="op" id="1573482">=</span>&nbsp;<span class="ident" id="1573484">unsafe</span><span class="op" id="1573490">.</span><span class="ident" id="1573491">Pointer</span><span class="op" id="1573498">(</span><span class="ident" id="1573499">ot</span><span class="op" id="1573501">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573504">onM</span><span class="op" id="1573507">(</span><span class="ident" id="1573508">setFinalizer_m</span><span class="op" id="1573522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1573525">if</span>&nbsp;<span class="ident" id="1573528">mp</span><span class="op" id="1573530">.</span><span class="ident" id="1573531">scalararg</span><span class="op" id="1573540">[</span><span class="num" id="1573541">0</span><span class="op" id="1573542">]</span>&nbsp;<span class="op" id="1573544">!=</span>&nbsp;<span class="num" id="1573547">1</span>&nbsp;<span class="op" id="1573549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573553">gothrow</span><span class="op" id="1573560">(</span><span class="string" id="1573561">&#34;runtime.SetFinalizer:&nbsp;finalizer&nbsp;already&nbsp;set&#34;</span><span class="op" id="1573606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1573609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573612">releasem</span><span class="op" id="1573620">(</span><span class="ident" id="1573621">mp</span><span class="op" id="1573623">)</span><br>
<span class="lineno">655</span><span class="op" id="1573625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1573628">//&nbsp;round&nbsp;n&nbsp;up&nbsp;to&nbsp;a&nbsp;multiple&nbsp;of&nbsp;a.&nbsp;&nbsp;a&nbsp;must&nbsp;be&nbsp;a&nbsp;power&nbsp;of&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="1573687">func</span>&nbsp;<span class="ident" id="1573692">round</span><span class="op" id="1573697">(</span><span class="ident" id="1573698">n</span><span class="op" id="1573699">,</span>&nbsp;<span class="ident" id="1573701">a</span>&nbsp;<span class="builtintype" id="1573703">uintptr</span><span class="op" id="1573710">)</span>&nbsp;<span class="builtintype" id="1573712">uintptr</span>&nbsp;<span class="op" id="1573720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1573723">return</span>&nbsp;<span class="op" id="1573730">(</span><span class="ident" id="1573731">n</span>&nbsp;<span class="op" id="1573733">+</span>&nbsp;<span class="ident" id="1573735">a</span>&nbsp;<span class="op" id="1573737">-</span>&nbsp;<span class="num" id="1573739">1</span><span class="op" id="1573740">)</span>&nbsp;<span class="op" id="1573742">&amp;^</span>&nbsp;<span class="op" id="1573745">(</span><span class="ident" id="1573746">a</span>&nbsp;<span class="op" id="1573748">-</span>&nbsp;<span class="num" id="1573750">1</span><span class="op" id="1573751">)</span><br>
<span class="lineno">660</span><span class="op" id="1573753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1573756">//&nbsp;Look&nbsp;up&nbsp;pointer&nbsp;v&nbsp;in&nbsp;heap.&nbsp;&nbsp;Return&nbsp;the&nbsp;span&nbsp;containing&nbsp;the&nbsp;object,</span><br>
<span class="lineno"></span><span class="comment" id="1573826">//&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;object,&nbsp;and&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;If&nbsp;the&nbsp;object</span><br>
<span class="lineno"></span><span class="comment" id="1573897">//&nbsp;does&nbsp;not&nbsp;exist,&nbsp;return&nbsp;nil,&nbsp;nil,&nbsp;0.</span><br>
<span class="lineno">665</span><span class="keyword" id="1573936">func</span>&nbsp;<span class="ident" id="1573941">findObject</span><span class="op" id="1573951">(</span><span class="ident" id="1573952">v</span>&nbsp;<span class="ident" id="1573954">unsafe</span><span class="op" id="1573960">.</span><span class="ident" id="1573961">Pointer</span><span class="op" id="1573968">)</span>&nbsp;<span class="op" id="1573970">(</span><span class="ident" id="1573971">s</span>&nbsp;<span class="op" id="1573973">*</span><span class="ident" id="1573974">mspan</span><span class="op" id="1573979">,</span>&nbsp;<span class="ident" id="1573981">x</span>&nbsp;<span class="ident" id="1573983">unsafe</span><span class="op" id="1573989">.</span><span class="ident" id="1573990">Pointer</span><span class="op" id="1573997">,</span>&nbsp;<span class="ident" id="1573999">n</span>&nbsp;<span class="builtintype" id="1574001">uintptr</span><span class="op" id="1574008">)</span>&nbsp;<span class="op" id="1574010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574013">c</span>&nbsp;<span class="op" id="1574015">:=</span>&nbsp;<span class="ident" id="1574018">gomcache</span><span class="op" id="1574026">(</span><span class="op" id="1574027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574030">c</span><span class="op" id="1574031">.</span><span class="ident" id="1574032">local_nlookup</span><span class="op" id="1574045">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1574049">if</span>&nbsp;<span class="ident" id="1574052">ptrSize</span>&nbsp;<span class="op" id="1574060">==</span>&nbsp;<span class="num" id="1574063">4</span>&nbsp;<span class="op" id="1574065">&amp;&amp;</span>&nbsp;<span class="ident" id="1574068">c</span><span class="op" id="1574069">.</span><span class="ident" id="1574070">local_nlookup</span>&nbsp;<span class="op" id="1574084">&gt;=</span>&nbsp;<span class="num" id="1574087">1</span><span class="op" id="1574088">&lt;&lt;</span><span class="num" id="1574090">30</span>&nbsp;<span class="op" id="1574093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1574097">//&nbsp;purge&nbsp;cache&nbsp;stats&nbsp;to&nbsp;prevent&nbsp;overflow</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574140">lock</span><span class="op" id="1574144">(</span><span class="op" id="1574145">&amp;</span><span class="ident" id="1574146">mheap_</span><span class="op" id="1574152">.</span><span class="ident" id="1574153">lock</span><span class="op" id="1574157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574161">purgecachedstats</span><span class="op" id="1574177">(</span><span class="ident" id="1574178">c</span><span class="op" id="1574179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574183">unlock</span><span class="op" id="1574189">(</span><span class="op" id="1574190">&amp;</span><span class="ident" id="1574191">mheap_</span><span class="op" id="1574197">.</span><span class="ident" id="1574198">lock</span><span class="op" id="1574202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1574205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1574209">//&nbsp;find&nbsp;span</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574223">arena_start</span>&nbsp;<span class="op" id="1574235">:=</span>&nbsp;<span class="builtintype" id="1574238">uintptr</span><span class="op" id="1574245">(</span><span class="ident" id="1574246">unsafe</span><span class="op" id="1574252">.</span><span class="ident" id="1574253">Pointer</span><span class="op" id="1574260">(</span><span class="ident" id="1574261">mheap_</span><span class="op" id="1574267">.</span><span class="ident" id="1574268">arena_start</span><span class="op" id="1574279">)</span><span class="op" id="1574280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574283">arena_used</span>&nbsp;<span class="op" id="1574294">:=</span>&nbsp;<span class="builtintype" id="1574297">uintptr</span><span class="op" id="1574304">(</span><span class="ident" id="1574305">unsafe</span><span class="op" id="1574311">.</span><span class="ident" id="1574312">Pointer</span><span class="op" id="1574319">(</span><span class="ident" id="1574320">mheap_</span><span class="op" id="1574326">.</span><span class="ident" id="1574327">arena_used</span><span class="op" id="1574337">)</span><span class="op" id="1574338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1574341">if</span>&nbsp;<span class="builtintype" id="1574344">uintptr</span><span class="op" id="1574351">(</span><span class="ident" id="1574352">v</span><span class="op" id="1574353">)</span>&nbsp;<span class="op" id="1574355">&lt;</span>&nbsp;<span class="ident" id="1574357">arena_start</span>&nbsp;<span class="op" id="1574369">||</span>&nbsp;<span class="builtintype" id="1574372">uintptr</span><span class="op" id="1574379">(</span><span class="ident" id="1574380">v</span><span class="op" id="1574381">)</span>&nbsp;<span class="op" id="1574383">&gt;=</span>&nbsp;<span class="ident" id="1574386">arena_used</span>&nbsp;<span class="op" id="1574397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1574401">return</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1574409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574412">p</span>&nbsp;<span class="op" id="1574414">:=</span>&nbsp;<span class="builtintype" id="1574417">uintptr</span><span class="op" id="1574424">(</span><span class="ident" id="1574425">v</span><span class="op" id="1574426">)</span>&nbsp;<span class="op" id="1574428">&gt;&gt;</span>&nbsp;<span class="ident" id="1574431">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574442">q</span>&nbsp;<span class="op" id="1574444">:=</span>&nbsp;<span class="ident" id="1574447">p</span>&nbsp;<span class="op" id="1574449">-</span>&nbsp;<span class="ident" id="1574451">arena_start</span><span class="op" id="1574462">&gt;&gt;</span><span class="ident" id="1574464">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574475">s</span>&nbsp;<span class="op" id="1574477">=</span>&nbsp;<span class="op" id="1574479">*</span><span class="op" id="1574480">(</span><span class="op" id="1574481">*</span><span class="op" id="1574482">*</span><span class="ident" id="1574483">mspan</span><span class="op" id="1574488">)</span><span class="op" id="1574489">(</span><span class="ident" id="1574490">add</span><span class="op" id="1574493">(</span><span class="ident" id="1574494">unsafe</span><span class="op" id="1574500">.</span><span class="ident" id="1574501">Pointer</span><span class="op" id="1574508">(</span><span class="ident" id="1574509">mheap_</span><span class="op" id="1574515">.</span><span class="ident" id="1574516">spans</span><span class="op" id="1574521">)</span><span class="op" id="1574522">,</span>&nbsp;<span class="ident" id="1574524">q</span><span class="op" id="1574525">*</span><span class="ident" id="1574526">ptrSize</span><span class="op" id="1574533">)</span><span class="op" id="1574534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1574537">if</span>&nbsp;<span class="ident" id="1574540">s</span>&nbsp;<span class="op" id="1574542">==</span>&nbsp;<span class="builtintype" id="1574545">nil</span>&nbsp;<span class="op" id="1574549">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1574553">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1574561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574564">x</span>&nbsp;<span class="op" id="1574566">=</span>&nbsp;<span class="ident" id="1574568">unsafe</span><span class="op" id="1574574">.</span><span class="ident" id="1574575">Pointer</span><span class="op" id="1574582">(</span><span class="builtintype" id="1574583">uintptr</span><span class="op" id="1574590">(</span><span class="ident" id="1574591">s</span><span class="op" id="1574592">.</span><span class="ident" id="1574593">start</span><span class="op" id="1574598">)</span>&nbsp;<span class="op" id="1574600">&lt;&lt;</span>&nbsp;<span class="ident" id="1574603">pageShift</span><span class="op" id="1574612">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1574616">if</span>&nbsp;<span class="builtintype" id="1574619">uintptr</span><span class="op" id="1574626">(</span><span class="ident" id="1574627">v</span><span class="op" id="1574628">)</span>&nbsp;<span class="op" id="1574630">&lt;</span>&nbsp;<span class="builtintype" id="1574632">uintptr</span><span class="op" id="1574639">(</span><span class="ident" id="1574640">x</span><span class="op" id="1574641">)</span>&nbsp;<span class="op" id="1574643">||</span>&nbsp;<span class="builtintype" id="1574646">uintptr</span><span class="op" id="1574653">(</span><span class="ident" id="1574654">v</span><span class="op" id="1574655">)</span>&nbsp;<span class="op" id="1574657">&gt;=</span>&nbsp;<span class="builtintype" id="1574660">uintptr</span><span class="op" id="1574667">(</span><span class="ident" id="1574668">unsafe</span><span class="op" id="1574674">.</span><span class="ident" id="1574675">Pointer</span><span class="op" id="1574682">(</span><span class="ident" id="1574683">s</span><span class="op" id="1574684">.</span><span class="ident" id="1574685">limit</span><span class="op" id="1574690">)</span><span class="op" id="1574691">)</span>&nbsp;<span class="op" id="1574693">||</span>&nbsp;<span class="ident" id="1574696">s</span><span class="op" id="1574697">.</span><span class="ident" id="1574698">state</span>&nbsp;<span class="op" id="1574704">!=</span>&nbsp;<span class="ident" id="1574707">mSpanInUse</span>&nbsp;<span class="op" id="1574718">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574722">s</span>&nbsp;<span class="op" id="1574724">=</span>&nbsp;<span class="builtintype" id="1574726">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574732">x</span>&nbsp;<span class="op" id="1574734">=</span>&nbsp;<span class="builtintype" id="1574736">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1574742">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1574750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574754">n</span>&nbsp;<span class="op" id="1574756">=</span>&nbsp;<span class="builtintype" id="1574758">uintptr</span><span class="op" id="1574765">(</span><span class="ident" id="1574766">s</span><span class="op" id="1574767">.</span><span class="ident" id="1574768">elemsize</span><span class="op" id="1574776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1574779">if</span>&nbsp;<span class="ident" id="1574782">s</span><span class="op" id="1574783">.</span><span class="ident" id="1574784">sizeclass</span>&nbsp;<span class="op" id="1574794">!=</span>&nbsp;<span class="num" id="1574797">0</span>&nbsp;<span class="op" id="1574799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574803">x</span>&nbsp;<span class="op" id="1574805">=</span>&nbsp;<span class="ident" id="1574807">add</span><span class="op" id="1574810">(</span><span class="ident" id="1574811">x</span><span class="op" id="1574812">,</span>&nbsp;<span class="op" id="1574814">(</span><span class="builtintype" id="1574815">uintptr</span><span class="op" id="1574822">(</span><span class="ident" id="1574823">v</span><span class="op" id="1574824">)</span><span class="op" id="1574825">-</span><span class="builtintype" id="1574826">uintptr</span><span class="op" id="1574833">(</span><span class="ident" id="1574834">x</span><span class="op" id="1574835">)</span><span class="op" id="1574836">)</span><span class="op" id="1574837">/</span><span class="ident" id="1574838">n</span><span class="op" id="1574839">*</span><span class="ident" id="1574840">n</span><span class="op" id="1574841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1574844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1574847">return</span><br>
<span class="lineno">700</span><span class="op" id="1574854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1574857">var</span>&nbsp;<span class="ident" id="1574861">fingCreate</span>&nbsp;<span class="builtintype" id="1574872">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1574880">func</span>&nbsp;<span class="ident" id="1574885">createfing</span><span class="op" id="1574895">(</span><span class="op" id="1574896">)</span>&nbsp;<span class="op" id="1574898">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1574901">//&nbsp;start&nbsp;the&nbsp;finalizer&nbsp;goroutine&nbsp;exactly&nbsp;once</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1574948">if</span>&nbsp;<span class="ident" id="1574951">fingCreate</span>&nbsp;<span class="op" id="1574962">==</span>&nbsp;<span class="num" id="1574965">0</span>&nbsp;<span class="op" id="1574967">&amp;&amp;</span>&nbsp;<span class="ident" id="1574970">cas</span><span class="op" id="1574973">(</span><span class="op" id="1574974">&amp;</span><span class="ident" id="1574975">fingCreate</span><span class="op" id="1574985">,</span>&nbsp;<span class="num" id="1574987">0</span><span class="op" id="1574988">,</span>&nbsp;<span class="num" id="1574990">1</span><span class="op" id="1574991">)</span>&nbsp;<span class="op" id="1574993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1574997">go</span>&nbsp;<span class="ident" id="1575000">runfinq</span><span class="op" id="1575007">(</span><span class="op" id="1575008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1575011">}</span><br>
<span class="lineno"></span><span class="op" id="1575013">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="1575016">//&nbsp;This&nbsp;is&nbsp;the&nbsp;goroutine&nbsp;that&nbsp;runs&nbsp;all&nbsp;of&nbsp;the&nbsp;finalizers</span><br>
<span class="lineno"></span><span class="keyword" id="1575073">func</span>&nbsp;<span class="ident" id="1575078">runfinq</span><span class="op" id="1575085">(</span><span class="op" id="1575086">)</span>&nbsp;<span class="op" id="1575088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1575091">var</span>&nbsp;<span class="op" id="1575095">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575099">frame</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575108">unsafe</span><span class="op" id="1575114">.</span><span class="ident" id="1575115">Pointer</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575125">framecap</span>&nbsp;<span class="builtintype" id="1575134">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1575143">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1575147">for</span>&nbsp;<span class="op" id="1575151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575155">lock</span><span class="op" id="1575159">(</span><span class="op" id="1575160">&amp;</span><span class="ident" id="1575161">finlock</span><span class="op" id="1575168">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575172">fb</span>&nbsp;<span class="op" id="1575175">:=</span>&nbsp;<span class="ident" id="1575178">finq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575185">finq</span>&nbsp;<span class="op" id="1575190">=</span>&nbsp;<span class="builtintype" id="1575192">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1575198">if</span>&nbsp;<span class="ident" id="1575201">fb</span>&nbsp;<span class="op" id="1575204">==</span>&nbsp;<span class="builtintype" id="1575207">nil</span>&nbsp;<span class="op" id="1575211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575216">gp</span>&nbsp;<span class="op" id="1575219">:=</span>&nbsp;<span class="ident" id="1575222">getg</span><span class="op" id="1575226">(</span><span class="op" id="1575227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575232">fing</span>&nbsp;<span class="op" id="1575237">=</span>&nbsp;<span class="ident" id="1575239">gp</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575245">fingwait</span>&nbsp;<span class="op" id="1575254">=</span>&nbsp;<span class="builtintype" id="1575256">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575264">gp</span><span class="op" id="1575266">.</span><span class="ident" id="1575267">issystem</span>&nbsp;<span class="op" id="1575276">=</span>&nbsp;<span class="builtintype" id="1575278">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575286">goparkunlock</span><span class="op" id="1575298">(</span><span class="op" id="1575299">&amp;</span><span class="ident" id="1575300">finlock</span><span class="op" id="1575307">,</span>&nbsp;<span class="string" id="1575309">&#34;finalizer&nbsp;wait&#34;</span><span class="op" id="1575325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575330">gp</span><span class="op" id="1575332">.</span><span class="ident" id="1575333">issystem</span>&nbsp;<span class="op" id="1575342">=</span>&nbsp;<span class="builtintype" id="1575344">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1575353">continue</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1575364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575368">unlock</span><span class="op" id="1575374">(</span><span class="op" id="1575375">&amp;</span><span class="ident" id="1575376">finlock</span><span class="op" id="1575383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1575387">if</span>&nbsp;<span class="ident" id="1575390">raceenabled</span>&nbsp;<span class="op" id="1575402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575407">racefingo</span><span class="op" id="1575416">(</span><span class="op" id="1575417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1575421">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1575425">for</span>&nbsp;<span class="ident" id="1575429">fb</span>&nbsp;<span class="op" id="1575432">!=</span>&nbsp;<span class="builtintype" id="1575435">nil</span>&nbsp;<span class="op" id="1575439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1575444">for</span>&nbsp;<span class="ident" id="1575448">i</span>&nbsp;<span class="op" id="1575450">:=</span>&nbsp;<span class="builtintype" id="1575453">int32</span><span class="op" id="1575458">(</span><span class="num" id="1575459">0</span><span class="op" id="1575460">)</span><span class="op" id="1575461">;</span>&nbsp;<span class="ident" id="1575463">i</span>&nbsp;<span class="op" id="1575465">&lt;</span>&nbsp;<span class="ident" id="1575467">fb</span><span class="op" id="1575469">.</span><span class="ident" id="1575470">cnt</span><span class="op" id="1575473">;</span>&nbsp;<span class="ident" id="1575475">i</span><span class="op" id="1575476">++</span>&nbsp;<span class="op" id="1575479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575485">f</span>&nbsp;<span class="op" id="1575487">:=</span>&nbsp;<span class="op" id="1575490">(</span><span class="op" id="1575491">*</span><span class="ident" id="1575492">finalizer</span><span class="op" id="1575501">)</span><span class="op" id="1575502">(</span><span class="ident" id="1575503">add</span><span class="op" id="1575506">(</span><span class="ident" id="1575507">unsafe</span><span class="op" id="1575513">.</span><span class="ident" id="1575514">Pointer</span><span class="op" id="1575521">(</span><span class="op" id="1575522">&amp;</span><span class="ident" id="1575523">fb</span><span class="op" id="1575525">.</span><span class="ident" id="1575526">fin</span><span class="op" id="1575529">)</span><span class="op" id="1575530">,</span>&nbsp;<span class="builtintype" id="1575532">uintptr</span><span class="op" id="1575539">(</span><span class="ident" id="1575540">i</span><span class="op" id="1575541">)</span><span class="op" id="1575542">*</span><span class="ident" id="1575543">unsafe</span><span class="op" id="1575549">.</span><span class="ident" id="1575550">Sizeof</span><span class="op" id="1575556">(</span><span class="ident" id="1575557">finalizer</span><span class="op" id="1575566">{</span><span class="op" id="1575567">}</span><span class="op" id="1575568">)</span><span class="op" id="1575569">)</span><span class="op" id="1575570">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575577">framesz</span>&nbsp;<span class="op" id="1575585">:=</span>&nbsp;<span class="ident" id="1575588">unsafe</span><span class="op" id="1575594">.</span><span class="ident" id="1575595">Sizeof</span><span class="op" id="1575601">(</span><span class="op" id="1575602">(</span><span class="keyword" id="1575603">interface</span><span class="op" id="1575612">{</span><span class="op" id="1575613">}</span><span class="op" id="1575614">)</span><span class="op" id="1575615">(</span><span class="builtintype" id="1575616">nil</span><span class="op" id="1575619">)</span><span class="op" id="1575620">)</span>&nbsp;<span class="op" id="1575622">+</span>&nbsp;<span class="builtintype" id="1575624">uintptr</span><span class="op" id="1575631">(</span><span class="ident" id="1575632">f</span><span class="op" id="1575633">.</span><span class="ident" id="1575634">nret</span><span class="op" id="1575638">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1575644">if</span>&nbsp;<span class="ident" id="1575647">framecap</span>&nbsp;<span class="op" id="1575656">&lt;</span>&nbsp;<span class="ident" id="1575658">framesz</span>&nbsp;<span class="op" id="1575666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1575673">//&nbsp;The&nbsp;frame&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1575737">//&nbsp;all&nbsp;not&nbsp;yet&nbsp;finalized&nbsp;objects&nbsp;are&nbsp;stored&nbsp;in&nbsp;finq.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1575795">//&nbsp;If&nbsp;we&nbsp;do&nbsp;not&nbsp;mark&nbsp;it&nbsp;as&nbsp;FlagNoScan,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1575839">//&nbsp;the&nbsp;last&nbsp;finalized&nbsp;object&nbsp;is&nbsp;not&nbsp;collected.</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575891">frame</span>&nbsp;<span class="op" id="1575897">=</span>&nbsp;<span class="ident" id="1575899">mallocgc</span><span class="op" id="1575907">(</span><span class="ident" id="1575908">framesz</span><span class="op" id="1575915">,</span>&nbsp;<span class="builtintype" id="1575917">nil</span><span class="op" id="1575920">,</span>&nbsp;<span class="ident" id="1575922">flagNoScan</span><span class="op" id="1575932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575939">framecap</span>&nbsp;<span class="op" id="1575948">=</span>&nbsp;<span class="ident" id="1575950">framesz</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1575962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1575969">if</span>&nbsp;<span class="ident" id="1575972">f</span><span class="op" id="1575973">.</span><span class="ident" id="1575974">fint</span>&nbsp;<span class="op" id="1575979">==</span>&nbsp;<span class="builtintype" id="1575982">nil</span>&nbsp;<span class="op" id="1575986">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575993">gothrow</span><span class="op" id="1576000">(</span><span class="string" id="1576001">&#34;missing&nbsp;type&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1576026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1576032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1576038">switch</span>&nbsp;<span class="ident" id="1576045">f</span><span class="op" id="1576046">.</span><span class="ident" id="1576047">fint</span><span class="op" id="1576051">.</span><span class="ident" id="1576052">kind</span>&nbsp;<span class="op" id="1576057">&amp;</span>&nbsp;<span class="ident" id="1576059">kindMask</span>&nbsp;<span class="op" id="1576068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1576074">case</span>&nbsp;<span class="ident" id="1576079">kindPtr</span><span class="op" id="1576086">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1576093">//&nbsp;direct&nbsp;use&nbsp;of&nbsp;pointer</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1576123">*</span><span class="op" id="1576124">(</span><span class="op" id="1576125">*</span><span class="ident" id="1576126">unsafe</span><span class="op" id="1576132">.</span><span class="ident" id="1576133">Pointer</span><span class="op" id="1576140">)</span><span class="op" id="1576141">(</span><span class="ident" id="1576142">frame</span><span class="op" id="1576147">)</span>&nbsp;<span class="op" id="1576149">=</span>&nbsp;<span class="ident" id="1576151">f</span><span class="op" id="1576152">.</span><span class="ident" id="1576153">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1576161">case</span>&nbsp;<span class="ident" id="1576166">kindInterface</span><span class="op" id="1576179">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1576186">ityp</span>&nbsp;<span class="op" id="1576191">:=</span>&nbsp;<span class="op" id="1576194">(</span><span class="op" id="1576195">*</span><span class="ident" id="1576196">interfacetype</span><span class="op" id="1576209">)</span><span class="op" id="1576210">(</span><span class="ident" id="1576211">unsafe</span><span class="op" id="1576217">.</span><span class="ident" id="1576218">Pointer</span><span class="op" id="1576225">(</span><span class="ident" id="1576226">f</span><span class="op" id="1576227">.</span><span class="ident" id="1576228">fint</span><span class="op" id="1576232">)</span><span class="op" id="1576233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1576240">//&nbsp;set&nbsp;up&nbsp;with&nbsp;empty&nbsp;interface</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1576276">(</span><span class="op" id="1576277">*</span><span class="ident" id="1576278">eface</span><span class="op" id="1576283">)</span><span class="op" id="1576284">(</span><span class="ident" id="1576285">frame</span><span class="op" id="1576290">)</span><span class="op" id="1576291">.</span><span class="ident" id="1576292">_type</span>&nbsp;<span class="op" id="1576298">=</span>&nbsp;<span class="op" id="1576300">&amp;</span><span class="ident" id="1576301">f</span><span class="op" id="1576302">.</span><span class="ident" id="1576303">ot</span><span class="op" id="1576305">.</span><span class="ident" id="1576306">typ</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1576315">(</span><span class="op" id="1576316">*</span><span class="ident" id="1576317">eface</span><span class="op" id="1576322">)</span><span class="op" id="1576323">(</span><span class="ident" id="1576324">frame</span><span class="op" id="1576329">)</span><span class="op" id="1576330">.</span><span class="ident" id="1576331">data</span>&nbsp;<span class="op" id="1576336">=</span>&nbsp;<span class="ident" id="1576338">f</span><span class="op" id="1576339">.</span><span class="ident" id="1576340">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1576349">if</span>&nbsp;<span class="builtinfunc" id="1576352">len</span><span class="op" id="1576355">(</span><span class="ident" id="1576356">ityp</span><span class="op" id="1576360">.</span><span class="ident" id="1576361">mhdr</span><span class="op" id="1576365">)</span>&nbsp;<span class="op" id="1576367">!=</span>&nbsp;<span class="num" id="1576370">0</span>&nbsp;<span class="op" id="1576372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1576380">//&nbsp;convert&nbsp;to&nbsp;interface&nbsp;with&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1576423">//&nbsp;this&nbsp;conversion&nbsp;is&nbsp;guaranteed&nbsp;to&nbsp;succeed&nbsp;-&nbsp;we&nbsp;checked&nbsp;in&nbsp;SetFinalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1576502">*</span><span class="op" id="1576503">(</span><span class="op" id="1576504">*</span><span class="ident" id="1576505">fInterface</span><span class="op" id="1576515">)</span><span class="op" id="1576516">(</span><span class="ident" id="1576517">frame</span><span class="op" id="1576522">)</span>&nbsp;<span class="op" id="1576524">=</span>&nbsp;<span class="ident" id="1576526">assertE2I</span><span class="op" id="1576535">(</span><span class="ident" id="1576536">ityp</span><span class="op" id="1576540">,</span>&nbsp;<span class="op" id="1576542">*</span><span class="op" id="1576543">(</span><span class="op" id="1576544">*</span><span class="keyword" id="1576545">interface</span><span class="op" id="1576554">{</span><span class="op" id="1576555">}</span><span class="op" id="1576556">)</span><span class="op" id="1576557">(</span><span class="ident" id="1576558">frame</span><span class="op" id="1576563">)</span><span class="op" id="1576564">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1576571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1576577">default</span><span class="op" id="1576584">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1576591">gothrow</span><span class="op" id="1576598">(</span><span class="string" id="1576599">&#34;bad&nbsp;kind&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1576620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1576626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1576632">reflectcall</span><span class="op" id="1576643">(</span><span class="ident" id="1576644">unsafe</span><span class="op" id="1576650">.</span><span class="ident" id="1576651">Pointer</span><span class="op" id="1576658">(</span><span class="ident" id="1576659">f</span><span class="op" id="1576660">.</span><span class="ident" id="1576661">fn</span><span class="op" id="1576663">)</span><span class="op" id="1576664">,</span>&nbsp;<span class="ident" id="1576666">frame</span><span class="op" id="1576671">,</span>&nbsp;<span class="builtintype" id="1576673">uint32</span><span class="op" id="1576679">(</span><span class="ident" id="1576680">framesz</span><span class="op" id="1576687">)</span><span class="op" id="1576688">,</span>&nbsp;<span class="builtintype" id="1576690">uint32</span><span class="op" id="1576696">(</span><span class="ident" id="1576697">framesz</span><span class="op" id="1576704">)</span><span class="op" id="1576705">)</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1576712">//&nbsp;drop&nbsp;finalizer&nbsp;queue&nbsp;references&nbsp;to&nbsp;finalized&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1576771">f</span><span class="op" id="1576772">.</span><span class="ident" id="1576773">fn</span>&nbsp;<span class="op" id="1576776">=</span>&nbsp;<span class="builtintype" id="1576778">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1576786">f</span><span class="op" id="1576787">.</span><span class="ident" id="1576788">arg</span>&nbsp;<span class="op" id="1576792">=</span>&nbsp;<span class="builtintype" id="1576794">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1576802">f</span><span class="op" id="1576803">.</span><span class="ident" id="1576804">ot</span>&nbsp;<span class="op" id="1576807">=</span>&nbsp;<span class="builtintype" id="1576809">nil</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1576816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1576821">fb</span><span class="op" id="1576823">.</span><span class="ident" id="1576824">cnt</span>&nbsp;<span class="op" id="1576828">=</span>&nbsp;<span class="num" id="1576830">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1576835">next</span>&nbsp;<span class="op" id="1576840">:=</span>&nbsp;<span class="ident" id="1576843">fb</span><span class="op" id="1576845">.</span><span class="ident" id="1576846">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1576854">lock</span><span class="op" id="1576858">(</span><span class="op" id="1576859">&amp;</span><span class="ident" id="1576860">finlock</span><span class="op" id="1576867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1576872">fb</span><span class="op" id="1576874">.</span><span class="ident" id="1576875">next</span>&nbsp;<span class="op" id="1576880">=</span>&nbsp;<span class="ident" id="1576882">finc</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1576890">finc</span>&nbsp;<span class="op" id="1576895">=</span>&nbsp;<span class="ident" id="1576897">fb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1576903">unlock</span><span class="op" id="1576909">(</span><span class="op" id="1576910">&amp;</span><span class="ident" id="1576911">finlock</span><span class="op" id="1576918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1576923">fb</span>&nbsp;<span class="op" id="1576926">=</span>&nbsp;<span class="ident" id="1576928">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1576935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1576938">}</span><br>
<span class="lineno">785</span><span class="op" id="1576940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1576943">var</span>&nbsp;<span class="ident" id="1576947">persistent</span>&nbsp;<span class="keyword" id="1576958">struct</span>&nbsp;<span class="op" id="1576965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1576968">lock</span>&nbsp;<span class="ident" id="1576973">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1576980">pos</span>&nbsp;&nbsp;<span class="ident" id="1576985">unsafe</span><span class="op" id="1576991">.</span><span class="ident" id="1576992">Pointer</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577001">end</span>&nbsp;&nbsp;<span class="ident" id="1577006">unsafe</span><span class="op" id="1577012">.</span><span class="ident" id="1577013">Pointer</span><br>
<span class="lineno"></span><span class="op" id="1577021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1577024">//&nbsp;Wrapper&nbsp;around&nbsp;sysAlloc&nbsp;that&nbsp;can&nbsp;allocate&nbsp;small&nbsp;chunks.</span><br>
<span class="lineno"></span><span class="comment" id="1577083">//&nbsp;There&nbsp;is&nbsp;no&nbsp;associated&nbsp;free&nbsp;operation.</span><br>
<span class="lineno">795</span><span class="comment" id="1577125">//&nbsp;Intended&nbsp;for&nbsp;things&nbsp;like&nbsp;function/type/debug-related&nbsp;persistent&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1577198">//&nbsp;If&nbsp;align&nbsp;is&nbsp;0,&nbsp;uses&nbsp;default&nbsp;align&nbsp;(currently&nbsp;8).</span><br>
<span class="lineno"></span><span class="keyword" id="1577250">func</span>&nbsp;<span class="ident" id="1577255">persistentalloc</span><span class="op" id="1577270">(</span><span class="ident" id="1577271">size</span><span class="op" id="1577275">,</span>&nbsp;<span class="ident" id="1577277">align</span>&nbsp;<span class="builtintype" id="1577283">uintptr</span><span class="op" id="1577290">,</span>&nbsp;<span class="ident" id="1577292">stat</span>&nbsp;<span class="op" id="1577297">*</span><span class="ident" id="1577298">uint64</span><span class="op" id="1577304">)</span>&nbsp;<span class="ident" id="1577306">unsafe</span><span class="op" id="1577312">.</span><span class="ident" id="1577313">Pointer</span>&nbsp;<span class="op" id="1577321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577324">const</span>&nbsp;<span class="op" id="1577330">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577334">chunk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1577343">=</span>&nbsp;<span class="num" id="1577345">256</span>&nbsp;<span class="op" id="1577349">&lt;&lt;</span>&nbsp;<span class="num" id="1577352">10</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577357">maxBlock</span>&nbsp;<span class="op" id="1577366">=</span>&nbsp;<span class="num" id="1577368">64</span>&nbsp;<span class="op" id="1577371">&lt;&lt;</span>&nbsp;<span class="num" id="1577374">10</span>&nbsp;<span class="comment" id="1577377">//&nbsp;VM&nbsp;reservation&nbsp;granularity&nbsp;is&nbsp;64K&nbsp;on&nbsp;windows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1577426">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577430">if</span>&nbsp;<span class="ident" id="1577433">align</span>&nbsp;<span class="op" id="1577439">!=</span>&nbsp;<span class="num" id="1577442">0</span>&nbsp;<span class="op" id="1577444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577448">if</span>&nbsp;<span class="ident" id="1577451">align</span><span class="op" id="1577456">&amp;</span><span class="op" id="1577457">(</span><span class="ident" id="1577458">align</span><span class="op" id="1577463">-</span><span class="num" id="1577464">1</span><span class="op" id="1577465">)</span>&nbsp;<span class="op" id="1577467">!=</span>&nbsp;<span class="num" id="1577470">0</span>&nbsp;<span class="op" id="1577472">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577477">gothrow</span><span class="op" id="1577484">(</span><span class="string" id="1577485">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;not&nbsp;a&nbsp;power&nbsp;of&nbsp;2&#34;</span><span class="op" id="1577529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1577533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577537">if</span>&nbsp;<span class="ident" id="1577540">align</span>&nbsp;<span class="op" id="1577546">&gt;</span>&nbsp;<span class="ident" id="1577548">_PageSize</span>&nbsp;<span class="op" id="1577558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577563">gothrow</span><span class="op" id="1577570">(</span><span class="string" id="1577571">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;too&nbsp;large&#34;</span><span class="op" id="1577608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1577612">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1577615">}</span>&nbsp;<span class="keyword" id="1577617">else</span>&nbsp;<span class="op" id="1577622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577626">align</span>&nbsp;<span class="op" id="1577632">=</span>&nbsp;<span class="num" id="1577634">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1577637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577641">if</span>&nbsp;<span class="ident" id="1577644">size</span>&nbsp;<span class="op" id="1577649">&gt;=</span>&nbsp;<span class="ident" id="1577652">maxBlock</span>&nbsp;<span class="op" id="1577661">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577665">return</span>&nbsp;<span class="ident" id="1577672">sysAlloc</span><span class="op" id="1577680">(</span><span class="ident" id="1577681">size</span><span class="op" id="1577685">,</span>&nbsp;<span class="ident" id="1577687">stat</span><span class="op" id="1577691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1577694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577698">lock</span><span class="op" id="1577702">(</span><span class="op" id="1577703">&amp;</span><span class="ident" id="1577704">persistent</span><span class="op" id="1577714">.</span><span class="ident" id="1577715">lock</span><span class="op" id="1577719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577722">persistent</span><span class="op" id="1577732">.</span><span class="ident" id="1577733">pos</span>&nbsp;<span class="op" id="1577737">=</span>&nbsp;<span class="ident" id="1577739">roundup</span><span class="op" id="1577746">(</span><span class="ident" id="1577747">persistent</span><span class="op" id="1577757">.</span><span class="ident" id="1577758">pos</span><span class="op" id="1577761">,</span>&nbsp;<span class="ident" id="1577763">align</span><span class="op" id="1577768">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577771">if</span>&nbsp;<span class="builtintype" id="1577774">uintptr</span><span class="op" id="1577781">(</span><span class="ident" id="1577782">persistent</span><span class="op" id="1577792">.</span><span class="ident" id="1577793">pos</span><span class="op" id="1577796">)</span><span class="op" id="1577797">+</span><span class="ident" id="1577798">size</span>&nbsp;<span class="op" id="1577803">&gt;</span>&nbsp;<span class="builtintype" id="1577805">uintptr</span><span class="op" id="1577812">(</span><span class="ident" id="1577813">persistent</span><span class="op" id="1577823">.</span><span class="ident" id="1577824">end</span><span class="op" id="1577827">)</span>&nbsp;<span class="op" id="1577829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577833">persistent</span><span class="op" id="1577843">.</span><span class="ident" id="1577844">pos</span>&nbsp;<span class="op" id="1577848">=</span>&nbsp;<span class="ident" id="1577850">sysAlloc</span><span class="op" id="1577858">(</span><span class="ident" id="1577859">chunk</span><span class="op" id="1577864">,</span>&nbsp;<span class="op" id="1577866">&amp;</span><span class="ident" id="1577867">memstats</span><span class="op" id="1577875">.</span><span class="ident" id="1577876">other_sys</span><span class="op" id="1577885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577889">if</span>&nbsp;<span class="ident" id="1577892">persistent</span><span class="op" id="1577902">.</span><span class="ident" id="1577903">pos</span>&nbsp;<span class="op" id="1577907">==</span>&nbsp;<span class="builtintype" id="1577910">nil</span>&nbsp;<span class="op" id="1577914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577919">unlock</span><span class="op" id="1577925">(</span><span class="op" id="1577926">&amp;</span><span class="ident" id="1577927">persistent</span><span class="op" id="1577937">.</span><span class="ident" id="1577938">lock</span><span class="op" id="1577942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577947">gothrow</span><span class="op" id="1577954">(</span><span class="string" id="1577955">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1577988">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1577992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577996">persistent</span><span class="op" id="1578006">.</span><span class="ident" id="1578007">end</span>&nbsp;<span class="op" id="1578011">=</span>&nbsp;<span class="ident" id="1578013">add</span><span class="op" id="1578016">(</span><span class="ident" id="1578017">persistent</span><span class="op" id="1578027">.</span><span class="ident" id="1578028">pos</span><span class="op" id="1578031">,</span>&nbsp;<span class="ident" id="1578033">chunk</span><span class="op" id="1578038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1578041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1578044">p</span>&nbsp;<span class="op" id="1578046">:=</span>&nbsp;<span class="ident" id="1578049">persistent</span><span class="op" id="1578059">.</span><span class="ident" id="1578060">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1578065">persistent</span><span class="op" id="1578075">.</span><span class="ident" id="1578076">pos</span>&nbsp;<span class="op" id="1578080">=</span>&nbsp;<span class="ident" id="1578082">add</span><span class="op" id="1578085">(</span><span class="ident" id="1578086">persistent</span><span class="op" id="1578096">.</span><span class="ident" id="1578097">pos</span><span class="op" id="1578100">,</span>&nbsp;<span class="ident" id="1578102">size</span><span class="op" id="1578106">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1578109">unlock</span><span class="op" id="1578115">(</span><span class="op" id="1578116">&amp;</span><span class="ident" id="1578117">persistent</span><span class="op" id="1578127">.</span><span class="ident" id="1578128">lock</span><span class="op" id="1578132">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1578136">if</span>&nbsp;<span class="ident" id="1578139">stat</span>&nbsp;<span class="op" id="1578144">!=</span>&nbsp;<span class="op" id="1578147">&amp;</span><span class="ident" id="1578148">memstats</span><span class="op" id="1578156">.</span><span class="ident" id="1578157">other_sys</span>&nbsp;<span class="op" id="1578167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1578171">xadd64</span><span class="op" id="1578177">(</span><span class="ident" id="1578178">stat</span><span class="op" id="1578182">,</span>&nbsp;<span class="ident" id="1578184">int64</span><span class="op" id="1578189">(</span><span class="ident" id="1578190">size</span><span class="op" id="1578194">)</span><span class="op" id="1578195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1578199">xadd64</span><span class="op" id="1578205">(</span><span class="op" id="1578206">&amp;</span><span class="ident" id="1578207">memstats</span><span class="op" id="1578215">.</span><span class="ident" id="1578216">other_sys</span><span class="op" id="1578225">,</span>&nbsp;<span class="op" id="1578227">-</span><span class="ident" id="1578228">int64</span><span class="op" id="1578233">(</span><span class="ident" id="1578234">size</span><span class="op" id="1578238">)</span><span class="op" id="1578239">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1578242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1578245">return</span>&nbsp;<span class="ident" id="1578252">p</span><br>
<span class="lineno"></span><span class="op" id="1578254">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
