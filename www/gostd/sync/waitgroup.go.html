<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1415448">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1415503">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1415557">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1415608">package</span>&nbsp;<span class="ident" id="1415616">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1415622">import</span>&nbsp;<span class="op" id="1415629">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1415632">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1415647">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1415656">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1415659">//&nbsp;A&nbsp;WaitGroup&nbsp;waits&nbsp;for&nbsp;a&nbsp;collection&nbsp;of&nbsp;goroutines&nbsp;to&nbsp;finish.</span><br>
<span class="lineno"></span><span class="comment" id="1415722">//&nbsp;The&nbsp;main&nbsp;goroutine&nbsp;calls&nbsp;Add&nbsp;to&nbsp;set&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1415775">//&nbsp;goroutines&nbsp;to&nbsp;wait&nbsp;for.&nbsp;&nbsp;Then&nbsp;each&nbsp;of&nbsp;the&nbsp;goroutines</span><br>
<span class="lineno">15</span><span class="comment" id="1415831">//&nbsp;runs&nbsp;and&nbsp;calls&nbsp;Done&nbsp;when&nbsp;finished.&nbsp;&nbsp;At&nbsp;the&nbsp;same&nbsp;time,</span><br>
<span class="lineno"></span><span class="comment" id="1415888">//&nbsp;Wait&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;block&nbsp;until&nbsp;all&nbsp;goroutines&nbsp;have&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="1415953">type</span>&nbsp;<span class="ident" id="1415958">WaitGroup</span>&nbsp;<span class="keyword" id="1415968">struct</span>&nbsp;<span class="op" id="1415975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1415978">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415986">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1415993">counter</span>&nbsp;<span class="builtintype" id="1416001">int32</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1416008">waiters</span>&nbsp;<span class="builtintype" id="1416016">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1416023">sema</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1416031">*</span><span class="builtintype" id="1416032">uint32</span><br>
<span class="lineno"></span><span class="op" id="1416039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1416042">//&nbsp;WaitGroup&nbsp;creates&nbsp;a&nbsp;new&nbsp;semaphore&nbsp;each&nbsp;time&nbsp;the&nbsp;old&nbsp;semaphore</span><br>
<span class="lineno">25</span><span class="comment" id="1416107">//&nbsp;is&nbsp;released.&nbsp;This&nbsp;is&nbsp;to&nbsp;avoid&nbsp;the&nbsp;following&nbsp;race:</span><br>
<span class="lineno"></span><span class="comment" id="1416160">//</span><br>
<span class="lineno"></span><span class="comment" id="1416163">//&nbsp;G1:&nbsp;Add(1)</span><br>
<span class="lineno"></span><span class="comment" id="1416177">//&nbsp;G1:&nbsp;go&nbsp;G2()</span><br>
<span class="lineno"></span><span class="comment" id="1416192">//&nbsp;G1:&nbsp;Wait()&nbsp;//&nbsp;Context&nbsp;switch&nbsp;after&nbsp;Unlock()&nbsp;and&nbsp;before&nbsp;Semacquire().</span><br>
<span class="lineno">30</span><span class="comment" id="1416264">//&nbsp;G2:&nbsp;Done()&nbsp;//&nbsp;Release&nbsp;semaphore:&nbsp;sema&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.&nbsp;G1&nbsp;doesn&#39;t&nbsp;run&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="1416345">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;Finds&nbsp;counter&nbsp;==&nbsp;0,&nbsp;waiters&nbsp;==&nbsp;0,&nbsp;doesn&#39;t&nbsp;block.</span><br>
<span class="lineno"></span><span class="comment" id="1416411">//&nbsp;G3:&nbsp;Add(1)&nbsp;//&nbsp;Makes&nbsp;counter&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1416462">//&nbsp;G3:&nbsp;go&nbsp;G4()</span><br>
<span class="lineno"></span><span class="comment" id="1416477">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;G1&nbsp;still&nbsp;hasn&#39;t&nbsp;run,&nbsp;G3&nbsp;finds&nbsp;sema&nbsp;==&nbsp;1,&nbsp;unblocked!&nbsp;Bug.</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="1416552">//&nbsp;Add&nbsp;adds&nbsp;delta,&nbsp;which&nbsp;may&nbsp;be&nbsp;negative,&nbsp;to&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="comment" id="1416620">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;becomes&nbsp;zero,&nbsp;all&nbsp;goroutines&nbsp;blocked&nbsp;on&nbsp;Wait&nbsp;are&nbsp;released.</span><br>
<span class="lineno"></span><span class="comment" id="1416697">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;goes&nbsp;negative,&nbsp;Add&nbsp;panics.</span><br>
<span class="lineno"></span><span class="comment" id="1416742">//</span><br>
<span class="lineno">40</span><span class="comment" id="1416745">//&nbsp;Note&nbsp;that&nbsp;calls&nbsp;with&nbsp;a&nbsp;positive&nbsp;delta&nbsp;that&nbsp;occur&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="1416822">//&nbsp;must&nbsp;happen&nbsp;before&nbsp;a&nbsp;Wait.&nbsp;Calls&nbsp;with&nbsp;a&nbsp;negative&nbsp;delta,&nbsp;or&nbsp;calls&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1416897">//&nbsp;positive&nbsp;delta&nbsp;that&nbsp;start&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;greater&nbsp;than&nbsp;zero,&nbsp;may&nbsp;happen</span><br>
<span class="lineno"></span><span class="comment" id="1416976">//&nbsp;at&nbsp;any&nbsp;time.</span><br>
<span class="lineno"></span><span class="comment" id="1416992">//&nbsp;Typically&nbsp;this&nbsp;means&nbsp;the&nbsp;calls&nbsp;to&nbsp;Add&nbsp;should&nbsp;execute&nbsp;before&nbsp;the&nbsp;statement</span><br>
<span class="lineno">45</span><span class="comment" id="1417069">//&nbsp;creating&nbsp;the&nbsp;goroutine&nbsp;or&nbsp;other&nbsp;event&nbsp;to&nbsp;be&nbsp;waited&nbsp;for.</span><br>
<span class="lineno"></span><span class="comment" id="1417128">//&nbsp;See&nbsp;the&nbsp;WaitGroup&nbsp;example.</span><br>
<span class="lineno"></span><span class="keyword" id="1417158">func</span>&nbsp;<span class="op" id="1417163">(</span><span class="ident" id="1417164">wg</span>&nbsp;<span class="op" id="1417167">*</span><span class="ident" id="1417168">WaitGroup</span><span class="op" id="1417177">)</span>&nbsp;<span class="ident" id="1417179">Add</span><span class="op" id="1417182">(</span><span class="ident" id="1417183">delta</span>&nbsp;<span class="builtintype" id="1417189">int</span><span class="op" id="1417192">)</span>&nbsp;<span class="op" id="1417194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417197">if</span>&nbsp;<span class="ident" id="1417200">raceenabled</span>&nbsp;<span class="op" id="1417212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417216">_</span>&nbsp;<span class="op" id="1417218">=</span>&nbsp;<span class="ident" id="1417220">wg</span><span class="op" id="1417222">.</span><span class="ident" id="1417223">m</span><span class="op" id="1417224">.</span><span class="ident" id="1417225">state</span>&nbsp;<span class="comment" id="1417231">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417260">if</span>&nbsp;<span class="ident" id="1417263">delta</span>&nbsp;<span class="op" id="1417269">&lt;</span>&nbsp;<span class="num" id="1417271">0</span>&nbsp;<span class="op" id="1417273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1417278">//&nbsp;Synchronize&nbsp;decrements&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417318">raceReleaseMerge</span><span class="op" id="1417334">(</span><span class="ident" id="1417335">unsafe</span><span class="op" id="1417341">.</span><span class="ident" id="1417342">Pointer</span><span class="op" id="1417349">(</span><span class="ident" id="1417350">wg</span><span class="op" id="1417352">)</span><span class="op" id="1417353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1417357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417361">raceDisable</span><span class="op" id="1417372">(</span><span class="op" id="1417373">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417377">defer</span>&nbsp;<span class="ident" id="1417383">raceEnable</span><span class="op" id="1417393">(</span><span class="op" id="1417394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1417397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417400">v</span>&nbsp;<span class="op" id="1417402">:=</span>&nbsp;<span class="ident" id="1417405">atomic</span><span class="op" id="1417411">.</span><span class="ident" id="1417412">AddInt32</span><span class="op" id="1417420">(</span><span class="op" id="1417421">&amp;</span><span class="ident" id="1417422">wg</span><span class="op" id="1417424">.</span><span class="ident" id="1417425">counter</span><span class="op" id="1417432">,</span>&nbsp;<span class="builtintype" id="1417434">int32</span><span class="op" id="1417439">(</span><span class="ident" id="1417440">delta</span><span class="op" id="1417445">)</span><span class="op" id="1417446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417449">if</span>&nbsp;<span class="ident" id="1417452">raceenabled</span>&nbsp;<span class="op" id="1417464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417468">if</span>&nbsp;<span class="ident" id="1417471">delta</span>&nbsp;<span class="op" id="1417477">&gt;</span>&nbsp;<span class="num" id="1417479">0</span>&nbsp;<span class="op" id="1417481">&amp;&amp;</span>&nbsp;<span class="ident" id="1417484">v</span>&nbsp;<span class="op" id="1417486">==</span>&nbsp;<span class="builtintype" id="1417489">int32</span><span class="op" id="1417494">(</span><span class="ident" id="1417495">delta</span><span class="op" id="1417500">)</span>&nbsp;<span class="op" id="1417502">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1417507">//&nbsp;The&nbsp;first&nbsp;increment&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1417565">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;as&nbsp;a&nbsp;read,&nbsp;because&nbsp;there&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1417622">//&nbsp;several&nbsp;concurrent&nbsp;wg.counter&nbsp;transitions&nbsp;from&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417678">raceRead</span><span class="op" id="1417686">(</span><span class="ident" id="1417687">unsafe</span><span class="op" id="1417693">.</span><span class="ident" id="1417694">Pointer</span><span class="op" id="1417701">(</span><span class="op" id="1417702">&amp;</span><span class="ident" id="1417703">wg</span><span class="op" id="1417705">.</span><span class="ident" id="1417706">sema</span><span class="op" id="1417710">)</span><span class="op" id="1417711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1417715">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1417718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417721">if</span>&nbsp;<span class="ident" id="1417724">v</span>&nbsp;<span class="op" id="1417726">&lt;</span>&nbsp;<span class="num" id="1417728">0</span>&nbsp;<span class="op" id="1417730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1417734">panic</span><span class="op" id="1417739">(</span><span class="string" id="1417740">&#34;sync:&nbsp;negative&nbsp;WaitGroup&nbsp;counter&#34;</span><span class="op" id="1417774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1417777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417780">if</span>&nbsp;<span class="ident" id="1417783">v</span>&nbsp;<span class="op" id="1417785">&gt;</span>&nbsp;<span class="num" id="1417787">0</span>&nbsp;<span class="op" id="1417789">||</span>&nbsp;<span class="ident" id="1417792">atomic</span><span class="op" id="1417798">.</span><span class="ident" id="1417799">LoadInt32</span><span class="op" id="1417808">(</span><span class="op" id="1417809">&amp;</span><span class="ident" id="1417810">wg</span><span class="op" id="1417812">.</span><span class="ident" id="1417813">waiters</span><span class="op" id="1417820">)</span>&nbsp;<span class="op" id="1417822">==</span>&nbsp;<span class="num" id="1417825">0</span>&nbsp;<span class="op" id="1417827">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417831">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1417839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417842">wg</span><span class="op" id="1417844">.</span><span class="ident" id="1417845">m</span><span class="op" id="1417846">.</span><span class="ident" id="1417847">Lock</span><span class="op" id="1417851">(</span><span class="op" id="1417852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417855">if</span>&nbsp;<span class="ident" id="1417858">atomic</span><span class="op" id="1417864">.</span><span class="ident" id="1417865">LoadInt32</span><span class="op" id="1417874">(</span><span class="op" id="1417875">&amp;</span><span class="ident" id="1417876">wg</span><span class="op" id="1417878">.</span><span class="ident" id="1417879">counter</span><span class="op" id="1417886">)</span>&nbsp;<span class="op" id="1417888">==</span>&nbsp;<span class="num" id="1417891">0</span>&nbsp;<span class="op" id="1417893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417897">for</span>&nbsp;<span class="ident" id="1417901">i</span>&nbsp;<span class="op" id="1417903">:=</span>&nbsp;<span class="builtintype" id="1417906">int32</span><span class="op" id="1417911">(</span><span class="num" id="1417912">0</span><span class="op" id="1417913">)</span><span class="op" id="1417914">;</span>&nbsp;<span class="ident" id="1417916">i</span>&nbsp;<span class="op" id="1417918">&lt;</span>&nbsp;<span class="ident" id="1417920">wg</span><span class="op" id="1417922">.</span><span class="ident" id="1417923">waiters</span><span class="op" id="1417930">;</span>&nbsp;<span class="ident" id="1417932">i</span><span class="op" id="1417933">++</span>&nbsp;<span class="op" id="1417936">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417941">runtime_Semrelease</span><span class="op" id="1417959">(</span><span class="ident" id="1417960">wg</span><span class="op" id="1417962">.</span><span class="ident" id="1417963">sema</span><span class="op" id="1417967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1417971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417975">wg</span><span class="op" id="1417977">.</span><span class="ident" id="1417978">waiters</span>&nbsp;<span class="op" id="1417986">=</span>&nbsp;<span class="num" id="1417988">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417992">wg</span><span class="op" id="1417994">.</span><span class="ident" id="1417995">sema</span>&nbsp;<span class="op" id="1418000">=</span>&nbsp;<span class="ident" id="1418002">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1418007">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418010">wg</span><span class="op" id="1418012">.</span><span class="ident" id="1418013">m</span><span class="op" id="1418014">.</span><span class="ident" id="1418015">Unlock</span><span class="op" id="1418021">(</span><span class="op" id="1418022">)</span><br>
<span class="lineno"></span><span class="op" id="1418024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1418027">//&nbsp;Done&nbsp;decrements&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="keyword" id="1418069">func</span>&nbsp;<span class="op" id="1418074">(</span><span class="ident" id="1418075">wg</span>&nbsp;<span class="op" id="1418078">*</span><span class="ident" id="1418079">WaitGroup</span><span class="op" id="1418088">)</span>&nbsp;<span class="ident" id="1418090">Done</span><span class="op" id="1418094">(</span><span class="op" id="1418095">)</span>&nbsp;<span class="op" id="1418097">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418100">wg</span><span class="op" id="1418102">.</span><span class="ident" id="1418103">Add</span><span class="op" id="1418106">(</span><span class="op" id="1418107">-</span><span class="num" id="1418108">1</span><span class="op" id="1418109">)</span><br>
<span class="lineno"></span><span class="op" id="1418111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1418114">//&nbsp;Wait&nbsp;blocks&nbsp;until&nbsp;the&nbsp;WaitGroup&nbsp;counter&nbsp;is&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="1418166">func</span>&nbsp;<span class="op" id="1418171">(</span><span class="ident" id="1418172">wg</span>&nbsp;<span class="op" id="1418175">*</span><span class="ident" id="1418176">WaitGroup</span><span class="op" id="1418185">)</span>&nbsp;<span class="ident" id="1418187">Wait</span><span class="op" id="1418191">(</span><span class="op" id="1418192">)</span>&nbsp;<span class="op" id="1418194">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418197">if</span>&nbsp;<span class="ident" id="1418200">raceenabled</span>&nbsp;<span class="op" id="1418212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418216">_</span>&nbsp;<span class="op" id="1418218">=</span>&nbsp;<span class="ident" id="1418220">wg</span><span class="op" id="1418222">.</span><span class="ident" id="1418223">m</span><span class="op" id="1418224">.</span><span class="ident" id="1418225">state</span>&nbsp;<span class="comment" id="1418231">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418260">raceDisable</span><span class="op" id="1418271">(</span><span class="op" id="1418272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1418275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418278">if</span>&nbsp;<span class="ident" id="1418281">atomic</span><span class="op" id="1418287">.</span><span class="ident" id="1418288">LoadInt32</span><span class="op" id="1418297">(</span><span class="op" id="1418298">&amp;</span><span class="ident" id="1418299">wg</span><span class="op" id="1418301">.</span><span class="ident" id="1418302">counter</span><span class="op" id="1418309">)</span>&nbsp;<span class="op" id="1418311">==</span>&nbsp;<span class="num" id="1418314">0</span>&nbsp;<span class="op" id="1418316">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418320">if</span>&nbsp;<span class="ident" id="1418323">raceenabled</span>&nbsp;<span class="op" id="1418335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418340">raceEnable</span><span class="op" id="1418350">(</span><span class="op" id="1418351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418356">raceAcquire</span><span class="op" id="1418367">(</span><span class="ident" id="1418368">unsafe</span><span class="op" id="1418374">.</span><span class="ident" id="1418375">Pointer</span><span class="op" id="1418382">(</span><span class="ident" id="1418383">wg</span><span class="op" id="1418385">)</span><span class="op" id="1418386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1418390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418394">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1418402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418405">wg</span><span class="op" id="1418407">.</span><span class="ident" id="1418408">m</span><span class="op" id="1418409">.</span><span class="ident" id="1418410">Lock</span><span class="op" id="1418414">(</span><span class="op" id="1418415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418418">w</span>&nbsp;<span class="op" id="1418420">:=</span>&nbsp;<span class="ident" id="1418423">atomic</span><span class="op" id="1418429">.</span><span class="ident" id="1418430">AddInt32</span><span class="op" id="1418438">(</span><span class="op" id="1418439">&amp;</span><span class="ident" id="1418440">wg</span><span class="op" id="1418442">.</span><span class="ident" id="1418443">waiters</span><span class="op" id="1418450">,</span>&nbsp;<span class="num" id="1418452">1</span><span class="op" id="1418453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1418456">//&nbsp;This&nbsp;code&nbsp;is&nbsp;racing&nbsp;with&nbsp;the&nbsp;unlocked&nbsp;path&nbsp;in&nbsp;Add&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1418517">//&nbsp;The&nbsp;code&nbsp;above&nbsp;modifies&nbsp;counter&nbsp;and&nbsp;then&nbsp;reads&nbsp;waiters.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1418577">//&nbsp;We&nbsp;must&nbsp;modify&nbsp;waiters&nbsp;and&nbsp;then&nbsp;read&nbsp;counter&nbsp;(the&nbsp;opposite&nbsp;order)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1418647">//&nbsp;to&nbsp;avoid&nbsp;missing&nbsp;an&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418676">if</span>&nbsp;<span class="ident" id="1418679">atomic</span><span class="op" id="1418685">.</span><span class="ident" id="1418686">LoadInt32</span><span class="op" id="1418695">(</span><span class="op" id="1418696">&amp;</span><span class="ident" id="1418697">wg</span><span class="op" id="1418699">.</span><span class="ident" id="1418700">counter</span><span class="op" id="1418707">)</span>&nbsp;<span class="op" id="1418709">==</span>&nbsp;<span class="num" id="1418712">0</span>&nbsp;<span class="op" id="1418714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418718">atomic</span><span class="op" id="1418724">.</span><span class="ident" id="1418725">AddInt32</span><span class="op" id="1418733">(</span><span class="op" id="1418734">&amp;</span><span class="ident" id="1418735">wg</span><span class="op" id="1418737">.</span><span class="ident" id="1418738">waiters</span><span class="op" id="1418745">,</span>&nbsp;<span class="op" id="1418747">-</span><span class="num" id="1418748">1</span><span class="op" id="1418749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418753">if</span>&nbsp;<span class="ident" id="1418756">raceenabled</span>&nbsp;<span class="op" id="1418768">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418773">raceEnable</span><span class="op" id="1418783">(</span><span class="op" id="1418784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418789">raceAcquire</span><span class="op" id="1418800">(</span><span class="ident" id="1418801">unsafe</span><span class="op" id="1418807">.</span><span class="ident" id="1418808">Pointer</span><span class="op" id="1418815">(</span><span class="ident" id="1418816">wg</span><span class="op" id="1418818">)</span><span class="op" id="1418819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418824">raceDisable</span><span class="op" id="1418835">(</span><span class="op" id="1418836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1418840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418844">wg</span><span class="op" id="1418846">.</span><span class="ident" id="1418847">m</span><span class="op" id="1418848">.</span><span class="ident" id="1418849">Unlock</span><span class="op" id="1418855">(</span><span class="op" id="1418856">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418860">if</span>&nbsp;<span class="ident" id="1418863">raceenabled</span>&nbsp;<span class="op" id="1418875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418880">raceEnable</span><span class="op" id="1418890">(</span><span class="op" id="1418891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1418895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418899">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1418907">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418910">if</span>&nbsp;<span class="ident" id="1418913">raceenabled</span>&nbsp;<span class="op" id="1418925">&amp;&amp;</span>&nbsp;<span class="ident" id="1418928">w</span>&nbsp;<span class="op" id="1418930">==</span>&nbsp;<span class="num" id="1418933">1</span>&nbsp;<span class="op" id="1418935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1418939">//&nbsp;Wait&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;the&nbsp;first&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1418990">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;is&nbsp;as&nbsp;a&nbsp;write&nbsp;to&nbsp;race&nbsp;with&nbsp;the&nbsp;read&nbsp;in&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1419058">//&nbsp;As&nbsp;a&nbsp;consequence,&nbsp;can&nbsp;do&nbsp;the&nbsp;write&nbsp;only&nbsp;for&nbsp;the&nbsp;first&nbsp;waiter,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1419125">//&nbsp;otherwise&nbsp;concurrent&nbsp;Waits&nbsp;will&nbsp;race&nbsp;with&nbsp;each&nbsp;other.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419184">raceWrite</span><span class="op" id="1419193">(</span><span class="ident" id="1419194">unsafe</span><span class="op" id="1419200">.</span><span class="ident" id="1419201">Pointer</span><span class="op" id="1419208">(</span><span class="op" id="1419209">&amp;</span><span class="ident" id="1419210">wg</span><span class="op" id="1419212">.</span><span class="ident" id="1419213">sema</span><span class="op" id="1419217">)</span><span class="op" id="1419218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1419221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1419224">if</span>&nbsp;<span class="ident" id="1419227">wg</span><span class="op" id="1419229">.</span><span class="ident" id="1419230">sema</span>&nbsp;<span class="op" id="1419235">==</span>&nbsp;<span class="ident" id="1419238">nil</span>&nbsp;<span class="op" id="1419242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419246">wg</span><span class="op" id="1419248">.</span><span class="ident" id="1419249">sema</span>&nbsp;<span class="op" id="1419254">=</span>&nbsp;<span class="builtinfunc" id="1419256">new</span><span class="op" id="1419259">(</span><span class="builtintype" id="1419260">uint32</span><span class="op" id="1419266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1419269">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419272">s</span>&nbsp;<span class="op" id="1419274">:=</span>&nbsp;<span class="ident" id="1419277">wg</span><span class="op" id="1419279">.</span><span class="ident" id="1419280">sema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419286">wg</span><span class="op" id="1419288">.</span><span class="ident" id="1419289">m</span><span class="op" id="1419290">.</span><span class="ident" id="1419291">Unlock</span><span class="op" id="1419297">(</span><span class="op" id="1419298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419301">runtime_Semacquire</span><span class="op" id="1419319">(</span><span class="ident" id="1419320">s</span><span class="op" id="1419321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1419324">if</span>&nbsp;<span class="ident" id="1419327">raceenabled</span>&nbsp;<span class="op" id="1419339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419343">raceEnable</span><span class="op" id="1419353">(</span><span class="op" id="1419354">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419358">raceAcquire</span><span class="op" id="1419369">(</span><span class="ident" id="1419370">unsafe</span><span class="op" id="1419376">.</span><span class="ident" id="1419377">Pointer</span><span class="op" id="1419384">(</span><span class="ident" id="1419385">wg</span><span class="op" id="1419387">)</span><span class="op" id="1419388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1419391">}</span><br>
<span class="lineno"></span><span class="op" id="1419393">}</span>
</div>
</body>
</html>
