<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>regexp</h2>
<ul>
<li><a href="/gostd/regexp/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/regexp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/regexp/exec.go.html">exec.go</a></li>
<li><a href="/gostd/regexp/exec2_test.go.html">exec2_test.go</a></li>
<li><a href="/gostd/regexp/exec_test.go.html">exec_test.go</a></li>
<li><a href="/gostd/regexp/find_test.go.html">find_test.go</a></li>
<li><a href="/gostd/regexp/onepass.go.html">onepass.go</a></li>
<li><a href="/gostd/regexp/onepass_test.go.html">onepass_test.go</a></li>
<li><a href="/gostd/regexp/regexp.go.html">regexp.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5235334">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5235390">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5235444">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5235495">package</span>&nbsp;<span class="ident" id="5235503">regexp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5235511">import</span>&nbsp;<span class="op" id="5235518">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5235521">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5235530">&#34;regexp/syntax&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5235547">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5235555">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="5235565">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5235568">//&nbsp;&#34;One-pass&#34;&nbsp;regexp&nbsp;execution.</span><br>
<span class="lineno">15</span><span class="comment" id="5235600">//&nbsp;Some&nbsp;regexps&nbsp;can&nbsp;be&nbsp;analyzed&nbsp;to&nbsp;determine&nbsp;that&nbsp;they&nbsp;never&nbsp;need</span><br>
<span class="lineno"></span><span class="comment" id="5235666">//&nbsp;backtracking:&nbsp;they&nbsp;are&nbsp;guaranteed&nbsp;to&nbsp;run&nbsp;in&nbsp;one&nbsp;pass&nbsp;over&nbsp;the&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5235738">//&nbsp;without&nbsp;bothering&nbsp;to&nbsp;save&nbsp;all&nbsp;the&nbsp;usual&nbsp;NFA&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="5235792">//&nbsp;Detect&nbsp;those&nbsp;and&nbsp;execute&nbsp;them&nbsp;more&nbsp;quickly.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5235840">//&nbsp;A&nbsp;onePassProg&nbsp;is&nbsp;a&nbsp;compiled&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="5235908">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Prog&nbsp;except&nbsp;for&nbsp;the&nbsp;use&nbsp;of&nbsp;onePassInst.</span><br>
<span class="lineno"></span><span class="keyword" id="5235976">type</span>&nbsp;<span class="ident" id="5235981">onePassProg</span>&nbsp;<span class="keyword" id="5235993">struct</span>&nbsp;<span class="op" id="5236000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236003">Inst</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5236010">[</span><span class="op" id="5236011">]</span><span class="ident" id="5236012">onePassInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236025">Start</span>&nbsp;&nbsp;<span class="builtintype" id="5236032">int</span>&nbsp;<span class="comment" id="5236036">//&nbsp;index&nbsp;of&nbsp;start&nbsp;instruction</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236067">NumCap</span>&nbsp;<span class="builtintype" id="5236074">int</span>&nbsp;<span class="comment" id="5236078">//&nbsp;number&nbsp;of&nbsp;InstCapture&nbsp;insts&nbsp;in&nbsp;re</span><br>
<span class="lineno"></span><span class="op" id="5236115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5236118">//&nbsp;A&nbsp;onePassInst&nbsp;is&nbsp;a&nbsp;single&nbsp;instruction&nbsp;in&nbsp;a&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="5236201">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Inst&nbsp;except&nbsp;for&nbsp;the&nbsp;new&nbsp;&#39;Next&#39;&nbsp;field.</span><br>
<span class="lineno">30</span><span class="keyword" id="5236267">type</span>&nbsp;<span class="ident" id="5236272">onePassInst</span>&nbsp;<span class="keyword" id="5236284">struct</span>&nbsp;<span class="op" id="5236291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236294">syntax</span><span class="op" id="5236300">.</span><span class="ident" id="5236301">Inst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236307">Next</span>&nbsp;<span class="op" id="5236312">[</span><span class="op" id="5236313">]</span><span class="builtintype" id="5236314">uint32</span><br>
<span class="lineno"></span><span class="op" id="5236321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="5236324">//&nbsp;OnePassPrefix&nbsp;returns&nbsp;a&nbsp;literal&nbsp;string&nbsp;that&nbsp;all&nbsp;matches&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5236391">//&nbsp;regexp&nbsp;must&nbsp;start&nbsp;with.&nbsp;&nbsp;Complete&nbsp;is&nbsp;true&nbsp;if&nbsp;the&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="5236450">//&nbsp;is&nbsp;the&nbsp;entire&nbsp;match.&nbsp;Pc&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;last&nbsp;rune&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="5236519">//&nbsp;in&nbsp;the&nbsp;string.&nbsp;The&nbsp;OnePassPrefix&nbsp;skips&nbsp;over&nbsp;the&nbsp;mandatory</span><br>
<span class="lineno"></span><span class="comment" id="5236580">//&nbsp;EmptyBeginText</span><br>
<span class="lineno">40</span><span class="keyword" id="5236598">func</span>&nbsp;<span class="ident" id="5236603">onePassPrefix</span><span class="op" id="5236616">(</span><span class="ident" id="5236617">p</span>&nbsp;<span class="op" id="5236619">*</span><span class="ident" id="5236620">syntax</span><span class="op" id="5236626">.</span><span class="ident" id="5236627">Prog</span><span class="op" id="5236631">)</span>&nbsp;<span class="op" id="5236633">(</span><span class="ident" id="5236634">prefix</span>&nbsp;<span class="builtintype" id="5236641">string</span><span class="op" id="5236647">,</span>&nbsp;<span class="ident" id="5236649">complete</span>&nbsp;<span class="builtintype" id="5236658">bool</span><span class="op" id="5236662">,</span>&nbsp;<span class="ident" id="5236664">pc</span>&nbsp;<span class="builtintype" id="5236667">uint32</span><span class="op" id="5236673">)</span>&nbsp;<span class="op" id="5236675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236678">i</span>&nbsp;<span class="op" id="5236680">:=</span>&nbsp;<span class="op" id="5236683">&amp;</span><span class="ident" id="5236684">p</span><span class="op" id="5236685">.</span><span class="ident" id="5236686">Inst</span><span class="op" id="5236690">[</span><span class="ident" id="5236691">p</span><span class="op" id="5236692">.</span><span class="ident" id="5236693">Start</span><span class="op" id="5236698">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5236701">if</span>&nbsp;<span class="ident" id="5236704">i</span><span class="op" id="5236705">.</span><span class="ident" id="5236706">Op</span>&nbsp;<span class="op" id="5236709">!=</span>&nbsp;<span class="ident" id="5236712">syntax</span><span class="op" id="5236718">.</span><span class="ident" id="5236719">InstEmptyWidth</span>&nbsp;<span class="op" id="5236734">||</span>&nbsp;<span class="op" id="5236737">(</span><span class="ident" id="5236738">syntax</span><span class="op" id="5236744">.</span><span class="ident" id="5236745">EmptyOp</span><span class="op" id="5236752">(</span><span class="ident" id="5236753">i</span><span class="op" id="5236754">.</span><span class="ident" id="5236755">Arg</span><span class="op" id="5236758">)</span><span class="op" id="5236759">)</span><span class="op" id="5236760">&amp;</span><span class="ident" id="5236761">syntax</span><span class="op" id="5236767">.</span><span class="ident" id="5236768">EmptyBeginText</span>&nbsp;<span class="op" id="5236783">==</span>&nbsp;<span class="num" id="5236786">0</span>&nbsp;<span class="op" id="5236788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5236792">return</span>&nbsp;<span class="string" id="5236799">&#34;&#34;</span><span class="op" id="5236801">,</span>&nbsp;<span class="ident" id="5236803">i</span><span class="op" id="5236804">.</span><span class="ident" id="5236805">Op</span>&nbsp;<span class="op" id="5236808">==</span>&nbsp;<span class="ident" id="5236811">syntax</span><span class="op" id="5236817">.</span><span class="ident" id="5236818">InstMatch</span><span class="op" id="5236827">,</span>&nbsp;<span class="builtintype" id="5236829">uint32</span><span class="op" id="5236835">(</span><span class="ident" id="5236836">p</span><span class="op" id="5236837">.</span><span class="ident" id="5236838">Start</span><span class="op" id="5236843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5236846">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236849">pc</span>&nbsp;<span class="op" id="5236852">=</span>&nbsp;<span class="ident" id="5236854">i</span><span class="op" id="5236855">.</span><span class="ident" id="5236856">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236861">i</span>&nbsp;<span class="op" id="5236863">=</span>&nbsp;<span class="op" id="5236865">&amp;</span><span class="ident" id="5236866">p</span><span class="op" id="5236867">.</span><span class="ident" id="5236868">Inst</span><span class="op" id="5236872">[</span><span class="ident" id="5236873">pc</span><span class="op" id="5236875">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5236878">for</span>&nbsp;<span class="ident" id="5236882">i</span><span class="op" id="5236883">.</span><span class="ident" id="5236884">Op</span>&nbsp;<span class="op" id="5236887">==</span>&nbsp;<span class="ident" id="5236890">syntax</span><span class="op" id="5236896">.</span><span class="ident" id="5236897">InstNop</span>&nbsp;<span class="op" id="5236905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236909">pc</span>&nbsp;<span class="op" id="5236912">=</span>&nbsp;<span class="ident" id="5236914">i</span><span class="op" id="5236915">.</span><span class="ident" id="5236916">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236922">i</span>&nbsp;<span class="op" id="5236924">=</span>&nbsp;<span class="op" id="5236926">&amp;</span><span class="ident" id="5236927">p</span><span class="op" id="5236928">.</span><span class="ident" id="5236929">Inst</span><span class="op" id="5236933">[</span><span class="ident" id="5236934">pc</span><span class="op" id="5236936">]</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5236939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5236942">//&nbsp;Avoid&nbsp;allocation&nbsp;of&nbsp;buffer&nbsp;if&nbsp;prefix&nbsp;is&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5236993">if</span>&nbsp;<span class="ident" id="5236996">iop</span><span class="op" id="5236999">(</span><span class="ident" id="5237000">i</span><span class="op" id="5237001">)</span>&nbsp;<span class="op" id="5237003">!=</span>&nbsp;<span class="ident" id="5237006">syntax</span><span class="op" id="5237012">.</span><span class="ident" id="5237013">InstRune</span>&nbsp;<span class="op" id="5237022">||</span>&nbsp;<span class="builtinfunc" id="5237025">len</span><span class="op" id="5237028">(</span><span class="ident" id="5237029">i</span><span class="op" id="5237030">.</span><span class="ident" id="5237031">Rune</span><span class="op" id="5237035">)</span>&nbsp;<span class="op" id="5237037">!=</span>&nbsp;<span class="num" id="5237040">1</span>&nbsp;<span class="op" id="5237042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237046">return</span>&nbsp;<span class="string" id="5237053">&#34;&#34;</span><span class="op" id="5237055">,</span>&nbsp;<span class="ident" id="5237057">i</span><span class="op" id="5237058">.</span><span class="ident" id="5237059">Op</span>&nbsp;<span class="op" id="5237062">==</span>&nbsp;<span class="ident" id="5237065">syntax</span><span class="op" id="5237071">.</span><span class="ident" id="5237072">InstMatch</span><span class="op" id="5237081">,</span>&nbsp;<span class="builtintype" id="5237083">uint32</span><span class="op" id="5237089">(</span><span class="ident" id="5237090">p</span><span class="op" id="5237091">.</span><span class="ident" id="5237092">Start</span><span class="op" id="5237097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5237100">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5237104">//&nbsp;Have&nbsp;prefix;&nbsp;gather&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237140">var</span>&nbsp;<span class="ident" id="5237144">buf</span>&nbsp;<span class="ident" id="5237148">bytes</span><span class="op" id="5237153">.</span><span class="ident" id="5237154">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237162">for</span>&nbsp;<span class="ident" id="5237166">iop</span><span class="op" id="5237169">(</span><span class="ident" id="5237170">i</span><span class="op" id="5237171">)</span>&nbsp;<span class="op" id="5237173">==</span>&nbsp;<span class="ident" id="5237176">syntax</span><span class="op" id="5237182">.</span><span class="ident" id="5237183">InstRune</span>&nbsp;<span class="op" id="5237192">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5237195">len</span><span class="op" id="5237198">(</span><span class="ident" id="5237199">i</span><span class="op" id="5237200">.</span><span class="ident" id="5237201">Rune</span><span class="op" id="5237205">)</span>&nbsp;<span class="op" id="5237207">==</span>&nbsp;<span class="num" id="5237210">1</span>&nbsp;<span class="op" id="5237212">&amp;&amp;</span>&nbsp;<span class="ident" id="5237215">syntax</span><span class="op" id="5237221">.</span><span class="ident" id="5237222">Flags</span><span class="op" id="5237227">(</span><span class="ident" id="5237228">i</span><span class="op" id="5237229">.</span><span class="ident" id="5237230">Arg</span><span class="op" id="5237233">)</span><span class="op" id="5237234">&amp;</span><span class="ident" id="5237235">syntax</span><span class="op" id="5237241">.</span><span class="ident" id="5237242">FoldCase</span>&nbsp;<span class="op" id="5237251">==</span>&nbsp;<span class="num" id="5237254">0</span>&nbsp;<span class="op" id="5237256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237260">buf</span><span class="op" id="5237263">.</span><span class="ident" id="5237264">WriteRune</span><span class="op" id="5237273">(</span><span class="ident" id="5237274">i</span><span class="op" id="5237275">.</span><span class="ident" id="5237276">Rune</span><span class="op" id="5237280">[</span><span class="num" id="5237281">0</span><span class="op" id="5237282">]</span><span class="op" id="5237283">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237287">pc</span><span class="op" id="5237289">,</span>&nbsp;<span class="ident" id="5237291">i</span>&nbsp;<span class="op" id="5237293">=</span>&nbsp;<span class="ident" id="5237295">i</span><span class="op" id="5237296">.</span><span class="ident" id="5237297">Out</span><span class="op" id="5237300">,</span>&nbsp;<span class="op" id="5237302">&amp;</span><span class="ident" id="5237303">p</span><span class="op" id="5237304">.</span><span class="ident" id="5237305">Inst</span><span class="op" id="5237309">[</span><span class="ident" id="5237310">i</span><span class="op" id="5237311">.</span><span class="ident" id="5237312">Out</span><span class="op" id="5237315">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5237318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237321">return</span>&nbsp;<span class="ident" id="5237328">buf</span><span class="op" id="5237331">.</span><span class="ident" id="5237332">String</span><span class="op" id="5237338">(</span><span class="op" id="5237339">)</span><span class="op" id="5237340">,</span>&nbsp;<span class="ident" id="5237342">i</span><span class="op" id="5237343">.</span><span class="ident" id="5237344">Op</span>&nbsp;<span class="op" id="5237347">==</span>&nbsp;<span class="ident" id="5237350">syntax</span><span class="op" id="5237356">.</span><span class="ident" id="5237357">InstEmptyWidth</span>&nbsp;<span class="op" id="5237372">&amp;&amp;</span>&nbsp;<span class="op" id="5237375">(</span><span class="ident" id="5237376">syntax</span><span class="op" id="5237382">.</span><span class="ident" id="5237383">EmptyOp</span><span class="op" id="5237390">(</span><span class="ident" id="5237391">i</span><span class="op" id="5237392">.</span><span class="ident" id="5237393">Arg</span><span class="op" id="5237396">)</span><span class="op" id="5237397">)</span><span class="op" id="5237398">&amp;</span><span class="ident" id="5237399">syntax</span><span class="op" id="5237405">.</span><span class="ident" id="5237406">EmptyBeginText</span>&nbsp;<span class="op" id="5237421">!=</span>&nbsp;<span class="num" id="5237424">0</span><span class="op" id="5237425">,</span>&nbsp;<span class="ident" id="5237427">pc</span><br>
<span class="lineno"></span><span class="op" id="5237430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5237433">//&nbsp;OnePassNext&nbsp;selects&nbsp;the&nbsp;next&nbsp;actionable&nbsp;state&nbsp;of&nbsp;the&nbsp;prog,&nbsp;based&nbsp;on&nbsp;the&nbsp;input&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5237525">//&nbsp;It&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;i.Op&nbsp;==&nbsp;InstAlt&nbsp;or&nbsp;InstAltMatch,&nbsp;and&nbsp;from&nbsp;the&nbsp;one-pass&nbsp;machine.</span><br>
<span class="lineno"></span><span class="comment" id="5237622">//&nbsp;One&nbsp;of&nbsp;the&nbsp;alternates&nbsp;may&nbsp;ultimately&nbsp;lead&nbsp;without&nbsp;input&nbsp;to&nbsp;end&nbsp;of&nbsp;line.&nbsp;If&nbsp;the&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="5237716">//&nbsp;is&nbsp;InstAltMatch&nbsp;the&nbsp;path&nbsp;to&nbsp;the&nbsp;InstMatch&nbsp;is&nbsp;in&nbsp;i.Out,&nbsp;the&nbsp;normal&nbsp;node&nbsp;in&nbsp;i.Next.</span><br>
<span class="lineno"></span><span class="keyword" id="5237801">func</span>&nbsp;<span class="ident" id="5237806">onePassNext</span><span class="op" id="5237817">(</span><span class="ident" id="5237818">i</span>&nbsp;<span class="op" id="5237820">*</span><span class="ident" id="5237821">onePassInst</span><span class="op" id="5237832">,</span>&nbsp;<span class="ident" id="5237834">r</span>&nbsp;<span class="builtintype" id="5237836">rune</span><span class="op" id="5237840">)</span>&nbsp;<span class="builtintype" id="5237842">uint32</span>&nbsp;<span class="op" id="5237849">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237852">next</span>&nbsp;<span class="op" id="5237857">:=</span>&nbsp;<span class="ident" id="5237860">i</span><span class="op" id="5237861">.</span><span class="ident" id="5237862">MatchRunePos</span><span class="op" id="5237874">(</span><span class="ident" id="5237875">r</span><span class="op" id="5237876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237879">if</span>&nbsp;<span class="ident" id="5237882">next</span>&nbsp;<span class="op" id="5237887">&gt;=</span>&nbsp;<span class="num" id="5237890">0</span>&nbsp;<span class="op" id="5237892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237896">return</span>&nbsp;<span class="ident" id="5237903">i</span><span class="op" id="5237904">.</span><span class="ident" id="5237905">Next</span><span class="op" id="5237909">[</span><span class="ident" id="5237910">next</span><span class="op" id="5237914">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5237917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237920">if</span>&nbsp;<span class="ident" id="5237923">i</span><span class="op" id="5237924">.</span><span class="ident" id="5237925">Op</span>&nbsp;<span class="op" id="5237928">==</span>&nbsp;<span class="ident" id="5237931">syntax</span><span class="op" id="5237937">.</span><span class="ident" id="5237938">InstAltMatch</span>&nbsp;<span class="op" id="5237951">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237955">return</span>&nbsp;<span class="ident" id="5237962">i</span><span class="op" id="5237963">.</span><span class="ident" id="5237964">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5237969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237972">return</span>&nbsp;<span class="num" id="5237979">0</span><br>
<span class="lineno"></span><span class="op" id="5237981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="5237984">func</span>&nbsp;<span class="ident" id="5237989">iop</span><span class="op" id="5237992">(</span><span class="ident" id="5237993">i</span>&nbsp;<span class="op" id="5237995">*</span><span class="ident" id="5237996">syntax</span><span class="op" id="5238002">.</span><span class="ident" id="5238003">Inst</span><span class="op" id="5238007">)</span>&nbsp;<span class="ident" id="5238009">syntax</span><span class="op" id="5238015">.</span><span class="ident" id="5238016">InstOp</span>&nbsp;<span class="op" id="5238023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238026">op</span>&nbsp;<span class="op" id="5238029">:=</span>&nbsp;<span class="ident" id="5238032">i</span><span class="op" id="5238033">.</span><span class="ident" id="5238034">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238038">switch</span>&nbsp;<span class="ident" id="5238045">op</span>&nbsp;<span class="op" id="5238048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238051">case</span>&nbsp;<span class="ident" id="5238056">syntax</span><span class="op" id="5238062">.</span><span class="ident" id="5238063">InstRune1</span><span class="op" id="5238072">,</span>&nbsp;<span class="ident" id="5238074">syntax</span><span class="op" id="5238080">.</span><span class="ident" id="5238081">InstRuneAny</span><span class="op" id="5238092">,</span>&nbsp;<span class="ident" id="5238094">syntax</span><span class="op" id="5238100">.</span><span class="ident" id="5238101">InstRuneAnyNotNL</span><span class="op" id="5238117">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238121">op</span>&nbsp;<span class="op" id="5238124">=</span>&nbsp;<span class="ident" id="5238126">syntax</span><span class="op" id="5238132">.</span><span class="ident" id="5238133">InstRune</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238146">return</span>&nbsp;<span class="ident" id="5238153">op</span><br>
<span class="lineno"></span><span class="op" id="5238156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5238159">//&nbsp;Sparse&nbsp;Array&nbsp;implementation&nbsp;is&nbsp;used&nbsp;as&nbsp;a&nbsp;queueOnePass.</span><br>
<span class="lineno">90</span><span class="keyword" id="5238217">type</span>&nbsp;<span class="ident" id="5238222">queueOnePass</span>&nbsp;<span class="keyword" id="5238235">struct</span>&nbsp;<span class="op" id="5238242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238245">sparse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5238261">[</span><span class="op" id="5238262">]</span><span class="builtintype" id="5238263">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238271">dense</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5238287">[</span><span class="op" id="5238288">]</span><span class="builtintype" id="5238289">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238297">size</span><span class="op" id="5238301">,</span>&nbsp;<span class="ident" id="5238303">nextIndex</span>&nbsp;<span class="builtintype" id="5238313">uint32</span><br>
<span class="lineno"></span><span class="op" id="5238320">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="5238323">func</span>&nbsp;<span class="op" id="5238328">(</span><span class="ident" id="5238329">q</span>&nbsp;<span class="op" id="5238331">*</span><span class="ident" id="5238332">queueOnePass</span><span class="op" id="5238344">)</span>&nbsp;<span class="ident" id="5238346">empty</span><span class="op" id="5238351">(</span><span class="op" id="5238352">)</span>&nbsp;<span class="builtintype" id="5238354">bool</span>&nbsp;<span class="op" id="5238359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238362">return</span>&nbsp;<span class="ident" id="5238369">q</span><span class="op" id="5238370">.</span><span class="ident" id="5238371">nextIndex</span>&nbsp;<span class="op" id="5238381">&gt;=</span>&nbsp;<span class="ident" id="5238384">q</span><span class="op" id="5238385">.</span><span class="ident" id="5238386">size</span><br>
<span class="lineno"></span><span class="op" id="5238391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5238394">func</span>&nbsp;<span class="op" id="5238399">(</span><span class="ident" id="5238400">q</span>&nbsp;<span class="op" id="5238402">*</span><span class="ident" id="5238403">queueOnePass</span><span class="op" id="5238415">)</span>&nbsp;<span class="ident" id="5238417">next</span><span class="op" id="5238421">(</span><span class="op" id="5238422">)</span>&nbsp;<span class="op" id="5238424">(</span><span class="ident" id="5238425">n</span>&nbsp;<span class="builtintype" id="5238427">uint32</span><span class="op" id="5238433">)</span>&nbsp;<span class="op" id="5238435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238438">n</span>&nbsp;<span class="op" id="5238440">=</span>&nbsp;<span class="ident" id="5238442">q</span><span class="op" id="5238443">.</span><span class="ident" id="5238444">dense</span><span class="op" id="5238449">[</span><span class="ident" id="5238450">q</span><span class="op" id="5238451">.</span><span class="ident" id="5238452">nextIndex</span><span class="op" id="5238461">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238464">q</span><span class="op" id="5238465">.</span><span class="ident" id="5238466">nextIndex</span><span class="op" id="5238475">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238479">return</span><br>
<span class="lineno"></span><span class="op" id="5238486">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="5238489">func</span>&nbsp;<span class="op" id="5238494">(</span><span class="ident" id="5238495">q</span>&nbsp;<span class="op" id="5238497">*</span><span class="ident" id="5238498">queueOnePass</span><span class="op" id="5238510">)</span>&nbsp;<span class="ident" id="5238512">clear</span><span class="op" id="5238517">(</span><span class="op" id="5238518">)</span>&nbsp;<span class="op" id="5238520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238523">q</span><span class="op" id="5238524">.</span><span class="ident" id="5238525">size</span>&nbsp;<span class="op" id="5238530">=</span>&nbsp;<span class="num" id="5238532">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238535">q</span><span class="op" id="5238536">.</span><span class="ident" id="5238537">nextIndex</span>&nbsp;<span class="op" id="5238547">=</span>&nbsp;<span class="num" id="5238549">0</span><br>
<span class="lineno"></span><span class="op" id="5238551">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="5238554">func</span>&nbsp;<span class="op" id="5238559">(</span><span class="ident" id="5238560">q</span>&nbsp;<span class="op" id="5238562">*</span><span class="ident" id="5238563">queueOnePass</span><span class="op" id="5238575">)</span>&nbsp;<span class="ident" id="5238577">reset</span><span class="op" id="5238582">(</span><span class="op" id="5238583">)</span>&nbsp;<span class="op" id="5238585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238588">q</span><span class="op" id="5238589">.</span><span class="ident" id="5238590">nextIndex</span>&nbsp;<span class="op" id="5238600">=</span>&nbsp;<span class="num" id="5238602">0</span><br>
<span class="lineno"></span><span class="op" id="5238604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="5238607">func</span>&nbsp;<span class="op" id="5238612">(</span><span class="ident" id="5238613">q</span>&nbsp;<span class="op" id="5238615">*</span><span class="ident" id="5238616">queueOnePass</span><span class="op" id="5238628">)</span>&nbsp;<span class="ident" id="5238630">contains</span><span class="op" id="5238638">(</span><span class="ident" id="5238639">u</span>&nbsp;<span class="builtintype" id="5238641">uint32</span><span class="op" id="5238647">)</span>&nbsp;<span class="builtintype" id="5238649">bool</span>&nbsp;<span class="op" id="5238654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238657">if</span>&nbsp;<span class="ident" id="5238660">u</span>&nbsp;<span class="op" id="5238662">&gt;=</span>&nbsp;<span class="builtintype" id="5238665">uint32</span><span class="op" id="5238671">(</span><span class="builtinfunc" id="5238672">len</span><span class="op" id="5238675">(</span><span class="ident" id="5238676">q</span><span class="op" id="5238677">.</span><span class="ident" id="5238678">sparse</span><span class="op" id="5238684">)</span><span class="op" id="5238685">)</span>&nbsp;<span class="op" id="5238687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238691">return</span>&nbsp;<span class="builtintype" id="5238698">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238708">return</span>&nbsp;<span class="ident" id="5238715">q</span><span class="op" id="5238716">.</span><span class="ident" id="5238717">sparse</span><span class="op" id="5238723">[</span><span class="ident" id="5238724">u</span><span class="op" id="5238725">]</span>&nbsp;<span class="op" id="5238727">&lt;</span>&nbsp;<span class="ident" id="5238729">q</span><span class="op" id="5238730">.</span><span class="ident" id="5238731">size</span>&nbsp;<span class="op" id="5238736">&amp;&amp;</span>&nbsp;<span class="ident" id="5238739">q</span><span class="op" id="5238740">.</span><span class="ident" id="5238741">dense</span><span class="op" id="5238746">[</span><span class="ident" id="5238747">q</span><span class="op" id="5238748">.</span><span class="ident" id="5238749">sparse</span><span class="op" id="5238755">[</span><span class="ident" id="5238756">u</span><span class="op" id="5238757">]</span><span class="op" id="5238758">]</span>&nbsp;<span class="op" id="5238760">==</span>&nbsp;<span class="ident" id="5238763">u</span><br>
<span class="lineno">120</span><span class="op" id="5238765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5238768">func</span>&nbsp;<span class="op" id="5238773">(</span><span class="ident" id="5238774">q</span>&nbsp;<span class="op" id="5238776">*</span><span class="ident" id="5238777">queueOnePass</span><span class="op" id="5238789">)</span>&nbsp;<span class="ident" id="5238791">insert</span><span class="op" id="5238797">(</span><span class="ident" id="5238798">u</span>&nbsp;<span class="builtintype" id="5238800">uint32</span><span class="op" id="5238806">)</span>&nbsp;<span class="op" id="5238808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238811">if</span>&nbsp;<span class="op" id="5238814">!</span><span class="ident" id="5238815">q</span><span class="op" id="5238816">.</span><span class="ident" id="5238817">contains</span><span class="op" id="5238825">(</span><span class="ident" id="5238826">u</span><span class="op" id="5238827">)</span>&nbsp;<span class="op" id="5238829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238833">q</span><span class="op" id="5238834">.</span><span class="ident" id="5238835">insertNew</span><span class="op" id="5238844">(</span><span class="ident" id="5238845">u</span><span class="op" id="5238846">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238849">}</span><br>
<span class="lineno"></span><span class="op" id="5238851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5238854">func</span>&nbsp;<span class="op" id="5238859">(</span><span class="ident" id="5238860">q</span>&nbsp;<span class="op" id="5238862">*</span><span class="ident" id="5238863">queueOnePass</span><span class="op" id="5238875">)</span>&nbsp;<span class="ident" id="5238877">insertNew</span><span class="op" id="5238886">(</span><span class="ident" id="5238887">u</span>&nbsp;<span class="builtintype" id="5238889">uint32</span><span class="op" id="5238895">)</span>&nbsp;<span class="op" id="5238897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238900">if</span>&nbsp;<span class="ident" id="5238903">u</span>&nbsp;<span class="op" id="5238905">&gt;=</span>&nbsp;<span class="builtintype" id="5238908">uint32</span><span class="op" id="5238914">(</span><span class="builtinfunc" id="5238915">len</span><span class="op" id="5238918">(</span><span class="ident" id="5238919">q</span><span class="op" id="5238920">.</span><span class="ident" id="5238921">sparse</span><span class="op" id="5238927">)</span><span class="op" id="5238928">)</span>&nbsp;<span class="op" id="5238930">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238934">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238945">q</span><span class="op" id="5238946">.</span><span class="ident" id="5238947">sparse</span><span class="op" id="5238953">[</span><span class="ident" id="5238954">u</span><span class="op" id="5238955">]</span>&nbsp;<span class="op" id="5238957">=</span>&nbsp;<span class="ident" id="5238959">q</span><span class="op" id="5238960">.</span><span class="ident" id="5238961">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238967">q</span><span class="op" id="5238968">.</span><span class="ident" id="5238969">dense</span><span class="op" id="5238974">[</span><span class="ident" id="5238975">q</span><span class="op" id="5238976">.</span><span class="ident" id="5238977">size</span><span class="op" id="5238981">]</span>&nbsp;<span class="op" id="5238983">=</span>&nbsp;<span class="ident" id="5238985">u</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238988">q</span><span class="op" id="5238989">.</span><span class="ident" id="5238990">size</span><span class="op" id="5238994">++</span><br>
<span class="lineno">135</span><span class="op" id="5238997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5239000">func</span>&nbsp;<span class="ident" id="5239005">newQueue</span><span class="op" id="5239013">(</span><span class="ident" id="5239014">size</span>&nbsp;<span class="builtintype" id="5239019">int</span><span class="op" id="5239022">)</span>&nbsp;<span class="op" id="5239024">(</span><span class="ident" id="5239025">q</span>&nbsp;<span class="op" id="5239027">*</span><span class="ident" id="5239028">queueOnePass</span><span class="op" id="5239040">)</span>&nbsp;<span class="op" id="5239042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239045">return</span>&nbsp;<span class="op" id="5239052">&amp;</span><span class="ident" id="5239053">queueOnePass</span><span class="op" id="5239065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239069">sparse</span><span class="op" id="5239075">:</span>&nbsp;<span class="builtinfunc" id="5239077">make</span><span class="op" id="5239081">(</span><span class="op" id="5239082">[</span><span class="op" id="5239083">]</span><span class="builtintype" id="5239084">uint32</span><span class="op" id="5239090">,</span>&nbsp;<span class="ident" id="5239092">size</span><span class="op" id="5239096">)</span><span class="op" id="5239097">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239101">dense</span><span class="op" id="5239106">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5239109">make</span><span class="op" id="5239113">(</span><span class="op" id="5239114">[</span><span class="op" id="5239115">]</span><span class="builtintype" id="5239116">uint32</span><span class="op" id="5239122">,</span>&nbsp;<span class="ident" id="5239124">size</span><span class="op" id="5239128">)</span><span class="op" id="5239129">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5239132">}</span><br>
<span class="lineno"></span><span class="op" id="5239134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5239137">//&nbsp;mergeRuneSets&nbsp;merges&nbsp;two&nbsp;non-intersecting&nbsp;runesets,&nbsp;and&nbsp;returns&nbsp;the&nbsp;merged&nbsp;result,</span><br>
<span class="lineno">145</span><span class="comment" id="5239223">//&nbsp;and&nbsp;a&nbsp;NextIp&nbsp;array.&nbsp;The&nbsp;idea&nbsp;is&nbsp;that&nbsp;if&nbsp;a&nbsp;rune&nbsp;matches&nbsp;the&nbsp;OnePassRunes&nbsp;at&nbsp;index</span><br>
<span class="lineno"></span><span class="comment" id="5239307">//&nbsp;i,&nbsp;NextIp[i/2]&nbsp;is&nbsp;the&nbsp;target.&nbsp;If&nbsp;the&nbsp;input&nbsp;sets&nbsp;intersect,&nbsp;an&nbsp;empty&nbsp;runeset&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5239392">//&nbsp;NextIp&nbsp;array&nbsp;with&nbsp;the&nbsp;single&nbsp;element&nbsp;mergeFailed&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="5239457">//&nbsp;The&nbsp;code&nbsp;assumes&nbsp;that&nbsp;both&nbsp;inputs&nbsp;contain&nbsp;ordered&nbsp;and&nbsp;non-intersecting&nbsp;rune&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="keyword" id="5239543">const</span>&nbsp;<span class="ident" id="5239549">mergeFailed</span>&nbsp;<span class="op" id="5239561">=</span>&nbsp;<span class="builtintype" id="5239563">uint32</span><span class="op" id="5239569">(</span><span class="num" id="5239570">0xffffffff</span><span class="op" id="5239580">)</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="5239583">var</span>&nbsp;<span class="op" id="5239587">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239590">noRune</span>&nbsp;<span class="op" id="5239597">=</span>&nbsp;<span class="op" id="5239599">[</span><span class="op" id="5239600">]</span><span class="builtintype" id="5239601">rune</span><span class="op" id="5239605">{</span><span class="op" id="5239606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239609">noNext</span>&nbsp;<span class="op" id="5239616">=</span>&nbsp;<span class="op" id="5239618">[</span><span class="op" id="5239619">]</span><span class="builtintype" id="5239620">uint32</span><span class="op" id="5239626">{</span><span class="ident" id="5239627">mergeFailed</span><span class="op" id="5239638">}</span><br>
<span class="lineno"></span><span class="op" id="5239640">)</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="keyword" id="5239643">func</span>&nbsp;<span class="ident" id="5239648">mergeRuneSets</span><span class="op" id="5239661">(</span><span class="ident" id="5239662">leftRunes</span><span class="op" id="5239671">,</span>&nbsp;<span class="ident" id="5239673">rightRunes</span>&nbsp;<span class="op" id="5239684">*</span><span class="op" id="5239685">[</span><span class="op" id="5239686">]</span><span class="builtintype" id="5239687">rune</span><span class="op" id="5239691">,</span>&nbsp;<span class="ident" id="5239693">leftPC</span><span class="op" id="5239699">,</span>&nbsp;<span class="ident" id="5239701">rightPC</span>&nbsp;<span class="builtintype" id="5239709">uint32</span><span class="op" id="5239715">)</span>&nbsp;<span class="op" id="5239717">(</span><span class="op" id="5239718">[</span><span class="op" id="5239719">]</span><span class="builtintype" id="5239720">rune</span><span class="op" id="5239724">,</span>&nbsp;<span class="op" id="5239726">[</span><span class="op" id="5239727">]</span><span class="builtintype" id="5239728">uint32</span><span class="op" id="5239734">)</span>&nbsp;<span class="op" id="5239736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239739">leftLen</span>&nbsp;<span class="op" id="5239747">:=</span>&nbsp;<span class="builtinfunc" id="5239750">len</span><span class="op" id="5239753">(</span><span class="op" id="5239754">*</span><span class="ident" id="5239755">leftRunes</span><span class="op" id="5239764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239767">rightLen</span>&nbsp;<span class="op" id="5239776">:=</span>&nbsp;<span class="builtinfunc" id="5239779">len</span><span class="op" id="5239782">(</span><span class="op" id="5239783">*</span><span class="ident" id="5239784">rightRunes</span><span class="op" id="5239794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239797">if</span>&nbsp;<span class="ident" id="5239800">leftLen</span><span class="op" id="5239807">&amp;</span><span class="num" id="5239808">0x1</span>&nbsp;<span class="op" id="5239812">!=</span>&nbsp;<span class="num" id="5239815">0</span>&nbsp;<span class="op" id="5239817">||</span>&nbsp;<span class="ident" id="5239820">rightLen</span><span class="op" id="5239828">&amp;</span><span class="num" id="5239829">0x1</span>&nbsp;<span class="op" id="5239833">!=</span>&nbsp;<span class="num" id="5239836">0</span>&nbsp;<span class="op" id="5239838">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5239842">panic</span><span class="op" id="5239847">(</span><span class="string" id="5239848">&#34;mergeRuneSets&nbsp;odd&nbsp;length&nbsp;[]rune&#34;</span><span class="op" id="5239881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5239884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239887">var</span>&nbsp;<span class="op" id="5239891">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239895">lx</span><span class="op" id="5239897">,</span>&nbsp;<span class="ident" id="5239899">rx</span>&nbsp;<span class="builtintype" id="5239902">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5239907">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239910">merged</span>&nbsp;<span class="op" id="5239917">:=</span>&nbsp;<span class="builtinfunc" id="5239920">make</span><span class="op" id="5239924">(</span><span class="op" id="5239925">[</span><span class="op" id="5239926">]</span><span class="builtintype" id="5239927">rune</span><span class="op" id="5239931">,</span>&nbsp;<span class="num" id="5239933">0</span><span class="op" id="5239934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239937">next</span>&nbsp;<span class="op" id="5239942">:=</span>&nbsp;<span class="builtinfunc" id="5239945">make</span><span class="op" id="5239949">(</span><span class="op" id="5239950">[</span><span class="op" id="5239951">]</span><span class="builtintype" id="5239952">uint32</span><span class="op" id="5239958">,</span>&nbsp;<span class="num" id="5239960">0</span><span class="op" id="5239961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239964">ok</span>&nbsp;<span class="op" id="5239967">:=</span>&nbsp;<span class="builtintype" id="5239970">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239976">defer</span>&nbsp;<span class="keyword" id="5239982">func</span><span class="op" id="5239986">(</span><span class="op" id="5239987">)</span>&nbsp;<span class="op" id="5239989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239993">if</span>&nbsp;<span class="op" id="5239996">!</span><span class="ident" id="5239997">ok</span>&nbsp;<span class="op" id="5240000">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240005">merged</span>&nbsp;<span class="op" id="5240012">=</span>&nbsp;<span class="ident" id="5240014">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240021">next</span>&nbsp;<span class="op" id="5240026">=</span>&nbsp;<span class="ident" id="5240028">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240037">}</span><span class="op" id="5240038">(</span><span class="op" id="5240039">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240043">ix</span>&nbsp;<span class="op" id="5240046">:=</span>&nbsp;<span class="op" id="5240049">-</span><span class="num" id="5240050">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240053">extend</span>&nbsp;<span class="op" id="5240060">:=</span>&nbsp;<span class="keyword" id="5240063">func</span><span class="op" id="5240067">(</span><span class="ident" id="5240068">newLow</span>&nbsp;<span class="op" id="5240075">*</span><span class="builtintype" id="5240076">int</span><span class="op" id="5240079">,</span>&nbsp;<span class="ident" id="5240081">newArray</span>&nbsp;<span class="op" id="5240090">*</span><span class="op" id="5240091">[</span><span class="op" id="5240092">]</span><span class="builtintype" id="5240093">rune</span><span class="op" id="5240097">,</span>&nbsp;<span class="ident" id="5240099">pc</span>&nbsp;<span class="builtintype" id="5240102">uint32</span><span class="op" id="5240108">)</span>&nbsp;<span class="builtintype" id="5240110">bool</span>&nbsp;<span class="op" id="5240115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240119">if</span>&nbsp;<span class="ident" id="5240122">ix</span>&nbsp;<span class="op" id="5240125">&gt;</span>&nbsp;<span class="num" id="5240127">0</span>&nbsp;<span class="op" id="5240129">&amp;&amp;</span>&nbsp;<span class="op" id="5240132">(</span><span class="op" id="5240133">*</span><span class="ident" id="5240134">newArray</span><span class="op" id="5240142">)</span><span class="op" id="5240143">[</span><span class="op" id="5240144">*</span><span class="ident" id="5240145">newLow</span><span class="op" id="5240151">]</span>&nbsp;<span class="op" id="5240153">&lt;=</span>&nbsp;<span class="ident" id="5240156">merged</span><span class="op" id="5240162">[</span><span class="ident" id="5240163">ix</span><span class="op" id="5240165">]</span>&nbsp;<span class="op" id="5240167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240172">return</span>&nbsp;<span class="builtintype" id="5240179">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240187">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240191">merged</span>&nbsp;<span class="op" id="5240198">=</span>&nbsp;<span class="builtinfunc" id="5240200">append</span><span class="op" id="5240206">(</span><span class="ident" id="5240207">merged</span><span class="op" id="5240213">,</span>&nbsp;<span class="op" id="5240215">(</span><span class="op" id="5240216">*</span><span class="ident" id="5240217">newArray</span><span class="op" id="5240225">)</span><span class="op" id="5240226">[</span><span class="op" id="5240227">*</span><span class="ident" id="5240228">newLow</span><span class="op" id="5240234">]</span><span class="op" id="5240235">,</span>&nbsp;<span class="op" id="5240237">(</span><span class="op" id="5240238">*</span><span class="ident" id="5240239">newArray</span><span class="op" id="5240247">)</span><span class="op" id="5240248">[</span><span class="op" id="5240249">*</span><span class="ident" id="5240250">newLow</span><span class="op" id="5240256">+</span><span class="num" id="5240257">1</span><span class="op" id="5240258">]</span><span class="op" id="5240259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240263">*</span><span class="ident" id="5240264">newLow</span>&nbsp;<span class="op" id="5240271">+=</span>&nbsp;<span class="num" id="5240274">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240278">ix</span>&nbsp;<span class="op" id="5240281">+=</span>&nbsp;<span class="num" id="5240284">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240288">next</span>&nbsp;<span class="op" id="5240293">=</span>&nbsp;<span class="builtinfunc" id="5240295">append</span><span class="op" id="5240301">(</span><span class="ident" id="5240302">next</span><span class="op" id="5240306">,</span>&nbsp;<span class="ident" id="5240308">pc</span><span class="op" id="5240310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240314">return</span>&nbsp;<span class="builtintype" id="5240321">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240331">for</span>&nbsp;<span class="ident" id="5240335">lx</span>&nbsp;<span class="op" id="5240338">&lt;</span>&nbsp;<span class="ident" id="5240340">leftLen</span>&nbsp;<span class="op" id="5240348">||</span>&nbsp;<span class="ident" id="5240351">rx</span>&nbsp;<span class="op" id="5240354">&lt;</span>&nbsp;<span class="ident" id="5240356">rightLen</span>&nbsp;<span class="op" id="5240365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240369">switch</span>&nbsp;<span class="op" id="5240376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240380">case</span>&nbsp;<span class="ident" id="5240385">rx</span>&nbsp;<span class="op" id="5240388">&gt;=</span>&nbsp;<span class="ident" id="5240391">rightLen</span><span class="op" id="5240399">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240404">ok</span>&nbsp;<span class="op" id="5240407">=</span>&nbsp;<span class="ident" id="5240409">extend</span><span class="op" id="5240415">(</span><span class="op" id="5240416">&amp;</span><span class="ident" id="5240417">lx</span><span class="op" id="5240419">,</span>&nbsp;<span class="ident" id="5240421">leftRunes</span><span class="op" id="5240430">,</span>&nbsp;<span class="ident" id="5240432">leftPC</span><span class="op" id="5240438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240442">case</span>&nbsp;<span class="ident" id="5240447">lx</span>&nbsp;<span class="op" id="5240450">&gt;=</span>&nbsp;<span class="ident" id="5240453">leftLen</span><span class="op" id="5240460">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240465">ok</span>&nbsp;<span class="op" id="5240468">=</span>&nbsp;<span class="ident" id="5240470">extend</span><span class="op" id="5240476">(</span><span class="op" id="5240477">&amp;</span><span class="ident" id="5240478">rx</span><span class="op" id="5240480">,</span>&nbsp;<span class="ident" id="5240482">rightRunes</span><span class="op" id="5240492">,</span>&nbsp;<span class="ident" id="5240494">rightPC</span><span class="op" id="5240501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240505">case</span>&nbsp;<span class="op" id="5240510">(</span><span class="op" id="5240511">*</span><span class="ident" id="5240512">rightRunes</span><span class="op" id="5240522">)</span><span class="op" id="5240523">[</span><span class="ident" id="5240524">rx</span><span class="op" id="5240526">]</span>&nbsp;<span class="op" id="5240528">&lt;</span>&nbsp;<span class="op" id="5240530">(</span><span class="op" id="5240531">*</span><span class="ident" id="5240532">leftRunes</span><span class="op" id="5240541">)</span><span class="op" id="5240542">[</span><span class="ident" id="5240543">lx</span><span class="op" id="5240545">]</span><span class="op" id="5240546">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240551">ok</span>&nbsp;<span class="op" id="5240554">=</span>&nbsp;<span class="ident" id="5240556">extend</span><span class="op" id="5240562">(</span><span class="op" id="5240563">&amp;</span><span class="ident" id="5240564">rx</span><span class="op" id="5240566">,</span>&nbsp;<span class="ident" id="5240568">rightRunes</span><span class="op" id="5240578">,</span>&nbsp;<span class="ident" id="5240580">rightPC</span><span class="op" id="5240587">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240591">default</span><span class="op" id="5240598">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240603">ok</span>&nbsp;<span class="op" id="5240606">=</span>&nbsp;<span class="ident" id="5240608">extend</span><span class="op" id="5240614">(</span><span class="op" id="5240615">&amp;</span><span class="ident" id="5240616">lx</span><span class="op" id="5240618">,</span>&nbsp;<span class="ident" id="5240620">leftRunes</span><span class="op" id="5240629">,</span>&nbsp;<span class="ident" id="5240631">leftPC</span><span class="op" id="5240637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240645">if</span>&nbsp;<span class="op" id="5240648">!</span><span class="ident" id="5240649">ok</span>&nbsp;<span class="op" id="5240652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240657">return</span>&nbsp;<span class="ident" id="5240664">noRune</span><span class="op" id="5240670">,</span>&nbsp;<span class="ident" id="5240672">noNext</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240687">return</span>&nbsp;<span class="ident" id="5240694">merged</span><span class="op" id="5240700">,</span>&nbsp;<span class="ident" id="5240702">next</span><br>
<span class="lineno"></span><span class="op" id="5240707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="comment" id="5240710">//&nbsp;cleanupOnePass&nbsp;drops&nbsp;working&nbsp;memory,&nbsp;and&nbsp;restores&nbsp;certain&nbsp;shortcut&nbsp;instructions.</span><br>
<span class="lineno"></span><span class="keyword" id="5240794">func</span>&nbsp;<span class="ident" id="5240799">cleanupOnePass</span><span class="op" id="5240813">(</span><span class="ident" id="5240814">prog</span>&nbsp;<span class="op" id="5240819">*</span><span class="ident" id="5240820">onePassProg</span><span class="op" id="5240831">,</span>&nbsp;<span class="ident" id="5240833">original</span>&nbsp;<span class="op" id="5240842">*</span><span class="ident" id="5240843">syntax</span><span class="op" id="5240849">.</span><span class="ident" id="5240850">Prog</span><span class="op" id="5240854">)</span>&nbsp;<span class="op" id="5240856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240859">for</span>&nbsp;<span class="ident" id="5240863">ix</span><span class="op" id="5240865">,</span>&nbsp;<span class="ident" id="5240867">instOriginal</span>&nbsp;<span class="op" id="5240880">:=</span>&nbsp;<span class="keyword" id="5240883">range</span>&nbsp;<span class="ident" id="5240889">original</span><span class="op" id="5240897">.</span><span class="ident" id="5240898">Inst</span>&nbsp;<span class="op" id="5240903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240907">switch</span>&nbsp;<span class="ident" id="5240914">instOriginal</span><span class="op" id="5240926">.</span><span class="ident" id="5240927">Op</span>&nbsp;<span class="op" id="5240930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240934">case</span>&nbsp;<span class="ident" id="5240939">syntax</span><span class="op" id="5240945">.</span><span class="ident" id="5240946">InstAlt</span><span class="op" id="5240953">,</span>&nbsp;<span class="ident" id="5240955">syntax</span><span class="op" id="5240961">.</span><span class="ident" id="5240962">InstAltMatch</span><span class="op" id="5240974">,</span>&nbsp;<span class="ident" id="5240976">syntax</span><span class="op" id="5240982">.</span><span class="ident" id="5240983">InstRune</span><span class="op" id="5240991">:</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240995">case</span>&nbsp;<span class="ident" id="5241000">syntax</span><span class="op" id="5241006">.</span><span class="ident" id="5241007">InstCapture</span><span class="op" id="5241018">,</span>&nbsp;<span class="ident" id="5241020">syntax</span><span class="op" id="5241026">.</span><span class="ident" id="5241027">InstEmptyWidth</span><span class="op" id="5241041">,</span>&nbsp;<span class="ident" id="5241043">syntax</span><span class="op" id="5241049">.</span><span class="ident" id="5241050">InstNop</span><span class="op" id="5241057">,</span>&nbsp;<span class="ident" id="5241059">syntax</span><span class="op" id="5241065">.</span><span class="ident" id="5241066">InstMatch</span><span class="op" id="5241075">,</span>&nbsp;<span class="ident" id="5241077">syntax</span><span class="op" id="5241083">.</span><span class="ident" id="5241084">InstFail</span><span class="op" id="5241092">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241097">prog</span><span class="op" id="5241101">.</span><span class="ident" id="5241102">Inst</span><span class="op" id="5241106">[</span><span class="ident" id="5241107">ix</span><span class="op" id="5241109">]</span><span class="op" id="5241110">.</span><span class="ident" id="5241111">Next</span>&nbsp;<span class="op" id="5241116">=</span>&nbsp;<span class="ident" id="5241118">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241124">case</span>&nbsp;<span class="ident" id="5241129">syntax</span><span class="op" id="5241135">.</span><span class="ident" id="5241136">InstRune1</span><span class="op" id="5241145">,</span>&nbsp;<span class="ident" id="5241147">syntax</span><span class="op" id="5241153">.</span><span class="ident" id="5241154">InstRuneAny</span><span class="op" id="5241165">,</span>&nbsp;<span class="ident" id="5241167">syntax</span><span class="op" id="5241173">.</span><span class="ident" id="5241174">InstRuneAnyNotNL</span><span class="op" id="5241190">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241195">prog</span><span class="op" id="5241199">.</span><span class="ident" id="5241200">Inst</span><span class="op" id="5241204">[</span><span class="ident" id="5241205">ix</span><span class="op" id="5241207">]</span><span class="op" id="5241208">.</span><span class="ident" id="5241209">Next</span>&nbsp;<span class="op" id="5241214">=</span>&nbsp;<span class="ident" id="5241216">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241223">prog</span><span class="op" id="5241227">.</span><span class="ident" id="5241228">Inst</span><span class="op" id="5241232">[</span><span class="ident" id="5241233">ix</span><span class="op" id="5241235">]</span>&nbsp;<span class="op" id="5241237">=</span>&nbsp;<span class="ident" id="5241239">onePassInst</span><span class="op" id="5241250">{</span><span class="ident" id="5241251">Inst</span><span class="op" id="5241255">:</span>&nbsp;<span class="ident" id="5241257">instOriginal</span><span class="op" id="5241269">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241276">}</span><br>
<span class="lineno"></span><span class="op" id="5241278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5241281">//&nbsp;onePassCopy&nbsp;creates&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog,&nbsp;as&nbsp;we&#39;ll&nbsp;be&nbsp;modifying&nbsp;it</span><br>
<span class="lineno">220</span><span class="keyword" id="5241358">func</span>&nbsp;<span class="ident" id="5241363">onePassCopy</span><span class="op" id="5241374">(</span><span class="ident" id="5241375">prog</span>&nbsp;<span class="op" id="5241380">*</span><span class="ident" id="5241381">syntax</span><span class="op" id="5241387">.</span><span class="ident" id="5241388">Prog</span><span class="op" id="5241392">)</span>&nbsp;<span class="op" id="5241394">*</span><span class="ident" id="5241395">onePassProg</span>&nbsp;<span class="op" id="5241407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241410">p</span>&nbsp;<span class="op" id="5241412">:=</span>&nbsp;<span class="op" id="5241415">&amp;</span><span class="ident" id="5241416">onePassProg</span><span class="op" id="5241427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241431">Start</span><span class="op" id="5241436">:</span>&nbsp;&nbsp;<span class="ident" id="5241439">prog</span><span class="op" id="5241443">.</span><span class="ident" id="5241444">Start</span><span class="op" id="5241449">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241453">NumCap</span><span class="op" id="5241459">:</span>&nbsp;<span class="ident" id="5241461">prog</span><span class="op" id="5241465">.</span><span class="ident" id="5241466">NumCap</span><span class="op" id="5241472">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241475">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241478">for</span>&nbsp;<span class="ident" id="5241482">_</span><span class="op" id="5241483">,</span>&nbsp;<span class="ident" id="5241485">inst</span>&nbsp;<span class="op" id="5241490">:=</span>&nbsp;<span class="keyword" id="5241493">range</span>&nbsp;<span class="ident" id="5241499">prog</span><span class="op" id="5241503">.</span><span class="ident" id="5241504">Inst</span>&nbsp;<span class="op" id="5241509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241513">p</span><span class="op" id="5241514">.</span><span class="ident" id="5241515">Inst</span>&nbsp;<span class="op" id="5241520">=</span>&nbsp;<span class="builtinfunc" id="5241522">append</span><span class="op" id="5241528">(</span><span class="ident" id="5241529">p</span><span class="op" id="5241530">.</span><span class="ident" id="5241531">Inst</span><span class="op" id="5241535">,</span>&nbsp;<span class="ident" id="5241537">onePassInst</span><span class="op" id="5241548">{</span><span class="ident" id="5241549">Inst</span><span class="op" id="5241553">:</span>&nbsp;<span class="ident" id="5241555">inst</span><span class="op" id="5241559">}</span><span class="op" id="5241560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5241567">//&nbsp;rewrites&nbsp;one&nbsp;or&nbsp;more&nbsp;common&nbsp;Prog&nbsp;constructs&nbsp;that&nbsp;enable&nbsp;some&nbsp;otherwise</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5241642">//&nbsp;non-onepass&nbsp;Progs&nbsp;to&nbsp;be&nbsp;onepass.&nbsp;A:BD&nbsp;(for&nbsp;example)&nbsp;means&nbsp;an&nbsp;InstAlt&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5241718">//&nbsp;ip&nbsp;A,&nbsp;that&nbsp;points&nbsp;to&nbsp;ips&nbsp;B&nbsp;&amp;&nbsp;C.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5241754">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:CD</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5241785">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241816">for</span>&nbsp;<span class="ident" id="5241820">pc</span>&nbsp;<span class="op" id="5241823">:=</span>&nbsp;<span class="keyword" id="5241826">range</span>&nbsp;<span class="ident" id="5241832">p</span><span class="op" id="5241833">.</span><span class="ident" id="5241834">Inst</span>&nbsp;<span class="op" id="5241839">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241843">switch</span>&nbsp;<span class="ident" id="5241850">p</span><span class="op" id="5241851">.</span><span class="ident" id="5241852">Inst</span><span class="op" id="5241856">[</span><span class="ident" id="5241857">pc</span><span class="op" id="5241859">]</span><span class="op" id="5241860">.</span><span class="ident" id="5241861">Op</span>&nbsp;<span class="op" id="5241864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241868">default</span><span class="op" id="5241875">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241880">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241891">case</span>&nbsp;<span class="ident" id="5241896">syntax</span><span class="op" id="5241902">.</span><span class="ident" id="5241903">InstAlt</span><span class="op" id="5241910">,</span>&nbsp;<span class="ident" id="5241912">syntax</span><span class="op" id="5241918">.</span><span class="ident" id="5241919">InstAltMatch</span><span class="op" id="5241931">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5241936">//&nbsp;A:Bx&nbsp;+&nbsp;B:Ay</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241954">p_A_Other</span>&nbsp;<span class="op" id="5241964">:=</span>&nbsp;<span class="op" id="5241967">&amp;</span><span class="ident" id="5241968">p</span><span class="op" id="5241969">.</span><span class="ident" id="5241970">Inst</span><span class="op" id="5241974">[</span><span class="ident" id="5241975">pc</span><span class="op" id="5241977">]</span><span class="op" id="5241978">.</span><span class="ident" id="5241979">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241986">p_A_Alt</span>&nbsp;<span class="op" id="5241994">:=</span>&nbsp;<span class="op" id="5241997">&amp;</span><span class="ident" id="5241998">p</span><span class="op" id="5241999">.</span><span class="ident" id="5242000">Inst</span><span class="op" id="5242004">[</span><span class="ident" id="5242005">pc</span><span class="op" id="5242007">]</span><span class="op" id="5242008">.</span><span class="ident" id="5242009">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242016">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;target&nbsp;is&nbsp;another&nbsp;Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242056">instAlt</span>&nbsp;<span class="op" id="5242064">:=</span>&nbsp;<span class="ident" id="5242067">p</span><span class="op" id="5242068">.</span><span class="ident" id="5242069">Inst</span><span class="op" id="5242073">[</span><span class="op" id="5242074">*</span><span class="ident" id="5242075">p_A_Alt</span><span class="op" id="5242082">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242087">if</span>&nbsp;<span class="op" id="5242090">!</span><span class="op" id="5242091">(</span><span class="ident" id="5242092">instAlt</span><span class="op" id="5242099">.</span><span class="ident" id="5242100">Op</span>&nbsp;<span class="op" id="5242103">==</span>&nbsp;<span class="ident" id="5242106">syntax</span><span class="op" id="5242112">.</span><span class="ident" id="5242113">InstAlt</span>&nbsp;<span class="op" id="5242121">||</span>&nbsp;<span class="ident" id="5242124">instAlt</span><span class="op" id="5242131">.</span><span class="ident" id="5242132">Op</span>&nbsp;<span class="op" id="5242135">==</span>&nbsp;<span class="ident" id="5242138">syntax</span><span class="op" id="5242144">.</span><span class="ident" id="5242145">InstAltMatch</span><span class="op" id="5242157">)</span>&nbsp;<span class="op" id="5242159">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242165">p_A_Alt</span><span class="op" id="5242172">,</span>&nbsp;<span class="ident" id="5242174">p_A_Other</span>&nbsp;<span class="op" id="5242184">=</span>&nbsp;<span class="ident" id="5242186">p_A_Other</span><span class="op" id="5242195">,</span>&nbsp;<span class="ident" id="5242197">p_A_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242209">instAlt</span>&nbsp;<span class="op" id="5242217">=</span>&nbsp;<span class="ident" id="5242219">p</span><span class="op" id="5242220">.</span><span class="ident" id="5242221">Inst</span><span class="op" id="5242225">[</span><span class="op" id="5242226">*</span><span class="ident" id="5242227">p_A_Alt</span><span class="op" id="5242234">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242240">if</span>&nbsp;<span class="op" id="5242243">!</span><span class="op" id="5242244">(</span><span class="ident" id="5242245">instAlt</span><span class="op" id="5242252">.</span><span class="ident" id="5242253">Op</span>&nbsp;<span class="op" id="5242256">==</span>&nbsp;<span class="ident" id="5242259">syntax</span><span class="op" id="5242265">.</span><span class="ident" id="5242266">InstAlt</span>&nbsp;<span class="op" id="5242274">||</span>&nbsp;<span class="ident" id="5242277">instAlt</span><span class="op" id="5242284">.</span><span class="ident" id="5242285">Op</span>&nbsp;<span class="op" id="5242288">==</span>&nbsp;<span class="ident" id="5242291">syntax</span><span class="op" id="5242297">.</span><span class="ident" id="5242298">InstAltMatch</span><span class="op" id="5242310">)</span>&nbsp;<span class="op" id="5242312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242319">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5242332">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5242337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242342">instOther</span>&nbsp;<span class="op" id="5242352">:=</span>&nbsp;<span class="ident" id="5242355">p</span><span class="op" id="5242356">.</span><span class="ident" id="5242357">Inst</span><span class="op" id="5242361">[</span><span class="op" id="5242362">*</span><span class="ident" id="5242363">p_A_Other</span><span class="op" id="5242372">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242377">//&nbsp;Analyzing&nbsp;both&nbsp;legs&nbsp;pointing&nbsp;to&nbsp;Alts&nbsp;is&nbsp;for&nbsp;another&nbsp;day</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242439">if</span>&nbsp;<span class="ident" id="5242442">instOther</span><span class="op" id="5242451">.</span><span class="ident" id="5242452">Op</span>&nbsp;<span class="op" id="5242455">==</span>&nbsp;<span class="ident" id="5242458">syntax</span><span class="op" id="5242464">.</span><span class="ident" id="5242465">InstAlt</span>&nbsp;<span class="op" id="5242473">||</span>&nbsp;<span class="ident" id="5242476">instOther</span><span class="op" id="5242485">.</span><span class="ident" id="5242486">Op</span>&nbsp;<span class="op" id="5242489">==</span>&nbsp;<span class="ident" id="5242492">syntax</span><span class="op" id="5242498">.</span><span class="ident" id="5242499">InstAltMatch</span>&nbsp;<span class="op" id="5242512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242518">//&nbsp;too&nbsp;complicated</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242541">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5242553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242558">//&nbsp;simple&nbsp;empty&nbsp;transition&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242593">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242626">p_B_Alt</span>&nbsp;<span class="op" id="5242634">:=</span>&nbsp;<span class="op" id="5242637">&amp;</span><span class="ident" id="5242638">p</span><span class="op" id="5242639">.</span><span class="ident" id="5242640">Inst</span><span class="op" id="5242644">[</span><span class="op" id="5242645">*</span><span class="ident" id="5242646">p_A_Alt</span><span class="op" id="5242653">]</span><span class="op" id="5242654">.</span><span class="ident" id="5242655">Out</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242662">p_B_Other</span>&nbsp;<span class="op" id="5242672">:=</span>&nbsp;<span class="op" id="5242675">&amp;</span><span class="ident" id="5242676">p</span><span class="op" id="5242677">.</span><span class="ident" id="5242678">Inst</span><span class="op" id="5242682">[</span><span class="op" id="5242683">*</span><span class="ident" id="5242684">p_A_Alt</span><span class="op" id="5242691">]</span><span class="op" id="5242692">.</span><span class="ident" id="5242693">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242700">patch</span>&nbsp;<span class="op" id="5242706">:=</span>&nbsp;<span class="builtintype" id="5242709">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242718">if</span>&nbsp;<span class="ident" id="5242721">instAlt</span><span class="op" id="5242728">.</span><span class="ident" id="5242729">Out</span>&nbsp;<span class="op" id="5242733">==</span>&nbsp;<span class="builtintype" id="5242736">uint32</span><span class="op" id="5242742">(</span><span class="ident" id="5242743">pc</span><span class="op" id="5242745">)</span>&nbsp;<span class="op" id="5242747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242753">patch</span>&nbsp;<span class="op" id="5242759">=</span>&nbsp;<span class="builtintype" id="5242761">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5242769">}</span>&nbsp;<span class="keyword" id="5242771">else</span>&nbsp;<span class="keyword" id="5242776">if</span>&nbsp;<span class="ident" id="5242779">instAlt</span><span class="op" id="5242786">.</span><span class="ident" id="5242787">Arg</span>&nbsp;<span class="op" id="5242791">==</span>&nbsp;<span class="builtintype" id="5242794">uint32</span><span class="op" id="5242800">(</span><span class="ident" id="5242801">pc</span><span class="op" id="5242803">)</span>&nbsp;<span class="op" id="5242805">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242811">patch</span>&nbsp;<span class="op" id="5242817">=</span>&nbsp;<span class="builtintype" id="5242819">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242828">p_B_Alt</span><span class="op" id="5242835">,</span>&nbsp;<span class="ident" id="5242837">p_B_Other</span>&nbsp;<span class="op" id="5242847">=</span>&nbsp;<span class="ident" id="5242849">p_B_Other</span><span class="op" id="5242858">,</span>&nbsp;<span class="ident" id="5242860">p_B_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5242871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242876">if</span>&nbsp;<span class="ident" id="5242879">patch</span>&nbsp;<span class="op" id="5242885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5242891">*</span><span class="ident" id="5242892">p_B_Alt</span>&nbsp;<span class="op" id="5242900">=</span>&nbsp;<span class="op" id="5242902">*</span><span class="ident" id="5242903">p_A_Other</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5242916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242922">//&nbsp;empty&nbsp;transition&nbsp;to&nbsp;common&nbsp;target</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242962">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242995">if</span>&nbsp;<span class="op" id="5242998">*</span><span class="ident" id="5242999">p_A_Other</span>&nbsp;<span class="op" id="5243009">==</span>&nbsp;<span class="op" id="5243012">*</span><span class="ident" id="5243013">p_B_Alt</span>&nbsp;<span class="op" id="5243021">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243027">*</span><span class="ident" id="5243028">p_A_Alt</span>&nbsp;<span class="op" id="5243036">=</span>&nbsp;<span class="op" id="5243038">*</span><span class="ident" id="5243039">p_B_Other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243062">return</span>&nbsp;<span class="ident" id="5243069">p</span><br>
<span class="lineno">280</span><span class="op" id="5243071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5243074">//&nbsp;runeSlice&nbsp;exists&nbsp;to&nbsp;permit&nbsp;sorting&nbsp;the&nbsp;case-folded&nbsp;rune&nbsp;sets.</span><br>
<span class="lineno"></span><span class="keyword" id="5243139">type</span>&nbsp;<span class="ident" id="5243144">runeSlice</span>&nbsp;<span class="op" id="5243154">[</span><span class="op" id="5243155">]</span><span class="builtintype" id="5243156">rune</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="5243162">func</span>&nbsp;<span class="op" id="5243167">(</span><span class="ident" id="5243168">p</span>&nbsp;<span class="ident" id="5243170">runeSlice</span><span class="op" id="5243179">)</span>&nbsp;<span class="ident" id="5243181">Len</span><span class="op" id="5243184">(</span><span class="op" id="5243185">)</span>&nbsp;<span class="builtintype" id="5243187">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5243201">{</span>&nbsp;<span class="keyword" id="5243203">return</span>&nbsp;<span class="builtinfunc" id="5243210">len</span><span class="op" id="5243213">(</span><span class="ident" id="5243214">p</span><span class="op" id="5243215">)</span>&nbsp;<span class="op" id="5243217">}</span><br>
<span class="lineno"></span><span class="keyword" id="5243219">func</span>&nbsp;<span class="op" id="5243224">(</span><span class="ident" id="5243225">p</span>&nbsp;<span class="ident" id="5243227">runeSlice</span><span class="op" id="5243236">)</span>&nbsp;<span class="ident" id="5243238">Less</span><span class="op" id="5243242">(</span><span class="ident" id="5243243">i</span><span class="op" id="5243244">,</span>&nbsp;<span class="ident" id="5243246">j</span>&nbsp;<span class="builtintype" id="5243248">int</span><span class="op" id="5243251">)</span>&nbsp;<span class="builtintype" id="5243253">bool</span>&nbsp;<span class="op" id="5243258">{</span>&nbsp;<span class="keyword" id="5243260">return</span>&nbsp;<span class="ident" id="5243267">p</span><span class="op" id="5243268">[</span><span class="ident" id="5243269">i</span><span class="op" id="5243270">]</span>&nbsp;<span class="op" id="5243272">&lt;</span>&nbsp;<span class="ident" id="5243274">p</span><span class="op" id="5243275">[</span><span class="ident" id="5243276">j</span><span class="op" id="5243277">]</span>&nbsp;<span class="op" id="5243279">}</span><br>
<span class="lineno"></span><span class="keyword" id="5243281">func</span>&nbsp;<span class="op" id="5243286">(</span><span class="ident" id="5243287">p</span>&nbsp;<span class="ident" id="5243289">runeSlice</span><span class="op" id="5243298">)</span>&nbsp;<span class="ident" id="5243300">Swap</span><span class="op" id="5243304">(</span><span class="ident" id="5243305">i</span><span class="op" id="5243306">,</span>&nbsp;<span class="ident" id="5243308">j</span>&nbsp;<span class="builtintype" id="5243310">int</span><span class="op" id="5243313">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5243320">{</span>&nbsp;<span class="ident" id="5243322">p</span><span class="op" id="5243323">[</span><span class="ident" id="5243324">i</span><span class="op" id="5243325">]</span><span class="op" id="5243326">,</span>&nbsp;<span class="ident" id="5243328">p</span><span class="op" id="5243329">[</span><span class="ident" id="5243330">j</span><span class="op" id="5243331">]</span>&nbsp;<span class="op" id="5243333">=</span>&nbsp;<span class="ident" id="5243335">p</span><span class="op" id="5243336">[</span><span class="ident" id="5243337">j</span><span class="op" id="5243338">]</span><span class="op" id="5243339">,</span>&nbsp;<span class="ident" id="5243341">p</span><span class="op" id="5243342">[</span><span class="ident" id="5243343">i</span><span class="op" id="5243344">]</span>&nbsp;<span class="op" id="5243346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5243349">//&nbsp;Sort&nbsp;is&nbsp;a&nbsp;convenience&nbsp;method.</span><br>
<span class="lineno">290</span><span class="keyword" id="5243382">func</span>&nbsp;<span class="op" id="5243387">(</span><span class="ident" id="5243388">p</span>&nbsp;<span class="ident" id="5243390">runeSlice</span><span class="op" id="5243399">)</span>&nbsp;<span class="ident" id="5243401">Sort</span><span class="op" id="5243405">(</span><span class="op" id="5243406">)</span>&nbsp;<span class="op" id="5243408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5243411">sort</span><span class="op" id="5243415">.</span><span class="ident" id="5243416">Sort</span><span class="op" id="5243420">(</span><span class="ident" id="5243421">p</span><span class="op" id="5243422">)</span><br>
<span class="lineno"></span><span class="op" id="5243424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5243427">var</span>&nbsp;<span class="ident" id="5243431">anyRuneNotNL</span>&nbsp;<span class="op" id="5243444">=</span>&nbsp;<span class="op" id="5243446">[</span><span class="op" id="5243447">]</span><span class="builtintype" id="5243448">rune</span><span class="op" id="5243452">{</span><span class="num" id="5243453">0</span><span class="op" id="5243454">,</span>&nbsp;<span class="string" id="5243456">&#39;\n&#39;</span>&nbsp;<span class="op" id="5243461">-</span>&nbsp;<span class="num" id="5243463">1</span><span class="op" id="5243464">,</span>&nbsp;<span class="string" id="5243466">&#39;\n&#39;</span>&nbsp;<span class="op" id="5243471">+</span>&nbsp;<span class="num" id="5243473">1</span><span class="op" id="5243474">,</span>&nbsp;<span class="ident" id="5243476">unicode</span><span class="op" id="5243483">.</span><span class="ident" id="5243484">MaxRune</span><span class="op" id="5243491">}</span><br>
<span class="lineno">295</span><span class="keyword" id="5243493">var</span>&nbsp;<span class="ident" id="5243497">anyRune</span>&nbsp;<span class="op" id="5243505">=</span>&nbsp;<span class="op" id="5243507">[</span><span class="op" id="5243508">]</span><span class="builtintype" id="5243509">rune</span><span class="op" id="5243513">{</span><span class="num" id="5243514">0</span><span class="op" id="5243515">,</span>&nbsp;<span class="ident" id="5243517">unicode</span><span class="op" id="5243524">.</span><span class="ident" id="5243525">MaxRune</span><span class="op" id="5243532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5243535">//&nbsp;makeOnePass&nbsp;creates&nbsp;a&nbsp;onepass&nbsp;Prog,&nbsp;if&nbsp;possible.&nbsp;It&nbsp;is&nbsp;possible&nbsp;if&nbsp;at&nbsp;any&nbsp;alt,</span><br>
<span class="lineno"></span><span class="comment" id="5243617">//&nbsp;the&nbsp;match&nbsp;engine&nbsp;can&nbsp;always&nbsp;tell&nbsp;which&nbsp;branch&nbsp;to&nbsp;take.&nbsp;The&nbsp;routine&nbsp;may&nbsp;modify</span><br>
<span class="lineno"></span><span class="comment" id="5243698">//&nbsp;p&nbsp;if&nbsp;it&nbsp;is&nbsp;turned&nbsp;into&nbsp;a&nbsp;onepass&nbsp;Prog.&nbsp;If&nbsp;it&nbsp;isn&#39;t&nbsp;possible&nbsp;for&nbsp;this&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno">300</span><span class="comment" id="5243778">//&nbsp;onepass&nbsp;Prog,&nbsp;the&nbsp;Prog&nbsp;notOnePass&nbsp;is&nbsp;returned.&nbsp;makeOnePass&nbsp;is&nbsp;recursive</span><br>
<span class="lineno"></span><span class="comment" id="5243853">//&nbsp;to&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;Prog.</span><br>
<span class="lineno"></span><span class="keyword" id="5243881">func</span>&nbsp;<span class="ident" id="5243886">makeOnePass</span><span class="op" id="5243897">(</span><span class="ident" id="5243898">p</span>&nbsp;<span class="op" id="5243900">*</span><span class="ident" id="5243901">onePassProg</span><span class="op" id="5243912">)</span>&nbsp;<span class="op" id="5243914">*</span><span class="ident" id="5243915">onePassProg</span>&nbsp;<span class="op" id="5243927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5243930">//&nbsp;If&nbsp;the&nbsp;machine&nbsp;is&nbsp;very&nbsp;long,&nbsp;it&#39;s&nbsp;not&nbsp;worth&nbsp;the&nbsp;time&nbsp;to&nbsp;check&nbsp;if&nbsp;we&nbsp;can&nbsp;use&nbsp;one&nbsp;pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244020">if</span>&nbsp;<span class="builtinfunc" id="5244023">len</span><span class="op" id="5244026">(</span><span class="ident" id="5244027">p</span><span class="op" id="5244028">.</span><span class="ident" id="5244029">Inst</span><span class="op" id="5244033">)</span>&nbsp;<span class="op" id="5244035">&gt;=</span>&nbsp;<span class="num" id="5244038">1000</span>&nbsp;<span class="op" id="5244043">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244047">return</span>&nbsp;<span class="ident" id="5244054">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5244066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244070">var</span>&nbsp;<span class="op" id="5244074">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244078">instQueue</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5244091">=</span>&nbsp;<span class="ident" id="5244093">newQueue</span><span class="op" id="5244101">(</span><span class="builtinfunc" id="5244102">len</span><span class="op" id="5244105">(</span><span class="ident" id="5244106">p</span><span class="op" id="5244107">.</span><span class="ident" id="5244108">Inst</span><span class="op" id="5244112">)</span><span class="op" id="5244113">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244117">visitQueue</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5244130">=</span>&nbsp;<span class="ident" id="5244132">newQueue</span><span class="op" id="5244140">(</span><span class="builtinfunc" id="5244141">len</span><span class="op" id="5244144">(</span><span class="ident" id="5244145">p</span><span class="op" id="5244146">.</span><span class="ident" id="5244147">Inst</span><span class="op" id="5244151">)</span><span class="op" id="5244152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244156">build</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5244169">func</span><span class="op" id="5244173">(</span><span class="builtintype" id="5244174">uint32</span><span class="op" id="5244180">,</span>&nbsp;<span class="op" id="5244182">*</span><span class="ident" id="5244183">queueOnePass</span><span class="op" id="5244195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244199">check</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5244212">func</span><span class="op" id="5244216">(</span><span class="builtintype" id="5244217">uint32</span><span class="op" id="5244223">,</span>&nbsp;<span class="keyword" id="5244225">map</span><span class="op" id="5244228">[</span><span class="builtintype" id="5244229">uint32</span><span class="op" id="5244235">]</span><span class="builtintype" id="5244236">bool</span><span class="op" id="5244240">)</span>&nbsp;<span class="builtintype" id="5244242">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244249">onePassRunes</span>&nbsp;<span class="op" id="5244262">=</span>&nbsp;<span class="builtinfunc" id="5244264">make</span><span class="op" id="5244268">(</span><span class="op" id="5244269">[</span><span class="op" id="5244270">]</span><span class="op" id="5244271">[</span><span class="op" id="5244272">]</span><span class="builtintype" id="5244273">rune</span><span class="op" id="5244277">,</span>&nbsp;<span class="builtinfunc" id="5244279">len</span><span class="op" id="5244282">(</span><span class="ident" id="5244283">p</span><span class="op" id="5244284">.</span><span class="ident" id="5244285">Inst</span><span class="op" id="5244289">)</span><span class="op" id="5244290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5244293">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244296">build</span>&nbsp;<span class="op" id="5244302">=</span>&nbsp;<span class="keyword" id="5244304">func</span><span class="op" id="5244308">(</span><span class="ident" id="5244309">pc</span>&nbsp;<span class="builtintype" id="5244312">uint32</span><span class="op" id="5244318">,</span>&nbsp;<span class="ident" id="5244320">q</span>&nbsp;<span class="op" id="5244322">*</span><span class="ident" id="5244323">queueOnePass</span><span class="op" id="5244335">)</span>&nbsp;<span class="op" id="5244337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244341">if</span>&nbsp;<span class="ident" id="5244344">q</span><span class="op" id="5244345">.</span><span class="ident" id="5244346">contains</span><span class="op" id="5244354">(</span><span class="ident" id="5244355">pc</span><span class="op" id="5244357">)</span>&nbsp;<span class="op" id="5244359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244364">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5244373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244377">inst</span>&nbsp;<span class="op" id="5244382">:=</span>&nbsp;<span class="ident" id="5244385">p</span><span class="op" id="5244386">.</span><span class="ident" id="5244387">Inst</span><span class="op" id="5244391">[</span><span class="ident" id="5244392">pc</span><span class="op" id="5244394">]</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244398">switch</span>&nbsp;<span class="ident" id="5244405">inst</span><span class="op" id="5244409">.</span><span class="ident" id="5244410">Op</span>&nbsp;<span class="op" id="5244413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244417">case</span>&nbsp;<span class="ident" id="5244422">syntax</span><span class="op" id="5244428">.</span><span class="ident" id="5244429">InstAlt</span><span class="op" id="5244436">,</span>&nbsp;<span class="ident" id="5244438">syntax</span><span class="op" id="5244444">.</span><span class="ident" id="5244445">InstAltMatch</span><span class="op" id="5244457">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244462">q</span><span class="op" id="5244463">.</span><span class="ident" id="5244464">insert</span><span class="op" id="5244470">(</span><span class="ident" id="5244471">inst</span><span class="op" id="5244475">.</span><span class="ident" id="5244476">Out</span><span class="op" id="5244479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244484">build</span><span class="op" id="5244489">(</span><span class="ident" id="5244490">inst</span><span class="op" id="5244494">.</span><span class="ident" id="5244495">Out</span><span class="op" id="5244498">,</span>&nbsp;<span class="ident" id="5244500">q</span><span class="op" id="5244501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244506">q</span><span class="op" id="5244507">.</span><span class="ident" id="5244508">insert</span><span class="op" id="5244514">(</span><span class="ident" id="5244515">inst</span><span class="op" id="5244519">.</span><span class="ident" id="5244520">Arg</span><span class="op" id="5244523">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244527">case</span>&nbsp;<span class="ident" id="5244532">syntax</span><span class="op" id="5244538">.</span><span class="ident" id="5244539">InstMatch</span><span class="op" id="5244548">,</span>&nbsp;<span class="ident" id="5244550">syntax</span><span class="op" id="5244556">.</span><span class="ident" id="5244557">InstFail</span><span class="op" id="5244565">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244569">default</span><span class="op" id="5244576">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244581">q</span><span class="op" id="5244582">.</span><span class="ident" id="5244583">insert</span><span class="op" id="5244589">(</span><span class="ident" id="5244590">inst</span><span class="op" id="5244594">.</span><span class="ident" id="5244595">Out</span><span class="op" id="5244598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5244602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5244605">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5244609">//&nbsp;check&nbsp;that&nbsp;paths&nbsp;from&nbsp;Alt&nbsp;instructions&nbsp;are&nbsp;unambiguous,&nbsp;and&nbsp;rebuild&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5244689">//&nbsp;program&nbsp;as&nbsp;a&nbsp;onepass&nbsp;program</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244722">check</span>&nbsp;<span class="op" id="5244728">=</span>&nbsp;<span class="keyword" id="5244730">func</span><span class="op" id="5244734">(</span><span class="ident" id="5244735">pc</span>&nbsp;<span class="builtintype" id="5244738">uint32</span><span class="op" id="5244744">,</span>&nbsp;<span class="ident" id="5244746">m</span>&nbsp;<span class="keyword" id="5244748">map</span><span class="op" id="5244751">[</span><span class="builtintype" id="5244752">uint32</span><span class="op" id="5244758">]</span><span class="builtintype" id="5244759">bool</span><span class="op" id="5244763">)</span>&nbsp;<span class="op" id="5244765">(</span><span class="ident" id="5244766">ok</span>&nbsp;<span class="builtintype" id="5244769">bool</span><span class="op" id="5244773">)</span>&nbsp;<span class="op" id="5244775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244779">ok</span>&nbsp;<span class="op" id="5244782">=</span>&nbsp;<span class="builtintype" id="5244784">true</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244791">inst</span>&nbsp;<span class="op" id="5244796">:=</span>&nbsp;<span class="op" id="5244799">&amp;</span><span class="ident" id="5244800">p</span><span class="op" id="5244801">.</span><span class="ident" id="5244802">Inst</span><span class="op" id="5244806">[</span><span class="ident" id="5244807">pc</span><span class="op" id="5244809">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244813">if</span>&nbsp;<span class="ident" id="5244816">visitQueue</span><span class="op" id="5244826">.</span><span class="ident" id="5244827">contains</span><span class="op" id="5244835">(</span><span class="ident" id="5244836">pc</span><span class="op" id="5244838">)</span>&nbsp;<span class="op" id="5244840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244845">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5244854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244858">visitQueue</span><span class="op" id="5244868">.</span><span class="ident" id="5244869">insert</span><span class="op" id="5244875">(</span><span class="ident" id="5244876">pc</span><span class="op" id="5244878">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244882">switch</span>&nbsp;<span class="ident" id="5244889">inst</span><span class="op" id="5244893">.</span><span class="ident" id="5244894">Op</span>&nbsp;<span class="op" id="5244897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244901">case</span>&nbsp;<span class="ident" id="5244906">syntax</span><span class="op" id="5244912">.</span><span class="ident" id="5244913">InstAlt</span><span class="op" id="5244920">,</span>&nbsp;<span class="ident" id="5244922">syntax</span><span class="op" id="5244928">.</span><span class="ident" id="5244929">InstAltMatch</span><span class="op" id="5244941">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244946">ok</span>&nbsp;<span class="op" id="5244949">=</span>&nbsp;<span class="ident" id="5244951">check</span><span class="op" id="5244956">(</span><span class="ident" id="5244957">inst</span><span class="op" id="5244961">.</span><span class="ident" id="5244962">Out</span><span class="op" id="5244965">,</span>&nbsp;<span class="ident" id="5244967">m</span><span class="op" id="5244968">)</span>&nbsp;<span class="op" id="5244970">&amp;&amp;</span>&nbsp;<span class="ident" id="5244973">check</span><span class="op" id="5244978">(</span><span class="ident" id="5244979">inst</span><span class="op" id="5244983">.</span><span class="ident" id="5244984">Arg</span><span class="op" id="5244987">,</span>&nbsp;<span class="ident" id="5244989">m</span><span class="op" id="5244990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5244995">//&nbsp;check&nbsp;no-input&nbsp;paths&nbsp;to&nbsp;InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245035">matchOut</span>&nbsp;<span class="op" id="5245044">:=</span>&nbsp;<span class="ident" id="5245047">m</span><span class="op" id="5245048">[</span><span class="ident" id="5245049">inst</span><span class="op" id="5245053">.</span><span class="ident" id="5245054">Out</span><span class="op" id="5245057">]</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245062">matchArg</span>&nbsp;<span class="op" id="5245071">:=</span>&nbsp;<span class="ident" id="5245074">m</span><span class="op" id="5245075">[</span><span class="ident" id="5245076">inst</span><span class="op" id="5245080">.</span><span class="ident" id="5245081">Arg</span><span class="op" id="5245084">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5245089">if</span>&nbsp;<span class="ident" id="5245092">matchOut</span>&nbsp;<span class="op" id="5245101">&amp;&amp;</span>&nbsp;<span class="ident" id="5245104">matchArg</span>&nbsp;<span class="op" id="5245113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245119">ok</span>&nbsp;<span class="op" id="5245122">=</span>&nbsp;<span class="builtintype" id="5245124">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5245134">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5245143">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5245148">//&nbsp;Match&nbsp;on&nbsp;empty&nbsp;goes&nbsp;in&nbsp;inst.Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5245186">if</span>&nbsp;<span class="ident" id="5245189">matchArg</span>&nbsp;<span class="op" id="5245198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245204">inst</span><span class="op" id="5245208">.</span><span class="ident" id="5245209">Out</span><span class="op" id="5245212">,</span>&nbsp;<span class="ident" id="5245214">inst</span><span class="op" id="5245218">.</span><span class="ident" id="5245219">Arg</span>&nbsp;<span class="op" id="5245223">=</span>&nbsp;<span class="ident" id="5245225">inst</span><span class="op" id="5245229">.</span><span class="ident" id="5245230">Arg</span><span class="op" id="5245233">,</span>&nbsp;<span class="ident" id="5245235">inst</span><span class="op" id="5245239">.</span><span class="ident" id="5245240">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245248">matchOut</span><span class="op" id="5245256">,</span>&nbsp;<span class="ident" id="5245258">matchArg</span>&nbsp;<span class="op" id="5245267">=</span>&nbsp;<span class="ident" id="5245269">matchArg</span><span class="op" id="5245277">,</span>&nbsp;<span class="ident" id="5245279">matchOut</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5245291">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5245296">if</span>&nbsp;<span class="ident" id="5245299">matchOut</span>&nbsp;<span class="op" id="5245308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245314">m</span><span class="op" id="5245315">[</span><span class="ident" id="5245316">pc</span><span class="op" id="5245318">]</span>&nbsp;<span class="op" id="5245320">=</span>&nbsp;<span class="builtintype" id="5245322">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245331">inst</span><span class="op" id="5245335">.</span><span class="ident" id="5245336">Op</span>&nbsp;<span class="op" id="5245339">=</span>&nbsp;<span class="ident" id="5245341">syntax</span><span class="op" id="5245347">.</span><span class="ident" id="5245348">InstAltMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5245364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5245370">//&nbsp;build&nbsp;a&nbsp;dispatch&nbsp;operator&nbsp;from&nbsp;the&nbsp;two&nbsp;legs&nbsp;of&nbsp;the&nbsp;alt.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245432">onePassRunes</span><span class="op" id="5245444">[</span><span class="ident" id="5245445">pc</span><span class="op" id="5245447">]</span><span class="op" id="5245448">,</span>&nbsp;<span class="ident" id="5245450">inst</span><span class="op" id="5245454">.</span><span class="ident" id="5245455">Next</span>&nbsp;<span class="op" id="5245460">=</span>&nbsp;<span class="ident" id="5245462">mergeRuneSets</span><span class="op" id="5245475">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5245481">&amp;</span><span class="ident" id="5245482">onePassRunes</span><span class="op" id="5245494">[</span><span class="ident" id="5245495">inst</span><span class="op" id="5245499">.</span><span class="ident" id="5245500">Out</span><span class="op" id="5245503">]</span><span class="op" id="5245504">,</span>&nbsp;<span class="op" id="5245506">&amp;</span><span class="ident" id="5245507">onePassRunes</span><span class="op" id="5245519">[</span><span class="ident" id="5245520">inst</span><span class="op" id="5245524">.</span><span class="ident" id="5245525">Arg</span><span class="op" id="5245528">]</span><span class="op" id="5245529">,</span>&nbsp;<span class="ident" id="5245531">inst</span><span class="op" id="5245535">.</span><span class="ident" id="5245536">Out</span><span class="op" id="5245539">,</span>&nbsp;<span class="ident" id="5245541">inst</span><span class="op" id="5245545">.</span><span class="ident" id="5245546">Arg</span><span class="op" id="5245549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5245554">if</span>&nbsp;<span class="builtinfunc" id="5245557">len</span><span class="op" id="5245560">(</span><span class="ident" id="5245561">inst</span><span class="op" id="5245565">.</span><span class="ident" id="5245566">Next</span><span class="op" id="5245570">)</span>&nbsp;<span class="op" id="5245572">&gt;</span>&nbsp;<span class="num" id="5245574">0</span>&nbsp;<span class="op" id="5245576">&amp;&amp;</span>&nbsp;<span class="ident" id="5245579">inst</span><span class="op" id="5245583">.</span><span class="ident" id="5245584">Next</span><span class="op" id="5245588">[</span><span class="num" id="5245589">0</span><span class="op" id="5245590">]</span>&nbsp;<span class="op" id="5245592">==</span>&nbsp;<span class="ident" id="5245595">mergeFailed</span>&nbsp;<span class="op" id="5245607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245613">ok</span>&nbsp;<span class="op" id="5245616">=</span>&nbsp;<span class="builtintype" id="5245618">false</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5245628">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5245637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5245641">case</span>&nbsp;<span class="ident" id="5245646">syntax</span><span class="op" id="5245652">.</span><span class="ident" id="5245653">InstCapture</span><span class="op" id="5245664">,</span>&nbsp;<span class="ident" id="5245666">syntax</span><span class="op" id="5245672">.</span><span class="ident" id="5245673">InstNop</span><span class="op" id="5245680">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245685">ok</span>&nbsp;<span class="op" id="5245688">=</span>&nbsp;<span class="ident" id="5245690">check</span><span class="op" id="5245695">(</span><span class="ident" id="5245696">inst</span><span class="op" id="5245700">.</span><span class="ident" id="5245701">Out</span><span class="op" id="5245704">,</span>&nbsp;<span class="ident" id="5245706">m</span><span class="op" id="5245707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245712">m</span><span class="op" id="5245713">[</span><span class="ident" id="5245714">pc</span><span class="op" id="5245716">]</span>&nbsp;<span class="op" id="5245718">=</span>&nbsp;<span class="ident" id="5245720">m</span><span class="op" id="5245721">[</span><span class="ident" id="5245722">inst</span><span class="op" id="5245726">.</span><span class="ident" id="5245727">Out</span><span class="op" id="5245730">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5245735">//&nbsp;pass&nbsp;matching&nbsp;runes&nbsp;back&nbsp;through&nbsp;these&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245788">onePassRunes</span><span class="op" id="5245800">[</span><span class="ident" id="5245801">pc</span><span class="op" id="5245803">]</span>&nbsp;<span class="op" id="5245805">=</span>&nbsp;<span class="builtinfunc" id="5245807">append</span><span class="op" id="5245813">(</span><span class="op" id="5245814">[</span><span class="op" id="5245815">]</span><span class="builtintype" id="5245816">rune</span><span class="op" id="5245820">{</span><span class="op" id="5245821">}</span><span class="op" id="5245822">,</span>&nbsp;<span class="ident" id="5245824">onePassRunes</span><span class="op" id="5245836">[</span><span class="ident" id="5245837">inst</span><span class="op" id="5245841">.</span><span class="ident" id="5245842">Out</span><span class="op" id="5245845">]</span><span class="op" id="5245846">...</span><span class="op" id="5245849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245854">inst</span><span class="op" id="5245858">.</span><span class="ident" id="5245859">Next</span>&nbsp;<span class="op" id="5245864">=</span>&nbsp;<span class="op" id="5245866">[</span><span class="op" id="5245867">]</span><span class="builtintype" id="5245868">uint32</span><span class="op" id="5245874">{</span><span class="op" id="5245875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5245880">for</span>&nbsp;<span class="ident" id="5245884">i</span>&nbsp;<span class="op" id="5245886">:=</span>&nbsp;<span class="builtinfunc" id="5245889">len</span><span class="op" id="5245892">(</span><span class="ident" id="5245893">onePassRunes</span><span class="op" id="5245905">[</span><span class="ident" id="5245906">pc</span><span class="op" id="5245908">]</span><span class="op" id="5245909">)</span>&nbsp;<span class="op" id="5245911">/</span>&nbsp;<span class="num" id="5245913">2</span><span class="op" id="5245914">;</span>&nbsp;<span class="ident" id="5245916">i</span>&nbsp;<span class="op" id="5245918">&gt;=</span>&nbsp;<span class="num" id="5245921">0</span><span class="op" id="5245922">;</span>&nbsp;<span class="ident" id="5245924">i</span><span class="op" id="5245925">--</span>&nbsp;<span class="op" id="5245928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245934">inst</span><span class="op" id="5245938">.</span><span class="ident" id="5245939">Next</span>&nbsp;<span class="op" id="5245944">=</span>&nbsp;<span class="builtinfunc" id="5245946">append</span><span class="op" id="5245952">(</span><span class="ident" id="5245953">inst</span><span class="op" id="5245957">.</span><span class="ident" id="5245958">Next</span><span class="op" id="5245962">,</span>&nbsp;<span class="ident" id="5245964">inst</span><span class="op" id="5245968">.</span><span class="ident" id="5245969">Out</span><span class="op" id="5245972">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5245977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5245981">case</span>&nbsp;<span class="ident" id="5245986">syntax</span><span class="op" id="5245992">.</span><span class="ident" id="5245993">InstEmptyWidth</span><span class="op" id="5246007">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246012">ok</span>&nbsp;<span class="op" id="5246015">=</span>&nbsp;<span class="ident" id="5246017">check</span><span class="op" id="5246022">(</span><span class="ident" id="5246023">inst</span><span class="op" id="5246027">.</span><span class="ident" id="5246028">Out</span><span class="op" id="5246031">,</span>&nbsp;<span class="ident" id="5246033">m</span><span class="op" id="5246034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246039">m</span><span class="op" id="5246040">[</span><span class="ident" id="5246041">pc</span><span class="op" id="5246043">]</span>&nbsp;<span class="op" id="5246045">=</span>&nbsp;<span class="ident" id="5246047">m</span><span class="op" id="5246048">[</span><span class="ident" id="5246049">inst</span><span class="op" id="5246053">.</span><span class="ident" id="5246054">Out</span><span class="op" id="5246057">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246062">onePassRunes</span><span class="op" id="5246074">[</span><span class="ident" id="5246075">pc</span><span class="op" id="5246077">]</span>&nbsp;<span class="op" id="5246079">=</span>&nbsp;<span class="builtinfunc" id="5246081">append</span><span class="op" id="5246087">(</span><span class="op" id="5246088">[</span><span class="op" id="5246089">]</span><span class="builtintype" id="5246090">rune</span><span class="op" id="5246094">{</span><span class="op" id="5246095">}</span><span class="op" id="5246096">,</span>&nbsp;<span class="ident" id="5246098">onePassRunes</span><span class="op" id="5246110">[</span><span class="ident" id="5246111">inst</span><span class="op" id="5246115">.</span><span class="ident" id="5246116">Out</span><span class="op" id="5246119">]</span><span class="op" id="5246120">...</span><span class="op" id="5246123">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246128">inst</span><span class="op" id="5246132">.</span><span class="ident" id="5246133">Next</span>&nbsp;<span class="op" id="5246138">=</span>&nbsp;<span class="op" id="5246140">[</span><span class="op" id="5246141">]</span><span class="builtintype" id="5246142">uint32</span><span class="op" id="5246148">{</span><span class="op" id="5246149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246154">for</span>&nbsp;<span class="ident" id="5246158">i</span>&nbsp;<span class="op" id="5246160">:=</span>&nbsp;<span class="builtinfunc" id="5246163">len</span><span class="op" id="5246166">(</span><span class="ident" id="5246167">onePassRunes</span><span class="op" id="5246179">[</span><span class="ident" id="5246180">pc</span><span class="op" id="5246182">]</span><span class="op" id="5246183">)</span>&nbsp;<span class="op" id="5246185">/</span>&nbsp;<span class="num" id="5246187">2</span><span class="op" id="5246188">;</span>&nbsp;<span class="ident" id="5246190">i</span>&nbsp;<span class="op" id="5246192">&gt;=</span>&nbsp;<span class="num" id="5246195">0</span><span class="op" id="5246196">;</span>&nbsp;<span class="ident" id="5246198">i</span><span class="op" id="5246199">--</span>&nbsp;<span class="op" id="5246202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246208">inst</span><span class="op" id="5246212">.</span><span class="ident" id="5246213">Next</span>&nbsp;<span class="op" id="5246218">=</span>&nbsp;<span class="builtinfunc" id="5246220">append</span><span class="op" id="5246226">(</span><span class="ident" id="5246227">inst</span><span class="op" id="5246231">.</span><span class="ident" id="5246232">Next</span><span class="op" id="5246236">,</span>&nbsp;<span class="ident" id="5246238">inst</span><span class="op" id="5246242">.</span><span class="ident" id="5246243">Out</span><span class="op" id="5246246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5246251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246255">case</span>&nbsp;<span class="ident" id="5246260">syntax</span><span class="op" id="5246266">.</span><span class="ident" id="5246267">InstMatch</span><span class="op" id="5246276">,</span>&nbsp;<span class="ident" id="5246278">syntax</span><span class="op" id="5246284">.</span><span class="ident" id="5246285">InstFail</span><span class="op" id="5246293">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246298">m</span><span class="op" id="5246299">[</span><span class="ident" id="5246300">pc</span><span class="op" id="5246302">]</span>&nbsp;<span class="op" id="5246304">=</span>&nbsp;<span class="ident" id="5246306">inst</span><span class="op" id="5246310">.</span><span class="ident" id="5246311">Op</span>&nbsp;<span class="op" id="5246314">==</span>&nbsp;<span class="ident" id="5246317">syntax</span><span class="op" id="5246323">.</span><span class="ident" id="5246324">InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246337">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246345">case</span>&nbsp;<span class="ident" id="5246350">syntax</span><span class="op" id="5246356">.</span><span class="ident" id="5246357">InstRune</span><span class="op" id="5246365">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246370">ok</span>&nbsp;<span class="op" id="5246373">=</span>&nbsp;<span class="ident" id="5246375">check</span><span class="op" id="5246380">(</span><span class="ident" id="5246381">inst</span><span class="op" id="5246385">.</span><span class="ident" id="5246386">Out</span><span class="op" id="5246389">,</span>&nbsp;<span class="ident" id="5246391">m</span><span class="op" id="5246392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246397">m</span><span class="op" id="5246398">[</span><span class="ident" id="5246399">pc</span><span class="op" id="5246401">]</span>&nbsp;<span class="op" id="5246403">=</span>&nbsp;<span class="builtintype" id="5246405">false</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246414">if</span>&nbsp;<span class="builtinfunc" id="5246417">len</span><span class="op" id="5246420">(</span><span class="ident" id="5246421">inst</span><span class="op" id="5246425">.</span><span class="ident" id="5246426">Next</span><span class="op" id="5246430">)</span>&nbsp;<span class="op" id="5246432">&gt;</span>&nbsp;<span class="num" id="5246434">0</span>&nbsp;<span class="op" id="5246436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246442">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5246451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246456">if</span>&nbsp;<span class="builtinfunc" id="5246459">len</span><span class="op" id="5246462">(</span><span class="ident" id="5246463">inst</span><span class="op" id="5246467">.</span><span class="ident" id="5246468">Rune</span><span class="op" id="5246472">)</span>&nbsp;<span class="op" id="5246474">==</span>&nbsp;<span class="num" id="5246477">0</span>&nbsp;<span class="op" id="5246479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246485">onePassRunes</span><span class="op" id="5246497">[</span><span class="ident" id="5246498">pc</span><span class="op" id="5246500">]</span>&nbsp;<span class="op" id="5246502">=</span>&nbsp;<span class="op" id="5246504">[</span><span class="op" id="5246505">]</span><span class="builtintype" id="5246506">rune</span><span class="op" id="5246510">{</span><span class="op" id="5246511">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246517">inst</span><span class="op" id="5246521">.</span><span class="ident" id="5246522">Next</span>&nbsp;<span class="op" id="5246527">=</span>&nbsp;<span class="op" id="5246529">[</span><span class="op" id="5246530">]</span><span class="builtintype" id="5246531">uint32</span><span class="op" id="5246537">{</span><span class="ident" id="5246538">inst</span><span class="op" id="5246542">.</span><span class="ident" id="5246543">Out</span><span class="op" id="5246546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246552">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5246561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246566">runes</span>&nbsp;<span class="op" id="5246572">:=</span>&nbsp;<span class="builtinfunc" id="5246575">make</span><span class="op" id="5246579">(</span><span class="op" id="5246580">[</span><span class="op" id="5246581">]</span><span class="builtintype" id="5246582">rune</span><span class="op" id="5246586">,</span>&nbsp;<span class="num" id="5246588">0</span><span class="op" id="5246589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246594">if</span>&nbsp;<span class="builtinfunc" id="5246597">len</span><span class="op" id="5246600">(</span><span class="ident" id="5246601">inst</span><span class="op" id="5246605">.</span><span class="ident" id="5246606">Rune</span><span class="op" id="5246610">)</span>&nbsp;<span class="op" id="5246612">==</span>&nbsp;<span class="num" id="5246615">1</span>&nbsp;<span class="op" id="5246617">&amp;&amp;</span>&nbsp;<span class="ident" id="5246620">syntax</span><span class="op" id="5246626">.</span><span class="ident" id="5246627">Flags</span><span class="op" id="5246632">(</span><span class="ident" id="5246633">inst</span><span class="op" id="5246637">.</span><span class="ident" id="5246638">Arg</span><span class="op" id="5246641">)</span><span class="op" id="5246642">&amp;</span><span class="ident" id="5246643">syntax</span><span class="op" id="5246649">.</span><span class="ident" id="5246650">FoldCase</span>&nbsp;<span class="op" id="5246659">!=</span>&nbsp;<span class="num" id="5246662">0</span>&nbsp;<span class="op" id="5246664">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246670">r0</span>&nbsp;<span class="op" id="5246673">:=</span>&nbsp;<span class="ident" id="5246676">inst</span><span class="op" id="5246680">.</span><span class="ident" id="5246681">Rune</span><span class="op" id="5246685">[</span><span class="num" id="5246686">0</span><span class="op" id="5246687">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246693">runes</span>&nbsp;<span class="op" id="5246699">=</span>&nbsp;<span class="builtinfunc" id="5246701">append</span><span class="op" id="5246707">(</span><span class="ident" id="5246708">runes</span><span class="op" id="5246713">,</span>&nbsp;<span class="ident" id="5246715">r0</span><span class="op" id="5246717">,</span>&nbsp;<span class="ident" id="5246719">r0</span><span class="op" id="5246721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246727">for</span>&nbsp;<span class="ident" id="5246731">r1</span>&nbsp;<span class="op" id="5246734">:=</span>&nbsp;<span class="ident" id="5246737">unicode</span><span class="op" id="5246744">.</span><span class="ident" id="5246745">SimpleFold</span><span class="op" id="5246755">(</span><span class="ident" id="5246756">r0</span><span class="op" id="5246758">)</span><span class="op" id="5246759">;</span>&nbsp;<span class="ident" id="5246761">r1</span>&nbsp;<span class="op" id="5246764">!=</span>&nbsp;<span class="ident" id="5246767">r0</span><span class="op" id="5246769">;</span>&nbsp;<span class="ident" id="5246771">r1</span>&nbsp;<span class="op" id="5246774">=</span>&nbsp;<span class="ident" id="5246776">unicode</span><span class="op" id="5246783">.</span><span class="ident" id="5246784">SimpleFold</span><span class="op" id="5246794">(</span><span class="ident" id="5246795">r1</span><span class="op" id="5246797">)</span>&nbsp;<span class="op" id="5246799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246806">runes</span>&nbsp;<span class="op" id="5246812">=</span>&nbsp;<span class="builtinfunc" id="5246814">append</span><span class="op" id="5246820">(</span><span class="ident" id="5246821">runes</span><span class="op" id="5246826">,</span>&nbsp;<span class="ident" id="5246828">r1</span><span class="op" id="5246830">,</span>&nbsp;<span class="ident" id="5246832">r1</span><span class="op" id="5246834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5246840">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246846">sort</span><span class="op" id="5246850">.</span><span class="ident" id="5246851">Sort</span><span class="op" id="5246855">(</span><span class="ident" id="5246856">runeSlice</span><span class="op" id="5246865">(</span><span class="ident" id="5246866">runes</span><span class="op" id="5246871">)</span><span class="op" id="5246872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5246877">}</span>&nbsp;<span class="keyword" id="5246879">else</span>&nbsp;<span class="op" id="5246884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246890">runes</span>&nbsp;<span class="op" id="5246896">=</span>&nbsp;<span class="builtinfunc" id="5246898">append</span><span class="op" id="5246904">(</span><span class="ident" id="5246905">runes</span><span class="op" id="5246910">,</span>&nbsp;<span class="ident" id="5246912">inst</span><span class="op" id="5246916">.</span><span class="ident" id="5246917">Rune</span><span class="op" id="5246921">...</span><span class="op" id="5246924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5246929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246934">onePassRunes</span><span class="op" id="5246946">[</span><span class="ident" id="5246947">pc</span><span class="op" id="5246949">]</span>&nbsp;<span class="op" id="5246951">=</span>&nbsp;<span class="ident" id="5246953">runes</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246962">inst</span><span class="op" id="5246966">.</span><span class="ident" id="5246967">Next</span>&nbsp;<span class="op" id="5246972">=</span>&nbsp;<span class="op" id="5246974">[</span><span class="op" id="5246975">]</span><span class="builtintype" id="5246976">uint32</span><span class="op" id="5246982">{</span><span class="op" id="5246983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246988">for</span>&nbsp;<span class="ident" id="5246992">i</span>&nbsp;<span class="op" id="5246994">:=</span>&nbsp;<span class="builtinfunc" id="5246997">len</span><span class="op" id="5247000">(</span><span class="ident" id="5247001">onePassRunes</span><span class="op" id="5247013">[</span><span class="ident" id="5247014">pc</span><span class="op" id="5247016">]</span><span class="op" id="5247017">)</span>&nbsp;<span class="op" id="5247019">/</span>&nbsp;<span class="num" id="5247021">2</span><span class="op" id="5247022">;</span>&nbsp;<span class="ident" id="5247024">i</span>&nbsp;<span class="op" id="5247026">&gt;=</span>&nbsp;<span class="num" id="5247029">0</span><span class="op" id="5247030">;</span>&nbsp;<span class="ident" id="5247032">i</span><span class="op" id="5247033">--</span>&nbsp;<span class="op" id="5247036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247042">inst</span><span class="op" id="5247046">.</span><span class="ident" id="5247047">Next</span>&nbsp;<span class="op" id="5247052">=</span>&nbsp;<span class="builtinfunc" id="5247054">append</span><span class="op" id="5247060">(</span><span class="ident" id="5247061">inst</span><span class="op" id="5247065">.</span><span class="ident" id="5247066">Next</span><span class="op" id="5247070">,</span>&nbsp;<span class="ident" id="5247072">inst</span><span class="op" id="5247076">.</span><span class="ident" id="5247077">Out</span><span class="op" id="5247080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5247085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247090">inst</span><span class="op" id="5247094">.</span><span class="ident" id="5247095">Op</span>&nbsp;<span class="op" id="5247098">=</span>&nbsp;<span class="ident" id="5247100">syntax</span><span class="op" id="5247106">.</span><span class="ident" id="5247107">InstRune</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5247118">case</span>&nbsp;<span class="ident" id="5247123">syntax</span><span class="op" id="5247129">.</span><span class="ident" id="5247130">InstRune1</span><span class="op" id="5247139">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247144">ok</span>&nbsp;<span class="op" id="5247147">=</span>&nbsp;<span class="ident" id="5247149">check</span><span class="op" id="5247154">(</span><span class="ident" id="5247155">inst</span><span class="op" id="5247159">.</span><span class="ident" id="5247160">Out</span><span class="op" id="5247163">,</span>&nbsp;<span class="ident" id="5247165">m</span><span class="op" id="5247166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247171">m</span><span class="op" id="5247172">[</span><span class="ident" id="5247173">pc</span><span class="op" id="5247175">]</span>&nbsp;<span class="op" id="5247177">=</span>&nbsp;<span class="builtintype" id="5247179">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5247188">if</span>&nbsp;<span class="builtinfunc" id="5247191">len</span><span class="op" id="5247194">(</span><span class="ident" id="5247195">inst</span><span class="op" id="5247199">.</span><span class="ident" id="5247200">Next</span><span class="op" id="5247204">)</span>&nbsp;<span class="op" id="5247206">&gt;</span>&nbsp;<span class="num" id="5247208">0</span>&nbsp;<span class="op" id="5247210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5247216">break</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5247225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247230">runes</span>&nbsp;<span class="op" id="5247236">:=</span>&nbsp;<span class="op" id="5247239">[</span><span class="op" id="5247240">]</span><span class="builtintype" id="5247241">rune</span><span class="op" id="5247245">{</span><span class="op" id="5247246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5247251">//&nbsp;expand&nbsp;case-folded&nbsp;runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5247282">if</span>&nbsp;<span class="ident" id="5247285">syntax</span><span class="op" id="5247291">.</span><span class="ident" id="5247292">Flags</span><span class="op" id="5247297">(</span><span class="ident" id="5247298">inst</span><span class="op" id="5247302">.</span><span class="ident" id="5247303">Arg</span><span class="op" id="5247306">)</span><span class="op" id="5247307">&amp;</span><span class="ident" id="5247308">syntax</span><span class="op" id="5247314">.</span><span class="ident" id="5247315">FoldCase</span>&nbsp;<span class="op" id="5247324">!=</span>&nbsp;<span class="num" id="5247327">0</span>&nbsp;<span class="op" id="5247329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247335">r0</span>&nbsp;<span class="op" id="5247338">:=</span>&nbsp;<span class="ident" id="5247341">inst</span><span class="op" id="5247345">.</span><span class="ident" id="5247346">Rune</span><span class="op" id="5247350">[</span><span class="num" id="5247351">0</span><span class="op" id="5247352">]</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247358">runes</span>&nbsp;<span class="op" id="5247364">=</span>&nbsp;<span class="builtinfunc" id="5247366">append</span><span class="op" id="5247372">(</span><span class="ident" id="5247373">runes</span><span class="op" id="5247378">,</span>&nbsp;<span class="ident" id="5247380">r0</span><span class="op" id="5247382">,</span>&nbsp;<span class="ident" id="5247384">r0</span><span class="op" id="5247386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5247392">for</span>&nbsp;<span class="ident" id="5247396">r1</span>&nbsp;<span class="op" id="5247399">:=</span>&nbsp;<span class="ident" id="5247402">unicode</span><span class="op" id="5247409">.</span><span class="ident" id="5247410">SimpleFold</span><span class="op" id="5247420">(</span><span class="ident" id="5247421">r0</span><span class="op" id="5247423">)</span><span class="op" id="5247424">;</span>&nbsp;<span class="ident" id="5247426">r1</span>&nbsp;<span class="op" id="5247429">!=</span>&nbsp;<span class="ident" id="5247432">r0</span><span class="op" id="5247434">;</span>&nbsp;<span class="ident" id="5247436">r1</span>&nbsp;<span class="op" id="5247439">=</span>&nbsp;<span class="ident" id="5247441">unicode</span><span class="op" id="5247448">.</span><span class="ident" id="5247449">SimpleFold</span><span class="op" id="5247459">(</span><span class="ident" id="5247460">r1</span><span class="op" id="5247462">)</span>&nbsp;<span class="op" id="5247464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247471">runes</span>&nbsp;<span class="op" id="5247477">=</span>&nbsp;<span class="builtinfunc" id="5247479">append</span><span class="op" id="5247485">(</span><span class="ident" id="5247486">runes</span><span class="op" id="5247491">,</span>&nbsp;<span class="ident" id="5247493">r1</span><span class="op" id="5247495">,</span>&nbsp;<span class="ident" id="5247497">r1</span><span class="op" id="5247499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5247505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247511">sort</span><span class="op" id="5247515">.</span><span class="ident" id="5247516">Sort</span><span class="op" id="5247520">(</span><span class="ident" id="5247521">runeSlice</span><span class="op" id="5247530">(</span><span class="ident" id="5247531">runes</span><span class="op" id="5247536">)</span><span class="op" id="5247537">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5247542">}</span>&nbsp;<span class="keyword" id="5247544">else</span>&nbsp;<span class="op" id="5247549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247555">runes</span>&nbsp;<span class="op" id="5247561">=</span>&nbsp;<span class="builtinfunc" id="5247563">append</span><span class="op" id="5247569">(</span><span class="ident" id="5247570">runes</span><span class="op" id="5247575">,</span>&nbsp;<span class="ident" id="5247577">inst</span><span class="op" id="5247581">.</span><span class="ident" id="5247582">Rune</span><span class="op" id="5247586">[</span><span class="num" id="5247587">0</span><span class="op" id="5247588">]</span><span class="op" id="5247589">,</span>&nbsp;<span class="ident" id="5247591">inst</span><span class="op" id="5247595">.</span><span class="ident" id="5247596">Rune</span><span class="op" id="5247600">[</span><span class="num" id="5247601">0</span><span class="op" id="5247602">]</span><span class="op" id="5247603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5247608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247613">onePassRunes</span><span class="op" id="5247625">[</span><span class="ident" id="5247626">pc</span><span class="op" id="5247628">]</span>&nbsp;<span class="op" id="5247630">=</span>&nbsp;<span class="ident" id="5247632">runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247641">inst</span><span class="op" id="5247645">.</span><span class="ident" id="5247646">Next</span>&nbsp;<span class="op" id="5247651">=</span>&nbsp;<span class="op" id="5247653">[</span><span class="op" id="5247654">]</span><span class="builtintype" id="5247655">uint32</span><span class="op" id="5247661">{</span><span class="op" id="5247662">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5247667">for</span>&nbsp;<span class="ident" id="5247671">i</span>&nbsp;<span class="op" id="5247673">:=</span>&nbsp;<span class="builtinfunc" id="5247676">len</span><span class="op" id="5247679">(</span><span class="ident" id="5247680">onePassRunes</span><span class="op" id="5247692">[</span><span class="ident" id="5247693">pc</span><span class="op" id="5247695">]</span><span class="op" id="5247696">)</span>&nbsp;<span class="op" id="5247698">/</span>&nbsp;<span class="num" id="5247700">2</span><span class="op" id="5247701">;</span>&nbsp;<span class="ident" id="5247703">i</span>&nbsp;<span class="op" id="5247705">&gt;=</span>&nbsp;<span class="num" id="5247708">0</span><span class="op" id="5247709">;</span>&nbsp;<span class="ident" id="5247711">i</span><span class="op" id="5247712">--</span>&nbsp;<span class="op" id="5247715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247721">inst</span><span class="op" id="5247725">.</span><span class="ident" id="5247726">Next</span>&nbsp;<span class="op" id="5247731">=</span>&nbsp;<span class="builtinfunc" id="5247733">append</span><span class="op" id="5247739">(</span><span class="ident" id="5247740">inst</span><span class="op" id="5247744">.</span><span class="ident" id="5247745">Next</span><span class="op" id="5247749">,</span>&nbsp;<span class="ident" id="5247751">inst</span><span class="op" id="5247755">.</span><span class="ident" id="5247756">Out</span><span class="op" id="5247759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5247764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247769">inst</span><span class="op" id="5247773">.</span><span class="ident" id="5247774">Op</span>&nbsp;<span class="op" id="5247777">=</span>&nbsp;<span class="ident" id="5247779">syntax</span><span class="op" id="5247785">.</span><span class="ident" id="5247786">InstRune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5247797">case</span>&nbsp;<span class="ident" id="5247802">syntax</span><span class="op" id="5247808">.</span><span class="ident" id="5247809">InstRuneAny</span><span class="op" id="5247820">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247825">ok</span>&nbsp;<span class="op" id="5247828">=</span>&nbsp;<span class="ident" id="5247830">check</span><span class="op" id="5247835">(</span><span class="ident" id="5247836">inst</span><span class="op" id="5247840">.</span><span class="ident" id="5247841">Out</span><span class="op" id="5247844">,</span>&nbsp;<span class="ident" id="5247846">m</span><span class="op" id="5247847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247852">m</span><span class="op" id="5247853">[</span><span class="ident" id="5247854">pc</span><span class="op" id="5247856">]</span>&nbsp;<span class="op" id="5247858">=</span>&nbsp;<span class="builtintype" id="5247860">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5247869">if</span>&nbsp;<span class="builtinfunc" id="5247872">len</span><span class="op" id="5247875">(</span><span class="ident" id="5247876">inst</span><span class="op" id="5247880">.</span><span class="ident" id="5247881">Next</span><span class="op" id="5247885">)</span>&nbsp;<span class="op" id="5247887">&gt;</span>&nbsp;<span class="num" id="5247889">0</span>&nbsp;<span class="op" id="5247891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5247897">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5247906">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247911">onePassRunes</span><span class="op" id="5247923">[</span><span class="ident" id="5247924">pc</span><span class="op" id="5247926">]</span>&nbsp;<span class="op" id="5247928">=</span>&nbsp;<span class="builtinfunc" id="5247930">append</span><span class="op" id="5247936">(</span><span class="op" id="5247937">[</span><span class="op" id="5247938">]</span><span class="builtintype" id="5247939">rune</span><span class="op" id="5247943">{</span><span class="op" id="5247944">}</span><span class="op" id="5247945">,</span>&nbsp;<span class="ident" id="5247947">anyRune</span><span class="op" id="5247954">...</span><span class="op" id="5247957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247962">inst</span><span class="op" id="5247966">.</span><span class="ident" id="5247967">Next</span>&nbsp;<span class="op" id="5247972">=</span>&nbsp;<span class="op" id="5247974">[</span><span class="op" id="5247975">]</span><span class="builtintype" id="5247976">uint32</span><span class="op" id="5247982">{</span><span class="ident" id="5247983">inst</span><span class="op" id="5247987">.</span><span class="ident" id="5247988">Out</span><span class="op" id="5247991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5247995">case</span>&nbsp;<span class="ident" id="5248000">syntax</span><span class="op" id="5248006">.</span><span class="ident" id="5248007">InstRuneAnyNotNL</span><span class="op" id="5248023">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248028">ok</span>&nbsp;<span class="op" id="5248031">=</span>&nbsp;<span class="ident" id="5248033">check</span><span class="op" id="5248038">(</span><span class="ident" id="5248039">inst</span><span class="op" id="5248043">.</span><span class="ident" id="5248044">Out</span><span class="op" id="5248047">,</span>&nbsp;<span class="ident" id="5248049">m</span><span class="op" id="5248050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248055">m</span><span class="op" id="5248056">[</span><span class="ident" id="5248057">pc</span><span class="op" id="5248059">]</span>&nbsp;<span class="op" id="5248061">=</span>&nbsp;<span class="builtintype" id="5248063">false</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248072">if</span>&nbsp;<span class="builtinfunc" id="5248075">len</span><span class="op" id="5248078">(</span><span class="ident" id="5248079">inst</span><span class="op" id="5248083">.</span><span class="ident" id="5248084">Next</span><span class="op" id="5248088">)</span>&nbsp;<span class="op" id="5248090">&gt;</span>&nbsp;<span class="num" id="5248092">0</span>&nbsp;<span class="op" id="5248094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248100">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5248109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248114">onePassRunes</span><span class="op" id="5248126">[</span><span class="ident" id="5248127">pc</span><span class="op" id="5248129">]</span>&nbsp;<span class="op" id="5248131">=</span>&nbsp;<span class="builtinfunc" id="5248133">append</span><span class="op" id="5248139">(</span><span class="op" id="5248140">[</span><span class="op" id="5248141">]</span><span class="builtintype" id="5248142">rune</span><span class="op" id="5248146">{</span><span class="op" id="5248147">}</span><span class="op" id="5248148">,</span>&nbsp;<span class="ident" id="5248150">anyRuneNotNL</span><span class="op" id="5248162">...</span><span class="op" id="5248165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248170">inst</span><span class="op" id="5248174">.</span><span class="ident" id="5248175">Next</span>&nbsp;<span class="op" id="5248180">=</span>&nbsp;<span class="op" id="5248182">[</span><span class="op" id="5248183">]</span><span class="builtintype" id="5248184">uint32</span><span class="op" id="5248190">{</span><span class="op" id="5248191">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248196">for</span>&nbsp;<span class="ident" id="5248200">i</span>&nbsp;<span class="op" id="5248202">:=</span>&nbsp;<span class="builtinfunc" id="5248205">len</span><span class="op" id="5248208">(</span><span class="ident" id="5248209">onePassRunes</span><span class="op" id="5248221">[</span><span class="ident" id="5248222">pc</span><span class="op" id="5248224">]</span><span class="op" id="5248225">)</span>&nbsp;<span class="op" id="5248227">/</span>&nbsp;<span class="num" id="5248229">2</span><span class="op" id="5248230">;</span>&nbsp;<span class="ident" id="5248232">i</span>&nbsp;<span class="op" id="5248234">&gt;=</span>&nbsp;<span class="num" id="5248237">0</span><span class="op" id="5248238">;</span>&nbsp;<span class="ident" id="5248240">i</span><span class="op" id="5248241">--</span>&nbsp;<span class="op" id="5248244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248250">inst</span><span class="op" id="5248254">.</span><span class="ident" id="5248255">Next</span>&nbsp;<span class="op" id="5248260">=</span>&nbsp;<span class="builtinfunc" id="5248262">append</span><span class="op" id="5248268">(</span><span class="ident" id="5248269">inst</span><span class="op" id="5248273">.</span><span class="ident" id="5248274">Next</span><span class="op" id="5248278">,</span>&nbsp;<span class="ident" id="5248280">inst</span><span class="op" id="5248284">.</span><span class="ident" id="5248285">Out</span><span class="op" id="5248288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5248293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5248297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248301">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5248309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248313">instQueue</span><span class="op" id="5248322">.</span><span class="ident" id="5248323">clear</span><span class="op" id="5248328">(</span><span class="op" id="5248329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248332">instQueue</span><span class="op" id="5248341">.</span><span class="ident" id="5248342">insert</span><span class="op" id="5248348">(</span><span class="builtintype" id="5248349">uint32</span><span class="op" id="5248355">(</span><span class="ident" id="5248356">p</span><span class="op" id="5248357">.</span><span class="ident" id="5248358">Start</span><span class="op" id="5248363">)</span><span class="op" id="5248364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248367">m</span>&nbsp;<span class="op" id="5248369">:=</span>&nbsp;<span class="builtinfunc" id="5248372">make</span><span class="op" id="5248376">(</span><span class="keyword" id="5248377">map</span><span class="op" id="5248380">[</span><span class="builtintype" id="5248381">uint32</span><span class="op" id="5248387">]</span><span class="builtintype" id="5248388">bool</span><span class="op" id="5248392">,</span>&nbsp;<span class="builtinfunc" id="5248394">len</span><span class="op" id="5248397">(</span><span class="ident" id="5248398">p</span><span class="op" id="5248399">.</span><span class="ident" id="5248400">Inst</span><span class="op" id="5248404">)</span><span class="op" id="5248405">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248408">for</span>&nbsp;<span class="op" id="5248412">!</span><span class="ident" id="5248413">instQueue</span><span class="op" id="5248422">.</span><span class="ident" id="5248423">empty</span><span class="op" id="5248428">(</span><span class="op" id="5248429">)</span>&nbsp;<span class="op" id="5248431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248435">pc</span>&nbsp;<span class="op" id="5248438">:=</span>&nbsp;<span class="ident" id="5248441">instQueue</span><span class="op" id="5248450">.</span><span class="ident" id="5248451">next</span><span class="op" id="5248455">(</span><span class="op" id="5248456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248460">inst</span>&nbsp;<span class="op" id="5248465">:=</span>&nbsp;<span class="ident" id="5248468">p</span><span class="op" id="5248469">.</span><span class="ident" id="5248470">Inst</span><span class="op" id="5248474">[</span><span class="ident" id="5248475">pc</span><span class="op" id="5248477">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248481">visitQueue</span><span class="op" id="5248491">.</span><span class="ident" id="5248492">clear</span><span class="op" id="5248497">(</span><span class="op" id="5248498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248502">if</span>&nbsp;<span class="op" id="5248505">!</span><span class="ident" id="5248506">check</span><span class="op" id="5248511">(</span><span class="builtintype" id="5248512">uint32</span><span class="op" id="5248518">(</span><span class="ident" id="5248519">pc</span><span class="op" id="5248521">)</span><span class="op" id="5248522">,</span>&nbsp;<span class="ident" id="5248524">m</span><span class="op" id="5248525">)</span>&nbsp;<span class="op" id="5248527">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248532">p</span>&nbsp;<span class="op" id="5248534">=</span>&nbsp;<span class="ident" id="5248536">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248550">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5248558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248562">switch</span>&nbsp;<span class="ident" id="5248569">inst</span><span class="op" id="5248573">.</span><span class="ident" id="5248574">Op</span>&nbsp;<span class="op" id="5248577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248581">case</span>&nbsp;<span class="ident" id="5248586">syntax</span><span class="op" id="5248592">.</span><span class="ident" id="5248593">InstAlt</span><span class="op" id="5248600">,</span>&nbsp;<span class="ident" id="5248602">syntax</span><span class="op" id="5248608">.</span><span class="ident" id="5248609">InstAltMatch</span><span class="op" id="5248621">:</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248626">instQueue</span><span class="op" id="5248635">.</span><span class="ident" id="5248636">insert</span><span class="op" id="5248642">(</span><span class="ident" id="5248643">inst</span><span class="op" id="5248647">.</span><span class="ident" id="5248648">Out</span><span class="op" id="5248651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248656">instQueue</span><span class="op" id="5248665">.</span><span class="ident" id="5248666">insert</span><span class="op" id="5248672">(</span><span class="ident" id="5248673">inst</span><span class="op" id="5248677">.</span><span class="ident" id="5248678">Arg</span><span class="op" id="5248681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248685">case</span>&nbsp;<span class="ident" id="5248690">syntax</span><span class="op" id="5248696">.</span><span class="ident" id="5248697">InstCapture</span><span class="op" id="5248708">,</span>&nbsp;<span class="ident" id="5248710">syntax</span><span class="op" id="5248716">.</span><span class="ident" id="5248717">InstEmptyWidth</span><span class="op" id="5248731">,</span>&nbsp;<span class="ident" id="5248733">syntax</span><span class="op" id="5248739">.</span><span class="ident" id="5248740">InstNop</span><span class="op" id="5248747">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248752">instQueue</span><span class="op" id="5248761">.</span><span class="ident" id="5248762">insert</span><span class="op" id="5248768">(</span><span class="ident" id="5248769">inst</span><span class="op" id="5248773">.</span><span class="ident" id="5248774">Out</span><span class="op" id="5248777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248781">case</span>&nbsp;<span class="ident" id="5248786">syntax</span><span class="op" id="5248792">.</span><span class="ident" id="5248793">InstMatch</span><span class="op" id="5248802">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248806">case</span>&nbsp;<span class="ident" id="5248811">syntax</span><span class="op" id="5248817">.</span><span class="ident" id="5248818">InstFail</span><span class="op" id="5248826">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248830">case</span>&nbsp;<span class="ident" id="5248835">syntax</span><span class="op" id="5248841">.</span><span class="ident" id="5248842">InstRune</span><span class="op" id="5248850">,</span>&nbsp;<span class="ident" id="5248852">syntax</span><span class="op" id="5248858">.</span><span class="ident" id="5248859">InstRune1</span><span class="op" id="5248868">,</span>&nbsp;<span class="ident" id="5248870">syntax</span><span class="op" id="5248876">.</span><span class="ident" id="5248877">InstRuneAny</span><span class="op" id="5248888">,</span>&nbsp;<span class="ident" id="5248890">syntax</span><span class="op" id="5248896">.</span><span class="ident" id="5248897">InstRuneAnyNotNL</span><span class="op" id="5248913">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248917">default</span><span class="op" id="5248924">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5248928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5248931">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248934">if</span>&nbsp;<span class="ident" id="5248937">p</span>&nbsp;<span class="op" id="5248939">!=</span>&nbsp;<span class="ident" id="5248942">notOnePass</span>&nbsp;<span class="op" id="5248953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248957">for</span>&nbsp;<span class="ident" id="5248961">i</span>&nbsp;<span class="op" id="5248963">:=</span>&nbsp;<span class="keyword" id="5248966">range</span>&nbsp;<span class="ident" id="5248972">p</span><span class="op" id="5248973">.</span><span class="ident" id="5248974">Inst</span>&nbsp;<span class="op" id="5248979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248984">p</span><span class="op" id="5248985">.</span><span class="ident" id="5248986">Inst</span><span class="op" id="5248990">[</span><span class="ident" id="5248991">i</span><span class="op" id="5248992">]</span><span class="op" id="5248993">.</span><span class="ident" id="5248994">Rune</span>&nbsp;<span class="op" id="5248999">=</span>&nbsp;<span class="ident" id="5249001">onePassRunes</span><span class="op" id="5249013">[</span><span class="ident" id="5249014">i</span><span class="op" id="5249015">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5249019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5249022">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249025">return</span>&nbsp;<span class="ident" id="5249032">p</span><br>
<span class="lineno"></span><span class="op" id="5249034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5249037">//&nbsp;walk&nbsp;visits&nbsp;each&nbsp;Inst&nbsp;in&nbsp;the&nbsp;prog&nbsp;once,&nbsp;and&nbsp;applies&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="5249105">//&nbsp;function(ip,&nbsp;next),&nbsp;in&nbsp;pre-order.</span><br>
<span class="lineno">495</span><span class="keyword" id="5249142">func</span>&nbsp;<span class="ident" id="5249147">walk</span><span class="op" id="5249151">(</span><span class="ident" id="5249152">prog</span>&nbsp;<span class="op" id="5249157">*</span><span class="ident" id="5249158">syntax</span><span class="op" id="5249164">.</span><span class="ident" id="5249165">Prog</span><span class="op" id="5249169">,</span>&nbsp;<span class="ident" id="5249171">funcs</span>&nbsp;<span class="op" id="5249177">...</span><span class="keyword" id="5249180">func</span><span class="op" id="5249184">(</span><span class="ident" id="5249185">ip</span><span class="op" id="5249187">,</span>&nbsp;<span class="ident" id="5249189">next</span>&nbsp;<span class="builtintype" id="5249194">uint32</span><span class="op" id="5249200">)</span><span class="op" id="5249201">)</span>&nbsp;<span class="op" id="5249203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249206">var</span>&nbsp;<span class="ident" id="5249210">walk1</span>&nbsp;<span class="keyword" id="5249216">func</span><span class="op" id="5249220">(</span><span class="builtintype" id="5249221">uint32</span><span class="op" id="5249227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249230">progQueue</span>&nbsp;<span class="op" id="5249240">:=</span>&nbsp;<span class="ident" id="5249243">newQueue</span><span class="op" id="5249251">(</span><span class="builtinfunc" id="5249252">len</span><span class="op" id="5249255">(</span><span class="ident" id="5249256">prog</span><span class="op" id="5249260">.</span><span class="ident" id="5249261">Inst</span><span class="op" id="5249265">)</span><span class="op" id="5249266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249269">walk1</span>&nbsp;<span class="op" id="5249275">=</span>&nbsp;<span class="keyword" id="5249277">func</span><span class="op" id="5249281">(</span><span class="ident" id="5249282">ip</span>&nbsp;<span class="builtintype" id="5249285">uint32</span><span class="op" id="5249291">)</span>&nbsp;<span class="op" id="5249293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249297">if</span>&nbsp;<span class="ident" id="5249300">progQueue</span><span class="op" id="5249309">.</span><span class="ident" id="5249310">contains</span><span class="op" id="5249318">(</span><span class="ident" id="5249319">ip</span><span class="op" id="5249321">)</span>&nbsp;<span class="op" id="5249323">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249328">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5249337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249341">progQueue</span><span class="op" id="5249350">.</span><span class="ident" id="5249351">insert</span><span class="op" id="5249357">(</span><span class="ident" id="5249358">ip</span><span class="op" id="5249360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249364">inst</span>&nbsp;<span class="op" id="5249369">:=</span>&nbsp;<span class="ident" id="5249372">prog</span><span class="op" id="5249376">.</span><span class="ident" id="5249377">Inst</span><span class="op" id="5249381">[</span><span class="ident" id="5249382">ip</span><span class="op" id="5249384">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249388">switch</span>&nbsp;<span class="ident" id="5249395">inst</span><span class="op" id="5249399">.</span><span class="ident" id="5249400">Op</span>&nbsp;<span class="op" id="5249403">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249407">case</span>&nbsp;<span class="ident" id="5249412">syntax</span><span class="op" id="5249418">.</span><span class="ident" id="5249419">InstAlt</span><span class="op" id="5249426">,</span>&nbsp;<span class="ident" id="5249428">syntax</span><span class="op" id="5249434">.</span><span class="ident" id="5249435">InstAltMatch</span><span class="op" id="5249447">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249452">for</span>&nbsp;<span class="ident" id="5249456">_</span><span class="op" id="5249457">,</span>&nbsp;<span class="ident" id="5249459">f</span>&nbsp;<span class="op" id="5249461">:=</span>&nbsp;<span class="keyword" id="5249464">range</span>&nbsp;<span class="ident" id="5249470">funcs</span>&nbsp;<span class="op" id="5249476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249482">f</span><span class="op" id="5249483">(</span><span class="ident" id="5249484">ip</span><span class="op" id="5249486">,</span>&nbsp;<span class="ident" id="5249488">inst</span><span class="op" id="5249492">.</span><span class="ident" id="5249493">Out</span><span class="op" id="5249496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249502">f</span><span class="op" id="5249503">(</span><span class="ident" id="5249504">ip</span><span class="op" id="5249506">,</span>&nbsp;<span class="ident" id="5249508">inst</span><span class="op" id="5249512">.</span><span class="ident" id="5249513">Arg</span><span class="op" id="5249516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5249521">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249526">walk1</span><span class="op" id="5249531">(</span><span class="ident" id="5249532">inst</span><span class="op" id="5249536">.</span><span class="ident" id="5249537">Out</span><span class="op" id="5249540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249545">walk1</span><span class="op" id="5249550">(</span><span class="ident" id="5249551">inst</span><span class="op" id="5249555">.</span><span class="ident" id="5249556">Arg</span><span class="op" id="5249559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249563">default</span><span class="op" id="5249570">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249575">for</span>&nbsp;<span class="ident" id="5249579">_</span><span class="op" id="5249580">,</span>&nbsp;<span class="ident" id="5249582">f</span>&nbsp;<span class="op" id="5249584">:=</span>&nbsp;<span class="keyword" id="5249587">range</span>&nbsp;<span class="ident" id="5249593">funcs</span>&nbsp;<span class="op" id="5249599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249605">f</span><span class="op" id="5249606">(</span><span class="ident" id="5249607">ip</span><span class="op" id="5249609">,</span>&nbsp;<span class="ident" id="5249611">inst</span><span class="op" id="5249615">.</span><span class="ident" id="5249616">Out</span><span class="op" id="5249619">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5249624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249629">walk1</span><span class="op" id="5249634">(</span><span class="ident" id="5249635">inst</span><span class="op" id="5249639">.</span><span class="ident" id="5249640">Out</span><span class="op" id="5249643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5249647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5249650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249653">walk1</span><span class="op" id="5249658">(</span><span class="builtintype" id="5249659">uint32</span><span class="op" id="5249665">(</span><span class="ident" id="5249666">prog</span><span class="op" id="5249670">.</span><span class="ident" id="5249671">Start</span><span class="op" id="5249676">)</span><span class="op" id="5249677">)</span><br>
<span class="lineno">520</span><span class="op" id="5249679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5249682">//&nbsp;find&nbsp;returns&nbsp;the&nbsp;Insts&nbsp;that&nbsp;match&nbsp;the&nbsp;argument&nbsp;predicate&nbsp;function</span><br>
<span class="lineno"></span><span class="keyword" id="5249751">func</span>&nbsp;<span class="ident" id="5249756">find</span><span class="op" id="5249760">(</span><span class="ident" id="5249761">prog</span>&nbsp;<span class="op" id="5249766">*</span><span class="ident" id="5249767">syntax</span><span class="op" id="5249773">.</span><span class="ident" id="5249774">Prog</span><span class="op" id="5249778">,</span>&nbsp;<span class="ident" id="5249780">f</span>&nbsp;<span class="keyword" id="5249782">func</span><span class="op" id="5249786">(</span><span class="op" id="5249787">*</span><span class="ident" id="5249788">syntax</span><span class="op" id="5249794">.</span><span class="ident" id="5249795">Prog</span><span class="op" id="5249799">,</span>&nbsp;<span class="builtintype" id="5249801">int</span><span class="op" id="5249804">)</span>&nbsp;<span class="builtintype" id="5249806">bool</span><span class="op" id="5249810">)</span>&nbsp;<span class="op" id="5249812">(</span><span class="ident" id="5249813">matches</span>&nbsp;<span class="op" id="5249821">[</span><span class="op" id="5249822">]</span><span class="builtintype" id="5249823">uint32</span><span class="op" id="5249829">)</span>&nbsp;<span class="op" id="5249831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249834">matches</span>&nbsp;<span class="op" id="5249842">=</span>&nbsp;<span class="op" id="5249844">[</span><span class="op" id="5249845">]</span><span class="builtintype" id="5249846">uint32</span><span class="op" id="5249852">{</span><span class="op" id="5249853">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249857">for</span>&nbsp;<span class="ident" id="5249861">ip</span>&nbsp;<span class="op" id="5249864">:=</span>&nbsp;<span class="keyword" id="5249867">range</span>&nbsp;<span class="ident" id="5249873">prog</span><span class="op" id="5249877">.</span><span class="ident" id="5249878">Inst</span>&nbsp;<span class="op" id="5249883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249887">if</span>&nbsp;<span class="ident" id="5249890">f</span><span class="op" id="5249891">(</span><span class="ident" id="5249892">prog</span><span class="op" id="5249896">,</span>&nbsp;<span class="ident" id="5249898">ip</span><span class="op" id="5249900">)</span>&nbsp;<span class="op" id="5249902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249907">matches</span>&nbsp;<span class="op" id="5249915">=</span>&nbsp;<span class="builtinfunc" id="5249917">append</span><span class="op" id="5249923">(</span><span class="ident" id="5249924">matches</span><span class="op" id="5249931">,</span>&nbsp;<span class="builtintype" id="5249933">uint32</span><span class="op" id="5249939">(</span><span class="ident" id="5249940">ip</span><span class="op" id="5249942">)</span><span class="op" id="5249943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5249947">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5249950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249953">return</span><br>
<span class="lineno"></span><span class="op" id="5249960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5249963">var</span>&nbsp;<span class="ident" id="5249967">notOnePass</span>&nbsp;<span class="op" id="5249978">*</span><span class="ident" id="5249979">onePassProg</span>&nbsp;<span class="op" id="5249991">=</span>&nbsp;<span class="ident" id="5249993">nil</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span><span class="comment" id="5249998">//&nbsp;compileOnePass&nbsp;returns&nbsp;a&nbsp;new&nbsp;*syntax.Prog&nbsp;suitable&nbsp;for&nbsp;onePass&nbsp;execution&nbsp;if&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span><span class="comment" id="5250095">//&nbsp;can&nbsp;be&nbsp;recharacterized&nbsp;as&nbsp;a&nbsp;one-pass&nbsp;regexp&nbsp;program,&nbsp;or&nbsp;syntax.notOnePass&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5250179">//&nbsp;Prog&nbsp;cannot&nbsp;be&nbsp;converted.&nbsp;For&nbsp;a&nbsp;one&nbsp;pass&nbsp;prog,&nbsp;the&nbsp;fundamental&nbsp;condition&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="5250265">//&nbsp;be&nbsp;true&nbsp;is:&nbsp;at&nbsp;any&nbsp;InstAlt,&nbsp;there&nbsp;must&nbsp;be&nbsp;no&nbsp;ambiguity&nbsp;about&nbsp;what&nbsp;branch&nbsp;to&nbsp;&nbsp;take.</span><br>
<span class="lineno">540</span><span class="keyword" id="5250351">func</span>&nbsp;<span class="ident" id="5250356">compileOnePass</span><span class="op" id="5250370">(</span><span class="ident" id="5250371">prog</span>&nbsp;<span class="op" id="5250376">*</span><span class="ident" id="5250377">syntax</span><span class="op" id="5250383">.</span><span class="ident" id="5250384">Prog</span><span class="op" id="5250388">)</span>&nbsp;<span class="op" id="5250390">(</span><span class="ident" id="5250391">p</span>&nbsp;<span class="op" id="5250393">*</span><span class="ident" id="5250394">onePassProg</span><span class="op" id="5250405">)</span>&nbsp;<span class="op" id="5250407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250410">if</span>&nbsp;<span class="ident" id="5250413">prog</span><span class="op" id="5250417">.</span><span class="ident" id="5250418">Start</span>&nbsp;<span class="op" id="5250424">==</span>&nbsp;<span class="num" id="5250427">0</span>&nbsp;<span class="op" id="5250429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250433">return</span>&nbsp;<span class="ident" id="5250440">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5250452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5250455">//&nbsp;onepass&nbsp;regexp&nbsp;is&nbsp;anchored</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250486">if</span>&nbsp;<span class="ident" id="5250489">prog</span><span class="op" id="5250493">.</span><span class="ident" id="5250494">Inst</span><span class="op" id="5250498">[</span><span class="ident" id="5250499">prog</span><span class="op" id="5250503">.</span><span class="ident" id="5250504">Start</span><span class="op" id="5250509">]</span><span class="op" id="5250510">.</span><span class="ident" id="5250511">Op</span>&nbsp;<span class="op" id="5250514">!=</span>&nbsp;<span class="ident" id="5250517">syntax</span><span class="op" id="5250523">.</span><span class="ident" id="5250524">InstEmptyWidth</span>&nbsp;<span class="op" id="5250539">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5250544">syntax</span><span class="op" id="5250550">.</span><span class="ident" id="5250551">EmptyOp</span><span class="op" id="5250558">(</span><span class="ident" id="5250559">prog</span><span class="op" id="5250563">.</span><span class="ident" id="5250564">Inst</span><span class="op" id="5250568">[</span><span class="ident" id="5250569">prog</span><span class="op" id="5250573">.</span><span class="ident" id="5250574">Start</span><span class="op" id="5250579">]</span><span class="op" id="5250580">.</span><span class="ident" id="5250581">Arg</span><span class="op" id="5250584">)</span><span class="op" id="5250585">&amp;</span><span class="ident" id="5250586">syntax</span><span class="op" id="5250592">.</span><span class="ident" id="5250593">EmptyBeginText</span>&nbsp;<span class="op" id="5250608">!=</span>&nbsp;<span class="ident" id="5250611">syntax</span><span class="op" id="5250617">.</span><span class="ident" id="5250618">EmptyBeginText</span>&nbsp;<span class="op" id="5250633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250637">return</span>&nbsp;<span class="ident" id="5250644">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5250656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5250659">//&nbsp;every&nbsp;instruction&nbsp;leading&nbsp;to&nbsp;InstMatch&nbsp;must&nbsp;be&nbsp;EmptyEndText</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250723">for</span>&nbsp;<span class="ident" id="5250727">_</span><span class="op" id="5250728">,</span>&nbsp;<span class="ident" id="5250730">inst</span>&nbsp;<span class="op" id="5250735">:=</span>&nbsp;<span class="keyword" id="5250738">range</span>&nbsp;<span class="ident" id="5250744">prog</span><span class="op" id="5250748">.</span><span class="ident" id="5250749">Inst</span>&nbsp;<span class="op" id="5250754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5250758">opOut</span>&nbsp;<span class="op" id="5250764">:=</span>&nbsp;<span class="ident" id="5250767">prog</span><span class="op" id="5250771">.</span><span class="ident" id="5250772">Inst</span><span class="op" id="5250776">[</span><span class="ident" id="5250777">inst</span><span class="op" id="5250781">.</span><span class="ident" id="5250782">Out</span><span class="op" id="5250785">]</span><span class="op" id="5250786">.</span><span class="ident" id="5250787">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250792">switch</span>&nbsp;<span class="ident" id="5250799">inst</span><span class="op" id="5250803">.</span><span class="ident" id="5250804">Op</span>&nbsp;<span class="op" id="5250807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250811">default</span><span class="op" id="5250818">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250823">if</span>&nbsp;<span class="ident" id="5250826">opOut</span>&nbsp;<span class="op" id="5250832">==</span>&nbsp;<span class="ident" id="5250835">syntax</span><span class="op" id="5250841">.</span><span class="ident" id="5250842">InstMatch</span>&nbsp;<span class="op" id="5250852">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250858">return</span>&nbsp;<span class="ident" id="5250865">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5250879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250883">case</span>&nbsp;<span class="ident" id="5250888">syntax</span><span class="op" id="5250894">.</span><span class="ident" id="5250895">InstAlt</span><span class="op" id="5250902">,</span>&nbsp;<span class="ident" id="5250904">syntax</span><span class="op" id="5250910">.</span><span class="ident" id="5250911">InstAltMatch</span><span class="op" id="5250923">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250928">if</span>&nbsp;<span class="ident" id="5250931">opOut</span>&nbsp;<span class="op" id="5250937">==</span>&nbsp;<span class="ident" id="5250940">syntax</span><span class="op" id="5250946">.</span><span class="ident" id="5250947">InstMatch</span>&nbsp;<span class="op" id="5250957">||</span>&nbsp;<span class="ident" id="5250960">prog</span><span class="op" id="5250964">.</span><span class="ident" id="5250965">Inst</span><span class="op" id="5250969">[</span><span class="ident" id="5250970">inst</span><span class="op" id="5250974">.</span><span class="ident" id="5250975">Arg</span><span class="op" id="5250978">]</span><span class="op" id="5250979">.</span><span class="ident" id="5250980">Op</span>&nbsp;<span class="op" id="5250983">==</span>&nbsp;<span class="ident" id="5250986">syntax</span><span class="op" id="5250992">.</span><span class="ident" id="5250993">InstMatch</span>&nbsp;<span class="op" id="5251003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251009">return</span>&nbsp;<span class="ident" id="5251016">notOnePass</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5251030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251034">case</span>&nbsp;<span class="ident" id="5251039">syntax</span><span class="op" id="5251045">.</span><span class="ident" id="5251046">InstEmptyWidth</span><span class="op" id="5251060">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251065">if</span>&nbsp;<span class="ident" id="5251068">opOut</span>&nbsp;<span class="op" id="5251074">==</span>&nbsp;<span class="ident" id="5251077">syntax</span><span class="op" id="5251083">.</span><span class="ident" id="5251084">InstMatch</span>&nbsp;<span class="op" id="5251094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251100">if</span>&nbsp;<span class="ident" id="5251103">syntax</span><span class="op" id="5251109">.</span><span class="ident" id="5251110">EmptyOp</span><span class="op" id="5251117">(</span><span class="ident" id="5251118">inst</span><span class="op" id="5251122">.</span><span class="ident" id="5251123">Arg</span><span class="op" id="5251126">)</span><span class="op" id="5251127">&amp;</span><span class="ident" id="5251128">syntax</span><span class="op" id="5251134">.</span><span class="ident" id="5251135">EmptyEndText</span>&nbsp;<span class="op" id="5251148">==</span>&nbsp;<span class="ident" id="5251151">syntax</span><span class="op" id="5251157">.</span><span class="ident" id="5251158">EmptyEndText</span>&nbsp;<span class="op" id="5251171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251178">continue</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5251191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251197">return</span>&nbsp;<span class="ident" id="5251204">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5251218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5251222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5251225">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5251228">//&nbsp;Creates&nbsp;a&nbsp;slightly&nbsp;optimized&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5251287">//&nbsp;that&nbsp;cleans&nbsp;up&nbsp;some&nbsp;Prog&nbsp;idioms&nbsp;that&nbsp;block&nbsp;valid&nbsp;onepass&nbsp;programs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5251357">p</span>&nbsp;<span class="op" id="5251359">=</span>&nbsp;<span class="ident" id="5251361">onePassCopy</span><span class="op" id="5251372">(</span><span class="ident" id="5251373">prog</span><span class="op" id="5251377">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5251381">//&nbsp;checkAmbiguity&nbsp;on&nbsp;InstAlts,&nbsp;build&nbsp;onepass&nbsp;Prog&nbsp;if&nbsp;possible</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5251444">p</span>&nbsp;<span class="op" id="5251446">=</span>&nbsp;<span class="ident" id="5251448">makeOnePass</span><span class="op" id="5251459">(</span><span class="ident" id="5251460">p</span><span class="op" id="5251461">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251465">if</span>&nbsp;<span class="ident" id="5251468">p</span>&nbsp;<span class="op" id="5251470">!=</span>&nbsp;<span class="ident" id="5251473">notOnePass</span>&nbsp;<span class="op" id="5251484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5251488">cleanupOnePass</span><span class="op" id="5251502">(</span><span class="ident" id="5251503">p</span><span class="op" id="5251504">,</span>&nbsp;<span class="ident" id="5251506">prog</span><span class="op" id="5251510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5251513">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251516">return</span>&nbsp;<span class="ident" id="5251523">p</span><br>
<span class="lineno"></span><span class="op" id="5251525">}</span>
</div>
</body>
</html>
