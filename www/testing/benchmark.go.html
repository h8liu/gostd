<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">testing</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;time&#34;</span><br>
<span class="lineno">15</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">matchBenchmarks</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">flag</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="string">&#34;test.bench&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;regular&nbsp;expression&nbsp;to&nbsp;select&nbsp;benchmarks&nbsp;to&nbsp;run&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">benchTime</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">flag</span><span class="op">.</span><span class="ident">Duration</span><span class="op">(</span><span class="string">&#34;test.benchtime&#34;</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">*</span><span class="ident">time</span><span class="op">.</span><span class="ident">Second</span><span class="op">,</span>&nbsp;<span class="string">&#34;approximate&nbsp;run&nbsp;time&nbsp;for&nbsp;each&nbsp;benchmark&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">benchmarkMemory</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">flag</span><span class="op">.</span><span class="ident">Bool</span><span class="op">(</span><span class="string">&#34;test.benchmem&#34;</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">,</span>&nbsp;<span class="string">&#34;print&nbsp;memory&nbsp;allocations&nbsp;for&nbsp;benchmarks&#34;</span><span class="op">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Global&nbsp;lock&nbsp;to&nbsp;ensure&nbsp;only&nbsp;one&nbsp;benchmark&nbsp;runs&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">benchmarkLock</span>&nbsp;<span class="ident">sync</span><span class="op">.</span><span class="ident">Mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Used&nbsp;for&nbsp;every&nbsp;benchmark&nbsp;for&nbsp;measuring&nbsp;memory.</span><br>
<span class="lineno">25</span><span class="keyword">var</span>&nbsp;<span class="ident">memStats</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">MemStats</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;An&nbsp;internal&nbsp;type&nbsp;but&nbsp;exported&nbsp;because&nbsp;it&nbsp;is&nbsp;cross-package;&nbsp;part&nbsp;of&nbsp;the&nbsp;implementation</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;of&nbsp;the&nbsp;&#34;go&nbsp;test&#34;&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">InternalBenchmark</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Name</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">F</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">B</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;B&nbsp;is&nbsp;a&nbsp;type&nbsp;passed&nbsp;to&nbsp;Benchmark&nbsp;functions&nbsp;to&nbsp;manage&nbsp;benchmark</span><br>
<span class="lineno">35</span><span class="comment">//&nbsp;timing&nbsp;and&nbsp;to&nbsp;specify&nbsp;the&nbsp;number&nbsp;of&nbsp;iterations&nbsp;to&nbsp;run.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">B</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">common</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">N</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">previousN</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;number&nbsp;of&nbsp;iterations&nbsp;in&nbsp;the&nbsp;previous&nbsp;run</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">previousDuration</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Duration</span>&nbsp;<span class="comment">//&nbsp;total&nbsp;duration&nbsp;of&nbsp;the&nbsp;previous&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">benchmark</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">InternalBenchmark</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bytes</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">timerOn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">showAllocResult</span>&nbsp;&nbsp;<span class="builtintype">bool</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">result</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">BenchmarkResult</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">parallelism</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">int</span>&nbsp;<span class="comment">//&nbsp;RunParallel&nbsp;creates&nbsp;parallelism*GOMAXPROCS&nbsp;goroutines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;initial&nbsp;states&nbsp;of&nbsp;memStats.Mallocs&nbsp;and&nbsp;memStats.TotalAlloc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">startAllocs</span>&nbsp;<span class="ident">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">startBytes</span>&nbsp;&nbsp;<span class="ident">uint64</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;net&nbsp;total&nbsp;of&nbsp;this&nbsp;test&nbsp;after&nbsp;being&nbsp;run.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">netAllocs</span>&nbsp;<span class="ident">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">netBytes</span>&nbsp;&nbsp;<span class="ident">uint64</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment">//&nbsp;StartTimer&nbsp;starts&nbsp;timing&nbsp;a&nbsp;test.&nbsp;&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;automatically</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;before&nbsp;a&nbsp;benchmark&nbsp;starts,&nbsp;but&nbsp;it&nbsp;can&nbsp;also&nbsp;used&nbsp;to&nbsp;resume&nbsp;timing&nbsp;after</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;a&nbsp;call&nbsp;to&nbsp;StopTimer.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">B</span><span class="op">)</span>&nbsp;<span class="ident">StartTimer</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">b</span><span class="op">.</span><span class="ident">timerOn</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runtime</span><span class="op">.</span><span class="ident">ReadMemStats</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">memStats</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">startAllocs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">memStats</span><span class="op">.</span><span class="ident">Mallocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">startBytes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">memStats</span><span class="op">.</span><span class="ident">TotalAlloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">start</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Now</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">timerOn</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;StopTimer&nbsp;stops&nbsp;timing&nbsp;a&nbsp;test.&nbsp;&nbsp;This&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;pause&nbsp;the&nbsp;timer</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;while&nbsp;performing&nbsp;complex&nbsp;initialization&nbsp;that&nbsp;you&nbsp;don&#39;t</span><br>
<span class="lineno">70</span><span class="comment">//&nbsp;want&nbsp;to&nbsp;measure.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">B</span><span class="op">)</span>&nbsp;<span class="ident">StopTimer</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">timerOn</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">duration</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Now</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Sub</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">start</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runtime</span><span class="op">.</span><span class="ident">ReadMemStats</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">memStats</span><span class="op">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">netAllocs</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">memStats</span><span class="op">.</span><span class="ident">Mallocs</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">startAllocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">netBytes</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">memStats</span><span class="op">.</span><span class="ident">TotalAlloc</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">startBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">timerOn</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ResetTimer&nbsp;zeros&nbsp;the&nbsp;elapsed&nbsp;benchmark&nbsp;time&nbsp;and&nbsp;memory&nbsp;allocation&nbsp;counters.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;does&nbsp;not&nbsp;affect&nbsp;whether&nbsp;the&nbsp;timer&nbsp;is&nbsp;running.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">B</span><span class="op">)</span>&nbsp;<span class="ident">ResetTimer</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">timerOn</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runtime</span><span class="op">.</span><span class="ident">ReadMemStats</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">memStats</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">startAllocs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">memStats</span><span class="op">.</span><span class="ident">Mallocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">startBytes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">memStats</span><span class="op">.</span><span class="ident">TotalAlloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">start</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Now</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">duration</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">netAllocs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">netBytes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment">//&nbsp;SetBytes&nbsp;records&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;processed&nbsp;in&nbsp;a&nbsp;single&nbsp;operation.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;this&nbsp;is&nbsp;called,&nbsp;the&nbsp;benchmark&nbsp;will&nbsp;report&nbsp;ns/op&nbsp;and&nbsp;MB/s.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">B</span><span class="op">)</span>&nbsp;<span class="ident">SetBytes</span><span class="op">(</span><span class="ident">n</span>&nbsp;<span class="ident">int64</span><span class="op">)</span>&nbsp;<span class="op">{</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">bytes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ReportAllocs&nbsp;enables&nbsp;malloc&nbsp;statistics&nbsp;for&nbsp;this&nbsp;benchmark.</span><br>
<span class="lineno">100</span><span class="comment">//&nbsp;It&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;setting&nbsp;-test.benchmem,&nbsp;but&nbsp;it&nbsp;only&nbsp;affects&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;benchmark&nbsp;function&nbsp;that&nbsp;calls&nbsp;ReportAllocs.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">B</span><span class="op">)</span>&nbsp;<span class="ident">ReportAllocs</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">showAllocResult</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">B</span><span class="op">)</span>&nbsp;<span class="ident">nsPerOp</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">int64</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">N</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">duration</span><span class="op">.</span><span class="ident">Nanoseconds</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;runN&nbsp;runs&nbsp;a&nbsp;single&nbsp;benchmark&nbsp;for&nbsp;the&nbsp;specified&nbsp;number&nbsp;of&nbsp;iterations.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">B</span><span class="op">)</span>&nbsp;<span class="ident">runN</span><span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">benchmarkLock</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">benchmarkLock</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Try&nbsp;to&nbsp;get&nbsp;a&nbsp;comparable&nbsp;environment&nbsp;for&nbsp;each&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;by&nbsp;clearing&nbsp;garbage&nbsp;from&nbsp;previous&nbsp;runs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runtime</span><span class="op">.</span><span class="ident">GC</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">N</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">parallelism</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">ResetTimer</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">StartTimer</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">benchmark</span><span class="op">.</span><span class="ident">F</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">StopTimer</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">previousN</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">previousDuration</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">duration</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword">func</span>&nbsp;<span class="ident">min</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">x</span><br>
<span class="lineno">135</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">max</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">y</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">x</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;roundDown10&nbsp;rounds&nbsp;a&nbsp;number&nbsp;down&nbsp;to&nbsp;the&nbsp;nearest&nbsp;power&nbsp;of&nbsp;10.</span><br>
<span class="lineno">145</span><span class="keyword">func</span>&nbsp;<span class="ident">roundDown10</span><span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">tens</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;tens&nbsp;=&nbsp;floor(log_10(n))</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">10</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">/</span>&nbsp;<span class="num">10</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tens</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;result&nbsp;=&nbsp;10^tens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">result</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">tens</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">result</span>&nbsp;<span class="op">*=</span>&nbsp;<span class="num">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">result</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment">//&nbsp;roundUp&nbsp;rounds&nbsp;x&nbsp;up&nbsp;to&nbsp;a&nbsp;number&nbsp;of&nbsp;the&nbsp;form&nbsp;[1eX,&nbsp;2eX,&nbsp;3eX,&nbsp;5eX].</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">roundUp</span><span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">base</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">roundDown10</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">base</span><span class="op">:</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="op">(</span><span class="num">2</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">base</span><span class="op">)</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="op">(</span><span class="num">3</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">base</span><span class="op">)</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">3</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">base</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="op">(</span><span class="num">5</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">base</span><span class="op">)</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">5</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">10</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">175</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;run&nbsp;times&nbsp;the&nbsp;benchmark&nbsp;function&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">B</span><span class="op">)</span>&nbsp;<span class="ident">run</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">BenchmarkResult</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">go</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">launch</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">&lt;-</span><span class="ident">b</span><span class="op">.</span><span class="ident">signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">result</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;launch&nbsp;launches&nbsp;the&nbsp;benchmark&nbsp;function.&nbsp;&nbsp;It&nbsp;gradually&nbsp;increases&nbsp;the&nbsp;number</span><br>
<span class="lineno">185</span><span class="comment">//&nbsp;of&nbsp;benchmark&nbsp;iterations&nbsp;until&nbsp;the&nbsp;benchmark&nbsp;runs&nbsp;for&nbsp;the&nbsp;requested&nbsp;benchtime.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;prints&nbsp;timing&nbsp;information&nbsp;in&nbsp;this&nbsp;form</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptesting.BenchmarkHello&nbsp;&nbsp;&nbsp;&nbsp100000&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp19&nbsp;ns/op</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;launch&nbsp;is&nbsp;run&nbsp;by&nbsp;the&nbsp;run&nbsp;function&nbsp;as&nbsp;a&nbsp;separate&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">B</span><span class="op">)</span>&nbsp;<span class="ident">launch</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Run&nbsp;the&nbsp;benchmark&nbsp;for&nbsp;a&nbsp;single&nbsp;iteration&nbsp;in&nbsp;case&nbsp;it&#39;s&nbsp;expensive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Signal&nbsp;that&nbsp;we&#39;re&nbsp;done&nbsp;whether&nbsp;we&nbsp;return&nbsp;normally</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;or&nbsp;by&nbsp;FailNow&#39;s&nbsp;runtime.Goexit.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">signal</span>&nbsp;<span class="op">&lt;-</span>&nbsp;<span class="ident">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">runN</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Run&nbsp;the&nbsp;benchmark&nbsp;for&nbsp;at&nbsp;least&nbsp;the&nbsp;specified&nbsp;amount&nbsp;of&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">*</span><span class="ident">benchTime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">!</span><span class="ident">b</span><span class="op">.</span><span class="ident">failed</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">duration</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">d</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">1e9</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">last</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Predict&nbsp;required&nbsp;iterations.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">nsPerOp</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1e9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">d</span><span class="op">.</span><span class="ident">Nanoseconds</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">nsPerOp</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Run&nbsp;more&nbsp;iterations&nbsp;than&nbsp;we&nbsp;think&nbsp;we&#39;ll&nbsp;need&nbsp;(1.2x).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Don&#39;t&nbsp;grow&nbsp;too&nbsp;fast&nbsp;in&nbsp;case&nbsp;we&nbsp;had&nbsp;timing&nbsp;errors&nbsp;previously.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Be&nbsp;sure&nbsp;to&nbsp;run&nbsp;at&nbsp;least&nbsp;one&nbsp;more&nbsp;than&nbsp;last&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">max</span><span class="op">(</span><span class="ident">min</span><span class="op">(</span><span class="ident">n</span><span class="op">+</span><span class="ident">n</span><span class="op">/</span><span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">100</span><span class="op">*</span><span class="ident">last</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">last</span><span class="op">+</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Round&nbsp;up&nbsp;to&nbsp;something&nbsp;easy&nbsp;to&nbsp;read.</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">roundUp</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">runN</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">result</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">BenchmarkResult</span><span class="op">{</span><span class="ident">b</span><span class="op">.</span><span class="ident">N</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">duration</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">bytes</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">netAllocs</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">netBytes</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;results&nbsp;of&nbsp;a&nbsp;benchmark&nbsp;run.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">BenchmarkResult</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">N</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;The&nbsp;number&nbsp;of&nbsp;iterations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">T</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Duration</span>&nbsp;<span class="comment">//&nbsp;The&nbsp;total&nbsp;time&nbsp;taken.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Bytes</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Bytes&nbsp;processed&nbsp;in&nbsp;one&nbsp;iteration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">MemAllocs</span>&nbsp;<span class="ident">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;The&nbsp;total&nbsp;number&nbsp;of&nbsp;memory&nbsp;allocations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">MemBytes</span>&nbsp;&nbsp;<span class="ident">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;The&nbsp;total&nbsp;number&nbsp;of&nbsp;bytes&nbsp;allocated.</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="ident">BenchmarkResult</span><span class="op">)</span>&nbsp;<span class="ident">NsPerOp</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">int64</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">N</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">T</span><span class="op">.</span><span class="ident">Nanoseconds</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span><br>
<span class="lineno">235</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="ident">BenchmarkResult</span><span class="op">)</span>&nbsp;<span class="ident">mbPerSec</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">float64</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Bytes</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">T</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">N</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">(</span><span class="builtintype">float64</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Bytes</span><span class="op">)</span>&nbsp;<span class="op">*</span>&nbsp;<span class="builtintype">float64</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="num">1e6</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">T</span><span class="op">.</span><span class="ident">Seconds</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="ident">BenchmarkResult</span><span class="op">)</span>&nbsp;<span class="ident">AllocsPerOp</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">int64</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">N</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">MemAllocs</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="ident">BenchmarkResult</span><span class="op">)</span>&nbsp;<span class="ident">AllocedBytesPerOp</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">int64</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">N</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">MemBytes</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="ident">BenchmarkResult</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mbs</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">mbPerSec</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mb</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="string">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">mbs</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mb</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;\t%7.2f&nbsp;MB/s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">mbs</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nsop</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">NsPerOp</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ns</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;%10d&nbsp;ns/op&#34;</span><span class="op">,</span>&nbsp;<span class="ident">nsop</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">N</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">nsop</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">100</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;format&nbsp;specifiers&nbsp;here&nbsp;make&nbsp;sure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;ones&nbsp;digits&nbsp;line&nbsp;up&nbsp;for&nbsp;all&nbsp;three&nbsp;possible&nbsp;formats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">nsop</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">10</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ns</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;%13.2f&nbsp;ns/op&#34;</span><span class="op">,</span>&nbsp;<span class="builtintype">float64</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">T</span><span class="op">.</span><span class="ident">Nanoseconds</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="builtintype">float64</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ns</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;%12.1f&nbsp;ns/op&#34;</span><span class="op">,</span>&nbsp;<span class="builtintype">float64</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">T</span><span class="op">.</span><span class="ident">Nanoseconds</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="builtintype">float64</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;%8d\t%s%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">N</span><span class="op">,</span>&nbsp;<span class="ident">ns</span><span class="op">,</span>&nbsp;<span class="ident">mb</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="ident">BenchmarkResult</span><span class="op">)</span>&nbsp;<span class="ident">MemString</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;%8d&nbsp;B/op\t%8d&nbsp;allocs/op&#34;</span><span class="op">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">AllocedBytesPerOp</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">AllocsPerOp</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;An&nbsp;internal&nbsp;function&nbsp;but&nbsp;exported&nbsp;because&nbsp;it&nbsp;is&nbsp;cross-package;&nbsp;part&nbsp;of&nbsp;the&nbsp;implementation</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;of&nbsp;the&nbsp;&#34;go&nbsp;test&#34;&nbsp;command.</span><br>
<span class="lineno">285</span><span class="keyword">func</span>&nbsp;<span class="ident">RunBenchmarks</span><span class="op">(</span><span class="ident">matchString</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">pat</span><span class="op">,</span>&nbsp;<span class="ident">str</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="builtintype">bool</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">benchmarks</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">InternalBenchmark</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;no&nbsp;flag&nbsp;was&nbsp;specified,&nbsp;don&#39;t&nbsp;run&nbsp;benchmarks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="op">*</span><span class="ident">matchBenchmarks</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">Benchmark</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">benchmarks</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">matched</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">matchString</span><span class="op">(</span><span class="op">*</span><span class="ident">matchBenchmarks</span><span class="op">,</span>&nbsp;<span class="ident">Benchmark</span><span class="op">.</span><span class="ident">Name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fmt</span><span class="op">.</span><span class="ident">Fprintf</span><span class="op">(</span><span class="ident">os</span><span class="op">.</span><span class="ident">Stderr</span><span class="op">,</span>&nbsp;<span class="string">&#34;testing:&nbsp;invalid&nbsp;regexp&nbsp;for&nbsp;-test.bench:&nbsp;%s\n&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">os</span><span class="op">.</span><span class="ident">Exit</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">matched</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">procs</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">cpuList</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOMAXPROCS</span><span class="op">(</span><span class="ident">procs</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">B</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">common</span><span class="op">:</span>&nbsp;<span class="ident">common</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">signal</span><span class="op">:</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">chan</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">benchmark</span><span class="op">:</span>&nbsp;<span class="ident">Benchmark</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">benchName</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Benchmark</span><span class="op">.</span><span class="ident">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">procs</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">benchName</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;%s-%d&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Benchmark</span><span class="op">.</span><span class="ident">Name</span><span class="op">,</span>&nbsp;<span class="ident">procs</span><span class="op">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fmt</span><span class="op">.</span><span class="ident">Printf</span><span class="op">(</span><span class="string">&#34;%s\t&#34;</span><span class="op">,</span>&nbsp;<span class="ident">benchName</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">run</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">failed</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;output&nbsp;could&nbsp;be&nbsp;very&nbsp;long&nbsp;here,&nbsp;but&nbsp;probably&nbsp;isn&#39;t.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;print&nbsp;it&nbsp;all,&nbsp;regardless,&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;trim&nbsp;the&nbsp;reason</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;benchmark&nbsp;failed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fmt</span><span class="op">.</span><span class="ident">Printf</span><span class="op">(</span><span class="string">&#34;---&nbsp;FAIL:&nbsp;%s\n%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">benchName</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">output</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">results</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">*</span><span class="ident">benchmarkMemory</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">showAllocResult</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">results</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="string">&#34;\t&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">MemString</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fmt</span><span class="op">.</span><span class="ident">Println</span><span class="op">(</span><span class="ident">results</span><span class="op">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Unlike&nbsp;with&nbsp;tests,&nbsp;we&nbsp;ignore&nbsp;the&nbsp;-chatty&nbsp;flag&nbsp;and&nbsp;always&nbsp;print&nbsp;output&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;benchmarks&nbsp;since&nbsp;the&nbsp;output&nbsp;generation&nbsp;time&nbsp;will&nbsp;skew&nbsp;the&nbsp;results.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">output</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">trimOutput</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fmt</span><span class="op">.</span><span class="ident">Printf</span><span class="op">(</span><span class="string">&#34;---&nbsp;BENCH:&nbsp;%s\n%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">benchName</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">output</span><span class="op">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">p</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOMAXPROCS</span><span class="op">(</span><span class="op">-</span><span class="num">1</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">p</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">procs</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fmt</span><span class="op">.</span><span class="ident">Fprintf</span><span class="op">(</span><span class="ident">os</span><span class="op">.</span><span class="ident">Stderr</span><span class="op">,</span>&nbsp;<span class="string">&#34;testing:&nbsp;%s&nbsp;left&nbsp;GOMAXPROCS&nbsp;set&nbsp;to&nbsp;%d\n&#34;</span><span class="op">,</span>&nbsp;<span class="ident">benchName</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;trimOutput&nbsp;shortens&nbsp;the&nbsp;output&nbsp;from&nbsp;a&nbsp;benchmark,&nbsp;which&nbsp;can&nbsp;be&nbsp;very&nbsp;long.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">B</span><span class="op">)</span>&nbsp;<span class="ident">trimOutput</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;output&nbsp;is&nbsp;likely&nbsp;to&nbsp;appear&nbsp;multiple&nbsp;times&nbsp;because&nbsp;the&nbsp;benchmark</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;is&nbsp;run&nbsp;multiple&nbsp;times,&nbsp;but&nbsp;at&nbsp;least&nbsp;it&nbsp;will&nbsp;be&nbsp;seen.&nbsp;This&nbsp;is&nbsp;not&nbsp;a&nbsp;big&nbsp;deal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;because&nbsp;benchmarks&nbsp;rarely&nbsp;print,&nbsp;but&nbsp;just&nbsp;in&nbsp;case,&nbsp;we&nbsp;trim&nbsp;it&nbsp;if&nbsp;it&#39;s&nbsp;too&nbsp;long.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="ident">maxNewlines</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">nlCount</span><span class="op">,</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">output</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">j</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">output</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#39;\n&#39;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nlCount</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">nlCount</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">maxNewlines</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">output</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">output</span><span class="op">[</span><span class="op">:</span><span class="ident">j</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="string">&#34;\n\t...&nbsp;[output&nbsp;truncated]\n&#34;</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment">//&nbsp;A&nbsp;PB&nbsp;is&nbsp;used&nbsp;by&nbsp;RunParallel&nbsp;for&nbsp;running&nbsp;parallel&nbsp;benchmarks.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">PB</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">globalN</span>&nbsp;<span class="op">*</span><span class="ident">uint64</span>&nbsp;<span class="comment">//&nbsp;shared&nbsp;between&nbsp;all&nbsp;worker&nbsp;goroutines&nbsp;iteration&nbsp;counter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">grain</span>&nbsp;&nbsp;&nbsp;<span class="ident">uint64</span>&nbsp;&nbsp;<span class="comment">//&nbsp;acquire&nbsp;that&nbsp;many&nbsp;iterations&nbsp;from&nbsp;globalN&nbsp;at&nbsp;once</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cache</span>&nbsp;&nbsp;&nbsp;<span class="ident">uint64</span>&nbsp;&nbsp;<span class="comment">//&nbsp;local&nbsp;cache&nbsp;of&nbsp;acquired&nbsp;iterations</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bN</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">uint64</span>&nbsp;&nbsp;<span class="comment">//&nbsp;total&nbsp;number&nbsp;of&nbsp;iterations&nbsp;to&nbsp;execute&nbsp;(b.N)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Next&nbsp;reports&nbsp;whether&nbsp;there&nbsp;are&nbsp;more&nbsp;iterations&nbsp;to&nbsp;execute.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">pb</span>&nbsp;<span class="op">*</span><span class="ident">PB</span><span class="op">)</span>&nbsp;<span class="ident">Next</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">pb</span><span class="op">.</span><span class="ident">cache</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">atomic</span><span class="op">.</span><span class="ident">AddUint64</span><span class="op">(</span><span class="ident">pb</span><span class="op">.</span><span class="ident">globalN</span><span class="op">,</span>&nbsp;<span class="ident">pb</span><span class="op">.</span><span class="ident">grain</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">pb</span><span class="op">.</span><span class="ident">bN</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pb</span><span class="op">.</span><span class="ident">cache</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">pb</span><span class="op">.</span><span class="ident">grain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">pb</span><span class="op">.</span><span class="ident">bN</span><span class="op">+</span><span class="ident">pb</span><span class="op">.</span><span class="ident">grain</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pb</span><span class="op">.</span><span class="ident">cache</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">pb</span><span class="op">.</span><span class="ident">bN</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">pb</span><span class="op">.</span><span class="ident">grain</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pb</span><span class="op">.</span><span class="ident">cache</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;RunParallel&nbsp;runs&nbsp;a&nbsp;benchmark&nbsp;in&nbsp;parallel.</span><br>
<span class="lineno">380</span><span class="comment">//&nbsp;It&nbsp;creates&nbsp;multiple&nbsp;goroutines&nbsp;and&nbsp;distributes&nbsp;b.N&nbsp;iterations&nbsp;among&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;number&nbsp;of&nbsp;goroutines&nbsp;defaults&nbsp;to&nbsp;GOMAXPROCS.&nbsp;To&nbsp;increase&nbsp;parallelism&nbsp;for</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;non-CPU-bound&nbsp;benchmarks,&nbsp;call&nbsp;SetParallelism&nbsp;before&nbsp;RunParallel.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;RunParallel&nbsp;is&nbsp;usually&nbsp;used&nbsp;with&nbsp;the&nbsp;go&nbsp;test&nbsp;-cpu&nbsp;flag.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">385</span><span class="comment">//&nbsp;The&nbsp;body&nbsp;function&nbsp;will&nbsp;be&nbsp;run&nbsp;in&nbsp;each&nbsp;goroutine.&nbsp;It&nbsp;should&nbsp;set&nbsp;up&nbsp;any</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;goroutine-local&nbsp;state&nbsp;and&nbsp;then&nbsp;iterate&nbsp;until&nbsp;pb.Next&nbsp;returns&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;should&nbsp;not&nbsp;use&nbsp;the&nbsp;StartTimer,&nbsp;StopTimer,&nbsp;or&nbsp;ResetTimer&nbsp;functions,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;because&nbsp;they&nbsp;have&nbsp;global&nbsp;effect.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">B</span><span class="op">)</span>&nbsp;<span class="ident">RunParallel</span><span class="op">(</span><span class="ident">body</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="op">*</span><span class="ident">PB</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Calculate&nbsp;grain&nbsp;size&nbsp;as&nbsp;number&nbsp;of&nbsp;iterations&nbsp;that&nbsp;take&nbsp;~100s.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;100s&nbsp;is&nbsp;enough&nbsp;to&nbsp;amortize&nbsp;the&nbsp;overhead&nbsp;and&nbsp;provide&nbsp;sufficient</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;dynamic&nbsp;load&nbsp;balancing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">grain</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">previousN</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">previousDuration</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">grain</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1e5</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">previousN</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">previousDuration</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">grain</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">grain</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;expect&nbsp;the&nbsp;inner&nbsp;loop&nbsp;and&nbsp;function&nbsp;call&nbsp;to&nbsp;take&nbsp;at&nbsp;least&nbsp;10ns,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;so&nbsp;do&nbsp;not&nbsp;do&nbsp;more&nbsp;than&nbsp;100s/10ns=1e4&nbsp;iterations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">grain</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">1e4</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">grain</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1e4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">numProcs</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">parallelism</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOMAXPROCS</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">wg</span>&nbsp;<span class="ident">sync</span><span class="op">.</span><span class="ident">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wg</span><span class="op">.</span><span class="ident">Add</span><span class="op">(</span><span class="ident">numProcs</span><span class="op">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">p</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">p</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">numProcs</span><span class="op">;</span>&nbsp;<span class="ident">p</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">go</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">wg</span><span class="op">.</span><span class="ident">Done</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pb</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">PB</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">globalN</span><span class="op">:</span>&nbsp;<span class="op">&amp;</span><span class="ident">n</span><span class="op">,</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">grain</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;<span class="ident">grain</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bN</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">body</span><span class="op">(</span><span class="ident">pb</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wg</span><span class="op">.</span><span class="ident">Wait</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">!</span><span class="ident">b</span><span class="op">.</span><span class="ident">Failed</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">Fatal</span><span class="op">(</span><span class="string">&#34;RunParallel:&nbsp;body&nbsp;exited&nbsp;without&nbsp;pb.Next()&nbsp;==&nbsp;false&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">425</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;SetParallelism&nbsp;sets&nbsp;the&nbsp;number&nbsp;of&nbsp;goroutines&nbsp;used&nbsp;by&nbsp;RunParallel&nbsp;to&nbsp;p*GOMAXPROCS.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;There&nbsp;is&nbsp;usually&nbsp;no&nbsp;need&nbsp;to&nbsp;call&nbsp;SetParallelism&nbsp;for&nbsp;CPU-bound&nbsp;benchmarks.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;p&nbsp;is&nbsp;less&nbsp;than&nbsp;1,&nbsp;this&nbsp;call&nbsp;will&nbsp;have&nbsp;no&nbsp;effect.</span><br>
<span class="lineno">430</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">B</span><span class="op">)</span>&nbsp;<span class="ident">SetParallelism</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">p</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">parallelism</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">435</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Benchmark&nbsp;benchmarks&nbsp;a&nbsp;single&nbsp;function.&nbsp;Useful&nbsp;for&nbsp;creating</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;custom&nbsp;benchmarks&nbsp;that&nbsp;do&nbsp;not&nbsp;use&nbsp;the&nbsp;&#34;go&nbsp;test&#34;&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">Benchmark</span><span class="op">(</span><span class="ident">f</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">B</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="ident">BenchmarkResult</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">B</span><span class="op">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">common</span><span class="op">:</span>&nbsp;<span class="ident">common</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">signal</span><span class="op">:</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">chan</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">benchmark</span><span class="op">:</span>&nbsp;<span class="ident">InternalBenchmark</span><span class="op">{</span><span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">f</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">run</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
