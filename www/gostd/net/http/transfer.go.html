<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html" class="current">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3621679">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3621734">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3621788">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3621839">package</span>&nbsp;<span class="ident" id="3621847">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3621853">import</span>&nbsp;<span class="op" id="3621860">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3621863">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3621872">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3621881">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3621891">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3621898">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3621904">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3621917">&#34;net/http/internal&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3621938">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3621955">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3621963">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3621974">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3621985">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3621992">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3621995">//&nbsp;ErrLineTooLong&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;request&nbsp;or&nbsp;response&nbsp;bodies</span><br>
<span class="lineno"></span><span class="comment" id="3622065">//&nbsp;with&nbsp;malformed&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="keyword" id="3622101">var</span>&nbsp;<span class="ident" id="3622105">ErrLineTooLong</span>&nbsp;<span class="op" id="3622120">=</span>&nbsp;<span class="ident" id="3622122">internal</span><span class="op" id="3622130">.</span><span class="ident" id="3622131">ErrLineTooLong</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="3622147">type</span>&nbsp;<span class="ident" id="3622152">errorReader</span>&nbsp;<span class="keyword" id="3622164">struct</span>&nbsp;<span class="op" id="3622171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622174">err</span>&nbsp;<span class="builtintype" id="3622178">error</span><br>
<span class="lineno"></span><span class="op" id="3622184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3622187">func</span>&nbsp;<span class="op" id="3622192">(</span><span class="ident" id="3622193">r</span>&nbsp;<span class="op" id="3622195">*</span><span class="ident" id="3622196">errorReader</span><span class="op" id="3622207">)</span>&nbsp;<span class="ident" id="3622209">Read</span><span class="op" id="3622213">(</span><span class="ident" id="3622214">p</span>&nbsp;<span class="op" id="3622216">[</span><span class="op" id="3622217">]</span><span class="builtintype" id="3622218">byte</span><span class="op" id="3622222">)</span>&nbsp;<span class="op" id="3622224">(</span><span class="ident" id="3622225">n</span>&nbsp;<span class="builtintype" id="3622227">int</span><span class="op" id="3622230">,</span>&nbsp;<span class="ident" id="3622232">err</span>&nbsp;<span class="builtintype" id="3622236">error</span><span class="op" id="3622241">)</span>&nbsp;<span class="op" id="3622243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3622246">return</span>&nbsp;<span class="num" id="3622253">0</span><span class="op" id="3622254">,</span>&nbsp;<span class="ident" id="3622256">r</span><span class="op" id="3622257">.</span><span class="ident" id="3622258">err</span><br>
<span class="lineno"></span><span class="op" id="3622262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3622265">//&nbsp;transferWriter&nbsp;inspects&nbsp;the&nbsp;fields&nbsp;of&nbsp;a&nbsp;user-supplied&nbsp;Request&nbsp;or&nbsp;Response,</span><br>
<span class="lineno">35</span><span class="comment" id="3622343">//&nbsp;sanitizes&nbsp;them&nbsp;without&nbsp;changing&nbsp;the&nbsp;user&nbsp;object&nbsp;and&nbsp;provides&nbsp;methods&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3622419">//&nbsp;writing&nbsp;the&nbsp;respective&nbsp;header,&nbsp;body&nbsp;and&nbsp;trailer&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="3622486">type</span>&nbsp;<span class="ident" id="3622491">transferWriter</span>&nbsp;<span class="keyword" id="3622506">struct</span>&nbsp;<span class="op" id="3622513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622516">Method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3622533">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622541">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622558">io</span><span class="op" id="3622560">.</span><span class="ident" id="3622561">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622569">BodyCloser</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622586">io</span><span class="op" id="3622588">.</span><span class="ident" id="3622589">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622597">ResponseToHEAD</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3622614">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622620">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3622637">int64</span>&nbsp;<span class="comment" id="3622643">//&nbsp;-1&nbsp;means&nbsp;unknown,&nbsp;0&nbsp;means&nbsp;exactly&nbsp;none</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622686">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3622703">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622709">TransferEncoding</span>&nbsp;<span class="op" id="3622726">[</span><span class="op" id="3622727">]</span><span class="builtintype" id="3622728">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622736">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622753">Header</span><br>
<span class="lineno"></span><span class="op" id="3622760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3622763">func</span>&nbsp;<span class="ident" id="3622768">newTransferWriter</span><span class="op" id="3622785">(</span><span class="ident" id="3622786">r</span>&nbsp;<span class="keyword" id="3622788">interface</span><span class="op" id="3622797">{</span><span class="op" id="3622798">}</span><span class="op" id="3622799">)</span>&nbsp;<span class="op" id="3622801">(</span><span class="ident" id="3622802">t</span>&nbsp;<span class="op" id="3622804">*</span><span class="ident" id="3622805">transferWriter</span><span class="op" id="3622819">,</span>&nbsp;<span class="ident" id="3622821">err</span>&nbsp;<span class="builtintype" id="3622825">error</span><span class="op" id="3622830">)</span>&nbsp;<span class="op" id="3622832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622835">t</span>&nbsp;<span class="op" id="3622837">=</span>&nbsp;<span class="op" id="3622839">&amp;</span><span class="ident" id="3622840">transferWriter</span><span class="op" id="3622854">{</span><span class="op" id="3622855">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3622859">//&nbsp;Extract&nbsp;relevant&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622887">atLeastHTTP11</span>&nbsp;<span class="op" id="3622901">:=</span>&nbsp;<span class="builtintype" id="3622904">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3622911">switch</span>&nbsp;<span class="ident" id="3622918">rr</span>&nbsp;<span class="op" id="3622921">:=</span>&nbsp;<span class="ident" id="3622924">r</span><span class="op" id="3622925">.</span><span class="op" id="3622926">(</span><span class="keyword" id="3622927">type</span><span class="op" id="3622931">)</span>&nbsp;<span class="op" id="3622933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3622936">case</span>&nbsp;<span class="op" id="3622941">*</span><span class="ident" id="3622942">Request</span><span class="op" id="3622949">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3622953">if</span>&nbsp;<span class="ident" id="3622956">rr</span><span class="op" id="3622958">.</span><span class="ident" id="3622959">ContentLength</span>&nbsp;<span class="op" id="3622973">!=</span>&nbsp;<span class="num" id="3622976">0</span>&nbsp;<span class="op" id="3622978">&amp;&amp;</span>&nbsp;<span class="ident" id="3622981">rr</span><span class="op" id="3622983">.</span><span class="ident" id="3622984">Body</span>&nbsp;<span class="op" id="3622989">==</span>&nbsp;<span class="builtintype" id="3622992">nil</span>&nbsp;<span class="op" id="3622996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3623001">return</span>&nbsp;<span class="builtintype" id="3623008">nil</span><span class="op" id="3623011">,</span>&nbsp;<span class="ident" id="3623013">fmt</span><span class="op" id="3623016">.</span><span class="ident" id="3623017">Errorf</span><span class="op" id="3623023">(</span><span class="string" id="3623024">&#34;http:&nbsp;Request.ContentLength=%d&nbsp;with&nbsp;nil&nbsp;Body&#34;</span><span class="op" id="3623070">,</span>&nbsp;<span class="ident" id="3623072">rr</span><span class="op" id="3623074">.</span><span class="ident" id="3623075">ContentLength</span><span class="op" id="3623088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3623092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623096">t</span><span class="op" id="3623097">.</span><span class="ident" id="3623098">Method</span>&nbsp;<span class="op" id="3623105">=</span>&nbsp;<span class="ident" id="3623107">rr</span><span class="op" id="3623109">.</span><span class="ident" id="3623110">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623119">t</span><span class="op" id="3623120">.</span><span class="ident" id="3623121">Body</span>&nbsp;<span class="op" id="3623126">=</span>&nbsp;<span class="ident" id="3623128">rr</span><span class="op" id="3623130">.</span><span class="ident" id="3623131">Body</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623138">t</span><span class="op" id="3623139">.</span><span class="ident" id="3623140">BodyCloser</span>&nbsp;<span class="op" id="3623151">=</span>&nbsp;<span class="ident" id="3623153">rr</span><span class="op" id="3623155">.</span><span class="ident" id="3623156">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623163">t</span><span class="op" id="3623164">.</span><span class="ident" id="3623165">ContentLength</span>&nbsp;<span class="op" id="3623179">=</span>&nbsp;<span class="ident" id="3623181">rr</span><span class="op" id="3623183">.</span><span class="ident" id="3623184">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623200">t</span><span class="op" id="3623201">.</span><span class="ident" id="3623202">Close</span>&nbsp;<span class="op" id="3623208">=</span>&nbsp;<span class="ident" id="3623210">rr</span><span class="op" id="3623212">.</span><span class="ident" id="3623213">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623221">t</span><span class="op" id="3623222">.</span><span class="ident" id="3623223">TransferEncoding</span>&nbsp;<span class="op" id="3623240">=</span>&nbsp;<span class="ident" id="3623242">rr</span><span class="op" id="3623244">.</span><span class="ident" id="3623245">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623264">t</span><span class="op" id="3623265">.</span><span class="ident" id="3623266">Trailer</span>&nbsp;<span class="op" id="3623274">=</span>&nbsp;<span class="ident" id="3623276">rr</span><span class="op" id="3623278">.</span><span class="ident" id="3623279">Trailer</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623289">atLeastHTTP11</span>&nbsp;<span class="op" id="3623303">=</span>&nbsp;<span class="ident" id="3623305">rr</span><span class="op" id="3623307">.</span><span class="ident" id="3623308">ProtoAtLeast</span><span class="op" id="3623320">(</span><span class="num" id="3623321">1</span><span class="op" id="3623322">,</span>&nbsp;<span class="num" id="3623324">1</span><span class="op" id="3623325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3623329">if</span>&nbsp;<span class="ident" id="3623332">t</span><span class="op" id="3623333">.</span><span class="ident" id="3623334">Body</span>&nbsp;<span class="op" id="3623339">!=</span>&nbsp;<span class="builtintype" id="3623342">nil</span>&nbsp;<span class="op" id="3623346">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3623349">len</span><span class="op" id="3623352">(</span><span class="ident" id="3623353">t</span><span class="op" id="3623354">.</span><span class="ident" id="3623355">TransferEncoding</span><span class="op" id="3623371">)</span>&nbsp;<span class="op" id="3623373">==</span>&nbsp;<span class="num" id="3623376">0</span>&nbsp;<span class="op" id="3623378">&amp;&amp;</span>&nbsp;<span class="ident" id="3623381">atLeastHTTP11</span>&nbsp;<span class="op" id="3623395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3623400">if</span>&nbsp;<span class="ident" id="3623403">t</span><span class="op" id="3623404">.</span><span class="ident" id="3623405">ContentLength</span>&nbsp;<span class="op" id="3623419">==</span>&nbsp;<span class="num" id="3623422">0</span>&nbsp;<span class="op" id="3623424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623430">//&nbsp;Test&nbsp;to&nbsp;see&nbsp;if&nbsp;it&#39;s&nbsp;actually&nbsp;zero&nbsp;or&nbsp;just&nbsp;unset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3623486">var</span>&nbsp;<span class="ident" id="3623490">buf</span>&nbsp;<span class="op" id="3623494">[</span><span class="num" id="3623495">1</span><span class="op" id="3623496">]</span><span class="builtintype" id="3623497">byte</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623506">n</span><span class="op" id="3623507">,</span>&nbsp;<span class="ident" id="3623509">rerr</span>&nbsp;<span class="op" id="3623514">:=</span>&nbsp;<span class="ident" id="3623517">io</span><span class="op" id="3623519">.</span><span class="ident" id="3623520">ReadFull</span><span class="op" id="3623528">(</span><span class="ident" id="3623529">t</span><span class="op" id="3623530">.</span><span class="ident" id="3623531">Body</span><span class="op" id="3623535">,</span>&nbsp;<span class="ident" id="3623537">buf</span><span class="op" id="3623540">[</span><span class="op" id="3623541">:</span><span class="op" id="3623542">]</span><span class="op" id="3623543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3623549">if</span>&nbsp;<span class="ident" id="3623552">rerr</span>&nbsp;<span class="op" id="3623557">!=</span>&nbsp;<span class="builtintype" id="3623560">nil</span>&nbsp;<span class="op" id="3623564">&amp;&amp;</span>&nbsp;<span class="ident" id="3623567">rerr</span>&nbsp;<span class="op" id="3623572">!=</span>&nbsp;<span class="ident" id="3623575">io</span><span class="op" id="3623577">.</span><span class="ident" id="3623578">EOF</span>&nbsp;<span class="op" id="3623582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623589">t</span><span class="op" id="3623590">.</span><span class="ident" id="3623591">ContentLength</span>&nbsp;<span class="op" id="3623605">=</span>&nbsp;<span class="op" id="3623607">-</span><span class="num" id="3623608">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623615">t</span><span class="op" id="3623616">.</span><span class="ident" id="3623617">Body</span>&nbsp;<span class="op" id="3623622">=</span>&nbsp;<span class="op" id="3623624">&amp;</span><span class="ident" id="3623625">errorReader</span><span class="op" id="3623636">{</span><span class="ident" id="3623637">rerr</span><span class="op" id="3623641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3623647">}</span>&nbsp;<span class="keyword" id="3623649">else</span>&nbsp;<span class="keyword" id="3623654">if</span>&nbsp;<span class="ident" id="3623657">n</span>&nbsp;<span class="op" id="3623659">==</span>&nbsp;<span class="num" id="3623662">1</span>&nbsp;<span class="op" id="3623664">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623671">//&nbsp;Oh,&nbsp;guess&nbsp;there&nbsp;is&nbsp;data&nbsp;in&nbsp;this&nbsp;Body&nbsp;Reader&nbsp;after&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623734">//&nbsp;The&nbsp;ContentLength&nbsp;field&nbsp;just&nbsp;wasn&#39;t&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623783">//&nbsp;Stich&nbsp;the&nbsp;Body&nbsp;back&nbsp;together&nbsp;again,&nbsp;re-attaching&nbsp;our</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623844">//&nbsp;consumed&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623867">t</span><span class="op" id="3623868">.</span><span class="ident" id="3623869">ContentLength</span>&nbsp;<span class="op" id="3623883">=</span>&nbsp;<span class="op" id="3623885">-</span><span class="num" id="3623886">1</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623893">t</span><span class="op" id="3623894">.</span><span class="ident" id="3623895">Body</span>&nbsp;<span class="op" id="3623900">=</span>&nbsp;<span class="ident" id="3623902">io</span><span class="op" id="3623904">.</span><span class="ident" id="3623905">MultiReader</span><span class="op" id="3623916">(</span><span class="ident" id="3623917">bytes</span><span class="op" id="3623922">.</span><span class="ident" id="3623923">NewReader</span><span class="op" id="3623932">(</span><span class="ident" id="3623933">buf</span><span class="op" id="3623936">[</span><span class="op" id="3623937">:</span><span class="op" id="3623938">]</span><span class="op" id="3623939">)</span><span class="op" id="3623940">,</span>&nbsp;<span class="ident" id="3623942">t</span><span class="op" id="3623943">.</span><span class="ident" id="3623944">Body</span><span class="op" id="3623948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3623954">}</span>&nbsp;<span class="keyword" id="3623956">else</span>&nbsp;<span class="op" id="3623961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623968">//&nbsp;Body&nbsp;is&nbsp;actually&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624000">t</span><span class="op" id="3624001">.</span><span class="ident" id="3624002">Body</span>&nbsp;<span class="op" id="3624007">=</span>&nbsp;<span class="builtintype" id="3624009">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624018">t</span><span class="op" id="3624019">.</span><span class="ident" id="3624020">BodyCloser</span>&nbsp;<span class="op" id="3624031">=</span>&nbsp;<span class="builtintype" id="3624033">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3624041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3624046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624051">if</span>&nbsp;<span class="ident" id="3624054">t</span><span class="op" id="3624055">.</span><span class="ident" id="3624056">ContentLength</span>&nbsp;<span class="op" id="3624070">&lt;</span>&nbsp;<span class="num" id="3624072">0</span>&nbsp;<span class="op" id="3624074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624080">t</span><span class="op" id="3624081">.</span><span class="ident" id="3624082">TransferEncoding</span>&nbsp;<span class="op" id="3624099">=</span>&nbsp;<span class="op" id="3624101">[</span><span class="op" id="3624102">]</span><span class="builtintype" id="3624103">string</span><span class="op" id="3624109">{</span><span class="string" id="3624110">&#34;chunked&#34;</span><span class="op" id="3624119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3624124">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3624128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624131">case</span>&nbsp;<span class="op" id="3624136">*</span><span class="ident" id="3624137">Response</span><span class="op" id="3624145">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624149">if</span>&nbsp;<span class="ident" id="3624152">rr</span><span class="op" id="3624154">.</span><span class="ident" id="3624155">Request</span>&nbsp;<span class="op" id="3624163">!=</span>&nbsp;<span class="builtintype" id="3624166">nil</span>&nbsp;<span class="op" id="3624170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624175">t</span><span class="op" id="3624176">.</span><span class="ident" id="3624177">Method</span>&nbsp;<span class="op" id="3624184">=</span>&nbsp;<span class="ident" id="3624186">rr</span><span class="op" id="3624188">.</span><span class="ident" id="3624189">Request</span><span class="op" id="3624196">.</span><span class="ident" id="3624197">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3624206">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624210">t</span><span class="op" id="3624211">.</span><span class="ident" id="3624212">Body</span>&nbsp;<span class="op" id="3624217">=</span>&nbsp;<span class="ident" id="3624219">rr</span><span class="op" id="3624221">.</span><span class="ident" id="3624222">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624229">t</span><span class="op" id="3624230">.</span><span class="ident" id="3624231">BodyCloser</span>&nbsp;<span class="op" id="3624242">=</span>&nbsp;<span class="ident" id="3624244">rr</span><span class="op" id="3624246">.</span><span class="ident" id="3624247">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624254">t</span><span class="op" id="3624255">.</span><span class="ident" id="3624256">ContentLength</span>&nbsp;<span class="op" id="3624270">=</span>&nbsp;<span class="ident" id="3624272">rr</span><span class="op" id="3624274">.</span><span class="ident" id="3624275">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624291">t</span><span class="op" id="3624292">.</span><span class="ident" id="3624293">Close</span>&nbsp;<span class="op" id="3624299">=</span>&nbsp;<span class="ident" id="3624301">rr</span><span class="op" id="3624303">.</span><span class="ident" id="3624304">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624312">t</span><span class="op" id="3624313">.</span><span class="ident" id="3624314">TransferEncoding</span>&nbsp;<span class="op" id="3624331">=</span>&nbsp;<span class="ident" id="3624333">rr</span><span class="op" id="3624335">.</span><span class="ident" id="3624336">TransferEncoding</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624355">t</span><span class="op" id="3624356">.</span><span class="ident" id="3624357">Trailer</span>&nbsp;<span class="op" id="3624365">=</span>&nbsp;<span class="ident" id="3624367">rr</span><span class="op" id="3624369">.</span><span class="ident" id="3624370">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624380">atLeastHTTP11</span>&nbsp;<span class="op" id="3624394">=</span>&nbsp;<span class="ident" id="3624396">rr</span><span class="op" id="3624398">.</span><span class="ident" id="3624399">ProtoAtLeast</span><span class="op" id="3624411">(</span><span class="num" id="3624412">1</span><span class="op" id="3624413">,</span>&nbsp;<span class="num" id="3624415">1</span><span class="op" id="3624416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624420">t</span><span class="op" id="3624421">.</span><span class="ident" id="3624422">ResponseToHEAD</span>&nbsp;<span class="op" id="3624437">=</span>&nbsp;<span class="ident" id="3624439">noBodyExpected</span><span class="op" id="3624453">(</span><span class="ident" id="3624454">t</span><span class="op" id="3624455">.</span><span class="ident" id="3624456">Method</span><span class="op" id="3624462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3624465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3624469">//&nbsp;Sanitize&nbsp;Body,ContentLength,TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624518">if</span>&nbsp;<span class="ident" id="3624521">t</span><span class="op" id="3624522">.</span><span class="ident" id="3624523">ResponseToHEAD</span>&nbsp;<span class="op" id="3624538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624542">t</span><span class="op" id="3624543">.</span><span class="ident" id="3624544">Body</span>&nbsp;<span class="op" id="3624549">=</span>&nbsp;<span class="builtintype" id="3624551">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624557">if</span>&nbsp;<span class="ident" id="3624560">chunked</span><span class="op" id="3624567">(</span><span class="ident" id="3624568">t</span><span class="op" id="3624569">.</span><span class="ident" id="3624570">TransferEncoding</span><span class="op" id="3624586">)</span>&nbsp;<span class="op" id="3624588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624593">t</span><span class="op" id="3624594">.</span><span class="ident" id="3624595">ContentLength</span>&nbsp;<span class="op" id="3624609">=</span>&nbsp;<span class="op" id="3624611">-</span><span class="num" id="3624612">1</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3624616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3624619">}</span>&nbsp;<span class="keyword" id="3624621">else</span>&nbsp;<span class="op" id="3624626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624630">if</span>&nbsp;<span class="op" id="3624633">!</span><span class="ident" id="3624634">atLeastHTTP11</span>&nbsp;<span class="op" id="3624648">||</span>&nbsp;<span class="ident" id="3624651">t</span><span class="op" id="3624652">.</span><span class="ident" id="3624653">Body</span>&nbsp;<span class="op" id="3624658">==</span>&nbsp;<span class="builtintype" id="3624661">nil</span>&nbsp;<span class="op" id="3624665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624670">t</span><span class="op" id="3624671">.</span><span class="ident" id="3624672">TransferEncoding</span>&nbsp;<span class="op" id="3624689">=</span>&nbsp;<span class="builtintype" id="3624691">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3624697">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624701">if</span>&nbsp;<span class="ident" id="3624704">chunked</span><span class="op" id="3624711">(</span><span class="ident" id="3624712">t</span><span class="op" id="3624713">.</span><span class="ident" id="3624714">TransferEncoding</span><span class="op" id="3624730">)</span>&nbsp;<span class="op" id="3624732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624737">t</span><span class="op" id="3624738">.</span><span class="ident" id="3624739">ContentLength</span>&nbsp;<span class="op" id="3624753">=</span>&nbsp;<span class="op" id="3624755">-</span><span class="num" id="3624756">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3624760">}</span>&nbsp;<span class="keyword" id="3624762">else</span>&nbsp;<span class="keyword" id="3624767">if</span>&nbsp;<span class="ident" id="3624770">t</span><span class="op" id="3624771">.</span><span class="ident" id="3624772">Body</span>&nbsp;<span class="op" id="3624777">==</span>&nbsp;<span class="builtintype" id="3624780">nil</span>&nbsp;<span class="op" id="3624784">{</span>&nbsp;<span class="comment" id="3624786">//&nbsp;no&nbsp;chunking,&nbsp;no&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624813">t</span><span class="op" id="3624814">.</span><span class="ident" id="3624815">ContentLength</span>&nbsp;<span class="op" id="3624829">=</span>&nbsp;<span class="num" id="3624831">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3624835">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3624838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3624842">//&nbsp;Sanitize&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624863">if</span>&nbsp;<span class="op" id="3624866">!</span><span class="ident" id="3624867">chunked</span><span class="op" id="3624874">(</span><span class="ident" id="3624875">t</span><span class="op" id="3624876">.</span><span class="ident" id="3624877">TransferEncoding</span><span class="op" id="3624893">)</span>&nbsp;<span class="op" id="3624895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624899">t</span><span class="op" id="3624900">.</span><span class="ident" id="3624901">Trailer</span>&nbsp;<span class="op" id="3624909">=</span>&nbsp;<span class="builtintype" id="3624911">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3624916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624920">return</span>&nbsp;<span class="ident" id="3624927">t</span><span class="op" id="3624928">,</span>&nbsp;<span class="builtintype" id="3624930">nil</span><br>
<span class="lineno"></span><span class="op" id="3624934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="3624937">func</span>&nbsp;<span class="ident" id="3624942">noBodyExpected</span><span class="op" id="3624956">(</span><span class="ident" id="3624957">requestMethod</span>&nbsp;<span class="builtintype" id="3624971">string</span><span class="op" id="3624977">)</span>&nbsp;<span class="builtintype" id="3624979">bool</span>&nbsp;<span class="op" id="3624984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624987">return</span>&nbsp;<span class="ident" id="3624994">requestMethod</span>&nbsp;<span class="op" id="3625008">==</span>&nbsp;<span class="string" id="3625011">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><span class="op" id="3625018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3625021">func</span>&nbsp;<span class="op" id="3625026">(</span><span class="ident" id="3625027">t</span>&nbsp;<span class="op" id="3625029">*</span><span class="ident" id="3625030">transferWriter</span><span class="op" id="3625044">)</span>&nbsp;<span class="ident" id="3625046">shouldSendContentLength</span><span class="op" id="3625069">(</span><span class="op" id="3625070">)</span>&nbsp;<span class="builtintype" id="3625072">bool</span>&nbsp;<span class="op" id="3625077">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625080">if</span>&nbsp;<span class="ident" id="3625083">chunked</span><span class="op" id="3625090">(</span><span class="ident" id="3625091">t</span><span class="op" id="3625092">.</span><span class="ident" id="3625093">TransferEncoding</span><span class="op" id="3625109">)</span>&nbsp;<span class="op" id="3625111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625115">return</span>&nbsp;<span class="builtintype" id="3625122">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3625129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625132">if</span>&nbsp;<span class="ident" id="3625135">t</span><span class="op" id="3625136">.</span><span class="ident" id="3625137">ContentLength</span>&nbsp;<span class="op" id="3625151">&gt;</span>&nbsp;<span class="num" id="3625153">0</span>&nbsp;<span class="op" id="3625155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625159">return</span>&nbsp;<span class="builtintype" id="3625166">true</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3625172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3625175">//&nbsp;Many&nbsp;servers&nbsp;expect&nbsp;a&nbsp;Content-Length&nbsp;for&nbsp;these&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625234">if</span>&nbsp;<span class="ident" id="3625237">t</span><span class="op" id="3625238">.</span><span class="ident" id="3625239">Method</span>&nbsp;<span class="op" id="3625246">==</span>&nbsp;<span class="string" id="3625249">&#34;POST&#34;</span>&nbsp;<span class="op" id="3625256">||</span>&nbsp;<span class="ident" id="3625259">t</span><span class="op" id="3625260">.</span><span class="ident" id="3625261">Method</span>&nbsp;<span class="op" id="3625268">==</span>&nbsp;<span class="string" id="3625271">&#34;PUT&#34;</span>&nbsp;<span class="op" id="3625277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625281">return</span>&nbsp;<span class="builtintype" id="3625288">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3625294">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625297">if</span>&nbsp;<span class="ident" id="3625300">t</span><span class="op" id="3625301">.</span><span class="ident" id="3625302">ContentLength</span>&nbsp;<span class="op" id="3625316">==</span>&nbsp;<span class="num" id="3625319">0</span>&nbsp;<span class="op" id="3625321">&amp;&amp;</span>&nbsp;<span class="ident" id="3625324">isIdentity</span><span class="op" id="3625334">(</span><span class="ident" id="3625335">t</span><span class="op" id="3625336">.</span><span class="ident" id="3625337">TransferEncoding</span><span class="op" id="3625353">)</span>&nbsp;<span class="op" id="3625355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625359">return</span>&nbsp;<span class="builtintype" id="3625366">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3625372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625376">return</span>&nbsp;<span class="builtintype" id="3625383">false</span><br>
<span class="lineno">150</span><span class="op" id="3625389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3625392">func</span>&nbsp;<span class="op" id="3625397">(</span><span class="ident" id="3625398">t</span>&nbsp;<span class="op" id="3625400">*</span><span class="ident" id="3625401">transferWriter</span><span class="op" id="3625415">)</span>&nbsp;<span class="ident" id="3625417">WriteHeader</span><span class="op" id="3625428">(</span><span class="ident" id="3625429">w</span>&nbsp;<span class="ident" id="3625431">io</span><span class="op" id="3625433">.</span><span class="ident" id="3625434">Writer</span><span class="op" id="3625440">)</span>&nbsp;<span class="builtintype" id="3625442">error</span>&nbsp;<span class="op" id="3625448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625451">if</span>&nbsp;<span class="ident" id="3625454">t</span><span class="op" id="3625455">.</span><span class="ident" id="3625456">Close</span>&nbsp;<span class="op" id="3625462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625466">if</span>&nbsp;<span class="ident" id="3625469">_</span><span class="op" id="3625470">,</span>&nbsp;<span class="ident" id="3625472">err</span>&nbsp;<span class="op" id="3625476">:=</span>&nbsp;<span class="ident" id="3625479">io</span><span class="op" id="3625481">.</span><span class="ident" id="3625482">WriteString</span><span class="op" id="3625493">(</span><span class="ident" id="3625494">w</span><span class="op" id="3625495">,</span>&nbsp;<span class="string" id="3625497">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="3625520">)</span><span class="op" id="3625521">;</span>&nbsp;<span class="ident" id="3625523">err</span>&nbsp;<span class="op" id="3625527">!=</span>&nbsp;<span class="builtintype" id="3625530">nil</span>&nbsp;<span class="op" id="3625534">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625539">return</span>&nbsp;<span class="ident" id="3625546">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3625552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3625555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3625559">//&nbsp;Write&nbsp;Content-Length&nbsp;and/or&nbsp;Transfer-Encoding&nbsp;whose&nbsp;values&nbsp;are&nbsp;a</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3625628">//&nbsp;function&nbsp;of&nbsp;the&nbsp;sanitized&nbsp;field&nbsp;triple&nbsp;(Body,&nbsp;ContentLength,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3625693">//&nbsp;TransferEncoding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625715">if</span>&nbsp;<span class="ident" id="3625718">t</span><span class="op" id="3625719">.</span><span class="ident" id="3625720">shouldSendContentLength</span><span class="op" id="3625743">(</span><span class="op" id="3625744">)</span>&nbsp;<span class="op" id="3625746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625750">if</span>&nbsp;<span class="ident" id="3625753">_</span><span class="op" id="3625754">,</span>&nbsp;<span class="ident" id="3625756">err</span>&nbsp;<span class="op" id="3625760">:=</span>&nbsp;<span class="ident" id="3625763">io</span><span class="op" id="3625765">.</span><span class="ident" id="3625766">WriteString</span><span class="op" id="3625777">(</span><span class="ident" id="3625778">w</span><span class="op" id="3625779">,</span>&nbsp;<span class="string" id="3625781">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="3625799">)</span><span class="op" id="3625800">;</span>&nbsp;<span class="ident" id="3625802">err</span>&nbsp;<span class="op" id="3625806">!=</span>&nbsp;<span class="builtintype" id="3625809">nil</span>&nbsp;<span class="op" id="3625813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625818">return</span>&nbsp;<span class="ident" id="3625825">err</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3625831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625835">if</span>&nbsp;<span class="ident" id="3625838">_</span><span class="op" id="3625839">,</span>&nbsp;<span class="ident" id="3625841">err</span>&nbsp;<span class="op" id="3625845">:=</span>&nbsp;<span class="ident" id="3625848">io</span><span class="op" id="3625850">.</span><span class="ident" id="3625851">WriteString</span><span class="op" id="3625862">(</span><span class="ident" id="3625863">w</span><span class="op" id="3625864">,</span>&nbsp;<span class="ident" id="3625866">strconv</span><span class="op" id="3625873">.</span><span class="ident" id="3625874">FormatInt</span><span class="op" id="3625883">(</span><span class="ident" id="3625884">t</span><span class="op" id="3625885">.</span><span class="ident" id="3625886">ContentLength</span><span class="op" id="3625899">,</span>&nbsp;<span class="num" id="3625901">10</span><span class="op" id="3625903">)</span><span class="op" id="3625904">+</span><span class="string" id="3625905">&#34;\r\n&#34;</span><span class="op" id="3625911">)</span><span class="op" id="3625912">;</span>&nbsp;<span class="ident" id="3625914">err</span>&nbsp;<span class="op" id="3625918">!=</span>&nbsp;<span class="builtintype" id="3625921">nil</span>&nbsp;<span class="op" id="3625925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625930">return</span>&nbsp;<span class="ident" id="3625937">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3625943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3625946">}</span>&nbsp;<span class="keyword" id="3625948">else</span>&nbsp;<span class="keyword" id="3625953">if</span>&nbsp;<span class="ident" id="3625956">chunked</span><span class="op" id="3625963">(</span><span class="ident" id="3625964">t</span><span class="op" id="3625965">.</span><span class="ident" id="3625966">TransferEncoding</span><span class="op" id="3625982">)</span>&nbsp;<span class="op" id="3625984">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625988">if</span>&nbsp;<span class="ident" id="3625991">_</span><span class="op" id="3625992">,</span>&nbsp;<span class="ident" id="3625994">err</span>&nbsp;<span class="op" id="3625998">:=</span>&nbsp;<span class="ident" id="3626001">io</span><span class="op" id="3626003">.</span><span class="ident" id="3626004">WriteString</span><span class="op" id="3626015">(</span><span class="ident" id="3626016">w</span><span class="op" id="3626017">,</span>&nbsp;<span class="string" id="3626019">&#34;Transfer-Encoding:&nbsp;chunked\r\n&#34;</span><span class="op" id="3626051">)</span><span class="op" id="3626052">;</span>&nbsp;<span class="ident" id="3626054">err</span>&nbsp;<span class="op" id="3626058">!=</span>&nbsp;<span class="builtintype" id="3626061">nil</span>&nbsp;<span class="op" id="3626065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626070">return</span>&nbsp;<span class="ident" id="3626077">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3626083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3626086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3626090">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626115">if</span>&nbsp;<span class="ident" id="3626118">t</span><span class="op" id="3626119">.</span><span class="ident" id="3626120">Trailer</span>&nbsp;<span class="op" id="3626128">!=</span>&nbsp;<span class="builtintype" id="3626131">nil</span>&nbsp;<span class="op" id="3626135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3626139">keys</span>&nbsp;<span class="op" id="3626144">:=</span>&nbsp;<span class="builtinfunc" id="3626147">make</span><span class="op" id="3626151">(</span><span class="op" id="3626152">[</span><span class="op" id="3626153">]</span><span class="builtintype" id="3626154">string</span><span class="op" id="3626160">,</span>&nbsp;<span class="num" id="3626162">0</span><span class="op" id="3626163">,</span>&nbsp;<span class="builtinfunc" id="3626165">len</span><span class="op" id="3626168">(</span><span class="ident" id="3626169">t</span><span class="op" id="3626170">.</span><span class="ident" id="3626171">Trailer</span><span class="op" id="3626178">)</span><span class="op" id="3626179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626183">for</span>&nbsp;<span class="ident" id="3626187">k</span>&nbsp;<span class="op" id="3626189">:=</span>&nbsp;<span class="keyword" id="3626192">range</span>&nbsp;<span class="ident" id="3626198">t</span><span class="op" id="3626199">.</span><span class="ident" id="3626200">Trailer</span>&nbsp;<span class="op" id="3626208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3626213">k</span>&nbsp;<span class="op" id="3626215">=</span>&nbsp;<span class="ident" id="3626217">CanonicalHeaderKey</span><span class="op" id="3626235">(</span><span class="ident" id="3626236">k</span><span class="op" id="3626237">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626242">switch</span>&nbsp;<span class="ident" id="3626249">k</span>&nbsp;<span class="op" id="3626251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626256">case</span>&nbsp;<span class="string" id="3626261">&#34;Transfer-Encoding&#34;</span><span class="op" id="3626280">,</span>&nbsp;<span class="string" id="3626282">&#34;Trailer&#34;</span><span class="op" id="3626291">,</span>&nbsp;<span class="string" id="3626293">&#34;Content-Length&#34;</span><span class="op" id="3626309">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626315">return</span>&nbsp;<span class="op" id="3626322">&amp;</span><span class="ident" id="3626323">badStringError</span><span class="op" id="3626337">{</span><span class="string" id="3626338">&#34;invalid&nbsp;Trailer&nbsp;key&#34;</span><span class="op" id="3626359">,</span>&nbsp;<span class="ident" id="3626361">k</span><span class="op" id="3626362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3626367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3626372">keys</span>&nbsp;<span class="op" id="3626377">=</span>&nbsp;<span class="builtinfunc" id="3626379">append</span><span class="op" id="3626385">(</span><span class="ident" id="3626386">keys</span><span class="op" id="3626390">,</span>&nbsp;<span class="ident" id="3626392">k</span><span class="op" id="3626393">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3626397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626401">if</span>&nbsp;<span class="builtinfunc" id="3626404">len</span><span class="op" id="3626407">(</span><span class="ident" id="3626408">keys</span><span class="op" id="3626412">)</span>&nbsp;<span class="op" id="3626414">&gt;</span>&nbsp;<span class="num" id="3626416">0</span>&nbsp;<span class="op" id="3626418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3626423">sort</span><span class="op" id="3626427">.</span><span class="ident" id="3626428">Strings</span><span class="op" id="3626435">(</span><span class="ident" id="3626436">keys</span><span class="op" id="3626440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3626445">//&nbsp;TODO:&nbsp;could&nbsp;do&nbsp;better&nbsp;allocation-wise&nbsp;here,&nbsp;but&nbsp;trailers&nbsp;are&nbsp;rare,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3626518">//&nbsp;so&nbsp;being&nbsp;lazy&nbsp;for&nbsp;now.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626547">if</span>&nbsp;<span class="ident" id="3626550">_</span><span class="op" id="3626551">,</span>&nbsp;<span class="ident" id="3626553">err</span>&nbsp;<span class="op" id="3626557">:=</span>&nbsp;<span class="ident" id="3626560">io</span><span class="op" id="3626562">.</span><span class="ident" id="3626563">WriteString</span><span class="op" id="3626574">(</span><span class="ident" id="3626575">w</span><span class="op" id="3626576">,</span>&nbsp;<span class="string" id="3626578">&#34;Trailer:&nbsp;&#34;</span><span class="op" id="3626589">+</span><span class="ident" id="3626590">strings</span><span class="op" id="3626597">.</span><span class="ident" id="3626598">Join</span><span class="op" id="3626602">(</span><span class="ident" id="3626603">keys</span><span class="op" id="3626607">,</span>&nbsp;<span class="string" id="3626609">&#34;,&#34;</span><span class="op" id="3626612">)</span><span class="op" id="3626613">+</span><span class="string" id="3626614">&#34;\r\n&#34;</span><span class="op" id="3626620">)</span><span class="op" id="3626621">;</span>&nbsp;<span class="ident" id="3626623">err</span>&nbsp;<span class="op" id="3626627">!=</span>&nbsp;<span class="builtintype" id="3626630">nil</span>&nbsp;<span class="op" id="3626634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626640">return</span>&nbsp;<span class="ident" id="3626647">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3626654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3626658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3626661">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626665">return</span>&nbsp;<span class="builtintype" id="3626672">nil</span><br>
<span class="lineno"></span><span class="op" id="3626676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3626679">func</span>&nbsp;<span class="op" id="3626684">(</span><span class="ident" id="3626685">t</span>&nbsp;<span class="op" id="3626687">*</span><span class="ident" id="3626688">transferWriter</span><span class="op" id="3626702">)</span>&nbsp;<span class="ident" id="3626704">WriteBody</span><span class="op" id="3626713">(</span><span class="ident" id="3626714">w</span>&nbsp;<span class="ident" id="3626716">io</span><span class="op" id="3626718">.</span><span class="ident" id="3626719">Writer</span><span class="op" id="3626725">)</span>&nbsp;<span class="builtintype" id="3626727">error</span>&nbsp;<span class="op" id="3626733">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626736">var</span>&nbsp;<span class="ident" id="3626740">err</span>&nbsp;<span class="builtintype" id="3626744">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626751">var</span>&nbsp;<span class="ident" id="3626755">ncopy</span>&nbsp;<span class="builtintype" id="3626761">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3626769">//&nbsp;Write&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626784">if</span>&nbsp;<span class="ident" id="3626787">t</span><span class="op" id="3626788">.</span><span class="ident" id="3626789">Body</span>&nbsp;<span class="op" id="3626794">!=</span>&nbsp;<span class="builtintype" id="3626797">nil</span>&nbsp;<span class="op" id="3626801">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626805">if</span>&nbsp;<span class="ident" id="3626808">chunked</span><span class="op" id="3626815">(</span><span class="ident" id="3626816">t</span><span class="op" id="3626817">.</span><span class="ident" id="3626818">TransferEncoding</span><span class="op" id="3626834">)</span>&nbsp;<span class="op" id="3626836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3626841">cw</span>&nbsp;<span class="op" id="3626844">:=</span>&nbsp;<span class="ident" id="3626847">internal</span><span class="op" id="3626855">.</span><span class="ident" id="3626856">NewChunkedWriter</span><span class="op" id="3626872">(</span><span class="ident" id="3626873">w</span><span class="op" id="3626874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3626879">_</span><span class="op" id="3626880">,</span>&nbsp;<span class="ident" id="3626882">err</span>&nbsp;<span class="op" id="3626886">=</span>&nbsp;<span class="ident" id="3626888">io</span><span class="op" id="3626890">.</span><span class="ident" id="3626891">Copy</span><span class="op" id="3626895">(</span><span class="ident" id="3626896">cw</span><span class="op" id="3626898">,</span>&nbsp;<span class="ident" id="3626900">t</span><span class="op" id="3626901">.</span><span class="ident" id="3626902">Body</span><span class="op" id="3626906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626911">if</span>&nbsp;<span class="ident" id="3626914">err</span>&nbsp;<span class="op" id="3626918">==</span>&nbsp;<span class="builtintype" id="3626921">nil</span>&nbsp;<span class="op" id="3626925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3626931">err</span>&nbsp;<span class="op" id="3626935">=</span>&nbsp;<span class="ident" id="3626937">cw</span><span class="op" id="3626939">.</span><span class="ident" id="3626940">Close</span><span class="op" id="3626945">(</span><span class="op" id="3626946">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3626951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3626955">}</span>&nbsp;<span class="keyword" id="3626957">else</span>&nbsp;<span class="keyword" id="3626962">if</span>&nbsp;<span class="ident" id="3626965">t</span><span class="op" id="3626966">.</span><span class="ident" id="3626967">ContentLength</span>&nbsp;<span class="op" id="3626981">==</span>&nbsp;<span class="op" id="3626984">-</span><span class="num" id="3626985">1</span>&nbsp;<span class="op" id="3626987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3626992">ncopy</span><span class="op" id="3626997">,</span>&nbsp;<span class="ident" id="3626999">err</span>&nbsp;<span class="op" id="3627003">=</span>&nbsp;<span class="ident" id="3627005">io</span><span class="op" id="3627007">.</span><span class="ident" id="3627008">Copy</span><span class="op" id="3627012">(</span><span class="ident" id="3627013">w</span><span class="op" id="3627014">,</span>&nbsp;<span class="ident" id="3627016">t</span><span class="op" id="3627017">.</span><span class="ident" id="3627018">Body</span><span class="op" id="3627022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3627026">}</span>&nbsp;<span class="keyword" id="3627028">else</span>&nbsp;<span class="op" id="3627033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627038">ncopy</span><span class="op" id="3627043">,</span>&nbsp;<span class="ident" id="3627045">err</span>&nbsp;<span class="op" id="3627049">=</span>&nbsp;<span class="ident" id="3627051">io</span><span class="op" id="3627053">.</span><span class="ident" id="3627054">Copy</span><span class="op" id="3627058">(</span><span class="ident" id="3627059">w</span><span class="op" id="3627060">,</span>&nbsp;<span class="ident" id="3627062">io</span><span class="op" id="3627064">.</span><span class="ident" id="3627065">LimitReader</span><span class="op" id="3627076">(</span><span class="ident" id="3627077">t</span><span class="op" id="3627078">.</span><span class="ident" id="3627079">Body</span><span class="op" id="3627083">,</span>&nbsp;<span class="ident" id="3627085">t</span><span class="op" id="3627086">.</span><span class="ident" id="3627087">ContentLength</span><span class="op" id="3627100">)</span><span class="op" id="3627101">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627106">if</span>&nbsp;<span class="ident" id="3627109">err</span>&nbsp;<span class="op" id="3627113">!=</span>&nbsp;<span class="builtintype" id="3627116">nil</span>&nbsp;<span class="op" id="3627120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627126">return</span>&nbsp;<span class="ident" id="3627133">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3627140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627145">var</span>&nbsp;<span class="ident" id="3627149">nextra</span>&nbsp;<span class="builtintype" id="3627156">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627165">nextra</span><span class="op" id="3627171">,</span>&nbsp;<span class="ident" id="3627173">err</span>&nbsp;<span class="op" id="3627177">=</span>&nbsp;<span class="ident" id="3627179">io</span><span class="op" id="3627181">.</span><span class="ident" id="3627182">Copy</span><span class="op" id="3627186">(</span><span class="ident" id="3627187">ioutil</span><span class="op" id="3627193">.</span><span class="ident" id="3627194">Discard</span><span class="op" id="3627201">,</span>&nbsp;<span class="ident" id="3627203">t</span><span class="op" id="3627204">.</span><span class="ident" id="3627205">Body</span><span class="op" id="3627209">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627214">ncopy</span>&nbsp;<span class="op" id="3627220">+=</span>&nbsp;<span class="ident" id="3627223">nextra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3627232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627236">if</span>&nbsp;<span class="ident" id="3627239">err</span>&nbsp;<span class="op" id="3627243">!=</span>&nbsp;<span class="builtintype" id="3627246">nil</span>&nbsp;<span class="op" id="3627250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627255">return</span>&nbsp;<span class="ident" id="3627262">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3627268">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627272">if</span>&nbsp;<span class="ident" id="3627275">err</span>&nbsp;<span class="op" id="3627279">=</span>&nbsp;<span class="ident" id="3627281">t</span><span class="op" id="3627282">.</span><span class="ident" id="3627283">BodyCloser</span><span class="op" id="3627293">.</span><span class="ident" id="3627294">Close</span><span class="op" id="3627299">(</span><span class="op" id="3627300">)</span><span class="op" id="3627301">;</span>&nbsp;<span class="ident" id="3627303">err</span>&nbsp;<span class="op" id="3627307">!=</span>&nbsp;<span class="builtintype" id="3627310">nil</span>&nbsp;<span class="op" id="3627314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627319">return</span>&nbsp;<span class="ident" id="3627326">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3627332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3627335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627339">if</span>&nbsp;<span class="op" id="3627342">!</span><span class="ident" id="3627343">t</span><span class="op" id="3627344">.</span><span class="ident" id="3627345">ResponseToHEAD</span>&nbsp;<span class="op" id="3627360">&amp;&amp;</span>&nbsp;<span class="ident" id="3627363">t</span><span class="op" id="3627364">.</span><span class="ident" id="3627365">ContentLength</span>&nbsp;<span class="op" id="3627379">!=</span>&nbsp;<span class="op" id="3627382">-</span><span class="num" id="3627383">1</span>&nbsp;<span class="op" id="3627385">&amp;&amp;</span>&nbsp;<span class="ident" id="3627388">t</span><span class="op" id="3627389">.</span><span class="ident" id="3627390">ContentLength</span>&nbsp;<span class="op" id="3627404">!=</span>&nbsp;<span class="ident" id="3627407">ncopy</span>&nbsp;<span class="op" id="3627413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627417">return</span>&nbsp;<span class="ident" id="3627424">fmt</span><span class="op" id="3627427">.</span><span class="ident" id="3627428">Errorf</span><span class="op" id="3627434">(</span><span class="string" id="3627435">&#34;http:&nbsp;ContentLength=%d&nbsp;with&nbsp;Body&nbsp;length&nbsp;%d&#34;</span><span class="op" id="3627479">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627484">t</span><span class="op" id="3627485">.</span><span class="ident" id="3627486">ContentLength</span><span class="op" id="3627499">,</span>&nbsp;<span class="ident" id="3627501">ncopy</span><span class="op" id="3627506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3627509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3627513">//&nbsp;TODO(petar):&nbsp;Place&nbsp;trailer&nbsp;writer&nbsp;code&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627562">if</span>&nbsp;<span class="ident" id="3627565">chunked</span><span class="op" id="3627572">(</span><span class="ident" id="3627573">t</span><span class="op" id="3627574">.</span><span class="ident" id="3627575">TransferEncoding</span><span class="op" id="3627591">)</span>&nbsp;<span class="op" id="3627593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3627597">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627623">if</span>&nbsp;<span class="ident" id="3627626">t</span><span class="op" id="3627627">.</span><span class="ident" id="3627628">Trailer</span>&nbsp;<span class="op" id="3627636">!=</span>&nbsp;<span class="builtintype" id="3627639">nil</span>&nbsp;<span class="op" id="3627643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627648">if</span>&nbsp;<span class="ident" id="3627651">err</span>&nbsp;<span class="op" id="3627655">:=</span>&nbsp;<span class="ident" id="3627658">t</span><span class="op" id="3627659">.</span><span class="ident" id="3627660">Trailer</span><span class="op" id="3627667">.</span><span class="ident" id="3627668">Write</span><span class="op" id="3627673">(</span><span class="ident" id="3627674">w</span><span class="op" id="3627675">)</span><span class="op" id="3627676">;</span>&nbsp;<span class="ident" id="3627678">err</span>&nbsp;<span class="op" id="3627682">!=</span>&nbsp;<span class="builtintype" id="3627685">nil</span>&nbsp;<span class="op" id="3627689">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627695">return</span>&nbsp;<span class="ident" id="3627702">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3627709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3627713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3627717">//&nbsp;Last&nbsp;chunk,&nbsp;empty&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627748">_</span><span class="op" id="3627749">,</span>&nbsp;<span class="ident" id="3627751">err</span>&nbsp;<span class="op" id="3627755">=</span>&nbsp;<span class="ident" id="3627757">io</span><span class="op" id="3627759">.</span><span class="ident" id="3627760">WriteString</span><span class="op" id="3627771">(</span><span class="ident" id="3627772">w</span><span class="op" id="3627773">,</span>&nbsp;<span class="string" id="3627775">&#34;\r\n&#34;</span><span class="op" id="3627781">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3627784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627787">return</span>&nbsp;<span class="ident" id="3627794">err</span><br>
<span class="lineno"></span><span class="op" id="3627798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3627801">type</span>&nbsp;<span class="ident" id="3627806">transferReader</span>&nbsp;<span class="keyword" id="3627821">struct</span>&nbsp;<span class="op" id="3627828">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3627831">//&nbsp;Input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627841">Header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627855">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627863">StatusCode</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3627877">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627882">RequestMethod</span>&nbsp;<span class="builtintype" id="3627896">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627904">ProtoMajor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3627918">int</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627923">ProtoMinor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3627937">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3627942">//&nbsp;Output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627953">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627970">io</span><span class="op" id="3627972">.</span><span class="ident" id="3627973">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627985">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3628002">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3628009">TransferEncoding</span>&nbsp;<span class="op" id="3628026">[</span><span class="op" id="3628027">]</span><span class="builtintype" id="3628028">string</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3628036">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3628053">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3628059">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3628076">Header</span><br>
<span class="lineno"></span><span class="op" id="3628083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3628086">//&nbsp;bodyAllowedForStatus&nbsp;reports&nbsp;whether&nbsp;a&nbsp;given&nbsp;response&nbsp;status&nbsp;code</span><br>
<span class="lineno">265</span><span class="comment" id="3628155">//&nbsp;permits&nbsp;a&nbsp;body.&nbsp;&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span><span class="keyword" id="3628201">func</span>&nbsp;<span class="ident" id="3628206">bodyAllowedForStatus</span><span class="op" id="3628226">(</span><span class="ident" id="3628227">status</span>&nbsp;<span class="builtintype" id="3628234">int</span><span class="op" id="3628237">)</span>&nbsp;<span class="builtintype" id="3628239">bool</span>&nbsp;<span class="op" id="3628244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628247">switch</span>&nbsp;<span class="op" id="3628254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628257">case</span>&nbsp;<span class="ident" id="3628262">status</span>&nbsp;<span class="op" id="3628269">&gt;=</span>&nbsp;<span class="num" id="3628272">100</span>&nbsp;<span class="op" id="3628276">&amp;&amp;</span>&nbsp;<span class="ident" id="3628279">status</span>&nbsp;<span class="op" id="3628286">&lt;=</span>&nbsp;<span class="num" id="3628289">199</span><span class="op" id="3628292">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628296">return</span>&nbsp;<span class="builtintype" id="3628303">false</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628310">case</span>&nbsp;<span class="ident" id="3628315">status</span>&nbsp;<span class="op" id="3628322">==</span>&nbsp;<span class="num" id="3628325">204</span><span class="op" id="3628328">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628332">return</span>&nbsp;<span class="builtintype" id="3628339">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628346">case</span>&nbsp;<span class="ident" id="3628351">status</span>&nbsp;<span class="op" id="3628358">==</span>&nbsp;<span class="num" id="3628361">304</span><span class="op" id="3628364">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628368">return</span>&nbsp;<span class="builtintype" id="3628375">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3628382">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628385">return</span>&nbsp;<span class="builtintype" id="3628392">true</span><br>
<span class="lineno"></span><span class="op" id="3628397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3628400">var</span>&nbsp;<span class="op" id="3628404">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3628407">suppressedHeaders304</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3628431">=</span>&nbsp;<span class="op" id="3628433">[</span><span class="op" id="3628434">]</span><span class="builtintype" id="3628435">string</span><span class="op" id="3628441">{</span><span class="string" id="3628442">&#34;Content-Type&#34;</span><span class="op" id="3628456">,</span>&nbsp;<span class="string" id="3628458">&#34;Content-Length&#34;</span><span class="op" id="3628474">,</span>&nbsp;<span class="string" id="3628476">&#34;Transfer-Encoding&#34;</span><span class="op" id="3628495">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3628498">suppressedHeadersNoBody</span>&nbsp;<span class="op" id="3628522">=</span>&nbsp;<span class="op" id="3628524">[</span><span class="op" id="3628525">]</span><span class="builtintype" id="3628526">string</span><span class="op" id="3628532">{</span><span class="string" id="3628533">&#34;Content-Length&#34;</span><span class="op" id="3628549">,</span>&nbsp;<span class="string" id="3628551">&#34;Transfer-Encoding&#34;</span><span class="op" id="3628570">}</span><br>
<span class="lineno"></span><span class="op" id="3628572">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3628575">func</span>&nbsp;<span class="ident" id="3628580">suppressedHeaders</span><span class="op" id="3628597">(</span><span class="ident" id="3628598">status</span>&nbsp;<span class="builtintype" id="3628605">int</span><span class="op" id="3628608">)</span>&nbsp;<span class="op" id="3628610">[</span><span class="op" id="3628611">]</span><span class="builtintype" id="3628612">string</span>&nbsp;<span class="op" id="3628619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628622">switch</span>&nbsp;<span class="op" id="3628629">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628632">case</span>&nbsp;<span class="ident" id="3628637">status</span>&nbsp;<span class="op" id="3628644">==</span>&nbsp;<span class="num" id="3628647">304</span><span class="op" id="3628650">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3628654">//&nbsp;RFC&nbsp;2616&nbsp;section&nbsp;10.3.5:&nbsp;&#34;the&nbsp;response&nbsp;MUST&nbsp;NOT&nbsp;include&nbsp;other&nbsp;entity-headers&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628737">return</span>&nbsp;<span class="ident" id="3628744">suppressedHeaders304</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628766">case</span>&nbsp;<span class="op" id="3628771">!</span><span class="ident" id="3628772">bodyAllowedForStatus</span><span class="op" id="3628792">(</span><span class="ident" id="3628793">status</span><span class="op" id="3628799">)</span><span class="op" id="3628800">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628804">return</span>&nbsp;<span class="ident" id="3628811">suppressedHeadersNoBody</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3628836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628839">return</span>&nbsp;<span class="builtintype" id="3628846">nil</span><br>
<span class="lineno"></span><span class="op" id="3628850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3628853">//&nbsp;msg&nbsp;is&nbsp;*Request&nbsp;or&nbsp;*Response.</span><br>
<span class="lineno">295</span><span class="keyword" id="3628886">func</span>&nbsp;<span class="ident" id="3628891">readTransfer</span><span class="op" id="3628903">(</span><span class="ident" id="3628904">msg</span>&nbsp;<span class="keyword" id="3628908">interface</span><span class="op" id="3628917">{</span><span class="op" id="3628918">}</span><span class="op" id="3628919">,</span>&nbsp;<span class="ident" id="3628921">r</span>&nbsp;<span class="op" id="3628923">*</span><span class="ident" id="3628924">bufio</span><span class="op" id="3628929">.</span><span class="ident" id="3628930">Reader</span><span class="op" id="3628936">)</span>&nbsp;<span class="op" id="3628938">(</span><span class="ident" id="3628939">err</span>&nbsp;<span class="builtintype" id="3628943">error</span><span class="op" id="3628948">)</span>&nbsp;<span class="op" id="3628950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3628953">t</span>&nbsp;<span class="op" id="3628955">:=</span>&nbsp;<span class="op" id="3628958">&amp;</span><span class="ident" id="3628959">transferReader</span><span class="op" id="3628973">{</span><span class="ident" id="3628974">RequestMethod</span><span class="op" id="3628987">:</span>&nbsp;<span class="string" id="3628989">&#34;GET&#34;</span><span class="op" id="3628994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3628998">//&nbsp;Unify&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629014">isResponse</span>&nbsp;<span class="op" id="3629025">:=</span>&nbsp;<span class="builtintype" id="3629028">false</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3629035">switch</span>&nbsp;<span class="ident" id="3629042">rr</span>&nbsp;<span class="op" id="3629045">:=</span>&nbsp;<span class="ident" id="3629048">msg</span><span class="op" id="3629051">.</span><span class="op" id="3629052">(</span><span class="keyword" id="3629053">type</span><span class="op" id="3629057">)</span>&nbsp;<span class="op" id="3629059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3629062">case</span>&nbsp;<span class="op" id="3629067">*</span><span class="ident" id="3629068">Response</span><span class="op" id="3629076">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629080">t</span><span class="op" id="3629081">.</span><span class="ident" id="3629082">Header</span>&nbsp;<span class="op" id="3629089">=</span>&nbsp;<span class="ident" id="3629091">rr</span><span class="op" id="3629093">.</span><span class="ident" id="3629094">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629103">t</span><span class="op" id="3629104">.</span><span class="ident" id="3629105">StatusCode</span>&nbsp;<span class="op" id="3629116">=</span>&nbsp;<span class="ident" id="3629118">rr</span><span class="op" id="3629120">.</span><span class="ident" id="3629121">StatusCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629134">t</span><span class="op" id="3629135">.</span><span class="ident" id="3629136">ProtoMajor</span>&nbsp;<span class="op" id="3629147">=</span>&nbsp;<span class="ident" id="3629149">rr</span><span class="op" id="3629151">.</span><span class="ident" id="3629152">ProtoMajor</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629165">t</span><span class="op" id="3629166">.</span><span class="ident" id="3629167">ProtoMinor</span>&nbsp;<span class="op" id="3629178">=</span>&nbsp;<span class="ident" id="3629180">rr</span><span class="op" id="3629182">.</span><span class="ident" id="3629183">ProtoMinor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629196">t</span><span class="op" id="3629197">.</span><span class="ident" id="3629198">Close</span>&nbsp;<span class="op" id="3629204">=</span>&nbsp;<span class="ident" id="3629206">shouldClose</span><span class="op" id="3629217">(</span><span class="ident" id="3629218">t</span><span class="op" id="3629219">.</span><span class="ident" id="3629220">ProtoMajor</span><span class="op" id="3629230">,</span>&nbsp;<span class="ident" id="3629232">t</span><span class="op" id="3629233">.</span><span class="ident" id="3629234">ProtoMinor</span><span class="op" id="3629244">,</span>&nbsp;<span class="ident" id="3629246">t</span><span class="op" id="3629247">.</span><span class="ident" id="3629248">Header</span><span class="op" id="3629254">,</span>&nbsp;<span class="builtintype" id="3629256">true</span><span class="op" id="3629260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629264">isResponse</span>&nbsp;<span class="op" id="3629275">=</span>&nbsp;<span class="builtintype" id="3629277">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3629284">if</span>&nbsp;<span class="ident" id="3629287">rr</span><span class="op" id="3629289">.</span><span class="ident" id="3629290">Request</span>&nbsp;<span class="op" id="3629298">!=</span>&nbsp;<span class="builtintype" id="3629301">nil</span>&nbsp;<span class="op" id="3629305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629310">t</span><span class="op" id="3629311">.</span><span class="ident" id="3629312">RequestMethod</span>&nbsp;<span class="op" id="3629326">=</span>&nbsp;<span class="ident" id="3629328">rr</span><span class="op" id="3629330">.</span><span class="ident" id="3629331">Request</span><span class="op" id="3629338">.</span><span class="ident" id="3629339">Method</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3629348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3629351">case</span>&nbsp;<span class="op" id="3629356">*</span><span class="ident" id="3629357">Request</span><span class="op" id="3629364">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629368">t</span><span class="op" id="3629369">.</span><span class="ident" id="3629370">Header</span>&nbsp;<span class="op" id="3629377">=</span>&nbsp;<span class="ident" id="3629379">rr</span><span class="op" id="3629381">.</span><span class="ident" id="3629382">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629391">t</span><span class="op" id="3629392">.</span><span class="ident" id="3629393">ProtoMajor</span>&nbsp;<span class="op" id="3629404">=</span>&nbsp;<span class="ident" id="3629406">rr</span><span class="op" id="3629408">.</span><span class="ident" id="3629409">ProtoMajor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629422">t</span><span class="op" id="3629423">.</span><span class="ident" id="3629424">ProtoMinor</span>&nbsp;<span class="op" id="3629435">=</span>&nbsp;<span class="ident" id="3629437">rr</span><span class="op" id="3629439">.</span><span class="ident" id="3629440">ProtoMinor</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3629453">//&nbsp;Transfer&nbsp;semantics&nbsp;for&nbsp;Requests&nbsp;are&nbsp;exactly&nbsp;like&nbsp;those&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3629517">//&nbsp;Responses&nbsp;with&nbsp;status&nbsp;code&nbsp;200,&nbsp;responding&nbsp;to&nbsp;a&nbsp;GET&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629581">t</span><span class="op" id="3629582">.</span><span class="ident" id="3629583">StatusCode</span>&nbsp;<span class="op" id="3629594">=</span>&nbsp;<span class="num" id="3629596">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3629601">default</span><span class="op" id="3629608">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3629612">panic</span><span class="op" id="3629617">(</span><span class="string" id="3629618">&#34;unexpected&nbsp;type&#34;</span><span class="op" id="3629635">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3629638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3629642">//&nbsp;Default&nbsp;to&nbsp;HTTP/1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3629666">if</span>&nbsp;<span class="ident" id="3629669">t</span><span class="op" id="3629670">.</span><span class="ident" id="3629671">ProtoMajor</span>&nbsp;<span class="op" id="3629682">==</span>&nbsp;<span class="num" id="3629685">0</span>&nbsp;<span class="op" id="3629687">&amp;&amp;</span>&nbsp;<span class="ident" id="3629690">t</span><span class="op" id="3629691">.</span><span class="ident" id="3629692">ProtoMinor</span>&nbsp;<span class="op" id="3629703">==</span>&nbsp;<span class="num" id="3629706">0</span>&nbsp;<span class="op" id="3629708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629712">t</span><span class="op" id="3629713">.</span><span class="ident" id="3629714">ProtoMajor</span><span class="op" id="3629724">,</span>&nbsp;<span class="ident" id="3629726">t</span><span class="op" id="3629727">.</span><span class="ident" id="3629728">ProtoMinor</span>&nbsp;<span class="op" id="3629739">=</span>&nbsp;<span class="num" id="3629741">1</span><span class="op" id="3629742">,</span>&nbsp;<span class="num" id="3629744">1</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3629747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3629751">//&nbsp;Transfer&nbsp;encoding,&nbsp;content&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629789">t</span><span class="op" id="3629790">.</span><span class="ident" id="3629791">TransferEncoding</span><span class="op" id="3629807">,</span>&nbsp;<span class="ident" id="3629809">err</span>&nbsp;<span class="op" id="3629813">=</span>&nbsp;<span class="ident" id="3629815">fixTransferEncoding</span><span class="op" id="3629834">(</span><span class="ident" id="3629835">t</span><span class="op" id="3629836">.</span><span class="ident" id="3629837">RequestMethod</span><span class="op" id="3629850">,</span>&nbsp;<span class="ident" id="3629852">t</span><span class="op" id="3629853">.</span><span class="ident" id="3629854">Header</span><span class="op" id="3629860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3629863">if</span>&nbsp;<span class="ident" id="3629866">err</span>&nbsp;<span class="op" id="3629870">!=</span>&nbsp;<span class="builtintype" id="3629873">nil</span>&nbsp;<span class="op" id="3629877">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3629881">return</span>&nbsp;<span class="ident" id="3629888">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3629893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629897">realLength</span><span class="op" id="3629907">,</span>&nbsp;<span class="ident" id="3629909">err</span>&nbsp;<span class="op" id="3629913">:=</span>&nbsp;<span class="ident" id="3629916">fixLength</span><span class="op" id="3629925">(</span><span class="ident" id="3629926">isResponse</span><span class="op" id="3629936">,</span>&nbsp;<span class="ident" id="3629938">t</span><span class="op" id="3629939">.</span><span class="ident" id="3629940">StatusCode</span><span class="op" id="3629950">,</span>&nbsp;<span class="ident" id="3629952">t</span><span class="op" id="3629953">.</span><span class="ident" id="3629954">RequestMethod</span><span class="op" id="3629967">,</span>&nbsp;<span class="ident" id="3629969">t</span><span class="op" id="3629970">.</span><span class="ident" id="3629971">Header</span><span class="op" id="3629977">,</span>&nbsp;<span class="ident" id="3629979">t</span><span class="op" id="3629980">.</span><span class="ident" id="3629981">TransferEncoding</span><span class="op" id="3629997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3630000">if</span>&nbsp;<span class="ident" id="3630003">err</span>&nbsp;<span class="op" id="3630007">!=</span>&nbsp;<span class="builtintype" id="3630010">nil</span>&nbsp;<span class="op" id="3630014">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3630018">return</span>&nbsp;<span class="ident" id="3630025">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3630030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3630033">if</span>&nbsp;<span class="ident" id="3630036">isResponse</span>&nbsp;<span class="op" id="3630047">&amp;&amp;</span>&nbsp;<span class="ident" id="3630050">t</span><span class="op" id="3630051">.</span><span class="ident" id="3630052">RequestMethod</span>&nbsp;<span class="op" id="3630066">==</span>&nbsp;<span class="string" id="3630069">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3630076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3630080">if</span>&nbsp;<span class="ident" id="3630083">n</span><span class="op" id="3630084">,</span>&nbsp;<span class="ident" id="3630086">err</span>&nbsp;<span class="op" id="3630090">:=</span>&nbsp;<span class="ident" id="3630093">parseContentLength</span><span class="op" id="3630111">(</span><span class="ident" id="3630112">t</span><span class="op" id="3630113">.</span><span class="ident" id="3630114">Header</span><span class="op" id="3630120">.</span><span class="ident" id="3630121">get</span><span class="op" id="3630124">(</span><span class="string" id="3630125">&#34;Content-Length&#34;</span><span class="op" id="3630141">)</span><span class="op" id="3630142">)</span><span class="op" id="3630143">;</span>&nbsp;<span class="ident" id="3630145">err</span>&nbsp;<span class="op" id="3630149">!=</span>&nbsp;<span class="builtintype" id="3630152">nil</span>&nbsp;<span class="op" id="3630156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3630161">return</span>&nbsp;<span class="ident" id="3630168">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3630174">}</span>&nbsp;<span class="keyword" id="3630176">else</span>&nbsp;<span class="op" id="3630181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3630186">t</span><span class="op" id="3630187">.</span><span class="ident" id="3630188">ContentLength</span>&nbsp;<span class="op" id="3630202">=</span>&nbsp;<span class="ident" id="3630204">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3630208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3630211">}</span>&nbsp;<span class="keyword" id="3630213">else</span>&nbsp;<span class="op" id="3630218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3630222">t</span><span class="op" id="3630223">.</span><span class="ident" id="3630224">ContentLength</span>&nbsp;<span class="op" id="3630238">=</span>&nbsp;<span class="ident" id="3630240">realLength</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3630252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3630256">//&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3630268">t</span><span class="op" id="3630269">.</span><span class="ident" id="3630270">Trailer</span><span class="op" id="3630277">,</span>&nbsp;<span class="ident" id="3630279">err</span>&nbsp;<span class="op" id="3630283">=</span>&nbsp;<span class="ident" id="3630285">fixTrailer</span><span class="op" id="3630295">(</span><span class="ident" id="3630296">t</span><span class="op" id="3630297">.</span><span class="ident" id="3630298">Header</span><span class="op" id="3630304">,</span>&nbsp;<span class="ident" id="3630306">t</span><span class="op" id="3630307">.</span><span class="ident" id="3630308">TransferEncoding</span><span class="op" id="3630324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3630327">if</span>&nbsp;<span class="ident" id="3630330">err</span>&nbsp;<span class="op" id="3630334">!=</span>&nbsp;<span class="builtintype" id="3630337">nil</span>&nbsp;<span class="op" id="3630341">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3630345">return</span>&nbsp;<span class="ident" id="3630352">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3630357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3630361">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;Content-Length&nbsp;or&nbsp;chunked&nbsp;Transfer-Encoding&nbsp;on&nbsp;a&nbsp;*Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3630439">//&nbsp;and&nbsp;the&nbsp;status&nbsp;is&nbsp;not&nbsp;1xx,&nbsp;204&nbsp;or&nbsp;304,&nbsp;then&nbsp;the&nbsp;body&nbsp;is&nbsp;unbounded.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3630510">//&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3630540">switch</span>&nbsp;<span class="ident" id="3630547">msg</span><span class="op" id="3630550">.</span><span class="op" id="3630551">(</span><span class="keyword" id="3630552">type</span><span class="op" id="3630556">)</span>&nbsp;<span class="op" id="3630558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3630561">case</span>&nbsp;<span class="op" id="3630566">*</span><span class="ident" id="3630567">Response</span><span class="op" id="3630575">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3630579">if</span>&nbsp;<span class="ident" id="3630582">realLength</span>&nbsp;<span class="op" id="3630593">==</span>&nbsp;<span class="op" id="3630596">-</span><span class="num" id="3630597">1</span>&nbsp;<span class="op" id="3630599">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3630605">!</span><span class="ident" id="3630606">chunked</span><span class="op" id="3630613">(</span><span class="ident" id="3630614">t</span><span class="op" id="3630615">.</span><span class="ident" id="3630616">TransferEncoding</span><span class="op" id="3630632">)</span>&nbsp;<span class="op" id="3630634">&amp;&amp;</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3630640">bodyAllowedForStatus</span><span class="op" id="3630660">(</span><span class="ident" id="3630661">t</span><span class="op" id="3630662">.</span><span class="ident" id="3630663">StatusCode</span><span class="op" id="3630673">)</span>&nbsp;<span class="op" id="3630675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3630680">//&nbsp;Unbounded&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3630702">t</span><span class="op" id="3630703">.</span><span class="ident" id="3630704">Close</span>&nbsp;<span class="op" id="3630710">=</span>&nbsp;<span class="builtintype" id="3630712">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3630719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3630722">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3630726">//&nbsp;Prepare&nbsp;body&nbsp;reader.&nbsp;&nbsp;ContentLength&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;chunked&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3630793">//&nbsp;or&nbsp;close&nbsp;connection&nbsp;when&nbsp;finished,&nbsp;since&nbsp;multipart&nbsp;is&nbsp;not&nbsp;supported&nbsp;yet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3630869">switch</span>&nbsp;<span class="op" id="3630876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3630879">case</span>&nbsp;<span class="ident" id="3630884">chunked</span><span class="op" id="3630891">(</span><span class="ident" id="3630892">t</span><span class="op" id="3630893">.</span><span class="ident" id="3630894">TransferEncoding</span><span class="op" id="3630910">)</span><span class="op" id="3630911">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3630915">if</span>&nbsp;<span class="ident" id="3630918">noBodyExpected</span><span class="op" id="3630932">(</span><span class="ident" id="3630933">t</span><span class="op" id="3630934">.</span><span class="ident" id="3630935">RequestMethod</span><span class="op" id="3630948">)</span>&nbsp;<span class="op" id="3630950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3630955">t</span><span class="op" id="3630956">.</span><span class="ident" id="3630957">Body</span>&nbsp;<span class="op" id="3630962">=</span>&nbsp;<span class="ident" id="3630964">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3630976">}</span>&nbsp;<span class="keyword" id="3630978">else</span>&nbsp;<span class="op" id="3630983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3630988">t</span><span class="op" id="3630989">.</span><span class="ident" id="3630990">Body</span>&nbsp;<span class="op" id="3630995">=</span>&nbsp;<span class="op" id="3630997">&amp;</span><span class="ident" id="3630998">body</span><span class="op" id="3631002">{</span><span class="ident" id="3631003">src</span><span class="op" id="3631006">:</span>&nbsp;<span class="ident" id="3631008">internal</span><span class="op" id="3631016">.</span><span class="ident" id="3631017">NewChunkedReader</span><span class="op" id="3631033">(</span><span class="ident" id="3631034">r</span><span class="op" id="3631035">)</span><span class="op" id="3631036">,</span>&nbsp;<span class="ident" id="3631038">hdr</span><span class="op" id="3631041">:</span>&nbsp;<span class="ident" id="3631043">msg</span><span class="op" id="3631046">,</span>&nbsp;<span class="ident" id="3631048">r</span><span class="op" id="3631049">:</span>&nbsp;<span class="ident" id="3631051">r</span><span class="op" id="3631052">,</span>&nbsp;<span class="ident" id="3631054">closing</span><span class="op" id="3631061">:</span>&nbsp;<span class="ident" id="3631063">t</span><span class="op" id="3631064">.</span><span class="ident" id="3631065">Close</span><span class="op" id="3631070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3631074">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3631077">case</span>&nbsp;<span class="ident" id="3631082">realLength</span>&nbsp;<span class="op" id="3631093">==</span>&nbsp;<span class="num" id="3631096">0</span><span class="op" id="3631097">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3631101">t</span><span class="op" id="3631102">.</span><span class="ident" id="3631103">Body</span>&nbsp;<span class="op" id="3631108">=</span>&nbsp;<span class="ident" id="3631110">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3631121">case</span>&nbsp;<span class="ident" id="3631126">realLength</span>&nbsp;<span class="op" id="3631137">&gt;</span>&nbsp;<span class="num" id="3631139">0</span><span class="op" id="3631140">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3631144">t</span><span class="op" id="3631145">.</span><span class="ident" id="3631146">Body</span>&nbsp;<span class="op" id="3631151">=</span>&nbsp;<span class="op" id="3631153">&amp;</span><span class="ident" id="3631154">body</span><span class="op" id="3631158">{</span><span class="ident" id="3631159">src</span><span class="op" id="3631162">:</span>&nbsp;<span class="ident" id="3631164">io</span><span class="op" id="3631166">.</span><span class="ident" id="3631167">LimitReader</span><span class="op" id="3631178">(</span><span class="ident" id="3631179">r</span><span class="op" id="3631180">,</span>&nbsp;<span class="ident" id="3631182">realLength</span><span class="op" id="3631192">)</span><span class="op" id="3631193">,</span>&nbsp;<span class="ident" id="3631195">closing</span><span class="op" id="3631202">:</span>&nbsp;<span class="ident" id="3631204">t</span><span class="op" id="3631205">.</span><span class="ident" id="3631206">Close</span><span class="op" id="3631211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3631214">default</span><span class="op" id="3631221">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3631225">//&nbsp;realLength&nbsp;&lt;&nbsp;0,&nbsp;i.e.&nbsp;&#34;Content-Length&#34;&nbsp;not&nbsp;mentioned&nbsp;in&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3631292">if</span>&nbsp;<span class="ident" id="3631295">t</span><span class="op" id="3631296">.</span><span class="ident" id="3631297">Close</span>&nbsp;<span class="op" id="3631303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3631308">//&nbsp;Close&nbsp;semantics&nbsp;(i.e.&nbsp;HTTP/1.0)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3631346">t</span><span class="op" id="3631347">.</span><span class="ident" id="3631348">Body</span>&nbsp;<span class="op" id="3631353">=</span>&nbsp;<span class="op" id="3631355">&amp;</span><span class="ident" id="3631356">body</span><span class="op" id="3631360">{</span><span class="ident" id="3631361">src</span><span class="op" id="3631364">:</span>&nbsp;<span class="ident" id="3631366">r</span><span class="op" id="3631367">,</span>&nbsp;<span class="ident" id="3631369">closing</span><span class="op" id="3631376">:</span>&nbsp;<span class="ident" id="3631378">t</span><span class="op" id="3631379">.</span><span class="ident" id="3631380">Close</span><span class="op" id="3631385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3631389">}</span>&nbsp;<span class="keyword" id="3631391">else</span>&nbsp;<span class="op" id="3631396">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3631401">//&nbsp;Persistent&nbsp;connection&nbsp;(i.e.&nbsp;HTTP/1.1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3631445">t</span><span class="op" id="3631446">.</span><span class="ident" id="3631447">Body</span>&nbsp;<span class="op" id="3631452">=</span>&nbsp;<span class="ident" id="3631454">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3631466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3631469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3631473">//&nbsp;Unify&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3631490">switch</span>&nbsp;<span class="ident" id="3631497">rr</span>&nbsp;<span class="op" id="3631500">:=</span>&nbsp;<span class="ident" id="3631503">msg</span><span class="op" id="3631506">.</span><span class="op" id="3631507">(</span><span class="keyword" id="3631508">type</span><span class="op" id="3631512">)</span>&nbsp;<span class="op" id="3631514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3631517">case</span>&nbsp;<span class="op" id="3631522">*</span><span class="ident" id="3631523">Request</span><span class="op" id="3631530">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3631534">rr</span><span class="op" id="3631536">.</span><span class="ident" id="3631537">Body</span>&nbsp;<span class="op" id="3631542">=</span>&nbsp;<span class="ident" id="3631544">t</span><span class="op" id="3631545">.</span><span class="ident" id="3631546">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3631553">rr</span><span class="op" id="3631555">.</span><span class="ident" id="3631556">ContentLength</span>&nbsp;<span class="op" id="3631570">=</span>&nbsp;<span class="ident" id="3631572">t</span><span class="op" id="3631573">.</span><span class="ident" id="3631574">ContentLength</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3631590">rr</span><span class="op" id="3631592">.</span><span class="ident" id="3631593">TransferEncoding</span>&nbsp;<span class="op" id="3631610">=</span>&nbsp;<span class="ident" id="3631612">t</span><span class="op" id="3631613">.</span><span class="ident" id="3631614">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3631633">rr</span><span class="op" id="3631635">.</span><span class="ident" id="3631636">Close</span>&nbsp;<span class="op" id="3631642">=</span>&nbsp;<span class="ident" id="3631644">t</span><span class="op" id="3631645">.</span><span class="ident" id="3631646">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3631654">rr</span><span class="op" id="3631656">.</span><span class="ident" id="3631657">Trailer</span>&nbsp;<span class="op" id="3631665">=</span>&nbsp;<span class="ident" id="3631667">t</span><span class="op" id="3631668">.</span><span class="ident" id="3631669">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3631678">case</span>&nbsp;<span class="op" id="3631683">*</span><span class="ident" id="3631684">Response</span><span class="op" id="3631692">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3631696">rr</span><span class="op" id="3631698">.</span><span class="ident" id="3631699">Body</span>&nbsp;<span class="op" id="3631704">=</span>&nbsp;<span class="ident" id="3631706">t</span><span class="op" id="3631707">.</span><span class="ident" id="3631708">Body</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3631715">rr</span><span class="op" id="3631717">.</span><span class="ident" id="3631718">ContentLength</span>&nbsp;<span class="op" id="3631732">=</span>&nbsp;<span class="ident" id="3631734">t</span><span class="op" id="3631735">.</span><span class="ident" id="3631736">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3631752">rr</span><span class="op" id="3631754">.</span><span class="ident" id="3631755">TransferEncoding</span>&nbsp;<span class="op" id="3631772">=</span>&nbsp;<span class="ident" id="3631774">t</span><span class="op" id="3631775">.</span><span class="ident" id="3631776">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3631795">rr</span><span class="op" id="3631797">.</span><span class="ident" id="3631798">Close</span>&nbsp;<span class="op" id="3631804">=</span>&nbsp;<span class="ident" id="3631806">t</span><span class="op" id="3631807">.</span><span class="ident" id="3631808">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3631816">rr</span><span class="op" id="3631818">.</span><span class="ident" id="3631819">Trailer</span>&nbsp;<span class="op" id="3631827">=</span>&nbsp;<span class="ident" id="3631829">t</span><span class="op" id="3631830">.</span><span class="ident" id="3631831">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3631840">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3631844">return</span>&nbsp;<span class="builtintype" id="3631851">nil</span><br>
<span class="lineno"></span><span class="op" id="3631855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3631858">//&nbsp;Checks&nbsp;whether&nbsp;chunked&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;encodings&nbsp;stack</span><br>
<span class="lineno">410</span><span class="keyword" id="3631915">func</span>&nbsp;<span class="ident" id="3631920">chunked</span><span class="op" id="3631927">(</span><span class="ident" id="3631928">te</span>&nbsp;<span class="op" id="3631931">[</span><span class="op" id="3631932">]</span><span class="builtintype" id="3631933">string</span><span class="op" id="3631939">)</span>&nbsp;<span class="builtintype" id="3631941">bool</span>&nbsp;<span class="op" id="3631946">{</span>&nbsp;<span class="keyword" id="3631948">return</span>&nbsp;<span class="builtinfunc" id="3631955">len</span><span class="op" id="3631958">(</span><span class="ident" id="3631959">te</span><span class="op" id="3631961">)</span>&nbsp;<span class="op" id="3631963">&gt;</span>&nbsp;<span class="num" id="3631965">0</span>&nbsp;<span class="op" id="3631967">&amp;&amp;</span>&nbsp;<span class="ident" id="3631970">te</span><span class="op" id="3631972">[</span><span class="num" id="3631973">0</span><span class="op" id="3631974">]</span>&nbsp;<span class="op" id="3631976">==</span>&nbsp;<span class="string" id="3631979">&#34;chunked&#34;</span>&nbsp;<span class="op" id="3631989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3631992">//&nbsp;Checks&nbsp;whether&nbsp;the&nbsp;encoding&nbsp;is&nbsp;explicitly&nbsp;&#34;identity&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3632049">func</span>&nbsp;<span class="ident" id="3632054">isIdentity</span><span class="op" id="3632064">(</span><span class="ident" id="3632065">te</span>&nbsp;<span class="op" id="3632068">[</span><span class="op" id="3632069">]</span><span class="builtintype" id="3632070">string</span><span class="op" id="3632076">)</span>&nbsp;<span class="builtintype" id="3632078">bool</span>&nbsp;<span class="op" id="3632083">{</span>&nbsp;<span class="keyword" id="3632085">return</span>&nbsp;<span class="builtinfunc" id="3632092">len</span><span class="op" id="3632095">(</span><span class="ident" id="3632096">te</span><span class="op" id="3632098">)</span>&nbsp;<span class="op" id="3632100">==</span>&nbsp;<span class="num" id="3632103">1</span>&nbsp;<span class="op" id="3632105">&amp;&amp;</span>&nbsp;<span class="ident" id="3632108">te</span><span class="op" id="3632110">[</span><span class="num" id="3632111">0</span><span class="op" id="3632112">]</span>&nbsp;<span class="op" id="3632114">==</span>&nbsp;<span class="string" id="3632117">&#34;identity&#34;</span>&nbsp;<span class="op" id="3632128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3632131">//&nbsp;Sanitize&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno"></span><span class="keyword" id="3632161">func</span>&nbsp;<span class="ident" id="3632166">fixTransferEncoding</span><span class="op" id="3632185">(</span><span class="ident" id="3632186">requestMethod</span>&nbsp;<span class="builtintype" id="3632200">string</span><span class="op" id="3632206">,</span>&nbsp;<span class="ident" id="3632208">header</span>&nbsp;<span class="ident" id="3632215">Header</span><span class="op" id="3632221">)</span>&nbsp;<span class="op" id="3632223">(</span><span class="op" id="3632224">[</span><span class="op" id="3632225">]</span><span class="builtintype" id="3632226">string</span><span class="op" id="3632232">,</span>&nbsp;<span class="builtintype" id="3632234">error</span><span class="op" id="3632239">)</span>&nbsp;<span class="op" id="3632241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3632244">raw</span><span class="op" id="3632247">,</span>&nbsp;<span class="ident" id="3632249">present</span>&nbsp;<span class="op" id="3632257">:=</span>&nbsp;<span class="ident" id="3632260">header</span><span class="op" id="3632266">[</span><span class="string" id="3632267">&#34;Transfer-Encoding&#34;</span><span class="op" id="3632286">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3632289">if</span>&nbsp;<span class="op" id="3632292">!</span><span class="ident" id="3632293">present</span>&nbsp;<span class="op" id="3632301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3632305">return</span>&nbsp;<span class="builtintype" id="3632312">nil</span><span class="op" id="3632315">,</span>&nbsp;<span class="builtintype" id="3632317">nil</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3632322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3632326">delete</span><span class="op" id="3632332">(</span><span class="ident" id="3632333">header</span><span class="op" id="3632339">,</span>&nbsp;<span class="string" id="3632341">&#34;Transfer-Encoding&#34;</span><span class="op" id="3632360">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3632364">encodings</span>&nbsp;<span class="op" id="3632374">:=</span>&nbsp;<span class="ident" id="3632377">strings</span><span class="op" id="3632384">.</span><span class="ident" id="3632385">Split</span><span class="op" id="3632390">(</span><span class="ident" id="3632391">raw</span><span class="op" id="3632394">[</span><span class="num" id="3632395">0</span><span class="op" id="3632396">]</span><span class="op" id="3632397">,</span>&nbsp;<span class="string" id="3632399">&#34;,&#34;</span><span class="op" id="3632402">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3632405">te</span>&nbsp;<span class="op" id="3632408">:=</span>&nbsp;<span class="builtinfunc" id="3632411">make</span><span class="op" id="3632415">(</span><span class="op" id="3632416">[</span><span class="op" id="3632417">]</span><span class="builtintype" id="3632418">string</span><span class="op" id="3632424">,</span>&nbsp;<span class="num" id="3632426">0</span><span class="op" id="3632427">,</span>&nbsp;<span class="builtinfunc" id="3632429">len</span><span class="op" id="3632432">(</span><span class="ident" id="3632433">encodings</span><span class="op" id="3632442">)</span><span class="op" id="3632443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3632446">//&nbsp;TODO:&nbsp;Even&nbsp;though&nbsp;we&nbsp;only&nbsp;support&nbsp;&#34;identity&#34;&nbsp;and&nbsp;&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3632509">//&nbsp;encodings,&nbsp;the&nbsp;loop&nbsp;below&nbsp;is&nbsp;designed&nbsp;with&nbsp;foresight.&nbsp;One</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3632571">//&nbsp;invariant&nbsp;that&nbsp;must&nbsp;be&nbsp;maintained&nbsp;is&nbsp;that,&nbsp;if&nbsp;present,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3632630">//&nbsp;chunked&nbsp;encoding&nbsp;must&nbsp;always&nbsp;come&nbsp;first.</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3632675">for</span>&nbsp;<span class="ident" id="3632679">_</span><span class="op" id="3632680">,</span>&nbsp;<span class="ident" id="3632682">encoding</span>&nbsp;<span class="op" id="3632691">:=</span>&nbsp;<span class="keyword" id="3632694">range</span>&nbsp;<span class="ident" id="3632700">encodings</span>&nbsp;<span class="op" id="3632710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3632714">encoding</span>&nbsp;<span class="op" id="3632723">=</span>&nbsp;<span class="ident" id="3632725">strings</span><span class="op" id="3632732">.</span><span class="ident" id="3632733">ToLower</span><span class="op" id="3632740">(</span><span class="ident" id="3632741">strings</span><span class="op" id="3632748">.</span><span class="ident" id="3632749">TrimSpace</span><span class="op" id="3632758">(</span><span class="ident" id="3632759">encoding</span><span class="op" id="3632767">)</span><span class="op" id="3632768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3632772">//&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;not&nbsp;recorded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3632813">if</span>&nbsp;<span class="ident" id="3632816">encoding</span>&nbsp;<span class="op" id="3632825">==</span>&nbsp;<span class="string" id="3632828">&#34;identity&#34;</span>&nbsp;<span class="op" id="3632839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3632844">break</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3632852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3632856">if</span>&nbsp;<span class="ident" id="3632859">encoding</span>&nbsp;<span class="op" id="3632868">!=</span>&nbsp;<span class="string" id="3632871">&#34;chunked&#34;</span>&nbsp;<span class="op" id="3632881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3632886">return</span>&nbsp;<span class="builtintype" id="3632893">nil</span><span class="op" id="3632896">,</span>&nbsp;<span class="op" id="3632898">&amp;</span><span class="ident" id="3632899">badStringError</span><span class="op" id="3632913">{</span><span class="string" id="3632914">&#34;unsupported&nbsp;transfer&nbsp;encoding&#34;</span><span class="op" id="3632945">,</span>&nbsp;<span class="ident" id="3632947">encoding</span><span class="op" id="3632955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3632959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3632963">te</span>&nbsp;<span class="op" id="3632966">=</span>&nbsp;<span class="ident" id="3632968">te</span><span class="op" id="3632970">[</span><span class="num" id="3632971">0</span>&nbsp;<span class="op" id="3632973">:</span>&nbsp;<span class="builtinfunc" id="3632975">len</span><span class="op" id="3632978">(</span><span class="ident" id="3632979">te</span><span class="op" id="3632981">)</span><span class="op" id="3632982">+</span><span class="num" id="3632983">1</span><span class="op" id="3632984">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3632988">te</span><span class="op" id="3632990">[</span><span class="builtinfunc" id="3632991">len</span><span class="op" id="3632994">(</span><span class="ident" id="3632995">te</span><span class="op" id="3632997">)</span><span class="op" id="3632998">-</span><span class="num" id="3632999">1</span><span class="op" id="3633000">]</span>&nbsp;<span class="op" id="3633002">=</span>&nbsp;<span class="ident" id="3633004">encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3633014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3633017">if</span>&nbsp;<span class="builtinfunc" id="3633020">len</span><span class="op" id="3633023">(</span><span class="ident" id="3633024">te</span><span class="op" id="3633026">)</span>&nbsp;<span class="op" id="3633028">&gt;</span>&nbsp;<span class="num" id="3633030">1</span>&nbsp;<span class="op" id="3633032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3633036">return</span>&nbsp;<span class="builtintype" id="3633043">nil</span><span class="op" id="3633046">,</span>&nbsp;<span class="op" id="3633048">&amp;</span><span class="ident" id="3633049">badStringError</span><span class="op" id="3633063">{</span><span class="string" id="3633064">&#34;too&nbsp;many&nbsp;transfer&nbsp;encodings&#34;</span><span class="op" id="3633093">,</span>&nbsp;<span class="ident" id="3633095">strings</span><span class="op" id="3633102">.</span><span class="ident" id="3633103">Join</span><span class="op" id="3633107">(</span><span class="ident" id="3633108">te</span><span class="op" id="3633110">,</span>&nbsp;<span class="string" id="3633112">&#34;,&#34;</span><span class="op" id="3633115">)</span><span class="op" id="3633116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3633119">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3633122">if</span>&nbsp;<span class="builtinfunc" id="3633125">len</span><span class="op" id="3633128">(</span><span class="ident" id="3633129">te</span><span class="op" id="3633131">)</span>&nbsp;<span class="op" id="3633133">&gt;</span>&nbsp;<span class="num" id="3633135">0</span>&nbsp;<span class="op" id="3633137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3633141">//&nbsp;Chunked&nbsp;encoding&nbsp;trumps&nbsp;Content-Length.&nbsp;See&nbsp;RFC&nbsp;2616</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3633199">//&nbsp;Section&nbsp;4.4.&nbsp;Currently&nbsp;len(te)&nbsp;&gt;&nbsp;0&nbsp;implies&nbsp;chunked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3633255">//&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3633270">delete</span><span class="op" id="3633276">(</span><span class="ident" id="3633277">header</span><span class="op" id="3633283">,</span>&nbsp;<span class="string" id="3633285">&#34;Content-Length&#34;</span><span class="op" id="3633301">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3633305">return</span>&nbsp;<span class="ident" id="3633312">te</span><span class="op" id="3633314">,</span>&nbsp;<span class="builtintype" id="3633316">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3633321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3633325">return</span>&nbsp;<span class="builtintype" id="3633332">nil</span><span class="op" id="3633335">,</span>&nbsp;<span class="builtintype" id="3633337">nil</span><br>
<span class="lineno"></span><span class="op" id="3633341">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="3633344">//&nbsp;Determine&nbsp;the&nbsp;expected&nbsp;body&nbsp;length,&nbsp;using&nbsp;RFC&nbsp;2616&nbsp;Section&nbsp;4.4.&nbsp;This</span><br>
<span class="lineno"></span><span class="comment" id="3633416">//&nbsp;function&nbsp;is&nbsp;not&nbsp;a&nbsp;method,&nbsp;because&nbsp;ultimately&nbsp;it&nbsp;should&nbsp;be&nbsp;shared&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3633487">//&nbsp;ReadResponse&nbsp;and&nbsp;ReadRequest.</span><br>
<span class="lineno"></span><span class="keyword" id="3633520">func</span>&nbsp;<span class="ident" id="3633525">fixLength</span><span class="op" id="3633534">(</span><span class="ident" id="3633535">isResponse</span>&nbsp;<span class="builtintype" id="3633546">bool</span><span class="op" id="3633550">,</span>&nbsp;<span class="ident" id="3633552">status</span>&nbsp;<span class="builtintype" id="3633559">int</span><span class="op" id="3633562">,</span>&nbsp;<span class="ident" id="3633564">requestMethod</span>&nbsp;<span class="builtintype" id="3633578">string</span><span class="op" id="3633584">,</span>&nbsp;<span class="ident" id="3633586">header</span>&nbsp;<span class="ident" id="3633593">Header</span><span class="op" id="3633599">,</span>&nbsp;<span class="ident" id="3633601">te</span>&nbsp;<span class="op" id="3633604">[</span><span class="op" id="3633605">]</span><span class="builtintype" id="3633606">string</span><span class="op" id="3633612">)</span>&nbsp;<span class="op" id="3633614">(</span><span class="builtintype" id="3633615">int64</span><span class="op" id="3633620">,</span>&nbsp;<span class="builtintype" id="3633622">error</span><span class="op" id="3633627">)</span>&nbsp;<span class="op" id="3633629">{</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3633633">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;response&nbsp;type&nbsp;or&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3633676">if</span>&nbsp;<span class="ident" id="3633679">noBodyExpected</span><span class="op" id="3633693">(</span><span class="ident" id="3633694">requestMethod</span><span class="op" id="3633707">)</span>&nbsp;<span class="op" id="3633709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3633713">return</span>&nbsp;<span class="num" id="3633720">0</span><span class="op" id="3633721">,</span>&nbsp;<span class="builtintype" id="3633723">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3633728">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3633731">if</span>&nbsp;<span class="ident" id="3633734">status</span><span class="op" id="3633740">/</span><span class="num" id="3633741">100</span>&nbsp;<span class="op" id="3633745">==</span>&nbsp;<span class="num" id="3633748">1</span>&nbsp;<span class="op" id="3633750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3633754">return</span>&nbsp;<span class="num" id="3633761">0</span><span class="op" id="3633762">,</span>&nbsp;<span class="builtintype" id="3633764">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3633769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3633772">switch</span>&nbsp;<span class="ident" id="3633779">status</span>&nbsp;<span class="op" id="3633786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3633789">case</span>&nbsp;<span class="num" id="3633794">204</span><span class="op" id="3633797">,</span>&nbsp;<span class="num" id="3633799">304</span><span class="op" id="3633802">:</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3633806">return</span>&nbsp;<span class="num" id="3633813">0</span><span class="op" id="3633814">,</span>&nbsp;<span class="builtintype" id="3633816">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3633821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3633825">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3633862">if</span>&nbsp;<span class="ident" id="3633865">chunked</span><span class="op" id="3633872">(</span><span class="ident" id="3633873">te</span><span class="op" id="3633875">)</span>&nbsp;<span class="op" id="3633877">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3633881">return</span>&nbsp;<span class="op" id="3633888">-</span><span class="num" id="3633889">1</span><span class="op" id="3633890">,</span>&nbsp;<span class="builtintype" id="3633892">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3633897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3633901">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3633935">cl</span>&nbsp;<span class="op" id="3633938">:=</span>&nbsp;<span class="ident" id="3633941">strings</span><span class="op" id="3633948">.</span><span class="ident" id="3633949">TrimSpace</span><span class="op" id="3633958">(</span><span class="ident" id="3633959">header</span><span class="op" id="3633965">.</span><span class="ident" id="3633966">get</span><span class="op" id="3633969">(</span><span class="string" id="3633970">&#34;Content-Length&#34;</span><span class="op" id="3633986">)</span><span class="op" id="3633987">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3633990">if</span>&nbsp;<span class="ident" id="3633993">cl</span>&nbsp;<span class="op" id="3633996">!=</span>&nbsp;<span class="string" id="3633999">&#34;&#34;</span>&nbsp;<span class="op" id="3634002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3634006">n</span><span class="op" id="3634007">,</span>&nbsp;<span class="ident" id="3634009">err</span>&nbsp;<span class="op" id="3634013">:=</span>&nbsp;<span class="ident" id="3634016">parseContentLength</span><span class="op" id="3634034">(</span><span class="ident" id="3634035">cl</span><span class="op" id="3634037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3634041">if</span>&nbsp;<span class="ident" id="3634044">err</span>&nbsp;<span class="op" id="3634048">!=</span>&nbsp;<span class="builtintype" id="3634051">nil</span>&nbsp;<span class="op" id="3634055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3634060">return</span>&nbsp;<span class="op" id="3634067">-</span><span class="num" id="3634068">1</span><span class="op" id="3634069">,</span>&nbsp;<span class="ident" id="3634071">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3634077">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3634081">return</span>&nbsp;<span class="ident" id="3634088">n</span><span class="op" id="3634089">,</span>&nbsp;<span class="builtintype" id="3634091">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3634096">}</span>&nbsp;<span class="keyword" id="3634098">else</span>&nbsp;<span class="op" id="3634103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3634107">header</span><span class="op" id="3634113">.</span><span class="ident" id="3634114">Del</span><span class="op" id="3634117">(</span><span class="string" id="3634118">&#34;Content-Length&#34;</span><span class="op" id="3634134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3634137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3634141">if</span>&nbsp;<span class="op" id="3634144">!</span><span class="ident" id="3634145">isResponse</span>&nbsp;<span class="op" id="3634156">&amp;&amp;</span>&nbsp;<span class="ident" id="3634159">requestMethod</span>&nbsp;<span class="op" id="3634173">==</span>&nbsp;<span class="string" id="3634176">&#34;GET&#34;</span>&nbsp;<span class="op" id="3634182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3634186">//&nbsp;RFC&nbsp;2616&nbsp;doesn&#39;t&nbsp;explicitly&nbsp;permit&nbsp;nor&nbsp;forbid&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3634240">//&nbsp;entity-body&nbsp;on&nbsp;a&nbsp;GET&nbsp;request&nbsp;so&nbsp;we&nbsp;permit&nbsp;one&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3634294">//&nbsp;declared,&nbsp;but&nbsp;we&nbsp;default&nbsp;to&nbsp;0&nbsp;here&nbsp;(not&nbsp;-1&nbsp;below)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3634349">//&nbsp;if&nbsp;there&#39;s&nbsp;no&nbsp;mention&nbsp;of&nbsp;a&nbsp;body.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3634387">return</span>&nbsp;<span class="num" id="3634394">0</span><span class="op" id="3634395">,</span>&nbsp;<span class="builtintype" id="3634397">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3634402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3634406">//&nbsp;Body-EOF&nbsp;logic&nbsp;based&nbsp;on&nbsp;other&nbsp;methods&nbsp;(like&nbsp;closing,&nbsp;or&nbsp;chunked&nbsp;coding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3634482">return</span>&nbsp;<span class="op" id="3634489">-</span><span class="num" id="3634490">1</span><span class="op" id="3634491">,</span>&nbsp;<span class="builtintype" id="3634493">nil</span><br>
<span class="lineno">500</span><span class="op" id="3634497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3634500">//&nbsp;Determine&nbsp;whether&nbsp;to&nbsp;hang&nbsp;up&nbsp;after&nbsp;sending&nbsp;a&nbsp;request&nbsp;and&nbsp;body,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3634569">//&nbsp;receiving&nbsp;a&nbsp;response&nbsp;and&nbsp;body</span><br>
<span class="lineno"></span><span class="comment" id="3634602">//&nbsp;&#39;header&#39;&nbsp;is&nbsp;the&nbsp;request&nbsp;headers</span><br>
<span class="lineno">505</span><span class="keyword" id="3634637">func</span>&nbsp;<span class="ident" id="3634642">shouldClose</span><span class="op" id="3634653">(</span><span class="ident" id="3634654">major</span><span class="op" id="3634659">,</span>&nbsp;<span class="ident" id="3634661">minor</span>&nbsp;<span class="builtintype" id="3634667">int</span><span class="op" id="3634670">,</span>&nbsp;<span class="ident" id="3634672">header</span>&nbsp;<span class="ident" id="3634679">Header</span><span class="op" id="3634685">,</span>&nbsp;<span class="ident" id="3634687">removeCloseHeader</span>&nbsp;<span class="builtintype" id="3634705">bool</span><span class="op" id="3634709">)</span>&nbsp;<span class="builtintype" id="3634711">bool</span>&nbsp;<span class="op" id="3634716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3634719">if</span>&nbsp;<span class="ident" id="3634722">major</span>&nbsp;<span class="op" id="3634728">&lt;</span>&nbsp;<span class="num" id="3634730">1</span>&nbsp;<span class="op" id="3634732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3634736">return</span>&nbsp;<span class="builtintype" id="3634743">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3634749">}</span>&nbsp;<span class="keyword" id="3634751">else</span>&nbsp;<span class="keyword" id="3634756">if</span>&nbsp;<span class="ident" id="3634759">major</span>&nbsp;<span class="op" id="3634765">==</span>&nbsp;<span class="num" id="3634768">1</span>&nbsp;<span class="op" id="3634770">&amp;&amp;</span>&nbsp;<span class="ident" id="3634773">minor</span>&nbsp;<span class="op" id="3634779">==</span>&nbsp;<span class="num" id="3634782">0</span>&nbsp;<span class="op" id="3634784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3634788">if</span>&nbsp;<span class="op" id="3634791">!</span><span class="ident" id="3634792">strings</span><span class="op" id="3634799">.</span><span class="ident" id="3634800">Contains</span><span class="op" id="3634808">(</span><span class="ident" id="3634809">strings</span><span class="op" id="3634816">.</span><span class="ident" id="3634817">ToLower</span><span class="op" id="3634824">(</span><span class="ident" id="3634825">header</span><span class="op" id="3634831">.</span><span class="ident" id="3634832">get</span><span class="op" id="3634835">(</span><span class="string" id="3634836">&#34;Connection&#34;</span><span class="op" id="3634848">)</span><span class="op" id="3634849">)</span><span class="op" id="3634850">,</span>&nbsp;<span class="string" id="3634852">&#34;keep-alive&#34;</span><span class="op" id="3634864">)</span>&nbsp;<span class="op" id="3634866">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3634871">return</span>&nbsp;<span class="builtintype" id="3634878">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3634885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3634889">return</span>&nbsp;<span class="builtintype" id="3634896">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3634903">}</span>&nbsp;<span class="keyword" id="3634905">else</span>&nbsp;<span class="op" id="3634910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3634914">//&nbsp;TODO:&nbsp;Should&nbsp;split&nbsp;on&nbsp;commas,&nbsp;toss&nbsp;surrounding&nbsp;white&nbsp;space,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3634979">//&nbsp;and&nbsp;check&nbsp;each&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3635006">if</span>&nbsp;<span class="ident" id="3635009">strings</span><span class="op" id="3635016">.</span><span class="ident" id="3635017">ToLower</span><span class="op" id="3635024">(</span><span class="ident" id="3635025">header</span><span class="op" id="3635031">.</span><span class="ident" id="3635032">get</span><span class="op" id="3635035">(</span><span class="string" id="3635036">&#34;Connection&#34;</span><span class="op" id="3635048">)</span><span class="op" id="3635049">)</span>&nbsp;<span class="op" id="3635051">==</span>&nbsp;<span class="string" id="3635054">&#34;close&#34;</span>&nbsp;<span class="op" id="3635062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3635067">if</span>&nbsp;<span class="ident" id="3635070">removeCloseHeader</span>&nbsp;<span class="op" id="3635088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635094">header</span><span class="op" id="3635100">.</span><span class="ident" id="3635101">Del</span><span class="op" id="3635104">(</span><span class="string" id="3635105">&#34;Connection&#34;</span><span class="op" id="3635117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3635122">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3635127">return</span>&nbsp;<span class="builtintype" id="3635134">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3635141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3635144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3635147">return</span>&nbsp;<span class="builtintype" id="3635154">false</span><br>
<span class="lineno"></span><span class="op" id="3635160">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="comment" id="3635163">//&nbsp;Parse&nbsp;the&nbsp;trailer&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="3635191">func</span>&nbsp;<span class="ident" id="3635196">fixTrailer</span><span class="op" id="3635206">(</span><span class="ident" id="3635207">header</span>&nbsp;<span class="ident" id="3635214">Header</span><span class="op" id="3635220">,</span>&nbsp;<span class="ident" id="3635222">te</span>&nbsp;<span class="op" id="3635225">[</span><span class="op" id="3635226">]</span><span class="builtintype" id="3635227">string</span><span class="op" id="3635233">)</span>&nbsp;<span class="op" id="3635235">(</span><span class="ident" id="3635236">Header</span><span class="op" id="3635242">,</span>&nbsp;<span class="builtintype" id="3635244">error</span><span class="op" id="3635249">)</span>&nbsp;<span class="op" id="3635251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635254">raw</span>&nbsp;<span class="op" id="3635258">:=</span>&nbsp;<span class="ident" id="3635261">header</span><span class="op" id="3635267">.</span><span class="ident" id="3635268">get</span><span class="op" id="3635271">(</span><span class="string" id="3635272">&#34;Trailer&#34;</span><span class="op" id="3635281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3635284">if</span>&nbsp;<span class="ident" id="3635287">raw</span>&nbsp;<span class="op" id="3635291">==</span>&nbsp;<span class="string" id="3635294">&#34;&#34;</span>&nbsp;<span class="op" id="3635297">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3635301">return</span>&nbsp;<span class="builtintype" id="3635308">nil</span><span class="op" id="3635311">,</span>&nbsp;<span class="builtintype" id="3635313">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3635318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635322">header</span><span class="op" id="3635328">.</span><span class="ident" id="3635329">Del</span><span class="op" id="3635332">(</span><span class="string" id="3635333">&#34;Trailer&#34;</span><span class="op" id="3635342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635345">trailer</span>&nbsp;<span class="op" id="3635353">:=</span>&nbsp;<span class="builtinfunc" id="3635356">make</span><span class="op" id="3635360">(</span><span class="ident" id="3635361">Header</span><span class="op" id="3635367">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635370">keys</span>&nbsp;<span class="op" id="3635375">:=</span>&nbsp;<span class="ident" id="3635378">strings</span><span class="op" id="3635385">.</span><span class="ident" id="3635386">Split</span><span class="op" id="3635391">(</span><span class="ident" id="3635392">raw</span><span class="op" id="3635395">,</span>&nbsp;<span class="string" id="3635397">&#34;,&#34;</span><span class="op" id="3635400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3635403">for</span>&nbsp;<span class="ident" id="3635407">_</span><span class="op" id="3635408">,</span>&nbsp;<span class="ident" id="3635410">key</span>&nbsp;<span class="op" id="3635414">:=</span>&nbsp;<span class="keyword" id="3635417">range</span>&nbsp;<span class="ident" id="3635423">keys</span>&nbsp;<span class="op" id="3635428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635432">key</span>&nbsp;<span class="op" id="3635436">=</span>&nbsp;<span class="ident" id="3635438">CanonicalHeaderKey</span><span class="op" id="3635456">(</span><span class="ident" id="3635457">strings</span><span class="op" id="3635464">.</span><span class="ident" id="3635465">TrimSpace</span><span class="op" id="3635474">(</span><span class="ident" id="3635475">key</span><span class="op" id="3635478">)</span><span class="op" id="3635479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3635483">switch</span>&nbsp;<span class="ident" id="3635490">key</span>&nbsp;<span class="op" id="3635494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3635498">case</span>&nbsp;<span class="string" id="3635503">&#34;Transfer-Encoding&#34;</span><span class="op" id="3635522">,</span>&nbsp;<span class="string" id="3635524">&#34;Trailer&#34;</span><span class="op" id="3635533">,</span>&nbsp;<span class="string" id="3635535">&#34;Content-Length&#34;</span><span class="op" id="3635551">:</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3635556">return</span>&nbsp;<span class="builtintype" id="3635563">nil</span><span class="op" id="3635566">,</span>&nbsp;<span class="op" id="3635568">&amp;</span><span class="ident" id="3635569">badStringError</span><span class="op" id="3635583">{</span><span class="string" id="3635584">&#34;bad&nbsp;trailer&nbsp;key&#34;</span><span class="op" id="3635601">,</span>&nbsp;<span class="ident" id="3635603">key</span><span class="op" id="3635606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3635610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635614">trailer</span><span class="op" id="3635621">[</span><span class="ident" id="3635622">key</span><span class="op" id="3635625">]</span>&nbsp;<span class="op" id="3635627">=</span>&nbsp;<span class="builtintype" id="3635629">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3635634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3635637">if</span>&nbsp;<span class="builtinfunc" id="3635640">len</span><span class="op" id="3635643">(</span><span class="ident" id="3635644">trailer</span><span class="op" id="3635651">)</span>&nbsp;<span class="op" id="3635653">==</span>&nbsp;<span class="num" id="3635656">0</span>&nbsp;<span class="op" id="3635658">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3635662">return</span>&nbsp;<span class="builtintype" id="3635669">nil</span><span class="op" id="3635672">,</span>&nbsp;<span class="builtintype" id="3635674">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3635679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3635682">if</span>&nbsp;<span class="op" id="3635685">!</span><span class="ident" id="3635686">chunked</span><span class="op" id="3635693">(</span><span class="ident" id="3635694">te</span><span class="op" id="3635696">)</span>&nbsp;<span class="op" id="3635698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3635702">//&nbsp;Trailer&nbsp;and&nbsp;no&nbsp;chunking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3635731">return</span>&nbsp;<span class="builtintype" id="3635738">nil</span><span class="op" id="3635741">,</span>&nbsp;<span class="ident" id="3635743">ErrUnexpectedTrailer</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3635765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3635768">return</span>&nbsp;<span class="ident" id="3635775">trailer</span><span class="op" id="3635782">,</span>&nbsp;<span class="builtintype" id="3635784">nil</span><br>
<span class="lineno"></span><span class="op" id="3635788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3635791">//&nbsp;body&nbsp;turns&nbsp;a&nbsp;Reader&nbsp;into&nbsp;a&nbsp;ReadCloser.</span><br>
<span class="lineno">555</span><span class="comment" id="3635833">//&nbsp;Close&nbsp;ensures&nbsp;that&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;fully&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="3635884">//&nbsp;and&nbsp;then&nbsp;reads&nbsp;the&nbsp;trailer&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3635928">type</span>&nbsp;<span class="ident" id="3635933">body</span>&nbsp;<span class="keyword" id="3635938">struct</span>&nbsp;<span class="op" id="3635945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635948">src</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635956">io</span><span class="op" id="3635958">.</span><span class="ident" id="3635959">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635967">hdr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3635975">interface</span><span class="op" id="3635984">{</span><span class="op" id="3635985">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3635989">//&nbsp;non-nil&nbsp;(Response&nbsp;or&nbsp;Request)&nbsp;value&nbsp;means&nbsp;read&nbsp;trailer</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636048">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3636056">*</span><span class="ident" id="3636057">bufio</span><span class="op" id="3636062">.</span><span class="ident" id="3636063">Reader</span>&nbsp;<span class="comment" id="3636070">//&nbsp;underlying&nbsp;wire-format&nbsp;reader&nbsp;for&nbsp;the&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636120">closing</span>&nbsp;<span class="builtintype" id="3636128">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3636142">//&nbsp;is&nbsp;the&nbsp;connection&nbsp;to&nbsp;be&nbsp;closed&nbsp;after&nbsp;reading&nbsp;body?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636198">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636205">sync</span><span class="op" id="3636209">.</span><span class="ident" id="3636210">Mutex</span>&nbsp;<span class="comment" id="3636216">//&nbsp;guards&nbsp;closed,&nbsp;and&nbsp;calls&nbsp;to&nbsp;Read&nbsp;and&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636263">closed</span>&nbsp;<span class="builtintype" id="3636270">bool</span><br>
<span class="lineno">565</span><span class="op" id="3636275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3636278">//&nbsp;ErrBodyReadAfterClose&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;a&nbsp;Request&nbsp;or&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="3636350">//&nbsp;Body&nbsp;after&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;closed.&nbsp;This&nbsp;typically&nbsp;happens&nbsp;when&nbsp;the&nbsp;body&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3636430">//&nbsp;read&nbsp;after&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;calls&nbsp;WriteHeader&nbsp;or&nbsp;Write&nbsp;on&nbsp;its</span><br>
<span class="lineno">570</span><span class="comment" id="3636494">//&nbsp;ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="3636513">var</span>&nbsp;<span class="ident" id="3636517">ErrBodyReadAfterClose</span>&nbsp;<span class="op" id="3636539">=</span>&nbsp;<span class="ident" id="3636541">errors</span><span class="op" id="3636547">.</span><span class="ident" id="3636548">New</span><span class="op" id="3636551">(</span><span class="string" id="3636552">&#34;http:&nbsp;invalid&nbsp;Read&nbsp;on&nbsp;closed&nbsp;Body&#34;</span><span class="op" id="3636587">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3636590">func</span>&nbsp;<span class="op" id="3636595">(</span><span class="ident" id="3636596">b</span>&nbsp;<span class="op" id="3636598">*</span><span class="ident" id="3636599">body</span><span class="op" id="3636603">)</span>&nbsp;<span class="ident" id="3636605">Read</span><span class="op" id="3636609">(</span><span class="ident" id="3636610">p</span>&nbsp;<span class="op" id="3636612">[</span><span class="op" id="3636613">]</span><span class="builtintype" id="3636614">byte</span><span class="op" id="3636618">)</span>&nbsp;<span class="op" id="3636620">(</span><span class="ident" id="3636621">n</span>&nbsp;<span class="builtintype" id="3636623">int</span><span class="op" id="3636626">,</span>&nbsp;<span class="ident" id="3636628">err</span>&nbsp;<span class="builtintype" id="3636632">error</span><span class="op" id="3636637">)</span>&nbsp;<span class="op" id="3636639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636642">b</span><span class="op" id="3636643">.</span><span class="ident" id="3636644">mu</span><span class="op" id="3636646">.</span><span class="ident" id="3636647">Lock</span><span class="op" id="3636651">(</span><span class="op" id="3636652">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3636655">defer</span>&nbsp;<span class="ident" id="3636661">b</span><span class="op" id="3636662">.</span><span class="ident" id="3636663">mu</span><span class="op" id="3636665">.</span><span class="ident" id="3636666">Unlock</span><span class="op" id="3636672">(</span><span class="op" id="3636673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3636676">if</span>&nbsp;<span class="ident" id="3636679">b</span><span class="op" id="3636680">.</span><span class="ident" id="3636681">closed</span>&nbsp;<span class="op" id="3636688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3636692">return</span>&nbsp;<span class="num" id="3636699">0</span><span class="op" id="3636700">,</span>&nbsp;<span class="ident" id="3636702">ErrBodyReadAfterClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3636725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3636728">return</span>&nbsp;<span class="ident" id="3636735">b</span><span class="op" id="3636736">.</span><span class="ident" id="3636737">readLocked</span><span class="op" id="3636747">(</span><span class="ident" id="3636748">p</span><span class="op" id="3636749">)</span><br>
<span class="lineno">580</span><span class="op" id="3636751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3636754">//&nbsp;Must&nbsp;hold&nbsp;b.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="3636773">func</span>&nbsp;<span class="op" id="3636778">(</span><span class="ident" id="3636779">b</span>&nbsp;<span class="op" id="3636781">*</span><span class="ident" id="3636782">body</span><span class="op" id="3636786">)</span>&nbsp;<span class="ident" id="3636788">readLocked</span><span class="op" id="3636798">(</span><span class="ident" id="3636799">p</span>&nbsp;<span class="op" id="3636801">[</span><span class="op" id="3636802">]</span><span class="builtintype" id="3636803">byte</span><span class="op" id="3636807">)</span>&nbsp;<span class="op" id="3636809">(</span><span class="ident" id="3636810">n</span>&nbsp;<span class="builtintype" id="3636812">int</span><span class="op" id="3636815">,</span>&nbsp;<span class="ident" id="3636817">err</span>&nbsp;<span class="builtintype" id="3636821">error</span><span class="op" id="3636826">)</span>&nbsp;<span class="op" id="3636828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636831">n</span><span class="op" id="3636832">,</span>&nbsp;<span class="ident" id="3636834">err</span>&nbsp;<span class="op" id="3636838">=</span>&nbsp;<span class="ident" id="3636840">b</span><span class="op" id="3636841">.</span><span class="ident" id="3636842">src</span><span class="op" id="3636845">.</span><span class="ident" id="3636846">Read</span><span class="op" id="3636850">(</span><span class="ident" id="3636851">p</span><span class="op" id="3636852">)</span><br>
<span class="lineno">585</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3636856">if</span>&nbsp;<span class="ident" id="3636859">err</span>&nbsp;<span class="op" id="3636863">==</span>&nbsp;<span class="ident" id="3636866">io</span><span class="op" id="3636868">.</span><span class="ident" id="3636869">EOF</span>&nbsp;<span class="op" id="3636873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3636877">//&nbsp;Chunked&nbsp;case.&nbsp;Read&nbsp;the&nbsp;trailer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3636914">if</span>&nbsp;<span class="ident" id="3636917">b</span><span class="op" id="3636918">.</span><span class="ident" id="3636919">hdr</span>&nbsp;<span class="op" id="3636923">!=</span>&nbsp;<span class="builtintype" id="3636926">nil</span>&nbsp;<span class="op" id="3636930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3636935">if</span>&nbsp;<span class="ident" id="3636938">e</span>&nbsp;<span class="op" id="3636940">:=</span>&nbsp;<span class="ident" id="3636943">b</span><span class="op" id="3636944">.</span><span class="ident" id="3636945">readTrailer</span><span class="op" id="3636956">(</span><span class="op" id="3636957">)</span><span class="op" id="3636958">;</span>&nbsp;<span class="ident" id="3636960">e</span>&nbsp;<span class="op" id="3636962">!=</span>&nbsp;<span class="builtintype" id="3636965">nil</span>&nbsp;<span class="op" id="3636969">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636975">err</span>&nbsp;<span class="op" id="3636979">=</span>&nbsp;<span class="ident" id="3636981">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3636986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636991">b</span><span class="op" id="3636992">.</span><span class="ident" id="3636993">hdr</span>&nbsp;<span class="op" id="3636997">=</span>&nbsp;<span class="builtintype" id="3636999">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3637005">}</span>&nbsp;<span class="keyword" id="3637007">else</span>&nbsp;<span class="op" id="3637012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3637017">//&nbsp;If&nbsp;the&nbsp;server&nbsp;declared&nbsp;the&nbsp;Content-Length,&nbsp;our&nbsp;body&nbsp;is&nbsp;a&nbsp;LimitedReader</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3637094">//&nbsp;and&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;whether&nbsp;this&nbsp;EOF&nbsp;arrived&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3637153">if</span>&nbsp;<span class="ident" id="3637156">lr</span><span class="op" id="3637158">,</span>&nbsp;<span class="ident" id="3637160">ok</span>&nbsp;<span class="op" id="3637163">:=</span>&nbsp;<span class="ident" id="3637166">b</span><span class="op" id="3637167">.</span><span class="ident" id="3637168">src</span><span class="op" id="3637171">.</span><span class="op" id="3637172">(</span><span class="op" id="3637173">*</span><span class="ident" id="3637174">io</span><span class="op" id="3637176">.</span><span class="ident" id="3637177">LimitedReader</span><span class="op" id="3637190">)</span><span class="op" id="3637191">;</span>&nbsp;<span class="ident" id="3637193">ok</span>&nbsp;<span class="op" id="3637196">&amp;&amp;</span>&nbsp;<span class="ident" id="3637199">lr</span><span class="op" id="3637201">.</span><span class="ident" id="3637202">N</span>&nbsp;<span class="op" id="3637204">&gt;</span>&nbsp;<span class="num" id="3637206">0</span>&nbsp;<span class="op" id="3637208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3637214">err</span>&nbsp;<span class="op" id="3637218">=</span>&nbsp;<span class="ident" id="3637220">io</span><span class="op" id="3637222">.</span><span class="ident" id="3637223">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3637243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3637247">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3637250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3637254">//&nbsp;If&nbsp;we&nbsp;can&nbsp;return&nbsp;an&nbsp;EOF&nbsp;here&nbsp;along&nbsp;with&nbsp;the&nbsp;read&nbsp;data,&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3637316">//&nbsp;so.&nbsp;This&nbsp;is&nbsp;optional&nbsp;per&nbsp;the&nbsp;io.Reader&nbsp;contract,&nbsp;but&nbsp;doing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3637379">//&nbsp;so&nbsp;helps&nbsp;the&nbsp;HTTP&nbsp;transport&nbsp;code&nbsp;recycle&nbsp;its&nbsp;connection</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3637439">//&nbsp;earlier&nbsp;(since&nbsp;it&nbsp;will&nbsp;see&nbsp;this&nbsp;EOF&nbsp;itself),&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3637500">//&nbsp;client&nbsp;doesn&#39;t&nbsp;do&nbsp;future&nbsp;reads&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3637545">if</span>&nbsp;<span class="ident" id="3637548">err</span>&nbsp;<span class="op" id="3637552">==</span>&nbsp;<span class="builtintype" id="3637555">nil</span>&nbsp;<span class="op" id="3637559">&amp;&amp;</span>&nbsp;<span class="ident" id="3637562">n</span>&nbsp;<span class="op" id="3637564">&gt;</span>&nbsp;<span class="num" id="3637566">0</span>&nbsp;<span class="op" id="3637568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3637572">if</span>&nbsp;<span class="ident" id="3637575">lr</span><span class="op" id="3637577">,</span>&nbsp;<span class="ident" id="3637579">ok</span>&nbsp;<span class="op" id="3637582">:=</span>&nbsp;<span class="ident" id="3637585">b</span><span class="op" id="3637586">.</span><span class="ident" id="3637587">src</span><span class="op" id="3637590">.</span><span class="op" id="3637591">(</span><span class="op" id="3637592">*</span><span class="ident" id="3637593">io</span><span class="op" id="3637595">.</span><span class="ident" id="3637596">LimitedReader</span><span class="op" id="3637609">)</span><span class="op" id="3637610">;</span>&nbsp;<span class="ident" id="3637612">ok</span>&nbsp;<span class="op" id="3637615">&amp;&amp;</span>&nbsp;<span class="ident" id="3637618">lr</span><span class="op" id="3637620">.</span><span class="ident" id="3637621">N</span>&nbsp;<span class="op" id="3637623">==</span>&nbsp;<span class="num" id="3637626">0</span>&nbsp;<span class="op" id="3637628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3637633">err</span>&nbsp;<span class="op" id="3637637">=</span>&nbsp;<span class="ident" id="3637639">io</span><span class="op" id="3637641">.</span><span class="ident" id="3637642">EOF</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3637648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3637651">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3637655">return</span>&nbsp;<span class="ident" id="3637662">n</span><span class="op" id="3637663">,</span>&nbsp;<span class="ident" id="3637665">err</span><br>
<span class="lineno"></span><span class="op" id="3637669">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="keyword" id="3637672">var</span>&nbsp;<span class="op" id="3637676">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3637679">singleCRLF</span>&nbsp;<span class="op" id="3637690">=</span>&nbsp;<span class="op" id="3637692">[</span><span class="op" id="3637693">]</span><span class="builtintype" id="3637694">byte</span><span class="op" id="3637698">(</span><span class="string" id="3637699">&#34;\r\n&#34;</span><span class="op" id="3637705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3637708">doubleCRLF</span>&nbsp;<span class="op" id="3637719">=</span>&nbsp;<span class="op" id="3637721">[</span><span class="op" id="3637722">]</span><span class="builtintype" id="3637723">byte</span><span class="op" id="3637727">(</span><span class="string" id="3637728">&#34;\r\n\r\n&#34;</span><span class="op" id="3637738">)</span><br>
<span class="lineno"></span><span class="op" id="3637740">)</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="3637743">func</span>&nbsp;<span class="ident" id="3637748">seeUpcomingDoubleCRLF</span><span class="op" id="3637769">(</span><span class="ident" id="3637770">r</span>&nbsp;<span class="op" id="3637772">*</span><span class="ident" id="3637773">bufio</span><span class="op" id="3637778">.</span><span class="ident" id="3637779">Reader</span><span class="op" id="3637785">)</span>&nbsp;<span class="builtintype" id="3637787">bool</span>&nbsp;<span class="op" id="3637792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3637795">for</span>&nbsp;<span class="ident" id="3637799">peekSize</span>&nbsp;<span class="op" id="3637808">:=</span>&nbsp;<span class="num" id="3637811">4</span><span class="op" id="3637812">;</span>&nbsp;<span class="op" id="3637814">;</span>&nbsp;<span class="ident" id="3637816">peekSize</span><span class="op" id="3637824">++</span>&nbsp;<span class="op" id="3637827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3637831">//&nbsp;This&nbsp;loop&nbsp;stops&nbsp;when&nbsp;Peek&nbsp;returns&nbsp;an&nbsp;error,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3637880">//&nbsp;which&nbsp;it&nbsp;does&nbsp;when&nbsp;r&#39;s&nbsp;buffer&nbsp;has&nbsp;been&nbsp;filled.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3637932">buf</span><span class="op" id="3637935">,</span>&nbsp;<span class="ident" id="3637937">err</span>&nbsp;<span class="op" id="3637941">:=</span>&nbsp;<span class="ident" id="3637944">r</span><span class="op" id="3637945">.</span><span class="ident" id="3637946">Peek</span><span class="op" id="3637950">(</span><span class="ident" id="3637951">peekSize</span><span class="op" id="3637959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3637963">if</span>&nbsp;<span class="ident" id="3637966">bytes</span><span class="op" id="3637971">.</span><span class="ident" id="3637972">HasSuffix</span><span class="op" id="3637981">(</span><span class="ident" id="3637982">buf</span><span class="op" id="3637985">,</span>&nbsp;<span class="ident" id="3637987">doubleCRLF</span><span class="op" id="3637997">)</span>&nbsp;<span class="op" id="3637999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3638004">return</span>&nbsp;<span class="builtintype" id="3638011">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3638018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3638022">if</span>&nbsp;<span class="ident" id="3638025">err</span>&nbsp;<span class="op" id="3638029">!=</span>&nbsp;<span class="builtintype" id="3638032">nil</span>&nbsp;<span class="op" id="3638036">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3638041">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3638049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3638052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3638055">return</span>&nbsp;<span class="builtintype" id="3638062">false</span><br>
<span class="lineno"></span><span class="op" id="3638068">}</span><br>
<span class="lineno">635</span><br>
<span class="lineno"></span><span class="keyword" id="3638071">var</span>&nbsp;<span class="ident" id="3638075">errTrailerEOF</span>&nbsp;<span class="op" id="3638089">=</span>&nbsp;<span class="ident" id="3638091">errors</span><span class="op" id="3638097">.</span><span class="ident" id="3638098">New</span><span class="op" id="3638101">(</span><span class="string" id="3638102">&#34;http:&nbsp;unexpected&nbsp;EOF&nbsp;reading&nbsp;trailer&#34;</span><span class="op" id="3638140">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3638143">func</span>&nbsp;<span class="op" id="3638148">(</span><span class="ident" id="3638149">b</span>&nbsp;<span class="op" id="3638151">*</span><span class="ident" id="3638152">body</span><span class="op" id="3638156">)</span>&nbsp;<span class="ident" id="3638158">readTrailer</span><span class="op" id="3638169">(</span><span class="op" id="3638170">)</span>&nbsp;<span class="builtintype" id="3638172">error</span>&nbsp;<span class="op" id="3638178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3638181">//&nbsp;The&nbsp;common&nbsp;case,&nbsp;since&nbsp;nobody&nbsp;uses&nbsp;trailers.</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3638230">buf</span><span class="op" id="3638233">,</span>&nbsp;<span class="ident" id="3638235">err</span>&nbsp;<span class="op" id="3638239">:=</span>&nbsp;<span class="ident" id="3638242">b</span><span class="op" id="3638243">.</span><span class="ident" id="3638244">r</span><span class="op" id="3638245">.</span><span class="ident" id="3638246">Peek</span><span class="op" id="3638250">(</span><span class="num" id="3638251">2</span><span class="op" id="3638252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3638255">if</span>&nbsp;<span class="ident" id="3638258">bytes</span><span class="op" id="3638263">.</span><span class="ident" id="3638264">Equal</span><span class="op" id="3638269">(</span><span class="ident" id="3638270">buf</span><span class="op" id="3638273">,</span>&nbsp;<span class="ident" id="3638275">singleCRLF</span><span class="op" id="3638285">)</span>&nbsp;<span class="op" id="3638287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3638291">b</span><span class="op" id="3638292">.</span><span class="ident" id="3638293">r</span><span class="op" id="3638294">.</span><span class="ident" id="3638295">ReadByte</span><span class="op" id="3638303">(</span><span class="op" id="3638304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3638308">b</span><span class="op" id="3638309">.</span><span class="ident" id="3638310">r</span><span class="op" id="3638311">.</span><span class="ident" id="3638312">ReadByte</span><span class="op" id="3638320">(</span><span class="op" id="3638321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3638325">return</span>&nbsp;<span class="builtintype" id="3638332">nil</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3638337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3638340">if</span>&nbsp;<span class="builtinfunc" id="3638343">len</span><span class="op" id="3638346">(</span><span class="ident" id="3638347">buf</span><span class="op" id="3638350">)</span>&nbsp;<span class="op" id="3638352">&lt;</span>&nbsp;<span class="num" id="3638354">2</span>&nbsp;<span class="op" id="3638356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3638360">return</span>&nbsp;<span class="ident" id="3638367">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3638382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3638385">if</span>&nbsp;<span class="ident" id="3638388">err</span>&nbsp;<span class="op" id="3638392">!=</span>&nbsp;<span class="builtintype" id="3638395">nil</span>&nbsp;<span class="op" id="3638399">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3638403">return</span>&nbsp;<span class="ident" id="3638410">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3638415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3638419">//&nbsp;Make&nbsp;sure&nbsp;there&#39;s&nbsp;a&nbsp;header&nbsp;terminator&nbsp;coming&nbsp;up,&nbsp;to&nbsp;prevent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3638483">//&nbsp;a&nbsp;DoS&nbsp;with&nbsp;an&nbsp;unbounded&nbsp;size&nbsp;Trailer.&nbsp;&nbsp;It&#39;s&nbsp;not&nbsp;easy&nbsp;to</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3638543">//&nbsp;slip&nbsp;in&nbsp;a&nbsp;LimitReader&nbsp;here,&nbsp;as&nbsp;textproto.NewReader&nbsp;requires</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3638607">//&nbsp;a&nbsp;concrete&nbsp;*bufio.Reader.&nbsp;&nbsp;Also,&nbsp;we&nbsp;can&#39;t&nbsp;get&nbsp;all&nbsp;the&nbsp;way</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3638669">//&nbsp;back&nbsp;up&nbsp;to&nbsp;our&nbsp;conn&#39;s&nbsp;LimitedReader&nbsp;that&nbsp;*might*&nbsp;be&nbsp;backing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3638733">//&nbsp;this&nbsp;bufio.Reader.&nbsp;&nbsp;Instead,&nbsp;a&nbsp;hack:&nbsp;we&nbsp;iteratively&nbsp;Peek&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3638797">//&nbsp;to&nbsp;the&nbsp;bufio.Reader&#39;s&nbsp;max&nbsp;size,&nbsp;looking&nbsp;for&nbsp;a&nbsp;double&nbsp;CRLF.</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3638860">//&nbsp;This&nbsp;limits&nbsp;the&nbsp;trailer&nbsp;to&nbsp;the&nbsp;underlying&nbsp;buffer&nbsp;size,&nbsp;typically&nbsp;4kB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3638934">if</span>&nbsp;<span class="op" id="3638937">!</span><span class="ident" id="3638938">seeUpcomingDoubleCRLF</span><span class="op" id="3638959">(</span><span class="ident" id="3638960">b</span><span class="op" id="3638961">.</span><span class="ident" id="3638962">r</span><span class="op" id="3638963">)</span>&nbsp;<span class="op" id="3638965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3638969">return</span>&nbsp;<span class="ident" id="3638976">errors</span><span class="op" id="3638982">.</span><span class="ident" id="3638983">New</span><span class="op" id="3638986">(</span><span class="string" id="3638987">&#34;http:&nbsp;suspiciously&nbsp;long&nbsp;trailer&nbsp;after&nbsp;chunked&nbsp;body&#34;</span><span class="op" id="3639039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3639042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3639046">hdr</span><span class="op" id="3639049">,</span>&nbsp;<span class="ident" id="3639051">err</span>&nbsp;<span class="op" id="3639055">:=</span>&nbsp;<span class="ident" id="3639058">textproto</span><span class="op" id="3639067">.</span><span class="ident" id="3639068">NewReader</span><span class="op" id="3639077">(</span><span class="ident" id="3639078">b</span><span class="op" id="3639079">.</span><span class="ident" id="3639080">r</span><span class="op" id="3639081">)</span><span class="op" id="3639082">.</span><span class="ident" id="3639083">ReadMIMEHeader</span><span class="op" id="3639097">(</span><span class="op" id="3639098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639101">if</span>&nbsp;<span class="ident" id="3639104">err</span>&nbsp;<span class="op" id="3639108">!=</span>&nbsp;<span class="builtintype" id="3639111">nil</span>&nbsp;<span class="op" id="3639115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639119">if</span>&nbsp;<span class="ident" id="3639122">err</span>&nbsp;<span class="op" id="3639126">==</span>&nbsp;<span class="ident" id="3639129">io</span><span class="op" id="3639131">.</span><span class="ident" id="3639132">EOF</span>&nbsp;<span class="op" id="3639136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639141">return</span>&nbsp;<span class="ident" id="3639148">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3639164">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639168">return</span>&nbsp;<span class="ident" id="3639175">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3639180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639183">switch</span>&nbsp;<span class="ident" id="3639190">rr</span>&nbsp;<span class="op" id="3639193">:=</span>&nbsp;<span class="ident" id="3639196">b</span><span class="op" id="3639197">.</span><span class="ident" id="3639198">hdr</span><span class="op" id="3639201">.</span><span class="op" id="3639202">(</span><span class="keyword" id="3639203">type</span><span class="op" id="3639207">)</span>&nbsp;<span class="op" id="3639209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639212">case</span>&nbsp;<span class="op" id="3639217">*</span><span class="ident" id="3639218">Request</span><span class="op" id="3639225">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3639229">mergeSetHeader</span><span class="op" id="3639243">(</span><span class="op" id="3639244">&amp;</span><span class="ident" id="3639245">rr</span><span class="op" id="3639247">.</span><span class="ident" id="3639248">Trailer</span><span class="op" id="3639255">,</span>&nbsp;<span class="ident" id="3639257">Header</span><span class="op" id="3639263">(</span><span class="ident" id="3639264">hdr</span><span class="op" id="3639267">)</span><span class="op" id="3639268">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639271">case</span>&nbsp;<span class="op" id="3639276">*</span><span class="ident" id="3639277">Response</span><span class="op" id="3639285">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3639289">mergeSetHeader</span><span class="op" id="3639303">(</span><span class="op" id="3639304">&amp;</span><span class="ident" id="3639305">rr</span><span class="op" id="3639307">.</span><span class="ident" id="3639308">Trailer</span><span class="op" id="3639315">,</span>&nbsp;<span class="ident" id="3639317">Header</span><span class="op" id="3639323">(</span><span class="ident" id="3639324">hdr</span><span class="op" id="3639327">)</span><span class="op" id="3639328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3639331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639334">return</span>&nbsp;<span class="builtintype" id="3639341">nil</span><br>
<span class="lineno"></span><span class="op" id="3639345">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="3639348">func</span>&nbsp;<span class="ident" id="3639353">mergeSetHeader</span><span class="op" id="3639367">(</span><span class="ident" id="3639368">dst</span>&nbsp;<span class="op" id="3639372">*</span><span class="ident" id="3639373">Header</span><span class="op" id="3639379">,</span>&nbsp;<span class="ident" id="3639381">src</span>&nbsp;<span class="ident" id="3639385">Header</span><span class="op" id="3639391">)</span>&nbsp;<span class="op" id="3639393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639396">if</span>&nbsp;<span class="op" id="3639399">*</span><span class="ident" id="3639400">dst</span>&nbsp;<span class="op" id="3639404">==</span>&nbsp;<span class="builtintype" id="3639407">nil</span>&nbsp;<span class="op" id="3639411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3639415">*</span><span class="ident" id="3639416">dst</span>&nbsp;<span class="op" id="3639420">=</span>&nbsp;<span class="ident" id="3639422">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639428">return</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3639436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639439">for</span>&nbsp;<span class="ident" id="3639443">k</span><span class="op" id="3639444">,</span>&nbsp;<span class="ident" id="3639446">vv</span>&nbsp;<span class="op" id="3639449">:=</span>&nbsp;<span class="keyword" id="3639452">range</span>&nbsp;<span class="ident" id="3639458">src</span>&nbsp;<span class="op" id="3639462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3639466">(</span><span class="op" id="3639467">*</span><span class="ident" id="3639468">dst</span><span class="op" id="3639471">)</span><span class="op" id="3639472">[</span><span class="ident" id="3639473">k</span><span class="op" id="3639474">]</span>&nbsp;<span class="op" id="3639476">=</span>&nbsp;<span class="ident" id="3639478">vv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3639482">}</span><br>
<span class="lineno"></span><span class="op" id="3639484">}</span><br>
<span class="lineno">690</span><br>
<span class="lineno"></span><span class="keyword" id="3639487">func</span>&nbsp;<span class="op" id="3639492">(</span><span class="ident" id="3639493">b</span>&nbsp;<span class="op" id="3639495">*</span><span class="ident" id="3639496">body</span><span class="op" id="3639500">)</span>&nbsp;<span class="ident" id="3639502">Close</span><span class="op" id="3639507">(</span><span class="op" id="3639508">)</span>&nbsp;<span class="builtintype" id="3639510">error</span>&nbsp;<span class="op" id="3639516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3639519">b</span><span class="op" id="3639520">.</span><span class="ident" id="3639521">mu</span><span class="op" id="3639523">.</span><span class="ident" id="3639524">Lock</span><span class="op" id="3639528">(</span><span class="op" id="3639529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639532">defer</span>&nbsp;<span class="ident" id="3639538">b</span><span class="op" id="3639539">.</span><span class="ident" id="3639540">mu</span><span class="op" id="3639542">.</span><span class="ident" id="3639543">Unlock</span><span class="op" id="3639549">(</span><span class="op" id="3639550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639553">if</span>&nbsp;<span class="ident" id="3639556">b</span><span class="op" id="3639557">.</span><span class="ident" id="3639558">closed</span>&nbsp;<span class="op" id="3639565">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639569">return</span>&nbsp;<span class="builtintype" id="3639576">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3639581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639584">var</span>&nbsp;<span class="ident" id="3639588">err</span>&nbsp;<span class="builtintype" id="3639592">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639599">switch</span>&nbsp;<span class="op" id="3639606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639609">case</span>&nbsp;<span class="ident" id="3639614">b</span><span class="op" id="3639615">.</span><span class="ident" id="3639616">hdr</span>&nbsp;<span class="op" id="3639620">==</span>&nbsp;<span class="builtintype" id="3639623">nil</span>&nbsp;<span class="op" id="3639627">&amp;&amp;</span>&nbsp;<span class="ident" id="3639630">b</span><span class="op" id="3639631">.</span><span class="ident" id="3639632">closing</span><span class="op" id="3639639">:</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3639643">//&nbsp;no&nbsp;trailer&nbsp;and&nbsp;closing&nbsp;the&nbsp;connection&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3639692">//&nbsp;no&nbsp;point&nbsp;in&nbsp;reading&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639724">default</span><span class="op" id="3639731">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3639735">//&nbsp;Fully&nbsp;consume&nbsp;the&nbsp;body,&nbsp;which&nbsp;will&nbsp;also&nbsp;lead&nbsp;to&nbsp;us&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3639799">//&nbsp;the&nbsp;trailer&nbsp;headers&nbsp;after&nbsp;the&nbsp;body,&nbsp;if&nbsp;present.</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3639852">_</span><span class="op" id="3639853">,</span>&nbsp;<span class="ident" id="3639855">err</span>&nbsp;<span class="op" id="3639859">=</span>&nbsp;<span class="ident" id="3639861">io</span><span class="op" id="3639863">.</span><span class="ident" id="3639864">Copy</span><span class="op" id="3639868">(</span><span class="ident" id="3639869">ioutil</span><span class="op" id="3639875">.</span><span class="ident" id="3639876">Discard</span><span class="op" id="3639883">,</span>&nbsp;<span class="ident" id="3639885">bodyLocked</span><span class="op" id="3639895">{</span><span class="ident" id="3639896">b</span><span class="op" id="3639897">}</span><span class="op" id="3639898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3639901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3639904">b</span><span class="op" id="3639905">.</span><span class="ident" id="3639906">closed</span>&nbsp;<span class="op" id="3639913">=</span>&nbsp;<span class="builtintype" id="3639915">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639921">return</span>&nbsp;<span class="ident" id="3639928">err</span><br>
<span class="lineno"></span><span class="op" id="3639932">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="3639935">//&nbsp;bodyLocked&nbsp;is&nbsp;a&nbsp;io.Reader&nbsp;reading&nbsp;from&nbsp;a&nbsp;*body&nbsp;when&nbsp;its&nbsp;mutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3640003">//&nbsp;already&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="3640020">type</span>&nbsp;<span class="ident" id="3640025">bodyLocked</span>&nbsp;<span class="keyword" id="3640036">struct</span>&nbsp;<span class="op" id="3640043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3640046">b</span>&nbsp;<span class="op" id="3640048">*</span><span class="ident" id="3640049">body</span><br>
<span class="lineno">715</span><span class="op" id="3640054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3640057">func</span>&nbsp;<span class="op" id="3640062">(</span><span class="ident" id="3640063">bl</span>&nbsp;<span class="ident" id="3640066">bodyLocked</span><span class="op" id="3640076">)</span>&nbsp;<span class="ident" id="3640078">Read</span><span class="op" id="3640082">(</span><span class="ident" id="3640083">p</span>&nbsp;<span class="op" id="3640085">[</span><span class="op" id="3640086">]</span><span class="builtintype" id="3640087">byte</span><span class="op" id="3640091">)</span>&nbsp;<span class="op" id="3640093">(</span><span class="ident" id="3640094">n</span>&nbsp;<span class="builtintype" id="3640096">int</span><span class="op" id="3640099">,</span>&nbsp;<span class="ident" id="3640101">err</span>&nbsp;<span class="builtintype" id="3640105">error</span><span class="op" id="3640110">)</span>&nbsp;<span class="op" id="3640112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3640115">if</span>&nbsp;<span class="ident" id="3640118">bl</span><span class="op" id="3640120">.</span><span class="ident" id="3640121">b</span><span class="op" id="3640122">.</span><span class="ident" id="3640123">closed</span>&nbsp;<span class="op" id="3640130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3640134">return</span>&nbsp;<span class="num" id="3640141">0</span><span class="op" id="3640142">,</span>&nbsp;<span class="ident" id="3640144">ErrBodyReadAfterClose</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3640167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3640170">return</span>&nbsp;<span class="ident" id="3640177">bl</span><span class="op" id="3640179">.</span><span class="ident" id="3640180">b</span><span class="op" id="3640181">.</span><span class="ident" id="3640182">readLocked</span><span class="op" id="3640192">(</span><span class="ident" id="3640193">p</span><span class="op" id="3640194">)</span><br>
<span class="lineno"></span><span class="op" id="3640196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3640199">//&nbsp;parseContentLength&nbsp;trims&nbsp;whitespace&nbsp;from&nbsp;s&nbsp;and&nbsp;returns&nbsp;-1&nbsp;if&nbsp;no&nbsp;value</span><br>
<span class="lineno">725</span><span class="comment" id="3640272">//&nbsp;is&nbsp;set,&nbsp;or&nbsp;the&nbsp;value&nbsp;if&nbsp;it&#39;s&nbsp;&gt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3640310">func</span>&nbsp;<span class="ident" id="3640315">parseContentLength</span><span class="op" id="3640333">(</span><span class="ident" id="3640334">cl</span>&nbsp;<span class="builtintype" id="3640337">string</span><span class="op" id="3640343">)</span>&nbsp;<span class="op" id="3640345">(</span><span class="builtintype" id="3640346">int64</span><span class="op" id="3640351">,</span>&nbsp;<span class="builtintype" id="3640353">error</span><span class="op" id="3640358">)</span>&nbsp;<span class="op" id="3640360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3640363">cl</span>&nbsp;<span class="op" id="3640366">=</span>&nbsp;<span class="ident" id="3640368">strings</span><span class="op" id="3640375">.</span><span class="ident" id="3640376">TrimSpace</span><span class="op" id="3640385">(</span><span class="ident" id="3640386">cl</span><span class="op" id="3640388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3640391">if</span>&nbsp;<span class="ident" id="3640394">cl</span>&nbsp;<span class="op" id="3640397">==</span>&nbsp;<span class="string" id="3640400">&#34;&#34;</span>&nbsp;<span class="op" id="3640403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3640407">return</span>&nbsp;<span class="op" id="3640414">-</span><span class="num" id="3640415">1</span><span class="op" id="3640416">,</span>&nbsp;<span class="builtintype" id="3640418">nil</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3640423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3640426">n</span><span class="op" id="3640427">,</span>&nbsp;<span class="ident" id="3640429">err</span>&nbsp;<span class="op" id="3640433">:=</span>&nbsp;<span class="ident" id="3640436">strconv</span><span class="op" id="3640443">.</span><span class="ident" id="3640444">ParseInt</span><span class="op" id="3640452">(</span><span class="ident" id="3640453">cl</span><span class="op" id="3640455">,</span>&nbsp;<span class="num" id="3640457">10</span><span class="op" id="3640459">,</span>&nbsp;<span class="num" id="3640461">64</span><span class="op" id="3640463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3640466">if</span>&nbsp;<span class="ident" id="3640469">err</span>&nbsp;<span class="op" id="3640473">!=</span>&nbsp;<span class="builtintype" id="3640476">nil</span>&nbsp;<span class="op" id="3640480">||</span>&nbsp;<span class="ident" id="3640483">n</span>&nbsp;<span class="op" id="3640485">&lt;</span>&nbsp;<span class="num" id="3640487">0</span>&nbsp;<span class="op" id="3640489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3640493">return</span>&nbsp;<span class="num" id="3640500">0</span><span class="op" id="3640501">,</span>&nbsp;<span class="op" id="3640503">&amp;</span><span class="ident" id="3640504">badStringError</span><span class="op" id="3640518">{</span><span class="string" id="3640519">&#34;bad&nbsp;Content-Length&#34;</span><span class="op" id="3640539">,</span>&nbsp;<span class="ident" id="3640541">cl</span><span class="op" id="3640543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3640546">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3640549">return</span>&nbsp;<span class="ident" id="3640556">n</span><span class="op" id="3640557">,</span>&nbsp;<span class="builtintype" id="3640559">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="3640564">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
