<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html" class="current">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2382850">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2382905">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2382959">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2383010">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2383075">//&nbsp;Fork,&nbsp;exec,&nbsp;wait,&nbsp;etc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2383102">package</span>&nbsp;<span class="ident" id="2383110">syscall</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="2383119">import</span>&nbsp;<span class="op" id="2383126">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2383129">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2383140">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2383148">&#34;unsafe&#34;</span><br>
<span class="lineno">15</span><span class="op" id="2383157">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2383160">//&nbsp;Lock&nbsp;synchronizing&nbsp;creation&nbsp;of&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;with&nbsp;fork.</span><br>
<span class="lineno"></span><span class="comment" id="2383226">//</span><br>
<span class="lineno"></span><span class="comment" id="2383229">//&nbsp;We&nbsp;want&nbsp;the&nbsp;child&nbsp;in&nbsp;a&nbsp;fork/exec&nbsp;sequence&nbsp;to&nbsp;inherit&nbsp;only&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="2383294">//&nbsp;file&nbsp;descriptors&nbsp;we&nbsp;intend.&nbsp;&nbsp;To&nbsp;do&nbsp;that,&nbsp;we&nbsp;mark&nbsp;all&nbsp;file</span><br>
<span class="lineno"></span><span class="comment" id="2383355">//&nbsp;descriptors&nbsp;close-on-exec&nbsp;and&nbsp;then,&nbsp;in&nbsp;the&nbsp;child,&nbsp;explicitly</span><br>
<span class="lineno"></span><span class="comment" id="2383419">//&nbsp;unmark&nbsp;the&nbsp;ones&nbsp;we&nbsp;want&nbsp;the&nbsp;exec&#39;ed&nbsp;program&nbsp;to&nbsp;keep.</span><br>
<span class="lineno"></span><span class="comment" id="2383475">//&nbsp;Unix&nbsp;doesn&#39;t&nbsp;make&nbsp;this&nbsp;easy:&nbsp;there&nbsp;is,&nbsp;in&nbsp;general,&nbsp;no&nbsp;way&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2383539">//&nbsp;allocate&nbsp;a&nbsp;new&nbsp;file&nbsp;descriptor&nbsp;close-on-exec.&nbsp;&nbsp;Instead&nbsp;you</span><br>
<span class="lineno">25</span><span class="comment" id="2383601">//&nbsp;have&nbsp;to&nbsp;allocate&nbsp;the&nbsp;descriptor&nbsp;and&nbsp;then&nbsp;mark&nbsp;it&nbsp;close-on-exec.</span><br>
<span class="lineno"></span><span class="comment" id="2383668">//&nbsp;If&nbsp;a&nbsp;fork&nbsp;happens&nbsp;between&nbsp;those&nbsp;two&nbsp;events,&nbsp;the&nbsp;child&#39;s&nbsp;exec</span><br>
<span class="lineno"></span><span class="comment" id="2383732">//&nbsp;will&nbsp;inherit&nbsp;an&nbsp;unwanted&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="comment" id="2383777">//</span><br>
<span class="lineno"></span><span class="comment" id="2383780">//&nbsp;This&nbsp;lock&nbsp;solves&nbsp;that&nbsp;race:&nbsp;the&nbsp;create&nbsp;new&nbsp;fd/mark&nbsp;close-on-exec</span><br>
<span class="lineno">30</span><span class="comment" id="2383848">//&nbsp;operation&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;reading,&nbsp;and&nbsp;the&nbsp;fork&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2383919">//&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;writing.&nbsp;&nbsp;At&nbsp;least,&nbsp;that&#39;s&nbsp;the&nbsp;idea.</span><br>
<span class="lineno"></span><span class="comment" id="2383988">//&nbsp;There&nbsp;are&nbsp;some&nbsp;complications.</span><br>
<span class="lineno"></span><span class="comment" id="2384021">//</span><br>
<span class="lineno"></span><span class="comment" id="2384024">//&nbsp;Some&nbsp;system&nbsp;calls&nbsp;that&nbsp;create&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;can&nbsp;block</span><br>
<span class="lineno">35</span><span class="comment" id="2384088">//&nbsp;for&nbsp;arbitrarily&nbsp;long&nbsp;times:&nbsp;open&nbsp;on&nbsp;a&nbsp;hung&nbsp;NFS&nbsp;server&nbsp;or&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="2384154">//&nbsp;pipe,&nbsp;accept&nbsp;on&nbsp;a&nbsp;socket,&nbsp;and&nbsp;so&nbsp;on.&nbsp;&nbsp;We&nbsp;can&#39;t&nbsp;reasonably&nbsp;grab</span><br>
<span class="lineno"></span><span class="comment" id="2384220">//&nbsp;the&nbsp;lock&nbsp;across&nbsp;those&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="2384257">//</span><br>
<span class="lineno"></span><span class="comment" id="2384260">//&nbsp;It&nbsp;is&nbsp;worse&nbsp;to&nbsp;inherit&nbsp;some&nbsp;file&nbsp;descriptors&nbsp;than&nbsp;others.</span><br>
<span class="lineno">40</span><span class="comment" id="2384321">//&nbsp;If&nbsp;a&nbsp;non-malicious&nbsp;child&nbsp;accidentally&nbsp;inherits&nbsp;an&nbsp;open&nbsp;ordinary&nbsp;file,</span><br>
<span class="lineno"></span><span class="comment" id="2384394">//&nbsp;that&#39;s&nbsp;not&nbsp;a&nbsp;big&nbsp;deal.&nbsp;&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;if&nbsp;a&nbsp;long-lived&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="2384462">//&nbsp;accidentally&nbsp;inherits&nbsp;the&nbsp;write&nbsp;end&nbsp;of&nbsp;a&nbsp;pipe,&nbsp;then&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span><span class="comment" id="2384528">//&nbsp;of&nbsp;that&nbsp;pipe&nbsp;will&nbsp;not&nbsp;see&nbsp;EOF&nbsp;until&nbsp;that&nbsp;child&nbsp;exits,&nbsp;potentially</span><br>
<span class="lineno"></span><span class="comment" id="2384597">//&nbsp;causing&nbsp;the&nbsp;parent&nbsp;program&nbsp;to&nbsp;hang.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;common&nbsp;problem</span><br>
<span class="lineno">45</span><span class="comment" id="2384662">//&nbsp;in&nbsp;threaded&nbsp;C&nbsp;programs&nbsp;that&nbsp;use&nbsp;popen.</span><br>
<span class="lineno"></span><span class="comment" id="2384704">//</span><br>
<span class="lineno"></span><span class="comment" id="2384707">//&nbsp;Luckily,&nbsp;the&nbsp;file&nbsp;descriptors&nbsp;that&nbsp;are&nbsp;most&nbsp;important&nbsp;not&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2384771">//&nbsp;inherit&nbsp;are&nbsp;not&nbsp;the&nbsp;ones&nbsp;that&nbsp;can&nbsp;take&nbsp;an&nbsp;arbitrarily&nbsp;long&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="2384838">//&nbsp;to&nbsp;create:&nbsp;pipe&nbsp;returns&nbsp;instantly,&nbsp;and&nbsp;the&nbsp;net&nbsp;package&nbsp;uses</span><br>
<span class="lineno">50</span><span class="comment" id="2384901">//&nbsp;non-blocking&nbsp;I/O&nbsp;to&nbsp;accept&nbsp;on&nbsp;a&nbsp;listening&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="2384954">//&nbsp;The&nbsp;rules&nbsp;for&nbsp;which&nbsp;file&nbsp;descriptor-creating&nbsp;operations&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2385021">//&nbsp;ForkLock&nbsp;are&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="2385049">//</span><br>
<span class="lineno"></span><span class="comment" id="2385052">//&nbsp;1)&nbsp;Pipe.&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno">55</span><span class="comment" id="2385102">//&nbsp;2)&nbsp;Socket.&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2385152">//&nbsp;3)&nbsp;Accept.&nbsp;&nbsp;If&nbsp;using&nbsp;non-blocking&nbsp;mode,&nbsp;use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2385213">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno"></span><span class="comment" id="2385259">//&nbsp;4)&nbsp;Open.&nbsp;&nbsp;&nbsp;&nbsp;Can&nbsp;block.&nbsp;&nbsp;Use&nbsp;O_CLOEXEC&nbsp;if&nbsp;available&nbsp;(Linux).</span><br>
<span class="lineno"></span><span class="comment" id="2385322">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno">60</span><span class="comment" id="2385368">//&nbsp;5)&nbsp;Dup.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2385418">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;On&nbsp;Linux,&nbsp;could&nbsp;use&nbsp;fcntl&nbsp;F_DUPFD_CLOEXEC</span><br>
<span class="lineno"></span><span class="comment" id="2385475">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instead&nbsp;of&nbsp;the&nbsp;ForkLock,&nbsp;but&nbsp;only&nbsp;for&nbsp;dup(fd,&nbsp;-1).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2385542">var</span>&nbsp;<span class="ident" id="2385546">ForkLock</span>&nbsp;<span class="ident" id="2385555">sync</span><span class="op" id="2385559">.</span><span class="ident" id="2385560">RWMutex</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2385569">//&nbsp;StringSlicePtr&nbsp;is&nbsp;deprecated.&nbsp;Use&nbsp;SlicePtrFromStrings&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="2385635">//&nbsp;If&nbsp;any&nbsp;string&nbsp;contains&nbsp;a&nbsp;NUL&nbsp;byte&nbsp;this&nbsp;function&nbsp;panics&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="2385701">//&nbsp;of&nbsp;returning&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="2385727">func</span>&nbsp;<span class="ident" id="2385732">StringSlicePtr</span><span class="op" id="2385746">(</span><span class="ident" id="2385747">ss</span>&nbsp;<span class="op" id="2385750">[</span><span class="op" id="2385751">]</span><span class="builtintype" id="2385752">string</span><span class="op" id="2385758">)</span>&nbsp;<span class="op" id="2385760">[</span><span class="op" id="2385761">]</span><span class="op" id="2385762">*</span><span class="builtintype" id="2385763">byte</span>&nbsp;<span class="op" id="2385768">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2385771">bb</span>&nbsp;<span class="op" id="2385774">:=</span>&nbsp;<span class="builtinfunc" id="2385777">make</span><span class="op" id="2385781">(</span><span class="op" id="2385782">[</span><span class="op" id="2385783">]</span><span class="op" id="2385784">*</span><span class="builtintype" id="2385785">byte</span><span class="op" id="2385789">,</span>&nbsp;<span class="builtinfunc" id="2385791">len</span><span class="op" id="2385794">(</span><span class="ident" id="2385795">ss</span><span class="op" id="2385797">)</span><span class="op" id="2385798">+</span><span class="num" id="2385799">1</span><span class="op" id="2385800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2385803">for</span>&nbsp;<span class="ident" id="2385807">i</span>&nbsp;<span class="op" id="2385809">:=</span>&nbsp;<span class="num" id="2385812">0</span><span class="op" id="2385813">;</span>&nbsp;<span class="ident" id="2385815">i</span>&nbsp;<span class="op" id="2385817">&lt;</span>&nbsp;<span class="builtinfunc" id="2385819">len</span><span class="op" id="2385822">(</span><span class="ident" id="2385823">ss</span><span class="op" id="2385825">)</span><span class="op" id="2385826">;</span>&nbsp;<span class="ident" id="2385828">i</span><span class="op" id="2385829">++</span>&nbsp;<span class="op" id="2385832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2385836">bb</span><span class="op" id="2385838">[</span><span class="ident" id="2385839">i</span><span class="op" id="2385840">]</span>&nbsp;<span class="op" id="2385842">=</span>&nbsp;<span class="ident" id="2385844">StringBytePtr</span><span class="op" id="2385857">(</span><span class="ident" id="2385858">ss</span><span class="op" id="2385860">[</span><span class="ident" id="2385861">i</span><span class="op" id="2385862">]</span><span class="op" id="2385863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2385866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2385869">bb</span><span class="op" id="2385871">[</span><span class="builtinfunc" id="2385872">len</span><span class="op" id="2385875">(</span><span class="ident" id="2385876">ss</span><span class="op" id="2385878">)</span><span class="op" id="2385879">]</span>&nbsp;<span class="op" id="2385881">=</span>&nbsp;<span class="builtintype" id="2385883">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2385888">return</span>&nbsp;<span class="ident" id="2385895">bb</span><br>
<span class="lineno"></span><span class="op" id="2385898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2385901">//&nbsp;SlicePtrFromStrings&nbsp;converts&nbsp;a&nbsp;slice&nbsp;of&nbsp;strings&nbsp;to&nbsp;a&nbsp;slice&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2385966">//&nbsp;pointers&nbsp;to&nbsp;NUL-terminated&nbsp;byte&nbsp;slices.&nbsp;If&nbsp;any&nbsp;string&nbsp;contains</span><br>
<span class="lineno">80</span><span class="comment" id="2386032">//&nbsp;a&nbsp;NUL&nbsp;byte,&nbsp;it&nbsp;returns&nbsp;(nil,&nbsp;EINVAL).</span><br>
<span class="lineno"></span><span class="keyword" id="2386073">func</span>&nbsp;<span class="ident" id="2386078">SlicePtrFromStrings</span><span class="op" id="2386097">(</span><span class="ident" id="2386098">ss</span>&nbsp;<span class="op" id="2386101">[</span><span class="op" id="2386102">]</span><span class="builtintype" id="2386103">string</span><span class="op" id="2386109">)</span>&nbsp;<span class="op" id="2386111">(</span><span class="op" id="2386112">[</span><span class="op" id="2386113">]</span><span class="op" id="2386114">*</span><span class="builtintype" id="2386115">byte</span><span class="op" id="2386119">,</span>&nbsp;<span class="builtintype" id="2386121">error</span><span class="op" id="2386126">)</span>&nbsp;<span class="op" id="2386128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2386131">var</span>&nbsp;<span class="ident" id="2386135">err</span>&nbsp;<span class="builtintype" id="2386139">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2386146">bb</span>&nbsp;<span class="op" id="2386149">:=</span>&nbsp;<span class="builtinfunc" id="2386152">make</span><span class="op" id="2386156">(</span><span class="op" id="2386157">[</span><span class="op" id="2386158">]</span><span class="op" id="2386159">*</span><span class="builtintype" id="2386160">byte</span><span class="op" id="2386164">,</span>&nbsp;<span class="builtinfunc" id="2386166">len</span><span class="op" id="2386169">(</span><span class="ident" id="2386170">ss</span><span class="op" id="2386172">)</span><span class="op" id="2386173">+</span><span class="num" id="2386174">1</span><span class="op" id="2386175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2386178">for</span>&nbsp;<span class="ident" id="2386182">i</span>&nbsp;<span class="op" id="2386184">:=</span>&nbsp;<span class="num" id="2386187">0</span><span class="op" id="2386188">;</span>&nbsp;<span class="ident" id="2386190">i</span>&nbsp;<span class="op" id="2386192">&lt;</span>&nbsp;<span class="builtinfunc" id="2386194">len</span><span class="op" id="2386197">(</span><span class="ident" id="2386198">ss</span><span class="op" id="2386200">)</span><span class="op" id="2386201">;</span>&nbsp;<span class="ident" id="2386203">i</span><span class="op" id="2386204">++</span>&nbsp;<span class="op" id="2386207">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2386211">bb</span><span class="op" id="2386213">[</span><span class="ident" id="2386214">i</span><span class="op" id="2386215">]</span><span class="op" id="2386216">,</span>&nbsp;<span class="ident" id="2386218">err</span>&nbsp;<span class="op" id="2386222">=</span>&nbsp;<span class="ident" id="2386224">BytePtrFromString</span><span class="op" id="2386241">(</span><span class="ident" id="2386242">ss</span><span class="op" id="2386244">[</span><span class="ident" id="2386245">i</span><span class="op" id="2386246">]</span><span class="op" id="2386247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2386251">if</span>&nbsp;<span class="ident" id="2386254">err</span>&nbsp;<span class="op" id="2386258">!=</span>&nbsp;<span class="builtintype" id="2386261">nil</span>&nbsp;<span class="op" id="2386265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2386270">return</span>&nbsp;<span class="builtintype" id="2386277">nil</span><span class="op" id="2386280">,</span>&nbsp;<span class="ident" id="2386282">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2386288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2386291">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2386294">bb</span><span class="op" id="2386296">[</span><span class="builtinfunc" id="2386297">len</span><span class="op" id="2386300">(</span><span class="ident" id="2386301">ss</span><span class="op" id="2386303">)</span><span class="op" id="2386304">]</span>&nbsp;<span class="op" id="2386306">=</span>&nbsp;<span class="builtintype" id="2386308">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2386313">return</span>&nbsp;<span class="ident" id="2386320">bb</span><span class="op" id="2386322">,</span>&nbsp;<span class="builtintype" id="2386324">nil</span><br>
<span class="lineno"></span><span class="op" id="2386328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2386331">func</span>&nbsp;<span class="ident" id="2386336">CloseOnExec</span><span class="op" id="2386347">(</span><span class="ident" id="2386348">fd</span>&nbsp;<span class="builtintype" id="2386351">int</span><span class="op" id="2386354">)</span>&nbsp;<span class="op" id="2386356">{</span>&nbsp;<span class="ident" id="2386358">fcntl</span><span class="op" id="2386363">(</span><span class="ident" id="2386364">fd</span><span class="op" id="2386366">,</span>&nbsp;<span class="ident" id="2386368">F_SETFD</span><span class="op" id="2386375">,</span>&nbsp;<span class="ident" id="2386377">FD_CLOEXEC</span><span class="op" id="2386387">)</span>&nbsp;<span class="op" id="2386389">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="2386392">func</span>&nbsp;<span class="ident" id="2386397">SetNonblock</span><span class="op" id="2386408">(</span><span class="ident" id="2386409">fd</span>&nbsp;<span class="builtintype" id="2386412">int</span><span class="op" id="2386415">,</span>&nbsp;<span class="ident" id="2386417">nonblocking</span>&nbsp;<span class="builtintype" id="2386429">bool</span><span class="op" id="2386433">)</span>&nbsp;<span class="op" id="2386435">(</span><span class="ident" id="2386436">err</span>&nbsp;<span class="builtintype" id="2386440">error</span><span class="op" id="2386445">)</span>&nbsp;<span class="op" id="2386447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2386450">flag</span><span class="op" id="2386454">,</span>&nbsp;<span class="ident" id="2386456">err</span>&nbsp;<span class="op" id="2386460">:=</span>&nbsp;<span class="ident" id="2386463">fcntl</span><span class="op" id="2386468">(</span><span class="ident" id="2386469">fd</span><span class="op" id="2386471">,</span>&nbsp;<span class="ident" id="2386473">F_GETFL</span><span class="op" id="2386480">,</span>&nbsp;<span class="num" id="2386482">0</span><span class="op" id="2386483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2386486">if</span>&nbsp;<span class="ident" id="2386489">err</span>&nbsp;<span class="op" id="2386493">!=</span>&nbsp;<span class="builtintype" id="2386496">nil</span>&nbsp;<span class="op" id="2386500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2386504">return</span>&nbsp;<span class="ident" id="2386511">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2386516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2386519">if</span>&nbsp;<span class="ident" id="2386522">nonblocking</span>&nbsp;<span class="op" id="2386534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2386538">flag</span>&nbsp;<span class="op" id="2386543">|=</span>&nbsp;<span class="ident" id="2386546">O_NONBLOCK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2386558">}</span>&nbsp;<span class="keyword" id="2386560">else</span>&nbsp;<span class="op" id="2386565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2386569">flag</span>&nbsp;<span class="op" id="2386574">&amp;=</span>&nbsp;<span class="op" id="2386577">^</span><span class="ident" id="2386578">O_NONBLOCK</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2386590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2386593">_</span><span class="op" id="2386594">,</span>&nbsp;<span class="ident" id="2386596">err</span>&nbsp;<span class="op" id="2386600">=</span>&nbsp;<span class="ident" id="2386602">fcntl</span><span class="op" id="2386607">(</span><span class="ident" id="2386608">fd</span><span class="op" id="2386610">,</span>&nbsp;<span class="ident" id="2386612">F_SETFL</span><span class="op" id="2386619">,</span>&nbsp;<span class="ident" id="2386621">flag</span><span class="op" id="2386625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2386628">return</span>&nbsp;<span class="ident" id="2386635">err</span><br>
<span class="lineno"></span><span class="op" id="2386639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="2386642">//&nbsp;Credential&nbsp;holds&nbsp;user&nbsp;and&nbsp;group&nbsp;identities&nbsp;to&nbsp;be&nbsp;assumed</span><br>
<span class="lineno"></span><span class="comment" id="2386702">//&nbsp;by&nbsp;a&nbsp;child&nbsp;process&nbsp;started&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno"></span><span class="keyword" id="2386749">type</span>&nbsp;<span class="ident" id="2386754">Credential</span>&nbsp;<span class="keyword" id="2386765">struct</span>&nbsp;<span class="op" id="2386772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2386775">Uid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2386782">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2386791">//&nbsp;User&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2386804">Gid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2386811">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2386820">//&nbsp;Group&nbsp;ID.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2386834">Groups</span>&nbsp;<span class="op" id="2386841">[</span><span class="op" id="2386842">]</span><span class="builtintype" id="2386843">uint32</span>&nbsp;<span class="comment" id="2386850">//&nbsp;Supplementary&nbsp;group&nbsp;IDs.</span><br>
<span class="lineno"></span><span class="op" id="2386878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2386881">//&nbsp;ProcAttr&nbsp;holds&nbsp;attributes&nbsp;that&nbsp;will&nbsp;be&nbsp;applied&nbsp;to&nbsp;a&nbsp;new&nbsp;process&nbsp;started</span><br>
<span class="lineno"></span><span class="comment" id="2386956">//&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno">120</span><span class="keyword" id="2386976">type</span>&nbsp;<span class="ident" id="2386981">ProcAttr</span>&nbsp;<span class="keyword" id="2386990">struct</span>&nbsp;<span class="op" id="2386997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2387000">Dir</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2387006">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2387016">//&nbsp;Current&nbsp;working&nbsp;directory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2387047">Env</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2387053">[</span><span class="op" id="2387054">]</span><span class="builtintype" id="2387055">string</span>&nbsp;&nbsp;<span class="comment" id="2387063">//&nbsp;Environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2387080">Files</span>&nbsp;<span class="op" id="2387086">[</span><span class="op" id="2387087">]</span><span class="builtintype" id="2387088">uintptr</span>&nbsp;<span class="comment" id="2387096">//&nbsp;File&nbsp;descriptors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2387118">Sys</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2387124">*</span><span class="ident" id="2387125">SysProcAttr</span><br>
<span class="lineno">125</span><span class="op" id="2387137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2387140">var</span>&nbsp;<span class="ident" id="2387144">zeroProcAttr</span>&nbsp;<span class="ident" id="2387157">ProcAttr</span><br>
<span class="lineno"></span><span class="keyword" id="2387166">var</span>&nbsp;<span class="ident" id="2387170">zeroSysProcAttr</span>&nbsp;<span class="ident" id="2387186">SysProcAttr</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2387199">func</span>&nbsp;<span class="ident" id="2387204">forkExec</span><span class="op" id="2387212">(</span><span class="ident" id="2387213">argv0</span>&nbsp;<span class="builtintype" id="2387219">string</span><span class="op" id="2387225">,</span>&nbsp;<span class="ident" id="2387227">argv</span>&nbsp;<span class="op" id="2387232">[</span><span class="op" id="2387233">]</span><span class="builtintype" id="2387234">string</span><span class="op" id="2387240">,</span>&nbsp;<span class="ident" id="2387242">attr</span>&nbsp;<span class="op" id="2387247">*</span><span class="ident" id="2387248">ProcAttr</span><span class="op" id="2387256">)</span>&nbsp;<span class="op" id="2387258">(</span><span class="ident" id="2387259">pid</span>&nbsp;<span class="builtintype" id="2387263">int</span><span class="op" id="2387266">,</span>&nbsp;<span class="ident" id="2387268">err</span>&nbsp;<span class="builtintype" id="2387272">error</span><span class="op" id="2387277">)</span>&nbsp;<span class="op" id="2387279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387282">var</span>&nbsp;<span class="ident" id="2387286">p</span>&nbsp;<span class="op" id="2387288">[</span><span class="num" id="2387289">2</span><span class="op" id="2387290">]</span><span class="builtintype" id="2387291">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387296">var</span>&nbsp;<span class="ident" id="2387300">n</span>&nbsp;<span class="builtintype" id="2387302">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387307">var</span>&nbsp;<span class="ident" id="2387311">err1</span>&nbsp;<span class="ident" id="2387316">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387323">var</span>&nbsp;<span class="ident" id="2387327">wstatus</span>&nbsp;<span class="ident" id="2387335">WaitStatus</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387348">if</span>&nbsp;<span class="ident" id="2387351">attr</span>&nbsp;<span class="op" id="2387356">==</span>&nbsp;<span class="builtintype" id="2387359">nil</span>&nbsp;<span class="op" id="2387363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2387367">attr</span>&nbsp;<span class="op" id="2387372">=</span>&nbsp;<span class="op" id="2387374">&amp;</span><span class="ident" id="2387375">zeroProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2387389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2387392">sys</span>&nbsp;<span class="op" id="2387396">:=</span>&nbsp;<span class="ident" id="2387399">attr</span><span class="op" id="2387403">.</span><span class="ident" id="2387404">Sys</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387409">if</span>&nbsp;<span class="ident" id="2387412">sys</span>&nbsp;<span class="op" id="2387416">==</span>&nbsp;<span class="builtintype" id="2387419">nil</span>&nbsp;<span class="op" id="2387423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2387427">sys</span>&nbsp;<span class="op" id="2387431">=</span>&nbsp;<span class="op" id="2387433">&amp;</span><span class="ident" id="2387434">zeroSysProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2387451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2387455">p</span><span class="op" id="2387456">[</span><span class="num" id="2387457">0</span><span class="op" id="2387458">]</span>&nbsp;<span class="op" id="2387460">=</span>&nbsp;<span class="op" id="2387462">-</span><span class="num" id="2387463">1</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2387466">p</span><span class="op" id="2387467">[</span><span class="num" id="2387468">1</span><span class="op" id="2387469">]</span>&nbsp;<span class="op" id="2387471">=</span>&nbsp;<span class="op" id="2387473">-</span><span class="num" id="2387474">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2387478">//&nbsp;Convert&nbsp;args&nbsp;to&nbsp;C&nbsp;form.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2387506">argv0p</span><span class="op" id="2387512">,</span>&nbsp;<span class="ident" id="2387514">err</span>&nbsp;<span class="op" id="2387518">:=</span>&nbsp;<span class="ident" id="2387521">BytePtrFromString</span><span class="op" id="2387538">(</span><span class="ident" id="2387539">argv0</span><span class="op" id="2387544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387547">if</span>&nbsp;<span class="ident" id="2387550">err</span>&nbsp;<span class="op" id="2387554">!=</span>&nbsp;<span class="builtintype" id="2387557">nil</span>&nbsp;<span class="op" id="2387561">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387565">return</span>&nbsp;<span class="num" id="2387572">0</span><span class="op" id="2387573">,</span>&nbsp;<span class="ident" id="2387575">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2387580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2387583">argvp</span><span class="op" id="2387588">,</span>&nbsp;<span class="ident" id="2387590">err</span>&nbsp;<span class="op" id="2387594">:=</span>&nbsp;<span class="ident" id="2387597">SlicePtrFromStrings</span><span class="op" id="2387616">(</span><span class="ident" id="2387617">argv</span><span class="op" id="2387621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387624">if</span>&nbsp;<span class="ident" id="2387627">err</span>&nbsp;<span class="op" id="2387631">!=</span>&nbsp;<span class="builtintype" id="2387634">nil</span>&nbsp;<span class="op" id="2387638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387642">return</span>&nbsp;<span class="num" id="2387649">0</span><span class="op" id="2387650">,</span>&nbsp;<span class="ident" id="2387652">err</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2387657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2387660">envvp</span><span class="op" id="2387665">,</span>&nbsp;<span class="ident" id="2387667">err</span>&nbsp;<span class="op" id="2387671">:=</span>&nbsp;<span class="ident" id="2387674">SlicePtrFromStrings</span><span class="op" id="2387693">(</span><span class="ident" id="2387694">attr</span><span class="op" id="2387698">.</span><span class="ident" id="2387699">Env</span><span class="op" id="2387702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387705">if</span>&nbsp;<span class="ident" id="2387708">err</span>&nbsp;<span class="op" id="2387712">!=</span>&nbsp;<span class="builtintype" id="2387715">nil</span>&nbsp;<span class="op" id="2387719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387723">return</span>&nbsp;<span class="num" id="2387730">0</span><span class="op" id="2387731">,</span>&nbsp;<span class="ident" id="2387733">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2387738">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387742">if</span>&nbsp;<span class="op" id="2387745">(</span><span class="ident" id="2387746">runtime</span><span class="op" id="2387753">.</span><span class="ident" id="2387754">GOOS</span>&nbsp;<span class="op" id="2387759">==</span>&nbsp;<span class="string" id="2387762">&#34;freebsd&#34;</span>&nbsp;<span class="op" id="2387772">||</span>&nbsp;<span class="ident" id="2387775">runtime</span><span class="op" id="2387782">.</span><span class="ident" id="2387783">GOOS</span>&nbsp;<span class="op" id="2387788">==</span>&nbsp;<span class="string" id="2387791">&#34;dragonfly&#34;</span><span class="op" id="2387802">)</span>&nbsp;<span class="op" id="2387804">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2387807">len</span><span class="op" id="2387810">(</span><span class="ident" id="2387811">argv</span><span class="op" id="2387815">[</span><span class="num" id="2387816">0</span><span class="op" id="2387817">]</span><span class="op" id="2387818">)</span>&nbsp;<span class="op" id="2387820">&gt;</span>&nbsp;<span class="builtinfunc" id="2387822">len</span><span class="op" id="2387825">(</span><span class="ident" id="2387826">argv0</span><span class="op" id="2387831">)</span>&nbsp;<span class="op" id="2387833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2387837">argvp</span><span class="op" id="2387842">[</span><span class="num" id="2387843">0</span><span class="op" id="2387844">]</span>&nbsp;<span class="op" id="2387846">=</span>&nbsp;<span class="ident" id="2387848">argv0p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2387856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387860">var</span>&nbsp;<span class="ident" id="2387864">chroot</span>&nbsp;<span class="op" id="2387871">*</span><span class="builtintype" id="2387872">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387878">if</span>&nbsp;<span class="ident" id="2387881">sys</span><span class="op" id="2387884">.</span><span class="ident" id="2387885">Chroot</span>&nbsp;<span class="op" id="2387892">!=</span>&nbsp;<span class="string" id="2387895">&#34;&#34;</span>&nbsp;<span class="op" id="2387898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2387902">chroot</span><span class="op" id="2387908">,</span>&nbsp;<span class="ident" id="2387910">err</span>&nbsp;<span class="op" id="2387914">=</span>&nbsp;<span class="ident" id="2387916">BytePtrFromString</span><span class="op" id="2387933">(</span><span class="ident" id="2387934">sys</span><span class="op" id="2387937">.</span><span class="ident" id="2387938">Chroot</span><span class="op" id="2387944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387948">if</span>&nbsp;<span class="ident" id="2387951">err</span>&nbsp;<span class="op" id="2387955">!=</span>&nbsp;<span class="builtintype" id="2387958">nil</span>&nbsp;<span class="op" id="2387962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387967">return</span>&nbsp;<span class="num" id="2387974">0</span><span class="op" id="2387975">,</span>&nbsp;<span class="ident" id="2387977">err</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2387983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2387986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2387989">var</span>&nbsp;<span class="ident" id="2387993">dir</span>&nbsp;<span class="op" id="2387997">*</span><span class="builtintype" id="2387998">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2388004">if</span>&nbsp;<span class="ident" id="2388007">attr</span><span class="op" id="2388011">.</span><span class="ident" id="2388012">Dir</span>&nbsp;<span class="op" id="2388016">!=</span>&nbsp;<span class="string" id="2388019">&#34;&#34;</span>&nbsp;<span class="op" id="2388022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2388026">dir</span><span class="op" id="2388029">,</span>&nbsp;<span class="ident" id="2388031">err</span>&nbsp;<span class="op" id="2388035">=</span>&nbsp;<span class="ident" id="2388037">BytePtrFromString</span><span class="op" id="2388054">(</span><span class="ident" id="2388055">attr</span><span class="op" id="2388059">.</span><span class="ident" id="2388060">Dir</span><span class="op" id="2388063">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2388067">if</span>&nbsp;<span class="ident" id="2388070">err</span>&nbsp;<span class="op" id="2388074">!=</span>&nbsp;<span class="builtintype" id="2388077">nil</span>&nbsp;<span class="op" id="2388081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2388086">return</span>&nbsp;<span class="num" id="2388093">0</span><span class="op" id="2388094">,</span>&nbsp;<span class="ident" id="2388096">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2388102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2388105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2388109">//&nbsp;Acquire&nbsp;the&nbsp;fork&nbsp;lock&nbsp;so&nbsp;that&nbsp;no&nbsp;other&nbsp;threads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2388160">//&nbsp;create&nbsp;new&nbsp;fds&nbsp;that&nbsp;are&nbsp;not&nbsp;yet&nbsp;close-on-exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2388210">//&nbsp;before&nbsp;we&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2388230">ForkLock</span><span class="op" id="2388238">.</span><span class="ident" id="2388239">Lock</span><span class="op" id="2388243">(</span><span class="op" id="2388244">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2388248">//&nbsp;Allocate&nbsp;child&nbsp;status&nbsp;pipe&nbsp;close&nbsp;on&nbsp;exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2388294">if</span>&nbsp;<span class="ident" id="2388297">err</span>&nbsp;<span class="op" id="2388301">=</span>&nbsp;<span class="ident" id="2388303">forkExecPipe</span><span class="op" id="2388315">(</span><span class="ident" id="2388316">p</span><span class="op" id="2388317">[</span><span class="op" id="2388318">:</span><span class="op" id="2388319">]</span><span class="op" id="2388320">)</span><span class="op" id="2388321">;</span>&nbsp;<span class="ident" id="2388323">err</span>&nbsp;<span class="op" id="2388327">!=</span>&nbsp;<span class="builtintype" id="2388330">nil</span>&nbsp;<span class="op" id="2388334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2388338">goto</span>&nbsp;<span class="builtintype" id="2388343">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2388350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2388354">//&nbsp;Kick&nbsp;off&nbsp;child.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2388374">pid</span><span class="op" id="2388377">,</span>&nbsp;<span class="ident" id="2388379">err1</span>&nbsp;<span class="op" id="2388384">=</span>&nbsp;<span class="ident" id="2388386">forkAndExecInChild</span><span class="op" id="2388404">(</span><span class="ident" id="2388405">argv0p</span><span class="op" id="2388411">,</span>&nbsp;<span class="ident" id="2388413">argvp</span><span class="op" id="2388418">,</span>&nbsp;<span class="ident" id="2388420">envvp</span><span class="op" id="2388425">,</span>&nbsp;<span class="ident" id="2388427">chroot</span><span class="op" id="2388433">,</span>&nbsp;<span class="ident" id="2388435">dir</span><span class="op" id="2388438">,</span>&nbsp;<span class="ident" id="2388440">attr</span><span class="op" id="2388444">,</span>&nbsp;<span class="ident" id="2388446">sys</span><span class="op" id="2388449">,</span>&nbsp;<span class="ident" id="2388451">p</span><span class="op" id="2388452">[</span><span class="num" id="2388453">1</span><span class="op" id="2388454">]</span><span class="op" id="2388455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2388458">if</span>&nbsp;<span class="ident" id="2388461">err1</span>&nbsp;<span class="op" id="2388466">!=</span>&nbsp;<span class="num" id="2388469">0</span>&nbsp;<span class="op" id="2388471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2388475">err</span>&nbsp;<span class="op" id="2388479">=</span>&nbsp;<span class="ident" id="2388481">Errno</span><span class="op" id="2388486">(</span><span class="ident" id="2388487">err1</span><span class="op" id="2388491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2388495">goto</span>&nbsp;<span class="builtintype" id="2388500">error</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2388507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2388510">ForkLock</span><span class="op" id="2388518">.</span><span class="ident" id="2388519">Unlock</span><span class="op" id="2388525">(</span><span class="op" id="2388526">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2388530">//&nbsp;Read&nbsp;child&nbsp;error&nbsp;status&nbsp;from&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2388569">Close</span><span class="op" id="2388574">(</span><span class="ident" id="2388575">p</span><span class="op" id="2388576">[</span><span class="num" id="2388577">1</span><span class="op" id="2388578">]</span><span class="op" id="2388579">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2388582">n</span><span class="op" id="2388583">,</span>&nbsp;<span class="ident" id="2388585">err</span>&nbsp;<span class="op" id="2388589">=</span>&nbsp;<span class="ident" id="2388591">readlen</span><span class="op" id="2388598">(</span><span class="ident" id="2388599">p</span><span class="op" id="2388600">[</span><span class="num" id="2388601">0</span><span class="op" id="2388602">]</span><span class="op" id="2388603">,</span>&nbsp;<span class="op" id="2388605">(</span><span class="op" id="2388606">*</span><span class="builtintype" id="2388607">byte</span><span class="op" id="2388611">)</span><span class="op" id="2388612">(</span><span class="ident" id="2388613">unsafe</span><span class="op" id="2388619">.</span><span class="ident" id="2388620">Pointer</span><span class="op" id="2388627">(</span><span class="op" id="2388628">&amp;</span><span class="ident" id="2388629">err1</span><span class="op" id="2388633">)</span><span class="op" id="2388634">)</span><span class="op" id="2388635">,</span>&nbsp;<span class="builtintype" id="2388637">int</span><span class="op" id="2388640">(</span><span class="ident" id="2388641">unsafe</span><span class="op" id="2388647">.</span><span class="ident" id="2388648">Sizeof</span><span class="op" id="2388654">(</span><span class="ident" id="2388655">err1</span><span class="op" id="2388659">)</span><span class="op" id="2388660">)</span><span class="op" id="2388661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2388664">Close</span><span class="op" id="2388669">(</span><span class="ident" id="2388670">p</span><span class="op" id="2388671">[</span><span class="num" id="2388672">0</span><span class="op" id="2388673">]</span><span class="op" id="2388674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2388677">if</span>&nbsp;<span class="ident" id="2388680">err</span>&nbsp;<span class="op" id="2388684">!=</span>&nbsp;<span class="builtintype" id="2388687">nil</span>&nbsp;<span class="op" id="2388691">||</span>&nbsp;<span class="ident" id="2388694">n</span>&nbsp;<span class="op" id="2388696">!=</span>&nbsp;<span class="num" id="2388699">0</span>&nbsp;<span class="op" id="2388701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2388705">if</span>&nbsp;<span class="ident" id="2388708">n</span>&nbsp;<span class="op" id="2388710">==</span>&nbsp;<span class="builtintype" id="2388713">int</span><span class="op" id="2388716">(</span><span class="ident" id="2388717">unsafe</span><span class="op" id="2388723">.</span><span class="ident" id="2388724">Sizeof</span><span class="op" id="2388730">(</span><span class="ident" id="2388731">err1</span><span class="op" id="2388735">)</span><span class="op" id="2388736">)</span>&nbsp;<span class="op" id="2388738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2388743">err</span>&nbsp;<span class="op" id="2388747">=</span>&nbsp;<span class="ident" id="2388749">Errno</span><span class="op" id="2388754">(</span><span class="ident" id="2388755">err1</span><span class="op" id="2388759">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2388763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2388767">if</span>&nbsp;<span class="ident" id="2388770">err</span>&nbsp;<span class="op" id="2388774">==</span>&nbsp;<span class="builtintype" id="2388777">nil</span>&nbsp;<span class="op" id="2388781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2388786">err</span>&nbsp;<span class="op" id="2388790">=</span>&nbsp;<span class="ident" id="2388792">EPIPE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2388800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2388805">//&nbsp;Child&nbsp;failed;&nbsp;wait&nbsp;for&nbsp;it&nbsp;to&nbsp;exit,&nbsp;to&nbsp;make&nbsp;sure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2388858">//&nbsp;the&nbsp;zombies&nbsp;don&#39;t&nbsp;accumulate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2388893">_</span><span class="op" id="2388894">,</span>&nbsp;<span class="ident" id="2388896">err1</span>&nbsp;<span class="op" id="2388901">:=</span>&nbsp;<span class="ident" id="2388904">Wait4</span><span class="op" id="2388909">(</span><span class="ident" id="2388910">pid</span><span class="op" id="2388913">,</span>&nbsp;<span class="op" id="2388915">&amp;</span><span class="ident" id="2388916">wstatus</span><span class="op" id="2388923">,</span>&nbsp;<span class="num" id="2388925">0</span><span class="op" id="2388926">,</span>&nbsp;<span class="builtintype" id="2388928">nil</span><span class="op" id="2388931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2388935">for</span>&nbsp;<span class="ident" id="2388939">err1</span>&nbsp;<span class="op" id="2388944">==</span>&nbsp;<span class="ident" id="2388947">EINTR</span>&nbsp;<span class="op" id="2388953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2388958">_</span><span class="op" id="2388959">,</span>&nbsp;<span class="ident" id="2388961">err1</span>&nbsp;<span class="op" id="2388966">=</span>&nbsp;<span class="ident" id="2388968">Wait4</span><span class="op" id="2388973">(</span><span class="ident" id="2388974">pid</span><span class="op" id="2388977">,</span>&nbsp;<span class="op" id="2388979">&amp;</span><span class="ident" id="2388980">wstatus</span><span class="op" id="2388987">,</span>&nbsp;<span class="num" id="2388989">0</span><span class="op" id="2388990">,</span>&nbsp;<span class="builtintype" id="2388992">nil</span><span class="op" id="2388995">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2388999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2389003">return</span>&nbsp;<span class="num" id="2389010">0</span><span class="op" id="2389011">,</span>&nbsp;<span class="ident" id="2389013">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2389018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2389022">//&nbsp;Read&nbsp;got&nbsp;EOF,&nbsp;so&nbsp;pipe&nbsp;closed&nbsp;on&nbsp;exec,&nbsp;so&nbsp;exec&nbsp;succeeded.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2389083">return</span>&nbsp;<span class="ident" id="2389090">pid</span><span class="op" id="2389093">,</span>&nbsp;<span class="builtintype" id="2389095">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="builtintype" id="2389100">error</span><span class="op" id="2389105">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2389108">if</span>&nbsp;<span class="ident" id="2389111">p</span><span class="op" id="2389112">[</span><span class="num" id="2389113">0</span><span class="op" id="2389114">]</span>&nbsp;<span class="op" id="2389116">&gt;=</span>&nbsp;<span class="num" id="2389119">0</span>&nbsp;<span class="op" id="2389121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2389125">Close</span><span class="op" id="2389130">(</span><span class="ident" id="2389131">p</span><span class="op" id="2389132">[</span><span class="num" id="2389133">0</span><span class="op" id="2389134">]</span><span class="op" id="2389135">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2389139">Close</span><span class="op" id="2389144">(</span><span class="ident" id="2389145">p</span><span class="op" id="2389146">[</span><span class="num" id="2389147">1</span><span class="op" id="2389148">]</span><span class="op" id="2389149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2389152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2389155">ForkLock</span><span class="op" id="2389163">.</span><span class="ident" id="2389164">Unlock</span><span class="op" id="2389170">(</span><span class="op" id="2389171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2389174">return</span>&nbsp;<span class="num" id="2389181">0</span><span class="op" id="2389182">,</span>&nbsp;<span class="ident" id="2389184">err</span><br>
<span class="lineno"></span><span class="op" id="2389188">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="2389191">//&nbsp;Combination&nbsp;of&nbsp;fork&nbsp;and&nbsp;exec,&nbsp;careful&nbsp;to&nbsp;be&nbsp;thread&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="2389251">func</span>&nbsp;<span class="ident" id="2389256">ForkExec</span><span class="op" id="2389264">(</span><span class="ident" id="2389265">argv0</span>&nbsp;<span class="builtintype" id="2389271">string</span><span class="op" id="2389277">,</span>&nbsp;<span class="ident" id="2389279">argv</span>&nbsp;<span class="op" id="2389284">[</span><span class="op" id="2389285">]</span><span class="builtintype" id="2389286">string</span><span class="op" id="2389292">,</span>&nbsp;<span class="ident" id="2389294">attr</span>&nbsp;<span class="op" id="2389299">*</span><span class="ident" id="2389300">ProcAttr</span><span class="op" id="2389308">)</span>&nbsp;<span class="op" id="2389310">(</span><span class="ident" id="2389311">pid</span>&nbsp;<span class="builtintype" id="2389315">int</span><span class="op" id="2389318">,</span>&nbsp;<span class="ident" id="2389320">err</span>&nbsp;<span class="builtintype" id="2389324">error</span><span class="op" id="2389329">)</span>&nbsp;<span class="op" id="2389331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2389334">return</span>&nbsp;<span class="ident" id="2389341">forkExec</span><span class="op" id="2389349">(</span><span class="ident" id="2389350">argv0</span><span class="op" id="2389355">,</span>&nbsp;<span class="ident" id="2389357">argv</span><span class="op" id="2389361">,</span>&nbsp;<span class="ident" id="2389363">attr</span><span class="op" id="2389367">)</span><br>
<span class="lineno"></span><span class="op" id="2389369">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="2389372">//&nbsp;StartProcess&nbsp;wraps&nbsp;ForkExec&nbsp;for&nbsp;package&nbsp;os.</span><br>
<span class="lineno"></span><span class="keyword" id="2389419">func</span>&nbsp;<span class="ident" id="2389424">StartProcess</span><span class="op" id="2389436">(</span><span class="ident" id="2389437">argv0</span>&nbsp;<span class="builtintype" id="2389443">string</span><span class="op" id="2389449">,</span>&nbsp;<span class="ident" id="2389451">argv</span>&nbsp;<span class="op" id="2389456">[</span><span class="op" id="2389457">]</span><span class="builtintype" id="2389458">string</span><span class="op" id="2389464">,</span>&nbsp;<span class="ident" id="2389466">attr</span>&nbsp;<span class="op" id="2389471">*</span><span class="ident" id="2389472">ProcAttr</span><span class="op" id="2389480">)</span>&nbsp;<span class="op" id="2389482">(</span><span class="ident" id="2389483">pid</span>&nbsp;<span class="builtintype" id="2389487">int</span><span class="op" id="2389490">,</span>&nbsp;<span class="ident" id="2389492">handle</span>&nbsp;<span class="builtintype" id="2389499">uintptr</span><span class="op" id="2389506">,</span>&nbsp;<span class="ident" id="2389508">err</span>&nbsp;<span class="builtintype" id="2389512">error</span><span class="op" id="2389517">)</span>&nbsp;<span class="op" id="2389519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2389522">pid</span><span class="op" id="2389525">,</span>&nbsp;<span class="ident" id="2389527">err</span>&nbsp;<span class="op" id="2389531">=</span>&nbsp;<span class="ident" id="2389533">forkExec</span><span class="op" id="2389541">(</span><span class="ident" id="2389542">argv0</span><span class="op" id="2389547">,</span>&nbsp;<span class="ident" id="2389549">argv</span><span class="op" id="2389553">,</span>&nbsp;<span class="ident" id="2389555">attr</span><span class="op" id="2389559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2389562">return</span>&nbsp;<span class="ident" id="2389569">pid</span><span class="op" id="2389572">,</span>&nbsp;<span class="num" id="2389574">0</span><span class="op" id="2389575">,</span>&nbsp;<span class="ident" id="2389577">err</span><br>
<span class="lineno">240</span><span class="op" id="2389581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2389584">//&nbsp;Ordinary&nbsp;exec.</span><br>
<span class="lineno"></span><span class="keyword" id="2389602">func</span>&nbsp;<span class="ident" id="2389607">Exec</span><span class="op" id="2389611">(</span><span class="ident" id="2389612">argv0</span>&nbsp;<span class="builtintype" id="2389618">string</span><span class="op" id="2389624">,</span>&nbsp;<span class="ident" id="2389626">argv</span>&nbsp;<span class="op" id="2389631">[</span><span class="op" id="2389632">]</span><span class="builtintype" id="2389633">string</span><span class="op" id="2389639">,</span>&nbsp;<span class="ident" id="2389641">envv</span>&nbsp;<span class="op" id="2389646">[</span><span class="op" id="2389647">]</span><span class="builtintype" id="2389648">string</span><span class="op" id="2389654">)</span>&nbsp;<span class="op" id="2389656">(</span><span class="ident" id="2389657">err</span>&nbsp;<span class="builtintype" id="2389661">error</span><span class="op" id="2389666">)</span>&nbsp;<span class="op" id="2389668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2389671">argv0p</span><span class="op" id="2389677">,</span>&nbsp;<span class="ident" id="2389679">err</span>&nbsp;<span class="op" id="2389683">:=</span>&nbsp;<span class="ident" id="2389686">BytePtrFromString</span><span class="op" id="2389703">(</span><span class="ident" id="2389704">argv0</span><span class="op" id="2389709">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2389712">if</span>&nbsp;<span class="ident" id="2389715">err</span>&nbsp;<span class="op" id="2389719">!=</span>&nbsp;<span class="builtintype" id="2389722">nil</span>&nbsp;<span class="op" id="2389726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2389730">return</span>&nbsp;<span class="ident" id="2389737">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2389742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2389745">argvp</span><span class="op" id="2389750">,</span>&nbsp;<span class="ident" id="2389752">err</span>&nbsp;<span class="op" id="2389756">:=</span>&nbsp;<span class="ident" id="2389759">SlicePtrFromStrings</span><span class="op" id="2389778">(</span><span class="ident" id="2389779">argv</span><span class="op" id="2389783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2389786">if</span>&nbsp;<span class="ident" id="2389789">err</span>&nbsp;<span class="op" id="2389793">!=</span>&nbsp;<span class="builtintype" id="2389796">nil</span>&nbsp;<span class="op" id="2389800">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2389804">return</span>&nbsp;<span class="ident" id="2389811">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2389816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2389819">envvp</span><span class="op" id="2389824">,</span>&nbsp;<span class="ident" id="2389826">err</span>&nbsp;<span class="op" id="2389830">:=</span>&nbsp;<span class="ident" id="2389833">SlicePtrFromStrings</span><span class="op" id="2389852">(</span><span class="ident" id="2389853">envv</span><span class="op" id="2389857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2389860">if</span>&nbsp;<span class="ident" id="2389863">err</span>&nbsp;<span class="op" id="2389867">!=</span>&nbsp;<span class="builtintype" id="2389870">nil</span>&nbsp;<span class="op" id="2389874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2389878">return</span>&nbsp;<span class="ident" id="2389885">err</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2389890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2389893">_</span><span class="op" id="2389894">,</span>&nbsp;<span class="ident" id="2389896">_</span><span class="op" id="2389897">,</span>&nbsp;<span class="ident" id="2389899">err1</span>&nbsp;<span class="op" id="2389904">:=</span>&nbsp;<span class="ident" id="2389907">RawSyscall</span><span class="op" id="2389917">(</span><span class="ident" id="2389918">SYS_EXECVE</span><span class="op" id="2389928">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2389932">uintptr</span><span class="op" id="2389939">(</span><span class="ident" id="2389940">unsafe</span><span class="op" id="2389946">.</span><span class="ident" id="2389947">Pointer</span><span class="op" id="2389954">(</span><span class="ident" id="2389955">argv0p</span><span class="op" id="2389961">)</span><span class="op" id="2389962">)</span><span class="op" id="2389963">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2389967">uintptr</span><span class="op" id="2389974">(</span><span class="ident" id="2389975">unsafe</span><span class="op" id="2389981">.</span><span class="ident" id="2389982">Pointer</span><span class="op" id="2389989">(</span><span class="op" id="2389990">&amp;</span><span class="ident" id="2389991">argvp</span><span class="op" id="2389996">[</span><span class="num" id="2389997">0</span><span class="op" id="2389998">]</span><span class="op" id="2389999">)</span><span class="op" id="2390000">)</span><span class="op" id="2390001">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2390005">uintptr</span><span class="op" id="2390012">(</span><span class="ident" id="2390013">unsafe</span><span class="op" id="2390019">.</span><span class="ident" id="2390020">Pointer</span><span class="op" id="2390027">(</span><span class="op" id="2390028">&amp;</span><span class="ident" id="2390029">envvp</span><span class="op" id="2390034">[</span><span class="num" id="2390035">0</span><span class="op" id="2390036">]</span><span class="op" id="2390037">)</span><span class="op" id="2390038">)</span><span class="op" id="2390039">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2390042">return</span>&nbsp;<span class="ident" id="2390049">Errno</span><span class="op" id="2390054">(</span><span class="ident" id="2390055">err1</span><span class="op" id="2390059">)</span><br>
<span class="lineno"></span><span class="op" id="2390061">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
