<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5537603">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5537658">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5537712">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5537763">//&nbsp;HTTP&nbsp;reverse&nbsp;proxy&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5537794">package</span>&nbsp;<span class="ident" id="5537802">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5537812">import</span>&nbsp;<span class="op" id="5537819">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5537822">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5537828">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5537835">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5537842">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5537854">&#34;net/url&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5537865">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5537876">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5537884">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="5537891">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5537894">//&nbsp;onExitFlushLoop&nbsp;is&nbsp;a&nbsp;callback&nbsp;set&nbsp;by&nbsp;tests&nbsp;to&nbsp;detect&nbsp;the&nbsp;state&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5537967">//&nbsp;flushLoop()&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="5537993">var</span>&nbsp;<span class="ident" id="5537997">onExitFlushLoop</span>&nbsp;<span class="keyword" id="5538013">func</span><span class="op" id="5538017">(</span><span class="op" id="5538018">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5538021">//&nbsp;ReverseProxy&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;that&nbsp;takes&nbsp;an&nbsp;incoming&nbsp;request&nbsp;and</span><br>
<span class="lineno">25</span><span class="comment" id="5538091">//&nbsp;sends&nbsp;it&nbsp;to&nbsp;another&nbsp;server,&nbsp;proxying&nbsp;the&nbsp;response&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5538156">//&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="5538167">type</span>&nbsp;<span class="ident" id="5538172">ReverseProxy</span>&nbsp;<span class="keyword" id="5538185">struct</span>&nbsp;<span class="op" id="5538192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538195">//&nbsp;Director&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;which&nbsp;modifies</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538242">//&nbsp;the&nbsp;request&nbsp;into&nbsp;a&nbsp;new&nbsp;request&nbsp;to&nbsp;be&nbsp;sent</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538288">//&nbsp;using&nbsp;Transport.&nbsp;Its&nbsp;response&nbsp;is&nbsp;then&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538337">//&nbsp;back&nbsp;to&nbsp;the&nbsp;original&nbsp;client&nbsp;unmodified.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538381">Director</span>&nbsp;<span class="keyword" id="5538390">func</span><span class="op" id="5538394">(</span><span class="op" id="5538395">*</span><span class="ident" id="5538396"><a href="/net/http/httputil/reverseproxy.go.html#5537842">http</a></span><span class="op" id="5538400">.</span><span class="ident" id="5538401">Request</span><span class="op" id="5538408">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538412">//&nbsp;The&nbsp;transport&nbsp;used&nbsp;to&nbsp;perform&nbsp;proxy&nbsp;requests.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538462">//&nbsp;If&nbsp;nil,&nbsp;http.DefaultTransport&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538505">Transport</span>&nbsp;<span class="ident" id="5538515"><a href="/net/http/httputil/reverseproxy.go.html#5537842">http</a></span><span class="op" id="5538519">.</span><span class="ident" id="5538520">RoundTripper</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538535">//&nbsp;FlushInterval&nbsp;specifies&nbsp;the&nbsp;flush&nbsp;interval</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538582">//&nbsp;to&nbsp;flush&nbsp;to&nbsp;the&nbsp;client&nbsp;while&nbsp;copying&nbsp;the</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538627">//&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538646">//&nbsp;If&nbsp;zero,&nbsp;no&nbsp;periodic&nbsp;flushing&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538689">FlushInterval</span>&nbsp;<span class="ident" id="5538703"><a href="/net/http/httputil/reverseproxy.go.html#5537884">time</a></span><span class="op" id="5538707">.</span><span class="ident" id="5538708">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538719">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538772">//&nbsp;that&nbsp;occur&nbsp;when&nbsp;attempting&nbsp;to&nbsp;proxy&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538825">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5538885">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538906">ErrorLog</span>&nbsp;<span class="op" id="5538915">*</span><span class="ident" id="5538916"><a href="/net/http/httputil/reverseproxy.go.html#5537828">log</a></span><span class="op" id="5538919">.</span><span class="ident" id="5538920">Logger</span><br>
<span class="lineno"></span><span class="op" id="5538927">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="5538930">func</span>&nbsp;<span class="ident" id="5538935">singleJoiningSlash</span><span class="op" id="5538953">(</span><span class="ident" id="5538954">a</span><span class="op" id="5538955">,</span>&nbsp;<span class="ident" id="5538957">b</span>&nbsp;<span class="builtintype" id="5538959">string</span><span class="op" id="5538965">)</span>&nbsp;<span class="builtintype" id="5538967">string</span>&nbsp;<span class="op" id="5538974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5538977">aslash</span>&nbsp;<span class="op" id="5538984">:=</span>&nbsp;<span class="ident" id="5538987"><a href="/net/http/httputil/reverseproxy.go.html#5537865">strings</a></span><span class="op" id="5538994">.</span><span class="ident" id="5538995">HasSuffix</span><span class="op" id="5539004">(</span><span class="ident" id="5539005"><a href="/net/http/httputil/reverseproxy.go.html#5538954">a</a></span><span class="op" id="5539006">,</span>&nbsp;<span class="string" id="5539008">&#34;/&#34;</span><span class="op" id="5539011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539014">bslash</span>&nbsp;<span class="op" id="5539021">:=</span>&nbsp;<span class="ident" id="5539024"><a href="/net/http/httputil/reverseproxy.go.html#5537865">strings</a></span><span class="op" id="5539031">.</span><span class="ident" id="5539032">HasPrefix</span><span class="op" id="5539041">(</span><span class="ident" id="5539042"><a href="/net/http/httputil/reverseproxy.go.html#5538957">b</a></span><span class="op" id="5539043">,</span>&nbsp;<span class="string" id="5539045">&#34;/&#34;</span><span class="op" id="5539048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539051">switch</span>&nbsp;<span class="op" id="5539058">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539061">case</span>&nbsp;<span class="ident" id="5539066"><a href="/net/http/httputil/reverseproxy.go.html#5538977">aslash</a></span>&nbsp;<span class="op" id="5539073">&amp;&amp;</span>&nbsp;<span class="ident" id="5539076"><a href="/net/http/httputil/reverseproxy.go.html#5539014">bslash</a></span><span class="op" id="5539082">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539086">return</span>&nbsp;<span class="ident" id="5539093"><a href="/net/http/httputil/reverseproxy.go.html#5538954">a</a></span>&nbsp;<span class="op" id="5539095">+</span>&nbsp;<span class="ident" id="5539097"><a href="/net/http/httputil/reverseproxy.go.html#5538957">b</a></span><span class="op" id="5539098">[</span><span class="num" id="5539099">1</span><span class="op" id="5539100">:</span><span class="op" id="5539101">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539104">case</span>&nbsp;<span class="op" id="5539109">!</span><span class="ident" id="5539110"><a href="/net/http/httputil/reverseproxy.go.html#5538977">aslash</a></span>&nbsp;<span class="op" id="5539117">&amp;&amp;</span>&nbsp;<span class="op" id="5539120">!</span><span class="ident" id="5539121"><a href="/net/http/httputil/reverseproxy.go.html#5539014">bslash</a></span><span class="op" id="5539127">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539131">return</span>&nbsp;<span class="ident" id="5539138"><a href="/net/http/httputil/reverseproxy.go.html#5538954">a</a></span>&nbsp;<span class="op" id="5539140">+</span>&nbsp;<span class="string" id="5539142">&#34;/&#34;</span>&nbsp;<span class="op" id="5539146">+</span>&nbsp;<span class="ident" id="5539148"><a href="/net/http/httputil/reverseproxy.go.html#5538957">b</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5539151">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539154">return</span>&nbsp;<span class="ident" id="5539161"><a href="/net/http/httputil/reverseproxy.go.html#5538954">a</a></span>&nbsp;<span class="op" id="5539163">+</span>&nbsp;<span class="ident" id="5539165"><a href="/net/http/httputil/reverseproxy.go.html#5538957">b</a></span><br>
<span class="lineno"></span><span class="op" id="5539167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5539170">//&nbsp;NewSingleHostReverseProxy&nbsp;returns&nbsp;a&nbsp;new&nbsp;ReverseProxy&nbsp;that&nbsp;rewrites</span><br>
<span class="lineno"></span><span class="comment" id="5539240">//&nbsp;URLs&nbsp;to&nbsp;the&nbsp;scheme,&nbsp;host,&nbsp;and&nbsp;base&nbsp;path&nbsp;provided&nbsp;in&nbsp;target.&nbsp;If&nbsp;the</span><br>
<span class="lineno">65</span><span class="comment" id="5539310">//&nbsp;target&#39;s&nbsp;path&nbsp;is&nbsp;&#34;/base&#34;&nbsp;and&nbsp;the&nbsp;incoming&nbsp;request&nbsp;was&nbsp;for&nbsp;&#34;/dir&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="5539379">//&nbsp;the&nbsp;target&nbsp;request&nbsp;will&nbsp;be&nbsp;for&nbsp;/base/dir.</span><br>
<span class="lineno"></span><span class="keyword" id="5539424">func</span>&nbsp;<span class="ident" id="5539429">NewSingleHostReverseProxy</span><span class="op" id="5539454">(</span><span class="ident" id="5539455">target</span>&nbsp;<span class="op" id="5539462">*</span><span class="ident" id="5539463"><a href="/net/http/httputil/reverseproxy.go.html#5537854">url</a></span><span class="op" id="5539466">.</span><span class="ident" id="5539467">URL</span><span class="op" id="5539470">)</span>&nbsp;<span class="op" id="5539472">*</span><span class="ident" id="5539473"><a href="/net/http/httputil/reverseproxy.go.html#5538172">ReverseProxy</a></span>&nbsp;<span class="op" id="5539486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539489">targetQuery</span>&nbsp;<span class="op" id="5539501">:=</span>&nbsp;<span class="ident" id="5539504"><a href="/net/http/httputil/reverseproxy.go.html#5539455">target</a></span><span class="op" id="5539510">.</span><span class="ident" id="5539511">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539521">director</span>&nbsp;<span class="op" id="5539530">:=</span>&nbsp;<span class="keyword" id="5539533">func</span><span class="op" id="5539537">(</span><span class="ident" id="5539538">req</span>&nbsp;<span class="op" id="5539542">*</span><span class="ident" id="5539543"><a href="/net/http/httputil/reverseproxy.go.html#5537842">http</a></span><span class="op" id="5539547">.</span><span class="ident" id="5539548">Request</span><span class="op" id="5539555">)</span>&nbsp;<span class="op" id="5539557">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539561"><a href="/net/http/httputil/reverseproxy.go.html#5539538">req</a></span><span class="op" id="5539564">.</span><span class="ident" id="5539565">URL</span><span class="op" id="5539568">.</span><span class="ident" id="5539569">Scheme</span>&nbsp;<span class="op" id="5539576">=</span>&nbsp;<span class="ident" id="5539578"><a href="/net/http/httputil/reverseproxy.go.html#5539455">target</a></span><span class="op" id="5539584">.</span><span class="ident" id="5539585">Scheme</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539594"><a href="/net/http/httputil/reverseproxy.go.html#5539538">req</a></span><span class="op" id="5539597">.</span><span class="ident" id="5539598">URL</span><span class="op" id="5539601">.</span><span class="ident" id="5539602">Host</span>&nbsp;<span class="op" id="5539607">=</span>&nbsp;<span class="ident" id="5539609"><a href="/net/http/httputil/reverseproxy.go.html#5539455">target</a></span><span class="op" id="5539615">.</span><span class="ident" id="5539616">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539623"><a href="/net/http/httputil/reverseproxy.go.html#5539538">req</a></span><span class="op" id="5539626">.</span><span class="ident" id="5539627">URL</span><span class="op" id="5539630">.</span><span class="ident" id="5539631">Path</span>&nbsp;<span class="op" id="5539636">=</span>&nbsp;<span class="ident" id="5539638"><a href="/net/http/httputil/reverseproxy.go.html#5538935">singleJoiningSlash</a></span><span class="op" id="5539656">(</span><span class="ident" id="5539657"><a href="/net/http/httputil/reverseproxy.go.html#5539455">target</a></span><span class="op" id="5539663">.</span><span class="ident" id="5539664">Path</span><span class="op" id="5539668">,</span>&nbsp;<span class="ident" id="5539670"><a href="/net/http/httputil/reverseproxy.go.html#5539538">req</a></span><span class="op" id="5539673">.</span><span class="ident" id="5539674">URL</span><span class="op" id="5539677">.</span><span class="ident" id="5539678">Path</span><span class="op" id="5539682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539686">if</span>&nbsp;<span class="ident" id="5539689"><a href="/net/http/httputil/reverseproxy.go.html#5539489">targetQuery</a></span>&nbsp;<span class="op" id="5539701">==</span>&nbsp;<span class="string" id="5539704">&#34;&#34;</span>&nbsp;<span class="op" id="5539707">||</span>&nbsp;<span class="ident" id="5539710"><a href="/net/http/httputil/reverseproxy.go.html#5539538">req</a></span><span class="op" id="5539713">.</span><span class="ident" id="5539714">URL</span><span class="op" id="5539717">.</span><span class="ident" id="5539718">RawQuery</span>&nbsp;<span class="op" id="5539727">==</span>&nbsp;<span class="string" id="5539730">&#34;&#34;</span>&nbsp;<span class="op" id="5539733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539738"><a href="/net/http/httputil/reverseproxy.go.html#5539538">req</a></span><span class="op" id="5539741">.</span><span class="ident" id="5539742">URL</span><span class="op" id="5539745">.</span><span class="ident" id="5539746">RawQuery</span>&nbsp;<span class="op" id="5539755">=</span>&nbsp;<span class="ident" id="5539757"><a href="/net/http/httputil/reverseproxy.go.html#5539489">targetQuery</a></span>&nbsp;<span class="op" id="5539769">+</span>&nbsp;<span class="ident" id="5539771"><a href="/net/http/httputil/reverseproxy.go.html#5539538">req</a></span><span class="op" id="5539774">.</span><span class="ident" id="5539775">URL</span><span class="op" id="5539778">.</span><span class="ident" id="5539779">RawQuery</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5539790">}</span>&nbsp;<span class="keyword" id="5539792">else</span>&nbsp;<span class="op" id="5539797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5539802"><a href="/net/http/httputil/reverseproxy.go.html#5539538">req</a></span><span class="op" id="5539805">.</span><span class="ident" id="5539806">URL</span><span class="op" id="5539809">.</span><span class="ident" id="5539810">RawQuery</span>&nbsp;<span class="op" id="5539819">=</span>&nbsp;<span class="ident" id="5539821"><a href="/net/http/httputil/reverseproxy.go.html#5539489">targetQuery</a></span>&nbsp;<span class="op" id="5539833">+</span>&nbsp;<span class="string" id="5539835">&#34;&amp;&#34;</span>&nbsp;<span class="op" id="5539839">+</span>&nbsp;<span class="ident" id="5539841"><a href="/net/http/httputil/reverseproxy.go.html#5539538">req</a></span><span class="op" id="5539844">.</span><span class="ident" id="5539845">URL</span><span class="op" id="5539848">.</span><span class="ident" id="5539849">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5539860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5539863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539866">return</span>&nbsp;<span class="op" id="5539873">&amp;</span><span class="ident" id="5539874"><a href="/net/http/httputil/reverseproxy.go.html#5538172">ReverseProxy</a></span><span class="op" id="5539886">{</span><span class="ident" id="5539887">Director</span><span class="op" id="5539895">:</span>&nbsp;<span class="ident" id="5539897"><a href="/net/http/httputil/reverseproxy.go.html#5539521">director</a></span><span class="op" id="5539905">}</span><br>
<span class="lineno">80</span><span class="op" id="5539907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5539910">func</span>&nbsp;<span class="ident" id="5539915">copyHeader</span><span class="op" id="5539925">(</span><span class="ident" id="5539926">dst</span><span class="op" id="5539929">,</span>&nbsp;<span class="ident" id="5539931">src</span>&nbsp;<span class="ident" id="5539935"><a href="/net/http/httputil/reverseproxy.go.html#5537842">http</a></span><span class="op" id="5539939">.</span><span class="ident" id="5539940">Header</span><span class="op" id="5539946">)</span>&nbsp;<span class="op" id="5539948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539951">for</span>&nbsp;<span class="ident" id="5539955">k</span><span class="op" id="5539956">,</span>&nbsp;<span class="ident" id="5539958">vv</span>&nbsp;<span class="op" id="5539961">:=</span>&nbsp;<span class="keyword" id="5539964">range</span>&nbsp;<span class="ident" id="5539970"><a href="/net/http/httputil/reverseproxy.go.html#5539931">src</a></span>&nbsp;<span class="op" id="5539974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5539978">for</span>&nbsp;<span class="ident" id="5539982">_</span><span class="op" id="5539983">,</span>&nbsp;<span class="ident" id="5539985">v</span>&nbsp;<span class="op" id="5539987">:=</span>&nbsp;<span class="keyword" id="5539990">range</span>&nbsp;<span class="ident" id="5539996"><a href="/net/http/httputil/reverseproxy.go.html#5539958">vv</a></span>&nbsp;<span class="op" id="5539999">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5540004"><a href="/net/http/httputil/reverseproxy.go.html#5539926">dst</a></span><span class="op" id="5540007">.</span><span class="ident" id="5540008">Add</span><span class="op" id="5540011">(</span><span class="ident" id="5540012"><a href="/net/http/httputil/reverseproxy.go.html#5539955">k</a></span><span class="op" id="5540013">,</span>&nbsp;<span class="ident" id="5540015"><a href="/net/http/httputil/reverseproxy.go.html#5539985">v</a></span><span class="op" id="5540016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5540020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5540023">}</span><br>
<span class="lineno"></span><span class="op" id="5540025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="5540028">//&nbsp;Hop-by-hop&nbsp;headers.&nbsp;These&nbsp;are&nbsp;removed&nbsp;when&nbsp;sent&nbsp;to&nbsp;the&nbsp;backend.</span><br>
<span class="lineno"></span><span class="comment" id="5540095">//&nbsp;http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html</span><br>
<span class="lineno"></span><span class="keyword" id="5540153">var</span>&nbsp;<span class="ident" id="5540157">hopHeaders</span>&nbsp;<span class="op" id="5540168">=</span>&nbsp;<span class="op" id="5540170">[</span><span class="op" id="5540171">]</span><span class="builtintype" id="5540172">string</span><span class="op" id="5540178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5540181">&#34;Connection&#34;</span><span class="op" id="5540193">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5540196">&#34;Keep-Alive&#34;</span><span class="op" id="5540208">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5540211">&#34;Proxy-Authenticate&#34;</span><span class="op" id="5540231">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5540234">&#34;Proxy-Authorization&#34;</span><span class="op" id="5540255">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5540258">&#34;Te&#34;</span><span class="op" id="5540262">,</span>&nbsp;<span class="comment" id="5540264">//&nbsp;canonicalized&nbsp;version&nbsp;of&nbsp;&#34;TE&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5540298">&#34;Trailers&#34;</span><span class="op" id="5540308">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5540311">&#34;Transfer-Encoding&#34;</span><span class="op" id="5540330">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5540333">&#34;Upgrade&#34;</span><span class="op" id="5540342">,</span><br>
<span class="lineno"></span><span class="op" id="5540344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5540347">func</span>&nbsp;<span class="op" id="5540352">(</span><span class="ident" id="5540353">p</span>&nbsp;<span class="op" id="5540355">*</span><span class="ident" id="5540356"><a href="/net/http/httputil/reverseproxy.go.html#5538172">ReverseProxy</a></span><span class="op" id="5540368">)</span>&nbsp;<span class="ident" id="5540370">ServeHTTP</span><span class="op" id="5540379">(</span><span class="ident" id="5540380">rw</span>&nbsp;<span class="ident" id="5540383"><a href="/net/http/httputil/reverseproxy.go.html#5537842">http</a></span><span class="op" id="5540387">.</span><span class="ident" id="5540388">ResponseWriter</span><span class="op" id="5540402">,</span>&nbsp;<span class="ident" id="5540404">req</span>&nbsp;<span class="op" id="5540408">*</span><span class="ident" id="5540409"><a href="/net/http/httputil/reverseproxy.go.html#5537842">http</a></span><span class="op" id="5540413">.</span><span class="ident" id="5540414">Request</span><span class="op" id="5540421">)</span>&nbsp;<span class="op" id="5540423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5540426">transport</span>&nbsp;<span class="op" id="5540436">:=</span>&nbsp;<span class="ident" id="5540439"><a href="/net/http/httputil/reverseproxy.go.html#5540353">p</a></span><span class="op" id="5540440">.</span><span class="ident" id="5540441">Transport</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5540452">if</span>&nbsp;<span class="ident" id="5540455"><a href="/net/http/httputil/reverseproxy.go.html#5540426">transport</a></span>&nbsp;<span class="op" id="5540465">==</span>&nbsp;<span class="ident" id="5540468">nil</span>&nbsp;<span class="op" id="5540472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5540476"><a href="/net/http/httputil/reverseproxy.go.html#5540426">transport</a></span>&nbsp;<span class="op" id="5540486">=</span>&nbsp;<span class="ident" id="5540488"><a href="/net/http/httputil/reverseproxy.go.html#5537842">http</a></span><span class="op" id="5540492">.</span><span class="ident" id="5540493">DefaultTransport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5540511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5540515">outreq</span>&nbsp;<span class="op" id="5540522">:=</span>&nbsp;<span class="builtinfunc" id="5540525">new</span><span class="op" id="5540528">(</span><span class="ident" id="5540529"><a href="/net/http/httputil/reverseproxy.go.html#5537842">http</a></span><span class="op" id="5540533">.</span><span class="ident" id="5540534">Request</span><span class="op" id="5540541">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5540544">*</span><span class="ident" id="5540545"><a href="/net/http/httputil/reverseproxy.go.html#5540515">outreq</a></span>&nbsp;<span class="op" id="5540552">=</span>&nbsp;<span class="op" id="5540554">*</span><span class="ident" id="5540555"><a href="/net/http/httputil/reverseproxy.go.html#5540404">req</a></span>&nbsp;<span class="comment" id="5540559">//&nbsp;includes&nbsp;shallow&nbsp;copies&nbsp;of&nbsp;maps,&nbsp;but&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5540606"><a href="/net/http/httputil/reverseproxy.go.html#5540353">p</a></span><span class="op" id="5540607">.</span><span class="ident" id="5540608">Director</span><span class="op" id="5540616">(</span><span class="ident" id="5540617"><a href="/net/http/httputil/reverseproxy.go.html#5540515">outreq</a></span><span class="op" id="5540623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5540626"><a href="/net/http/httputil/reverseproxy.go.html#5540515">outreq</a></span><span class="op" id="5540632">.</span><span class="ident" id="5540633">Proto</span>&nbsp;<span class="op" id="5540639">=</span>&nbsp;<span class="string" id="5540641">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5540653"><a href="/net/http/httputil/reverseproxy.go.html#5540515">outreq</a></span><span class="op" id="5540659">.</span><span class="ident" id="5540660">ProtoMajor</span>&nbsp;<span class="op" id="5540671">=</span>&nbsp;<span class="num" id="5540673">1</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5540676"><a href="/net/http/httputil/reverseproxy.go.html#5540515">outreq</a></span><span class="op" id="5540682">.</span><span class="ident" id="5540683">ProtoMinor</span>&nbsp;<span class="op" id="5540694">=</span>&nbsp;<span class="num" id="5540696">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5540699"><a href="/net/http/httputil/reverseproxy.go.html#5540515">outreq</a></span><span class="op" id="5540705">.</span><span class="ident" id="5540706">Close</span>&nbsp;<span class="op" id="5540712">=</span>&nbsp;<span class="builtintype" id="5540714">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5540722">//&nbsp;Remove&nbsp;hop-by-hop&nbsp;headers&nbsp;to&nbsp;the&nbsp;backend.&nbsp;&nbsp;Especially</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5540780">//&nbsp;important&nbsp;is&nbsp;&#34;Connection&#34;&nbsp;because&nbsp;we&nbsp;want&nbsp;a&nbsp;persistent</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5540839">//&nbsp;connection,&nbsp;regardless&nbsp;of&nbsp;what&nbsp;the&nbsp;client&nbsp;sent&nbsp;to&nbsp;us.&nbsp;&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5540903">//&nbsp;is&nbsp;modifying&nbsp;the&nbsp;same&nbsp;underlying&nbsp;map&nbsp;from&nbsp;req&nbsp;(shallow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5540962">//&nbsp;copied&nbsp;above)&nbsp;so&nbsp;we&nbsp;only&nbsp;copy&nbsp;it&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541013">copiedHeaders</span>&nbsp;<span class="op" id="5541027">:=</span>&nbsp;<span class="builtintype" id="5541030">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5541037">for</span>&nbsp;<span class="ident" id="5541041">_</span><span class="op" id="5541042">,</span>&nbsp;<span class="ident" id="5541044">h</span>&nbsp;<span class="op" id="5541046">:=</span>&nbsp;<span class="keyword" id="5541049">range</span>&nbsp;<span class="ident" id="5541055"><a href="/net/http/httputil/reverseproxy.go.html#5540157">hopHeaders</a></span>&nbsp;<span class="op" id="5541066">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5541070">if</span>&nbsp;<span class="ident" id="5541073"><a href="/net/http/httputil/reverseproxy.go.html#5540515">outreq</a></span><span class="op" id="5541079">.</span><span class="ident" id="5541080">Header</span><span class="op" id="5541086">.</span><span class="ident" id="5541087">Get</span><span class="op" id="5541090">(</span><span class="ident" id="5541091"><a href="/net/http/httputil/reverseproxy.go.html#5541044">h</a></span><span class="op" id="5541092">)</span>&nbsp;<span class="op" id="5541094">!=</span>&nbsp;<span class="string" id="5541097">&#34;&#34;</span>&nbsp;<span class="op" id="5541100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5541105">if</span>&nbsp;<span class="op" id="5541108">!</span><span class="ident" id="5541109"><a href="/net/http/httputil/reverseproxy.go.html#5541013">copiedHeaders</a></span>&nbsp;<span class="op" id="5541123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541129"><a href="/net/http/httputil/reverseproxy.go.html#5540515">outreq</a></span><span class="op" id="5541135">.</span><span class="ident" id="5541136">Header</span>&nbsp;<span class="op" id="5541143">=</span>&nbsp;<span class="builtinfunc" id="5541145">make</span><span class="op" id="5541149">(</span><span class="ident" id="5541150"><a href="/net/http/httputil/reverseproxy.go.html#5537842">http</a></span><span class="op" id="5541154">.</span><span class="ident" id="5541155">Header</span><span class="op" id="5541161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541167"><a href="/net/http/httputil/reverseproxy.go.html#5539915">copyHeader</a></span><span class="op" id="5541177">(</span><span class="ident" id="5541178"><a href="/net/http/httputil/reverseproxy.go.html#5540515">outreq</a></span><span class="op" id="5541184">.</span><span class="ident" id="5541185">Header</span><span class="op" id="5541191">,</span>&nbsp;<span class="ident" id="5541193"><a href="/net/http/httputil/reverseproxy.go.html#5540404">req</a></span><span class="op" id="5541196">.</span><span class="ident" id="5541197">Header</span><span class="op" id="5541203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541209"><a href="/net/http/httputil/reverseproxy.go.html#5541013">copiedHeaders</a></span>&nbsp;<span class="op" id="5541223">=</span>&nbsp;<span class="builtintype" id="5541225">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5541233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541238"><a href="/net/http/httputil/reverseproxy.go.html#5540515">outreq</a></span><span class="op" id="5541244">.</span><span class="ident" id="5541245">Header</span><span class="op" id="5541251">.</span><span class="ident" id="5541252">Del</span><span class="op" id="5541255">(</span><span class="ident" id="5541256"><a href="/net/http/httputil/reverseproxy.go.html#5541044">h</a></span><span class="op" id="5541257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5541261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5541264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5541268">if</span>&nbsp;<span class="ident" id="5541271">clientIP</span><span class="op" id="5541279">,</span>&nbsp;<span class="ident" id="5541281">_</span><span class="op" id="5541282">,</span>&nbsp;<span class="ident" id="5541284">err</span>&nbsp;<span class="op" id="5541288">:=</span>&nbsp;<span class="ident" id="5541291"><a href="/net/http/httputil/reverseproxy.go.html#5537835">net</a></span><span class="op" id="5541294">.</span><span class="ident" id="5541295">SplitHostPort</span><span class="op" id="5541308">(</span><span class="ident" id="5541309"><a href="/net/http/httputil/reverseproxy.go.html#5540404">req</a></span><span class="op" id="5541312">.</span><span class="ident" id="5541313">RemoteAddr</span><span class="op" id="5541323">)</span><span class="op" id="5541324">;</span>&nbsp;<span class="ident" id="5541326"><a href="/net/http/httputil/reverseproxy.go.html#5541284">err</a></span>&nbsp;<span class="op" id="5541330">==</span>&nbsp;<span class="ident" id="5541333">nil</span>&nbsp;<span class="op" id="5541337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5541341">//&nbsp;If&nbsp;we&nbsp;aren&#39;t&nbsp;the&nbsp;first&nbsp;proxy&nbsp;retain&nbsp;prior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5541388">//&nbsp;X-Forwarded-For&nbsp;information&nbsp;as&nbsp;a&nbsp;comma+space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5541438">//&nbsp;separated&nbsp;list&nbsp;and&nbsp;fold&nbsp;multiple&nbsp;headers&nbsp;into&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5541494">if</span>&nbsp;<span class="ident" id="5541497">prior</span><span class="op" id="5541502">,</span>&nbsp;<span class="ident" id="5541504">ok</span>&nbsp;<span class="op" id="5541507">:=</span>&nbsp;<span class="ident" id="5541510"><a href="/net/http/httputil/reverseproxy.go.html#5540515">outreq</a></span><span class="op" id="5541516">.</span><span class="ident" id="5541517">Header</span><span class="op" id="5541523">[</span><span class="string" id="5541524">&#34;X-Forwarded-For&#34;</span><span class="op" id="5541541">]</span><span class="op" id="5541542">;</span>&nbsp;<span class="ident" id="5541544"><a href="/net/http/httputil/reverseproxy.go.html#5541504">ok</a></span>&nbsp;<span class="op" id="5541547">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541552"><a href="/net/http/httputil/reverseproxy.go.html#5541271">clientIP</a></span>&nbsp;<span class="op" id="5541561">=</span>&nbsp;<span class="ident" id="5541563"><a href="/net/http/httputil/reverseproxy.go.html#5537865">strings</a></span><span class="op" id="5541570">.</span><span class="ident" id="5541571">Join</span><span class="op" id="5541575">(</span><span class="ident" id="5541576"><a href="/net/http/httputil/reverseproxy.go.html#5541497">prior</a></span><span class="op" id="5541581">,</span>&nbsp;<span class="string" id="5541583">&#34;,&nbsp;&#34;</span><span class="op" id="5541587">)</span>&nbsp;<span class="op" id="5541589">+</span>&nbsp;<span class="string" id="5541591">&#34;,&nbsp;&#34;</span>&nbsp;<span class="op" id="5541596">+</span>&nbsp;<span class="ident" id="5541598"><a href="/net/http/httputil/reverseproxy.go.html#5541271">clientIP</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5541609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541613"><a href="/net/http/httputil/reverseproxy.go.html#5540515">outreq</a></span><span class="op" id="5541619">.</span><span class="ident" id="5541620">Header</span><span class="op" id="5541626">.</span><span class="ident" id="5541627">Set</span><span class="op" id="5541630">(</span><span class="string" id="5541631">&#34;X-Forwarded-For&#34;</span><span class="op" id="5541648">,</span>&nbsp;<span class="ident" id="5541650"><a href="/net/http/httputil/reverseproxy.go.html#5541271">clientIP</a></span><span class="op" id="5541658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5541661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541665">res</span><span class="op" id="5541668">,</span>&nbsp;<span class="ident" id="5541670">err</span>&nbsp;<span class="op" id="5541674">:=</span>&nbsp;<span class="ident" id="5541677"><a href="/net/http/httputil/reverseproxy.go.html#5540426">transport</a></span><span class="op" id="5541686">.</span><span class="ident" id="5541687">RoundTrip</span><span class="op" id="5541696">(</span><span class="ident" id="5541697"><a href="/net/http/httputil/reverseproxy.go.html#5540515">outreq</a></span><span class="op" id="5541703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5541706">if</span>&nbsp;<span class="ident" id="5541709"><a href="/net/http/httputil/reverseproxy.go.html#5541670">err</a></span>&nbsp;<span class="op" id="5541713">!=</span>&nbsp;<span class="ident" id="5541716">nil</span>&nbsp;<span class="op" id="5541720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541724"><a href="/net/http/httputil/reverseproxy.go.html#5540353">p</a></span><span class="op" id="5541725">.</span><span class="ident" id="5541726">logf</span><span class="op" id="5541730">(</span><span class="string" id="5541731">&#34;http:&nbsp;proxy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="5541754">,</span>&nbsp;<span class="ident" id="5541756"><a href="/net/http/httputil/reverseproxy.go.html#5541670">err</a></span><span class="op" id="5541759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541763"><a href="/net/http/httputil/reverseproxy.go.html#5540380">rw</a></span><span class="op" id="5541765">.</span><span class="ident" id="5541766">WriteHeader</span><span class="op" id="5541777">(</span><span class="ident" id="5541778"><a href="/net/http/httputil/reverseproxy.go.html#5537842">http</a></span><span class="op" id="5541782">.</span><span class="ident" id="5541783">StatusInternalServerError</span><span class="op" id="5541808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5541812">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5541820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5541823">defer</span>&nbsp;<span class="ident" id="5541829"><a href="/net/http/httputil/reverseproxy.go.html#5541665">res</a></span><span class="op" id="5541832">.</span><span class="ident" id="5541833">Body</span><span class="op" id="5541837">.</span><span class="ident" id="5541838">Close</span><span class="op" id="5541843">(</span><span class="op" id="5541844">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5541848">for</span>&nbsp;<span class="ident" id="5541852">_</span><span class="op" id="5541853">,</span>&nbsp;<span class="ident" id="5541855">h</span>&nbsp;<span class="op" id="5541857">:=</span>&nbsp;<span class="keyword" id="5541860">range</span>&nbsp;<span class="ident" id="5541866"><a href="/net/http/httputil/reverseproxy.go.html#5540157">hopHeaders</a></span>&nbsp;<span class="op" id="5541877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541881"><a href="/net/http/httputil/reverseproxy.go.html#5541665">res</a></span><span class="op" id="5541884">.</span><span class="ident" id="5541885">Header</span><span class="op" id="5541891">.</span><span class="ident" id="5541892">Del</span><span class="op" id="5541895">(</span><span class="ident" id="5541896"><a href="/net/http/httputil/reverseproxy.go.html#5541855">h</a></span><span class="op" id="5541897">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5541900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541904"><a href="/net/http/httputil/reverseproxy.go.html#5539915">copyHeader</a></span><span class="op" id="5541914">(</span><span class="ident" id="5541915"><a href="/net/http/httputil/reverseproxy.go.html#5540380">rw</a></span><span class="op" id="5541917">.</span><span class="ident" id="5541918">Header</span><span class="op" id="5541924">(</span><span class="op" id="5541925">)</span><span class="op" id="5541926">,</span>&nbsp;<span class="ident" id="5541928"><a href="/net/http/httputil/reverseproxy.go.html#5541665">res</a></span><span class="op" id="5541931">.</span><span class="ident" id="5541932">Header</span><span class="op" id="5541938">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541942"><a href="/net/http/httputil/reverseproxy.go.html#5540380">rw</a></span><span class="op" id="5541944">.</span><span class="ident" id="5541945">WriteHeader</span><span class="op" id="5541956">(</span><span class="ident" id="5541957"><a href="/net/http/httputil/reverseproxy.go.html#5541665">res</a></span><span class="op" id="5541960">.</span><span class="ident" id="5541961">StatusCode</span><span class="op" id="5541971">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5541974"><a href="/net/http/httputil/reverseproxy.go.html#5540353">p</a></span><span class="op" id="5541975">.</span><span class="ident" id="5541976">copyResponse</span><span class="op" id="5541988">(</span><span class="ident" id="5541989"><a href="/net/http/httputil/reverseproxy.go.html#5540380">rw</a></span><span class="op" id="5541991">,</span>&nbsp;<span class="ident" id="5541993"><a href="/net/http/httputil/reverseproxy.go.html#5541665">res</a></span><span class="op" id="5541996">.</span><span class="ident" id="5541997">Body</span><span class="op" id="5542001">)</span><br>
<span class="lineno"></span><span class="op" id="5542003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5542006">func</span>&nbsp;<span class="op" id="5542011">(</span><span class="ident" id="5542012">p</span>&nbsp;<span class="op" id="5542014">*</span><span class="ident" id="5542015"><a href="/net/http/httputil/reverseproxy.go.html#5538172">ReverseProxy</a></span><span class="op" id="5542027">)</span>&nbsp;<span class="ident" id="5542029">copyResponse</span><span class="op" id="5542041">(</span><span class="ident" id="5542042">dst</span>&nbsp;<span class="ident" id="5542046"><a href="/net/http/httputil/reverseproxy.go.html#5537822">io</a></span><span class="op" id="5542048">.</span><span class="ident" id="5542049">Writer</span><span class="op" id="5542055">,</span>&nbsp;<span class="ident" id="5542057">src</span>&nbsp;<span class="ident" id="5542061"><a href="/net/http/httputil/reverseproxy.go.html#5537822">io</a></span><span class="op" id="5542063">.</span><span class="ident" id="5542064">Reader</span><span class="op" id="5542070">)</span>&nbsp;<span class="op" id="5542072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5542075">if</span>&nbsp;<span class="ident" id="5542078"><a href="/net/http/httputil/reverseproxy.go.html#5542012">p</a></span><span class="op" id="5542079">.</span><span class="ident" id="5542080">FlushInterval</span>&nbsp;<span class="op" id="5542094">!=</span>&nbsp;<span class="num" id="5542097">0</span>&nbsp;<span class="op" id="5542099">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5542103">if</span>&nbsp;<span class="ident" id="5542106">wf</span><span class="op" id="5542108">,</span>&nbsp;<span class="ident" id="5542110">ok</span>&nbsp;<span class="op" id="5542113">:=</span>&nbsp;<span class="ident" id="5542116"><a href="/net/http/httputil/reverseproxy.go.html#5542042">dst</a></span><span class="op" id="5542119">.</span><span class="op" id="5542120">(</span><span class="ident" id="5542121"><a href="/net/http/httputil/reverseproxy.go.html#5542515">writeFlusher</a></span><span class="op" id="5542133">)</span><span class="op" id="5542134">;</span>&nbsp;<span class="ident" id="5542136"><a href="/net/http/httputil/reverseproxy.go.html#5542110">ok</a></span>&nbsp;<span class="op" id="5542139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542144">mlw</span>&nbsp;<span class="op" id="5542148">:=</span>&nbsp;<span class="op" id="5542151">&amp;</span><span class="ident" id="5542152"><a href="/net/http/httputil/reverseproxy.go.html#5542573">maxLatencyWriter</a></span><span class="op" id="5542168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542174">dst</span><span class="op" id="5542177">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5542183"><a href="/net/http/httputil/reverseproxy.go.html#5542106">wf</a></span><span class="op" id="5542185">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542191">latency</span><span class="op" id="5542198">:</span>&nbsp;<span class="ident" id="5542200"><a href="/net/http/httputil/reverseproxy.go.html#5542012">p</a></span><span class="op" id="5542201">.</span><span class="ident" id="5542202">FlushInterval</span><span class="op" id="5542215">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542221">done</span><span class="op" id="5542225">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5542230">make</span><span class="op" id="5542234">(</span><span class="keyword" id="5542235">chan</span>&nbsp;<span class="builtintype" id="5542240">bool</span><span class="op" id="5542244">)</span><span class="op" id="5542245">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5542250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5542255">go</span>&nbsp;<span class="ident" id="5542258"><a href="/net/http/httputil/reverseproxy.go.html#5542144">mlw</a></span><span class="op" id="5542261">.</span><span class="ident" id="5542262">flushLoop</span><span class="op" id="5542271">(</span><span class="op" id="5542272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5542277">defer</span>&nbsp;<span class="ident" id="5542283"><a href="/net/http/httputil/reverseproxy.go.html#5542144">mlw</a></span><span class="op" id="5542286">.</span><span class="ident" id="5542287">stop</span><span class="op" id="5542291">(</span><span class="op" id="5542292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542297"><a href="/net/http/httputil/reverseproxy.go.html#5542042">dst</a></span>&nbsp;<span class="op" id="5542301">=</span>&nbsp;<span class="ident" id="5542303"><a href="/net/http/httputil/reverseproxy.go.html#5542144">mlw</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5542309">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5542312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542316"><a href="/net/http/httputil/reverseproxy.go.html#5537822">io</a></span><span class="op" id="5542318">.</span><span class="ident" id="5542319">Copy</span><span class="op" id="5542323">(</span><span class="ident" id="5542324"><a href="/net/http/httputil/reverseproxy.go.html#5542042">dst</a></span><span class="op" id="5542327">,</span>&nbsp;<span class="ident" id="5542329"><a href="/net/http/httputil/reverseproxy.go.html#5542057">src</a></span><span class="op" id="5542332">)</span><br>
<span class="lineno"></span><span class="op" id="5542334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="5542337">func</span>&nbsp;<span class="op" id="5542342">(</span><span class="ident" id="5542343">p</span>&nbsp;<span class="op" id="5542345">*</span><span class="ident" id="5542346"><a href="/net/http/httputil/reverseproxy.go.html#5538172">ReverseProxy</a></span><span class="op" id="5542358">)</span>&nbsp;<span class="ident" id="5542360">logf</span><span class="op" id="5542364">(</span><span class="ident" id="5542365">format</span>&nbsp;<span class="builtintype" id="5542372">string</span><span class="op" id="5542378">,</span>&nbsp;<span class="ident" id="5542380">args</span>&nbsp;<span class="op" id="5542385">...</span><span class="keyword" id="5542388">interface</span><span class="op" id="5542397">{</span><span class="op" id="5542398">}</span><span class="op" id="5542399">)</span>&nbsp;<span class="op" id="5542401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5542404">if</span>&nbsp;<span class="ident" id="5542407"><a href="/net/http/httputil/reverseproxy.go.html#5542343">p</a></span><span class="op" id="5542408">.</span><span class="ident" id="5542409">ErrorLog</span>&nbsp;<span class="op" id="5542418">!=</span>&nbsp;<span class="ident" id="5542421">nil</span>&nbsp;<span class="op" id="5542425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542429"><a href="/net/http/httputil/reverseproxy.go.html#5542343">p</a></span><span class="op" id="5542430">.</span><span class="ident" id="5542431">ErrorLog</span><span class="op" id="5542439">.</span><span class="ident" id="5542440">Printf</span><span class="op" id="5542446">(</span><span class="ident" id="5542447"><a href="/net/http/httputil/reverseproxy.go.html#5542365">format</a></span><span class="op" id="5542453">,</span>&nbsp;<span class="ident" id="5542455"><a href="/net/http/httputil/reverseproxy.go.html#5542380">args</a></span><span class="op" id="5542459">...</span><span class="op" id="5542462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5542465">}</span>&nbsp;<span class="keyword" id="5542467">else</span>&nbsp;<span class="op" id="5542472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542476"><a href="/net/http/httputil/reverseproxy.go.html#5537828">log</a></span><span class="op" id="5542479">.</span><span class="ident" id="5542480">Printf</span><span class="op" id="5542486">(</span><span class="ident" id="5542487"><a href="/net/http/httputil/reverseproxy.go.html#5542365">format</a></span><span class="op" id="5542493">,</span>&nbsp;<span class="ident" id="5542495"><a href="/net/http/httputil/reverseproxy.go.html#5542380">args</a></span><span class="op" id="5542499">...</span><span class="op" id="5542502">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5542505">}</span><br>
<span class="lineno"></span><span class="op" id="5542507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5542510">type</span>&nbsp;<span class="ident" id="5542515">writeFlusher</span>&nbsp;<span class="keyword" id="5542528">interface</span>&nbsp;<span class="op" id="5542538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542541"><a href="/net/http/httputil/reverseproxy.go.html#5537822">io</a></span><span class="op" id="5542543">.</span><span class="ident" id="5542544">Writer</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542552"><a href="/net/http/httputil/reverseproxy.go.html#5537842">http</a></span><span class="op" id="5542556">.</span><span class="ident" id="5542557">Flusher</span><br>
<span class="lineno"></span><span class="op" id="5542565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5542568">type</span>&nbsp;<span class="ident" id="5542573">maxLatencyWriter</span>&nbsp;<span class="keyword" id="5542590">struct</span>&nbsp;<span class="op" id="5542597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542600">dst</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5542608"><a href="/net/http/httputil/reverseproxy.go.html#5542515">writeFlusher</a></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542622">latency</span>&nbsp;<span class="ident" id="5542630"><a href="/net/http/httputil/reverseproxy.go.html#5537884">time</a></span><span class="op" id="5542634">.</span><span class="ident" id="5542635">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542646">lk</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5542651"><a href="/net/http/httputil/reverseproxy.go.html#5537876">sync</a></span><span class="op" id="5542655">.</span><span class="ident" id="5542656">Mutex</span>&nbsp;<span class="comment" id="5542662">//&nbsp;protects&nbsp;Write&nbsp;+&nbsp;Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542689">done</span>&nbsp;<span class="keyword" id="5542694">chan</span>&nbsp;<span class="builtintype" id="5542699">bool</span><br>
<span class="lineno"></span><span class="op" id="5542704">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="5542707">func</span>&nbsp;<span class="op" id="5542712">(</span><span class="ident" id="5542713">m</span>&nbsp;<span class="op" id="5542715">*</span><span class="ident" id="5542716"><a href="/net/http/httputil/reverseproxy.go.html#5542573">maxLatencyWriter</a></span><span class="op" id="5542732">)</span>&nbsp;<span class="ident" id="5542734">Write</span><span class="op" id="5542739">(</span><span class="ident" id="5542740">p</span>&nbsp;<span class="op" id="5542742">[</span><span class="op" id="5542743">]</span><span class="builtintype" id="5542744">byte</span><span class="op" id="5542748">)</span>&nbsp;<span class="op" id="5542750">(</span><span class="builtintype" id="5542751">int</span><span class="op" id="5542754">,</span>&nbsp;<span class="builtintype" id="5542756">error</span><span class="op" id="5542761">)</span>&nbsp;<span class="op" id="5542763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542766"><a href="/net/http/httputil/reverseproxy.go.html#5542713">m</a></span><span class="op" id="5542767">.</span><span class="ident" id="5542768">lk</span><span class="op" id="5542770">.</span><span class="ident" id="5542771">Lock</span><span class="op" id="5542775">(</span><span class="op" id="5542776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5542779">defer</span>&nbsp;<span class="ident" id="5542785"><a href="/net/http/httputil/reverseproxy.go.html#5542713">m</a></span><span class="op" id="5542786">.</span><span class="ident" id="5542787">lk</span><span class="op" id="5542789">.</span><span class="ident" id="5542790">Unlock</span><span class="op" id="5542796">(</span><span class="op" id="5542797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5542800">return</span>&nbsp;<span class="ident" id="5542807"><a href="/net/http/httputil/reverseproxy.go.html#5542713">m</a></span><span class="op" id="5542808">.</span><span class="ident" id="5542809">dst</span><span class="op" id="5542812">.</span><span class="ident" id="5542813">Write</span><span class="op" id="5542818">(</span><span class="ident" id="5542819"><a href="/net/http/httputil/reverseproxy.go.html#5542740">p</a></span><span class="op" id="5542820">)</span><br>
<span class="lineno">205</span><span class="op" id="5542822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5542825">func</span>&nbsp;<span class="op" id="5542830">(</span><span class="ident" id="5542831">m</span>&nbsp;<span class="op" id="5542833">*</span><span class="ident" id="5542834"><a href="/net/http/httputil/reverseproxy.go.html#5542573">maxLatencyWriter</a></span><span class="op" id="5542850">)</span>&nbsp;<span class="ident" id="5542852">flushLoop</span><span class="op" id="5542861">(</span><span class="op" id="5542862">)</span>&nbsp;<span class="op" id="5542864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542867">t</span>&nbsp;<span class="op" id="5542869">:=</span>&nbsp;<span class="ident" id="5542872"><a href="/net/http/httputil/reverseproxy.go.html#5537884">time</a></span><span class="op" id="5542876">.</span><span class="ident" id="5542877">NewTicker</span><span class="op" id="5542886">(</span><span class="ident" id="5542887"><a href="/net/http/httputil/reverseproxy.go.html#5542831">m</a></span><span class="op" id="5542888">.</span><span class="ident" id="5542889">latency</span><span class="op" id="5542896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5542899">defer</span>&nbsp;<span class="ident" id="5542905"><a href="/net/http/httputil/reverseproxy.go.html#5542867">t</a></span><span class="op" id="5542906">.</span><span class="ident" id="5542907">Stop</span><span class="op" id="5542911">(</span><span class="op" id="5542912">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5542915">for</span>&nbsp;<span class="op" id="5542919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5542923">select</span>&nbsp;<span class="op" id="5542930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5542934">case</span>&nbsp;<span class="op" id="5542939">&lt;-</span><span class="ident" id="5542941"><a href="/net/http/httputil/reverseproxy.go.html#5542831">m</a></span><span class="op" id="5542942">.</span><span class="ident" id="5542943">done</span><span class="op" id="5542947">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5542952">if</span>&nbsp;<span class="ident" id="5542955"><a href="/net/http/httputil/reverseproxy.go.html#5537997">onExitFlushLoop</a></span>&nbsp;<span class="op" id="5542971">!=</span>&nbsp;<span class="ident" id="5542974">nil</span>&nbsp;<span class="op" id="5542978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5542984"><a href="/net/http/httputil/reverseproxy.go.html#5537997">onExitFlushLoop</a></span><span class="op" id="5542999">(</span><span class="op" id="5543000">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5543005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5543010">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5543019">case</span>&nbsp;<span class="op" id="5543024">&lt;-</span><span class="ident" id="5543026"><a href="/net/http/httputil/reverseproxy.go.html#5542867">t</a></span><span class="op" id="5543027">.</span><span class="ident" id="5543028">C</span><span class="op" id="5543029">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5543034"><a href="/net/http/httputil/reverseproxy.go.html#5542831">m</a></span><span class="op" id="5543035">.</span><span class="ident" id="5543036">lk</span><span class="op" id="5543038">.</span><span class="ident" id="5543039">Lock</span><span class="op" id="5543043">(</span><span class="op" id="5543044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5543049"><a href="/net/http/httputil/reverseproxy.go.html#5542831">m</a></span><span class="op" id="5543050">.</span><span class="ident" id="5543051">dst</span><span class="op" id="5543054">.</span><span class="ident" id="5543055">Flush</span><span class="op" id="5543060">(</span><span class="op" id="5543061">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5543066"><a href="/net/http/httputil/reverseproxy.go.html#5542831">m</a></span><span class="op" id="5543067">.</span><span class="ident" id="5543068">lk</span><span class="op" id="5543070">.</span><span class="ident" id="5543071">Unlock</span><span class="op" id="5543077">(</span><span class="op" id="5543078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5543082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5543085">}</span><br>
<span class="lineno"></span><span class="op" id="5543087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="5543090">func</span>&nbsp;<span class="op" id="5543095">(</span><span class="ident" id="5543096">m</span>&nbsp;<span class="op" id="5543098">*</span><span class="ident" id="5543099"><a href="/net/http/httputil/reverseproxy.go.html#5542573">maxLatencyWriter</a></span><span class="op" id="5543115">)</span>&nbsp;<span class="ident" id="5543117">stop</span><span class="op" id="5543121">(</span><span class="op" id="5543122">)</span>&nbsp;<span class="op" id="5543124">{</span>&nbsp;<span class="ident" id="5543126"><a href="/net/http/httputil/reverseproxy.go.html#5543096">m</a></span><span class="op" id="5543127">.</span><span class="ident" id="5543128">done</span>&nbsp;<span class="op" id="5543133">&lt;-</span>&nbsp;<span class="builtintype" id="5543136">true</span>&nbsp;<span class="op" id="5543141">}</span>
</div>
</body>
</html>
