<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7585190">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7585245">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7585299">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7585350">package</span>&nbsp;<span class="ident" id="7585358">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7585363">import</span>&nbsp;<span class="op" id="7585370">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585373">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585396">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585406">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585413">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585419">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585426">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585434">&#34;strconv&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585445">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585456">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585464">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7585475">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7585482">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7585485">var</span>&nbsp;<span class="ident" id="7585489">_</span>&nbsp;<span class="op" id="7585491">=</span>&nbsp;<span class="ident" id="7585493">log</span><span class="op" id="7585496">.</span><span class="ident" id="7585497">Printf</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7585505">//&nbsp;fakeDriver&nbsp;is&nbsp;a&nbsp;fake&nbsp;database&nbsp;that&nbsp;implements&nbsp;Go&#39;s&nbsp;driver.Driver</span><br>
<span class="lineno"></span><span class="comment" id="7585573">//&nbsp;interface,&nbsp;just&nbsp;for&nbsp;testing.</span><br>
<span class="lineno">25</span><span class="comment" id="7585605">//</span><br>
<span class="lineno"></span><span class="comment" id="7585608">//&nbsp;It&nbsp;speaks&nbsp;a&nbsp;query&nbsp;language&nbsp;that&#39;s&nbsp;semantically&nbsp;similar&nbsp;to&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="7585673">//&nbsp;syntactically&nbsp;different&nbsp;and&nbsp;simpler&nbsp;than&nbsp;SQL.&nbsp;&nbsp;The&nbsp;syntax&nbsp;is&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="7585740">//&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="7585752">//</span><br>
<span class="lineno">30</span><span class="comment" id="7585755">//&nbsp;&nbsp;&nbsp;WIPE</span><br>
<span class="lineno"></span><span class="comment" id="7585765">//&nbsp;&nbsp;&nbsp;CREATE|&lt;tablename&gt;|&lt;col&gt;=&lt;type&gt;,&lt;col&gt;=&lt;type&gt;,...</span><br>
<span class="lineno"></span><span class="comment" id="7585819">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;types&nbsp;are:&nbsp;&#34;string&#34;,&nbsp;[u]int{8,16,32,64},&nbsp;&#34;bool&#34;</span><br>
<span class="lineno"></span><span class="comment" id="7585880">//&nbsp;&nbsp;&nbsp;INSERT|&lt;tablename&gt;|col=val,col2=val2,col3=?</span><br>
<span class="lineno"></span><span class="comment" id="7585929">//&nbsp;&nbsp;&nbsp;SELECT|&lt;tablename&gt;|projectcol1,projectcol2|filtercol=?,filtercol2=?</span><br>
<span class="lineno">35</span><span class="comment" id="7586002">//</span><br>
<span class="lineno"></span><span class="comment" id="7586005">//&nbsp;When&nbsp;opening&nbsp;a&nbsp;fakeDriver&#39;s&nbsp;database,&nbsp;it&nbsp;starts&nbsp;empty&nbsp;with&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="7586070">//&nbsp;tables.&nbsp;&nbsp;All&nbsp;tables&nbsp;and&nbsp;data&nbsp;are&nbsp;stored&nbsp;in&nbsp;memory&nbsp;only.</span><br>
<span class="lineno"></span><span class="keyword" id="7586129">type</span>&nbsp;<span class="ident" id="7586134">fakeDriver</span>&nbsp;<span class="keyword" id="7586145">struct</span>&nbsp;<span class="op" id="7586152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586155">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7586166">sync</span><span class="op" id="7586170">.</span><span class="ident" id="7586171">Mutex</span>&nbsp;<span class="comment" id="7586177">//&nbsp;guards&nbsp;3&nbsp;following&nbsp;fields</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586207">openCount</span>&nbsp;&nbsp;<span class="builtintype" id="7586218">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7586229">//&nbsp;conn&nbsp;opens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586244">closeCount</span>&nbsp;<span class="builtintype" id="7586255">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7586266">//&nbsp;conn&nbsp;closes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586282">waitCh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7586293">chan</span>&nbsp;<span class="keyword" id="7586298">struct</span><span class="op" id="7586304">{</span><span class="op" id="7586305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586308">waitingCh</span>&nbsp;&nbsp;<span class="keyword" id="7586319">chan</span>&nbsp;<span class="keyword" id="7586324">struct</span><span class="op" id="7586330">{</span><span class="op" id="7586331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586334">dbs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7586345">map</span><span class="op" id="7586348">[</span><span class="builtintype" id="7586349">string</span><span class="op" id="7586355">]</span><span class="op" id="7586356">*</span><span class="ident" id="7586357">fakeDB</span><br>
<span class="lineno">45</span><span class="op" id="7586364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7586367">type</span>&nbsp;<span class="ident" id="7586372">fakeDB</span>&nbsp;<span class="keyword" id="7586379">struct</span>&nbsp;<span class="op" id="7586386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586389">name</span>&nbsp;<span class="builtintype" id="7586394">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586403">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7586411">sync</span><span class="op" id="7586415">.</span><span class="ident" id="7586416">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586423">free</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7586431">[</span><span class="op" id="7586432">]</span><span class="op" id="7586433">*</span><span class="ident" id="7586434">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586444">tables</span>&nbsp;&nbsp;<span class="keyword" id="7586452">map</span><span class="op" id="7586455">[</span><span class="builtintype" id="7586456">string</span><span class="op" id="7586462">]</span><span class="op" id="7586463">*</span><span class="ident" id="7586464">table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586471">badConn</span>&nbsp;<span class="builtintype" id="7586479">bool</span><br>
<span class="lineno"></span><span class="op" id="7586484">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="7586487">type</span>&nbsp;<span class="ident" id="7586492">table</span>&nbsp;<span class="keyword" id="7586498">struct</span>&nbsp;<span class="op" id="7586505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586508">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7586516">sync</span><span class="op" id="7586520">.</span><span class="ident" id="7586521">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586528">colname</span>&nbsp;<span class="op" id="7586536">[</span><span class="op" id="7586537">]</span><span class="builtintype" id="7586538">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586546">coltype</span>&nbsp;<span class="op" id="7586554">[</span><span class="op" id="7586555">]</span><span class="builtintype" id="7586556">string</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586564">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7586572">[</span><span class="op" id="7586573">]</span><span class="op" id="7586574">*</span><span class="ident" id="7586575">row</span><br>
<span class="lineno"></span><span class="op" id="7586579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7586582">func</span>&nbsp;<span class="op" id="7586587">(</span><span class="ident" id="7586588">t</span>&nbsp;<span class="op" id="7586590">*</span><span class="ident" id="7586591">table</span><span class="op" id="7586596">)</span>&nbsp;<span class="ident" id="7586598">columnIndex</span><span class="op" id="7586609">(</span><span class="ident" id="7586610">name</span>&nbsp;<span class="builtintype" id="7586615">string</span><span class="op" id="7586621">)</span>&nbsp;<span class="builtintype" id="7586623">int</span>&nbsp;<span class="op" id="7586627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7586630">for</span>&nbsp;<span class="ident" id="7586634">n</span><span class="op" id="7586635">,</span>&nbsp;<span class="ident" id="7586637">nname</span>&nbsp;<span class="op" id="7586643">:=</span>&nbsp;<span class="keyword" id="7586646">range</span>&nbsp;<span class="ident" id="7586652">t</span><span class="op" id="7586653">.</span><span class="ident" id="7586654">colname</span>&nbsp;<span class="op" id="7586662">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7586666">if</span>&nbsp;<span class="ident" id="7586669">name</span>&nbsp;<span class="op" id="7586674">==</span>&nbsp;<span class="ident" id="7586677">nname</span>&nbsp;<span class="op" id="7586683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7586688">return</span>&nbsp;<span class="ident" id="7586695">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7586699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7586702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7586705">return</span>&nbsp;<span class="op" id="7586712">-</span><span class="num" id="7586713">1</span><br>
<span class="lineno">70</span><span class="op" id="7586715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7586718">type</span>&nbsp;<span class="ident" id="7586723">row</span>&nbsp;<span class="keyword" id="7586727">struct</span>&nbsp;<span class="op" id="7586734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586737">cols</span>&nbsp;<span class="op" id="7586742">[</span><span class="op" id="7586743">]</span><span class="keyword" id="7586744">interface</span><span class="op" id="7586753">{</span><span class="op" id="7586754">}</span>&nbsp;<span class="comment" id="7586756">//&nbsp;must&nbsp;be&nbsp;same&nbsp;size&nbsp;as&nbsp;its&nbsp;table&nbsp;colname&nbsp;+&nbsp;coltype</span><br>
<span class="lineno"></span><span class="op" id="7586808">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="7586811">func</span>&nbsp;<span class="op" id="7586816">(</span><span class="ident" id="7586817">r</span>&nbsp;<span class="op" id="7586819">*</span><span class="ident" id="7586820">row</span><span class="op" id="7586823">)</span>&nbsp;<span class="ident" id="7586825">clone</span><span class="op" id="7586830">(</span><span class="op" id="7586831">)</span>&nbsp;<span class="op" id="7586833">*</span><span class="ident" id="7586834">row</span>&nbsp;<span class="op" id="7586838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586841">nrow</span>&nbsp;<span class="op" id="7586846">:=</span>&nbsp;<span class="op" id="7586849">&amp;</span><span class="ident" id="7586850">row</span><span class="op" id="7586853">{</span><span class="ident" id="7586854">cols</span><span class="op" id="7586858">:</span>&nbsp;<span class="builtinfunc" id="7586860">make</span><span class="op" id="7586864">(</span><span class="op" id="7586865">[</span><span class="op" id="7586866">]</span><span class="keyword" id="7586867">interface</span><span class="op" id="7586876">{</span><span class="op" id="7586877">}</span><span class="op" id="7586878">,</span>&nbsp;<span class="builtinfunc" id="7586880">len</span><span class="op" id="7586883">(</span><span class="ident" id="7586884">r</span><span class="op" id="7586885">.</span><span class="ident" id="7586886">cols</span><span class="op" id="7586890">)</span><span class="op" id="7586891">)</span><span class="op" id="7586892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7586895">copy</span><span class="op" id="7586899">(</span><span class="ident" id="7586900">nrow</span><span class="op" id="7586904">.</span><span class="ident" id="7586905">cols</span><span class="op" id="7586909">,</span>&nbsp;<span class="ident" id="7586911">r</span><span class="op" id="7586912">.</span><span class="ident" id="7586913">cols</span><span class="op" id="7586917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7586920">return</span>&nbsp;<span class="ident" id="7586927">nrow</span><br>
<span class="lineno">80</span><span class="op" id="7586932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7586935">type</span>&nbsp;<span class="ident" id="7586940">fakeConn</span>&nbsp;<span class="keyword" id="7586949">struct</span>&nbsp;<span class="op" id="7586956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7586959">db</span>&nbsp;<span class="op" id="7586962">*</span><span class="ident" id="7586963">fakeDB</span>&nbsp;<span class="comment" id="7586970">//&nbsp;where&nbsp;to&nbsp;return&nbsp;ourselves&nbsp;to</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587004">currTx</span>&nbsp;<span class="op" id="7587011">*</span><span class="ident" id="7587012">fakeTx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7587021">//&nbsp;Stats&nbsp;for&nbsp;tests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587042">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7587054">sync</span><span class="op" id="7587058">.</span><span class="ident" id="7587059">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587066">stmtsMade</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7587078">int</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587083">stmtsClosed</span>&nbsp;<span class="builtintype" id="7587095">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587100">numPrepare</span>&nbsp;&nbsp;<span class="builtintype" id="7587112">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587117">bad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7587129">bool</span><br>
<span class="lineno"></span><span class="op" id="7587134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7587137">func</span>&nbsp;<span class="op" id="7587142">(</span><span class="ident" id="7587143">c</span>&nbsp;<span class="op" id="7587145">*</span><span class="ident" id="7587146">fakeConn</span><span class="op" id="7587154">)</span>&nbsp;<span class="ident" id="7587156">incrStat</span><span class="op" id="7587164">(</span><span class="ident" id="7587165">v</span>&nbsp;<span class="op" id="7587167">*</span><span class="builtintype" id="7587168">int</span><span class="op" id="7587171">)</span>&nbsp;<span class="op" id="7587173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587176">c</span><span class="op" id="7587177">.</span><span class="ident" id="7587178">mu</span><span class="op" id="7587180">.</span><span class="ident" id="7587181">Lock</span><span class="op" id="7587185">(</span><span class="op" id="7587186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7587189">*</span><span class="ident" id="7587190">v</span><span class="op" id="7587191">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587195">c</span><span class="op" id="7587196">.</span><span class="ident" id="7587197">mu</span><span class="op" id="7587199">.</span><span class="ident" id="7587200">Unlock</span><span class="op" id="7587206">(</span><span class="op" id="7587207">)</span><br>
<span class="lineno"></span><span class="op" id="7587209">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="7587212">type</span>&nbsp;<span class="ident" id="7587217">fakeTx</span>&nbsp;<span class="keyword" id="7587224">struct</span>&nbsp;<span class="op" id="7587231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587234">c</span>&nbsp;<span class="op" id="7587236">*</span><span class="ident" id="7587237">fakeConn</span><br>
<span class="lineno"></span><span class="op" id="7587246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="7587249">type</span>&nbsp;<span class="ident" id="7587254">fakeStmt</span>&nbsp;<span class="keyword" id="7587263">struct</span>&nbsp;<span class="op" id="7587270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587273">c</span>&nbsp;<span class="op" id="7587275">*</span><span class="ident" id="7587276">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587286">q</span>&nbsp;<span class="builtintype" id="7587288">string</span>&nbsp;<span class="comment" id="7587295">//&nbsp;just&nbsp;for&nbsp;debugging</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587319">cmd</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7587325">string</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587333">table</span>&nbsp;<span class="builtintype" id="7587339">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587348">closed</span>&nbsp;<span class="builtintype" id="7587355">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587362">colName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7587375">[</span><span class="op" id="7587376">]</span><span class="builtintype" id="7587377">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7587389">//&nbsp;used&nbsp;by&nbsp;CREATE,&nbsp;INSERT,&nbsp;SELECT&nbsp;(selected&nbsp;columns)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587443">colType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7587456">[</span><span class="op" id="7587457">]</span><span class="builtintype" id="7587458">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7587470">//&nbsp;used&nbsp;by&nbsp;CREATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587489">colValue</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7587502">[</span><span class="op" id="7587503">]</span><span class="keyword" id="7587504">interface</span><span class="op" id="7587513">{</span><span class="op" id="7587514">}</span>&nbsp;<span class="comment" id="7587516">//&nbsp;used&nbsp;by&nbsp;INSERT&nbsp;(mix&nbsp;of&nbsp;strings&nbsp;and&nbsp;&#34;?&#34;&nbsp;for&nbsp;bound&nbsp;params)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587577">placeholders</span>&nbsp;<span class="builtintype" id="7587590">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7587604">//&nbsp;used&nbsp;by&nbsp;INSERT/SELECT:&nbsp;number&nbsp;of&nbsp;?&nbsp;params</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587651">whereCol</span>&nbsp;<span class="op" id="7587660">[</span><span class="op" id="7587661">]</span><span class="builtintype" id="7587662">string</span>&nbsp;<span class="comment" id="7587669">//&nbsp;used&nbsp;by&nbsp;SELECT&nbsp;(all&nbsp;placeholders)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587708">placeholderConverter</span>&nbsp;<span class="op" id="7587729">[</span><span class="op" id="7587730">]</span><span class="ident" id="7587731">driver</span><span class="op" id="7587737">.</span><span class="ident" id="7587738">ValueConverter</span>&nbsp;<span class="comment" id="7587753">//&nbsp;used&nbsp;by&nbsp;INSERT</span><br>
<span class="lineno"></span><span class="op" id="7587771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7587774">var</span>&nbsp;<span class="ident" id="7587778">fdriver</span>&nbsp;<span class="ident" id="7587786">driver</span><span class="op" id="7587792">.</span><span class="ident" id="7587793">Driver</span>&nbsp;<span class="op" id="7587800">=</span>&nbsp;<span class="op" id="7587802">&amp;</span><span class="ident" id="7587803">fakeDriver</span><span class="op" id="7587813">{</span><span class="op" id="7587814">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="7587817">func</span>&nbsp;<span class="ident" id="7587822">init</span><span class="op" id="7587826">(</span><span class="op" id="7587827">)</span>&nbsp;<span class="op" id="7587829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7587832">Register</span><span class="op" id="7587840">(</span><span class="string" id="7587841">&#34;test&#34;</span><span class="op" id="7587847">,</span>&nbsp;<span class="ident" id="7587849">fdriver</span><span class="op" id="7587856">)</span><br>
<span class="lineno"></span><span class="op" id="7587858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="7587861">func</span>&nbsp;<span class="ident" id="7587866">contains</span><span class="op" id="7587874">(</span><span class="ident" id="7587875">list</span>&nbsp;<span class="op" id="7587880">[</span><span class="op" id="7587881">]</span><span class="builtintype" id="7587882">string</span><span class="op" id="7587888">,</span>&nbsp;<span class="ident" id="7587890">y</span>&nbsp;<span class="builtintype" id="7587892">string</span><span class="op" id="7587898">)</span>&nbsp;<span class="builtintype" id="7587900">bool</span>&nbsp;<span class="op" id="7587905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7587908">for</span>&nbsp;<span class="ident" id="7587912">_</span><span class="op" id="7587913">,</span>&nbsp;<span class="ident" id="7587915">x</span>&nbsp;<span class="op" id="7587917">:=</span>&nbsp;<span class="keyword" id="7587920">range</span>&nbsp;<span class="ident" id="7587926">list</span>&nbsp;<span class="op" id="7587931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7587935">if</span>&nbsp;<span class="ident" id="7587938">x</span>&nbsp;<span class="op" id="7587940">==</span>&nbsp;<span class="ident" id="7587943">y</span>&nbsp;<span class="op" id="7587945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7587950">return</span>&nbsp;<span class="builtintype" id="7587957">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7587964">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7587967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7587970">return</span>&nbsp;<span class="builtintype" id="7587977">false</span><br>
<span class="lineno"></span><span class="op" id="7587983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7587986">type</span>&nbsp;<span class="ident" id="7587991">Dummy</span>&nbsp;<span class="keyword" id="7587997">struct</span>&nbsp;<span class="op" id="7588004">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588007">driver</span><span class="op" id="7588013">.</span><span class="ident" id="7588014">Driver</span><br>
<span class="lineno"></span><span class="op" id="7588021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7588024">func</span>&nbsp;<span class="ident" id="7588029">TestDrivers</span><span class="op" id="7588040">(</span><span class="ident" id="7588041">t</span>&nbsp;<span class="op" id="7588043">*</span><span class="ident" id="7588044">testing</span><span class="op" id="7588051">.</span><span class="ident" id="7588052">T</span><span class="op" id="7588053">)</span>&nbsp;<span class="op" id="7588055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588058">unregisterAllDrivers</span><span class="op" id="7588078">(</span><span class="op" id="7588079">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588082">Register</span><span class="op" id="7588090">(</span><span class="string" id="7588091">&#34;test&#34;</span><span class="op" id="7588097">,</span>&nbsp;<span class="ident" id="7588099">fdriver</span><span class="op" id="7588106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588109">Register</span><span class="op" id="7588117">(</span><span class="string" id="7588118">&#34;invalid&#34;</span><span class="op" id="7588127">,</span>&nbsp;<span class="ident" id="7588129">Dummy</span><span class="op" id="7588134">{</span><span class="op" id="7588135">}</span><span class="op" id="7588136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588139">all</span>&nbsp;<span class="op" id="7588143">:=</span>&nbsp;<span class="ident" id="7588146">Drivers</span><span class="op" id="7588153">(</span><span class="op" id="7588154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7588157">if</span>&nbsp;<span class="builtinfunc" id="7588160">len</span><span class="op" id="7588163">(</span><span class="ident" id="7588164">all</span><span class="op" id="7588167">)</span>&nbsp;<span class="op" id="7588169">&lt;</span>&nbsp;<span class="num" id="7588171">2</span>&nbsp;<span class="op" id="7588173">||</span>&nbsp;<span class="op" id="7588176">!</span><span class="ident" id="7588177">sort</span><span class="op" id="7588181">.</span><span class="ident" id="7588182">StringsAreSorted</span><span class="op" id="7588198">(</span><span class="ident" id="7588199">all</span><span class="op" id="7588202">)</span>&nbsp;<span class="op" id="7588204">||</span>&nbsp;<span class="op" id="7588207">!</span><span class="ident" id="7588208">contains</span><span class="op" id="7588216">(</span><span class="ident" id="7588217">all</span><span class="op" id="7588220">,</span>&nbsp;<span class="string" id="7588222">&#34;test&#34;</span><span class="op" id="7588228">)</span>&nbsp;<span class="op" id="7588230">||</span>&nbsp;<span class="op" id="7588233">!</span><span class="ident" id="7588234">contains</span><span class="op" id="7588242">(</span><span class="ident" id="7588243">all</span><span class="op" id="7588246">,</span>&nbsp;<span class="string" id="7588248">&#34;invalid&#34;</span><span class="op" id="7588257">)</span>&nbsp;<span class="op" id="7588259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588263">t</span><span class="op" id="7588264">.</span><span class="ident" id="7588265">Fatalf</span><span class="op" id="7588271">(</span><span class="string" id="7588272">&#34;Drivers&nbsp;=&nbsp;%v,&nbsp;want&nbsp;sorted&nbsp;list&nbsp;with&nbsp;at&nbsp;least&nbsp;[invalid,&nbsp;test]&#34;</span><span class="op" id="7588334">,</span>&nbsp;<span class="ident" id="7588336">all</span><span class="op" id="7588339">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7588342">}</span><br>
<span class="lineno"></span><span class="op" id="7588344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7588347">//&nbsp;Supports&nbsp;dsn&nbsp;forms:</span><br>
<span class="lineno"></span><span class="comment" id="7588370">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;</span><br>
<span class="lineno">155</span><span class="comment" id="7588385">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;;&lt;opts&gt;&nbsp;&nbsp;(only&nbsp;currently&nbsp;supported&nbsp;option&nbsp;is&nbsp;`badConn`,</span><br>
<span class="lineno"></span><span class="comment" id="7588455">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;causes&nbsp;driver.ErrBadConn&nbsp;to&nbsp;be&nbsp;returned&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="7588528">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;every&nbsp;other&nbsp;conn.Begin())</span><br>
<span class="lineno"></span><span class="keyword" id="7588578">func</span>&nbsp;<span class="op" id="7588583">(</span><span class="ident" id="7588584">d</span>&nbsp;<span class="op" id="7588586">*</span><span class="ident" id="7588587">fakeDriver</span><span class="op" id="7588597">)</span>&nbsp;<span class="ident" id="7588599">Open</span><span class="op" id="7588603">(</span><span class="ident" id="7588604">dsn</span>&nbsp;<span class="builtintype" id="7588608">string</span><span class="op" id="7588614">)</span>&nbsp;<span class="op" id="7588616">(</span><span class="ident" id="7588617">driver</span><span class="op" id="7588623">.</span><span class="ident" id="7588624">Conn</span><span class="op" id="7588628">,</span>&nbsp;<span class="builtintype" id="7588630">error</span><span class="op" id="7588635">)</span>&nbsp;<span class="op" id="7588637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588640">parts</span>&nbsp;<span class="op" id="7588646">:=</span>&nbsp;<span class="ident" id="7588649">strings</span><span class="op" id="7588656">.</span><span class="ident" id="7588657">Split</span><span class="op" id="7588662">(</span><span class="ident" id="7588663">dsn</span><span class="op" id="7588666">,</span>&nbsp;<span class="string" id="7588668">&#34;;&#34;</span><span class="op" id="7588671">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7588674">if</span>&nbsp;<span class="builtinfunc" id="7588677">len</span><span class="op" id="7588680">(</span><span class="ident" id="7588681">parts</span><span class="op" id="7588686">)</span>&nbsp;<span class="op" id="7588688">&lt;</span>&nbsp;<span class="num" id="7588690">1</span>&nbsp;<span class="op" id="7588692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7588696">return</span>&nbsp;<span class="ident" id="7588703">nil</span><span class="op" id="7588706">,</span>&nbsp;<span class="ident" id="7588708">errors</span><span class="op" id="7588714">.</span><span class="ident" id="7588715">New</span><span class="op" id="7588718">(</span><span class="string" id="7588719">&#34;fakedb:&nbsp;no&nbsp;database&nbsp;name&#34;</span><span class="op" id="7588745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7588748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588751">name</span>&nbsp;<span class="op" id="7588756">:=</span>&nbsp;<span class="ident" id="7588759">parts</span><span class="op" id="7588764">[</span><span class="num" id="7588765">0</span><span class="op" id="7588766">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588770">db</span>&nbsp;<span class="op" id="7588773">:=</span>&nbsp;<span class="ident" id="7588776">d</span><span class="op" id="7588777">.</span><span class="ident" id="7588778">getDB</span><span class="op" id="7588783">(</span><span class="ident" id="7588784">name</span><span class="op" id="7588788">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588792">d</span><span class="op" id="7588793">.</span><span class="ident" id="7588794">mu</span><span class="op" id="7588796">.</span><span class="ident" id="7588797">Lock</span><span class="op" id="7588801">(</span><span class="op" id="7588802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588805">d</span><span class="op" id="7588806">.</span><span class="ident" id="7588807">openCount</span><span class="op" id="7588816">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588820">d</span><span class="op" id="7588821">.</span><span class="ident" id="7588822">mu</span><span class="op" id="7588824">.</span><span class="ident" id="7588825">Unlock</span><span class="op" id="7588831">(</span><span class="op" id="7588832">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588835">conn</span>&nbsp;<span class="op" id="7588840">:=</span>&nbsp;<span class="op" id="7588843">&amp;</span><span class="ident" id="7588844">fakeConn</span><span class="op" id="7588852">{</span><span class="ident" id="7588853">db</span><span class="op" id="7588855">:</span>&nbsp;<span class="ident" id="7588857">db</span><span class="op" id="7588859">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7588863">if</span>&nbsp;<span class="builtinfunc" id="7588866">len</span><span class="op" id="7588869">(</span><span class="ident" id="7588870">parts</span><span class="op" id="7588875">)</span>&nbsp;<span class="op" id="7588877">&gt;=</span>&nbsp;<span class="num" id="7588880">2</span>&nbsp;<span class="op" id="7588882">&amp;&amp;</span>&nbsp;<span class="ident" id="7588885">parts</span><span class="op" id="7588890">[</span><span class="num" id="7588891">1</span><span class="op" id="7588892">]</span>&nbsp;<span class="op" id="7588894">==</span>&nbsp;<span class="string" id="7588897">&#34;badConn&#34;</span>&nbsp;<span class="op" id="7588907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588911">conn</span><span class="op" id="7588915">.</span><span class="ident" id="7588916">bad</span>&nbsp;<span class="op" id="7588920">=</span>&nbsp;<span class="builtintype" id="7588922">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7588928">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7588931">if</span>&nbsp;<span class="ident" id="7588934">d</span><span class="op" id="7588935">.</span><span class="ident" id="7588936">waitCh</span>&nbsp;<span class="op" id="7588943">!=</span>&nbsp;<span class="ident" id="7588946">nil</span>&nbsp;<span class="op" id="7588950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588954">d</span><span class="op" id="7588955">.</span><span class="ident" id="7588956">waitingCh</span>&nbsp;<span class="op" id="7588966">&lt;-</span>&nbsp;<span class="keyword" id="7588969">struct</span><span class="op" id="7588975">{</span><span class="op" id="7588976">}</span><span class="op" id="7588977">{</span><span class="op" id="7588978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7588982">&lt;-</span><span class="ident" id="7588984">d</span><span class="op" id="7588985">.</span><span class="ident" id="7588986">waitCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7588995">d</span><span class="op" id="7588996">.</span><span class="ident" id="7588997">waitCh</span>&nbsp;<span class="op" id="7589004">=</span>&nbsp;<span class="ident" id="7589006">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589012">d</span><span class="op" id="7589013">.</span><span class="ident" id="7589014">waitingCh</span>&nbsp;<span class="op" id="7589024">=</span>&nbsp;<span class="ident" id="7589026">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7589031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589034">return</span>&nbsp;<span class="ident" id="7589041">conn</span><span class="op" id="7589045">,</span>&nbsp;<span class="ident" id="7589047">nil</span><br>
<span class="lineno"></span><span class="op" id="7589051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7589054">func</span>&nbsp;<span class="op" id="7589059">(</span><span class="ident" id="7589060">d</span>&nbsp;<span class="op" id="7589062">*</span><span class="ident" id="7589063">fakeDriver</span><span class="op" id="7589073">)</span>&nbsp;<span class="ident" id="7589075">getDB</span><span class="op" id="7589080">(</span><span class="ident" id="7589081">name</span>&nbsp;<span class="builtintype" id="7589086">string</span><span class="op" id="7589092">)</span>&nbsp;<span class="op" id="7589094">*</span><span class="ident" id="7589095">fakeDB</span>&nbsp;<span class="op" id="7589102">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589105">d</span><span class="op" id="7589106">.</span><span class="ident" id="7589107">mu</span><span class="op" id="7589109">.</span><span class="ident" id="7589110">Lock</span><span class="op" id="7589114">(</span><span class="op" id="7589115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589118">defer</span>&nbsp;<span class="ident" id="7589124">d</span><span class="op" id="7589125">.</span><span class="ident" id="7589126">mu</span><span class="op" id="7589128">.</span><span class="ident" id="7589129">Unlock</span><span class="op" id="7589135">(</span><span class="op" id="7589136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589139">if</span>&nbsp;<span class="ident" id="7589142">d</span><span class="op" id="7589143">.</span><span class="ident" id="7589144">dbs</span>&nbsp;<span class="op" id="7589148">==</span>&nbsp;<span class="ident" id="7589151">nil</span>&nbsp;<span class="op" id="7589155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589159">d</span><span class="op" id="7589160">.</span><span class="ident" id="7589161">dbs</span>&nbsp;<span class="op" id="7589165">=</span>&nbsp;<span class="builtinfunc" id="7589167">make</span><span class="op" id="7589171">(</span><span class="keyword" id="7589172">map</span><span class="op" id="7589175">[</span><span class="builtintype" id="7589176">string</span><span class="op" id="7589182">]</span><span class="op" id="7589183">*</span><span class="ident" id="7589184">fakeDB</span><span class="op" id="7589190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7589193">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589196">db</span><span class="op" id="7589198">,</span>&nbsp;<span class="ident" id="7589200">ok</span>&nbsp;<span class="op" id="7589203">:=</span>&nbsp;<span class="ident" id="7589206">d</span><span class="op" id="7589207">.</span><span class="ident" id="7589208">dbs</span><span class="op" id="7589211">[</span><span class="ident" id="7589212">name</span><span class="op" id="7589216">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589219">if</span>&nbsp;<span class="op" id="7589222">!</span><span class="ident" id="7589223">ok</span>&nbsp;<span class="op" id="7589226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589230">db</span>&nbsp;<span class="op" id="7589233">=</span>&nbsp;<span class="op" id="7589235">&amp;</span><span class="ident" id="7589236">fakeDB</span><span class="op" id="7589242">{</span><span class="ident" id="7589243">name</span><span class="op" id="7589247">:</span>&nbsp;<span class="ident" id="7589249">name</span><span class="op" id="7589253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589257">d</span><span class="op" id="7589258">.</span><span class="ident" id="7589259">dbs</span><span class="op" id="7589262">[</span><span class="ident" id="7589263">name</span><span class="op" id="7589267">]</span>&nbsp;<span class="op" id="7589269">=</span>&nbsp;<span class="ident" id="7589271">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7589275">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589278">return</span>&nbsp;<span class="ident" id="7589285">db</span><br>
<span class="lineno"></span><span class="op" id="7589288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7589291">func</span>&nbsp;<span class="op" id="7589296">(</span><span class="ident" id="7589297">db</span>&nbsp;<span class="op" id="7589300">*</span><span class="ident" id="7589301">fakeDB</span><span class="op" id="7589307">)</span>&nbsp;<span class="ident" id="7589309">wipe</span><span class="op" id="7589313">(</span><span class="op" id="7589314">)</span>&nbsp;<span class="op" id="7589316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589319">db</span><span class="op" id="7589321">.</span><span class="ident" id="7589322">mu</span><span class="op" id="7589324">.</span><span class="ident" id="7589325">Lock</span><span class="op" id="7589329">(</span><span class="op" id="7589330">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589333">defer</span>&nbsp;<span class="ident" id="7589339">db</span><span class="op" id="7589341">.</span><span class="ident" id="7589342">mu</span><span class="op" id="7589344">.</span><span class="ident" id="7589345">Unlock</span><span class="op" id="7589351">(</span><span class="op" id="7589352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589355">db</span><span class="op" id="7589357">.</span><span class="ident" id="7589358">tables</span>&nbsp;<span class="op" id="7589365">=</span>&nbsp;<span class="ident" id="7589367">nil</span><br>
<span class="lineno"></span><span class="op" id="7589371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7589374">func</span>&nbsp;<span class="op" id="7589379">(</span><span class="ident" id="7589380">db</span>&nbsp;<span class="op" id="7589383">*</span><span class="ident" id="7589384">fakeDB</span><span class="op" id="7589390">)</span>&nbsp;<span class="ident" id="7589392">createTable</span><span class="op" id="7589403">(</span><span class="ident" id="7589404">name</span>&nbsp;<span class="builtintype" id="7589409">string</span><span class="op" id="7589415">,</span>&nbsp;<span class="ident" id="7589417">columnNames</span><span class="op" id="7589428">,</span>&nbsp;<span class="ident" id="7589430">columnTypes</span>&nbsp;<span class="op" id="7589442">[</span><span class="op" id="7589443">]</span><span class="builtintype" id="7589444">string</span><span class="op" id="7589450">)</span>&nbsp;<span class="builtintype" id="7589452">error</span>&nbsp;<span class="op" id="7589458">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589461">db</span><span class="op" id="7589463">.</span><span class="ident" id="7589464">mu</span><span class="op" id="7589466">.</span><span class="ident" id="7589467">Lock</span><span class="op" id="7589471">(</span><span class="op" id="7589472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589475">defer</span>&nbsp;<span class="ident" id="7589481">db</span><span class="op" id="7589483">.</span><span class="ident" id="7589484">mu</span><span class="op" id="7589486">.</span><span class="ident" id="7589487">Unlock</span><span class="op" id="7589493">(</span><span class="op" id="7589494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589497">if</span>&nbsp;<span class="ident" id="7589500">db</span><span class="op" id="7589502">.</span><span class="ident" id="7589503">tables</span>&nbsp;<span class="op" id="7589510">==</span>&nbsp;<span class="ident" id="7589513">nil</span>&nbsp;<span class="op" id="7589517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589521">db</span><span class="op" id="7589523">.</span><span class="ident" id="7589524">tables</span>&nbsp;<span class="op" id="7589531">=</span>&nbsp;<span class="builtinfunc" id="7589533">make</span><span class="op" id="7589537">(</span><span class="keyword" id="7589538">map</span><span class="op" id="7589541">[</span><span class="builtintype" id="7589542">string</span><span class="op" id="7589548">]</span><span class="op" id="7589549">*</span><span class="ident" id="7589550">table</span><span class="op" id="7589555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7589558">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589561">if</span>&nbsp;<span class="ident" id="7589564">_</span><span class="op" id="7589565">,</span>&nbsp;<span class="ident" id="7589567">exist</span>&nbsp;<span class="op" id="7589573">:=</span>&nbsp;<span class="ident" id="7589576">db</span><span class="op" id="7589578">.</span><span class="ident" id="7589579">tables</span><span class="op" id="7589585">[</span><span class="ident" id="7589586">name</span><span class="op" id="7589590">]</span><span class="op" id="7589591">;</span>&nbsp;<span class="ident" id="7589593">exist</span>&nbsp;<span class="op" id="7589599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589603">return</span>&nbsp;<span class="ident" id="7589610">fmt</span><span class="op" id="7589613">.</span><span class="ident" id="7589614">Errorf</span><span class="op" id="7589620">(</span><span class="string" id="7589621">&#34;table&nbsp;%q&nbsp;already&nbsp;exists&#34;</span><span class="op" id="7589646">,</span>&nbsp;<span class="ident" id="7589648">name</span><span class="op" id="7589652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7589655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589658">if</span>&nbsp;<span class="builtinfunc" id="7589661">len</span><span class="op" id="7589664">(</span><span class="ident" id="7589665">columnNames</span><span class="op" id="7589676">)</span>&nbsp;<span class="op" id="7589678">!=</span>&nbsp;<span class="builtinfunc" id="7589681">len</span><span class="op" id="7589684">(</span><span class="ident" id="7589685">columnTypes</span><span class="op" id="7589696">)</span>&nbsp;<span class="op" id="7589698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589702">return</span>&nbsp;<span class="ident" id="7589709">fmt</span><span class="op" id="7589712">.</span><span class="ident" id="7589713">Errorf</span><span class="op" id="7589719">(</span><span class="string" id="7589720">&#34;create&nbsp;table&nbsp;of&nbsp;%q&nbsp;len(names)&nbsp;!=&nbsp;len(types):&nbsp;%d&nbsp;vs&nbsp;%d&#34;</span><span class="op" id="7589775">,</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589780">name</span><span class="op" id="7589784">,</span>&nbsp;<span class="builtinfunc" id="7589786">len</span><span class="op" id="7589789">(</span><span class="ident" id="7589790">columnNames</span><span class="op" id="7589801">)</span><span class="op" id="7589802">,</span>&nbsp;<span class="builtinfunc" id="7589804">len</span><span class="op" id="7589807">(</span><span class="ident" id="7589808">columnTypes</span><span class="op" id="7589819">)</span><span class="op" id="7589820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7589823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7589826">db</span><span class="op" id="7589828">.</span><span class="ident" id="7589829">tables</span><span class="op" id="7589835">[</span><span class="ident" id="7589836">name</span><span class="op" id="7589840">]</span>&nbsp;<span class="op" id="7589842">=</span>&nbsp;<span class="op" id="7589844">&amp;</span><span class="ident" id="7589845">table</span><span class="op" id="7589850">{</span><span class="ident" id="7589851">colname</span><span class="op" id="7589858">:</span>&nbsp;<span class="ident" id="7589860">columnNames</span><span class="op" id="7589871">,</span>&nbsp;<span class="ident" id="7589873">coltype</span><span class="op" id="7589880">:</span>&nbsp;<span class="ident" id="7589882">columnTypes</span><span class="op" id="7589893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7589896">return</span>&nbsp;<span class="ident" id="7589903">nil</span><br>
<span class="lineno"></span><span class="op" id="7589907">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="7589910">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;db.mu&nbsp;lock&nbsp;held</span><br>
<span class="lineno"></span><span class="keyword" id="7589949">func</span>&nbsp;<span class="op" id="7589954">(</span><span class="ident" id="7589955">db</span>&nbsp;<span class="op" id="7589958">*</span><span class="ident" id="7589959">fakeDB</span><span class="op" id="7589965">)</span>&nbsp;<span class="ident" id="7589967">table</span><span class="op" id="7589972">(</span><span class="ident" id="7589973">table</span>&nbsp;<span class="builtintype" id="7589979">string</span><span class="op" id="7589985">)</span>&nbsp;<span class="op" id="7589987">(</span><span class="op" id="7589988">*</span><span class="ident" id="7589989">table</span><span class="op" id="7589994">,</span>&nbsp;<span class="builtintype" id="7589996">bool</span><span class="op" id="7590000">)</span>&nbsp;<span class="op" id="7590002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590005">if</span>&nbsp;<span class="ident" id="7590008">db</span><span class="op" id="7590010">.</span><span class="ident" id="7590011">tables</span>&nbsp;<span class="op" id="7590018">==</span>&nbsp;<span class="ident" id="7590021">nil</span>&nbsp;<span class="op" id="7590025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590029">return</span>&nbsp;<span class="ident" id="7590036">nil</span><span class="op" id="7590039">,</span>&nbsp;<span class="builtintype" id="7590041">false</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590051">t</span><span class="op" id="7590052">,</span>&nbsp;<span class="ident" id="7590054">ok</span>&nbsp;<span class="op" id="7590057">:=</span>&nbsp;<span class="ident" id="7590060">db</span><span class="op" id="7590062">.</span><span class="ident" id="7590063">tables</span><span class="op" id="7590069">[</span><span class="ident" id="7590070">table</span><span class="op" id="7590075">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590078">return</span>&nbsp;<span class="ident" id="7590085">t</span><span class="op" id="7590086">,</span>&nbsp;<span class="ident" id="7590088">ok</span><br>
<span class="lineno"></span><span class="op" id="7590091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="7590094">func</span>&nbsp;<span class="op" id="7590099">(</span><span class="ident" id="7590100">db</span>&nbsp;<span class="op" id="7590103">*</span><span class="ident" id="7590104">fakeDB</span><span class="op" id="7590110">)</span>&nbsp;<span class="ident" id="7590112">columnType</span><span class="op" id="7590122">(</span><span class="ident" id="7590123">table</span><span class="op" id="7590128">,</span>&nbsp;<span class="ident" id="7590130">column</span>&nbsp;<span class="builtintype" id="7590137">string</span><span class="op" id="7590143">)</span>&nbsp;<span class="op" id="7590145">(</span><span class="ident" id="7590146">typ</span>&nbsp;<span class="builtintype" id="7590150">string</span><span class="op" id="7590156">,</span>&nbsp;<span class="ident" id="7590158">ok</span>&nbsp;<span class="builtintype" id="7590161">bool</span><span class="op" id="7590165">)</span>&nbsp;<span class="op" id="7590167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590170">db</span><span class="op" id="7590172">.</span><span class="ident" id="7590173">mu</span><span class="op" id="7590175">.</span><span class="ident" id="7590176">Lock</span><span class="op" id="7590180">(</span><span class="op" id="7590181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590184">defer</span>&nbsp;<span class="ident" id="7590190">db</span><span class="op" id="7590192">.</span><span class="ident" id="7590193">mu</span><span class="op" id="7590195">.</span><span class="ident" id="7590196">Unlock</span><span class="op" id="7590202">(</span><span class="op" id="7590203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590206">t</span><span class="op" id="7590207">,</span>&nbsp;<span class="ident" id="7590209">ok</span>&nbsp;<span class="op" id="7590212">:=</span>&nbsp;<span class="ident" id="7590215">db</span><span class="op" id="7590217">.</span><span class="ident" id="7590218">table</span><span class="op" id="7590223">(</span><span class="ident" id="7590224">table</span><span class="op" id="7590229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590232">if</span>&nbsp;<span class="op" id="7590235">!</span><span class="ident" id="7590236">ok</span>&nbsp;<span class="op" id="7590239">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590243">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590254">for</span>&nbsp;<span class="ident" id="7590258">n</span><span class="op" id="7590259">,</span>&nbsp;<span class="ident" id="7590261">cname</span>&nbsp;<span class="op" id="7590267">:=</span>&nbsp;<span class="keyword" id="7590270">range</span>&nbsp;<span class="ident" id="7590276">t</span><span class="op" id="7590277">.</span><span class="ident" id="7590278">colname</span>&nbsp;<span class="op" id="7590286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590290">if</span>&nbsp;<span class="ident" id="7590293">cname</span>&nbsp;<span class="op" id="7590299">==</span>&nbsp;<span class="ident" id="7590302">column</span>&nbsp;<span class="op" id="7590309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590314">return</span>&nbsp;<span class="ident" id="7590321">t</span><span class="op" id="7590322">.</span><span class="ident" id="7590323">coltype</span><span class="op" id="7590330">[</span><span class="ident" id="7590331">n</span><span class="op" id="7590332">]</span><span class="op" id="7590333">,</span>&nbsp;<span class="builtintype" id="7590335">true</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590348">return</span>&nbsp;<span class="string" id="7590355">&#34;&#34;</span><span class="op" id="7590357">,</span>&nbsp;<span class="builtintype" id="7590359">false</span><br>
<span class="lineno"></span><span class="op" id="7590365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="keyword" id="7590368">func</span>&nbsp;<span class="op" id="7590373">(</span><span class="ident" id="7590374">c</span>&nbsp;<span class="op" id="7590376">*</span><span class="ident" id="7590377">fakeConn</span><span class="op" id="7590385">)</span>&nbsp;<span class="ident" id="7590387">isBad</span><span class="op" id="7590392">(</span><span class="op" id="7590393">)</span>&nbsp;<span class="builtintype" id="7590395">bool</span>&nbsp;<span class="op" id="7590400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7590403">//&nbsp;if&nbsp;not&nbsp;simulating&nbsp;bad&nbsp;conn,&nbsp;do&nbsp;nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590446">if</span>&nbsp;<span class="op" id="7590449">!</span><span class="ident" id="7590450">c</span><span class="op" id="7590451">.</span><span class="ident" id="7590452">bad</span>&nbsp;<span class="op" id="7590456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590460">return</span>&nbsp;<span class="builtintype" id="7590467">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590474">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7590477">//&nbsp;alternate&nbsp;between&nbsp;bad&nbsp;conn&nbsp;and&nbsp;not&nbsp;bad&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590525">c</span><span class="op" id="7590526">.</span><span class="ident" id="7590527">db</span><span class="op" id="7590529">.</span><span class="ident" id="7590530">badConn</span>&nbsp;<span class="op" id="7590538">=</span>&nbsp;<span class="op" id="7590540">!</span><span class="ident" id="7590541">c</span><span class="op" id="7590542">.</span><span class="ident" id="7590543">db</span><span class="op" id="7590545">.</span><span class="ident" id="7590546">badConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590555">return</span>&nbsp;<span class="ident" id="7590562">c</span><span class="op" id="7590563">.</span><span class="ident" id="7590564">db</span><span class="op" id="7590566">.</span><span class="ident" id="7590567">badConn</span><br>
<span class="lineno"></span><span class="op" id="7590575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="7590578">func</span>&nbsp;<span class="op" id="7590583">(</span><span class="ident" id="7590584">c</span>&nbsp;<span class="op" id="7590586">*</span><span class="ident" id="7590587">fakeConn</span><span class="op" id="7590595">)</span>&nbsp;<span class="ident" id="7590597">Begin</span><span class="op" id="7590602">(</span><span class="op" id="7590603">)</span>&nbsp;<span class="op" id="7590605">(</span><span class="ident" id="7590606">driver</span><span class="op" id="7590612">.</span><span class="ident" id="7590613">Tx</span><span class="op" id="7590615">,</span>&nbsp;<span class="builtintype" id="7590617">error</span><span class="op" id="7590622">)</span>&nbsp;<span class="op" id="7590624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590627">if</span>&nbsp;<span class="ident" id="7590630">c</span><span class="op" id="7590631">.</span><span class="ident" id="7590632">isBad</span><span class="op" id="7590637">(</span><span class="op" id="7590638">)</span>&nbsp;<span class="op" id="7590640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590644">return</span>&nbsp;<span class="ident" id="7590651">nil</span><span class="op" id="7590654">,</span>&nbsp;<span class="ident" id="7590656">driver</span><span class="op" id="7590662">.</span><span class="ident" id="7590663">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590678">if</span>&nbsp;<span class="ident" id="7590681">c</span><span class="op" id="7590682">.</span><span class="ident" id="7590683">currTx</span>&nbsp;<span class="op" id="7590690">!=</span>&nbsp;<span class="ident" id="7590693">nil</span>&nbsp;<span class="op" id="7590697">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590701">return</span>&nbsp;<span class="ident" id="7590708">nil</span><span class="op" id="7590711">,</span>&nbsp;<span class="ident" id="7590713">errors</span><span class="op" id="7590719">.</span><span class="ident" id="7590720">New</span><span class="op" id="7590723">(</span><span class="string" id="7590724">&#34;already&nbsp;in&nbsp;a&nbsp;transaction&#34;</span><span class="op" id="7590750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7590753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590756">c</span><span class="op" id="7590757">.</span><span class="ident" id="7590758">currTx</span>&nbsp;<span class="op" id="7590765">=</span>&nbsp;<span class="op" id="7590767">&amp;</span><span class="ident" id="7590768">fakeTx</span><span class="op" id="7590774">{</span><span class="ident" id="7590775">c</span><span class="op" id="7590776">:</span>&nbsp;<span class="ident" id="7590778">c</span><span class="op" id="7590779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590782">return</span>&nbsp;<span class="ident" id="7590789">c</span><span class="op" id="7590790">.</span><span class="ident" id="7590791">currTx</span><span class="op" id="7590797">,</span>&nbsp;<span class="ident" id="7590799">nil</span><br>
<span class="lineno"></span><span class="op" id="7590803">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="7590806">var</span>&nbsp;<span class="ident" id="7590810">hookPostCloseConn</span>&nbsp;<span class="keyword" id="7590828">struct</span>&nbsp;<span class="op" id="7590835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590838">sync</span><span class="op" id="7590842">.</span><span class="ident" id="7590843">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590850">fn</span>&nbsp;<span class="keyword" id="7590853">func</span><span class="op" id="7590857">(</span><span class="op" id="7590858">*</span><span class="ident" id="7590859">fakeConn</span><span class="op" id="7590867">,</span>&nbsp;<span class="builtintype" id="7590869">error</span><span class="op" id="7590874">)</span><br>
<span class="lineno"></span><span class="op" id="7590876">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="7590879">func</span>&nbsp;<span class="ident" id="7590884">setHookpostCloseConn</span><span class="op" id="7590904">(</span><span class="ident" id="7590905">fn</span>&nbsp;<span class="keyword" id="7590908">func</span><span class="op" id="7590912">(</span><span class="op" id="7590913">*</span><span class="ident" id="7590914">fakeConn</span><span class="op" id="7590922">,</span>&nbsp;<span class="builtintype" id="7590924">error</span><span class="op" id="7590929">)</span><span class="op" id="7590930">)</span>&nbsp;<span class="op" id="7590932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590935">hookPostCloseConn</span><span class="op" id="7590952">.</span><span class="ident" id="7590953">Lock</span><span class="op" id="7590957">(</span><span class="op" id="7590958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7590961">defer</span>&nbsp;<span class="ident" id="7590967">hookPostCloseConn</span><span class="op" id="7590984">.</span><span class="ident" id="7590985">Unlock</span><span class="op" id="7590991">(</span><span class="op" id="7590992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7590995">hookPostCloseConn</span><span class="op" id="7591012">.</span><span class="ident" id="7591013">fn</span>&nbsp;<span class="op" id="7591016">=</span>&nbsp;<span class="ident" id="7591018">fn</span><br>
<span class="lineno">275</span><span class="op" id="7591021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7591024">var</span>&nbsp;<span class="ident" id="7591028">testStrictClose</span>&nbsp;<span class="op" id="7591044">*</span><span class="ident" id="7591045">testing</span><span class="op" id="7591052">.</span><span class="ident" id="7591053">T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7591056">//&nbsp;setStrictFakeConnClose&nbsp;sets&nbsp;the&nbsp;t&nbsp;to&nbsp;Errorf&nbsp;on&nbsp;when&nbsp;fakeConn.Close</span><br>
<span class="lineno">280</span><span class="comment" id="7591126">//&nbsp;fails&nbsp;to&nbsp;close.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;check&nbsp;is&nbsp;disabled.</span><br>
<span class="lineno"></span><span class="keyword" id="7591176">func</span>&nbsp;<span class="ident" id="7591181">setStrictFakeConnClose</span><span class="op" id="7591203">(</span><span class="ident" id="7591204">t</span>&nbsp;<span class="op" id="7591206">*</span><span class="ident" id="7591207">testing</span><span class="op" id="7591214">.</span><span class="ident" id="7591215">T</span><span class="op" id="7591216">)</span>&nbsp;<span class="op" id="7591218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591221">testStrictClose</span>&nbsp;<span class="op" id="7591237">=</span>&nbsp;<span class="ident" id="7591239">t</span><br>
<span class="lineno"></span><span class="op" id="7591241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="7591244">func</span>&nbsp;<span class="op" id="7591249">(</span><span class="ident" id="7591250">c</span>&nbsp;<span class="op" id="7591252">*</span><span class="ident" id="7591253">fakeConn</span><span class="op" id="7591261">)</span>&nbsp;<span class="ident" id="7591263">Close</span><span class="op" id="7591268">(</span><span class="op" id="7591269">)</span>&nbsp;<span class="op" id="7591271">(</span><span class="ident" id="7591272">err</span>&nbsp;<span class="builtintype" id="7591276">error</span><span class="op" id="7591281">)</span>&nbsp;<span class="op" id="7591283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591286">drv</span>&nbsp;<span class="op" id="7591290">:=</span>&nbsp;<span class="ident" id="7591293">fdriver</span><span class="op" id="7591300">.</span><span class="op" id="7591301">(</span><span class="op" id="7591302">*</span><span class="ident" id="7591303">fakeDriver</span><span class="op" id="7591313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591316">defer</span>&nbsp;<span class="keyword" id="7591322">func</span><span class="op" id="7591326">(</span><span class="op" id="7591327">)</span>&nbsp;<span class="op" id="7591329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591333">if</span>&nbsp;<span class="ident" id="7591336">err</span>&nbsp;<span class="op" id="7591340">!=</span>&nbsp;<span class="ident" id="7591343">nil</span>&nbsp;<span class="op" id="7591347">&amp;&amp;</span>&nbsp;<span class="ident" id="7591350">testStrictClose</span>&nbsp;<span class="op" id="7591366">!=</span>&nbsp;<span class="ident" id="7591369">nil</span>&nbsp;<span class="op" id="7591373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591378">testStrictClose</span><span class="op" id="7591393">.</span><span class="ident" id="7591394">Errorf</span><span class="op" id="7591400">(</span><span class="string" id="7591401">&#34;failed&nbsp;to&nbsp;close&nbsp;a&nbsp;test&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7591438">,</span>&nbsp;<span class="ident" id="7591440">err</span><span class="op" id="7591443">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7591447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591451">hookPostCloseConn</span><span class="op" id="7591468">.</span><span class="ident" id="7591469">Lock</span><span class="op" id="7591473">(</span><span class="op" id="7591474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591478">fn</span>&nbsp;<span class="op" id="7591481">:=</span>&nbsp;<span class="ident" id="7591484">hookPostCloseConn</span><span class="op" id="7591501">.</span><span class="ident" id="7591502">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591507">hookPostCloseConn</span><span class="op" id="7591524">.</span><span class="ident" id="7591525">Unlock</span><span class="op" id="7591531">(</span><span class="op" id="7591532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591536">if</span>&nbsp;<span class="ident" id="7591539">fn</span>&nbsp;<span class="op" id="7591542">!=</span>&nbsp;<span class="ident" id="7591545">nil</span>&nbsp;<span class="op" id="7591549">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591554">fn</span><span class="op" id="7591556">(</span><span class="ident" id="7591557">c</span><span class="op" id="7591558">,</span>&nbsp;<span class="ident" id="7591560">err</span><span class="op" id="7591563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7591567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591571">if</span>&nbsp;<span class="ident" id="7591574">err</span>&nbsp;<span class="op" id="7591578">==</span>&nbsp;<span class="ident" id="7591581">nil</span>&nbsp;<span class="op" id="7591585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591590">drv</span><span class="op" id="7591593">.</span><span class="ident" id="7591594">mu</span><span class="op" id="7591596">.</span><span class="ident" id="7591597">Lock</span><span class="op" id="7591601">(</span><span class="op" id="7591602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591607">drv</span><span class="op" id="7591610">.</span><span class="ident" id="7591611">closeCount</span><span class="op" id="7591621">++</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591627">drv</span><span class="op" id="7591630">.</span><span class="ident" id="7591631">mu</span><span class="op" id="7591633">.</span><span class="ident" id="7591634">Unlock</span><span class="op" id="7591640">(</span><span class="op" id="7591641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7591645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7591648">}</span><span class="op" id="7591649">(</span><span class="op" id="7591650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591653">if</span>&nbsp;<span class="ident" id="7591656">c</span><span class="op" id="7591657">.</span><span class="ident" id="7591658">currTx</span>&nbsp;<span class="op" id="7591665">!=</span>&nbsp;<span class="ident" id="7591668">nil</span>&nbsp;<span class="op" id="7591672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591676">return</span>&nbsp;<span class="ident" id="7591683">errors</span><span class="op" id="7591689">.</span><span class="ident" id="7591690">New</span><span class="op" id="7591693">(</span><span class="string" id="7591694">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;in&nbsp;a&nbsp;Transaction&#34;</span><span class="op" id="7591734">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7591737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591740">if</span>&nbsp;<span class="ident" id="7591743">c</span><span class="op" id="7591744">.</span><span class="ident" id="7591745">db</span>&nbsp;<span class="op" id="7591748">==</span>&nbsp;<span class="ident" id="7591751">nil</span>&nbsp;<span class="op" id="7591755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591759">return</span>&nbsp;<span class="ident" id="7591766">errors</span><span class="op" id="7591772">.</span><span class="ident" id="7591773">New</span><span class="op" id="7591776">(</span><span class="string" id="7591777">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;already&nbsp;closed&#34;</span><span class="op" id="7591815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7591818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591821">if</span>&nbsp;<span class="ident" id="7591824">c</span><span class="op" id="7591825">.</span><span class="ident" id="7591826">stmtsMade</span>&nbsp;<span class="op" id="7591836">&gt;</span>&nbsp;<span class="ident" id="7591838">c</span><span class="op" id="7591839">.</span><span class="ident" id="7591840">stmtsClosed</span>&nbsp;<span class="op" id="7591852">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591856">return</span>&nbsp;<span class="ident" id="7591863">errors</span><span class="op" id="7591869">.</span><span class="ident" id="7591870">New</span><span class="op" id="7591873">(</span><span class="string" id="7591874">&#34;can&#39;t&nbsp;close;&nbsp;dangling&nbsp;statement(s)&#34;</span><span class="op" id="7591910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7591913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7591916">c</span><span class="op" id="7591917">.</span><span class="ident" id="7591918">db</span>&nbsp;<span class="op" id="7591921">=</span>&nbsp;<span class="ident" id="7591923">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591928">return</span>&nbsp;<span class="ident" id="7591935">nil</span><br>
<span class="lineno"></span><span class="op" id="7591939">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="7591942">func</span>&nbsp;<span class="ident" id="7591947">checkSubsetTypes</span><span class="op" id="7591963">(</span><span class="ident" id="7591964">args</span>&nbsp;<span class="op" id="7591969">[</span><span class="op" id="7591970">]</span><span class="ident" id="7591971">driver</span><span class="op" id="7591977">.</span><span class="ident" id="7591978">Value</span><span class="op" id="7591983">)</span>&nbsp;<span class="builtintype" id="7591985">error</span>&nbsp;<span class="op" id="7591991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7591994">for</span>&nbsp;<span class="ident" id="7591998">n</span><span class="op" id="7591999">,</span>&nbsp;<span class="ident" id="7592001">arg</span>&nbsp;<span class="op" id="7592005">:=</span>&nbsp;<span class="keyword" id="7592008">range</span>&nbsp;<span class="ident" id="7592014">args</span>&nbsp;<span class="op" id="7592019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592023">switch</span>&nbsp;<span class="ident" id="7592030">arg</span><span class="op" id="7592033">.</span><span class="op" id="7592034">(</span><span class="keyword" id="7592035">type</span><span class="op" id="7592039">)</span>&nbsp;<span class="op" id="7592041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592045">case</span>&nbsp;<span class="ident" id="7592050">int64</span><span class="op" id="7592055">,</span>&nbsp;<span class="builtintype" id="7592057">float64</span><span class="op" id="7592064">,</span>&nbsp;<span class="builtintype" id="7592066">bool</span><span class="op" id="7592070">,</span>&nbsp;<span class="ident" id="7592072">nil</span><span class="op" id="7592075">,</span>&nbsp;<span class="op" id="7592077">[</span><span class="op" id="7592078">]</span><span class="builtintype" id="7592079">byte</span><span class="op" id="7592083">,</span>&nbsp;<span class="builtintype" id="7592085">string</span><span class="op" id="7592091">,</span>&nbsp;<span class="ident" id="7592093">time</span><span class="op" id="7592097">.</span><span class="ident" id="7592098">Time</span><span class="op" id="7592102">:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592106">default</span><span class="op" id="7592113">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592118">return</span>&nbsp;<span class="ident" id="7592125">fmt</span><span class="op" id="7592128">.</span><span class="ident" id="7592129">Errorf</span><span class="op" id="7592135">(</span><span class="string" id="7592136">&#34;fakedb_test:&nbsp;invalid&nbsp;argument&nbsp;#%d:&nbsp;%v,&nbsp;type&nbsp;%T&#34;</span><span class="op" id="7592184">,</span>&nbsp;<span class="ident" id="7592186">n</span><span class="op" id="7592187">+</span><span class="num" id="7592188">1</span><span class="op" id="7592189">,</span>&nbsp;<span class="ident" id="7592191">arg</span><span class="op" id="7592194">,</span>&nbsp;<span class="ident" id="7592196">arg</span><span class="op" id="7592199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7592203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7592206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592209">return</span>&nbsp;<span class="ident" id="7592216">nil</span><br>
<span class="lineno">325</span><span class="op" id="7592220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7592223">func</span>&nbsp;<span class="op" id="7592228">(</span><span class="ident" id="7592229">c</span>&nbsp;<span class="op" id="7592231">*</span><span class="ident" id="7592232">fakeConn</span><span class="op" id="7592240">)</span>&nbsp;<span class="ident" id="7592242">Exec</span><span class="op" id="7592246">(</span><span class="ident" id="7592247">query</span>&nbsp;<span class="builtintype" id="7592253">string</span><span class="op" id="7592259">,</span>&nbsp;<span class="ident" id="7592261">args</span>&nbsp;<span class="op" id="7592266">[</span><span class="op" id="7592267">]</span><span class="ident" id="7592268">driver</span><span class="op" id="7592274">.</span><span class="ident" id="7592275">Value</span><span class="op" id="7592280">)</span>&nbsp;<span class="op" id="7592282">(</span><span class="ident" id="7592283">driver</span><span class="op" id="7592289">.</span><span class="ident" id="7592290">Result</span><span class="op" id="7592296">,</span>&nbsp;<span class="builtintype" id="7592298">error</span><span class="op" id="7592303">)</span>&nbsp;<span class="op" id="7592305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7592308">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7592369">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7592430">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7592489">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7592516">err</span>&nbsp;<span class="op" id="7592520">:=</span>&nbsp;<span class="ident" id="7592523">checkSubsetTypes</span><span class="op" id="7592539">(</span><span class="ident" id="7592540">args</span><span class="op" id="7592544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592547">if</span>&nbsp;<span class="ident" id="7592550">err</span>&nbsp;<span class="op" id="7592554">!=</span>&nbsp;<span class="ident" id="7592557">nil</span>&nbsp;<span class="op" id="7592561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592565">return</span>&nbsp;<span class="ident" id="7592572">nil</span><span class="op" id="7592575">,</span>&nbsp;<span class="ident" id="7592577">err</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7592582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592585">return</span>&nbsp;<span class="ident" id="7592592">nil</span><span class="op" id="7592595">,</span>&nbsp;<span class="ident" id="7592597">driver</span><span class="op" id="7592603">.</span><span class="ident" id="7592604">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="7592612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7592615">func</span>&nbsp;<span class="op" id="7592620">(</span><span class="ident" id="7592621">c</span>&nbsp;<span class="op" id="7592623">*</span><span class="ident" id="7592624">fakeConn</span><span class="op" id="7592632">)</span>&nbsp;<span class="ident" id="7592634">Query</span><span class="op" id="7592639">(</span><span class="ident" id="7592640">query</span>&nbsp;<span class="builtintype" id="7592646">string</span><span class="op" id="7592652">,</span>&nbsp;<span class="ident" id="7592654">args</span>&nbsp;<span class="op" id="7592659">[</span><span class="op" id="7592660">]</span><span class="ident" id="7592661">driver</span><span class="op" id="7592667">.</span><span class="ident" id="7592668">Value</span><span class="op" id="7592673">)</span>&nbsp;<span class="op" id="7592675">(</span><span class="ident" id="7592676">driver</span><span class="op" id="7592682">.</span><span class="ident" id="7592683">Rows</span><span class="op" id="7592687">,</span>&nbsp;<span class="builtintype" id="7592689">error</span><span class="op" id="7592694">)</span>&nbsp;<span class="op" id="7592696">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7592699">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7592760">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7592821">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7592880">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7592907">err</span>&nbsp;<span class="op" id="7592911">:=</span>&nbsp;<span class="ident" id="7592914">checkSubsetTypes</span><span class="op" id="7592930">(</span><span class="ident" id="7592931">args</span><span class="op" id="7592935">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592938">if</span>&nbsp;<span class="ident" id="7592941">err</span>&nbsp;<span class="op" id="7592945">!=</span>&nbsp;<span class="ident" id="7592948">nil</span>&nbsp;<span class="op" id="7592952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592956">return</span>&nbsp;<span class="ident" id="7592963">nil</span><span class="op" id="7592966">,</span>&nbsp;<span class="ident" id="7592968">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7592973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7592976">return</span>&nbsp;<span class="ident" id="7592983">nil</span><span class="op" id="7592986">,</span>&nbsp;<span class="ident" id="7592988">driver</span><span class="op" id="7592994">.</span><span class="ident" id="7592995">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="7593003">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="7593006">func</span>&nbsp;<span class="ident" id="7593011">errf</span><span class="op" id="7593015">(</span><span class="ident" id="7593016">msg</span>&nbsp;<span class="builtintype" id="7593020">string</span><span class="op" id="7593026">,</span>&nbsp;<span class="ident" id="7593028">args</span>&nbsp;<span class="op" id="7593033">...</span><span class="keyword" id="7593036">interface</span><span class="op" id="7593045">{</span><span class="op" id="7593046">}</span><span class="op" id="7593047">)</span>&nbsp;<span class="builtintype" id="7593049">error</span>&nbsp;<span class="op" id="7593055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593058">return</span>&nbsp;<span class="ident" id="7593065">errors</span><span class="op" id="7593071">.</span><span class="ident" id="7593072">New</span><span class="op" id="7593075">(</span><span class="string" id="7593076">&#34;fakedb:&nbsp;&#34;</span>&nbsp;<span class="op" id="7593087">+</span>&nbsp;<span class="ident" id="7593089">fmt</span><span class="op" id="7593092">.</span><span class="ident" id="7593093">Sprintf</span><span class="op" id="7593100">(</span><span class="ident" id="7593101">msg</span><span class="op" id="7593104">,</span>&nbsp;<span class="ident" id="7593106">args</span><span class="op" id="7593110">...</span><span class="op" id="7593113">)</span><span class="op" id="7593114">)</span><br>
<span class="lineno"></span><span class="op" id="7593116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="7593119">//&nbsp;parts&nbsp;are&nbsp;table|selectCol1,selectCol2|whereCol=?,whereCol2=?</span><br>
<span class="lineno"></span><span class="comment" id="7593183">//&nbsp;(note&nbsp;that&nbsp;where&nbsp;columns&nbsp;must&nbsp;always&nbsp;contain&nbsp;?&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="7593240">//&nbsp;&nbsp;just&nbsp;a&nbsp;limitation&nbsp;for&nbsp;fakedb)</span><br>
<span class="lineno"></span><span class="keyword" id="7593274">func</span>&nbsp;<span class="op" id="7593279">(</span><span class="ident" id="7593280">c</span>&nbsp;<span class="op" id="7593282">*</span><span class="ident" id="7593283">fakeConn</span><span class="op" id="7593291">)</span>&nbsp;<span class="ident" id="7593293">prepareSelect</span><span class="op" id="7593306">(</span><span class="ident" id="7593307">stmt</span>&nbsp;<span class="op" id="7593312">*</span><span class="ident" id="7593313">fakeStmt</span><span class="op" id="7593321">,</span>&nbsp;<span class="ident" id="7593323">parts</span>&nbsp;<span class="op" id="7593329">[</span><span class="op" id="7593330">]</span><span class="builtintype" id="7593331">string</span><span class="op" id="7593337">)</span>&nbsp;<span class="op" id="7593339">(</span><span class="ident" id="7593340">driver</span><span class="op" id="7593346">.</span><span class="ident" id="7593347">Stmt</span><span class="op" id="7593351">,</span>&nbsp;<span class="builtintype" id="7593353">error</span><span class="op" id="7593358">)</span>&nbsp;<span class="op" id="7593360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593363">if</span>&nbsp;<span class="builtinfunc" id="7593366">len</span><span class="op" id="7593369">(</span><span class="ident" id="7593370">parts</span><span class="op" id="7593375">)</span>&nbsp;<span class="op" id="7593377">!=</span>&nbsp;<span class="num" id="7593380">3</span>&nbsp;<span class="op" id="7593382">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593386">stmt</span><span class="op" id="7593390">.</span><span class="ident" id="7593391">Close</span><span class="op" id="7593396">(</span><span class="op" id="7593397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593401">return</span>&nbsp;<span class="ident" id="7593408">nil</span><span class="op" id="7593411">,</span>&nbsp;<span class="ident" id="7593413">errf</span><span class="op" id="7593417">(</span><span class="string" id="7593418">&#34;invalid&nbsp;SELECT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;3&#34;</span><span class="op" id="7593463">,</span>&nbsp;<span class="builtinfunc" id="7593465">len</span><span class="op" id="7593468">(</span><span class="ident" id="7593469">parts</span><span class="op" id="7593474">)</span><span class="op" id="7593475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7593478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593481">stmt</span><span class="op" id="7593485">.</span><span class="ident" id="7593486">table</span>&nbsp;<span class="op" id="7593492">=</span>&nbsp;<span class="ident" id="7593494">parts</span><span class="op" id="7593499">[</span><span class="num" id="7593500">0</span><span class="op" id="7593501">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593504">stmt</span><span class="op" id="7593508">.</span><span class="ident" id="7593509">colName</span>&nbsp;<span class="op" id="7593517">=</span>&nbsp;<span class="ident" id="7593519">strings</span><span class="op" id="7593526">.</span><span class="ident" id="7593527">Split</span><span class="op" id="7593532">(</span><span class="ident" id="7593533">parts</span><span class="op" id="7593538">[</span><span class="num" id="7593539">1</span><span class="op" id="7593540">]</span><span class="op" id="7593541">,</span>&nbsp;<span class="string" id="7593543">&#34;,&#34;</span><span class="op" id="7593546">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593549">for</span>&nbsp;<span class="ident" id="7593553">n</span><span class="op" id="7593554">,</span>&nbsp;<span class="ident" id="7593556">colspec</span>&nbsp;<span class="op" id="7593564">:=</span>&nbsp;<span class="keyword" id="7593567">range</span>&nbsp;<span class="ident" id="7593573">strings</span><span class="op" id="7593580">.</span><span class="ident" id="7593581">Split</span><span class="op" id="7593586">(</span><span class="ident" id="7593587">parts</span><span class="op" id="7593592">[</span><span class="num" id="7593593">2</span><span class="op" id="7593594">]</span><span class="op" id="7593595">,</span>&nbsp;<span class="string" id="7593597">&#34;,&#34;</span><span class="op" id="7593600">)</span>&nbsp;<span class="op" id="7593602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593606">if</span>&nbsp;<span class="ident" id="7593609">colspec</span>&nbsp;<span class="op" id="7593617">==</span>&nbsp;<span class="string" id="7593620">&#34;&#34;</span>&nbsp;<span class="op" id="7593623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593628">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7593639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593643">nameVal</span>&nbsp;<span class="op" id="7593651">:=</span>&nbsp;<span class="ident" id="7593654">strings</span><span class="op" id="7593661">.</span><span class="ident" id="7593662">Split</span><span class="op" id="7593667">(</span><span class="ident" id="7593668">colspec</span><span class="op" id="7593675">,</span>&nbsp;<span class="string" id="7593677">&#34;=&#34;</span><span class="op" id="7593680">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593684">if</span>&nbsp;<span class="builtinfunc" id="7593687">len</span><span class="op" id="7593690">(</span><span class="ident" id="7593691">nameVal</span><span class="op" id="7593698">)</span>&nbsp;<span class="op" id="7593700">!=</span>&nbsp;<span class="num" id="7593703">2</span>&nbsp;<span class="op" id="7593705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593710">stmt</span><span class="op" id="7593714">.</span><span class="ident" id="7593715">Close</span><span class="op" id="7593720">(</span><span class="op" id="7593721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593726">return</span>&nbsp;<span class="ident" id="7593733">nil</span><span class="op" id="7593736">,</span>&nbsp;<span class="ident" id="7593738">errf</span><span class="op" id="7593742">(</span><span class="string" id="7593743">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7593804">,</span>&nbsp;<span class="ident" id="7593806">stmt</span><span class="op" id="7593810">.</span><span class="ident" id="7593811">table</span><span class="op" id="7593816">,</span>&nbsp;<span class="ident" id="7593818">colspec</span><span class="op" id="7593825">,</span>&nbsp;<span class="ident" id="7593827">n</span><span class="op" id="7593828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7593832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593836">column</span><span class="op" id="7593842">,</span>&nbsp;<span class="ident" id="7593844">value</span>&nbsp;<span class="op" id="7593850">:=</span>&nbsp;<span class="ident" id="7593853">nameVal</span><span class="op" id="7593860">[</span><span class="num" id="7593861">0</span><span class="op" id="7593862">]</span><span class="op" id="7593863">,</span>&nbsp;<span class="ident" id="7593865">nameVal</span><span class="op" id="7593872">[</span><span class="num" id="7593873">1</span><span class="op" id="7593874">]</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593878">_</span><span class="op" id="7593879">,</span>&nbsp;<span class="ident" id="7593881">ok</span>&nbsp;<span class="op" id="7593884">:=</span>&nbsp;<span class="ident" id="7593887">c</span><span class="op" id="7593888">.</span><span class="ident" id="7593889">db</span><span class="op" id="7593891">.</span><span class="ident" id="7593892">columnType</span><span class="op" id="7593902">(</span><span class="ident" id="7593903">stmt</span><span class="op" id="7593907">.</span><span class="ident" id="7593908">table</span><span class="op" id="7593913">,</span>&nbsp;<span class="ident" id="7593915">column</span><span class="op" id="7593921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593925">if</span>&nbsp;<span class="op" id="7593928">!</span><span class="ident" id="7593929">ok</span>&nbsp;<span class="op" id="7593932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7593937">stmt</span><span class="op" id="7593941">.</span><span class="ident" id="7593942">Close</span><span class="op" id="7593947">(</span><span class="op" id="7593948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7593953">return</span>&nbsp;<span class="ident" id="7593960">nil</span><span class="op" id="7593963">,</span>&nbsp;<span class="ident" id="7593965">errf</span><span class="op" id="7593969">(</span><span class="string" id="7593970">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7594024">,</span>&nbsp;<span class="ident" id="7594026">stmt</span><span class="op" id="7594030">.</span><span class="ident" id="7594031">table</span><span class="op" id="7594036">,</span>&nbsp;<span class="ident" id="7594038">column</span><span class="op" id="7594044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594048">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594052">if</span>&nbsp;<span class="ident" id="7594055">value</span>&nbsp;<span class="op" id="7594061">!=</span>&nbsp;<span class="string" id="7594064">&#34;?&#34;</span>&nbsp;<span class="op" id="7594068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594073">stmt</span><span class="op" id="7594077">.</span><span class="ident" id="7594078">Close</span><span class="op" id="7594083">(</span><span class="op" id="7594084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594089">return</span>&nbsp;<span class="ident" id="7594096">nil</span><span class="op" id="7594099">,</span>&nbsp;<span class="ident" id="7594101">errf</span><span class="op" id="7594105">(</span><span class="string" id="7594106">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;pre-bound&nbsp;value&nbsp;for&nbsp;where&nbsp;column&nbsp;%q;&nbsp;need&nbsp;a&nbsp;question&nbsp;mark&#34;</span><span class="op" id="7594188">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594194">stmt</span><span class="op" id="7594198">.</span><span class="ident" id="7594199">table</span><span class="op" id="7594204">,</span>&nbsp;<span class="ident" id="7594206">column</span><span class="op" id="7594212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594216">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594220">stmt</span><span class="op" id="7594224">.</span><span class="ident" id="7594225">whereCol</span>&nbsp;<span class="op" id="7594234">=</span>&nbsp;<span class="builtinfunc" id="7594236">append</span><span class="op" id="7594242">(</span><span class="ident" id="7594243">stmt</span><span class="op" id="7594247">.</span><span class="ident" id="7594248">whereCol</span><span class="op" id="7594256">,</span>&nbsp;<span class="ident" id="7594258">column</span><span class="op" id="7594264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594268">stmt</span><span class="op" id="7594272">.</span><span class="ident" id="7594273">placeholders</span><span class="op" id="7594285">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594292">return</span>&nbsp;<span class="ident" id="7594299">stmt</span><span class="op" id="7594303">,</span>&nbsp;<span class="ident" id="7594305">nil</span><br>
<span class="lineno"></span><span class="op" id="7594309">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span><span class="comment" id="7594312">//&nbsp;parts&nbsp;are&nbsp;table|col=type,col2=type2</span><br>
<span class="lineno"></span><span class="keyword" id="7594351">func</span>&nbsp;<span class="op" id="7594356">(</span><span class="ident" id="7594357">c</span>&nbsp;<span class="op" id="7594359">*</span><span class="ident" id="7594360">fakeConn</span><span class="op" id="7594368">)</span>&nbsp;<span class="ident" id="7594370">prepareCreate</span><span class="op" id="7594383">(</span><span class="ident" id="7594384">stmt</span>&nbsp;<span class="op" id="7594389">*</span><span class="ident" id="7594390">fakeStmt</span><span class="op" id="7594398">,</span>&nbsp;<span class="ident" id="7594400">parts</span>&nbsp;<span class="op" id="7594406">[</span><span class="op" id="7594407">]</span><span class="builtintype" id="7594408">string</span><span class="op" id="7594414">)</span>&nbsp;<span class="op" id="7594416">(</span><span class="ident" id="7594417">driver</span><span class="op" id="7594423">.</span><span class="ident" id="7594424">Stmt</span><span class="op" id="7594428">,</span>&nbsp;<span class="builtintype" id="7594430">error</span><span class="op" id="7594435">)</span>&nbsp;<span class="op" id="7594437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594440">if</span>&nbsp;<span class="builtinfunc" id="7594443">len</span><span class="op" id="7594446">(</span><span class="ident" id="7594447">parts</span><span class="op" id="7594452">)</span>&nbsp;<span class="op" id="7594454">!=</span>&nbsp;<span class="num" id="7594457">2</span>&nbsp;<span class="op" id="7594459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594463">stmt</span><span class="op" id="7594467">.</span><span class="ident" id="7594468">Close</span><span class="op" id="7594473">(</span><span class="op" id="7594474">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594478">return</span>&nbsp;<span class="ident" id="7594485">nil</span><span class="op" id="7594488">,</span>&nbsp;<span class="ident" id="7594490">errf</span><span class="op" id="7594494">(</span><span class="string" id="7594495">&#34;invalid&nbsp;CREATE&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="7594540">,</span>&nbsp;<span class="builtinfunc" id="7594542">len</span><span class="op" id="7594545">(</span><span class="ident" id="7594546">parts</span><span class="op" id="7594551">)</span><span class="op" id="7594552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594558">stmt</span><span class="op" id="7594562">.</span><span class="ident" id="7594563">table</span>&nbsp;<span class="op" id="7594569">=</span>&nbsp;<span class="ident" id="7594571">parts</span><span class="op" id="7594576">[</span><span class="num" id="7594577">0</span><span class="op" id="7594578">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594581">for</span>&nbsp;<span class="ident" id="7594585">n</span><span class="op" id="7594586">,</span>&nbsp;<span class="ident" id="7594588">colspec</span>&nbsp;<span class="op" id="7594596">:=</span>&nbsp;<span class="keyword" id="7594599">range</span>&nbsp;<span class="ident" id="7594605">strings</span><span class="op" id="7594612">.</span><span class="ident" id="7594613">Split</span><span class="op" id="7594618">(</span><span class="ident" id="7594619">parts</span><span class="op" id="7594624">[</span><span class="num" id="7594625">1</span><span class="op" id="7594626">]</span><span class="op" id="7594627">,</span>&nbsp;<span class="string" id="7594629">&#34;,&#34;</span><span class="op" id="7594632">)</span>&nbsp;<span class="op" id="7594634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594638">nameType</span>&nbsp;<span class="op" id="7594647">:=</span>&nbsp;<span class="ident" id="7594650">strings</span><span class="op" id="7594657">.</span><span class="ident" id="7594658">Split</span><span class="op" id="7594663">(</span><span class="ident" id="7594664">colspec</span><span class="op" id="7594671">,</span>&nbsp;<span class="string" id="7594673">&#34;=&#34;</span><span class="op" id="7594676">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594680">if</span>&nbsp;<span class="builtinfunc" id="7594683">len</span><span class="op" id="7594686">(</span><span class="ident" id="7594687">nameType</span><span class="op" id="7594695">)</span>&nbsp;<span class="op" id="7594697">!=</span>&nbsp;<span class="num" id="7594700">2</span>&nbsp;<span class="op" id="7594702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594707">stmt</span><span class="op" id="7594711">.</span><span class="ident" id="7594712">Close</span><span class="op" id="7594717">(</span><span class="op" id="7594718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594723">return</span>&nbsp;<span class="ident" id="7594730">nil</span><span class="op" id="7594733">,</span>&nbsp;<span class="ident" id="7594735">errf</span><span class="op" id="7594739">(</span><span class="string" id="7594740">&#34;CREATE&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7594798">,</span>&nbsp;<span class="ident" id="7594800">stmt</span><span class="op" id="7594804">.</span><span class="ident" id="7594805">table</span><span class="op" id="7594810">,</span>&nbsp;<span class="ident" id="7594812">colspec</span><span class="op" id="7594819">,</span>&nbsp;<span class="ident" id="7594821">n</span><span class="op" id="7594822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594830">stmt</span><span class="op" id="7594834">.</span><span class="ident" id="7594835">colName</span>&nbsp;<span class="op" id="7594843">=</span>&nbsp;<span class="builtinfunc" id="7594845">append</span><span class="op" id="7594851">(</span><span class="ident" id="7594852">stmt</span><span class="op" id="7594856">.</span><span class="ident" id="7594857">colName</span><span class="op" id="7594864">,</span>&nbsp;<span class="ident" id="7594866">nameType</span><span class="op" id="7594874">[</span><span class="num" id="7594875">0</span><span class="op" id="7594876">]</span><span class="op" id="7594877">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7594881">stmt</span><span class="op" id="7594885">.</span><span class="ident" id="7594886">colType</span>&nbsp;<span class="op" id="7594894">=</span>&nbsp;<span class="builtinfunc" id="7594896">append</span><span class="op" id="7594902">(</span><span class="ident" id="7594903">stmt</span><span class="op" id="7594907">.</span><span class="ident" id="7594908">colType</span><span class="op" id="7594915">,</span>&nbsp;<span class="ident" id="7594917">nameType</span><span class="op" id="7594925">[</span><span class="num" id="7594926">1</span><span class="op" id="7594927">]</span><span class="op" id="7594928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7594931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7594934">return</span>&nbsp;<span class="ident" id="7594941">stmt</span><span class="op" id="7594945">,</span>&nbsp;<span class="ident" id="7594947">nil</span><br>
<span class="lineno"></span><span class="op" id="7594951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="7594954">//&nbsp;parts&nbsp;are&nbsp;table|col=?,col2=val</span><br>
<span class="lineno"></span><span class="keyword" id="7594988">func</span>&nbsp;<span class="op" id="7594993">(</span><span class="ident" id="7594994">c</span>&nbsp;<span class="op" id="7594996">*</span><span class="ident" id="7594997">fakeConn</span><span class="op" id="7595005">)</span>&nbsp;<span class="ident" id="7595007">prepareInsert</span><span class="op" id="7595020">(</span><span class="ident" id="7595021">stmt</span>&nbsp;<span class="op" id="7595026">*</span><span class="ident" id="7595027">fakeStmt</span><span class="op" id="7595035">,</span>&nbsp;<span class="ident" id="7595037">parts</span>&nbsp;<span class="op" id="7595043">[</span><span class="op" id="7595044">]</span><span class="builtintype" id="7595045">string</span><span class="op" id="7595051">)</span>&nbsp;<span class="op" id="7595053">(</span><span class="ident" id="7595054">driver</span><span class="op" id="7595060">.</span><span class="ident" id="7595061">Stmt</span><span class="op" id="7595065">,</span>&nbsp;<span class="builtintype" id="7595067">error</span><span class="op" id="7595072">)</span>&nbsp;<span class="op" id="7595074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595077">if</span>&nbsp;<span class="builtinfunc" id="7595080">len</span><span class="op" id="7595083">(</span><span class="ident" id="7595084">parts</span><span class="op" id="7595089">)</span>&nbsp;<span class="op" id="7595091">!=</span>&nbsp;<span class="num" id="7595094">2</span>&nbsp;<span class="op" id="7595096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595100">stmt</span><span class="op" id="7595104">.</span><span class="ident" id="7595105">Close</span><span class="op" id="7595110">(</span><span class="op" id="7595111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595115">return</span>&nbsp;<span class="ident" id="7595122">nil</span><span class="op" id="7595125">,</span>&nbsp;<span class="ident" id="7595127">errf</span><span class="op" id="7595131">(</span><span class="string" id="7595132">&#34;invalid&nbsp;INSERT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="7595177">,</span>&nbsp;<span class="builtinfunc" id="7595179">len</span><span class="op" id="7595182">(</span><span class="ident" id="7595183">parts</span><span class="op" id="7595188">)</span><span class="op" id="7595189">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7595192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595195">stmt</span><span class="op" id="7595199">.</span><span class="ident" id="7595200">table</span>&nbsp;<span class="op" id="7595206">=</span>&nbsp;<span class="ident" id="7595208">parts</span><span class="op" id="7595213">[</span><span class="num" id="7595214">0</span><span class="op" id="7595215">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595218">for</span>&nbsp;<span class="ident" id="7595222">n</span><span class="op" id="7595223">,</span>&nbsp;<span class="ident" id="7595225">colspec</span>&nbsp;<span class="op" id="7595233">:=</span>&nbsp;<span class="keyword" id="7595236">range</span>&nbsp;<span class="ident" id="7595242">strings</span><span class="op" id="7595249">.</span><span class="ident" id="7595250">Split</span><span class="op" id="7595255">(</span><span class="ident" id="7595256">parts</span><span class="op" id="7595261">[</span><span class="num" id="7595262">1</span><span class="op" id="7595263">]</span><span class="op" id="7595264">,</span>&nbsp;<span class="string" id="7595266">&#34;,&#34;</span><span class="op" id="7595269">)</span>&nbsp;<span class="op" id="7595271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595275">nameVal</span>&nbsp;<span class="op" id="7595283">:=</span>&nbsp;<span class="ident" id="7595286">strings</span><span class="op" id="7595293">.</span><span class="ident" id="7595294">Split</span><span class="op" id="7595299">(</span><span class="ident" id="7595300">colspec</span><span class="op" id="7595307">,</span>&nbsp;<span class="string" id="7595309">&#34;=&#34;</span><span class="op" id="7595312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595316">if</span>&nbsp;<span class="builtinfunc" id="7595319">len</span><span class="op" id="7595322">(</span><span class="ident" id="7595323">nameVal</span><span class="op" id="7595330">)</span>&nbsp;<span class="op" id="7595332">!=</span>&nbsp;<span class="num" id="7595335">2</span>&nbsp;<span class="op" id="7595337">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595342">stmt</span><span class="op" id="7595346">.</span><span class="ident" id="7595347">Close</span><span class="op" id="7595352">(</span><span class="op" id="7595353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595358">return</span>&nbsp;<span class="ident" id="7595365">nil</span><span class="op" id="7595368">,</span>&nbsp;<span class="ident" id="7595370">errf</span><span class="op" id="7595374">(</span><span class="string" id="7595375">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7595433">,</span>&nbsp;<span class="ident" id="7595435">stmt</span><span class="op" id="7595439">.</span><span class="ident" id="7595440">table</span><span class="op" id="7595445">,</span>&nbsp;<span class="ident" id="7595447">colspec</span><span class="op" id="7595454">,</span>&nbsp;<span class="ident" id="7595456">n</span><span class="op" id="7595457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7595461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595465">column</span><span class="op" id="7595471">,</span>&nbsp;<span class="ident" id="7595473">value</span>&nbsp;<span class="op" id="7595479">:=</span>&nbsp;<span class="ident" id="7595482">nameVal</span><span class="op" id="7595489">[</span><span class="num" id="7595490">0</span><span class="op" id="7595491">]</span><span class="op" id="7595492">,</span>&nbsp;<span class="ident" id="7595494">nameVal</span><span class="op" id="7595501">[</span><span class="num" id="7595502">1</span><span class="op" id="7595503">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595507">ctype</span><span class="op" id="7595512">,</span>&nbsp;<span class="ident" id="7595514">ok</span>&nbsp;<span class="op" id="7595517">:=</span>&nbsp;<span class="ident" id="7595520">c</span><span class="op" id="7595521">.</span><span class="ident" id="7595522">db</span><span class="op" id="7595524">.</span><span class="ident" id="7595525">columnType</span><span class="op" id="7595535">(</span><span class="ident" id="7595536">stmt</span><span class="op" id="7595540">.</span><span class="ident" id="7595541">table</span><span class="op" id="7595546">,</span>&nbsp;<span class="ident" id="7595548">column</span><span class="op" id="7595554">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595558">if</span>&nbsp;<span class="op" id="7595561">!</span><span class="ident" id="7595562">ok</span>&nbsp;<span class="op" id="7595565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595570">stmt</span><span class="op" id="7595574">.</span><span class="ident" id="7595575">Close</span><span class="op" id="7595580">(</span><span class="op" id="7595581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595586">return</span>&nbsp;<span class="ident" id="7595593">nil</span><span class="op" id="7595596">,</span>&nbsp;<span class="ident" id="7595598">errf</span><span class="op" id="7595602">(</span><span class="string" id="7595603">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7595654">,</span>&nbsp;<span class="ident" id="7595656">stmt</span><span class="op" id="7595660">.</span><span class="ident" id="7595661">table</span><span class="op" id="7595666">,</span>&nbsp;<span class="ident" id="7595668">column</span><span class="op" id="7595674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7595678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595682">stmt</span><span class="op" id="7595686">.</span><span class="ident" id="7595687">colName</span>&nbsp;<span class="op" id="7595695">=</span>&nbsp;<span class="builtinfunc" id="7595697">append</span><span class="op" id="7595703">(</span><span class="ident" id="7595704">stmt</span><span class="op" id="7595708">.</span><span class="ident" id="7595709">colName</span><span class="op" id="7595716">,</span>&nbsp;<span class="ident" id="7595718">column</span><span class="op" id="7595724">)</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595729">if</span>&nbsp;<span class="ident" id="7595732">value</span>&nbsp;<span class="op" id="7595738">!=</span>&nbsp;<span class="string" id="7595741">&#34;?&#34;</span>&nbsp;<span class="op" id="7595745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595750">var</span>&nbsp;<span class="ident" id="7595754">subsetVal</span>&nbsp;<span class="keyword" id="7595764">interface</span><span class="op" id="7595773">{</span><span class="op" id="7595774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7595779">//&nbsp;Convert&nbsp;to&nbsp;driver&nbsp;subset&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595815">switch</span>&nbsp;<span class="ident" id="7595822">ctype</span>&nbsp;<span class="op" id="7595828">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595833">case</span>&nbsp;<span class="string" id="7595838">&#34;string&#34;</span><span class="op" id="7595846">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595852">subsetVal</span>&nbsp;<span class="op" id="7595862">=</span>&nbsp;<span class="op" id="7595864">[</span><span class="op" id="7595865">]</span><span class="builtintype" id="7595866">byte</span><span class="op" id="7595870">(</span><span class="ident" id="7595871">value</span><span class="op" id="7595876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595881">case</span>&nbsp;<span class="string" id="7595886">&#34;blob&#34;</span><span class="op" id="7595892">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595898">subsetVal</span>&nbsp;<span class="op" id="7595908">=</span>&nbsp;<span class="op" id="7595910">[</span><span class="op" id="7595911">]</span><span class="builtintype" id="7595912">byte</span><span class="op" id="7595916">(</span><span class="ident" id="7595917">value</span><span class="op" id="7595922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595927">case</span>&nbsp;<span class="string" id="7595932">&#34;int32&#34;</span><span class="op" id="7595939">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7595945">i</span><span class="op" id="7595946">,</span>&nbsp;<span class="ident" id="7595948">err</span>&nbsp;<span class="op" id="7595952">:=</span>&nbsp;<span class="ident" id="7595955">strconv</span><span class="op" id="7595962">.</span><span class="ident" id="7595963">Atoi</span><span class="op" id="7595967">(</span><span class="ident" id="7595968">value</span><span class="op" id="7595973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7595979">if</span>&nbsp;<span class="ident" id="7595982">err</span>&nbsp;<span class="op" id="7595986">!=</span>&nbsp;<span class="ident" id="7595989">nil</span>&nbsp;<span class="op" id="7595993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596000">stmt</span><span class="op" id="7596004">.</span><span class="ident" id="7596005">Close</span><span class="op" id="7596010">(</span><span class="op" id="7596011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596018">return</span>&nbsp;<span class="ident" id="7596025">nil</span><span class="op" id="7596028">,</span>&nbsp;<span class="ident" id="7596030">errf</span><span class="op" id="7596034">(</span><span class="string" id="7596035">&#34;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;%q&#34;</span><span class="op" id="7596072">,</span>&nbsp;<span class="ident" id="7596074">value</span><span class="op" id="7596079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7596085">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596091">subsetVal</span>&nbsp;<span class="op" id="7596101">=</span>&nbsp;<span class="ident" id="7596103">int64</span><span class="op" id="7596108">(</span><span class="ident" id="7596109">i</span><span class="op" id="7596110">)</span>&nbsp;<span class="comment" id="7596112">//&nbsp;int64&nbsp;is&nbsp;a&nbsp;subset&nbsp;type,&nbsp;but&nbsp;not&nbsp;int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596156">default</span><span class="op" id="7596163">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596169">stmt</span><span class="op" id="7596173">.</span><span class="ident" id="7596174">Close</span><span class="op" id="7596179">(</span><span class="op" id="7596180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596186">return</span>&nbsp;<span class="ident" id="7596193">nil</span><span class="op" id="7596196">,</span>&nbsp;<span class="ident" id="7596198">errf</span><span class="op" id="7596202">(</span><span class="string" id="7596203">&#34;unsupported&nbsp;conversion&nbsp;for&nbsp;pre-bound&nbsp;parameter&nbsp;%q&nbsp;to&nbsp;type&nbsp;%q&#34;</span><span class="op" id="7596265">,</span>&nbsp;<span class="ident" id="7596267">value</span><span class="op" id="7596272">,</span>&nbsp;<span class="ident" id="7596274">ctype</span><span class="op" id="7596279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7596284">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596289">stmt</span><span class="op" id="7596293">.</span><span class="ident" id="7596294">colValue</span>&nbsp;<span class="op" id="7596303">=</span>&nbsp;<span class="builtinfunc" id="7596305">append</span><span class="op" id="7596311">(</span><span class="ident" id="7596312">stmt</span><span class="op" id="7596316">.</span><span class="ident" id="7596317">colValue</span><span class="op" id="7596325">,</span>&nbsp;<span class="ident" id="7596327">subsetVal</span><span class="op" id="7596336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7596340">}</span>&nbsp;<span class="keyword" id="7596342">else</span>&nbsp;<span class="op" id="7596347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596352">stmt</span><span class="op" id="7596356">.</span><span class="ident" id="7596357">placeholders</span><span class="op" id="7596369">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596375">stmt</span><span class="op" id="7596379">.</span><span class="ident" id="7596380">placeholderConverter</span>&nbsp;<span class="op" id="7596401">=</span>&nbsp;<span class="builtinfunc" id="7596403">append</span><span class="op" id="7596409">(</span><span class="ident" id="7596410">stmt</span><span class="op" id="7596414">.</span><span class="ident" id="7596415">placeholderConverter</span><span class="op" id="7596435">,</span>&nbsp;<span class="ident" id="7596437">converterForType</span><span class="op" id="7596453">(</span><span class="ident" id="7596454">ctype</span><span class="op" id="7596459">)</span><span class="op" id="7596460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596465">stmt</span><span class="op" id="7596469">.</span><span class="ident" id="7596470">colValue</span>&nbsp;<span class="op" id="7596479">=</span>&nbsp;<span class="builtinfunc" id="7596481">append</span><span class="op" id="7596487">(</span><span class="ident" id="7596488">stmt</span><span class="op" id="7596492">.</span><span class="ident" id="7596493">colValue</span><span class="op" id="7596501">,</span>&nbsp;<span class="string" id="7596503">&#34;?&#34;</span><span class="op" id="7596506">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7596510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7596513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596516">return</span>&nbsp;<span class="ident" id="7596523">stmt</span><span class="op" id="7596527">,</span>&nbsp;<span class="ident" id="7596529">nil</span><br>
<span class="lineno"></span><span class="op" id="7596533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="7596536">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="7596575">var</span>&nbsp;<span class="ident" id="7596579">hookPrepareBadConn</span>&nbsp;<span class="keyword" id="7596598">func</span><span class="op" id="7596602">(</span><span class="op" id="7596603">)</span>&nbsp;<span class="builtintype" id="7596605">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7596611">func</span>&nbsp;<span class="op" id="7596616">(</span><span class="ident" id="7596617">c</span>&nbsp;<span class="op" id="7596619">*</span><span class="ident" id="7596620">fakeConn</span><span class="op" id="7596628">)</span>&nbsp;<span class="ident" id="7596630">Prepare</span><span class="op" id="7596637">(</span><span class="ident" id="7596638">query</span>&nbsp;<span class="builtintype" id="7596644">string</span><span class="op" id="7596650">)</span>&nbsp;<span class="op" id="7596652">(</span><span class="ident" id="7596653">driver</span><span class="op" id="7596659">.</span><span class="ident" id="7596660">Stmt</span><span class="op" id="7596664">,</span>&nbsp;<span class="builtintype" id="7596666">error</span><span class="op" id="7596671">)</span>&nbsp;<span class="op" id="7596673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596676">c</span><span class="op" id="7596677">.</span><span class="ident" id="7596678">numPrepare</span><span class="op" id="7596688">++</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596692">if</span>&nbsp;<span class="ident" id="7596695">c</span><span class="op" id="7596696">.</span><span class="ident" id="7596697">db</span>&nbsp;<span class="op" id="7596700">==</span>&nbsp;<span class="ident" id="7596703">nil</span>&nbsp;<span class="op" id="7596707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7596711">panic</span><span class="op" id="7596716">(</span><span class="string" id="7596717">&#34;nil&nbsp;c.db;&nbsp;conn&nbsp;=&nbsp;&#34;</span>&nbsp;<span class="op" id="7596737">+</span>&nbsp;<span class="ident" id="7596739">fmt</span><span class="op" id="7596742">.</span><span class="ident" id="7596743">Sprintf</span><span class="op" id="7596750">(</span><span class="string" id="7596751">&#34;%#v&#34;</span><span class="op" id="7596756">,</span>&nbsp;<span class="ident" id="7596758">c</span><span class="op" id="7596759">)</span><span class="op" id="7596760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7596763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596767">if</span>&nbsp;<span class="ident" id="7596770">hookPrepareBadConn</span>&nbsp;<span class="op" id="7596789">!=</span>&nbsp;<span class="ident" id="7596792">nil</span>&nbsp;<span class="op" id="7596796">&amp;&amp;</span>&nbsp;<span class="ident" id="7596799">hookPrepareBadConn</span><span class="op" id="7596817">(</span><span class="op" id="7596818">)</span>&nbsp;<span class="op" id="7596820">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596824">return</span>&nbsp;<span class="ident" id="7596831">nil</span><span class="op" id="7596834">,</span>&nbsp;<span class="ident" id="7596836">driver</span><span class="op" id="7596842">.</span><span class="ident" id="7596843">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7596855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596859">parts</span>&nbsp;<span class="op" id="7596865">:=</span>&nbsp;<span class="ident" id="7596868">strings</span><span class="op" id="7596875">.</span><span class="ident" id="7596876">Split</span><span class="op" id="7596881">(</span><span class="ident" id="7596882">query</span><span class="op" id="7596887">,</span>&nbsp;<span class="string" id="7596889">&#34;|&#34;</span><span class="op" id="7596892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596895">if</span>&nbsp;<span class="builtinfunc" id="7596898">len</span><span class="op" id="7596901">(</span><span class="ident" id="7596902">parts</span><span class="op" id="7596907">)</span>&nbsp;<span class="op" id="7596909">&lt;</span>&nbsp;<span class="num" id="7596911">1</span>&nbsp;<span class="op" id="7596913">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7596917">return</span>&nbsp;<span class="ident" id="7596924">nil</span><span class="op" id="7596927">,</span>&nbsp;<span class="ident" id="7596929">errf</span><span class="op" id="7596933">(</span><span class="string" id="7596934">&#34;empty&nbsp;query&#34;</span><span class="op" id="7596947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7596950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596953">cmd</span>&nbsp;<span class="op" id="7596957">:=</span>&nbsp;<span class="ident" id="7596960">parts</span><span class="op" id="7596965">[</span><span class="num" id="7596966">0</span><span class="op" id="7596967">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596970">parts</span>&nbsp;<span class="op" id="7596976">=</span>&nbsp;<span class="ident" id="7596978">parts</span><span class="op" id="7596983">[</span><span class="num" id="7596984">1</span><span class="op" id="7596985">:</span><span class="op" id="7596986">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7596989">stmt</span>&nbsp;<span class="op" id="7596994">:=</span>&nbsp;<span class="op" id="7596997">&amp;</span><span class="ident" id="7596998">fakeStmt</span><span class="op" id="7597006">{</span><span class="ident" id="7597007">q</span><span class="op" id="7597008">:</span>&nbsp;<span class="ident" id="7597010">query</span><span class="op" id="7597015">,</span>&nbsp;<span class="ident" id="7597017">c</span><span class="op" id="7597018">:</span>&nbsp;<span class="ident" id="7597020">c</span><span class="op" id="7597021">,</span>&nbsp;<span class="ident" id="7597023">cmd</span><span class="op" id="7597026">:</span>&nbsp;<span class="ident" id="7597028">cmd</span><span class="op" id="7597031">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597034">c</span><span class="op" id="7597035">.</span><span class="ident" id="7597036">incrStat</span><span class="op" id="7597044">(</span><span class="op" id="7597045">&amp;</span><span class="ident" id="7597046">c</span><span class="op" id="7597047">.</span><span class="ident" id="7597048">stmtsMade</span><span class="op" id="7597057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597060">switch</span>&nbsp;<span class="ident" id="7597067">cmd</span>&nbsp;<span class="op" id="7597071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597074">case</span>&nbsp;<span class="string" id="7597079">&#34;WIPE&#34;</span><span class="op" id="7597085">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7597089">//&nbsp;Nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597101">case</span>&nbsp;<span class="string" id="7597106">&#34;SELECT&#34;</span><span class="op" id="7597114">:</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597118">return</span>&nbsp;<span class="ident" id="7597125">c</span><span class="op" id="7597126">.</span><span class="ident" id="7597127">prepareSelect</span><span class="op" id="7597140">(</span><span class="ident" id="7597141">stmt</span><span class="op" id="7597145">,</span>&nbsp;<span class="ident" id="7597147">parts</span><span class="op" id="7597152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597155">case</span>&nbsp;<span class="string" id="7597160">&#34;CREATE&#34;</span><span class="op" id="7597168">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597172">return</span>&nbsp;<span class="ident" id="7597179">c</span><span class="op" id="7597180">.</span><span class="ident" id="7597181">prepareCreate</span><span class="op" id="7597194">(</span><span class="ident" id="7597195">stmt</span><span class="op" id="7597199">,</span>&nbsp;<span class="ident" id="7597201">parts</span><span class="op" id="7597206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597209">case</span>&nbsp;<span class="string" id="7597214">&#34;INSERT&#34;</span><span class="op" id="7597222">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597226">return</span>&nbsp;<span class="ident" id="7597233">c</span><span class="op" id="7597234">.</span><span class="ident" id="7597235">prepareInsert</span><span class="op" id="7597248">(</span><span class="ident" id="7597249">stmt</span><span class="op" id="7597253">,</span>&nbsp;<span class="ident" id="7597255">parts</span><span class="op" id="7597260">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597263">case</span>&nbsp;<span class="string" id="7597268">&#34;NOSERT&#34;</span><span class="op" id="7597276">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7597280">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7597360">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597404">return</span>&nbsp;<span class="ident" id="7597411">c</span><span class="op" id="7597412">.</span><span class="ident" id="7597413">prepareInsert</span><span class="op" id="7597426">(</span><span class="ident" id="7597427">stmt</span><span class="op" id="7597431">,</span>&nbsp;<span class="ident" id="7597433">parts</span><span class="op" id="7597438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597441">default</span><span class="op" id="7597448">:</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597452">stmt</span><span class="op" id="7597456">.</span><span class="ident" id="7597457">Close</span><span class="op" id="7597462">(</span><span class="op" id="7597463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597467">return</span>&nbsp;<span class="ident" id="7597474">nil</span><span class="op" id="7597477">,</span>&nbsp;<span class="ident" id="7597479">errf</span><span class="op" id="7597483">(</span><span class="string" id="7597484">&#34;unsupported&nbsp;command&nbsp;type&nbsp;%q&#34;</span><span class="op" id="7597513">,</span>&nbsp;<span class="ident" id="7597515">cmd</span><span class="op" id="7597518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7597521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597524">return</span>&nbsp;<span class="ident" id="7597531">stmt</span><span class="op" id="7597535">,</span>&nbsp;<span class="ident" id="7597537">nil</span><br>
<span class="lineno"></span><span class="op" id="7597541">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="7597544">func</span>&nbsp;<span class="op" id="7597549">(</span><span class="ident" id="7597550">s</span>&nbsp;<span class="op" id="7597552">*</span><span class="ident" id="7597553">fakeStmt</span><span class="op" id="7597561">)</span>&nbsp;<span class="ident" id="7597563">ColumnConverter</span><span class="op" id="7597578">(</span><span class="ident" id="7597579">idx</span>&nbsp;<span class="builtintype" id="7597583">int</span><span class="op" id="7597586">)</span>&nbsp;<span class="ident" id="7597588">driver</span><span class="op" id="7597594">.</span><span class="ident" id="7597595">ValueConverter</span>&nbsp;<span class="op" id="7597610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597613">if</span>&nbsp;<span class="builtinfunc" id="7597616">len</span><span class="op" id="7597619">(</span><span class="ident" id="7597620">s</span><span class="op" id="7597621">.</span><span class="ident" id="7597622">placeholderConverter</span><span class="op" id="7597642">)</span>&nbsp;<span class="op" id="7597644">==</span>&nbsp;<span class="num" id="7597647">0</span>&nbsp;<span class="op" id="7597649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597653">return</span>&nbsp;<span class="ident" id="7597660">driver</span><span class="op" id="7597666">.</span><span class="ident" id="7597667">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7597694">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597697">return</span>&nbsp;<span class="ident" id="7597704">s</span><span class="op" id="7597705">.</span><span class="ident" id="7597706">placeholderConverter</span><span class="op" id="7597726">[</span><span class="ident" id="7597727">idx</span><span class="op" id="7597730">]</span><br>
<span class="lineno"></span><span class="op" id="7597732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7597735">func</span>&nbsp;<span class="op" id="7597740">(</span><span class="ident" id="7597741">s</span>&nbsp;<span class="op" id="7597743">*</span><span class="ident" id="7597744">fakeStmt</span><span class="op" id="7597752">)</span>&nbsp;<span class="ident" id="7597754">Close</span><span class="op" id="7597759">(</span><span class="op" id="7597760">)</span>&nbsp;<span class="builtintype" id="7597762">error</span>&nbsp;<span class="op" id="7597768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597771">if</span>&nbsp;<span class="ident" id="7597774">s</span><span class="op" id="7597775">.</span><span class="ident" id="7597776">c</span>&nbsp;<span class="op" id="7597778">==</span>&nbsp;<span class="ident" id="7597781">nil</span>&nbsp;<span class="op" id="7597785">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7597789">panic</span><span class="op" id="7597794">(</span><span class="string" id="7597795">&#34;nil&nbsp;conn&nbsp;in&nbsp;fakeStmt.Close&#34;</span><span class="op" id="7597823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7597826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597829">if</span>&nbsp;<span class="ident" id="7597832">s</span><span class="op" id="7597833">.</span><span class="ident" id="7597834">c</span><span class="op" id="7597835">.</span><span class="ident" id="7597836">db</span>&nbsp;<span class="op" id="7597839">==</span>&nbsp;<span class="ident" id="7597842">nil</span>&nbsp;<span class="op" id="7597846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7597850">panic</span><span class="op" id="7597855">(</span><span class="string" id="7597856">&#34;in&nbsp;fakeStmt.Close,&nbsp;conn&#39;s&nbsp;db&nbsp;is&nbsp;nil&nbsp;(already&nbsp;closed)&#34;</span><span class="op" id="7597910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7597913">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597916">if</span>&nbsp;<span class="op" id="7597919">!</span><span class="ident" id="7597920">s</span><span class="op" id="7597921">.</span><span class="ident" id="7597922">closed</span>&nbsp;<span class="op" id="7597929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597933">s</span><span class="op" id="7597934">.</span><span class="ident" id="7597935">c</span><span class="op" id="7597936">.</span><span class="ident" id="7597937">incrStat</span><span class="op" id="7597945">(</span><span class="op" id="7597946">&amp;</span><span class="ident" id="7597947">s</span><span class="op" id="7597948">.</span><span class="ident" id="7597949">c</span><span class="op" id="7597950">.</span><span class="ident" id="7597951">stmtsClosed</span><span class="op" id="7597962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7597966">s</span><span class="op" id="7597967">.</span><span class="ident" id="7597968">closed</span>&nbsp;<span class="op" id="7597975">=</span>&nbsp;<span class="builtintype" id="7597977">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7597983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7597986">return</span>&nbsp;<span class="ident" id="7597993">nil</span><br>
<span class="lineno">520</span><span class="op" id="7597997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7598000">var</span>&nbsp;<span class="ident" id="7598004">errClosed</span>&nbsp;<span class="op" id="7598014">=</span>&nbsp;<span class="ident" id="7598016">errors</span><span class="op" id="7598022">.</span><span class="ident" id="7598023">New</span><span class="op" id="7598026">(</span><span class="string" id="7598027">&#34;fakedb:&nbsp;statement&nbsp;has&nbsp;been&nbsp;closed&#34;</span><span class="op" id="7598062">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7598065">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno">525</span><span class="keyword" id="7598104">var</span>&nbsp;<span class="ident" id="7598108">hookExecBadConn</span>&nbsp;<span class="keyword" id="7598124">func</span><span class="op" id="7598128">(</span><span class="op" id="7598129">)</span>&nbsp;<span class="builtintype" id="7598131">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7598137">func</span>&nbsp;<span class="op" id="7598142">(</span><span class="ident" id="7598143">s</span>&nbsp;<span class="op" id="7598145">*</span><span class="ident" id="7598146">fakeStmt</span><span class="op" id="7598154">)</span>&nbsp;<span class="ident" id="7598156">Exec</span><span class="op" id="7598160">(</span><span class="ident" id="7598161">args</span>&nbsp;<span class="op" id="7598166">[</span><span class="op" id="7598167">]</span><span class="ident" id="7598168">driver</span><span class="op" id="7598174">.</span><span class="ident" id="7598175">Value</span><span class="op" id="7598180">)</span>&nbsp;<span class="op" id="7598182">(</span><span class="ident" id="7598183">driver</span><span class="op" id="7598189">.</span><span class="ident" id="7598190">Result</span><span class="op" id="7598196">,</span>&nbsp;<span class="builtintype" id="7598198">error</span><span class="op" id="7598203">)</span>&nbsp;<span class="op" id="7598205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598208">if</span>&nbsp;<span class="ident" id="7598211">s</span><span class="op" id="7598212">.</span><span class="ident" id="7598213">closed</span>&nbsp;<span class="op" id="7598220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598224">return</span>&nbsp;<span class="ident" id="7598231">nil</span><span class="op" id="7598234">,</span>&nbsp;<span class="ident" id="7598236">errClosed</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7598247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598251">if</span>&nbsp;<span class="ident" id="7598254">hookExecBadConn</span>&nbsp;<span class="op" id="7598270">!=</span>&nbsp;<span class="ident" id="7598273">nil</span>&nbsp;<span class="op" id="7598277">&amp;&amp;</span>&nbsp;<span class="ident" id="7598280">hookExecBadConn</span><span class="op" id="7598295">(</span><span class="op" id="7598296">)</span>&nbsp;<span class="op" id="7598298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598302">return</span>&nbsp;<span class="ident" id="7598309">nil</span><span class="op" id="7598312">,</span>&nbsp;<span class="ident" id="7598314">driver</span><span class="op" id="7598320">.</span><span class="ident" id="7598321">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7598333">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598337">err</span>&nbsp;<span class="op" id="7598341">:=</span>&nbsp;<span class="ident" id="7598344">checkSubsetTypes</span><span class="op" id="7598360">(</span><span class="ident" id="7598361">args</span><span class="op" id="7598365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598368">if</span>&nbsp;<span class="ident" id="7598371">err</span>&nbsp;<span class="op" id="7598375">!=</span>&nbsp;<span class="ident" id="7598378">nil</span>&nbsp;<span class="op" id="7598382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598386">return</span>&nbsp;<span class="ident" id="7598393">nil</span><span class="op" id="7598396">,</span>&nbsp;<span class="ident" id="7598398">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7598403">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598407">db</span>&nbsp;<span class="op" id="7598410">:=</span>&nbsp;<span class="ident" id="7598413">s</span><span class="op" id="7598414">.</span><span class="ident" id="7598415">c</span><span class="op" id="7598416">.</span><span class="ident" id="7598417">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598421">switch</span>&nbsp;<span class="ident" id="7598428">s</span><span class="op" id="7598429">.</span><span class="ident" id="7598430">cmd</span>&nbsp;<span class="op" id="7598434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598437">case</span>&nbsp;<span class="string" id="7598442">&#34;WIPE&#34;</span><span class="op" id="7598448">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598452">db</span><span class="op" id="7598454">.</span><span class="ident" id="7598455">wipe</span><span class="op" id="7598459">(</span><span class="op" id="7598460">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598464">return</span>&nbsp;<span class="ident" id="7598471">driver</span><span class="op" id="7598477">.</span><span class="ident" id="7598478">ResultNoRows</span><span class="op" id="7598490">,</span>&nbsp;<span class="ident" id="7598492">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598497">case</span>&nbsp;<span class="string" id="7598502">&#34;CREATE&#34;</span><span class="op" id="7598510">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598514">if</span>&nbsp;<span class="ident" id="7598517">err</span>&nbsp;<span class="op" id="7598521">:=</span>&nbsp;<span class="ident" id="7598524">db</span><span class="op" id="7598526">.</span><span class="ident" id="7598527">createTable</span><span class="op" id="7598538">(</span><span class="ident" id="7598539">s</span><span class="op" id="7598540">.</span><span class="ident" id="7598541">table</span><span class="op" id="7598546">,</span>&nbsp;<span class="ident" id="7598548">s</span><span class="op" id="7598549">.</span><span class="ident" id="7598550">colName</span><span class="op" id="7598557">,</span>&nbsp;<span class="ident" id="7598559">s</span><span class="op" id="7598560">.</span><span class="ident" id="7598561">colType</span><span class="op" id="7598568">)</span><span class="op" id="7598569">;</span>&nbsp;<span class="ident" id="7598571">err</span>&nbsp;<span class="op" id="7598575">!=</span>&nbsp;<span class="ident" id="7598578">nil</span>&nbsp;<span class="op" id="7598582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598587">return</span>&nbsp;<span class="ident" id="7598594">nil</span><span class="op" id="7598597">,</span>&nbsp;<span class="ident" id="7598599">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7598605">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598609">return</span>&nbsp;<span class="ident" id="7598616">driver</span><span class="op" id="7598622">.</span><span class="ident" id="7598623">ResultNoRows</span><span class="op" id="7598635">,</span>&nbsp;<span class="ident" id="7598637">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598642">case</span>&nbsp;<span class="string" id="7598647">&#34;INSERT&#34;</span><span class="op" id="7598655">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598659">return</span>&nbsp;<span class="ident" id="7598666">s</span><span class="op" id="7598667">.</span><span class="ident" id="7598668">execInsert</span><span class="op" id="7598678">(</span><span class="ident" id="7598679">args</span><span class="op" id="7598683">,</span>&nbsp;<span class="builtintype" id="7598685">true</span><span class="op" id="7598689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598692">case</span>&nbsp;<span class="string" id="7598697">&#34;NOSERT&#34;</span><span class="op" id="7598705">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7598709">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7598789">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598833">return</span>&nbsp;<span class="ident" id="7598840">s</span><span class="op" id="7598841">.</span><span class="ident" id="7598842">execInsert</span><span class="op" id="7598852">(</span><span class="ident" id="7598853">args</span><span class="op" id="7598857">,</span>&nbsp;<span class="builtintype" id="7598859">false</span><span class="op" id="7598864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7598867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7598870">fmt</span><span class="op" id="7598873">.</span><span class="ident" id="7598874">Printf</span><span class="op" id="7598880">(</span><span class="string" id="7598881">&#34;EXEC&nbsp;statement,&nbsp;cmd=%q:&nbsp;%#v\n&#34;</span><span class="op" id="7598912">,</span>&nbsp;<span class="ident" id="7598914">s</span><span class="op" id="7598915">.</span><span class="ident" id="7598916">cmd</span><span class="op" id="7598919">,</span>&nbsp;<span class="ident" id="7598921">s</span><span class="op" id="7598922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7598925">return</span>&nbsp;<span class="ident" id="7598932">nil</span><span class="op" id="7598935">,</span>&nbsp;<span class="ident" id="7598937">fmt</span><span class="op" id="7598940">.</span><span class="ident" id="7598941">Errorf</span><span class="op" id="7598947">(</span><span class="string" id="7598948">&#34;unimplemented&nbsp;statement&nbsp;Exec&nbsp;command&nbsp;type&nbsp;of&nbsp;%q&#34;</span><span class="op" id="7598997">,</span>&nbsp;<span class="ident" id="7598999">s</span><span class="op" id="7599000">.</span><span class="ident" id="7599001">cmd</span><span class="op" id="7599004">)</span><br>
<span class="lineno">560</span><span class="op" id="7599006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7599009">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;true,&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span><span class="comment" id="7599061">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;false&nbsp;do&nbsp;prep-work&nbsp;and&nbsp;error&nbsp;checking,&nbsp;but&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="7599130">//&nbsp;actually&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno">565</span><span class="keyword" id="7599168">func</span>&nbsp;<span class="op" id="7599173">(</span><span class="ident" id="7599174">s</span>&nbsp;<span class="op" id="7599176">*</span><span class="ident" id="7599177">fakeStmt</span><span class="op" id="7599185">)</span>&nbsp;<span class="ident" id="7599187">execInsert</span><span class="op" id="7599197">(</span><span class="ident" id="7599198">args</span>&nbsp;<span class="op" id="7599203">[</span><span class="op" id="7599204">]</span><span class="ident" id="7599205">driver</span><span class="op" id="7599211">.</span><span class="ident" id="7599212">Value</span><span class="op" id="7599217">,</span>&nbsp;<span class="ident" id="7599219">doInsert</span>&nbsp;<span class="builtintype" id="7599228">bool</span><span class="op" id="7599232">)</span>&nbsp;<span class="op" id="7599234">(</span><span class="ident" id="7599235">driver</span><span class="op" id="7599241">.</span><span class="ident" id="7599242">Result</span><span class="op" id="7599248">,</span>&nbsp;<span class="builtintype" id="7599250">error</span><span class="op" id="7599255">)</span>&nbsp;<span class="op" id="7599257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599260">db</span>&nbsp;<span class="op" id="7599263">:=</span>&nbsp;<span class="ident" id="7599266">s</span><span class="op" id="7599267">.</span><span class="ident" id="7599268">c</span><span class="op" id="7599269">.</span><span class="ident" id="7599270">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599274">if</span>&nbsp;<span class="builtinfunc" id="7599277">len</span><span class="op" id="7599280">(</span><span class="ident" id="7599281">args</span><span class="op" id="7599285">)</span>&nbsp;<span class="op" id="7599287">!=</span>&nbsp;<span class="ident" id="7599290">s</span><span class="op" id="7599291">.</span><span class="ident" id="7599292">placeholders</span>&nbsp;<span class="op" id="7599305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7599309">panic</span><span class="op" id="7599314">(</span><span class="string" id="7599315">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="7599373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7599376">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599379">db</span><span class="op" id="7599381">.</span><span class="ident" id="7599382">mu</span><span class="op" id="7599384">.</span><span class="ident" id="7599385">Lock</span><span class="op" id="7599389">(</span><span class="op" id="7599390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599393">t</span><span class="op" id="7599394">,</span>&nbsp;<span class="ident" id="7599396">ok</span>&nbsp;<span class="op" id="7599399">:=</span>&nbsp;<span class="ident" id="7599402">db</span><span class="op" id="7599404">.</span><span class="ident" id="7599405">table</span><span class="op" id="7599410">(</span><span class="ident" id="7599411">s</span><span class="op" id="7599412">.</span><span class="ident" id="7599413">table</span><span class="op" id="7599418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599421">db</span><span class="op" id="7599423">.</span><span class="ident" id="7599424">mu</span><span class="op" id="7599426">.</span><span class="ident" id="7599427">Unlock</span><span class="op" id="7599433">(</span><span class="op" id="7599434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599437">if</span>&nbsp;<span class="op" id="7599440">!</span><span class="ident" id="7599441">ok</span>&nbsp;<span class="op" id="7599444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599448">return</span>&nbsp;<span class="ident" id="7599455">nil</span><span class="op" id="7599458">,</span>&nbsp;<span class="ident" id="7599460">fmt</span><span class="op" id="7599463">.</span><span class="ident" id="7599464">Errorf</span><span class="op" id="7599470">(</span><span class="string" id="7599471">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="7599503">,</span>&nbsp;<span class="ident" id="7599505">s</span><span class="op" id="7599506">.</span><span class="ident" id="7599507">table</span><span class="op" id="7599512">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7599515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599519">t</span><span class="op" id="7599520">.</span><span class="ident" id="7599521">mu</span><span class="op" id="7599523">.</span><span class="ident" id="7599524">Lock</span><span class="op" id="7599528">(</span><span class="op" id="7599529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599532">defer</span>&nbsp;<span class="ident" id="7599538">t</span><span class="op" id="7599539">.</span><span class="ident" id="7599540">mu</span><span class="op" id="7599542">.</span><span class="ident" id="7599543">Unlock</span><span class="op" id="7599549">(</span><span class="op" id="7599550">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599554">var</span>&nbsp;<span class="ident" id="7599558">cols</span>&nbsp;<span class="op" id="7599563">[</span><span class="op" id="7599564">]</span><span class="keyword" id="7599565">interface</span><span class="op" id="7599574">{</span><span class="op" id="7599575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599578">if</span>&nbsp;<span class="ident" id="7599581">doInsert</span>&nbsp;<span class="op" id="7599590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599594">cols</span>&nbsp;<span class="op" id="7599599">=</span>&nbsp;<span class="builtinfunc" id="7599601">make</span><span class="op" id="7599605">(</span><span class="op" id="7599606">[</span><span class="op" id="7599607">]</span><span class="keyword" id="7599608">interface</span><span class="op" id="7599617">{</span><span class="op" id="7599618">}</span><span class="op" id="7599619">,</span>&nbsp;<span class="builtinfunc" id="7599621">len</span><span class="op" id="7599624">(</span><span class="ident" id="7599625">t</span><span class="op" id="7599626">.</span><span class="ident" id="7599627">colname</span><span class="op" id="7599634">)</span><span class="op" id="7599635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7599638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599641">argPos</span>&nbsp;<span class="op" id="7599648">:=</span>&nbsp;<span class="num" id="7599651">0</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599654">for</span>&nbsp;<span class="ident" id="7599658">n</span><span class="op" id="7599659">,</span>&nbsp;<span class="ident" id="7599661">colname</span>&nbsp;<span class="op" id="7599669">:=</span>&nbsp;<span class="keyword" id="7599672">range</span>&nbsp;<span class="ident" id="7599678">s</span><span class="op" id="7599679">.</span><span class="ident" id="7599680">colName</span>&nbsp;<span class="op" id="7599688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599692">colidx</span>&nbsp;<span class="op" id="7599699">:=</span>&nbsp;<span class="ident" id="7599702">t</span><span class="op" id="7599703">.</span><span class="ident" id="7599704">columnIndex</span><span class="op" id="7599715">(</span><span class="ident" id="7599716">colname</span><span class="op" id="7599723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599727">if</span>&nbsp;<span class="ident" id="7599730">colidx</span>&nbsp;<span class="op" id="7599737">==</span>&nbsp;<span class="op" id="7599740">-</span><span class="num" id="7599741">1</span>&nbsp;<span class="op" id="7599743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599748">return</span>&nbsp;<span class="ident" id="7599755">nil</span><span class="op" id="7599758">,</span>&nbsp;<span class="ident" id="7599760">fmt</span><span class="op" id="7599763">.</span><span class="ident" id="7599764">Errorf</span><span class="op" id="7599770">(</span><span class="string" id="7599771">&#34;fakedb:&nbsp;column&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&nbsp;or&nbsp;dropped&nbsp;since&nbsp;prepared&nbsp;statement&nbsp;was&nbsp;created&#34;</span><span class="op" id="7599852">,</span>&nbsp;<span class="ident" id="7599854">colname</span><span class="op" id="7599861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7599865">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599869">var</span>&nbsp;<span class="ident" id="7599873">val</span>&nbsp;<span class="keyword" id="7599877">interface</span><span class="op" id="7599886">{</span><span class="op" id="7599887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7599891">if</span>&nbsp;<span class="ident" id="7599894">strvalue</span><span class="op" id="7599902">,</span>&nbsp;<span class="ident" id="7599904">ok</span>&nbsp;<span class="op" id="7599907">:=</span>&nbsp;<span class="ident" id="7599910">s</span><span class="op" id="7599911">.</span><span class="ident" id="7599912">colValue</span><span class="op" id="7599920">[</span><span class="ident" id="7599921">n</span><span class="op" id="7599922">]</span><span class="op" id="7599923">.</span><span class="op" id="7599924">(</span><span class="builtintype" id="7599925">string</span><span class="op" id="7599931">)</span><span class="op" id="7599932">;</span>&nbsp;<span class="ident" id="7599934">ok</span>&nbsp;<span class="op" id="7599937">&amp;&amp;</span>&nbsp;<span class="ident" id="7599940">strvalue</span>&nbsp;<span class="op" id="7599949">==</span>&nbsp;<span class="string" id="7599952">&#34;?&#34;</span>&nbsp;<span class="op" id="7599956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599961">val</span>&nbsp;<span class="op" id="7599965">=</span>&nbsp;<span class="ident" id="7599967">args</span><span class="op" id="7599971">[</span><span class="ident" id="7599972">argPos</span><span class="op" id="7599978">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7599983">argPos</span><span class="op" id="7599989">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7599994">}</span>&nbsp;<span class="keyword" id="7599996">else</span>&nbsp;<span class="op" id="7600001">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600006">val</span>&nbsp;<span class="op" id="7600010">=</span>&nbsp;<span class="ident" id="7600012">s</span><span class="op" id="7600013">.</span><span class="ident" id="7600014">colValue</span><span class="op" id="7600022">[</span><span class="ident" id="7600023">n</span><span class="op" id="7600024">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600032">if</span>&nbsp;<span class="ident" id="7600035">doInsert</span>&nbsp;<span class="op" id="7600044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600049">cols</span><span class="op" id="7600053">[</span><span class="ident" id="7600054">colidx</span><span class="op" id="7600060">]</span>&nbsp;<span class="op" id="7600062">=</span>&nbsp;<span class="ident" id="7600064">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600070">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600077">if</span>&nbsp;<span class="ident" id="7600080">doInsert</span>&nbsp;<span class="op" id="7600089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600093">t</span><span class="op" id="7600094">.</span><span class="ident" id="7600095">rows</span>&nbsp;<span class="op" id="7600100">=</span>&nbsp;<span class="builtinfunc" id="7600102">append</span><span class="op" id="7600108">(</span><span class="ident" id="7600109">t</span><span class="op" id="7600110">.</span><span class="ident" id="7600111">rows</span><span class="op" id="7600115">,</span>&nbsp;<span class="op" id="7600117">&amp;</span><span class="ident" id="7600118">row</span><span class="op" id="7600121">{</span><span class="ident" id="7600122">cols</span><span class="op" id="7600126">:</span>&nbsp;<span class="ident" id="7600128">cols</span><span class="op" id="7600132">}</span><span class="op" id="7600133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600136">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600139">return</span>&nbsp;<span class="ident" id="7600146">driver</span><span class="op" id="7600152">.</span><span class="ident" id="7600153">RowsAffected</span><span class="op" id="7600165">(</span><span class="num" id="7600166">1</span><span class="op" id="7600167">)</span><span class="op" id="7600168">,</span>&nbsp;<span class="ident" id="7600170">nil</span><br>
<span class="lineno"></span><span class="op" id="7600174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7600177">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="7600216">var</span>&nbsp;<span class="ident" id="7600220">hookQueryBadConn</span>&nbsp;<span class="keyword" id="7600237">func</span><span class="op" id="7600241">(</span><span class="op" id="7600242">)</span>&nbsp;<span class="builtintype" id="7600244">bool</span><br>
<span class="lineno">610</span><br>
<span class="lineno"></span><span class="keyword" id="7600250">func</span>&nbsp;<span class="op" id="7600255">(</span><span class="ident" id="7600256">s</span>&nbsp;<span class="op" id="7600258">*</span><span class="ident" id="7600259">fakeStmt</span><span class="op" id="7600267">)</span>&nbsp;<span class="ident" id="7600269">Query</span><span class="op" id="7600274">(</span><span class="ident" id="7600275">args</span>&nbsp;<span class="op" id="7600280">[</span><span class="op" id="7600281">]</span><span class="ident" id="7600282">driver</span><span class="op" id="7600288">.</span><span class="ident" id="7600289">Value</span><span class="op" id="7600294">)</span>&nbsp;<span class="op" id="7600296">(</span><span class="ident" id="7600297">driver</span><span class="op" id="7600303">.</span><span class="ident" id="7600304">Rows</span><span class="op" id="7600308">,</span>&nbsp;<span class="builtintype" id="7600310">error</span><span class="op" id="7600315">)</span>&nbsp;<span class="op" id="7600317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600320">if</span>&nbsp;<span class="ident" id="7600323">s</span><span class="op" id="7600324">.</span><span class="ident" id="7600325">closed</span>&nbsp;<span class="op" id="7600332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600336">return</span>&nbsp;<span class="ident" id="7600343">nil</span><span class="op" id="7600346">,</span>&nbsp;<span class="ident" id="7600348">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600359">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600363">if</span>&nbsp;<span class="ident" id="7600366">hookQueryBadConn</span>&nbsp;<span class="op" id="7600383">!=</span>&nbsp;<span class="ident" id="7600386">nil</span>&nbsp;<span class="op" id="7600390">&amp;&amp;</span>&nbsp;<span class="ident" id="7600393">hookQueryBadConn</span><span class="op" id="7600409">(</span><span class="op" id="7600410">)</span>&nbsp;<span class="op" id="7600412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600416">return</span>&nbsp;<span class="ident" id="7600423">nil</span><span class="op" id="7600426">,</span>&nbsp;<span class="ident" id="7600428">driver</span><span class="op" id="7600434">.</span><span class="ident" id="7600435">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600451">err</span>&nbsp;<span class="op" id="7600455">:=</span>&nbsp;<span class="ident" id="7600458">checkSubsetTypes</span><span class="op" id="7600474">(</span><span class="ident" id="7600475">args</span><span class="op" id="7600479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600482">if</span>&nbsp;<span class="ident" id="7600485">err</span>&nbsp;<span class="op" id="7600489">!=</span>&nbsp;<span class="ident" id="7600492">nil</span>&nbsp;<span class="op" id="7600496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600500">return</span>&nbsp;<span class="ident" id="7600507">nil</span><span class="op" id="7600510">,</span>&nbsp;<span class="ident" id="7600512">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600521">db</span>&nbsp;<span class="op" id="7600524">:=</span>&nbsp;<span class="ident" id="7600527">s</span><span class="op" id="7600528">.</span><span class="ident" id="7600529">c</span><span class="op" id="7600530">.</span><span class="ident" id="7600531">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600535">if</span>&nbsp;<span class="builtinfunc" id="7600538">len</span><span class="op" id="7600541">(</span><span class="ident" id="7600542">args</span><span class="op" id="7600546">)</span>&nbsp;<span class="op" id="7600548">!=</span>&nbsp;<span class="ident" id="7600551">s</span><span class="op" id="7600552">.</span><span class="ident" id="7600553">placeholders</span>&nbsp;<span class="op" id="7600566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7600570">panic</span><span class="op" id="7600575">(</span><span class="string" id="7600576">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="7600634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600641">db</span><span class="op" id="7600643">.</span><span class="ident" id="7600644">mu</span><span class="op" id="7600646">.</span><span class="ident" id="7600647">Lock</span><span class="op" id="7600651">(</span><span class="op" id="7600652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600655">t</span><span class="op" id="7600656">,</span>&nbsp;<span class="ident" id="7600658">ok</span>&nbsp;<span class="op" id="7600661">:=</span>&nbsp;<span class="ident" id="7600664">db</span><span class="op" id="7600666">.</span><span class="ident" id="7600667">table</span><span class="op" id="7600672">(</span><span class="ident" id="7600673">s</span><span class="op" id="7600674">.</span><span class="ident" id="7600675">table</span><span class="op" id="7600680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600683">db</span><span class="op" id="7600685">.</span><span class="ident" id="7600686">mu</span><span class="op" id="7600688">.</span><span class="ident" id="7600689">Unlock</span><span class="op" id="7600695">(</span><span class="op" id="7600696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600699">if</span>&nbsp;<span class="op" id="7600702">!</span><span class="ident" id="7600703">ok</span>&nbsp;<span class="op" id="7600706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600710">return</span>&nbsp;<span class="ident" id="7600717">nil</span><span class="op" id="7600720">,</span>&nbsp;<span class="ident" id="7600722">fmt</span><span class="op" id="7600725">.</span><span class="ident" id="7600726">Errorf</span><span class="op" id="7600732">(</span><span class="string" id="7600733">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="7600765">,</span>&nbsp;<span class="ident" id="7600767">s</span><span class="op" id="7600768">.</span><span class="ident" id="7600769">table</span><span class="op" id="7600774">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600781">if</span>&nbsp;<span class="ident" id="7600784">s</span><span class="op" id="7600785">.</span><span class="ident" id="7600786">table</span>&nbsp;<span class="op" id="7600792">==</span>&nbsp;<span class="string" id="7600795">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="7600808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600812">if</span>&nbsp;<span class="builtinfunc" id="7600815">len</span><span class="op" id="7600818">(</span><span class="ident" id="7600819">s</span><span class="op" id="7600820">.</span><span class="ident" id="7600821">whereCol</span><span class="op" id="7600829">)</span>&nbsp;<span class="op" id="7600831">==</span>&nbsp;<span class="num" id="7600834">2</span>&nbsp;<span class="op" id="7600836">&amp;&amp;</span>&nbsp;<span class="ident" id="7600839">s</span><span class="op" id="7600840">.</span><span class="ident" id="7600841">whereCol</span><span class="op" id="7600849">[</span><span class="num" id="7600850">0</span><span class="op" id="7600851">]</span>&nbsp;<span class="op" id="7600853">==</span>&nbsp;<span class="string" id="7600856">&#34;op&#34;</span>&nbsp;<span class="op" id="7600861">&amp;&amp;</span>&nbsp;<span class="ident" id="7600864">s</span><span class="op" id="7600865">.</span><span class="ident" id="7600866">whereCol</span><span class="op" id="7600874">[</span><span class="num" id="7600875">1</span><span class="op" id="7600876">]</span>&nbsp;<span class="op" id="7600878">==</span>&nbsp;<span class="string" id="7600881">&#34;millis&#34;</span>&nbsp;<span class="op" id="7600890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7600895">if</span>&nbsp;<span class="ident" id="7600898">args</span><span class="op" id="7600902">[</span><span class="num" id="7600903">0</span><span class="op" id="7600904">]</span>&nbsp;<span class="op" id="7600906">==</span>&nbsp;<span class="string" id="7600909">&#34;sleep&#34;</span>&nbsp;<span class="op" id="7600917">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600923">time</span><span class="op" id="7600927">.</span><span class="ident" id="7600928">Sleep</span><span class="op" id="7600933">(</span><span class="ident" id="7600934">time</span><span class="op" id="7600938">.</span><span class="ident" id="7600939">Duration</span><span class="op" id="7600947">(</span><span class="ident" id="7600948">args</span><span class="op" id="7600952">[</span><span class="num" id="7600953">1</span><span class="op" id="7600954">]</span><span class="op" id="7600955">.</span><span class="op" id="7600956">(</span><span class="ident" id="7600957">int64</span><span class="op" id="7600962">)</span><span class="op" id="7600963">)</span>&nbsp;<span class="op" id="7600965">*</span>&nbsp;<span class="ident" id="7600967">time</span><span class="op" id="7600971">.</span><span class="ident" id="7600972">Millisecond</span><span class="op" id="7600983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7600995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7600999">t</span><span class="op" id="7601000">.</span><span class="ident" id="7601001">mu</span><span class="op" id="7601003">.</span><span class="ident" id="7601004">Lock</span><span class="op" id="7601008">(</span><span class="op" id="7601009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601012">defer</span>&nbsp;<span class="ident" id="7601018">t</span><span class="op" id="7601019">.</span><span class="ident" id="7601020">mu</span><span class="op" id="7601022">.</span><span class="ident" id="7601023">Unlock</span><span class="op" id="7601029">(</span><span class="op" id="7601030">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601034">colIdx</span>&nbsp;<span class="op" id="7601041">:=</span>&nbsp;<span class="builtinfunc" id="7601044">make</span><span class="op" id="7601048">(</span><span class="keyword" id="7601049">map</span><span class="op" id="7601052">[</span><span class="builtintype" id="7601053">string</span><span class="op" id="7601059">]</span><span class="builtintype" id="7601060">int</span><span class="op" id="7601063">)</span>&nbsp;<span class="comment" id="7601065">//&nbsp;select&nbsp;column&nbsp;name&nbsp;-&gt;&nbsp;column&nbsp;index&nbsp;in&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601113">for</span>&nbsp;<span class="ident" id="7601117">_</span><span class="op" id="7601118">,</span>&nbsp;<span class="ident" id="7601120">name</span>&nbsp;<span class="op" id="7601125">:=</span>&nbsp;<span class="keyword" id="7601128">range</span>&nbsp;<span class="ident" id="7601134">s</span><span class="op" id="7601135">.</span><span class="ident" id="7601136">colName</span>&nbsp;<span class="op" id="7601144">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601148">idx</span>&nbsp;<span class="op" id="7601152">:=</span>&nbsp;<span class="ident" id="7601155">t</span><span class="op" id="7601156">.</span><span class="ident" id="7601157">columnIndex</span><span class="op" id="7601168">(</span><span class="ident" id="7601169">name</span><span class="op" id="7601173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601177">if</span>&nbsp;<span class="ident" id="7601180">idx</span>&nbsp;<span class="op" id="7601184">==</span>&nbsp;<span class="op" id="7601187">-</span><span class="num" id="7601188">1</span>&nbsp;<span class="op" id="7601190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601195">return</span>&nbsp;<span class="ident" id="7601202">nil</span><span class="op" id="7601205">,</span>&nbsp;<span class="ident" id="7601207">fmt</span><span class="op" id="7601210">.</span><span class="ident" id="7601211">Errorf</span><span class="op" id="7601217">(</span><span class="string" id="7601218">&#34;fakedb:&nbsp;unknown&nbsp;column&nbsp;name&nbsp;%q&#34;</span><span class="op" id="7601250">,</span>&nbsp;<span class="ident" id="7601252">name</span><span class="op" id="7601256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7601260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601264">colIdx</span><span class="op" id="7601270">[</span><span class="ident" id="7601271">name</span><span class="op" id="7601275">]</span>&nbsp;<span class="op" id="7601277">=</span>&nbsp;<span class="ident" id="7601279">idx</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7601284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601288">mrows</span>&nbsp;<span class="op" id="7601294">:=</span>&nbsp;<span class="op" id="7601297">[</span><span class="op" id="7601298">]</span><span class="op" id="7601299">*</span><span class="ident" id="7601300">row</span><span class="op" id="7601303">{</span><span class="op" id="7601304">}</span><br>
<span class="lineno"></span><span class="ident" id="7601306">rows</span><span class="op" id="7601310">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601313">for</span>&nbsp;<span class="ident" id="7601317">_</span><span class="op" id="7601318">,</span>&nbsp;<span class="ident" id="7601320">trow</span>&nbsp;<span class="op" id="7601325">:=</span>&nbsp;<span class="keyword" id="7601328">range</span>&nbsp;<span class="ident" id="7601334">t</span><span class="op" id="7601335">.</span><span class="ident" id="7601336">rows</span>&nbsp;<span class="op" id="7601341">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7601345">//&nbsp;Process&nbsp;the&nbsp;where&nbsp;clause,&nbsp;skipping&nbsp;non-match&nbsp;rows.&nbsp;This&nbsp;is&nbsp;lazy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7601414">//&nbsp;and&nbsp;just&nbsp;uses&nbsp;fmt.Sprintf(&#34;%v&#34;)&nbsp;to&nbsp;test&nbsp;equality.&nbsp;&nbsp;Good&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7601482">//&nbsp;for&nbsp;test&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601502">for</span>&nbsp;<span class="ident" id="7601506">widx</span><span class="op" id="7601510">,</span>&nbsp;<span class="ident" id="7601512">wcol</span>&nbsp;<span class="op" id="7601517">:=</span>&nbsp;<span class="keyword" id="7601520">range</span>&nbsp;<span class="ident" id="7601526">s</span><span class="op" id="7601527">.</span><span class="ident" id="7601528">whereCol</span>&nbsp;<span class="op" id="7601537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601542">idx</span>&nbsp;<span class="op" id="7601546">:=</span>&nbsp;<span class="ident" id="7601549">t</span><span class="op" id="7601550">.</span><span class="ident" id="7601551">columnIndex</span><span class="op" id="7601562">(</span><span class="ident" id="7601563">wcol</span><span class="op" id="7601567">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601572">if</span>&nbsp;<span class="ident" id="7601575">idx</span>&nbsp;<span class="op" id="7601579">==</span>&nbsp;<span class="op" id="7601582">-</span><span class="num" id="7601583">1</span>&nbsp;<span class="op" id="7601585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601591">return</span>&nbsp;<span class="ident" id="7601598">nil</span><span class="op" id="7601601">,</span>&nbsp;<span class="ident" id="7601603">fmt</span><span class="op" id="7601606">.</span><span class="ident" id="7601607">Errorf</span><span class="op" id="7601613">(</span><span class="string" id="7601614">&#34;db:&nbsp;invalid&nbsp;where&nbsp;clause&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7601650">,</span>&nbsp;<span class="ident" id="7601652">wcol</span><span class="op" id="7601656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7601661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601666">tcol</span>&nbsp;<span class="op" id="7601671">:=</span>&nbsp;<span class="ident" id="7601674">trow</span><span class="op" id="7601678">.</span><span class="ident" id="7601679">cols</span><span class="op" id="7601683">[</span><span class="ident" id="7601684">idx</span><span class="op" id="7601687">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601692">if</span>&nbsp;<span class="ident" id="7601695">bs</span><span class="op" id="7601697">,</span>&nbsp;<span class="ident" id="7601699">ok</span>&nbsp;<span class="op" id="7601702">:=</span>&nbsp;<span class="ident" id="7601705">tcol</span><span class="op" id="7601709">.</span><span class="op" id="7601710">(</span><span class="op" id="7601711">[</span><span class="op" id="7601712">]</span><span class="builtintype" id="7601713">byte</span><span class="op" id="7601717">)</span><span class="op" id="7601718">;</span>&nbsp;<span class="ident" id="7601720">ok</span>&nbsp;<span class="op" id="7601723">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7601729">//&nbsp;lazy&nbsp;hack&nbsp;to&nbsp;avoid&nbsp;sprintf&nbsp;%v&nbsp;on&nbsp;a&nbsp;[]byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601778">tcol</span>&nbsp;<span class="op" id="7601783">=</span>&nbsp;<span class="builtintype" id="7601785">string</span><span class="op" id="7601791">(</span><span class="ident" id="7601792">bs</span><span class="op" id="7601794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7601799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601804">if</span>&nbsp;<span class="ident" id="7601807">fmt</span><span class="op" id="7601810">.</span><span class="ident" id="7601811">Sprintf</span><span class="op" id="7601818">(</span><span class="string" id="7601819">&#34;%v&#34;</span><span class="op" id="7601823">,</span>&nbsp;<span class="ident" id="7601825">tcol</span><span class="op" id="7601829">)</span>&nbsp;<span class="op" id="7601831">!=</span>&nbsp;<span class="ident" id="7601834">fmt</span><span class="op" id="7601837">.</span><span class="ident" id="7601838">Sprintf</span><span class="op" id="7601845">(</span><span class="string" id="7601846">&#34;%v&#34;</span><span class="op" id="7601850">,</span>&nbsp;<span class="ident" id="7601852">args</span><span class="op" id="7601856">[</span><span class="ident" id="7601857">widx</span><span class="op" id="7601861">]</span><span class="op" id="7601862">)</span>&nbsp;<span class="op" id="7601864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601870">continue</span>&nbsp;<span class="ident" id="7601879">rows</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7601887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7601891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601895">mrow</span>&nbsp;<span class="op" id="7601900">:=</span>&nbsp;<span class="op" id="7601903">&amp;</span><span class="ident" id="7601904">row</span><span class="op" id="7601907">{</span><span class="ident" id="7601908">cols</span><span class="op" id="7601912">:</span>&nbsp;<span class="builtinfunc" id="7601914">make</span><span class="op" id="7601918">(</span><span class="op" id="7601919">[</span><span class="op" id="7601920">]</span><span class="keyword" id="7601921">interface</span><span class="op" id="7601930">{</span><span class="op" id="7601931">}</span><span class="op" id="7601932">,</span>&nbsp;<span class="builtinfunc" id="7601934">len</span><span class="op" id="7601937">(</span><span class="ident" id="7601938">s</span><span class="op" id="7601939">.</span><span class="ident" id="7601940">colName</span><span class="op" id="7601947">)</span><span class="op" id="7601948">)</span><span class="op" id="7601949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7601953">for</span>&nbsp;<span class="ident" id="7601957">seli</span><span class="op" id="7601961">,</span>&nbsp;<span class="ident" id="7601963">name</span>&nbsp;<span class="op" id="7601968">:=</span>&nbsp;<span class="keyword" id="7601971">range</span>&nbsp;<span class="ident" id="7601977">s</span><span class="op" id="7601978">.</span><span class="ident" id="7601979">colName</span>&nbsp;<span class="op" id="7601987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7601992">mrow</span><span class="op" id="7601996">.</span><span class="ident" id="7601997">cols</span><span class="op" id="7602001">[</span><span class="ident" id="7602002">seli</span><span class="op" id="7602006">]</span>&nbsp;<span class="op" id="7602008">=</span>&nbsp;<span class="ident" id="7602010">trow</span><span class="op" id="7602014">.</span><span class="ident" id="7602015">cols</span><span class="op" id="7602019">[</span><span class="ident" id="7602020">colIdx</span><span class="op" id="7602026">[</span><span class="ident" id="7602027">name</span><span class="op" id="7602031">]</span><span class="op" id="7602032">]</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7602036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602040">mrows</span>&nbsp;<span class="op" id="7602046">=</span>&nbsp;<span class="builtinfunc" id="7602048">append</span><span class="op" id="7602054">(</span><span class="ident" id="7602055">mrows</span><span class="op" id="7602060">,</span>&nbsp;<span class="ident" id="7602062">mrow</span><span class="op" id="7602066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7602069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602073">cursor</span>&nbsp;<span class="op" id="7602080">:=</span>&nbsp;<span class="op" id="7602083">&amp;</span><span class="ident" id="7602084">rowsCursor</span><span class="op" id="7602094">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602098">pos</span><span class="op" id="7602101">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7602106">-</span><span class="num" id="7602107">1</span><span class="op" id="7602108">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602112">rows</span><span class="op" id="7602116">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7602120">mrows</span><span class="op" id="7602125">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602129">cols</span><span class="op" id="7602133">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7602137">s</span><span class="op" id="7602138">.</span><span class="ident" id="7602139">colName</span><span class="op" id="7602146">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602150">errPos</span><span class="op" id="7602156">:</span>&nbsp;<span class="op" id="7602158">-</span><span class="num" id="7602159">1</span><span class="op" id="7602160">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7602163">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7602166">return</span>&nbsp;<span class="ident" id="7602173">cursor</span><span class="op" id="7602179">,</span>&nbsp;<span class="ident" id="7602181">nil</span><br>
<span class="lineno"></span><span class="op" id="7602185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7602188">func</span>&nbsp;<span class="op" id="7602193">(</span><span class="ident" id="7602194">s</span>&nbsp;<span class="op" id="7602196">*</span><span class="ident" id="7602197">fakeStmt</span><span class="op" id="7602205">)</span>&nbsp;<span class="ident" id="7602207">NumInput</span><span class="op" id="7602215">(</span><span class="op" id="7602216">)</span>&nbsp;<span class="builtintype" id="7602218">int</span>&nbsp;<span class="op" id="7602222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7602225">return</span>&nbsp;<span class="ident" id="7602232">s</span><span class="op" id="7602233">.</span><span class="ident" id="7602234">placeholders</span><br>
<span class="lineno">695</span><span class="op" id="7602247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7602250">func</span>&nbsp;<span class="op" id="7602255">(</span><span class="ident" id="7602256">tx</span>&nbsp;<span class="op" id="7602259">*</span><span class="ident" id="7602260">fakeTx</span><span class="op" id="7602266">)</span>&nbsp;<span class="ident" id="7602268">Commit</span><span class="op" id="7602274">(</span><span class="op" id="7602275">)</span>&nbsp;<span class="builtintype" id="7602277">error</span>&nbsp;<span class="op" id="7602283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602286">tx</span><span class="op" id="7602288">.</span><span class="ident" id="7602289">c</span><span class="op" id="7602290">.</span><span class="ident" id="7602291">currTx</span>&nbsp;<span class="op" id="7602298">=</span>&nbsp;<span class="ident" id="7602300">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7602305">return</span>&nbsp;<span class="ident" id="7602312">nil</span><br>
<span class="lineno">700</span><span class="op" id="7602316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7602319">func</span>&nbsp;<span class="op" id="7602324">(</span><span class="ident" id="7602325">tx</span>&nbsp;<span class="op" id="7602328">*</span><span class="ident" id="7602329">fakeTx</span><span class="op" id="7602335">)</span>&nbsp;<span class="ident" id="7602337">Rollback</span><span class="op" id="7602345">(</span><span class="op" id="7602346">)</span>&nbsp;<span class="builtintype" id="7602348">error</span>&nbsp;<span class="op" id="7602354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602357">tx</span><span class="op" id="7602359">.</span><span class="ident" id="7602360">c</span><span class="op" id="7602361">.</span><span class="ident" id="7602362">currTx</span>&nbsp;<span class="op" id="7602369">=</span>&nbsp;<span class="ident" id="7602371">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7602376">return</span>&nbsp;<span class="ident" id="7602383">nil</span><br>
<span class="lineno">705</span><span class="op" id="7602387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7602390">type</span>&nbsp;<span class="ident" id="7602395">rowsCursor</span>&nbsp;<span class="keyword" id="7602406">struct</span>&nbsp;<span class="op" id="7602413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602416">cols</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7602423">[</span><span class="op" id="7602424">]</span><span class="builtintype" id="7602425">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602433">pos</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7602440">int</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602445">rows</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7602452">[</span><span class="op" id="7602453">]</span><span class="op" id="7602454">*</span><span class="ident" id="7602455">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602460">closed</span>&nbsp;<span class="builtintype" id="7602467">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7602474">//&nbsp;errPos&nbsp;and&nbsp;err&nbsp;are&nbsp;for&nbsp;making&nbsp;Next&nbsp;return&nbsp;early&nbsp;with&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602538">errPos</span>&nbsp;<span class="builtintype" id="7602545">int</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602550">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7602557">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7602565">//&nbsp;a&nbsp;clone&nbsp;of&nbsp;slices&nbsp;to&nbsp;give&nbsp;out&nbsp;to&nbsp;clients,&nbsp;indexed&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7602626">//&nbsp;the&nbsp;original&nbsp;slice&#39;s&nbsp;first&nbsp;byte&nbsp;address.&nbsp;&nbsp;we&nbsp;clone&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7602686">//&nbsp;just&nbsp;so&nbsp;we&#39;re&nbsp;able&nbsp;to&nbsp;corrupt&nbsp;them&nbsp;on&nbsp;close.</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602735">bytesClone</span>&nbsp;<span class="keyword" id="7602746">map</span><span class="op" id="7602749">[</span><span class="op" id="7602750">*</span><span class="builtintype" id="7602751">byte</span><span class="op" id="7602755">]</span><span class="op" id="7602756">[</span><span class="op" id="7602757">]</span><span class="builtintype" id="7602758">byte</span><br>
<span class="lineno"></span><span class="op" id="7602763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7602766">func</span>&nbsp;<span class="op" id="7602771">(</span><span class="ident" id="7602772">rc</span>&nbsp;<span class="op" id="7602775">*</span><span class="ident" id="7602776">rowsCursor</span><span class="op" id="7602786">)</span>&nbsp;<span class="ident" id="7602788">Close</span><span class="op" id="7602793">(</span><span class="op" id="7602794">)</span>&nbsp;<span class="builtintype" id="7602796">error</span>&nbsp;<span class="op" id="7602802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7602805">if</span>&nbsp;<span class="op" id="7602808">!</span><span class="ident" id="7602809">rc</span><span class="op" id="7602811">.</span><span class="ident" id="7602812">closed</span>&nbsp;<span class="op" id="7602819">{</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7602823">for</span>&nbsp;<span class="ident" id="7602827">_</span><span class="op" id="7602828">,</span>&nbsp;<span class="ident" id="7602830">bs</span>&nbsp;<span class="op" id="7602833">:=</span>&nbsp;<span class="keyword" id="7602836">range</span>&nbsp;<span class="ident" id="7602842">rc</span><span class="op" id="7602844">.</span><span class="ident" id="7602845">bytesClone</span>&nbsp;<span class="op" id="7602856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602861">bs</span><span class="op" id="7602863">[</span><span class="num" id="7602864">0</span><span class="op" id="7602865">]</span>&nbsp;<span class="op" id="7602867">=</span>&nbsp;<span class="num" id="7602869">255</span>&nbsp;<span class="comment" id="7602873">//&nbsp;first&nbsp;byte&nbsp;corrupted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7602899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7602902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7602905">rc</span><span class="op" id="7602907">.</span><span class="ident" id="7602908">closed</span>&nbsp;<span class="op" id="7602915">=</span>&nbsp;<span class="builtintype" id="7602917">true</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7602923">return</span>&nbsp;<span class="ident" id="7602930">nil</span><br>
<span class="lineno"></span><span class="op" id="7602934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7602937">func</span>&nbsp;<span class="op" id="7602942">(</span><span class="ident" id="7602943">rc</span>&nbsp;<span class="op" id="7602946">*</span><span class="ident" id="7602947">rowsCursor</span><span class="op" id="7602957">)</span>&nbsp;<span class="ident" id="7602959">Columns</span><span class="op" id="7602966">(</span><span class="op" id="7602967">)</span>&nbsp;<span class="op" id="7602969">[</span><span class="op" id="7602970">]</span><span class="builtintype" id="7602971">string</span>&nbsp;<span class="op" id="7602978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7602981">return</span>&nbsp;<span class="ident" id="7602988">rc</span><span class="op" id="7602990">.</span><span class="ident" id="7602991">cols</span><br>
<span class="lineno">735</span><span class="op" id="7602996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7602999">var</span>&nbsp;<span class="ident" id="7603003">rowsCursorNextHook</span>&nbsp;<span class="keyword" id="7603022">func</span><span class="op" id="7603026">(</span><span class="ident" id="7603027">dest</span>&nbsp;<span class="op" id="7603032">[</span><span class="op" id="7603033">]</span><span class="ident" id="7603034">driver</span><span class="op" id="7603040">.</span><span class="ident" id="7603041">Value</span><span class="op" id="7603046">)</span>&nbsp;<span class="builtintype" id="7603048">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7603055">func</span>&nbsp;<span class="op" id="7603060">(</span><span class="ident" id="7603061">rc</span>&nbsp;<span class="op" id="7603064">*</span><span class="ident" id="7603065">rowsCursor</span><span class="op" id="7603075">)</span>&nbsp;<span class="ident" id="7603077">Next</span><span class="op" id="7603081">(</span><span class="ident" id="7603082">dest</span>&nbsp;<span class="op" id="7603087">[</span><span class="op" id="7603088">]</span><span class="ident" id="7603089">driver</span><span class="op" id="7603095">.</span><span class="ident" id="7603096">Value</span><span class="op" id="7603101">)</span>&nbsp;<span class="builtintype" id="7603103">error</span>&nbsp;<span class="op" id="7603109">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7603112">if</span>&nbsp;<span class="ident" id="7603115">rowsCursorNextHook</span>&nbsp;<span class="op" id="7603134">!=</span>&nbsp;<span class="ident" id="7603137">nil</span>&nbsp;<span class="op" id="7603141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7603145">return</span>&nbsp;<span class="ident" id="7603152">rowsCursorNextHook</span><span class="op" id="7603170">(</span><span class="ident" id="7603171">dest</span><span class="op" id="7603175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7603182">if</span>&nbsp;<span class="ident" id="7603185">rc</span><span class="op" id="7603187">.</span><span class="ident" id="7603188">closed</span>&nbsp;<span class="op" id="7603195">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7603199">return</span>&nbsp;<span class="ident" id="7603206">errors</span><span class="op" id="7603212">.</span><span class="ident" id="7603213">New</span><span class="op" id="7603216">(</span><span class="string" id="7603217">&#34;fakedb:&nbsp;cursor&nbsp;is&nbsp;closed&#34;</span><span class="op" id="7603243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7603249">rc</span><span class="op" id="7603251">.</span><span class="ident" id="7603252">pos</span><span class="op" id="7603255">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7603259">if</span>&nbsp;<span class="ident" id="7603262">rc</span><span class="op" id="7603264">.</span><span class="ident" id="7603265">pos</span>&nbsp;<span class="op" id="7603269">==</span>&nbsp;<span class="ident" id="7603272">rc</span><span class="op" id="7603274">.</span><span class="ident" id="7603275">errPos</span>&nbsp;<span class="op" id="7603282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7603286">return</span>&nbsp;<span class="ident" id="7603293">rc</span><span class="op" id="7603295">.</span><span class="ident" id="7603296">err</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7603304">if</span>&nbsp;<span class="ident" id="7603307">rc</span><span class="op" id="7603309">.</span><span class="ident" id="7603310">pos</span>&nbsp;<span class="op" id="7603314">&gt;=</span>&nbsp;<span class="builtinfunc" id="7603317">len</span><span class="op" id="7603320">(</span><span class="ident" id="7603321">rc</span><span class="op" id="7603323">.</span><span class="ident" id="7603324">rows</span><span class="op" id="7603328">)</span>&nbsp;<span class="op" id="7603330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7603334">return</span>&nbsp;<span class="ident" id="7603341">io</span><span class="op" id="7603343">.</span><span class="ident" id="7603344">EOF</span>&nbsp;<span class="comment" id="7603348">//&nbsp;per&nbsp;interface&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7603374">for</span>&nbsp;<span class="ident" id="7603378">i</span><span class="op" id="7603379">,</span>&nbsp;<span class="ident" id="7603381">v</span>&nbsp;<span class="op" id="7603383">:=</span>&nbsp;<span class="keyword" id="7603386">range</span>&nbsp;<span class="ident" id="7603392">rc</span><span class="op" id="7603394">.</span><span class="ident" id="7603395">rows</span><span class="op" id="7603399">[</span><span class="ident" id="7603400">rc</span><span class="op" id="7603402">.</span><span class="ident" id="7603403">pos</span><span class="op" id="7603406">]</span><span class="op" id="7603407">.</span><span class="ident" id="7603408">cols</span>&nbsp;<span class="op" id="7603413">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7603417">//&nbsp;TODO(bradfitz):&nbsp;convert&nbsp;to&nbsp;subset&nbsp;types?&nbsp;naah,&nbsp;I</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7603471">//&nbsp;think&nbsp;the&nbsp;subset&nbsp;types&nbsp;should&nbsp;only&nbsp;be&nbsp;input&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7603523">//&nbsp;driver,&nbsp;but&nbsp;the&nbsp;sql&nbsp;package&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7603581">//&nbsp;a&nbsp;wider&nbsp;range&nbsp;of&nbsp;types&nbsp;coming&nbsp;out&nbsp;of&nbsp;drivers.&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7603636">//&nbsp;for&nbsp;ease&nbsp;of&nbsp;drivers,&nbsp;and&nbsp;to&nbsp;prevent&nbsp;drivers&nbsp;from</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7603690">//&nbsp;messing&nbsp;up&nbsp;conversions&nbsp;or&nbsp;doing&nbsp;them&nbsp;differently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7603745">dest</span><span class="op" id="7603749">[</span><span class="ident" id="7603750">i</span><span class="op" id="7603751">]</span>&nbsp;<span class="op" id="7603753">=</span>&nbsp;<span class="ident" id="7603755">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7603760">if</span>&nbsp;<span class="ident" id="7603763">bs</span><span class="op" id="7603765">,</span>&nbsp;<span class="ident" id="7603767">ok</span>&nbsp;<span class="op" id="7603770">:=</span>&nbsp;<span class="ident" id="7603773">v</span><span class="op" id="7603774">.</span><span class="op" id="7603775">(</span><span class="op" id="7603776">[</span><span class="op" id="7603777">]</span><span class="builtintype" id="7603778">byte</span><span class="op" id="7603782">)</span><span class="op" id="7603783">;</span>&nbsp;<span class="ident" id="7603785">ok</span>&nbsp;<span class="op" id="7603788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7603793">if</span>&nbsp;<span class="ident" id="7603796">rc</span><span class="op" id="7603798">.</span><span class="ident" id="7603799">bytesClone</span>&nbsp;<span class="op" id="7603810">==</span>&nbsp;<span class="ident" id="7603813">nil</span>&nbsp;<span class="op" id="7603817">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7603823">rc</span><span class="op" id="7603825">.</span><span class="ident" id="7603826">bytesClone</span>&nbsp;<span class="op" id="7603837">=</span>&nbsp;<span class="builtinfunc" id="7603839">make</span><span class="op" id="7603843">(</span><span class="keyword" id="7603844">map</span><span class="op" id="7603847">[</span><span class="op" id="7603848">*</span><span class="builtintype" id="7603849">byte</span><span class="op" id="7603853">]</span><span class="op" id="7603854">[</span><span class="op" id="7603855">]</span><span class="builtintype" id="7603856">byte</span><span class="op" id="7603860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7603865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7603870">clone</span><span class="op" id="7603875">,</span>&nbsp;<span class="ident" id="7603877">ok</span>&nbsp;<span class="op" id="7603880">:=</span>&nbsp;<span class="ident" id="7603883">rc</span><span class="op" id="7603885">.</span><span class="ident" id="7603886">bytesClone</span><span class="op" id="7603896">[</span><span class="op" id="7603897">&amp;</span><span class="ident" id="7603898">bs</span><span class="op" id="7603900">[</span><span class="num" id="7603901">0</span><span class="op" id="7603902">]</span><span class="op" id="7603903">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7603908">if</span>&nbsp;<span class="op" id="7603911">!</span><span class="ident" id="7603912">ok</span>&nbsp;<span class="op" id="7603915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7603921">clone</span>&nbsp;<span class="op" id="7603927">=</span>&nbsp;<span class="builtinfunc" id="7603929">make</span><span class="op" id="7603933">(</span><span class="op" id="7603934">[</span><span class="op" id="7603935">]</span><span class="builtintype" id="7603936">byte</span><span class="op" id="7603940">,</span>&nbsp;<span class="builtinfunc" id="7603942">len</span><span class="op" id="7603945">(</span><span class="ident" id="7603946">bs</span><span class="op" id="7603948">)</span><span class="op" id="7603949">)</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7603955">copy</span><span class="op" id="7603959">(</span><span class="ident" id="7603960">clone</span><span class="op" id="7603965">,</span>&nbsp;<span class="ident" id="7603967">bs</span><span class="op" id="7603969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7603975">rc</span><span class="op" id="7603977">.</span><span class="ident" id="7603978">bytesClone</span><span class="op" id="7603988">[</span><span class="op" id="7603989">&amp;</span><span class="ident" id="7603990">bs</span><span class="op" id="7603992">[</span><span class="num" id="7603993">0</span><span class="op" id="7603994">]</span><span class="op" id="7603995">]</span>&nbsp;<span class="op" id="7603997">=</span>&nbsp;<span class="ident" id="7603999">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7604013">dest</span><span class="op" id="7604017">[</span><span class="ident" id="7604018">i</span><span class="op" id="7604019">]</span>&nbsp;<span class="op" id="7604021">=</span>&nbsp;<span class="ident" id="7604023">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604031">}</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604037">return</span>&nbsp;<span class="ident" id="7604044">nil</span><br>
<span class="lineno"></span><span class="op" id="7604048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7604051">//&nbsp;fakeDriverString&nbsp;is&nbsp;like&nbsp;driver.String,&nbsp;but&nbsp;indirects&nbsp;pointers&nbsp;like</span><br>
<span class="lineno">780</span><span class="comment" id="7604122">//&nbsp;DefaultValueConverter.</span><br>
<span class="lineno"></span><span class="comment" id="7604148">//</span><br>
<span class="lineno"></span><span class="comment" id="7604151">//&nbsp;This&nbsp;could&nbsp;be&nbsp;surprising&nbsp;behavior&nbsp;to&nbsp;retroactively&nbsp;apply&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="7604214">//&nbsp;driver.String&nbsp;now&nbsp;that&nbsp;Go1&nbsp;is&nbsp;out,&nbsp;but&nbsp;this&nbsp;is&nbsp;convenient&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="7604279">//&nbsp;our&nbsp;TestPointerParamsAndScans.</span><br>
<span class="lineno">785</span><span class="comment" id="7604313">//</span><br>
<span class="lineno"></span><span class="keyword" id="7604316">type</span>&nbsp;<span class="ident" id="7604321">fakeDriverString</span>&nbsp;<span class="keyword" id="7604338">struct</span><span class="op" id="7604344">{</span><span class="op" id="7604345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7604348">func</span>&nbsp;<span class="op" id="7604353">(</span><span class="ident" id="7604354">fakeDriverString</span><span class="op" id="7604370">)</span>&nbsp;<span class="ident" id="7604372">ConvertValue</span><span class="op" id="7604384">(</span><span class="ident" id="7604385">v</span>&nbsp;<span class="keyword" id="7604387">interface</span><span class="op" id="7604396">{</span><span class="op" id="7604397">}</span><span class="op" id="7604398">)</span>&nbsp;<span class="op" id="7604400">(</span><span class="ident" id="7604401">driver</span><span class="op" id="7604407">.</span><span class="ident" id="7604408">Value</span><span class="op" id="7604413">,</span>&nbsp;<span class="builtintype" id="7604415">error</span><span class="op" id="7604420">)</span>&nbsp;<span class="op" id="7604422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604425">switch</span>&nbsp;<span class="ident" id="7604432">c</span>&nbsp;<span class="op" id="7604434">:=</span>&nbsp;<span class="ident" id="7604437">v</span><span class="op" id="7604438">.</span><span class="op" id="7604439">(</span><span class="keyword" id="7604440">type</span><span class="op" id="7604444">)</span>&nbsp;<span class="op" id="7604446">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604449">case</span>&nbsp;<span class="builtintype" id="7604454">string</span><span class="op" id="7604460">,</span>&nbsp;<span class="op" id="7604462">[</span><span class="op" id="7604463">]</span><span class="builtintype" id="7604464">byte</span><span class="op" id="7604468">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604472">return</span>&nbsp;<span class="ident" id="7604479">v</span><span class="op" id="7604480">,</span>&nbsp;<span class="ident" id="7604482">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604487">case</span>&nbsp;<span class="op" id="7604492">*</span><span class="builtintype" id="7604493">string</span><span class="op" id="7604499">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604503">if</span>&nbsp;<span class="ident" id="7604506">c</span>&nbsp;<span class="op" id="7604508">==</span>&nbsp;<span class="ident" id="7604511">nil</span>&nbsp;<span class="op" id="7604515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604520">return</span>&nbsp;<span class="ident" id="7604527">nil</span><span class="op" id="7604530">,</span>&nbsp;<span class="ident" id="7604532">nil</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604542">return</span>&nbsp;<span class="op" id="7604549">*</span><span class="ident" id="7604550">c</span><span class="op" id="7604551">,</span>&nbsp;<span class="ident" id="7604553">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7604558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604561">return</span>&nbsp;<span class="ident" id="7604568">fmt</span><span class="op" id="7604571">.</span><span class="ident" id="7604572">Sprintf</span><span class="op" id="7604579">(</span><span class="string" id="7604580">&#34;%v&#34;</span><span class="op" id="7604584">,</span>&nbsp;<span class="ident" id="7604586">v</span><span class="op" id="7604587">)</span><span class="op" id="7604588">,</span>&nbsp;<span class="ident" id="7604590">nil</span><br>
<span class="lineno"></span><span class="op" id="7604594">}</span><br>
<span class="lineno">800</span><br>
<span class="lineno"></span><span class="keyword" id="7604597">func</span>&nbsp;<span class="ident" id="7604602">converterForType</span><span class="op" id="7604618">(</span><span class="ident" id="7604619">typ</span>&nbsp;<span class="builtintype" id="7604623">string</span><span class="op" id="7604629">)</span>&nbsp;<span class="ident" id="7604631">driver</span><span class="op" id="7604637">.</span><span class="ident" id="7604638">ValueConverter</span>&nbsp;<span class="op" id="7604653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604656">switch</span>&nbsp;<span class="ident" id="7604663">typ</span>&nbsp;<span class="op" id="7604667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604670">case</span>&nbsp;<span class="string" id="7604675">&#34;bool&#34;</span><span class="op" id="7604681">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604685">return</span>&nbsp;<span class="ident" id="7604692">driver</span><span class="op" id="7604698">.</span><span class="ident" id="7604699">Bool</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604705">case</span>&nbsp;<span class="string" id="7604710">&#34;nullbool&#34;</span><span class="op" id="7604720">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604724">return</span>&nbsp;<span class="ident" id="7604731">driver</span><span class="op" id="7604737">.</span><span class="ident" id="7604738">Null</span><span class="op" id="7604742">{</span><span class="ident" id="7604743">Converter</span><span class="op" id="7604752">:</span>&nbsp;<span class="ident" id="7604754">driver</span><span class="op" id="7604760">.</span><span class="ident" id="7604761">Bool</span><span class="op" id="7604765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604768">case</span>&nbsp;<span class="string" id="7604773">&#34;int32&#34;</span><span class="op" id="7604780">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604784">return</span>&nbsp;<span class="ident" id="7604791">driver</span><span class="op" id="7604797">.</span><span class="ident" id="7604798">Int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604805">case</span>&nbsp;<span class="string" id="7604810">&#34;string&#34;</span><span class="op" id="7604818">:</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604822">return</span>&nbsp;<span class="ident" id="7604829">driver</span><span class="op" id="7604835">.</span><span class="ident" id="7604836">NotNull</span><span class="op" id="7604843">{</span><span class="ident" id="7604844">Converter</span><span class="op" id="7604853">:</span>&nbsp;<span class="ident" id="7604855">fakeDriverString</span><span class="op" id="7604871">{</span><span class="op" id="7604872">}</span><span class="op" id="7604873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604876">case</span>&nbsp;<span class="string" id="7604881">&#34;nullstring&#34;</span><span class="op" id="7604893">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604897">return</span>&nbsp;<span class="ident" id="7604904">driver</span><span class="op" id="7604910">.</span><span class="ident" id="7604911">Null</span><span class="op" id="7604915">{</span><span class="ident" id="7604916">Converter</span><span class="op" id="7604925">:</span>&nbsp;<span class="ident" id="7604927">fakeDriverString</span><span class="op" id="7604943">{</span><span class="op" id="7604944">}</span><span class="op" id="7604945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7604948">case</span>&nbsp;<span class="string" id="7604953">&#34;int64&#34;</span><span class="op" id="7604960">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7604964">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7605016">return</span>&nbsp;<span class="ident" id="7605023">driver</span><span class="op" id="7605029">.</span><span class="ident" id="7605030">NotNull</span><span class="op" id="7605037">{</span><span class="ident" id="7605038">Converter</span><span class="op" id="7605047">:</span>&nbsp;<span class="ident" id="7605049">driver</span><span class="op" id="7605055">.</span><span class="ident" id="7605056">DefaultParameterConverter</span><span class="op" id="7605081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7605084">case</span>&nbsp;<span class="string" id="7605089">&#34;nullint64&#34;</span><span class="op" id="7605100">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7605104">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7605156">return</span>&nbsp;<span class="ident" id="7605163">driver</span><span class="op" id="7605169">.</span><span class="ident" id="7605170">Null</span><span class="op" id="7605174">{</span><span class="ident" id="7605175">Converter</span><span class="op" id="7605184">:</span>&nbsp;<span class="ident" id="7605186">driver</span><span class="op" id="7605192">.</span><span class="ident" id="7605193">DefaultParameterConverter</span><span class="op" id="7605218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7605221">case</span>&nbsp;<span class="string" id="7605226">&#34;float64&#34;</span><span class="op" id="7605235">:</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7605239">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7605291">return</span>&nbsp;<span class="ident" id="7605298">driver</span><span class="op" id="7605304">.</span><span class="ident" id="7605305">NotNull</span><span class="op" id="7605312">{</span><span class="ident" id="7605313">Converter</span><span class="op" id="7605322">:</span>&nbsp;<span class="ident" id="7605324">driver</span><span class="op" id="7605330">.</span><span class="ident" id="7605331">DefaultParameterConverter</span><span class="op" id="7605356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7605359">case</span>&nbsp;<span class="string" id="7605364">&#34;nullfloat64&#34;</span><span class="op" id="7605377">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7605381">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7605433">return</span>&nbsp;<span class="ident" id="7605440">driver</span><span class="op" id="7605446">.</span><span class="ident" id="7605447">Null</span><span class="op" id="7605451">{</span><span class="ident" id="7605452">Converter</span><span class="op" id="7605461">:</span>&nbsp;<span class="ident" id="7605463">driver</span><span class="op" id="7605469">.</span><span class="ident" id="7605470">DefaultParameterConverter</span><span class="op" id="7605495">}</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7605498">case</span>&nbsp;<span class="string" id="7605503">&#34;datetime&#34;</span><span class="op" id="7605513">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7605517">return</span>&nbsp;<span class="ident" id="7605524">driver</span><span class="op" id="7605530">.</span><span class="ident" id="7605531">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7605558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7605561">panic</span><span class="op" id="7605566">(</span><span class="string" id="7605567">&#34;invalid&nbsp;fakedb&nbsp;column&nbsp;type&nbsp;of&nbsp;&#34;</span>&nbsp;<span class="op" id="7605600">+</span>&nbsp;<span class="ident" id="7605602">typ</span><span class="op" id="7605605">)</span><br>
<span class="lineno"></span><span class="op" id="7605607">}</span>
</div>
</body>
</html>
