<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/internal</h2>
<ul>
<li><a href="/gostd/net/http/internal/chunked.go.html" class="current">chunked.go</a></li>
<li><a href="/gostd/net/http/internal/chunked_test.go.html">chunked_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4754704">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4754759">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4754813">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4754864">//&nbsp;The&nbsp;wire&nbsp;protocol&nbsp;for&nbsp;HTTP&#39;s&nbsp;&#34;chunked&#34;&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4754926">//&nbsp;Package&nbsp;internal&nbsp;contains&nbsp;HTTP&nbsp;internals&nbsp;shared&nbsp;by&nbsp;net/http&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4754993">//&nbsp;net/http/httputil.</span><br>
<span class="lineno"></span><span class="keyword" id="4755015">package</span>&nbsp;<span class="ident" id="4755023">internal</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4755033">import</span>&nbsp;<span class="op" id="4755040">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4755043">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4755052">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4755061">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4755071">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4755078">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4755083">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4755086">const</span>&nbsp;<span class="ident" id="4755092">maxLineLength</span>&nbsp;<span class="op" id="4755106">=</span>&nbsp;<span class="num" id="4755108">4096</span>&nbsp;<span class="comment" id="4755113">//&nbsp;assumed&nbsp;&lt;=&nbsp;bufio.defaultBufSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4755149">var</span>&nbsp;<span class="ident" id="4755153">ErrLineTooLong</span>&nbsp;<span class="op" id="4755168">=</span>&nbsp;<span class="ident" id="4755170">errors</span><span class="op" id="4755176">.</span><span class="ident" id="4755177">New</span><span class="op" id="4755180">(</span><span class="string" id="4755181">&#34;header&nbsp;line&nbsp;too&nbsp;long&#34;</span><span class="op" id="4755203">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4755206">//&nbsp;NewChunkedReader&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedReader&nbsp;that&nbsp;translates&nbsp;the&nbsp;data&nbsp;read&nbsp;from&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="4755291">//&nbsp;out&nbsp;of&nbsp;HTTP&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;returning&nbsp;it.</span><br>
<span class="lineno">25</span><span class="comment" id="4755344">//&nbsp;The&nbsp;chunkedReader&nbsp;returns&nbsp;io.EOF&nbsp;when&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;is&nbsp;read.</span><br>
<span class="lineno"></span><span class="comment" id="4755419">//</span><br>
<span class="lineno"></span><span class="comment" id="4755422">//&nbsp;NewChunkedReader&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="4755497">//&nbsp;automatically&nbsp;decodes&nbsp;chunking&nbsp;when&nbsp;reading&nbsp;response&nbsp;bodies.</span><br>
<span class="lineno"></span><span class="keyword" id="4755561">func</span>&nbsp;<span class="ident" id="4755566">NewChunkedReader</span><span class="op" id="4755582">(</span><span class="ident" id="4755583">r</span>&nbsp;<span class="ident" id="4755585">io</span><span class="op" id="4755587">.</span><span class="ident" id="4755588">Reader</span><span class="op" id="4755594">)</span>&nbsp;<span class="ident" id="4755596">io</span><span class="op" id="4755598">.</span><span class="ident" id="4755599">Reader</span>&nbsp;<span class="op" id="4755606">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4755609">br</span><span class="op" id="4755611">,</span>&nbsp;<span class="ident" id="4755613">ok</span>&nbsp;<span class="op" id="4755616">:=</span>&nbsp;<span class="ident" id="4755619">r</span><span class="op" id="4755620">.</span><span class="op" id="4755621">(</span><span class="op" id="4755622">*</span><span class="ident" id="4755623">bufio</span><span class="op" id="4755628">.</span><span class="ident" id="4755629">Reader</span><span class="op" id="4755635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4755638">if</span>&nbsp;<span class="op" id="4755641">!</span><span class="ident" id="4755642">ok</span>&nbsp;<span class="op" id="4755645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4755649">br</span>&nbsp;<span class="op" id="4755652">=</span>&nbsp;<span class="ident" id="4755654">bufio</span><span class="op" id="4755659">.</span><span class="ident" id="4755660">NewReader</span><span class="op" id="4755669">(</span><span class="ident" id="4755670">r</span><span class="op" id="4755671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4755674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4755677">return</span>&nbsp;<span class="op" id="4755684">&amp;</span><span class="ident" id="4755685">chunkedReader</span><span class="op" id="4755698">{</span><span class="ident" id="4755699">r</span><span class="op" id="4755700">:</span>&nbsp;<span class="ident" id="4755702">br</span><span class="op" id="4755704">}</span><br>
<span class="lineno">35</span><span class="op" id="4755706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4755709">type</span>&nbsp;<span class="ident" id="4755714">chunkedReader</span>&nbsp;<span class="keyword" id="4755728">struct</span>&nbsp;<span class="op" id="4755735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4755738">r</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4755742">*</span><span class="ident" id="4755743">bufio</span><span class="op" id="4755748">.</span><span class="ident" id="4755749">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4755757">n</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4755761">uint64</span>&nbsp;<span class="comment" id="4755768">//&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;chunk</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4755794">err</span>&nbsp;<span class="builtintype" id="4755798">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4755805">buf</span>&nbsp;<span class="op" id="4755809">[</span><span class="num" id="4755810">2</span><span class="op" id="4755811">]</span><span class="builtintype" id="4755812">byte</span><br>
<span class="lineno"></span><span class="op" id="4755817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4755820">func</span>&nbsp;<span class="op" id="4755825">(</span><span class="ident" id="4755826">cr</span>&nbsp;<span class="op" id="4755829">*</span><span class="ident" id="4755830">chunkedReader</span><span class="op" id="4755843">)</span>&nbsp;<span class="ident" id="4755845">beginChunk</span><span class="op" id="4755855">(</span><span class="op" id="4755856">)</span>&nbsp;<span class="op" id="4755858">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4755861">//&nbsp;chunk-size&nbsp;CRLF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4755881">var</span>&nbsp;<span class="ident" id="4755885">line</span>&nbsp;<span class="op" id="4755890">[</span><span class="op" id="4755891">]</span><span class="builtintype" id="4755892">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4755898">line</span><span class="op" id="4755902">,</span>&nbsp;<span class="ident" id="4755904">cr</span><span class="op" id="4755906">.</span><span class="ident" id="4755907">err</span>&nbsp;<span class="op" id="4755911">=</span>&nbsp;<span class="ident" id="4755913">readLine</span><span class="op" id="4755921">(</span><span class="ident" id="4755922">cr</span><span class="op" id="4755924">.</span><span class="ident" id="4755925">r</span><span class="op" id="4755926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4755929">if</span>&nbsp;<span class="ident" id="4755932">cr</span><span class="op" id="4755934">.</span><span class="ident" id="4755935">err</span>&nbsp;<span class="op" id="4755939">!=</span>&nbsp;<span class="builtintype" id="4755942">nil</span>&nbsp;<span class="op" id="4755946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4755950">return</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4755958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4755961">cr</span><span class="op" id="4755963">.</span><span class="ident" id="4755964">n</span><span class="op" id="4755965">,</span>&nbsp;<span class="ident" id="4755967">cr</span><span class="op" id="4755969">.</span><span class="ident" id="4755970">err</span>&nbsp;<span class="op" id="4755974">=</span>&nbsp;<span class="ident" id="4755976">parseHexUint</span><span class="op" id="4755988">(</span><span class="ident" id="4755989">line</span><span class="op" id="4755993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4755996">if</span>&nbsp;<span class="ident" id="4755999">cr</span><span class="op" id="4756001">.</span><span class="ident" id="4756002">err</span>&nbsp;<span class="op" id="4756006">!=</span>&nbsp;<span class="builtintype" id="4756009">nil</span>&nbsp;<span class="op" id="4756013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4756017">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4756025">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4756028">if</span>&nbsp;<span class="ident" id="4756031">cr</span><span class="op" id="4756033">.</span><span class="ident" id="4756034">n</span>&nbsp;<span class="op" id="4756036">==</span>&nbsp;<span class="num" id="4756039">0</span>&nbsp;<span class="op" id="4756041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4756045">cr</span><span class="op" id="4756047">.</span><span class="ident" id="4756048">err</span>&nbsp;<span class="op" id="4756052">=</span>&nbsp;<span class="ident" id="4756054">io</span><span class="op" id="4756056">.</span><span class="ident" id="4756057">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4756062">}</span><br>
<span class="lineno"></span><span class="op" id="4756064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4756067">func</span>&nbsp;<span class="op" id="4756072">(</span><span class="ident" id="4756073">cr</span>&nbsp;<span class="op" id="4756076">*</span><span class="ident" id="4756077">chunkedReader</span><span class="op" id="4756090">)</span>&nbsp;<span class="ident" id="4756092">chunkHeaderAvailable</span><span class="op" id="4756112">(</span><span class="op" id="4756113">)</span>&nbsp;<span class="builtintype" id="4756115">bool</span>&nbsp;<span class="op" id="4756120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4756123">n</span>&nbsp;<span class="op" id="4756125">:=</span>&nbsp;<span class="ident" id="4756128">cr</span><span class="op" id="4756130">.</span><span class="ident" id="4756131">r</span><span class="op" id="4756132">.</span><span class="ident" id="4756133">Buffered</span><span class="op" id="4756141">(</span><span class="op" id="4756142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4756145">if</span>&nbsp;<span class="ident" id="4756148">n</span>&nbsp;<span class="op" id="4756150">&gt;</span>&nbsp;<span class="num" id="4756152">0</span>&nbsp;<span class="op" id="4756154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4756158">peek</span><span class="op" id="4756162">,</span>&nbsp;<span class="ident" id="4756164">_</span>&nbsp;<span class="op" id="4756166">:=</span>&nbsp;<span class="ident" id="4756169">cr</span><span class="op" id="4756171">.</span><span class="ident" id="4756172">r</span><span class="op" id="4756173">.</span><span class="ident" id="4756174">Peek</span><span class="op" id="4756178">(</span><span class="ident" id="4756179">n</span><span class="op" id="4756180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4756184">return</span>&nbsp;<span class="ident" id="4756191">bytes</span><span class="op" id="4756196">.</span><span class="ident" id="4756197">IndexByte</span><span class="op" id="4756206">(</span><span class="ident" id="4756207">peek</span><span class="op" id="4756211">,</span>&nbsp;<span class="string" id="4756213">&#39;\n&#39;</span><span class="op" id="4756217">)</span>&nbsp;<span class="op" id="4756219">&gt;=</span>&nbsp;<span class="num" id="4756222">0</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4756225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4756228">return</span>&nbsp;<span class="builtintype" id="4756235">false</span><br>
<span class="lineno"></span><span class="op" id="4756241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4756244">func</span>&nbsp;<span class="op" id="4756249">(</span><span class="ident" id="4756250">cr</span>&nbsp;<span class="op" id="4756253">*</span><span class="ident" id="4756254">chunkedReader</span><span class="op" id="4756267">)</span>&nbsp;<span class="ident" id="4756269">Read</span><span class="op" id="4756273">(</span><span class="ident" id="4756274">b</span>&nbsp;<span class="op" id="4756276">[</span><span class="op" id="4756277">]</span><span class="builtintype" id="4756278">uint8</span><span class="op" id="4756283">)</span>&nbsp;<span class="op" id="4756285">(</span><span class="ident" id="4756286">n</span>&nbsp;<span class="builtintype" id="4756288">int</span><span class="op" id="4756291">,</span>&nbsp;<span class="ident" id="4756293">err</span>&nbsp;<span class="builtintype" id="4756297">error</span><span class="op" id="4756302">)</span>&nbsp;<span class="op" id="4756304">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4756307">for</span>&nbsp;<span class="ident" id="4756311">cr</span><span class="op" id="4756313">.</span><span class="ident" id="4756314">err</span>&nbsp;<span class="op" id="4756318">==</span>&nbsp;<span class="builtintype" id="4756321">nil</span>&nbsp;<span class="op" id="4756325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4756329">if</span>&nbsp;<span class="ident" id="4756332">cr</span><span class="op" id="4756334">.</span><span class="ident" id="4756335">n</span>&nbsp;<span class="op" id="4756337">==</span>&nbsp;<span class="num" id="4756340">0</span>&nbsp;<span class="op" id="4756342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4756347">if</span>&nbsp;<span class="ident" id="4756350">n</span>&nbsp;<span class="op" id="4756352">&gt;</span>&nbsp;<span class="num" id="4756354">0</span>&nbsp;<span class="op" id="4756356">&amp;&amp;</span>&nbsp;<span class="op" id="4756359">!</span><span class="ident" id="4756360">cr</span><span class="op" id="4756362">.</span><span class="ident" id="4756363">chunkHeaderAvailable</span><span class="op" id="4756383">(</span><span class="op" id="4756384">)</span>&nbsp;<span class="op" id="4756386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4756392">//&nbsp;We&#39;ve&nbsp;read&nbsp;enough.&nbsp;Don&#39;t&nbsp;potentially&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4756442">//&nbsp;reading&nbsp;a&nbsp;new&nbsp;chunk&nbsp;header.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4756477">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4756486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4756491">cr</span><span class="op" id="4756493">.</span><span class="ident" id="4756494">beginChunk</span><span class="op" id="4756504">(</span><span class="op" id="4756505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4756510">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4756521">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4756525">if</span>&nbsp;<span class="builtinfunc" id="4756528">len</span><span class="op" id="4756531">(</span><span class="ident" id="4756532">b</span><span class="op" id="4756533">)</span>&nbsp;<span class="op" id="4756535">==</span>&nbsp;<span class="num" id="4756538">0</span>&nbsp;<span class="op" id="4756540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4756545">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4756553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4756557">rbuf</span>&nbsp;<span class="op" id="4756562">:=</span>&nbsp;<span class="ident" id="4756565">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4756569">if</span>&nbsp;<span class="ident" id="4756572">uint64</span><span class="op" id="4756578">(</span><span class="builtinfunc" id="4756579">len</span><span class="op" id="4756582">(</span><span class="ident" id="4756583">rbuf</span><span class="op" id="4756587">)</span><span class="op" id="4756588">)</span>&nbsp;<span class="op" id="4756590">&gt;</span>&nbsp;<span class="ident" id="4756592">cr</span><span class="op" id="4756594">.</span><span class="ident" id="4756595">n</span>&nbsp;<span class="op" id="4756597">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4756602">rbuf</span>&nbsp;<span class="op" id="4756607">=</span>&nbsp;<span class="ident" id="4756609">rbuf</span><span class="op" id="4756613">[</span><span class="op" id="4756614">:</span><span class="ident" id="4756615">cr</span><span class="op" id="4756617">.</span><span class="ident" id="4756618">n</span><span class="op" id="4756619">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4756623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4756627">var</span>&nbsp;<span class="ident" id="4756631">n0</span>&nbsp;<span class="builtintype" id="4756634">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4756640">n0</span><span class="op" id="4756642">,</span>&nbsp;<span class="ident" id="4756644">cr</span><span class="op" id="4756646">.</span><span class="ident" id="4756647">err</span>&nbsp;<span class="op" id="4756651">=</span>&nbsp;<span class="ident" id="4756653">cr</span><span class="op" id="4756655">.</span><span class="ident" id="4756656">r</span><span class="op" id="4756657">.</span><span class="ident" id="4756658">Read</span><span class="op" id="4756662">(</span><span class="ident" id="4756663">rbuf</span><span class="op" id="4756667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4756671">n</span>&nbsp;<span class="op" id="4756673">+=</span>&nbsp;<span class="ident" id="4756676">n0</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4756681">b</span>&nbsp;<span class="op" id="4756683">=</span>&nbsp;<span class="ident" id="4756685">b</span><span class="op" id="4756686">[</span><span class="ident" id="4756687">n0</span><span class="op" id="4756689">:</span><span class="op" id="4756690">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4756694">cr</span><span class="op" id="4756696">.</span><span class="ident" id="4756697">n</span>&nbsp;<span class="op" id="4756699">-=</span>&nbsp;<span class="ident" id="4756702">uint64</span><span class="op" id="4756708">(</span><span class="ident" id="4756709">n0</span><span class="op" id="4756711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4756715">//&nbsp;If&nbsp;we&#39;re&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;chunk,&nbsp;read&nbsp;the&nbsp;next&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4756770">//&nbsp;bytes&nbsp;to&nbsp;verify&nbsp;they&nbsp;are&nbsp;&#34;\r\n&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4756808">if</span>&nbsp;<span class="ident" id="4756811">cr</span><span class="op" id="4756813">.</span><span class="ident" id="4756814">n</span>&nbsp;<span class="op" id="4756816">==</span>&nbsp;<span class="num" id="4756819">0</span>&nbsp;<span class="op" id="4756821">&amp;&amp;</span>&nbsp;<span class="ident" id="4756824">cr</span><span class="op" id="4756826">.</span><span class="ident" id="4756827">err</span>&nbsp;<span class="op" id="4756831">==</span>&nbsp;<span class="builtintype" id="4756834">nil</span>&nbsp;<span class="op" id="4756838">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4756843">if</span>&nbsp;<span class="ident" id="4756846">_</span><span class="op" id="4756847">,</span>&nbsp;<span class="ident" id="4756849">cr</span><span class="op" id="4756851">.</span><span class="ident" id="4756852">err</span>&nbsp;<span class="op" id="4756856">=</span>&nbsp;<span class="ident" id="4756858">io</span><span class="op" id="4756860">.</span><span class="ident" id="4756861">ReadFull</span><span class="op" id="4756869">(</span><span class="ident" id="4756870">cr</span><span class="op" id="4756872">.</span><span class="ident" id="4756873">r</span><span class="op" id="4756874">,</span>&nbsp;<span class="ident" id="4756876">cr</span><span class="op" id="4756878">.</span><span class="ident" id="4756879">buf</span><span class="op" id="4756882">[</span><span class="op" id="4756883">:</span><span class="num" id="4756884">2</span><span class="op" id="4756885">]</span><span class="op" id="4756886">)</span><span class="op" id="4756887">;</span>&nbsp;<span class="ident" id="4756889">cr</span><span class="op" id="4756891">.</span><span class="ident" id="4756892">err</span>&nbsp;<span class="op" id="4756896">==</span>&nbsp;<span class="builtintype" id="4756899">nil</span>&nbsp;<span class="op" id="4756903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4756909">if</span>&nbsp;<span class="ident" id="4756912">cr</span><span class="op" id="4756914">.</span><span class="ident" id="4756915">buf</span><span class="op" id="4756918">[</span><span class="num" id="4756919">0</span><span class="op" id="4756920">]</span>&nbsp;<span class="op" id="4756922">!=</span>&nbsp;<span class="string" id="4756925">&#39;\r&#39;</span>&nbsp;<span class="op" id="4756930">||</span>&nbsp;<span class="ident" id="4756933">cr</span><span class="op" id="4756935">.</span><span class="ident" id="4756936">buf</span><span class="op" id="4756939">[</span><span class="num" id="4756940">1</span><span class="op" id="4756941">]</span>&nbsp;<span class="op" id="4756943">!=</span>&nbsp;<span class="string" id="4756946">&#39;\n&#39;</span>&nbsp;<span class="op" id="4756951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4756958">cr</span><span class="op" id="4756960">.</span><span class="ident" id="4756961">err</span>&nbsp;<span class="op" id="4756965">=</span>&nbsp;<span class="ident" id="4756967">errors</span><span class="op" id="4756973">.</span><span class="ident" id="4756974">New</span><span class="op" id="4756977">(</span><span class="string" id="4756978">&#34;malformed&nbsp;chunked&nbsp;encoding&#34;</span><span class="op" id="4757006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4757012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4757017">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4757021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4757024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4757027">return</span>&nbsp;<span class="ident" id="4757034">n</span><span class="op" id="4757035">,</span>&nbsp;<span class="ident" id="4757037">cr</span><span class="op" id="4757039">.</span><span class="ident" id="4757040">err</span><br>
<span class="lineno"></span><span class="op" id="4757044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4757047">//&nbsp;Read&nbsp;a&nbsp;line&nbsp;of&nbsp;bytes&nbsp;(up&nbsp;to&nbsp;\n)&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="4757090">//&nbsp;Give&nbsp;up&nbsp;if&nbsp;the&nbsp;line&nbsp;exceeds&nbsp;maxLineLength.</span><br>
<span class="lineno"></span><span class="comment" id="4757136">//&nbsp;The&nbsp;returned&nbsp;bytes&nbsp;are&nbsp;a&nbsp;pointer&nbsp;into&nbsp;storage&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4757188">//&nbsp;the&nbsp;bufio,&nbsp;so&nbsp;they&nbsp;are&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;bufio&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="4757252">func</span>&nbsp;<span class="ident" id="4757257">readLine</span><span class="op" id="4757265">(</span><span class="ident" id="4757266">b</span>&nbsp;<span class="op" id="4757268">*</span><span class="ident" id="4757269">bufio</span><span class="op" id="4757274">.</span><span class="ident" id="4757275">Reader</span><span class="op" id="4757281">)</span>&nbsp;<span class="op" id="4757283">(</span><span class="ident" id="4757284">p</span>&nbsp;<span class="op" id="4757286">[</span><span class="op" id="4757287">]</span><span class="builtintype" id="4757288">byte</span><span class="op" id="4757292">,</span>&nbsp;<span class="ident" id="4757294">err</span>&nbsp;<span class="builtintype" id="4757298">error</span><span class="op" id="4757303">)</span>&nbsp;<span class="op" id="4757305">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4757308">if</span>&nbsp;<span class="ident" id="4757311">p</span><span class="op" id="4757312">,</span>&nbsp;<span class="ident" id="4757314">err</span>&nbsp;<span class="op" id="4757318">=</span>&nbsp;<span class="ident" id="4757320">b</span><span class="op" id="4757321">.</span><span class="ident" id="4757322">ReadSlice</span><span class="op" id="4757331">(</span><span class="string" id="4757332">&#39;\n&#39;</span><span class="op" id="4757336">)</span><span class="op" id="4757337">;</span>&nbsp;<span class="ident" id="4757339">err</span>&nbsp;<span class="op" id="4757343">!=</span>&nbsp;<span class="builtintype" id="4757346">nil</span>&nbsp;<span class="op" id="4757350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4757354">//&nbsp;We&nbsp;always&nbsp;know&nbsp;when&nbsp;EOF&nbsp;is&nbsp;coming.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4757394">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;asked&nbsp;for&nbsp;a&nbsp;line,&nbsp;there&nbsp;should&nbsp;be&nbsp;a&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4757455">if</span>&nbsp;<span class="ident" id="4757458">err</span>&nbsp;<span class="op" id="4757462">==</span>&nbsp;<span class="ident" id="4757465">io</span><span class="op" id="4757467">.</span><span class="ident" id="4757468">EOF</span>&nbsp;<span class="op" id="4757472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4757477">err</span>&nbsp;<span class="op" id="4757481">=</span>&nbsp;<span class="ident" id="4757483">io</span><span class="op" id="4757485">.</span><span class="ident" id="4757486">ErrUnexpectedEOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4757505">}</span>&nbsp;<span class="keyword" id="4757507">else</span>&nbsp;<span class="keyword" id="4757512">if</span>&nbsp;<span class="ident" id="4757515">err</span>&nbsp;<span class="op" id="4757519">==</span>&nbsp;<span class="ident" id="4757522">bufio</span><span class="op" id="4757527">.</span><span class="ident" id="4757528">ErrBufferFull</span>&nbsp;<span class="op" id="4757542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4757547">err</span>&nbsp;<span class="op" id="4757551">=</span>&nbsp;<span class="ident" id="4757553">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4757570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4757574">return</span>&nbsp;<span class="builtintype" id="4757581">nil</span><span class="op" id="4757584">,</span>&nbsp;<span class="ident" id="4757586">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4757591">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4757594">if</span>&nbsp;<span class="builtinfunc" id="4757597">len</span><span class="op" id="4757600">(</span><span class="ident" id="4757601">p</span><span class="op" id="4757602">)</span>&nbsp;<span class="op" id="4757604">&gt;=</span>&nbsp;<span class="ident" id="4757607">maxLineLength</span>&nbsp;<span class="op" id="4757621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4757625">return</span>&nbsp;<span class="builtintype" id="4757632">nil</span><span class="op" id="4757635">,</span>&nbsp;<span class="ident" id="4757637">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4757653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4757656">return</span>&nbsp;<span class="ident" id="4757663">trimTrailingWhitespace</span><span class="op" id="4757685">(</span><span class="ident" id="4757686">p</span><span class="op" id="4757687">)</span><span class="op" id="4757688">,</span>&nbsp;<span class="builtintype" id="4757690">nil</span><br>
<span class="lineno"></span><span class="op" id="4757694">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="4757697">func</span>&nbsp;<span class="ident" id="4757702">trimTrailingWhitespace</span><span class="op" id="4757724">(</span><span class="ident" id="4757725">b</span>&nbsp;<span class="op" id="4757727">[</span><span class="op" id="4757728">]</span><span class="builtintype" id="4757729">byte</span><span class="op" id="4757733">)</span>&nbsp;<span class="op" id="4757735">[</span><span class="op" id="4757736">]</span><span class="builtintype" id="4757737">byte</span>&nbsp;<span class="op" id="4757742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4757745">for</span>&nbsp;<span class="builtinfunc" id="4757749">len</span><span class="op" id="4757752">(</span><span class="ident" id="4757753">b</span><span class="op" id="4757754">)</span>&nbsp;<span class="op" id="4757756">&gt;</span>&nbsp;<span class="num" id="4757758">0</span>&nbsp;<span class="op" id="4757760">&amp;&amp;</span>&nbsp;<span class="ident" id="4757763">isASCIISpace</span><span class="op" id="4757775">(</span><span class="ident" id="4757776">b</span><span class="op" id="4757777">[</span><span class="builtinfunc" id="4757778">len</span><span class="op" id="4757781">(</span><span class="ident" id="4757782">b</span><span class="op" id="4757783">)</span><span class="op" id="4757784">-</span><span class="num" id="4757785">1</span><span class="op" id="4757786">]</span><span class="op" id="4757787">)</span>&nbsp;<span class="op" id="4757789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4757793">b</span>&nbsp;<span class="op" id="4757795">=</span>&nbsp;<span class="ident" id="4757797">b</span><span class="op" id="4757798">[</span><span class="op" id="4757799">:</span><span class="builtinfunc" id="4757800">len</span><span class="op" id="4757803">(</span><span class="ident" id="4757804">b</span><span class="op" id="4757805">)</span><span class="op" id="4757806">-</span><span class="num" id="4757807">1</span><span class="op" id="4757808">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4757811">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4757814">return</span>&nbsp;<span class="ident" id="4757821">b</span><br>
<span class="lineno"></span><span class="op" id="4757823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4757826">func</span>&nbsp;<span class="ident" id="4757831">isASCIISpace</span><span class="op" id="4757843">(</span><span class="ident" id="4757844">b</span>&nbsp;<span class="builtintype" id="4757846">byte</span><span class="op" id="4757850">)</span>&nbsp;<span class="builtintype" id="4757852">bool</span>&nbsp;<span class="op" id="4757857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4757860">return</span>&nbsp;<span class="ident" id="4757867">b</span>&nbsp;<span class="op" id="4757869">==</span>&nbsp;<span class="string" id="4757872">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4757876">||</span>&nbsp;<span class="ident" id="4757879">b</span>&nbsp;<span class="op" id="4757881">==</span>&nbsp;<span class="string" id="4757884">&#39;\t&#39;</span>&nbsp;<span class="op" id="4757889">||</span>&nbsp;<span class="ident" id="4757892">b</span>&nbsp;<span class="op" id="4757894">==</span>&nbsp;<span class="string" id="4757897">&#39;\n&#39;</span>&nbsp;<span class="op" id="4757902">||</span>&nbsp;<span class="ident" id="4757905">b</span>&nbsp;<span class="op" id="4757907">==</span>&nbsp;<span class="string" id="4757910">&#39;\r&#39;</span><br>
<span class="lineno">135</span><span class="op" id="4757915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4757918">//&nbsp;NewChunkedWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedWriter&nbsp;that&nbsp;translates&nbsp;writes&nbsp;into&nbsp;HTTP</span><br>
<span class="lineno"></span><span class="comment" id="4757999">//&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;writing&nbsp;them&nbsp;to&nbsp;w.&nbsp;Closing&nbsp;the&nbsp;returned&nbsp;chunkedWriter</span><br>
<span class="lineno"></span><span class="comment" id="4758080">//&nbsp;sends&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;that&nbsp;marks&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;stream.</span><br>
<span class="lineno">140</span><span class="comment" id="4758148">//</span><br>
<span class="lineno"></span><span class="comment" id="4758151">//&nbsp;NewChunkedWriter&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http</span><br>
<span class="lineno"></span><span class="comment" id="4758218">//&nbsp;package&nbsp;adds&nbsp;chunking&nbsp;automatically&nbsp;if&nbsp;handlers&nbsp;don&#39;t&nbsp;set&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4758281">//&nbsp;Content-Length&nbsp;header.&nbsp;Using&nbsp;newChunkedWriter&nbsp;inside&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="4758347">//&nbsp;would&nbsp;result&nbsp;in&nbsp;double&nbsp;chunking&nbsp;or&nbsp;chunking&nbsp;with&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno">145</span><span class="comment" id="4758416">//&nbsp;length,&nbsp;both&nbsp;of&nbsp;which&nbsp;are&nbsp;wrong.</span><br>
<span class="lineno"></span><span class="keyword" id="4758452">func</span>&nbsp;<span class="ident" id="4758457">NewChunkedWriter</span><span class="op" id="4758473">(</span><span class="ident" id="4758474">w</span>&nbsp;<span class="ident" id="4758476">io</span><span class="op" id="4758478">.</span><span class="ident" id="4758479">Writer</span><span class="op" id="4758485">)</span>&nbsp;<span class="ident" id="4758487">io</span><span class="op" id="4758489">.</span><span class="ident" id="4758490">WriteCloser</span>&nbsp;<span class="op" id="4758502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4758505">return</span>&nbsp;<span class="op" id="4758512">&amp;</span><span class="ident" id="4758513">chunkedWriter</span><span class="op" id="4758526">{</span><span class="ident" id="4758527">w</span><span class="op" id="4758528">}</span><br>
<span class="lineno"></span><span class="op" id="4758530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4758533">//&nbsp;Writing&nbsp;to&nbsp;chunkedWriter&nbsp;translates&nbsp;to&nbsp;writing&nbsp;in&nbsp;HTTP&nbsp;chunked&nbsp;Transfer</span><br>
<span class="lineno"></span><span class="comment" id="4758608">//&nbsp;Encoding&nbsp;wire&nbsp;format&nbsp;to&nbsp;the&nbsp;underlying&nbsp;Wire&nbsp;chunkedWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="4758670">type</span>&nbsp;<span class="ident" id="4758675">chunkedWriter</span>&nbsp;<span class="keyword" id="4758689">struct</span>&nbsp;<span class="op" id="4758696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4758699">Wire</span>&nbsp;<span class="ident" id="4758704">io</span><span class="op" id="4758706">.</span><span class="ident" id="4758707">Writer</span><br>
<span class="lineno"></span><span class="op" id="4758714">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4758717">//&nbsp;Write&nbsp;the&nbsp;contents&nbsp;of&nbsp;data&nbsp;as&nbsp;one&nbsp;chunk&nbsp;to&nbsp;Wire.</span><br>
<span class="lineno"></span><span class="comment" id="4758769">//&nbsp;NOTE:&nbsp;Note&nbsp;that&nbsp;the&nbsp;corresponding&nbsp;chunk-writing&nbsp;procedure&nbsp;in&nbsp;Conn.Write&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4758848">//&nbsp;a&nbsp;bug&nbsp;since&nbsp;it&nbsp;does&nbsp;not&nbsp;check&nbsp;for&nbsp;success&nbsp;of&nbsp;io.WriteString</span><br>
<span class="lineno"></span><span class="keyword" id="4758911">func</span>&nbsp;<span class="op" id="4758916">(</span><span class="ident" id="4758917">cw</span>&nbsp;<span class="op" id="4758920">*</span><span class="ident" id="4758921">chunkedWriter</span><span class="op" id="4758934">)</span>&nbsp;<span class="ident" id="4758936">Write</span><span class="op" id="4758941">(</span><span class="ident" id="4758942">data</span>&nbsp;<span class="op" id="4758947">[</span><span class="op" id="4758948">]</span><span class="builtintype" id="4758949">byte</span><span class="op" id="4758953">)</span>&nbsp;<span class="op" id="4758955">(</span><span class="ident" id="4758956">n</span>&nbsp;<span class="builtintype" id="4758958">int</span><span class="op" id="4758961">,</span>&nbsp;<span class="ident" id="4758963">err</span>&nbsp;<span class="builtintype" id="4758967">error</span><span class="op" id="4758972">)</span>&nbsp;<span class="op" id="4758974">{</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4758978">//&nbsp;Don&#39;t&nbsp;send&nbsp;0-length&nbsp;data.&nbsp;It&nbsp;looks&nbsp;like&nbsp;EOF&nbsp;for&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759048">if</span>&nbsp;<span class="builtinfunc" id="4759051">len</span><span class="op" id="4759054">(</span><span class="ident" id="4759055">data</span><span class="op" id="4759059">)</span>&nbsp;<span class="op" id="4759061">==</span>&nbsp;<span class="num" id="4759064">0</span>&nbsp;<span class="op" id="4759066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759070">return</span>&nbsp;<span class="num" id="4759077">0</span><span class="op" id="4759078">,</span>&nbsp;<span class="builtintype" id="4759080">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4759085">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759089">if</span>&nbsp;<span class="ident" id="4759092">_</span><span class="op" id="4759093">,</span>&nbsp;<span class="ident" id="4759095">err</span>&nbsp;<span class="op" id="4759099">=</span>&nbsp;<span class="ident" id="4759101">fmt</span><span class="op" id="4759104">.</span><span class="ident" id="4759105">Fprintf</span><span class="op" id="4759112">(</span><span class="ident" id="4759113">cw</span><span class="op" id="4759115">.</span><span class="ident" id="4759116">Wire</span><span class="op" id="4759120">,</span>&nbsp;<span class="string" id="4759122">&#34;%x\r\n&#34;</span><span class="op" id="4759130">,</span>&nbsp;<span class="builtinfunc" id="4759132">len</span><span class="op" id="4759135">(</span><span class="ident" id="4759136">data</span><span class="op" id="4759140">)</span><span class="op" id="4759141">)</span><span class="op" id="4759142">;</span>&nbsp;<span class="ident" id="4759144">err</span>&nbsp;<span class="op" id="4759148">!=</span>&nbsp;<span class="builtintype" id="4759151">nil</span>&nbsp;<span class="op" id="4759155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759159">return</span>&nbsp;<span class="num" id="4759166">0</span><span class="op" id="4759167">,</span>&nbsp;<span class="ident" id="4759169">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4759174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759177">if</span>&nbsp;<span class="ident" id="4759180">n</span><span class="op" id="4759181">,</span>&nbsp;<span class="ident" id="4759183">err</span>&nbsp;<span class="op" id="4759187">=</span>&nbsp;<span class="ident" id="4759189">cw</span><span class="op" id="4759191">.</span><span class="ident" id="4759192">Wire</span><span class="op" id="4759196">.</span><span class="ident" id="4759197">Write</span><span class="op" id="4759202">(</span><span class="ident" id="4759203">data</span><span class="op" id="4759207">)</span><span class="op" id="4759208">;</span>&nbsp;<span class="ident" id="4759210">err</span>&nbsp;<span class="op" id="4759214">!=</span>&nbsp;<span class="builtintype" id="4759217">nil</span>&nbsp;<span class="op" id="4759221">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759225">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4759233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759236">if</span>&nbsp;<span class="ident" id="4759239">n</span>&nbsp;<span class="op" id="4759241">!=</span>&nbsp;<span class="builtinfunc" id="4759244">len</span><span class="op" id="4759247">(</span><span class="ident" id="4759248">data</span><span class="op" id="4759252">)</span>&nbsp;<span class="op" id="4759254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4759258">err</span>&nbsp;<span class="op" id="4759262">=</span>&nbsp;<span class="ident" id="4759264">io</span><span class="op" id="4759266">.</span><span class="ident" id="4759267">ErrShortWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759283">return</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4759291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4759294">_</span><span class="op" id="4759295">,</span>&nbsp;<span class="ident" id="4759297">err</span>&nbsp;<span class="op" id="4759301">=</span>&nbsp;<span class="ident" id="4759303">io</span><span class="op" id="4759305">.</span><span class="ident" id="4759306">WriteString</span><span class="op" id="4759317">(</span><span class="ident" id="4759318">cw</span><span class="op" id="4759320">.</span><span class="ident" id="4759321">Wire</span><span class="op" id="4759325">,</span>&nbsp;<span class="string" id="4759327">&#34;\r\n&#34;</span><span class="op" id="4759333">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759337">return</span><br>
<span class="lineno"></span><span class="op" id="4759344">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="keyword" id="4759347">func</span>&nbsp;<span class="op" id="4759352">(</span><span class="ident" id="4759353">cw</span>&nbsp;<span class="op" id="4759356">*</span><span class="ident" id="4759357">chunkedWriter</span><span class="op" id="4759370">)</span>&nbsp;<span class="ident" id="4759372">Close</span><span class="op" id="4759377">(</span><span class="op" id="4759378">)</span>&nbsp;<span class="builtintype" id="4759380">error</span>&nbsp;<span class="op" id="4759386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4759389">_</span><span class="op" id="4759390">,</span>&nbsp;<span class="ident" id="4759392">err</span>&nbsp;<span class="op" id="4759396">:=</span>&nbsp;<span class="ident" id="4759399">io</span><span class="op" id="4759401">.</span><span class="ident" id="4759402">WriteString</span><span class="op" id="4759413">(</span><span class="ident" id="4759414">cw</span><span class="op" id="4759416">.</span><span class="ident" id="4759417">Wire</span><span class="op" id="4759421">,</span>&nbsp;<span class="string" id="4759423">&#34;0\r\n&#34;</span><span class="op" id="4759430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759433">return</span>&nbsp;<span class="ident" id="4759440">err</span><br>
<span class="lineno"></span><span class="op" id="4759444">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="4759447">func</span>&nbsp;<span class="ident" id="4759452">parseHexUint</span><span class="op" id="4759464">(</span><span class="ident" id="4759465">v</span>&nbsp;<span class="op" id="4759467">[</span><span class="op" id="4759468">]</span><span class="builtintype" id="4759469">byte</span><span class="op" id="4759473">)</span>&nbsp;<span class="op" id="4759475">(</span><span class="ident" id="4759476">n</span>&nbsp;<span class="ident" id="4759478">uint64</span><span class="op" id="4759484">,</span>&nbsp;<span class="ident" id="4759486">err</span>&nbsp;<span class="builtintype" id="4759490">error</span><span class="op" id="4759495">)</span>&nbsp;<span class="op" id="4759497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759500">for</span>&nbsp;<span class="ident" id="4759504">_</span><span class="op" id="4759505">,</span>&nbsp;<span class="ident" id="4759507">b</span>&nbsp;<span class="op" id="4759509">:=</span>&nbsp;<span class="keyword" id="4759512">range</span>&nbsp;<span class="ident" id="4759518">v</span>&nbsp;<span class="op" id="4759520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4759524">n</span>&nbsp;<span class="op" id="4759526">&lt;&lt;=</span>&nbsp;<span class="num" id="4759530">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759534">switch</span>&nbsp;<span class="op" id="4759541">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759545">case</span>&nbsp;<span class="string" id="4759550">&#39;0&#39;</span>&nbsp;<span class="op" id="4759554">&lt;=</span>&nbsp;<span class="ident" id="4759557">b</span>&nbsp;<span class="op" id="4759559">&amp;&amp;</span>&nbsp;<span class="ident" id="4759562">b</span>&nbsp;<span class="op" id="4759564">&lt;=</span>&nbsp;<span class="string" id="4759567">&#39;9&#39;</span><span class="op" id="4759570">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4759575">b</span>&nbsp;<span class="op" id="4759577">=</span>&nbsp;<span class="ident" id="4759579">b</span>&nbsp;<span class="op" id="4759581">-</span>&nbsp;<span class="string" id="4759583">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759589">case</span>&nbsp;<span class="string" id="4759594">&#39;a&#39;</span>&nbsp;<span class="op" id="4759598">&lt;=</span>&nbsp;<span class="ident" id="4759601">b</span>&nbsp;<span class="op" id="4759603">&amp;&amp;</span>&nbsp;<span class="ident" id="4759606">b</span>&nbsp;<span class="op" id="4759608">&lt;=</span>&nbsp;<span class="string" id="4759611">&#39;f&#39;</span><span class="op" id="4759614">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4759619">b</span>&nbsp;<span class="op" id="4759621">=</span>&nbsp;<span class="ident" id="4759623">b</span>&nbsp;<span class="op" id="4759625">-</span>&nbsp;<span class="string" id="4759627">&#39;a&#39;</span>&nbsp;<span class="op" id="4759631">+</span>&nbsp;<span class="num" id="4759633">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759638">case</span>&nbsp;<span class="string" id="4759643">&#39;A&#39;</span>&nbsp;<span class="op" id="4759647">&lt;=</span>&nbsp;<span class="ident" id="4759650">b</span>&nbsp;<span class="op" id="4759652">&amp;&amp;</span>&nbsp;<span class="ident" id="4759655">b</span>&nbsp;<span class="op" id="4759657">&lt;=</span>&nbsp;<span class="string" id="4759660">&#39;F&#39;</span><span class="op" id="4759663">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4759668">b</span>&nbsp;<span class="op" id="4759670">=</span>&nbsp;<span class="ident" id="4759672">b</span>&nbsp;<span class="op" id="4759674">-</span>&nbsp;<span class="string" id="4759676">&#39;A&#39;</span>&nbsp;<span class="op" id="4759680">+</span>&nbsp;<span class="num" id="4759682">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759687">default</span><span class="op" id="4759694">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759699">return</span>&nbsp;<span class="num" id="4759706">0</span><span class="op" id="4759707">,</span>&nbsp;<span class="ident" id="4759709">errors</span><span class="op" id="4759715">.</span><span class="ident" id="4759716">New</span><span class="op" id="4759719">(</span><span class="string" id="4759720">&#34;invalid&nbsp;byte&nbsp;in&nbsp;chunk&nbsp;length&#34;</span><span class="op" id="4759750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4759754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4759758">n</span>&nbsp;<span class="op" id="4759760">|=</span>&nbsp;<span class="ident" id="4759763">uint64</span><span class="op" id="4759769">(</span><span class="ident" id="4759770">b</span><span class="op" id="4759771">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4759774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4759777">return</span><br>
<span class="lineno"></span><span class="op" id="4759784">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
