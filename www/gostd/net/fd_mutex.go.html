<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html" class="current">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3725530">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3725585">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3725639">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3725690">package</span>&nbsp;<span class="ident" id="3725698">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3725703">import</span>&nbsp;<span class="string" id="3725710">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3725725">//&nbsp;fdMutex&nbsp;is&nbsp;a&nbsp;specialized&nbsp;synchronization&nbsp;primitive</span><br>
<span class="lineno">10</span><span class="comment" id="3725779">//&nbsp;that&nbsp;manages&nbsp;lifetime&nbsp;of&nbsp;an&nbsp;fd&nbsp;and&nbsp;serializes&nbsp;access</span><br>
<span class="lineno"></span><span class="comment" id="3725835">//&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods&nbsp;on&nbsp;netFD.</span><br>
<span class="lineno"></span><span class="keyword" id="3725874">type</span>&nbsp;<span class="ident" id="3725879">fdMutex</span>&nbsp;<span class="keyword" id="3725887">struct</span>&nbsp;<span class="op" id="3725894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3725897">state</span>&nbsp;<span class="builtintype" id="3725903">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3725911">rsema</span>&nbsp;<span class="builtintype" id="3725917">uint32</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3725925">wsema</span>&nbsp;<span class="builtintype" id="3725931">uint32</span><br>
<span class="lineno"></span><span class="op" id="3725938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3725941">//&nbsp;fdMutex.state&nbsp;is&nbsp;organized&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="3725983">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;whether&nbsp;netFD&nbsp;is&nbsp;closed,&nbsp;if&nbsp;set&nbsp;all&nbsp;subsequent&nbsp;lock&nbsp;operations&nbsp;will&nbsp;fail.</span><br>
<span class="lineno">20</span><span class="comment" id="3726068">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;read&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3726105">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;write&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3726143">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;total&nbsp;number&nbsp;of&nbsp;references&nbsp;(read+write+misc).</span><br>
<span class="lineno"></span><span class="comment" id="3726202">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;read&nbsp;waiters.</span><br>
<span class="lineno"></span><span class="comment" id="3726251">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno">25</span><span class="keyword" id="3726301">const</span>&nbsp;<span class="op" id="3726307">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3726310">mutexClosed</span>&nbsp;&nbsp;<span class="op" id="3726323">=</span>&nbsp;<span class="num" id="3726325">1</span>&nbsp;<span class="op" id="3726327">&lt;&lt;</span>&nbsp;<span class="num" id="3726330">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3726333">mutexRLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3726346">=</span>&nbsp;<span class="num" id="3726348">1</span>&nbsp;<span class="op" id="3726350">&lt;&lt;</span>&nbsp;<span class="num" id="3726353">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3726356">mutexWLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3726369">=</span>&nbsp;<span class="num" id="3726371">1</span>&nbsp;<span class="op" id="3726373">&lt;&lt;</span>&nbsp;<span class="num" id="3726376">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3726379">mutexRef</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3726392">=</span>&nbsp;<span class="num" id="3726394">1</span>&nbsp;<span class="op" id="3726396">&lt;&lt;</span>&nbsp;<span class="num" id="3726399">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3726402">mutexRefMask</span>&nbsp;<span class="op" id="3726415">=</span>&nbsp;<span class="op" id="3726417">(</span><span class="num" id="3726418">1</span><span class="op" id="3726419">&lt;&lt;</span><span class="num" id="3726421">20</span>&nbsp;<span class="op" id="3726424">-</span>&nbsp;<span class="num" id="3726426">1</span><span class="op" id="3726427">)</span>&nbsp;<span class="op" id="3726429">&lt;&lt;</span>&nbsp;<span class="num" id="3726432">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3726435">mutexRWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3726448">=</span>&nbsp;<span class="num" id="3726450">1</span>&nbsp;<span class="op" id="3726452">&lt;&lt;</span>&nbsp;<span class="num" id="3726455">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3726459">mutexRMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3726472">=</span>&nbsp;<span class="op" id="3726474">(</span><span class="num" id="3726475">1</span><span class="op" id="3726476">&lt;&lt;</span><span class="num" id="3726478">20</span>&nbsp;<span class="op" id="3726481">-</span>&nbsp;<span class="num" id="3726483">1</span><span class="op" id="3726484">)</span>&nbsp;<span class="op" id="3726486">&lt;&lt;</span>&nbsp;<span class="num" id="3726489">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3726493">mutexWWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3726506">=</span>&nbsp;<span class="num" id="3726508">1</span>&nbsp;<span class="op" id="3726510">&lt;&lt;</span>&nbsp;<span class="num" id="3726513">43</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3726517">mutexWMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3726530">=</span>&nbsp;<span class="op" id="3726532">(</span><span class="num" id="3726533">1</span><span class="op" id="3726534">&lt;&lt;</span><span class="num" id="3726536">20</span>&nbsp;<span class="op" id="3726539">-</span>&nbsp;<span class="num" id="3726541">1</span><span class="op" id="3726542">)</span>&nbsp;<span class="op" id="3726544">&lt;&lt;</span>&nbsp;<span class="num" id="3726547">43</span><br>
<span class="lineno">35</span><span class="op" id="3726550">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3726553">//&nbsp;Read&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(true)/RWUnlock(true).</span><br>
<span class="lineno"></span><span class="comment" id="3726609">//&nbsp;Write&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(false)/RWUnlock(false).</span><br>
<span class="lineno"></span><span class="comment" id="3726668">//&nbsp;Misc&nbsp;operations&nbsp;must&nbsp;do&nbsp;Incref/Decref.&nbsp;Misc&nbsp;operations&nbsp;include&nbsp;functions&nbsp;like</span><br>
<span class="lineno">40</span><span class="comment" id="3726749">//&nbsp;setsockopt&nbsp;and&nbsp;setDeadline.&nbsp;They&nbsp;need&nbsp;to&nbsp;use&nbsp;Incref/Decref&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3726826">//&nbsp;they&nbsp;operate&nbsp;on&nbsp;the&nbsp;correct&nbsp;fd&nbsp;in&nbsp;presence&nbsp;of&nbsp;a&nbsp;concurrent&nbsp;Close&nbsp;call</span><br>
<span class="lineno"></span><span class="comment" id="3726899">//&nbsp;(otherwise&nbsp;fd&nbsp;can&nbsp;be&nbsp;closed&nbsp;under&nbsp;their&nbsp;feet).</span><br>
<span class="lineno"></span><span class="comment" id="3726949">//&nbsp;Close&nbsp;operation&nbsp;must&nbsp;do&nbsp;IncrefAndClose/Decref.</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="3727000">//&nbsp;RWLock/Incref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;open.</span><br>
<span class="lineno"></span><span class="comment" id="3727044">//&nbsp;RWUnlock/Decref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;closed&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;remaining&nbsp;references.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3727131">func</span>&nbsp;<span class="op" id="3727136">(</span><span class="ident" id="3727137">mu</span>&nbsp;<span class="op" id="3727140">*</span><span class="ident" id="3727141">fdMutex</span><span class="op" id="3727148">)</span>&nbsp;<span class="ident" id="3727150">Incref</span><span class="op" id="3727156">(</span><span class="op" id="3727157">)</span>&nbsp;<span class="builtintype" id="3727159">bool</span>&nbsp;<span class="op" id="3727164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3727167">for</span>&nbsp;<span class="op" id="3727171">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3727175">old</span>&nbsp;<span class="op" id="3727179">:=</span>&nbsp;<span class="ident" id="3727182">atomic</span><span class="op" id="3727188">.</span><span class="ident" id="3727189">LoadUint64</span><span class="op" id="3727199">(</span><span class="op" id="3727200">&amp;</span><span class="ident" id="3727201">mu</span><span class="op" id="3727203">.</span><span class="ident" id="3727204">state</span><span class="op" id="3727209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3727213">if</span>&nbsp;<span class="ident" id="3727216">old</span><span class="op" id="3727219">&amp;</span><span class="ident" id="3727220">mutexClosed</span>&nbsp;<span class="op" id="3727232">!=</span>&nbsp;<span class="num" id="3727235">0</span>&nbsp;<span class="op" id="3727237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3727242">return</span>&nbsp;<span class="builtintype" id="3727249">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3727257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3727261">new</span>&nbsp;<span class="op" id="3727265">:=</span>&nbsp;<span class="ident" id="3727268">old</span>&nbsp;<span class="op" id="3727272">+</span>&nbsp;<span class="ident" id="3727274">mutexRef</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3727285">if</span>&nbsp;<span class="builtinfunc" id="3727288">new</span><span class="op" id="3727291">&amp;</span><span class="ident" id="3727292">mutexRefMask</span>&nbsp;<span class="op" id="3727305">==</span>&nbsp;<span class="num" id="3727308">0</span>&nbsp;<span class="op" id="3727310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3727315">panic</span><span class="op" id="3727320">(</span><span class="string" id="3727321">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3727348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3727352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3727356">if</span>&nbsp;<span class="ident" id="3727359">atomic</span><span class="op" id="3727365">.</span><span class="ident" id="3727366">CompareAndSwapUint64</span><span class="op" id="3727386">(</span><span class="op" id="3727387">&amp;</span><span class="ident" id="3727388">mu</span><span class="op" id="3727390">.</span><span class="ident" id="3727391">state</span><span class="op" id="3727396">,</span>&nbsp;<span class="ident" id="3727398">old</span><span class="op" id="3727401">,</span>&nbsp;<span class="builtinfunc" id="3727403">new</span><span class="op" id="3727406">)</span>&nbsp;<span class="op" id="3727408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3727413">return</span>&nbsp;<span class="builtintype" id="3727420">true</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3727427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3727430">}</span><br>
<span class="lineno"></span><span class="op" id="3727432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3727435">func</span>&nbsp;<span class="op" id="3727440">(</span><span class="ident" id="3727441">mu</span>&nbsp;<span class="op" id="3727444">*</span><span class="ident" id="3727445">fdMutex</span><span class="op" id="3727452">)</span>&nbsp;<span class="ident" id="3727454">IncrefAndClose</span><span class="op" id="3727468">(</span><span class="op" id="3727469">)</span>&nbsp;<span class="builtintype" id="3727471">bool</span>&nbsp;<span class="op" id="3727476">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3727479">for</span>&nbsp;<span class="op" id="3727483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3727487">old</span>&nbsp;<span class="op" id="3727491">:=</span>&nbsp;<span class="ident" id="3727494">atomic</span><span class="op" id="3727500">.</span><span class="ident" id="3727501">LoadUint64</span><span class="op" id="3727511">(</span><span class="op" id="3727512">&amp;</span><span class="ident" id="3727513">mu</span><span class="op" id="3727515">.</span><span class="ident" id="3727516">state</span><span class="op" id="3727521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3727525">if</span>&nbsp;<span class="ident" id="3727528">old</span><span class="op" id="3727531">&amp;</span><span class="ident" id="3727532">mutexClosed</span>&nbsp;<span class="op" id="3727544">!=</span>&nbsp;<span class="num" id="3727547">0</span>&nbsp;<span class="op" id="3727549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3727554">return</span>&nbsp;<span class="builtintype" id="3727561">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3727569">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3727573">//&nbsp;Mark&nbsp;as&nbsp;closed&nbsp;and&nbsp;acquire&nbsp;a&nbsp;reference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3727618">new</span>&nbsp;<span class="op" id="3727622">:=</span>&nbsp;<span class="op" id="3727625">(</span><span class="ident" id="3727626">old</span>&nbsp;<span class="op" id="3727630">|</span>&nbsp;<span class="ident" id="3727632">mutexClosed</span><span class="op" id="3727643">)</span>&nbsp;<span class="op" id="3727645">+</span>&nbsp;<span class="ident" id="3727647">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3727658">if</span>&nbsp;<span class="builtinfunc" id="3727661">new</span><span class="op" id="3727664">&amp;</span><span class="ident" id="3727665">mutexRefMask</span>&nbsp;<span class="op" id="3727678">==</span>&nbsp;<span class="num" id="3727681">0</span>&nbsp;<span class="op" id="3727683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3727688">panic</span><span class="op" id="3727693">(</span><span class="string" id="3727694">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3727721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3727725">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3727729">//&nbsp;Remove&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3727769">new</span>&nbsp;<span class="op" id="3727773">&amp;^=</span>&nbsp;<span class="ident" id="3727777">mutexRMask</span>&nbsp;<span class="op" id="3727788">|</span>&nbsp;<span class="ident" id="3727790">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3727803">if</span>&nbsp;<span class="ident" id="3727806">atomic</span><span class="op" id="3727812">.</span><span class="ident" id="3727813">CompareAndSwapUint64</span><span class="op" id="3727833">(</span><span class="op" id="3727834">&amp;</span><span class="ident" id="3727835">mu</span><span class="op" id="3727837">.</span><span class="ident" id="3727838">state</span><span class="op" id="3727843">,</span>&nbsp;<span class="ident" id="3727845">old</span><span class="op" id="3727848">,</span>&nbsp;<span class="builtinfunc" id="3727850">new</span><span class="op" id="3727853">)</span>&nbsp;<span class="op" id="3727855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3727860">//&nbsp;Wake&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3727899">//&nbsp;they&nbsp;will&nbsp;observe&nbsp;closed&nbsp;flag&nbsp;after&nbsp;wakeup.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3727949">for</span>&nbsp;<span class="ident" id="3727953">old</span><span class="op" id="3727956">&amp;</span><span class="ident" id="3727957">mutexRMask</span>&nbsp;<span class="op" id="3727968">!=</span>&nbsp;<span class="num" id="3727971">0</span>&nbsp;<span class="op" id="3727973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3727979">old</span>&nbsp;<span class="op" id="3727983">-=</span>&nbsp;<span class="ident" id="3727986">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3728001">runtime_Semrelease</span><span class="op" id="3728019">(</span><span class="op" id="3728020">&amp;</span><span class="ident" id="3728021">mu</span><span class="op" id="3728023">.</span><span class="ident" id="3728024">rsema</span><span class="op" id="3728029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3728034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3728039">for</span>&nbsp;<span class="ident" id="3728043">old</span><span class="op" id="3728046">&amp;</span><span class="ident" id="3728047">mutexWMask</span>&nbsp;<span class="op" id="3728058">!=</span>&nbsp;<span class="num" id="3728061">0</span>&nbsp;<span class="op" id="3728063">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3728069">old</span>&nbsp;<span class="op" id="3728073">-=</span>&nbsp;<span class="ident" id="3728076">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3728091">runtime_Semrelease</span><span class="op" id="3728109">(</span><span class="op" id="3728110">&amp;</span><span class="ident" id="3728111">mu</span><span class="op" id="3728113">.</span><span class="ident" id="3728114">wsema</span><span class="op" id="3728119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3728124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3728129">return</span>&nbsp;<span class="builtintype" id="3728136">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3728143">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3728146">}</span><br>
<span class="lineno"></span><span class="op" id="3728148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3728151">func</span>&nbsp;<span class="op" id="3728156">(</span><span class="ident" id="3728157">mu</span>&nbsp;<span class="op" id="3728160">*</span><span class="ident" id="3728161">fdMutex</span><span class="op" id="3728168">)</span>&nbsp;<span class="ident" id="3728170">Decref</span><span class="op" id="3728176">(</span><span class="op" id="3728177">)</span>&nbsp;<span class="builtintype" id="3728179">bool</span>&nbsp;<span class="op" id="3728184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3728187">for</span>&nbsp;<span class="op" id="3728191">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3728195">old</span>&nbsp;<span class="op" id="3728199">:=</span>&nbsp;<span class="ident" id="3728202">atomic</span><span class="op" id="3728208">.</span><span class="ident" id="3728209">LoadUint64</span><span class="op" id="3728219">(</span><span class="op" id="3728220">&amp;</span><span class="ident" id="3728221">mu</span><span class="op" id="3728223">.</span><span class="ident" id="3728224">state</span><span class="op" id="3728229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3728233">if</span>&nbsp;<span class="ident" id="3728236">old</span><span class="op" id="3728239">&amp;</span><span class="ident" id="3728240">mutexRefMask</span>&nbsp;<span class="op" id="3728253">==</span>&nbsp;<span class="num" id="3728256">0</span>&nbsp;<span class="op" id="3728258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3728263">panic</span><span class="op" id="3728268">(</span><span class="string" id="3728269">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3728296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3728300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3728304">new</span>&nbsp;<span class="op" id="3728308">:=</span>&nbsp;<span class="ident" id="3728311">old</span>&nbsp;<span class="op" id="3728315">-</span>&nbsp;<span class="ident" id="3728317">mutexRef</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3728328">if</span>&nbsp;<span class="ident" id="3728331">atomic</span><span class="op" id="3728337">.</span><span class="ident" id="3728338">CompareAndSwapUint64</span><span class="op" id="3728358">(</span><span class="op" id="3728359">&amp;</span><span class="ident" id="3728360">mu</span><span class="op" id="3728362">.</span><span class="ident" id="3728363">state</span><span class="op" id="3728368">,</span>&nbsp;<span class="ident" id="3728370">old</span><span class="op" id="3728373">,</span>&nbsp;<span class="builtinfunc" id="3728375">new</span><span class="op" id="3728378">)</span>&nbsp;<span class="op" id="3728380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3728385">return</span>&nbsp;<span class="builtinfunc" id="3728392">new</span><span class="op" id="3728395">&amp;</span><span class="op" id="3728396">(</span><span class="ident" id="3728397">mutexClosed</span><span class="op" id="3728408">|</span><span class="ident" id="3728409">mutexRefMask</span><span class="op" id="3728421">)</span>&nbsp;<span class="op" id="3728423">==</span>&nbsp;<span class="ident" id="3728426">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3728440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3728443">}</span><br>
<span class="lineno"></span><span class="op" id="3728445">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="3728448">func</span>&nbsp;<span class="op" id="3728453">(</span><span class="ident" id="3728454">mu</span>&nbsp;<span class="op" id="3728457">*</span><span class="ident" id="3728458">fdMutex</span><span class="op" id="3728465">)</span>&nbsp;<span class="ident" id="3728467">RWLock</span><span class="op" id="3728473">(</span><span class="ident" id="3728474">read</span>&nbsp;<span class="builtintype" id="3728479">bool</span><span class="op" id="3728483">)</span>&nbsp;<span class="builtintype" id="3728485">bool</span>&nbsp;<span class="op" id="3728490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3728493">var</span>&nbsp;<span class="ident" id="3728497">mutexBit</span><span class="op" id="3728505">,</span>&nbsp;<span class="ident" id="3728507">mutexWait</span><span class="op" id="3728516">,</span>&nbsp;<span class="ident" id="3728518">mutexMask</span>&nbsp;<span class="builtintype" id="3728528">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3728536">var</span>&nbsp;<span class="ident" id="3728540">mutexSema</span>&nbsp;<span class="op" id="3728550">*</span><span class="builtintype" id="3728551">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3728559">if</span>&nbsp;<span class="ident" id="3728562">read</span>&nbsp;<span class="op" id="3728567">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3728571">mutexBit</span>&nbsp;<span class="op" id="3728580">=</span>&nbsp;<span class="ident" id="3728582">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3728595">mutexWait</span>&nbsp;<span class="op" id="3728605">=</span>&nbsp;<span class="ident" id="3728607">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3728620">mutexMask</span>&nbsp;<span class="op" id="3728630">=</span>&nbsp;<span class="ident" id="3728632">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3728645">mutexSema</span>&nbsp;<span class="op" id="3728655">=</span>&nbsp;<span class="op" id="3728657">&amp;</span><span class="ident" id="3728658">mu</span><span class="op" id="3728660">.</span><span class="ident" id="3728661">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3728668">}</span>&nbsp;<span class="keyword" id="3728670">else</span>&nbsp;<span class="op" id="3728675">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3728679">mutexBit</span>&nbsp;<span class="op" id="3728688">=</span>&nbsp;<span class="ident" id="3728690">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3728703">mutexWait</span>&nbsp;<span class="op" id="3728713">=</span>&nbsp;<span class="ident" id="3728715">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3728728">mutexMask</span>&nbsp;<span class="op" id="3728738">=</span>&nbsp;<span class="ident" id="3728740">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3728753">mutexSema</span>&nbsp;<span class="op" id="3728763">=</span>&nbsp;<span class="op" id="3728765">&amp;</span><span class="ident" id="3728766">mu</span><span class="op" id="3728768">.</span><span class="ident" id="3728769">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3728776">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3728779">for</span>&nbsp;<span class="op" id="3728783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3728787">old</span>&nbsp;<span class="op" id="3728791">:=</span>&nbsp;<span class="ident" id="3728794">atomic</span><span class="op" id="3728800">.</span><span class="ident" id="3728801">LoadUint64</span><span class="op" id="3728811">(</span><span class="op" id="3728812">&amp;</span><span class="ident" id="3728813">mu</span><span class="op" id="3728815">.</span><span class="ident" id="3728816">state</span><span class="op" id="3728821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3728825">if</span>&nbsp;<span class="ident" id="3728828">old</span><span class="op" id="3728831">&amp;</span><span class="ident" id="3728832">mutexClosed</span>&nbsp;<span class="op" id="3728844">!=</span>&nbsp;<span class="num" id="3728847">0</span>&nbsp;<span class="op" id="3728849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3728854">return</span>&nbsp;<span class="builtintype" id="3728861">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3728869">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3728873">var</span>&nbsp;<span class="builtinfunc" id="3728877">new</span>&nbsp;<span class="builtintype" id="3728881">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3728890">if</span>&nbsp;<span class="ident" id="3728893">old</span><span class="op" id="3728896">&amp;</span><span class="ident" id="3728897">mutexBit</span>&nbsp;<span class="op" id="3728906">==</span>&nbsp;<span class="num" id="3728909">0</span>&nbsp;<span class="op" id="3728911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3728916">//&nbsp;Lock&nbsp;is&nbsp;free,&nbsp;acquire&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3728948">new</span>&nbsp;<span class="op" id="3728952">=</span>&nbsp;<span class="op" id="3728954">(</span><span class="ident" id="3728955">old</span>&nbsp;<span class="op" id="3728959">|</span>&nbsp;<span class="ident" id="3728961">mutexBit</span><span class="op" id="3728969">)</span>&nbsp;<span class="op" id="3728971">+</span>&nbsp;<span class="ident" id="3728973">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3728985">if</span>&nbsp;<span class="builtinfunc" id="3728988">new</span><span class="op" id="3728991">&amp;</span><span class="ident" id="3728992">mutexRefMask</span>&nbsp;<span class="op" id="3729005">==</span>&nbsp;<span class="num" id="3729008">0</span>&nbsp;<span class="op" id="3729010">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3729016">panic</span><span class="op" id="3729021">(</span><span class="string" id="3729022">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3729049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3729054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3729058">}</span>&nbsp;<span class="keyword" id="3729060">else</span>&nbsp;<span class="op" id="3729065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3729070">//&nbsp;Wait&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3729091">new</span>&nbsp;<span class="op" id="3729095">=</span>&nbsp;<span class="ident" id="3729097">old</span>&nbsp;<span class="op" id="3729101">+</span>&nbsp;<span class="ident" id="3729103">mutexWait</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3729116">if</span>&nbsp;<span class="builtinfunc" id="3729119">new</span><span class="op" id="3729122">&amp;</span><span class="ident" id="3729123">mutexMask</span>&nbsp;<span class="op" id="3729133">==</span>&nbsp;<span class="num" id="3729136">0</span>&nbsp;<span class="op" id="3729138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3729144">panic</span><span class="op" id="3729149">(</span><span class="string" id="3729150">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3729177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3729182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3729186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3729190">if</span>&nbsp;<span class="ident" id="3729193">atomic</span><span class="op" id="3729199">.</span><span class="ident" id="3729200">CompareAndSwapUint64</span><span class="op" id="3729220">(</span><span class="op" id="3729221">&amp;</span><span class="ident" id="3729222">mu</span><span class="op" id="3729224">.</span><span class="ident" id="3729225">state</span><span class="op" id="3729230">,</span>&nbsp;<span class="ident" id="3729232">old</span><span class="op" id="3729235">,</span>&nbsp;<span class="builtinfunc" id="3729237">new</span><span class="op" id="3729240">)</span>&nbsp;<span class="op" id="3729242">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3729247">if</span>&nbsp;<span class="ident" id="3729250">old</span><span class="op" id="3729253">&amp;</span><span class="ident" id="3729254">mutexBit</span>&nbsp;<span class="op" id="3729263">==</span>&nbsp;<span class="num" id="3729266">0</span>&nbsp;<span class="op" id="3729268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3729274">return</span>&nbsp;<span class="builtintype" id="3729281">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3729289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3729294">runtime_Semacquire</span><span class="op" id="3729312">(</span><span class="ident" id="3729313">mutexSema</span><span class="op" id="3729322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3729327">//&nbsp;The&nbsp;signaller&nbsp;has&nbsp;subtracted&nbsp;mutexWait.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3729372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3729375">}</span><br>
<span class="lineno"></span><span class="op" id="3729377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3729380">func</span>&nbsp;<span class="op" id="3729385">(</span><span class="ident" id="3729386">mu</span>&nbsp;<span class="op" id="3729389">*</span><span class="ident" id="3729390">fdMutex</span><span class="op" id="3729397">)</span>&nbsp;<span class="ident" id="3729399">RWUnlock</span><span class="op" id="3729407">(</span><span class="ident" id="3729408">read</span>&nbsp;<span class="builtintype" id="3729413">bool</span><span class="op" id="3729417">)</span>&nbsp;<span class="builtintype" id="3729419">bool</span>&nbsp;<span class="op" id="3729424">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3729427">var</span>&nbsp;<span class="ident" id="3729431">mutexBit</span><span class="op" id="3729439">,</span>&nbsp;<span class="ident" id="3729441">mutexWait</span><span class="op" id="3729450">,</span>&nbsp;<span class="ident" id="3729452">mutexMask</span>&nbsp;<span class="builtintype" id="3729462">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3729470">var</span>&nbsp;<span class="ident" id="3729474">mutexSema</span>&nbsp;<span class="op" id="3729484">*</span><span class="builtintype" id="3729485">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3729493">if</span>&nbsp;<span class="ident" id="3729496">read</span>&nbsp;<span class="op" id="3729501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3729505">mutexBit</span>&nbsp;<span class="op" id="3729514">=</span>&nbsp;<span class="ident" id="3729516">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3729529">mutexWait</span>&nbsp;<span class="op" id="3729539">=</span>&nbsp;<span class="ident" id="3729541">mutexRWait</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3729554">mutexMask</span>&nbsp;<span class="op" id="3729564">=</span>&nbsp;<span class="ident" id="3729566">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3729579">mutexSema</span>&nbsp;<span class="op" id="3729589">=</span>&nbsp;<span class="op" id="3729591">&amp;</span><span class="ident" id="3729592">mu</span><span class="op" id="3729594">.</span><span class="ident" id="3729595">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3729602">}</span>&nbsp;<span class="keyword" id="3729604">else</span>&nbsp;<span class="op" id="3729609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3729613">mutexBit</span>&nbsp;<span class="op" id="3729622">=</span>&nbsp;<span class="ident" id="3729624">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3729637">mutexWait</span>&nbsp;<span class="op" id="3729647">=</span>&nbsp;<span class="ident" id="3729649">mutexWWait</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3729662">mutexMask</span>&nbsp;<span class="op" id="3729672">=</span>&nbsp;<span class="ident" id="3729674">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3729687">mutexSema</span>&nbsp;<span class="op" id="3729697">=</span>&nbsp;<span class="op" id="3729699">&amp;</span><span class="ident" id="3729700">mu</span><span class="op" id="3729702">.</span><span class="ident" id="3729703">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3729710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3729713">for</span>&nbsp;<span class="op" id="3729717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3729721">old</span>&nbsp;<span class="op" id="3729725">:=</span>&nbsp;<span class="ident" id="3729728">atomic</span><span class="op" id="3729734">.</span><span class="ident" id="3729735">LoadUint64</span><span class="op" id="3729745">(</span><span class="op" id="3729746">&amp;</span><span class="ident" id="3729747">mu</span><span class="op" id="3729749">.</span><span class="ident" id="3729750">state</span><span class="op" id="3729755">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3729759">if</span>&nbsp;<span class="ident" id="3729762">old</span><span class="op" id="3729765">&amp;</span><span class="ident" id="3729766">mutexBit</span>&nbsp;<span class="op" id="3729775">==</span>&nbsp;<span class="num" id="3729778">0</span>&nbsp;<span class="op" id="3729780">||</span>&nbsp;<span class="ident" id="3729783">old</span><span class="op" id="3729786">&amp;</span><span class="ident" id="3729787">mutexRefMask</span>&nbsp;<span class="op" id="3729800">==</span>&nbsp;<span class="num" id="3729803">0</span>&nbsp;<span class="op" id="3729805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3729810">panic</span><span class="op" id="3729815">(</span><span class="string" id="3729816">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3729843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3729847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3729851">//&nbsp;Drop&nbsp;lock,&nbsp;drop&nbsp;reference&nbsp;and&nbsp;wake&nbsp;read&nbsp;waiter&nbsp;if&nbsp;present.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3729915">new</span>&nbsp;<span class="op" id="3729919">:=</span>&nbsp;<span class="op" id="3729922">(</span><span class="ident" id="3729923">old</span>&nbsp;<span class="op" id="3729927">&amp;^</span>&nbsp;<span class="ident" id="3729930">mutexBit</span><span class="op" id="3729938">)</span>&nbsp;<span class="op" id="3729940">-</span>&nbsp;<span class="ident" id="3729942">mutexRef</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3729953">if</span>&nbsp;<span class="ident" id="3729956">old</span><span class="op" id="3729959">&amp;</span><span class="ident" id="3729960">mutexMask</span>&nbsp;<span class="op" id="3729970">!=</span>&nbsp;<span class="num" id="3729973">0</span>&nbsp;<span class="op" id="3729975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3729980">new</span>&nbsp;<span class="op" id="3729984">-=</span>&nbsp;<span class="ident" id="3729987">mutexWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3729999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3730003">if</span>&nbsp;<span class="ident" id="3730006">atomic</span><span class="op" id="3730012">.</span><span class="ident" id="3730013">CompareAndSwapUint64</span><span class="op" id="3730033">(</span><span class="op" id="3730034">&amp;</span><span class="ident" id="3730035">mu</span><span class="op" id="3730037">.</span><span class="ident" id="3730038">state</span><span class="op" id="3730043">,</span>&nbsp;<span class="ident" id="3730045">old</span><span class="op" id="3730048">,</span>&nbsp;<span class="builtinfunc" id="3730050">new</span><span class="op" id="3730053">)</span>&nbsp;<span class="op" id="3730055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3730060">if</span>&nbsp;<span class="ident" id="3730063">old</span><span class="op" id="3730066">&amp;</span><span class="ident" id="3730067">mutexMask</span>&nbsp;<span class="op" id="3730077">!=</span>&nbsp;<span class="num" id="3730080">0</span>&nbsp;<span class="op" id="3730082">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3730088">runtime_Semrelease</span><span class="op" id="3730106">(</span><span class="ident" id="3730107">mutexSema</span><span class="op" id="3730116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3730121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3730126">return</span>&nbsp;<span class="builtinfunc" id="3730133">new</span><span class="op" id="3730136">&amp;</span><span class="op" id="3730137">(</span><span class="ident" id="3730138">mutexClosed</span><span class="op" id="3730149">|</span><span class="ident" id="3730150">mutexRefMask</span><span class="op" id="3730162">)</span>&nbsp;<span class="op" id="3730164">==</span>&nbsp;<span class="ident" id="3730167">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3730181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3730184">}</span><br>
<span class="lineno">180</span><span class="op" id="3730186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3730189">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="3730224">func</span>&nbsp;<span class="ident" id="3730229">runtime_Semacquire</span><span class="op" id="3730247">(</span><span class="ident" id="3730248">sema</span>&nbsp;<span class="op" id="3730253">*</span><span class="builtintype" id="3730254">uint32</span><span class="op" id="3730260">)</span><br>
<span class="lineno"></span><span class="keyword" id="3730262">func</span>&nbsp;<span class="ident" id="3730267">runtime_Semrelease</span><span class="op" id="3730285">(</span><span class="ident" id="3730286">sema</span>&nbsp;<span class="op" id="3730291">*</span><span class="builtintype" id="3730292">uint32</span><span class="op" id="3730298">)</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
