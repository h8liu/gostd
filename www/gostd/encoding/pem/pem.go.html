<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/pem</h2>
<ul>
<li><a href="/gostd/encoding/pem/pem.go.html">pem.go</a></li>
<li><a href="/gostd/encoding/pem/pem_test.go.html">pem_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3663138">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3663193">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3663247">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3663298">//&nbsp;Package&nbsp;pem&nbsp;implements&nbsp;the&nbsp;PEM&nbsp;data&nbsp;encoding,&nbsp;which&nbsp;originated&nbsp;in&nbsp;Privacy</span><br>
<span class="lineno"></span><span class="comment" id="3663375">//&nbsp;Enhanced&nbsp;Mail.&nbsp;The&nbsp;most&nbsp;common&nbsp;use&nbsp;of&nbsp;PEM&nbsp;encoding&nbsp;today&nbsp;is&nbsp;in&nbsp;TLS&nbsp;keys&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3663454">//&nbsp;certificates.&nbsp;See&nbsp;RFC&nbsp;1421.</span><br>
<span class="lineno"></span><span class="keyword" id="3663485">package</span>&nbsp;<span class="ident" id="3663493">pem</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="3663498">import</span>&nbsp;<span class="op" id="3663505">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3663508">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3663517">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3663536">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3663542">&#34;sort&#34;</span><br>
<span class="lineno">15</span><span class="op" id="3663549">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3663552">//&nbsp;A&nbsp;Block&nbsp;represents&nbsp;a&nbsp;PEM&nbsp;encoded&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="3663599">//</span><br>
<span class="lineno"></span><span class="comment" id="3663602">//&nbsp;The&nbsp;encoded&nbsp;form&nbsp;is:</span><br>
<span class="lineno">20</span><span class="comment" id="3663626">//&nbsp;&nbsp;&nbsp;&nbsp;-----BEGIN&nbsp;Type-----</span><br>
<span class="lineno"></span><span class="comment" id="3663653">//&nbsp;&nbsp;&nbsp;&nbsp;Headers</span><br>
<span class="lineno"></span><span class="comment" id="3663667">//&nbsp;&nbsp;&nbsp;&nbsp;base64-encoded&nbsp;Bytes</span><br>
<span class="lineno"></span><span class="comment" id="3663694">//&nbsp;&nbsp;&nbsp;&nbsp;-----END&nbsp;Type-----</span><br>
<span class="lineno"></span><span class="comment" id="3663719">//&nbsp;where&nbsp;Headers&nbsp;is&nbsp;a&nbsp;possibly&nbsp;empty&nbsp;sequence&nbsp;of&nbsp;Key:&nbsp;Value&nbsp;lines.</span><br>
<span class="lineno">25</span><span class="keyword" id="3663786">type</span>&nbsp;<span class="ident" id="3663791">Block</span>&nbsp;<span class="keyword" id="3663797">struct</span>&nbsp;<span class="op" id="3663804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663807">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3663815">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3663833">//&nbsp;The&nbsp;type,&nbsp;taken&nbsp;from&nbsp;the&nbsp;preamble&nbsp;(i.e.&nbsp;&#34;RSA&nbsp;PRIVATE&nbsp;KEY&#34;).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663897">Headers</span>&nbsp;<span class="keyword" id="3663905">map</span><span class="op" id="3663908">[</span><span class="builtintype" id="3663909">string</span><span class="op" id="3663915">]</span><span class="builtintype" id="3663916">string</span>&nbsp;<span class="comment" id="3663923">//&nbsp;Optional&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663945">Bytes</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3663953">[</span><span class="op" id="3663954">]</span><span class="builtintype" id="3663955">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3663971">//&nbsp;The&nbsp;decoded&nbsp;bytes&nbsp;of&nbsp;the&nbsp;contents.&nbsp;Typically&nbsp;a&nbsp;DER&nbsp;encoded&nbsp;ASN.1&nbsp;structure.</span><br>
<span class="lineno"></span><span class="op" id="3664050">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="3664053">//&nbsp;getLine&nbsp;results&nbsp;the&nbsp;first&nbsp;\r\n&nbsp;or&nbsp;\n&nbsp;delineated&nbsp;line&nbsp;from&nbsp;the&nbsp;given&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="3664129">//&nbsp;array.&nbsp;The&nbsp;line&nbsp;does&nbsp;not&nbsp;include&nbsp;trailing&nbsp;whitespace&nbsp;or&nbsp;the&nbsp;trailing&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="3664205">//&nbsp;line&nbsp;bytes.&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;byte&nbsp;array&nbsp;(also&nbsp;not&nbsp;including&nbsp;the&nbsp;new&nbsp;line</span><br>
<span class="lineno"></span><span class="comment" id="3664285">//&nbsp;bytes)&nbsp;is&nbsp;also&nbsp;returned&nbsp;and&nbsp;this&nbsp;will&nbsp;always&nbsp;be&nbsp;smaller&nbsp;than&nbsp;the&nbsp;original</span><br>
<span class="lineno">35</span><span class="comment" id="3664362">//&nbsp;argument.</span><br>
<span class="lineno"></span><span class="keyword" id="3664375">func</span>&nbsp;<span class="ident" id="3664380">getLine</span><span class="op" id="3664387">(</span><span class="ident" id="3664388">data</span>&nbsp;<span class="op" id="3664393">[</span><span class="op" id="3664394">]</span><span class="builtintype" id="3664395">byte</span><span class="op" id="3664399">)</span>&nbsp;<span class="op" id="3664401">(</span><span class="ident" id="3664402">line</span><span class="op" id="3664406">,</span>&nbsp;<span class="ident" id="3664408">rest</span>&nbsp;<span class="op" id="3664413">[</span><span class="op" id="3664414">]</span><span class="builtintype" id="3664415">byte</span><span class="op" id="3664419">)</span>&nbsp;<span class="op" id="3664421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3664424">i</span>&nbsp;<span class="op" id="3664426">:=</span>&nbsp;<span class="ident" id="3664429">bytes</span><span class="op" id="3664434">.</span><span class="ident" id="3664435">Index</span><span class="op" id="3664440">(</span><span class="ident" id="3664441">data</span><span class="op" id="3664445">,</span>&nbsp;<span class="op" id="3664447">[</span><span class="op" id="3664448">]</span><span class="builtintype" id="3664449">byte</span><span class="op" id="3664453">{</span><span class="string" id="3664454">&#39;\n&#39;</span><span class="op" id="3664458">}</span><span class="op" id="3664459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664462">var</span>&nbsp;<span class="ident" id="3664466">j</span>&nbsp;<span class="builtintype" id="3664468">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664473">if</span>&nbsp;<span class="ident" id="3664476">i</span>&nbsp;<span class="op" id="3664478">&lt;</span>&nbsp;<span class="num" id="3664480">0</span>&nbsp;<span class="op" id="3664482">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3664486">i</span>&nbsp;<span class="op" id="3664488">=</span>&nbsp;<span class="builtinfunc" id="3664490">len</span><span class="op" id="3664493">(</span><span class="ident" id="3664494">data</span><span class="op" id="3664498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3664502">j</span>&nbsp;<span class="op" id="3664504">=</span>&nbsp;<span class="ident" id="3664506">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3664509">}</span>&nbsp;<span class="keyword" id="3664511">else</span>&nbsp;<span class="op" id="3664516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3664520">j</span>&nbsp;<span class="op" id="3664522">=</span>&nbsp;<span class="ident" id="3664524">i</span>&nbsp;<span class="op" id="3664526">+</span>&nbsp;<span class="num" id="3664528">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664532">if</span>&nbsp;<span class="ident" id="3664535">i</span>&nbsp;<span class="op" id="3664537">&gt;</span>&nbsp;<span class="num" id="3664539">0</span>&nbsp;<span class="op" id="3664541">&amp;&amp;</span>&nbsp;<span class="ident" id="3664544">data</span><span class="op" id="3664548">[</span><span class="ident" id="3664549">i</span><span class="op" id="3664550">-</span><span class="num" id="3664551">1</span><span class="op" id="3664552">]</span>&nbsp;<span class="op" id="3664554">==</span>&nbsp;<span class="string" id="3664557">&#39;\r&#39;</span>&nbsp;<span class="op" id="3664562">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3664567">i</span><span class="op" id="3664568">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3664573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3664576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664579">return</span>&nbsp;<span class="ident" id="3664586">bytes</span><span class="op" id="3664591">.</span><span class="ident" id="3664592">TrimRight</span><span class="op" id="3664601">(</span><span class="ident" id="3664602">data</span><span class="op" id="3664606">[</span><span class="num" id="3664607">0</span><span class="op" id="3664608">:</span><span class="ident" id="3664609">i</span><span class="op" id="3664610">]</span><span class="op" id="3664611">,</span>&nbsp;<span class="string" id="3664613">&#34;&nbsp;\t&#34;</span><span class="op" id="3664618">)</span><span class="op" id="3664619">,</span>&nbsp;<span class="ident" id="3664621">data</span><span class="op" id="3664625">[</span><span class="ident" id="3664626">j</span><span class="op" id="3664627">:</span><span class="op" id="3664628">]</span><br>
<span class="lineno"></span><span class="op" id="3664630">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="3664633">//&nbsp;removeWhitespace&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;its&nbsp;input&nbsp;with&nbsp;all&nbsp;spaces,&nbsp;tab&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3664706">//&nbsp;newline&nbsp;characters&nbsp;removed.</span><br>
<span class="lineno"></span><span class="keyword" id="3664737">func</span>&nbsp;<span class="ident" id="3664742">removeWhitespace</span><span class="op" id="3664758">(</span><span class="ident" id="3664759">data</span>&nbsp;<span class="op" id="3664764">[</span><span class="op" id="3664765">]</span><span class="builtintype" id="3664766">byte</span><span class="op" id="3664770">)</span>&nbsp;<span class="op" id="3664772">[</span><span class="op" id="3664773">]</span><span class="builtintype" id="3664774">byte</span>&nbsp;<span class="op" id="3664779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3664782">result</span>&nbsp;<span class="op" id="3664789">:=</span>&nbsp;<span class="builtinfunc" id="3664792">make</span><span class="op" id="3664796">(</span><span class="op" id="3664797">[</span><span class="op" id="3664798">]</span><span class="builtintype" id="3664799">byte</span><span class="op" id="3664803">,</span>&nbsp;<span class="builtinfunc" id="3664805">len</span><span class="op" id="3664808">(</span><span class="ident" id="3664809">data</span><span class="op" id="3664813">)</span><span class="op" id="3664814">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3664817">n</span>&nbsp;<span class="op" id="3664819">:=</span>&nbsp;<span class="num" id="3664822">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664826">for</span>&nbsp;<span class="ident" id="3664830">_</span><span class="op" id="3664831">,</span>&nbsp;<span class="ident" id="3664833">b</span>&nbsp;<span class="op" id="3664835">:=</span>&nbsp;<span class="keyword" id="3664838">range</span>&nbsp;<span class="ident" id="3664844">data</span>&nbsp;<span class="op" id="3664849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664853">if</span>&nbsp;<span class="ident" id="3664856">b</span>&nbsp;<span class="op" id="3664858">==</span>&nbsp;<span class="string" id="3664861">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="3664865">||</span>&nbsp;<span class="ident" id="3664868">b</span>&nbsp;<span class="op" id="3664870">==</span>&nbsp;<span class="string" id="3664873">&#39;\t&#39;</span>&nbsp;<span class="op" id="3664878">||</span>&nbsp;<span class="ident" id="3664881">b</span>&nbsp;<span class="op" id="3664883">==</span>&nbsp;<span class="string" id="3664886">&#39;\r&#39;</span>&nbsp;<span class="op" id="3664891">||</span>&nbsp;<span class="ident" id="3664894">b</span>&nbsp;<span class="op" id="3664896">==</span>&nbsp;<span class="string" id="3664899">&#39;\n&#39;</span>&nbsp;<span class="op" id="3664904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664909">continue</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3664920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3664924">result</span><span class="op" id="3664930">[</span><span class="ident" id="3664931">n</span><span class="op" id="3664932">]</span>&nbsp;<span class="op" id="3664934">=</span>&nbsp;<span class="ident" id="3664936">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3664940">n</span><span class="op" id="3664941">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3664945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664949">return</span>&nbsp;<span class="ident" id="3664956">result</span><span class="op" id="3664962">[</span><span class="num" id="3664963">0</span><span class="op" id="3664964">:</span><span class="ident" id="3664965">n</span><span class="op" id="3664966">]</span><br>
<span class="lineno"></span><span class="op" id="3664968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3664971">var</span>&nbsp;<span class="ident" id="3664975">pemStart</span>&nbsp;<span class="op" id="3664984">=</span>&nbsp;<span class="op" id="3664986">[</span><span class="op" id="3664987">]</span><span class="builtintype" id="3664988">byte</span><span class="op" id="3664992">(</span><span class="string" id="3664993">&#34;\n-----BEGIN&nbsp;&#34;</span><span class="op" id="3665008">)</span><br>
<span class="lineno"></span><span class="keyword" id="3665010">var</span>&nbsp;<span class="ident" id="3665014">pemEnd</span>&nbsp;<span class="op" id="3665021">=</span>&nbsp;<span class="op" id="3665023">[</span><span class="op" id="3665024">]</span><span class="builtintype" id="3665025">byte</span><span class="op" id="3665029">(</span><span class="string" id="3665030">&#34;\n-----END&nbsp;&#34;</span><span class="op" id="3665043">)</span><br>
<span class="lineno">70</span><span class="keyword" id="3665045">var</span>&nbsp;<span class="ident" id="3665049">pemEndOfLine</span>&nbsp;<span class="op" id="3665062">=</span>&nbsp;<span class="op" id="3665064">[</span><span class="op" id="3665065">]</span><span class="builtintype" id="3665066">byte</span><span class="op" id="3665070">(</span><span class="string" id="3665071">&#34;-----&#34;</span><span class="op" id="3665078">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3665081">//&nbsp;Decode&nbsp;will&nbsp;find&nbsp;the&nbsp;next&nbsp;PEM&nbsp;formatted&nbsp;block&nbsp;(certificate,&nbsp;private&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="3665156">//&nbsp;etc)&nbsp;in&nbsp;the&nbsp;input.&nbsp;It&nbsp;returns&nbsp;that&nbsp;block&nbsp;and&nbsp;the&nbsp;remainder&nbsp;of&nbsp;the&nbsp;input.&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="3665235">//&nbsp;no&nbsp;PEM&nbsp;data&nbsp;is&nbsp;found,&nbsp;p&nbsp;is&nbsp;nil&nbsp;and&nbsp;the&nbsp;whole&nbsp;of&nbsp;the&nbsp;input&nbsp;is&nbsp;returned&nbsp;in</span><br>
<span class="lineno">75</span><span class="comment" id="3665311">//&nbsp;rest.</span><br>
<span class="lineno"></span><span class="keyword" id="3665320">func</span>&nbsp;<span class="ident" id="3665325">Decode</span><span class="op" id="3665331">(</span><span class="ident" id="3665332">data</span>&nbsp;<span class="op" id="3665337">[</span><span class="op" id="3665338">]</span><span class="builtintype" id="3665339">byte</span><span class="op" id="3665343">)</span>&nbsp;<span class="op" id="3665345">(</span><span class="ident" id="3665346">p</span>&nbsp;<span class="op" id="3665348">*</span><span class="ident" id="3665349">Block</span><span class="op" id="3665354">,</span>&nbsp;<span class="ident" id="3665356">rest</span>&nbsp;<span class="op" id="3665361">[</span><span class="op" id="3665362">]</span><span class="builtintype" id="3665363">byte</span><span class="op" id="3665367">)</span>&nbsp;<span class="op" id="3665369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665372">//&nbsp;pemStart&nbsp;begins&nbsp;with&nbsp;a&nbsp;newline.&nbsp;However,&nbsp;at&nbsp;the&nbsp;very&nbsp;beginning&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665442">//&nbsp;the&nbsp;byte&nbsp;array,&nbsp;we&#39;ll&nbsp;accept&nbsp;the&nbsp;start&nbsp;string&nbsp;without&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3665504">rest</span>&nbsp;<span class="op" id="3665509">=</span>&nbsp;<span class="ident" id="3665511">data</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3665517">if</span>&nbsp;<span class="ident" id="3665520">bytes</span><span class="op" id="3665525">.</span><span class="ident" id="3665526">HasPrefix</span><span class="op" id="3665535">(</span><span class="ident" id="3665536">data</span><span class="op" id="3665540">,</span>&nbsp;<span class="ident" id="3665542">pemStart</span><span class="op" id="3665550">[</span><span class="num" id="3665551">1</span><span class="op" id="3665552">:</span><span class="op" id="3665553">]</span><span class="op" id="3665554">)</span>&nbsp;<span class="op" id="3665556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3665560">rest</span>&nbsp;<span class="op" id="3665565">=</span>&nbsp;<span class="ident" id="3665567">rest</span><span class="op" id="3665571">[</span><span class="builtinfunc" id="3665572">len</span><span class="op" id="3665575">(</span><span class="ident" id="3665576">pemStart</span><span class="op" id="3665584">)</span><span class="op" id="3665585">-</span><span class="num" id="3665586">1</span>&nbsp;<span class="op" id="3665588">:</span>&nbsp;<span class="builtinfunc" id="3665590">len</span><span class="op" id="3665593">(</span><span class="ident" id="3665594">data</span><span class="op" id="3665598">)</span><span class="op" id="3665599">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3665602">}</span>&nbsp;<span class="keyword" id="3665604">else</span>&nbsp;<span class="keyword" id="3665609">if</span>&nbsp;<span class="ident" id="3665612">i</span>&nbsp;<span class="op" id="3665614">:=</span>&nbsp;<span class="ident" id="3665617">bytes</span><span class="op" id="3665622">.</span><span class="ident" id="3665623">Index</span><span class="op" id="3665628">(</span><span class="ident" id="3665629">data</span><span class="op" id="3665633">,</span>&nbsp;<span class="ident" id="3665635">pemStart</span><span class="op" id="3665643">)</span><span class="op" id="3665644">;</span>&nbsp;<span class="ident" id="3665646">i</span>&nbsp;<span class="op" id="3665648">&gt;=</span>&nbsp;<span class="num" id="3665651">0</span>&nbsp;<span class="op" id="3665653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3665657">rest</span>&nbsp;<span class="op" id="3665662">=</span>&nbsp;<span class="ident" id="3665664">rest</span><span class="op" id="3665668">[</span><span class="ident" id="3665669">i</span><span class="op" id="3665670">+</span><span class="builtinfunc" id="3665671">len</span><span class="op" id="3665674">(</span><span class="ident" id="3665675">pemStart</span><span class="op" id="3665683">)</span>&nbsp;<span class="op" id="3665685">:</span>&nbsp;<span class="builtinfunc" id="3665687">len</span><span class="op" id="3665690">(</span><span class="ident" id="3665691">data</span><span class="op" id="3665695">)</span><span class="op" id="3665696">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3665699">}</span>&nbsp;<span class="keyword" id="3665701">else</span>&nbsp;<span class="op" id="3665706">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3665710">return</span>&nbsp;<span class="ident" id="3665717">nil</span><span class="op" id="3665720">,</span>&nbsp;<span class="ident" id="3665722">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3665728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3665732">typeLine</span><span class="op" id="3665740">,</span>&nbsp;<span class="ident" id="3665742">rest</span>&nbsp;<span class="op" id="3665747">:=</span>&nbsp;<span class="ident" id="3665750">getLine</span><span class="op" id="3665757">(</span><span class="ident" id="3665758">rest</span><span class="op" id="3665762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3665765">if</span>&nbsp;<span class="op" id="3665768">!</span><span class="ident" id="3665769">bytes</span><span class="op" id="3665774">.</span><span class="ident" id="3665775">HasSuffix</span><span class="op" id="3665784">(</span><span class="ident" id="3665785">typeLine</span><span class="op" id="3665793">,</span>&nbsp;<span class="ident" id="3665795">pemEndOfLine</span><span class="op" id="3665807">)</span>&nbsp;<span class="op" id="3665809">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3665813">return</span>&nbsp;<span class="ident" id="3665820">decodeError</span><span class="op" id="3665831">(</span><span class="ident" id="3665832">data</span><span class="op" id="3665836">,</span>&nbsp;<span class="ident" id="3665838">rest</span><span class="op" id="3665842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3665845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3665848">typeLine</span>&nbsp;<span class="op" id="3665857">=</span>&nbsp;<span class="ident" id="3665859">typeLine</span><span class="op" id="3665867">[</span><span class="num" id="3665868">0</span>&nbsp;<span class="op" id="3665870">:</span>&nbsp;<span class="builtinfunc" id="3665872">len</span><span class="op" id="3665875">(</span><span class="ident" id="3665876">typeLine</span><span class="op" id="3665884">)</span><span class="op" id="3665885">-</span><span class="builtinfunc" id="3665886">len</span><span class="op" id="3665889">(</span><span class="ident" id="3665890">pemEndOfLine</span><span class="op" id="3665902">)</span><span class="op" id="3665903">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3665907">p</span>&nbsp;<span class="op" id="3665909">=</span>&nbsp;<span class="op" id="3665911">&amp;</span><span class="ident" id="3665912">Block</span><span class="op" id="3665917">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3665921">Headers</span><span class="op" id="3665928">:</span>&nbsp;<span class="builtinfunc" id="3665930">make</span><span class="op" id="3665934">(</span><span class="keyword" id="3665935">map</span><span class="op" id="3665938">[</span><span class="builtintype" id="3665939">string</span><span class="op" id="3665945">]</span><span class="builtintype" id="3665946">string</span><span class="op" id="3665952">)</span><span class="op" id="3665953">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3665957">Type</span><span class="op" id="3665961">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3665966">string</span><span class="op" id="3665972">(</span><span class="ident" id="3665973">typeLine</span><span class="op" id="3665981">)</span><span class="op" id="3665982">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3665985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3665989">for</span>&nbsp;<span class="op" id="3665993">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665997">//&nbsp;This&nbsp;loop&nbsp;terminates&nbsp;because&nbsp;getLine&#39;s&nbsp;second&nbsp;result&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666058">//&nbsp;always&nbsp;smaller&nbsp;than&nbsp;its&nbsp;argument.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3666097">if</span>&nbsp;<span class="builtinfunc" id="3666100">len</span><span class="op" id="3666103">(</span><span class="ident" id="3666104">rest</span><span class="op" id="3666108">)</span>&nbsp;<span class="op" id="3666110">==</span>&nbsp;<span class="num" id="3666113">0</span>&nbsp;<span class="op" id="3666115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3666120">return</span>&nbsp;<span class="ident" id="3666127">nil</span><span class="op" id="3666130">,</span>&nbsp;<span class="ident" id="3666132">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3666139">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666143">line</span><span class="op" id="3666147">,</span>&nbsp;<span class="ident" id="3666149">next</span>&nbsp;<span class="op" id="3666154">:=</span>&nbsp;<span class="ident" id="3666157">getLine</span><span class="op" id="3666164">(</span><span class="ident" id="3666165">rest</span><span class="op" id="3666169">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666174">i</span>&nbsp;<span class="op" id="3666176">:=</span>&nbsp;<span class="ident" id="3666179">bytes</span><span class="op" id="3666184">.</span><span class="ident" id="3666185">Index</span><span class="op" id="3666190">(</span><span class="ident" id="3666191">line</span><span class="op" id="3666195">,</span>&nbsp;<span class="op" id="3666197">[</span><span class="op" id="3666198">]</span><span class="builtintype" id="3666199">byte</span><span class="op" id="3666203">{</span><span class="string" id="3666204">&#39;:&#39;</span><span class="op" id="3666207">}</span><span class="op" id="3666208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3666212">if</span>&nbsp;<span class="ident" id="3666215">i</span>&nbsp;<span class="op" id="3666217">==</span>&nbsp;<span class="op" id="3666220">-</span><span class="num" id="3666221">1</span>&nbsp;<span class="op" id="3666223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3666228">break</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3666236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666241">//&nbsp;TODO(agl):&nbsp;need&nbsp;to&nbsp;cope&nbsp;with&nbsp;values&nbsp;that&nbsp;spread&nbsp;across&nbsp;lines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666308">key</span><span class="op" id="3666311">,</span>&nbsp;<span class="ident" id="3666313">val</span>&nbsp;<span class="op" id="3666317">:=</span>&nbsp;<span class="ident" id="3666320">line</span><span class="op" id="3666324">[</span><span class="num" id="3666325">0</span><span class="op" id="3666326">:</span><span class="ident" id="3666327">i</span><span class="op" id="3666328">]</span><span class="op" id="3666329">,</span>&nbsp;<span class="ident" id="3666331">line</span><span class="op" id="3666335">[</span><span class="ident" id="3666336">i</span><span class="op" id="3666337">+</span><span class="num" id="3666338">1</span><span class="op" id="3666339">:</span><span class="op" id="3666340">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666344">key</span>&nbsp;<span class="op" id="3666348">=</span>&nbsp;<span class="ident" id="3666350">bytes</span><span class="op" id="3666355">.</span><span class="ident" id="3666356">TrimSpace</span><span class="op" id="3666365">(</span><span class="ident" id="3666366">key</span><span class="op" id="3666369">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666373">val</span>&nbsp;<span class="op" id="3666377">=</span>&nbsp;<span class="ident" id="3666379">bytes</span><span class="op" id="3666384">.</span><span class="ident" id="3666385">TrimSpace</span><span class="op" id="3666394">(</span><span class="ident" id="3666395">val</span><span class="op" id="3666398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666402">p</span><span class="op" id="3666403">.</span><span class="ident" id="3666404">Headers</span><span class="op" id="3666411">[</span><span class="builtintype" id="3666412">string</span><span class="op" id="3666418">(</span><span class="ident" id="3666419">key</span><span class="op" id="3666422">)</span><span class="op" id="3666423">]</span>&nbsp;<span class="op" id="3666425">=</span>&nbsp;<span class="builtintype" id="3666427">string</span><span class="op" id="3666433">(</span><span class="ident" id="3666434">val</span><span class="op" id="3666437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666441">rest</span>&nbsp;<span class="op" id="3666446">=</span>&nbsp;<span class="ident" id="3666448">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3666454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666458">i</span>&nbsp;<span class="op" id="3666460">:=</span>&nbsp;<span class="ident" id="3666463">bytes</span><span class="op" id="3666468">.</span><span class="ident" id="3666469">Index</span><span class="op" id="3666474">(</span><span class="ident" id="3666475">rest</span><span class="op" id="3666479">,</span>&nbsp;<span class="ident" id="3666481">pemEnd</span><span class="op" id="3666487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3666490">if</span>&nbsp;<span class="ident" id="3666493">i</span>&nbsp;<span class="op" id="3666495">&lt;</span>&nbsp;<span class="num" id="3666497">0</span>&nbsp;<span class="op" id="3666499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3666503">return</span>&nbsp;<span class="ident" id="3666510">decodeError</span><span class="op" id="3666521">(</span><span class="ident" id="3666522">data</span><span class="op" id="3666526">,</span>&nbsp;<span class="ident" id="3666528">rest</span><span class="op" id="3666532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3666535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666538">base64Data</span>&nbsp;<span class="op" id="3666549">:=</span>&nbsp;<span class="ident" id="3666552">removeWhitespace</span><span class="op" id="3666568">(</span><span class="ident" id="3666569">rest</span><span class="op" id="3666573">[</span><span class="num" id="3666574">0</span><span class="op" id="3666575">:</span><span class="ident" id="3666576">i</span><span class="op" id="3666577">]</span><span class="op" id="3666578">)</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666582">p</span><span class="op" id="3666583">.</span><span class="ident" id="3666584">Bytes</span>&nbsp;<span class="op" id="3666590">=</span>&nbsp;<span class="builtinfunc" id="3666592">make</span><span class="op" id="3666596">(</span><span class="op" id="3666597">[</span><span class="op" id="3666598">]</span><span class="builtintype" id="3666599">byte</span><span class="op" id="3666603">,</span>&nbsp;<span class="ident" id="3666605">base64</span><span class="op" id="3666611">.</span><span class="ident" id="3666612">StdEncoding</span><span class="op" id="3666623">.</span><span class="ident" id="3666624">DecodedLen</span><span class="op" id="3666634">(</span><span class="builtinfunc" id="3666635">len</span><span class="op" id="3666638">(</span><span class="ident" id="3666639">base64Data</span><span class="op" id="3666649">)</span><span class="op" id="3666650">)</span><span class="op" id="3666651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666654">n</span><span class="op" id="3666655">,</span>&nbsp;<span class="ident" id="3666657">err</span>&nbsp;<span class="op" id="3666661">:=</span>&nbsp;<span class="ident" id="3666664">base64</span><span class="op" id="3666670">.</span><span class="ident" id="3666671">StdEncoding</span><span class="op" id="3666682">.</span><span class="ident" id="3666683">Decode</span><span class="op" id="3666689">(</span><span class="ident" id="3666690">p</span><span class="op" id="3666691">.</span><span class="ident" id="3666692">Bytes</span><span class="op" id="3666697">,</span>&nbsp;<span class="ident" id="3666699">base64Data</span><span class="op" id="3666709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3666712">if</span>&nbsp;<span class="ident" id="3666715">err</span>&nbsp;<span class="op" id="3666719">!=</span>&nbsp;<span class="ident" id="3666722">nil</span>&nbsp;<span class="op" id="3666726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3666730">return</span>&nbsp;<span class="ident" id="3666737">decodeError</span><span class="op" id="3666748">(</span><span class="ident" id="3666749">data</span><span class="op" id="3666753">,</span>&nbsp;<span class="ident" id="3666755">rest</span><span class="op" id="3666759">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3666762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666765">p</span><span class="op" id="3666766">.</span><span class="ident" id="3666767">Bytes</span>&nbsp;<span class="op" id="3666773">=</span>&nbsp;<span class="ident" id="3666775">p</span><span class="op" id="3666776">.</span><span class="ident" id="3666777">Bytes</span><span class="op" id="3666782">[</span><span class="num" id="3666783">0</span><span class="op" id="3666784">:</span><span class="ident" id="3666785">n</span><span class="op" id="3666786">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666790">_</span><span class="op" id="3666791">,</span>&nbsp;<span class="ident" id="3666793">rest</span>&nbsp;<span class="op" id="3666798">=</span>&nbsp;<span class="ident" id="3666800">getLine</span><span class="op" id="3666807">(</span><span class="ident" id="3666808">rest</span><span class="op" id="3666812">[</span><span class="ident" id="3666813">i</span><span class="op" id="3666814">+</span><span class="builtinfunc" id="3666815">len</span><span class="op" id="3666818">(</span><span class="ident" id="3666819">pemEnd</span><span class="op" id="3666825">)</span><span class="op" id="3666826">:</span><span class="op" id="3666827">]</span><span class="op" id="3666828">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3666832">return</span><br>
<span class="lineno"></span><span class="op" id="3666839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3666842">func</span>&nbsp;<span class="ident" id="3666847">decodeError</span><span class="op" id="3666858">(</span><span class="ident" id="3666859">data</span><span class="op" id="3666863">,</span>&nbsp;<span class="ident" id="3666865">rest</span>&nbsp;<span class="op" id="3666870">[</span><span class="op" id="3666871">]</span><span class="builtintype" id="3666872">byte</span><span class="op" id="3666876">)</span>&nbsp;<span class="op" id="3666878">(</span><span class="op" id="3666879">*</span><span class="ident" id="3666880">Block</span><span class="op" id="3666885">,</span>&nbsp;<span class="op" id="3666887">[</span><span class="op" id="3666888">]</span><span class="builtintype" id="3666889">byte</span><span class="op" id="3666893">)</span>&nbsp;<span class="op" id="3666895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666898">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here&nbsp;then&nbsp;we&nbsp;have&nbsp;rejected&nbsp;a&nbsp;likely&nbsp;looking,&nbsp;but</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666961">//&nbsp;ultimately&nbsp;invalid&nbsp;PEM&nbsp;block.&nbsp;We&nbsp;need&nbsp;to&nbsp;start&nbsp;over&nbsp;from&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667028">//&nbsp;position.&nbsp;&nbsp;We&nbsp;have&nbsp;consumed&nbsp;the&nbsp;preamble&nbsp;line&nbsp;and&nbsp;will&nbsp;have&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667101">//&nbsp;any&nbsp;lines&nbsp;which&nbsp;could&nbsp;be&nbsp;header&nbsp;lines.&nbsp;However,&nbsp;a&nbsp;valid&nbsp;preamble</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667170">//&nbsp;line&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;header&nbsp;line,&nbsp;therefore&nbsp;we&nbsp;cannot&nbsp;have&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667241">//&nbsp;the&nbsp;preamble&nbsp;line&nbsp;for&nbsp;the&nbsp;any&nbsp;subsequent&nbsp;block.&nbsp;Thus,&nbsp;we&nbsp;will&nbsp;always</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667314">//&nbsp;find&nbsp;any&nbsp;valid&nbsp;block,&nbsp;no&nbsp;matter&nbsp;what&nbsp;bytes&nbsp;precede&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667373">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667377">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;the&nbsp;input&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667410">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667414">//&nbsp;&nbsp;&nbsp;&nbsp;-----BEGIN&nbsp;MALFORMED&nbsp;BLOCK-----</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667453">//&nbsp;&nbsp;&nbsp;&nbsp;junk&nbsp;that&nbsp;may&nbsp;look&nbsp;like&nbsp;header&nbsp;lines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667497">//&nbsp;&nbsp;&nbsp;or&nbsp;data&nbsp;lines,&nbsp;but&nbsp;no&nbsp;END&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667534">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667538">//&nbsp;&nbsp;&nbsp;&nbsp;-----BEGIN&nbsp;ACTUAL&nbsp;BLOCK-----</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667574">//&nbsp;&nbsp;&nbsp;&nbsp;realdata</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667590">//&nbsp;&nbsp;&nbsp;&nbsp;-----END&nbsp;ACTUAL&nbsp;BLOCK-----</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667624">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667628">//&nbsp;we&#39;ve&nbsp;failed&nbsp;to&nbsp;parse&nbsp;using&nbsp;the&nbsp;first&nbsp;BEGIN&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667681">//&nbsp;and&nbsp;now&nbsp;will&nbsp;try&nbsp;again,&nbsp;using&nbsp;the&nbsp;second&nbsp;BEGIN&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3667738">p</span><span class="op" id="3667739">,</span>&nbsp;<span class="ident" id="3667741">rest</span>&nbsp;<span class="op" id="3667746">:=</span>&nbsp;<span class="ident" id="3667749">Decode</span><span class="op" id="3667755">(</span><span class="ident" id="3667756">rest</span><span class="op" id="3667760">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667763">if</span>&nbsp;<span class="ident" id="3667766">p</span>&nbsp;<span class="op" id="3667768">==</span>&nbsp;<span class="ident" id="3667771">nil</span>&nbsp;<span class="op" id="3667775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3667779">rest</span>&nbsp;<span class="op" id="3667784">=</span>&nbsp;<span class="ident" id="3667786">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3667792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667795">return</span>&nbsp;<span class="ident" id="3667802">p</span><span class="op" id="3667803">,</span>&nbsp;<span class="ident" id="3667805">rest</span><br>
<span class="lineno"></span><span class="op" id="3667810">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="3667813">const</span>&nbsp;<span class="ident" id="3667819">pemLineLength</span>&nbsp;<span class="op" id="3667833">=</span>&nbsp;<span class="num" id="3667835">64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3667839">type</span>&nbsp;<span class="ident" id="3667844">lineBreaker</span>&nbsp;<span class="keyword" id="3667856">struct</span>&nbsp;<span class="op" id="3667863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3667866">line</span>&nbsp;<span class="op" id="3667871">[</span><span class="ident" id="3667872">pemLineLength</span><span class="op" id="3667885">]</span><span class="builtintype" id="3667886">byte</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3667892">used</span>&nbsp;<span class="builtintype" id="3667897">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3667902">out</span>&nbsp;&nbsp;<span class="ident" id="3667907">io</span><span class="op" id="3667909">.</span><span class="ident" id="3667910">Writer</span><br>
<span class="lineno"></span><span class="op" id="3667917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3667920">func</span>&nbsp;<span class="op" id="3667925">(</span><span class="ident" id="3667926">l</span>&nbsp;<span class="op" id="3667928">*</span><span class="ident" id="3667929">lineBreaker</span><span class="op" id="3667940">)</span>&nbsp;<span class="ident" id="3667942">Write</span><span class="op" id="3667947">(</span><span class="ident" id="3667948">b</span>&nbsp;<span class="op" id="3667950">[</span><span class="op" id="3667951">]</span><span class="builtintype" id="3667952">byte</span><span class="op" id="3667956">)</span>&nbsp;<span class="op" id="3667958">(</span><span class="ident" id="3667959">n</span>&nbsp;<span class="builtintype" id="3667961">int</span><span class="op" id="3667964">,</span>&nbsp;<span class="ident" id="3667966">err</span>&nbsp;<span class="builtintype" id="3667970">error</span><span class="op" id="3667975">)</span>&nbsp;<span class="op" id="3667977">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667980">if</span>&nbsp;<span class="ident" id="3667983">l</span><span class="op" id="3667984">.</span><span class="ident" id="3667985">used</span><span class="op" id="3667989">+</span><span class="builtinfunc" id="3667990">len</span><span class="op" id="3667993">(</span><span class="ident" id="3667994">b</span><span class="op" id="3667995">)</span>&nbsp;<span class="op" id="3667997">&lt;</span>&nbsp;<span class="ident" id="3667999">pemLineLength</span>&nbsp;<span class="op" id="3668013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3668017">copy</span><span class="op" id="3668021">(</span><span class="ident" id="3668022">l</span><span class="op" id="3668023">.</span><span class="ident" id="3668024">line</span><span class="op" id="3668028">[</span><span class="ident" id="3668029">l</span><span class="op" id="3668030">.</span><span class="ident" id="3668031">used</span><span class="op" id="3668035">:</span><span class="op" id="3668036">]</span><span class="op" id="3668037">,</span>&nbsp;<span class="ident" id="3668039">b</span><span class="op" id="3668040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668044">l</span><span class="op" id="3668045">.</span><span class="ident" id="3668046">used</span>&nbsp;<span class="op" id="3668051">+=</span>&nbsp;<span class="builtinfunc" id="3668054">len</span><span class="op" id="3668057">(</span><span class="ident" id="3668058">b</span><span class="op" id="3668059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668063">return</span>&nbsp;<span class="builtinfunc" id="3668070">len</span><span class="op" id="3668073">(</span><span class="ident" id="3668074">b</span><span class="op" id="3668075">)</span><span class="op" id="3668076">,</span>&nbsp;<span class="ident" id="3668078">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3668083">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668087">n</span><span class="op" id="3668088">,</span>&nbsp;<span class="ident" id="3668090">err</span>&nbsp;<span class="op" id="3668094">=</span>&nbsp;<span class="ident" id="3668096">l</span><span class="op" id="3668097">.</span><span class="ident" id="3668098">out</span><span class="op" id="3668101">.</span><span class="ident" id="3668102">Write</span><span class="op" id="3668107">(</span><span class="ident" id="3668108">l</span><span class="op" id="3668109">.</span><span class="ident" id="3668110">line</span><span class="op" id="3668114">[</span><span class="num" id="3668115">0</span><span class="op" id="3668116">:</span><span class="ident" id="3668117">l</span><span class="op" id="3668118">.</span><span class="ident" id="3668119">used</span><span class="op" id="3668123">]</span><span class="op" id="3668124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668127">if</span>&nbsp;<span class="ident" id="3668130">err</span>&nbsp;<span class="op" id="3668134">!=</span>&nbsp;<span class="ident" id="3668137">nil</span>&nbsp;<span class="op" id="3668141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668145">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3668153">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668156">excess</span>&nbsp;<span class="op" id="3668163">:=</span>&nbsp;<span class="ident" id="3668166">pemLineLength</span>&nbsp;<span class="op" id="3668180">-</span>&nbsp;<span class="ident" id="3668182">l</span><span class="op" id="3668183">.</span><span class="ident" id="3668184">used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668190">l</span><span class="op" id="3668191">.</span><span class="ident" id="3668192">used</span>&nbsp;<span class="op" id="3668197">=</span>&nbsp;<span class="num" id="3668199">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668203">n</span><span class="op" id="3668204">,</span>&nbsp;<span class="ident" id="3668206">err</span>&nbsp;<span class="op" id="3668210">=</span>&nbsp;<span class="ident" id="3668212">l</span><span class="op" id="3668213">.</span><span class="ident" id="3668214">out</span><span class="op" id="3668217">.</span><span class="ident" id="3668218">Write</span><span class="op" id="3668223">(</span><span class="ident" id="3668224">b</span><span class="op" id="3668225">[</span><span class="num" id="3668226">0</span><span class="op" id="3668227">:</span><span class="ident" id="3668228">excess</span><span class="op" id="3668234">]</span><span class="op" id="3668235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668238">if</span>&nbsp;<span class="ident" id="3668241">err</span>&nbsp;<span class="op" id="3668245">!=</span>&nbsp;<span class="ident" id="3668248">nil</span>&nbsp;<span class="op" id="3668252">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668256">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3668264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668268">n</span><span class="op" id="3668269">,</span>&nbsp;<span class="ident" id="3668271">err</span>&nbsp;<span class="op" id="3668275">=</span>&nbsp;<span class="ident" id="3668277">l</span><span class="op" id="3668278">.</span><span class="ident" id="3668279">out</span><span class="op" id="3668282">.</span><span class="ident" id="3668283">Write</span><span class="op" id="3668288">(</span><span class="op" id="3668289">[</span><span class="op" id="3668290">]</span><span class="builtintype" id="3668291">byte</span><span class="op" id="3668295">{</span><span class="string" id="3668296">&#39;\n&#39;</span><span class="op" id="3668300">}</span><span class="op" id="3668301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668304">if</span>&nbsp;<span class="ident" id="3668307">err</span>&nbsp;<span class="op" id="3668311">!=</span>&nbsp;<span class="ident" id="3668314">nil</span>&nbsp;<span class="op" id="3668318">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668322">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3668330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668334">return</span>&nbsp;<span class="ident" id="3668341">l</span><span class="op" id="3668342">.</span><span class="ident" id="3668343">Write</span><span class="op" id="3668348">(</span><span class="ident" id="3668349">b</span><span class="op" id="3668350">[</span><span class="ident" id="3668351">excess</span><span class="op" id="3668357">:</span><span class="op" id="3668358">]</span><span class="op" id="3668359">)</span><br>
<span class="lineno"></span><span class="op" id="3668361">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="3668364">func</span>&nbsp;<span class="op" id="3668369">(</span><span class="ident" id="3668370">l</span>&nbsp;<span class="op" id="3668372">*</span><span class="ident" id="3668373">lineBreaker</span><span class="op" id="3668384">)</span>&nbsp;<span class="ident" id="3668386">Close</span><span class="op" id="3668391">(</span><span class="op" id="3668392">)</span>&nbsp;<span class="op" id="3668394">(</span><span class="ident" id="3668395">err</span>&nbsp;<span class="builtintype" id="3668399">error</span><span class="op" id="3668404">)</span>&nbsp;<span class="op" id="3668406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668409">if</span>&nbsp;<span class="ident" id="3668412">l</span><span class="op" id="3668413">.</span><span class="ident" id="3668414">used</span>&nbsp;<span class="op" id="3668419">&gt;</span>&nbsp;<span class="num" id="3668421">0</span>&nbsp;<span class="op" id="3668423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668427">_</span><span class="op" id="3668428">,</span>&nbsp;<span class="ident" id="3668430">err</span>&nbsp;<span class="op" id="3668434">=</span>&nbsp;<span class="ident" id="3668436">l</span><span class="op" id="3668437">.</span><span class="ident" id="3668438">out</span><span class="op" id="3668441">.</span><span class="ident" id="3668442">Write</span><span class="op" id="3668447">(</span><span class="ident" id="3668448">l</span><span class="op" id="3668449">.</span><span class="ident" id="3668450">line</span><span class="op" id="3668454">[</span><span class="num" id="3668455">0</span><span class="op" id="3668456">:</span><span class="ident" id="3668457">l</span><span class="op" id="3668458">.</span><span class="ident" id="3668459">used</span><span class="op" id="3668463">]</span><span class="op" id="3668464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668468">if</span>&nbsp;<span class="ident" id="3668471">err</span>&nbsp;<span class="op" id="3668475">!=</span>&nbsp;<span class="ident" id="3668478">nil</span>&nbsp;<span class="op" id="3668482">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668487">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3668496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668500">_</span><span class="op" id="3668501">,</span>&nbsp;<span class="ident" id="3668503">err</span>&nbsp;<span class="op" id="3668507">=</span>&nbsp;<span class="ident" id="3668509">l</span><span class="op" id="3668510">.</span><span class="ident" id="3668511">out</span><span class="op" id="3668514">.</span><span class="ident" id="3668515">Write</span><span class="op" id="3668520">(</span><span class="op" id="3668521">[</span><span class="op" id="3668522">]</span><span class="builtintype" id="3668523">byte</span><span class="op" id="3668527">{</span><span class="string" id="3668528">&#39;\n&#39;</span><span class="op" id="3668532">}</span><span class="op" id="3668533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3668536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668540">return</span><br>
<span class="lineno"></span><span class="op" id="3668547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3668550">func</span>&nbsp;<span class="ident" id="3668555">writeHeader</span><span class="op" id="3668566">(</span><span class="ident" id="3668567">out</span>&nbsp;<span class="ident" id="3668571">io</span><span class="op" id="3668573">.</span><span class="ident" id="3668574">Writer</span><span class="op" id="3668580">,</span>&nbsp;<span class="ident" id="3668582">k</span><span class="op" id="3668583">,</span>&nbsp;<span class="ident" id="3668585">v</span>&nbsp;<span class="builtintype" id="3668587">string</span><span class="op" id="3668593">)</span>&nbsp;<span class="builtintype" id="3668595">error</span>&nbsp;<span class="op" id="3668601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668604">_</span><span class="op" id="3668605">,</span>&nbsp;<span class="ident" id="3668607">err</span>&nbsp;<span class="op" id="3668611">:=</span>&nbsp;<span class="ident" id="3668614">out</span><span class="op" id="3668617">.</span><span class="ident" id="3668618">Write</span><span class="op" id="3668623">(</span><span class="op" id="3668624">[</span><span class="op" id="3668625">]</span><span class="builtintype" id="3668626">byte</span><span class="op" id="3668630">(</span><span class="ident" id="3668631">k</span>&nbsp;<span class="op" id="3668633">+</span>&nbsp;<span class="string" id="3668635">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="3668640">+</span>&nbsp;<span class="ident" id="3668642">v</span>&nbsp;<span class="op" id="3668644">+</span>&nbsp;<span class="string" id="3668646">&#34;\n&#34;</span><span class="op" id="3668650">)</span><span class="op" id="3668651">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668654">return</span>&nbsp;<span class="ident" id="3668661">err</span><br>
<span class="lineno"></span><span class="op" id="3668665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3668668">func</span>&nbsp;<span class="ident" id="3668673">Encode</span><span class="op" id="3668679">(</span><span class="ident" id="3668680">out</span>&nbsp;<span class="ident" id="3668684">io</span><span class="op" id="3668686">.</span><span class="ident" id="3668687">Writer</span><span class="op" id="3668693">,</span>&nbsp;<span class="ident" id="3668695">b</span>&nbsp;<span class="op" id="3668697">*</span><span class="ident" id="3668698">Block</span><span class="op" id="3668703">)</span>&nbsp;<span class="builtintype" id="3668705">error</span>&nbsp;<span class="op" id="3668711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668714">if</span>&nbsp;<span class="ident" id="3668717">_</span><span class="op" id="3668718">,</span>&nbsp;<span class="ident" id="3668720">err</span>&nbsp;<span class="op" id="3668724">:=</span>&nbsp;<span class="ident" id="3668727">out</span><span class="op" id="3668730">.</span><span class="ident" id="3668731">Write</span><span class="op" id="3668736">(</span><span class="ident" id="3668737">pemStart</span><span class="op" id="3668745">[</span><span class="num" id="3668746">1</span><span class="op" id="3668747">:</span><span class="op" id="3668748">]</span><span class="op" id="3668749">)</span><span class="op" id="3668750">;</span>&nbsp;<span class="ident" id="3668752">err</span>&nbsp;<span class="op" id="3668756">!=</span>&nbsp;<span class="ident" id="3668759">nil</span>&nbsp;<span class="op" id="3668763">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668767">return</span>&nbsp;<span class="ident" id="3668774">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3668779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668782">if</span>&nbsp;<span class="ident" id="3668785">_</span><span class="op" id="3668786">,</span>&nbsp;<span class="ident" id="3668788">err</span>&nbsp;<span class="op" id="3668792">:=</span>&nbsp;<span class="ident" id="3668795">out</span><span class="op" id="3668798">.</span><span class="ident" id="3668799">Write</span><span class="op" id="3668804">(</span><span class="op" id="3668805">[</span><span class="op" id="3668806">]</span><span class="builtintype" id="3668807">byte</span><span class="op" id="3668811">(</span><span class="ident" id="3668812">b</span><span class="op" id="3668813">.</span><span class="ident" id="3668814">Type</span>&nbsp;<span class="op" id="3668819">+</span>&nbsp;<span class="string" id="3668821">&#34;-----\n&#34;</span><span class="op" id="3668830">)</span><span class="op" id="3668831">)</span><span class="op" id="3668832">;</span>&nbsp;<span class="ident" id="3668834">err</span>&nbsp;<span class="op" id="3668838">!=</span>&nbsp;<span class="ident" id="3668841">nil</span>&nbsp;<span class="op" id="3668845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668849">return</span>&nbsp;<span class="ident" id="3668856">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3668861">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668865">if</span>&nbsp;<span class="builtinfunc" id="3668868">len</span><span class="op" id="3668871">(</span><span class="ident" id="3668872">b</span><span class="op" id="3668873">.</span><span class="ident" id="3668874">Headers</span><span class="op" id="3668881">)</span>&nbsp;<span class="op" id="3668883">&gt;</span>&nbsp;<span class="num" id="3668885">0</span>&nbsp;<span class="op" id="3668887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668891">const</span>&nbsp;<span class="ident" id="3668897">procType</span>&nbsp;<span class="op" id="3668906">=</span>&nbsp;<span class="string" id="3668908">&#34;Proc-Type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668922">h</span>&nbsp;<span class="op" id="3668924">:=</span>&nbsp;<span class="builtinfunc" id="3668927">make</span><span class="op" id="3668931">(</span><span class="op" id="3668932">[</span><span class="op" id="3668933">]</span><span class="builtintype" id="3668934">string</span><span class="op" id="3668940">,</span>&nbsp;<span class="num" id="3668942">0</span><span class="op" id="3668943">,</span>&nbsp;<span class="builtinfunc" id="3668945">len</span><span class="op" id="3668948">(</span><span class="ident" id="3668949">b</span><span class="op" id="3668950">.</span><span class="ident" id="3668951">Headers</span><span class="op" id="3668958">)</span><span class="op" id="3668959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668963">hasProcType</span>&nbsp;<span class="op" id="3668975">:=</span>&nbsp;<span class="builtintype" id="3668978">false</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668986">for</span>&nbsp;<span class="ident" id="3668990">k</span>&nbsp;<span class="op" id="3668992">:=</span>&nbsp;<span class="keyword" id="3668995">range</span>&nbsp;<span class="ident" id="3669001">b</span><span class="op" id="3669002">.</span><span class="ident" id="3669003">Headers</span>&nbsp;<span class="op" id="3669011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669016">if</span>&nbsp;<span class="ident" id="3669019">k</span>&nbsp;<span class="op" id="3669021">==</span>&nbsp;<span class="ident" id="3669024">procType</span>&nbsp;<span class="op" id="3669033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669039">hasProcType</span>&nbsp;<span class="op" id="3669051">=</span>&nbsp;<span class="builtintype" id="3669053">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669062">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669074">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669079">h</span>&nbsp;<span class="op" id="3669081">=</span>&nbsp;<span class="builtinfunc" id="3669083">append</span><span class="op" id="3669089">(</span><span class="ident" id="3669090">h</span><span class="op" id="3669091">,</span>&nbsp;<span class="ident" id="3669093">k</span><span class="op" id="3669094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3669102">//&nbsp;The&nbsp;Proc-Type&nbsp;header&nbsp;must&nbsp;be&nbsp;written&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3669151">//&nbsp;See&nbsp;RFC&nbsp;1421,&nbsp;section&nbsp;4.6.1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669186">if</span>&nbsp;<span class="ident" id="3669189">hasProcType</span>&nbsp;<span class="op" id="3669201">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669206">if</span>&nbsp;<span class="ident" id="3669209">err</span>&nbsp;<span class="op" id="3669213">:=</span>&nbsp;<span class="ident" id="3669216">writeHeader</span><span class="op" id="3669227">(</span><span class="ident" id="3669228">out</span><span class="op" id="3669231">,</span>&nbsp;<span class="ident" id="3669233">procType</span><span class="op" id="3669241">,</span>&nbsp;<span class="ident" id="3669243">b</span><span class="op" id="3669244">.</span><span class="ident" id="3669245">Headers</span><span class="op" id="3669252">[</span><span class="ident" id="3669253">procType</span><span class="op" id="3669261">]</span><span class="op" id="3669262">)</span><span class="op" id="3669263">;</span>&nbsp;<span class="ident" id="3669265">err</span>&nbsp;<span class="op" id="3669269">!=</span>&nbsp;<span class="ident" id="3669272">nil</span>&nbsp;<span class="op" id="3669276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669282">return</span>&nbsp;<span class="ident" id="3669289">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3669304">//&nbsp;For&nbsp;consistency&nbsp;of&nbsp;output,&nbsp;write&nbsp;other&nbsp;headers&nbsp;sorted&nbsp;by&nbsp;key.</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669371">sort</span><span class="op" id="3669375">.</span><span class="ident" id="3669376">Strings</span><span class="op" id="3669383">(</span><span class="ident" id="3669384">h</span><span class="op" id="3669385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669389">for</span>&nbsp;<span class="ident" id="3669393">_</span><span class="op" id="3669394">,</span>&nbsp;<span class="ident" id="3669396">k</span>&nbsp;<span class="op" id="3669398">:=</span>&nbsp;<span class="keyword" id="3669401">range</span>&nbsp;<span class="ident" id="3669407">h</span>&nbsp;<span class="op" id="3669409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669414">if</span>&nbsp;<span class="ident" id="3669417">err</span>&nbsp;<span class="op" id="3669421">:=</span>&nbsp;<span class="ident" id="3669424">writeHeader</span><span class="op" id="3669435">(</span><span class="ident" id="3669436">out</span><span class="op" id="3669439">,</span>&nbsp;<span class="ident" id="3669441">k</span><span class="op" id="3669442">,</span>&nbsp;<span class="ident" id="3669444">b</span><span class="op" id="3669445">.</span><span class="ident" id="3669446">Headers</span><span class="op" id="3669453">[</span><span class="ident" id="3669454">k</span><span class="op" id="3669455">]</span><span class="op" id="3669456">)</span><span class="op" id="3669457">;</span>&nbsp;<span class="ident" id="3669459">err</span>&nbsp;<span class="op" id="3669463">!=</span>&nbsp;<span class="ident" id="3669466">nil</span>&nbsp;<span class="op" id="3669470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669476">return</span>&nbsp;<span class="ident" id="3669483">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669490">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669498">if</span>&nbsp;<span class="ident" id="3669501">_</span><span class="op" id="3669502">,</span>&nbsp;<span class="ident" id="3669504">err</span>&nbsp;<span class="op" id="3669508">:=</span>&nbsp;<span class="ident" id="3669511">out</span><span class="op" id="3669514">.</span><span class="ident" id="3669515">Write</span><span class="op" id="3669520">(</span><span class="op" id="3669521">[</span><span class="op" id="3669522">]</span><span class="builtintype" id="3669523">byte</span><span class="op" id="3669527">{</span><span class="string" id="3669528">&#39;\n&#39;</span><span class="op" id="3669532">}</span><span class="op" id="3669533">)</span><span class="op" id="3669534">;</span>&nbsp;<span class="ident" id="3669536">err</span>&nbsp;<span class="op" id="3669540">!=</span>&nbsp;<span class="ident" id="3669543">nil</span>&nbsp;<span class="op" id="3669547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669552">return</span>&nbsp;<span class="ident" id="3669559">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669568">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669572">var</span>&nbsp;<span class="ident" id="3669576">breaker</span>&nbsp;<span class="ident" id="3669584">lineBreaker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669597">breaker</span><span class="op" id="3669604">.</span><span class="ident" id="3669605">out</span>&nbsp;<span class="op" id="3669609">=</span>&nbsp;<span class="ident" id="3669611">out</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669617">b64</span>&nbsp;<span class="op" id="3669621">:=</span>&nbsp;<span class="ident" id="3669624">base64</span><span class="op" id="3669630">.</span><span class="ident" id="3669631">NewEncoder</span><span class="op" id="3669641">(</span><span class="ident" id="3669642">base64</span><span class="op" id="3669648">.</span><span class="ident" id="3669649">StdEncoding</span><span class="op" id="3669660">,</span>&nbsp;<span class="op" id="3669662">&amp;</span><span class="ident" id="3669663">breaker</span><span class="op" id="3669670">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669673">if</span>&nbsp;<span class="ident" id="3669676">_</span><span class="op" id="3669677">,</span>&nbsp;<span class="ident" id="3669679">err</span>&nbsp;<span class="op" id="3669683">:=</span>&nbsp;<span class="ident" id="3669686">b64</span><span class="op" id="3669689">.</span><span class="ident" id="3669690">Write</span><span class="op" id="3669695">(</span><span class="ident" id="3669696">b</span><span class="op" id="3669697">.</span><span class="ident" id="3669698">Bytes</span><span class="op" id="3669703">)</span><span class="op" id="3669704">;</span>&nbsp;<span class="ident" id="3669706">err</span>&nbsp;<span class="op" id="3669710">!=</span>&nbsp;<span class="ident" id="3669713">nil</span>&nbsp;<span class="op" id="3669717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669721">return</span>&nbsp;<span class="ident" id="3669728">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669736">b64</span><span class="op" id="3669739">.</span><span class="ident" id="3669740">Close</span><span class="op" id="3669745">(</span><span class="op" id="3669746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669749">breaker</span><span class="op" id="3669756">.</span><span class="ident" id="3669757">Close</span><span class="op" id="3669762">(</span><span class="op" id="3669763">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669767">if</span>&nbsp;<span class="ident" id="3669770">_</span><span class="op" id="3669771">,</span>&nbsp;<span class="ident" id="3669773">err</span>&nbsp;<span class="op" id="3669777">:=</span>&nbsp;<span class="ident" id="3669780">out</span><span class="op" id="3669783">.</span><span class="ident" id="3669784">Write</span><span class="op" id="3669789">(</span><span class="ident" id="3669790">pemEnd</span><span class="op" id="3669796">[</span><span class="num" id="3669797">1</span><span class="op" id="3669798">:</span><span class="op" id="3669799">]</span><span class="op" id="3669800">)</span><span class="op" id="3669801">;</span>&nbsp;<span class="ident" id="3669803">err</span>&nbsp;<span class="op" id="3669807">!=</span>&nbsp;<span class="ident" id="3669810">nil</span>&nbsp;<span class="op" id="3669814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669818">return</span>&nbsp;<span class="ident" id="3669825">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669833">_</span><span class="op" id="3669834">,</span>&nbsp;<span class="ident" id="3669836">err</span>&nbsp;<span class="op" id="3669840">:=</span>&nbsp;<span class="ident" id="3669843">out</span><span class="op" id="3669846">.</span><span class="ident" id="3669847">Write</span><span class="op" id="3669852">(</span><span class="op" id="3669853">[</span><span class="op" id="3669854">]</span><span class="builtintype" id="3669855">byte</span><span class="op" id="3669859">(</span><span class="ident" id="3669860">b</span><span class="op" id="3669861">.</span><span class="ident" id="3669862">Type</span>&nbsp;<span class="op" id="3669867">+</span>&nbsp;<span class="string" id="3669869">&#34;-----\n&#34;</span><span class="op" id="3669878">)</span><span class="op" id="3669879">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669882">return</span>&nbsp;<span class="ident" id="3669889">err</span><br>
<span class="lineno"></span><span class="op" id="3669893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3669896">func</span>&nbsp;<span class="ident" id="3669901">EncodeToMemory</span><span class="op" id="3669915">(</span><span class="ident" id="3669916">b</span>&nbsp;<span class="op" id="3669918">*</span><span class="ident" id="3669919">Block</span><span class="op" id="3669924">)</span>&nbsp;<span class="op" id="3669926">[</span><span class="op" id="3669927">]</span><span class="builtintype" id="3669928">byte</span>&nbsp;<span class="op" id="3669933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669936">var</span>&nbsp;<span class="ident" id="3669940">buf</span>&nbsp;<span class="ident" id="3669944">bytes</span><span class="op" id="3669949">.</span><span class="ident" id="3669950">Buffer</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669958">Encode</span><span class="op" id="3669964">(</span><span class="op" id="3669965">&amp;</span><span class="ident" id="3669966">buf</span><span class="op" id="3669969">,</span>&nbsp;<span class="ident" id="3669971">b</span><span class="op" id="3669972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669975">return</span>&nbsp;<span class="ident" id="3669982">buf</span><span class="op" id="3669985">.</span><span class="ident" id="3669986">Bytes</span><span class="op" id="3669991">(</span><span class="op" id="3669992">)</span><br>
<span class="lineno"></span><span class="op" id="3669994">}</span>
</div>
</body>
</html>
