<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6447973">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6448028">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6448082">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6448133">//&nbsp;Tests&nbsp;for&nbsp;package&nbsp;cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6448159">package</span>&nbsp;<span class="ident" id="6448167">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6448172">import</span>&nbsp;<span class="op" id="6448179">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6448182">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6448191">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6448198">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6448204">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6448211">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6448223">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6448244">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6448250">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6448261">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6448278">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6448289">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6448300">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6448311">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6448322">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6448329">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6448332">func</span>&nbsp;<span class="ident" id="6448337">newRequest</span><span class="op" id="6448347">(</span><span class="ident" id="6448348">httpreq</span>&nbsp;<span class="builtintype" id="6448356">string</span><span class="op" id="6448362">)</span>&nbsp;<span class="op" id="6448364">*</span><span class="ident" id="6448365">http</span><span class="op" id="6448369">.</span><span class="ident" id="6448370">Request</span>&nbsp;<span class="op" id="6448378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6448381">buf</span>&nbsp;<span class="op" id="6448385">:=</span>&nbsp;<span class="ident" id="6448388">bufio</span><span class="op" id="6448393">.</span><span class="ident" id="6448394">NewReader</span><span class="op" id="6448403">(</span><span class="ident" id="6448404">strings</span><span class="op" id="6448411">.</span><span class="ident" id="6448412">NewReader</span><span class="op" id="6448421">(</span><span class="ident" id="6448422">httpreq</span><span class="op" id="6448429">)</span><span class="op" id="6448430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6448433">req</span><span class="op" id="6448436">,</span>&nbsp;<span class="ident" id="6448438">err</span>&nbsp;<span class="op" id="6448442">:=</span>&nbsp;<span class="ident" id="6448445">http</span><span class="op" id="6448449">.</span><span class="ident" id="6448450">ReadRequest</span><span class="op" id="6448461">(</span><span class="ident" id="6448462">buf</span><span class="op" id="6448465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6448468">if</span>&nbsp;<span class="ident" id="6448471">err</span>&nbsp;<span class="op" id="6448475">!=</span>&nbsp;<span class="ident" id="6448478">nil</span>&nbsp;<span class="op" id="6448482">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6448486">panic</span><span class="op" id="6448491">(</span><span class="string" id="6448492">&#34;cgi:&nbsp;bogus&nbsp;http&nbsp;request&nbsp;in&nbsp;test:&nbsp;&#34;</span>&nbsp;<span class="op" id="6448528">+</span>&nbsp;<span class="ident" id="6448530">httpreq</span><span class="op" id="6448537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6448540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6448543">req</span><span class="op" id="6448546">.</span><span class="ident" id="6448547">RemoteAddr</span>&nbsp;<span class="op" id="6448558">=</span>&nbsp;<span class="string" id="6448560">&#34;1.2.3.4&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6448571">return</span>&nbsp;<span class="ident" id="6448578">req</span><br>
<span class="lineno"></span><span class="op" id="6448582">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="6448585">func</span>&nbsp;<span class="ident" id="6448590">runCgiTest</span><span class="op" id="6448600">(</span><span class="ident" id="6448601">t</span>&nbsp;<span class="op" id="6448603">*</span><span class="ident" id="6448604">testing</span><span class="op" id="6448611">.</span><span class="ident" id="6448612">T</span><span class="op" id="6448613">,</span>&nbsp;<span class="ident" id="6448615">h</span>&nbsp;<span class="op" id="6448617">*</span><span class="ident" id="6448618">Handler</span><span class="op" id="6448625">,</span>&nbsp;<span class="ident" id="6448627">httpreq</span>&nbsp;<span class="builtintype" id="6448635">string</span><span class="op" id="6448641">,</span>&nbsp;<span class="ident" id="6448643">expectedMap</span>&nbsp;<span class="keyword" id="6448655">map</span><span class="op" id="6448658">[</span><span class="builtintype" id="6448659">string</span><span class="op" id="6448665">]</span><span class="builtintype" id="6448666">string</span><span class="op" id="6448672">)</span>&nbsp;<span class="op" id="6448674">*</span><span class="ident" id="6448675">httptest</span><span class="op" id="6448683">.</span><span class="ident" id="6448684">ResponseRecorder</span>&nbsp;<span class="op" id="6448701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6448704">rw</span>&nbsp;<span class="op" id="6448707">:=</span>&nbsp;<span class="ident" id="6448710">httptest</span><span class="op" id="6448718">.</span><span class="ident" id="6448719">NewRecorder</span><span class="op" id="6448730">(</span><span class="op" id="6448731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6448734">req</span>&nbsp;<span class="op" id="6448738">:=</span>&nbsp;<span class="ident" id="6448741">newRequest</span><span class="op" id="6448751">(</span><span class="ident" id="6448752">httpreq</span><span class="op" id="6448759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6448762">h</span><span class="op" id="6448763">.</span><span class="ident" id="6448764">ServeHTTP</span><span class="op" id="6448773">(</span><span class="ident" id="6448774">rw</span><span class="op" id="6448776">,</span>&nbsp;<span class="ident" id="6448778">req</span><span class="op" id="6448781">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6448785">//&nbsp;Make&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;the&nbsp;test&nbsp;map&nbsp;that&nbsp;the&nbsp;CGI&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6448843">m</span>&nbsp;<span class="op" id="6448845">:=</span>&nbsp;<span class="builtinfunc" id="6448848">make</span><span class="op" id="6448852">(</span><span class="keyword" id="6448853">map</span><span class="op" id="6448856">[</span><span class="builtintype" id="6448857">string</span><span class="op" id="6448863">]</span><span class="builtintype" id="6448864">string</span><span class="op" id="6448870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6448873">m</span><span class="op" id="6448874">[</span><span class="string" id="6448875">&#34;_body&#34;</span><span class="op" id="6448882">]</span>&nbsp;<span class="op" id="6448884">=</span>&nbsp;<span class="ident" id="6448886">rw</span><span class="op" id="6448888">.</span><span class="ident" id="6448889">Body</span><span class="op" id="6448893">.</span><span class="ident" id="6448894">String</span><span class="op" id="6448900">(</span><span class="op" id="6448901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6448904">linesRead</span>&nbsp;<span class="op" id="6448914">:=</span>&nbsp;<span class="num" id="6448917">0</span><br>
<span class="lineno">45</span><span class="ident" id="6448919">readlines</span><span class="op" id="6448928">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6448931">for</span>&nbsp;<span class="op" id="6448935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6448939">line</span><span class="op" id="6448943">,</span>&nbsp;<span class="ident" id="6448945">err</span>&nbsp;<span class="op" id="6448949">:=</span>&nbsp;<span class="ident" id="6448952">rw</span><span class="op" id="6448954">.</span><span class="ident" id="6448955">Body</span><span class="op" id="6448959">.</span><span class="ident" id="6448960">ReadString</span><span class="op" id="6448970">(</span><span class="string" id="6448971">&#39;\n&#39;</span><span class="op" id="6448975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6448979">switch</span>&nbsp;<span class="op" id="6448986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6448990">case</span>&nbsp;<span class="ident" id="6448995">err</span>&nbsp;<span class="op" id="6448999">==</span>&nbsp;<span class="ident" id="6449002">io</span><span class="op" id="6449004">.</span><span class="ident" id="6449005">EOF</span><span class="op" id="6449008">:</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6449013">break</span>&nbsp;<span class="ident" id="6449019">readlines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6449031">case</span>&nbsp;<span class="ident" id="6449036">err</span>&nbsp;<span class="op" id="6449040">!=</span>&nbsp;<span class="ident" id="6449043">nil</span><span class="op" id="6449046">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6449051">t</span><span class="op" id="6449052">.</span><span class="ident" id="6449053">Fatalf</span><span class="op" id="6449059">(</span><span class="string" id="6449060">&#34;unexpected&nbsp;error&nbsp;reading&nbsp;from&nbsp;CGI:&nbsp;%v&#34;</span><span class="op" id="6449099">,</span>&nbsp;<span class="ident" id="6449101">err</span><span class="op" id="6449104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6449108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6449112">linesRead</span><span class="op" id="6449121">++</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6449126">trimmedLine</span>&nbsp;<span class="op" id="6449138">:=</span>&nbsp;<span class="ident" id="6449141">strings</span><span class="op" id="6449148">.</span><span class="ident" id="6449149">TrimRight</span><span class="op" id="6449158">(</span><span class="ident" id="6449159">line</span><span class="op" id="6449163">,</span>&nbsp;<span class="string" id="6449165">&#34;\r\n&#34;</span><span class="op" id="6449171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6449175">split</span>&nbsp;<span class="op" id="6449181">:=</span>&nbsp;<span class="ident" id="6449184">strings</span><span class="op" id="6449191">.</span><span class="ident" id="6449192">SplitN</span><span class="op" id="6449198">(</span><span class="ident" id="6449199">trimmedLine</span><span class="op" id="6449210">,</span>&nbsp;<span class="string" id="6449212">&#34;=&#34;</span><span class="op" id="6449215">,</span>&nbsp;<span class="num" id="6449217">2</span><span class="op" id="6449218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6449222">if</span>&nbsp;<span class="builtinfunc" id="6449225">len</span><span class="op" id="6449228">(</span><span class="ident" id="6449229">split</span><span class="op" id="6449234">)</span>&nbsp;<span class="op" id="6449236">!=</span>&nbsp;<span class="num" id="6449239">2</span>&nbsp;<span class="op" id="6449241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6449246">t</span><span class="op" id="6449247">.</span><span class="ident" id="6449248">Fatalf</span><span class="op" id="6449254">(</span><span class="string" id="6449255">&#34;Unexpected&nbsp;%d&nbsp;parts&nbsp;from&nbsp;invalid&nbsp;line&nbsp;number&nbsp;%v:&nbsp;%q;&nbsp;existing&nbsp;map=%v&#34;</span><span class="op" id="6449325">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6449331">len</span><span class="op" id="6449334">(</span><span class="ident" id="6449335">split</span><span class="op" id="6449340">)</span><span class="op" id="6449341">,</span>&nbsp;<span class="ident" id="6449343">linesRead</span><span class="op" id="6449352">,</span>&nbsp;<span class="ident" id="6449354">line</span><span class="op" id="6449358">,</span>&nbsp;<span class="ident" id="6449360">m</span><span class="op" id="6449361">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6449365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6449369">m</span><span class="op" id="6449370">[</span><span class="ident" id="6449371">split</span><span class="op" id="6449376">[</span><span class="num" id="6449377">0</span><span class="op" id="6449378">]</span><span class="op" id="6449379">]</span>&nbsp;<span class="op" id="6449381">=</span>&nbsp;<span class="ident" id="6449383">split</span><span class="op" id="6449388">[</span><span class="num" id="6449389">1</span><span class="op" id="6449390">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6449393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6449397">for</span>&nbsp;<span class="ident" id="6449401">key</span><span class="op" id="6449404">,</span>&nbsp;<span class="ident" id="6449406">expected</span>&nbsp;<span class="op" id="6449415">:=</span>&nbsp;<span class="keyword" id="6449418">range</span>&nbsp;<span class="ident" id="6449424">expectedMap</span>&nbsp;<span class="op" id="6449436">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6449440">got</span>&nbsp;<span class="op" id="6449444">:=</span>&nbsp;<span class="ident" id="6449447">m</span><span class="op" id="6449448">[</span><span class="ident" id="6449449">key</span><span class="op" id="6449452">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6449456">if</span>&nbsp;<span class="ident" id="6449459">key</span>&nbsp;<span class="op" id="6449463">==</span>&nbsp;<span class="string" id="6449466">&#34;cwd&#34;</span>&nbsp;<span class="op" id="6449472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6449477">//&nbsp;For&nbsp;Windows.&nbsp;golang.org/issue/4645.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6449519">fi1</span><span class="op" id="6449522">,</span>&nbsp;<span class="ident" id="6449524">_</span>&nbsp;<span class="op" id="6449526">:=</span>&nbsp;<span class="ident" id="6449529">os</span><span class="op" id="6449531">.</span><span class="ident" id="6449532">Stat</span><span class="op" id="6449536">(</span><span class="ident" id="6449537">got</span><span class="op" id="6449540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6449545">fi2</span><span class="op" id="6449548">,</span>&nbsp;<span class="ident" id="6449550">_</span>&nbsp;<span class="op" id="6449552">:=</span>&nbsp;<span class="ident" id="6449555">os</span><span class="op" id="6449557">.</span><span class="ident" id="6449558">Stat</span><span class="op" id="6449562">(</span><span class="ident" id="6449563">expected</span><span class="op" id="6449571">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6449576">if</span>&nbsp;<span class="ident" id="6449579">os</span><span class="op" id="6449581">.</span><span class="ident" id="6449582">SameFile</span><span class="op" id="6449590">(</span><span class="ident" id="6449591">fi1</span><span class="op" id="6449594">,</span>&nbsp;<span class="ident" id="6449596">fi2</span><span class="op" id="6449599">)</span>&nbsp;<span class="op" id="6449601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6449607">got</span>&nbsp;<span class="op" id="6449611">=</span>&nbsp;<span class="ident" id="6449613">expected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6449625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6449629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6449633">if</span>&nbsp;<span class="ident" id="6449636">got</span>&nbsp;<span class="op" id="6449640">!=</span>&nbsp;<span class="ident" id="6449643">expected</span>&nbsp;<span class="op" id="6449652">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6449657">t</span><span class="op" id="6449658">.</span><span class="ident" id="6449659">Errorf</span><span class="op" id="6449665">(</span><span class="string" id="6449666">&#34;for&nbsp;key&nbsp;%q&nbsp;got&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6449698">,</span>&nbsp;<span class="ident" id="6449700">key</span><span class="op" id="6449703">,</span>&nbsp;<span class="ident" id="6449705">got</span><span class="op" id="6449708">,</span>&nbsp;<span class="ident" id="6449710">expected</span><span class="op" id="6449718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6449722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6449725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6449728">return</span>&nbsp;<span class="ident" id="6449735">rw</span><br>
<span class="lineno"></span><span class="op" id="6449738">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="6449741">var</span>&nbsp;<span class="ident" id="6449745">cgiTested</span><span class="op" id="6449754">,</span>&nbsp;<span class="ident" id="6449756">cgiWorks</span>&nbsp;<span class="builtintype" id="6449765">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6449771">func</span>&nbsp;<span class="ident" id="6449776">check</span><span class="op" id="6449781">(</span><span class="ident" id="6449782">t</span>&nbsp;<span class="op" id="6449784">*</span><span class="ident" id="6449785">testing</span><span class="op" id="6449792">.</span><span class="ident" id="6449793">T</span><span class="op" id="6449794">)</span>&nbsp;<span class="op" id="6449796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6449799">if</span>&nbsp;<span class="op" id="6449802">!</span><span class="ident" id="6449803">cgiTested</span>&nbsp;<span class="op" id="6449813">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6449817">cgiTested</span>&nbsp;<span class="op" id="6449827">=</span>&nbsp;<span class="builtintype" id="6449829">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6449836">cgiWorks</span>&nbsp;<span class="op" id="6449845">=</span>&nbsp;<span class="ident" id="6449847">exec</span><span class="op" id="6449851">.</span><span class="ident" id="6449852">Command</span><span class="op" id="6449859">(</span><span class="string" id="6449860">&#34;./testdata/test.cgi&#34;</span><span class="op" id="6449881">)</span><span class="op" id="6449882">.</span><span class="ident" id="6449883">Run</span><span class="op" id="6449886">(</span><span class="op" id="6449887">)</span>&nbsp;<span class="op" id="6449889">==</span>&nbsp;<span class="ident" id="6449892">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6449897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6449900">if</span>&nbsp;<span class="op" id="6449903">!</span><span class="ident" id="6449904">cgiWorks</span>&nbsp;<span class="op" id="6449913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6449917">//&nbsp;No&nbsp;Perl&nbsp;on&nbsp;Windows,&nbsp;needed&nbsp;by&nbsp;test.cgi</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6449961">//&nbsp;TODO:&nbsp;make&nbsp;the&nbsp;child&nbsp;process&nbsp;be&nbsp;Go,&nbsp;not&nbsp;Perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6450012">t</span><span class="op" id="6450013">.</span><span class="ident" id="6450014">Skip</span><span class="op" id="6450018">(</span><span class="string" id="6450019">&#34;Skipping&nbsp;test:&nbsp;test.cgi&nbsp;failed.&#34;</span><span class="op" id="6450052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6450055">}</span><br>
<span class="lineno"></span><span class="op" id="6450057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="6450060">func</span>&nbsp;<span class="ident" id="6450065">TestCGIBasicGet</span><span class="op" id="6450080">(</span><span class="ident" id="6450081">t</span>&nbsp;<span class="op" id="6450083">*</span><span class="ident" id="6450084">testing</span><span class="op" id="6450091">.</span><span class="ident" id="6450092">T</span><span class="op" id="6450093">)</span>&nbsp;<span class="op" id="6450095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6450098">check</span><span class="op" id="6450103">(</span><span class="ident" id="6450104">t</span><span class="op" id="6450105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6450108">h</span>&nbsp;<span class="op" id="6450110">:=</span>&nbsp;<span class="op" id="6450113">&amp;</span><span class="ident" id="6450114">Handler</span><span class="op" id="6450121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6450125">Path</span><span class="op" id="6450129">:</span>&nbsp;<span class="string" id="6450131">&#34;testdata/test.cgi&#34;</span><span class="op" id="6450150">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6450154">Root</span><span class="op" id="6450158">:</span>&nbsp;<span class="string" id="6450160">&#34;/test.cgi&#34;</span><span class="op" id="6450171">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6450174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6450177">expectedMap</span>&nbsp;<span class="op" id="6450189">:=</span>&nbsp;<span class="keyword" id="6450192">map</span><span class="op" id="6450195">[</span><span class="builtintype" id="6450196">string</span><span class="op" id="6450202">]</span><span class="builtintype" id="6450203">string</span><span class="op" id="6450209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6450213">&#34;test&#34;</span><span class="op" id="6450219">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6450238">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="6450249">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6450253">&#34;param-a&#34;</span><span class="op" id="6450262">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6450278">&#34;b&#34;</span><span class="op" id="6450281">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6450285">&#34;param-foo&#34;</span><span class="op" id="6450296">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6450310">&#34;bar&#34;</span><span class="op" id="6450315">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6450319">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="6450342">:</span>&nbsp;<span class="string" id="6450344">&#34;CGI/1.1&#34;</span><span class="op" id="6450353">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6450357">&#34;env-HTTP_HOST&#34;</span><span class="op" id="6450372">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6450382">&#34;example.com&#34;</span><span class="op" id="6450395">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6450399">&#34;env-PATH_INFO&#34;</span><span class="op" id="6450414">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6450424">&#34;&#34;</span><span class="op" id="6450426">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6450430">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6450448">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6450455">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="6450468">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6450472">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="6450489">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6450497">&#34;1.2.3.4&#34;</span><span class="op" id="6450506">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6450510">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="6450527">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6450535">&#34;1.2.3.4&#34;</span><span class="op" id="6450544">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6450548">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="6450568">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6450573">&#34;GET&#34;</span><span class="op" id="6450578">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6450582">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6450599">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6450607">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="6450630">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6450634">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6450655">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6450659">&#34;testdata/test.cgi&#34;</span><span class="op" id="6450678">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6450682">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6450699">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6450707">&#34;/test.cgi&#34;</span><span class="op" id="6450718">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6450722">&#34;env-SERVER_NAME&#34;</span><span class="op" id="6450739">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6450747">&#34;example.com&#34;</span><span class="op" id="6450760">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6450764">&#34;env-SERVER_PORT&#34;</span><span class="op" id="6450781">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6450789">&#34;80&#34;</span><span class="op" id="6450793">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6450797">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="6450818">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6450822">&#34;go&#34;</span><span class="op" id="6450826">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6450829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6450832">replay</span>&nbsp;<span class="op" id="6450839">:=</span>&nbsp;<span class="ident" id="6450842">runCgiTest</span><span class="op" id="6450852">(</span><span class="ident" id="6450853">t</span><span class="op" id="6450854">,</span>&nbsp;<span class="ident" id="6450856">h</span><span class="op" id="6450857">,</span>&nbsp;<span class="string" id="6450859">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6450918">,</span>&nbsp;<span class="ident" id="6450920">expectedMap</span><span class="op" id="6450931">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6450935">if</span>&nbsp;<span class="ident" id="6450938">expected</span><span class="op" id="6450946">,</span>&nbsp;<span class="ident" id="6450948">got</span>&nbsp;<span class="op" id="6450952">:=</span>&nbsp;<span class="string" id="6450955">&#34;text/html&#34;</span><span class="op" id="6450966">,</span>&nbsp;<span class="ident" id="6450968">replay</span><span class="op" id="6450974">.</span><span class="ident" id="6450975">Header</span><span class="op" id="6450981">(</span><span class="op" id="6450982">)</span><span class="op" id="6450983">.</span><span class="ident" id="6450984">Get</span><span class="op" id="6450987">(</span><span class="string" id="6450988">&#34;Content-Type&#34;</span><span class="op" id="6451002">)</span><span class="op" id="6451003">;</span>&nbsp;<span class="ident" id="6451005">got</span>&nbsp;<span class="op" id="6451009">!=</span>&nbsp;<span class="ident" id="6451012">expected</span>&nbsp;<span class="op" id="6451021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6451025">t</span><span class="op" id="6451026">.</span><span class="ident" id="6451027">Errorf</span><span class="op" id="6451033">(</span><span class="string" id="6451034">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6451073">,</span>&nbsp;<span class="ident" id="6451075">got</span><span class="op" id="6451078">,</span>&nbsp;<span class="ident" id="6451080">expected</span><span class="op" id="6451088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6451091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6451094">if</span>&nbsp;<span class="ident" id="6451097">expected</span><span class="op" id="6451105">,</span>&nbsp;<span class="ident" id="6451107">got</span>&nbsp;<span class="op" id="6451111">:=</span>&nbsp;<span class="string" id="6451114">&#34;X-Test-Value&#34;</span><span class="op" id="6451128">,</span>&nbsp;<span class="ident" id="6451130">replay</span><span class="op" id="6451136">.</span><span class="ident" id="6451137">Header</span><span class="op" id="6451143">(</span><span class="op" id="6451144">)</span><span class="op" id="6451145">.</span><span class="ident" id="6451146">Get</span><span class="op" id="6451149">(</span><span class="string" id="6451150">&#34;X-Test-Header&#34;</span><span class="op" id="6451165">)</span><span class="op" id="6451166">;</span>&nbsp;<span class="ident" id="6451168">got</span>&nbsp;<span class="op" id="6451172">!=</span>&nbsp;<span class="ident" id="6451175">expected</span>&nbsp;<span class="op" id="6451184">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6451188">t</span><span class="op" id="6451189">.</span><span class="ident" id="6451190">Errorf</span><span class="op" id="6451196">(</span><span class="string" id="6451197">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6451237">,</span>&nbsp;<span class="ident" id="6451239">got</span><span class="op" id="6451242">,</span>&nbsp;<span class="ident" id="6451244">expected</span><span class="op" id="6451252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6451255">}</span><br>
<span class="lineno"></span><span class="op" id="6451257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6451260">func</span>&nbsp;<span class="ident" id="6451265">TestCGIBasicGetAbsPath</span><span class="op" id="6451287">(</span><span class="ident" id="6451288">t</span>&nbsp;<span class="op" id="6451290">*</span><span class="ident" id="6451291">testing</span><span class="op" id="6451298">.</span><span class="ident" id="6451299">T</span><span class="op" id="6451300">)</span>&nbsp;<span class="op" id="6451302">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6451305">check</span><span class="op" id="6451310">(</span><span class="ident" id="6451311">t</span><span class="op" id="6451312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6451315">pwd</span><span class="op" id="6451318">,</span>&nbsp;<span class="ident" id="6451320">err</span>&nbsp;<span class="op" id="6451324">:=</span>&nbsp;<span class="ident" id="6451327">os</span><span class="op" id="6451329">.</span><span class="ident" id="6451330">Getwd</span><span class="op" id="6451335">(</span><span class="op" id="6451336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6451339">if</span>&nbsp;<span class="ident" id="6451342">err</span>&nbsp;<span class="op" id="6451346">!=</span>&nbsp;<span class="ident" id="6451349">nil</span>&nbsp;<span class="op" id="6451353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6451357">t</span><span class="op" id="6451358">.</span><span class="ident" id="6451359">Fatalf</span><span class="op" id="6451365">(</span><span class="string" id="6451366">&#34;getwd&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6451383">,</span>&nbsp;<span class="ident" id="6451385">err</span><span class="op" id="6451388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6451391">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6451394">h</span>&nbsp;<span class="op" id="6451396">:=</span>&nbsp;<span class="op" id="6451399">&amp;</span><span class="ident" id="6451400">Handler</span><span class="op" id="6451407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6451411">Path</span><span class="op" id="6451415">:</span>&nbsp;<span class="ident" id="6451417">pwd</span>&nbsp;<span class="op" id="6451421">+</span>&nbsp;<span class="string" id="6451423">&#34;/testdata/test.cgi&#34;</span><span class="op" id="6451443">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6451447">Root</span><span class="op" id="6451451">:</span>&nbsp;<span class="string" id="6451453">&#34;/test.cgi&#34;</span><span class="op" id="6451464">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6451467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6451470">expectedMap</span>&nbsp;<span class="op" id="6451482">:=</span>&nbsp;<span class="keyword" id="6451485">map</span><span class="op" id="6451488">[</span><span class="builtintype" id="6451489">string</span><span class="op" id="6451495">]</span><span class="builtintype" id="6451496">string</span><span class="op" id="6451502">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6451506">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6451523">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6451529">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="6451552">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6451556">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6451577">:</span>&nbsp;<span class="ident" id="6451579">pwd</span>&nbsp;<span class="op" id="6451583">+</span>&nbsp;<span class="string" id="6451585">&#34;/testdata/test.cgi&#34;</span><span class="op" id="6451605">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6451609">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6451626">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6451632">&#34;/test.cgi&#34;</span><span class="op" id="6451643">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6451646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6451649">runCgiTest</span><span class="op" id="6451659">(</span><span class="ident" id="6451660">t</span><span class="op" id="6451661">,</span>&nbsp;<span class="ident" id="6451663">h</span><span class="op" id="6451664">,</span>&nbsp;<span class="string" id="6451666">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6451725">,</span>&nbsp;<span class="ident" id="6451727">expectedMap</span><span class="op" id="6451738">)</span><br>
<span class="lineno">145</span><span class="op" id="6451740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6451743">func</span>&nbsp;<span class="ident" id="6451748">TestPathInfo</span><span class="op" id="6451760">(</span><span class="ident" id="6451761">t</span>&nbsp;<span class="op" id="6451763">*</span><span class="ident" id="6451764">testing</span><span class="op" id="6451771">.</span><span class="ident" id="6451772">T</span><span class="op" id="6451773">)</span>&nbsp;<span class="op" id="6451775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6451778">check</span><span class="op" id="6451783">(</span><span class="ident" id="6451784">t</span><span class="op" id="6451785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6451788">h</span>&nbsp;<span class="op" id="6451790">:=</span>&nbsp;<span class="op" id="6451793">&amp;</span><span class="ident" id="6451794">Handler</span><span class="op" id="6451801">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6451805">Path</span><span class="op" id="6451809">:</span>&nbsp;<span class="string" id="6451811">&#34;testdata/test.cgi&#34;</span><span class="op" id="6451830">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6451834">Root</span><span class="op" id="6451838">:</span>&nbsp;<span class="string" id="6451840">&#34;/test.cgi&#34;</span><span class="op" id="6451851">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6451854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6451857">expectedMap</span>&nbsp;<span class="op" id="6451869">:=</span>&nbsp;<span class="keyword" id="6451872">map</span><span class="op" id="6451875">[</span><span class="builtintype" id="6451876">string</span><span class="op" id="6451882">]</span><span class="builtintype" id="6451883">string</span><span class="op" id="6451889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6451893">&#34;param-a&#34;</span><span class="op" id="6451902">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6451916">&#34;b&#34;</span><span class="op" id="6451919">,</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6451923">&#34;env-PATH_INFO&#34;</span><span class="op" id="6451938">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6451946">&#34;/extrapath&#34;</span><span class="op" id="6451958">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6451962">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6451980">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6451985">&#34;a=b&#34;</span><span class="op" id="6451990">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6451994">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6452011">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6452017">&#34;/test.cgi/extrapath?a=b&#34;</span><span class="op" id="6452042">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6452046">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6452067">:</span>&nbsp;<span class="string" id="6452069">&#34;testdata/test.cgi&#34;</span><span class="op" id="6452088">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6452092">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6452109">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6452115">&#34;/test.cgi&#34;</span><span class="op" id="6452126">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6452129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6452132">runCgiTest</span><span class="op" id="6452142">(</span><span class="ident" id="6452143">t</span><span class="op" id="6452144">,</span>&nbsp;<span class="ident" id="6452146">h</span><span class="op" id="6452147">,</span>&nbsp;<span class="string" id="6452149">&#34;GET&nbsp;/test.cgi/extrapath?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6452210">,</span>&nbsp;<span class="ident" id="6452212">expectedMap</span><span class="op" id="6452223">)</span><br>
<span class="lineno"></span><span class="op" id="6452225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6452228">func</span>&nbsp;<span class="ident" id="6452233">TestPathInfoDirRoot</span><span class="op" id="6452252">(</span><span class="ident" id="6452253">t</span>&nbsp;<span class="op" id="6452255">*</span><span class="ident" id="6452256">testing</span><span class="op" id="6452263">.</span><span class="ident" id="6452264">T</span><span class="op" id="6452265">)</span>&nbsp;<span class="op" id="6452267">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6452270">check</span><span class="op" id="6452275">(</span><span class="ident" id="6452276">t</span><span class="op" id="6452277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6452280">h</span>&nbsp;<span class="op" id="6452282">:=</span>&nbsp;<span class="op" id="6452285">&amp;</span><span class="ident" id="6452286">Handler</span><span class="op" id="6452293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6452297">Path</span><span class="op" id="6452301">:</span>&nbsp;<span class="string" id="6452303">&#34;testdata/test.cgi&#34;</span><span class="op" id="6452322">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6452326">Root</span><span class="op" id="6452330">:</span>&nbsp;<span class="string" id="6452332">&#34;/myscript/&#34;</span><span class="op" id="6452344">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6452347">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6452350">expectedMap</span>&nbsp;<span class="op" id="6452362">:=</span>&nbsp;<span class="keyword" id="6452365">map</span><span class="op" id="6452368">[</span><span class="builtintype" id="6452369">string</span><span class="op" id="6452375">]</span><span class="builtintype" id="6452376">string</span><span class="op" id="6452382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6452386">&#34;env-PATH_INFO&#34;</span><span class="op" id="6452401">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6452409">&#34;bar&#34;</span><span class="op" id="6452414">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6452418">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6452436">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6452441">&#34;a=b&#34;</span><span class="op" id="6452446">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6452450">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6452467">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6452473">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="6452492">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6452496">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6452517">:</span>&nbsp;<span class="string" id="6452519">&#34;testdata/test.cgi&#34;</span><span class="op" id="6452538">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6452542">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6452559">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6452565">&#34;/myscript/&#34;</span><span class="op" id="6452577">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6452580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6452583">runCgiTest</span><span class="op" id="6452593">(</span><span class="ident" id="6452594">t</span><span class="op" id="6452595">,</span>&nbsp;<span class="ident" id="6452597">h</span><span class="op" id="6452598">,</span>&nbsp;<span class="string" id="6452600">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6452655">,</span>&nbsp;<span class="ident" id="6452657">expectedMap</span><span class="op" id="6452668">)</span><br>
<span class="lineno"></span><span class="op" id="6452670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6452673">func</span>&nbsp;<span class="ident" id="6452678">TestDupHeaders</span><span class="op" id="6452692">(</span><span class="ident" id="6452693">t</span>&nbsp;<span class="op" id="6452695">*</span><span class="ident" id="6452696">testing</span><span class="op" id="6452703">.</span><span class="ident" id="6452704">T</span><span class="op" id="6452705">)</span>&nbsp;<span class="op" id="6452707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6452710">check</span><span class="op" id="6452715">(</span><span class="ident" id="6452716">t</span><span class="op" id="6452717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6452720">h</span>&nbsp;<span class="op" id="6452722">:=</span>&nbsp;<span class="op" id="6452725">&amp;</span><span class="ident" id="6452726">Handler</span><span class="op" id="6452733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6452737">Path</span><span class="op" id="6452741">:</span>&nbsp;<span class="string" id="6452743">&#34;testdata/test.cgi&#34;</span><span class="op" id="6452762">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6452765">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6452768">expectedMap</span>&nbsp;<span class="op" id="6452780">:=</span>&nbsp;<span class="keyword" id="6452783">map</span><span class="op" id="6452786">[</span><span class="builtintype" id="6452787">string</span><span class="op" id="6452793">]</span><span class="builtintype" id="6452794">string</span><span class="op" id="6452800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6452804">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6452821">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6452827">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="6452846">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6452850">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6452871">:</span>&nbsp;<span class="string" id="6452873">&#34;testdata/test.cgi&#34;</span><span class="op" id="6452892">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6452896">&#34;env-HTTP_COOKIE&#34;</span><span class="op" id="6452913">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6452919">&#34;nom=NOM;&nbsp;yum=YUM&#34;</span><span class="op" id="6452937">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6452941">&#34;env-HTTP_X_FOO&#34;</span><span class="op" id="6452957">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6452964">&#34;val1,&nbsp;val2&#34;</span><span class="op" id="6452976">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6452979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6452982">runCgiTest</span><span class="op" id="6452992">(</span><span class="ident" id="6452993">t</span><span class="op" id="6452994">,</span>&nbsp;<span class="ident" id="6452996">h</span><span class="op" id="6452997">,</span>&nbsp;<span class="string" id="6452999">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\n&#34;</span><span class="op" id="6453033">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6453037">&#34;Cookie:&nbsp;nom=NOM\n&#34;</span><span class="op" id="6453056">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6453060">&#34;Cookie:&nbsp;yum=YUM\n&#34;</span><span class="op" id="6453079">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6453083">&#34;X-Foo:&nbsp;val1\n&#34;</span><span class="op" id="6453098">+</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6453102">&#34;X-Foo:&nbsp;val2\n&#34;</span><span class="op" id="6453117">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6453121">&#34;Host:&nbsp;example.com\n\n&#34;</span><span class="op" id="6453144">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6453148">expectedMap</span><span class="op" id="6453159">)</span><br>
<span class="lineno"></span><span class="op" id="6453161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="6453164">func</span>&nbsp;<span class="ident" id="6453169">TestPathInfoNoRoot</span><span class="op" id="6453187">(</span><span class="ident" id="6453188">t</span>&nbsp;<span class="op" id="6453190">*</span><span class="ident" id="6453191">testing</span><span class="op" id="6453198">.</span><span class="ident" id="6453199">T</span><span class="op" id="6453200">)</span>&nbsp;<span class="op" id="6453202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6453205">check</span><span class="op" id="6453210">(</span><span class="ident" id="6453211">t</span><span class="op" id="6453212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6453215">h</span>&nbsp;<span class="op" id="6453217">:=</span>&nbsp;<span class="op" id="6453220">&amp;</span><span class="ident" id="6453221">Handler</span><span class="op" id="6453228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6453232">Path</span><span class="op" id="6453236">:</span>&nbsp;<span class="string" id="6453238">&#34;testdata/test.cgi&#34;</span><span class="op" id="6453257">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6453261">Root</span><span class="op" id="6453265">:</span>&nbsp;<span class="string" id="6453267">&#34;&#34;</span><span class="op" id="6453269">,</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6453272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6453275">expectedMap</span>&nbsp;<span class="op" id="6453287">:=</span>&nbsp;<span class="keyword" id="6453290">map</span><span class="op" id="6453293">[</span><span class="builtintype" id="6453294">string</span><span class="op" id="6453300">]</span><span class="builtintype" id="6453301">string</span><span class="op" id="6453307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6453311">&#34;env-PATH_INFO&#34;</span><span class="op" id="6453326">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6453334">&#34;/bar&#34;</span><span class="op" id="6453340">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6453344">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6453362">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6453367">&#34;a=b&#34;</span><span class="op" id="6453372">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6453376">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6453393">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6453399">&#34;/bar?a=b&#34;</span><span class="op" id="6453409">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6453413">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6453434">:</span>&nbsp;<span class="string" id="6453436">&#34;testdata/test.cgi&#34;</span><span class="op" id="6453455">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6453459">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6453476">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6453482">&#34;/&#34;</span><span class="op" id="6453485">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6453488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6453491">runCgiTest</span><span class="op" id="6453501">(</span><span class="ident" id="6453502">t</span><span class="op" id="6453503">,</span>&nbsp;<span class="ident" id="6453505">h</span><span class="op" id="6453506">,</span>&nbsp;<span class="string" id="6453508">&#34;GET&nbsp;/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6453554">,</span>&nbsp;<span class="ident" id="6453556">expectedMap</span><span class="op" id="6453567">)</span><br>
<span class="lineno"></span><span class="op" id="6453569">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6453572">func</span>&nbsp;<span class="ident" id="6453577">TestCGIBasicPost</span><span class="op" id="6453593">(</span><span class="ident" id="6453594">t</span>&nbsp;<span class="op" id="6453596">*</span><span class="ident" id="6453597">testing</span><span class="op" id="6453604">.</span><span class="ident" id="6453605">T</span><span class="op" id="6453606">)</span>&nbsp;<span class="op" id="6453608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6453611">check</span><span class="op" id="6453616">(</span><span class="ident" id="6453617">t</span><span class="op" id="6453618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6453621">postReq</span>&nbsp;<span class="op" id="6453629">:=</span>&nbsp;<span class="string" id="6453632">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.0<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno">220</span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Content-Length:&nbsp;15<br>
<span class="lineno"></span><br>
<span class="lineno"></span>postfoo=postbar`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6453765">h</span>&nbsp;<span class="op" id="6453767">:=</span>&nbsp;<span class="op" id="6453770">&amp;</span><span class="ident" id="6453771">Handler</span><span class="op" id="6453778">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6453782">Path</span><span class="op" id="6453786">:</span>&nbsp;<span class="string" id="6453788">&#34;testdata/test.cgi&#34;</span><span class="op" id="6453807">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6453811">Root</span><span class="op" id="6453815">:</span>&nbsp;<span class="string" id="6453817">&#34;/test.cgi&#34;</span><span class="op" id="6453828">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6453831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6453834">expectedMap</span>&nbsp;<span class="op" id="6453846">:=</span>&nbsp;<span class="keyword" id="6453849">map</span><span class="op" id="6453852">[</span><span class="builtintype" id="6453853">string</span><span class="op" id="6453859">]</span><span class="builtintype" id="6453860">string</span><span class="op" id="6453866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6453870">&#34;test&#34;</span><span class="op" id="6453876">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6453892">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="6453903">,</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6453907">&#34;param-postfoo&#34;</span><span class="op" id="6453922">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6453929">&#34;postbar&#34;</span><span class="op" id="6453938">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6453942">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="6453962">:</span>&nbsp;<span class="string" id="6453964">&#34;POST&#34;</span><span class="op" id="6453970">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6453974">&#34;env-CONTENT_LENGTH&#34;</span><span class="op" id="6453994">:</span>&nbsp;<span class="string" id="6453996">&#34;15&#34;</span><span class="op" id="6454000">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6454004">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6454021">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6454026">&#34;/test.cgi?a=b&#34;</span><span class="op" id="6454041">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6454044">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6454047">runCgiTest</span><span class="op" id="6454057">(</span><span class="ident" id="6454058">t</span><span class="op" id="6454059">,</span>&nbsp;<span class="ident" id="6454061">h</span><span class="op" id="6454062">,</span>&nbsp;<span class="ident" id="6454064">postReq</span><span class="op" id="6454071">,</span>&nbsp;<span class="ident" id="6454073">expectedMap</span><span class="op" id="6454084">)</span><br>
<span class="lineno"></span><span class="op" id="6454086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6454089">func</span>&nbsp;<span class="ident" id="6454094">chunk</span><span class="op" id="6454099">(</span><span class="ident" id="6454100">s</span>&nbsp;<span class="builtintype" id="6454102">string</span><span class="op" id="6454108">)</span>&nbsp;<span class="builtintype" id="6454110">string</span>&nbsp;<span class="op" id="6454117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6454120">return</span>&nbsp;<span class="ident" id="6454127">fmt</span><span class="op" id="6454130">.</span><span class="ident" id="6454131">Sprintf</span><span class="op" id="6454138">(</span><span class="string" id="6454139">&#34;%x\r\n%s\r\n&#34;</span><span class="op" id="6454153">,</span>&nbsp;<span class="builtinfunc" id="6454155">len</span><span class="op" id="6454158">(</span><span class="ident" id="6454159">s</span><span class="op" id="6454160">)</span><span class="op" id="6454161">,</span>&nbsp;<span class="ident" id="6454163">s</span><span class="op" id="6454164">)</span><br>
<span class="lineno">240</span><span class="op" id="6454166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6454169">//&nbsp;The&nbsp;CGI&nbsp;spec&nbsp;doesn&#39;t&nbsp;allow&nbsp;chunked&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="6454217">func</span>&nbsp;<span class="ident" id="6454222">TestCGIPostChunked</span><span class="op" id="6454240">(</span><span class="ident" id="6454241">t</span>&nbsp;<span class="op" id="6454243">*</span><span class="ident" id="6454244">testing</span><span class="op" id="6454251">.</span><span class="ident" id="6454252">T</span><span class="op" id="6454253">)</span>&nbsp;<span class="op" id="6454255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6454258">check</span><span class="op" id="6454263">(</span><span class="ident" id="6454264">t</span><span class="op" id="6454265">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6454268">postReq</span>&nbsp;<span class="op" id="6454276">:=</span>&nbsp;<span class="string" id="6454279">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.1<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno"></span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Transfer-Encoding:&nbsp;chunked<br>
<span class="lineno"></span><br>
<span class="lineno">250</span>`</span>&nbsp;<span class="op" id="6454404">+</span>&nbsp;<span class="ident" id="6454406">chunk</span><span class="op" id="6454411">(</span><span class="string" id="6454412">&#34;postfoo&#34;</span><span class="op" id="6454421">)</span>&nbsp;<span class="op" id="6454423">+</span>&nbsp;<span class="ident" id="6454425">chunk</span><span class="op" id="6454430">(</span><span class="string" id="6454431">&#34;=&#34;</span><span class="op" id="6454434">)</span>&nbsp;<span class="op" id="6454436">+</span>&nbsp;<span class="ident" id="6454438">chunk</span><span class="op" id="6454443">(</span><span class="string" id="6454444">&#34;postbar&#34;</span><span class="op" id="6454453">)</span>&nbsp;<span class="op" id="6454455">+</span>&nbsp;<span class="ident" id="6454457">chunk</span><span class="op" id="6454462">(</span><span class="string" id="6454463">&#34;&#34;</span><span class="op" id="6454465">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6454469">h</span>&nbsp;<span class="op" id="6454471">:=</span>&nbsp;<span class="op" id="6454474">&amp;</span><span class="ident" id="6454475">Handler</span><span class="op" id="6454482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6454486">Path</span><span class="op" id="6454490">:</span>&nbsp;<span class="string" id="6454492">&#34;testdata/test.cgi&#34;</span><span class="op" id="6454511">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6454515">Root</span><span class="op" id="6454519">:</span>&nbsp;<span class="string" id="6454521">&#34;/test.cgi&#34;</span><span class="op" id="6454532">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6454535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6454538">expectedMap</span>&nbsp;<span class="op" id="6454550">:=</span>&nbsp;<span class="keyword" id="6454553">map</span><span class="op" id="6454556">[</span><span class="builtintype" id="6454557">string</span><span class="op" id="6454563">]</span><span class="builtintype" id="6454564">string</span><span class="op" id="6454570">{</span><span class="op" id="6454571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6454574">resp</span>&nbsp;<span class="op" id="6454579">:=</span>&nbsp;<span class="ident" id="6454582">runCgiTest</span><span class="op" id="6454592">(</span><span class="ident" id="6454593">t</span><span class="op" id="6454594">,</span>&nbsp;<span class="ident" id="6454596">h</span><span class="op" id="6454597">,</span>&nbsp;<span class="ident" id="6454599">postReq</span><span class="op" id="6454606">,</span>&nbsp;<span class="ident" id="6454608">expectedMap</span><span class="op" id="6454619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6454622">if</span>&nbsp;<span class="ident" id="6454625">got</span><span class="op" id="6454628">,</span>&nbsp;<span class="ident" id="6454630">expected</span>&nbsp;<span class="op" id="6454639">:=</span>&nbsp;<span class="ident" id="6454642">resp</span><span class="op" id="6454646">.</span><span class="ident" id="6454647">Code</span><span class="op" id="6454651">,</span>&nbsp;<span class="ident" id="6454653">http</span><span class="op" id="6454657">.</span><span class="ident" id="6454658">StatusBadRequest</span><span class="op" id="6454674">;</span>&nbsp;<span class="ident" id="6454676">got</span>&nbsp;<span class="op" id="6454680">!=</span>&nbsp;<span class="ident" id="6454683">expected</span>&nbsp;<span class="op" id="6454692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6454696">t</span><span class="op" id="6454697">.</span><span class="ident" id="6454698">Fatalf</span><span class="op" id="6454704">(</span><span class="string" id="6454705">&#34;Expected&nbsp;%v&nbsp;response&nbsp;code&nbsp;from&nbsp;chunked&nbsp;request&nbsp;body;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6454766">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6454771">expected</span><span class="op" id="6454779">,</span>&nbsp;<span class="ident" id="6454781">got</span><span class="op" id="6454784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6454787">}</span><br>
<span class="lineno"></span><span class="op" id="6454789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6454792">func</span>&nbsp;<span class="ident" id="6454797">TestRedirect</span><span class="op" id="6454809">(</span><span class="ident" id="6454810">t</span>&nbsp;<span class="op" id="6454812">*</span><span class="ident" id="6454813">testing</span><span class="op" id="6454820">.</span><span class="ident" id="6454821">T</span><span class="op" id="6454822">)</span>&nbsp;<span class="op" id="6454824">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6454827">check</span><span class="op" id="6454832">(</span><span class="ident" id="6454833">t</span><span class="op" id="6454834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6454837">h</span>&nbsp;<span class="op" id="6454839">:=</span>&nbsp;<span class="op" id="6454842">&amp;</span><span class="ident" id="6454843">Handler</span><span class="op" id="6454850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6454854">Path</span><span class="op" id="6454858">:</span>&nbsp;<span class="string" id="6454860">&#34;testdata/test.cgi&#34;</span><span class="op" id="6454879">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6454883">Root</span><span class="op" id="6454887">:</span>&nbsp;<span class="string" id="6454889">&#34;/test.cgi&#34;</span><span class="op" id="6454900">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6454903">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6454906">rec</span>&nbsp;<span class="op" id="6454910">:=</span>&nbsp;<span class="ident" id="6454913">runCgiTest</span><span class="op" id="6454923">(</span><span class="ident" id="6454924">t</span><span class="op" id="6454925">,</span>&nbsp;<span class="ident" id="6454927">h</span><span class="op" id="6454928">,</span>&nbsp;<span class="string" id="6454930">&#34;GET&nbsp;/test.cgi?loc=http://foo.com/&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6454997">,</span>&nbsp;<span class="ident" id="6454999">nil</span><span class="op" id="6455002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6455005">if</span>&nbsp;<span class="ident" id="6455008">e</span><span class="op" id="6455009">,</span>&nbsp;<span class="ident" id="6455011">g</span>&nbsp;<span class="op" id="6455013">:=</span>&nbsp;<span class="num" id="6455016">302</span><span class="op" id="6455019">,</span>&nbsp;<span class="ident" id="6455021">rec</span><span class="op" id="6455024">.</span><span class="ident" id="6455025">Code</span><span class="op" id="6455029">;</span>&nbsp;<span class="ident" id="6455031">e</span>&nbsp;<span class="op" id="6455033">!=</span>&nbsp;<span class="ident" id="6455036">g</span>&nbsp;<span class="op" id="6455038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6455042">t</span><span class="op" id="6455043">.</span><span class="ident" id="6455044">Errorf</span><span class="op" id="6455050">(</span><span class="string" id="6455051">&#34;expected&nbsp;status&nbsp;code&nbsp;%d;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6455084">,</span>&nbsp;<span class="ident" id="6455086">e</span><span class="op" id="6455087">,</span>&nbsp;<span class="ident" id="6455089">g</span><span class="op" id="6455090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6455093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6455096">if</span>&nbsp;<span class="ident" id="6455099">e</span><span class="op" id="6455100">,</span>&nbsp;<span class="ident" id="6455102">g</span>&nbsp;<span class="op" id="6455104">:=</span>&nbsp;<span class="string" id="6455107">&#34;http://foo.com/&#34;</span><span class="op" id="6455124">,</span>&nbsp;<span class="ident" id="6455126">rec</span><span class="op" id="6455129">.</span><span class="ident" id="6455130">Header</span><span class="op" id="6455136">(</span><span class="op" id="6455137">)</span><span class="op" id="6455138">.</span><span class="ident" id="6455139">Get</span><span class="op" id="6455142">(</span><span class="string" id="6455143">&#34;Location&#34;</span><span class="op" id="6455153">)</span><span class="op" id="6455154">;</span>&nbsp;<span class="ident" id="6455156">e</span>&nbsp;<span class="op" id="6455158">!=</span>&nbsp;<span class="ident" id="6455161">g</span>&nbsp;<span class="op" id="6455163">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6455167">t</span><span class="op" id="6455168">.</span><span class="ident" id="6455169">Errorf</span><span class="op" id="6455175">(</span><span class="string" id="6455176">&#34;expected&nbsp;Location&nbsp;header&nbsp;of&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="6455216">,</span>&nbsp;<span class="ident" id="6455218">e</span><span class="op" id="6455219">,</span>&nbsp;<span class="ident" id="6455221">g</span><span class="op" id="6455222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6455225">}</span><br>
<span class="lineno"></span><span class="op" id="6455227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6455230">func</span>&nbsp;<span class="ident" id="6455235">TestInternalRedirect</span><span class="op" id="6455255">(</span><span class="ident" id="6455256">t</span>&nbsp;<span class="op" id="6455258">*</span><span class="ident" id="6455259">testing</span><span class="op" id="6455266">.</span><span class="ident" id="6455267">T</span><span class="op" id="6455268">)</span>&nbsp;<span class="op" id="6455270">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6455273">check</span><span class="op" id="6455278">(</span><span class="ident" id="6455279">t</span><span class="op" id="6455280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6455283">baseHandler</span>&nbsp;<span class="op" id="6455295">:=</span>&nbsp;<span class="ident" id="6455298">http</span><span class="op" id="6455302">.</span><span class="ident" id="6455303">HandlerFunc</span><span class="op" id="6455314">(</span><span class="keyword" id="6455315">func</span><span class="op" id="6455319">(</span><span class="ident" id="6455320">rw</span>&nbsp;<span class="ident" id="6455323">http</span><span class="op" id="6455327">.</span><span class="ident" id="6455328">ResponseWriter</span><span class="op" id="6455342">,</span>&nbsp;<span class="ident" id="6455344">req</span>&nbsp;<span class="op" id="6455348">*</span><span class="ident" id="6455349">http</span><span class="op" id="6455353">.</span><span class="ident" id="6455354">Request</span><span class="op" id="6455361">)</span>&nbsp;<span class="op" id="6455363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6455367">fmt</span><span class="op" id="6455370">.</span><span class="ident" id="6455371">Fprintf</span><span class="op" id="6455378">(</span><span class="ident" id="6455379">rw</span><span class="op" id="6455381">,</span>&nbsp;<span class="string" id="6455383">&#34;basepath=%s\n&#34;</span><span class="op" id="6455398">,</span>&nbsp;<span class="ident" id="6455400">req</span><span class="op" id="6455403">.</span><span class="ident" id="6455404">URL</span><span class="op" id="6455407">.</span><span class="ident" id="6455408">Path</span><span class="op" id="6455412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6455416">fmt</span><span class="op" id="6455419">.</span><span class="ident" id="6455420">Fprintf</span><span class="op" id="6455427">(</span><span class="ident" id="6455428">rw</span><span class="op" id="6455430">,</span>&nbsp;<span class="string" id="6455432">&#34;remoteaddr=%s\n&#34;</span><span class="op" id="6455449">,</span>&nbsp;<span class="ident" id="6455451">req</span><span class="op" id="6455454">.</span><span class="ident" id="6455455">RemoteAddr</span><span class="op" id="6455465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6455468">}</span><span class="op" id="6455469">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6455472">h</span>&nbsp;<span class="op" id="6455474">:=</span>&nbsp;<span class="op" id="6455477">&amp;</span><span class="ident" id="6455478">Handler</span><span class="op" id="6455485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6455489">Path</span><span class="op" id="6455493">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6455510">&#34;testdata/test.cgi&#34;</span><span class="op" id="6455529">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6455533">Root</span><span class="op" id="6455537">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6455554">&#34;/test.cgi&#34;</span><span class="op" id="6455565">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6455569">PathLocationHandler</span><span class="op" id="6455588">:</span>&nbsp;<span class="ident" id="6455590">baseHandler</span><span class="op" id="6455601">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6455604">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6455607">expectedMap</span>&nbsp;<span class="op" id="6455619">:=</span>&nbsp;<span class="keyword" id="6455622">map</span><span class="op" id="6455625">[</span><span class="builtintype" id="6455626">string</span><span class="op" id="6455632">]</span><span class="builtintype" id="6455633">string</span><span class="op" id="6455639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6455643">&#34;basepath&#34;</span><span class="op" id="6455653">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6455657">&#34;/foo&#34;</span><span class="op" id="6455663">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6455667">&#34;remoteaddr&#34;</span><span class="op" id="6455679">:</span>&nbsp;<span class="string" id="6455681">&#34;1.2.3.4&#34;</span><span class="op" id="6455690">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6455693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6455696">runCgiTest</span><span class="op" id="6455706">(</span><span class="ident" id="6455707">t</span><span class="op" id="6455708">,</span>&nbsp;<span class="ident" id="6455710">h</span><span class="op" id="6455711">,</span>&nbsp;<span class="string" id="6455713">&#34;GET&nbsp;/test.cgi?loc=/foo&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6455769">,</span>&nbsp;<span class="ident" id="6455771">expectedMap</span><span class="op" id="6455782">)</span><br>
<span class="lineno">295</span><span class="op" id="6455784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6455787">//&nbsp;TestCopyError&nbsp;tests&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;process&nbsp;if&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying</span><br>
<span class="lineno"></span><span class="comment" id="6455863">//&nbsp;its&nbsp;output.&nbsp;(for&nbsp;example,&nbsp;from&nbsp;the&nbsp;client&nbsp;having&nbsp;gone&nbsp;away)</span><br>
<span class="lineno"></span><span class="keyword" id="6455926">func</span>&nbsp;<span class="ident" id="6455931">TestCopyError</span><span class="op" id="6455944">(</span><span class="ident" id="6455945">t</span>&nbsp;<span class="op" id="6455947">*</span><span class="ident" id="6455948">testing</span><span class="op" id="6455955">.</span><span class="ident" id="6455956">T</span><span class="op" id="6455957">)</span>&nbsp;<span class="op" id="6455959">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6455962">check</span><span class="op" id="6455967">(</span><span class="ident" id="6455968">t</span><span class="op" id="6455969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6455972">if</span>&nbsp;<span class="ident" id="6455975">runtime</span><span class="op" id="6455982">.</span><span class="ident" id="6455983">GOOS</span>&nbsp;<span class="op" id="6455988">==</span>&nbsp;<span class="string" id="6455991">&#34;windows&#34;</span>&nbsp;<span class="op" id="6456001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456005">t</span><span class="op" id="6456006">.</span><span class="ident" id="6456007">Skipf</span><span class="op" id="6456012">(</span><span class="string" id="6456013">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6456034">,</span>&nbsp;<span class="ident" id="6456036">runtime</span><span class="op" id="6456043">.</span><span class="ident" id="6456044">GOOS</span><span class="op" id="6456048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6456051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456054">h</span>&nbsp;<span class="op" id="6456056">:=</span>&nbsp;<span class="op" id="6456059">&amp;</span><span class="ident" id="6456060">Handler</span><span class="op" id="6456067">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456071">Path</span><span class="op" id="6456075">:</span>&nbsp;<span class="string" id="6456077">&#34;testdata/test.cgi&#34;</span><span class="op" id="6456096">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456100">Root</span><span class="op" id="6456104">:</span>&nbsp;<span class="string" id="6456106">&#34;/test.cgi&#34;</span><span class="op" id="6456117">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6456120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456123">ts</span>&nbsp;<span class="op" id="6456126">:=</span>&nbsp;<span class="ident" id="6456129">httptest</span><span class="op" id="6456137">.</span><span class="ident" id="6456138">NewServer</span><span class="op" id="6456147">(</span><span class="ident" id="6456148">h</span><span class="op" id="6456149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6456152">defer</span>&nbsp;<span class="ident" id="6456158">ts</span><span class="op" id="6456160">.</span><span class="ident" id="6456161">Close</span><span class="op" id="6456166">(</span><span class="op" id="6456167">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456171">conn</span><span class="op" id="6456175">,</span>&nbsp;<span class="ident" id="6456177">err</span>&nbsp;<span class="op" id="6456181">:=</span>&nbsp;<span class="ident" id="6456184">net</span><span class="op" id="6456187">.</span><span class="ident" id="6456188">Dial</span><span class="op" id="6456192">(</span><span class="string" id="6456193">&#34;tcp&#34;</span><span class="op" id="6456198">,</span>&nbsp;<span class="ident" id="6456200">ts</span><span class="op" id="6456202">.</span><span class="ident" id="6456203">Listener</span><span class="op" id="6456211">.</span><span class="ident" id="6456212">Addr</span><span class="op" id="6456216">(</span><span class="op" id="6456217">)</span><span class="op" id="6456218">.</span><span class="ident" id="6456219">String</span><span class="op" id="6456225">(</span><span class="op" id="6456226">)</span><span class="op" id="6456227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6456230">if</span>&nbsp;<span class="ident" id="6456233">err</span>&nbsp;<span class="op" id="6456237">!=</span>&nbsp;<span class="ident" id="6456240">nil</span>&nbsp;<span class="op" id="6456244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456248">t</span><span class="op" id="6456249">.</span><span class="ident" id="6456250">Fatal</span><span class="op" id="6456255">(</span><span class="ident" id="6456256">err</span><span class="op" id="6456259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6456262">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456265">req</span><span class="op" id="6456268">,</span>&nbsp;<span class="ident" id="6456270">_</span>&nbsp;<span class="op" id="6456272">:=</span>&nbsp;<span class="ident" id="6456275">http</span><span class="op" id="6456279">.</span><span class="ident" id="6456280">NewRequest</span><span class="op" id="6456290">(</span><span class="string" id="6456291">&#34;GET&#34;</span><span class="op" id="6456296">,</span>&nbsp;<span class="string" id="6456298">&#34;http://example.com/test.cgi?bigresponse=1&#34;</span><span class="op" id="6456341">,</span>&nbsp;<span class="ident" id="6456343">nil</span><span class="op" id="6456346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456349">err</span>&nbsp;<span class="op" id="6456353">=</span>&nbsp;<span class="ident" id="6456355">req</span><span class="op" id="6456358">.</span><span class="ident" id="6456359">Write</span><span class="op" id="6456364">(</span><span class="ident" id="6456365">conn</span><span class="op" id="6456369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6456372">if</span>&nbsp;<span class="ident" id="6456375">err</span>&nbsp;<span class="op" id="6456379">!=</span>&nbsp;<span class="ident" id="6456382">nil</span>&nbsp;<span class="op" id="6456386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456390">t</span><span class="op" id="6456391">.</span><span class="ident" id="6456392">Fatalf</span><span class="op" id="6456398">(</span><span class="string" id="6456399">&#34;Write:&nbsp;%v&#34;</span><span class="op" id="6456410">,</span>&nbsp;<span class="ident" id="6456412">err</span><span class="op" id="6456415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6456418">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456422">res</span><span class="op" id="6456425">,</span>&nbsp;<span class="ident" id="6456427">err</span>&nbsp;<span class="op" id="6456431">:=</span>&nbsp;<span class="ident" id="6456434">http</span><span class="op" id="6456438">.</span><span class="ident" id="6456439">ReadResponse</span><span class="op" id="6456451">(</span><span class="ident" id="6456452">bufio</span><span class="op" id="6456457">.</span><span class="ident" id="6456458">NewReader</span><span class="op" id="6456467">(</span><span class="ident" id="6456468">conn</span><span class="op" id="6456472">)</span><span class="op" id="6456473">,</span>&nbsp;<span class="ident" id="6456475">req</span><span class="op" id="6456478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6456481">if</span>&nbsp;<span class="ident" id="6456484">err</span>&nbsp;<span class="op" id="6456488">!=</span>&nbsp;<span class="ident" id="6456491">nil</span>&nbsp;<span class="op" id="6456495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456499">t</span><span class="op" id="6456500">.</span><span class="ident" id="6456501">Fatalf</span><span class="op" id="6456507">(</span><span class="string" id="6456508">&#34;ReadResponse:&nbsp;%v&#34;</span><span class="op" id="6456526">,</span>&nbsp;<span class="ident" id="6456528">err</span><span class="op" id="6456531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6456534">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456538">pidstr</span>&nbsp;<span class="op" id="6456545">:=</span>&nbsp;<span class="ident" id="6456548">res</span><span class="op" id="6456551">.</span><span class="ident" id="6456552">Header</span><span class="op" id="6456558">.</span><span class="ident" id="6456559">Get</span><span class="op" id="6456562">(</span><span class="string" id="6456563">&#34;X-CGI-Pid&#34;</span><span class="op" id="6456574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6456577">if</span>&nbsp;<span class="ident" id="6456580">pidstr</span>&nbsp;<span class="op" id="6456587">==</span>&nbsp;<span class="string" id="6456590">&#34;&#34;</span>&nbsp;<span class="op" id="6456593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456597">t</span><span class="op" id="6456598">.</span><span class="ident" id="6456599">Fatalf</span><span class="op" id="6456605">(</span><span class="string" id="6456606">&#34;expected&nbsp;an&nbsp;X-CGI-Pid&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="6456648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6456651">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456654">pid</span><span class="op" id="6456657">,</span>&nbsp;<span class="ident" id="6456659">err</span>&nbsp;<span class="op" id="6456663">:=</span>&nbsp;<span class="ident" id="6456666">strconv</span><span class="op" id="6456673">.</span><span class="ident" id="6456674">Atoi</span><span class="op" id="6456678">(</span><span class="ident" id="6456679">pidstr</span><span class="op" id="6456685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6456688">if</span>&nbsp;<span class="ident" id="6456691">err</span>&nbsp;<span class="op" id="6456695">!=</span>&nbsp;<span class="ident" id="6456698">nil</span>&nbsp;<span class="op" id="6456702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456706">t</span><span class="op" id="6456707">.</span><span class="ident" id="6456708">Fatalf</span><span class="op" id="6456714">(</span><span class="string" id="6456715">&#34;invalid&nbsp;X-CGI-Pid&nbsp;value&#34;</span><span class="op" id="6456740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6456743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6456747">var</span>&nbsp;<span class="ident" id="6456751">buf</span>&nbsp;<span class="op" id="6456755">[</span><span class="num" id="6456756">5000</span><span class="op" id="6456760">]</span><span class="builtintype" id="6456761">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456767">n</span><span class="op" id="6456768">,</span>&nbsp;<span class="ident" id="6456770">err</span>&nbsp;<span class="op" id="6456774">:=</span>&nbsp;<span class="ident" id="6456777">io</span><span class="op" id="6456779">.</span><span class="ident" id="6456780">ReadFull</span><span class="op" id="6456788">(</span><span class="ident" id="6456789">res</span><span class="op" id="6456792">.</span><span class="ident" id="6456793">Body</span><span class="op" id="6456797">,</span>&nbsp;<span class="ident" id="6456799">buf</span><span class="op" id="6456802">[</span><span class="op" id="6456803">:</span><span class="op" id="6456804">]</span><span class="op" id="6456805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6456808">if</span>&nbsp;<span class="ident" id="6456811">err</span>&nbsp;<span class="op" id="6456815">!=</span>&nbsp;<span class="ident" id="6456818">nil</span>&nbsp;<span class="op" id="6456822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456826">t</span><span class="op" id="6456827">.</span><span class="ident" id="6456828">Fatalf</span><span class="op" id="6456834">(</span><span class="string" id="6456835">&#34;ReadFull:&nbsp;%d&nbsp;bytes,&nbsp;%v&#34;</span><span class="op" id="6456859">,</span>&nbsp;<span class="ident" id="6456861">n</span><span class="op" id="6456862">,</span>&nbsp;<span class="ident" id="6456864">err</span><span class="op" id="6456867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6456870">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456874">childRunning</span>&nbsp;<span class="op" id="6456887">:=</span>&nbsp;<span class="keyword" id="6456890">func</span><span class="op" id="6456894">(</span><span class="op" id="6456895">)</span>&nbsp;<span class="builtintype" id="6456897">bool</span>&nbsp;<span class="op" id="6456902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6456906">return</span>&nbsp;<span class="ident" id="6456913">isProcessRunning</span><span class="op" id="6456929">(</span><span class="ident" id="6456930">t</span><span class="op" id="6456931">,</span>&nbsp;<span class="ident" id="6456933">pid</span><span class="op" id="6456936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6456939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6456943">if</span>&nbsp;<span class="op" id="6456946">!</span><span class="ident" id="6456947">childRunning</span><span class="op" id="6456959">(</span><span class="op" id="6456960">)</span>&nbsp;<span class="op" id="6456962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6456966">t</span><span class="op" id="6456967">.</span><span class="ident" id="6456968">Fatalf</span><span class="op" id="6456974">(</span><span class="string" id="6456975">&#34;pre-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;running&#34;</span><span class="op" id="6457021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6457024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457027">conn</span><span class="op" id="6457031">.</span><span class="ident" id="6457032">Close</span><span class="op" id="6457037">(</span><span class="op" id="6457038">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457042">tries</span>&nbsp;<span class="op" id="6457048">:=</span>&nbsp;<span class="num" id="6457051">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6457054">for</span>&nbsp;<span class="ident" id="6457058">tries</span>&nbsp;<span class="op" id="6457064">&lt;</span>&nbsp;<span class="num" id="6457066">25</span>&nbsp;<span class="op" id="6457069">&amp;&amp;</span>&nbsp;<span class="ident" id="6457072">childRunning</span><span class="op" id="6457084">(</span><span class="op" id="6457085">)</span>&nbsp;<span class="op" id="6457087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457091">time</span><span class="op" id="6457095">.</span><span class="ident" id="6457096">Sleep</span><span class="op" id="6457101">(</span><span class="num" id="6457102">50</span>&nbsp;<span class="op" id="6457105">*</span>&nbsp;<span class="ident" id="6457107">time</span><span class="op" id="6457111">.</span><span class="ident" id="6457112">Millisecond</span>&nbsp;<span class="op" id="6457124">*</span>&nbsp;<span class="ident" id="6457126">time</span><span class="op" id="6457130">.</span><span class="ident" id="6457131">Duration</span><span class="op" id="6457139">(</span><span class="ident" id="6457140">tries</span><span class="op" id="6457145">)</span><span class="op" id="6457146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457150">tries</span><span class="op" id="6457155">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6457159">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6457162">if</span>&nbsp;<span class="ident" id="6457165">childRunning</span><span class="op" id="6457177">(</span><span class="op" id="6457178">)</span>&nbsp;<span class="op" id="6457180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457184">t</span><span class="op" id="6457185">.</span><span class="ident" id="6457186">Fatalf</span><span class="op" id="6457192">(</span><span class="string" id="6457193">&#34;post-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;gone&#34;</span><span class="op" id="6457237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6457240">}</span><br>
<span class="lineno"></span><span class="op" id="6457242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="keyword" id="6457245">func</span>&nbsp;<span class="ident" id="6457250">TestDirUnix</span><span class="op" id="6457261">(</span><span class="ident" id="6457262">t</span>&nbsp;<span class="op" id="6457264">*</span><span class="ident" id="6457265">testing</span><span class="op" id="6457272">.</span><span class="ident" id="6457273">T</span><span class="op" id="6457274">)</span>&nbsp;<span class="op" id="6457276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457279">check</span><span class="op" id="6457284">(</span><span class="ident" id="6457285">t</span><span class="op" id="6457286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6457289">if</span>&nbsp;<span class="ident" id="6457292">runtime</span><span class="op" id="6457299">.</span><span class="ident" id="6457300">GOOS</span>&nbsp;<span class="op" id="6457305">==</span>&nbsp;<span class="string" id="6457308">&#34;windows&#34;</span>&nbsp;<span class="op" id="6457318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457322">t</span><span class="op" id="6457323">.</span><span class="ident" id="6457324">Skipf</span><span class="op" id="6457329">(</span><span class="string" id="6457330">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6457351">,</span>&nbsp;<span class="ident" id="6457353">runtime</span><span class="op" id="6457360">.</span><span class="ident" id="6457361">GOOS</span><span class="op" id="6457365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6457368">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457371">cwd</span><span class="op" id="6457374">,</span>&nbsp;<span class="ident" id="6457376">_</span>&nbsp;<span class="op" id="6457378">:=</span>&nbsp;<span class="ident" id="6457381">os</span><span class="op" id="6457383">.</span><span class="ident" id="6457384">Getwd</span><span class="op" id="6457389">(</span><span class="op" id="6457390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457393">h</span>&nbsp;<span class="op" id="6457395">:=</span>&nbsp;<span class="op" id="6457398">&amp;</span><span class="ident" id="6457399">Handler</span><span class="op" id="6457406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457410">Path</span><span class="op" id="6457414">:</span>&nbsp;<span class="string" id="6457416">&#34;testdata/test.cgi&#34;</span><span class="op" id="6457435">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457439">Root</span><span class="op" id="6457443">:</span>&nbsp;<span class="string" id="6457445">&#34;/test.cgi&#34;</span><span class="op" id="6457456">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457460">Dir</span><span class="op" id="6457463">:</span>&nbsp;&nbsp;<span class="ident" id="6457466">cwd</span><span class="op" id="6457469">,</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6457472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457475">expectedMap</span>&nbsp;<span class="op" id="6457487">:=</span>&nbsp;<span class="keyword" id="6457490">map</span><span class="op" id="6457493">[</span><span class="builtintype" id="6457494">string</span><span class="op" id="6457500">]</span><span class="builtintype" id="6457501">string</span><span class="op" id="6457507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6457511">&#34;cwd&#34;</span><span class="op" id="6457516">:</span>&nbsp;<span class="ident" id="6457518">cwd</span><span class="op" id="6457521">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6457524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457527">runCgiTest</span><span class="op" id="6457537">(</span><span class="ident" id="6457538">t</span><span class="op" id="6457539">,</span>&nbsp;<span class="ident" id="6457541">h</span><span class="op" id="6457542">,</span>&nbsp;<span class="string" id="6457544">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6457591">,</span>&nbsp;<span class="ident" id="6457593">expectedMap</span><span class="op" id="6457604">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457608">cwd</span><span class="op" id="6457611">,</span>&nbsp;<span class="ident" id="6457613">_</span>&nbsp;<span class="op" id="6457615">=</span>&nbsp;<span class="ident" id="6457617">os</span><span class="op" id="6457619">.</span><span class="ident" id="6457620">Getwd</span><span class="op" id="6457625">(</span><span class="op" id="6457626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457629">cwd</span>&nbsp;<span class="op" id="6457633">=</span>&nbsp;<span class="ident" id="6457635">filepath</span><span class="op" id="6457643">.</span><span class="ident" id="6457644">Join</span><span class="op" id="6457648">(</span><span class="ident" id="6457649">cwd</span><span class="op" id="6457652">,</span>&nbsp;<span class="string" id="6457654">&#34;testdata&#34;</span><span class="op" id="6457664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457667">h</span>&nbsp;<span class="op" id="6457669">=</span>&nbsp;<span class="op" id="6457671">&amp;</span><span class="ident" id="6457672">Handler</span><span class="op" id="6457679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457683">Path</span><span class="op" id="6457687">:</span>&nbsp;<span class="string" id="6457689">&#34;testdata/test.cgi&#34;</span><span class="op" id="6457708">,</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457712">Root</span><span class="op" id="6457716">:</span>&nbsp;<span class="string" id="6457718">&#34;/test.cgi&#34;</span><span class="op" id="6457729">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6457732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457735">expectedMap</span>&nbsp;<span class="op" id="6457747">=</span>&nbsp;<span class="keyword" id="6457749">map</span><span class="op" id="6457752">[</span><span class="builtintype" id="6457753">string</span><span class="op" id="6457759">]</span><span class="builtintype" id="6457760">string</span><span class="op" id="6457766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6457770">&#34;cwd&#34;</span><span class="op" id="6457775">:</span>&nbsp;<span class="ident" id="6457777">cwd</span><span class="op" id="6457780">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6457783">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457786">runCgiTest</span><span class="op" id="6457796">(</span><span class="ident" id="6457797">t</span><span class="op" id="6457798">,</span>&nbsp;<span class="ident" id="6457800">h</span><span class="op" id="6457801">,</span>&nbsp;<span class="string" id="6457803">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6457850">,</span>&nbsp;<span class="ident" id="6457852">expectedMap</span><span class="op" id="6457863">)</span><br>
<span class="lineno"></span><span class="op" id="6457865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6457868">func</span>&nbsp;<span class="ident" id="6457873">TestDirWindows</span><span class="op" id="6457887">(</span><span class="ident" id="6457888">t</span>&nbsp;<span class="op" id="6457890">*</span><span class="ident" id="6457891">testing</span><span class="op" id="6457898">.</span><span class="ident" id="6457899">T</span><span class="op" id="6457900">)</span>&nbsp;<span class="op" id="6457902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6457905">if</span>&nbsp;<span class="ident" id="6457908">runtime</span><span class="op" id="6457915">.</span><span class="ident" id="6457916">GOOS</span>&nbsp;<span class="op" id="6457921">!=</span>&nbsp;<span class="string" id="6457924">&#34;windows&#34;</span>&nbsp;<span class="op" id="6457934">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457938">t</span><span class="op" id="6457939">.</span><span class="ident" id="6457940">Skip</span><span class="op" id="6457944">(</span><span class="string" id="6457945">&#34;Skipping&nbsp;windows&nbsp;specific&nbsp;test.&#34;</span><span class="op" id="6457978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6457981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6457985">cgifile</span><span class="op" id="6457992">,</span>&nbsp;<span class="ident" id="6457994">_</span>&nbsp;<span class="op" id="6457996">:=</span>&nbsp;<span class="ident" id="6457999">filepath</span><span class="op" id="6458007">.</span><span class="ident" id="6458008">Abs</span><span class="op" id="6458011">(</span><span class="string" id="6458012">&#34;testdata/test.cgi&#34;</span><span class="op" id="6458031">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6458035">var</span>&nbsp;<span class="ident" id="6458039">perl</span>&nbsp;<span class="builtintype" id="6458044">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6458052">var</span>&nbsp;<span class="ident" id="6458056">err</span>&nbsp;<span class="builtintype" id="6458060">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458067">perl</span><span class="op" id="6458071">,</span>&nbsp;<span class="ident" id="6458073">err</span>&nbsp;<span class="op" id="6458077">=</span>&nbsp;<span class="ident" id="6458079">exec</span><span class="op" id="6458083">.</span><span class="ident" id="6458084">LookPath</span><span class="op" id="6458092">(</span><span class="string" id="6458093">&#34;perl&#34;</span><span class="op" id="6458099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6458102">if</span>&nbsp;<span class="ident" id="6458105">err</span>&nbsp;<span class="op" id="6458109">!=</span>&nbsp;<span class="ident" id="6458112">nil</span>&nbsp;<span class="op" id="6458116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458120">t</span><span class="op" id="6458121">.</span><span class="ident" id="6458122">Skip</span><span class="op" id="6458126">(</span><span class="string" id="6458127">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="6458159">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6458162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458165">perl</span><span class="op" id="6458169">,</span>&nbsp;<span class="ident" id="6458171">_</span>&nbsp;<span class="op" id="6458173">=</span>&nbsp;<span class="ident" id="6458175">filepath</span><span class="op" id="6458183">.</span><span class="ident" id="6458184">Abs</span><span class="op" id="6458187">(</span><span class="ident" id="6458188">perl</span><span class="op" id="6458192">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458196">cwd</span><span class="op" id="6458199">,</span>&nbsp;<span class="ident" id="6458201">_</span>&nbsp;<span class="op" id="6458203">:=</span>&nbsp;<span class="ident" id="6458206">os</span><span class="op" id="6458208">.</span><span class="ident" id="6458209">Getwd</span><span class="op" id="6458214">(</span><span class="op" id="6458215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458218">h</span>&nbsp;<span class="op" id="6458220">:=</span>&nbsp;<span class="op" id="6458223">&amp;</span><span class="ident" id="6458224">Handler</span><span class="op" id="6458231">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458235">Path</span><span class="op" id="6458239">:</span>&nbsp;<span class="ident" id="6458241">perl</span><span class="op" id="6458245">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458249">Root</span><span class="op" id="6458253">:</span>&nbsp;<span class="string" id="6458255">&#34;/test.cgi&#34;</span><span class="op" id="6458266">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458270">Dir</span><span class="op" id="6458273">:</span>&nbsp;&nbsp;<span class="ident" id="6458276">cwd</span><span class="op" id="6458279">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458283">Args</span><span class="op" id="6458287">:</span>&nbsp;<span class="op" id="6458289">[</span><span class="op" id="6458290">]</span><span class="builtintype" id="6458291">string</span><span class="op" id="6458297">{</span><span class="ident" id="6458298">cgifile</span><span class="op" id="6458305">}</span><span class="op" id="6458306">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458310">Env</span><span class="op" id="6458313">:</span>&nbsp;&nbsp;<span class="op" id="6458316">[</span><span class="op" id="6458317">]</span><span class="builtintype" id="6458318">string</span><span class="op" id="6458324">{</span><span class="string" id="6458325">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="6458344">+</span>&nbsp;<span class="ident" id="6458346">cgifile</span><span class="op" id="6458353">}</span><span class="op" id="6458354">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6458357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458360">expectedMap</span>&nbsp;<span class="op" id="6458372">:=</span>&nbsp;<span class="keyword" id="6458375">map</span><span class="op" id="6458378">[</span><span class="builtintype" id="6458379">string</span><span class="op" id="6458385">]</span><span class="builtintype" id="6458386">string</span><span class="op" id="6458392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6458396">&#34;cwd&#34;</span><span class="op" id="6458401">:</span>&nbsp;<span class="ident" id="6458403">cwd</span><span class="op" id="6458406">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6458409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458412">runCgiTest</span><span class="op" id="6458422">(</span><span class="ident" id="6458423">t</span><span class="op" id="6458424">,</span>&nbsp;<span class="ident" id="6458426">h</span><span class="op" id="6458427">,</span>&nbsp;<span class="string" id="6458429">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6458476">,</span>&nbsp;<span class="ident" id="6458478">expectedMap</span><span class="op" id="6458489">)</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6458493">//&nbsp;If&nbsp;not&nbsp;specify&nbsp;Dir&nbsp;on&nbsp;windows,&nbsp;working&nbsp;directory&nbsp;should&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6458556">//&nbsp;base&nbsp;directory&nbsp;of&nbsp;perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458584">cwd</span><span class="op" id="6458587">,</span>&nbsp;<span class="ident" id="6458589">_</span>&nbsp;<span class="op" id="6458591">=</span>&nbsp;<span class="ident" id="6458593">filepath</span><span class="op" id="6458601">.</span><span class="ident" id="6458602">Split</span><span class="op" id="6458607">(</span><span class="ident" id="6458608">perl</span><span class="op" id="6458612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6458615">if</span>&nbsp;<span class="ident" id="6458618">cwd</span>&nbsp;<span class="op" id="6458622">!=</span>&nbsp;<span class="string" id="6458625">&#34;&#34;</span>&nbsp;<span class="op" id="6458628">&amp;&amp;</span>&nbsp;<span class="ident" id="6458631">cwd</span><span class="op" id="6458634">[</span><span class="builtinfunc" id="6458635">len</span><span class="op" id="6458638">(</span><span class="ident" id="6458639">cwd</span><span class="op" id="6458642">)</span><span class="op" id="6458643">-</span><span class="num" id="6458644">1</span><span class="op" id="6458645">]</span>&nbsp;<span class="op" id="6458647">==</span>&nbsp;<span class="ident" id="6458650">filepath</span><span class="op" id="6458658">.</span><span class="ident" id="6458659">Separator</span>&nbsp;<span class="op" id="6458669">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458673">cwd</span>&nbsp;<span class="op" id="6458677">=</span>&nbsp;<span class="ident" id="6458679">cwd</span><span class="op" id="6458682">[</span><span class="op" id="6458683">:</span><span class="builtinfunc" id="6458684">len</span><span class="op" id="6458687">(</span><span class="ident" id="6458688">cwd</span><span class="op" id="6458691">)</span><span class="op" id="6458692">-</span><span class="num" id="6458693">1</span><span class="op" id="6458694">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6458697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458700">h</span>&nbsp;<span class="op" id="6458702">=</span>&nbsp;<span class="op" id="6458704">&amp;</span><span class="ident" id="6458705">Handler</span><span class="op" id="6458712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458716">Path</span><span class="op" id="6458720">:</span>&nbsp;<span class="ident" id="6458722">perl</span><span class="op" id="6458726">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458730">Root</span><span class="op" id="6458734">:</span>&nbsp;<span class="string" id="6458736">&#34;/test.cgi&#34;</span><span class="op" id="6458747">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458751">Args</span><span class="op" id="6458755">:</span>&nbsp;<span class="op" id="6458757">[</span><span class="op" id="6458758">]</span><span class="builtintype" id="6458759">string</span><span class="op" id="6458765">{</span><span class="ident" id="6458766">cgifile</span><span class="op" id="6458773">}</span><span class="op" id="6458774">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458778">Env</span><span class="op" id="6458781">:</span>&nbsp;&nbsp;<span class="op" id="6458784">[</span><span class="op" id="6458785">]</span><span class="builtintype" id="6458786">string</span><span class="op" id="6458792">{</span><span class="string" id="6458793">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="6458812">+</span>&nbsp;<span class="ident" id="6458814">cgifile</span><span class="op" id="6458821">}</span><span class="op" id="6458822">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6458825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458828">expectedMap</span>&nbsp;<span class="op" id="6458840">=</span>&nbsp;<span class="keyword" id="6458842">map</span><span class="op" id="6458845">[</span><span class="builtintype" id="6458846">string</span><span class="op" id="6458852">]</span><span class="builtintype" id="6458853">string</span><span class="op" id="6458859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6458863">&#34;cwd&#34;</span><span class="op" id="6458868">:</span>&nbsp;<span class="ident" id="6458870">cwd</span><span class="op" id="6458873">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6458876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458879">runCgiTest</span><span class="op" id="6458889">(</span><span class="ident" id="6458890">t</span><span class="op" id="6458891">,</span>&nbsp;<span class="ident" id="6458893">h</span><span class="op" id="6458894">,</span>&nbsp;<span class="string" id="6458896">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6458943">,</span>&nbsp;<span class="ident" id="6458945">expectedMap</span><span class="op" id="6458956">)</span><br>
<span class="lineno"></span><span class="op" id="6458958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6458961">func</span>&nbsp;<span class="ident" id="6458966">TestEnvOverride</span><span class="op" id="6458981">(</span><span class="ident" id="6458982">t</span>&nbsp;<span class="op" id="6458984">*</span><span class="ident" id="6458985">testing</span><span class="op" id="6458992">.</span><span class="ident" id="6458993">T</span><span class="op" id="6458994">)</span>&nbsp;<span class="op" id="6458996">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6458999">cgifile</span><span class="op" id="6459006">,</span>&nbsp;<span class="ident" id="6459008">_</span>&nbsp;<span class="op" id="6459010">:=</span>&nbsp;<span class="ident" id="6459013">filepath</span><span class="op" id="6459021">.</span><span class="ident" id="6459022">Abs</span><span class="op" id="6459025">(</span><span class="string" id="6459026">&#34;testdata/test.cgi&#34;</span><span class="op" id="6459045">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6459049">var</span>&nbsp;<span class="ident" id="6459053">perl</span>&nbsp;<span class="builtintype" id="6459058">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6459066">var</span>&nbsp;<span class="ident" id="6459070">err</span>&nbsp;<span class="builtintype" id="6459074">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6459081">perl</span><span class="op" id="6459085">,</span>&nbsp;<span class="ident" id="6459087">err</span>&nbsp;<span class="op" id="6459091">=</span>&nbsp;<span class="ident" id="6459093">exec</span><span class="op" id="6459097">.</span><span class="ident" id="6459098">LookPath</span><span class="op" id="6459106">(</span><span class="string" id="6459107">&#34;perl&#34;</span><span class="op" id="6459113">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6459116">if</span>&nbsp;<span class="ident" id="6459119">err</span>&nbsp;<span class="op" id="6459123">!=</span>&nbsp;<span class="ident" id="6459126">nil</span>&nbsp;<span class="op" id="6459130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6459134">t</span><span class="op" id="6459135">.</span><span class="ident" id="6459136">Skipf</span><span class="op" id="6459141">(</span><span class="string" id="6459142">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="6459174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6459177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6459180">perl</span><span class="op" id="6459184">,</span>&nbsp;<span class="ident" id="6459186">_</span>&nbsp;<span class="op" id="6459188">=</span>&nbsp;<span class="ident" id="6459190">filepath</span><span class="op" id="6459198">.</span><span class="ident" id="6459199">Abs</span><span class="op" id="6459202">(</span><span class="ident" id="6459203">perl</span><span class="op" id="6459207">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6459211">cwd</span><span class="op" id="6459214">,</span>&nbsp;<span class="ident" id="6459216">_</span>&nbsp;<span class="op" id="6459218">:=</span>&nbsp;<span class="ident" id="6459221">os</span><span class="op" id="6459223">.</span><span class="ident" id="6459224">Getwd</span><span class="op" id="6459229">(</span><span class="op" id="6459230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6459233">h</span>&nbsp;<span class="op" id="6459235">:=</span>&nbsp;<span class="op" id="6459238">&amp;</span><span class="ident" id="6459239">Handler</span><span class="op" id="6459246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6459250">Path</span><span class="op" id="6459254">:</span>&nbsp;<span class="ident" id="6459256">perl</span><span class="op" id="6459260">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6459264">Root</span><span class="op" id="6459268">:</span>&nbsp;<span class="string" id="6459270">&#34;/test.cgi&#34;</span><span class="op" id="6459281">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6459285">Dir</span><span class="op" id="6459288">:</span>&nbsp;&nbsp;<span class="ident" id="6459291">cwd</span><span class="op" id="6459294">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6459298">Args</span><span class="op" id="6459302">:</span>&nbsp;<span class="op" id="6459304">[</span><span class="op" id="6459305">]</span><span class="builtintype" id="6459306">string</span><span class="op" id="6459312">{</span><span class="ident" id="6459313">cgifile</span><span class="op" id="6459320">}</span><span class="op" id="6459321">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6459325">Env</span><span class="op" id="6459328">:</span>&nbsp;<span class="op" id="6459330">[</span><span class="op" id="6459331">]</span><span class="builtintype" id="6459332">string</span><span class="op" id="6459338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6459343">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="6459362">+</span>&nbsp;<span class="ident" id="6459364">cgifile</span><span class="op" id="6459371">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6459376">&#34;REQUEST_URI=/foo/bar&#34;</span><span class="op" id="6459398">}</span><span class="op" id="6459399">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6459402">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6459405">expectedMap</span>&nbsp;<span class="op" id="6459417">:=</span>&nbsp;<span class="keyword" id="6459420">map</span><span class="op" id="6459423">[</span><span class="builtintype" id="6459424">string</span><span class="op" id="6459430">]</span><span class="builtintype" id="6459431">string</span><span class="op" id="6459437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6459441">&#34;cwd&#34;</span><span class="op" id="6459446">:</span>&nbsp;<span class="ident" id="6459448">cwd</span><span class="op" id="6459451">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6459455">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6459476">:</span>&nbsp;<span class="ident" id="6459478">cgifile</span><span class="op" id="6459485">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6459489">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6459506">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6459512">&#34;/foo/bar&#34;</span><span class="op" id="6459522">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6459525">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6459528">runCgiTest</span><span class="op" id="6459538">(</span><span class="ident" id="6459539">t</span><span class="op" id="6459540">,</span>&nbsp;<span class="ident" id="6459542">h</span><span class="op" id="6459543">,</span>&nbsp;<span class="string" id="6459545">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6459592">,</span>&nbsp;<span class="ident" id="6459594">expectedMap</span><span class="op" id="6459605">)</span><br>
<span class="lineno"></span><span class="op" id="6459607">}</span>
</div>
</body>
</html>
