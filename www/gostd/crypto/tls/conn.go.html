<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html" class="current">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4521584">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4521639">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4521693">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4521744">//&nbsp;TLS&nbsp;low&nbsp;level&nbsp;connection&nbsp;and&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4521790">package</span>&nbsp;<span class="ident" id="4521798">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4521803">import</span>&nbsp;<span class="op" id="4521810">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4521813">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4521822">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4521839">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4521856">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4521871">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4521881">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4521888">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4521894">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4521901">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4521909">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4521916">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4521919">//&nbsp;A&nbsp;Conn&nbsp;represents&nbsp;a&nbsp;secured&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4521962">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;net.Conn&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="4522003">type</span>&nbsp;<span class="ident" id="4522008">Conn</span>&nbsp;<span class="keyword" id="4522013">struct</span>&nbsp;<span class="op" id="4522020">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4522023">//&nbsp;constant</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522036">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4522045">net</span><span class="op" id="4522048">.</span><span class="ident" id="4522049">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522055">isClient</span>&nbsp;<span class="builtintype" id="4522064">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4522071">//&nbsp;constant&nbsp;after&nbsp;handshake;&nbsp;protected&nbsp;by&nbsp;handshakeMutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522129">handshakeMutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4522147">sync</span><span class="op" id="4522151">.</span><span class="ident" id="4522152">Mutex</span>&nbsp;<span class="comment" id="4522158">//&nbsp;handshakeMutex&nbsp;&lt;&nbsp;in.Mutex,&nbsp;out.Mutex,&nbsp;errMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522209">handshakeErr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4522227">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4522238">//&nbsp;error&nbsp;resulting&nbsp;from&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522273">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4522291">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4522302">//&nbsp;TLS&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522318">haveVers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4522336">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4522347">//&nbsp;version&nbsp;has&nbsp;been&nbsp;negotiated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522379">config</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4522397">*</span><span class="ident" id="4522398">Config</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4522408">//&nbsp;configuration&nbsp;passed&nbsp;to&nbsp;constructor</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522448">handshakeComplete</span>&nbsp;<span class="builtintype" id="4522466">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522472">didResume</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4522490">bool</span>&nbsp;<span class="comment" id="4522495">//&nbsp;whether&nbsp;this&nbsp;connection&nbsp;was&nbsp;a&nbsp;session&nbsp;resumption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522548">cipherSuite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4522566">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522574">ocspResponse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4522592">[</span><span class="op" id="4522593">]</span><span class="builtintype" id="4522594">byte</span>&nbsp;<span class="comment" id="4522599">//&nbsp;stapled&nbsp;OCSP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522625">peerCertificates</span>&nbsp;&nbsp;<span class="op" id="4522643">[</span><span class="op" id="4522644">]</span><span class="op" id="4522645">*</span><span class="ident" id="4522646">x509</span><span class="op" id="4522650">.</span><span class="ident" id="4522651">Certificate</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4522664">//&nbsp;verifiedChains&nbsp;contains&nbsp;the&nbsp;certificate&nbsp;chains&nbsp;that&nbsp;we&nbsp;built,&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4522733">//&nbsp;opposed&nbsp;to&nbsp;the&nbsp;ones&nbsp;presented&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522782">verifiedChains</span>&nbsp;<span class="op" id="4522797">[</span><span class="op" id="4522798">]</span><span class="op" id="4522799">[</span><span class="op" id="4522800">]</span><span class="op" id="4522801">*</span><span class="ident" id="4522802">x509</span><span class="op" id="4522806">.</span><span class="ident" id="4522807">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4522820">//&nbsp;serverName&nbsp;contains&nbsp;the&nbsp;server&nbsp;name&nbsp;indicated&nbsp;by&nbsp;the&nbsp;client,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522893">serverName</span>&nbsp;<span class="builtintype" id="4522904">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4522912">//&nbsp;firstFinished&nbsp;contains&nbsp;the&nbsp;first&nbsp;Finished&nbsp;hash&nbsp;sent&nbsp;during&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4522979">//&nbsp;handshake.&nbsp;This&nbsp;is&nbsp;the&nbsp;&#34;tls-unique&#34;&nbsp;channel&nbsp;binding&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523042">firstFinished</span>&nbsp;<span class="op" id="4523056">[</span><span class="num" id="4523057">12</span><span class="op" id="4523059">]</span><span class="builtintype" id="4523060">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523067">clientProtocol</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4523090">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523098">clientProtocolFallback</span>&nbsp;<span class="builtintype" id="4523121">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4523128">//&nbsp;input/output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523145">in</span><span class="op" id="4523147">,</span>&nbsp;<span class="ident" id="4523149">out</span>&nbsp;&nbsp;<span class="ident" id="4523154">halfConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4523167">//&nbsp;in.Mutex&nbsp;&lt;&nbsp;out.Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523192">rawInput</span>&nbsp;<span class="op" id="4523201">*</span><span class="ident" id="4523202">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4523214">//&nbsp;raw&nbsp;input,&nbsp;right&nbsp;off&nbsp;the&nbsp;wire</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523248">input</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4523257">*</span><span class="ident" id="4523258">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4523270">//&nbsp;application&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523310">hand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4523319">bytes</span><span class="op" id="4523324">.</span><span class="ident" id="4523325">Buffer</span>&nbsp;<span class="comment" id="4523332">//&nbsp;handshake&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523371">tmp</span>&nbsp;<span class="op" id="4523375">[</span><span class="num" id="4523376">16</span><span class="op" id="4523378">]</span><span class="builtintype" id="4523379">byte</span><br>
<span class="lineno"></span><span class="op" id="4523384">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="4523387">//&nbsp;Access&nbsp;to&nbsp;net.Conn&nbsp;methods.</span><br>
<span class="lineno"></span><span class="comment" id="4523418">//&nbsp;Cannot&nbsp;just&nbsp;embed&nbsp;net.Conn&nbsp;because&nbsp;that&nbsp;would</span><br>
<span class="lineno"></span><span class="comment" id="4523467">//&nbsp;export&nbsp;the&nbsp;struct&nbsp;field&nbsp;too.</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4523500">//&nbsp;LocalAddr&nbsp;returns&nbsp;the&nbsp;local&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4523548">func</span>&nbsp;<span class="op" id="4523553">(</span><span class="ident" id="4523554">c</span>&nbsp;<span class="op" id="4523556">*</span><span class="ident" id="4523557">Conn</span><span class="op" id="4523561">)</span>&nbsp;<span class="ident" id="4523563">LocalAddr</span><span class="op" id="4523572">(</span><span class="op" id="4523573">)</span>&nbsp;<span class="ident" id="4523575">net</span><span class="op" id="4523578">.</span><span class="ident" id="4523579">Addr</span>&nbsp;<span class="op" id="4523584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4523587">return</span>&nbsp;<span class="ident" id="4523594">c</span><span class="op" id="4523595">.</span><span class="ident" id="4523596">conn</span><span class="op" id="4523600">.</span><span class="ident" id="4523601">LocalAddr</span><span class="op" id="4523610">(</span><span class="op" id="4523611">)</span><br>
<span class="lineno"></span><span class="op" id="4523613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="4523616">//&nbsp;RemoteAddr&nbsp;returns&nbsp;the&nbsp;remote&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4523666">func</span>&nbsp;<span class="op" id="4523671">(</span><span class="ident" id="4523672">c</span>&nbsp;<span class="op" id="4523674">*</span><span class="ident" id="4523675">Conn</span><span class="op" id="4523679">)</span>&nbsp;<span class="ident" id="4523681">RemoteAddr</span><span class="op" id="4523691">(</span><span class="op" id="4523692">)</span>&nbsp;<span class="ident" id="4523694">net</span><span class="op" id="4523697">.</span><span class="ident" id="4523698">Addr</span>&nbsp;<span class="op" id="4523703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4523706">return</span>&nbsp;<span class="ident" id="4523713">c</span><span class="op" id="4523714">.</span><span class="ident" id="4523715">conn</span><span class="op" id="4523719">.</span><span class="ident" id="4523720">RemoteAddr</span><span class="op" id="4523730">(</span><span class="op" id="4523731">)</span><br>
<span class="lineno"></span><span class="op" id="4523733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="4523736">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;and&nbsp;write&nbsp;deadlines&nbsp;associated&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4523817">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;and&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="4523879">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4523986">func</span>&nbsp;<span class="op" id="4523991">(</span><span class="ident" id="4523992">c</span>&nbsp;<span class="op" id="4523994">*</span><span class="ident" id="4523995">Conn</span><span class="op" id="4523999">)</span>&nbsp;<span class="ident" id="4524001">SetDeadline</span><span class="op" id="4524012">(</span><span class="ident" id="4524013">t</span>&nbsp;<span class="ident" id="4524015">time</span><span class="op" id="4524019">.</span><span class="ident" id="4524020">Time</span><span class="op" id="4524024">)</span>&nbsp;<span class="builtintype" id="4524026">error</span>&nbsp;<span class="op" id="4524032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524035">return</span>&nbsp;<span class="ident" id="4524042">c</span><span class="op" id="4524043">.</span><span class="ident" id="4524044">conn</span><span class="op" id="4524048">.</span><span class="ident" id="4524049">SetDeadline</span><span class="op" id="4524060">(</span><span class="ident" id="4524061">t</span><span class="op" id="4524062">)</span><br>
<span class="lineno">80</span><span class="op" id="4524064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4524067">//&nbsp;SetReadDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4524139">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="4524191">func</span>&nbsp;<span class="op" id="4524196">(</span><span class="ident" id="4524197">c</span>&nbsp;<span class="op" id="4524199">*</span><span class="ident" id="4524200">Conn</span><span class="op" id="4524204">)</span>&nbsp;<span class="ident" id="4524206">SetReadDeadline</span><span class="op" id="4524221">(</span><span class="ident" id="4524222">t</span>&nbsp;<span class="ident" id="4524224">time</span><span class="op" id="4524228">.</span><span class="ident" id="4524229">Time</span><span class="op" id="4524233">)</span>&nbsp;<span class="builtintype" id="4524235">error</span>&nbsp;<span class="op" id="4524241">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524244">return</span>&nbsp;<span class="ident" id="4524251">c</span><span class="op" id="4524252">.</span><span class="ident" id="4524253">conn</span><span class="op" id="4524257">.</span><span class="ident" id="4524258">SetReadDeadline</span><span class="op" id="4524273">(</span><span class="ident" id="4524274">t</span><span class="op" id="4524275">)</span><br>
<span class="lineno"></span><span class="op" id="4524277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4524280">//&nbsp;SetWriteDeadline&nbsp;sets&nbsp;the&nbsp;write&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4524354">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno">90</span><span class="comment" id="4524407">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4524514">func</span>&nbsp;<span class="op" id="4524519">(</span><span class="ident" id="4524520">c</span>&nbsp;<span class="op" id="4524522">*</span><span class="ident" id="4524523">Conn</span><span class="op" id="4524527">)</span>&nbsp;<span class="ident" id="4524529">SetWriteDeadline</span><span class="op" id="4524545">(</span><span class="ident" id="4524546">t</span>&nbsp;<span class="ident" id="4524548">time</span><span class="op" id="4524552">.</span><span class="ident" id="4524553">Time</span><span class="op" id="4524557">)</span>&nbsp;<span class="builtintype" id="4524559">error</span>&nbsp;<span class="op" id="4524565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524568">return</span>&nbsp;<span class="ident" id="4524575">c</span><span class="op" id="4524576">.</span><span class="ident" id="4524577">conn</span><span class="op" id="4524581">.</span><span class="ident" id="4524582">SetWriteDeadline</span><span class="op" id="4524598">(</span><span class="ident" id="4524599">t</span><span class="op" id="4524600">)</span><br>
<span class="lineno"></span><span class="op" id="4524602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4524605">//&nbsp;A&nbsp;halfConn&nbsp;represents&nbsp;one&nbsp;direction&nbsp;of&nbsp;the&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><span class="comment" id="4524664">//&nbsp;connection,&nbsp;either&nbsp;sending&nbsp;or&nbsp;receiving.</span><br>
<span class="lineno"></span><span class="keyword" id="4524708">type</span>&nbsp;<span class="ident" id="4524713">halfConn</span>&nbsp;<span class="keyword" id="4524722">struct</span>&nbsp;<span class="op" id="4524729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524732">sync</span><span class="op" id="4524736">.</span><span class="ident" id="4524737">Mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524745">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4524753">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4524765">//&nbsp;first&nbsp;permanent&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524791">version</span>&nbsp;<span class="builtintype" id="4524799">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4524811">//&nbsp;protocol&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524832">cipher</span>&nbsp;&nbsp;<span class="keyword" id="4524840">interface</span><span class="op" id="4524849">{</span><span class="op" id="4524850">}</span>&nbsp;<span class="comment" id="4524852">//&nbsp;cipher&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524873">mac</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4524881">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524894">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4524902">[</span><span class="num" id="4524903">8</span><span class="op" id="4524904">]</span><span class="builtintype" id="4524905">byte</span>&nbsp;<span class="comment" id="4524910">//&nbsp;64-bit&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524937">bfree</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4524945">*</span><span class="ident" id="4524946">block</span>&nbsp;&nbsp;<span class="comment" id="4524953">//&nbsp;list&nbsp;of&nbsp;free&nbsp;blocks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524978">nextCipher</span>&nbsp;<span class="keyword" id="4524989">interface</span><span class="op" id="4524998">{</span><span class="op" id="4524999">}</span>&nbsp;<span class="comment" id="4525001">//&nbsp;next&nbsp;encryption&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525027">nextMac</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4525038">macFunction</span>&nbsp;<span class="comment" id="4525050">//&nbsp;next&nbsp;MAC&nbsp;algorithm</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4525074">//&nbsp;used&nbsp;to&nbsp;save&nbsp;allocating&nbsp;a&nbsp;new&nbsp;buffer&nbsp;for&nbsp;each&nbsp;MAC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525129">inDigestBuf</span><span class="op" id="4525140">,</span>&nbsp;<span class="ident" id="4525142">outDigestBuf</span>&nbsp;<span class="op" id="4525155">[</span><span class="op" id="4525156">]</span><span class="builtintype" id="4525157">byte</span><br>
<span class="lineno"></span><span class="op" id="4525162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4525165">func</span>&nbsp;<span class="op" id="4525170">(</span><span class="ident" id="4525171">hc</span>&nbsp;<span class="op" id="4525174">*</span><span class="ident" id="4525175">halfConn</span><span class="op" id="4525183">)</span>&nbsp;<span class="ident" id="4525185">setErrorLocked</span><span class="op" id="4525199">(</span><span class="ident" id="4525200">err</span>&nbsp;<span class="builtintype" id="4525204">error</span><span class="op" id="4525209">)</span>&nbsp;<span class="builtintype" id="4525211">error</span>&nbsp;<span class="op" id="4525217">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525220">hc</span><span class="op" id="4525222">.</span><span class="ident" id="4525223">err</span>&nbsp;<span class="op" id="4525227">=</span>&nbsp;<span class="ident" id="4525229">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525234">return</span>&nbsp;<span class="ident" id="4525241">err</span><br>
<span class="lineno"></span><span class="op" id="4525245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4525248">func</span>&nbsp;<span class="op" id="4525253">(</span><span class="ident" id="4525254">hc</span>&nbsp;<span class="op" id="4525257">*</span><span class="ident" id="4525258">halfConn</span><span class="op" id="4525266">)</span>&nbsp;<span class="builtintype" id="4525268">error</span><span class="op" id="4525273">(</span><span class="op" id="4525274">)</span>&nbsp;<span class="builtintype" id="4525276">error</span>&nbsp;<span class="op" id="4525282">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525285">hc</span><span class="op" id="4525287">.</span><span class="ident" id="4525288">Lock</span><span class="op" id="4525292">(</span><span class="op" id="4525293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525296">err</span>&nbsp;<span class="op" id="4525300">:=</span>&nbsp;<span class="ident" id="4525303">hc</span><span class="op" id="4525305">.</span><span class="ident" id="4525306">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525311">hc</span><span class="op" id="4525313">.</span><span class="ident" id="4525314">Unlock</span><span class="op" id="4525320">(</span><span class="op" id="4525321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525324">return</span>&nbsp;<span class="ident" id="4525331">err</span><br>
<span class="lineno"></span><span class="op" id="4525335">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="4525338">//&nbsp;prepareCipherSpec&nbsp;sets&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno"></span><span class="comment" id="4525394">//&nbsp;that&nbsp;a&nbsp;subsequent&nbsp;changeCipherSpec&nbsp;will&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="4525442">func</span>&nbsp;<span class="op" id="4525447">(</span><span class="ident" id="4525448">hc</span>&nbsp;<span class="op" id="4525451">*</span><span class="ident" id="4525452">halfConn</span><span class="op" id="4525460">)</span>&nbsp;<span class="ident" id="4525462">prepareCipherSpec</span><span class="op" id="4525479">(</span><span class="ident" id="4525480">version</span>&nbsp;<span class="builtintype" id="4525488">uint16</span><span class="op" id="4525494">,</span>&nbsp;<span class="ident" id="4525496">cipher</span>&nbsp;<span class="keyword" id="4525503">interface</span><span class="op" id="4525512">{</span><span class="op" id="4525513">}</span><span class="op" id="4525514">,</span>&nbsp;<span class="ident" id="4525516">mac</span>&nbsp;<span class="ident" id="4525520">macFunction</span><span class="op" id="4525531">)</span>&nbsp;<span class="op" id="4525533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525536">hc</span><span class="op" id="4525538">.</span><span class="ident" id="4525539">version</span>&nbsp;<span class="op" id="4525547">=</span>&nbsp;<span class="ident" id="4525549">version</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525558">hc</span><span class="op" id="4525560">.</span><span class="ident" id="4525561">nextCipher</span>&nbsp;<span class="op" id="4525572">=</span>&nbsp;<span class="ident" id="4525574">cipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525582">hc</span><span class="op" id="4525584">.</span><span class="ident" id="4525585">nextMac</span>&nbsp;<span class="op" id="4525593">=</span>&nbsp;<span class="ident" id="4525595">mac</span><br>
<span class="lineno"></span><span class="op" id="4525599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4525602">//&nbsp;changeCipherSpec&nbsp;changes&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno">135</span><span class="comment" id="4525660">//&nbsp;to&nbsp;the&nbsp;ones&nbsp;previously&nbsp;passed&nbsp;to&nbsp;prepareCipherSpec.</span><br>
<span class="lineno"></span><span class="keyword" id="4525715">func</span>&nbsp;<span class="op" id="4525720">(</span><span class="ident" id="4525721">hc</span>&nbsp;<span class="op" id="4525724">*</span><span class="ident" id="4525725">halfConn</span><span class="op" id="4525733">)</span>&nbsp;<span class="ident" id="4525735">changeCipherSpec</span><span class="op" id="4525751">(</span><span class="op" id="4525752">)</span>&nbsp;<span class="builtintype" id="4525754">error</span>&nbsp;<span class="op" id="4525760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525763">if</span>&nbsp;<span class="ident" id="4525766">hc</span><span class="op" id="4525768">.</span><span class="ident" id="4525769">nextCipher</span>&nbsp;<span class="op" id="4525780">==</span>&nbsp;<span class="ident" id="4525783">nil</span>&nbsp;<span class="op" id="4525787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525791">return</span>&nbsp;<span class="ident" id="4525798">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4525818">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525821">hc</span><span class="op" id="4525823">.</span><span class="ident" id="4525824">cipher</span>&nbsp;<span class="op" id="4525831">=</span>&nbsp;<span class="ident" id="4525833">hc</span><span class="op" id="4525835">.</span><span class="ident" id="4525836">nextCipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525848">hc</span><span class="op" id="4525850">.</span><span class="ident" id="4525851">mac</span>&nbsp;<span class="op" id="4525855">=</span>&nbsp;<span class="ident" id="4525857">hc</span><span class="op" id="4525859">.</span><span class="ident" id="4525860">nextMac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525869">hc</span><span class="op" id="4525871">.</span><span class="ident" id="4525872">nextCipher</span>&nbsp;<span class="op" id="4525883">=</span>&nbsp;<span class="ident" id="4525885">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525890">hc</span><span class="op" id="4525892">.</span><span class="ident" id="4525893">nextMac</span>&nbsp;<span class="op" id="4525901">=</span>&nbsp;<span class="ident" id="4525903">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525908">for</span>&nbsp;<span class="ident" id="4525912">i</span>&nbsp;<span class="op" id="4525914">:=</span>&nbsp;<span class="keyword" id="4525917">range</span>&nbsp;<span class="ident" id="4525923">hc</span><span class="op" id="4525925">.</span><span class="ident" id="4525926">seq</span>&nbsp;<span class="op" id="4525930">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525934">hc</span><span class="op" id="4525936">.</span><span class="ident" id="4525937">seq</span><span class="op" id="4525940">[</span><span class="ident" id="4525941">i</span><span class="op" id="4525942">]</span>&nbsp;<span class="op" id="4525944">=</span>&nbsp;<span class="num" id="4525946">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4525949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525952">return</span>&nbsp;<span class="ident" id="4525959">nil</span><br>
<span class="lineno"></span><span class="op" id="4525963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4525966">//&nbsp;incSeq&nbsp;increments&nbsp;the&nbsp;sequence&nbsp;number.</span><br>
<span class="lineno"></span><span class="keyword" id="4526008">func</span>&nbsp;<span class="op" id="4526013">(</span><span class="ident" id="4526014">hc</span>&nbsp;<span class="op" id="4526017">*</span><span class="ident" id="4526018">halfConn</span><span class="op" id="4526026">)</span>&nbsp;<span class="ident" id="4526028">incSeq</span><span class="op" id="4526034">(</span><span class="op" id="4526035">)</span>&nbsp;<span class="op" id="4526037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526040">for</span>&nbsp;<span class="ident" id="4526044">i</span>&nbsp;<span class="op" id="4526046">:=</span>&nbsp;<span class="num" id="4526049">7</span><span class="op" id="4526050">;</span>&nbsp;<span class="ident" id="4526052">i</span>&nbsp;<span class="op" id="4526054">&gt;=</span>&nbsp;<span class="num" id="4526057">0</span><span class="op" id="4526058">;</span>&nbsp;<span class="ident" id="4526060">i</span><span class="op" id="4526061">--</span>&nbsp;<span class="op" id="4526064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526068">hc</span><span class="op" id="4526070">.</span><span class="ident" id="4526071">seq</span><span class="op" id="4526074">[</span><span class="ident" id="4526075">i</span><span class="op" id="4526076">]</span><span class="op" id="4526077">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526082">if</span>&nbsp;<span class="ident" id="4526085">hc</span><span class="op" id="4526087">.</span><span class="ident" id="4526088">seq</span><span class="op" id="4526091">[</span><span class="ident" id="4526092">i</span><span class="op" id="4526093">]</span>&nbsp;<span class="op" id="4526095">!=</span>&nbsp;<span class="num" id="4526098">0</span>&nbsp;<span class="op" id="4526100">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526105">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4526114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4526117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4526121">//&nbsp;Not&nbsp;allowed&nbsp;to&nbsp;let&nbsp;sequence&nbsp;number&nbsp;wrap.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4526166">//&nbsp;Instead,&nbsp;must&nbsp;renegotiate&nbsp;before&nbsp;it&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4526212">//&nbsp;Not&nbsp;likely&nbsp;enough&nbsp;to&nbsp;bother.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4526245">panic</span><span class="op" id="4526250">(</span><span class="string" id="4526251">&#34;TLS:&nbsp;sequence&nbsp;number&nbsp;wraparound&#34;</span><span class="op" id="4526284">)</span><br>
<span class="lineno"></span><span class="op" id="4526286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="4526289">//&nbsp;resetSeq&nbsp;resets&nbsp;the&nbsp;sequence&nbsp;number&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="4526337">func</span>&nbsp;<span class="op" id="4526342">(</span><span class="ident" id="4526343">hc</span>&nbsp;<span class="op" id="4526346">*</span><span class="ident" id="4526347">halfConn</span><span class="op" id="4526355">)</span>&nbsp;<span class="ident" id="4526357">resetSeq</span><span class="op" id="4526365">(</span><span class="op" id="4526366">)</span>&nbsp;<span class="op" id="4526368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526371">for</span>&nbsp;<span class="ident" id="4526375">i</span>&nbsp;<span class="op" id="4526377">:=</span>&nbsp;<span class="keyword" id="4526380">range</span>&nbsp;<span class="ident" id="4526386">hc</span><span class="op" id="4526388">.</span><span class="ident" id="4526389">seq</span>&nbsp;<span class="op" id="4526393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526397">hc</span><span class="op" id="4526399">.</span><span class="ident" id="4526400">seq</span><span class="op" id="4526403">[</span><span class="ident" id="4526404">i</span><span class="op" id="4526405">]</span>&nbsp;<span class="op" id="4526407">=</span>&nbsp;<span class="num" id="4526409">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4526412">}</span><br>
<span class="lineno">170</span><span class="op" id="4526414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4526417">//&nbsp;removePadding&nbsp;returns&nbsp;an&nbsp;unpadded&nbsp;slice,&nbsp;in&nbsp;constant&nbsp;time,&nbsp;which&nbsp;is&nbsp;a&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="4526497">//&nbsp;of&nbsp;the&nbsp;input.&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;byte&nbsp;which&nbsp;is&nbsp;equal&nbsp;to&nbsp;255&nbsp;if&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="4526574">//&nbsp;was&nbsp;valid&nbsp;and&nbsp;0&nbsp;otherwise.&nbsp;See&nbsp;RFC&nbsp;2246,&nbsp;section&nbsp;6.2.3.2</span><br>
<span class="lineno">175</span><span class="keyword" id="4526634">func</span>&nbsp;<span class="ident" id="4526639">removePadding</span><span class="op" id="4526652">(</span><span class="ident" id="4526653">payload</span>&nbsp;<span class="op" id="4526661">[</span><span class="op" id="4526662">]</span><span class="builtintype" id="4526663">byte</span><span class="op" id="4526667">)</span>&nbsp;<span class="op" id="4526669">(</span><span class="op" id="4526670">[</span><span class="op" id="4526671">]</span><span class="builtintype" id="4526672">byte</span><span class="op" id="4526676">,</span>&nbsp;<span class="builtintype" id="4526678">byte</span><span class="op" id="4526682">)</span>&nbsp;<span class="op" id="4526684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526687">if</span>&nbsp;<span class="builtinfunc" id="4526690">len</span><span class="op" id="4526693">(</span><span class="ident" id="4526694">payload</span><span class="op" id="4526701">)</span>&nbsp;<span class="op" id="4526703">&lt;</span>&nbsp;<span class="num" id="4526705">1</span>&nbsp;<span class="op" id="4526707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526711">return</span>&nbsp;<span class="ident" id="4526718">payload</span><span class="op" id="4526725">,</span>&nbsp;<span class="num" id="4526727">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4526730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526734">paddingLen</span>&nbsp;<span class="op" id="4526745">:=</span>&nbsp;<span class="ident" id="4526748">payload</span><span class="op" id="4526755">[</span><span class="builtinfunc" id="4526756">len</span><span class="op" id="4526759">(</span><span class="ident" id="4526760">payload</span><span class="op" id="4526767">)</span><span class="op" id="4526768">-</span><span class="num" id="4526769">1</span><span class="op" id="4526770">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526773">t</span>&nbsp;<span class="op" id="4526775">:=</span>&nbsp;<span class="builtintype" id="4526778">uint</span><span class="op" id="4526782">(</span><span class="builtinfunc" id="4526783">len</span><span class="op" id="4526786">(</span><span class="ident" id="4526787">payload</span><span class="op" id="4526794">)</span><span class="op" id="4526795">-</span><span class="num" id="4526796">1</span><span class="op" id="4526797">)</span>&nbsp;<span class="op" id="4526799">-</span>&nbsp;<span class="builtintype" id="4526801">uint</span><span class="op" id="4526805">(</span><span class="ident" id="4526806">paddingLen</span><span class="op" id="4526816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4526819">//&nbsp;if&nbsp;len(payload)&nbsp;&gt;=&nbsp;(paddingLen&nbsp;-&nbsp;1)&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526885">good</span>&nbsp;<span class="op" id="4526890">:=</span>&nbsp;<span class="builtintype" id="4526893">byte</span><span class="op" id="4526897">(</span><span class="builtintype" id="4526898">int32</span><span class="op" id="4526903">(</span><span class="op" id="4526904">^</span><span class="ident" id="4526905">t</span><span class="op" id="4526906">)</span>&nbsp;<span class="op" id="4526908">&gt;&gt;</span>&nbsp;<span class="num" id="4526911">31</span><span class="op" id="4526913">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526917">toCheck</span>&nbsp;<span class="op" id="4526925">:=</span>&nbsp;<span class="num" id="4526928">255</span>&nbsp;<span class="comment" id="4526932">//&nbsp;the&nbsp;maximum&nbsp;possible&nbsp;padding&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4526972">//&nbsp;The&nbsp;length&nbsp;of&nbsp;the&nbsp;padded&nbsp;data&nbsp;is&nbsp;public,&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;an&nbsp;if&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527042">if</span>&nbsp;<span class="ident" id="4527045">toCheck</span><span class="op" id="4527052">+</span><span class="num" id="4527053">1</span>&nbsp;<span class="op" id="4527055">&gt;</span>&nbsp;<span class="builtinfunc" id="4527057">len</span><span class="op" id="4527060">(</span><span class="ident" id="4527061">payload</span><span class="op" id="4527068">)</span>&nbsp;<span class="op" id="4527070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527074">toCheck</span>&nbsp;<span class="op" id="4527082">=</span>&nbsp;<span class="builtinfunc" id="4527084">len</span><span class="op" id="4527087">(</span><span class="ident" id="4527088">payload</span><span class="op" id="4527095">)</span>&nbsp;<span class="op" id="4527097">-</span>&nbsp;<span class="num" id="4527099">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4527102">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527106">for</span>&nbsp;<span class="ident" id="4527110">i</span>&nbsp;<span class="op" id="4527112">:=</span>&nbsp;<span class="num" id="4527115">0</span><span class="op" id="4527116">;</span>&nbsp;<span class="ident" id="4527118">i</span>&nbsp;<span class="op" id="4527120">&lt;</span>&nbsp;<span class="ident" id="4527122">toCheck</span><span class="op" id="4527129">;</span>&nbsp;<span class="ident" id="4527131">i</span><span class="op" id="4527132">++</span>&nbsp;<span class="op" id="4527135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527139">t</span>&nbsp;<span class="op" id="4527141">:=</span>&nbsp;<span class="builtintype" id="4527144">uint</span><span class="op" id="4527148">(</span><span class="ident" id="4527149">paddingLen</span><span class="op" id="4527159">)</span>&nbsp;<span class="op" id="4527161">-</span>&nbsp;<span class="builtintype" id="4527163">uint</span><span class="op" id="4527167">(</span><span class="ident" id="4527168">i</span><span class="op" id="4527169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4527173">//&nbsp;if&nbsp;i&nbsp;&lt;=&nbsp;paddingLen&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527223">mask</span>&nbsp;<span class="op" id="4527228">:=</span>&nbsp;<span class="builtintype" id="4527231">byte</span><span class="op" id="4527235">(</span><span class="builtintype" id="4527236">int32</span><span class="op" id="4527241">(</span><span class="op" id="4527242">^</span><span class="ident" id="4527243">t</span><span class="op" id="4527244">)</span>&nbsp;<span class="op" id="4527246">&gt;&gt;</span>&nbsp;<span class="num" id="4527249">31</span><span class="op" id="4527251">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527255">b</span>&nbsp;<span class="op" id="4527257">:=</span>&nbsp;<span class="ident" id="4527260">payload</span><span class="op" id="4527267">[</span><span class="builtinfunc" id="4527268">len</span><span class="op" id="4527271">(</span><span class="ident" id="4527272">payload</span><span class="op" id="4527279">)</span><span class="op" id="4527280">-</span><span class="num" id="4527281">1</span><span class="op" id="4527282">-</span><span class="ident" id="4527283">i</span><span class="op" id="4527284">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527288">good</span>&nbsp;<span class="op" id="4527293">&amp;^=</span>&nbsp;<span class="ident" id="4527297">mask</span><span class="op" id="4527301">&amp;</span><span class="ident" id="4527302">paddingLen</span>&nbsp;<span class="op" id="4527313">^</span>&nbsp;<span class="ident" id="4527315">mask</span><span class="op" id="4527319">&amp;</span><span class="ident" id="4527320">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4527323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4527327">//&nbsp;We&nbsp;AND&nbsp;together&nbsp;the&nbsp;bits&nbsp;of&nbsp;good&nbsp;and&nbsp;replicate&nbsp;the&nbsp;result&nbsp;across</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4527396">//&nbsp;all&nbsp;the&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527414">good</span>&nbsp;<span class="op" id="4527419">&amp;=</span>&nbsp;<span class="ident" id="4527422">good</span>&nbsp;<span class="op" id="4527427">&lt;&lt;</span>&nbsp;<span class="num" id="4527430">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527433">good</span>&nbsp;<span class="op" id="4527438">&amp;=</span>&nbsp;<span class="ident" id="4527441">good</span>&nbsp;<span class="op" id="4527446">&lt;&lt;</span>&nbsp;<span class="num" id="4527449">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527452">good</span>&nbsp;<span class="op" id="4527457">&amp;=</span>&nbsp;<span class="ident" id="4527460">good</span>&nbsp;<span class="op" id="4527465">&lt;&lt;</span>&nbsp;<span class="num" id="4527468">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527471">good</span>&nbsp;<span class="op" id="4527476">=</span>&nbsp;<span class="builtintype" id="4527478">uint8</span><span class="op" id="4527483">(</span><span class="builtintype" id="4527484">int8</span><span class="op" id="4527488">(</span><span class="ident" id="4527489">good</span><span class="op" id="4527493">)</span>&nbsp;<span class="op" id="4527495">&gt;&gt;</span>&nbsp;<span class="num" id="4527498">7</span><span class="op" id="4527499">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527503">toRemove</span>&nbsp;<span class="op" id="4527512">:=</span>&nbsp;<span class="ident" id="4527515">good</span><span class="op" id="4527519">&amp;</span><span class="ident" id="4527520">paddingLen</span>&nbsp;<span class="op" id="4527531">+</span>&nbsp;<span class="num" id="4527533">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527536">return</span>&nbsp;<span class="ident" id="4527543">payload</span><span class="op" id="4527550">[</span><span class="op" id="4527551">:</span><span class="builtinfunc" id="4527552">len</span><span class="op" id="4527555">(</span><span class="ident" id="4527556">payload</span><span class="op" id="4527563">)</span><span class="op" id="4527564">-</span><span class="builtintype" id="4527565">int</span><span class="op" id="4527568">(</span><span class="ident" id="4527569">toRemove</span><span class="op" id="4527577">)</span><span class="op" id="4527578">]</span><span class="op" id="4527579">,</span>&nbsp;<span class="ident" id="4527581">good</span><br>
<span class="lineno"></span><span class="op" id="4527586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="comment" id="4527589">//&nbsp;removePaddingSSL30&nbsp;is&nbsp;a&nbsp;replacement&nbsp;for&nbsp;removePadding&nbsp;in&nbsp;the&nbsp;case&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4527667">//&nbsp;protocol&nbsp;version&nbsp;is&nbsp;SSLv3.&nbsp;In&nbsp;this&nbsp;version,&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="4527742">//&nbsp;are&nbsp;random&nbsp;and&nbsp;cannot&nbsp;be&nbsp;checked.</span><br>
<span class="lineno"></span><span class="keyword" id="4527779">func</span>&nbsp;<span class="ident" id="4527784">removePaddingSSL30</span><span class="op" id="4527802">(</span><span class="ident" id="4527803">payload</span>&nbsp;<span class="op" id="4527811">[</span><span class="op" id="4527812">]</span><span class="builtintype" id="4527813">byte</span><span class="op" id="4527817">)</span>&nbsp;<span class="op" id="4527819">(</span><span class="op" id="4527820">[</span><span class="op" id="4527821">]</span><span class="builtintype" id="4527822">byte</span><span class="op" id="4527826">,</span>&nbsp;<span class="builtintype" id="4527828">byte</span><span class="op" id="4527832">)</span>&nbsp;<span class="op" id="4527834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527837">if</span>&nbsp;<span class="builtinfunc" id="4527840">len</span><span class="op" id="4527843">(</span><span class="ident" id="4527844">payload</span><span class="op" id="4527851">)</span>&nbsp;<span class="op" id="4527853">&lt;</span>&nbsp;<span class="num" id="4527855">1</span>&nbsp;<span class="op" id="4527857">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527861">return</span>&nbsp;<span class="ident" id="4527868">payload</span><span class="op" id="4527875">,</span>&nbsp;<span class="num" id="4527877">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4527880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527884">paddingLen</span>&nbsp;<span class="op" id="4527895">:=</span>&nbsp;<span class="builtintype" id="4527898">int</span><span class="op" id="4527901">(</span><span class="ident" id="4527902">payload</span><span class="op" id="4527909">[</span><span class="builtinfunc" id="4527910">len</span><span class="op" id="4527913">(</span><span class="ident" id="4527914">payload</span><span class="op" id="4527921">)</span><span class="op" id="4527922">-</span><span class="num" id="4527923">1</span><span class="op" id="4527924">]</span><span class="op" id="4527925">)</span>&nbsp;<span class="op" id="4527927">+</span>&nbsp;<span class="num" id="4527929">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527932">if</span>&nbsp;<span class="ident" id="4527935">paddingLen</span>&nbsp;<span class="op" id="4527946">&gt;</span>&nbsp;<span class="builtinfunc" id="4527948">len</span><span class="op" id="4527951">(</span><span class="ident" id="4527952">payload</span><span class="op" id="4527959">)</span>&nbsp;<span class="op" id="4527961">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527965">return</span>&nbsp;<span class="ident" id="4527972">payload</span><span class="op" id="4527979">,</span>&nbsp;<span class="num" id="4527981">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4527984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527988">return</span>&nbsp;<span class="ident" id="4527995">payload</span><span class="op" id="4528002">[</span><span class="op" id="4528003">:</span><span class="builtinfunc" id="4528004">len</span><span class="op" id="4528007">(</span><span class="ident" id="4528008">payload</span><span class="op" id="4528015">)</span><span class="op" id="4528016">-</span><span class="ident" id="4528017">paddingLen</span><span class="op" id="4528027">]</span><span class="op" id="4528028">,</span>&nbsp;<span class="num" id="4528030">255</span><br>
<span class="lineno"></span><span class="op" id="4528034">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="4528037">func</span>&nbsp;<span class="ident" id="4528042">roundUp</span><span class="op" id="4528049">(</span><span class="ident" id="4528050">a</span><span class="op" id="4528051">,</span>&nbsp;<span class="ident" id="4528053">b</span>&nbsp;<span class="builtintype" id="4528055">int</span><span class="op" id="4528058">)</span>&nbsp;<span class="builtintype" id="4528060">int</span>&nbsp;<span class="op" id="4528064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528067">return</span>&nbsp;<span class="ident" id="4528074">a</span>&nbsp;<span class="op" id="4528076">+</span>&nbsp;<span class="op" id="4528078">(</span><span class="ident" id="4528079">b</span><span class="op" id="4528080">-</span><span class="ident" id="4528081">a</span><span class="op" id="4528082">%</span><span class="ident" id="4528083">b</span><span class="op" id="4528084">)</span><span class="op" id="4528085">%</span><span class="ident" id="4528086">b</span><br>
<span class="lineno"></span><span class="op" id="4528088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="comment" id="4528091">//&nbsp;cbcMode&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;block&nbsp;ciphers&nbsp;using&nbsp;cipher&nbsp;block&nbsp;chaining.</span><br>
<span class="lineno"></span><span class="keyword" id="4528165">type</span>&nbsp;<span class="ident" id="4528170">cbcMode</span>&nbsp;<span class="keyword" id="4528178">interface</span>&nbsp;<span class="op" id="4528188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528191">cipher</span><span class="op" id="4528197">.</span><span class="ident" id="4528198">BlockMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528209">SetIV</span><span class="op" id="4528214">(</span><span class="op" id="4528215">[</span><span class="op" id="4528216">]</span><span class="builtintype" id="4528217">byte</span><span class="op" id="4528221">)</span><br>
<span class="lineno"></span><span class="op" id="4528223">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="4528226">//&nbsp;decrypt&nbsp;checks&nbsp;and&nbsp;strips&nbsp;the&nbsp;mac&nbsp;and&nbsp;decrypts&nbsp;the&nbsp;data&nbsp;in&nbsp;b.&nbsp;Returns&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4528301">//&nbsp;success&nbsp;boolean,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;skip&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;record&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4528381">//&nbsp;order&nbsp;to&nbsp;get&nbsp;the&nbsp;application&nbsp;payload,&nbsp;and&nbsp;an&nbsp;optional&nbsp;alert&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4528451">func</span>&nbsp;<span class="op" id="4528456">(</span><span class="ident" id="4528457">hc</span>&nbsp;<span class="op" id="4528460">*</span><span class="ident" id="4528461">halfConn</span><span class="op" id="4528469">)</span>&nbsp;<span class="ident" id="4528471">decrypt</span><span class="op" id="4528478">(</span><span class="ident" id="4528479">b</span>&nbsp;<span class="op" id="4528481">*</span><span class="ident" id="4528482">block</span><span class="op" id="4528487">)</span>&nbsp;<span class="op" id="4528489">(</span><span class="ident" id="4528490">ok</span>&nbsp;<span class="builtintype" id="4528493">bool</span><span class="op" id="4528497">,</span>&nbsp;<span class="ident" id="4528499">prefixLen</span>&nbsp;<span class="builtintype" id="4528509">int</span><span class="op" id="4528512">,</span>&nbsp;<span class="ident" id="4528514">alertValue</span>&nbsp;<span class="ident" id="4528525">alert</span><span class="op" id="4528530">)</span>&nbsp;<span class="op" id="4528532">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4528535">//&nbsp;pull&nbsp;out&nbsp;payload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528556">payload</span>&nbsp;<span class="op" id="4528564">:=</span>&nbsp;<span class="ident" id="4528567">b</span><span class="op" id="4528568">.</span><span class="ident" id="4528569">data</span><span class="op" id="4528573">[</span><span class="ident" id="4528574">recordHeaderLen</span><span class="op" id="4528589">:</span><span class="op" id="4528590">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528594">macSize</span>&nbsp;<span class="op" id="4528602">:=</span>&nbsp;<span class="num" id="4528605">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528608">if</span>&nbsp;<span class="ident" id="4528611">hc</span><span class="op" id="4528613">.</span><span class="ident" id="4528614">mac</span>&nbsp;<span class="op" id="4528618">!=</span>&nbsp;<span class="ident" id="4528621">nil</span>&nbsp;<span class="op" id="4528625">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528629">macSize</span>&nbsp;<span class="op" id="4528637">=</span>&nbsp;<span class="ident" id="4528639">hc</span><span class="op" id="4528641">.</span><span class="ident" id="4528642">mac</span><span class="op" id="4528645">.</span><span class="ident" id="4528646">Size</span><span class="op" id="4528650">(</span><span class="op" id="4528651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4528654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528658">paddingGood</span>&nbsp;<span class="op" id="4528670">:=</span>&nbsp;<span class="builtintype" id="4528673">byte</span><span class="op" id="4528677">(</span><span class="num" id="4528678">255</span><span class="op" id="4528681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528684">explicitIVLen</span>&nbsp;<span class="op" id="4528698">:=</span>&nbsp;<span class="num" id="4528701">0</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4528705">//&nbsp;decrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528717">if</span>&nbsp;<span class="ident" id="4528720">hc</span><span class="op" id="4528722">.</span><span class="ident" id="4528723">cipher</span>&nbsp;<span class="op" id="4528730">!=</span>&nbsp;<span class="ident" id="4528733">nil</span>&nbsp;<span class="op" id="4528737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528741">switch</span>&nbsp;<span class="ident" id="4528748">c</span>&nbsp;<span class="op" id="4528750">:=</span>&nbsp;<span class="ident" id="4528753">hc</span><span class="op" id="4528755">.</span><span class="ident" id="4528756">cipher</span><span class="op" id="4528762">.</span><span class="op" id="4528763">(</span><span class="keyword" id="4528764">type</span><span class="op" id="4528768">)</span>&nbsp;<span class="op" id="4528770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528774">case</span>&nbsp;<span class="ident" id="4528779">cipher</span><span class="op" id="4528785">.</span><span class="ident" id="4528786">Stream</span><span class="op" id="4528792">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528797">c</span><span class="op" id="4528798">.</span><span class="ident" id="4528799">XORKeyStream</span><span class="op" id="4528811">(</span><span class="ident" id="4528812">payload</span><span class="op" id="4528819">,</span>&nbsp;<span class="ident" id="4528821">payload</span><span class="op" id="4528828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528832">case</span>&nbsp;<span class="ident" id="4528837">cipher</span><span class="op" id="4528843">.</span><span class="ident" id="4528844">AEAD</span><span class="op" id="4528848">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528853">explicitIVLen</span>&nbsp;<span class="op" id="4528867">=</span>&nbsp;<span class="num" id="4528869">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528874">if</span>&nbsp;<span class="builtinfunc" id="4528877">len</span><span class="op" id="4528880">(</span><span class="ident" id="4528881">payload</span><span class="op" id="4528888">)</span>&nbsp;<span class="op" id="4528890">&lt;</span>&nbsp;<span class="ident" id="4528892">explicitIVLen</span>&nbsp;<span class="op" id="4528906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528912">return</span>&nbsp;<span class="builtintype" id="4528919">false</span><span class="op" id="4528924">,</span>&nbsp;<span class="num" id="4528926">0</span><span class="op" id="4528927">,</span>&nbsp;<span class="ident" id="4528929">alertBadRecordMAC</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4528950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528955">nonce</span>&nbsp;<span class="op" id="4528961">:=</span>&nbsp;<span class="ident" id="4528964">payload</span><span class="op" id="4528971">[</span><span class="op" id="4528972">:</span><span class="num" id="4528973">8</span><span class="op" id="4528974">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528979">payload</span>&nbsp;<span class="op" id="4528987">=</span>&nbsp;<span class="ident" id="4528989">payload</span><span class="op" id="4528996">[</span><span class="num" id="4528997">8</span><span class="op" id="4528998">:</span><span class="op" id="4528999">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529005">var</span>&nbsp;<span class="ident" id="4529009">additionalData</span>&nbsp;<span class="op" id="4529024">[</span><span class="num" id="4529025">13</span><span class="op" id="4529027">]</span><span class="builtintype" id="4529028">byte</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4529036">copy</span><span class="op" id="4529040">(</span><span class="ident" id="4529041">additionalData</span><span class="op" id="4529055">[</span><span class="op" id="4529056">:</span><span class="op" id="4529057">]</span><span class="op" id="4529058">,</span>&nbsp;<span class="ident" id="4529060">hc</span><span class="op" id="4529062">.</span><span class="ident" id="4529063">seq</span><span class="op" id="4529066">[</span><span class="op" id="4529067">:</span><span class="op" id="4529068">]</span><span class="op" id="4529069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4529074">copy</span><span class="op" id="4529078">(</span><span class="ident" id="4529079">additionalData</span><span class="op" id="4529093">[</span><span class="num" id="4529094">8</span><span class="op" id="4529095">:</span><span class="op" id="4529096">]</span><span class="op" id="4529097">,</span>&nbsp;<span class="ident" id="4529099">b</span><span class="op" id="4529100">.</span><span class="ident" id="4529101">data</span><span class="op" id="4529105">[</span><span class="op" id="4529106">:</span><span class="num" id="4529107">3</span><span class="op" id="4529108">]</span><span class="op" id="4529109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529114">n</span>&nbsp;<span class="op" id="4529116">:=</span>&nbsp;<span class="builtinfunc" id="4529119">len</span><span class="op" id="4529122">(</span><span class="ident" id="4529123">payload</span><span class="op" id="4529130">)</span>&nbsp;<span class="op" id="4529132">-</span>&nbsp;<span class="ident" id="4529134">c</span><span class="op" id="4529135">.</span><span class="ident" id="4529136">Overhead</span><span class="op" id="4529144">(</span><span class="op" id="4529145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529150">additionalData</span><span class="op" id="4529164">[</span><span class="num" id="4529165">11</span><span class="op" id="4529167">]</span>&nbsp;<span class="op" id="4529169">=</span>&nbsp;<span class="builtintype" id="4529171">byte</span><span class="op" id="4529175">(</span><span class="ident" id="4529176">n</span>&nbsp;<span class="op" id="4529178">&gt;&gt;</span>&nbsp;<span class="num" id="4529181">8</span><span class="op" id="4529182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529187">additionalData</span><span class="op" id="4529201">[</span><span class="num" id="4529202">12</span><span class="op" id="4529204">]</span>&nbsp;<span class="op" id="4529206">=</span>&nbsp;<span class="builtintype" id="4529208">byte</span><span class="op" id="4529212">(</span><span class="ident" id="4529213">n</span><span class="op" id="4529214">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529219">var</span>&nbsp;<span class="ident" id="4529223">err</span>&nbsp;<span class="builtintype" id="4529227">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529236">payload</span><span class="op" id="4529243">,</span>&nbsp;<span class="ident" id="4529245">err</span>&nbsp;<span class="op" id="4529249">=</span>&nbsp;<span class="ident" id="4529251">c</span><span class="op" id="4529252">.</span><span class="ident" id="4529253">Open</span><span class="op" id="4529257">(</span><span class="ident" id="4529258">payload</span><span class="op" id="4529265">[</span><span class="op" id="4529266">:</span><span class="num" id="4529267">0</span><span class="op" id="4529268">]</span><span class="op" id="4529269">,</span>&nbsp;<span class="ident" id="4529271">nonce</span><span class="op" id="4529276">,</span>&nbsp;<span class="ident" id="4529278">payload</span><span class="op" id="4529285">,</span>&nbsp;<span class="ident" id="4529287">additionalData</span><span class="op" id="4529301">[</span><span class="op" id="4529302">:</span><span class="op" id="4529303">]</span><span class="op" id="4529304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529309">if</span>&nbsp;<span class="ident" id="4529312">err</span>&nbsp;<span class="op" id="4529316">!=</span>&nbsp;<span class="ident" id="4529319">nil</span>&nbsp;<span class="op" id="4529323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529329">return</span>&nbsp;<span class="builtintype" id="4529336">false</span><span class="op" id="4529341">,</span>&nbsp;<span class="num" id="4529343">0</span><span class="op" id="4529344">,</span>&nbsp;<span class="ident" id="4529346">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529367">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529372">b</span><span class="op" id="4529373">.</span><span class="ident" id="4529374">resize</span><span class="op" id="4529380">(</span><span class="ident" id="4529381">recordHeaderLen</span>&nbsp;<span class="op" id="4529397">+</span>&nbsp;<span class="ident" id="4529399">explicitIVLen</span>&nbsp;<span class="op" id="4529413">+</span>&nbsp;<span class="builtinfunc" id="4529415">len</span><span class="op" id="4529418">(</span><span class="ident" id="4529419">payload</span><span class="op" id="4529426">)</span><span class="op" id="4529427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529431">case</span>&nbsp;<span class="ident" id="4529436">cbcMode</span><span class="op" id="4529443">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529448">blockSize</span>&nbsp;<span class="op" id="4529458">:=</span>&nbsp;<span class="ident" id="4529461">c</span><span class="op" id="4529462">.</span><span class="ident" id="4529463">BlockSize</span><span class="op" id="4529472">(</span><span class="op" id="4529473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529478">if</span>&nbsp;<span class="ident" id="4529481">hc</span><span class="op" id="4529483">.</span><span class="ident" id="4529484">version</span>&nbsp;<span class="op" id="4529492">&gt;=</span>&nbsp;<span class="ident" id="4529495">VersionTLS11</span>&nbsp;<span class="op" id="4529508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529514">explicitIVLen</span>&nbsp;<span class="op" id="4529528">=</span>&nbsp;<span class="ident" id="4529530">blockSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529549">if</span>&nbsp;<span class="builtinfunc" id="4529552">len</span><span class="op" id="4529555">(</span><span class="ident" id="4529556">payload</span><span class="op" id="4529563">)</span><span class="op" id="4529564">%</span><span class="ident" id="4529565">blockSize</span>&nbsp;<span class="op" id="4529575">!=</span>&nbsp;<span class="num" id="4529578">0</span>&nbsp;<span class="op" id="4529580">||</span>&nbsp;<span class="builtinfunc" id="4529583">len</span><span class="op" id="4529586">(</span><span class="ident" id="4529587">payload</span><span class="op" id="4529594">)</span>&nbsp;<span class="op" id="4529596">&lt;</span>&nbsp;<span class="ident" id="4529598">roundUp</span><span class="op" id="4529605">(</span><span class="ident" id="4529606">explicitIVLen</span><span class="op" id="4529619">+</span><span class="ident" id="4529620">macSize</span><span class="op" id="4529627">+</span><span class="num" id="4529628">1</span><span class="op" id="4529629">,</span>&nbsp;<span class="ident" id="4529631">blockSize</span><span class="op" id="4529640">)</span>&nbsp;<span class="op" id="4529642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529648">return</span>&nbsp;<span class="builtintype" id="4529655">false</span><span class="op" id="4529660">,</span>&nbsp;<span class="num" id="4529662">0</span><span class="op" id="4529663">,</span>&nbsp;<span class="ident" id="4529665">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529686">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529692">if</span>&nbsp;<span class="ident" id="4529695">explicitIVLen</span>&nbsp;<span class="op" id="4529709">&gt;</span>&nbsp;<span class="num" id="4529711">0</span>&nbsp;<span class="op" id="4529713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529719">c</span><span class="op" id="4529720">.</span><span class="ident" id="4529721">SetIV</span><span class="op" id="4529726">(</span><span class="ident" id="4529727">payload</span><span class="op" id="4529734">[</span><span class="op" id="4529735">:</span><span class="ident" id="4529736">explicitIVLen</span><span class="op" id="4529749">]</span><span class="op" id="4529750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529756">payload</span>&nbsp;<span class="op" id="4529764">=</span>&nbsp;<span class="ident" id="4529766">payload</span><span class="op" id="4529773">[</span><span class="ident" id="4529774">explicitIVLen</span><span class="op" id="4529787">:</span><span class="op" id="4529788">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529793">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529798">c</span><span class="op" id="4529799">.</span><span class="ident" id="4529800">CryptBlocks</span><span class="op" id="4529811">(</span><span class="ident" id="4529812">payload</span><span class="op" id="4529819">,</span>&nbsp;<span class="ident" id="4529821">payload</span><span class="op" id="4529828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529833">if</span>&nbsp;<span class="ident" id="4529836">hc</span><span class="op" id="4529838">.</span><span class="ident" id="4529839">version</span>&nbsp;<span class="op" id="4529847">==</span>&nbsp;<span class="ident" id="4529850">VersionSSL30</span>&nbsp;<span class="op" id="4529863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529869">payload</span><span class="op" id="4529876">,</span>&nbsp;<span class="ident" id="4529878">paddingGood</span>&nbsp;<span class="op" id="4529890">=</span>&nbsp;<span class="ident" id="4529892">removePaddingSSL30</span><span class="op" id="4529910">(</span><span class="ident" id="4529911">payload</span><span class="op" id="4529918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529923">}</span>&nbsp;<span class="keyword" id="4529925">else</span>&nbsp;<span class="op" id="4529930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529936">payload</span><span class="op" id="4529943">,</span>&nbsp;<span class="ident" id="4529945">paddingGood</span>&nbsp;<span class="op" id="4529957">=</span>&nbsp;<span class="ident" id="4529959">removePadding</span><span class="op" id="4529972">(</span><span class="ident" id="4529973">payload</span><span class="op" id="4529980">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529990">b</span><span class="op" id="4529991">.</span><span class="ident" id="4529992">resize</span><span class="op" id="4529998">(</span><span class="ident" id="4529999">recordHeaderLen</span>&nbsp;<span class="op" id="4530015">+</span>&nbsp;<span class="ident" id="4530017">explicitIVLen</span>&nbsp;<span class="op" id="4530031">+</span>&nbsp;<span class="builtinfunc" id="4530033">len</span><span class="op" id="4530036">(</span><span class="ident" id="4530037">payload</span><span class="op" id="4530044">)</span><span class="op" id="4530045">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530051">//&nbsp;note&nbsp;that&nbsp;we&nbsp;still&nbsp;have&nbsp;a&nbsp;timing&nbsp;side-channel&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530110">//&nbsp;MAC&nbsp;check,&nbsp;below.&nbsp;An&nbsp;attacker&nbsp;can&nbsp;align&nbsp;the&nbsp;record</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530167">//&nbsp;so&nbsp;that&nbsp;a&nbsp;correct&nbsp;padding&nbsp;will&nbsp;cause&nbsp;one&nbsp;less&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530224">//&nbsp;block&nbsp;to&nbsp;be&nbsp;calculated.&nbsp;Then&nbsp;they&nbsp;can&nbsp;iteratively</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530280">//&nbsp;decrypt&nbsp;a&nbsp;record&nbsp;by&nbsp;breaking&nbsp;each&nbsp;byte.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530330">//&nbsp;&#34;Password&nbsp;Interception&nbsp;in&nbsp;a&nbsp;SSL/TLS&nbsp;Channel&#34;,&nbsp;Brice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530388">//&nbsp;Canvel&nbsp;et&nbsp;al.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530408">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530414">//&nbsp;However,&nbsp;our&nbsp;behavior&nbsp;matches&nbsp;OpenSSL,&nbsp;so&nbsp;we&nbsp;leak</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530470">//&nbsp;only&nbsp;as&nbsp;much&nbsp;as&nbsp;they&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530500">default</span><span class="op" id="4530507">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4530512">panic</span><span class="op" id="4530517">(</span><span class="string" id="4530518">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="4530539">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530550">//&nbsp;check,&nbsp;strip&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530571">if</span>&nbsp;<span class="ident" id="4530574">hc</span><span class="op" id="4530576">.</span><span class="ident" id="4530577">mac</span>&nbsp;<span class="op" id="4530581">!=</span>&nbsp;<span class="ident" id="4530584">nil</span>&nbsp;<span class="op" id="4530588">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530592">if</span>&nbsp;<span class="builtinfunc" id="4530595">len</span><span class="op" id="4530598">(</span><span class="ident" id="4530599">payload</span><span class="op" id="4530606">)</span>&nbsp;<span class="op" id="4530608">&lt;</span>&nbsp;<span class="ident" id="4530610">macSize</span>&nbsp;<span class="op" id="4530618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530623">return</span>&nbsp;<span class="builtintype" id="4530630">false</span><span class="op" id="4530635">,</span>&nbsp;<span class="num" id="4530637">0</span><span class="op" id="4530638">,</span>&nbsp;<span class="ident" id="4530640">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530665">//&nbsp;strip&nbsp;mac&nbsp;off&nbsp;payload,&nbsp;b.data</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530700">n</span>&nbsp;<span class="op" id="4530702">:=</span>&nbsp;<span class="builtinfunc" id="4530705">len</span><span class="op" id="4530708">(</span><span class="ident" id="4530709">payload</span><span class="op" id="4530716">)</span>&nbsp;<span class="op" id="4530718">-</span>&nbsp;<span class="ident" id="4530720">macSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530730">b</span><span class="op" id="4530731">.</span><span class="ident" id="4530732">data</span><span class="op" id="4530736">[</span><span class="num" id="4530737">3</span><span class="op" id="4530738">]</span>&nbsp;<span class="op" id="4530740">=</span>&nbsp;<span class="builtintype" id="4530742">byte</span><span class="op" id="4530746">(</span><span class="ident" id="4530747">n</span>&nbsp;<span class="op" id="4530749">&gt;&gt;</span>&nbsp;<span class="num" id="4530752">8</span><span class="op" id="4530753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530757">b</span><span class="op" id="4530758">.</span><span class="ident" id="4530759">data</span><span class="op" id="4530763">[</span><span class="num" id="4530764">4</span><span class="op" id="4530765">]</span>&nbsp;<span class="op" id="4530767">=</span>&nbsp;<span class="builtintype" id="4530769">byte</span><span class="op" id="4530773">(</span><span class="ident" id="4530774">n</span><span class="op" id="4530775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530779">b</span><span class="op" id="4530780">.</span><span class="ident" id="4530781">resize</span><span class="op" id="4530787">(</span><span class="ident" id="4530788">recordHeaderLen</span>&nbsp;<span class="op" id="4530804">+</span>&nbsp;<span class="ident" id="4530806">explicitIVLen</span>&nbsp;<span class="op" id="4530820">+</span>&nbsp;<span class="ident" id="4530822">n</span><span class="op" id="4530823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530827">remoteMAC</span>&nbsp;<span class="op" id="4530837">:=</span>&nbsp;<span class="ident" id="4530840">payload</span><span class="op" id="4530847">[</span><span class="ident" id="4530848">n</span><span class="op" id="4530849">:</span><span class="op" id="4530850">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530854">localMAC</span>&nbsp;<span class="op" id="4530863">:=</span>&nbsp;<span class="ident" id="4530866">hc</span><span class="op" id="4530868">.</span><span class="ident" id="4530869">mac</span><span class="op" id="4530872">.</span><span class="ident" id="4530873">MAC</span><span class="op" id="4530876">(</span><span class="ident" id="4530877">hc</span><span class="op" id="4530879">.</span><span class="ident" id="4530880">inDigestBuf</span><span class="op" id="4530891">,</span>&nbsp;<span class="ident" id="4530893">hc</span><span class="op" id="4530895">.</span><span class="ident" id="4530896">seq</span><span class="op" id="4530899">[</span><span class="num" id="4530900">0</span><span class="op" id="4530901">:</span><span class="op" id="4530902">]</span><span class="op" id="4530903">,</span>&nbsp;<span class="ident" id="4530905">b</span><span class="op" id="4530906">.</span><span class="ident" id="4530907">data</span><span class="op" id="4530911">[</span><span class="op" id="4530912">:</span><span class="ident" id="4530913">recordHeaderLen</span><span class="op" id="4530928">]</span><span class="op" id="4530929">,</span>&nbsp;<span class="ident" id="4530931">payload</span><span class="op" id="4530938">[</span><span class="op" id="4530939">:</span><span class="ident" id="4530940">n</span><span class="op" id="4530941">]</span><span class="op" id="4530942">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530947">if</span>&nbsp;<span class="ident" id="4530950">subtle</span><span class="op" id="4530956">.</span><span class="ident" id="4530957">ConstantTimeCompare</span><span class="op" id="4530976">(</span><span class="ident" id="4530977">localMAC</span><span class="op" id="4530985">,</span>&nbsp;<span class="ident" id="4530987">remoteMAC</span><span class="op" id="4530996">)</span>&nbsp;<span class="op" id="4530998">!=</span>&nbsp;<span class="num" id="4531001">1</span>&nbsp;<span class="op" id="4531003">||</span>&nbsp;<span class="ident" id="4531006">paddingGood</span>&nbsp;<span class="op" id="4531018">!=</span>&nbsp;<span class="num" id="4531021">255</span>&nbsp;<span class="op" id="4531025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531030">return</span>&nbsp;<span class="builtintype" id="4531037">false</span><span class="op" id="4531042">,</span>&nbsp;<span class="num" id="4531044">0</span><span class="op" id="4531045">,</span>&nbsp;<span class="ident" id="4531047">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4531067">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531071">hc</span><span class="op" id="4531073">.</span><span class="ident" id="4531074">inDigestBuf</span>&nbsp;<span class="op" id="4531086">=</span>&nbsp;<span class="ident" id="4531088">localMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4531098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531101">hc</span><span class="op" id="4531103">.</span><span class="ident" id="4531104">incSeq</span><span class="op" id="4531110">(</span><span class="op" id="4531111">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531115">return</span>&nbsp;<span class="builtintype" id="4531122">true</span><span class="op" id="4531126">,</span>&nbsp;<span class="ident" id="4531128">recordHeaderLen</span>&nbsp;<span class="op" id="4531144">+</span>&nbsp;<span class="ident" id="4531146">explicitIVLen</span><span class="op" id="4531159">,</span>&nbsp;<span class="num" id="4531161">0</span><br>
<span class="lineno">335</span><span class="op" id="4531163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4531166">//&nbsp;padToBlockSize&nbsp;calculates&nbsp;the&nbsp;needed&nbsp;padding&nbsp;block,&nbsp;if&nbsp;any,&nbsp;for&nbsp;a&nbsp;payload.</span><br>
<span class="lineno"></span><span class="comment" id="4531244">//&nbsp;On&nbsp;exit,&nbsp;prefix&nbsp;aliases&nbsp;payload&nbsp;and&nbsp;extends&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;last&nbsp;full</span><br>
<span class="lineno"></span><span class="comment" id="4531319">//&nbsp;block&nbsp;of&nbsp;payload.&nbsp;finalBlock&nbsp;is&nbsp;a&nbsp;fresh&nbsp;slice&nbsp;which&nbsp;contains&nbsp;the&nbsp;contents&nbsp;of</span><br>
<span class="lineno">340</span><span class="comment" id="4531399">//&nbsp;any&nbsp;suffix&nbsp;of&nbsp;payload&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;needed&nbsp;padding&nbsp;to&nbsp;make&nbsp;finalBlock&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4531475">//&nbsp;full&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="4531490">func</span>&nbsp;<span class="ident" id="4531495">padToBlockSize</span><span class="op" id="4531509">(</span><span class="ident" id="4531510">payload</span>&nbsp;<span class="op" id="4531518">[</span><span class="op" id="4531519">]</span><span class="builtintype" id="4531520">byte</span><span class="op" id="4531524">,</span>&nbsp;<span class="ident" id="4531526">blockSize</span>&nbsp;<span class="builtintype" id="4531536">int</span><span class="op" id="4531539">)</span>&nbsp;<span class="op" id="4531541">(</span><span class="ident" id="4531542">prefix</span><span class="op" id="4531548">,</span>&nbsp;<span class="ident" id="4531550">finalBlock</span>&nbsp;<span class="op" id="4531561">[</span><span class="op" id="4531562">]</span><span class="builtintype" id="4531563">byte</span><span class="op" id="4531567">)</span>&nbsp;<span class="op" id="4531569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531572">overrun</span>&nbsp;<span class="op" id="4531580">:=</span>&nbsp;<span class="builtinfunc" id="4531583">len</span><span class="op" id="4531586">(</span><span class="ident" id="4531587">payload</span><span class="op" id="4531594">)</span>&nbsp;<span class="op" id="4531596">%</span>&nbsp;<span class="ident" id="4531598">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531609">paddingLen</span>&nbsp;<span class="op" id="4531620">:=</span>&nbsp;<span class="ident" id="4531623">blockSize</span>&nbsp;<span class="op" id="4531633">-</span>&nbsp;<span class="ident" id="4531635">overrun</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531644">prefix</span>&nbsp;<span class="op" id="4531651">=</span>&nbsp;<span class="ident" id="4531653">payload</span><span class="op" id="4531660">[</span><span class="op" id="4531661">:</span><span class="builtinfunc" id="4531662">len</span><span class="op" id="4531665">(</span><span class="ident" id="4531666">payload</span><span class="op" id="4531673">)</span><span class="op" id="4531674">-</span><span class="ident" id="4531675">overrun</span><span class="op" id="4531682">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531685">finalBlock</span>&nbsp;<span class="op" id="4531696">=</span>&nbsp;<span class="builtinfunc" id="4531698">make</span><span class="op" id="4531702">(</span><span class="op" id="4531703">[</span><span class="op" id="4531704">]</span><span class="builtintype" id="4531705">byte</span><span class="op" id="4531709">,</span>&nbsp;<span class="ident" id="4531711">blockSize</span><span class="op" id="4531720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4531723">copy</span><span class="op" id="4531727">(</span><span class="ident" id="4531728">finalBlock</span><span class="op" id="4531738">,</span>&nbsp;<span class="ident" id="4531740">payload</span><span class="op" id="4531747">[</span><span class="builtinfunc" id="4531748">len</span><span class="op" id="4531751">(</span><span class="ident" id="4531752">payload</span><span class="op" id="4531759">)</span><span class="op" id="4531760">-</span><span class="ident" id="4531761">overrun</span><span class="op" id="4531768">:</span><span class="op" id="4531769">]</span><span class="op" id="4531770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531773">for</span>&nbsp;<span class="ident" id="4531777">i</span>&nbsp;<span class="op" id="4531779">:=</span>&nbsp;<span class="ident" id="4531782">overrun</span><span class="op" id="4531789">;</span>&nbsp;<span class="ident" id="4531791">i</span>&nbsp;<span class="op" id="4531793">&lt;</span>&nbsp;<span class="ident" id="4531795">blockSize</span><span class="op" id="4531804">;</span>&nbsp;<span class="ident" id="4531806">i</span><span class="op" id="4531807">++</span>&nbsp;<span class="op" id="4531810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531814">finalBlock</span><span class="op" id="4531824">[</span><span class="ident" id="4531825">i</span><span class="op" id="4531826">]</span>&nbsp;<span class="op" id="4531828">=</span>&nbsp;<span class="builtintype" id="4531830">byte</span><span class="op" id="4531834">(</span><span class="ident" id="4531835">paddingLen</span>&nbsp;<span class="op" id="4531846">-</span>&nbsp;<span class="num" id="4531848">1</span><span class="op" id="4531849">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4531852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531855">return</span><br>
<span class="lineno"></span><span class="op" id="4531862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4531865">//&nbsp;encrypt&nbsp;encrypts&nbsp;and&nbsp;macs&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno">355</span><span class="keyword" id="4531909">func</span>&nbsp;<span class="op" id="4531914">(</span><span class="ident" id="4531915">hc</span>&nbsp;<span class="op" id="4531918">*</span><span class="ident" id="4531919">halfConn</span><span class="op" id="4531927">)</span>&nbsp;<span class="ident" id="4531929">encrypt</span><span class="op" id="4531936">(</span><span class="ident" id="4531937">b</span>&nbsp;<span class="op" id="4531939">*</span><span class="ident" id="4531940">block</span><span class="op" id="4531945">,</span>&nbsp;<span class="ident" id="4531947">explicitIVLen</span>&nbsp;<span class="builtintype" id="4531961">int</span><span class="op" id="4531964">)</span>&nbsp;<span class="op" id="4531966">(</span><span class="builtintype" id="4531967">bool</span><span class="op" id="4531971">,</span>&nbsp;<span class="ident" id="4531973">alert</span><span class="op" id="4531978">)</span>&nbsp;<span class="op" id="4531980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4531983">//&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531991">if</span>&nbsp;<span class="ident" id="4531994">hc</span><span class="op" id="4531996">.</span><span class="ident" id="4531997">mac</span>&nbsp;<span class="op" id="4532001">!=</span>&nbsp;<span class="ident" id="4532004">nil</span>&nbsp;<span class="op" id="4532008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532012">mac</span>&nbsp;<span class="op" id="4532016">:=</span>&nbsp;<span class="ident" id="4532019">hc</span><span class="op" id="4532021">.</span><span class="ident" id="4532022">mac</span><span class="op" id="4532025">.</span><span class="ident" id="4532026">MAC</span><span class="op" id="4532029">(</span><span class="ident" id="4532030">hc</span><span class="op" id="4532032">.</span><span class="ident" id="4532033">outDigestBuf</span><span class="op" id="4532045">,</span>&nbsp;<span class="ident" id="4532047">hc</span><span class="op" id="4532049">.</span><span class="ident" id="4532050">seq</span><span class="op" id="4532053">[</span><span class="num" id="4532054">0</span><span class="op" id="4532055">:</span><span class="op" id="4532056">]</span><span class="op" id="4532057">,</span>&nbsp;<span class="ident" id="4532059">b</span><span class="op" id="4532060">.</span><span class="ident" id="4532061">data</span><span class="op" id="4532065">[</span><span class="op" id="4532066">:</span><span class="ident" id="4532067">recordHeaderLen</span><span class="op" id="4532082">]</span><span class="op" id="4532083">,</span>&nbsp;<span class="ident" id="4532085">b</span><span class="op" id="4532086">.</span><span class="ident" id="4532087">data</span><span class="op" id="4532091">[</span><span class="ident" id="4532092">recordHeaderLen</span><span class="op" id="4532107">+</span><span class="ident" id="4532108">explicitIVLen</span><span class="op" id="4532121">:</span><span class="op" id="4532122">]</span><span class="op" id="4532123">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532128">n</span>&nbsp;<span class="op" id="4532130">:=</span>&nbsp;<span class="builtinfunc" id="4532133">len</span><span class="op" id="4532136">(</span><span class="ident" id="4532137">b</span><span class="op" id="4532138">.</span><span class="ident" id="4532139">data</span><span class="op" id="4532143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532147">b</span><span class="op" id="4532148">.</span><span class="ident" id="4532149">resize</span><span class="op" id="4532155">(</span><span class="ident" id="4532156">n</span>&nbsp;<span class="op" id="4532158">+</span>&nbsp;<span class="builtinfunc" id="4532160">len</span><span class="op" id="4532163">(</span><span class="ident" id="4532164">mac</span><span class="op" id="4532167">)</span><span class="op" id="4532168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4532172">copy</span><span class="op" id="4532176">(</span><span class="ident" id="4532177">b</span><span class="op" id="4532178">.</span><span class="ident" id="4532179">data</span><span class="op" id="4532183">[</span><span class="ident" id="4532184">n</span><span class="op" id="4532185">:</span><span class="op" id="4532186">]</span><span class="op" id="4532187">,</span>&nbsp;<span class="ident" id="4532189">mac</span><span class="op" id="4532192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532196">hc</span><span class="op" id="4532198">.</span><span class="ident" id="4532199">outDigestBuf</span>&nbsp;<span class="op" id="4532212">=</span>&nbsp;<span class="ident" id="4532214">mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4532219">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532223">payload</span>&nbsp;<span class="op" id="4532231">:=</span>&nbsp;<span class="ident" id="4532234">b</span><span class="op" id="4532235">.</span><span class="ident" id="4532236">data</span><span class="op" id="4532240">[</span><span class="ident" id="4532241">recordHeaderLen</span><span class="op" id="4532256">:</span><span class="op" id="4532257">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4532261">//&nbsp;encrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532273">if</span>&nbsp;<span class="ident" id="4532276">hc</span><span class="op" id="4532278">.</span><span class="ident" id="4532279">cipher</span>&nbsp;<span class="op" id="4532286">!=</span>&nbsp;<span class="ident" id="4532289">nil</span>&nbsp;<span class="op" id="4532293">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532297">switch</span>&nbsp;<span class="ident" id="4532304">c</span>&nbsp;<span class="op" id="4532306">:=</span>&nbsp;<span class="ident" id="4532309">hc</span><span class="op" id="4532311">.</span><span class="ident" id="4532312">cipher</span><span class="op" id="4532318">.</span><span class="op" id="4532319">(</span><span class="keyword" id="4532320">type</span><span class="op" id="4532324">)</span>&nbsp;<span class="op" id="4532326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532330">case</span>&nbsp;<span class="ident" id="4532335">cipher</span><span class="op" id="4532341">.</span><span class="ident" id="4532342">Stream</span><span class="op" id="4532348">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532353">c</span><span class="op" id="4532354">.</span><span class="ident" id="4532355">XORKeyStream</span><span class="op" id="4532367">(</span><span class="ident" id="4532368">payload</span><span class="op" id="4532375">,</span>&nbsp;<span class="ident" id="4532377">payload</span><span class="op" id="4532384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532388">case</span>&nbsp;<span class="ident" id="4532393">cipher</span><span class="op" id="4532399">.</span><span class="ident" id="4532400">AEAD</span><span class="op" id="4532404">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532409">payloadLen</span>&nbsp;<span class="op" id="4532420">:=</span>&nbsp;<span class="builtinfunc" id="4532423">len</span><span class="op" id="4532426">(</span><span class="ident" id="4532427">b</span><span class="op" id="4532428">.</span><span class="ident" id="4532429">data</span><span class="op" id="4532433">)</span>&nbsp;<span class="op" id="4532435">-</span>&nbsp;<span class="ident" id="4532437">recordHeaderLen</span>&nbsp;<span class="op" id="4532453">-</span>&nbsp;<span class="ident" id="4532455">explicitIVLen</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532472">b</span><span class="op" id="4532473">.</span><span class="ident" id="4532474">resize</span><span class="op" id="4532480">(</span><span class="builtinfunc" id="4532481">len</span><span class="op" id="4532484">(</span><span class="ident" id="4532485">b</span><span class="op" id="4532486">.</span><span class="ident" id="4532487">data</span><span class="op" id="4532491">)</span>&nbsp;<span class="op" id="4532493">+</span>&nbsp;<span class="ident" id="4532495">c</span><span class="op" id="4532496">.</span><span class="ident" id="4532497">Overhead</span><span class="op" id="4532505">(</span><span class="op" id="4532506">)</span><span class="op" id="4532507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532512">nonce</span>&nbsp;<span class="op" id="4532518">:=</span>&nbsp;<span class="ident" id="4532521">b</span><span class="op" id="4532522">.</span><span class="ident" id="4532523">data</span><span class="op" id="4532527">[</span><span class="ident" id="4532528">recordHeaderLen</span>&nbsp;<span class="op" id="4532544">:</span>&nbsp;<span class="ident" id="4532546">recordHeaderLen</span><span class="op" id="4532561">+</span><span class="ident" id="4532562">explicitIVLen</span><span class="op" id="4532575">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532580">payload</span>&nbsp;<span class="op" id="4532588">:=</span>&nbsp;<span class="ident" id="4532591">b</span><span class="op" id="4532592">.</span><span class="ident" id="4532593">data</span><span class="op" id="4532597">[</span><span class="ident" id="4532598">recordHeaderLen</span><span class="op" id="4532613">+</span><span class="ident" id="4532614">explicitIVLen</span><span class="op" id="4532627">:</span><span class="op" id="4532628">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532633">payload</span>&nbsp;<span class="op" id="4532641">=</span>&nbsp;<span class="ident" id="4532643">payload</span><span class="op" id="4532650">[</span><span class="op" id="4532651">:</span><span class="ident" id="4532652">payloadLen</span><span class="op" id="4532662">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532668">var</span>&nbsp;<span class="ident" id="4532672">additionalData</span>&nbsp;<span class="op" id="4532687">[</span><span class="num" id="4532688">13</span><span class="op" id="4532690">]</span><span class="builtintype" id="4532691">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4532699">copy</span><span class="op" id="4532703">(</span><span class="ident" id="4532704">additionalData</span><span class="op" id="4532718">[</span><span class="op" id="4532719">:</span><span class="op" id="4532720">]</span><span class="op" id="4532721">,</span>&nbsp;<span class="ident" id="4532723">hc</span><span class="op" id="4532725">.</span><span class="ident" id="4532726">seq</span><span class="op" id="4532729">[</span><span class="op" id="4532730">:</span><span class="op" id="4532731">]</span><span class="op" id="4532732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4532737">copy</span><span class="op" id="4532741">(</span><span class="ident" id="4532742">additionalData</span><span class="op" id="4532756">[</span><span class="num" id="4532757">8</span><span class="op" id="4532758">:</span><span class="op" id="4532759">]</span><span class="op" id="4532760">,</span>&nbsp;<span class="ident" id="4532762">b</span><span class="op" id="4532763">.</span><span class="ident" id="4532764">data</span><span class="op" id="4532768">[</span><span class="op" id="4532769">:</span><span class="num" id="4532770">3</span><span class="op" id="4532771">]</span><span class="op" id="4532772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532777">additionalData</span><span class="op" id="4532791">[</span><span class="num" id="4532792">11</span><span class="op" id="4532794">]</span>&nbsp;<span class="op" id="4532796">=</span>&nbsp;<span class="builtintype" id="4532798">byte</span><span class="op" id="4532802">(</span><span class="ident" id="4532803">payloadLen</span>&nbsp;<span class="op" id="4532814">&gt;&gt;</span>&nbsp;<span class="num" id="4532817">8</span><span class="op" id="4532818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532823">additionalData</span><span class="op" id="4532837">[</span><span class="num" id="4532838">12</span><span class="op" id="4532840">]</span>&nbsp;<span class="op" id="4532842">=</span>&nbsp;<span class="builtintype" id="4532844">byte</span><span class="op" id="4532848">(</span><span class="ident" id="4532849">payloadLen</span><span class="op" id="4532859">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532865">c</span><span class="op" id="4532866">.</span><span class="ident" id="4532867">Seal</span><span class="op" id="4532871">(</span><span class="ident" id="4532872">payload</span><span class="op" id="4532879">[</span><span class="op" id="4532880">:</span><span class="num" id="4532881">0</span><span class="op" id="4532882">]</span><span class="op" id="4532883">,</span>&nbsp;<span class="ident" id="4532885">nonce</span><span class="op" id="4532890">,</span>&nbsp;<span class="ident" id="4532892">payload</span><span class="op" id="4532899">,</span>&nbsp;<span class="ident" id="4532901">additionalData</span><span class="op" id="4532915">[</span><span class="op" id="4532916">:</span><span class="op" id="4532917">]</span><span class="op" id="4532918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532922">case</span>&nbsp;<span class="ident" id="4532927">cbcMode</span><span class="op" id="4532934">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532939">blockSize</span>&nbsp;<span class="op" id="4532949">:=</span>&nbsp;<span class="ident" id="4532952">c</span><span class="op" id="4532953">.</span><span class="ident" id="4532954">BlockSize</span><span class="op" id="4532963">(</span><span class="op" id="4532964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532969">if</span>&nbsp;<span class="ident" id="4532972">explicitIVLen</span>&nbsp;<span class="op" id="4532986">&gt;</span>&nbsp;<span class="num" id="4532988">0</span>&nbsp;<span class="op" id="4532990">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532996">c</span><span class="op" id="4532997">.</span><span class="ident" id="4532998">SetIV</span><span class="op" id="4533003">(</span><span class="ident" id="4533004">payload</span><span class="op" id="4533011">[</span><span class="op" id="4533012">:</span><span class="ident" id="4533013">explicitIVLen</span><span class="op" id="4533026">]</span><span class="op" id="4533027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533033">payload</span>&nbsp;<span class="op" id="4533041">=</span>&nbsp;<span class="ident" id="4533043">payload</span><span class="op" id="4533050">[</span><span class="ident" id="4533051">explicitIVLen</span><span class="op" id="4533064">:</span><span class="op" id="4533065">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4533070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533075">prefix</span><span class="op" id="4533081">,</span>&nbsp;<span class="ident" id="4533083">finalBlock</span>&nbsp;<span class="op" id="4533094">:=</span>&nbsp;<span class="ident" id="4533097">padToBlockSize</span><span class="op" id="4533111">(</span><span class="ident" id="4533112">payload</span><span class="op" id="4533119">,</span>&nbsp;<span class="ident" id="4533121">blockSize</span><span class="op" id="4533130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533135">b</span><span class="op" id="4533136">.</span><span class="ident" id="4533137">resize</span><span class="op" id="4533143">(</span><span class="ident" id="4533144">recordHeaderLen</span>&nbsp;<span class="op" id="4533160">+</span>&nbsp;<span class="ident" id="4533162">explicitIVLen</span>&nbsp;<span class="op" id="4533176">+</span>&nbsp;<span class="builtinfunc" id="4533178">len</span><span class="op" id="4533181">(</span><span class="ident" id="4533182">prefix</span><span class="op" id="4533188">)</span>&nbsp;<span class="op" id="4533190">+</span>&nbsp;<span class="builtinfunc" id="4533192">len</span><span class="op" id="4533195">(</span><span class="ident" id="4533196">finalBlock</span><span class="op" id="4533206">)</span><span class="op" id="4533207">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533212">c</span><span class="op" id="4533213">.</span><span class="ident" id="4533214">CryptBlocks</span><span class="op" id="4533225">(</span><span class="ident" id="4533226">b</span><span class="op" id="4533227">.</span><span class="ident" id="4533228">data</span><span class="op" id="4533232">[</span><span class="ident" id="4533233">recordHeaderLen</span><span class="op" id="4533248">+</span><span class="ident" id="4533249">explicitIVLen</span><span class="op" id="4533262">:</span><span class="op" id="4533263">]</span><span class="op" id="4533264">,</span>&nbsp;<span class="ident" id="4533266">prefix</span><span class="op" id="4533272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533277">c</span><span class="op" id="4533278">.</span><span class="ident" id="4533279">CryptBlocks</span><span class="op" id="4533290">(</span><span class="ident" id="4533291">b</span><span class="op" id="4533292">.</span><span class="ident" id="4533293">data</span><span class="op" id="4533297">[</span><span class="ident" id="4533298">recordHeaderLen</span><span class="op" id="4533313">+</span><span class="ident" id="4533314">explicitIVLen</span><span class="op" id="4533327">+</span><span class="builtinfunc" id="4533328">len</span><span class="op" id="4533331">(</span><span class="ident" id="4533332">prefix</span><span class="op" id="4533338">)</span><span class="op" id="4533339">:</span><span class="op" id="4533340">]</span><span class="op" id="4533341">,</span>&nbsp;<span class="ident" id="4533343">finalBlock</span><span class="op" id="4533353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533357">default</span><span class="op" id="4533364">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4533369">panic</span><span class="op" id="4533374">(</span><span class="string" id="4533375">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="4533396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4533400">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4533403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4533407">//&nbsp;update&nbsp;length&nbsp;to&nbsp;include&nbsp;MAC&nbsp;and&nbsp;any&nbsp;block&nbsp;padding&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533470">n</span>&nbsp;<span class="op" id="4533472">:=</span>&nbsp;<span class="builtinfunc" id="4533475">len</span><span class="op" id="4533478">(</span><span class="ident" id="4533479">b</span><span class="op" id="4533480">.</span><span class="ident" id="4533481">data</span><span class="op" id="4533485">)</span>&nbsp;<span class="op" id="4533487">-</span>&nbsp;<span class="ident" id="4533489">recordHeaderLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533506">b</span><span class="op" id="4533507">.</span><span class="ident" id="4533508">data</span><span class="op" id="4533512">[</span><span class="num" id="4533513">3</span><span class="op" id="4533514">]</span>&nbsp;<span class="op" id="4533516">=</span>&nbsp;<span class="builtintype" id="4533518">byte</span><span class="op" id="4533522">(</span><span class="ident" id="4533523">n</span>&nbsp;<span class="op" id="4533525">&gt;&gt;</span>&nbsp;<span class="num" id="4533528">8</span><span class="op" id="4533529">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533532">b</span><span class="op" id="4533533">.</span><span class="ident" id="4533534">data</span><span class="op" id="4533538">[</span><span class="num" id="4533539">4</span><span class="op" id="4533540">]</span>&nbsp;<span class="op" id="4533542">=</span>&nbsp;<span class="builtintype" id="4533544">byte</span><span class="op" id="4533548">(</span><span class="ident" id="4533549">n</span><span class="op" id="4533550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533553">hc</span><span class="op" id="4533555">.</span><span class="ident" id="4533556">incSeq</span><span class="op" id="4533562">(</span><span class="op" id="4533563">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533567">return</span>&nbsp;<span class="builtintype" id="4533574">true</span><span class="op" id="4533578">,</span>&nbsp;<span class="num" id="4533580">0</span><br>
<span class="lineno"></span><span class="op" id="4533582">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="4533585">//&nbsp;A&nbsp;block&nbsp;is&nbsp;a&nbsp;simple&nbsp;data&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4533621">type</span>&nbsp;<span class="ident" id="4533626">block</span>&nbsp;<span class="keyword" id="4533632">struct</span>&nbsp;<span class="op" id="4533639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533642">data</span>&nbsp;<span class="op" id="4533647">[</span><span class="op" id="4533648">]</span><span class="builtintype" id="4533649">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533655">off</span>&nbsp;&nbsp;<span class="builtintype" id="4533660">int</span>&nbsp;<span class="comment" id="4533664">//&nbsp;index&nbsp;for&nbsp;Read</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533683">link</span>&nbsp;<span class="op" id="4533688">*</span><span class="ident" id="4533689">block</span><br>
<span class="lineno"></span><span class="op" id="4533695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4533698">//&nbsp;resize&nbsp;resizes&nbsp;block&nbsp;to&nbsp;be&nbsp;n&nbsp;bytes,&nbsp;growing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="4533759">func</span>&nbsp;<span class="op" id="4533764">(</span><span class="ident" id="4533765">b</span>&nbsp;<span class="op" id="4533767">*</span><span class="ident" id="4533768">block</span><span class="op" id="4533773">)</span>&nbsp;<span class="ident" id="4533775">resize</span><span class="op" id="4533781">(</span><span class="ident" id="4533782">n</span>&nbsp;<span class="builtintype" id="4533784">int</span><span class="op" id="4533787">)</span>&nbsp;<span class="op" id="4533789">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533792">if</span>&nbsp;<span class="ident" id="4533795">n</span>&nbsp;<span class="op" id="4533797">&gt;</span>&nbsp;<span class="builtinfunc" id="4533799">cap</span><span class="op" id="4533802">(</span><span class="ident" id="4533803">b</span><span class="op" id="4533804">.</span><span class="ident" id="4533805">data</span><span class="op" id="4533809">)</span>&nbsp;<span class="op" id="4533811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533815">b</span><span class="op" id="4533816">.</span><span class="ident" id="4533817">reserve</span><span class="op" id="4533824">(</span><span class="ident" id="4533825">n</span><span class="op" id="4533826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4533829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533832">b</span><span class="op" id="4533833">.</span><span class="ident" id="4533834">data</span>&nbsp;<span class="op" id="4533839">=</span>&nbsp;<span class="ident" id="4533841">b</span><span class="op" id="4533842">.</span><span class="ident" id="4533843">data</span><span class="op" id="4533847">[</span><span class="num" id="4533848">0</span><span class="op" id="4533849">:</span><span class="ident" id="4533850">n</span><span class="op" id="4533851">]</span><br>
<span class="lineno"></span><span class="op" id="4533853">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="4533856">//&nbsp;reserve&nbsp;makes&nbsp;sure&nbsp;that&nbsp;block&nbsp;contains&nbsp;a&nbsp;capacity&nbsp;of&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4533930">func</span>&nbsp;<span class="op" id="4533935">(</span><span class="ident" id="4533936">b</span>&nbsp;<span class="op" id="4533938">*</span><span class="ident" id="4533939">block</span><span class="op" id="4533944">)</span>&nbsp;<span class="ident" id="4533946">reserve</span><span class="op" id="4533953">(</span><span class="ident" id="4533954">n</span>&nbsp;<span class="builtintype" id="4533956">int</span><span class="op" id="4533959">)</span>&nbsp;<span class="op" id="4533961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533964">if</span>&nbsp;<span class="builtinfunc" id="4533967">cap</span><span class="op" id="4533970">(</span><span class="ident" id="4533971">b</span><span class="op" id="4533972">.</span><span class="ident" id="4533973">data</span><span class="op" id="4533977">)</span>&nbsp;<span class="op" id="4533979">&gt;=</span>&nbsp;<span class="ident" id="4533982">n</span>&nbsp;<span class="op" id="4533984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533988">return</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4533996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533999">m</span>&nbsp;<span class="op" id="4534001">:=</span>&nbsp;<span class="builtinfunc" id="4534004">cap</span><span class="op" id="4534007">(</span><span class="ident" id="4534008">b</span><span class="op" id="4534009">.</span><span class="ident" id="4534010">data</span><span class="op" id="4534014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534017">if</span>&nbsp;<span class="ident" id="4534020">m</span>&nbsp;<span class="op" id="4534022">==</span>&nbsp;<span class="num" id="4534025">0</span>&nbsp;<span class="op" id="4534027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534031">m</span>&nbsp;<span class="op" id="4534033">=</span>&nbsp;<span class="num" id="4534035">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4534041">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534044">for</span>&nbsp;<span class="ident" id="4534048">m</span>&nbsp;<span class="op" id="4534050">&lt;</span>&nbsp;<span class="ident" id="4534052">n</span>&nbsp;<span class="op" id="4534054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534058">m</span>&nbsp;<span class="op" id="4534060">*=</span>&nbsp;<span class="num" id="4534063">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4534066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534069">data</span>&nbsp;<span class="op" id="4534074">:=</span>&nbsp;<span class="builtinfunc" id="4534077">make</span><span class="op" id="4534081">(</span><span class="op" id="4534082">[</span><span class="op" id="4534083">]</span><span class="builtintype" id="4534084">byte</span><span class="op" id="4534088">,</span>&nbsp;<span class="builtinfunc" id="4534090">len</span><span class="op" id="4534093">(</span><span class="ident" id="4534094">b</span><span class="op" id="4534095">.</span><span class="ident" id="4534096">data</span><span class="op" id="4534100">)</span><span class="op" id="4534101">,</span>&nbsp;<span class="ident" id="4534103">m</span><span class="op" id="4534104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4534107">copy</span><span class="op" id="4534111">(</span><span class="ident" id="4534112">data</span><span class="op" id="4534116">,</span>&nbsp;<span class="ident" id="4534118">b</span><span class="op" id="4534119">.</span><span class="ident" id="4534120">data</span><span class="op" id="4534124">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534127">b</span><span class="op" id="4534128">.</span><span class="ident" id="4534129">data</span>&nbsp;<span class="op" id="4534134">=</span>&nbsp;<span class="ident" id="4534136">data</span><br>
<span class="lineno"></span><span class="op" id="4534141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4534144">//&nbsp;readFromUntil&nbsp;reads&nbsp;from&nbsp;r&nbsp;into&nbsp;b&nbsp;until&nbsp;b&nbsp;contains&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes</span><br>
<span class="lineno"></span><span class="comment" id="4534215">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">445</span><span class="keyword" id="4534244">func</span>&nbsp;<span class="op" id="4534249">(</span><span class="ident" id="4534250">b</span>&nbsp;<span class="op" id="4534252">*</span><span class="ident" id="4534253">block</span><span class="op" id="4534258">)</span>&nbsp;<span class="ident" id="4534260">readFromUntil</span><span class="op" id="4534273">(</span><span class="ident" id="4534274">r</span>&nbsp;<span class="ident" id="4534276">io</span><span class="op" id="4534278">.</span><span class="ident" id="4534279">Reader</span><span class="op" id="4534285">,</span>&nbsp;<span class="ident" id="4534287">n</span>&nbsp;<span class="builtintype" id="4534289">int</span><span class="op" id="4534292">)</span>&nbsp;<span class="builtintype" id="4534294">error</span>&nbsp;<span class="op" id="4534300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4534303">//&nbsp;quick&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534318">if</span>&nbsp;<span class="builtinfunc" id="4534321">len</span><span class="op" id="4534324">(</span><span class="ident" id="4534325">b</span><span class="op" id="4534326">.</span><span class="ident" id="4534327">data</span><span class="op" id="4534331">)</span>&nbsp;<span class="op" id="4534333">&gt;=</span>&nbsp;<span class="ident" id="4534336">n</span>&nbsp;<span class="op" id="4534338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534342">return</span>&nbsp;<span class="ident" id="4534349">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4534354">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4534358">//&nbsp;read&nbsp;until&nbsp;have&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534386">b</span><span class="op" id="4534387">.</span><span class="ident" id="4534388">reserve</span><span class="op" id="4534395">(</span><span class="ident" id="4534396">n</span><span class="op" id="4534397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534400">for</span>&nbsp;<span class="op" id="4534404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534408">m</span><span class="op" id="4534409">,</span>&nbsp;<span class="ident" id="4534411">err</span>&nbsp;<span class="op" id="4534415">:=</span>&nbsp;<span class="ident" id="4534418">r</span><span class="op" id="4534419">.</span><span class="ident" id="4534420">Read</span><span class="op" id="4534424">(</span><span class="ident" id="4534425">b</span><span class="op" id="4534426">.</span><span class="ident" id="4534427">data</span><span class="op" id="4534431">[</span><span class="builtinfunc" id="4534432">len</span><span class="op" id="4534435">(</span><span class="ident" id="4534436">b</span><span class="op" id="4534437">.</span><span class="ident" id="4534438">data</span><span class="op" id="4534442">)</span><span class="op" id="4534443">:</span><span class="builtinfunc" id="4534444">cap</span><span class="op" id="4534447">(</span><span class="ident" id="4534448">b</span><span class="op" id="4534449">.</span><span class="ident" id="4534450">data</span><span class="op" id="4534454">)</span><span class="op" id="4534455">]</span><span class="op" id="4534456">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534460">b</span><span class="op" id="4534461">.</span><span class="ident" id="4534462">data</span>&nbsp;<span class="op" id="4534467">=</span>&nbsp;<span class="ident" id="4534469">b</span><span class="op" id="4534470">.</span><span class="ident" id="4534471">data</span><span class="op" id="4534475">[</span><span class="num" id="4534476">0</span>&nbsp;<span class="op" id="4534478">:</span>&nbsp;<span class="builtinfunc" id="4534480">len</span><span class="op" id="4534483">(</span><span class="ident" id="4534484">b</span><span class="op" id="4534485">.</span><span class="ident" id="4534486">data</span><span class="op" id="4534490">)</span><span class="op" id="4534491">+</span><span class="ident" id="4534492">m</span><span class="op" id="4534493">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534497">if</span>&nbsp;<span class="builtinfunc" id="4534500">len</span><span class="op" id="4534503">(</span><span class="ident" id="4534504">b</span><span class="op" id="4534505">.</span><span class="ident" id="4534506">data</span><span class="op" id="4534510">)</span>&nbsp;<span class="op" id="4534512">&gt;=</span>&nbsp;<span class="ident" id="4534515">n</span>&nbsp;<span class="op" id="4534517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4534522">//&nbsp;TODO(bradfitz,agl):&nbsp;slightly&nbsp;suspicious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4534568">//&nbsp;that&nbsp;we&#39;re&nbsp;throwing&nbsp;away&nbsp;r.Read&#39;s&nbsp;err&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534618">break</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4534626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534630">if</span>&nbsp;<span class="ident" id="4534633">err</span>&nbsp;<span class="op" id="4534637">!=</span>&nbsp;<span class="ident" id="4534640">nil</span>&nbsp;<span class="op" id="4534644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534649">return</span>&nbsp;<span class="ident" id="4534656">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4534662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4534665">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534668">return</span>&nbsp;<span class="ident" id="4534675">nil</span><br>
<span class="lineno"></span><span class="op" id="4534679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4534682">func</span>&nbsp;<span class="op" id="4534687">(</span><span class="ident" id="4534688">b</span>&nbsp;<span class="op" id="4534690">*</span><span class="ident" id="4534691">block</span><span class="op" id="4534696">)</span>&nbsp;<span class="ident" id="4534698">Read</span><span class="op" id="4534702">(</span><span class="ident" id="4534703">p</span>&nbsp;<span class="op" id="4534705">[</span><span class="op" id="4534706">]</span><span class="builtintype" id="4534707">byte</span><span class="op" id="4534711">)</span>&nbsp;<span class="op" id="4534713">(</span><span class="ident" id="4534714">n</span>&nbsp;<span class="builtintype" id="4534716">int</span><span class="op" id="4534719">,</span>&nbsp;<span class="ident" id="4534721">err</span>&nbsp;<span class="builtintype" id="4534725">error</span><span class="op" id="4534730">)</span>&nbsp;<span class="op" id="4534732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534735">n</span>&nbsp;<span class="op" id="4534737">=</span>&nbsp;<span class="builtinfunc" id="4534739">copy</span><span class="op" id="4534743">(</span><span class="ident" id="4534744">p</span><span class="op" id="4534745">,</span>&nbsp;<span class="ident" id="4534747">b</span><span class="op" id="4534748">.</span><span class="ident" id="4534749">data</span><span class="op" id="4534753">[</span><span class="ident" id="4534754">b</span><span class="op" id="4534755">.</span><span class="ident" id="4534756">off</span><span class="op" id="4534759">:</span><span class="op" id="4534760">]</span><span class="op" id="4534761">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534764">b</span><span class="op" id="4534765">.</span><span class="ident" id="4534766">off</span>&nbsp;<span class="op" id="4534770">+=</span>&nbsp;<span class="ident" id="4534773">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534776">return</span><br>
<span class="lineno"></span><span class="op" id="4534783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4534786">//&nbsp;newBlock&nbsp;allocates&nbsp;a&nbsp;new&nbsp;block,&nbsp;from&nbsp;hc&#39;s&nbsp;free&nbsp;list&nbsp;if&nbsp;possible.</span><br>
<span class="lineno">475</span><span class="keyword" id="4534854">func</span>&nbsp;<span class="op" id="4534859">(</span><span class="ident" id="4534860">hc</span>&nbsp;<span class="op" id="4534863">*</span><span class="ident" id="4534864">halfConn</span><span class="op" id="4534872">)</span>&nbsp;<span class="ident" id="4534874">newBlock</span><span class="op" id="4534882">(</span><span class="op" id="4534883">)</span>&nbsp;<span class="op" id="4534885">*</span><span class="ident" id="4534886">block</span>&nbsp;<span class="op" id="4534892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534895">b</span>&nbsp;<span class="op" id="4534897">:=</span>&nbsp;<span class="ident" id="4534900">hc</span><span class="op" id="4534902">.</span><span class="ident" id="4534903">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534910">if</span>&nbsp;<span class="ident" id="4534913">b</span>&nbsp;<span class="op" id="4534915">==</span>&nbsp;<span class="ident" id="4534918">nil</span>&nbsp;<span class="op" id="4534922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534926">return</span>&nbsp;<span class="builtinfunc" id="4534933">new</span><span class="op" id="4534936">(</span><span class="ident" id="4534937">block</span><span class="op" id="4534942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4534945">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534948">hc</span><span class="op" id="4534950">.</span><span class="ident" id="4534951">bfree</span>&nbsp;<span class="op" id="4534957">=</span>&nbsp;<span class="ident" id="4534959">b</span><span class="op" id="4534960">.</span><span class="ident" id="4534961">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534967">b</span><span class="op" id="4534968">.</span><span class="ident" id="4534969">link</span>&nbsp;<span class="op" id="4534974">=</span>&nbsp;<span class="ident" id="4534976">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534981">b</span><span class="op" id="4534982">.</span><span class="ident" id="4534983">resize</span><span class="op" id="4534989">(</span><span class="num" id="4534990">0</span><span class="op" id="4534991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534994">return</span>&nbsp;<span class="ident" id="4535001">b</span><br>
<span class="lineno"></span><span class="op" id="4535003">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="4535006">//&nbsp;freeBlock&nbsp;returns&nbsp;a&nbsp;block&nbsp;to&nbsp;hc&#39;s&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="4535054">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;such&nbsp;that&nbsp;each&nbsp;side&nbsp;only&nbsp;has&nbsp;a&nbsp;block&nbsp;or&nbsp;two&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="4535120">//&nbsp;its&nbsp;free&nbsp;list&nbsp;at&nbsp;a&nbsp;time,&nbsp;so&nbsp;there&#39;s&nbsp;no&nbsp;need&nbsp;to&nbsp;worry&nbsp;about</span><br>
<span class="lineno"></span><span class="comment" id="4535182">//&nbsp;trimming&nbsp;the&nbsp;list,&nbsp;etc.</span><br>
<span class="lineno">490</span><span class="keyword" id="4535209">func</span>&nbsp;<span class="op" id="4535214">(</span><span class="ident" id="4535215">hc</span>&nbsp;<span class="op" id="4535218">*</span><span class="ident" id="4535219">halfConn</span><span class="op" id="4535227">)</span>&nbsp;<span class="ident" id="4535229">freeBlock</span><span class="op" id="4535238">(</span><span class="ident" id="4535239">b</span>&nbsp;<span class="op" id="4535241">*</span><span class="ident" id="4535242">block</span><span class="op" id="4535247">)</span>&nbsp;<span class="op" id="4535249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4535252">b</span><span class="op" id="4535253">.</span><span class="ident" id="4535254">link</span>&nbsp;<span class="op" id="4535259">=</span>&nbsp;<span class="ident" id="4535261">hc</span><span class="op" id="4535263">.</span><span class="ident" id="4535264">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4535271">hc</span><span class="op" id="4535273">.</span><span class="ident" id="4535274">bfree</span>&nbsp;<span class="op" id="4535280">=</span>&nbsp;<span class="ident" id="4535282">b</span><br>
<span class="lineno"></span><span class="op" id="4535284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="4535287">//&nbsp;splitBlock&nbsp;splits&nbsp;a&nbsp;block&nbsp;after&nbsp;the&nbsp;first&nbsp;n&nbsp;bytes,</span><br>
<span class="lineno"></span><span class="comment" id="4535341">//&nbsp;returning&nbsp;a&nbsp;block&nbsp;with&nbsp;those&nbsp;n&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4535387">//&nbsp;block&nbsp;with&nbsp;the&nbsp;remainder.&nbsp;&nbsp;the&nbsp;latter&nbsp;may&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="4535440">func</span>&nbsp;<span class="op" id="4535445">(</span><span class="ident" id="4535446">hc</span>&nbsp;<span class="op" id="4535449">*</span><span class="ident" id="4535450">halfConn</span><span class="op" id="4535458">)</span>&nbsp;<span class="ident" id="4535460">splitBlock</span><span class="op" id="4535470">(</span><span class="ident" id="4535471">b</span>&nbsp;<span class="op" id="4535473">*</span><span class="ident" id="4535474">block</span><span class="op" id="4535479">,</span>&nbsp;<span class="ident" id="4535481">n</span>&nbsp;<span class="builtintype" id="4535483">int</span><span class="op" id="4535486">)</span>&nbsp;<span class="op" id="4535488">(</span><span class="op" id="4535489">*</span><span class="ident" id="4535490">block</span><span class="op" id="4535495">,</span>&nbsp;<span class="op" id="4535497">*</span><span class="ident" id="4535498">block</span><span class="op" id="4535503">)</span>&nbsp;<span class="op" id="4535505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535508">if</span>&nbsp;<span class="builtinfunc" id="4535511">len</span><span class="op" id="4535514">(</span><span class="ident" id="4535515">b</span><span class="op" id="4535516">.</span><span class="ident" id="4535517">data</span><span class="op" id="4535521">)</span>&nbsp;<span class="op" id="4535523">&lt;=</span>&nbsp;<span class="ident" id="4535526">n</span>&nbsp;<span class="op" id="4535528">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535532">return</span>&nbsp;<span class="ident" id="4535539">b</span><span class="op" id="4535540">,</span>&nbsp;<span class="ident" id="4535542">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4535547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4535550">bb</span>&nbsp;<span class="op" id="4535553">:=</span>&nbsp;<span class="ident" id="4535556">hc</span><span class="op" id="4535558">.</span><span class="ident" id="4535559">newBlock</span><span class="op" id="4535567">(</span><span class="op" id="4535568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4535571">bb</span><span class="op" id="4535573">.</span><span class="ident" id="4535574">resize</span><span class="op" id="4535580">(</span><span class="builtinfunc" id="4535581">len</span><span class="op" id="4535584">(</span><span class="ident" id="4535585">b</span><span class="op" id="4535586">.</span><span class="ident" id="4535587">data</span><span class="op" id="4535591">)</span>&nbsp;<span class="op" id="4535593">-</span>&nbsp;<span class="ident" id="4535595">n</span><span class="op" id="4535596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4535599">copy</span><span class="op" id="4535603">(</span><span class="ident" id="4535604">bb</span><span class="op" id="4535606">.</span><span class="ident" id="4535607">data</span><span class="op" id="4535611">,</span>&nbsp;<span class="ident" id="4535613">b</span><span class="op" id="4535614">.</span><span class="ident" id="4535615">data</span><span class="op" id="4535619">[</span><span class="ident" id="4535620">n</span><span class="op" id="4535621">:</span><span class="op" id="4535622">]</span><span class="op" id="4535623">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4535626">b</span><span class="op" id="4535627">.</span><span class="ident" id="4535628">data</span>&nbsp;<span class="op" id="4535633">=</span>&nbsp;<span class="ident" id="4535635">b</span><span class="op" id="4535636">.</span><span class="ident" id="4535637">data</span><span class="op" id="4535641">[</span><span class="num" id="4535642">0</span><span class="op" id="4535643">:</span><span class="ident" id="4535644">n</span><span class="op" id="4535645">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535648">return</span>&nbsp;<span class="ident" id="4535655">b</span><span class="op" id="4535656">,</span>&nbsp;<span class="ident" id="4535658">bb</span><br>
<span class="lineno"></span><span class="op" id="4535661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4535664">//&nbsp;readRecord&nbsp;reads&nbsp;the&nbsp;next&nbsp;TLS&nbsp;record&nbsp;from&nbsp;the&nbsp;connection</span><br>
<span class="lineno">510</span><span class="comment" id="4535724">//&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="4535763">//&nbsp;c.in.Mutex&nbsp;&lt;=&nbsp;L;&nbsp;c.input&nbsp;==&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="4535799">func</span>&nbsp;<span class="op" id="4535804">(</span><span class="ident" id="4535805">c</span>&nbsp;<span class="op" id="4535807">*</span><span class="ident" id="4535808">Conn</span><span class="op" id="4535812">)</span>&nbsp;<span class="ident" id="4535814">readRecord</span><span class="op" id="4535824">(</span><span class="ident" id="4535825">want</span>&nbsp;<span class="ident" id="4535830">recordType</span><span class="op" id="4535840">)</span>&nbsp;<span class="builtintype" id="4535842">error</span>&nbsp;<span class="op" id="4535848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4535851">//&nbsp;Caller&nbsp;must&nbsp;be&nbsp;in&nbsp;sync&nbsp;with&nbsp;connection:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4535895">//&nbsp;handshake&nbsp;data&nbsp;if&nbsp;handshake&nbsp;not&nbsp;yet&nbsp;completed,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4535946">//&nbsp;else&nbsp;application&nbsp;data.&nbsp;&nbsp;(We&nbsp;don&#39;t&nbsp;support&nbsp;renegotiation.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536008">switch</span>&nbsp;<span class="ident" id="4536015">want</span>&nbsp;<span class="op" id="4536020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536023">default</span><span class="op" id="4536030">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4536034">c</span><span class="op" id="4536035">.</span><span class="ident" id="4536036">sendAlert</span><span class="op" id="4536045">(</span><span class="ident" id="4536046">alertInternalError</span><span class="op" id="4536064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536068">return</span>&nbsp;<span class="ident" id="4536075">c</span><span class="op" id="4536076">.</span><span class="ident" id="4536077">in</span><span class="op" id="4536079">.</span><span class="ident" id="4536080">setErrorLocked</span><span class="op" id="4536094">(</span><span class="ident" id="4536095">errors</span><span class="op" id="4536101">.</span><span class="ident" id="4536102">New</span><span class="op" id="4536105">(</span><span class="string" id="4536106">&#34;tls:&nbsp;unknown&nbsp;record&nbsp;type&nbsp;requested&#34;</span><span class="op" id="4536142">)</span><span class="op" id="4536143">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536146">case</span>&nbsp;<span class="ident" id="4536151">recordTypeHandshake</span><span class="op" id="4536170">,</span>&nbsp;<span class="ident" id="4536172">recordTypeChangeCipherSpec</span><span class="op" id="4536198">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536202">if</span>&nbsp;<span class="ident" id="4536205">c</span><span class="op" id="4536206">.</span><span class="ident" id="4536207">handshakeComplete</span>&nbsp;<span class="op" id="4536225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4536230">c</span><span class="op" id="4536231">.</span><span class="ident" id="4536232">sendAlert</span><span class="op" id="4536241">(</span><span class="ident" id="4536242">alertInternalError</span><span class="op" id="4536260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536265">return</span>&nbsp;<span class="ident" id="4536272">c</span><span class="op" id="4536273">.</span><span class="ident" id="4536274">in</span><span class="op" id="4536276">.</span><span class="ident" id="4536277">setErrorLocked</span><span class="op" id="4536291">(</span><span class="ident" id="4536292">errors</span><span class="op" id="4536298">.</span><span class="ident" id="4536299">New</span><span class="op" id="4536302">(</span><span class="string" id="4536303">&#34;tls:&nbsp;handshake&nbsp;or&nbsp;ChangeCipherSpec&nbsp;requested&nbsp;after&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="4536374">)</span><span class="op" id="4536375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4536379">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536382">case</span>&nbsp;<span class="ident" id="4536387">recordTypeApplicationData</span><span class="op" id="4536412">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536416">if</span>&nbsp;<span class="op" id="4536419">!</span><span class="ident" id="4536420">c</span><span class="op" id="4536421">.</span><span class="ident" id="4536422">handshakeComplete</span>&nbsp;<span class="op" id="4536440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4536445">c</span><span class="op" id="4536446">.</span><span class="ident" id="4536447">sendAlert</span><span class="op" id="4536456">(</span><span class="ident" id="4536457">alertInternalError</span><span class="op" id="4536475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536480">return</span>&nbsp;<span class="ident" id="4536487">c</span><span class="op" id="4536488">.</span><span class="ident" id="4536489">in</span><span class="op" id="4536491">.</span><span class="ident" id="4536492">setErrorLocked</span><span class="op" id="4536506">(</span><span class="ident" id="4536507">errors</span><span class="op" id="4536513">.</span><span class="ident" id="4536514">New</span><span class="op" id="4536517">(</span><span class="string" id="4536518">&#34;tls:&nbsp;application&nbsp;data&nbsp;record&nbsp;requested&nbsp;before&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="4536584">)</span><span class="op" id="4536585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4536589">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4536592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4536595">Again</span><span class="op" id="4536600">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536603">if</span>&nbsp;<span class="ident" id="4536606">c</span><span class="op" id="4536607">.</span><span class="ident" id="4536608">rawInput</span>&nbsp;<span class="op" id="4536617">==</span>&nbsp;<span class="ident" id="4536620">nil</span>&nbsp;<span class="op" id="4536624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4536628">c</span><span class="op" id="4536629">.</span><span class="ident" id="4536630">rawInput</span>&nbsp;<span class="op" id="4536639">=</span>&nbsp;<span class="ident" id="4536641">c</span><span class="op" id="4536642">.</span><span class="ident" id="4536643">in</span><span class="op" id="4536645">.</span><span class="ident" id="4536646">newBlock</span><span class="op" id="4536654">(</span><span class="op" id="4536655">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4536658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4536661">b</span>&nbsp;<span class="op" id="4536663">:=</span>&nbsp;<span class="ident" id="4536666">c</span><span class="op" id="4536667">.</span><span class="ident" id="4536668">rawInput</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4536679">//&nbsp;Read&nbsp;header,&nbsp;payload.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536705">if</span>&nbsp;<span class="ident" id="4536708">err</span>&nbsp;<span class="op" id="4536712">:=</span>&nbsp;<span class="ident" id="4536715">b</span><span class="op" id="4536716">.</span><span class="ident" id="4536717">readFromUntil</span><span class="op" id="4536730">(</span><span class="ident" id="4536731">c</span><span class="op" id="4536732">.</span><span class="ident" id="4536733">conn</span><span class="op" id="4536737">,</span>&nbsp;<span class="ident" id="4536739">recordHeaderLen</span><span class="op" id="4536754">)</span><span class="op" id="4536755">;</span>&nbsp;<span class="ident" id="4536757">err</span>&nbsp;<span class="op" id="4536761">!=</span>&nbsp;<span class="ident" id="4536764">nil</span>&nbsp;<span class="op" id="4536768">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4536772">//&nbsp;RFC&nbsp;suggests&nbsp;that&nbsp;EOF&nbsp;without&nbsp;an&nbsp;alertCloseNotify&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4536830">//&nbsp;an&nbsp;error,&nbsp;but&nbsp;popular&nbsp;web&nbsp;sites&nbsp;seem&nbsp;to&nbsp;do&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4536884">//&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;make&nbsp;it&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4536919">//&nbsp;if&nbsp;err&nbsp;==&nbsp;io.EOF&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4536943">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;io.ErrUnexpectedEOF</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4536975">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536982">if</span>&nbsp;<span class="ident" id="4536985">e</span><span class="op" id="4536986">,</span>&nbsp;<span class="ident" id="4536988">ok</span>&nbsp;<span class="op" id="4536991">:=</span>&nbsp;<span class="ident" id="4536994">err</span><span class="op" id="4536997">.</span><span class="op" id="4536998">(</span><span class="ident" id="4536999">net</span><span class="op" id="4537002">.</span><span class="ident" id="4537003">Error</span><span class="op" id="4537008">)</span><span class="op" id="4537009">;</span>&nbsp;<span class="op" id="4537011">!</span><span class="ident" id="4537012">ok</span>&nbsp;<span class="op" id="4537015">||</span>&nbsp;<span class="op" id="4537018">!</span><span class="ident" id="4537019">e</span><span class="op" id="4537020">.</span><span class="ident" id="4537021">Temporary</span><span class="op" id="4537030">(</span><span class="op" id="4537031">)</span>&nbsp;<span class="op" id="4537033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4537038">c</span><span class="op" id="4537039">.</span><span class="ident" id="4537040">in</span><span class="op" id="4537042">.</span><span class="ident" id="4537043">setErrorLocked</span><span class="op" id="4537057">(</span><span class="ident" id="4537058">err</span><span class="op" id="4537061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4537065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537069">return</span>&nbsp;<span class="ident" id="4537076">err</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4537081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4537084">typ</span>&nbsp;<span class="op" id="4537088">:=</span>&nbsp;<span class="ident" id="4537091">recordType</span><span class="op" id="4537101">(</span><span class="ident" id="4537102">b</span><span class="op" id="4537103">.</span><span class="ident" id="4537104">data</span><span class="op" id="4537108">[</span><span class="num" id="4537109">0</span><span class="op" id="4537110">]</span><span class="op" id="4537111">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4537115">//&nbsp;No&nbsp;valid&nbsp;TLS&nbsp;record&nbsp;has&nbsp;a&nbsp;type&nbsp;of&nbsp;0x80,&nbsp;however&nbsp;SSLv2&nbsp;handshakes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4537184">//&nbsp;start&nbsp;with&nbsp;a&nbsp;uint16&nbsp;length&nbsp;where&nbsp;the&nbsp;MSB&nbsp;is&nbsp;set&nbsp;and&nbsp;the&nbsp;first&nbsp;record</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4537257">//&nbsp;is&nbsp;always&nbsp;&lt;&nbsp;256&nbsp;bytes&nbsp;long.&nbsp;Therefore&nbsp;typ&nbsp;==&nbsp;0x80&nbsp;strongly&nbsp;suggests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4537329">//&nbsp;an&nbsp;SSLv2&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537350">if</span>&nbsp;<span class="ident" id="4537353">want</span>&nbsp;<span class="op" id="4537358">==</span>&nbsp;<span class="ident" id="4537361">recordTypeHandshake</span>&nbsp;<span class="op" id="4537381">&amp;&amp;</span>&nbsp;<span class="ident" id="4537384">typ</span>&nbsp;<span class="op" id="4537388">==</span>&nbsp;<span class="num" id="4537391">0x80</span>&nbsp;<span class="op" id="4537396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4537400">c</span><span class="op" id="4537401">.</span><span class="ident" id="4537402">sendAlert</span><span class="op" id="4537411">(</span><span class="ident" id="4537412">alertProtocolVersion</span><span class="op" id="4537432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537436">return</span>&nbsp;<span class="ident" id="4537443">c</span><span class="op" id="4537444">.</span><span class="ident" id="4537445">in</span><span class="op" id="4537447">.</span><span class="ident" id="4537448">setErrorLocked</span><span class="op" id="4537462">(</span><span class="ident" id="4537463">errors</span><span class="op" id="4537469">.</span><span class="ident" id="4537470">New</span><span class="op" id="4537473">(</span><span class="string" id="4537474">&#34;tls:&nbsp;unsupported&nbsp;SSLv2&nbsp;handshake&nbsp;received&#34;</span><span class="op" id="4537517">)</span><span class="op" id="4537518">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4537521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4537525">vers</span>&nbsp;<span class="op" id="4537530">:=</span>&nbsp;<span class="builtintype" id="4537533">uint16</span><span class="op" id="4537539">(</span><span class="ident" id="4537540">b</span><span class="op" id="4537541">.</span><span class="ident" id="4537542">data</span><span class="op" id="4537546">[</span><span class="num" id="4537547">1</span><span class="op" id="4537548">]</span><span class="op" id="4537549">)</span><span class="op" id="4537550">&lt;&lt;</span><span class="num" id="4537552">8</span>&nbsp;<span class="op" id="4537554">|</span>&nbsp;<span class="builtintype" id="4537556">uint16</span><span class="op" id="4537562">(</span><span class="ident" id="4537563">b</span><span class="op" id="4537564">.</span><span class="ident" id="4537565">data</span><span class="op" id="4537569">[</span><span class="num" id="4537570">2</span><span class="op" id="4537571">]</span><span class="op" id="4537572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4537575">n</span>&nbsp;<span class="op" id="4537577">:=</span>&nbsp;<span class="builtintype" id="4537580">int</span><span class="op" id="4537583">(</span><span class="ident" id="4537584">b</span><span class="op" id="4537585">.</span><span class="ident" id="4537586">data</span><span class="op" id="4537590">[</span><span class="num" id="4537591">3</span><span class="op" id="4537592">]</span><span class="op" id="4537593">)</span><span class="op" id="4537594">&lt;&lt;</span><span class="num" id="4537596">8</span>&nbsp;<span class="op" id="4537598">|</span>&nbsp;<span class="builtintype" id="4537600">int</span><span class="op" id="4537603">(</span><span class="ident" id="4537604">b</span><span class="op" id="4537605">.</span><span class="ident" id="4537606">data</span><span class="op" id="4537610">[</span><span class="num" id="4537611">4</span><span class="op" id="4537612">]</span><span class="op" id="4537613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537616">if</span>&nbsp;<span class="ident" id="4537619">c</span><span class="op" id="4537620">.</span><span class="ident" id="4537621">haveVers</span>&nbsp;<span class="op" id="4537630">&amp;&amp;</span>&nbsp;<span class="ident" id="4537633">vers</span>&nbsp;<span class="op" id="4537638">!=</span>&nbsp;<span class="ident" id="4537641">c</span><span class="op" id="4537642">.</span><span class="ident" id="4537643">vers</span>&nbsp;<span class="op" id="4537648">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4537652">c</span><span class="op" id="4537653">.</span><span class="ident" id="4537654">sendAlert</span><span class="op" id="4537663">(</span><span class="ident" id="4537664">alertProtocolVersion</span><span class="op" id="4537684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537688">return</span>&nbsp;<span class="ident" id="4537695">c</span><span class="op" id="4537696">.</span><span class="ident" id="4537697">in</span><span class="op" id="4537699">.</span><span class="ident" id="4537700">setErrorLocked</span><span class="op" id="4537714">(</span><span class="ident" id="4537715">fmt</span><span class="op" id="4537718">.</span><span class="ident" id="4537719">Errorf</span><span class="op" id="4537725">(</span><span class="string" id="4537726">&#34;tls:&nbsp;received&nbsp;record&nbsp;with&nbsp;version&nbsp;%x&nbsp;when&nbsp;expecting&nbsp;version&nbsp;%x&#34;</span><span class="op" id="4537790">,</span>&nbsp;<span class="ident" id="4537792">vers</span><span class="op" id="4537796">,</span>&nbsp;<span class="ident" id="4537798">c</span><span class="op" id="4537799">.</span><span class="ident" id="4537800">vers</span><span class="op" id="4537804">)</span><span class="op" id="4537805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4537808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537811">if</span>&nbsp;<span class="ident" id="4537814">n</span>&nbsp;<span class="op" id="4537816">&gt;</span>&nbsp;<span class="ident" id="4537818">maxCiphertext</span>&nbsp;<span class="op" id="4537832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4537836">c</span><span class="op" id="4537837">.</span><span class="ident" id="4537838">sendAlert</span><span class="op" id="4537847">(</span><span class="ident" id="4537848">alertRecordOverflow</span><span class="op" id="4537867">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537871">return</span>&nbsp;<span class="ident" id="4537878">c</span><span class="op" id="4537879">.</span><span class="ident" id="4537880">in</span><span class="op" id="4537882">.</span><span class="ident" id="4537883">setErrorLocked</span><span class="op" id="4537897">(</span><span class="ident" id="4537898">fmt</span><span class="op" id="4537901">.</span><span class="ident" id="4537902">Errorf</span><span class="op" id="4537908">(</span><span class="string" id="4537909">&#34;tls:&nbsp;oversized&nbsp;record&nbsp;received&nbsp;with&nbsp;length&nbsp;%d&#34;</span><span class="op" id="4537956">,</span>&nbsp;<span class="ident" id="4537958">n</span><span class="op" id="4537959">)</span><span class="op" id="4537960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4537963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537966">if</span>&nbsp;<span class="op" id="4537969">!</span><span class="ident" id="4537970">c</span><span class="op" id="4537971">.</span><span class="ident" id="4537972">haveVers</span>&nbsp;<span class="op" id="4537981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4537985">//&nbsp;First&nbsp;message,&nbsp;be&nbsp;extra&nbsp;suspicious:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4538026">//&nbsp;this&nbsp;might&nbsp;not&nbsp;be&nbsp;a&nbsp;TLS&nbsp;client.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4538063">//&nbsp;Bail&nbsp;out&nbsp;before&nbsp;reading&nbsp;a&nbsp;full&nbsp;&#39;body&#39;,&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4538120">//&nbsp;The&nbsp;current&nbsp;max&nbsp;version&nbsp;is&nbsp;3.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4538157">//&nbsp;If&nbsp;the&nbsp;version&nbsp;is&nbsp;&gt;=&nbsp;16.0,&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4538213">//&nbsp;Similarly,&nbsp;a&nbsp;clientHello&nbsp;message&nbsp;encodes&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4538262">//&nbsp;well&nbsp;under&nbsp;a&nbsp;kilobyte.&nbsp;&nbsp;If&nbsp;the&nbsp;length&nbsp;is&nbsp;&gt;=&nbsp;12&nbsp;kB,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4538318">//&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538347">if</span>&nbsp;<span class="op" id="4538350">(</span><span class="ident" id="4538351">typ</span>&nbsp;<span class="op" id="4538355">!=</span>&nbsp;<span class="ident" id="4538358">recordTypeAlert</span>&nbsp;<span class="op" id="4538374">&amp;&amp;</span>&nbsp;<span class="ident" id="4538377">typ</span>&nbsp;<span class="op" id="4538381">!=</span>&nbsp;<span class="ident" id="4538384">want</span><span class="op" id="4538388">)</span>&nbsp;<span class="op" id="4538390">||</span>&nbsp;<span class="ident" id="4538393">vers</span>&nbsp;<span class="op" id="4538398">&gt;=</span>&nbsp;<span class="num" id="4538401">0x1000</span>&nbsp;<span class="op" id="4538408">||</span>&nbsp;<span class="ident" id="4538411">n</span>&nbsp;<span class="op" id="4538413">&gt;=</span>&nbsp;<span class="num" id="4538416">0x3000</span>&nbsp;<span class="op" id="4538423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4538428">c</span><span class="op" id="4538429">.</span><span class="ident" id="4538430">sendAlert</span><span class="op" id="4538439">(</span><span class="ident" id="4538440">alertUnexpectedMessage</span><span class="op" id="4538462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538467">return</span>&nbsp;<span class="ident" id="4538474">c</span><span class="op" id="4538475">.</span><span class="ident" id="4538476">in</span><span class="op" id="4538478">.</span><span class="ident" id="4538479">setErrorLocked</span><span class="op" id="4538493">(</span><span class="ident" id="4538494">fmt</span><span class="op" id="4538497">.</span><span class="ident" id="4538498">Errorf</span><span class="op" id="4538504">(</span><span class="string" id="4538505">&#34;tls:&nbsp;first&nbsp;record&nbsp;does&nbsp;not&nbsp;look&nbsp;like&nbsp;a&nbsp;TLS&nbsp;handshake&#34;</span><span class="op" id="4538559">)</span><span class="op" id="4538560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4538564">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4538567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538570">if</span>&nbsp;<span class="ident" id="4538573">err</span>&nbsp;<span class="op" id="4538577">:=</span>&nbsp;<span class="ident" id="4538580">b</span><span class="op" id="4538581">.</span><span class="ident" id="4538582">readFromUntil</span><span class="op" id="4538595">(</span><span class="ident" id="4538596">c</span><span class="op" id="4538597">.</span><span class="ident" id="4538598">conn</span><span class="op" id="4538602">,</span>&nbsp;<span class="ident" id="4538604">recordHeaderLen</span><span class="op" id="4538619">+</span><span class="ident" id="4538620">n</span><span class="op" id="4538621">)</span><span class="op" id="4538622">;</span>&nbsp;<span class="ident" id="4538624">err</span>&nbsp;<span class="op" id="4538628">!=</span>&nbsp;<span class="ident" id="4538631">nil</span>&nbsp;<span class="op" id="4538635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538639">if</span>&nbsp;<span class="ident" id="4538642">err</span>&nbsp;<span class="op" id="4538646">==</span>&nbsp;<span class="ident" id="4538649">io</span><span class="op" id="4538651">.</span><span class="ident" id="4538652">EOF</span>&nbsp;<span class="op" id="4538656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4538661">err</span>&nbsp;<span class="op" id="4538665">=</span>&nbsp;<span class="ident" id="4538667">io</span><span class="op" id="4538669">.</span><span class="ident" id="4538670">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4538689">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538693">if</span>&nbsp;<span class="ident" id="4538696">e</span><span class="op" id="4538697">,</span>&nbsp;<span class="ident" id="4538699">ok</span>&nbsp;<span class="op" id="4538702">:=</span>&nbsp;<span class="ident" id="4538705">err</span><span class="op" id="4538708">.</span><span class="op" id="4538709">(</span><span class="ident" id="4538710">net</span><span class="op" id="4538713">.</span><span class="ident" id="4538714">Error</span><span class="op" id="4538719">)</span><span class="op" id="4538720">;</span>&nbsp;<span class="op" id="4538722">!</span><span class="ident" id="4538723">ok</span>&nbsp;<span class="op" id="4538726">||</span>&nbsp;<span class="op" id="4538729">!</span><span class="ident" id="4538730">e</span><span class="op" id="4538731">.</span><span class="ident" id="4538732">Temporary</span><span class="op" id="4538741">(</span><span class="op" id="4538742">)</span>&nbsp;<span class="op" id="4538744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4538749">c</span><span class="op" id="4538750">.</span><span class="ident" id="4538751">in</span><span class="op" id="4538753">.</span><span class="ident" id="4538754">setErrorLocked</span><span class="op" id="4538768">(</span><span class="ident" id="4538769">err</span><span class="op" id="4538772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4538776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538780">return</span>&nbsp;<span class="ident" id="4538787">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4538792">}</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4538796">//&nbsp;Process&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4538817">b</span><span class="op" id="4538818">,</span>&nbsp;<span class="ident" id="4538820">c</span><span class="op" id="4538821">.</span><span class="ident" id="4538822">rawInput</span>&nbsp;<span class="op" id="4538831">=</span>&nbsp;<span class="ident" id="4538833">c</span><span class="op" id="4538834">.</span><span class="ident" id="4538835">in</span><span class="op" id="4538837">.</span><span class="ident" id="4538838">splitBlock</span><span class="op" id="4538848">(</span><span class="ident" id="4538849">b</span><span class="op" id="4538850">,</span>&nbsp;<span class="ident" id="4538852">recordHeaderLen</span><span class="op" id="4538867">+</span><span class="ident" id="4538868">n</span><span class="op" id="4538869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4538872">ok</span><span class="op" id="4538874">,</span>&nbsp;<span class="ident" id="4538876">off</span><span class="op" id="4538879">,</span>&nbsp;<span class="ident" id="4538881">err</span>&nbsp;<span class="op" id="4538885">:=</span>&nbsp;<span class="ident" id="4538888">c</span><span class="op" id="4538889">.</span><span class="ident" id="4538890">in</span><span class="op" id="4538892">.</span><span class="ident" id="4538893">decrypt</span><span class="op" id="4538900">(</span><span class="ident" id="4538901">b</span><span class="op" id="4538902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538905">if</span>&nbsp;<span class="op" id="4538908">!</span><span class="ident" id="4538909">ok</span>&nbsp;<span class="op" id="4538912">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4538916">c</span><span class="op" id="4538917">.</span><span class="ident" id="4538918">in</span><span class="op" id="4538920">.</span><span class="ident" id="4538921">setErrorLocked</span><span class="op" id="4538935">(</span><span class="ident" id="4538936">c</span><span class="op" id="4538937">.</span><span class="ident" id="4538938">sendAlert</span><span class="op" id="4538947">(</span><span class="ident" id="4538948">err</span><span class="op" id="4538951">)</span><span class="op" id="4538952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4538955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4538958">b</span><span class="op" id="4538959">.</span><span class="ident" id="4538960">off</span>&nbsp;<span class="op" id="4538964">=</span>&nbsp;<span class="ident" id="4538966">off</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4538971">data</span>&nbsp;<span class="op" id="4538976">:=</span>&nbsp;<span class="ident" id="4538979">b</span><span class="op" id="4538980">.</span><span class="ident" id="4538981">data</span><span class="op" id="4538985">[</span><span class="ident" id="4538986">b</span><span class="op" id="4538987">.</span><span class="ident" id="4538988">off</span><span class="op" id="4538991">:</span><span class="op" id="4538992">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538995">if</span>&nbsp;<span class="builtinfunc" id="4538998">len</span><span class="op" id="4539001">(</span><span class="ident" id="4539002">data</span><span class="op" id="4539006">)</span>&nbsp;<span class="op" id="4539008">&gt;</span>&nbsp;<span class="ident" id="4539010">maxPlaintext</span>&nbsp;<span class="op" id="4539023">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539027">err</span>&nbsp;<span class="op" id="4539031">:=</span>&nbsp;<span class="ident" id="4539034">c</span><span class="op" id="4539035">.</span><span class="ident" id="4539036">sendAlert</span><span class="op" id="4539045">(</span><span class="ident" id="4539046">alertRecordOverflow</span><span class="op" id="4539065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539069">c</span><span class="op" id="4539070">.</span><span class="ident" id="4539071">in</span><span class="op" id="4539073">.</span><span class="ident" id="4539074">freeBlock</span><span class="op" id="4539083">(</span><span class="ident" id="4539084">b</span><span class="op" id="4539085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539089">return</span>&nbsp;<span class="ident" id="4539096">c</span><span class="op" id="4539097">.</span><span class="ident" id="4539098">in</span><span class="op" id="4539100">.</span><span class="ident" id="4539101">setErrorLocked</span><span class="op" id="4539115">(</span><span class="ident" id="4539116">err</span><span class="op" id="4539119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4539122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539126">switch</span>&nbsp;<span class="ident" id="4539133">typ</span>&nbsp;<span class="op" id="4539137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539140">default</span><span class="op" id="4539147">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539151">c</span><span class="op" id="4539152">.</span><span class="ident" id="4539153">in</span><span class="op" id="4539155">.</span><span class="ident" id="4539156">setErrorLocked</span><span class="op" id="4539170">(</span><span class="ident" id="4539171">c</span><span class="op" id="4539172">.</span><span class="ident" id="4539173">sendAlert</span><span class="op" id="4539182">(</span><span class="ident" id="4539183">alertUnexpectedMessage</span><span class="op" id="4539205">)</span><span class="op" id="4539206">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539210">case</span>&nbsp;<span class="ident" id="4539215">recordTypeAlert</span><span class="op" id="4539230">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539234">if</span>&nbsp;<span class="builtinfunc" id="4539237">len</span><span class="op" id="4539240">(</span><span class="ident" id="4539241">data</span><span class="op" id="4539245">)</span>&nbsp;<span class="op" id="4539247">!=</span>&nbsp;<span class="num" id="4539250">2</span>&nbsp;<span class="op" id="4539252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539257">c</span><span class="op" id="4539258">.</span><span class="ident" id="4539259">in</span><span class="op" id="4539261">.</span><span class="ident" id="4539262">setErrorLocked</span><span class="op" id="4539276">(</span><span class="ident" id="4539277">c</span><span class="op" id="4539278">.</span><span class="ident" id="4539279">sendAlert</span><span class="op" id="4539288">(</span><span class="ident" id="4539289">alertUnexpectedMessage</span><span class="op" id="4539311">)</span><span class="op" id="4539312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539317">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4539325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539329">if</span>&nbsp;<span class="ident" id="4539332">alert</span><span class="op" id="4539337">(</span><span class="ident" id="4539338">data</span><span class="op" id="4539342">[</span><span class="num" id="4539343">1</span><span class="op" id="4539344">]</span><span class="op" id="4539345">)</span>&nbsp;<span class="op" id="4539347">==</span>&nbsp;<span class="ident" id="4539350">alertCloseNotify</span>&nbsp;<span class="op" id="4539367">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539372">c</span><span class="op" id="4539373">.</span><span class="ident" id="4539374">in</span><span class="op" id="4539376">.</span><span class="ident" id="4539377">setErrorLocked</span><span class="op" id="4539391">(</span><span class="ident" id="4539392">io</span><span class="op" id="4539394">.</span><span class="ident" id="4539395">EOF</span><span class="op" id="4539398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539403">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4539411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539415">switch</span>&nbsp;<span class="ident" id="4539422">data</span><span class="op" id="4539426">[</span><span class="num" id="4539427">0</span><span class="op" id="4539428">]</span>&nbsp;<span class="op" id="4539430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539434">case</span>&nbsp;<span class="ident" id="4539439">alertLevelWarning</span><span class="op" id="4539456">:</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4539461">//&nbsp;drop&nbsp;on&nbsp;the&nbsp;floor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539485">c</span><span class="op" id="4539486">.</span><span class="ident" id="4539487">in</span><span class="op" id="4539489">.</span><span class="ident" id="4539490">freeBlock</span><span class="op" id="4539499">(</span><span class="ident" id="4539500">b</span><span class="op" id="4539501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539506">goto</span>&nbsp;<span class="ident" id="4539511">Again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539519">case</span>&nbsp;<span class="ident" id="4539524">alertLevelError</span><span class="op" id="4539539">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539544">c</span><span class="op" id="4539545">.</span><span class="ident" id="4539546">in</span><span class="op" id="4539548">.</span><span class="ident" id="4539549">setErrorLocked</span><span class="op" id="4539563">(</span><span class="op" id="4539564">&amp;</span><span class="ident" id="4539565">net</span><span class="op" id="4539568">.</span><span class="ident" id="4539569">OpError</span><span class="op" id="4539576">{</span><span class="ident" id="4539577">Op</span><span class="op" id="4539579">:</span>&nbsp;<span class="string" id="4539581">&#34;remote&nbsp;error&#34;</span><span class="op" id="4539595">,</span>&nbsp;<span class="ident" id="4539597">Err</span><span class="op" id="4539600">:</span>&nbsp;<span class="ident" id="4539602">alert</span><span class="op" id="4539607">(</span><span class="ident" id="4539608">data</span><span class="op" id="4539612">[</span><span class="num" id="4539613">1</span><span class="op" id="4539614">]</span><span class="op" id="4539615">)</span><span class="op" id="4539616">}</span><span class="op" id="4539617">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539621">default</span><span class="op" id="4539628">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539633">c</span><span class="op" id="4539634">.</span><span class="ident" id="4539635">in</span><span class="op" id="4539637">.</span><span class="ident" id="4539638">setErrorLocked</span><span class="op" id="4539652">(</span><span class="ident" id="4539653">c</span><span class="op" id="4539654">.</span><span class="ident" id="4539655">sendAlert</span><span class="op" id="4539664">(</span><span class="ident" id="4539665">alertUnexpectedMessage</span><span class="op" id="4539687">)</span><span class="op" id="4539688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4539692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539696">case</span>&nbsp;<span class="ident" id="4539701">recordTypeChangeCipherSpec</span><span class="op" id="4539727">:</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539731">if</span>&nbsp;<span class="ident" id="4539734">typ</span>&nbsp;<span class="op" id="4539738">!=</span>&nbsp;<span class="ident" id="4539741">want</span>&nbsp;<span class="op" id="4539746">||</span>&nbsp;<span class="builtinfunc" id="4539749">len</span><span class="op" id="4539752">(</span><span class="ident" id="4539753">data</span><span class="op" id="4539757">)</span>&nbsp;<span class="op" id="4539759">!=</span>&nbsp;<span class="num" id="4539762">1</span>&nbsp;<span class="op" id="4539764">||</span>&nbsp;<span class="ident" id="4539767">data</span><span class="op" id="4539771">[</span><span class="num" id="4539772">0</span><span class="op" id="4539773">]</span>&nbsp;<span class="op" id="4539775">!=</span>&nbsp;<span class="num" id="4539778">1</span>&nbsp;<span class="op" id="4539780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539785">c</span><span class="op" id="4539786">.</span><span class="ident" id="4539787">in</span><span class="op" id="4539789">.</span><span class="ident" id="4539790">setErrorLocked</span><span class="op" id="4539804">(</span><span class="ident" id="4539805">c</span><span class="op" id="4539806">.</span><span class="ident" id="4539807">sendAlert</span><span class="op" id="4539816">(</span><span class="ident" id="4539817">alertUnexpectedMessage</span><span class="op" id="4539839">)</span><span class="op" id="4539840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539845">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4539853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539857">err</span>&nbsp;<span class="op" id="4539861">:=</span>&nbsp;<span class="ident" id="4539864">c</span><span class="op" id="4539865">.</span><span class="ident" id="4539866">in</span><span class="op" id="4539868">.</span><span class="ident" id="4539869">changeCipherSpec</span><span class="op" id="4539885">(</span><span class="op" id="4539886">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539890">if</span>&nbsp;<span class="ident" id="4539893">err</span>&nbsp;<span class="op" id="4539897">!=</span>&nbsp;<span class="ident" id="4539900">nil</span>&nbsp;<span class="op" id="4539904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539909">c</span><span class="op" id="4539910">.</span><span class="ident" id="4539911">in</span><span class="op" id="4539913">.</span><span class="ident" id="4539914">setErrorLocked</span><span class="op" id="4539928">(</span><span class="ident" id="4539929">c</span><span class="op" id="4539930">.</span><span class="ident" id="4539931">sendAlert</span><span class="op" id="4539940">(</span><span class="ident" id="4539941">err</span><span class="op" id="4539944">.</span><span class="op" id="4539945">(</span><span class="ident" id="4539946">alert</span><span class="op" id="4539951">)</span><span class="op" id="4539952">)</span><span class="op" id="4539953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4539957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539961">case</span>&nbsp;<span class="ident" id="4539966">recordTypeApplicationData</span><span class="op" id="4539991">:</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539995">if</span>&nbsp;<span class="ident" id="4539998">typ</span>&nbsp;<span class="op" id="4540002">!=</span>&nbsp;<span class="ident" id="4540005">want</span>&nbsp;<span class="op" id="4540010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4540015">c</span><span class="op" id="4540016">.</span><span class="ident" id="4540017">in</span><span class="op" id="4540019">.</span><span class="ident" id="4540020">setErrorLocked</span><span class="op" id="4540034">(</span><span class="ident" id="4540035">c</span><span class="op" id="4540036">.</span><span class="ident" id="4540037">sendAlert</span><span class="op" id="4540046">(</span><span class="ident" id="4540047">alertUnexpectedMessage</span><span class="op" id="4540069">)</span><span class="op" id="4540070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540075">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4540083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4540087">c</span><span class="op" id="4540088">.</span><span class="ident" id="4540089">input</span>&nbsp;<span class="op" id="4540095">=</span>&nbsp;<span class="ident" id="4540097">b</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4540101">b</span>&nbsp;<span class="op" id="4540103">=</span>&nbsp;<span class="ident" id="4540105">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540111">case</span>&nbsp;<span class="ident" id="4540116">recordTypeHandshake</span><span class="op" id="4540135">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4540139">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;at&nbsp;least&nbsp;pick&nbsp;off&nbsp;connection&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540198">if</span>&nbsp;<span class="ident" id="4540201">typ</span>&nbsp;<span class="op" id="4540205">!=</span>&nbsp;<span class="ident" id="4540208">want</span>&nbsp;<span class="op" id="4540213">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540218">return</span>&nbsp;<span class="ident" id="4540225">c</span><span class="op" id="4540226">.</span><span class="ident" id="4540227">in</span><span class="op" id="4540229">.</span><span class="ident" id="4540230">setErrorLocked</span><span class="op" id="4540244">(</span><span class="ident" id="4540245">c</span><span class="op" id="4540246">.</span><span class="ident" id="4540247">sendAlert</span><span class="op" id="4540256">(</span><span class="ident" id="4540257">alertNoRenegotiation</span><span class="op" id="4540277">)</span><span class="op" id="4540278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4540282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4540286">c</span><span class="op" id="4540287">.</span><span class="ident" id="4540288">hand</span><span class="op" id="4540292">.</span><span class="ident" id="4540293">Write</span><span class="op" id="4540298">(</span><span class="ident" id="4540299">data</span><span class="op" id="4540303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4540306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540310">if</span>&nbsp;<span class="ident" id="4540313">b</span>&nbsp;<span class="op" id="4540315">!=</span>&nbsp;<span class="ident" id="4540318">nil</span>&nbsp;<span class="op" id="4540322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4540326">c</span><span class="op" id="4540327">.</span><span class="ident" id="4540328">in</span><span class="op" id="4540330">.</span><span class="ident" id="4540331">freeBlock</span><span class="op" id="4540340">(</span><span class="ident" id="4540341">b</span><span class="op" id="4540342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4540345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540348">return</span>&nbsp;<span class="ident" id="4540355">c</span><span class="op" id="4540356">.</span><span class="ident" id="4540357">in</span><span class="op" id="4540359">.</span><span class="ident" id="4540360">err</span><br>
<span class="lineno"></span><span class="op" id="4540364">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="4540367">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno"></span><span class="comment" id="4540407">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="4540428">func</span>&nbsp;<span class="op" id="4540433">(</span><span class="ident" id="4540434">c</span>&nbsp;<span class="op" id="4540436">*</span><span class="ident" id="4540437">Conn</span><span class="op" id="4540441">)</span>&nbsp;<span class="ident" id="4540443">sendAlertLocked</span><span class="op" id="4540458">(</span><span class="ident" id="4540459">err</span>&nbsp;<span class="ident" id="4540463">alert</span><span class="op" id="4540468">)</span>&nbsp;<span class="builtintype" id="4540470">error</span>&nbsp;<span class="op" id="4540476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540479">switch</span>&nbsp;<span class="ident" id="4540486">err</span>&nbsp;<span class="op" id="4540490">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540493">case</span>&nbsp;<span class="ident" id="4540498">alertNoRenegotiation</span><span class="op" id="4540518">,</span>&nbsp;<span class="ident" id="4540520">alertCloseNotify</span><span class="op" id="4540536">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4540540">c</span><span class="op" id="4540541">.</span><span class="ident" id="4540542">tmp</span><span class="op" id="4540545">[</span><span class="num" id="4540546">0</span><span class="op" id="4540547">]</span>&nbsp;<span class="op" id="4540549">=</span>&nbsp;<span class="ident" id="4540551">alertLevelWarning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540570">default</span><span class="op" id="4540577">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4540581">c</span><span class="op" id="4540582">.</span><span class="ident" id="4540583">tmp</span><span class="op" id="4540586">[</span><span class="num" id="4540587">0</span><span class="op" id="4540588">]</span>&nbsp;<span class="op" id="4540590">=</span>&nbsp;<span class="ident" id="4540592">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4540609">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4540612">c</span><span class="op" id="4540613">.</span><span class="ident" id="4540614">tmp</span><span class="op" id="4540617">[</span><span class="num" id="4540618">1</span><span class="op" id="4540619">]</span>&nbsp;<span class="op" id="4540621">=</span>&nbsp;<span class="builtintype" id="4540623">byte</span><span class="op" id="4540627">(</span><span class="ident" id="4540628">err</span><span class="op" id="4540631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4540634">c</span><span class="op" id="4540635">.</span><span class="ident" id="4540636">writeRecord</span><span class="op" id="4540647">(</span><span class="ident" id="4540648">recordTypeAlert</span><span class="op" id="4540663">,</span>&nbsp;<span class="ident" id="4540665">c</span><span class="op" id="4540666">.</span><span class="ident" id="4540667">tmp</span><span class="op" id="4540670">[</span><span class="num" id="4540671">0</span><span class="op" id="4540672">:</span><span class="num" id="4540673">2</span><span class="op" id="4540674">]</span><span class="op" id="4540675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4540678">//&nbsp;closeNotify&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;in&nbsp;that&nbsp;it&nbsp;isn&#39;t&nbsp;an&nbsp;error:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540739">if</span>&nbsp;<span class="ident" id="4540742">err</span>&nbsp;<span class="op" id="4540746">!=</span>&nbsp;<span class="ident" id="4540749">alertCloseNotify</span>&nbsp;<span class="op" id="4540766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540770">return</span>&nbsp;<span class="ident" id="4540777">c</span><span class="op" id="4540778">.</span><span class="ident" id="4540779">out</span><span class="op" id="4540782">.</span><span class="ident" id="4540783">setErrorLocked</span><span class="op" id="4540797">(</span><span class="op" id="4540798">&amp;</span><span class="ident" id="4540799">net</span><span class="op" id="4540802">.</span><span class="ident" id="4540803">OpError</span><span class="op" id="4540810">{</span><span class="ident" id="4540811">Op</span><span class="op" id="4540813">:</span>&nbsp;<span class="string" id="4540815">&#34;local&nbsp;error&#34;</span><span class="op" id="4540828">,</span>&nbsp;<span class="ident" id="4540830">Err</span><span class="op" id="4540833">:</span>&nbsp;<span class="ident" id="4540835">err</span><span class="op" id="4540838">}</span><span class="op" id="4540839">)</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4540842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540845">return</span>&nbsp;<span class="ident" id="4540852">nil</span><br>
<span class="lineno"></span><span class="op" id="4540856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4540859">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno">685</span><span class="comment" id="4540899">//&nbsp;L&nbsp;&lt;&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="4540919">func</span>&nbsp;<span class="op" id="4540924">(</span><span class="ident" id="4540925">c</span>&nbsp;<span class="op" id="4540927">*</span><span class="ident" id="4540928">Conn</span><span class="op" id="4540932">)</span>&nbsp;<span class="ident" id="4540934">sendAlert</span><span class="op" id="4540943">(</span><span class="ident" id="4540944">err</span>&nbsp;<span class="ident" id="4540948">alert</span><span class="op" id="4540953">)</span>&nbsp;<span class="builtintype" id="4540955">error</span>&nbsp;<span class="op" id="4540961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4540964">c</span><span class="op" id="4540965">.</span><span class="ident" id="4540966">out</span><span class="op" id="4540969">.</span><span class="ident" id="4540970">Lock</span><span class="op" id="4540974">(</span><span class="op" id="4540975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540978">defer</span>&nbsp;<span class="ident" id="4540984">c</span><span class="op" id="4540985">.</span><span class="ident" id="4540986">out</span><span class="op" id="4540989">.</span><span class="ident" id="4540990">Unlock</span><span class="op" id="4540996">(</span><span class="op" id="4540997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541000">return</span>&nbsp;<span class="ident" id="4541007">c</span><span class="op" id="4541008">.</span><span class="ident" id="4541009">sendAlertLocked</span><span class="op" id="4541024">(</span><span class="ident" id="4541025">err</span><span class="op" id="4541028">)</span><br>
<span class="lineno">690</span><span class="op" id="4541030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4541033">//&nbsp;writeRecord&nbsp;writes&nbsp;a&nbsp;TLS&nbsp;record&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="4541100">//&nbsp;to&nbsp;the&nbsp;connection&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="4541157">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno">695</span><span class="keyword" id="4541178">func</span>&nbsp;<span class="op" id="4541183">(</span><span class="ident" id="4541184">c</span>&nbsp;<span class="op" id="4541186">*</span><span class="ident" id="4541187">Conn</span><span class="op" id="4541191">)</span>&nbsp;<span class="ident" id="4541193">writeRecord</span><span class="op" id="4541204">(</span><span class="ident" id="4541205">typ</span>&nbsp;<span class="ident" id="4541209">recordType</span><span class="op" id="4541219">,</span>&nbsp;<span class="ident" id="4541221">data</span>&nbsp;<span class="op" id="4541226">[</span><span class="op" id="4541227">]</span><span class="builtintype" id="4541228">byte</span><span class="op" id="4541232">)</span>&nbsp;<span class="op" id="4541234">(</span><span class="ident" id="4541235">n</span>&nbsp;<span class="builtintype" id="4541237">int</span><span class="op" id="4541240">,</span>&nbsp;<span class="ident" id="4541242">err</span>&nbsp;<span class="builtintype" id="4541246">error</span><span class="op" id="4541251">)</span>&nbsp;<span class="op" id="4541253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541256">b</span>&nbsp;<span class="op" id="4541258">:=</span>&nbsp;<span class="ident" id="4541261">c</span><span class="op" id="4541262">.</span><span class="ident" id="4541263">out</span><span class="op" id="4541266">.</span><span class="ident" id="4541267">newBlock</span><span class="op" id="4541275">(</span><span class="op" id="4541276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541279">for</span>&nbsp;<span class="builtinfunc" id="4541283">len</span><span class="op" id="4541286">(</span><span class="ident" id="4541287">data</span><span class="op" id="4541291">)</span>&nbsp;<span class="op" id="4541293">&gt;</span>&nbsp;<span class="num" id="4541295">0</span>&nbsp;<span class="op" id="4541297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541301">m</span>&nbsp;<span class="op" id="4541303">:=</span>&nbsp;<span class="builtinfunc" id="4541306">len</span><span class="op" id="4541309">(</span><span class="ident" id="4541310">data</span><span class="op" id="4541314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541318">if</span>&nbsp;<span class="ident" id="4541321">m</span>&nbsp;<span class="op" id="4541323">&gt;</span>&nbsp;<span class="ident" id="4541325">maxPlaintext</span>&nbsp;<span class="op" id="4541338">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541343">m</span>&nbsp;<span class="op" id="4541345">=</span>&nbsp;<span class="ident" id="4541347">maxPlaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4541362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541366">explicitIVLen</span>&nbsp;<span class="op" id="4541380">:=</span>&nbsp;<span class="num" id="4541383">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541387">explicitIVIsSeq</span>&nbsp;<span class="op" id="4541403">:=</span>&nbsp;<span class="builtintype" id="4541406">false</span><br>
<span class="lineno"></span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541415">var</span>&nbsp;<span class="ident" id="4541419">cbc</span>&nbsp;<span class="ident" id="4541423">cbcMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541433">if</span>&nbsp;<span class="ident" id="4541436">c</span><span class="op" id="4541437">.</span><span class="ident" id="4541438">out</span><span class="op" id="4541441">.</span><span class="ident" id="4541442">version</span>&nbsp;<span class="op" id="4541450">&gt;=</span>&nbsp;<span class="ident" id="4541453">VersionTLS11</span>&nbsp;<span class="op" id="4541466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541471">var</span>&nbsp;<span class="ident" id="4541475">ok</span>&nbsp;<span class="builtintype" id="4541478">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541486">if</span>&nbsp;<span class="ident" id="4541489">cbc</span><span class="op" id="4541492">,</span>&nbsp;<span class="ident" id="4541494">ok</span>&nbsp;<span class="op" id="4541497">=</span>&nbsp;<span class="ident" id="4541499">c</span><span class="op" id="4541500">.</span><span class="ident" id="4541501">out</span><span class="op" id="4541504">.</span><span class="ident" id="4541505">cipher</span><span class="op" id="4541511">.</span><span class="op" id="4541512">(</span><span class="ident" id="4541513">cbcMode</span><span class="op" id="4541520">)</span><span class="op" id="4541521">;</span>&nbsp;<span class="ident" id="4541523">ok</span>&nbsp;<span class="op" id="4541526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541532">explicitIVLen</span>&nbsp;<span class="op" id="4541546">=</span>&nbsp;<span class="ident" id="4541548">cbc</span><span class="op" id="4541551">.</span><span class="ident" id="4541552">BlockSize</span><span class="op" id="4541561">(</span><span class="op" id="4541562">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4541567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4541571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541575">if</span>&nbsp;<span class="ident" id="4541578">explicitIVLen</span>&nbsp;<span class="op" id="4541592">==</span>&nbsp;<span class="num" id="4541595">0</span>&nbsp;<span class="op" id="4541597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541602">if</span>&nbsp;<span class="ident" id="4541605">_</span><span class="op" id="4541606">,</span>&nbsp;<span class="ident" id="4541608">ok</span>&nbsp;<span class="op" id="4541611">:=</span>&nbsp;<span class="ident" id="4541614">c</span><span class="op" id="4541615">.</span><span class="ident" id="4541616">out</span><span class="op" id="4541619">.</span><span class="ident" id="4541620">cipher</span><span class="op" id="4541626">.</span><span class="op" id="4541627">(</span><span class="ident" id="4541628">cipher</span><span class="op" id="4541634">.</span><span class="ident" id="4541635">AEAD</span><span class="op" id="4541639">)</span><span class="op" id="4541640">;</span>&nbsp;<span class="ident" id="4541642">ok</span>&nbsp;<span class="op" id="4541645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541651">explicitIVLen</span>&nbsp;<span class="op" id="4541665">=</span>&nbsp;<span class="num" id="4541667">8</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4541673">//&nbsp;The&nbsp;AES-GCM&nbsp;construction&nbsp;in&nbsp;TLS&nbsp;has&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4541719">//&nbsp;explicit&nbsp;nonce&nbsp;so&nbsp;that&nbsp;the&nbsp;nonce&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4541766">//&nbsp;random.&nbsp;However,&nbsp;the&nbsp;nonce&nbsp;is&nbsp;only&nbsp;8&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4541816">//&nbsp;which&nbsp;is&nbsp;too&nbsp;small&nbsp;for&nbsp;a&nbsp;secure,&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4541863">//&nbsp;nonce.&nbsp;Therefore&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4541914">//&nbsp;as&nbsp;the&nbsp;nonce.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541935">explicitIVIsSeq</span>&nbsp;<span class="op" id="4541951">=</span>&nbsp;<span class="builtintype" id="4541953">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4541961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4541965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541969">b</span><span class="op" id="4541970">.</span><span class="ident" id="4541971">resize</span><span class="op" id="4541977">(</span><span class="ident" id="4541978">recordHeaderLen</span>&nbsp;<span class="op" id="4541994">+</span>&nbsp;<span class="ident" id="4541996">explicitIVLen</span>&nbsp;<span class="op" id="4542010">+</span>&nbsp;<span class="ident" id="4542012">m</span><span class="op" id="4542013">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542017">b</span><span class="op" id="4542018">.</span><span class="ident" id="4542019">data</span><span class="op" id="4542023">[</span><span class="num" id="4542024">0</span><span class="op" id="4542025">]</span>&nbsp;<span class="op" id="4542027">=</span>&nbsp;<span class="builtintype" id="4542029">byte</span><span class="op" id="4542033">(</span><span class="ident" id="4542034">typ</span><span class="op" id="4542037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542041">vers</span>&nbsp;<span class="op" id="4542046">:=</span>&nbsp;<span class="ident" id="4542049">c</span><span class="op" id="4542050">.</span><span class="ident" id="4542051">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542058">if</span>&nbsp;<span class="ident" id="4542061">vers</span>&nbsp;<span class="op" id="4542066">==</span>&nbsp;<span class="num" id="4542069">0</span>&nbsp;<span class="op" id="4542071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4542076">//&nbsp;Some&nbsp;TLS&nbsp;servers&nbsp;fail&nbsp;if&nbsp;the&nbsp;record&nbsp;version&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4542129">//&nbsp;greater&nbsp;than&nbsp;TLS&nbsp;1.0&nbsp;for&nbsp;the&nbsp;initial&nbsp;ClientHello.</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542185">vers</span>&nbsp;<span class="op" id="4542190">=</span>&nbsp;<span class="ident" id="4542192">VersionTLS10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4542207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542211">b</span><span class="op" id="4542212">.</span><span class="ident" id="4542213">data</span><span class="op" id="4542217">[</span><span class="num" id="4542218">1</span><span class="op" id="4542219">]</span>&nbsp;<span class="op" id="4542221">=</span>&nbsp;<span class="builtintype" id="4542223">byte</span><span class="op" id="4542227">(</span><span class="ident" id="4542228">vers</span>&nbsp;<span class="op" id="4542233">&gt;&gt;</span>&nbsp;<span class="num" id="4542236">8</span><span class="op" id="4542237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542241">b</span><span class="op" id="4542242">.</span><span class="ident" id="4542243">data</span><span class="op" id="4542247">[</span><span class="num" id="4542248">2</span><span class="op" id="4542249">]</span>&nbsp;<span class="op" id="4542251">=</span>&nbsp;<span class="builtintype" id="4542253">byte</span><span class="op" id="4542257">(</span><span class="ident" id="4542258">vers</span><span class="op" id="4542262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542266">b</span><span class="op" id="4542267">.</span><span class="ident" id="4542268">data</span><span class="op" id="4542272">[</span><span class="num" id="4542273">3</span><span class="op" id="4542274">]</span>&nbsp;<span class="op" id="4542276">=</span>&nbsp;<span class="builtintype" id="4542278">byte</span><span class="op" id="4542282">(</span><span class="ident" id="4542283">m</span>&nbsp;<span class="op" id="4542285">&gt;&gt;</span>&nbsp;<span class="num" id="4542288">8</span><span class="op" id="4542289">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542293">b</span><span class="op" id="4542294">.</span><span class="ident" id="4542295">data</span><span class="op" id="4542299">[</span><span class="num" id="4542300">4</span><span class="op" id="4542301">]</span>&nbsp;<span class="op" id="4542303">=</span>&nbsp;<span class="builtintype" id="4542305">byte</span><span class="op" id="4542309">(</span><span class="ident" id="4542310">m</span><span class="op" id="4542311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542315">if</span>&nbsp;<span class="ident" id="4542318">explicitIVLen</span>&nbsp;<span class="op" id="4542332">&gt;</span>&nbsp;<span class="num" id="4542334">0</span>&nbsp;<span class="op" id="4542336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542341">explicitIV</span>&nbsp;<span class="op" id="4542352">:=</span>&nbsp;<span class="ident" id="4542355">b</span><span class="op" id="4542356">.</span><span class="ident" id="4542357">data</span><span class="op" id="4542361">[</span><span class="ident" id="4542362">recordHeaderLen</span>&nbsp;<span class="op" id="4542378">:</span>&nbsp;<span class="ident" id="4542380">recordHeaderLen</span><span class="op" id="4542395">+</span><span class="ident" id="4542396">explicitIVLen</span><span class="op" id="4542409">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542414">if</span>&nbsp;<span class="ident" id="4542417">explicitIVIsSeq</span>&nbsp;<span class="op" id="4542433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4542439">copy</span><span class="op" id="4542443">(</span><span class="ident" id="4542444">explicitIV</span><span class="op" id="4542454">,</span>&nbsp;<span class="ident" id="4542456">c</span><span class="op" id="4542457">.</span><span class="ident" id="4542458">out</span><span class="op" id="4542461">.</span><span class="ident" id="4542462">seq</span><span class="op" id="4542465">[</span><span class="op" id="4542466">:</span><span class="op" id="4542467">]</span><span class="op" id="4542468">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4542473">}</span>&nbsp;<span class="keyword" id="4542475">else</span>&nbsp;<span class="op" id="4542480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542486">if</span>&nbsp;<span class="ident" id="4542489">_</span><span class="op" id="4542490">,</span>&nbsp;<span class="ident" id="4542492">err</span>&nbsp;<span class="op" id="4542496">=</span>&nbsp;<span class="ident" id="4542498">io</span><span class="op" id="4542500">.</span><span class="ident" id="4542501">ReadFull</span><span class="op" id="4542509">(</span><span class="ident" id="4542510">c</span><span class="op" id="4542511">.</span><span class="ident" id="4542512">config</span><span class="op" id="4542518">.</span><span class="ident" id="4542519">rand</span><span class="op" id="4542523">(</span><span class="op" id="4542524">)</span><span class="op" id="4542525">,</span>&nbsp;<span class="ident" id="4542527">explicitIV</span><span class="op" id="4542537">)</span><span class="op" id="4542538">;</span>&nbsp;<span class="ident" id="4542540">err</span>&nbsp;<span class="op" id="4542544">!=</span>&nbsp;<span class="ident" id="4542547">nil</span>&nbsp;<span class="op" id="4542551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542558">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4542568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4542573">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4542577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4542581">copy</span><span class="op" id="4542585">(</span><span class="ident" id="4542586">b</span><span class="op" id="4542587">.</span><span class="ident" id="4542588">data</span><span class="op" id="4542592">[</span><span class="ident" id="4542593">recordHeaderLen</span><span class="op" id="4542608">+</span><span class="ident" id="4542609">explicitIVLen</span><span class="op" id="4542622">:</span><span class="op" id="4542623">]</span><span class="op" id="4542624">,</span>&nbsp;<span class="ident" id="4542626">data</span><span class="op" id="4542630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542634">c</span><span class="op" id="4542635">.</span><span class="ident" id="4542636">out</span><span class="op" id="4542639">.</span><span class="ident" id="4542640">encrypt</span><span class="op" id="4542647">(</span><span class="ident" id="4542648">b</span><span class="op" id="4542649">,</span>&nbsp;<span class="ident" id="4542651">explicitIVLen</span><span class="op" id="4542664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542668">_</span><span class="op" id="4542669">,</span>&nbsp;<span class="ident" id="4542671">err</span>&nbsp;<span class="op" id="4542675">=</span>&nbsp;<span class="ident" id="4542677">c</span><span class="op" id="4542678">.</span><span class="ident" id="4542679">conn</span><span class="op" id="4542683">.</span><span class="ident" id="4542684">Write</span><span class="op" id="4542689">(</span><span class="ident" id="4542690">b</span><span class="op" id="4542691">.</span><span class="ident" id="4542692">data</span><span class="op" id="4542696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542700">if</span>&nbsp;<span class="ident" id="4542703">err</span>&nbsp;<span class="op" id="4542707">!=</span>&nbsp;<span class="ident" id="4542710">nil</span>&nbsp;<span class="op" id="4542714">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542719">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4542727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542731">n</span>&nbsp;<span class="op" id="4542733">+=</span>&nbsp;<span class="ident" id="4542736">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542740">data</span>&nbsp;<span class="op" id="4542745">=</span>&nbsp;<span class="ident" id="4542747">data</span><span class="op" id="4542751">[</span><span class="ident" id="4542752">m</span><span class="op" id="4542753">:</span><span class="op" id="4542754">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4542757">}</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542760">c</span><span class="op" id="4542761">.</span><span class="ident" id="4542762">out</span><span class="op" id="4542765">.</span><span class="ident" id="4542766">freeBlock</span><span class="op" id="4542775">(</span><span class="ident" id="4542776">b</span><span class="op" id="4542777">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542781">if</span>&nbsp;<span class="ident" id="4542784">typ</span>&nbsp;<span class="op" id="4542788">==</span>&nbsp;<span class="ident" id="4542791">recordTypeChangeCipherSpec</span>&nbsp;<span class="op" id="4542818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542822">err</span>&nbsp;<span class="op" id="4542826">=</span>&nbsp;<span class="ident" id="4542828">c</span><span class="op" id="4542829">.</span><span class="ident" id="4542830">out</span><span class="op" id="4542833">.</span><span class="ident" id="4542834">changeCipherSpec</span><span class="op" id="4542850">(</span><span class="op" id="4542851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542855">if</span>&nbsp;<span class="ident" id="4542858">err</span>&nbsp;<span class="op" id="4542862">!=</span>&nbsp;<span class="ident" id="4542865">nil</span>&nbsp;<span class="op" id="4542869">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4542874">//&nbsp;Cannot&nbsp;call&nbsp;sendAlert&nbsp;directly,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4542912">//&nbsp;because&nbsp;we&nbsp;already&nbsp;hold&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542955">c</span><span class="op" id="4542956">.</span><span class="ident" id="4542957">tmp</span><span class="op" id="4542960">[</span><span class="num" id="4542961">0</span><span class="op" id="4542962">]</span>&nbsp;<span class="op" id="4542964">=</span>&nbsp;<span class="ident" id="4542966">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542985">c</span><span class="op" id="4542986">.</span><span class="ident" id="4542987">tmp</span><span class="op" id="4542990">[</span><span class="num" id="4542991">1</span><span class="op" id="4542992">]</span>&nbsp;<span class="op" id="4542994">=</span>&nbsp;<span class="builtintype" id="4542996">byte</span><span class="op" id="4543000">(</span><span class="ident" id="4543001">err</span><span class="op" id="4543004">.</span><span class="op" id="4543005">(</span><span class="ident" id="4543006">alert</span><span class="op" id="4543011">)</span><span class="op" id="4543012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4543017">c</span><span class="op" id="4543018">.</span><span class="ident" id="4543019">writeRecord</span><span class="op" id="4543030">(</span><span class="ident" id="4543031">recordTypeAlert</span><span class="op" id="4543046">,</span>&nbsp;<span class="ident" id="4543048">c</span><span class="op" id="4543049">.</span><span class="ident" id="4543050">tmp</span><span class="op" id="4543053">[</span><span class="num" id="4543054">0</span><span class="op" id="4543055">:</span><span class="num" id="4543056">2</span><span class="op" id="4543057">]</span><span class="op" id="4543058">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543063">return</span>&nbsp;<span class="ident" id="4543070">n</span><span class="op" id="4543071">,</span>&nbsp;<span class="ident" id="4543073">c</span><span class="op" id="4543074">.</span><span class="ident" id="4543075">out</span><span class="op" id="4543078">.</span><span class="ident" id="4543079">setErrorLocked</span><span class="op" id="4543093">(</span><span class="op" id="4543094">&amp;</span><span class="ident" id="4543095">net</span><span class="op" id="4543098">.</span><span class="ident" id="4543099">OpError</span><span class="op" id="4543106">{</span><span class="ident" id="4543107">Op</span><span class="op" id="4543109">:</span>&nbsp;<span class="string" id="4543111">&#34;local&nbsp;error&#34;</span><span class="op" id="4543124">,</span>&nbsp;<span class="ident" id="4543126">Err</span><span class="op" id="4543129">:</span>&nbsp;<span class="ident" id="4543131">err</span><span class="op" id="4543134">}</span><span class="op" id="4543135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4543139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4543142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543145">return</span><br>
<span class="lineno"></span><span class="op" id="4543152">}</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="4543155">//&nbsp;readHandshake&nbsp;reads&nbsp;the&nbsp;next&nbsp;handshake&nbsp;message&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="4543210">//&nbsp;the&nbsp;record&nbsp;layer.</span><br>
<span class="lineno"></span><span class="comment" id="4543231">//&nbsp;c.in.Mutex&nbsp;&lt;&nbsp;L;&nbsp;c.out.Mutex&nbsp;&lt;&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="4543267">func</span>&nbsp;<span class="op" id="4543272">(</span><span class="ident" id="4543273">c</span>&nbsp;<span class="op" id="4543275">*</span><span class="ident" id="4543276">Conn</span><span class="op" id="4543280">)</span>&nbsp;<span class="ident" id="4543282">readHandshake</span><span class="op" id="4543295">(</span><span class="op" id="4543296">)</span>&nbsp;<span class="op" id="4543298">(</span><span class="keyword" id="4543299">interface</span><span class="op" id="4543308">{</span><span class="op" id="4543309">}</span><span class="op" id="4543310">,</span>&nbsp;<span class="builtintype" id="4543312">error</span><span class="op" id="4543317">)</span>&nbsp;<span class="op" id="4543319">{</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543322">for</span>&nbsp;<span class="ident" id="4543326">c</span><span class="op" id="4543327">.</span><span class="ident" id="4543328">hand</span><span class="op" id="4543332">.</span><span class="ident" id="4543333">Len</span><span class="op" id="4543336">(</span><span class="op" id="4543337">)</span>&nbsp;<span class="op" id="4543339">&lt;</span>&nbsp;<span class="num" id="4543341">4</span>&nbsp;<span class="op" id="4543343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543347">if</span>&nbsp;<span class="ident" id="4543350">err</span>&nbsp;<span class="op" id="4543354">:=</span>&nbsp;<span class="ident" id="4543357">c</span><span class="op" id="4543358">.</span><span class="ident" id="4543359">in</span><span class="op" id="4543361">.</span><span class="ident" id="4543362">err</span><span class="op" id="4543365">;</span>&nbsp;<span class="ident" id="4543367">err</span>&nbsp;<span class="op" id="4543371">!=</span>&nbsp;<span class="ident" id="4543374">nil</span>&nbsp;<span class="op" id="4543378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543383">return</span>&nbsp;<span class="ident" id="4543390">nil</span><span class="op" id="4543393">,</span>&nbsp;<span class="ident" id="4543395">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4543401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543405">if</span>&nbsp;<span class="ident" id="4543408">err</span>&nbsp;<span class="op" id="4543412">:=</span>&nbsp;<span class="ident" id="4543415">c</span><span class="op" id="4543416">.</span><span class="ident" id="4543417">readRecord</span><span class="op" id="4543427">(</span><span class="ident" id="4543428">recordTypeHandshake</span><span class="op" id="4543447">)</span><span class="op" id="4543448">;</span>&nbsp;<span class="ident" id="4543450">err</span>&nbsp;<span class="op" id="4543454">!=</span>&nbsp;<span class="ident" id="4543457">nil</span>&nbsp;<span class="op" id="4543461">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543466">return</span>&nbsp;<span class="ident" id="4543473">nil</span><span class="op" id="4543476">,</span>&nbsp;<span class="ident" id="4543478">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4543484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4543487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4543491">data</span>&nbsp;<span class="op" id="4543496">:=</span>&nbsp;<span class="ident" id="4543499">c</span><span class="op" id="4543500">.</span><span class="ident" id="4543501">hand</span><span class="op" id="4543505">.</span><span class="ident" id="4543506">Bytes</span><span class="op" id="4543511">(</span><span class="op" id="4543512">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4543515">n</span>&nbsp;<span class="op" id="4543517">:=</span>&nbsp;<span class="builtintype" id="4543520">int</span><span class="op" id="4543523">(</span><span class="ident" id="4543524">data</span><span class="op" id="4543528">[</span><span class="num" id="4543529">1</span><span class="op" id="4543530">]</span><span class="op" id="4543531">)</span><span class="op" id="4543532">&lt;&lt;</span><span class="num" id="4543534">16</span>&nbsp;<span class="op" id="4543537">|</span>&nbsp;<span class="builtintype" id="4543539">int</span><span class="op" id="4543542">(</span><span class="ident" id="4543543">data</span><span class="op" id="4543547">[</span><span class="num" id="4543548">2</span><span class="op" id="4543549">]</span><span class="op" id="4543550">)</span><span class="op" id="4543551">&lt;&lt;</span><span class="num" id="4543553">8</span>&nbsp;<span class="op" id="4543555">|</span>&nbsp;<span class="builtintype" id="4543557">int</span><span class="op" id="4543560">(</span><span class="ident" id="4543561">data</span><span class="op" id="4543565">[</span><span class="num" id="4543566">3</span><span class="op" id="4543567">]</span><span class="op" id="4543568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543571">if</span>&nbsp;<span class="ident" id="4543574">n</span>&nbsp;<span class="op" id="4543576">&gt;</span>&nbsp;<span class="ident" id="4543578">maxHandshake</span>&nbsp;<span class="op" id="4543591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543595">return</span>&nbsp;<span class="ident" id="4543602">nil</span><span class="op" id="4543605">,</span>&nbsp;<span class="ident" id="4543607">c</span><span class="op" id="4543608">.</span><span class="ident" id="4543609">in</span><span class="op" id="4543611">.</span><span class="ident" id="4543612">setErrorLocked</span><span class="op" id="4543626">(</span><span class="ident" id="4543627">c</span><span class="op" id="4543628">.</span><span class="ident" id="4543629">sendAlert</span><span class="op" id="4543638">(</span><span class="ident" id="4543639">alertInternalError</span><span class="op" id="4543657">)</span><span class="op" id="4543658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4543661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543664">for</span>&nbsp;<span class="ident" id="4543668">c</span><span class="op" id="4543669">.</span><span class="ident" id="4543670">hand</span><span class="op" id="4543674">.</span><span class="ident" id="4543675">Len</span><span class="op" id="4543678">(</span><span class="op" id="4543679">)</span>&nbsp;<span class="op" id="4543681">&lt;</span>&nbsp;<span class="num" id="4543683">4</span><span class="op" id="4543684">+</span><span class="ident" id="4543685">n</span>&nbsp;<span class="op" id="4543687">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543691">if</span>&nbsp;<span class="ident" id="4543694">err</span>&nbsp;<span class="op" id="4543698">:=</span>&nbsp;<span class="ident" id="4543701">c</span><span class="op" id="4543702">.</span><span class="ident" id="4543703">in</span><span class="op" id="4543705">.</span><span class="ident" id="4543706">err</span><span class="op" id="4543709">;</span>&nbsp;<span class="ident" id="4543711">err</span>&nbsp;<span class="op" id="4543715">!=</span>&nbsp;<span class="ident" id="4543718">nil</span>&nbsp;<span class="op" id="4543722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543727">return</span>&nbsp;<span class="ident" id="4543734">nil</span><span class="op" id="4543737">,</span>&nbsp;<span class="ident" id="4543739">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4543745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543749">if</span>&nbsp;<span class="ident" id="4543752">err</span>&nbsp;<span class="op" id="4543756">:=</span>&nbsp;<span class="ident" id="4543759">c</span><span class="op" id="4543760">.</span><span class="ident" id="4543761">readRecord</span><span class="op" id="4543771">(</span><span class="ident" id="4543772">recordTypeHandshake</span><span class="op" id="4543791">)</span><span class="op" id="4543792">;</span>&nbsp;<span class="ident" id="4543794">err</span>&nbsp;<span class="op" id="4543798">!=</span>&nbsp;<span class="ident" id="4543801">nil</span>&nbsp;<span class="op" id="4543805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543810">return</span>&nbsp;<span class="ident" id="4543817">nil</span><span class="op" id="4543820">,</span>&nbsp;<span class="ident" id="4543822">err</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4543828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4543831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4543834">data</span>&nbsp;<span class="op" id="4543839">=</span>&nbsp;<span class="ident" id="4543841">c</span><span class="op" id="4543842">.</span><span class="ident" id="4543843">hand</span><span class="op" id="4543847">.</span><span class="ident" id="4543848">Next</span><span class="op" id="4543852">(</span><span class="num" id="4543853">4</span>&nbsp;<span class="op" id="4543855">+</span>&nbsp;<span class="ident" id="4543857">n</span><span class="op" id="4543858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543861">var</span>&nbsp;<span class="ident" id="4543865">m</span>&nbsp;<span class="ident" id="4543867">handshakeMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543885">switch</span>&nbsp;<span class="ident" id="4543892">data</span><span class="op" id="4543896">[</span><span class="num" id="4543897">0</span><span class="op" id="4543898">]</span>&nbsp;<span class="op" id="4543900">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543903">case</span>&nbsp;<span class="ident" id="4543908">typeClientHello</span><span class="op" id="4543923">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4543927">m</span>&nbsp;<span class="op" id="4543929">=</span>&nbsp;<span class="builtinfunc" id="4543931">new</span><span class="op" id="4543934">(</span><span class="ident" id="4543935">clientHelloMsg</span><span class="op" id="4543949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543952">case</span>&nbsp;<span class="ident" id="4543957">typeServerHello</span><span class="op" id="4543972">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4543976">m</span>&nbsp;<span class="op" id="4543978">=</span>&nbsp;<span class="builtinfunc" id="4543980">new</span><span class="op" id="4543983">(</span><span class="ident" id="4543984">serverHelloMsg</span><span class="op" id="4543998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4544001">case</span>&nbsp;<span class="ident" id="4544006">typeNewSessionTicket</span><span class="op" id="4544026">:</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4544030">m</span>&nbsp;<span class="op" id="4544032">=</span>&nbsp;<span class="builtinfunc" id="4544034">new</span><span class="op" id="4544037">(</span><span class="ident" id="4544038">newSessionTicketMsg</span><span class="op" id="4544057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4544060">case</span>&nbsp;<span class="ident" id="4544065">typeCertificate</span><span class="op" id="4544080">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4544084">m</span>&nbsp;<span class="op" id="4544086">=</span>&nbsp;<span class="builtinfunc" id="4544088">new</span><span class="op" id="4544091">(</span><span class="ident" id="4544092">certificateMsg</span><span class="op" id="4544106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4544109">case</span>&nbsp;<span class="ident" id="4544114">typeCertificateRequest</span><span class="op" id="4544136">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4544140">m</span>&nbsp;<span class="op" id="4544142">=</span>&nbsp;<span class="op" id="4544144">&amp;</span><span class="ident" id="4544145">certificateRequestMsg</span><span class="op" id="4544166">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4544171">hasSignatureAndHash</span><span class="op" id="4544190">:</span>&nbsp;<span class="ident" id="4544192">c</span><span class="op" id="4544193">.</span><span class="ident" id="4544194">vers</span>&nbsp;<span class="op" id="4544199">&gt;=</span>&nbsp;<span class="ident" id="4544202">VersionTLS12</span><span class="op" id="4544214">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4544218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4544221">case</span>&nbsp;<span class="ident" id="4544226">typeCertificateStatus</span><span class="op" id="4544247">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4544251">m</span>&nbsp;<span class="op" id="4544253">=</span>&nbsp;<span class="builtinfunc" id="4544255">new</span><span class="op" id="4544258">(</span><span class="ident" id="4544259">certificateStatusMsg</span><span class="op" id="4544279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4544282">case</span>&nbsp;<span class="ident" id="4544287">typeServerKeyExchange</span><span class="op" id="4544308">:</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4544312">m</span>&nbsp;<span class="op" id="4544314">=</span>&nbsp;<span class="builtinfunc" id="4544316">new</span><span class="op" id="4544319">(</span><span class="ident" id="4544320">serverKeyExchangeMsg</span><span class="op" id="4544340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4544343">case</span>&nbsp;<span class="ident" id="4544348">typeServerHelloDone</span><span class="op" id="4544367">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4544371">m</span>&nbsp;<span class="op" id="4544373">=</span>&nbsp;<span class="builtinfunc" id="4544375">new</span><span class="op" id="4544378">(</span><span class="ident" id="4544379">serverHelloDoneMsg</span><span class="op" id="4544397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4544400">case</span>&nbsp;<span class="ident" id="4544405">typeClientKeyExchange</span><span class="op" id="4544426">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4544430">m</span>&nbsp;<span class="op" id="4544432">=</span>&nbsp;<span class="builtinfunc" id="4544434">new</span><span class="op" id="4544437">(</span><span class="ident" id="4544438">clientKeyExchangeMsg</span><span class="op" id="4544458">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4544461">case</span>&nbsp;<span class="ident" id="4544466">typeCertificateVerify</span><span class="op" id="4544487">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4544491">m</span>&nbsp;<span class="op" id="4544493">=</span>&nbsp;<span class="op" id="4544495">&amp;</span><span class="ident" id="4544496">certificateVerifyMsg</span><span class="op" id="4544516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4544521">hasSignatureAndHash</span><span class="op" id="4544540">:</span>&nbsp;<span class="ident" id="4544542">c</span><span class="op" id="4544543">.</span><span class="ident" id="4544544">vers</span>&nbsp;<span class="op" id="4544549">&gt;=</span>&nbsp;<span class="ident" id="4544552">VersionTLS12</span><span class="op" id="4544564">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4544568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4544571">case</span>&nbsp;<span class="ident" id="4544576">typeNextProtocol</span><span class="op" id="4544592">:</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4544596">m</span>&nbsp;<span class="op" id="4544598">=</span>&nbsp;<span class="builtinfunc" id="4544600">new</span><span class="op" id="4544603">(</span><span class="ident" id="4544604">nextProtoMsg</span><span class="op" id="4544616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4544619">case</span>&nbsp;<span class="ident" id="4544624">typeFinished</span><span class="op" id="4544636">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4544640">m</span>&nbsp;<span class="op" id="4544642">=</span>&nbsp;<span class="builtinfunc" id="4544644">new</span><span class="op" id="4544647">(</span><span class="ident" id="4544648">finishedMsg</span><span class="op" id="4544659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4544662">default</span><span class="op" id="4544669">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4544673">return</span>&nbsp;<span class="ident" id="4544680">nil</span><span class="op" id="4544683">,</span>&nbsp;<span class="ident" id="4544685">c</span><span class="op" id="4544686">.</span><span class="ident" id="4544687">in</span><span class="op" id="4544689">.</span><span class="ident" id="4544690">setErrorLocked</span><span class="op" id="4544704">(</span><span class="ident" id="4544705">c</span><span class="op" id="4544706">.</span><span class="ident" id="4544707">sendAlert</span><span class="op" id="4544716">(</span><span class="ident" id="4544717">alertUnexpectedMessage</span><span class="op" id="4544739">)</span><span class="op" id="4544740">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4544743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4544747">//&nbsp;The&nbsp;handshake&nbsp;message&nbsp;unmarshallers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4544787">//&nbsp;expect&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;keep&nbsp;references&nbsp;to&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4544837">//&nbsp;so&nbsp;pass&nbsp;in&nbsp;a&nbsp;fresh&nbsp;copy&nbsp;that&nbsp;won&#39;t&nbsp;be&nbsp;overwritten.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4544892">data</span>&nbsp;<span class="op" id="4544897">=</span>&nbsp;<span class="builtinfunc" id="4544899">append</span><span class="op" id="4544905">(</span><span class="op" id="4544906">[</span><span class="op" id="4544907">]</span><span class="builtintype" id="4544908">byte</span><span class="op" id="4544912">(</span><span class="ident" id="4544913">nil</span><span class="op" id="4544916">)</span><span class="op" id="4544917">,</span>&nbsp;<span class="ident" id="4544919">data</span><span class="op" id="4544923">...</span><span class="op" id="4544926">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4544930">if</span>&nbsp;<span class="op" id="4544933">!</span><span class="ident" id="4544934">m</span><span class="op" id="4544935">.</span><span class="ident" id="4544936">unmarshal</span><span class="op" id="4544945">(</span><span class="ident" id="4544946">data</span><span class="op" id="4544950">)</span>&nbsp;<span class="op" id="4544952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4544956">return</span>&nbsp;<span class="ident" id="4544963">nil</span><span class="op" id="4544966">,</span>&nbsp;<span class="ident" id="4544968">c</span><span class="op" id="4544969">.</span><span class="ident" id="4544970">in</span><span class="op" id="4544972">.</span><span class="ident" id="4544973">setErrorLocked</span><span class="op" id="4544987">(</span><span class="ident" id="4544988">c</span><span class="op" id="4544989">.</span><span class="ident" id="4544990">sendAlert</span><span class="op" id="4544999">(</span><span class="ident" id="4545000">alertUnexpectedMessage</span><span class="op" id="4545022">)</span><span class="op" id="4545023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4545026">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4545029">return</span>&nbsp;<span class="ident" id="4545036">m</span><span class="op" id="4545037">,</span>&nbsp;<span class="ident" id="4545039">nil</span><br>
<span class="lineno"></span><span class="op" id="4545043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4545046">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4545086">func</span>&nbsp;<span class="op" id="4545091">(</span><span class="ident" id="4545092">c</span>&nbsp;<span class="op" id="4545094">*</span><span class="ident" id="4545095">Conn</span><span class="op" id="4545099">)</span>&nbsp;<span class="ident" id="4545101">Write</span><span class="op" id="4545106">(</span><span class="ident" id="4545107">b</span>&nbsp;<span class="op" id="4545109">[</span><span class="op" id="4545110">]</span><span class="builtintype" id="4545111">byte</span><span class="op" id="4545115">)</span>&nbsp;<span class="op" id="4545117">(</span><span class="builtintype" id="4545118">int</span><span class="op" id="4545121">,</span>&nbsp;<span class="builtintype" id="4545123">error</span><span class="op" id="4545128">)</span>&nbsp;<span class="op" id="4545130">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4545133">if</span>&nbsp;<span class="ident" id="4545136">err</span>&nbsp;<span class="op" id="4545140">:=</span>&nbsp;<span class="ident" id="4545143">c</span><span class="op" id="4545144">.</span><span class="ident" id="4545145">Handshake</span><span class="op" id="4545154">(</span><span class="op" id="4545155">)</span><span class="op" id="4545156">;</span>&nbsp;<span class="ident" id="4545158">err</span>&nbsp;<span class="op" id="4545162">!=</span>&nbsp;<span class="ident" id="4545165">nil</span>&nbsp;<span class="op" id="4545169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4545173">return</span>&nbsp;<span class="num" id="4545180">0</span><span class="op" id="4545181">,</span>&nbsp;<span class="ident" id="4545183">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4545188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4545192">c</span><span class="op" id="4545193">.</span><span class="ident" id="4545194">out</span><span class="op" id="4545197">.</span><span class="ident" id="4545198">Lock</span><span class="op" id="4545202">(</span><span class="op" id="4545203">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4545206">defer</span>&nbsp;<span class="ident" id="4545212">c</span><span class="op" id="4545213">.</span><span class="ident" id="4545214">out</span><span class="op" id="4545217">.</span><span class="ident" id="4545218">Unlock</span><span class="op" id="4545224">(</span><span class="op" id="4545225">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4545229">if</span>&nbsp;<span class="ident" id="4545232">err</span>&nbsp;<span class="op" id="4545236">:=</span>&nbsp;<span class="ident" id="4545239">c</span><span class="op" id="4545240">.</span><span class="ident" id="4545241">out</span><span class="op" id="4545244">.</span><span class="ident" id="4545245">err</span><span class="op" id="4545248">;</span>&nbsp;<span class="ident" id="4545250">err</span>&nbsp;<span class="op" id="4545254">!=</span>&nbsp;<span class="ident" id="4545257">nil</span>&nbsp;<span class="op" id="4545261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4545265">return</span>&nbsp;<span class="num" id="4545272">0</span><span class="op" id="4545273">,</span>&nbsp;<span class="ident" id="4545275">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4545280">}</span><br>
<span class="lineno">855</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4545284">if</span>&nbsp;<span class="op" id="4545287">!</span><span class="ident" id="4545288">c</span><span class="op" id="4545289">.</span><span class="ident" id="4545290">handshakeComplete</span>&nbsp;<span class="op" id="4545308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4545312">return</span>&nbsp;<span class="num" id="4545319">0</span><span class="op" id="4545320">,</span>&nbsp;<span class="ident" id="4545322">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4545342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4545346">//&nbsp;SSL&nbsp;3.0&nbsp;and&nbsp;TLS&nbsp;1.0&nbsp;are&nbsp;susceptible&nbsp;to&nbsp;a&nbsp;chosen-plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4545408">//&nbsp;attack&nbsp;when&nbsp;using&nbsp;block&nbsp;mode&nbsp;ciphers&nbsp;due&nbsp;to&nbsp;predictable&nbsp;IVs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4545473">//&nbsp;This&nbsp;can&nbsp;be&nbsp;prevented&nbsp;by&nbsp;splitting&nbsp;each&nbsp;Application&nbsp;Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4545534">//&nbsp;record&nbsp;into&nbsp;two&nbsp;records,&nbsp;effectively&nbsp;randomizing&nbsp;the&nbsp;IV.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4545595">//</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4545599">//&nbsp;http://www.openssl.org/~bodo/tls-cbc.txt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4545644">//&nbsp;https://bugzilla.mozilla.org/show_bug.cgi?id=665814</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4545700">//&nbsp;http://www.imperialviolet.org/2012/01/15/beastfollowup.html</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4545765">var</span>&nbsp;<span class="ident" id="4545769">m</span>&nbsp;<span class="builtintype" id="4545771">int</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4545776">if</span>&nbsp;<span class="builtinfunc" id="4545779">len</span><span class="op" id="4545782">(</span><span class="ident" id="4545783">b</span><span class="op" id="4545784">)</span>&nbsp;<span class="op" id="4545786">&gt;</span>&nbsp;<span class="num" id="4545788">1</span>&nbsp;<span class="op" id="4545790">&amp;&amp;</span>&nbsp;<span class="ident" id="4545793">c</span><span class="op" id="4545794">.</span><span class="ident" id="4545795">vers</span>&nbsp;<span class="op" id="4545800">&lt;=</span>&nbsp;<span class="ident" id="4545803">VersionTLS10</span>&nbsp;<span class="op" id="4545816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4545820">if</span>&nbsp;<span class="ident" id="4545823">_</span><span class="op" id="4545824">,</span>&nbsp;<span class="ident" id="4545826">ok</span>&nbsp;<span class="op" id="4545829">:=</span>&nbsp;<span class="ident" id="4545832">c</span><span class="op" id="4545833">.</span><span class="ident" id="4545834">out</span><span class="op" id="4545837">.</span><span class="ident" id="4545838">cipher</span><span class="op" id="4545844">.</span><span class="op" id="4545845">(</span><span class="ident" id="4545846">cipher</span><span class="op" id="4545852">.</span><span class="ident" id="4545853">BlockMode</span><span class="op" id="4545862">)</span><span class="op" id="4545863">;</span>&nbsp;<span class="ident" id="4545865">ok</span>&nbsp;<span class="op" id="4545868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4545873">n</span><span class="op" id="4545874">,</span>&nbsp;<span class="ident" id="4545876">err</span>&nbsp;<span class="op" id="4545880">:=</span>&nbsp;<span class="ident" id="4545883">c</span><span class="op" id="4545884">.</span><span class="ident" id="4545885">writeRecord</span><span class="op" id="4545896">(</span><span class="ident" id="4545897">recordTypeApplicationData</span><span class="op" id="4545922">,</span>&nbsp;<span class="ident" id="4545924">b</span><span class="op" id="4545925">[</span><span class="op" id="4545926">:</span><span class="num" id="4545927">1</span><span class="op" id="4545928">]</span><span class="op" id="4545929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4545934">if</span>&nbsp;<span class="ident" id="4545937">err</span>&nbsp;<span class="op" id="4545941">!=</span>&nbsp;<span class="ident" id="4545944">nil</span>&nbsp;<span class="op" id="4545948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4545954">return</span>&nbsp;<span class="ident" id="4545961">n</span><span class="op" id="4545962">,</span>&nbsp;<span class="ident" id="4545964">c</span><span class="op" id="4545965">.</span><span class="ident" id="4545966">out</span><span class="op" id="4545969">.</span><span class="ident" id="4545970">setErrorLocked</span><span class="op" id="4545984">(</span><span class="ident" id="4545985">err</span><span class="op" id="4545988">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4545993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4545998">m</span><span class="op" id="4545999">,</span>&nbsp;<span class="ident" id="4546001">b</span>&nbsp;<span class="op" id="4546003">=</span>&nbsp;<span class="num" id="4546005">1</span><span class="op" id="4546006">,</span>&nbsp;<span class="ident" id="4546008">b</span><span class="op" id="4546009">[</span><span class="num" id="4546010">1</span><span class="op" id="4546011">:</span><span class="op" id="4546012">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4546016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4546019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4546023">n</span><span class="op" id="4546024">,</span>&nbsp;<span class="ident" id="4546026">err</span>&nbsp;<span class="op" id="4546030">:=</span>&nbsp;<span class="ident" id="4546033">c</span><span class="op" id="4546034">.</span><span class="ident" id="4546035">writeRecord</span><span class="op" id="4546046">(</span><span class="ident" id="4546047">recordTypeApplicationData</span><span class="op" id="4546072">,</span>&nbsp;<span class="ident" id="4546074">b</span><span class="op" id="4546075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4546078">return</span>&nbsp;<span class="ident" id="4546085">n</span>&nbsp;<span class="op" id="4546087">+</span>&nbsp;<span class="ident" id="4546089">m</span><span class="op" id="4546090">,</span>&nbsp;<span class="ident" id="4546092">c</span><span class="op" id="4546093">.</span><span class="ident" id="4546094">out</span><span class="op" id="4546097">.</span><span class="ident" id="4546098">setErrorLocked</span><span class="op" id="4546112">(</span><span class="ident" id="4546113">err</span><span class="op" id="4546116">)</span><br>
<span class="lineno"></span><span class="op" id="4546118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4546121">//&nbsp;Read&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;a&nbsp;net.Error&nbsp;with&nbsp;Timeout()&nbsp;==&nbsp;true</span><br>
<span class="lineno">885</span><span class="comment" id="4546199">//&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and&nbsp;SetReadDeadline.</span><br>
<span class="lineno"></span><span class="keyword" id="4546265">func</span>&nbsp;<span class="op" id="4546270">(</span><span class="ident" id="4546271">c</span>&nbsp;<span class="op" id="4546273">*</span><span class="ident" id="4546274">Conn</span><span class="op" id="4546278">)</span>&nbsp;<span class="ident" id="4546280">Read</span><span class="op" id="4546284">(</span><span class="ident" id="4546285">b</span>&nbsp;<span class="op" id="4546287">[</span><span class="op" id="4546288">]</span><span class="builtintype" id="4546289">byte</span><span class="op" id="4546293">)</span>&nbsp;<span class="op" id="4546295">(</span><span class="ident" id="4546296">n</span>&nbsp;<span class="builtintype" id="4546298">int</span><span class="op" id="4546301">,</span>&nbsp;<span class="ident" id="4546303">err</span>&nbsp;<span class="builtintype" id="4546307">error</span><span class="op" id="4546312">)</span>&nbsp;<span class="op" id="4546314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4546317">if</span>&nbsp;<span class="ident" id="4546320">err</span>&nbsp;<span class="op" id="4546324">=</span>&nbsp;<span class="ident" id="4546326">c</span><span class="op" id="4546327">.</span><span class="ident" id="4546328">Handshake</span><span class="op" id="4546337">(</span><span class="op" id="4546338">)</span><span class="op" id="4546339">;</span>&nbsp;<span class="ident" id="4546341">err</span>&nbsp;<span class="op" id="4546345">!=</span>&nbsp;<span class="ident" id="4546348">nil</span>&nbsp;<span class="op" id="4546352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4546356">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4546364">}</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4546367">if</span>&nbsp;<span class="builtinfunc" id="4546370">len</span><span class="op" id="4546373">(</span><span class="ident" id="4546374">b</span><span class="op" id="4546375">)</span>&nbsp;<span class="op" id="4546377">==</span>&nbsp;<span class="num" id="4546380">0</span>&nbsp;<span class="op" id="4546382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4546386">//&nbsp;Put&nbsp;this&nbsp;after&nbsp;Handshake,&nbsp;in&nbsp;case&nbsp;people&nbsp;were&nbsp;calling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4546445">//&nbsp;Read(nil)&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of&nbsp;the&nbsp;Handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4546498">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4546506">}</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4546510">c</span><span class="op" id="4546511">.</span><span class="ident" id="4546512">in</span><span class="op" id="4546514">.</span><span class="ident" id="4546515">Lock</span><span class="op" id="4546519">(</span><span class="op" id="4546520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4546523">defer</span>&nbsp;<span class="ident" id="4546529">c</span><span class="op" id="4546530">.</span><span class="ident" id="4546531">in</span><span class="op" id="4546533">.</span><span class="ident" id="4546534">Unlock</span><span class="op" id="4546540">(</span><span class="op" id="4546541">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4546545">//&nbsp;Some&nbsp;OpenSSL&nbsp;servers&nbsp;send&nbsp;empty&nbsp;records&nbsp;in&nbsp;order&nbsp;to&nbsp;randomize&nbsp;the</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4546615">//&nbsp;CBC&nbsp;IV.&nbsp;So&nbsp;this&nbsp;loop&nbsp;ignores&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;empty&nbsp;records.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4546683">const</span>&nbsp;<span class="ident" id="4546689">maxConsecutiveEmptyRecords</span>&nbsp;<span class="op" id="4546716">=</span>&nbsp;<span class="num" id="4546718">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4546723">for</span>&nbsp;<span class="ident" id="4546727">emptyRecordCount</span>&nbsp;<span class="op" id="4546744">:=</span>&nbsp;<span class="num" id="4546747">0</span><span class="op" id="4546748">;</span>&nbsp;<span class="ident" id="4546750">emptyRecordCount</span>&nbsp;<span class="op" id="4546767">&lt;=</span>&nbsp;<span class="ident" id="4546770">maxConsecutiveEmptyRecords</span><span class="op" id="4546796">;</span>&nbsp;<span class="ident" id="4546798">emptyRecordCount</span><span class="op" id="4546814">++</span>&nbsp;<span class="op" id="4546817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4546821">for</span>&nbsp;<span class="ident" id="4546825">c</span><span class="op" id="4546826">.</span><span class="ident" id="4546827">input</span>&nbsp;<span class="op" id="4546833">==</span>&nbsp;<span class="ident" id="4546836">nil</span>&nbsp;<span class="op" id="4546840">&amp;&amp;</span>&nbsp;<span class="ident" id="4546843">c</span><span class="op" id="4546844">.</span><span class="ident" id="4546845">in</span><span class="op" id="4546847">.</span><span class="ident" id="4546848">err</span>&nbsp;<span class="op" id="4546852">==</span>&nbsp;<span class="ident" id="4546855">nil</span>&nbsp;<span class="op" id="4546859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4546864">if</span>&nbsp;<span class="ident" id="4546867">err</span>&nbsp;<span class="op" id="4546871">:=</span>&nbsp;<span class="ident" id="4546874">c</span><span class="op" id="4546875">.</span><span class="ident" id="4546876">readRecord</span><span class="op" id="4546886">(</span><span class="ident" id="4546887">recordTypeApplicationData</span><span class="op" id="4546912">)</span><span class="op" id="4546913">;</span>&nbsp;<span class="ident" id="4546915">err</span>&nbsp;<span class="op" id="4546919">!=</span>&nbsp;<span class="ident" id="4546922">nil</span>&nbsp;<span class="op" id="4546926">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4546932">//&nbsp;Soft&nbsp;error,&nbsp;like&nbsp;EAGAIN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4546963">return</span>&nbsp;<span class="num" id="4546970">0</span><span class="op" id="4546971">,</span>&nbsp;<span class="ident" id="4546973">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4546980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4546984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4546988">if</span>&nbsp;<span class="ident" id="4546991">err</span>&nbsp;<span class="op" id="4546995">:=</span>&nbsp;<span class="ident" id="4546998">c</span><span class="op" id="4546999">.</span><span class="ident" id="4547000">in</span><span class="op" id="4547002">.</span><span class="ident" id="4547003">err</span><span class="op" id="4547006">;</span>&nbsp;<span class="ident" id="4547008">err</span>&nbsp;<span class="op" id="4547012">!=</span>&nbsp;<span class="ident" id="4547015">nil</span>&nbsp;<span class="op" id="4547019">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4547024">return</span>&nbsp;<span class="num" id="4547031">0</span><span class="op" id="4547032">,</span>&nbsp;<span class="ident" id="4547034">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4547040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4547045">n</span><span class="op" id="4547046">,</span>&nbsp;<span class="ident" id="4547048">err</span>&nbsp;<span class="op" id="4547052">=</span>&nbsp;<span class="ident" id="4547054">c</span><span class="op" id="4547055">.</span><span class="ident" id="4547056">input</span><span class="op" id="4547061">.</span><span class="ident" id="4547062">Read</span><span class="op" id="4547066">(</span><span class="ident" id="4547067">b</span><span class="op" id="4547068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4547072">if</span>&nbsp;<span class="ident" id="4547075">c</span><span class="op" id="4547076">.</span><span class="ident" id="4547077">input</span><span class="op" id="4547082">.</span><span class="ident" id="4547083">off</span>&nbsp;<span class="op" id="4547087">&gt;=</span>&nbsp;<span class="builtinfunc" id="4547090">len</span><span class="op" id="4547093">(</span><span class="ident" id="4547094">c</span><span class="op" id="4547095">.</span><span class="ident" id="4547096">input</span><span class="op" id="4547101">.</span><span class="ident" id="4547102">data</span><span class="op" id="4547106">)</span>&nbsp;<span class="op" id="4547108">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4547113">c</span><span class="op" id="4547114">.</span><span class="ident" id="4547115">in</span><span class="op" id="4547117">.</span><span class="ident" id="4547118">freeBlock</span><span class="op" id="4547127">(</span><span class="ident" id="4547128">c</span><span class="op" id="4547129">.</span><span class="ident" id="4547130">input</span><span class="op" id="4547135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4547140">c</span><span class="op" id="4547141">.</span><span class="ident" id="4547142">input</span>&nbsp;<span class="op" id="4547148">=</span>&nbsp;<span class="ident" id="4547150">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4547156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4547161">//&nbsp;If&nbsp;a&nbsp;close-notify&nbsp;alert&nbsp;is&nbsp;waiting,&nbsp;read&nbsp;it&nbsp;so&nbsp;that</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4547218">//&nbsp;we&nbsp;can&nbsp;return&nbsp;(n,&nbsp;EOF)&nbsp;instead&nbsp;of&nbsp;(n,&nbsp;nil),&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4547277">//&nbsp;to&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4547330">//&nbsp;connection&nbsp;is&nbsp;now&nbsp;closed.&nbsp;This&nbsp;eliminates&nbsp;a&nbsp;race</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4547384">//&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4547437">//&nbsp;otherwise&nbsp;not&nbsp;observe&nbsp;the&nbsp;EOF&nbsp;until&nbsp;its&nbsp;next&nbsp;read,</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4547493">//&nbsp;by&nbsp;which&nbsp;time&nbsp;a&nbsp;client&nbsp;goroutine&nbsp;might&nbsp;have&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4547550">//&nbsp;tried&nbsp;to&nbsp;reuse&nbsp;the&nbsp;HTTP&nbsp;connection&nbsp;for&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4547600">//&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4547614">//&nbsp;See&nbsp;https://codereview.appspot.com/76400046</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4547663">//&nbsp;and&nbsp;http://golang.org/issue/3514</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4547701">if</span>&nbsp;<span class="ident" id="4547704">ri</span>&nbsp;<span class="op" id="4547707">:=</span>&nbsp;<span class="ident" id="4547710">c</span><span class="op" id="4547711">.</span><span class="ident" id="4547712">rawInput</span><span class="op" id="4547720">;</span>&nbsp;<span class="ident" id="4547722">ri</span>&nbsp;<span class="op" id="4547725">!=</span>&nbsp;<span class="ident" id="4547728">nil</span>&nbsp;<span class="op" id="4547732">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4547738">n</span>&nbsp;<span class="op" id="4547740">!=</span>&nbsp;<span class="num" id="4547743">0</span>&nbsp;<span class="op" id="4547745">&amp;&amp;</span>&nbsp;<span class="ident" id="4547748">err</span>&nbsp;<span class="op" id="4547752">==</span>&nbsp;<span class="ident" id="4547755">nil</span>&nbsp;<span class="op" id="4547759">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4547765">c</span><span class="op" id="4547766">.</span><span class="ident" id="4547767">input</span>&nbsp;<span class="op" id="4547773">==</span>&nbsp;<span class="ident" id="4547776">nil</span>&nbsp;<span class="op" id="4547780">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4547783">len</span><span class="op" id="4547786">(</span><span class="ident" id="4547787">ri</span><span class="op" id="4547789">.</span><span class="ident" id="4547790">data</span><span class="op" id="4547794">)</span>&nbsp;<span class="op" id="4547796">&gt;</span>&nbsp;<span class="num" id="4547798">0</span>&nbsp;<span class="op" id="4547800">&amp;&amp;</span>&nbsp;<span class="ident" id="4547803">recordType</span><span class="op" id="4547813">(</span><span class="ident" id="4547814">ri</span><span class="op" id="4547816">.</span><span class="ident" id="4547817">data</span><span class="op" id="4547821">[</span><span class="num" id="4547822">0</span><span class="op" id="4547823">]</span><span class="op" id="4547824">)</span>&nbsp;<span class="op" id="4547826">==</span>&nbsp;<span class="ident" id="4547829">recordTypeAlert</span>&nbsp;<span class="op" id="4547845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4547850">if</span>&nbsp;<span class="ident" id="4547853">recErr</span>&nbsp;<span class="op" id="4547860">:=</span>&nbsp;<span class="ident" id="4547863">c</span><span class="op" id="4547864">.</span><span class="ident" id="4547865">readRecord</span><span class="op" id="4547875">(</span><span class="ident" id="4547876">recordTypeApplicationData</span><span class="op" id="4547901">)</span><span class="op" id="4547902">;</span>&nbsp;<span class="ident" id="4547904">recErr</span>&nbsp;<span class="op" id="4547911">!=</span>&nbsp;<span class="ident" id="4547914">nil</span>&nbsp;<span class="op" id="4547918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4547924">err</span>&nbsp;<span class="op" id="4547928">=</span>&nbsp;<span class="ident" id="4547930">recErr</span>&nbsp;<span class="comment" id="4547937">//&nbsp;will&nbsp;be&nbsp;io.EOF&nbsp;on&nbsp;closeNotify</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4547973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4547977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4547982">if</span>&nbsp;<span class="ident" id="4547985">n</span>&nbsp;<span class="op" id="4547987">!=</span>&nbsp;<span class="num" id="4547990">0</span>&nbsp;<span class="op" id="4547992">||</span>&nbsp;<span class="ident" id="4547995">err</span>&nbsp;<span class="op" id="4547999">!=</span>&nbsp;<span class="ident" id="4548002">nil</span>&nbsp;<span class="op" id="4548006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4548011">return</span>&nbsp;<span class="ident" id="4548018">n</span><span class="op" id="4548019">,</span>&nbsp;<span class="ident" id="4548021">err</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4548027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4548030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4548034">return</span>&nbsp;<span class="num" id="4548041">0</span><span class="op" id="4548042">,</span>&nbsp;<span class="ident" id="4548044">io</span><span class="op" id="4548046">.</span><span class="ident" id="4548047">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="4548061">}</span><br>
<span class="lineno">945</span><br>
<span class="lineno"></span><span class="comment" id="4548064">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4548096">func</span>&nbsp;<span class="op" id="4548101">(</span><span class="ident" id="4548102">c</span>&nbsp;<span class="op" id="4548104">*</span><span class="ident" id="4548105">Conn</span><span class="op" id="4548109">)</span>&nbsp;<span class="ident" id="4548111">Close</span><span class="op" id="4548116">(</span><span class="op" id="4548117">)</span>&nbsp;<span class="builtintype" id="4548119">error</span>&nbsp;<span class="op" id="4548125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4548128">var</span>&nbsp;<span class="ident" id="4548132">alertErr</span>&nbsp;<span class="builtintype" id="4548141">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548149">c</span><span class="op" id="4548150">.</span><span class="ident" id="4548151">handshakeMutex</span><span class="op" id="4548165">.</span><span class="ident" id="4548166">Lock</span><span class="op" id="4548170">(</span><span class="op" id="4548171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4548174">defer</span>&nbsp;<span class="ident" id="4548180">c</span><span class="op" id="4548181">.</span><span class="ident" id="4548182">handshakeMutex</span><span class="op" id="4548196">.</span><span class="ident" id="4548197">Unlock</span><span class="op" id="4548203">(</span><span class="op" id="4548204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4548207">if</span>&nbsp;<span class="ident" id="4548210">c</span><span class="op" id="4548211">.</span><span class="ident" id="4548212">handshakeComplete</span>&nbsp;<span class="op" id="4548230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548234">alertErr</span>&nbsp;<span class="op" id="4548243">=</span>&nbsp;<span class="ident" id="4548245">c</span><span class="op" id="4548246">.</span><span class="ident" id="4548247">sendAlert</span><span class="op" id="4548256">(</span><span class="ident" id="4548257">alertCloseNotify</span><span class="op" id="4548273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4548276">}</span><br>
<span class="lineno">955</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4548280">if</span>&nbsp;<span class="ident" id="4548283">err</span>&nbsp;<span class="op" id="4548287">:=</span>&nbsp;<span class="ident" id="4548290">c</span><span class="op" id="4548291">.</span><span class="ident" id="4548292">conn</span><span class="op" id="4548296">.</span><span class="ident" id="4548297">Close</span><span class="op" id="4548302">(</span><span class="op" id="4548303">)</span><span class="op" id="4548304">;</span>&nbsp;<span class="ident" id="4548306">err</span>&nbsp;<span class="op" id="4548310">!=</span>&nbsp;<span class="ident" id="4548313">nil</span>&nbsp;<span class="op" id="4548317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4548321">return</span>&nbsp;<span class="ident" id="4548328">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4548333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4548336">return</span>&nbsp;<span class="ident" id="4548343">alertErr</span><br>
<span class="lineno">960</span><span class="op" id="4548352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4548355">//&nbsp;Handshake&nbsp;runs&nbsp;the&nbsp;client&nbsp;or&nbsp;server&nbsp;handshake</span><br>
<span class="lineno"></span><span class="comment" id="4548404">//&nbsp;protocol&nbsp;if&nbsp;it&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="4548444">//&nbsp;Most&nbsp;uses&nbsp;of&nbsp;this&nbsp;package&nbsp;need&nbsp;not&nbsp;call&nbsp;Handshake</span><br>
<span class="lineno">965</span><span class="comment" id="4548497">//&nbsp;explicitly:&nbsp;the&nbsp;first&nbsp;Read&nbsp;or&nbsp;Write&nbsp;will&nbsp;call&nbsp;it&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="4548564">func</span>&nbsp;<span class="op" id="4548569">(</span><span class="ident" id="4548570">c</span>&nbsp;<span class="op" id="4548572">*</span><span class="ident" id="4548573">Conn</span><span class="op" id="4548577">)</span>&nbsp;<span class="ident" id="4548579">Handshake</span><span class="op" id="4548588">(</span><span class="op" id="4548589">)</span>&nbsp;<span class="builtintype" id="4548591">error</span>&nbsp;<span class="op" id="4548597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548600">c</span><span class="op" id="4548601">.</span><span class="ident" id="4548602">handshakeMutex</span><span class="op" id="4548616">.</span><span class="ident" id="4548617">Lock</span><span class="op" id="4548621">(</span><span class="op" id="4548622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4548625">defer</span>&nbsp;<span class="ident" id="4548631">c</span><span class="op" id="4548632">.</span><span class="ident" id="4548633">handshakeMutex</span><span class="op" id="4548647">.</span><span class="ident" id="4548648">Unlock</span><span class="op" id="4548654">(</span><span class="op" id="4548655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4548658">if</span>&nbsp;<span class="ident" id="4548661">err</span>&nbsp;<span class="op" id="4548665">:=</span>&nbsp;<span class="ident" id="4548668">c</span><span class="op" id="4548669">.</span><span class="ident" id="4548670">handshakeErr</span><span class="op" id="4548682">;</span>&nbsp;<span class="ident" id="4548684">err</span>&nbsp;<span class="op" id="4548688">!=</span>&nbsp;<span class="ident" id="4548691">nil</span>&nbsp;<span class="op" id="4548695">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4548699">return</span>&nbsp;<span class="ident" id="4548706">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4548711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4548714">if</span>&nbsp;<span class="ident" id="4548717">c</span><span class="op" id="4548718">.</span><span class="ident" id="4548719">handshakeComplete</span>&nbsp;<span class="op" id="4548737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4548741">return</span>&nbsp;<span class="ident" id="4548748">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4548753">}</span><br>
<span class="lineno">975</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4548757">if</span>&nbsp;<span class="ident" id="4548760">c</span><span class="op" id="4548761">.</span><span class="ident" id="4548762">isClient</span>&nbsp;<span class="op" id="4548771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548775">c</span><span class="op" id="4548776">.</span><span class="ident" id="4548777">handshakeErr</span>&nbsp;<span class="op" id="4548790">=</span>&nbsp;<span class="ident" id="4548792">c</span><span class="op" id="4548793">.</span><span class="ident" id="4548794">clientHandshake</span><span class="op" id="4548809">(</span><span class="op" id="4548810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4548813">}</span>&nbsp;<span class="keyword" id="4548815">else</span>&nbsp;<span class="op" id="4548820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548824">c</span><span class="op" id="4548825">.</span><span class="ident" id="4548826">handshakeErr</span>&nbsp;<span class="op" id="4548839">=</span>&nbsp;<span class="ident" id="4548841">c</span><span class="op" id="4548842">.</span><span class="ident" id="4548843">serverHandshake</span><span class="op" id="4548858">(</span><span class="op" id="4548859">)</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4548862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4548865">return</span>&nbsp;<span class="ident" id="4548872">c</span><span class="op" id="4548873">.</span><span class="ident" id="4548874">handshakeErr</span><br>
<span class="lineno"></span><span class="op" id="4548887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4548890">//&nbsp;ConnectionState&nbsp;returns&nbsp;basic&nbsp;TLS&nbsp;details&nbsp;about&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">985</span><span class="keyword" id="4548957">func</span>&nbsp;<span class="op" id="4548962">(</span><span class="ident" id="4548963">c</span>&nbsp;<span class="op" id="4548965">*</span><span class="ident" id="4548966">Conn</span><span class="op" id="4548970">)</span>&nbsp;<span class="ident" id="4548972">ConnectionState</span><span class="op" id="4548987">(</span><span class="op" id="4548988">)</span>&nbsp;<span class="ident" id="4548990">ConnectionState</span>&nbsp;<span class="op" id="4549006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549009">c</span><span class="op" id="4549010">.</span><span class="ident" id="4549011">handshakeMutex</span><span class="op" id="4549025">.</span><span class="ident" id="4549026">Lock</span><span class="op" id="4549030">(</span><span class="op" id="4549031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4549034">defer</span>&nbsp;<span class="ident" id="4549040">c</span><span class="op" id="4549041">.</span><span class="ident" id="4549042">handshakeMutex</span><span class="op" id="4549056">.</span><span class="ident" id="4549057">Unlock</span><span class="op" id="4549063">(</span><span class="op" id="4549064">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4549068">var</span>&nbsp;<span class="ident" id="4549072">state</span>&nbsp;<span class="ident" id="4549078">ConnectionState</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549095">state</span><span class="op" id="4549100">.</span><span class="ident" id="4549101">HandshakeComplete</span>&nbsp;<span class="op" id="4549119">=</span>&nbsp;<span class="ident" id="4549121">c</span><span class="op" id="4549122">.</span><span class="ident" id="4549123">handshakeComplete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4549142">if</span>&nbsp;<span class="ident" id="4549145">c</span><span class="op" id="4549146">.</span><span class="ident" id="4549147">handshakeComplete</span>&nbsp;<span class="op" id="4549165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549169">state</span><span class="op" id="4549174">.</span><span class="ident" id="4549175">Version</span>&nbsp;<span class="op" id="4549183">=</span>&nbsp;<span class="ident" id="4549185">c</span><span class="op" id="4549186">.</span><span class="ident" id="4549187">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549194">state</span><span class="op" id="4549199">.</span><span class="ident" id="4549200">NegotiatedProtocol</span>&nbsp;<span class="op" id="4549219">=</span>&nbsp;<span class="ident" id="4549221">c</span><span class="op" id="4549222">.</span><span class="ident" id="4549223">clientProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549240">state</span><span class="op" id="4549245">.</span><span class="ident" id="4549246">DidResume</span>&nbsp;<span class="op" id="4549256">=</span>&nbsp;<span class="ident" id="4549258">c</span><span class="op" id="4549259">.</span><span class="ident" id="4549260">didResume</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549272">state</span><span class="op" id="4549277">.</span><span class="ident" id="4549278">NegotiatedProtocolIsMutual</span>&nbsp;<span class="op" id="4549305">=</span>&nbsp;<span class="op" id="4549307">!</span><span class="ident" id="4549308">c</span><span class="op" id="4549309">.</span><span class="ident" id="4549310">clientProtocolFallback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549335">state</span><span class="op" id="4549340">.</span><span class="ident" id="4549341">CipherSuite</span>&nbsp;<span class="op" id="4549353">=</span>&nbsp;<span class="ident" id="4549355">c</span><span class="op" id="4549356">.</span><span class="ident" id="4549357">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549371">state</span><span class="op" id="4549376">.</span><span class="ident" id="4549377">PeerCertificates</span>&nbsp;<span class="op" id="4549394">=</span>&nbsp;<span class="ident" id="4549396">c</span><span class="op" id="4549397">.</span><span class="ident" id="4549398">peerCertificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549417">state</span><span class="op" id="4549422">.</span><span class="ident" id="4549423">VerifiedChains</span>&nbsp;<span class="op" id="4549438">=</span>&nbsp;<span class="ident" id="4549440">c</span><span class="op" id="4549441">.</span><span class="ident" id="4549442">verifiedChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549459">state</span><span class="op" id="4549464">.</span><span class="ident" id="4549465">ServerName</span>&nbsp;<span class="op" id="4549476">=</span>&nbsp;<span class="ident" id="4549478">c</span><span class="op" id="4549479">.</span><span class="ident" id="4549480">serverName</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4549493">if</span>&nbsp;<span class="op" id="4549496">!</span><span class="ident" id="4549497">c</span><span class="op" id="4549498">.</span><span class="ident" id="4549499">didResume</span>&nbsp;<span class="op" id="4549509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549514">state</span><span class="op" id="4549519">.</span><span class="ident" id="4549520">TLSUnique</span>&nbsp;<span class="op" id="4549530">=</span>&nbsp;<span class="ident" id="4549532">c</span><span class="op" id="4549533">.</span><span class="ident" id="4549534">firstFinished</span><span class="op" id="4549547">[</span><span class="op" id="4549548">:</span><span class="op" id="4549549">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4549553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4549556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4549560">return</span>&nbsp;<span class="ident" id="4549567">state</span><br>
<span class="lineno"></span><span class="op" id="4549573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4549576">//&nbsp;OCSPResponse&nbsp;returns&nbsp;the&nbsp;stapled&nbsp;OCSP&nbsp;response&nbsp;from&nbsp;the&nbsp;TLS&nbsp;server,&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4549650">//&nbsp;any.&nbsp;(Only&nbsp;valid&nbsp;for&nbsp;client&nbsp;connections.)</span><br>
<span class="lineno">1010</span><span class="keyword" id="4549695">func</span>&nbsp;<span class="op" id="4549700">(</span><span class="ident" id="4549701">c</span>&nbsp;<span class="op" id="4549703">*</span><span class="ident" id="4549704">Conn</span><span class="op" id="4549708">)</span>&nbsp;<span class="ident" id="4549710">OCSPResponse</span><span class="op" id="4549722">(</span><span class="op" id="4549723">)</span>&nbsp;<span class="op" id="4549725">[</span><span class="op" id="4549726">]</span><span class="builtintype" id="4549727">byte</span>&nbsp;<span class="op" id="4549732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549735">c</span><span class="op" id="4549736">.</span><span class="ident" id="4549737">handshakeMutex</span><span class="op" id="4549751">.</span><span class="ident" id="4549752">Lock</span><span class="op" id="4549756">(</span><span class="op" id="4549757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4549760">defer</span>&nbsp;<span class="ident" id="4549766">c</span><span class="op" id="4549767">.</span><span class="ident" id="4549768">handshakeMutex</span><span class="op" id="4549782">.</span><span class="ident" id="4549783">Unlock</span><span class="op" id="4549789">(</span><span class="op" id="4549790">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4549794">return</span>&nbsp;<span class="ident" id="4549801">c</span><span class="op" id="4549802">.</span><span class="ident" id="4549803">ocspResponse</span><br>
<span class="lineno">1015</span><span class="op" id="4549816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4549819">//&nbsp;VerifyHostname&nbsp;checks&nbsp;that&nbsp;the&nbsp;peer&nbsp;certificate&nbsp;chain&nbsp;is&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4549889">//&nbsp;connecting&nbsp;to&nbsp;host.&nbsp;&nbsp;If&nbsp;so,&nbsp;it&nbsp;returns&nbsp;nil;&nbsp;if&nbsp;not,&nbsp;it&nbsp;returns&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4549964">//&nbsp;describing&nbsp;the&nbsp;problem.</span><br>
<span class="lineno">1020</span><span class="keyword" id="4549991">func</span>&nbsp;<span class="op" id="4549996">(</span><span class="ident" id="4549997">c</span>&nbsp;<span class="op" id="4549999">*</span><span class="ident" id="4550000">Conn</span><span class="op" id="4550004">)</span>&nbsp;<span class="ident" id="4550006">VerifyHostname</span><span class="op" id="4550020">(</span><span class="ident" id="4550021">host</span>&nbsp;<span class="builtintype" id="4550026">string</span><span class="op" id="4550032">)</span>&nbsp;<span class="builtintype" id="4550034">error</span>&nbsp;<span class="op" id="4550040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550043">c</span><span class="op" id="4550044">.</span><span class="ident" id="4550045">handshakeMutex</span><span class="op" id="4550059">.</span><span class="ident" id="4550060">Lock</span><span class="op" id="4550064">(</span><span class="op" id="4550065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4550068">defer</span>&nbsp;<span class="ident" id="4550074">c</span><span class="op" id="4550075">.</span><span class="ident" id="4550076">handshakeMutex</span><span class="op" id="4550090">.</span><span class="ident" id="4550091">Unlock</span><span class="op" id="4550097">(</span><span class="op" id="4550098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4550101">if</span>&nbsp;<span class="op" id="4550104">!</span><span class="ident" id="4550105">c</span><span class="op" id="4550106">.</span><span class="ident" id="4550107">isClient</span>&nbsp;<span class="op" id="4550116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4550120">return</span>&nbsp;<span class="ident" id="4550127">errors</span><span class="op" id="4550133">.</span><span class="ident" id="4550134">New</span><span class="op" id="4550137">(</span><span class="string" id="4550138">&#34;tls:&nbsp;VerifyHostname&nbsp;called&nbsp;on&nbsp;TLS&nbsp;server&nbsp;connection&#34;</span><span class="op" id="4550191">)</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4550194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4550197">if</span>&nbsp;<span class="op" id="4550200">!</span><span class="ident" id="4550201">c</span><span class="op" id="4550202">.</span><span class="ident" id="4550203">handshakeComplete</span>&nbsp;<span class="op" id="4550221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4550225">return</span>&nbsp;<span class="ident" id="4550232">errors</span><span class="op" id="4550238">.</span><span class="ident" id="4550239">New</span><span class="op" id="4550242">(</span><span class="string" id="4550243">&#34;tls:&nbsp;handshake&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;performed&#34;</span><span class="op" id="4550286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4550289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4550292">return</span>&nbsp;<span class="ident" id="4550299">c</span><span class="op" id="4550300">.</span><span class="ident" id="4550301">peerCertificates</span><span class="op" id="4550317">[</span><span class="num" id="4550318">0</span><span class="op" id="4550319">]</span><span class="op" id="4550320">.</span><span class="ident" id="4550321">VerifyHostname</span><span class="op" id="4550335">(</span><span class="ident" id="4550336">host</span><span class="op" id="4550340">)</span><br>
<span class="lineno">1030</span><span class="op" id="4550342">}</span>
</div>
</body>
</html>
