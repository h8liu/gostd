<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html" class="current">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1406674">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1406729">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1406783">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1406834">package</span>&nbsp;<span class="ident" id="1406842">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1406848">import</span>&nbsp;<span class="op" id="1406855">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1406858">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1406869">&#34;sync/atomic&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1406884">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1406893">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1406896">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;temporary&nbsp;objects&nbsp;that&nbsp;may&nbsp;be&nbsp;individually&nbsp;saved&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1406971">//&nbsp;retrieved.</span><br>
<span class="lineno">15</span><span class="comment" id="1406985">//</span><br>
<span class="lineno"></span><span class="comment" id="1406988">//&nbsp;Any&nbsp;item&nbsp;stored&nbsp;in&nbsp;the&nbsp;Pool&nbsp;may&nbsp;be&nbsp;removed&nbsp;automatically&nbsp;at&nbsp;any&nbsp;time&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="1407068">//&nbsp;notification.&nbsp;If&nbsp;the&nbsp;Pool&nbsp;holds&nbsp;the&nbsp;only&nbsp;reference&nbsp;when&nbsp;this&nbsp;happens,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1407145">//&nbsp;item&nbsp;might&nbsp;be&nbsp;deallocated.</span><br>
<span class="lineno"></span><span class="comment" id="1407175">//</span><br>
<span class="lineno">20</span><span class="comment" id="1407178">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;safe&nbsp;for&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="1407243">//</span><br>
<span class="lineno"></span><span class="comment" id="1407246">//&nbsp;Pool&#39;s&nbsp;purpose&nbsp;is&nbsp;to&nbsp;cache&nbsp;allocated&nbsp;but&nbsp;unused&nbsp;items&nbsp;for&nbsp;later&nbsp;reuse,</span><br>
<span class="lineno"></span><span class="comment" id="1407320">//&nbsp;relieving&nbsp;pressure&nbsp;on&nbsp;the&nbsp;garbage&nbsp;collector.&nbsp;That&nbsp;is,&nbsp;it&nbsp;makes&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1407397">//&nbsp;build&nbsp;efficient,&nbsp;thread-safe&nbsp;free&nbsp;lists.&nbsp;However,&nbsp;it&nbsp;is&nbsp;not&nbsp;suitable&nbsp;for&nbsp;all</span><br>
<span class="lineno">25</span><span class="comment" id="1407477">//&nbsp;free&nbsp;lists.</span><br>
<span class="lineno"></span><span class="comment" id="1407492">//</span><br>
<span class="lineno"></span><span class="comment" id="1407495">//&nbsp;An&nbsp;appropriate&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;to&nbsp;manage&nbsp;a&nbsp;group&nbsp;of&nbsp;temporary&nbsp;items</span><br>
<span class="lineno"></span><span class="comment" id="1407567">//&nbsp;silently&nbsp;shared&nbsp;among&nbsp;and&nbsp;potentially&nbsp;reused&nbsp;by&nbsp;concurrent&nbsp;independent</span><br>
<span class="lineno"></span><span class="comment" id="1407641">//&nbsp;clients&nbsp;of&nbsp;a&nbsp;package.&nbsp;Pool&nbsp;provides&nbsp;a&nbsp;way&nbsp;to&nbsp;amortize&nbsp;allocation&nbsp;overhead</span><br>
<span class="lineno">30</span><span class="comment" id="1407718">//&nbsp;across&nbsp;many&nbsp;clients.</span><br>
<span class="lineno"></span><span class="comment" id="1407742">//</span><br>
<span class="lineno"></span><span class="comment" id="1407745">//&nbsp;An&nbsp;example&nbsp;of&nbsp;good&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;in&nbsp;the&nbsp;fmt&nbsp;package,&nbsp;which&nbsp;maintains&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1407822">//&nbsp;dynamically-sized&nbsp;store&nbsp;of&nbsp;temporary&nbsp;output&nbsp;buffers.&nbsp;The&nbsp;store&nbsp;scales&nbsp;under</span><br>
<span class="lineno"></span><span class="comment" id="1407901">//&nbsp;load&nbsp;(when&nbsp;many&nbsp;goroutines&nbsp;are&nbsp;actively&nbsp;printing)&nbsp;and&nbsp;shrinks&nbsp;when</span><br>
<span class="lineno">35</span><span class="comment" id="1407971">//&nbsp;quiescent.</span><br>
<span class="lineno"></span><span class="comment" id="1407985">//</span><br>
<span class="lineno"></span><span class="comment" id="1407988">//&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;a&nbsp;free&nbsp;list&nbsp;maintained&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;short-lived&nbsp;object&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1408068">//&nbsp;not&nbsp;a&nbsp;suitable&nbsp;use&nbsp;for&nbsp;a&nbsp;Pool,&nbsp;since&nbsp;the&nbsp;overhead&nbsp;does&nbsp;not&nbsp;amortize&nbsp;well&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1408147">//&nbsp;that&nbsp;scenario.&nbsp;It&nbsp;is&nbsp;more&nbsp;efficient&nbsp;to&nbsp;have&nbsp;such&nbsp;objects&nbsp;implement&nbsp;their&nbsp;own</span><br>
<span class="lineno">40</span><span class="comment" id="1408227">//&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="1408241">//</span><br>
<span class="lineno"></span><span class="keyword" id="1408244">type</span>&nbsp;<span class="ident" id="1408249">Pool</span>&nbsp;<span class="keyword" id="1408254">struct</span>&nbsp;<span class="op" id="1408261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408264">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408274">unsafe</span><span class="op" id="1408280">.</span><span class="ident" id="1408281">Pointer</span>&nbsp;<span class="comment" id="1408289">//&nbsp;local&nbsp;fixed-size&nbsp;per-P&nbsp;pool,&nbsp;actual&nbsp;type&nbsp;is&nbsp;[P]poolLocal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408350">localSize</span>&nbsp;<span class="builtintype" id="1408360">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1408375">//&nbsp;size&nbsp;of&nbsp;the&nbsp;local&nbsp;array</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1408404">//&nbsp;New&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;generate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1408456">//&nbsp;a&nbsp;value&nbsp;when&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1408505">//&nbsp;It&nbsp;may&nbsp;not&nbsp;be&nbsp;changed&nbsp;concurrently&nbsp;with&nbsp;calls&nbsp;to&nbsp;Get.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408563">New</span>&nbsp;<span class="keyword" id="1408567">func</span><span class="op" id="1408571">(</span><span class="op" id="1408572">)</span>&nbsp;<span class="keyword" id="1408574">interface</span><span class="op" id="1408583">{</span><span class="op" id="1408584">}</span><br>
<span class="lineno">50</span><span class="op" id="1408586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1408589">//&nbsp;Local&nbsp;per-P&nbsp;Pool&nbsp;appendix.</span><br>
<span class="lineno"></span><span class="keyword" id="1408619">type</span>&nbsp;<span class="ident" id="1408624">poolLocal</span>&nbsp;<span class="keyword" id="1408634">struct</span>&nbsp;<span class="op" id="1408641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408644">private</span>&nbsp;<span class="keyword" id="1408652">interface</span><span class="op" id="1408661">{</span><span class="op" id="1408662">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1408666">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;only&nbsp;by&nbsp;the&nbsp;respective&nbsp;P.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408708">shared</span>&nbsp;&nbsp;<span class="op" id="1408716">[</span><span class="op" id="1408717">]</span><span class="keyword" id="1408718">interface</span><span class="op" id="1408727">{</span><span class="op" id="1408728">}</span>&nbsp;<span class="comment" id="1408730">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;by&nbsp;any&nbsp;P.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408756">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1408778">//&nbsp;Protects&nbsp;shared.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408799">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1408807">[</span><span class="num" id="1408808">128</span><span class="op" id="1408811">]</span><span class="builtintype" id="1408812">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1408821">//&nbsp;Prevents&nbsp;false&nbsp;sharing.</span><br>
<span class="lineno"></span><span class="op" id="1408848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1408851">//&nbsp;Put&nbsp;adds&nbsp;x&nbsp;to&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1408878">func</span>&nbsp;<span class="op" id="1408883">(</span><span class="ident" id="1408884">p</span>&nbsp;<span class="op" id="1408886">*</span><span class="ident" id="1408887">Pool</span><span class="op" id="1408891">)</span>&nbsp;<span class="ident" id="1408893">Put</span><span class="op" id="1408896">(</span><span class="ident" id="1408897">x</span>&nbsp;<span class="keyword" id="1408899">interface</span><span class="op" id="1408908">{</span><span class="op" id="1408909">}</span><span class="op" id="1408910">)</span>&nbsp;<span class="op" id="1408912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408915">if</span>&nbsp;<span class="ident" id="1408918">raceenabled</span>&nbsp;<span class="op" id="1408930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1408934">//&nbsp;Under&nbsp;race&nbsp;detector&nbsp;the&nbsp;Pool&nbsp;degenerates&nbsp;into&nbsp;no-op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1408992">//&nbsp;It&#39;s&nbsp;conforming,&nbsp;simple&nbsp;and&nbsp;does&nbsp;not&nbsp;introduce&nbsp;excessive</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1409054">//&nbsp;happens-before&nbsp;edges&nbsp;between&nbsp;unrelated&nbsp;goroutines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409110">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409121">if</span>&nbsp;<span class="ident" id="1409124">x</span>&nbsp;<span class="op" id="1409126">==</span>&nbsp;<span class="builtintype" id="1409129">nil</span>&nbsp;<span class="op" id="1409133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409137">return</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409148">l</span>&nbsp;<span class="op" id="1409150">:=</span>&nbsp;<span class="ident" id="1409153">p</span><span class="op" id="1409154">.</span><span class="ident" id="1409155">pin</span><span class="op" id="1409158">(</span><span class="op" id="1409159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409162">if</span>&nbsp;<span class="ident" id="1409165">l</span><span class="op" id="1409166">.</span><span class="ident" id="1409167">private</span>&nbsp;<span class="op" id="1409175">==</span>&nbsp;<span class="builtintype" id="1409178">nil</span>&nbsp;<span class="op" id="1409182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409186">l</span><span class="op" id="1409187">.</span><span class="ident" id="1409188">private</span>&nbsp;<span class="op" id="1409196">=</span>&nbsp;<span class="ident" id="1409198">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409202">x</span>&nbsp;<span class="op" id="1409204">=</span>&nbsp;<span class="builtintype" id="1409206">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409214">runtime_procUnpin</span><span class="op" id="1409231">(</span><span class="op" id="1409232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409235">if</span>&nbsp;<span class="ident" id="1409238">x</span>&nbsp;<span class="op" id="1409240">==</span>&nbsp;<span class="builtintype" id="1409243">nil</span>&nbsp;<span class="op" id="1409247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409251">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409259">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409262">l</span><span class="op" id="1409263">.</span><span class="ident" id="1409264">Lock</span><span class="op" id="1409268">(</span><span class="op" id="1409269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409272">l</span><span class="op" id="1409273">.</span><span class="ident" id="1409274">shared</span>&nbsp;<span class="op" id="1409281">=</span>&nbsp;<span class="builtinfunc" id="1409283">append</span><span class="op" id="1409289">(</span><span class="ident" id="1409290">l</span><span class="op" id="1409291">.</span><span class="ident" id="1409292">shared</span><span class="op" id="1409298">,</span>&nbsp;<span class="ident" id="1409300">x</span><span class="op" id="1409301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409304">l</span><span class="op" id="1409305">.</span><span class="ident" id="1409306">Unlock</span><span class="op" id="1409312">(</span><span class="op" id="1409313">)</span><br>
<span class="lineno"></span><span class="op" id="1409315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="1409318">//&nbsp;Get&nbsp;selects&nbsp;an&nbsp;arbitrary&nbsp;item&nbsp;from&nbsp;the&nbsp;Pool,&nbsp;removes&nbsp;it&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1409386">//&nbsp;Pool,&nbsp;and&nbsp;returns&nbsp;it&nbsp;to&nbsp;the&nbsp;caller.</span><br>
<span class="lineno"></span><span class="comment" id="1409425">//&nbsp;Get&nbsp;may&nbsp;choose&nbsp;to&nbsp;ignore&nbsp;the&nbsp;pool&nbsp;and&nbsp;treat&nbsp;it&nbsp;as&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="1409485">//&nbsp;Callers&nbsp;should&nbsp;not&nbsp;assume&nbsp;any&nbsp;relation&nbsp;between&nbsp;values&nbsp;passed&nbsp;to&nbsp;Put&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1409560">//&nbsp;the&nbsp;values&nbsp;returned&nbsp;by&nbsp;Get.</span><br>
<span class="lineno">90</span><span class="comment" id="1409591">//</span><br>
<span class="lineno"></span><span class="comment" id="1409594">//&nbsp;If&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil&nbsp;and&nbsp;p.New&nbsp;is&nbsp;non-nil,&nbsp;Get&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="1409665">//&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;p.New.</span><br>
<span class="lineno"></span><span class="keyword" id="1409697">func</span>&nbsp;<span class="op" id="1409702">(</span><span class="ident" id="1409703">p</span>&nbsp;<span class="op" id="1409705">*</span><span class="ident" id="1409706">Pool</span><span class="op" id="1409710">)</span>&nbsp;<span class="ident" id="1409712">Get</span><span class="op" id="1409715">(</span><span class="op" id="1409716">)</span>&nbsp;<span class="keyword" id="1409718">interface</span><span class="op" id="1409727">{</span><span class="op" id="1409728">}</span>&nbsp;<span class="op" id="1409730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409733">if</span>&nbsp;<span class="ident" id="1409736">raceenabled</span>&nbsp;<span class="op" id="1409748">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409752">if</span>&nbsp;<span class="ident" id="1409755">p</span><span class="op" id="1409756">.</span><span class="ident" id="1409757">New</span>&nbsp;<span class="op" id="1409761">!=</span>&nbsp;<span class="builtintype" id="1409764">nil</span>&nbsp;<span class="op" id="1409768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409773">return</span>&nbsp;<span class="ident" id="1409780">p</span><span class="op" id="1409781">.</span><span class="ident" id="1409782">New</span><span class="op" id="1409785">(</span><span class="op" id="1409786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409794">return</span>&nbsp;<span class="builtintype" id="1409801">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409806">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409809">l</span>&nbsp;<span class="op" id="1409811">:=</span>&nbsp;<span class="ident" id="1409814">p</span><span class="op" id="1409815">.</span><span class="ident" id="1409816">pin</span><span class="op" id="1409819">(</span><span class="op" id="1409820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409823">x</span>&nbsp;<span class="op" id="1409825">:=</span>&nbsp;<span class="ident" id="1409828">l</span><span class="op" id="1409829">.</span><span class="ident" id="1409830">private</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409839">l</span><span class="op" id="1409840">.</span><span class="ident" id="1409841">private</span>&nbsp;<span class="op" id="1409849">=</span>&nbsp;<span class="builtintype" id="1409851">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409856">runtime_procUnpin</span><span class="op" id="1409873">(</span><span class="op" id="1409874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409877">if</span>&nbsp;<span class="ident" id="1409880">x</span>&nbsp;<span class="op" id="1409882">!=</span>&nbsp;<span class="builtintype" id="1409885">nil</span>&nbsp;<span class="op" id="1409889">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409893">return</span>&nbsp;<span class="ident" id="1409900">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409906">l</span><span class="op" id="1409907">.</span><span class="ident" id="1409908">Lock</span><span class="op" id="1409912">(</span><span class="op" id="1409913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409916">last</span>&nbsp;<span class="op" id="1409921">:=</span>&nbsp;<span class="builtinfunc" id="1409924">len</span><span class="op" id="1409927">(</span><span class="ident" id="1409928">l</span><span class="op" id="1409929">.</span><span class="ident" id="1409930">shared</span><span class="op" id="1409936">)</span>&nbsp;<span class="op" id="1409938">-</span>&nbsp;<span class="num" id="1409940">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409943">if</span>&nbsp;<span class="ident" id="1409946">last</span>&nbsp;<span class="op" id="1409951">&gt;=</span>&nbsp;<span class="num" id="1409954">0</span>&nbsp;<span class="op" id="1409956">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409960">x</span>&nbsp;<span class="op" id="1409962">=</span>&nbsp;<span class="ident" id="1409964">l</span><span class="op" id="1409965">.</span><span class="ident" id="1409966">shared</span><span class="op" id="1409972">[</span><span class="ident" id="1409973">last</span><span class="op" id="1409977">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409981">l</span><span class="op" id="1409982">.</span><span class="ident" id="1409983">shared</span>&nbsp;<span class="op" id="1409990">=</span>&nbsp;<span class="ident" id="1409992">l</span><span class="op" id="1409993">.</span><span class="ident" id="1409994">shared</span><span class="op" id="1410000">[</span><span class="op" id="1410001">:</span><span class="ident" id="1410002">last</span><span class="op" id="1410006">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410012">l</span><span class="op" id="1410013">.</span><span class="ident" id="1410014">Unlock</span><span class="op" id="1410020">(</span><span class="op" id="1410021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410024">if</span>&nbsp;<span class="ident" id="1410027">x</span>&nbsp;<span class="op" id="1410029">!=</span>&nbsp;<span class="builtintype" id="1410032">nil</span>&nbsp;<span class="op" id="1410036">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410040">return</span>&nbsp;<span class="ident" id="1410047">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410053">return</span>&nbsp;<span class="ident" id="1410060">p</span><span class="op" id="1410061">.</span><span class="ident" id="1410062">getSlow</span><span class="op" id="1410069">(</span><span class="op" id="1410070">)</span><br>
<span class="lineno"></span><span class="op" id="1410072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="1410075">func</span>&nbsp;<span class="op" id="1410080">(</span><span class="ident" id="1410081">p</span>&nbsp;<span class="op" id="1410083">*</span><span class="ident" id="1410084">Pool</span><span class="op" id="1410088">)</span>&nbsp;<span class="ident" id="1410090">getSlow</span><span class="op" id="1410097">(</span><span class="op" id="1410098">)</span>&nbsp;<span class="op" id="1410100">(</span><span class="ident" id="1410101">x</span>&nbsp;<span class="keyword" id="1410103">interface</span><span class="op" id="1410112">{</span><span class="op" id="1410113">}</span><span class="op" id="1410114">)</span>&nbsp;<span class="op" id="1410116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1410119">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;pin&nbsp;regarding&nbsp;ordering&nbsp;of&nbsp;the&nbsp;loads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410179">size</span>&nbsp;<span class="op" id="1410184">:=</span>&nbsp;<span class="ident" id="1410187">atomic</span><span class="op" id="1410193">.</span><span class="ident" id="1410194">LoadUintptr</span><span class="op" id="1410205">(</span><span class="op" id="1410206">&amp;</span><span class="ident" id="1410207">p</span><span class="op" id="1410208">.</span><span class="ident" id="1410209">localSize</span><span class="op" id="1410218">)</span>&nbsp;<span class="comment" id="1410220">//&nbsp;load-acquire</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410237">local</span>&nbsp;<span class="op" id="1410243">:=</span>&nbsp;<span class="ident" id="1410246">p</span><span class="op" id="1410247">.</span><span class="ident" id="1410248">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1410278">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1410295">//&nbsp;Try&nbsp;to&nbsp;steal&nbsp;one&nbsp;element&nbsp;from&nbsp;other&nbsp;procs.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410342">pid</span>&nbsp;<span class="op" id="1410346">:=</span>&nbsp;<span class="ident" id="1410349">runtime_procPin</span><span class="op" id="1410364">(</span><span class="op" id="1410365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410368">runtime_procUnpin</span><span class="op" id="1410385">(</span><span class="op" id="1410386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410389">for</span>&nbsp;<span class="ident" id="1410393">i</span>&nbsp;<span class="op" id="1410395">:=</span>&nbsp;<span class="num" id="1410398">0</span><span class="op" id="1410399">;</span>&nbsp;<span class="ident" id="1410401">i</span>&nbsp;<span class="op" id="1410403">&lt;</span>&nbsp;<span class="builtintype" id="1410405">int</span><span class="op" id="1410408">(</span><span class="ident" id="1410409">size</span><span class="op" id="1410413">)</span><span class="op" id="1410414">;</span>&nbsp;<span class="ident" id="1410416">i</span><span class="op" id="1410417">++</span>&nbsp;<span class="op" id="1410420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410424">l</span>&nbsp;<span class="op" id="1410426">:=</span>&nbsp;<span class="ident" id="1410429">indexLocal</span><span class="op" id="1410439">(</span><span class="ident" id="1410440">local</span><span class="op" id="1410445">,</span>&nbsp;<span class="op" id="1410447">(</span><span class="ident" id="1410448">pid</span><span class="op" id="1410451">+</span><span class="ident" id="1410452">i</span><span class="op" id="1410453">+</span><span class="num" id="1410454">1</span><span class="op" id="1410455">)</span><span class="op" id="1410456">%</span><span class="builtintype" id="1410457">int</span><span class="op" id="1410460">(</span><span class="ident" id="1410461">size</span><span class="op" id="1410465">)</span><span class="op" id="1410466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410470">l</span><span class="op" id="1410471">.</span><span class="ident" id="1410472">Lock</span><span class="op" id="1410476">(</span><span class="op" id="1410477">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410481">last</span>&nbsp;<span class="op" id="1410486">:=</span>&nbsp;<span class="builtinfunc" id="1410489">len</span><span class="op" id="1410492">(</span><span class="ident" id="1410493">l</span><span class="op" id="1410494">.</span><span class="ident" id="1410495">shared</span><span class="op" id="1410501">)</span>&nbsp;<span class="op" id="1410503">-</span>&nbsp;<span class="num" id="1410505">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410509">if</span>&nbsp;<span class="ident" id="1410512">last</span>&nbsp;<span class="op" id="1410517">&gt;=</span>&nbsp;<span class="num" id="1410520">0</span>&nbsp;<span class="op" id="1410522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410527">x</span>&nbsp;<span class="op" id="1410529">=</span>&nbsp;<span class="ident" id="1410531">l</span><span class="op" id="1410532">.</span><span class="ident" id="1410533">shared</span><span class="op" id="1410539">[</span><span class="ident" id="1410540">last</span><span class="op" id="1410544">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410549">l</span><span class="op" id="1410550">.</span><span class="ident" id="1410551">shared</span>&nbsp;<span class="op" id="1410558">=</span>&nbsp;<span class="ident" id="1410560">l</span><span class="op" id="1410561">.</span><span class="ident" id="1410562">shared</span><span class="op" id="1410568">[</span><span class="op" id="1410569">:</span><span class="ident" id="1410570">last</span><span class="op" id="1410574">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410579">l</span><span class="op" id="1410580">.</span><span class="ident" id="1410581">Unlock</span><span class="op" id="1410587">(</span><span class="op" id="1410588">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410593">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410605">l</span><span class="op" id="1410606">.</span><span class="ident" id="1410607">Unlock</span><span class="op" id="1410613">(</span><span class="op" id="1410614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410621">if</span>&nbsp;<span class="ident" id="1410624">x</span>&nbsp;<span class="op" id="1410626">==</span>&nbsp;<span class="builtintype" id="1410629">nil</span>&nbsp;<span class="op" id="1410633">&amp;&amp;</span>&nbsp;<span class="ident" id="1410636">p</span><span class="op" id="1410637">.</span><span class="ident" id="1410638">New</span>&nbsp;<span class="op" id="1410642">!=</span>&nbsp;<span class="builtintype" id="1410645">nil</span>&nbsp;<span class="op" id="1410649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410653">x</span>&nbsp;<span class="op" id="1410655">=</span>&nbsp;<span class="ident" id="1410657">p</span><span class="op" id="1410658">.</span><span class="ident" id="1410659">New</span><span class="op" id="1410662">(</span><span class="op" id="1410663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410669">return</span>&nbsp;<span class="ident" id="1410676">x</span><br>
<span class="lineno"></span><span class="op" id="1410678">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="comment" id="1410681">//&nbsp;pin&nbsp;pins&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;to&nbsp;P,&nbsp;disables&nbsp;preemption&nbsp;and&nbsp;returns&nbsp;poolLocal&nbsp;pool&nbsp;for&nbsp;the&nbsp;P.</span><br>
<span class="lineno"></span><span class="comment" id="1410779">//&nbsp;Caller&nbsp;must&nbsp;call&nbsp;runtime_procUnpin()&nbsp;when&nbsp;done&nbsp;with&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1410844">func</span>&nbsp;<span class="op" id="1410849">(</span><span class="ident" id="1410850">p</span>&nbsp;<span class="op" id="1410852">*</span><span class="ident" id="1410853">Pool</span><span class="op" id="1410857">)</span>&nbsp;<span class="ident" id="1410859">pin</span><span class="op" id="1410862">(</span><span class="op" id="1410863">)</span>&nbsp;<span class="op" id="1410865">*</span><span class="ident" id="1410866">poolLocal</span>&nbsp;<span class="op" id="1410876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410879">pid</span>&nbsp;<span class="op" id="1410883">:=</span>&nbsp;<span class="ident" id="1410886">runtime_procPin</span><span class="op" id="1410901">(</span><span class="op" id="1410902">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1410905">//&nbsp;In&nbsp;pinSlow&nbsp;we&nbsp;store&nbsp;to&nbsp;localSize&nbsp;and&nbsp;then&nbsp;to&nbsp;local,&nbsp;here&nbsp;we&nbsp;load&nbsp;in&nbsp;opposite&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1410993">//&nbsp;Since&nbsp;we&#39;ve&nbsp;disabled&nbsp;preemption,&nbsp;GC&nbsp;can&nbsp;not&nbsp;happen&nbsp;in&nbsp;between.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1411060">//&nbsp;Thus&nbsp;here&nbsp;we&nbsp;must&nbsp;observe&nbsp;local&nbsp;at&nbsp;least&nbsp;as&nbsp;large&nbsp;localSize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1411125">//&nbsp;We&nbsp;can&nbsp;observe&nbsp;a&nbsp;newer/larger&nbsp;local,&nbsp;it&nbsp;is&nbsp;fine&nbsp;(we&nbsp;must&nbsp;observe&nbsp;its&nbsp;zero-initialized-ness).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411222">s</span>&nbsp;<span class="op" id="1411224">:=</span>&nbsp;<span class="ident" id="1411227">atomic</span><span class="op" id="1411233">.</span><span class="ident" id="1411234">LoadUintptr</span><span class="op" id="1411245">(</span><span class="op" id="1411246">&amp;</span><span class="ident" id="1411247">p</span><span class="op" id="1411248">.</span><span class="ident" id="1411249">localSize</span><span class="op" id="1411258">)</span>&nbsp;<span class="comment" id="1411260">//&nbsp;load-acquire</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411277">l</span>&nbsp;<span class="op" id="1411279">:=</span>&nbsp;<span class="ident" id="1411282">p</span><span class="op" id="1411283">.</span><span class="ident" id="1411284">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1411315">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411332">if</span>&nbsp;<span class="builtintype" id="1411335">uintptr</span><span class="op" id="1411342">(</span><span class="ident" id="1411343">pid</span><span class="op" id="1411346">)</span>&nbsp;<span class="op" id="1411348">&lt;</span>&nbsp;<span class="ident" id="1411350">s</span>&nbsp;<span class="op" id="1411352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411356">return</span>&nbsp;<span class="ident" id="1411363">indexLocal</span><span class="op" id="1411373">(</span><span class="ident" id="1411374">l</span><span class="op" id="1411375">,</span>&nbsp;<span class="ident" id="1411377">pid</span><span class="op" id="1411380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1411383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411386">return</span>&nbsp;<span class="ident" id="1411393">p</span><span class="op" id="1411394">.</span><span class="ident" id="1411395">pinSlow</span><span class="op" id="1411402">(</span><span class="op" id="1411403">)</span><br>
<span class="lineno">160</span><span class="op" id="1411405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1411408">func</span>&nbsp;<span class="op" id="1411413">(</span><span class="ident" id="1411414">p</span>&nbsp;<span class="op" id="1411416">*</span><span class="ident" id="1411417">Pool</span><span class="op" id="1411421">)</span>&nbsp;<span class="ident" id="1411423">pinSlow</span><span class="op" id="1411430">(</span><span class="op" id="1411431">)</span>&nbsp;<span class="op" id="1411433">*</span><span class="ident" id="1411434">poolLocal</span>&nbsp;<span class="op" id="1411444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1411447">//&nbsp;Retry&nbsp;under&nbsp;the&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1411474">//&nbsp;Can&nbsp;not&nbsp;lock&nbsp;the&nbsp;mutex&nbsp;while&nbsp;pinned.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411515">runtime_procUnpin</span><span class="op" id="1411532">(</span><span class="op" id="1411533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411536">allPoolsMu</span><span class="op" id="1411546">.</span><span class="ident" id="1411547">Lock</span><span class="op" id="1411551">(</span><span class="op" id="1411552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411555">defer</span>&nbsp;<span class="ident" id="1411561">allPoolsMu</span><span class="op" id="1411571">.</span><span class="ident" id="1411572">Unlock</span><span class="op" id="1411578">(</span><span class="op" id="1411579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411582">pid</span>&nbsp;<span class="op" id="1411586">:=</span>&nbsp;<span class="ident" id="1411589">runtime_procPin</span><span class="op" id="1411604">(</span><span class="op" id="1411605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1411608">//&nbsp;poolCleanup&nbsp;won&#39;t&nbsp;be&nbsp;called&nbsp;while&nbsp;we&nbsp;are&nbsp;pinned.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411661">s</span>&nbsp;<span class="op" id="1411663">:=</span>&nbsp;<span class="ident" id="1411666">p</span><span class="op" id="1411667">.</span><span class="ident" id="1411668">localSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411679">l</span>&nbsp;<span class="op" id="1411681">:=</span>&nbsp;<span class="ident" id="1411684">p</span><span class="op" id="1411685">.</span><span class="ident" id="1411686">local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411693">if</span>&nbsp;<span class="builtintype" id="1411696">uintptr</span><span class="op" id="1411703">(</span><span class="ident" id="1411704">pid</span><span class="op" id="1411707">)</span>&nbsp;<span class="op" id="1411709">&lt;</span>&nbsp;<span class="ident" id="1411711">s</span>&nbsp;<span class="op" id="1411713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411717">return</span>&nbsp;<span class="ident" id="1411724">indexLocal</span><span class="op" id="1411734">(</span><span class="ident" id="1411735">l</span><span class="op" id="1411736">,</span>&nbsp;<span class="ident" id="1411738">pid</span><span class="op" id="1411741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1411744">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411747">if</span>&nbsp;<span class="ident" id="1411750">p</span><span class="op" id="1411751">.</span><span class="ident" id="1411752">local</span>&nbsp;<span class="op" id="1411758">==</span>&nbsp;<span class="builtintype" id="1411761">nil</span>&nbsp;<span class="op" id="1411765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411769">allPools</span>&nbsp;<span class="op" id="1411778">=</span>&nbsp;<span class="builtinfunc" id="1411780">append</span><span class="op" id="1411786">(</span><span class="ident" id="1411787">allPools</span><span class="op" id="1411795">,</span>&nbsp;<span class="ident" id="1411797">p</span><span class="op" id="1411798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1411801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1411804">//&nbsp;If&nbsp;GOMAXPROCS&nbsp;changes&nbsp;between&nbsp;GCs,&nbsp;we&nbsp;re-allocate&nbsp;the&nbsp;array&nbsp;and&nbsp;lose&nbsp;the&nbsp;old&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411890">size</span>&nbsp;<span class="op" id="1411895">:=</span>&nbsp;<span class="ident" id="1411898">runtime</span><span class="op" id="1411905">.</span><span class="ident" id="1411906">GOMAXPROCS</span><span class="op" id="1411916">(</span><span class="num" id="1411917">0</span><span class="op" id="1411918">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411921">local</span>&nbsp;<span class="op" id="1411927">:=</span>&nbsp;<span class="builtinfunc" id="1411930">make</span><span class="op" id="1411934">(</span><span class="op" id="1411935">[</span><span class="op" id="1411936">]</span><span class="ident" id="1411937">poolLocal</span><span class="op" id="1411946">,</span>&nbsp;<span class="ident" id="1411948">size</span><span class="op" id="1411952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411955">atomic</span><span class="op" id="1411961">.</span><span class="ident" id="1411962">StorePointer</span><span class="op" id="1411974">(</span><span class="op" id="1411975">(</span><span class="op" id="1411976">*</span><span class="ident" id="1411977">unsafe</span><span class="op" id="1411983">.</span><span class="ident" id="1411984">Pointer</span><span class="op" id="1411991">)</span><span class="op" id="1411992">(</span><span class="op" id="1411993">&amp;</span><span class="ident" id="1411994">p</span><span class="op" id="1411995">.</span><span class="ident" id="1411996">local</span><span class="op" id="1412001">)</span><span class="op" id="1412002">,</span>&nbsp;<span class="ident" id="1412004">unsafe</span><span class="op" id="1412010">.</span><span class="ident" id="1412011">Pointer</span><span class="op" id="1412018">(</span><span class="op" id="1412019">&amp;</span><span class="ident" id="1412020">local</span><span class="op" id="1412025">[</span><span class="num" id="1412026">0</span><span class="op" id="1412027">]</span><span class="op" id="1412028">)</span><span class="op" id="1412029">)</span>&nbsp;<span class="comment" id="1412031">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1412049">atomic</span><span class="op" id="1412055">.</span><span class="ident" id="1412056">StoreUintptr</span><span class="op" id="1412068">(</span><span class="op" id="1412069">&amp;</span><span class="ident" id="1412070">p</span><span class="op" id="1412071">.</span><span class="ident" id="1412072">localSize</span><span class="op" id="1412081">,</span>&nbsp;<span class="builtintype" id="1412083">uintptr</span><span class="op" id="1412090">(</span><span class="ident" id="1412091">size</span><span class="op" id="1412095">)</span><span class="op" id="1412096">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1412125">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1412143">return</span>&nbsp;<span class="op" id="1412150">&amp;</span><span class="ident" id="1412151">local</span><span class="op" id="1412156">[</span><span class="ident" id="1412157">pid</span><span class="op" id="1412160">]</span><br>
<span class="lineno"></span><span class="op" id="1412162">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="1412165">func</span>&nbsp;<span class="ident" id="1412170">poolCleanup</span><span class="op" id="1412181">(</span><span class="op" id="1412182">)</span>&nbsp;<span class="op" id="1412184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1412187">//&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;with&nbsp;the&nbsp;world&nbsp;stopped,&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1412281">//&nbsp;It&nbsp;must&nbsp;not&nbsp;allocate&nbsp;and&nbsp;probably&nbsp;should&nbsp;not&nbsp;call&nbsp;any&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1412358">//&nbsp;Defensively&nbsp;zero&nbsp;out&nbsp;everything,&nbsp;2&nbsp;reasons:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1412406">//&nbsp;1.&nbsp;To&nbsp;prevent&nbsp;false&nbsp;retention&nbsp;of&nbsp;whole&nbsp;Pools.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1412456">//&nbsp;2.&nbsp;If&nbsp;GC&nbsp;happens&nbsp;while&nbsp;a&nbsp;goroutine&nbsp;works&nbsp;with&nbsp;l.shared&nbsp;in&nbsp;Put/Get,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1412527">//&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;will&nbsp;retain&nbsp;whole&nbsp;Pool.&nbsp;So&nbsp;next&nbsp;cycle&nbsp;memory&nbsp;consumption&nbsp;would&nbsp;be&nbsp;doubled.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1412612">for</span>&nbsp;<span class="ident" id="1412616">i</span><span class="op" id="1412617">,</span>&nbsp;<span class="ident" id="1412619">p</span>&nbsp;<span class="op" id="1412621">:=</span>&nbsp;<span class="keyword" id="1412624">range</span>&nbsp;<span class="ident" id="1412630">allPools</span>&nbsp;<span class="op" id="1412639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1412643">allPools</span><span class="op" id="1412651">[</span><span class="ident" id="1412652">i</span><span class="op" id="1412653">]</span>&nbsp;<span class="op" id="1412655">=</span>&nbsp;<span class="builtintype" id="1412657">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1412663">for</span>&nbsp;<span class="ident" id="1412667">i</span>&nbsp;<span class="op" id="1412669">:=</span>&nbsp;<span class="num" id="1412672">0</span><span class="op" id="1412673">;</span>&nbsp;<span class="ident" id="1412675">i</span>&nbsp;<span class="op" id="1412677">&lt;</span>&nbsp;<span class="builtintype" id="1412679">int</span><span class="op" id="1412682">(</span><span class="ident" id="1412683">p</span><span class="op" id="1412684">.</span><span class="ident" id="1412685">localSize</span><span class="op" id="1412694">)</span><span class="op" id="1412695">;</span>&nbsp;<span class="ident" id="1412697">i</span><span class="op" id="1412698">++</span>&nbsp;<span class="op" id="1412701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1412706">l</span>&nbsp;<span class="op" id="1412708">:=</span>&nbsp;<span class="ident" id="1412711">indexLocal</span><span class="op" id="1412721">(</span><span class="ident" id="1412722">p</span><span class="op" id="1412723">.</span><span class="ident" id="1412724">local</span><span class="op" id="1412729">,</span>&nbsp;<span class="ident" id="1412731">i</span><span class="op" id="1412732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1412737">l</span><span class="op" id="1412738">.</span><span class="ident" id="1412739">private</span>&nbsp;<span class="op" id="1412747">=</span>&nbsp;<span class="builtintype" id="1412749">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1412756">for</span>&nbsp;<span class="ident" id="1412760">j</span>&nbsp;<span class="op" id="1412762">:=</span>&nbsp;<span class="keyword" id="1412765">range</span>&nbsp;<span class="ident" id="1412771">l</span><span class="op" id="1412772">.</span><span class="ident" id="1412773">shared</span>&nbsp;<span class="op" id="1412780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1412786">l</span><span class="op" id="1412787">.</span><span class="ident" id="1412788">shared</span><span class="op" id="1412794">[</span><span class="ident" id="1412795">j</span><span class="op" id="1412796">]</span>&nbsp;<span class="op" id="1412798">=</span>&nbsp;<span class="builtintype" id="1412800">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1412807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1412812">l</span><span class="op" id="1412813">.</span><span class="ident" id="1412814">shared</span>&nbsp;<span class="op" id="1412821">=</span>&nbsp;<span class="builtintype" id="1412823">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1412829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1412833">p</span><span class="op" id="1412834">.</span><span class="ident" id="1412835">local</span>&nbsp;<span class="op" id="1412841">=</span>&nbsp;<span class="builtintype" id="1412843">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1412849">p</span><span class="op" id="1412850">.</span><span class="ident" id="1412851">localSize</span>&nbsp;<span class="op" id="1412861">=</span>&nbsp;<span class="num" id="1412863">0</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1412866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1412869">allPools</span>&nbsp;<span class="op" id="1412878">=</span>&nbsp;<span class="op" id="1412880">[</span><span class="op" id="1412881">]</span><span class="op" id="1412882">*</span><span class="ident" id="1412883">Pool</span><span class="op" id="1412887">{</span><span class="op" id="1412888">}</span><br>
<span class="lineno"></span><span class="op" id="1412890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1412893">var</span>&nbsp;<span class="op" id="1412897">(</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1412900">allPoolsMu</span>&nbsp;<span class="ident" id="1412911">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1412918">allPools</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1412929">[</span><span class="op" id="1412930">]</span><span class="op" id="1412931">*</span><span class="ident" id="1412932">Pool</span><br>
<span class="lineno"></span><span class="op" id="1412937">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1412940">func</span>&nbsp;<span class="ident" id="1412945">init</span><span class="op" id="1412949">(</span><span class="op" id="1412950">)</span>&nbsp;<span class="op" id="1412952">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1412955">runtime_registerPoolCleanup</span><span class="op" id="1412982">(</span><span class="ident" id="1412983">poolCleanup</span><span class="op" id="1412994">)</span><br>
<span class="lineno"></span><span class="op" id="1412996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1412999">func</span>&nbsp;<span class="ident" id="1413004">indexLocal</span><span class="op" id="1413014">(</span><span class="ident" id="1413015">l</span>&nbsp;<span class="ident" id="1413017">unsafe</span><span class="op" id="1413023">.</span><span class="ident" id="1413024">Pointer</span><span class="op" id="1413031">,</span>&nbsp;<span class="ident" id="1413033">i</span>&nbsp;<span class="builtintype" id="1413035">int</span><span class="op" id="1413038">)</span>&nbsp;<span class="op" id="1413040">*</span><span class="ident" id="1413041">poolLocal</span>&nbsp;<span class="op" id="1413051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1413054">return</span>&nbsp;<span class="op" id="1413061">&amp;</span><span class="op" id="1413062">(</span><span class="op" id="1413063">*</span><span class="op" id="1413064">[</span><span class="num" id="1413065">1000000</span><span class="op" id="1413072">]</span><span class="ident" id="1413073">poolLocal</span><span class="op" id="1413082">)</span><span class="op" id="1413083">(</span><span class="ident" id="1413084">l</span><span class="op" id="1413085">)</span><span class="op" id="1413086">[</span><span class="ident" id="1413087">i</span><span class="op" id="1413088">]</span><br>
<span class="lineno">220</span><span class="op" id="1413090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1413093">//&nbsp;Implemented&nbsp;in&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1413120">func</span>&nbsp;<span class="ident" id="1413125">runtime_registerPoolCleanup</span><span class="op" id="1413152">(</span><span class="ident" id="1413153">cleanup</span>&nbsp;<span class="keyword" id="1413161">func</span><span class="op" id="1413165">(</span><span class="op" id="1413166">)</span><span class="op" id="1413167">)</span><br>
<span class="lineno"></span><span class="keyword" id="1413169">func</span>&nbsp;<span class="ident" id="1413174">runtime_procPin</span><span class="op" id="1413189">(</span><span class="op" id="1413190">)</span>&nbsp;<span class="builtintype" id="1413192">int</span><br>
<span class="lineno">225</span><span class="keyword" id="1413196">func</span>&nbsp;<span class="ident" id="1413201">runtime_procUnpin</span><span class="op" id="1413218">(</span><span class="op" id="1413219">)</span>
</div>
</body>
</html>
