<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5359241">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5359296">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5359350">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5359401">package</span>&nbsp;<span class="ident" id="5359409">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5359419">import</span>&nbsp;<span class="op" id="5359426">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5359429">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5359438">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5359448">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5359454">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5359461">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5359473">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5359490">&#34;sync&#34;</span><br>
<span class="lineno">15</span><span class="op" id="5359497">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5359500">var</span>&nbsp;<span class="op" id="5359504">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359507">ErrPersistEOF</span>&nbsp;<span class="op" id="5359521">=</span>&nbsp;<span class="op" id="5359523">&amp;</span><span class="ident" id="5359524">http</span><span class="op" id="5359528">.</span><span class="ident" id="5359529">ProtocolError</span><span class="op" id="5359542">{</span><span class="ident" id="5359543">ErrorString</span><span class="op" id="5359554">:</span>&nbsp;<span class="string" id="5359556">&#34;persistent&nbsp;connection&nbsp;closed&#34;</span><span class="op" id="5359586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359589">ErrClosed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5359603">=</span>&nbsp;<span class="op" id="5359605">&amp;</span><span class="ident" id="5359606">http</span><span class="op" id="5359610">.</span><span class="ident" id="5359611">ProtocolError</span><span class="op" id="5359624">{</span><span class="ident" id="5359625">ErrorString</span><span class="op" id="5359636">:</span>&nbsp;<span class="string" id="5359638">&#34;connection&nbsp;closed&nbsp;by&nbsp;user&#34;</span><span class="op" id="5359665">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359668">ErrPipeline</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5359682">=</span>&nbsp;<span class="op" id="5359684">&amp;</span><span class="ident" id="5359685">http</span><span class="op" id="5359689">.</span><span class="ident" id="5359690">ProtocolError</span><span class="op" id="5359703">{</span><span class="ident" id="5359704">ErrorString</span><span class="op" id="5359715">:</span>&nbsp;<span class="string" id="5359717">&#34;pipeline&nbsp;error&#34;</span><span class="op" id="5359733">}</span><br>
<span class="lineno"></span><span class="op" id="5359735">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5359738">//&nbsp;This&nbsp;is&nbsp;an&nbsp;API&nbsp;usage&nbsp;error&nbsp;-&nbsp;the&nbsp;local&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="5359796">//&nbsp;ErrPersistEOF&nbsp;(above)&nbsp;reports&nbsp;that&nbsp;the&nbsp;remote&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno">25</span><span class="keyword" id="5359861">var</span>&nbsp;<span class="ident" id="5359865">errClosed</span>&nbsp;<span class="op" id="5359875">=</span>&nbsp;<span class="ident" id="5359877">errors</span><span class="op" id="5359883">.</span><span class="ident" id="5359884">New</span><span class="op" id="5359887">(</span><span class="string" id="5359888">&#34;i/o&nbsp;operation&nbsp;on&nbsp;closed&nbsp;connection&#34;</span><span class="op" id="5359924">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5359927">//&nbsp;A&nbsp;ServerConn&nbsp;reads&nbsp;requests&nbsp;and&nbsp;sends&nbsp;responses&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="5359997">//&nbsp;connection,&nbsp;until&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic&nbsp;commands&nbsp;an&nbsp;end.&nbsp;ServerConn</span><br>
<span class="lineno"></span><span class="comment" id="5360071">//&nbsp;also&nbsp;allows&nbsp;hijacking&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;by&nbsp;calling&nbsp;Hijack</span><br>
<span class="lineno">30</span><span class="comment" id="5360140">//&nbsp;to&nbsp;regain&nbsp;control&nbsp;over&nbsp;the&nbsp;connection.&nbsp;ServerConn&nbsp;supports&nbsp;pipe-lining,</span><br>
<span class="lineno"></span><span class="comment" id="5360215">//&nbsp;i.e.&nbsp;requests&nbsp;can&nbsp;be&nbsp;read&nbsp;out&nbsp;of&nbsp;sync&nbsp;(but&nbsp;in&nbsp;the&nbsp;same&nbsp;order)&nbsp;while&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5360290">//&nbsp;respective&nbsp;responses&nbsp;are&nbsp;sent.</span><br>
<span class="lineno"></span><span class="comment" id="5360324">//</span><br>
<span class="lineno"></span><span class="comment" id="5360327">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno">35</span><span class="comment" id="5360402">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5360430">type</span>&nbsp;<span class="ident" id="5360435">ServerConn</span>&nbsp;<span class="keyword" id="5360446">struct</span>&nbsp;<span class="op" id="5360453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5360456">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5360472">sync</span><span class="op" id="5360476">.</span><span class="ident" id="5360477">Mutex</span>&nbsp;<span class="comment" id="5360483">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5360528">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5360544">net</span><span class="op" id="5360547">.</span><span class="ident" id="5360548">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5360554">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5360570">*</span><span class="ident" id="5360571">bufio</span><span class="op" id="5360576">.</span><span class="ident" id="5360577">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5360585">re</span><span class="op" id="5360587">,</span>&nbsp;<span class="ident" id="5360589">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5360601">error</span>&nbsp;<span class="comment" id="5360607">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5360629">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5360645">io</span><span class="op" id="5360647">.</span><span class="ident" id="5360648">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5360660">nread</span><span class="op" id="5360665">,</span>&nbsp;<span class="ident" id="5360667">nwritten</span>&nbsp;<span class="builtintype" id="5360676">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5360681">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5360697">map</span><span class="op" id="5360700">[</span><span class="op" id="5360701">*</span><span class="ident" id="5360702">http</span><span class="op" id="5360706">.</span><span class="ident" id="5360707">Request</span><span class="op" id="5360714">]</span><span class="builtintype" id="5360715">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5360722">pipe</span>&nbsp;<span class="ident" id="5360727">textproto</span><span class="op" id="5360736">.</span><span class="ident" id="5360737">Pipeline</span><br>
<span class="lineno"></span><span class="op" id="5360746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5360749">//&nbsp;NewServerConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServerConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="5360826">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno">50</span><span class="comment" id="5360874">//</span><br>
<span class="lineno"></span><span class="comment" id="5360877">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno"></span><span class="comment" id="5360952">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5360980">func</span>&nbsp;<span class="ident" id="5360985">NewServerConn</span><span class="op" id="5360998">(</span><span class="ident" id="5360999">c</span>&nbsp;<span class="ident" id="5361001">net</span><span class="op" id="5361004">.</span><span class="ident" id="5361005">Conn</span><span class="op" id="5361009">,</span>&nbsp;<span class="ident" id="5361011">r</span>&nbsp;<span class="op" id="5361013">*</span><span class="ident" id="5361014">bufio</span><span class="op" id="5361019">.</span><span class="ident" id="5361020">Reader</span><span class="op" id="5361026">)</span>&nbsp;<span class="op" id="5361028">*</span><span class="ident" id="5361029">ServerConn</span>&nbsp;<span class="op" id="5361040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361043">if</span>&nbsp;<span class="ident" id="5361046">r</span>&nbsp;<span class="op" id="5361048">==</span>&nbsp;<span class="ident" id="5361051">nil</span>&nbsp;<span class="op" id="5361055">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361059">r</span>&nbsp;<span class="op" id="5361061">=</span>&nbsp;<span class="ident" id="5361063">bufio</span><span class="op" id="5361068">.</span><span class="ident" id="5361069">NewReader</span><span class="op" id="5361078">(</span><span class="ident" id="5361079">c</span><span class="op" id="5361080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5361083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361086">return</span>&nbsp;<span class="op" id="5361093">&amp;</span><span class="ident" id="5361094">ServerConn</span><span class="op" id="5361104">{</span><span class="ident" id="5361105">c</span><span class="op" id="5361106">:</span>&nbsp;<span class="ident" id="5361108">c</span><span class="op" id="5361109">,</span>&nbsp;<span class="ident" id="5361111">r</span><span class="op" id="5361112">:</span>&nbsp;<span class="ident" id="5361114">r</span><span class="op" id="5361115">,</span>&nbsp;<span class="ident" id="5361117">pipereq</span><span class="op" id="5361124">:</span>&nbsp;<span class="builtinfunc" id="5361126">make</span><span class="op" id="5361130">(</span><span class="keyword" id="5361131">map</span><span class="op" id="5361134">[</span><span class="op" id="5361135">*</span><span class="ident" id="5361136">http</span><span class="op" id="5361140">.</span><span class="ident" id="5361141">Request</span><span class="op" id="5361148">]</span><span class="builtintype" id="5361149">uint</span><span class="op" id="5361153">)</span><span class="op" id="5361154">}</span><br>
<span class="lineno"></span><span class="op" id="5361156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="5361159">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ServerConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="5361239">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5361315">//&nbsp;called&nbsp;before&nbsp;Read&nbsp;has&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive&nbsp;logic.&nbsp;The&nbsp;user</span><br>
<span class="lineno"></span><span class="comment" id="5361392">//&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="5361454">func</span>&nbsp;<span class="op" id="5361459">(</span><span class="ident" id="5361460">sc</span>&nbsp;<span class="op" id="5361463">*</span><span class="ident" id="5361464">ServerConn</span><span class="op" id="5361474">)</span>&nbsp;<span class="ident" id="5361476">Hijack</span><span class="op" id="5361482">(</span><span class="op" id="5361483">)</span>&nbsp;<span class="op" id="5361485">(</span><span class="ident" id="5361486">c</span>&nbsp;<span class="ident" id="5361488">net</span><span class="op" id="5361491">.</span><span class="ident" id="5361492">Conn</span><span class="op" id="5361496">,</span>&nbsp;<span class="ident" id="5361498">r</span>&nbsp;<span class="op" id="5361500">*</span><span class="ident" id="5361501">bufio</span><span class="op" id="5361506">.</span><span class="ident" id="5361507">Reader</span><span class="op" id="5361513">)</span>&nbsp;<span class="op" id="5361515">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361518">sc</span><span class="op" id="5361520">.</span><span class="ident" id="5361521">lk</span><span class="op" id="5361523">.</span><span class="ident" id="5361524">Lock</span><span class="op" id="5361528">(</span><span class="op" id="5361529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361532">defer</span>&nbsp;<span class="ident" id="5361538">sc</span><span class="op" id="5361540">.</span><span class="ident" id="5361541">lk</span><span class="op" id="5361543">.</span><span class="ident" id="5361544">Unlock</span><span class="op" id="5361550">(</span><span class="op" id="5361551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361554">c</span>&nbsp;<span class="op" id="5361556">=</span>&nbsp;<span class="ident" id="5361558">sc</span><span class="op" id="5361560">.</span><span class="ident" id="5361561">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361564">r</span>&nbsp;<span class="op" id="5361566">=</span>&nbsp;<span class="ident" id="5361568">sc</span><span class="op" id="5361570">.</span><span class="ident" id="5361571">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361574">sc</span><span class="op" id="5361576">.</span><span class="ident" id="5361577">c</span>&nbsp;<span class="op" id="5361579">=</span>&nbsp;<span class="ident" id="5361581">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361586">sc</span><span class="op" id="5361588">.</span><span class="ident" id="5361589">r</span>&nbsp;<span class="op" id="5361591">=</span>&nbsp;<span class="ident" id="5361593">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361598">return</span><br>
<span class="lineno"></span><span class="op" id="5361605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5361608">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">75</span><span class="keyword" id="5361677">func</span>&nbsp;<span class="op" id="5361682">(</span><span class="ident" id="5361683">sc</span>&nbsp;<span class="op" id="5361686">*</span><span class="ident" id="5361687">ServerConn</span><span class="op" id="5361697">)</span>&nbsp;<span class="ident" id="5361699">Close</span><span class="op" id="5361704">(</span><span class="op" id="5361705">)</span>&nbsp;<span class="builtintype" id="5361707">error</span>&nbsp;<span class="op" id="5361713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361716">c</span><span class="op" id="5361717">,</span>&nbsp;<span class="ident" id="5361719">_</span>&nbsp;<span class="op" id="5361721">:=</span>&nbsp;<span class="ident" id="5361724">sc</span><span class="op" id="5361726">.</span><span class="ident" id="5361727">Hijack</span><span class="op" id="5361733">(</span><span class="op" id="5361734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361737">if</span>&nbsp;<span class="ident" id="5361740">c</span>&nbsp;<span class="op" id="5361742">!=</span>&nbsp;<span class="ident" id="5361745">nil</span>&nbsp;<span class="op" id="5361749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361753">return</span>&nbsp;<span class="ident" id="5361760">c</span><span class="op" id="5361761">.</span><span class="ident" id="5361762">Close</span><span class="op" id="5361767">(</span><span class="op" id="5361768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5361771">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361774">return</span>&nbsp;<span class="ident" id="5361781">nil</span><br>
<span class="lineno"></span><span class="op" id="5361785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5361788">//&nbsp;Read&nbsp;returns&nbsp;the&nbsp;next&nbsp;request&nbsp;on&nbsp;the&nbsp;wire.&nbsp;An&nbsp;ErrPersistEOF&nbsp;is&nbsp;returned&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="5361866">//&nbsp;it&nbsp;is&nbsp;gracefully&nbsp;determined&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;requests&nbsp;(e.g.&nbsp;after&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="5361945">//&nbsp;first&nbsp;request&nbsp;on&nbsp;an&nbsp;HTTP/1.0&nbsp;connection,&nbsp;or&nbsp;after&nbsp;a&nbsp;Connection:close&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5362022">//&nbsp;HTTP/1.1&nbsp;connection).</span><br>
<span class="lineno"></span><span class="keyword" id="5362047">func</span>&nbsp;<span class="op" id="5362052">(</span><span class="ident" id="5362053">sc</span>&nbsp;<span class="op" id="5362056">*</span><span class="ident" id="5362057">ServerConn</span><span class="op" id="5362067">)</span>&nbsp;<span class="ident" id="5362069">Read</span><span class="op" id="5362073">(</span><span class="op" id="5362074">)</span>&nbsp;<span class="op" id="5362076">(</span><span class="ident" id="5362077">req</span>&nbsp;<span class="op" id="5362081">*</span><span class="ident" id="5362082">http</span><span class="op" id="5362086">.</span><span class="ident" id="5362087">Request</span><span class="op" id="5362094">,</span>&nbsp;<span class="ident" id="5362096">err</span>&nbsp;<span class="builtintype" id="5362100">error</span><span class="op" id="5362105">)</span>&nbsp;<span class="op" id="5362107">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5362111">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Reads&nbsp;and&nbsp;Writes</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362160">id</span>&nbsp;<span class="op" id="5362163">:=</span>&nbsp;<span class="ident" id="5362166">sc</span><span class="op" id="5362168">.</span><span class="ident" id="5362169">pipe</span><span class="op" id="5362173">.</span><span class="ident" id="5362174">Next</span><span class="op" id="5362178">(</span><span class="op" id="5362179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362182">sc</span><span class="op" id="5362184">.</span><span class="ident" id="5362185">pipe</span><span class="op" id="5362189">.</span><span class="ident" id="5362190">StartRequest</span><span class="op" id="5362202">(</span><span class="ident" id="5362203">id</span><span class="op" id="5362205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362208">defer</span>&nbsp;<span class="keyword" id="5362214">func</span><span class="op" id="5362218">(</span><span class="op" id="5362219">)</span>&nbsp;<span class="op" id="5362221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362225">sc</span><span class="op" id="5362227">.</span><span class="ident" id="5362228">pipe</span><span class="op" id="5362232">.</span><span class="ident" id="5362233">EndRequest</span><span class="op" id="5362243">(</span><span class="ident" id="5362244">id</span><span class="op" id="5362246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362250">if</span>&nbsp;<span class="ident" id="5362253">req</span>&nbsp;<span class="op" id="5362257">==</span>&nbsp;<span class="ident" id="5362260">nil</span>&nbsp;<span class="op" id="5362264">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362269">sc</span><span class="op" id="5362271">.</span><span class="ident" id="5362272">pipe</span><span class="op" id="5362276">.</span><span class="ident" id="5362277">StartResponse</span><span class="op" id="5362290">(</span><span class="ident" id="5362291">id</span><span class="op" id="5362293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362298">sc</span><span class="op" id="5362300">.</span><span class="ident" id="5362301">pipe</span><span class="op" id="5362305">.</span><span class="ident" id="5362306">EndResponse</span><span class="op" id="5362317">(</span><span class="ident" id="5362318">id</span><span class="op" id="5362320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5362324">}</span>&nbsp;<span class="keyword" id="5362326">else</span>&nbsp;<span class="op" id="5362331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5362336">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362383">sc</span><span class="op" id="5362385">.</span><span class="ident" id="5362386">lk</span><span class="op" id="5362388">.</span><span class="ident" id="5362389">Lock</span><span class="op" id="5362393">(</span><span class="op" id="5362394">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362399">sc</span><span class="op" id="5362401">.</span><span class="ident" id="5362402">pipereq</span><span class="op" id="5362409">[</span><span class="ident" id="5362410">req</span><span class="op" id="5362413">]</span>&nbsp;<span class="op" id="5362415">=</span>&nbsp;<span class="ident" id="5362417">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362423">sc</span><span class="op" id="5362425">.</span><span class="ident" id="5362426">lk</span><span class="op" id="5362428">.</span><span class="ident" id="5362429">Unlock</span><span class="op" id="5362435">(</span><span class="op" id="5362436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5362440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5362443">}</span><span class="op" id="5362444">(</span><span class="op" id="5362445">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362449">sc</span><span class="op" id="5362451">.</span><span class="ident" id="5362452">lk</span><span class="op" id="5362454">.</span><span class="ident" id="5362455">Lock</span><span class="op" id="5362459">(</span><span class="op" id="5362460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362463">if</span>&nbsp;<span class="ident" id="5362466">sc</span><span class="op" id="5362468">.</span><span class="ident" id="5362469">we</span>&nbsp;<span class="op" id="5362472">!=</span>&nbsp;<span class="ident" id="5362475">nil</span>&nbsp;<span class="op" id="5362479">{</span>&nbsp;<span class="comment" id="5362481">//&nbsp;no&nbsp;point&nbsp;receiving&nbsp;if&nbsp;write-side&nbsp;broken&nbsp;or&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362536">defer</span>&nbsp;<span class="ident" id="5362542">sc</span><span class="op" id="5362544">.</span><span class="ident" id="5362545">lk</span><span class="op" id="5362547">.</span><span class="ident" id="5362548">Unlock</span><span class="op" id="5362554">(</span><span class="op" id="5362555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362559">return</span>&nbsp;<span class="ident" id="5362566">nil</span><span class="op" id="5362569">,</span>&nbsp;<span class="ident" id="5362571">sc</span><span class="op" id="5362573">.</span><span class="ident" id="5362574">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5362578">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362581">if</span>&nbsp;<span class="ident" id="5362584">sc</span><span class="op" id="5362586">.</span><span class="ident" id="5362587">re</span>&nbsp;<span class="op" id="5362590">!=</span>&nbsp;<span class="ident" id="5362593">nil</span>&nbsp;<span class="op" id="5362597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362601">defer</span>&nbsp;<span class="ident" id="5362607">sc</span><span class="op" id="5362609">.</span><span class="ident" id="5362610">lk</span><span class="op" id="5362612">.</span><span class="ident" id="5362613">Unlock</span><span class="op" id="5362619">(</span><span class="op" id="5362620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362624">return</span>&nbsp;<span class="ident" id="5362631">nil</span><span class="op" id="5362634">,</span>&nbsp;<span class="ident" id="5362636">sc</span><span class="op" id="5362638">.</span><span class="ident" id="5362639">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5362643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362646">if</span>&nbsp;<span class="ident" id="5362649">sc</span><span class="op" id="5362651">.</span><span class="ident" id="5362652">r</span>&nbsp;<span class="op" id="5362654">==</span>&nbsp;<span class="ident" id="5362657">nil</span>&nbsp;<span class="op" id="5362661">{</span>&nbsp;<span class="comment" id="5362663">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362710">defer</span>&nbsp;<span class="ident" id="5362716">sc</span><span class="op" id="5362718">.</span><span class="ident" id="5362719">lk</span><span class="op" id="5362721">.</span><span class="ident" id="5362722">Unlock</span><span class="op" id="5362728">(</span><span class="op" id="5362729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362733">return</span>&nbsp;<span class="ident" id="5362740">nil</span><span class="op" id="5362743">,</span>&nbsp;<span class="ident" id="5362745">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5362756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362759">r</span>&nbsp;<span class="op" id="5362761">:=</span>&nbsp;<span class="ident" id="5362764">sc</span><span class="op" id="5362766">.</span><span class="ident" id="5362767">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362770">lastbody</span>&nbsp;<span class="op" id="5362779">:=</span>&nbsp;<span class="ident" id="5362782">sc</span><span class="op" id="5362784">.</span><span class="ident" id="5362785">lastbody</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362795">sc</span><span class="op" id="5362797">.</span><span class="ident" id="5362798">lastbody</span>&nbsp;<span class="op" id="5362807">=</span>&nbsp;<span class="ident" id="5362809">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362814">sc</span><span class="op" id="5362816">.</span><span class="ident" id="5362817">lk</span><span class="op" id="5362819">.</span><span class="ident" id="5362820">Unlock</span><span class="op" id="5362826">(</span><span class="op" id="5362827">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5362831">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362907">if</span>&nbsp;<span class="ident" id="5362910">lastbody</span>&nbsp;<span class="op" id="5362919">!=</span>&nbsp;<span class="ident" id="5362922">nil</span>&nbsp;<span class="op" id="5362926">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5362930">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5362996">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5363054">//&nbsp;returned.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363069">err</span>&nbsp;<span class="op" id="5363073">=</span>&nbsp;<span class="ident" id="5363075">lastbody</span><span class="op" id="5363083">.</span><span class="ident" id="5363084">Close</span><span class="op" id="5363089">(</span><span class="op" id="5363090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363094">if</span>&nbsp;<span class="ident" id="5363097">err</span>&nbsp;<span class="op" id="5363101">!=</span>&nbsp;<span class="ident" id="5363104">nil</span>&nbsp;<span class="op" id="5363108">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363113">sc</span><span class="op" id="5363115">.</span><span class="ident" id="5363116">lk</span><span class="op" id="5363118">.</span><span class="ident" id="5363119">Lock</span><span class="op" id="5363123">(</span><span class="op" id="5363124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363129">defer</span>&nbsp;<span class="ident" id="5363135">sc</span><span class="op" id="5363137">.</span><span class="ident" id="5363138">lk</span><span class="op" id="5363140">.</span><span class="ident" id="5363141">Unlock</span><span class="op" id="5363147">(</span><span class="op" id="5363148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363153">sc</span><span class="op" id="5363155">.</span><span class="ident" id="5363156">re</span>&nbsp;<span class="op" id="5363159">=</span>&nbsp;<span class="ident" id="5363161">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363168">return</span>&nbsp;<span class="ident" id="5363175">nil</span><span class="op" id="5363178">,</span>&nbsp;<span class="ident" id="5363180">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5363186">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5363189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363193">req</span><span class="op" id="5363196">,</span>&nbsp;<span class="ident" id="5363198">err</span>&nbsp;<span class="op" id="5363202">=</span>&nbsp;<span class="ident" id="5363204">http</span><span class="op" id="5363208">.</span><span class="ident" id="5363209">ReadRequest</span><span class="op" id="5363220">(</span><span class="ident" id="5363221">r</span><span class="op" id="5363222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363225">sc</span><span class="op" id="5363227">.</span><span class="ident" id="5363228">lk</span><span class="op" id="5363230">.</span><span class="ident" id="5363231">Lock</span><span class="op" id="5363235">(</span><span class="op" id="5363236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363239">defer</span>&nbsp;<span class="ident" id="5363245">sc</span><span class="op" id="5363247">.</span><span class="ident" id="5363248">lk</span><span class="op" id="5363250">.</span><span class="ident" id="5363251">Unlock</span><span class="op" id="5363257">(</span><span class="op" id="5363258">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363261">if</span>&nbsp;<span class="ident" id="5363264">err</span>&nbsp;<span class="op" id="5363268">!=</span>&nbsp;<span class="ident" id="5363271">nil</span>&nbsp;<span class="op" id="5363275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363279">if</span>&nbsp;<span class="ident" id="5363282">err</span>&nbsp;<span class="op" id="5363286">==</span>&nbsp;<span class="ident" id="5363289">io</span><span class="op" id="5363291">.</span><span class="ident" id="5363292">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="5363309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5363314">//&nbsp;A&nbsp;close&nbsp;from&nbsp;the&nbsp;opposing&nbsp;client&nbsp;is&nbsp;treated&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5363369">//&nbsp;graceful&nbsp;close,&nbsp;even&nbsp;if&nbsp;there&nbsp;was&nbsp;some&nbsp;unparse-able</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5363427">//&nbsp;data&nbsp;before&nbsp;the&nbsp;close.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363456">sc</span><span class="op" id="5363458">.</span><span class="ident" id="5363459">re</span>&nbsp;<span class="op" id="5363462">=</span>&nbsp;<span class="ident" id="5363464">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363481">return</span>&nbsp;<span class="ident" id="5363488">nil</span><span class="op" id="5363491">,</span>&nbsp;<span class="ident" id="5363493">sc</span><span class="op" id="5363495">.</span><span class="ident" id="5363496">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5363501">}</span>&nbsp;<span class="keyword" id="5363503">else</span>&nbsp;<span class="op" id="5363508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363513">sc</span><span class="op" id="5363515">.</span><span class="ident" id="5363516">re</span>&nbsp;<span class="op" id="5363519">=</span>&nbsp;<span class="ident" id="5363521">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363528">return</span>&nbsp;<span class="ident" id="5363535">req</span><span class="op" id="5363538">,</span>&nbsp;<span class="ident" id="5363540">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5363546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5363549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363552">sc</span><span class="op" id="5363554">.</span><span class="ident" id="5363555">lastbody</span>&nbsp;<span class="op" id="5363564">=</span>&nbsp;<span class="ident" id="5363566">req</span><span class="op" id="5363569">.</span><span class="ident" id="5363570">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363576">sc</span><span class="op" id="5363578">.</span><span class="ident" id="5363579">nread</span><span class="op" id="5363584">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363588">if</span>&nbsp;<span class="ident" id="5363591">req</span><span class="op" id="5363594">.</span><span class="ident" id="5363595">Close</span>&nbsp;<span class="op" id="5363601">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363605">sc</span><span class="op" id="5363607">.</span><span class="ident" id="5363608">re</span>&nbsp;<span class="op" id="5363611">=</span>&nbsp;<span class="ident" id="5363613">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363629">return</span>&nbsp;<span class="ident" id="5363636">req</span><span class="op" id="5363639">,</span>&nbsp;<span class="ident" id="5363641">sc</span><span class="op" id="5363643">.</span><span class="ident" id="5363644">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5363648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363651">return</span>&nbsp;<span class="ident" id="5363658">req</span><span class="op" id="5363661">,</span>&nbsp;<span class="ident" id="5363663">err</span><br>
<span class="lineno"></span><span class="op" id="5363667">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="5363670">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5363723">//&nbsp;that&nbsp;have&nbsp;been&nbsp;received&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5363769">func</span>&nbsp;<span class="op" id="5363774">(</span><span class="ident" id="5363775">sc</span>&nbsp;<span class="op" id="5363778">*</span><span class="ident" id="5363779">ServerConn</span><span class="op" id="5363789">)</span>&nbsp;<span class="ident" id="5363791">Pending</span><span class="op" id="5363798">(</span><span class="op" id="5363799">)</span>&nbsp;<span class="builtintype" id="5363801">int</span>&nbsp;<span class="op" id="5363805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363808">sc</span><span class="op" id="5363810">.</span><span class="ident" id="5363811">lk</span><span class="op" id="5363813">.</span><span class="ident" id="5363814">Lock</span><span class="op" id="5363818">(</span><span class="op" id="5363819">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363822">defer</span>&nbsp;<span class="ident" id="5363828">sc</span><span class="op" id="5363830">.</span><span class="ident" id="5363831">lk</span><span class="op" id="5363833">.</span><span class="ident" id="5363834">Unlock</span><span class="op" id="5363840">(</span><span class="op" id="5363841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363844">return</span>&nbsp;<span class="ident" id="5363851">sc</span><span class="op" id="5363853">.</span><span class="ident" id="5363854">nread</span>&nbsp;<span class="op" id="5363860">-</span>&nbsp;<span class="ident" id="5363862">sc</span><span class="op" id="5363864">.</span><span class="ident" id="5363865">nwritten</span><br>
<span class="lineno"></span><span class="op" id="5363874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5363877">//&nbsp;Write&nbsp;writes&nbsp;resp&nbsp;in&nbsp;response&nbsp;to&nbsp;req.&nbsp;To&nbsp;close&nbsp;the&nbsp;connection&nbsp;gracefully,&nbsp;set&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="5363962">//&nbsp;Response.Close&nbsp;field&nbsp;to&nbsp;true.&nbsp;Write&nbsp;should&nbsp;be&nbsp;considered&nbsp;operational&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="5364040">//&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,&nbsp;regardless&nbsp;of&nbsp;any&nbsp;errors&nbsp;returned&nbsp;on&nbsp;the&nbsp;Read&nbsp;side.</span><br>
<span class="lineno"></span><span class="keyword" id="5364116">func</span>&nbsp;<span class="op" id="5364121">(</span><span class="ident" id="5364122">sc</span>&nbsp;<span class="op" id="5364125">*</span><span class="ident" id="5364126">ServerConn</span><span class="op" id="5364136">)</span>&nbsp;<span class="ident" id="5364138">Write</span><span class="op" id="5364143">(</span><span class="ident" id="5364144">req</span>&nbsp;<span class="op" id="5364148">*</span><span class="ident" id="5364149">http</span><span class="op" id="5364153">.</span><span class="ident" id="5364154">Request</span><span class="op" id="5364161">,</span>&nbsp;<span class="ident" id="5364163">resp</span>&nbsp;<span class="op" id="5364168">*</span><span class="ident" id="5364169">http</span><span class="op" id="5364173">.</span><span class="ident" id="5364174">Response</span><span class="op" id="5364182">)</span>&nbsp;<span class="builtintype" id="5364184">error</span>&nbsp;<span class="op" id="5364190">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5364194">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364253">sc</span><span class="op" id="5364255">.</span><span class="ident" id="5364256">lk</span><span class="op" id="5364258">.</span><span class="ident" id="5364259">Lock</span><span class="op" id="5364263">(</span><span class="op" id="5364264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364267">id</span><span class="op" id="5364269">,</span>&nbsp;<span class="ident" id="5364271">ok</span>&nbsp;<span class="op" id="5364274">:=</span>&nbsp;<span class="ident" id="5364277">sc</span><span class="op" id="5364279">.</span><span class="ident" id="5364280">pipereq</span><span class="op" id="5364287">[</span><span class="ident" id="5364288">req</span><span class="op" id="5364291">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5364294">delete</span><span class="op" id="5364300">(</span><span class="ident" id="5364301">sc</span><span class="op" id="5364303">.</span><span class="ident" id="5364304">pipereq</span><span class="op" id="5364311">,</span>&nbsp;<span class="ident" id="5364313">req</span><span class="op" id="5364316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364319">if</span>&nbsp;<span class="op" id="5364322">!</span><span class="ident" id="5364323">ok</span>&nbsp;<span class="op" id="5364326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364330">sc</span><span class="op" id="5364332">.</span><span class="ident" id="5364333">lk</span><span class="op" id="5364335">.</span><span class="ident" id="5364336">Unlock</span><span class="op" id="5364342">(</span><span class="op" id="5364343">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364347">return</span>&nbsp;<span class="ident" id="5364354">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5364367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364370">sc</span><span class="op" id="5364372">.</span><span class="ident" id="5364373">lk</span><span class="op" id="5364375">.</span><span class="ident" id="5364376">Unlock</span><span class="op" id="5364382">(</span><span class="op" id="5364383">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5364387">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364413">sc</span><span class="op" id="5364415">.</span><span class="ident" id="5364416">pipe</span><span class="op" id="5364420">.</span><span class="ident" id="5364421">StartResponse</span><span class="op" id="5364434">(</span><span class="ident" id="5364435">id</span><span class="op" id="5364437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364440">defer</span>&nbsp;<span class="ident" id="5364446">sc</span><span class="op" id="5364448">.</span><span class="ident" id="5364449">pipe</span><span class="op" id="5364453">.</span><span class="ident" id="5364454">EndResponse</span><span class="op" id="5364465">(</span><span class="ident" id="5364466">id</span><span class="op" id="5364468">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364472">sc</span><span class="op" id="5364474">.</span><span class="ident" id="5364475">lk</span><span class="op" id="5364477">.</span><span class="ident" id="5364478">Lock</span><span class="op" id="5364482">(</span><span class="op" id="5364483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364486">if</span>&nbsp;<span class="ident" id="5364489">sc</span><span class="op" id="5364491">.</span><span class="ident" id="5364492">we</span>&nbsp;<span class="op" id="5364495">!=</span>&nbsp;<span class="ident" id="5364498">nil</span>&nbsp;<span class="op" id="5364502">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364506">defer</span>&nbsp;<span class="ident" id="5364512">sc</span><span class="op" id="5364514">.</span><span class="ident" id="5364515">lk</span><span class="op" id="5364517">.</span><span class="ident" id="5364518">Unlock</span><span class="op" id="5364524">(</span><span class="op" id="5364525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364529">return</span>&nbsp;<span class="ident" id="5364536">sc</span><span class="op" id="5364538">.</span><span class="ident" id="5364539">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5364543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364546">if</span>&nbsp;<span class="ident" id="5364549">sc</span><span class="op" id="5364551">.</span><span class="ident" id="5364552">c</span>&nbsp;<span class="op" id="5364554">==</span>&nbsp;<span class="ident" id="5364557">nil</span>&nbsp;<span class="op" id="5364561">{</span>&nbsp;<span class="comment" id="5364563">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364610">defer</span>&nbsp;<span class="ident" id="5364616">sc</span><span class="op" id="5364618">.</span><span class="ident" id="5364619">lk</span><span class="op" id="5364621">.</span><span class="ident" id="5364622">Unlock</span><span class="op" id="5364628">(</span><span class="op" id="5364629">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364633">return</span>&nbsp;<span class="ident" id="5364640">ErrClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5364651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364654">c</span>&nbsp;<span class="op" id="5364656">:=</span>&nbsp;<span class="ident" id="5364659">sc</span><span class="op" id="5364661">.</span><span class="ident" id="5364662">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364665">if</span>&nbsp;<span class="ident" id="5364668">sc</span><span class="op" id="5364670">.</span><span class="ident" id="5364671">nread</span>&nbsp;<span class="op" id="5364677">&lt;=</span>&nbsp;<span class="ident" id="5364680">sc</span><span class="op" id="5364682">.</span><span class="ident" id="5364683">nwritten</span>&nbsp;<span class="op" id="5364692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364696">defer</span>&nbsp;<span class="ident" id="5364702">sc</span><span class="op" id="5364704">.</span><span class="ident" id="5364705">lk</span><span class="op" id="5364707">.</span><span class="ident" id="5364708">Unlock</span><span class="op" id="5364714">(</span><span class="op" id="5364715">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364719">return</span>&nbsp;<span class="ident" id="5364726">errors</span><span class="op" id="5364732">.</span><span class="ident" id="5364733">New</span><span class="op" id="5364736">(</span><span class="string" id="5364737">&#34;persist&nbsp;server&nbsp;pipe&nbsp;count&#34;</span><span class="op" id="5364764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5364767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364770">if</span>&nbsp;<span class="ident" id="5364773">resp</span><span class="op" id="5364777">.</span><span class="ident" id="5364778">Close</span>&nbsp;<span class="op" id="5364784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5364788">//&nbsp;After&nbsp;signaling&nbsp;a&nbsp;keep-alive&nbsp;close,&nbsp;any&nbsp;pipelined&nbsp;unread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5364850">//&nbsp;requests&nbsp;will&nbsp;be&nbsp;lost.&nbsp;It&nbsp;is&nbsp;up&nbsp;to&nbsp;the&nbsp;user&nbsp;to&nbsp;drain&nbsp;them</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5364913">//&nbsp;before&nbsp;signaling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364936">sc</span><span class="op" id="5364938">.</span><span class="ident" id="5364939">re</span>&nbsp;<span class="op" id="5364942">=</span>&nbsp;<span class="ident" id="5364944">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5364959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364962">sc</span><span class="op" id="5364964">.</span><span class="ident" id="5364965">lk</span><span class="op" id="5364967">.</span><span class="ident" id="5364968">Unlock</span><span class="op" id="5364974">(</span><span class="op" id="5364975">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364979">err</span>&nbsp;<span class="op" id="5364983">:=</span>&nbsp;<span class="ident" id="5364986">resp</span><span class="op" id="5364990">.</span><span class="ident" id="5364991">Write</span><span class="op" id="5364996">(</span><span class="ident" id="5364997">c</span><span class="op" id="5364998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365001">sc</span><span class="op" id="5365003">.</span><span class="ident" id="5365004">lk</span><span class="op" id="5365006">.</span><span class="ident" id="5365007">Lock</span><span class="op" id="5365011">(</span><span class="op" id="5365012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5365015">defer</span>&nbsp;<span class="ident" id="5365021">sc</span><span class="op" id="5365023">.</span><span class="ident" id="5365024">lk</span><span class="op" id="5365026">.</span><span class="ident" id="5365027">Unlock</span><span class="op" id="5365033">(</span><span class="op" id="5365034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5365037">if</span>&nbsp;<span class="ident" id="5365040">err</span>&nbsp;<span class="op" id="5365044">!=</span>&nbsp;<span class="ident" id="5365047">nil</span>&nbsp;<span class="op" id="5365051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365055">sc</span><span class="op" id="5365057">.</span><span class="ident" id="5365058">we</span>&nbsp;<span class="op" id="5365061">=</span>&nbsp;<span class="ident" id="5365063">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5365069">return</span>&nbsp;<span class="ident" id="5365076">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5365081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365084">sc</span><span class="op" id="5365086">.</span><span class="ident" id="5365087">nwritten</span><span class="op" id="5365095">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5365100">return</span>&nbsp;<span class="ident" id="5365107">nil</span><br>
<span class="lineno">220</span><span class="op" id="5365111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5365114">//&nbsp;A&nbsp;ClientConn&nbsp;sends&nbsp;request&nbsp;and&nbsp;receives&nbsp;headers&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="5365184">//&nbsp;connection,&nbsp;while&nbsp;respecting&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic.&nbsp;ClientConn</span><br>
<span class="lineno"></span><span class="comment" id="5365253">//&nbsp;supports&nbsp;hijacking&nbsp;the&nbsp;connection&nbsp;calling&nbsp;Hijack&nbsp;to</span><br>
<span class="lineno">225</span><span class="comment" id="5365308">//&nbsp;regain&nbsp;control&nbsp;of&nbsp;the&nbsp;underlying&nbsp;net.Conn&nbsp;and&nbsp;deal&nbsp;with&nbsp;it&nbsp;as&nbsp;desired.</span><br>
<span class="lineno"></span><span class="comment" id="5365382">//</span><br>
<span class="lineno"></span><span class="comment" id="5365385">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="5365453">//&nbsp;Client&nbsp;or&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5365501">type</span>&nbsp;<span class="ident" id="5365506">ClientConn</span>&nbsp;<span class="keyword" id="5365517">struct</span>&nbsp;<span class="op" id="5365524">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365527">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5365543">sync</span><span class="op" id="5365547">.</span><span class="ident" id="5365548">Mutex</span>&nbsp;<span class="comment" id="5365554">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365599">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5365615">net</span><span class="op" id="5365618">.</span><span class="ident" id="5365619">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365625">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5365641">*</span><span class="ident" id="5365642">bufio</span><span class="op" id="5365647">.</span><span class="ident" id="5365648">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365656">re</span><span class="op" id="5365658">,</span>&nbsp;<span class="ident" id="5365660">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5365672">error</span>&nbsp;<span class="comment" id="5365678">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365700">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5365716">io</span><span class="op" id="5365718">.</span><span class="ident" id="5365719">ReadCloser</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365731">nread</span><span class="op" id="5365736">,</span>&nbsp;<span class="ident" id="5365738">nwritten</span>&nbsp;<span class="builtintype" id="5365747">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365752">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5365768">map</span><span class="op" id="5365771">[</span><span class="op" id="5365772">*</span><span class="ident" id="5365773">http</span><span class="op" id="5365777">.</span><span class="ident" id="5365778">Request</span><span class="op" id="5365785">]</span><span class="builtintype" id="5365786">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365793">pipe</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5365802">textproto</span><span class="op" id="5365811">.</span><span class="ident" id="5365812">Pipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365822">writeReq</span>&nbsp;<span class="keyword" id="5365831">func</span><span class="op" id="5365835">(</span><span class="op" id="5365836">*</span><span class="ident" id="5365837">http</span><span class="op" id="5365841">.</span><span class="ident" id="5365842">Request</span><span class="op" id="5365849">,</span>&nbsp;<span class="ident" id="5365851">io</span><span class="op" id="5365853">.</span><span class="ident" id="5365854">Writer</span><span class="op" id="5365860">)</span>&nbsp;<span class="builtintype" id="5365862">error</span><br>
<span class="lineno">240</span><span class="op" id="5365868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5365871">//&nbsp;NewClientConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ClientConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="5365949">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno"></span><span class="comment" id="5365997">//</span><br>
<span class="lineno">245</span><span class="comment" id="5366000">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;use&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5366070">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5366108">func</span>&nbsp;<span class="ident" id="5366113">NewClientConn</span><span class="op" id="5366126">(</span><span class="ident" id="5366127">c</span>&nbsp;<span class="ident" id="5366129">net</span><span class="op" id="5366132">.</span><span class="ident" id="5366133">Conn</span><span class="op" id="5366137">,</span>&nbsp;<span class="ident" id="5366139">r</span>&nbsp;<span class="op" id="5366141">*</span><span class="ident" id="5366142">bufio</span><span class="op" id="5366147">.</span><span class="ident" id="5366148">Reader</span><span class="op" id="5366154">)</span>&nbsp;<span class="op" id="5366156">*</span><span class="ident" id="5366157">ClientConn</span>&nbsp;<span class="op" id="5366168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5366171">if</span>&nbsp;<span class="ident" id="5366174">r</span>&nbsp;<span class="op" id="5366176">==</span>&nbsp;<span class="ident" id="5366179">nil</span>&nbsp;<span class="op" id="5366183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366187">r</span>&nbsp;<span class="op" id="5366189">=</span>&nbsp;<span class="ident" id="5366191">bufio</span><span class="op" id="5366196">.</span><span class="ident" id="5366197">NewReader</span><span class="op" id="5366206">(</span><span class="ident" id="5366207">c</span><span class="op" id="5366208">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5366211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5366214">return</span>&nbsp;<span class="op" id="5366221">&amp;</span><span class="ident" id="5366222">ClientConn</span><span class="op" id="5366232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366236">c</span><span class="op" id="5366237">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5366246">c</span><span class="op" id="5366247">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366251">r</span><span class="op" id="5366252">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5366261">r</span><span class="op" id="5366262">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366266">pipereq</span><span class="op" id="5366273">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5366276">make</span><span class="op" id="5366280">(</span><span class="keyword" id="5366281">map</span><span class="op" id="5366284">[</span><span class="op" id="5366285">*</span><span class="ident" id="5366286">http</span><span class="op" id="5366290">.</span><span class="ident" id="5366291">Request</span><span class="op" id="5366298">]</span><span class="builtintype" id="5366299">uint</span><span class="op" id="5366303">)</span><span class="op" id="5366304">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366308">writeReq</span><span class="op" id="5366316">:</span>&nbsp;<span class="op" id="5366318">(</span><span class="op" id="5366319">*</span><span class="ident" id="5366320">http</span><span class="op" id="5366324">.</span><span class="ident" id="5366325">Request</span><span class="op" id="5366332">)</span><span class="op" id="5366333">.</span><span class="ident" id="5366334">Write</span><span class="op" id="5366339">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5366342">}</span><br>
<span class="lineno"></span><span class="op" id="5366344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5366347">//&nbsp;NewProxyClientConn&nbsp;works&nbsp;like&nbsp;NewClientConn&nbsp;but&nbsp;writes&nbsp;Requests</span><br>
<span class="lineno">260</span><span class="comment" id="5366414">//&nbsp;using&nbsp;Request&#39;s&nbsp;WriteProxy&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="5366452">//</span><br>
<span class="lineno"></span><span class="comment" id="5366455">//&nbsp;New&nbsp;code&nbsp;should&nbsp;not&nbsp;use&nbsp;NewProxyClientConn.&nbsp;See&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5366516">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="5366562">func</span>&nbsp;<span class="ident" id="5366567">NewProxyClientConn</span><span class="op" id="5366585">(</span><span class="ident" id="5366586">c</span>&nbsp;<span class="ident" id="5366588">net</span><span class="op" id="5366591">.</span><span class="ident" id="5366592">Conn</span><span class="op" id="5366596">,</span>&nbsp;<span class="ident" id="5366598">r</span>&nbsp;<span class="op" id="5366600">*</span><span class="ident" id="5366601">bufio</span><span class="op" id="5366606">.</span><span class="ident" id="5366607">Reader</span><span class="op" id="5366613">)</span>&nbsp;<span class="op" id="5366615">*</span><span class="ident" id="5366616">ClientConn</span>&nbsp;<span class="op" id="5366627">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366630">cc</span>&nbsp;<span class="op" id="5366633">:=</span>&nbsp;<span class="ident" id="5366636">NewClientConn</span><span class="op" id="5366649">(</span><span class="ident" id="5366650">c</span><span class="op" id="5366651">,</span>&nbsp;<span class="ident" id="5366653">r</span><span class="op" id="5366654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366657">cc</span><span class="op" id="5366659">.</span><span class="ident" id="5366660">writeReq</span>&nbsp;<span class="op" id="5366669">=</span>&nbsp;<span class="op" id="5366671">(</span><span class="op" id="5366672">*</span><span class="ident" id="5366673">http</span><span class="op" id="5366677">.</span><span class="ident" id="5366678">Request</span><span class="op" id="5366685">)</span><span class="op" id="5366686">.</span><span class="ident" id="5366687">WriteProxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5366699">return</span>&nbsp;<span class="ident" id="5366706">cc</span><br>
<span class="lineno"></span><span class="op" id="5366709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="5366712">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ClientConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="5366792">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5366868">//&nbsp;called&nbsp;before&nbsp;the&nbsp;user&nbsp;or&nbsp;Read&nbsp;have&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive</span><br>
<span class="lineno"></span><span class="comment" id="5366942">//&nbsp;logic.&nbsp;The&nbsp;user&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="5367020">func</span>&nbsp;<span class="op" id="5367025">(</span><span class="ident" id="5367026">cc</span>&nbsp;<span class="op" id="5367029">*</span><span class="ident" id="5367030">ClientConn</span><span class="op" id="5367040">)</span>&nbsp;<span class="ident" id="5367042">Hijack</span><span class="op" id="5367048">(</span><span class="op" id="5367049">)</span>&nbsp;<span class="op" id="5367051">(</span><span class="ident" id="5367052">c</span>&nbsp;<span class="ident" id="5367054">net</span><span class="op" id="5367057">.</span><span class="ident" id="5367058">Conn</span><span class="op" id="5367062">,</span>&nbsp;<span class="ident" id="5367064">r</span>&nbsp;<span class="op" id="5367066">*</span><span class="ident" id="5367067">bufio</span><span class="op" id="5367072">.</span><span class="ident" id="5367073">Reader</span><span class="op" id="5367079">)</span>&nbsp;<span class="op" id="5367081">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367084">cc</span><span class="op" id="5367086">.</span><span class="ident" id="5367087">lk</span><span class="op" id="5367089">.</span><span class="ident" id="5367090">Lock</span><span class="op" id="5367094">(</span><span class="op" id="5367095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367098">defer</span>&nbsp;<span class="ident" id="5367104">cc</span><span class="op" id="5367106">.</span><span class="ident" id="5367107">lk</span><span class="op" id="5367109">.</span><span class="ident" id="5367110">Unlock</span><span class="op" id="5367116">(</span><span class="op" id="5367117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367120">c</span>&nbsp;<span class="op" id="5367122">=</span>&nbsp;<span class="ident" id="5367124">cc</span><span class="op" id="5367126">.</span><span class="ident" id="5367127">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367130">r</span>&nbsp;<span class="op" id="5367132">=</span>&nbsp;<span class="ident" id="5367134">cc</span><span class="op" id="5367136">.</span><span class="ident" id="5367137">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367140">cc</span><span class="op" id="5367142">.</span><span class="ident" id="5367143">c</span>&nbsp;<span class="op" id="5367145">=</span>&nbsp;<span class="ident" id="5367147">nil</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367152">cc</span><span class="op" id="5367154">.</span><span class="ident" id="5367155">r</span>&nbsp;<span class="op" id="5367157">=</span>&nbsp;<span class="ident" id="5367159">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367164">return</span><br>
<span class="lineno"></span><span class="op" id="5367171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5367174">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">285</span><span class="keyword" id="5367243">func</span>&nbsp;<span class="op" id="5367248">(</span><span class="ident" id="5367249">cc</span>&nbsp;<span class="op" id="5367252">*</span><span class="ident" id="5367253">ClientConn</span><span class="op" id="5367263">)</span>&nbsp;<span class="ident" id="5367265">Close</span><span class="op" id="5367270">(</span><span class="op" id="5367271">)</span>&nbsp;<span class="builtintype" id="5367273">error</span>&nbsp;<span class="op" id="5367279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367282">c</span><span class="op" id="5367283">,</span>&nbsp;<span class="ident" id="5367285">_</span>&nbsp;<span class="op" id="5367287">:=</span>&nbsp;<span class="ident" id="5367290">cc</span><span class="op" id="5367292">.</span><span class="ident" id="5367293">Hijack</span><span class="op" id="5367299">(</span><span class="op" id="5367300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367303">if</span>&nbsp;<span class="ident" id="5367306">c</span>&nbsp;<span class="op" id="5367308">!=</span>&nbsp;<span class="ident" id="5367311">nil</span>&nbsp;<span class="op" id="5367315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367319">return</span>&nbsp;<span class="ident" id="5367326">c</span><span class="op" id="5367327">.</span><span class="ident" id="5367328">Close</span><span class="op" id="5367333">(</span><span class="op" id="5367334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5367337">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367340">return</span>&nbsp;<span class="ident" id="5367347">nil</span><br>
<span class="lineno"></span><span class="op" id="5367351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5367354">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;request.&nbsp;An&nbsp;ErrPersistEOF&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5367434">//&nbsp;has&nbsp;been&nbsp;closed&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;keepalive&nbsp;sense.&nbsp;If&nbsp;req.Close&nbsp;equals&nbsp;true,&nbsp;the</span><br>
<span class="lineno">295</span><span class="comment" id="5367511">//&nbsp;keepalive&nbsp;connection&nbsp;is&nbsp;logically&nbsp;closed&nbsp;after&nbsp;this&nbsp;request&nbsp;and&nbsp;the&nbsp;opposing</span><br>
<span class="lineno"></span><span class="comment" id="5367591">//&nbsp;server&nbsp;is&nbsp;informed.&nbsp;An&nbsp;ErrUnexpectedEOF&nbsp;indicates&nbsp;the&nbsp;remote&nbsp;closed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5367666">//&nbsp;underlying&nbsp;TCP&nbsp;connection,&nbsp;which&nbsp;is&nbsp;usually&nbsp;considered&nbsp;as&nbsp;graceful&nbsp;close.</span><br>
<span class="lineno"></span><span class="keyword" id="5367743">func</span>&nbsp;<span class="op" id="5367748">(</span><span class="ident" id="5367749">cc</span>&nbsp;<span class="op" id="5367752">*</span><span class="ident" id="5367753">ClientConn</span><span class="op" id="5367763">)</span>&nbsp;<span class="ident" id="5367765">Write</span><span class="op" id="5367770">(</span><span class="ident" id="5367771">req</span>&nbsp;<span class="op" id="5367775">*</span><span class="ident" id="5367776">http</span><span class="op" id="5367780">.</span><span class="ident" id="5367781">Request</span><span class="op" id="5367788">)</span>&nbsp;<span class="op" id="5367790">(</span><span class="ident" id="5367791">err</span>&nbsp;<span class="builtintype" id="5367795">error</span><span class="op" id="5367800">)</span>&nbsp;<span class="op" id="5367802">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5367806">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367845">id</span>&nbsp;<span class="op" id="5367848">:=</span>&nbsp;<span class="ident" id="5367851">cc</span><span class="op" id="5367853">.</span><span class="ident" id="5367854">pipe</span><span class="op" id="5367858">.</span><span class="ident" id="5367859">Next</span><span class="op" id="5367863">(</span><span class="op" id="5367864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367867">cc</span><span class="op" id="5367869">.</span><span class="ident" id="5367870">pipe</span><span class="op" id="5367874">.</span><span class="ident" id="5367875">StartRequest</span><span class="op" id="5367887">(</span><span class="ident" id="5367888">id</span><span class="op" id="5367890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367893">defer</span>&nbsp;<span class="keyword" id="5367899">func</span><span class="op" id="5367903">(</span><span class="op" id="5367904">)</span>&nbsp;<span class="op" id="5367906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367910">cc</span><span class="op" id="5367912">.</span><span class="ident" id="5367913">pipe</span><span class="op" id="5367917">.</span><span class="ident" id="5367918">EndRequest</span><span class="op" id="5367928">(</span><span class="ident" id="5367929">id</span><span class="op" id="5367931">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367935">if</span>&nbsp;<span class="ident" id="5367938">err</span>&nbsp;<span class="op" id="5367942">!=</span>&nbsp;<span class="ident" id="5367945">nil</span>&nbsp;<span class="op" id="5367949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367954">cc</span><span class="op" id="5367956">.</span><span class="ident" id="5367957">pipe</span><span class="op" id="5367961">.</span><span class="ident" id="5367962">StartResponse</span><span class="op" id="5367975">(</span><span class="ident" id="5367976">id</span><span class="op" id="5367978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367983">cc</span><span class="op" id="5367985">.</span><span class="ident" id="5367986">pipe</span><span class="op" id="5367990">.</span><span class="ident" id="5367991">EndResponse</span><span class="op" id="5368002">(</span><span class="ident" id="5368003">id</span><span class="op" id="5368005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368009">}</span>&nbsp;<span class="keyword" id="5368011">else</span>&nbsp;<span class="op" id="5368016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5368021">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368068">cc</span><span class="op" id="5368070">.</span><span class="ident" id="5368071">lk</span><span class="op" id="5368073">.</span><span class="ident" id="5368074">Lock</span><span class="op" id="5368078">(</span><span class="op" id="5368079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368084">cc</span><span class="op" id="5368086">.</span><span class="ident" id="5368087">pipereq</span><span class="op" id="5368094">[</span><span class="ident" id="5368095">req</span><span class="op" id="5368098">]</span>&nbsp;<span class="op" id="5368100">=</span>&nbsp;<span class="ident" id="5368102">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368108">cc</span><span class="op" id="5368110">.</span><span class="ident" id="5368111">lk</span><span class="op" id="5368113">.</span><span class="ident" id="5368114">Unlock</span><span class="op" id="5368120">(</span><span class="op" id="5368121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368128">}</span><span class="op" id="5368129">(</span><span class="op" id="5368130">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368134">cc</span><span class="op" id="5368136">.</span><span class="ident" id="5368137">lk</span><span class="op" id="5368139">.</span><span class="ident" id="5368140">Lock</span><span class="op" id="5368144">(</span><span class="op" id="5368145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368148">if</span>&nbsp;<span class="ident" id="5368151">cc</span><span class="op" id="5368153">.</span><span class="ident" id="5368154">re</span>&nbsp;<span class="op" id="5368157">!=</span>&nbsp;<span class="ident" id="5368160">nil</span>&nbsp;<span class="op" id="5368164">{</span>&nbsp;<span class="comment" id="5368166">//&nbsp;no&nbsp;point&nbsp;sending&nbsp;if&nbsp;read-side&nbsp;closed&nbsp;or&nbsp;broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368218">defer</span>&nbsp;<span class="ident" id="5368224">cc</span><span class="op" id="5368226">.</span><span class="ident" id="5368227">lk</span><span class="op" id="5368229">.</span><span class="ident" id="5368230">Unlock</span><span class="op" id="5368236">(</span><span class="op" id="5368237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368241">return</span>&nbsp;<span class="ident" id="5368248">cc</span><span class="op" id="5368250">.</span><span class="ident" id="5368251">re</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368258">if</span>&nbsp;<span class="ident" id="5368261">cc</span><span class="op" id="5368263">.</span><span class="ident" id="5368264">we</span>&nbsp;<span class="op" id="5368267">!=</span>&nbsp;<span class="ident" id="5368270">nil</span>&nbsp;<span class="op" id="5368274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368278">defer</span>&nbsp;<span class="ident" id="5368284">cc</span><span class="op" id="5368286">.</span><span class="ident" id="5368287">lk</span><span class="op" id="5368289">.</span><span class="ident" id="5368290">Unlock</span><span class="op" id="5368296">(</span><span class="op" id="5368297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368301">return</span>&nbsp;<span class="ident" id="5368308">cc</span><span class="op" id="5368310">.</span><span class="ident" id="5368311">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368315">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368318">if</span>&nbsp;<span class="ident" id="5368321">cc</span><span class="op" id="5368323">.</span><span class="ident" id="5368324">c</span>&nbsp;<span class="op" id="5368326">==</span>&nbsp;<span class="ident" id="5368329">nil</span>&nbsp;<span class="op" id="5368333">{</span>&nbsp;<span class="comment" id="5368335">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368382">defer</span>&nbsp;<span class="ident" id="5368388">cc</span><span class="op" id="5368390">.</span><span class="ident" id="5368391">lk</span><span class="op" id="5368393">.</span><span class="ident" id="5368394">Unlock</span><span class="op" id="5368400">(</span><span class="op" id="5368401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368405">return</span>&nbsp;<span class="ident" id="5368412">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368426">c</span>&nbsp;<span class="op" id="5368428">:=</span>&nbsp;<span class="ident" id="5368431">cc</span><span class="op" id="5368433">.</span><span class="ident" id="5368434">c</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368437">if</span>&nbsp;<span class="ident" id="5368440">req</span><span class="op" id="5368443">.</span><span class="ident" id="5368444">Close</span>&nbsp;<span class="op" id="5368450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5368454">//&nbsp;We&nbsp;write&nbsp;the&nbsp;EOF&nbsp;to&nbsp;the&nbsp;write-side&nbsp;error,&nbsp;because&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5368515">//&nbsp;still&nbsp;might&nbsp;be&nbsp;some&nbsp;pipelined&nbsp;reads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368556">cc</span><span class="op" id="5368558">.</span><span class="ident" id="5368559">we</span>&nbsp;<span class="op" id="5368562">=</span>&nbsp;<span class="ident" id="5368564">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368579">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368582">cc</span><span class="op" id="5368584">.</span><span class="ident" id="5368585">lk</span><span class="op" id="5368587">.</span><span class="ident" id="5368588">Unlock</span><span class="op" id="5368594">(</span><span class="op" id="5368595">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368599">err</span>&nbsp;<span class="op" id="5368603">=</span>&nbsp;<span class="ident" id="5368605">cc</span><span class="op" id="5368607">.</span><span class="ident" id="5368608">writeReq</span><span class="op" id="5368616">(</span><span class="ident" id="5368617">req</span><span class="op" id="5368620">,</span>&nbsp;<span class="ident" id="5368622">c</span><span class="op" id="5368623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368626">cc</span><span class="op" id="5368628">.</span><span class="ident" id="5368629">lk</span><span class="op" id="5368631">.</span><span class="ident" id="5368632">Lock</span><span class="op" id="5368636">(</span><span class="op" id="5368637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368640">defer</span>&nbsp;<span class="ident" id="5368646">cc</span><span class="op" id="5368648">.</span><span class="ident" id="5368649">lk</span><span class="op" id="5368651">.</span><span class="ident" id="5368652">Unlock</span><span class="op" id="5368658">(</span><span class="op" id="5368659">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368662">if</span>&nbsp;<span class="ident" id="5368665">err</span>&nbsp;<span class="op" id="5368669">!=</span>&nbsp;<span class="ident" id="5368672">nil</span>&nbsp;<span class="op" id="5368676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368680">cc</span><span class="op" id="5368682">.</span><span class="ident" id="5368683">we</span>&nbsp;<span class="op" id="5368686">=</span>&nbsp;<span class="ident" id="5368688">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368694">return</span>&nbsp;<span class="ident" id="5368701">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368709">cc</span><span class="op" id="5368711">.</span><span class="ident" id="5368712">nwritten</span><span class="op" id="5368720">++</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368725">return</span>&nbsp;<span class="ident" id="5368732">nil</span><br>
<span class="lineno"></span><span class="op" id="5368736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5368739">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno">350</span><span class="comment" id="5368792">//&nbsp;that&nbsp;have&nbsp;been&nbsp;sent&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5368834">func</span>&nbsp;<span class="op" id="5368839">(</span><span class="ident" id="5368840">cc</span>&nbsp;<span class="op" id="5368843">*</span><span class="ident" id="5368844">ClientConn</span><span class="op" id="5368854">)</span>&nbsp;<span class="ident" id="5368856">Pending</span><span class="op" id="5368863">(</span><span class="op" id="5368864">)</span>&nbsp;<span class="builtintype" id="5368866">int</span>&nbsp;<span class="op" id="5368870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368873">cc</span><span class="op" id="5368875">.</span><span class="ident" id="5368876">lk</span><span class="op" id="5368878">.</span><span class="ident" id="5368879">Lock</span><span class="op" id="5368883">(</span><span class="op" id="5368884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368887">defer</span>&nbsp;<span class="ident" id="5368893">cc</span><span class="op" id="5368895">.</span><span class="ident" id="5368896">lk</span><span class="op" id="5368898">.</span><span class="ident" id="5368899">Unlock</span><span class="op" id="5368905">(</span><span class="op" id="5368906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368909">return</span>&nbsp;<span class="ident" id="5368916">cc</span><span class="op" id="5368918">.</span><span class="ident" id="5368919">nwritten</span>&nbsp;<span class="op" id="5368928">-</span>&nbsp;<span class="ident" id="5368930">cc</span><span class="op" id="5368932">.</span><span class="ident" id="5368933">nread</span><br>
<span class="lineno">355</span><span class="op" id="5368939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5368942">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;next&nbsp;response&nbsp;from&nbsp;the&nbsp;wire.&nbsp;A&nbsp;valid&nbsp;response&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5369015">//&nbsp;returned&nbsp;together&nbsp;with&nbsp;an&nbsp;ErrPersistEOF,&nbsp;which&nbsp;means&nbsp;that&nbsp;the&nbsp;remote</span><br>
<span class="lineno"></span><span class="comment" id="5369087">//&nbsp;requested&nbsp;that&nbsp;this&nbsp;be&nbsp;the&nbsp;last&nbsp;request&nbsp;serviced.&nbsp;Read&nbsp;can&nbsp;be&nbsp;called</span><br>
<span class="lineno">360</span><span class="comment" id="5369159">//&nbsp;concurrently&nbsp;with&nbsp;Write,&nbsp;but&nbsp;not&nbsp;with&nbsp;another&nbsp;Read.</span><br>
<span class="lineno"></span><span class="keyword" id="5369214">func</span>&nbsp;<span class="op" id="5369219">(</span><span class="ident" id="5369220">cc</span>&nbsp;<span class="op" id="5369223">*</span><span class="ident" id="5369224">ClientConn</span><span class="op" id="5369234">)</span>&nbsp;<span class="ident" id="5369236">Read</span><span class="op" id="5369240">(</span><span class="ident" id="5369241">req</span>&nbsp;<span class="op" id="5369245">*</span><span class="ident" id="5369246">http</span><span class="op" id="5369250">.</span><span class="ident" id="5369251">Request</span><span class="op" id="5369258">)</span>&nbsp;<span class="op" id="5369260">(</span><span class="ident" id="5369261">resp</span>&nbsp;<span class="op" id="5369266">*</span><span class="ident" id="5369267">http</span><span class="op" id="5369271">.</span><span class="ident" id="5369272">Response</span><span class="op" id="5369280">,</span>&nbsp;<span class="ident" id="5369282">err</span>&nbsp;<span class="builtintype" id="5369286">error</span><span class="op" id="5369291">)</span>&nbsp;<span class="op" id="5369293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5369296">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369355">cc</span><span class="op" id="5369357">.</span><span class="ident" id="5369358">lk</span><span class="op" id="5369360">.</span><span class="ident" id="5369361">Lock</span><span class="op" id="5369365">(</span><span class="op" id="5369366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369369">id</span><span class="op" id="5369371">,</span>&nbsp;<span class="ident" id="5369373">ok</span>&nbsp;<span class="op" id="5369376">:=</span>&nbsp;<span class="ident" id="5369379">cc</span><span class="op" id="5369381">.</span><span class="ident" id="5369382">pipereq</span><span class="op" id="5369389">[</span><span class="ident" id="5369390">req</span><span class="op" id="5369393">]</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5369396">delete</span><span class="op" id="5369402">(</span><span class="ident" id="5369403">cc</span><span class="op" id="5369405">.</span><span class="ident" id="5369406">pipereq</span><span class="op" id="5369413">,</span>&nbsp;<span class="ident" id="5369415">req</span><span class="op" id="5369418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369421">if</span>&nbsp;<span class="op" id="5369424">!</span><span class="ident" id="5369425">ok</span>&nbsp;<span class="op" id="5369428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369432">cc</span><span class="op" id="5369434">.</span><span class="ident" id="5369435">lk</span><span class="op" id="5369437">.</span><span class="ident" id="5369438">Unlock</span><span class="op" id="5369444">(</span><span class="op" id="5369445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369449">return</span>&nbsp;<span class="ident" id="5369456">nil</span><span class="op" id="5369459">,</span>&nbsp;<span class="ident" id="5369461">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5369474">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369477">cc</span><span class="op" id="5369479">.</span><span class="ident" id="5369480">lk</span><span class="op" id="5369482">.</span><span class="ident" id="5369483">Unlock</span><span class="op" id="5369489">(</span><span class="op" id="5369490">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5369494">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369520">cc</span><span class="op" id="5369522">.</span><span class="ident" id="5369523">pipe</span><span class="op" id="5369527">.</span><span class="ident" id="5369528">StartResponse</span><span class="op" id="5369541">(</span><span class="ident" id="5369542">id</span><span class="op" id="5369544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369547">defer</span>&nbsp;<span class="ident" id="5369553">cc</span><span class="op" id="5369555">.</span><span class="ident" id="5369556">pipe</span><span class="op" id="5369560">.</span><span class="ident" id="5369561">EndResponse</span><span class="op" id="5369572">(</span><span class="ident" id="5369573">id</span><span class="op" id="5369575">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369579">cc</span><span class="op" id="5369581">.</span><span class="ident" id="5369582">lk</span><span class="op" id="5369584">.</span><span class="ident" id="5369585">Lock</span><span class="op" id="5369589">(</span><span class="op" id="5369590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369593">if</span>&nbsp;<span class="ident" id="5369596">cc</span><span class="op" id="5369598">.</span><span class="ident" id="5369599">re</span>&nbsp;<span class="op" id="5369602">!=</span>&nbsp;<span class="ident" id="5369605">nil</span>&nbsp;<span class="op" id="5369609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369613">defer</span>&nbsp;<span class="ident" id="5369619">cc</span><span class="op" id="5369621">.</span><span class="ident" id="5369622">lk</span><span class="op" id="5369624">.</span><span class="ident" id="5369625">Unlock</span><span class="op" id="5369631">(</span><span class="op" id="5369632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369636">return</span>&nbsp;<span class="ident" id="5369643">nil</span><span class="op" id="5369646">,</span>&nbsp;<span class="ident" id="5369648">cc</span><span class="op" id="5369650">.</span><span class="ident" id="5369651">re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5369655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369658">if</span>&nbsp;<span class="ident" id="5369661">cc</span><span class="op" id="5369663">.</span><span class="ident" id="5369664">r</span>&nbsp;<span class="op" id="5369666">==</span>&nbsp;<span class="ident" id="5369669">nil</span>&nbsp;<span class="op" id="5369673">{</span>&nbsp;<span class="comment" id="5369675">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369722">defer</span>&nbsp;<span class="ident" id="5369728">cc</span><span class="op" id="5369730">.</span><span class="ident" id="5369731">lk</span><span class="op" id="5369733">.</span><span class="ident" id="5369734">Unlock</span><span class="op" id="5369740">(</span><span class="op" id="5369741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369745">return</span>&nbsp;<span class="ident" id="5369752">nil</span><span class="op" id="5369755">,</span>&nbsp;<span class="ident" id="5369757">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5369768">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369771">r</span>&nbsp;<span class="op" id="5369773">:=</span>&nbsp;<span class="ident" id="5369776">cc</span><span class="op" id="5369778">.</span><span class="ident" id="5369779">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369782">lastbody</span>&nbsp;<span class="op" id="5369791">:=</span>&nbsp;<span class="ident" id="5369794">cc</span><span class="op" id="5369796">.</span><span class="ident" id="5369797">lastbody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369807">cc</span><span class="op" id="5369809">.</span><span class="ident" id="5369810">lastbody</span>&nbsp;<span class="op" id="5369819">=</span>&nbsp;<span class="ident" id="5369821">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369826">cc</span><span class="op" id="5369828">.</span><span class="ident" id="5369829">lk</span><span class="op" id="5369831">.</span><span class="ident" id="5369832">Unlock</span><span class="op" id="5369838">(</span><span class="op" id="5369839">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5369843">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369919">if</span>&nbsp;<span class="ident" id="5369922">lastbody</span>&nbsp;<span class="op" id="5369931">!=</span>&nbsp;<span class="ident" id="5369934">nil</span>&nbsp;<span class="op" id="5369938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5369942">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5370008">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5370066">//&nbsp;returned.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370081">err</span>&nbsp;<span class="op" id="5370085">=</span>&nbsp;<span class="ident" id="5370087">lastbody</span><span class="op" id="5370095">.</span><span class="ident" id="5370096">Close</span><span class="op" id="5370101">(</span><span class="op" id="5370102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370106">if</span>&nbsp;<span class="ident" id="5370109">err</span>&nbsp;<span class="op" id="5370113">!=</span>&nbsp;<span class="ident" id="5370116">nil</span>&nbsp;<span class="op" id="5370120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370125">cc</span><span class="op" id="5370127">.</span><span class="ident" id="5370128">lk</span><span class="op" id="5370130">.</span><span class="ident" id="5370131">Lock</span><span class="op" id="5370135">(</span><span class="op" id="5370136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370141">defer</span>&nbsp;<span class="ident" id="5370147">cc</span><span class="op" id="5370149">.</span><span class="ident" id="5370150">lk</span><span class="op" id="5370152">.</span><span class="ident" id="5370153">Unlock</span><span class="op" id="5370159">(</span><span class="op" id="5370160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370165">cc</span><span class="op" id="5370167">.</span><span class="ident" id="5370168">re</span>&nbsp;<span class="op" id="5370171">=</span>&nbsp;<span class="ident" id="5370173">err</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370180">return</span>&nbsp;<span class="ident" id="5370187">nil</span><span class="op" id="5370190">,</span>&nbsp;<span class="ident" id="5370192">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370205">resp</span><span class="op" id="5370209">,</span>&nbsp;<span class="ident" id="5370211">err</span>&nbsp;<span class="op" id="5370215">=</span>&nbsp;<span class="ident" id="5370217">http</span><span class="op" id="5370221">.</span><span class="ident" id="5370222">ReadResponse</span><span class="op" id="5370234">(</span><span class="ident" id="5370235">r</span><span class="op" id="5370236">,</span>&nbsp;<span class="ident" id="5370238">req</span><span class="op" id="5370241">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370244">cc</span><span class="op" id="5370246">.</span><span class="ident" id="5370247">lk</span><span class="op" id="5370249">.</span><span class="ident" id="5370250">Lock</span><span class="op" id="5370254">(</span><span class="op" id="5370255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370258">defer</span>&nbsp;<span class="ident" id="5370264">cc</span><span class="op" id="5370266">.</span><span class="ident" id="5370267">lk</span><span class="op" id="5370269">.</span><span class="ident" id="5370270">Unlock</span><span class="op" id="5370276">(</span><span class="op" id="5370277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370280">if</span>&nbsp;<span class="ident" id="5370283">err</span>&nbsp;<span class="op" id="5370287">!=</span>&nbsp;<span class="ident" id="5370290">nil</span>&nbsp;<span class="op" id="5370294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370298">cc</span><span class="op" id="5370300">.</span><span class="ident" id="5370301">re</span>&nbsp;<span class="op" id="5370304">=</span>&nbsp;<span class="ident" id="5370306">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370312">return</span>&nbsp;<span class="ident" id="5370319">resp</span><span class="op" id="5370323">,</span>&nbsp;<span class="ident" id="5370325">err</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370333">cc</span><span class="op" id="5370335">.</span><span class="ident" id="5370336">lastbody</span>&nbsp;<span class="op" id="5370345">=</span>&nbsp;<span class="ident" id="5370347">resp</span><span class="op" id="5370351">.</span><span class="ident" id="5370352">Body</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370359">cc</span><span class="op" id="5370361">.</span><span class="ident" id="5370362">nread</span><span class="op" id="5370367">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370372">if</span>&nbsp;<span class="ident" id="5370375">resp</span><span class="op" id="5370379">.</span><span class="ident" id="5370380">Close</span>&nbsp;<span class="op" id="5370386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370390">cc</span><span class="op" id="5370392">.</span><span class="ident" id="5370393">re</span>&nbsp;<span class="op" id="5370396">=</span>&nbsp;<span class="ident" id="5370398">ErrPersistEOF</span>&nbsp;<span class="comment" id="5370412">//&nbsp;don&#39;t&nbsp;send&nbsp;any&nbsp;more&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370446">return</span>&nbsp;<span class="ident" id="5370453">resp</span><span class="op" id="5370457">,</span>&nbsp;<span class="ident" id="5370459">cc</span><span class="op" id="5370461">.</span><span class="ident" id="5370462">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370469">return</span>&nbsp;<span class="ident" id="5370476">resp</span><span class="op" id="5370480">,</span>&nbsp;<span class="ident" id="5370482">err</span><br>
<span class="lineno">420</span><span class="op" id="5370486">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5370489">//&nbsp;Do&nbsp;is&nbsp;convenience&nbsp;method&nbsp;that&nbsp;writes&nbsp;a&nbsp;request&nbsp;and&nbsp;reads&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="5370561">func</span>&nbsp;<span class="op" id="5370566">(</span><span class="ident" id="5370567">cc</span>&nbsp;<span class="op" id="5370570">*</span><span class="ident" id="5370571">ClientConn</span><span class="op" id="5370581">)</span>&nbsp;<span class="ident" id="5370583">Do</span><span class="op" id="5370585">(</span><span class="ident" id="5370586">req</span>&nbsp;<span class="op" id="5370590">*</span><span class="ident" id="5370591">http</span><span class="op" id="5370595">.</span><span class="ident" id="5370596">Request</span><span class="op" id="5370603">)</span>&nbsp;<span class="op" id="5370605">(</span><span class="ident" id="5370606">resp</span>&nbsp;<span class="op" id="5370611">*</span><span class="ident" id="5370612">http</span><span class="op" id="5370616">.</span><span class="ident" id="5370617">Response</span><span class="op" id="5370625">,</span>&nbsp;<span class="ident" id="5370627">err</span>&nbsp;<span class="builtintype" id="5370631">error</span><span class="op" id="5370636">)</span>&nbsp;<span class="op" id="5370638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370641">err</span>&nbsp;<span class="op" id="5370645">=</span>&nbsp;<span class="ident" id="5370647">cc</span><span class="op" id="5370649">.</span><span class="ident" id="5370650">Write</span><span class="op" id="5370655">(</span><span class="ident" id="5370656">req</span><span class="op" id="5370659">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370662">if</span>&nbsp;<span class="ident" id="5370665">err</span>&nbsp;<span class="op" id="5370669">!=</span>&nbsp;<span class="ident" id="5370672">nil</span>&nbsp;<span class="op" id="5370676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370680">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370691">return</span>&nbsp;<span class="ident" id="5370698">cc</span><span class="op" id="5370700">.</span><span class="ident" id="5370701">Read</span><span class="op" id="5370705">(</span><span class="ident" id="5370706">req</span><span class="op" id="5370709">)</span><br>
<span class="lineno"></span><span class="op" id="5370711">}</span>
</div>
</body>
</html>
