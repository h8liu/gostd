<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/smtp</h2>
<ul>
<li><a href="/gostd/net/smtp/auth.go.html">auth.go</a></li>
<li><a href="/gostd/net/smtp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/smtp/smtp.go.html">smtp.go</a></li>
<li><a href="/gostd/net/smtp/smtp_test.go.html">smtp_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8198516">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8198571">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8198625">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8198676">package</span>&nbsp;<span class="ident" id="8198684">smtp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8198690">import</span>&nbsp;<span class="op" id="8198697">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8198700">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8198709">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8198718">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8198732">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8198747">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8198753">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8198760">&#34;net/textproto&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8198777">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8198788">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8198799">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8198806">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="8198809">type</span>&nbsp;<span class="ident" id="8198814">authTest</span>&nbsp;<span class="keyword" id="8198823">struct</span>&nbsp;<span class="op" id="8198830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8198833">auth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8198844">Auth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8198850">challenges</span>&nbsp;<span class="op" id="8198861">[</span><span class="op" id="8198862">]</span><span class="builtintype" id="8198863">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8198871">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8198882">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8198890">responses</span>&nbsp;&nbsp;<span class="op" id="8198901">[</span><span class="op" id="8198902">]</span><span class="builtintype" id="8198903">string</span><br>
<span class="lineno">25</span><span class="op" id="8198910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8198913">var</span>&nbsp;<span class="ident" id="8198917">authTests</span>&nbsp;<span class="op" id="8198927">=</span>&nbsp;<span class="op" id="8198929">[</span><span class="op" id="8198930">]</span><span class="ident" id="8198931">authTest</span><span class="op" id="8198939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8198942">{</span><span class="ident" id="8198943">PlainAuth</span><span class="op" id="8198952">(</span><span class="string" id="8198953">&#34;&#34;</span><span class="op" id="8198955">,</span>&nbsp;<span class="string" id="8198957">&#34;user&#34;</span><span class="op" id="8198963">,</span>&nbsp;<span class="string" id="8198965">&#34;pass&#34;</span><span class="op" id="8198971">,</span>&nbsp;<span class="string" id="8198973">&#34;testserver&#34;</span><span class="op" id="8198985">)</span><span class="op" id="8198986">,</span>&nbsp;<span class="op" id="8198988">[</span><span class="op" id="8198989">]</span><span class="builtintype" id="8198990">string</span><span class="op" id="8198996">{</span><span class="op" id="8198997">}</span><span class="op" id="8198998">,</span>&nbsp;<span class="string" id="8199000">&#34;PLAIN&#34;</span><span class="op" id="8199007">,</span>&nbsp;<span class="op" id="8199009">[</span><span class="op" id="8199010">]</span><span class="builtintype" id="8199011">string</span><span class="op" id="8199017">{</span><span class="string" id="8199018">&#34;\x00user\x00pass&#34;</span><span class="op" id="8199036">}</span><span class="op" id="8199037">}</span><span class="op" id="8199038">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199041">{</span><span class="ident" id="8199042">PlainAuth</span><span class="op" id="8199051">(</span><span class="string" id="8199052">&#34;foo&#34;</span><span class="op" id="8199057">,</span>&nbsp;<span class="string" id="8199059">&#34;bar&#34;</span><span class="op" id="8199064">,</span>&nbsp;<span class="string" id="8199066">&#34;baz&#34;</span><span class="op" id="8199071">,</span>&nbsp;<span class="string" id="8199073">&#34;testserver&#34;</span><span class="op" id="8199085">)</span><span class="op" id="8199086">,</span>&nbsp;<span class="op" id="8199088">[</span><span class="op" id="8199089">]</span><span class="builtintype" id="8199090">string</span><span class="op" id="8199096">{</span><span class="op" id="8199097">}</span><span class="op" id="8199098">,</span>&nbsp;<span class="string" id="8199100">&#34;PLAIN&#34;</span><span class="op" id="8199107">,</span>&nbsp;<span class="op" id="8199109">[</span><span class="op" id="8199110">]</span><span class="builtintype" id="8199111">string</span><span class="op" id="8199117">{</span><span class="string" id="8199118">&#34;foo\x00bar\x00baz&#34;</span><span class="op" id="8199137">}</span><span class="op" id="8199138">}</span><span class="op" id="8199139">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199142">{</span><span class="ident" id="8199143">CRAMMD5Auth</span><span class="op" id="8199154">(</span><span class="string" id="8199155">&#34;user&#34;</span><span class="op" id="8199161">,</span>&nbsp;<span class="string" id="8199163">&#34;pass&#34;</span><span class="op" id="8199169">)</span><span class="op" id="8199170">,</span>&nbsp;<span class="op" id="8199172">[</span><span class="op" id="8199173">]</span><span class="builtintype" id="8199174">string</span><span class="op" id="8199180">{</span><span class="string" id="8199181">&#34;&lt;123456.1322876914@testserver&gt;&#34;</span><span class="op" id="8199213">}</span><span class="op" id="8199214">,</span>&nbsp;<span class="string" id="8199216">&#34;CRAM-MD5&#34;</span><span class="op" id="8199226">,</span>&nbsp;<span class="op" id="8199228">[</span><span class="op" id="8199229">]</span><span class="builtintype" id="8199230">string</span><span class="op" id="8199236">{</span><span class="string" id="8199237">&#34;&#34;</span><span class="op" id="8199239">,</span>&nbsp;<span class="string" id="8199241">&#34;user&nbsp;287eb355114cf5c471c26a875f1ca4ae&#34;</span><span class="op" id="8199280">}</span><span class="op" id="8199281">}</span><span class="op" id="8199282">,</span><br>
<span class="lineno"></span><span class="op" id="8199284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8199287">func</span>&nbsp;<span class="ident" id="8199292">TestAuth</span><span class="op" id="8199300">(</span><span class="ident" id="8199301">t</span>&nbsp;<span class="op" id="8199303">*</span><span class="ident" id="8199304">testing</span><span class="op" id="8199311">.</span><span class="ident" id="8199312">T</span><span class="op" id="8199313">)</span>&nbsp;<span class="op" id="8199315">{</span><br>
<span class="lineno"></span><span class="ident" id="8199317">testLoop</span><span class="op" id="8199325">:</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199328">for</span>&nbsp;<span class="ident" id="8199332">i</span><span class="op" id="8199333">,</span>&nbsp;<span class="ident" id="8199335">test</span>&nbsp;<span class="op" id="8199340">:=</span>&nbsp;<span class="keyword" id="8199343">range</span>&nbsp;<span class="ident" id="8199349">authTests</span>&nbsp;<span class="op" id="8199359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199363">name</span><span class="op" id="8199367">,</span>&nbsp;<span class="ident" id="8199369">resp</span><span class="op" id="8199373">,</span>&nbsp;<span class="ident" id="8199375">err</span>&nbsp;<span class="op" id="8199379">:=</span>&nbsp;<span class="ident" id="8199382">test</span><span class="op" id="8199386">.</span><span class="ident" id="8199387">auth</span><span class="op" id="8199391">.</span><span class="ident" id="8199392">Start</span><span class="op" id="8199397">(</span><span class="op" id="8199398">&amp;</span><span class="ident" id="8199399">ServerInfo</span><span class="op" id="8199409">{</span><span class="string" id="8199410">&#34;testserver&#34;</span><span class="op" id="8199422">,</span>&nbsp;<span class="builtintype" id="8199424">true</span><span class="op" id="8199428">,</span>&nbsp;<span class="ident" id="8199430">nil</span><span class="op" id="8199433">}</span><span class="op" id="8199434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199438">if</span>&nbsp;<span class="ident" id="8199441">name</span>&nbsp;<span class="op" id="8199446">!=</span>&nbsp;<span class="ident" id="8199449">test</span><span class="op" id="8199453">.</span><span class="ident" id="8199454">name</span>&nbsp;<span class="op" id="8199459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199464">t</span><span class="op" id="8199465">.</span><span class="ident" id="8199466">Errorf</span><span class="op" id="8199472">(</span><span class="string" id="8199473">&#34;#%d&nbsp;got&nbsp;name&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="8199503">,</span>&nbsp;<span class="ident" id="8199505">i</span><span class="op" id="8199506">,</span>&nbsp;<span class="ident" id="8199508">name</span><span class="op" id="8199512">,</span>&nbsp;<span class="ident" id="8199514">test</span><span class="op" id="8199518">.</span><span class="ident" id="8199519">name</span><span class="op" id="8199523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199527">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199531">if</span>&nbsp;<span class="op" id="8199534">!</span><span class="ident" id="8199535">bytes</span><span class="op" id="8199540">.</span><span class="ident" id="8199541">Equal</span><span class="op" id="8199546">(</span><span class="ident" id="8199547">resp</span><span class="op" id="8199551">,</span>&nbsp;<span class="op" id="8199553">[</span><span class="op" id="8199554">]</span><span class="builtintype" id="8199555">byte</span><span class="op" id="8199559">(</span><span class="ident" id="8199560">test</span><span class="op" id="8199564">.</span><span class="ident" id="8199565">responses</span><span class="op" id="8199574">[</span><span class="num" id="8199575">0</span><span class="op" id="8199576">]</span><span class="op" id="8199577">)</span><span class="op" id="8199578">)</span>&nbsp;<span class="op" id="8199580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199585">t</span><span class="op" id="8199586">.</span><span class="ident" id="8199587">Errorf</span><span class="op" id="8199593">(</span><span class="string" id="8199594">&#34;#%d&nbsp;got&nbsp;response&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="8199628">,</span>&nbsp;<span class="ident" id="8199630">i</span><span class="op" id="8199631">,</span>&nbsp;<span class="ident" id="8199633">resp</span><span class="op" id="8199637">,</span>&nbsp;<span class="ident" id="8199639">test</span><span class="op" id="8199643">.</span><span class="ident" id="8199644">responses</span><span class="op" id="8199653">[</span><span class="num" id="8199654">0</span><span class="op" id="8199655">]</span><span class="op" id="8199656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199664">if</span>&nbsp;<span class="ident" id="8199667">err</span>&nbsp;<span class="op" id="8199671">!=</span>&nbsp;<span class="ident" id="8199674">nil</span>&nbsp;<span class="op" id="8199678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199683">t</span><span class="op" id="8199684">.</span><span class="ident" id="8199685">Errorf</span><span class="op" id="8199691">(</span><span class="string" id="8199692">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="8199707">,</span>&nbsp;<span class="ident" id="8199709">i</span><span class="op" id="8199710">,</span>&nbsp;<span class="ident" id="8199712">err</span><span class="op" id="8199715">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199723">for</span>&nbsp;<span class="ident" id="8199727">j</span>&nbsp;<span class="op" id="8199729">:=</span>&nbsp;<span class="keyword" id="8199732">range</span>&nbsp;<span class="ident" id="8199738">test</span><span class="op" id="8199742">.</span><span class="ident" id="8199743">challenges</span>&nbsp;<span class="op" id="8199754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199759">challenge</span>&nbsp;<span class="op" id="8199769">:=</span>&nbsp;<span class="op" id="8199772">[</span><span class="op" id="8199773">]</span><span class="builtintype" id="8199774">byte</span><span class="op" id="8199778">(</span><span class="ident" id="8199779">test</span><span class="op" id="8199783">.</span><span class="ident" id="8199784">challenges</span><span class="op" id="8199794">[</span><span class="ident" id="8199795">j</span><span class="op" id="8199796">]</span><span class="op" id="8199797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199802">expected</span>&nbsp;<span class="op" id="8199811">:=</span>&nbsp;<span class="op" id="8199814">[</span><span class="op" id="8199815">]</span><span class="builtintype" id="8199816">byte</span><span class="op" id="8199820">(</span><span class="ident" id="8199821">test</span><span class="op" id="8199825">.</span><span class="ident" id="8199826">responses</span><span class="op" id="8199835">[</span><span class="ident" id="8199836">j</span><span class="op" id="8199837">+</span><span class="num" id="8199838">1</span><span class="op" id="8199839">]</span><span class="op" id="8199840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199845">resp</span><span class="op" id="8199849">,</span>&nbsp;<span class="ident" id="8199851">err</span>&nbsp;<span class="op" id="8199855">:=</span>&nbsp;<span class="ident" id="8199858">test</span><span class="op" id="8199862">.</span><span class="ident" id="8199863">auth</span><span class="op" id="8199867">.</span><span class="ident" id="8199868">Next</span><span class="op" id="8199872">(</span><span class="ident" id="8199873">challenge</span><span class="op" id="8199882">,</span>&nbsp;<span class="builtintype" id="8199884">true</span><span class="op" id="8199888">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199893">if</span>&nbsp;<span class="ident" id="8199896">err</span>&nbsp;<span class="op" id="8199900">!=</span>&nbsp;<span class="ident" id="8199903">nil</span>&nbsp;<span class="op" id="8199907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199913">t</span><span class="op" id="8199914">.</span><span class="ident" id="8199915">Errorf</span><span class="op" id="8199921">(</span><span class="string" id="8199922">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="8199937">,</span>&nbsp;<span class="ident" id="8199939">i</span><span class="op" id="8199940">,</span>&nbsp;<span class="ident" id="8199942">err</span><span class="op" id="8199945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199951">continue</span>&nbsp;<span class="ident" id="8199960">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199977">if</span>&nbsp;<span class="op" id="8199980">!</span><span class="ident" id="8199981">bytes</span><span class="op" id="8199986">.</span><span class="ident" id="8199987">Equal</span><span class="op" id="8199992">(</span><span class="ident" id="8199993">resp</span><span class="op" id="8199997">,</span>&nbsp;<span class="ident" id="8199999">expected</span><span class="op" id="8200007">)</span>&nbsp;<span class="op" id="8200009">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200015">t</span><span class="op" id="8200016">.</span><span class="ident" id="8200017">Errorf</span><span class="op" id="8200023">(</span><span class="string" id="8200024">&#34;#%d&nbsp;got&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="8200049">,</span>&nbsp;<span class="ident" id="8200051">i</span><span class="op" id="8200052">,</span>&nbsp;<span class="ident" id="8200054">resp</span><span class="op" id="8200058">,</span>&nbsp;<span class="ident" id="8200060">expected</span><span class="op" id="8200068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200074">continue</span>&nbsp;<span class="ident" id="8200083">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200102">}</span><br>
<span class="lineno">60</span><span class="op" id="8200104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8200107">func</span>&nbsp;<span class="ident" id="8200112">TestAuthPlain</span><span class="op" id="8200125">(</span><span class="ident" id="8200126">t</span>&nbsp;<span class="op" id="8200128">*</span><span class="ident" id="8200129">testing</span><span class="op" id="8200136">.</span><span class="ident" id="8200137">T</span><span class="op" id="8200138">)</span>&nbsp;<span class="op" id="8200140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200143">auth</span>&nbsp;<span class="op" id="8200148">:=</span>&nbsp;<span class="ident" id="8200151">PlainAuth</span><span class="op" id="8200160">(</span><span class="string" id="8200161">&#34;foo&#34;</span><span class="op" id="8200166">,</span>&nbsp;<span class="string" id="8200168">&#34;bar&#34;</span><span class="op" id="8200173">,</span>&nbsp;<span class="string" id="8200175">&#34;baz&#34;</span><span class="op" id="8200180">,</span>&nbsp;<span class="string" id="8200182">&#34;servername&#34;</span><span class="op" id="8200194">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200198">tests</span>&nbsp;<span class="op" id="8200204">:=</span>&nbsp;<span class="op" id="8200207">[</span><span class="op" id="8200208">]</span><span class="keyword" id="8200209">struct</span>&nbsp;<span class="op" id="8200216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200220">server</span>&nbsp;<span class="op" id="8200227">*</span><span class="ident" id="8200228">ServerInfo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200241">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8200248">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200256">}</span><span class="op" id="8200257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200261">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200266">server</span><span class="op" id="8200272">:</span>&nbsp;<span class="op" id="8200274">&amp;</span><span class="ident" id="8200275">ServerInfo</span><span class="op" id="8200285">{</span><span class="ident" id="8200286">Name</span><span class="op" id="8200290">:</span>&nbsp;<span class="string" id="8200292">&#34;servername&#34;</span><span class="op" id="8200304">,</span>&nbsp;<span class="ident" id="8200306">TLS</span><span class="op" id="8200309">:</span>&nbsp;<span class="builtintype" id="8200311">true</span><span class="op" id="8200315">}</span><span class="op" id="8200316">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200320">}</span><span class="op" id="8200321">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8200330">//&nbsp;Okay;&nbsp;explicitly&nbsp;advertised&nbsp;by&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200375">server</span><span class="op" id="8200381">:</span>&nbsp;<span class="op" id="8200383">&amp;</span><span class="ident" id="8200384">ServerInfo</span><span class="op" id="8200394">{</span><span class="ident" id="8200395">Name</span><span class="op" id="8200399">:</span>&nbsp;<span class="string" id="8200401">&#34;servername&#34;</span><span class="op" id="8200413">,</span>&nbsp;<span class="ident" id="8200415">Auth</span><span class="op" id="8200419">:</span>&nbsp;<span class="op" id="8200421">[</span><span class="op" id="8200422">]</span><span class="builtintype" id="8200423">string</span><span class="op" id="8200429">{</span><span class="string" id="8200430">&#34;PLAIN&#34;</span><span class="op" id="8200437">}</span><span class="op" id="8200438">}</span><span class="op" id="8200439">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200443">}</span><span class="op" id="8200444">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200453">server</span><span class="op" id="8200459">:</span>&nbsp;<span class="op" id="8200461">&amp;</span><span class="ident" id="8200462">ServerInfo</span><span class="op" id="8200472">{</span><span class="ident" id="8200473">Name</span><span class="op" id="8200477">:</span>&nbsp;<span class="string" id="8200479">&#34;servername&#34;</span><span class="op" id="8200491">,</span>&nbsp;<span class="ident" id="8200493">Auth</span><span class="op" id="8200497">:</span>&nbsp;<span class="op" id="8200499">[</span><span class="op" id="8200500">]</span><span class="builtintype" id="8200501">string</span><span class="op" id="8200507">{</span><span class="string" id="8200508">&#34;CRAM-MD5&#34;</span><span class="op" id="8200518">}</span><span class="op" id="8200519">}</span><span class="op" id="8200520">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200525">err</span><span class="op" id="8200528">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8200533">&#34;unencrypted&nbsp;connection&#34;</span><span class="op" id="8200557">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200561">}</span><span class="op" id="8200562">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200571">server</span><span class="op" id="8200577">:</span>&nbsp;<span class="op" id="8200579">&amp;</span><span class="ident" id="8200580">ServerInfo</span><span class="op" id="8200590">{</span><span class="ident" id="8200591">Name</span><span class="op" id="8200595">:</span>&nbsp;<span class="string" id="8200597">&#34;attacker&#34;</span><span class="op" id="8200607">,</span>&nbsp;<span class="ident" id="8200609">TLS</span><span class="op" id="8200612">:</span>&nbsp;<span class="builtintype" id="8200614">true</span><span class="op" id="8200618">}</span><span class="op" id="8200619">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200624">err</span><span class="op" id="8200627">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8200632">&#34;wrong&nbsp;host&nbsp;name&#34;</span><span class="op" id="8200649">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200653">}</span><span class="op" id="8200654">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200657">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200660">for</span>&nbsp;<span class="ident" id="8200664">i</span><span class="op" id="8200665">,</span>&nbsp;<span class="ident" id="8200667">tt</span>&nbsp;<span class="op" id="8200670">:=</span>&nbsp;<span class="keyword" id="8200673">range</span>&nbsp;<span class="ident" id="8200679">tests</span>&nbsp;<span class="op" id="8200685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200689">_</span><span class="op" id="8200690">,</span>&nbsp;<span class="ident" id="8200692">_</span><span class="op" id="8200693">,</span>&nbsp;<span class="ident" id="8200695">err</span>&nbsp;<span class="op" id="8200699">:=</span>&nbsp;<span class="ident" id="8200702">auth</span><span class="op" id="8200706">.</span><span class="ident" id="8200707">Start</span><span class="op" id="8200712">(</span><span class="ident" id="8200713">tt</span><span class="op" id="8200715">.</span><span class="ident" id="8200716">server</span><span class="op" id="8200722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200726">got</span>&nbsp;<span class="op" id="8200730">:=</span>&nbsp;<span class="string" id="8200733">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200738">if</span>&nbsp;<span class="ident" id="8200741">err</span>&nbsp;<span class="op" id="8200745">!=</span>&nbsp;<span class="ident" id="8200748">nil</span>&nbsp;<span class="op" id="8200752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200757">got</span>&nbsp;<span class="op" id="8200761">=</span>&nbsp;<span class="ident" id="8200763">err</span><span class="op" id="8200766">.</span><span class="ident" id="8200767">Error</span><span class="op" id="8200772">(</span><span class="op" id="8200773">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200781">if</span>&nbsp;<span class="ident" id="8200784">got</span>&nbsp;<span class="op" id="8200788">!=</span>&nbsp;<span class="ident" id="8200791">tt</span><span class="op" id="8200793">.</span><span class="ident" id="8200794">err</span>&nbsp;<span class="op" id="8200798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200803">t</span><span class="op" id="8200804">.</span><span class="ident" id="8200805">Errorf</span><span class="op" id="8200811">(</span><span class="string" id="8200812">&#34;%d.&nbsp;got&nbsp;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8200841">,</span>&nbsp;<span class="ident" id="8200843">i</span><span class="op" id="8200844">,</span>&nbsp;<span class="ident" id="8200846">got</span><span class="op" id="8200849">,</span>&nbsp;<span class="ident" id="8200851">tt</span><span class="op" id="8200853">.</span><span class="ident" id="8200854">err</span><span class="op" id="8200857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200864">}</span><br>
<span class="lineno">95</span><span class="op" id="8200866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8200869">type</span>&nbsp;<span class="ident" id="8200874">faker</span>&nbsp;<span class="keyword" id="8200880">struct</span>&nbsp;<span class="op" id="8200887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200890">io</span><span class="op" id="8200892">.</span><span class="ident" id="8200893">ReadWriter</span><br>
<span class="lineno"></span><span class="op" id="8200904">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="8200907">func</span>&nbsp;<span class="op" id="8200912">(</span><span class="ident" id="8200913">f</span>&nbsp;<span class="ident" id="8200915">faker</span><span class="op" id="8200920">)</span>&nbsp;<span class="ident" id="8200922">Close</span><span class="op" id="8200927">(</span><span class="op" id="8200928">)</span>&nbsp;<span class="builtintype" id="8200930">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8200956">{</span>&nbsp;<span class="keyword" id="8200958">return</span>&nbsp;<span class="ident" id="8200965">nil</span>&nbsp;<span class="op" id="8200969">}</span><br>
<span class="lineno"></span><span class="keyword" id="8200971">func</span>&nbsp;<span class="op" id="8200976">(</span><span class="ident" id="8200977">f</span>&nbsp;<span class="ident" id="8200979">faker</span><span class="op" id="8200984">)</span>&nbsp;<span class="ident" id="8200986">LocalAddr</span><span class="op" id="8200995">(</span><span class="op" id="8200996">)</span>&nbsp;<span class="ident" id="8200998">net</span><span class="op" id="8201001">.</span><span class="ident" id="8201002">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8201020">{</span>&nbsp;<span class="keyword" id="8201022">return</span>&nbsp;<span class="ident" id="8201029">nil</span>&nbsp;<span class="op" id="8201033">}</span><br>
<span class="lineno"></span><span class="keyword" id="8201035">func</span>&nbsp;<span class="op" id="8201040">(</span><span class="ident" id="8201041">f</span>&nbsp;<span class="ident" id="8201043">faker</span><span class="op" id="8201048">)</span>&nbsp;<span class="ident" id="8201050">RemoteAddr</span><span class="op" id="8201060">(</span><span class="op" id="8201061">)</span>&nbsp;<span class="ident" id="8201063">net</span><span class="op" id="8201066">.</span><span class="ident" id="8201067">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8201084">{</span>&nbsp;<span class="keyword" id="8201086">return</span>&nbsp;<span class="ident" id="8201093">nil</span>&nbsp;<span class="op" id="8201097">}</span><br>
<span class="lineno"></span><span class="keyword" id="8201099">func</span>&nbsp;<span class="op" id="8201104">(</span><span class="ident" id="8201105">f</span>&nbsp;<span class="ident" id="8201107">faker</span><span class="op" id="8201112">)</span>&nbsp;<span class="ident" id="8201114">SetDeadline</span><span class="op" id="8201125">(</span><span class="ident" id="8201126">time</span><span class="op" id="8201130">.</span><span class="ident" id="8201131">Time</span><span class="op" id="8201135">)</span>&nbsp;<span class="builtintype" id="8201137">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8201148">{</span>&nbsp;<span class="keyword" id="8201150">return</span>&nbsp;<span class="ident" id="8201157">nil</span>&nbsp;<span class="op" id="8201161">}</span><br>
<span class="lineno">105</span><span class="keyword" id="8201163">func</span>&nbsp;<span class="op" id="8201168">(</span><span class="ident" id="8201169">f</span>&nbsp;<span class="ident" id="8201171">faker</span><span class="op" id="8201176">)</span>&nbsp;<span class="ident" id="8201178">SetReadDeadline</span><span class="op" id="8201193">(</span><span class="ident" id="8201194">time</span><span class="op" id="8201198">.</span><span class="ident" id="8201199">Time</span><span class="op" id="8201203">)</span>&nbsp;<span class="builtintype" id="8201205">error</span>&nbsp;&nbsp;<span class="op" id="8201212">{</span>&nbsp;<span class="keyword" id="8201214">return</span>&nbsp;<span class="ident" id="8201221">nil</span>&nbsp;<span class="op" id="8201225">}</span><br>
<span class="lineno"></span><span class="keyword" id="8201227">func</span>&nbsp;<span class="op" id="8201232">(</span><span class="ident" id="8201233">f</span>&nbsp;<span class="ident" id="8201235">faker</span><span class="op" id="8201240">)</span>&nbsp;<span class="ident" id="8201242">SetWriteDeadline</span><span class="op" id="8201258">(</span><span class="ident" id="8201259">time</span><span class="op" id="8201263">.</span><span class="ident" id="8201264">Time</span><span class="op" id="8201268">)</span>&nbsp;<span class="builtintype" id="8201270">error</span>&nbsp;<span class="op" id="8201276">{</span>&nbsp;<span class="keyword" id="8201278">return</span>&nbsp;<span class="ident" id="8201285">nil</span>&nbsp;<span class="op" id="8201289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8201292">func</span>&nbsp;<span class="ident" id="8201297">TestBasic</span><span class="op" id="8201306">(</span><span class="ident" id="8201307">t</span>&nbsp;<span class="op" id="8201309">*</span><span class="ident" id="8201310">testing</span><span class="op" id="8201317">.</span><span class="ident" id="8201318">T</span><span class="op" id="8201319">)</span>&nbsp;<span class="op" id="8201321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8201324">server</span>&nbsp;<span class="op" id="8201331">:=</span>&nbsp;<span class="ident" id="8201334">strings</span><span class="op" id="8201341">.</span><span class="ident" id="8201342">Join</span><span class="op" id="8201346">(</span><span class="ident" id="8201347">strings</span><span class="op" id="8201354">.</span><span class="ident" id="8201355">Split</span><span class="op" id="8201360">(</span><span class="ident" id="8201361">basicServer</span><span class="op" id="8201372">,</span>&nbsp;<span class="string" id="8201374">&#34;\n&#34;</span><span class="op" id="8201378">)</span><span class="op" id="8201379">,</span>&nbsp;<span class="string" id="8201381">&#34;\r\n&#34;</span><span class="op" id="8201387">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8201390">client</span>&nbsp;<span class="op" id="8201397">:=</span>&nbsp;<span class="ident" id="8201400">strings</span><span class="op" id="8201407">.</span><span class="ident" id="8201408">Join</span><span class="op" id="8201412">(</span><span class="ident" id="8201413">strings</span><span class="op" id="8201420">.</span><span class="ident" id="8201421">Split</span><span class="op" id="8201426">(</span><span class="ident" id="8201427">basicClient</span><span class="op" id="8201438">,</span>&nbsp;<span class="string" id="8201440">&#34;\n&#34;</span><span class="op" id="8201444">)</span><span class="op" id="8201445">,</span>&nbsp;<span class="string" id="8201447">&#34;\r\n&#34;</span><span class="op" id="8201453">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8201457">var</span>&nbsp;<span class="ident" id="8201461">cmdbuf</span>&nbsp;<span class="ident" id="8201468">bytes</span><span class="op" id="8201473">.</span><span class="ident" id="8201474">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8201482">bcmdbuf</span>&nbsp;<span class="op" id="8201490">:=</span>&nbsp;<span class="ident" id="8201493">bufio</span><span class="op" id="8201498">.</span><span class="ident" id="8201499">NewWriter</span><span class="op" id="8201508">(</span><span class="op" id="8201509">&amp;</span><span class="ident" id="8201510">cmdbuf</span><span class="op" id="8201516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8201519">var</span>&nbsp;<span class="ident" id="8201523">fake</span>&nbsp;<span class="ident" id="8201528">faker</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8201535">fake</span><span class="op" id="8201539">.</span><span class="ident" id="8201540">ReadWriter</span>&nbsp;<span class="op" id="8201551">=</span>&nbsp;<span class="ident" id="8201553">bufio</span><span class="op" id="8201558">.</span><span class="ident" id="8201559">NewReadWriter</span><span class="op" id="8201572">(</span><span class="ident" id="8201573">bufio</span><span class="op" id="8201578">.</span><span class="ident" id="8201579">NewReader</span><span class="op" id="8201588">(</span><span class="ident" id="8201589">strings</span><span class="op" id="8201596">.</span><span class="ident" id="8201597">NewReader</span><span class="op" id="8201606">(</span><span class="ident" id="8201607">server</span><span class="op" id="8201613">)</span><span class="op" id="8201614">)</span><span class="op" id="8201615">,</span>&nbsp;<span class="ident" id="8201617">bcmdbuf</span><span class="op" id="8201624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8201627">c</span>&nbsp;<span class="op" id="8201629">:=</span>&nbsp;<span class="op" id="8201632">&amp;</span><span class="ident" id="8201633">Client</span><span class="op" id="8201639">{</span><span class="ident" id="8201640">Text</span><span class="op" id="8201644">:</span>&nbsp;<span class="ident" id="8201646">textproto</span><span class="op" id="8201655">.</span><span class="ident" id="8201656">NewConn</span><span class="op" id="8201663">(</span><span class="ident" id="8201664">fake</span><span class="op" id="8201668">)</span><span class="op" id="8201669">,</span>&nbsp;<span class="ident" id="8201671">localName</span><span class="op" id="8201680">:</span>&nbsp;<span class="string" id="8201682">&#34;localhost&#34;</span><span class="op" id="8201693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8201697">if</span>&nbsp;<span class="ident" id="8201700">err</span>&nbsp;<span class="op" id="8201704">:=</span>&nbsp;<span class="ident" id="8201707">c</span><span class="op" id="8201708">.</span><span class="ident" id="8201709">helo</span><span class="op" id="8201713">(</span><span class="op" id="8201714">)</span><span class="op" id="8201715">;</span>&nbsp;<span class="ident" id="8201717">err</span>&nbsp;<span class="op" id="8201721">!=</span>&nbsp;<span class="ident" id="8201724">nil</span>&nbsp;<span class="op" id="8201728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8201732">t</span><span class="op" id="8201733">.</span><span class="ident" id="8201734">Fatalf</span><span class="op" id="8201740">(</span><span class="string" id="8201741">&#34;HELO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8201758">,</span>&nbsp;<span class="ident" id="8201760">err</span><span class="op" id="8201763">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8201766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8201769">if</span>&nbsp;<span class="ident" id="8201772">err</span>&nbsp;<span class="op" id="8201776">:=</span>&nbsp;<span class="ident" id="8201779">c</span><span class="op" id="8201780">.</span><span class="ident" id="8201781">ehlo</span><span class="op" id="8201785">(</span><span class="op" id="8201786">)</span><span class="op" id="8201787">;</span>&nbsp;<span class="ident" id="8201789">err</span>&nbsp;<span class="op" id="8201793">==</span>&nbsp;<span class="ident" id="8201796">nil</span>&nbsp;<span class="op" id="8201800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8201804">t</span><span class="op" id="8201805">.</span><span class="ident" id="8201806">Fatalf</span><span class="op" id="8201812">(</span><span class="string" id="8201813">&#34;Expected&nbsp;first&nbsp;EHLO&nbsp;to&nbsp;fail&#34;</span><span class="op" id="8201842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8201845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8201848">if</span>&nbsp;<span class="ident" id="8201851">err</span>&nbsp;<span class="op" id="8201855">:=</span>&nbsp;<span class="ident" id="8201858">c</span><span class="op" id="8201859">.</span><span class="ident" id="8201860">ehlo</span><span class="op" id="8201864">(</span><span class="op" id="8201865">)</span><span class="op" id="8201866">;</span>&nbsp;<span class="ident" id="8201868">err</span>&nbsp;<span class="op" id="8201872">!=</span>&nbsp;<span class="ident" id="8201875">nil</span>&nbsp;<span class="op" id="8201879">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8201883">t</span><span class="op" id="8201884">.</span><span class="ident" id="8201885">Fatalf</span><span class="op" id="8201891">(</span><span class="string" id="8201892">&#34;Second&nbsp;EHLO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8201916">,</span>&nbsp;<span class="ident" id="8201918">err</span><span class="op" id="8201921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8201924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8201928">c</span><span class="op" id="8201929">.</span><span class="ident" id="8201930">didHello</span>&nbsp;<span class="op" id="8201939">=</span>&nbsp;<span class="builtintype" id="8201941">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8201947">if</span>&nbsp;<span class="ident" id="8201950">ok</span><span class="op" id="8201952">,</span>&nbsp;<span class="ident" id="8201954">args</span>&nbsp;<span class="op" id="8201959">:=</span>&nbsp;<span class="ident" id="8201962">c</span><span class="op" id="8201963">.</span><span class="ident" id="8201964">Extension</span><span class="op" id="8201973">(</span><span class="string" id="8201974">&#34;aUtH&#34;</span><span class="op" id="8201980">)</span><span class="op" id="8201981">;</span>&nbsp;<span class="op" id="8201983">!</span><span class="ident" id="8201984">ok</span>&nbsp;<span class="op" id="8201987">||</span>&nbsp;<span class="ident" id="8201990">args</span>&nbsp;<span class="op" id="8201995">!=</span>&nbsp;<span class="string" id="8201998">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="8202012">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8202016">t</span><span class="op" id="8202017">.</span><span class="ident" id="8202018">Fatalf</span><span class="op" id="8202024">(</span><span class="string" id="8202025">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="8202050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8202053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8202056">if</span>&nbsp;<span class="ident" id="8202059">ok</span><span class="op" id="8202061">,</span>&nbsp;<span class="ident" id="8202063">_</span>&nbsp;<span class="op" id="8202065">:=</span>&nbsp;<span class="ident" id="8202068">c</span><span class="op" id="8202069">.</span><span class="ident" id="8202070">Extension</span><span class="op" id="8202079">(</span><span class="string" id="8202080">&#34;DSN&#34;</span><span class="op" id="8202085">)</span><span class="op" id="8202086">;</span>&nbsp;<span class="ident" id="8202088">ok</span>&nbsp;<span class="op" id="8202091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8202095">t</span><span class="op" id="8202096">.</span><span class="ident" id="8202097">Fatalf</span><span class="op" id="8202103">(</span><span class="string" id="8202104">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="8202127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8202130">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8202134">if</span>&nbsp;<span class="ident" id="8202137">err</span>&nbsp;<span class="op" id="8202141">:=</span>&nbsp;<span class="ident" id="8202144">c</span><span class="op" id="8202145">.</span><span class="ident" id="8202146">Mail</span><span class="op" id="8202150">(</span><span class="string" id="8202151">&#34;user@gmail.com&#34;</span><span class="op" id="8202167">)</span><span class="op" id="8202168">;</span>&nbsp;<span class="ident" id="8202170">err</span>&nbsp;<span class="op" id="8202174">==</span>&nbsp;<span class="ident" id="8202177">nil</span>&nbsp;<span class="op" id="8202181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8202185">t</span><span class="op" id="8202186">.</span><span class="ident" id="8202187">Fatalf</span><span class="op" id="8202193">(</span><span class="string" id="8202194">&#34;MAIL&nbsp;should&nbsp;require&nbsp;authentication&#34;</span><span class="op" id="8202230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8202233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8202237">if</span>&nbsp;<span class="ident" id="8202240">err</span>&nbsp;<span class="op" id="8202244">:=</span>&nbsp;<span class="ident" id="8202247">c</span><span class="op" id="8202248">.</span><span class="ident" id="8202249">Verify</span><span class="op" id="8202255">(</span><span class="string" id="8202256">&#34;user1@gmail.com&#34;</span><span class="op" id="8202273">)</span><span class="op" id="8202274">;</span>&nbsp;<span class="ident" id="8202276">err</span>&nbsp;<span class="op" id="8202280">==</span>&nbsp;<span class="ident" id="8202283">nil</span>&nbsp;<span class="op" id="8202287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8202291">t</span><span class="op" id="8202292">.</span><span class="ident" id="8202293">Fatalf</span><span class="op" id="8202299">(</span><span class="string" id="8202300">&#34;First&nbsp;VRFY:&nbsp;expected&nbsp;no&nbsp;verification&#34;</span><span class="op" id="8202338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8202341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8202344">if</span>&nbsp;<span class="ident" id="8202347">err</span>&nbsp;<span class="op" id="8202351">:=</span>&nbsp;<span class="ident" id="8202354">c</span><span class="op" id="8202355">.</span><span class="ident" id="8202356">Verify</span><span class="op" id="8202362">(</span><span class="string" id="8202363">&#34;user2@gmail.com&#34;</span><span class="op" id="8202380">)</span><span class="op" id="8202381">;</span>&nbsp;<span class="ident" id="8202383">err</span>&nbsp;<span class="op" id="8202387">!=</span>&nbsp;<span class="ident" id="8202390">nil</span>&nbsp;<span class="op" id="8202394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8202398">t</span><span class="op" id="8202399">.</span><span class="ident" id="8202400">Fatalf</span><span class="op" id="8202406">(</span><span class="string" id="8202407">&#34;Second&nbsp;VRFY:&nbsp;expected&nbsp;verification,&nbsp;got&nbsp;%s&#34;</span><span class="op" id="8202451">,</span>&nbsp;<span class="ident" id="8202453">err</span><span class="op" id="8202456">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8202459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8202463">//&nbsp;fake&nbsp;TLS&nbsp;so&nbsp;authentication&nbsp;won&#39;t&nbsp;complain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8202509">c</span><span class="op" id="8202510">.</span><span class="ident" id="8202511">tls</span>&nbsp;<span class="op" id="8202515">=</span>&nbsp;<span class="builtintype" id="8202517">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8202523">c</span><span class="op" id="8202524">.</span><span class="ident" id="8202525">serverName</span>&nbsp;<span class="op" id="8202536">=</span>&nbsp;<span class="string" id="8202538">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8202557">if</span>&nbsp;<span class="ident" id="8202560">err</span>&nbsp;<span class="op" id="8202564">:=</span>&nbsp;<span class="ident" id="8202567">c</span><span class="op" id="8202568">.</span><span class="ident" id="8202569">Auth</span><span class="op" id="8202573">(</span><span class="ident" id="8202574">PlainAuth</span><span class="op" id="8202583">(</span><span class="string" id="8202584">&#34;&#34;</span><span class="op" id="8202586">,</span>&nbsp;<span class="string" id="8202588">&#34;user&#34;</span><span class="op" id="8202594">,</span>&nbsp;<span class="string" id="8202596">&#34;pass&#34;</span><span class="op" id="8202602">,</span>&nbsp;<span class="string" id="8202604">&#34;smtp.google.com&#34;</span><span class="op" id="8202621">)</span><span class="op" id="8202622">)</span><span class="op" id="8202623">;</span>&nbsp;<span class="ident" id="8202625">err</span>&nbsp;<span class="op" id="8202629">!=</span>&nbsp;<span class="ident" id="8202632">nil</span>&nbsp;<span class="op" id="8202636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8202640">t</span><span class="op" id="8202641">.</span><span class="ident" id="8202642">Fatalf</span><span class="op" id="8202648">(</span><span class="string" id="8202649">&#34;AUTH&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8202666">,</span>&nbsp;<span class="ident" id="8202668">err</span><span class="op" id="8202671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8202674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8202678">if</span>&nbsp;<span class="ident" id="8202681">err</span>&nbsp;<span class="op" id="8202685">:=</span>&nbsp;<span class="ident" id="8202688">c</span><span class="op" id="8202689">.</span><span class="ident" id="8202690">Mail</span><span class="op" id="8202694">(</span><span class="string" id="8202695">&#34;user@gmail.com&#34;</span><span class="op" id="8202711">)</span><span class="op" id="8202712">;</span>&nbsp;<span class="ident" id="8202714">err</span>&nbsp;<span class="op" id="8202718">!=</span>&nbsp;<span class="ident" id="8202721">nil</span>&nbsp;<span class="op" id="8202725">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8202729">t</span><span class="op" id="8202730">.</span><span class="ident" id="8202731">Fatalf</span><span class="op" id="8202737">(</span><span class="string" id="8202738">&#34;MAIL&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8202755">,</span>&nbsp;<span class="ident" id="8202757">err</span><span class="op" id="8202760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8202763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8202766">if</span>&nbsp;<span class="ident" id="8202769">err</span>&nbsp;<span class="op" id="8202773">:=</span>&nbsp;<span class="ident" id="8202776">c</span><span class="op" id="8202777">.</span><span class="ident" id="8202778">Rcpt</span><span class="op" id="8202782">(</span><span class="string" id="8202783">&#34;golang-nuts@googlegroups.com&#34;</span><span class="op" id="8202813">)</span><span class="op" id="8202814">;</span>&nbsp;<span class="ident" id="8202816">err</span>&nbsp;<span class="op" id="8202820">!=</span>&nbsp;<span class="ident" id="8202823">nil</span>&nbsp;<span class="op" id="8202827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8202831">t</span><span class="op" id="8202832">.</span><span class="ident" id="8202833">Fatalf</span><span class="op" id="8202839">(</span><span class="string" id="8202840">&#34;RCPT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8202857">,</span>&nbsp;<span class="ident" id="8202859">err</span><span class="op" id="8202862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8202865">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8202868">msg</span>&nbsp;<span class="op" id="8202872">:=</span>&nbsp;<span class="string" id="8202875">`From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno"></span>Line&nbsp;1<br>
<span class="lineno">165</span>.Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8202992">w</span><span class="op" id="8202993">,</span>&nbsp;<span class="ident" id="8202995">err</span>&nbsp;<span class="op" id="8202999">:=</span>&nbsp;<span class="ident" id="8203002">c</span><span class="op" id="8203003">.</span><span class="ident" id="8203004">Data</span><span class="op" id="8203008">(</span><span class="op" id="8203009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203012">if</span>&nbsp;<span class="ident" id="8203015">err</span>&nbsp;<span class="op" id="8203019">!=</span>&nbsp;<span class="ident" id="8203022">nil</span>&nbsp;<span class="op" id="8203026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203030">t</span><span class="op" id="8203031">.</span><span class="ident" id="8203032">Fatalf</span><span class="op" id="8203038">(</span><span class="string" id="8203039">&#34;DATA&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8203056">,</span>&nbsp;<span class="ident" id="8203058">err</span><span class="op" id="8203061">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8203064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203067">if</span>&nbsp;<span class="ident" id="8203070">_</span><span class="op" id="8203071">,</span>&nbsp;<span class="ident" id="8203073">err</span>&nbsp;<span class="op" id="8203077">:=</span>&nbsp;<span class="ident" id="8203080">w</span><span class="op" id="8203081">.</span><span class="ident" id="8203082">Write</span><span class="op" id="8203087">(</span><span class="op" id="8203088">[</span><span class="op" id="8203089">]</span><span class="builtintype" id="8203090">byte</span><span class="op" id="8203094">(</span><span class="ident" id="8203095">msg</span><span class="op" id="8203098">)</span><span class="op" id="8203099">)</span><span class="op" id="8203100">;</span>&nbsp;<span class="ident" id="8203102">err</span>&nbsp;<span class="op" id="8203106">!=</span>&nbsp;<span class="ident" id="8203109">nil</span>&nbsp;<span class="op" id="8203113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203117">t</span><span class="op" id="8203118">.</span><span class="ident" id="8203119">Fatalf</span><span class="op" id="8203125">(</span><span class="string" id="8203126">&#34;Data&nbsp;write&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8203149">,</span>&nbsp;<span class="ident" id="8203151">err</span><span class="op" id="8203154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8203157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203160">if</span>&nbsp;<span class="ident" id="8203163">err</span>&nbsp;<span class="op" id="8203167">:=</span>&nbsp;<span class="ident" id="8203170">w</span><span class="op" id="8203171">.</span><span class="ident" id="8203172">Close</span><span class="op" id="8203177">(</span><span class="op" id="8203178">)</span><span class="op" id="8203179">;</span>&nbsp;<span class="ident" id="8203181">err</span>&nbsp;<span class="op" id="8203185">!=</span>&nbsp;<span class="ident" id="8203188">nil</span>&nbsp;<span class="op" id="8203192">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203196">t</span><span class="op" id="8203197">.</span><span class="ident" id="8203198">Fatalf</span><span class="op" id="8203204">(</span><span class="string" id="8203205">&#34;Bad&nbsp;data&nbsp;response:&nbsp;%s&#34;</span><span class="op" id="8203228">,</span>&nbsp;<span class="ident" id="8203230">err</span><span class="op" id="8203233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8203236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203240">if</span>&nbsp;<span class="ident" id="8203243">err</span>&nbsp;<span class="op" id="8203247">:=</span>&nbsp;<span class="ident" id="8203250">c</span><span class="op" id="8203251">.</span><span class="ident" id="8203252">Quit</span><span class="op" id="8203256">(</span><span class="op" id="8203257">)</span><span class="op" id="8203258">;</span>&nbsp;<span class="ident" id="8203260">err</span>&nbsp;<span class="op" id="8203264">!=</span>&nbsp;<span class="ident" id="8203267">nil</span>&nbsp;<span class="op" id="8203271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203275">t</span><span class="op" id="8203276">.</span><span class="ident" id="8203277">Fatalf</span><span class="op" id="8203283">(</span><span class="string" id="8203284">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8203301">,</span>&nbsp;<span class="ident" id="8203303">err</span><span class="op" id="8203306">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8203309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203313">bcmdbuf</span><span class="op" id="8203320">.</span><span class="ident" id="8203321">Flush</span><span class="op" id="8203326">(</span><span class="op" id="8203327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203330">actualcmds</span>&nbsp;<span class="op" id="8203341">:=</span>&nbsp;<span class="ident" id="8203344">cmdbuf</span><span class="op" id="8203350">.</span><span class="ident" id="8203351">String</span><span class="op" id="8203357">(</span><span class="op" id="8203358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8203361">if</span>&nbsp;<span class="ident" id="8203364">client</span>&nbsp;<span class="op" id="8203371">!=</span>&nbsp;<span class="ident" id="8203374">actualcmds</span>&nbsp;<span class="op" id="8203385">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8203389">t</span><span class="op" id="8203390">.</span><span class="ident" id="8203391">Fatalf</span><span class="op" id="8203397">(</span><span class="string" id="8203398">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8203423">,</span>&nbsp;<span class="ident" id="8203425">actualcmds</span><span class="op" id="8203435">,</span>&nbsp;<span class="ident" id="8203437">client</span><span class="op" id="8203443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8203446">}</span><br>
<span class="lineno"></span><span class="op" id="8203448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8203451">var</span>&nbsp;<span class="ident" id="8203455">basicServer</span>&nbsp;<span class="op" id="8203467">=</span>&nbsp;<span class="string" id="8203469">`250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno">190</span>502&nbsp;Unrecognized&nbsp;command.<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">195</span>530&nbsp;Authentication&nbsp;required<br>
<span class="lineno"></span>252&nbsp;Send&nbsp;some&nbsp;mail,&nbsp;I&#39;ll&nbsp;try&nbsp;my&nbsp;best<br>
<span class="lineno"></span>250&nbsp;User&nbsp;is&nbsp;valid<br>
<span class="lineno"></span>235&nbsp;Accepted<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;OK<br>
<span class="lineno">200</span>250&nbsp;Receiver&nbsp;OK<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;OK<br>
<span class="lineno"></span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="8203777">var</span>&nbsp;<span class="ident" id="8203781">basicClient</span>&nbsp;<span class="op" id="8203793">=</span>&nbsp;<span class="string" id="8203795">`HELO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno">210</span>VRFY&nbsp;user1@gmail.com<br>
<span class="lineno"></span>VRFY&nbsp;user2@gmail.com<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;golang-nuts@googlegroups.com&gt;<br>
<span class="lineno">215</span>DATA<br>
<span class="lineno"></span>From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno">220</span>Line&nbsp;1<br>
<span class="lineno"></span>..Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">225</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8204162">func</span>&nbsp;<span class="ident" id="8204167">TestNewClient</span><span class="op" id="8204180">(</span><span class="ident" id="8204181">t</span>&nbsp;<span class="op" id="8204183">*</span><span class="ident" id="8204184">testing</span><span class="op" id="8204191">.</span><span class="ident" id="8204192">T</span><span class="op" id="8204193">)</span>&nbsp;<span class="op" id="8204195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204198">server</span>&nbsp;<span class="op" id="8204205">:=</span>&nbsp;<span class="ident" id="8204208">strings</span><span class="op" id="8204215">.</span><span class="ident" id="8204216">Join</span><span class="op" id="8204220">(</span><span class="ident" id="8204221">strings</span><span class="op" id="8204228">.</span><span class="ident" id="8204229">Split</span><span class="op" id="8204234">(</span><span class="ident" id="8204235">newClientServer</span><span class="op" id="8204250">,</span>&nbsp;<span class="string" id="8204252">&#34;\n&#34;</span><span class="op" id="8204256">)</span><span class="op" id="8204257">,</span>&nbsp;<span class="string" id="8204259">&#34;\r\n&#34;</span><span class="op" id="8204265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204268">client</span>&nbsp;<span class="op" id="8204275">:=</span>&nbsp;<span class="ident" id="8204278">strings</span><span class="op" id="8204285">.</span><span class="ident" id="8204286">Join</span><span class="op" id="8204290">(</span><span class="ident" id="8204291">strings</span><span class="op" id="8204298">.</span><span class="ident" id="8204299">Split</span><span class="op" id="8204304">(</span><span class="ident" id="8204305">newClientClient</span><span class="op" id="8204320">,</span>&nbsp;<span class="string" id="8204322">&#34;\n&#34;</span><span class="op" id="8204326">)</span><span class="op" id="8204327">,</span>&nbsp;<span class="string" id="8204329">&#34;\r\n&#34;</span><span class="op" id="8204335">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204339">var</span>&nbsp;<span class="ident" id="8204343">cmdbuf</span>&nbsp;<span class="ident" id="8204350">bytes</span><span class="op" id="8204355">.</span><span class="ident" id="8204356">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204364">bcmdbuf</span>&nbsp;<span class="op" id="8204372">:=</span>&nbsp;<span class="ident" id="8204375">bufio</span><span class="op" id="8204380">.</span><span class="ident" id="8204381">NewWriter</span><span class="op" id="8204390">(</span><span class="op" id="8204391">&amp;</span><span class="ident" id="8204392">cmdbuf</span><span class="op" id="8204398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204401">out</span>&nbsp;<span class="op" id="8204405">:=</span>&nbsp;<span class="keyword" id="8204408">func</span><span class="op" id="8204412">(</span><span class="op" id="8204413">)</span>&nbsp;<span class="builtintype" id="8204415">string</span>&nbsp;<span class="op" id="8204422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204426">bcmdbuf</span><span class="op" id="8204433">.</span><span class="ident" id="8204434">Flush</span><span class="op" id="8204439">(</span><span class="op" id="8204440">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204444">return</span>&nbsp;<span class="ident" id="8204451">cmdbuf</span><span class="op" id="8204457">.</span><span class="ident" id="8204458">String</span><span class="op" id="8204464">(</span><span class="op" id="8204465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8204468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204471">var</span>&nbsp;<span class="ident" id="8204475">fake</span>&nbsp;<span class="ident" id="8204480">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204487">fake</span><span class="op" id="8204491">.</span><span class="ident" id="8204492">ReadWriter</span>&nbsp;<span class="op" id="8204503">=</span>&nbsp;<span class="ident" id="8204505">bufio</span><span class="op" id="8204510">.</span><span class="ident" id="8204511">NewReadWriter</span><span class="op" id="8204524">(</span><span class="ident" id="8204525">bufio</span><span class="op" id="8204530">.</span><span class="ident" id="8204531">NewReader</span><span class="op" id="8204540">(</span><span class="ident" id="8204541">strings</span><span class="op" id="8204548">.</span><span class="ident" id="8204549">NewReader</span><span class="op" id="8204558">(</span><span class="ident" id="8204559">server</span><span class="op" id="8204565">)</span><span class="op" id="8204566">)</span><span class="op" id="8204567">,</span>&nbsp;<span class="ident" id="8204569">bcmdbuf</span><span class="op" id="8204576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204579">c</span><span class="op" id="8204580">,</span>&nbsp;<span class="ident" id="8204582">err</span>&nbsp;<span class="op" id="8204586">:=</span>&nbsp;<span class="ident" id="8204589">NewClient</span><span class="op" id="8204598">(</span><span class="ident" id="8204599">fake</span><span class="op" id="8204603">,</span>&nbsp;<span class="string" id="8204605">&#34;fake.host&#34;</span><span class="op" id="8204616">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204619">if</span>&nbsp;<span class="ident" id="8204622">err</span>&nbsp;<span class="op" id="8204626">!=</span>&nbsp;<span class="ident" id="8204629">nil</span>&nbsp;<span class="op" id="8204633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204637">t</span><span class="op" id="8204638">.</span><span class="ident" id="8204639">Fatalf</span><span class="op" id="8204645">(</span><span class="string" id="8204646">&#34;NewClient:&nbsp;%v\n(after&nbsp;%v)&#34;</span><span class="op" id="8204673">,</span>&nbsp;<span class="ident" id="8204675">err</span><span class="op" id="8204678">,</span>&nbsp;<span class="ident" id="8204680">out</span><span class="op" id="8204683">(</span><span class="op" id="8204684">)</span><span class="op" id="8204685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8204688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204691">defer</span>&nbsp;<span class="ident" id="8204697">c</span><span class="op" id="8204698">.</span><span class="ident" id="8204699">Close</span><span class="op" id="8204704">(</span><span class="op" id="8204705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204708">if</span>&nbsp;<span class="ident" id="8204711">ok</span><span class="op" id="8204713">,</span>&nbsp;<span class="ident" id="8204715">args</span>&nbsp;<span class="op" id="8204720">:=</span>&nbsp;<span class="ident" id="8204723">c</span><span class="op" id="8204724">.</span><span class="ident" id="8204725">Extension</span><span class="op" id="8204734">(</span><span class="string" id="8204735">&#34;aUtH&#34;</span><span class="op" id="8204741">)</span><span class="op" id="8204742">;</span>&nbsp;<span class="op" id="8204744">!</span><span class="ident" id="8204745">ok</span>&nbsp;<span class="op" id="8204748">||</span>&nbsp;<span class="ident" id="8204751">args</span>&nbsp;<span class="op" id="8204756">!=</span>&nbsp;<span class="string" id="8204759">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="8204773">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204777">t</span><span class="op" id="8204778">.</span><span class="ident" id="8204779">Fatalf</span><span class="op" id="8204785">(</span><span class="string" id="8204786">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="8204811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8204814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204817">if</span>&nbsp;<span class="ident" id="8204820">ok</span><span class="op" id="8204822">,</span>&nbsp;<span class="ident" id="8204824">_</span>&nbsp;<span class="op" id="8204826">:=</span>&nbsp;<span class="ident" id="8204829">c</span><span class="op" id="8204830">.</span><span class="ident" id="8204831">Extension</span><span class="op" id="8204840">(</span><span class="string" id="8204841">&#34;DSN&#34;</span><span class="op" id="8204846">)</span><span class="op" id="8204847">;</span>&nbsp;<span class="ident" id="8204849">ok</span>&nbsp;<span class="op" id="8204852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204856">t</span><span class="op" id="8204857">.</span><span class="ident" id="8204858">Fatalf</span><span class="op" id="8204864">(</span><span class="string" id="8204865">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="8204888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8204891">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204894">if</span>&nbsp;<span class="ident" id="8204897">err</span>&nbsp;<span class="op" id="8204901">:=</span>&nbsp;<span class="ident" id="8204904">c</span><span class="op" id="8204905">.</span><span class="ident" id="8204906">Quit</span><span class="op" id="8204910">(</span><span class="op" id="8204911">)</span><span class="op" id="8204912">;</span>&nbsp;<span class="ident" id="8204914">err</span>&nbsp;<span class="op" id="8204918">!=</span>&nbsp;<span class="ident" id="8204921">nil</span>&nbsp;<span class="op" id="8204925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204929">t</span><span class="op" id="8204930">.</span><span class="ident" id="8204931">Fatalf</span><span class="op" id="8204937">(</span><span class="string" id="8204938">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8204955">,</span>&nbsp;<span class="ident" id="8204957">err</span><span class="op" id="8204960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8204963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8204967">actualcmds</span>&nbsp;<span class="op" id="8204978">:=</span>&nbsp;<span class="ident" id="8204981">out</span><span class="op" id="8204984">(</span><span class="op" id="8204985">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8204988">if</span>&nbsp;<span class="ident" id="8204991">client</span>&nbsp;<span class="op" id="8204998">!=</span>&nbsp;<span class="ident" id="8205001">actualcmds</span>&nbsp;<span class="op" id="8205012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205016">t</span><span class="op" id="8205017">.</span><span class="ident" id="8205018">Fatalf</span><span class="op" id="8205024">(</span><span class="string" id="8205025">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8205050">,</span>&nbsp;<span class="ident" id="8205052">actualcmds</span><span class="op" id="8205062">,</span>&nbsp;<span class="ident" id="8205064">client</span><span class="op" id="8205070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8205073">}</span><br>
<span class="lineno"></span><span class="op" id="8205075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="keyword" id="8205078">var</span>&nbsp;<span class="ident" id="8205082">newClientServer</span>&nbsp;<span class="op" id="8205098">=</span>&nbsp;<span class="string" id="8205100">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">265</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8205213">var</span>&nbsp;<span class="ident" id="8205217">newClientClient</span>&nbsp;<span class="op" id="8205233">=</span>&nbsp;<span class="string" id="8205235">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">270</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8205259">func</span>&nbsp;<span class="ident" id="8205264">TestNewClient2</span><span class="op" id="8205278">(</span><span class="ident" id="8205279">t</span>&nbsp;<span class="op" id="8205281">*</span><span class="ident" id="8205282">testing</span><span class="op" id="8205289">.</span><span class="ident" id="8205290">T</span><span class="op" id="8205291">)</span>&nbsp;<span class="op" id="8205293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205296">server</span>&nbsp;<span class="op" id="8205303">:=</span>&nbsp;<span class="ident" id="8205306">strings</span><span class="op" id="8205313">.</span><span class="ident" id="8205314">Join</span><span class="op" id="8205318">(</span><span class="ident" id="8205319">strings</span><span class="op" id="8205326">.</span><span class="ident" id="8205327">Split</span><span class="op" id="8205332">(</span><span class="ident" id="8205333">newClient2Server</span><span class="op" id="8205349">,</span>&nbsp;<span class="string" id="8205351">&#34;\n&#34;</span><span class="op" id="8205355">)</span><span class="op" id="8205356">,</span>&nbsp;<span class="string" id="8205358">&#34;\r\n&#34;</span><span class="op" id="8205364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205367">client</span>&nbsp;<span class="op" id="8205374">:=</span>&nbsp;<span class="ident" id="8205377">strings</span><span class="op" id="8205384">.</span><span class="ident" id="8205385">Join</span><span class="op" id="8205389">(</span><span class="ident" id="8205390">strings</span><span class="op" id="8205397">.</span><span class="ident" id="8205398">Split</span><span class="op" id="8205403">(</span><span class="ident" id="8205404">newClient2Client</span><span class="op" id="8205420">,</span>&nbsp;<span class="string" id="8205422">&#34;\n&#34;</span><span class="op" id="8205426">)</span><span class="op" id="8205427">,</span>&nbsp;<span class="string" id="8205429">&#34;\r\n&#34;</span><span class="op" id="8205435">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205439">var</span>&nbsp;<span class="ident" id="8205443">cmdbuf</span>&nbsp;<span class="ident" id="8205450">bytes</span><span class="op" id="8205455">.</span><span class="ident" id="8205456">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205464">bcmdbuf</span>&nbsp;<span class="op" id="8205472">:=</span>&nbsp;<span class="ident" id="8205475">bufio</span><span class="op" id="8205480">.</span><span class="ident" id="8205481">NewWriter</span><span class="op" id="8205490">(</span><span class="op" id="8205491">&amp;</span><span class="ident" id="8205492">cmdbuf</span><span class="op" id="8205498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205501">var</span>&nbsp;<span class="ident" id="8205505">fake</span>&nbsp;<span class="ident" id="8205510">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205517">fake</span><span class="op" id="8205521">.</span><span class="ident" id="8205522">ReadWriter</span>&nbsp;<span class="op" id="8205533">=</span>&nbsp;<span class="ident" id="8205535">bufio</span><span class="op" id="8205540">.</span><span class="ident" id="8205541">NewReadWriter</span><span class="op" id="8205554">(</span><span class="ident" id="8205555">bufio</span><span class="op" id="8205560">.</span><span class="ident" id="8205561">NewReader</span><span class="op" id="8205570">(</span><span class="ident" id="8205571">strings</span><span class="op" id="8205578">.</span><span class="ident" id="8205579">NewReader</span><span class="op" id="8205588">(</span><span class="ident" id="8205589">server</span><span class="op" id="8205595">)</span><span class="op" id="8205596">)</span><span class="op" id="8205597">,</span>&nbsp;<span class="ident" id="8205599">bcmdbuf</span><span class="op" id="8205606">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205609">c</span><span class="op" id="8205610">,</span>&nbsp;<span class="ident" id="8205612">err</span>&nbsp;<span class="op" id="8205616">:=</span>&nbsp;<span class="ident" id="8205619">NewClient</span><span class="op" id="8205628">(</span><span class="ident" id="8205629">fake</span><span class="op" id="8205633">,</span>&nbsp;<span class="string" id="8205635">&#34;fake.host&#34;</span><span class="op" id="8205646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205649">if</span>&nbsp;<span class="ident" id="8205652">err</span>&nbsp;<span class="op" id="8205656">!=</span>&nbsp;<span class="ident" id="8205659">nil</span>&nbsp;<span class="op" id="8205663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205667">t</span><span class="op" id="8205668">.</span><span class="ident" id="8205669">Fatalf</span><span class="op" id="8205675">(</span><span class="string" id="8205676">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="8205691">,</span>&nbsp;<span class="ident" id="8205693">err</span><span class="op" id="8205696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8205699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205702">defer</span>&nbsp;<span class="ident" id="8205708">c</span><span class="op" id="8205709">.</span><span class="ident" id="8205710">Close</span><span class="op" id="8205715">(</span><span class="op" id="8205716">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205719">if</span>&nbsp;<span class="ident" id="8205722">ok</span><span class="op" id="8205724">,</span>&nbsp;<span class="ident" id="8205726">_</span>&nbsp;<span class="op" id="8205728">:=</span>&nbsp;<span class="ident" id="8205731">c</span><span class="op" id="8205732">.</span><span class="ident" id="8205733">Extension</span><span class="op" id="8205742">(</span><span class="string" id="8205743">&#34;DSN&#34;</span><span class="op" id="8205748">)</span><span class="op" id="8205749">;</span>&nbsp;<span class="ident" id="8205751">ok</span>&nbsp;<span class="op" id="8205754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205758">t</span><span class="op" id="8205759">.</span><span class="ident" id="8205760">Fatalf</span><span class="op" id="8205766">(</span><span class="string" id="8205767">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="8205790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8205793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205796">if</span>&nbsp;<span class="ident" id="8205799">err</span>&nbsp;<span class="op" id="8205803">:=</span>&nbsp;<span class="ident" id="8205806">c</span><span class="op" id="8205807">.</span><span class="ident" id="8205808">Quit</span><span class="op" id="8205812">(</span><span class="op" id="8205813">)</span><span class="op" id="8205814">;</span>&nbsp;<span class="ident" id="8205816">err</span>&nbsp;<span class="op" id="8205820">!=</span>&nbsp;<span class="ident" id="8205823">nil</span>&nbsp;<span class="op" id="8205827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205831">t</span><span class="op" id="8205832">.</span><span class="ident" id="8205833">Fatalf</span><span class="op" id="8205839">(</span><span class="string" id="8205840">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8205857">,</span>&nbsp;<span class="ident" id="8205859">err</span><span class="op" id="8205862">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8205865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205869">bcmdbuf</span><span class="op" id="8205876">.</span><span class="ident" id="8205877">Flush</span><span class="op" id="8205882">(</span><span class="op" id="8205883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205886">actualcmds</span>&nbsp;<span class="op" id="8205897">:=</span>&nbsp;<span class="ident" id="8205900">cmdbuf</span><span class="op" id="8205906">.</span><span class="ident" id="8205907">String</span><span class="op" id="8205913">(</span><span class="op" id="8205914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205917">if</span>&nbsp;<span class="ident" id="8205920">client</span>&nbsp;<span class="op" id="8205927">!=</span>&nbsp;<span class="ident" id="8205930">actualcmds</span>&nbsp;<span class="op" id="8205941">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205945">t</span><span class="op" id="8205946">.</span><span class="ident" id="8205947">Fatalf</span><span class="op" id="8205953">(</span><span class="string" id="8205954">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8205979">,</span>&nbsp;<span class="ident" id="8205981">actualcmds</span><span class="op" id="8205991">,</span>&nbsp;<span class="ident" id="8205993">client</span><span class="op" id="8205999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206002">}</span><br>
<span class="lineno"></span><span class="op" id="8206004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8206007">var</span>&nbsp;<span class="ident" id="8206011">newClient2Server</span>&nbsp;<span class="op" id="8206028">=</span>&nbsp;<span class="string" id="8206030">`220&nbsp;hello&nbsp;world<br>
<span class="lineno">300</span>502&nbsp;EH?<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">305</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8206151">var</span>&nbsp;<span class="ident" id="8206155">newClient2Client</span>&nbsp;<span class="op" id="8206172">=</span>&nbsp;<span class="string" id="8206174">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno">310</span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8206213">func</span>&nbsp;<span class="ident" id="8206218">TestHello</span><span class="op" id="8206227">(</span><span class="ident" id="8206228">t</span>&nbsp;<span class="op" id="8206230">*</span><span class="ident" id="8206231">testing</span><span class="op" id="8206238">.</span><span class="ident" id="8206239">T</span><span class="op" id="8206240">)</span>&nbsp;<span class="op" id="8206242">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206246">if</span>&nbsp;<span class="builtinfunc" id="8206249">len</span><span class="op" id="8206252">(</span><span class="ident" id="8206253">helloServer</span><span class="op" id="8206264">)</span>&nbsp;<span class="op" id="8206266">!=</span>&nbsp;<span class="builtinfunc" id="8206269">len</span><span class="op" id="8206272">(</span><span class="ident" id="8206273">helloClient</span><span class="op" id="8206284">)</span>&nbsp;<span class="op" id="8206286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206290">t</span><span class="op" id="8206291">.</span><span class="ident" id="8206292">Fatalf</span><span class="op" id="8206298">(</span><span class="string" id="8206299">&#34;Hello&nbsp;server&nbsp;and&nbsp;client&nbsp;size&nbsp;mismatch&#34;</span><span class="op" id="8206338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206345">for</span>&nbsp;<span class="ident" id="8206349">i</span>&nbsp;<span class="op" id="8206351">:=</span>&nbsp;<span class="num" id="8206354">0</span><span class="op" id="8206355">;</span>&nbsp;<span class="ident" id="8206357">i</span>&nbsp;<span class="op" id="8206359">&lt;</span>&nbsp;<span class="builtinfunc" id="8206361">len</span><span class="op" id="8206364">(</span><span class="ident" id="8206365">helloServer</span><span class="op" id="8206376">)</span><span class="op" id="8206377">;</span>&nbsp;<span class="ident" id="8206379">i</span><span class="op" id="8206380">++</span>&nbsp;<span class="op" id="8206383">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206387">server</span>&nbsp;<span class="op" id="8206394">:=</span>&nbsp;<span class="ident" id="8206397">strings</span><span class="op" id="8206404">.</span><span class="ident" id="8206405">Join</span><span class="op" id="8206409">(</span><span class="ident" id="8206410">strings</span><span class="op" id="8206417">.</span><span class="ident" id="8206418">Split</span><span class="op" id="8206423">(</span><span class="ident" id="8206424">baseHelloServer</span><span class="op" id="8206439">+</span><span class="ident" id="8206440">helloServer</span><span class="op" id="8206451">[</span><span class="ident" id="8206452">i</span><span class="op" id="8206453">]</span><span class="op" id="8206454">,</span>&nbsp;<span class="string" id="8206456">&#34;\n&#34;</span><span class="op" id="8206460">)</span><span class="op" id="8206461">,</span>&nbsp;<span class="string" id="8206463">&#34;\r\n&#34;</span><span class="op" id="8206469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206473">client</span>&nbsp;<span class="op" id="8206480">:=</span>&nbsp;<span class="ident" id="8206483">strings</span><span class="op" id="8206490">.</span><span class="ident" id="8206491">Join</span><span class="op" id="8206495">(</span><span class="ident" id="8206496">strings</span><span class="op" id="8206503">.</span><span class="ident" id="8206504">Split</span><span class="op" id="8206509">(</span><span class="ident" id="8206510">baseHelloClient</span><span class="op" id="8206525">+</span><span class="ident" id="8206526">helloClient</span><span class="op" id="8206537">[</span><span class="ident" id="8206538">i</span><span class="op" id="8206539">]</span><span class="op" id="8206540">,</span>&nbsp;<span class="string" id="8206542">&#34;\n&#34;</span><span class="op" id="8206546">)</span><span class="op" id="8206547">,</span>&nbsp;<span class="string" id="8206549">&#34;\r\n&#34;</span><span class="op" id="8206555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206559">var</span>&nbsp;<span class="ident" id="8206563">cmdbuf</span>&nbsp;<span class="ident" id="8206570">bytes</span><span class="op" id="8206575">.</span><span class="ident" id="8206576">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206585">bcmdbuf</span>&nbsp;<span class="op" id="8206593">:=</span>&nbsp;<span class="ident" id="8206596">bufio</span><span class="op" id="8206601">.</span><span class="ident" id="8206602">NewWriter</span><span class="op" id="8206611">(</span><span class="op" id="8206612">&amp;</span><span class="ident" id="8206613">cmdbuf</span><span class="op" id="8206619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206623">var</span>&nbsp;<span class="ident" id="8206627">fake</span>&nbsp;<span class="ident" id="8206632">faker</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206640">fake</span><span class="op" id="8206644">.</span><span class="ident" id="8206645">ReadWriter</span>&nbsp;<span class="op" id="8206656">=</span>&nbsp;<span class="ident" id="8206658">bufio</span><span class="op" id="8206663">.</span><span class="ident" id="8206664">NewReadWriter</span><span class="op" id="8206677">(</span><span class="ident" id="8206678">bufio</span><span class="op" id="8206683">.</span><span class="ident" id="8206684">NewReader</span><span class="op" id="8206693">(</span><span class="ident" id="8206694">strings</span><span class="op" id="8206701">.</span><span class="ident" id="8206702">NewReader</span><span class="op" id="8206711">(</span><span class="ident" id="8206712">server</span><span class="op" id="8206718">)</span><span class="op" id="8206719">)</span><span class="op" id="8206720">,</span>&nbsp;<span class="ident" id="8206722">bcmdbuf</span><span class="op" id="8206729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206733">c</span><span class="op" id="8206734">,</span>&nbsp;<span class="ident" id="8206736">err</span>&nbsp;<span class="op" id="8206740">:=</span>&nbsp;<span class="ident" id="8206743">NewClient</span><span class="op" id="8206752">(</span><span class="ident" id="8206753">fake</span><span class="op" id="8206757">,</span>&nbsp;<span class="string" id="8206759">&#34;fake.host&#34;</span><span class="op" id="8206770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206774">if</span>&nbsp;<span class="ident" id="8206777">err</span>&nbsp;<span class="op" id="8206781">!=</span>&nbsp;<span class="ident" id="8206784">nil</span>&nbsp;<span class="op" id="8206788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206793">t</span><span class="op" id="8206794">.</span><span class="ident" id="8206795">Fatalf</span><span class="op" id="8206801">(</span><span class="string" id="8206802">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="8206817">,</span>&nbsp;<span class="ident" id="8206819">err</span><span class="op" id="8206822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206826">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206830">defer</span>&nbsp;<span class="ident" id="8206836">c</span><span class="op" id="8206837">.</span><span class="ident" id="8206838">Close</span><span class="op" id="8206843">(</span><span class="op" id="8206844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206848">c</span><span class="op" id="8206849">.</span><span class="ident" id="8206850">localName</span>&nbsp;<span class="op" id="8206860">=</span>&nbsp;<span class="string" id="8206862">&#34;customhost&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206877">err</span>&nbsp;<span class="op" id="8206881">=</span>&nbsp;<span class="ident" id="8206883">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206890">switch</span>&nbsp;<span class="ident" id="8206897">i</span>&nbsp;<span class="op" id="8206899">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206903">case</span>&nbsp;<span class="num" id="8206908">0</span><span class="op" id="8206909">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206914">err</span>&nbsp;<span class="op" id="8206918">=</span>&nbsp;<span class="ident" id="8206920">c</span><span class="op" id="8206921">.</span><span class="ident" id="8206922">Hello</span><span class="op" id="8206927">(</span><span class="string" id="8206928">&#34;customhost&#34;</span><span class="op" id="8206940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206944">case</span>&nbsp;<span class="num" id="8206949">1</span><span class="op" id="8206950">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206955">err</span>&nbsp;<span class="op" id="8206959">=</span>&nbsp;<span class="ident" id="8206961">c</span><span class="op" id="8206962">.</span><span class="ident" id="8206963">StartTLS</span><span class="op" id="8206971">(</span><span class="ident" id="8206972">nil</span><span class="op" id="8206975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206980">if</span>&nbsp;<span class="ident" id="8206983">err</span><span class="op" id="8206986">.</span><span class="ident" id="8206987">Error</span><span class="op" id="8206992">(</span><span class="op" id="8206993">)</span>&nbsp;<span class="op" id="8206995">==</span>&nbsp;<span class="string" id="8206998">&#34;502&nbsp;Not&nbsp;implemented&#34;</span>&nbsp;<span class="op" id="8207020">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207026">err</span>&nbsp;<span class="op" id="8207030">=</span>&nbsp;<span class="ident" id="8207032">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207043">case</span>&nbsp;<span class="num" id="8207048">2</span><span class="op" id="8207049">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207054">err</span>&nbsp;<span class="op" id="8207058">=</span>&nbsp;<span class="ident" id="8207060">c</span><span class="op" id="8207061">.</span><span class="ident" id="8207062">Verify</span><span class="op" id="8207068">(</span><span class="string" id="8207069">&#34;test@example.com&#34;</span><span class="op" id="8207087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207091">case</span>&nbsp;<span class="num" id="8207096">3</span><span class="op" id="8207097">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207102">c</span><span class="op" id="8207103">.</span><span class="ident" id="8207104">tls</span>&nbsp;<span class="op" id="8207108">=</span>&nbsp;<span class="builtintype" id="8207110">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207118">c</span><span class="op" id="8207119">.</span><span class="ident" id="8207120">serverName</span>&nbsp;<span class="op" id="8207131">=</span>&nbsp;<span class="string" id="8207133">&#34;smtp.google.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207154">err</span>&nbsp;<span class="op" id="8207158">=</span>&nbsp;<span class="ident" id="8207160">c</span><span class="op" id="8207161">.</span><span class="ident" id="8207162">Auth</span><span class="op" id="8207166">(</span><span class="ident" id="8207167">PlainAuth</span><span class="op" id="8207176">(</span><span class="string" id="8207177">&#34;&#34;</span><span class="op" id="8207179">,</span>&nbsp;<span class="string" id="8207181">&#34;user&#34;</span><span class="op" id="8207187">,</span>&nbsp;<span class="string" id="8207189">&#34;pass&#34;</span><span class="op" id="8207195">,</span>&nbsp;<span class="string" id="8207197">&#34;smtp.google.com&#34;</span><span class="op" id="8207214">)</span><span class="op" id="8207215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207219">case</span>&nbsp;<span class="num" id="8207224">4</span><span class="op" id="8207225">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207230">err</span>&nbsp;<span class="op" id="8207234">=</span>&nbsp;<span class="ident" id="8207236">c</span><span class="op" id="8207237">.</span><span class="ident" id="8207238">Mail</span><span class="op" id="8207242">(</span><span class="string" id="8207243">&#34;test@example.com&#34;</span><span class="op" id="8207261">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207265">case</span>&nbsp;<span class="num" id="8207270">5</span><span class="op" id="8207271">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207276">ok</span><span class="op" id="8207278">,</span>&nbsp;<span class="ident" id="8207280">_</span>&nbsp;<span class="op" id="8207282">:=</span>&nbsp;<span class="ident" id="8207285">c</span><span class="op" id="8207286">.</span><span class="ident" id="8207287">Extension</span><span class="op" id="8207296">(</span><span class="string" id="8207297">&#34;feature&#34;</span><span class="op" id="8207306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207311">if</span>&nbsp;<span class="ident" id="8207314">ok</span>&nbsp;<span class="op" id="8207317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207323">t</span><span class="op" id="8207324">.</span><span class="ident" id="8207325">Errorf</span><span class="op" id="8207331">(</span><span class="string" id="8207332">&#34;Expected&nbsp;FEATURE&nbsp;not&nbsp;to&nbsp;be&nbsp;supported&#34;</span><span class="op" id="8207370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207375">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207379">case</span>&nbsp;<span class="num" id="8207384">6</span><span class="op" id="8207385">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207390">err</span>&nbsp;<span class="op" id="8207394">=</span>&nbsp;<span class="ident" id="8207396">c</span><span class="op" id="8207397">.</span><span class="ident" id="8207398">Reset</span><span class="op" id="8207403">(</span><span class="op" id="8207404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207408">case</span>&nbsp;<span class="num" id="8207413">7</span><span class="op" id="8207414">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207419">err</span>&nbsp;<span class="op" id="8207423">=</span>&nbsp;<span class="ident" id="8207425">c</span><span class="op" id="8207426">.</span><span class="ident" id="8207427">Quit</span><span class="op" id="8207431">(</span><span class="op" id="8207432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207436">case</span>&nbsp;<span class="num" id="8207441">8</span><span class="op" id="8207442">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207447">err</span>&nbsp;<span class="op" id="8207451">=</span>&nbsp;<span class="ident" id="8207453">c</span><span class="op" id="8207454">.</span><span class="ident" id="8207455">Verify</span><span class="op" id="8207461">(</span><span class="string" id="8207462">&#34;test@example.com&#34;</span><span class="op" id="8207480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207485">if</span>&nbsp;<span class="ident" id="8207488">err</span>&nbsp;<span class="op" id="8207492">!=</span>&nbsp;<span class="ident" id="8207495">nil</span>&nbsp;<span class="op" id="8207499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207505">err</span>&nbsp;<span class="op" id="8207509">=</span>&nbsp;<span class="ident" id="8207511">c</span><span class="op" id="8207512">.</span><span class="ident" id="8207513">Hello</span><span class="op" id="8207518">(</span><span class="string" id="8207519">&#34;customhost&#34;</span><span class="op" id="8207531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207537">if</span>&nbsp;<span class="ident" id="8207540">err</span>&nbsp;<span class="op" id="8207544">!=</span>&nbsp;<span class="ident" id="8207547">nil</span>&nbsp;<span class="op" id="8207551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207558">t</span><span class="op" id="8207559">.</span><span class="ident" id="8207560">Errorf</span><span class="op" id="8207566">(</span><span class="string" id="8207567">&#34;Want&nbsp;error,&nbsp;got&nbsp;none&#34;</span><span class="op" id="8207589">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207604">default</span><span class="op" id="8207611">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207616">t</span><span class="op" id="8207617">.</span><span class="ident" id="8207618">Fatalf</span><span class="op" id="8207624">(</span><span class="string" id="8207625">&#34;Unhandled&nbsp;command&#34;</span><span class="op" id="8207644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207648">}</span><br>
<span class="lineno">370</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207653">if</span>&nbsp;<span class="ident" id="8207656">err</span>&nbsp;<span class="op" id="8207660">!=</span>&nbsp;<span class="ident" id="8207663">nil</span>&nbsp;<span class="op" id="8207667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207672">t</span><span class="op" id="8207673">.</span><span class="ident" id="8207674">Errorf</span><span class="op" id="8207680">(</span><span class="string" id="8207681">&#34;Command&nbsp;%d&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8207704">,</span>&nbsp;<span class="ident" id="8207706">i</span><span class="op" id="8207707">,</span>&nbsp;<span class="ident" id="8207709">err</span><span class="op" id="8207712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207721">bcmdbuf</span><span class="op" id="8207728">.</span><span class="ident" id="8207729">Flush</span><span class="op" id="8207734">(</span><span class="op" id="8207735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207739">actualcmds</span>&nbsp;<span class="op" id="8207750">:=</span>&nbsp;<span class="ident" id="8207753">cmdbuf</span><span class="op" id="8207759">.</span><span class="ident" id="8207760">String</span><span class="op" id="8207766">(</span><span class="op" id="8207767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207771">if</span>&nbsp;<span class="ident" id="8207774">client</span>&nbsp;<span class="op" id="8207781">!=</span>&nbsp;<span class="ident" id="8207784">actualcmds</span>&nbsp;<span class="op" id="8207795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207800">t</span><span class="op" id="8207801">.</span><span class="ident" id="8207802">Errorf</span><span class="op" id="8207808">(</span><span class="string" id="8207809">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8207834">,</span>&nbsp;<span class="ident" id="8207836">actualcmds</span><span class="op" id="8207846">,</span>&nbsp;<span class="ident" id="8207848">client</span><span class="op" id="8207854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207858">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207861">}</span><br>
<span class="lineno"></span><span class="op" id="8207863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8207866">var</span>&nbsp;<span class="ident" id="8207870">baseHelloServer</span>&nbsp;<span class="op" id="8207886">=</span>&nbsp;<span class="string" id="8207888">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno">385</span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;FEATURE<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8207962">var</span>&nbsp;<span class="ident" id="8207966">helloServer</span>&nbsp;<span class="op" id="8207978">=</span>&nbsp;<span class="op" id="8207980">[</span><span class="op" id="8207981">]</span><span class="builtintype" id="8207982">string</span><span class="op" id="8207988">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8207991">&#34;&#34;</span><span class="op" id="8207993">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8207996">&#34;502&nbsp;Not&nbsp;implemented\n&#34;</span><span class="op" id="8208019">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208022">&#34;250&nbsp;User&nbsp;is&nbsp;valid\n&#34;</span><span class="op" id="8208043">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208046">&#34;235&nbsp;Accepted\n&#34;</span><span class="op" id="8208062">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208065">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="8208082">,</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208085">&#34;&#34;</span><span class="op" id="8208087">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208090">&#34;250&nbsp;Reset&nbsp;ok\n&#34;</span><span class="op" id="8208106">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208109">&#34;221&nbsp;Goodbye\n&#34;</span><span class="op" id="8208124">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208127">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="8208144">,</span><br>
<span class="lineno"></span><span class="op" id="8208146">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="8208149">var</span>&nbsp;<span class="ident" id="8208153">baseHelloClient</span>&nbsp;<span class="op" id="8208169">=</span>&nbsp;<span class="string" id="8208171">`EHLO&nbsp;customhost<br>
<span class="lineno"></span>HELO&nbsp;customhost<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="8208207">var</span>&nbsp;<span class="ident" id="8208211">helloClient</span>&nbsp;<span class="op" id="8208223">=</span>&nbsp;<span class="op" id="8208225">[</span><span class="op" id="8208226">]</span><span class="builtintype" id="8208227">string</span><span class="op" id="8208233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208236">&#34;&#34;</span><span class="op" id="8208238">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208241">&#34;STARTTLS\n&#34;</span><span class="op" id="8208253">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208256">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="8208281">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208284">&#34;AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==\n&#34;</span><span class="op" id="8208315">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208318">&#34;MAIL&nbsp;FROM:&lt;test@example.com&gt;\n&#34;</span><span class="op" id="8208350">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208353">&#34;&#34;</span><span class="op" id="8208355">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208358">&#34;RSET\n&#34;</span><span class="op" id="8208366">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208369">&#34;QUIT\n&#34;</span><span class="op" id="8208377">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208380">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="8208405">,</span><br>
<span class="lineno">415</span><span class="op" id="8208407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8208410">func</span>&nbsp;<span class="ident" id="8208415">TestSendMail</span><span class="op" id="8208427">(</span><span class="ident" id="8208428">t</span>&nbsp;<span class="op" id="8208430">*</span><span class="ident" id="8208431">testing</span><span class="op" id="8208438">.</span><span class="ident" id="8208439">T</span><span class="op" id="8208440">)</span>&nbsp;<span class="op" id="8208442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208445">server</span>&nbsp;<span class="op" id="8208452">:=</span>&nbsp;<span class="ident" id="8208455">strings</span><span class="op" id="8208462">.</span><span class="ident" id="8208463">Join</span><span class="op" id="8208467">(</span><span class="ident" id="8208468">strings</span><span class="op" id="8208475">.</span><span class="ident" id="8208476">Split</span><span class="op" id="8208481">(</span><span class="ident" id="8208482">sendMailServer</span><span class="op" id="8208496">,</span>&nbsp;<span class="string" id="8208498">&#34;\n&#34;</span><span class="op" id="8208502">)</span><span class="op" id="8208503">,</span>&nbsp;<span class="string" id="8208505">&#34;\r\n&#34;</span><span class="op" id="8208511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208514">client</span>&nbsp;<span class="op" id="8208521">:=</span>&nbsp;<span class="ident" id="8208524">strings</span><span class="op" id="8208531">.</span><span class="ident" id="8208532">Join</span><span class="op" id="8208536">(</span><span class="ident" id="8208537">strings</span><span class="op" id="8208544">.</span><span class="ident" id="8208545">Split</span><span class="op" id="8208550">(</span><span class="ident" id="8208551">sendMailClient</span><span class="op" id="8208565">,</span>&nbsp;<span class="string" id="8208567">&#34;\n&#34;</span><span class="op" id="8208571">)</span><span class="op" id="8208572">,</span>&nbsp;<span class="string" id="8208574">&#34;\r\n&#34;</span><span class="op" id="8208580">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208583">var</span>&nbsp;<span class="ident" id="8208587">cmdbuf</span>&nbsp;<span class="ident" id="8208594">bytes</span><span class="op" id="8208599">.</span><span class="ident" id="8208600">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208608">bcmdbuf</span>&nbsp;<span class="op" id="8208616">:=</span>&nbsp;<span class="ident" id="8208619">bufio</span><span class="op" id="8208624">.</span><span class="ident" id="8208625">NewWriter</span><span class="op" id="8208634">(</span><span class="op" id="8208635">&amp;</span><span class="ident" id="8208636">cmdbuf</span><span class="op" id="8208642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208645">l</span><span class="op" id="8208646">,</span>&nbsp;<span class="ident" id="8208648">err</span>&nbsp;<span class="op" id="8208652">:=</span>&nbsp;<span class="ident" id="8208655">net</span><span class="op" id="8208658">.</span><span class="ident" id="8208659">Listen</span><span class="op" id="8208665">(</span><span class="string" id="8208666">&#34;tcp&#34;</span><span class="op" id="8208671">,</span>&nbsp;<span class="string" id="8208673">&#34;127.0.0.1:0&#34;</span><span class="op" id="8208686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208689">if</span>&nbsp;<span class="ident" id="8208692">err</span>&nbsp;<span class="op" id="8208696">!=</span>&nbsp;<span class="ident" id="8208699">nil</span>&nbsp;<span class="op" id="8208703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208707">t</span><span class="op" id="8208708">.</span><span class="ident" id="8208709">Fatalf</span><span class="op" id="8208715">(</span><span class="string" id="8208716">&#34;Unable&nbsp;to&nbsp;to&nbsp;create&nbsp;listener:&nbsp;%v&#34;</span><span class="op" id="8208750">,</span>&nbsp;<span class="ident" id="8208752">err</span><span class="op" id="8208755">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8208758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208761">defer</span>&nbsp;<span class="ident" id="8208767">l</span><span class="op" id="8208768">.</span><span class="ident" id="8208769">Close</span><span class="op" id="8208774">(</span><span class="op" id="8208775">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8208779">//&nbsp;prevent&nbsp;data&nbsp;race&nbsp;on&nbsp;bcmdbuf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208812">var</span>&nbsp;<span class="ident" id="8208816">done</span>&nbsp;<span class="op" id="8208821">=</span>&nbsp;<span class="builtinfunc" id="8208823">make</span><span class="op" id="8208827">(</span><span class="keyword" id="8208828">chan</span>&nbsp;<span class="keyword" id="8208833">struct</span><span class="op" id="8208839">{</span><span class="op" id="8208840">}</span><span class="op" id="8208841">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208844">go</span>&nbsp;<span class="keyword" id="8208847">func</span><span class="op" id="8208851">(</span><span class="ident" id="8208852">data</span>&nbsp;<span class="op" id="8208857">[</span><span class="op" id="8208858">]</span><span class="builtintype" id="8208859">string</span><span class="op" id="8208865">)</span>&nbsp;<span class="op" id="8208867">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208872">defer</span>&nbsp;<span class="builtinfunc" id="8208878">close</span><span class="op" id="8208883">(</span><span class="ident" id="8208884">done</span><span class="op" id="8208888">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208893">conn</span><span class="op" id="8208897">,</span>&nbsp;<span class="ident" id="8208899">err</span>&nbsp;<span class="op" id="8208903">:=</span>&nbsp;<span class="ident" id="8208906">l</span><span class="op" id="8208907">.</span><span class="ident" id="8208908">Accept</span><span class="op" id="8208914">(</span><span class="op" id="8208915">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208919">if</span>&nbsp;<span class="ident" id="8208922">err</span>&nbsp;<span class="op" id="8208926">!=</span>&nbsp;<span class="ident" id="8208929">nil</span>&nbsp;<span class="op" id="8208933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208938">t</span><span class="op" id="8208939">.</span><span class="ident" id="8208940">Errorf</span><span class="op" id="8208946">(</span><span class="string" id="8208947">&#34;Accept&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8208965">,</span>&nbsp;<span class="ident" id="8208967">err</span><span class="op" id="8208970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208975">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8208984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208988">defer</span>&nbsp;<span class="ident" id="8208994">conn</span><span class="op" id="8208998">.</span><span class="ident" id="8208999">Close</span><span class="op" id="8209004">(</span><span class="op" id="8209005">)</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209010">tc</span>&nbsp;<span class="op" id="8209013">:=</span>&nbsp;<span class="ident" id="8209016">textproto</span><span class="op" id="8209025">.</span><span class="ident" id="8209026">NewConn</span><span class="op" id="8209033">(</span><span class="ident" id="8209034">conn</span><span class="op" id="8209038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209042">for</span>&nbsp;<span class="ident" id="8209046">i</span>&nbsp;<span class="op" id="8209048">:=</span>&nbsp;<span class="num" id="8209051">0</span><span class="op" id="8209052">;</span>&nbsp;<span class="ident" id="8209054">i</span>&nbsp;<span class="op" id="8209056">&lt;</span>&nbsp;<span class="builtinfunc" id="8209058">len</span><span class="op" id="8209061">(</span><span class="ident" id="8209062">data</span><span class="op" id="8209066">)</span>&nbsp;<span class="op" id="8209068">&amp;&amp;</span>&nbsp;<span class="ident" id="8209071">data</span><span class="op" id="8209075">[</span><span class="ident" id="8209076">i</span><span class="op" id="8209077">]</span>&nbsp;<span class="op" id="8209079">!=</span>&nbsp;<span class="string" id="8209082">&#34;&#34;</span><span class="op" id="8209084">;</span>&nbsp;<span class="ident" id="8209086">i</span><span class="op" id="8209087">++</span>&nbsp;<span class="op" id="8209090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209095">tc</span><span class="op" id="8209097">.</span><span class="ident" id="8209098">PrintfLine</span><span class="op" id="8209108">(</span><span class="ident" id="8209109">data</span><span class="op" id="8209113">[</span><span class="ident" id="8209114">i</span><span class="op" id="8209115">]</span><span class="op" id="8209116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209121">for</span>&nbsp;<span class="builtinfunc" id="8209125">len</span><span class="op" id="8209128">(</span><span class="ident" id="8209129">data</span><span class="op" id="8209133">[</span><span class="ident" id="8209134">i</span><span class="op" id="8209135">]</span><span class="op" id="8209136">)</span>&nbsp;<span class="op" id="8209138">&gt;=</span>&nbsp;<span class="num" id="8209141">4</span>&nbsp;<span class="op" id="8209143">&amp;&amp;</span>&nbsp;<span class="ident" id="8209146">data</span><span class="op" id="8209150">[</span><span class="ident" id="8209151">i</span><span class="op" id="8209152">]</span><span class="op" id="8209153">[</span><span class="num" id="8209154">3</span><span class="op" id="8209155">]</span>&nbsp;<span class="op" id="8209157">==</span>&nbsp;<span class="string" id="8209160">&#39;-&#39;</span>&nbsp;<span class="op" id="8209164">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209170">i</span><span class="op" id="8209171">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209178">tc</span><span class="op" id="8209180">.</span><span class="ident" id="8209181">PrintfLine</span><span class="op" id="8209191">(</span><span class="ident" id="8209192">data</span><span class="op" id="8209196">[</span><span class="ident" id="8209197">i</span><span class="op" id="8209198">]</span><span class="op" id="8209199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209209">if</span>&nbsp;<span class="ident" id="8209212">data</span><span class="op" id="8209216">[</span><span class="ident" id="8209217">i</span><span class="op" id="8209218">]</span>&nbsp;<span class="op" id="8209220">==</span>&nbsp;<span class="string" id="8209223">&#34;221&nbsp;Goodbye&#34;</span>&nbsp;<span class="op" id="8209237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209243">return</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209258">read</span>&nbsp;<span class="op" id="8209263">:=</span>&nbsp;<span class="builtintype" id="8209266">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209275">for</span>&nbsp;<span class="op" id="8209279">!</span><span class="ident" id="8209280">read</span>&nbsp;<span class="op" id="8209285">||</span>&nbsp;<span class="ident" id="8209288">data</span><span class="op" id="8209292">[</span><span class="ident" id="8209293">i</span><span class="op" id="8209294">]</span>&nbsp;<span class="op" id="8209296">==</span>&nbsp;<span class="string" id="8209299">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="8209314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209320">msg</span><span class="op" id="8209323">,</span>&nbsp;<span class="ident" id="8209325">err</span>&nbsp;<span class="op" id="8209329">:=</span>&nbsp;<span class="ident" id="8209332">tc</span><span class="op" id="8209334">.</span><span class="ident" id="8209335">ReadLine</span><span class="op" id="8209343">(</span><span class="op" id="8209344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209350">bcmdbuf</span><span class="op" id="8209357">.</span><span class="ident" id="8209358">Write</span><span class="op" id="8209363">(</span><span class="op" id="8209364">[</span><span class="op" id="8209365">]</span><span class="builtintype" id="8209366">byte</span><span class="op" id="8209370">(</span><span class="ident" id="8209371">msg</span>&nbsp;<span class="op" id="8209375">+</span>&nbsp;<span class="string" id="8209377">&#34;\r\n&#34;</span><span class="op" id="8209383">)</span><span class="op" id="8209384">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209390">read</span>&nbsp;<span class="op" id="8209395">=</span>&nbsp;<span class="builtintype" id="8209397">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209406">if</span>&nbsp;<span class="ident" id="8209409">err</span>&nbsp;<span class="op" id="8209413">!=</span>&nbsp;<span class="ident" id="8209416">nil</span>&nbsp;<span class="op" id="8209420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209427">t</span><span class="op" id="8209428">.</span><span class="ident" id="8209429">Errorf</span><span class="op" id="8209435">(</span><span class="string" id="8209436">&#34;Read&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8209452">,</span>&nbsp;<span class="ident" id="8209454">err</span><span class="op" id="8209457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209464">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209475">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209481">if</span>&nbsp;<span class="ident" id="8209484">data</span><span class="op" id="8209488">[</span><span class="ident" id="8209489">i</span><span class="op" id="8209490">]</span>&nbsp;<span class="op" id="8209492">==</span>&nbsp;<span class="string" id="8209495">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="8209510">&amp;&amp;</span>&nbsp;<span class="ident" id="8209513">msg</span>&nbsp;<span class="op" id="8209517">==</span>&nbsp;<span class="string" id="8209520">&#34;.&#34;</span>&nbsp;<span class="op" id="8209524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209531">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209550">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209553">}</span><span class="op" id="8209554">(</span><span class="ident" id="8209555">strings</span><span class="op" id="8209562">.</span><span class="ident" id="8209563">Split</span><span class="op" id="8209568">(</span><span class="ident" id="8209569">server</span><span class="op" id="8209575">,</span>&nbsp;<span class="string" id="8209577">&#34;\r\n&#34;</span><span class="op" id="8209583">)</span><span class="op" id="8209584">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209588">err</span>&nbsp;<span class="op" id="8209592">=</span>&nbsp;<span class="ident" id="8209594">SendMail</span><span class="op" id="8209602">(</span><span class="ident" id="8209603">l</span><span class="op" id="8209604">.</span><span class="ident" id="8209605">Addr</span><span class="op" id="8209609">(</span><span class="op" id="8209610">)</span><span class="op" id="8209611">.</span><span class="ident" id="8209612">String</span><span class="op" id="8209618">(</span><span class="op" id="8209619">)</span><span class="op" id="8209620">,</span>&nbsp;<span class="ident" id="8209622">nil</span><span class="op" id="8209625">,</span>&nbsp;<span class="string" id="8209627">&#34;test@example.com&#34;</span><span class="op" id="8209645">,</span>&nbsp;<span class="op" id="8209647">[</span><span class="op" id="8209648">]</span><span class="builtintype" id="8209649">string</span><span class="op" id="8209655">{</span><span class="string" id="8209656">&#34;other@example.com&#34;</span><span class="op" id="8209675">}</span><span class="op" id="8209676">,</span>&nbsp;<span class="op" id="8209678">[</span><span class="op" id="8209679">]</span><span class="builtintype" id="8209680">byte</span><span class="op" id="8209684">(</span><span class="ident" id="8209685">strings</span><span class="op" id="8209692">.</span><span class="ident" id="8209693">Replace</span><span class="op" id="8209700">(</span><span class="string" id="8209701">`From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno">470</span><br>
<span class="lineno"></span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>`</span><span class="op" id="8209800">,</span>&nbsp;<span class="string" id="8209802">&#34;\n&#34;</span><span class="op" id="8209806">,</span>&nbsp;<span class="string" id="8209808">&#34;\r\n&#34;</span><span class="op" id="8209814">,</span>&nbsp;<span class="op" id="8209816">-</span><span class="num" id="8209817">1</span><span class="op" id="8209818">)</span><span class="op" id="8209819">)</span><span class="op" id="8209820">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209824">if</span>&nbsp;<span class="ident" id="8209827">err</span>&nbsp;<span class="op" id="8209831">!=</span>&nbsp;<span class="ident" id="8209834">nil</span>&nbsp;<span class="op" id="8209838">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209842">t</span><span class="op" id="8209843">.</span><span class="ident" id="8209844">Errorf</span><span class="op" id="8209850">(</span><span class="string" id="8209851">&#34;%v&#34;</span><span class="op" id="8209855">,</span>&nbsp;<span class="ident" id="8209857">err</span><span class="op" id="8209860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209867">&lt;-</span><span class="ident" id="8209869">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209875">bcmdbuf</span><span class="op" id="8209882">.</span><span class="ident" id="8209883">Flush</span><span class="op" id="8209888">(</span><span class="op" id="8209889">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209892">actualcmds</span>&nbsp;<span class="op" id="8209903">:=</span>&nbsp;<span class="ident" id="8209906">cmdbuf</span><span class="op" id="8209912">.</span><span class="ident" id="8209913">String</span><span class="op" id="8209919">(</span><span class="op" id="8209920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209923">if</span>&nbsp;<span class="ident" id="8209926">client</span>&nbsp;<span class="op" id="8209933">!=</span>&nbsp;<span class="ident" id="8209936">actualcmds</span>&nbsp;<span class="op" id="8209947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209951">t</span><span class="op" id="8209952">.</span><span class="ident" id="8209953">Errorf</span><span class="op" id="8209959">(</span><span class="string" id="8209960">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8209985">,</span>&nbsp;<span class="ident" id="8209987">actualcmds</span><span class="op" id="8209997">,</span>&nbsp;<span class="ident" id="8209999">client</span><span class="op" id="8210005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8210008">}</span><br>
<span class="lineno"></span><span class="op" id="8210010">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="8210013">var</span>&nbsp;<span class="ident" id="8210017">sendMailServer</span>&nbsp;<span class="op" id="8210032">=</span>&nbsp;<span class="string" id="8210034">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno"></span>250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;ok<br>
<span class="lineno">490</span>250&nbsp;Receiver&nbsp;ok<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;ok<br>
<span class="lineno"></span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="keyword" id="8210163">var</span>&nbsp;<span class="ident" id="8210167">sendMailClient</span>&nbsp;<span class="op" id="8210182">=</span>&nbsp;<span class="string" id="8210184">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;test@example.com&gt;<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;other@example.com&gt;<br>
<span class="lineno">500</span>DATA<br>
<span class="lineno"></span>From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno"></span><br>
<span class="lineno">505</span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="8210384">func</span>&nbsp;<span class="ident" id="8210389">TestAuthFailed</span><span class="op" id="8210403">(</span><span class="ident" id="8210404">t</span>&nbsp;<span class="op" id="8210406">*</span><span class="ident" id="8210407">testing</span><span class="op" id="8210414">.</span><span class="ident" id="8210415">T</span><span class="op" id="8210416">)</span>&nbsp;<span class="op" id="8210418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210421">server</span>&nbsp;<span class="op" id="8210428">:=</span>&nbsp;<span class="ident" id="8210431">strings</span><span class="op" id="8210438">.</span><span class="ident" id="8210439">Join</span><span class="op" id="8210443">(</span><span class="ident" id="8210444">strings</span><span class="op" id="8210451">.</span><span class="ident" id="8210452">Split</span><span class="op" id="8210457">(</span><span class="ident" id="8210458">authFailedServer</span><span class="op" id="8210474">,</span>&nbsp;<span class="string" id="8210476">&#34;\n&#34;</span><span class="op" id="8210480">)</span><span class="op" id="8210481">,</span>&nbsp;<span class="string" id="8210483">&#34;\r\n&#34;</span><span class="op" id="8210489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210492">client</span>&nbsp;<span class="op" id="8210499">:=</span>&nbsp;<span class="ident" id="8210502">strings</span><span class="op" id="8210509">.</span><span class="ident" id="8210510">Join</span><span class="op" id="8210514">(</span><span class="ident" id="8210515">strings</span><span class="op" id="8210522">.</span><span class="ident" id="8210523">Split</span><span class="op" id="8210528">(</span><span class="ident" id="8210529">authFailedClient</span><span class="op" id="8210545">,</span>&nbsp;<span class="string" id="8210547">&#34;\n&#34;</span><span class="op" id="8210551">)</span><span class="op" id="8210552">,</span>&nbsp;<span class="string" id="8210554">&#34;\r\n&#34;</span><span class="op" id="8210560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210563">var</span>&nbsp;<span class="ident" id="8210567">cmdbuf</span>&nbsp;<span class="ident" id="8210574">bytes</span><span class="op" id="8210579">.</span><span class="ident" id="8210580">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210588">bcmdbuf</span>&nbsp;<span class="op" id="8210596">:=</span>&nbsp;<span class="ident" id="8210599">bufio</span><span class="op" id="8210604">.</span><span class="ident" id="8210605">NewWriter</span><span class="op" id="8210614">(</span><span class="op" id="8210615">&amp;</span><span class="ident" id="8210616">cmdbuf</span><span class="op" id="8210622">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210625">var</span>&nbsp;<span class="ident" id="8210629">fake</span>&nbsp;<span class="ident" id="8210634">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210641">fake</span><span class="op" id="8210645">.</span><span class="ident" id="8210646">ReadWriter</span>&nbsp;<span class="op" id="8210657">=</span>&nbsp;<span class="ident" id="8210659">bufio</span><span class="op" id="8210664">.</span><span class="ident" id="8210665">NewReadWriter</span><span class="op" id="8210678">(</span><span class="ident" id="8210679">bufio</span><span class="op" id="8210684">.</span><span class="ident" id="8210685">NewReader</span><span class="op" id="8210694">(</span><span class="ident" id="8210695">strings</span><span class="op" id="8210702">.</span><span class="ident" id="8210703">NewReader</span><span class="op" id="8210712">(</span><span class="ident" id="8210713">server</span><span class="op" id="8210719">)</span><span class="op" id="8210720">)</span><span class="op" id="8210721">,</span>&nbsp;<span class="ident" id="8210723">bcmdbuf</span><span class="op" id="8210730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210733">c</span><span class="op" id="8210734">,</span>&nbsp;<span class="ident" id="8210736">err</span>&nbsp;<span class="op" id="8210740">:=</span>&nbsp;<span class="ident" id="8210743">NewClient</span><span class="op" id="8210752">(</span><span class="ident" id="8210753">fake</span><span class="op" id="8210757">,</span>&nbsp;<span class="string" id="8210759">&#34;fake.host&#34;</span><span class="op" id="8210770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210773">if</span>&nbsp;<span class="ident" id="8210776">err</span>&nbsp;<span class="op" id="8210780">!=</span>&nbsp;<span class="ident" id="8210783">nil</span>&nbsp;<span class="op" id="8210787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210791">t</span><span class="op" id="8210792">.</span><span class="ident" id="8210793">Fatalf</span><span class="op" id="8210799">(</span><span class="string" id="8210800">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="8210815">,</span>&nbsp;<span class="ident" id="8210817">err</span><span class="op" id="8210820">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8210823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210826">defer</span>&nbsp;<span class="ident" id="8210832">c</span><span class="op" id="8210833">.</span><span class="ident" id="8210834">Close</span><span class="op" id="8210839">(</span><span class="op" id="8210840">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210844">c</span><span class="op" id="8210845">.</span><span class="ident" id="8210846">tls</span>&nbsp;<span class="op" id="8210850">=</span>&nbsp;<span class="builtintype" id="8210852">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210858">c</span><span class="op" id="8210859">.</span><span class="ident" id="8210860">serverName</span>&nbsp;<span class="op" id="8210871">=</span>&nbsp;<span class="string" id="8210873">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210892">err</span>&nbsp;<span class="op" id="8210896">=</span>&nbsp;<span class="ident" id="8210898">c</span><span class="op" id="8210899">.</span><span class="ident" id="8210900">Auth</span><span class="op" id="8210904">(</span><span class="ident" id="8210905">PlainAuth</span><span class="op" id="8210914">(</span><span class="string" id="8210915">&#34;&#34;</span><span class="op" id="8210917">,</span>&nbsp;<span class="string" id="8210919">&#34;user&#34;</span><span class="op" id="8210925">,</span>&nbsp;<span class="string" id="8210927">&#34;pass&#34;</span><span class="op" id="8210933">,</span>&nbsp;<span class="string" id="8210935">&#34;smtp.google.com&#34;</span><span class="op" id="8210952">)</span><span class="op" id="8210953">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210957">if</span>&nbsp;<span class="ident" id="8210960">err</span>&nbsp;<span class="op" id="8210964">==</span>&nbsp;<span class="ident" id="8210967">nil</span>&nbsp;<span class="op" id="8210971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210975">t</span><span class="op" id="8210976">.</span><span class="ident" id="8210977">Error</span><span class="op" id="8210982">(</span><span class="string" id="8210983">&#34;Auth:&nbsp;expected&nbsp;error;&nbsp;got&nbsp;none&#34;</span><span class="op" id="8211015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8211018">}</span>&nbsp;<span class="keyword" id="8211020">else</span>&nbsp;<span class="keyword" id="8211025">if</span>&nbsp;<span class="ident" id="8211028">err</span><span class="op" id="8211031">.</span><span class="ident" id="8211032">Error</span><span class="op" id="8211037">(</span><span class="op" id="8211038">)</span>&nbsp;<span class="op" id="8211040">!=</span>&nbsp;<span class="string" id="8211043">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span>&nbsp;<span class="op" id="8211097">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211101">t</span><span class="op" id="8211102">.</span><span class="ident" id="8211103">Errorf</span><span class="op" id="8211109">(</span><span class="string" id="8211110">&#34;Auth:&nbsp;got&nbsp;error:&nbsp;%v,&nbsp;want:&nbsp;%s&#34;</span><span class="op" id="8211141">,</span>&nbsp;<span class="ident" id="8211143">err</span><span class="op" id="8211146">,</span>&nbsp;<span class="string" id="8211148">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span><span class="op" id="8211201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8211204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211208">bcmdbuf</span><span class="op" id="8211215">.</span><span class="ident" id="8211216">Flush</span><span class="op" id="8211221">(</span><span class="op" id="8211222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211225">actualcmds</span>&nbsp;<span class="op" id="8211236">:=</span>&nbsp;<span class="ident" id="8211239">cmdbuf</span><span class="op" id="8211245">.</span><span class="ident" id="8211246">String</span><span class="op" id="8211252">(</span><span class="op" id="8211253">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8211256">if</span>&nbsp;<span class="ident" id="8211259">client</span>&nbsp;<span class="op" id="8211266">!=</span>&nbsp;<span class="ident" id="8211269">actualcmds</span>&nbsp;<span class="op" id="8211280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211284">t</span><span class="op" id="8211285">.</span><span class="ident" id="8211286">Errorf</span><span class="op" id="8211292">(</span><span class="string" id="8211293">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8211318">,</span>&nbsp;<span class="ident" id="8211320">actualcmds</span><span class="op" id="8211330">,</span>&nbsp;<span class="ident" id="8211332">client</span><span class="op" id="8211338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8211341">}</span><br>
<span class="lineno"></span><span class="op" id="8211343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">540</span><span class="keyword" id="8211346">var</span>&nbsp;<span class="ident" id="8211350">authFailedServer</span>&nbsp;<span class="op" id="8211367">=</span>&nbsp;<span class="string" id="8211369">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>535-Invalid&nbsp;credentials<br>
<span class="lineno"></span>535&nbsp;please&nbsp;see&nbsp;www.example.com<br>
<span class="lineno">545</span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8211511">var</span>&nbsp;<span class="ident" id="8211515">authFailedClient</span>&nbsp;<span class="op" id="8211532">=</span>&nbsp;<span class="string" id="8211534">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno">550</span>*<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8211588">func</span>&nbsp;<span class="ident" id="8211593">TestTLSClient</span><span class="op" id="8211606">(</span><span class="ident" id="8211607">t</span>&nbsp;<span class="op" id="8211609">*</span><span class="ident" id="8211610">testing</span><span class="op" id="8211617">.</span><span class="ident" id="8211618">T</span><span class="op" id="8211619">)</span>&nbsp;<span class="op" id="8211621">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211624">ln</span>&nbsp;<span class="op" id="8211627">:=</span>&nbsp;<span class="ident" id="8211630">newLocalListener</span><span class="op" id="8211646">(</span><span class="ident" id="8211647">t</span><span class="op" id="8211648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8211651">defer</span>&nbsp;<span class="ident" id="8211657">ln</span><span class="op" id="8211659">.</span><span class="ident" id="8211660">Close</span><span class="op" id="8211665">(</span><span class="op" id="8211666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211669">errc</span>&nbsp;<span class="op" id="8211674">:=</span>&nbsp;<span class="builtinfunc" id="8211677">make</span><span class="op" id="8211681">(</span><span class="keyword" id="8211682">chan</span>&nbsp;<span class="builtintype" id="8211687">error</span><span class="op" id="8211692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8211695">go</span>&nbsp;<span class="keyword" id="8211698">func</span><span class="op" id="8211702">(</span><span class="op" id="8211703">)</span>&nbsp;<span class="op" id="8211705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211709">errc</span>&nbsp;<span class="op" id="8211714">&lt;-</span>&nbsp;<span class="ident" id="8211717">sendMail</span><span class="op" id="8211725">(</span><span class="ident" id="8211726">ln</span><span class="op" id="8211728">.</span><span class="ident" id="8211729">Addr</span><span class="op" id="8211733">(</span><span class="op" id="8211734">)</span><span class="op" id="8211735">.</span><span class="ident" id="8211736">String</span><span class="op" id="8211742">(</span><span class="op" id="8211743">)</span><span class="op" id="8211744">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8211747">}</span><span class="op" id="8211748">(</span><span class="op" id="8211749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211752">conn</span><span class="op" id="8211756">,</span>&nbsp;<span class="ident" id="8211758">err</span>&nbsp;<span class="op" id="8211762">:=</span>&nbsp;<span class="ident" id="8211765">ln</span><span class="op" id="8211767">.</span><span class="ident" id="8211768">Accept</span><span class="op" id="8211774">(</span><span class="op" id="8211775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8211778">if</span>&nbsp;<span class="ident" id="8211781">err</span>&nbsp;<span class="op" id="8211785">!=</span>&nbsp;<span class="ident" id="8211788">nil</span>&nbsp;<span class="op" id="8211792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211796">t</span><span class="op" id="8211797">.</span><span class="ident" id="8211798">Fatalf</span><span class="op" id="8211804">(</span><span class="string" id="8211805">&#34;failed&nbsp;to&nbsp;accept&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="8211838">,</span>&nbsp;<span class="ident" id="8211840">err</span><span class="op" id="8211843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8211846">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8211849">defer</span>&nbsp;<span class="ident" id="8211855">conn</span><span class="op" id="8211859">.</span><span class="ident" id="8211860">Close</span><span class="op" id="8211865">(</span><span class="op" id="8211866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8211869">if</span>&nbsp;<span class="ident" id="8211872">err</span>&nbsp;<span class="op" id="8211876">:=</span>&nbsp;<span class="ident" id="8211879">serverHandle</span><span class="op" id="8211891">(</span><span class="ident" id="8211892">conn</span><span class="op" id="8211896">,</span>&nbsp;<span class="ident" id="8211898">t</span><span class="op" id="8211899">)</span><span class="op" id="8211900">;</span>&nbsp;<span class="ident" id="8211902">err</span>&nbsp;<span class="op" id="8211906">!=</span>&nbsp;<span class="ident" id="8211909">nil</span>&nbsp;<span class="op" id="8211913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211917">t</span><span class="op" id="8211918">.</span><span class="ident" id="8211919">Fatalf</span><span class="op" id="8211925">(</span><span class="string" id="8211926">&#34;failed&nbsp;to&nbsp;handle&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="8211959">,</span>&nbsp;<span class="ident" id="8211961">err</span><span class="op" id="8211964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8211967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8211970">if</span>&nbsp;<span class="ident" id="8211973">err</span>&nbsp;<span class="op" id="8211977">:=</span>&nbsp;<span class="op" id="8211980">&lt;-</span><span class="ident" id="8211982">errc</span><span class="op" id="8211986">;</span>&nbsp;<span class="ident" id="8211988">err</span>&nbsp;<span class="op" id="8211992">!=</span>&nbsp;<span class="ident" id="8211995">nil</span>&nbsp;<span class="op" id="8211999">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212003">t</span><span class="op" id="8212004">.</span><span class="ident" id="8212005">Fatalf</span><span class="op" id="8212011">(</span><span class="string" id="8212012">&#34;client&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8212030">,</span>&nbsp;<span class="ident" id="8212032">err</span><span class="op" id="8212035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8212038">}</span><br>
<span class="lineno"></span><span class="op" id="8212040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8212043">func</span>&nbsp;<span class="ident" id="8212048">newLocalListener</span><span class="op" id="8212064">(</span><span class="ident" id="8212065">t</span>&nbsp;<span class="op" id="8212067">*</span><span class="ident" id="8212068">testing</span><span class="op" id="8212075">.</span><span class="ident" id="8212076">T</span><span class="op" id="8212077">)</span>&nbsp;<span class="ident" id="8212079">net</span><span class="op" id="8212082">.</span><span class="ident" id="8212083">Listener</span>&nbsp;<span class="op" id="8212092">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212095">ln</span><span class="op" id="8212097">,</span>&nbsp;<span class="ident" id="8212099">err</span>&nbsp;<span class="op" id="8212103">:=</span>&nbsp;<span class="ident" id="8212106">net</span><span class="op" id="8212109">.</span><span class="ident" id="8212110">Listen</span><span class="op" id="8212116">(</span><span class="string" id="8212117">&#34;tcp&#34;</span><span class="op" id="8212122">,</span>&nbsp;<span class="string" id="8212124">&#34;127.0.0.1:0&#34;</span><span class="op" id="8212137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212140">if</span>&nbsp;<span class="ident" id="8212143">err</span>&nbsp;<span class="op" id="8212147">!=</span>&nbsp;<span class="ident" id="8212150">nil</span>&nbsp;<span class="op" id="8212154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212158">ln</span><span class="op" id="8212160">,</span>&nbsp;<span class="ident" id="8212162">err</span>&nbsp;<span class="op" id="8212166">=</span>&nbsp;<span class="ident" id="8212168">net</span><span class="op" id="8212171">.</span><span class="ident" id="8212172">Listen</span><span class="op" id="8212178">(</span><span class="string" id="8212179">&#34;tcp6&#34;</span><span class="op" id="8212185">,</span>&nbsp;<span class="string" id="8212187">&#34;[::1]:0&#34;</span><span class="op" id="8212196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8212199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212202">if</span>&nbsp;<span class="ident" id="8212205">err</span>&nbsp;<span class="op" id="8212209">!=</span>&nbsp;<span class="ident" id="8212212">nil</span>&nbsp;<span class="op" id="8212216">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212220">t</span><span class="op" id="8212221">.</span><span class="ident" id="8212222">Fatal</span><span class="op" id="8212227">(</span><span class="ident" id="8212228">err</span><span class="op" id="8212231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8212234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212237">return</span>&nbsp;<span class="ident" id="8212244">ln</span><br>
<span class="lineno"></span><span class="op" id="8212247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span><span class="keyword" id="8212250">type</span>&nbsp;<span class="ident" id="8212255">smtpSender</span>&nbsp;<span class="keyword" id="8212266">struct</span>&nbsp;<span class="op" id="8212273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212276">w</span>&nbsp;<span class="ident" id="8212278">io</span><span class="op" id="8212280">.</span><span class="ident" id="8212281">Writer</span><br>
<span class="lineno"></span><span class="op" id="8212288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8212291">func</span>&nbsp;<span class="op" id="8212296">(</span><span class="ident" id="8212297">s</span>&nbsp;<span class="ident" id="8212299">smtpSender</span><span class="op" id="8212309">)</span>&nbsp;<span class="ident" id="8212311">send</span><span class="op" id="8212315">(</span><span class="ident" id="8212316">f</span>&nbsp;<span class="builtintype" id="8212318">string</span><span class="op" id="8212324">)</span>&nbsp;<span class="op" id="8212326">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212329">s</span><span class="op" id="8212330">.</span><span class="ident" id="8212331">w</span><span class="op" id="8212332">.</span><span class="ident" id="8212333">Write</span><span class="op" id="8212338">(</span><span class="op" id="8212339">[</span><span class="op" id="8212340">]</span><span class="builtintype" id="8212341">byte</span><span class="op" id="8212345">(</span><span class="ident" id="8212346">f</span>&nbsp;<span class="op" id="8212348">+</span>&nbsp;<span class="string" id="8212350">&#34;\r\n&#34;</span><span class="op" id="8212356">)</span><span class="op" id="8212357">)</span><br>
<span class="lineno"></span><span class="op" id="8212359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8212362">//&nbsp;smtp&nbsp;server,&nbsp;finely&nbsp;tailored&nbsp;to&nbsp;deal&nbsp;with&nbsp;our&nbsp;own&nbsp;client&nbsp;only!</span><br>
<span class="lineno"></span><span class="keyword" id="8212428">func</span>&nbsp;<span class="ident" id="8212433">serverHandle</span><span class="op" id="8212445">(</span><span class="ident" id="8212446">c</span>&nbsp;<span class="ident" id="8212448">net</span><span class="op" id="8212451">.</span><span class="ident" id="8212452">Conn</span><span class="op" id="8212456">,</span>&nbsp;<span class="ident" id="8212458">t</span>&nbsp;<span class="op" id="8212460">*</span><span class="ident" id="8212461">testing</span><span class="op" id="8212468">.</span><span class="ident" id="8212469">T</span><span class="op" id="8212470">)</span>&nbsp;<span class="builtintype" id="8212472">error</span>&nbsp;<span class="op" id="8212478">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212481">send</span>&nbsp;<span class="op" id="8212486">:=</span>&nbsp;<span class="ident" id="8212489">smtpSender</span><span class="op" id="8212499">{</span><span class="ident" id="8212500">c</span><span class="op" id="8212501">}</span><span class="op" id="8212502">.</span><span class="ident" id="8212503">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212509">send</span><span class="op" id="8212513">(</span><span class="string" id="8212514">&#34;220&nbsp;127.0.0.1&nbsp;ESMTP&nbsp;service&nbsp;ready&#34;</span><span class="op" id="8212549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212552">s</span>&nbsp;<span class="op" id="8212554">:=</span>&nbsp;<span class="ident" id="8212557">bufio</span><span class="op" id="8212562">.</span><span class="ident" id="8212563">NewScanner</span><span class="op" id="8212573">(</span><span class="ident" id="8212574">c</span><span class="op" id="8212575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212578">for</span>&nbsp;<span class="ident" id="8212582">s</span><span class="op" id="8212583">.</span><span class="ident" id="8212584">Scan</span><span class="op" id="8212588">(</span><span class="op" id="8212589">)</span>&nbsp;<span class="op" id="8212591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212595">switch</span>&nbsp;<span class="ident" id="8212602">s</span><span class="op" id="8212603">.</span><span class="ident" id="8212604">Text</span><span class="op" id="8212608">(</span><span class="op" id="8212609">)</span>&nbsp;<span class="op" id="8212611">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212615">case</span>&nbsp;<span class="string" id="8212620">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="8212636">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212641">send</span><span class="op" id="8212645">(</span><span class="string" id="8212646">&#34;250-127.0.0.1&nbsp;ESMTP&nbsp;offers&nbsp;a&nbsp;warm&nbsp;hug&nbsp;of&nbsp;welcome&#34;</span><span class="op" id="8212696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212701">send</span><span class="op" id="8212705">(</span><span class="string" id="8212706">&#34;250-STARTTLS&#34;</span><span class="op" id="8212720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212725">send</span><span class="op" id="8212729">(</span><span class="string" id="8212730">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8212738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212742">case</span>&nbsp;<span class="string" id="8212747">&#34;STARTTLS&#34;</span><span class="op" id="8212757">:</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212762">send</span><span class="op" id="8212766">(</span><span class="string" id="8212767">&#34;220&nbsp;Go&nbsp;ahead&#34;</span><span class="op" id="8212781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212786">keypair</span><span class="op" id="8212793">,</span>&nbsp;<span class="ident" id="8212795">err</span>&nbsp;<span class="op" id="8212799">:=</span>&nbsp;<span class="ident" id="8212802">tls</span><span class="op" id="8212805">.</span><span class="ident" id="8212806">X509KeyPair</span><span class="op" id="8212817">(</span><span class="ident" id="8212818">localhostCert</span><span class="op" id="8212831">,</span>&nbsp;<span class="ident" id="8212833">localhostKey</span><span class="op" id="8212845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212850">if</span>&nbsp;<span class="ident" id="8212853">err</span>&nbsp;<span class="op" id="8212857">!=</span>&nbsp;<span class="ident" id="8212860">nil</span>&nbsp;<span class="op" id="8212864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212870">return</span>&nbsp;<span class="ident" id="8212877">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8212884">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212889">config</span>&nbsp;<span class="op" id="8212896">:=</span>&nbsp;<span class="op" id="8212899">&amp;</span><span class="ident" id="8212900">tls</span><span class="op" id="8212903">.</span><span class="ident" id="8212904">Config</span><span class="op" id="8212910">{</span><span class="ident" id="8212911">Certificates</span><span class="op" id="8212923">:</span>&nbsp;<span class="op" id="8212925">[</span><span class="op" id="8212926">]</span><span class="ident" id="8212927">tls</span><span class="op" id="8212930">.</span><span class="ident" id="8212931">Certificate</span><span class="op" id="8212942">{</span><span class="ident" id="8212943">keypair</span><span class="op" id="8212950">}</span><span class="op" id="8212951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212956">c</span>&nbsp;<span class="op" id="8212958">=</span>&nbsp;<span class="ident" id="8212960">tls</span><span class="op" id="8212963">.</span><span class="ident" id="8212964">Server</span><span class="op" id="8212970">(</span><span class="ident" id="8212971">c</span><span class="op" id="8212972">,</span>&nbsp;<span class="ident" id="8212974">config</span><span class="op" id="8212980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212985">defer</span>&nbsp;<span class="ident" id="8212991">c</span><span class="op" id="8212992">.</span><span class="ident" id="8212993">Close</span><span class="op" id="8212998">(</span><span class="op" id="8212999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213004">return</span>&nbsp;<span class="ident" id="8213011">serverHandleTLS</span><span class="op" id="8213026">(</span><span class="ident" id="8213027">c</span><span class="op" id="8213028">,</span>&nbsp;<span class="ident" id="8213030">t</span><span class="op" id="8213031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213035">default</span><span class="op" id="8213042">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213047">t</span><span class="op" id="8213048">.</span><span class="ident" id="8213049">Fatalf</span><span class="op" id="8213055">(</span><span class="string" id="8213056">&#34;unrecognized&nbsp;command:&nbsp;%q&#34;</span><span class="op" id="8213082">,</span>&nbsp;<span class="ident" id="8213084">s</span><span class="op" id="8213085">.</span><span class="ident" id="8213086">Text</span><span class="op" id="8213090">(</span><span class="op" id="8213091">)</span><span class="op" id="8213092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8213096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8213099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213102">return</span>&nbsp;<span class="ident" id="8213109">s</span><span class="op" id="8213110">.</span><span class="ident" id="8213111">Err</span><span class="op" id="8213114">(</span><span class="op" id="8213115">)</span><br>
<span class="lineno"></span><span class="op" id="8213117">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="8213120">func</span>&nbsp;<span class="ident" id="8213125">serverHandleTLS</span><span class="op" id="8213140">(</span><span class="ident" id="8213141">c</span>&nbsp;<span class="ident" id="8213143">net</span><span class="op" id="8213146">.</span><span class="ident" id="8213147">Conn</span><span class="op" id="8213151">,</span>&nbsp;<span class="ident" id="8213153">t</span>&nbsp;<span class="op" id="8213155">*</span><span class="ident" id="8213156">testing</span><span class="op" id="8213163">.</span><span class="ident" id="8213164">T</span><span class="op" id="8213165">)</span>&nbsp;<span class="builtintype" id="8213167">error</span>&nbsp;<span class="op" id="8213173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213176">send</span>&nbsp;<span class="op" id="8213181">:=</span>&nbsp;<span class="ident" id="8213184">smtpSender</span><span class="op" id="8213194">{</span><span class="ident" id="8213195">c</span><span class="op" id="8213196">}</span><span class="op" id="8213197">.</span><span class="ident" id="8213198">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213204">s</span>&nbsp;<span class="op" id="8213206">:=</span>&nbsp;<span class="ident" id="8213209">bufio</span><span class="op" id="8213214">.</span><span class="ident" id="8213215">NewScanner</span><span class="op" id="8213225">(</span><span class="ident" id="8213226">c</span><span class="op" id="8213227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213230">for</span>&nbsp;<span class="ident" id="8213234">s</span><span class="op" id="8213235">.</span><span class="ident" id="8213236">Scan</span><span class="op" id="8213240">(</span><span class="op" id="8213241">)</span>&nbsp;<span class="op" id="8213243">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213247">switch</span>&nbsp;<span class="ident" id="8213254">s</span><span class="op" id="8213255">.</span><span class="ident" id="8213256">Text</span><span class="op" id="8213260">(</span><span class="op" id="8213261">)</span>&nbsp;<span class="op" id="8213263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213267">case</span>&nbsp;<span class="string" id="8213272">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="8213288">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213293">send</span><span class="op" id="8213297">(</span><span class="string" id="8213298">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8213306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213310">case</span>&nbsp;<span class="string" id="8213315">&#34;MAIL&nbsp;FROM:&lt;joe1@example.com&gt;&#34;</span><span class="op" id="8213345">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213350">send</span><span class="op" id="8213354">(</span><span class="string" id="8213355">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8213363">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213367">case</span>&nbsp;<span class="string" id="8213372">&#34;RCPT&nbsp;TO:&lt;joe2@example.com&gt;&#34;</span><span class="op" id="8213400">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213405">send</span><span class="op" id="8213409">(</span><span class="string" id="8213410">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8213418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213422">case</span>&nbsp;<span class="string" id="8213427">&#34;DATA&#34;</span><span class="op" id="8213433">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213438">send</span><span class="op" id="8213442">(</span><span class="string" id="8213443">&#34;354&nbsp;send&nbsp;the&nbsp;mail&nbsp;data,&nbsp;end&nbsp;with&nbsp;.&#34;</span><span class="op" id="8213479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213484">send</span><span class="op" id="8213488">(</span><span class="string" id="8213489">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8213497">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213501">case</span>&nbsp;<span class="string" id="8213506">&#34;Subject:&nbsp;test&#34;</span><span class="op" id="8213521">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213525">case</span>&nbsp;<span class="string" id="8213530">&#34;&#34;</span><span class="op" id="8213532">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213536">case</span>&nbsp;<span class="string" id="8213541">&#34;howdy!&#34;</span><span class="op" id="8213549">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213553">case</span>&nbsp;<span class="string" id="8213558">&#34;.&#34;</span><span class="op" id="8213561">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213565">case</span>&nbsp;<span class="string" id="8213570">&#34;QUIT&#34;</span><span class="op" id="8213576">:</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213581">send</span><span class="op" id="8213585">(</span><span class="string" id="8213586">&#34;221&nbsp;127.0.0.1&nbsp;Service&nbsp;closing&nbsp;transmission&nbsp;channel&#34;</span><span class="op" id="8213638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213643">return</span>&nbsp;<span class="ident" id="8213650">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213656">default</span><span class="op" id="8213663">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213668">t</span><span class="op" id="8213669">.</span><span class="ident" id="8213670">Fatalf</span><span class="op" id="8213676">(</span><span class="string" id="8213677">&#34;unrecognized&nbsp;command&nbsp;during&nbsp;TLS:&nbsp;%q&#34;</span><span class="op" id="8213714">,</span>&nbsp;<span class="ident" id="8213716">s</span><span class="op" id="8213717">.</span><span class="ident" id="8213718">Text</span><span class="op" id="8213722">(</span><span class="op" id="8213723">)</span><span class="op" id="8213724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8213728">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8213731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213734">return</span>&nbsp;<span class="ident" id="8213741">s</span><span class="op" id="8213742">.</span><span class="ident" id="8213743">Err</span><span class="op" id="8213746">(</span><span class="op" id="8213747">)</span><br>
<span class="lineno"></span><span class="op" id="8213749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8213752">func</span>&nbsp;<span class="ident" id="8213757">init</span><span class="op" id="8213761">(</span><span class="op" id="8213762">)</span>&nbsp;<span class="op" id="8213764">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213767">testRootCAs</span>&nbsp;<span class="op" id="8213779">:=</span>&nbsp;<span class="ident" id="8213782">x509</span><span class="op" id="8213786">.</span><span class="ident" id="8213787">NewCertPool</span><span class="op" id="8213798">(</span><span class="op" id="8213799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213802">testRootCAs</span><span class="op" id="8213813">.</span><span class="ident" id="8213814">AppendCertsFromPEM</span><span class="op" id="8213832">(</span><span class="ident" id="8213833">localhostCert</span><span class="op" id="8213846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213849">testHookStartTLS</span>&nbsp;<span class="op" id="8213866">=</span>&nbsp;<span class="keyword" id="8213868">func</span><span class="op" id="8213872">(</span><span class="ident" id="8213873">config</span>&nbsp;<span class="op" id="8213880">*</span><span class="ident" id="8213881">tls</span><span class="op" id="8213884">.</span><span class="ident" id="8213885">Config</span><span class="op" id="8213891">)</span>&nbsp;<span class="op" id="8213893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213897">config</span><span class="op" id="8213903">.</span><span class="ident" id="8213904">RootCAs</span>&nbsp;<span class="op" id="8213912">=</span>&nbsp;<span class="ident" id="8213914">testRootCAs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8213927">}</span><br>
<span class="lineno">655</span><span class="op" id="8213929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8213932">func</span>&nbsp;<span class="ident" id="8213937">sendMail</span><span class="op" id="8213945">(</span><span class="ident" id="8213946">hostPort</span>&nbsp;<span class="builtintype" id="8213955">string</span><span class="op" id="8213961">)</span>&nbsp;<span class="builtintype" id="8213963">error</span>&nbsp;<span class="op" id="8213969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213972">host</span><span class="op" id="8213976">,</span>&nbsp;<span class="ident" id="8213978">_</span><span class="op" id="8213979">,</span>&nbsp;<span class="ident" id="8213981">err</span>&nbsp;<span class="op" id="8213985">:=</span>&nbsp;<span class="ident" id="8213988">net</span><span class="op" id="8213991">.</span><span class="ident" id="8213992">SplitHostPort</span><span class="op" id="8214005">(</span><span class="ident" id="8214006">hostPort</span><span class="op" id="8214014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8214017">if</span>&nbsp;<span class="ident" id="8214020">err</span>&nbsp;<span class="op" id="8214024">!=</span>&nbsp;<span class="ident" id="8214027">nil</span>&nbsp;<span class="op" id="8214031">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8214035">return</span>&nbsp;<span class="ident" id="8214042">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8214047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8214050">auth</span>&nbsp;<span class="op" id="8214055">:=</span>&nbsp;<span class="ident" id="8214058">PlainAuth</span><span class="op" id="8214067">(</span><span class="string" id="8214068">&#34;&#34;</span><span class="op" id="8214070">,</span>&nbsp;<span class="string" id="8214072">&#34;&#34;</span><span class="op" id="8214074">,</span>&nbsp;<span class="string" id="8214076">&#34;&#34;</span><span class="op" id="8214078">,</span>&nbsp;<span class="ident" id="8214080">host</span><span class="op" id="8214084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8214087">from</span>&nbsp;<span class="op" id="8214092">:=</span>&nbsp;<span class="string" id="8214095">&#34;joe1@example.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8214115">to</span>&nbsp;<span class="op" id="8214118">:=</span>&nbsp;<span class="op" id="8214121">[</span><span class="op" id="8214122">]</span><span class="builtintype" id="8214123">string</span><span class="op" id="8214129">{</span><span class="string" id="8214130">&#34;joe2@example.com&#34;</span><span class="op" id="8214148">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8214151">return</span>&nbsp;<span class="ident" id="8214158">SendMail</span><span class="op" id="8214166">(</span><span class="ident" id="8214167">hostPort</span><span class="op" id="8214175">,</span>&nbsp;<span class="ident" id="8214177">auth</span><span class="op" id="8214181">,</span>&nbsp;<span class="ident" id="8214183">from</span><span class="op" id="8214187">,</span>&nbsp;<span class="ident" id="8214189">to</span><span class="op" id="8214191">,</span>&nbsp;<span class="op" id="8214193">[</span><span class="op" id="8214194">]</span><span class="builtintype" id="8214195">byte</span><span class="op" id="8214199">(</span><span class="string" id="8214200">&#34;Subject:&nbsp;test\n\nhowdy!&#34;</span><span class="op" id="8214225">)</span><span class="op" id="8214226">)</span><br>
<span class="lineno"></span><span class="op" id="8214228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8214231">//&nbsp;(copied&nbsp;from&nbsp;net/http/httptest)</span><br>
<span class="lineno"></span><span class="comment" id="8214266">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno">670</span><span class="comment" id="8214322">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno"></span><span class="comment" id="8214395">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="8214414">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="8214448">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="8214584">var</span>&nbsp;<span class="ident" id="8214588">localhostCert</span>&nbsp;<span class="op" id="8214602">=</span>&nbsp;<span class="op" id="8214604">[</span><span class="op" id="8214605">]</span><span class="builtintype" id="8214606">byte</span><span class="op" id="8214610">(</span><span class="string" id="8214611">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno">675</span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno"></span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno">680</span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno"></span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="8215182">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span><span class="comment" id="8215185">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno"></span><span class="keyword" id="8215239">var</span>&nbsp;<span class="ident" id="8215243">localhostKey</span>&nbsp;<span class="op" id="8215256">=</span>&nbsp;<span class="op" id="8215258">[</span><span class="op" id="8215259">]</span><span class="builtintype" id="8215260">byte</span><span class="op" id="8215264">(</span><span class="string" id="8215265">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno">690</span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno"></span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="8215763">)</span>
</div>
</body>
</html>
