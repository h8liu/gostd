<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3378057">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3378113">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3378167">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3378218">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3378296">package</span>&nbsp;<span class="ident" id="3378304">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3378309">import</span>&nbsp;<span class="op" id="3378316">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3378319">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3378330">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3378337">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3378340">//&nbsp;BUG(mikio):&nbsp;On&nbsp;every&nbsp;POSIX&nbsp;platform,&nbsp;reads&nbsp;from&nbsp;the&nbsp;&#34;ip4&#34;&nbsp;network</span><br>
<span class="lineno">15</span><span class="comment" id="3378409">//&nbsp;using&nbsp;the&nbsp;ReadFrom&nbsp;or&nbsp;ReadFromIP&nbsp;method&nbsp;might&nbsp;not&nbsp;return&nbsp;a&nbsp;complete</span><br>
<span class="lineno"></span><span class="comment" id="3378480">//&nbsp;IPv4&nbsp;packet,&nbsp;including&nbsp;its&nbsp;header,&nbsp;even&nbsp;if&nbsp;there&nbsp;is&nbsp;space</span><br>
<span class="lineno"></span><span class="comment" id="3378541">//&nbsp;available.&nbsp;This&nbsp;can&nbsp;occur&nbsp;even&nbsp;in&nbsp;cases&nbsp;where&nbsp;Read&nbsp;or&nbsp;ReadMsgIP</span><br>
<span class="lineno"></span><span class="comment" id="3378608">//&nbsp;could&nbsp;return&nbsp;a&nbsp;complete&nbsp;packet.&nbsp;For&nbsp;this&nbsp;reason,&nbsp;it&nbsp;is&nbsp;recommended</span><br>
<span class="lineno"></span><span class="comment" id="3378678">//&nbsp;that&nbsp;you&nbsp;do&nbsp;not&nbsp;uses&nbsp;these&nbsp;methods&nbsp;if&nbsp;it&nbsp;is&nbsp;important&nbsp;to&nbsp;receive&nbsp;a</span><br>
<span class="lineno">20</span><span class="comment" id="3378748">//&nbsp;full&nbsp;packet.</span><br>
<span class="lineno"></span><span class="comment" id="3378764">//</span><br>
<span class="lineno"></span><span class="comment" id="3378767">//&nbsp;The&nbsp;Go&nbsp;1&nbsp;compatibility&nbsp;guidelines&nbsp;make&nbsp;it&nbsp;impossible&nbsp;for&nbsp;us&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3378833">//&nbsp;change&nbsp;the&nbsp;behavior&nbsp;of&nbsp;these&nbsp;methods;&nbsp;use&nbsp;Read&nbsp;or&nbsp;ReadMsgIP</span><br>
<span class="lineno"></span><span class="comment" id="3378896">//&nbsp;instead.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="3378909">func</span>&nbsp;<span class="ident" id="3378914">sockaddrToIP</span><span class="op" id="3378926">(</span><span class="ident" id="3378927">sa</span>&nbsp;<span class="ident" id="3378930">syscall</span><span class="op" id="3378937">.</span><span class="ident" id="3378938">Sockaddr</span><span class="op" id="3378946">)</span>&nbsp;<span class="ident" id="3378948">Addr</span>&nbsp;<span class="op" id="3378953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378956">switch</span>&nbsp;<span class="ident" id="3378963">sa</span>&nbsp;<span class="op" id="3378966">:=</span>&nbsp;<span class="ident" id="3378969">sa</span><span class="op" id="3378971">.</span><span class="op" id="3378972">(</span><span class="keyword" id="3378973">type</span><span class="op" id="3378977">)</span>&nbsp;<span class="op" id="3378979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378982">case</span>&nbsp;<span class="op" id="3378987">*</span><span class="ident" id="3378988">syscall</span><span class="op" id="3378995">.</span><span class="ident" id="3378996">SockaddrInet4</span><span class="op" id="3379009">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379013">return</span>&nbsp;<span class="op" id="3379020">&amp;</span><span class="ident" id="3379021">IPAddr</span><span class="op" id="3379027">{</span><span class="ident" id="3379028">IP</span><span class="op" id="3379030">:</span>&nbsp;<span class="ident" id="3379032">sa</span><span class="op" id="3379034">.</span><span class="ident" id="3379035">Addr</span><span class="op" id="3379039">[</span><span class="num" id="3379040">0</span><span class="op" id="3379041">:</span><span class="op" id="3379042">]</span><span class="op" id="3379043">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379046">case</span>&nbsp;<span class="op" id="3379051">*</span><span class="ident" id="3379052">syscall</span><span class="op" id="3379059">.</span><span class="ident" id="3379060">SockaddrInet6</span><span class="op" id="3379073">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379077">return</span>&nbsp;<span class="op" id="3379084">&amp;</span><span class="ident" id="3379085">IPAddr</span><span class="op" id="3379091">{</span><span class="ident" id="3379092">IP</span><span class="op" id="3379094">:</span>&nbsp;<span class="ident" id="3379096">sa</span><span class="op" id="3379098">.</span><span class="ident" id="3379099">Addr</span><span class="op" id="3379103">[</span><span class="num" id="3379104">0</span><span class="op" id="3379105">:</span><span class="op" id="3379106">]</span><span class="op" id="3379107">,</span>&nbsp;<span class="ident" id="3379109">Zone</span><span class="op" id="3379113">:</span>&nbsp;<span class="ident" id="3379115">zoneToString</span><span class="op" id="3379127">(</span><span class="builtintype" id="3379128">int</span><span class="op" id="3379131">(</span><span class="ident" id="3379132">sa</span><span class="op" id="3379134">.</span><span class="ident" id="3379135">ZoneId</span><span class="op" id="3379141">)</span><span class="op" id="3379142">)</span><span class="op" id="3379143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379149">return</span>&nbsp;<span class="ident" id="3379156">nil</span><br>
<span class="lineno"></span><span class="op" id="3379160">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="3379163">func</span>&nbsp;<span class="op" id="3379168">(</span><span class="ident" id="3379169">a</span>&nbsp;<span class="op" id="3379171">*</span><span class="ident" id="3379172">IPAddr</span><span class="op" id="3379178">)</span>&nbsp;<span class="ident" id="3379180">family</span><span class="op" id="3379186">(</span><span class="op" id="3379187">)</span>&nbsp;<span class="builtintype" id="3379189">int</span>&nbsp;<span class="op" id="3379193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379196">if</span>&nbsp;<span class="ident" id="3379199">a</span>&nbsp;<span class="op" id="3379201">==</span>&nbsp;<span class="ident" id="3379204">nil</span>&nbsp;<span class="op" id="3379208">||</span>&nbsp;<span class="builtinfunc" id="3379211">len</span><span class="op" id="3379214">(</span><span class="ident" id="3379215">a</span><span class="op" id="3379216">.</span><span class="ident" id="3379217">IP</span><span class="op" id="3379219">)</span>&nbsp;<span class="op" id="3379221">&lt;=</span>&nbsp;<span class="ident" id="3379224">IPv4len</span>&nbsp;<span class="op" id="3379232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379236">return</span>&nbsp;<span class="ident" id="3379243">syscall</span><span class="op" id="3379250">.</span><span class="ident" id="3379251">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379260">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379263">if</span>&nbsp;<span class="ident" id="3379266">a</span><span class="op" id="3379267">.</span><span class="ident" id="3379268">IP</span><span class="op" id="3379270">.</span><span class="ident" id="3379271">To4</span><span class="op" id="3379274">(</span><span class="op" id="3379275">)</span>&nbsp;<span class="op" id="3379277">!=</span>&nbsp;<span class="ident" id="3379280">nil</span>&nbsp;<span class="op" id="3379284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379288">return</span>&nbsp;<span class="ident" id="3379295">syscall</span><span class="op" id="3379302">.</span><span class="ident" id="3379303">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379315">return</span>&nbsp;<span class="ident" id="3379322">syscall</span><span class="op" id="3379329">.</span><span class="ident" id="3379330">AF_INET6</span><br>
<span class="lineno"></span><span class="op" id="3379339">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="3379342">func</span>&nbsp;<span class="op" id="3379347">(</span><span class="ident" id="3379348">a</span>&nbsp;<span class="op" id="3379350">*</span><span class="ident" id="3379351">IPAddr</span><span class="op" id="3379357">)</span>&nbsp;<span class="ident" id="3379359">isWildcard</span><span class="op" id="3379369">(</span><span class="op" id="3379370">)</span>&nbsp;<span class="builtintype" id="3379372">bool</span>&nbsp;<span class="op" id="3379377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379380">if</span>&nbsp;<span class="ident" id="3379383">a</span>&nbsp;<span class="op" id="3379385">==</span>&nbsp;<span class="ident" id="3379388">nil</span>&nbsp;<span class="op" id="3379392">||</span>&nbsp;<span class="ident" id="3379395">a</span><span class="op" id="3379396">.</span><span class="ident" id="3379397">IP</span>&nbsp;<span class="op" id="3379400">==</span>&nbsp;<span class="ident" id="3379403">nil</span>&nbsp;<span class="op" id="3379407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379411">return</span>&nbsp;<span class="ident" id="3379418">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379424">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379427">return</span>&nbsp;<span class="ident" id="3379434">a</span><span class="op" id="3379435">.</span><span class="ident" id="3379436">IP</span><span class="op" id="3379438">.</span><span class="ident" id="3379439">IsUnspecified</span><span class="op" id="3379452">(</span><span class="op" id="3379453">)</span><br>
<span class="lineno"></span><span class="op" id="3379455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3379458">func</span>&nbsp;<span class="op" id="3379463">(</span><span class="ident" id="3379464">a</span>&nbsp;<span class="op" id="3379466">*</span><span class="ident" id="3379467">IPAddr</span><span class="op" id="3379473">)</span>&nbsp;<span class="ident" id="3379475">sockaddr</span><span class="op" id="3379483">(</span><span class="ident" id="3379484">family</span>&nbsp;<span class="builtintype" id="3379491">int</span><span class="op" id="3379494">)</span>&nbsp;<span class="op" id="3379496">(</span><span class="ident" id="3379497">syscall</span><span class="op" id="3379504">.</span><span class="ident" id="3379505">Sockaddr</span><span class="op" id="3379513">,</span>&nbsp;<span class="builtintype" id="3379515">error</span><span class="op" id="3379520">)</span>&nbsp;<span class="op" id="3379522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379525">if</span>&nbsp;<span class="ident" id="3379528">a</span>&nbsp;<span class="op" id="3379530">==</span>&nbsp;<span class="ident" id="3379533">nil</span>&nbsp;<span class="op" id="3379537">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379541">return</span>&nbsp;<span class="ident" id="3379548">nil</span><span class="op" id="3379551">,</span>&nbsp;<span class="ident" id="3379553">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379561">return</span>&nbsp;<span class="ident" id="3379568">ipToSockaddr</span><span class="op" id="3379580">(</span><span class="ident" id="3379581">family</span><span class="op" id="3379587">,</span>&nbsp;<span class="ident" id="3379589">a</span><span class="op" id="3379590">.</span><span class="ident" id="3379591">IP</span><span class="op" id="3379593">,</span>&nbsp;<span class="num" id="3379595">0</span><span class="op" id="3379596">,</span>&nbsp;<span class="ident" id="3379598">a</span><span class="op" id="3379599">.</span><span class="ident" id="3379600">Zone</span><span class="op" id="3379604">)</span><br>
<span class="lineno"></span><span class="op" id="3379606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="3379609">//&nbsp;IPConn&nbsp;is&nbsp;the&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Conn&nbsp;and&nbsp;PacketConn&nbsp;interfaces</span><br>
<span class="lineno"></span><span class="comment" id="3379679">//&nbsp;for&nbsp;IP&nbsp;network&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="3379710">type</span>&nbsp;<span class="ident" id="3379715">IPConn</span>&nbsp;<span class="keyword" id="3379722">struct</span>&nbsp;<span class="op" id="3379729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379732">conn</span><br>
<span class="lineno"></span><span class="op" id="3379737">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="3379740">func</span>&nbsp;<span class="ident" id="3379745">newIPConn</span><span class="op" id="3379754">(</span><span class="ident" id="3379755">fd</span>&nbsp;<span class="op" id="3379758">*</span><span class="ident" id="3379759">netFD</span><span class="op" id="3379764">)</span>&nbsp;<span class="op" id="3379766">*</span><span class="ident" id="3379767">IPConn</span>&nbsp;<span class="op" id="3379774">{</span>&nbsp;<span class="keyword" id="3379776">return</span>&nbsp;<span class="op" id="3379783">&amp;</span><span class="ident" id="3379784">IPConn</span><span class="op" id="3379790">{</span><span class="ident" id="3379791">conn</span><span class="op" id="3379795">{</span><span class="ident" id="3379796">fd</span><span class="op" id="3379798">}</span><span class="op" id="3379799">}</span>&nbsp;<span class="op" id="3379801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3379804">//&nbsp;ReadFromIP&nbsp;reads&nbsp;an&nbsp;IP&nbsp;packet&nbsp;from&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;into&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="3379873">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;b&nbsp;and&nbsp;the&nbsp;return&nbsp;address</span><br>
<span class="lineno">70</span><span class="comment" id="3379944">//&nbsp;that&nbsp;was&nbsp;on&nbsp;the&nbsp;packet.</span><br>
<span class="lineno"></span><span class="comment" id="3379971">//</span><br>
<span class="lineno"></span><span class="comment" id="3379974">//&nbsp;ReadFromIP&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;an&nbsp;error&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3380037">//&nbsp;Timeout()&nbsp;==&nbsp;true&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3380104">//&nbsp;SetReadDeadline.</span><br>
<span class="lineno">75</span><span class="keyword" id="3380124">func</span>&nbsp;<span class="op" id="3380129">(</span><span class="ident" id="3380130">c</span>&nbsp;<span class="op" id="3380132">*</span><span class="ident" id="3380133">IPConn</span><span class="op" id="3380139">)</span>&nbsp;<span class="ident" id="3380141">ReadFromIP</span><span class="op" id="3380151">(</span><span class="ident" id="3380152">b</span>&nbsp;<span class="op" id="3380154">[</span><span class="op" id="3380155">]</span><span class="builtintype" id="3380156">byte</span><span class="op" id="3380160">)</span>&nbsp;<span class="op" id="3380162">(</span><span class="builtintype" id="3380163">int</span><span class="op" id="3380166">,</span>&nbsp;<span class="op" id="3380168">*</span><span class="ident" id="3380169">IPAddr</span><span class="op" id="3380175">,</span>&nbsp;<span class="builtintype" id="3380177">error</span><span class="op" id="3380182">)</span>&nbsp;<span class="op" id="3380184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380187">if</span>&nbsp;<span class="op" id="3380190">!</span><span class="ident" id="3380191">c</span><span class="op" id="3380192">.</span><span class="ident" id="3380193">ok</span><span class="op" id="3380195">(</span><span class="op" id="3380196">)</span>&nbsp;<span class="op" id="3380198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380202">return</span>&nbsp;<span class="num" id="3380209">0</span><span class="op" id="3380210">,</span>&nbsp;<span class="ident" id="3380212">nil</span><span class="op" id="3380215">,</span>&nbsp;<span class="ident" id="3380217">syscall</span><span class="op" id="3380224">.</span><span class="ident" id="3380225">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3380236">//&nbsp;TODO(cw,rsc):&nbsp;consider&nbsp;using&nbsp;readv&nbsp;if&nbsp;we&nbsp;know&nbsp;the&nbsp;family</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3380297">//&nbsp;type&nbsp;to&nbsp;avoid&nbsp;the&nbsp;header&nbsp;trim/copy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380336">var</span>&nbsp;<span class="ident" id="3380340">addr</span>&nbsp;<span class="op" id="3380345">*</span><span class="ident" id="3380346">IPAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380354">n</span><span class="op" id="3380355">,</span>&nbsp;<span class="ident" id="3380357">sa</span><span class="op" id="3380359">,</span>&nbsp;<span class="ident" id="3380361">err</span>&nbsp;<span class="op" id="3380365">:=</span>&nbsp;<span class="ident" id="3380368">c</span><span class="op" id="3380369">.</span><span class="ident" id="3380370">fd</span><span class="op" id="3380372">.</span><span class="ident" id="3380373">readFrom</span><span class="op" id="3380381">(</span><span class="ident" id="3380382">b</span><span class="op" id="3380383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380386">switch</span>&nbsp;<span class="ident" id="3380393">sa</span>&nbsp;<span class="op" id="3380396">:=</span>&nbsp;<span class="ident" id="3380399">sa</span><span class="op" id="3380401">.</span><span class="op" id="3380402">(</span><span class="keyword" id="3380403">type</span><span class="op" id="3380407">)</span>&nbsp;<span class="op" id="3380409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380412">case</span>&nbsp;<span class="op" id="3380417">*</span><span class="ident" id="3380418">syscall</span><span class="op" id="3380425">.</span><span class="ident" id="3380426">SockaddrInet4</span><span class="op" id="3380439">:</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380443">addr</span>&nbsp;<span class="op" id="3380448">=</span>&nbsp;<span class="op" id="3380450">&amp;</span><span class="ident" id="3380451">IPAddr</span><span class="op" id="3380457">{</span><span class="ident" id="3380458">IP</span><span class="op" id="3380460">:</span>&nbsp;<span class="ident" id="3380462">sa</span><span class="op" id="3380464">.</span><span class="ident" id="3380465">Addr</span><span class="op" id="3380469">[</span><span class="num" id="3380470">0</span><span class="op" id="3380471">:</span><span class="op" id="3380472">]</span><span class="op" id="3380473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380477">if</span>&nbsp;<span class="builtinfunc" id="3380480">len</span><span class="op" id="3380483">(</span><span class="ident" id="3380484">b</span><span class="op" id="3380485">)</span>&nbsp;<span class="op" id="3380487">&gt;=</span>&nbsp;<span class="ident" id="3380490">IPv4len</span>&nbsp;<span class="op" id="3380498">{</span>&nbsp;<span class="comment" id="3380500">//&nbsp;discard&nbsp;ipv4&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380526">hsize</span>&nbsp;<span class="op" id="3380532">:=</span>&nbsp;<span class="op" id="3380535">(</span><span class="builtintype" id="3380536">int</span><span class="op" id="3380539">(</span><span class="ident" id="3380540">b</span><span class="op" id="3380541">[</span><span class="num" id="3380542">0</span><span class="op" id="3380543">]</span><span class="op" id="3380544">)</span>&nbsp;<span class="op" id="3380546">&amp;</span>&nbsp;<span class="num" id="3380548">0xf</span><span class="op" id="3380551">)</span>&nbsp;<span class="op" id="3380553">*</span>&nbsp;<span class="num" id="3380555">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3380560">copy</span><span class="op" id="3380564">(</span><span class="ident" id="3380565">b</span><span class="op" id="3380566">,</span>&nbsp;<span class="ident" id="3380568">b</span><span class="op" id="3380569">[</span><span class="ident" id="3380570">hsize</span><span class="op" id="3380575">:</span><span class="op" id="3380576">]</span><span class="op" id="3380577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380582">n</span>&nbsp;<span class="op" id="3380584">-=</span>&nbsp;<span class="ident" id="3380587">hsize</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380598">case</span>&nbsp;<span class="op" id="3380603">*</span><span class="ident" id="3380604">syscall</span><span class="op" id="3380611">.</span><span class="ident" id="3380612">SockaddrInet6</span><span class="op" id="3380625">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380629">addr</span>&nbsp;<span class="op" id="3380634">=</span>&nbsp;<span class="op" id="3380636">&amp;</span><span class="ident" id="3380637">IPAddr</span><span class="op" id="3380643">{</span><span class="ident" id="3380644">IP</span><span class="op" id="3380646">:</span>&nbsp;<span class="ident" id="3380648">sa</span><span class="op" id="3380650">.</span><span class="ident" id="3380651">Addr</span><span class="op" id="3380655">[</span><span class="num" id="3380656">0</span><span class="op" id="3380657">:</span><span class="op" id="3380658">]</span><span class="op" id="3380659">,</span>&nbsp;<span class="ident" id="3380661">Zone</span><span class="op" id="3380665">:</span>&nbsp;<span class="ident" id="3380667">zoneToString</span><span class="op" id="3380679">(</span><span class="builtintype" id="3380680">int</span><span class="op" id="3380683">(</span><span class="ident" id="3380684">sa</span><span class="op" id="3380686">.</span><span class="ident" id="3380687">ZoneId</span><span class="op" id="3380693">)</span><span class="op" id="3380694">)</span><span class="op" id="3380695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380701">return</span>&nbsp;<span class="ident" id="3380708">n</span><span class="op" id="3380709">,</span>&nbsp;<span class="ident" id="3380711">addr</span><span class="op" id="3380715">,</span>&nbsp;<span class="ident" id="3380717">err</span><br>
<span class="lineno">95</span><span class="op" id="3380721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3380724">//&nbsp;ReadFrom&nbsp;implements&nbsp;the&nbsp;PacketConn&nbsp;ReadFrom&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="3380779">func</span>&nbsp;<span class="op" id="3380784">(</span><span class="ident" id="3380785">c</span>&nbsp;<span class="op" id="3380787">*</span><span class="ident" id="3380788">IPConn</span><span class="op" id="3380794">)</span>&nbsp;<span class="ident" id="3380796">ReadFrom</span><span class="op" id="3380804">(</span><span class="ident" id="3380805">b</span>&nbsp;<span class="op" id="3380807">[</span><span class="op" id="3380808">]</span><span class="builtintype" id="3380809">byte</span><span class="op" id="3380813">)</span>&nbsp;<span class="op" id="3380815">(</span><span class="builtintype" id="3380816">int</span><span class="op" id="3380819">,</span>&nbsp;<span class="ident" id="3380821">Addr</span><span class="op" id="3380825">,</span>&nbsp;<span class="builtintype" id="3380827">error</span><span class="op" id="3380832">)</span>&nbsp;<span class="op" id="3380834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380837">if</span>&nbsp;<span class="op" id="3380840">!</span><span class="ident" id="3380841">c</span><span class="op" id="3380842">.</span><span class="ident" id="3380843">ok</span><span class="op" id="3380845">(</span><span class="op" id="3380846">)</span>&nbsp;<span class="op" id="3380848">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380852">return</span>&nbsp;<span class="num" id="3380859">0</span><span class="op" id="3380860">,</span>&nbsp;<span class="ident" id="3380862">nil</span><span class="op" id="3380865">,</span>&nbsp;<span class="ident" id="3380867">syscall</span><span class="op" id="3380874">.</span><span class="ident" id="3380875">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380886">n</span><span class="op" id="3380887">,</span>&nbsp;<span class="ident" id="3380889">addr</span><span class="op" id="3380893">,</span>&nbsp;<span class="ident" id="3380895">err</span>&nbsp;<span class="op" id="3380899">:=</span>&nbsp;<span class="ident" id="3380902">c</span><span class="op" id="3380903">.</span><span class="ident" id="3380904">ReadFromIP</span><span class="op" id="3380914">(</span><span class="ident" id="3380915">b</span><span class="op" id="3380916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380919">return</span>&nbsp;<span class="ident" id="3380926">n</span><span class="op" id="3380927">,</span>&nbsp;<span class="ident" id="3380929">addr</span><span class="op" id="3380933">.</span><span class="ident" id="3380934">toAddr</span><span class="op" id="3380940">(</span><span class="op" id="3380941">)</span><span class="op" id="3380942">,</span>&nbsp;<span class="ident" id="3380944">err</span><br>
<span class="lineno"></span><span class="op" id="3380948">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="comment" id="3380951">//&nbsp;ReadMsgIP&nbsp;reads&nbsp;a&nbsp;packet&nbsp;from&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;into&nbsp;b&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3381022">//&nbsp;associated&nbsp;out-of-band&nbsp;data&nbsp;into&nbsp;oob.&nbsp;&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3381089">//&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;b,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;oob,&nbsp;the&nbsp;flags</span><br>
<span class="lineno"></span><span class="comment" id="3381160">//&nbsp;that&nbsp;were&nbsp;set&nbsp;on&nbsp;the&nbsp;packet&nbsp;and&nbsp;the&nbsp;source&nbsp;address&nbsp;of&nbsp;the&nbsp;packet.</span><br>
<span class="lineno">110</span><span class="keyword" id="3381229">func</span>&nbsp;<span class="op" id="3381234">(</span><span class="ident" id="3381235">c</span>&nbsp;<span class="op" id="3381237">*</span><span class="ident" id="3381238">IPConn</span><span class="op" id="3381244">)</span>&nbsp;<span class="ident" id="3381246">ReadMsgIP</span><span class="op" id="3381255">(</span><span class="ident" id="3381256">b</span><span class="op" id="3381257">,</span>&nbsp;<span class="ident" id="3381259">oob</span>&nbsp;<span class="op" id="3381263">[</span><span class="op" id="3381264">]</span><span class="builtintype" id="3381265">byte</span><span class="op" id="3381269">)</span>&nbsp;<span class="op" id="3381271">(</span><span class="ident" id="3381272">n</span><span class="op" id="3381273">,</span>&nbsp;<span class="ident" id="3381275">oobn</span><span class="op" id="3381279">,</span>&nbsp;<span class="ident" id="3381281">flags</span>&nbsp;<span class="builtintype" id="3381287">int</span><span class="op" id="3381290">,</span>&nbsp;<span class="ident" id="3381292">addr</span>&nbsp;<span class="op" id="3381297">*</span><span class="ident" id="3381298">IPAddr</span><span class="op" id="3381304">,</span>&nbsp;<span class="ident" id="3381306">err</span>&nbsp;<span class="builtintype" id="3381310">error</span><span class="op" id="3381315">)</span>&nbsp;<span class="op" id="3381317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381320">if</span>&nbsp;<span class="op" id="3381323">!</span><span class="ident" id="3381324">c</span><span class="op" id="3381325">.</span><span class="ident" id="3381326">ok</span><span class="op" id="3381328">(</span><span class="op" id="3381329">)</span>&nbsp;<span class="op" id="3381331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381335">return</span>&nbsp;<span class="num" id="3381342">0</span><span class="op" id="3381343">,</span>&nbsp;<span class="num" id="3381345">0</span><span class="op" id="3381346">,</span>&nbsp;<span class="num" id="3381348">0</span><span class="op" id="3381349">,</span>&nbsp;<span class="ident" id="3381351">nil</span><span class="op" id="3381354">,</span>&nbsp;<span class="ident" id="3381356">syscall</span><span class="op" id="3381363">.</span><span class="ident" id="3381364">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3381372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381375">var</span>&nbsp;<span class="ident" id="3381379">sa</span>&nbsp;<span class="ident" id="3381382">syscall</span><span class="op" id="3381389">.</span><span class="ident" id="3381390">Sockaddr</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381400">n</span><span class="op" id="3381401">,</span>&nbsp;<span class="ident" id="3381403">oobn</span><span class="op" id="3381407">,</span>&nbsp;<span class="ident" id="3381409">flags</span><span class="op" id="3381414">,</span>&nbsp;<span class="ident" id="3381416">sa</span><span class="op" id="3381418">,</span>&nbsp;<span class="ident" id="3381420">err</span>&nbsp;<span class="op" id="3381424">=</span>&nbsp;<span class="ident" id="3381426">c</span><span class="op" id="3381427">.</span><span class="ident" id="3381428">fd</span><span class="op" id="3381430">.</span><span class="ident" id="3381431">readMsg</span><span class="op" id="3381438">(</span><span class="ident" id="3381439">b</span><span class="op" id="3381440">,</span>&nbsp;<span class="ident" id="3381442">oob</span><span class="op" id="3381445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381448">switch</span>&nbsp;<span class="ident" id="3381455">sa</span>&nbsp;<span class="op" id="3381458">:=</span>&nbsp;<span class="ident" id="3381461">sa</span><span class="op" id="3381463">.</span><span class="op" id="3381464">(</span><span class="keyword" id="3381465">type</span><span class="op" id="3381469">)</span>&nbsp;<span class="op" id="3381471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381474">case</span>&nbsp;<span class="op" id="3381479">*</span><span class="ident" id="3381480">syscall</span><span class="op" id="3381487">.</span><span class="ident" id="3381488">SockaddrInet4</span><span class="op" id="3381501">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381505">addr</span>&nbsp;<span class="op" id="3381510">=</span>&nbsp;<span class="op" id="3381512">&amp;</span><span class="ident" id="3381513">IPAddr</span><span class="op" id="3381519">{</span><span class="ident" id="3381520">IP</span><span class="op" id="3381522">:</span>&nbsp;<span class="ident" id="3381524">sa</span><span class="op" id="3381526">.</span><span class="ident" id="3381527">Addr</span><span class="op" id="3381531">[</span><span class="num" id="3381532">0</span><span class="op" id="3381533">:</span><span class="op" id="3381534">]</span><span class="op" id="3381535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381538">case</span>&nbsp;<span class="op" id="3381543">*</span><span class="ident" id="3381544">syscall</span><span class="op" id="3381551">.</span><span class="ident" id="3381552">SockaddrInet6</span><span class="op" id="3381565">:</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381569">addr</span>&nbsp;<span class="op" id="3381574">=</span>&nbsp;<span class="op" id="3381576">&amp;</span><span class="ident" id="3381577">IPAddr</span><span class="op" id="3381583">{</span><span class="ident" id="3381584">IP</span><span class="op" id="3381586">:</span>&nbsp;<span class="ident" id="3381588">sa</span><span class="op" id="3381590">.</span><span class="ident" id="3381591">Addr</span><span class="op" id="3381595">[</span><span class="num" id="3381596">0</span><span class="op" id="3381597">:</span><span class="op" id="3381598">]</span><span class="op" id="3381599">,</span>&nbsp;<span class="ident" id="3381601">Zone</span><span class="op" id="3381605">:</span>&nbsp;<span class="ident" id="3381607">zoneToString</span><span class="op" id="3381619">(</span><span class="builtintype" id="3381620">int</span><span class="op" id="3381623">(</span><span class="ident" id="3381624">sa</span><span class="op" id="3381626">.</span><span class="ident" id="3381627">ZoneId</span><span class="op" id="3381633">)</span><span class="op" id="3381634">)</span><span class="op" id="3381635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3381638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381641">return</span><br>
<span class="lineno"></span><span class="op" id="3381648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="3381651">//&nbsp;WriteToIP&nbsp;writes&nbsp;an&nbsp;IP&nbsp;packet&nbsp;to&nbsp;addr&nbsp;via&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="3381719">//&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="3381730">//</span><br>
<span class="lineno"></span><span class="comment" id="3381733">//&nbsp;WriteToIP&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;an&nbsp;error&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3381795">//&nbsp;Timeout()&nbsp;==&nbsp;true&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and</span><br>
<span class="lineno">130</span><span class="comment" id="3381862">//&nbsp;SetWriteDeadline.&nbsp;&nbsp;On&nbsp;packet-oriented&nbsp;connections,&nbsp;write&nbsp;timeouts</span><br>
<span class="lineno"></span><span class="comment" id="3381931">//&nbsp;are&nbsp;rare.</span><br>
<span class="lineno"></span><span class="keyword" id="3381944">func</span>&nbsp;<span class="op" id="3381949">(</span><span class="ident" id="3381950">c</span>&nbsp;<span class="op" id="3381952">*</span><span class="ident" id="3381953">IPConn</span><span class="op" id="3381959">)</span>&nbsp;<span class="ident" id="3381961">WriteToIP</span><span class="op" id="3381970">(</span><span class="ident" id="3381971">b</span>&nbsp;<span class="op" id="3381973">[</span><span class="op" id="3381974">]</span><span class="builtintype" id="3381975">byte</span><span class="op" id="3381979">,</span>&nbsp;<span class="ident" id="3381981">addr</span>&nbsp;<span class="op" id="3381986">*</span><span class="ident" id="3381987">IPAddr</span><span class="op" id="3381993">)</span>&nbsp;<span class="op" id="3381995">(</span><span class="builtintype" id="3381996">int</span><span class="op" id="3381999">,</span>&nbsp;<span class="builtintype" id="3382001">error</span><span class="op" id="3382006">)</span>&nbsp;<span class="op" id="3382008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382011">if</span>&nbsp;<span class="op" id="3382014">!</span><span class="ident" id="3382015">c</span><span class="op" id="3382016">.</span><span class="ident" id="3382017">ok</span><span class="op" id="3382019">(</span><span class="op" id="3382020">)</span>&nbsp;<span class="op" id="3382022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382026">return</span>&nbsp;<span class="num" id="3382033">0</span><span class="op" id="3382034">,</span>&nbsp;<span class="ident" id="3382036">syscall</span><span class="op" id="3382043">.</span><span class="ident" id="3382044">EINVAL</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382055">if</span>&nbsp;<span class="ident" id="3382058">c</span><span class="op" id="3382059">.</span><span class="ident" id="3382060">fd</span><span class="op" id="3382062">.</span><span class="ident" id="3382063">isConnected</span>&nbsp;<span class="op" id="3382075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382079">return</span>&nbsp;<span class="num" id="3382086">0</span><span class="op" id="3382087">,</span>&nbsp;<span class="op" id="3382089">&amp;</span><span class="ident" id="3382090">OpError</span><span class="op" id="3382097">{</span><span class="ident" id="3382098">Op</span><span class="op" id="3382100">:</span>&nbsp;<span class="string" id="3382102">&#34;write&#34;</span><span class="op" id="3382109">,</span>&nbsp;<span class="ident" id="3382111">Net</span><span class="op" id="3382114">:</span>&nbsp;<span class="ident" id="3382116">c</span><span class="op" id="3382117">.</span><span class="ident" id="3382118">fd</span><span class="op" id="3382120">.</span><span class="ident" id="3382121">net</span><span class="op" id="3382124">,</span>&nbsp;<span class="ident" id="3382126">Addr</span><span class="op" id="3382130">:</span>&nbsp;<span class="ident" id="3382132">addr</span><span class="op" id="3382136">,</span>&nbsp;<span class="ident" id="3382138">Err</span><span class="op" id="3382141">:</span>&nbsp;<span class="ident" id="3382143">ErrWriteToConnected</span><span class="op" id="3382162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382168">if</span>&nbsp;<span class="ident" id="3382171">addr</span>&nbsp;<span class="op" id="3382176">==</span>&nbsp;<span class="ident" id="3382179">nil</span>&nbsp;<span class="op" id="3382183">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382187">return</span>&nbsp;<span class="num" id="3382194">0</span><span class="op" id="3382195">,</span>&nbsp;<span class="op" id="3382197">&amp;</span><span class="ident" id="3382198">OpError</span><span class="op" id="3382205">{</span><span class="ident" id="3382206">Op</span><span class="op" id="3382208">:</span>&nbsp;<span class="string" id="3382210">&#34;write&#34;</span><span class="op" id="3382217">,</span>&nbsp;<span class="ident" id="3382219">Net</span><span class="op" id="3382222">:</span>&nbsp;<span class="ident" id="3382224">c</span><span class="op" id="3382225">.</span><span class="ident" id="3382226">fd</span><span class="op" id="3382228">.</span><span class="ident" id="3382229">net</span><span class="op" id="3382232">,</span>&nbsp;<span class="ident" id="3382234">Addr</span><span class="op" id="3382238">:</span>&nbsp;<span class="ident" id="3382240">nil</span><span class="op" id="3382243">,</span>&nbsp;<span class="ident" id="3382245">Err</span><span class="op" id="3382248">:</span>&nbsp;<span class="ident" id="3382250">errMissingAddress</span><span class="op" id="3382267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382273">sa</span><span class="op" id="3382275">,</span>&nbsp;<span class="ident" id="3382277">err</span>&nbsp;<span class="op" id="3382281">:=</span>&nbsp;<span class="ident" id="3382284">addr</span><span class="op" id="3382288">.</span><span class="ident" id="3382289">sockaddr</span><span class="op" id="3382297">(</span><span class="ident" id="3382298">c</span><span class="op" id="3382299">.</span><span class="ident" id="3382300">fd</span><span class="op" id="3382302">.</span><span class="ident" id="3382303">family</span><span class="op" id="3382309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382312">if</span>&nbsp;<span class="ident" id="3382315">err</span>&nbsp;<span class="op" id="3382319">!=</span>&nbsp;<span class="ident" id="3382322">nil</span>&nbsp;<span class="op" id="3382326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382330">return</span>&nbsp;<span class="num" id="3382337">0</span><span class="op" id="3382338">,</span>&nbsp;<span class="op" id="3382340">&amp;</span><span class="ident" id="3382341">OpError</span><span class="op" id="3382348">{</span><span class="string" id="3382349">&#34;write&#34;</span><span class="op" id="3382356">,</span>&nbsp;<span class="ident" id="3382358">c</span><span class="op" id="3382359">.</span><span class="ident" id="3382360">fd</span><span class="op" id="3382362">.</span><span class="ident" id="3382363">net</span><span class="op" id="3382366">,</span>&nbsp;<span class="ident" id="3382368">addr</span><span class="op" id="3382372">,</span>&nbsp;<span class="ident" id="3382374">err</span><span class="op" id="3382377">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382383">return</span>&nbsp;<span class="ident" id="3382390">c</span><span class="op" id="3382391">.</span><span class="ident" id="3382392">fd</span><span class="op" id="3382394">.</span><span class="ident" id="3382395">writeTo</span><span class="op" id="3382402">(</span><span class="ident" id="3382403">b</span><span class="op" id="3382404">,</span>&nbsp;<span class="ident" id="3382406">sa</span><span class="op" id="3382408">)</span><br>
<span class="lineno"></span><span class="op" id="3382410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3382413">//&nbsp;WriteTo&nbsp;implements&nbsp;the&nbsp;PacketConn&nbsp;WriteTo&nbsp;method.</span><br>
<span class="lineno">150</span><span class="keyword" id="3382466">func</span>&nbsp;<span class="op" id="3382471">(</span><span class="ident" id="3382472">c</span>&nbsp;<span class="op" id="3382474">*</span><span class="ident" id="3382475">IPConn</span><span class="op" id="3382481">)</span>&nbsp;<span class="ident" id="3382483">WriteTo</span><span class="op" id="3382490">(</span><span class="ident" id="3382491">b</span>&nbsp;<span class="op" id="3382493">[</span><span class="op" id="3382494">]</span><span class="builtintype" id="3382495">byte</span><span class="op" id="3382499">,</span>&nbsp;<span class="ident" id="3382501">addr</span>&nbsp;<span class="ident" id="3382506">Addr</span><span class="op" id="3382510">)</span>&nbsp;<span class="op" id="3382512">(</span><span class="builtintype" id="3382513">int</span><span class="op" id="3382516">,</span>&nbsp;<span class="builtintype" id="3382518">error</span><span class="op" id="3382523">)</span>&nbsp;<span class="op" id="3382525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382528">if</span>&nbsp;<span class="op" id="3382531">!</span><span class="ident" id="3382532">c</span><span class="op" id="3382533">.</span><span class="ident" id="3382534">ok</span><span class="op" id="3382536">(</span><span class="op" id="3382537">)</span>&nbsp;<span class="op" id="3382539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382543">return</span>&nbsp;<span class="num" id="3382550">0</span><span class="op" id="3382551">,</span>&nbsp;<span class="ident" id="3382553">syscall</span><span class="op" id="3382560">.</span><span class="ident" id="3382561">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382572">a</span><span class="op" id="3382573">,</span>&nbsp;<span class="ident" id="3382575">ok</span>&nbsp;<span class="op" id="3382578">:=</span>&nbsp;<span class="ident" id="3382581">addr</span><span class="op" id="3382585">.</span><span class="op" id="3382586">(</span><span class="op" id="3382587">*</span><span class="ident" id="3382588">IPAddr</span><span class="op" id="3382594">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382597">if</span>&nbsp;<span class="op" id="3382600">!</span><span class="ident" id="3382601">ok</span>&nbsp;<span class="op" id="3382604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382608">return</span>&nbsp;<span class="num" id="3382615">0</span><span class="op" id="3382616">,</span>&nbsp;<span class="op" id="3382618">&amp;</span><span class="ident" id="3382619">OpError</span><span class="op" id="3382626">{</span><span class="string" id="3382627">&#34;write&#34;</span><span class="op" id="3382634">,</span>&nbsp;<span class="ident" id="3382636">c</span><span class="op" id="3382637">.</span><span class="ident" id="3382638">fd</span><span class="op" id="3382640">.</span><span class="ident" id="3382641">net</span><span class="op" id="3382644">,</span>&nbsp;<span class="ident" id="3382646">addr</span><span class="op" id="3382650">,</span>&nbsp;<span class="ident" id="3382652">syscall</span><span class="op" id="3382659">.</span><span class="ident" id="3382660">EINVAL</span><span class="op" id="3382666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382672">return</span>&nbsp;<span class="ident" id="3382679">c</span><span class="op" id="3382680">.</span><span class="ident" id="3382681">WriteToIP</span><span class="op" id="3382690">(</span><span class="ident" id="3382691">b</span><span class="op" id="3382692">,</span>&nbsp;<span class="ident" id="3382694">a</span><span class="op" id="3382695">)</span><br>
<span class="lineno"></span><span class="op" id="3382697">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="3382700">//&nbsp;WriteMsgIP&nbsp;writes&nbsp;a&nbsp;packet&nbsp;to&nbsp;addr&nbsp;via&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="3382770">//&nbsp;b&nbsp;and&nbsp;the&nbsp;associated&nbsp;out-of-band&nbsp;data&nbsp;from&nbsp;oob.&nbsp;&nbsp;It&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3382837">//&nbsp;number&nbsp;of&nbsp;payload&nbsp;and&nbsp;out-of-band&nbsp;bytes&nbsp;written.</span><br>
<span class="lineno"></span><span class="keyword" id="3382889">func</span>&nbsp;<span class="op" id="3382894">(</span><span class="ident" id="3382895">c</span>&nbsp;<span class="op" id="3382897">*</span><span class="ident" id="3382898">IPConn</span><span class="op" id="3382904">)</span>&nbsp;<span class="ident" id="3382906">WriteMsgIP</span><span class="op" id="3382916">(</span><span class="ident" id="3382917">b</span><span class="op" id="3382918">,</span>&nbsp;<span class="ident" id="3382920">oob</span>&nbsp;<span class="op" id="3382924">[</span><span class="op" id="3382925">]</span><span class="builtintype" id="3382926">byte</span><span class="op" id="3382930">,</span>&nbsp;<span class="ident" id="3382932">addr</span>&nbsp;<span class="op" id="3382937">*</span><span class="ident" id="3382938">IPAddr</span><span class="op" id="3382944">)</span>&nbsp;<span class="op" id="3382946">(</span><span class="ident" id="3382947">n</span><span class="op" id="3382948">,</span>&nbsp;<span class="ident" id="3382950">oobn</span>&nbsp;<span class="builtintype" id="3382955">int</span><span class="op" id="3382958">,</span>&nbsp;<span class="ident" id="3382960">err</span>&nbsp;<span class="builtintype" id="3382964">error</span><span class="op" id="3382969">)</span>&nbsp;<span class="op" id="3382971">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382974">if</span>&nbsp;<span class="op" id="3382977">!</span><span class="ident" id="3382978">c</span><span class="op" id="3382979">.</span><span class="ident" id="3382980">ok</span><span class="op" id="3382982">(</span><span class="op" id="3382983">)</span>&nbsp;<span class="op" id="3382985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382989">return</span>&nbsp;<span class="num" id="3382996">0</span><span class="op" id="3382997">,</span>&nbsp;<span class="num" id="3382999">0</span><span class="op" id="3383000">,</span>&nbsp;<span class="ident" id="3383002">syscall</span><span class="op" id="3383009">.</span><span class="ident" id="3383010">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383021">if</span>&nbsp;<span class="ident" id="3383024">c</span><span class="op" id="3383025">.</span><span class="ident" id="3383026">fd</span><span class="op" id="3383028">.</span><span class="ident" id="3383029">isConnected</span>&nbsp;<span class="op" id="3383041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383045">return</span>&nbsp;<span class="num" id="3383052">0</span><span class="op" id="3383053">,</span>&nbsp;<span class="num" id="3383055">0</span><span class="op" id="3383056">,</span>&nbsp;<span class="op" id="3383058">&amp;</span><span class="ident" id="3383059">OpError</span><span class="op" id="3383066">{</span><span class="ident" id="3383067">Op</span><span class="op" id="3383069">:</span>&nbsp;<span class="string" id="3383071">&#34;write&#34;</span><span class="op" id="3383078">,</span>&nbsp;<span class="ident" id="3383080">Net</span><span class="op" id="3383083">:</span>&nbsp;<span class="ident" id="3383085">c</span><span class="op" id="3383086">.</span><span class="ident" id="3383087">fd</span><span class="op" id="3383089">.</span><span class="ident" id="3383090">net</span><span class="op" id="3383093">,</span>&nbsp;<span class="ident" id="3383095">Addr</span><span class="op" id="3383099">:</span>&nbsp;<span class="ident" id="3383101">addr</span><span class="op" id="3383105">,</span>&nbsp;<span class="ident" id="3383107">Err</span><span class="op" id="3383110">:</span>&nbsp;<span class="ident" id="3383112">ErrWriteToConnected</span><span class="op" id="3383131">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383137">if</span>&nbsp;<span class="ident" id="3383140">addr</span>&nbsp;<span class="op" id="3383145">==</span>&nbsp;<span class="ident" id="3383148">nil</span>&nbsp;<span class="op" id="3383152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383156">return</span>&nbsp;<span class="num" id="3383163">0</span><span class="op" id="3383164">,</span>&nbsp;<span class="num" id="3383166">0</span><span class="op" id="3383167">,</span>&nbsp;<span class="op" id="3383169">&amp;</span><span class="ident" id="3383170">OpError</span><span class="op" id="3383177">{</span><span class="ident" id="3383178">Op</span><span class="op" id="3383180">:</span>&nbsp;<span class="string" id="3383182">&#34;write&#34;</span><span class="op" id="3383189">,</span>&nbsp;<span class="ident" id="3383191">Net</span><span class="op" id="3383194">:</span>&nbsp;<span class="ident" id="3383196">c</span><span class="op" id="3383197">.</span><span class="ident" id="3383198">fd</span><span class="op" id="3383200">.</span><span class="ident" id="3383201">net</span><span class="op" id="3383204">,</span>&nbsp;<span class="ident" id="3383206">Addr</span><span class="op" id="3383210">:</span>&nbsp;<span class="ident" id="3383212">nil</span><span class="op" id="3383215">,</span>&nbsp;<span class="ident" id="3383217">Err</span><span class="op" id="3383220">:</span>&nbsp;<span class="ident" id="3383222">errMissingAddress</span><span class="op" id="3383239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383245">sa</span><span class="op" id="3383247">,</span>&nbsp;<span class="ident" id="3383249">err</span>&nbsp;<span class="op" id="3383253">:=</span>&nbsp;<span class="ident" id="3383256">addr</span><span class="op" id="3383260">.</span><span class="ident" id="3383261">sockaddr</span><span class="op" id="3383269">(</span><span class="ident" id="3383270">c</span><span class="op" id="3383271">.</span><span class="ident" id="3383272">fd</span><span class="op" id="3383274">.</span><span class="ident" id="3383275">family</span><span class="op" id="3383281">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383284">if</span>&nbsp;<span class="ident" id="3383287">err</span>&nbsp;<span class="op" id="3383291">!=</span>&nbsp;<span class="ident" id="3383294">nil</span>&nbsp;<span class="op" id="3383298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383302">return</span>&nbsp;<span class="num" id="3383309">0</span><span class="op" id="3383310">,</span>&nbsp;<span class="num" id="3383312">0</span><span class="op" id="3383313">,</span>&nbsp;<span class="op" id="3383315">&amp;</span><span class="ident" id="3383316">OpError</span><span class="op" id="3383323">{</span><span class="string" id="3383324">&#34;write&#34;</span><span class="op" id="3383331">,</span>&nbsp;<span class="ident" id="3383333">c</span><span class="op" id="3383334">.</span><span class="ident" id="3383335">fd</span><span class="op" id="3383337">.</span><span class="ident" id="3383338">net</span><span class="op" id="3383341">,</span>&nbsp;<span class="ident" id="3383343">addr</span><span class="op" id="3383347">,</span>&nbsp;<span class="ident" id="3383349">err</span><span class="op" id="3383352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383358">return</span>&nbsp;<span class="ident" id="3383365">c</span><span class="op" id="3383366">.</span><span class="ident" id="3383367">fd</span><span class="op" id="3383369">.</span><span class="ident" id="3383370">writeMsg</span><span class="op" id="3383378">(</span><span class="ident" id="3383379">b</span><span class="op" id="3383380">,</span>&nbsp;<span class="ident" id="3383382">oob</span><span class="op" id="3383385">,</span>&nbsp;<span class="ident" id="3383387">sa</span><span class="op" id="3383389">)</span><br>
<span class="lineno"></span><span class="op" id="3383391">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="3383394">//&nbsp;DialIP&nbsp;connects&nbsp;to&nbsp;the&nbsp;remote&nbsp;address&nbsp;raddr&nbsp;on&nbsp;the&nbsp;network&nbsp;protocol</span><br>
<span class="lineno"></span><span class="comment" id="3383465">//&nbsp;netProto,&nbsp;which&nbsp;must&nbsp;be&nbsp;&#34;ip&#34;,&nbsp;&#34;ip4&#34;,&nbsp;or&nbsp;&#34;ip6&#34;&nbsp;followed&nbsp;by&nbsp;a&nbsp;colon</span><br>
<span class="lineno"></span><span class="comment" id="3383534">//&nbsp;and&nbsp;a&nbsp;protocol&nbsp;number&nbsp;or&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="3383568">func</span>&nbsp;<span class="ident" id="3383573">DialIP</span><span class="op" id="3383579">(</span><span class="ident" id="3383580">netProto</span>&nbsp;<span class="builtintype" id="3383589">string</span><span class="op" id="3383595">,</span>&nbsp;<span class="ident" id="3383597">laddr</span><span class="op" id="3383602">,</span>&nbsp;<span class="ident" id="3383604">raddr</span>&nbsp;<span class="op" id="3383610">*</span><span class="ident" id="3383611">IPAddr</span><span class="op" id="3383617">)</span>&nbsp;<span class="op" id="3383619">(</span><span class="op" id="3383620">*</span><span class="ident" id="3383621">IPConn</span><span class="op" id="3383627">,</span>&nbsp;<span class="builtintype" id="3383629">error</span><span class="op" id="3383634">)</span>&nbsp;<span class="op" id="3383636">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383639">return</span>&nbsp;<span class="ident" id="3383646">dialIP</span><span class="op" id="3383652">(</span><span class="ident" id="3383653">netProto</span><span class="op" id="3383661">,</span>&nbsp;<span class="ident" id="3383663">laddr</span><span class="op" id="3383668">,</span>&nbsp;<span class="ident" id="3383670">raddr</span><span class="op" id="3383675">,</span>&nbsp;<span class="ident" id="3383677">noDeadline</span><span class="op" id="3383687">)</span><br>
<span class="lineno"></span><span class="op" id="3383689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3383692">func</span>&nbsp;<span class="ident" id="3383697">dialIP</span><span class="op" id="3383703">(</span><span class="ident" id="3383704">netProto</span>&nbsp;<span class="builtintype" id="3383713">string</span><span class="op" id="3383719">,</span>&nbsp;<span class="ident" id="3383721">laddr</span><span class="op" id="3383726">,</span>&nbsp;<span class="ident" id="3383728">raddr</span>&nbsp;<span class="op" id="3383734">*</span><span class="ident" id="3383735">IPAddr</span><span class="op" id="3383741">,</span>&nbsp;<span class="ident" id="3383743">deadline</span>&nbsp;<span class="ident" id="3383752">time</span><span class="op" id="3383756">.</span><span class="ident" id="3383757">Time</span><span class="op" id="3383761">)</span>&nbsp;<span class="op" id="3383763">(</span><span class="op" id="3383764">*</span><span class="ident" id="3383765">IPConn</span><span class="op" id="3383771">,</span>&nbsp;<span class="builtintype" id="3383773">error</span><span class="op" id="3383778">)</span>&nbsp;<span class="op" id="3383780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383783">net</span><span class="op" id="3383786">,</span>&nbsp;<span class="ident" id="3383788">proto</span><span class="op" id="3383793">,</span>&nbsp;<span class="ident" id="3383795">err</span>&nbsp;<span class="op" id="3383799">:=</span>&nbsp;<span class="ident" id="3383802">parseNetwork</span><span class="op" id="3383814">(</span><span class="ident" id="3383815">netProto</span><span class="op" id="3383823">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383826">if</span>&nbsp;<span class="ident" id="3383829">err</span>&nbsp;<span class="op" id="3383833">!=</span>&nbsp;<span class="ident" id="3383836">nil</span>&nbsp;<span class="op" id="3383840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383844">return</span>&nbsp;<span class="ident" id="3383851">nil</span><span class="op" id="3383854">,</span>&nbsp;<span class="op" id="3383856">&amp;</span><span class="ident" id="3383857">OpError</span><span class="op" id="3383864">{</span><span class="ident" id="3383865">Op</span><span class="op" id="3383867">:</span>&nbsp;<span class="string" id="3383869">&#34;dial&#34;</span><span class="op" id="3383875">,</span>&nbsp;<span class="ident" id="3383877">Net</span><span class="op" id="3383880">:</span>&nbsp;<span class="ident" id="3383882">netProto</span><span class="op" id="3383890">,</span>&nbsp;<span class="ident" id="3383892">Addr</span><span class="op" id="3383896">:</span>&nbsp;<span class="ident" id="3383898">raddr</span><span class="op" id="3383903">,</span>&nbsp;<span class="ident" id="3383905">Err</span><span class="op" id="3383908">:</span>&nbsp;<span class="ident" id="3383910">err</span><span class="op" id="3383913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383919">switch</span>&nbsp;<span class="ident" id="3383926">net</span>&nbsp;<span class="op" id="3383930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383933">case</span>&nbsp;<span class="string" id="3383938">&#34;ip&#34;</span><span class="op" id="3383942">,</span>&nbsp;<span class="string" id="3383944">&#34;ip4&#34;</span><span class="op" id="3383949">,</span>&nbsp;<span class="string" id="3383951">&#34;ip6&#34;</span><span class="op" id="3383956">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383959">default</span><span class="op" id="3383966">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383970">return</span>&nbsp;<span class="ident" id="3383977">nil</span><span class="op" id="3383980">,</span>&nbsp;<span class="op" id="3383982">&amp;</span><span class="ident" id="3383983">OpError</span><span class="op" id="3383990">{</span><span class="ident" id="3383991">Op</span><span class="op" id="3383993">:</span>&nbsp;<span class="string" id="3383995">&#34;dial&#34;</span><span class="op" id="3384001">,</span>&nbsp;<span class="ident" id="3384003">Net</span><span class="op" id="3384006">:</span>&nbsp;<span class="ident" id="3384008">netProto</span><span class="op" id="3384016">,</span>&nbsp;<span class="ident" id="3384018">Addr</span><span class="op" id="3384022">:</span>&nbsp;<span class="ident" id="3384024">raddr</span><span class="op" id="3384029">,</span>&nbsp;<span class="ident" id="3384031">Err</span><span class="op" id="3384034">:</span>&nbsp;<span class="ident" id="3384036">UnknownNetworkError</span><span class="op" id="3384055">(</span><span class="ident" id="3384056">netProto</span><span class="op" id="3384064">)</span><span class="op" id="3384065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384071">if</span>&nbsp;<span class="ident" id="3384074">raddr</span>&nbsp;<span class="op" id="3384080">==</span>&nbsp;<span class="ident" id="3384083">nil</span>&nbsp;<span class="op" id="3384087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384091">return</span>&nbsp;<span class="ident" id="3384098">nil</span><span class="op" id="3384101">,</span>&nbsp;<span class="op" id="3384103">&amp;</span><span class="ident" id="3384104">OpError</span><span class="op" id="3384111">{</span><span class="ident" id="3384112">Op</span><span class="op" id="3384114">:</span>&nbsp;<span class="string" id="3384116">&#34;dial&#34;</span><span class="op" id="3384122">,</span>&nbsp;<span class="ident" id="3384124">Net</span><span class="op" id="3384127">:</span>&nbsp;<span class="ident" id="3384129">netProto</span><span class="op" id="3384137">,</span>&nbsp;<span class="ident" id="3384139">Addr</span><span class="op" id="3384143">:</span>&nbsp;<span class="ident" id="3384145">nil</span><span class="op" id="3384148">,</span>&nbsp;<span class="ident" id="3384150">Err</span><span class="op" id="3384153">:</span>&nbsp;<span class="ident" id="3384155">errMissingAddress</span><span class="op" id="3384172">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384178">fd</span><span class="op" id="3384180">,</span>&nbsp;<span class="ident" id="3384182">err</span>&nbsp;<span class="op" id="3384186">:=</span>&nbsp;<span class="ident" id="3384189">internetSocket</span><span class="op" id="3384203">(</span><span class="ident" id="3384204">net</span><span class="op" id="3384207">,</span>&nbsp;<span class="ident" id="3384209">laddr</span><span class="op" id="3384214">,</span>&nbsp;<span class="ident" id="3384216">raddr</span><span class="op" id="3384221">,</span>&nbsp;<span class="ident" id="3384223">deadline</span><span class="op" id="3384231">,</span>&nbsp;<span class="ident" id="3384233">syscall</span><span class="op" id="3384240">.</span><span class="ident" id="3384241">SOCK_RAW</span><span class="op" id="3384249">,</span>&nbsp;<span class="ident" id="3384251">proto</span><span class="op" id="3384256">,</span>&nbsp;<span class="string" id="3384258">&#34;dial&#34;</span><span class="op" id="3384264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384267">if</span>&nbsp;<span class="ident" id="3384270">err</span>&nbsp;<span class="op" id="3384274">!=</span>&nbsp;<span class="ident" id="3384277">nil</span>&nbsp;<span class="op" id="3384281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384285">return</span>&nbsp;<span class="ident" id="3384292">nil</span><span class="op" id="3384295">,</span>&nbsp;<span class="op" id="3384297">&amp;</span><span class="ident" id="3384298">OpError</span><span class="op" id="3384305">{</span><span class="ident" id="3384306">Op</span><span class="op" id="3384308">:</span>&nbsp;<span class="string" id="3384310">&#34;dial&#34;</span><span class="op" id="3384316">,</span>&nbsp;<span class="ident" id="3384318">Net</span><span class="op" id="3384321">:</span>&nbsp;<span class="ident" id="3384323">netProto</span><span class="op" id="3384331">,</span>&nbsp;<span class="ident" id="3384333">Addr</span><span class="op" id="3384337">:</span>&nbsp;<span class="ident" id="3384339">raddr</span><span class="op" id="3384344">,</span>&nbsp;<span class="ident" id="3384346">Err</span><span class="op" id="3384349">:</span>&nbsp;<span class="ident" id="3384351">err</span><span class="op" id="3384354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384357">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384360">return</span>&nbsp;<span class="ident" id="3384367">newIPConn</span><span class="op" id="3384376">(</span><span class="ident" id="3384377">fd</span><span class="op" id="3384379">)</span><span class="op" id="3384380">,</span>&nbsp;<span class="ident" id="3384382">nil</span><br>
<span class="lineno"></span><span class="op" id="3384386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3384389">//&nbsp;ListenIP&nbsp;listens&nbsp;for&nbsp;incoming&nbsp;IP&nbsp;packets&nbsp;addressed&nbsp;to&nbsp;the&nbsp;local</span><br>
<span class="lineno"></span><span class="comment" id="3384456">//&nbsp;address&nbsp;laddr.&nbsp;&nbsp;The&nbsp;returned&nbsp;connection&#39;s&nbsp;ReadFrom&nbsp;and&nbsp;WriteTo</span><br>
<span class="lineno">210</span><span class="comment" id="3384522">//&nbsp;methods&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;receive&nbsp;and&nbsp;send&nbsp;IP&nbsp;packets&nbsp;with&nbsp;per-packet</span><br>
<span class="lineno"></span><span class="comment" id="3384592">//&nbsp;addressing.</span><br>
<span class="lineno"></span><span class="keyword" id="3384607">func</span>&nbsp;<span class="ident" id="3384612">ListenIP</span><span class="op" id="3384620">(</span><span class="ident" id="3384621">netProto</span>&nbsp;<span class="builtintype" id="3384630">string</span><span class="op" id="3384636">,</span>&nbsp;<span class="ident" id="3384638">laddr</span>&nbsp;<span class="op" id="3384644">*</span><span class="ident" id="3384645">IPAddr</span><span class="op" id="3384651">)</span>&nbsp;<span class="op" id="3384653">(</span><span class="op" id="3384654">*</span><span class="ident" id="3384655">IPConn</span><span class="op" id="3384661">,</span>&nbsp;<span class="builtintype" id="3384663">error</span><span class="op" id="3384668">)</span>&nbsp;<span class="op" id="3384670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384673">net</span><span class="op" id="3384676">,</span>&nbsp;<span class="ident" id="3384678">proto</span><span class="op" id="3384683">,</span>&nbsp;<span class="ident" id="3384685">err</span>&nbsp;<span class="op" id="3384689">:=</span>&nbsp;<span class="ident" id="3384692">parseNetwork</span><span class="op" id="3384704">(</span><span class="ident" id="3384705">netProto</span><span class="op" id="3384713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384716">if</span>&nbsp;<span class="ident" id="3384719">err</span>&nbsp;<span class="op" id="3384723">!=</span>&nbsp;<span class="ident" id="3384726">nil</span>&nbsp;<span class="op" id="3384730">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384734">return</span>&nbsp;<span class="ident" id="3384741">nil</span><span class="op" id="3384744">,</span>&nbsp;<span class="op" id="3384746">&amp;</span><span class="ident" id="3384747">OpError</span><span class="op" id="3384754">{</span><span class="ident" id="3384755">Op</span><span class="op" id="3384757">:</span>&nbsp;<span class="string" id="3384759">&#34;dial&#34;</span><span class="op" id="3384765">,</span>&nbsp;<span class="ident" id="3384767">Net</span><span class="op" id="3384770">:</span>&nbsp;<span class="ident" id="3384772">netProto</span><span class="op" id="3384780">,</span>&nbsp;<span class="ident" id="3384782">Addr</span><span class="op" id="3384786">:</span>&nbsp;<span class="ident" id="3384788">laddr</span><span class="op" id="3384793">,</span>&nbsp;<span class="ident" id="3384795">Err</span><span class="op" id="3384798">:</span>&nbsp;<span class="ident" id="3384800">err</span><span class="op" id="3384803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384809">switch</span>&nbsp;<span class="ident" id="3384816">net</span>&nbsp;<span class="op" id="3384820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384823">case</span>&nbsp;<span class="string" id="3384828">&#34;ip&#34;</span><span class="op" id="3384832">,</span>&nbsp;<span class="string" id="3384834">&#34;ip4&#34;</span><span class="op" id="3384839">,</span>&nbsp;<span class="string" id="3384841">&#34;ip6&#34;</span><span class="op" id="3384846">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384849">default</span><span class="op" id="3384856">:</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384860">return</span>&nbsp;<span class="ident" id="3384867">nil</span><span class="op" id="3384870">,</span>&nbsp;<span class="op" id="3384872">&amp;</span><span class="ident" id="3384873">OpError</span><span class="op" id="3384880">{</span><span class="ident" id="3384881">Op</span><span class="op" id="3384883">:</span>&nbsp;<span class="string" id="3384885">&#34;listen&#34;</span><span class="op" id="3384893">,</span>&nbsp;<span class="ident" id="3384895">Net</span><span class="op" id="3384898">:</span>&nbsp;<span class="ident" id="3384900">netProto</span><span class="op" id="3384908">,</span>&nbsp;<span class="ident" id="3384910">Addr</span><span class="op" id="3384914">:</span>&nbsp;<span class="ident" id="3384916">laddr</span><span class="op" id="3384921">,</span>&nbsp;<span class="ident" id="3384923">Err</span><span class="op" id="3384926">:</span>&nbsp;<span class="ident" id="3384928">UnknownNetworkError</span><span class="op" id="3384947">(</span><span class="ident" id="3384948">netProto</span><span class="op" id="3384956">)</span><span class="op" id="3384957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384963">fd</span><span class="op" id="3384965">,</span>&nbsp;<span class="ident" id="3384967">err</span>&nbsp;<span class="op" id="3384971">:=</span>&nbsp;<span class="ident" id="3384974">internetSocket</span><span class="op" id="3384988">(</span><span class="ident" id="3384989">net</span><span class="op" id="3384992">,</span>&nbsp;<span class="ident" id="3384994">laddr</span><span class="op" id="3384999">,</span>&nbsp;<span class="ident" id="3385001">nil</span><span class="op" id="3385004">,</span>&nbsp;<span class="ident" id="3385006">noDeadline</span><span class="op" id="3385016">,</span>&nbsp;<span class="ident" id="3385018">syscall</span><span class="op" id="3385025">.</span><span class="ident" id="3385026">SOCK_RAW</span><span class="op" id="3385034">,</span>&nbsp;<span class="ident" id="3385036">proto</span><span class="op" id="3385041">,</span>&nbsp;<span class="string" id="3385043">&#34;listen&#34;</span><span class="op" id="3385051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385054">if</span>&nbsp;<span class="ident" id="3385057">err</span>&nbsp;<span class="op" id="3385061">!=</span>&nbsp;<span class="ident" id="3385064">nil</span>&nbsp;<span class="op" id="3385068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385072">return</span>&nbsp;<span class="ident" id="3385079">nil</span><span class="op" id="3385082">,</span>&nbsp;<span class="op" id="3385084">&amp;</span><span class="ident" id="3385085">OpError</span><span class="op" id="3385092">{</span><span class="ident" id="3385093">Op</span><span class="op" id="3385095">:</span>&nbsp;<span class="string" id="3385097">&#34;listen&#34;</span><span class="op" id="3385105">,</span>&nbsp;<span class="ident" id="3385107">Net</span><span class="op" id="3385110">:</span>&nbsp;<span class="ident" id="3385112">netProto</span><span class="op" id="3385120">,</span>&nbsp;<span class="ident" id="3385122">Addr</span><span class="op" id="3385126">:</span>&nbsp;<span class="ident" id="3385128">laddr</span><span class="op" id="3385133">,</span>&nbsp;<span class="ident" id="3385135">Err</span><span class="op" id="3385138">:</span>&nbsp;<span class="ident" id="3385140">err</span><span class="op" id="3385143">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385149">return</span>&nbsp;<span class="ident" id="3385156">newIPConn</span><span class="op" id="3385165">(</span><span class="ident" id="3385166">fd</span><span class="op" id="3385168">)</span><span class="op" id="3385169">,</span>&nbsp;<span class="ident" id="3385171">nil</span><br>
<span class="lineno"></span><span class="op" id="3385175">}</span>
</div>
</body>
</html>
