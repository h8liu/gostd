<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2510878">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2510933">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2510987">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2511038">//&nbsp;+build&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2511055">package</span>&nbsp;<span class="ident" id="2511063">syscall</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2511072">import</span>&nbsp;<span class="op" id="2511079">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2511082">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2511091">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2511094">//&nbsp;SysProcIDMap&nbsp;holds&nbsp;Container&nbsp;ID&nbsp;to&nbsp;Host&nbsp;ID&nbsp;mappings&nbsp;used&nbsp;for&nbsp;User&nbsp;Namespaces&nbsp;in&nbsp;Linux.</span><br>
<span class="lineno"></span><span class="comment" id="2511184">//&nbsp;See&nbsp;user_namespaces(7).</span><br>
<span class="lineno">15</span><span class="keyword" id="2511211">type</span>&nbsp;<span class="ident" id="2511216">SysProcIDMap</span>&nbsp;<span class="keyword" id="2511229">struct</span>&nbsp;<span class="op" id="2511236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2511239">ContainerID</span>&nbsp;<span class="builtintype" id="2511251">int</span>&nbsp;<span class="comment" id="2511255">//&nbsp;Container&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2511273">HostID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2511285">int</span>&nbsp;<span class="comment" id="2511289">//&nbsp;Host&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2511302">Size</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2511314">int</span>&nbsp;<span class="comment" id="2511318">//&nbsp;Size.</span><br>
<span class="lineno"></span><span class="op" id="2511327">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="2511330">type</span>&nbsp;<span class="ident" id="2511335">SysProcAttr</span>&nbsp;<span class="keyword" id="2511347">struct</span>&nbsp;<span class="op" id="2511354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2511357">Chroot</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2511369">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2511384">//&nbsp;Chroot.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2511396">Credential</span>&nbsp;&nbsp;<span class="op" id="2511408">*</span><span class="ident" id="2511409">Credential</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2511423">//&nbsp;Credential.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2511439">Ptrace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2511451">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2511466">//&nbsp;Enable&nbsp;tracing.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2511486">Setsid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2511498">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2511513">//&nbsp;Create&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2511533">Setpgid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2511545">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2511560">//&nbsp;Set&nbsp;process&nbsp;group&nbsp;ID&nbsp;to&nbsp;new&nbsp;pid&nbsp;(SYSV&nbsp;setpgrp)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2511611">Setctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2511623">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2511638">//&nbsp;Set&nbsp;controlling&nbsp;terminal&nbsp;to&nbsp;fd&nbsp;Ctty&nbsp;(only&nbsp;meaningful&nbsp;if&nbsp;Setsid&nbsp;is&nbsp;set)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2511713">Noctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2511725">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2511740">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;controlling&nbsp;terminal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2511782">Ctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2511794">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2511809">//&nbsp;Controlling&nbsp;TTY&nbsp;fd&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2511845">Pdeathsig</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2511857">Signal</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2511872">//&nbsp;Signal&nbsp;that&nbsp;the&nbsp;process&nbsp;will&nbsp;get&nbsp;when&nbsp;its&nbsp;parent&nbsp;dies&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2511943">Cloneflags</span>&nbsp;&nbsp;<span class="builtintype" id="2511955">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2511970">//&nbsp;Flags&nbsp;for&nbsp;clone&nbsp;calls&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2512009">UidMappings</span>&nbsp;<span class="op" id="2512021">[</span><span class="op" id="2512022">]</span><span class="ident" id="2512023">SysProcIDMap</span>&nbsp;<span class="comment" id="2512036">//&nbsp;User&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2512078">GidMappings</span>&nbsp;<span class="op" id="2512090">[</span><span class="op" id="2512091">]</span><span class="ident" id="2512092">SysProcIDMap</span>&nbsp;<span class="comment" id="2512105">//&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span><span class="op" id="2512147">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="2512150">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="2512185">func</span>&nbsp;<span class="ident" id="2512190">runtime_BeforeFork</span><span class="op" id="2512208">(</span><span class="op" id="2512209">)</span><br>
<span class="lineno"></span><span class="keyword" id="2512211">func</span>&nbsp;<span class="ident" id="2512216">runtime_AfterFork</span><span class="op" id="2512233">(</span><span class="op" id="2512234">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="2512237">//&nbsp;Fork,&nbsp;dup&nbsp;fd&nbsp;onto&nbsp;0..len(fd),&nbsp;and&nbsp;exec(argv0,&nbsp;argvv,&nbsp;envv)&nbsp;in&nbsp;child.</span><br>
<span class="lineno"></span><span class="comment" id="2512309">//&nbsp;If&nbsp;a&nbsp;dup&nbsp;or&nbsp;exec&nbsp;fails,&nbsp;write&nbsp;the&nbsp;errno&nbsp;error&nbsp;to&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="2512367">//&nbsp;(Pipe&nbsp;is&nbsp;close-on-exec&nbsp;so&nbsp;if&nbsp;exec&nbsp;succeeds,&nbsp;it&nbsp;will&nbsp;be&nbsp;closed.)</span><br>
<span class="lineno"></span><span class="comment" id="2512434">//&nbsp;In&nbsp;the&nbsp;child,&nbsp;this&nbsp;function&nbsp;must&nbsp;not&nbsp;acquire&nbsp;any&nbsp;locks,&nbsp;because</span><br>
<span class="lineno"></span><span class="comment" id="2512501">//&nbsp;they&nbsp;might&nbsp;have&nbsp;been&nbsp;locked&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;fork.&nbsp;&nbsp;This&nbsp;means</span><br>
<span class="lineno">45</span><span class="comment" id="2512569">//&nbsp;no&nbsp;rescheduling,&nbsp;no&nbsp;malloc&nbsp;calls,&nbsp;and&nbsp;no&nbsp;new&nbsp;stack&nbsp;segments.</span><br>
<span class="lineno"></span><span class="comment" id="2512633">//&nbsp;For&nbsp;the&nbsp;same&nbsp;reason&nbsp;compiler&nbsp;does&nbsp;not&nbsp;race&nbsp;instrument&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="2512694">//&nbsp;The&nbsp;calls&nbsp;to&nbsp;RawSyscall&nbsp;are&nbsp;okay&nbsp;because&nbsp;they&nbsp;are&nbsp;assembly</span><br>
<span class="lineno"></span><span class="comment" id="2512756">//&nbsp;functions&nbsp;that&nbsp;do&nbsp;not&nbsp;grow&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="2512797">func</span>&nbsp;<span class="ident" id="2512802">forkAndExecInChild</span><span class="op" id="2512820">(</span><span class="ident" id="2512821">argv0</span>&nbsp;<span class="op" id="2512827">*</span><span class="builtintype" id="2512828">byte</span><span class="op" id="2512832">,</span>&nbsp;<span class="ident" id="2512834">argv</span><span class="op" id="2512838">,</span>&nbsp;<span class="ident" id="2512840">envv</span>&nbsp;<span class="op" id="2512845">[</span><span class="op" id="2512846">]</span><span class="op" id="2512847">*</span><span class="builtintype" id="2512848">byte</span><span class="op" id="2512852">,</span>&nbsp;<span class="ident" id="2512854">chroot</span><span class="op" id="2512860">,</span>&nbsp;<span class="ident" id="2512862">dir</span>&nbsp;<span class="op" id="2512866">*</span><span class="builtintype" id="2512867">byte</span><span class="op" id="2512871">,</span>&nbsp;<span class="ident" id="2512873">attr</span>&nbsp;<span class="op" id="2512878">*</span><span class="ident" id="2512879">ProcAttr</span><span class="op" id="2512887">,</span>&nbsp;<span class="ident" id="2512889">sys</span>&nbsp;<span class="op" id="2512893">*</span><span class="ident" id="2512894">SysProcAttr</span><span class="op" id="2512905">,</span>&nbsp;<span class="ident" id="2512907">pipe</span>&nbsp;<span class="builtintype" id="2512912">int</span><span class="op" id="2512915">)</span>&nbsp;<span class="op" id="2512917">(</span><span class="ident" id="2512918">pid</span>&nbsp;<span class="builtintype" id="2512922">int</span><span class="op" id="2512925">,</span>&nbsp;<span class="ident" id="2512927">err</span>&nbsp;<span class="ident" id="2512931">Errno</span><span class="op" id="2512936">)</span>&nbsp;<span class="op" id="2512938">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2512941">//&nbsp;Declare&nbsp;all&nbsp;variables&nbsp;at&nbsp;top&nbsp;in&nbsp;case&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2512986">//&nbsp;declarations&nbsp;require&nbsp;heap&nbsp;allocation&nbsp;(e.g.,&nbsp;err1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2513041">var</span>&nbsp;<span class="op" id="2513045">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2513049">r1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2513056">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2513066">err1</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2513073">Errno</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2513081">err2</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2513088">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2513096">nextfd</span>&nbsp;<span class="builtintype" id="2513103">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2513109">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2513116">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2513122">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2513129">[</span><span class="num" id="2513130">2</span><span class="op" id="2513131">]</span><span class="builtintype" id="2513132">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2513137">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2513141">//&nbsp;Guard&nbsp;against&nbsp;side&nbsp;effects&nbsp;of&nbsp;shuffling&nbsp;fds&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2513196">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;nextfd&nbsp;is&nbsp;beyond&nbsp;any&nbsp;currently&nbsp;open&nbsp;files&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2513260">//&nbsp;that&nbsp;we&nbsp;can&#39;t&nbsp;run&nbsp;the&nbsp;risk&nbsp;of&nbsp;overwriting&nbsp;any&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2513319">fd</span>&nbsp;<span class="op" id="2513322">:=</span>&nbsp;<span class="builtinfunc" id="2513325">make</span><span class="op" id="2513329">(</span><span class="op" id="2513330">[</span><span class="op" id="2513331">]</span><span class="builtintype" id="2513332">int</span><span class="op" id="2513335">,</span>&nbsp;<span class="builtinfunc" id="2513337">len</span><span class="op" id="2513340">(</span><span class="ident" id="2513341">attr</span><span class="op" id="2513345">.</span><span class="ident" id="2513346">Files</span><span class="op" id="2513351">)</span><span class="op" id="2513352">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2513355">nextfd</span>&nbsp;<span class="op" id="2513362">=</span>&nbsp;<span class="builtinfunc" id="2513364">len</span><span class="op" id="2513367">(</span><span class="ident" id="2513368">attr</span><span class="op" id="2513372">.</span><span class="ident" id="2513373">Files</span><span class="op" id="2513378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2513381">for</span>&nbsp;<span class="ident" id="2513385">i</span><span class="op" id="2513386">,</span>&nbsp;<span class="ident" id="2513388">ufd</span>&nbsp;<span class="op" id="2513392">:=</span>&nbsp;<span class="keyword" id="2513395">range</span>&nbsp;<span class="ident" id="2513401">attr</span><span class="op" id="2513405">.</span><span class="ident" id="2513406">Files</span>&nbsp;<span class="op" id="2513412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2513416">if</span>&nbsp;<span class="ident" id="2513419">nextfd</span>&nbsp;<span class="op" id="2513426">&lt;</span>&nbsp;<span class="builtintype" id="2513428">int</span><span class="op" id="2513431">(</span><span class="ident" id="2513432">ufd</span><span class="op" id="2513435">)</span>&nbsp;<span class="op" id="2513437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2513442">nextfd</span>&nbsp;<span class="op" id="2513449">=</span>&nbsp;<span class="builtintype" id="2513451">int</span><span class="op" id="2513454">(</span><span class="ident" id="2513455">ufd</span><span class="op" id="2513458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2513462">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2513466">fd</span><span class="op" id="2513468">[</span><span class="ident" id="2513469">i</span><span class="op" id="2513470">]</span>&nbsp;<span class="op" id="2513472">=</span>&nbsp;<span class="builtintype" id="2513474">int</span><span class="op" id="2513477">(</span><span class="ident" id="2513478">ufd</span><span class="op" id="2513481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2513484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2513487">nextfd</span><span class="op" id="2513493">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2513498">//&nbsp;Allocate&nbsp;another&nbsp;pipe&nbsp;for&nbsp;parent&nbsp;to&nbsp;child&nbsp;communication&nbsp;for</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2513562">//&nbsp;synchronizing&nbsp;writing&nbsp;of&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2513618">if</span>&nbsp;<span class="ident" id="2513621">sys</span><span class="op" id="2513624">.</span><span class="ident" id="2513625">UidMappings</span>&nbsp;<span class="op" id="2513637">!=</span>&nbsp;<span class="ident" id="2513640">nil</span>&nbsp;<span class="op" id="2513644">||</span>&nbsp;<span class="ident" id="2513647">sys</span><span class="op" id="2513650">.</span><span class="ident" id="2513651">GidMappings</span>&nbsp;<span class="op" id="2513663">!=</span>&nbsp;<span class="ident" id="2513666">nil</span>&nbsp;<span class="op" id="2513670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2513674">if</span>&nbsp;<span class="ident" id="2513677">err</span>&nbsp;<span class="op" id="2513681">:=</span>&nbsp;<span class="ident" id="2513684">forkExecPipe</span><span class="op" id="2513696">(</span><span class="ident" id="2513697">p</span><span class="op" id="2513698">[</span><span class="op" id="2513699">:</span><span class="op" id="2513700">]</span><span class="op" id="2513701">)</span><span class="op" id="2513702">;</span>&nbsp;<span class="ident" id="2513704">err</span>&nbsp;<span class="op" id="2513708">!=</span>&nbsp;<span class="ident" id="2513711">nil</span>&nbsp;<span class="op" id="2513715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2513720">return</span>&nbsp;<span class="num" id="2513727">0</span><span class="op" id="2513728">,</span>&nbsp;<span class="ident" id="2513730">err</span><span class="op" id="2513733">.</span><span class="op" id="2513734">(</span><span class="ident" id="2513735">Errno</span><span class="op" id="2513740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2513744">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2513747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2513751">//&nbsp;About&nbsp;to&nbsp;call&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2513775">//&nbsp;No&nbsp;more&nbsp;allocation&nbsp;or&nbsp;calls&nbsp;of&nbsp;non-assembly&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2513834">runtime_BeforeFork</span><span class="op" id="2513852">(</span><span class="op" id="2513853">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2513856">r1</span><span class="op" id="2513858">,</span>&nbsp;<span class="ident" id="2513860">_</span><span class="op" id="2513861">,</span>&nbsp;<span class="ident" id="2513863">err1</span>&nbsp;<span class="op" id="2513868">=</span>&nbsp;<span class="ident" id="2513870">RawSyscall6</span><span class="op" id="2513881">(</span><span class="ident" id="2513882">SYS_CLONE</span><span class="op" id="2513891">,</span>&nbsp;<span class="builtintype" id="2513893">uintptr</span><span class="op" id="2513900">(</span><span class="ident" id="2513901">SIGCHLD</span><span class="op" id="2513908">)</span><span class="op" id="2513909">|</span><span class="ident" id="2513910">sys</span><span class="op" id="2513913">.</span><span class="ident" id="2513914">Cloneflags</span><span class="op" id="2513924">,</span>&nbsp;<span class="num" id="2513926">0</span><span class="op" id="2513927">,</span>&nbsp;<span class="num" id="2513929">0</span><span class="op" id="2513930">,</span>&nbsp;<span class="num" id="2513932">0</span><span class="op" id="2513933">,</span>&nbsp;<span class="num" id="2513935">0</span><span class="op" id="2513936">,</span>&nbsp;<span class="num" id="2513938">0</span><span class="op" id="2513939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2513942">if</span>&nbsp;<span class="ident" id="2513945">err1</span>&nbsp;<span class="op" id="2513950">!=</span>&nbsp;<span class="num" id="2513953">0</span>&nbsp;<span class="op" id="2513955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2513959">runtime_AfterFork</span><span class="op" id="2513976">(</span><span class="op" id="2513977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2513981">return</span>&nbsp;<span class="num" id="2513988">0</span><span class="op" id="2513989">,</span>&nbsp;<span class="ident" id="2513991">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2513997">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514001">if</span>&nbsp;<span class="ident" id="2514004">r1</span>&nbsp;<span class="op" id="2514007">!=</span>&nbsp;<span class="num" id="2514010">0</span>&nbsp;<span class="op" id="2514012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2514016">//&nbsp;parent;&nbsp;return&nbsp;PID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514040">runtime_AfterFork</span><span class="op" id="2514057">(</span><span class="op" id="2514058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514062">pid</span>&nbsp;<span class="op" id="2514066">=</span>&nbsp;<span class="builtintype" id="2514068">int</span><span class="op" id="2514071">(</span><span class="ident" id="2514072">r1</span><span class="op" id="2514074">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514079">if</span>&nbsp;<span class="ident" id="2514082">sys</span><span class="op" id="2514085">.</span><span class="ident" id="2514086">UidMappings</span>&nbsp;<span class="op" id="2514098">!=</span>&nbsp;<span class="ident" id="2514101">nil</span>&nbsp;<span class="op" id="2514105">||</span>&nbsp;<span class="ident" id="2514108">sys</span><span class="op" id="2514111">.</span><span class="ident" id="2514112">GidMappings</span>&nbsp;<span class="op" id="2514124">!=</span>&nbsp;<span class="ident" id="2514127">nil</span>&nbsp;<span class="op" id="2514131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514136">Close</span><span class="op" id="2514141">(</span><span class="ident" id="2514142">p</span><span class="op" id="2514143">[</span><span class="num" id="2514144">0</span><span class="op" id="2514145">]</span><span class="op" id="2514146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514151">err</span>&nbsp;<span class="op" id="2514155">:=</span>&nbsp;<span class="ident" id="2514158">writeUidGidMappings</span><span class="op" id="2514177">(</span><span class="ident" id="2514178">pid</span><span class="op" id="2514181">,</span>&nbsp;<span class="ident" id="2514183">sys</span><span class="op" id="2514186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514191">if</span>&nbsp;<span class="ident" id="2514194">err</span>&nbsp;<span class="op" id="2514198">!=</span>&nbsp;<span class="ident" id="2514201">nil</span>&nbsp;<span class="op" id="2514205">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514211">err2</span>&nbsp;<span class="op" id="2514216">=</span>&nbsp;<span class="ident" id="2514218">err</span><span class="op" id="2514221">.</span><span class="op" id="2514222">(</span><span class="ident" id="2514223">Errno</span><span class="op" id="2514228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2514233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514238">RawSyscall</span><span class="op" id="2514248">(</span><span class="ident" id="2514249">SYS_WRITE</span><span class="op" id="2514258">,</span>&nbsp;<span class="builtintype" id="2514260">uintptr</span><span class="op" id="2514267">(</span><span class="ident" id="2514268">p</span><span class="op" id="2514269">[</span><span class="num" id="2514270">1</span><span class="op" id="2514271">]</span><span class="op" id="2514272">)</span><span class="op" id="2514273">,</span>&nbsp;<span class="builtintype" id="2514275">uintptr</span><span class="op" id="2514282">(</span><span class="ident" id="2514283">unsafe</span><span class="op" id="2514289">.</span><span class="ident" id="2514290">Pointer</span><span class="op" id="2514297">(</span><span class="op" id="2514298">&amp;</span><span class="ident" id="2514299">err2</span><span class="op" id="2514303">)</span><span class="op" id="2514304">)</span><span class="op" id="2514305">,</span>&nbsp;<span class="ident" id="2514307">unsafe</span><span class="op" id="2514313">.</span><span class="ident" id="2514314">Sizeof</span><span class="op" id="2514320">(</span><span class="ident" id="2514321">err2</span><span class="op" id="2514325">)</span><span class="op" id="2514326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514331">Close</span><span class="op" id="2514336">(</span><span class="ident" id="2514337">p</span><span class="op" id="2514338">[</span><span class="num" id="2514339">1</span><span class="op" id="2514340">]</span><span class="op" id="2514341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2514345">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514350">return</span>&nbsp;<span class="ident" id="2514357">pid</span><span class="op" id="2514360">,</span>&nbsp;<span class="num" id="2514362">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2514365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2514369">//&nbsp;Fork&nbsp;succeeded,&nbsp;now&nbsp;in&nbsp;child.</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2514404">//&nbsp;Wait&nbsp;for&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;be&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514458">if</span>&nbsp;<span class="ident" id="2514461">sys</span><span class="op" id="2514464">.</span><span class="ident" id="2514465">UidMappings</span>&nbsp;<span class="op" id="2514477">!=</span>&nbsp;<span class="ident" id="2514480">nil</span>&nbsp;<span class="op" id="2514484">||</span>&nbsp;<span class="ident" id="2514487">sys</span><span class="op" id="2514490">.</span><span class="ident" id="2514491">GidMappings</span>&nbsp;<span class="op" id="2514503">!=</span>&nbsp;<span class="ident" id="2514506">nil</span>&nbsp;<span class="op" id="2514510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514514">if</span>&nbsp;<span class="ident" id="2514517">_</span><span class="op" id="2514518">,</span>&nbsp;<span class="ident" id="2514520">_</span><span class="op" id="2514521">,</span>&nbsp;<span class="ident" id="2514523">err1</span>&nbsp;<span class="op" id="2514528">=</span>&nbsp;<span class="ident" id="2514530">RawSyscall</span><span class="op" id="2514540">(</span><span class="ident" id="2514541">SYS_CLOSE</span><span class="op" id="2514550">,</span>&nbsp;<span class="builtintype" id="2514552">uintptr</span><span class="op" id="2514559">(</span><span class="ident" id="2514560">p</span><span class="op" id="2514561">[</span><span class="num" id="2514562">1</span><span class="op" id="2514563">]</span><span class="op" id="2514564">)</span><span class="op" id="2514565">,</span>&nbsp;<span class="num" id="2514567">0</span><span class="op" id="2514568">,</span>&nbsp;<span class="num" id="2514570">0</span><span class="op" id="2514571">)</span><span class="op" id="2514572">;</span>&nbsp;<span class="ident" id="2514574">err1</span>&nbsp;<span class="op" id="2514579">!=</span>&nbsp;<span class="num" id="2514582">0</span>&nbsp;<span class="op" id="2514584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514589">goto</span>&nbsp;<span class="ident" id="2514594">childerror</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2514607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514611">r1</span><span class="op" id="2514613">,</span>&nbsp;<span class="ident" id="2514615">_</span><span class="op" id="2514616">,</span>&nbsp;<span class="ident" id="2514618">err1</span>&nbsp;<span class="op" id="2514623">=</span>&nbsp;<span class="ident" id="2514625">RawSyscall</span><span class="op" id="2514635">(</span><span class="ident" id="2514636">SYS_READ</span><span class="op" id="2514644">,</span>&nbsp;<span class="builtintype" id="2514646">uintptr</span><span class="op" id="2514653">(</span><span class="ident" id="2514654">p</span><span class="op" id="2514655">[</span><span class="num" id="2514656">0</span><span class="op" id="2514657">]</span><span class="op" id="2514658">)</span><span class="op" id="2514659">,</span>&nbsp;<span class="builtintype" id="2514661">uintptr</span><span class="op" id="2514668">(</span><span class="ident" id="2514669">unsafe</span><span class="op" id="2514675">.</span><span class="ident" id="2514676">Pointer</span><span class="op" id="2514683">(</span><span class="op" id="2514684">&amp;</span><span class="ident" id="2514685">err2</span><span class="op" id="2514689">)</span><span class="op" id="2514690">)</span><span class="op" id="2514691">,</span>&nbsp;<span class="ident" id="2514693">unsafe</span><span class="op" id="2514699">.</span><span class="ident" id="2514700">Sizeof</span><span class="op" id="2514706">(</span><span class="ident" id="2514707">err2</span><span class="op" id="2514711">)</span><span class="op" id="2514712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514716">if</span>&nbsp;<span class="ident" id="2514719">err1</span>&nbsp;<span class="op" id="2514724">!=</span>&nbsp;<span class="num" id="2514727">0</span>&nbsp;<span class="op" id="2514729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514734">goto</span>&nbsp;<span class="ident" id="2514739">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2514752">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514756">if</span>&nbsp;<span class="ident" id="2514759">r1</span>&nbsp;<span class="op" id="2514762">!=</span>&nbsp;<span class="ident" id="2514765">unsafe</span><span class="op" id="2514771">.</span><span class="ident" id="2514772">Sizeof</span><span class="op" id="2514778">(</span><span class="ident" id="2514779">err2</span><span class="op" id="2514783">)</span>&nbsp;<span class="op" id="2514785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514790">err1</span>&nbsp;<span class="op" id="2514795">=</span>&nbsp;<span class="ident" id="2514797">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514807">goto</span>&nbsp;<span class="ident" id="2514812">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2514825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514829">if</span>&nbsp;<span class="ident" id="2514832">err2</span>&nbsp;<span class="op" id="2514837">!=</span>&nbsp;<span class="num" id="2514840">0</span>&nbsp;<span class="op" id="2514842">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514847">err1</span>&nbsp;<span class="op" id="2514852">=</span>&nbsp;<span class="ident" id="2514854">err2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514862">goto</span>&nbsp;<span class="ident" id="2514867">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2514880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2514883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2514887">//&nbsp;Parent&nbsp;death&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514911">if</span>&nbsp;<span class="ident" id="2514914">sys</span><span class="op" id="2514917">.</span><span class="ident" id="2514918">Pdeathsig</span>&nbsp;<span class="op" id="2514928">!=</span>&nbsp;<span class="num" id="2514931">0</span>&nbsp;<span class="op" id="2514933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514937">_</span><span class="op" id="2514938">,</span>&nbsp;<span class="ident" id="2514940">_</span><span class="op" id="2514941">,</span>&nbsp;<span class="ident" id="2514943">err1</span>&nbsp;<span class="op" id="2514948">=</span>&nbsp;<span class="ident" id="2514950">RawSyscall6</span><span class="op" id="2514961">(</span><span class="ident" id="2514962">SYS_PRCTL</span><span class="op" id="2514971">,</span>&nbsp;<span class="ident" id="2514973">PR_SET_PDEATHSIG</span><span class="op" id="2514989">,</span>&nbsp;<span class="builtintype" id="2514991">uintptr</span><span class="op" id="2514998">(</span><span class="ident" id="2514999">sys</span><span class="op" id="2515002">.</span><span class="ident" id="2515003">Pdeathsig</span><span class="op" id="2515012">)</span><span class="op" id="2515013">,</span>&nbsp;<span class="num" id="2515015">0</span><span class="op" id="2515016">,</span>&nbsp;<span class="num" id="2515018">0</span><span class="op" id="2515019">,</span>&nbsp;<span class="num" id="2515021">0</span><span class="op" id="2515022">,</span>&nbsp;<span class="num" id="2515024">0</span><span class="op" id="2515025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515029">if</span>&nbsp;<span class="ident" id="2515032">err1</span>&nbsp;<span class="op" id="2515037">!=</span>&nbsp;<span class="num" id="2515040">0</span>&nbsp;<span class="op" id="2515042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515047">goto</span>&nbsp;<span class="ident" id="2515052">childerror</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2515065">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2515070">//&nbsp;Signal&nbsp;self&nbsp;if&nbsp;parent&nbsp;is&nbsp;already&nbsp;dead.&nbsp;This&nbsp;might&nbsp;cause&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2515133">//&nbsp;duplicate&nbsp;signal&nbsp;in&nbsp;rare&nbsp;cases,&nbsp;but&nbsp;it&nbsp;won&#39;t&nbsp;matter&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2515195">//&nbsp;using&nbsp;SIGKILL.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515215">r1</span><span class="op" id="2515217">,</span>&nbsp;<span class="ident" id="2515219">_</span><span class="op" id="2515220">,</span>&nbsp;<span class="ident" id="2515222">_</span>&nbsp;<span class="op" id="2515224">=</span>&nbsp;<span class="ident" id="2515226">RawSyscall</span><span class="op" id="2515236">(</span><span class="ident" id="2515237">SYS_GETPPID</span><span class="op" id="2515248">,</span>&nbsp;<span class="num" id="2515250">0</span><span class="op" id="2515251">,</span>&nbsp;<span class="num" id="2515253">0</span><span class="op" id="2515254">,</span>&nbsp;<span class="num" id="2515256">0</span><span class="op" id="2515257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515261">if</span>&nbsp;<span class="ident" id="2515264">r1</span>&nbsp;<span class="op" id="2515267">==</span>&nbsp;<span class="num" id="2515270">1</span>&nbsp;<span class="op" id="2515272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515277">pid</span><span class="op" id="2515280">,</span>&nbsp;<span class="ident" id="2515282">_</span><span class="op" id="2515283">,</span>&nbsp;<span class="ident" id="2515285">_</span>&nbsp;<span class="op" id="2515287">:=</span>&nbsp;<span class="ident" id="2515290">RawSyscall</span><span class="op" id="2515300">(</span><span class="ident" id="2515301">SYS_GETPID</span><span class="op" id="2515311">,</span>&nbsp;<span class="num" id="2515313">0</span><span class="op" id="2515314">,</span>&nbsp;<span class="num" id="2515316">0</span><span class="op" id="2515317">,</span>&nbsp;<span class="num" id="2515319">0</span><span class="op" id="2515320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515325">_</span><span class="op" id="2515326">,</span>&nbsp;<span class="ident" id="2515328">_</span><span class="op" id="2515329">,</span>&nbsp;<span class="ident" id="2515331">err1</span>&nbsp;<span class="op" id="2515336">:=</span>&nbsp;<span class="ident" id="2515339">RawSyscall</span><span class="op" id="2515349">(</span><span class="ident" id="2515350">SYS_KILL</span><span class="op" id="2515358">,</span>&nbsp;<span class="ident" id="2515360">pid</span><span class="op" id="2515363">,</span>&nbsp;<span class="builtintype" id="2515365">uintptr</span><span class="op" id="2515372">(</span><span class="ident" id="2515373">sys</span><span class="op" id="2515376">.</span><span class="ident" id="2515377">Pdeathsig</span><span class="op" id="2515386">)</span><span class="op" id="2515387">,</span>&nbsp;<span class="num" id="2515389">0</span><span class="op" id="2515390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515395">if</span>&nbsp;<span class="ident" id="2515398">err1</span>&nbsp;<span class="op" id="2515403">!=</span>&nbsp;<span class="num" id="2515406">0</span>&nbsp;<span class="op" id="2515408">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515414">goto</span>&nbsp;<span class="ident" id="2515419">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2515433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2515437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2515440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2515444">//&nbsp;Enable&nbsp;tracing&nbsp;if&nbsp;requested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515477">if</span>&nbsp;<span class="ident" id="2515480">sys</span><span class="op" id="2515483">.</span><span class="ident" id="2515484">Ptrace</span>&nbsp;<span class="op" id="2515491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515495">_</span><span class="op" id="2515496">,</span>&nbsp;<span class="ident" id="2515498">_</span><span class="op" id="2515499">,</span>&nbsp;<span class="ident" id="2515501">err1</span>&nbsp;<span class="op" id="2515506">=</span>&nbsp;<span class="ident" id="2515508">RawSyscall</span><span class="op" id="2515518">(</span><span class="ident" id="2515519">SYS_PTRACE</span><span class="op" id="2515529">,</span>&nbsp;<span class="builtintype" id="2515531">uintptr</span><span class="op" id="2515538">(</span><span class="ident" id="2515539">PTRACE_TRACEME</span><span class="op" id="2515553">)</span><span class="op" id="2515554">,</span>&nbsp;<span class="num" id="2515556">0</span><span class="op" id="2515557">,</span>&nbsp;<span class="num" id="2515559">0</span><span class="op" id="2515560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515564">if</span>&nbsp;<span class="ident" id="2515567">err1</span>&nbsp;<span class="op" id="2515572">!=</span>&nbsp;<span class="num" id="2515575">0</span>&nbsp;<span class="op" id="2515577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515582">goto</span>&nbsp;<span class="ident" id="2515587">childerror</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2515600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2515603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2515607">//&nbsp;Session&nbsp;ID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515622">if</span>&nbsp;<span class="ident" id="2515625">sys</span><span class="op" id="2515628">.</span><span class="ident" id="2515629">Setsid</span>&nbsp;<span class="op" id="2515636">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515640">_</span><span class="op" id="2515641">,</span>&nbsp;<span class="ident" id="2515643">_</span><span class="op" id="2515644">,</span>&nbsp;<span class="ident" id="2515646">err1</span>&nbsp;<span class="op" id="2515651">=</span>&nbsp;<span class="ident" id="2515653">RawSyscall</span><span class="op" id="2515663">(</span><span class="ident" id="2515664">SYS_SETSID</span><span class="op" id="2515674">,</span>&nbsp;<span class="num" id="2515676">0</span><span class="op" id="2515677">,</span>&nbsp;<span class="num" id="2515679">0</span><span class="op" id="2515680">,</span>&nbsp;<span class="num" id="2515682">0</span><span class="op" id="2515683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515687">if</span>&nbsp;<span class="ident" id="2515690">err1</span>&nbsp;<span class="op" id="2515695">!=</span>&nbsp;<span class="num" id="2515698">0</span>&nbsp;<span class="op" id="2515700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515705">goto</span>&nbsp;<span class="ident" id="2515710">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2515723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2515726">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2515730">//&nbsp;Set&nbsp;process&nbsp;group</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515752">if</span>&nbsp;<span class="ident" id="2515755">sys</span><span class="op" id="2515758">.</span><span class="ident" id="2515759">Setpgid</span>&nbsp;<span class="op" id="2515767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515771">_</span><span class="op" id="2515772">,</span>&nbsp;<span class="ident" id="2515774">_</span><span class="op" id="2515775">,</span>&nbsp;<span class="ident" id="2515777">err1</span>&nbsp;<span class="op" id="2515782">=</span>&nbsp;<span class="ident" id="2515784">RawSyscall</span><span class="op" id="2515794">(</span><span class="ident" id="2515795">SYS_SETPGID</span><span class="op" id="2515806">,</span>&nbsp;<span class="num" id="2515808">0</span><span class="op" id="2515809">,</span>&nbsp;<span class="num" id="2515811">0</span><span class="op" id="2515812">,</span>&nbsp;<span class="num" id="2515814">0</span><span class="op" id="2515815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515819">if</span>&nbsp;<span class="ident" id="2515822">err1</span>&nbsp;<span class="op" id="2515827">!=</span>&nbsp;<span class="num" id="2515830">0</span>&nbsp;<span class="op" id="2515832">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515837">goto</span>&nbsp;<span class="ident" id="2515842">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2515855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2515858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2515862">//&nbsp;Chroot</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515873">if</span>&nbsp;<span class="ident" id="2515876">chroot</span>&nbsp;<span class="op" id="2515883">!=</span>&nbsp;<span class="ident" id="2515886">nil</span>&nbsp;<span class="op" id="2515890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515894">_</span><span class="op" id="2515895">,</span>&nbsp;<span class="ident" id="2515897">_</span><span class="op" id="2515898">,</span>&nbsp;<span class="ident" id="2515900">err1</span>&nbsp;<span class="op" id="2515905">=</span>&nbsp;<span class="ident" id="2515907">RawSyscall</span><span class="op" id="2515917">(</span><span class="ident" id="2515918">SYS_CHROOT</span><span class="op" id="2515928">,</span>&nbsp;<span class="builtintype" id="2515930">uintptr</span><span class="op" id="2515937">(</span><span class="ident" id="2515938">unsafe</span><span class="op" id="2515944">.</span><span class="ident" id="2515945">Pointer</span><span class="op" id="2515952">(</span><span class="ident" id="2515953">chroot</span><span class="op" id="2515959">)</span><span class="op" id="2515960">)</span><span class="op" id="2515961">,</span>&nbsp;<span class="num" id="2515963">0</span><span class="op" id="2515964">,</span>&nbsp;<span class="num" id="2515966">0</span><span class="op" id="2515967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515971">if</span>&nbsp;<span class="ident" id="2515974">err1</span>&nbsp;<span class="op" id="2515979">!=</span>&nbsp;<span class="num" id="2515982">0</span>&nbsp;<span class="op" id="2515984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515989">goto</span>&nbsp;<span class="ident" id="2515994">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516007">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2516014">//&nbsp;User&nbsp;and&nbsp;groups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516034">if</span>&nbsp;<span class="ident" id="2516037">cred</span>&nbsp;<span class="op" id="2516042">:=</span>&nbsp;<span class="ident" id="2516045">sys</span><span class="op" id="2516048">.</span><span class="ident" id="2516049">Credential</span><span class="op" id="2516059">;</span>&nbsp;<span class="ident" id="2516061">cred</span>&nbsp;<span class="op" id="2516066">!=</span>&nbsp;<span class="ident" id="2516069">nil</span>&nbsp;<span class="op" id="2516073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516077">ngroups</span>&nbsp;<span class="op" id="2516085">:=</span>&nbsp;<span class="builtintype" id="2516088">uintptr</span><span class="op" id="2516095">(</span><span class="builtinfunc" id="2516096">len</span><span class="op" id="2516099">(</span><span class="ident" id="2516100">cred</span><span class="op" id="2516104">.</span><span class="ident" id="2516105">Groups</span><span class="op" id="2516111">)</span><span class="op" id="2516112">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516116">var</span>&nbsp;<span class="ident" id="2516120">groups</span>&nbsp;<span class="ident" id="2516127">unsafe</span><span class="op" id="2516133">.</span><span class="ident" id="2516134">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516144">if</span>&nbsp;<span class="ident" id="2516147">ngroups</span>&nbsp;<span class="op" id="2516155">&gt;</span>&nbsp;<span class="num" id="2516157">0</span>&nbsp;<span class="op" id="2516159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516164">groups</span>&nbsp;<span class="op" id="2516171">=</span>&nbsp;<span class="ident" id="2516173">unsafe</span><span class="op" id="2516179">.</span><span class="ident" id="2516180">Pointer</span><span class="op" id="2516187">(</span><span class="op" id="2516188">&amp;</span><span class="ident" id="2516189">cred</span><span class="op" id="2516193">.</span><span class="ident" id="2516194">Groups</span><span class="op" id="2516200">[</span><span class="num" id="2516201">0</span><span class="op" id="2516202">]</span><span class="op" id="2516203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516211">_</span><span class="op" id="2516212">,</span>&nbsp;<span class="ident" id="2516214">_</span><span class="op" id="2516215">,</span>&nbsp;<span class="ident" id="2516217">err1</span>&nbsp;<span class="op" id="2516222">=</span>&nbsp;<span class="ident" id="2516224">RawSyscall</span><span class="op" id="2516234">(</span><span class="ident" id="2516235">SYS_SETGROUPS</span><span class="op" id="2516248">,</span>&nbsp;<span class="ident" id="2516250">ngroups</span><span class="op" id="2516257">,</span>&nbsp;<span class="builtintype" id="2516259">uintptr</span><span class="op" id="2516266">(</span><span class="ident" id="2516267">groups</span><span class="op" id="2516273">)</span><span class="op" id="2516274">,</span>&nbsp;<span class="num" id="2516276">0</span><span class="op" id="2516277">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516281">if</span>&nbsp;<span class="ident" id="2516284">err1</span>&nbsp;<span class="op" id="2516289">!=</span>&nbsp;<span class="num" id="2516292">0</span>&nbsp;<span class="op" id="2516294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516299">goto</span>&nbsp;<span class="ident" id="2516304">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516321">_</span><span class="op" id="2516322">,</span>&nbsp;<span class="ident" id="2516324">_</span><span class="op" id="2516325">,</span>&nbsp;<span class="ident" id="2516327">err1</span>&nbsp;<span class="op" id="2516332">=</span>&nbsp;<span class="ident" id="2516334">RawSyscall</span><span class="op" id="2516344">(</span><span class="ident" id="2516345">SYS_SETGID</span><span class="op" id="2516355">,</span>&nbsp;<span class="builtintype" id="2516357">uintptr</span><span class="op" id="2516364">(</span><span class="ident" id="2516365">cred</span><span class="op" id="2516369">.</span><span class="ident" id="2516370">Gid</span><span class="op" id="2516373">)</span><span class="op" id="2516374">,</span>&nbsp;<span class="num" id="2516376">0</span><span class="op" id="2516377">,</span>&nbsp;<span class="num" id="2516379">0</span><span class="op" id="2516380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516384">if</span>&nbsp;<span class="ident" id="2516387">err1</span>&nbsp;<span class="op" id="2516392">!=</span>&nbsp;<span class="num" id="2516395">0</span>&nbsp;<span class="op" id="2516397">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516402">goto</span>&nbsp;<span class="ident" id="2516407">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516424">_</span><span class="op" id="2516425">,</span>&nbsp;<span class="ident" id="2516427">_</span><span class="op" id="2516428">,</span>&nbsp;<span class="ident" id="2516430">err1</span>&nbsp;<span class="op" id="2516435">=</span>&nbsp;<span class="ident" id="2516437">RawSyscall</span><span class="op" id="2516447">(</span><span class="ident" id="2516448">SYS_SETUID</span><span class="op" id="2516458">,</span>&nbsp;<span class="builtintype" id="2516460">uintptr</span><span class="op" id="2516467">(</span><span class="ident" id="2516468">cred</span><span class="op" id="2516472">.</span><span class="ident" id="2516473">Uid</span><span class="op" id="2516476">)</span><span class="op" id="2516477">,</span>&nbsp;<span class="num" id="2516479">0</span><span class="op" id="2516480">,</span>&nbsp;<span class="num" id="2516482">0</span><span class="op" id="2516483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516487">if</span>&nbsp;<span class="ident" id="2516490">err1</span>&nbsp;<span class="op" id="2516495">!=</span>&nbsp;<span class="num" id="2516498">0</span>&nbsp;<span class="op" id="2516500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516505">goto</span>&nbsp;<span class="ident" id="2516510">childerror</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2516530">//&nbsp;Chdir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516540">if</span>&nbsp;<span class="ident" id="2516543">dir</span>&nbsp;<span class="op" id="2516547">!=</span>&nbsp;<span class="ident" id="2516550">nil</span>&nbsp;<span class="op" id="2516554">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516558">_</span><span class="op" id="2516559">,</span>&nbsp;<span class="ident" id="2516561">_</span><span class="op" id="2516562">,</span>&nbsp;<span class="ident" id="2516564">err1</span>&nbsp;<span class="op" id="2516569">=</span>&nbsp;<span class="ident" id="2516571">RawSyscall</span><span class="op" id="2516581">(</span><span class="ident" id="2516582">SYS_CHDIR</span><span class="op" id="2516591">,</span>&nbsp;<span class="builtintype" id="2516593">uintptr</span><span class="op" id="2516600">(</span><span class="ident" id="2516601">unsafe</span><span class="op" id="2516607">.</span><span class="ident" id="2516608">Pointer</span><span class="op" id="2516615">(</span><span class="ident" id="2516616">dir</span><span class="op" id="2516619">)</span><span class="op" id="2516620">)</span><span class="op" id="2516621">,</span>&nbsp;<span class="num" id="2516623">0</span><span class="op" id="2516624">,</span>&nbsp;<span class="num" id="2516626">0</span><span class="op" id="2516627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516631">if</span>&nbsp;<span class="ident" id="2516634">err1</span>&nbsp;<span class="op" id="2516639">!=</span>&nbsp;<span class="num" id="2516642">0</span>&nbsp;<span class="op" id="2516644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516649">goto</span>&nbsp;<span class="ident" id="2516654">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516670">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2516674">//&nbsp;Pass&nbsp;1:&nbsp;look&nbsp;for&nbsp;fd[i]&nbsp;&lt;&nbsp;i&nbsp;and&nbsp;move&nbsp;those&nbsp;up&nbsp;above&nbsp;len(fd)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2516737">//&nbsp;so&nbsp;that&nbsp;pass&nbsp;2&nbsp;won&#39;t&nbsp;stomp&nbsp;on&nbsp;an&nbsp;fd&nbsp;it&nbsp;needs&nbsp;later.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516793">if</span>&nbsp;<span class="ident" id="2516796">pipe</span>&nbsp;<span class="op" id="2516801">&lt;</span>&nbsp;<span class="ident" id="2516803">nextfd</span>&nbsp;<span class="op" id="2516810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516814">_</span><span class="op" id="2516815">,</span>&nbsp;<span class="ident" id="2516817">_</span><span class="op" id="2516818">,</span>&nbsp;<span class="ident" id="2516820">err1</span>&nbsp;<span class="op" id="2516825">=</span>&nbsp;<span class="ident" id="2516827">RawSyscall</span><span class="op" id="2516837">(</span><span class="ident" id="2516838">SYS_DUP2</span><span class="op" id="2516846">,</span>&nbsp;<span class="builtintype" id="2516848">uintptr</span><span class="op" id="2516855">(</span><span class="ident" id="2516856">pipe</span><span class="op" id="2516860">)</span><span class="op" id="2516861">,</span>&nbsp;<span class="builtintype" id="2516863">uintptr</span><span class="op" id="2516870">(</span><span class="ident" id="2516871">nextfd</span><span class="op" id="2516877">)</span><span class="op" id="2516878">,</span>&nbsp;<span class="num" id="2516880">0</span><span class="op" id="2516881">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516885">if</span>&nbsp;<span class="ident" id="2516888">err1</span>&nbsp;<span class="op" id="2516893">!=</span>&nbsp;<span class="num" id="2516896">0</span>&nbsp;<span class="op" id="2516898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516903">goto</span>&nbsp;<span class="ident" id="2516908">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516925">RawSyscall</span><span class="op" id="2516935">(</span><span class="ident" id="2516936">SYS_FCNTL</span><span class="op" id="2516945">,</span>&nbsp;<span class="builtintype" id="2516947">uintptr</span><span class="op" id="2516954">(</span><span class="ident" id="2516955">nextfd</span><span class="op" id="2516961">)</span><span class="op" id="2516962">,</span>&nbsp;<span class="ident" id="2516964">F_SETFD</span><span class="op" id="2516971">,</span>&nbsp;<span class="ident" id="2516973">FD_CLOEXEC</span><span class="op" id="2516983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516987">pipe</span>&nbsp;<span class="op" id="2516992">=</span>&nbsp;<span class="ident" id="2516994">nextfd</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517003">nextfd</span><span class="op" id="2517009">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2517013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517016">for</span>&nbsp;<span class="ident" id="2517020">i</span>&nbsp;<span class="op" id="2517022">=</span>&nbsp;<span class="num" id="2517024">0</span><span class="op" id="2517025">;</span>&nbsp;<span class="ident" id="2517027">i</span>&nbsp;<span class="op" id="2517029">&lt;</span>&nbsp;<span class="builtinfunc" id="2517031">len</span><span class="op" id="2517034">(</span><span class="ident" id="2517035">fd</span><span class="op" id="2517037">)</span><span class="op" id="2517038">;</span>&nbsp;<span class="ident" id="2517040">i</span><span class="op" id="2517041">++</span>&nbsp;<span class="op" id="2517044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517048">if</span>&nbsp;<span class="ident" id="2517051">fd</span><span class="op" id="2517053">[</span><span class="ident" id="2517054">i</span><span class="op" id="2517055">]</span>&nbsp;<span class="op" id="2517057">&gt;=</span>&nbsp;<span class="num" id="2517060">0</span>&nbsp;<span class="op" id="2517062">&amp;&amp;</span>&nbsp;<span class="ident" id="2517065">fd</span><span class="op" id="2517067">[</span><span class="ident" id="2517068">i</span><span class="op" id="2517069">]</span>&nbsp;<span class="op" id="2517071">&lt;</span>&nbsp;<span class="builtintype" id="2517073">int</span><span class="op" id="2517076">(</span><span class="ident" id="2517077">i</span><span class="op" id="2517078">)</span>&nbsp;<span class="op" id="2517080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517085">_</span><span class="op" id="2517086">,</span>&nbsp;<span class="ident" id="2517088">_</span><span class="op" id="2517089">,</span>&nbsp;<span class="ident" id="2517091">err1</span>&nbsp;<span class="op" id="2517096">=</span>&nbsp;<span class="ident" id="2517098">RawSyscall</span><span class="op" id="2517108">(</span><span class="ident" id="2517109">SYS_DUP2</span><span class="op" id="2517117">,</span>&nbsp;<span class="builtintype" id="2517119">uintptr</span><span class="op" id="2517126">(</span><span class="ident" id="2517127">fd</span><span class="op" id="2517129">[</span><span class="ident" id="2517130">i</span><span class="op" id="2517131">]</span><span class="op" id="2517132">)</span><span class="op" id="2517133">,</span>&nbsp;<span class="builtintype" id="2517135">uintptr</span><span class="op" id="2517142">(</span><span class="ident" id="2517143">nextfd</span><span class="op" id="2517149">)</span><span class="op" id="2517150">,</span>&nbsp;<span class="num" id="2517152">0</span><span class="op" id="2517153">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517158">if</span>&nbsp;<span class="ident" id="2517161">err1</span>&nbsp;<span class="op" id="2517166">!=</span>&nbsp;<span class="num" id="2517169">0</span>&nbsp;<span class="op" id="2517171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517177">goto</span>&nbsp;<span class="ident" id="2517182">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2517196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517201">RawSyscall</span><span class="op" id="2517211">(</span><span class="ident" id="2517212">SYS_FCNTL</span><span class="op" id="2517221">,</span>&nbsp;<span class="builtintype" id="2517223">uintptr</span><span class="op" id="2517230">(</span><span class="ident" id="2517231">nextfd</span><span class="op" id="2517237">)</span><span class="op" id="2517238">,</span>&nbsp;<span class="ident" id="2517240">F_SETFD</span><span class="op" id="2517247">,</span>&nbsp;<span class="ident" id="2517249">FD_CLOEXEC</span><span class="op" id="2517259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517264">fd</span><span class="op" id="2517266">[</span><span class="ident" id="2517267">i</span><span class="op" id="2517268">]</span>&nbsp;<span class="op" id="2517270">=</span>&nbsp;<span class="ident" id="2517272">nextfd</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517282">nextfd</span><span class="op" id="2517288">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517294">if</span>&nbsp;<span class="ident" id="2517297">nextfd</span>&nbsp;<span class="op" id="2517304">==</span>&nbsp;<span class="ident" id="2517307">pipe</span>&nbsp;<span class="op" id="2517312">{</span>&nbsp;<span class="comment" id="2517314">//&nbsp;don&#39;t&nbsp;stomp&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517341">nextfd</span><span class="op" id="2517347">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2517353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2517357">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2517360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2517364">//&nbsp;Pass&nbsp;2:&nbsp;dup&nbsp;fd[i]&nbsp;down&nbsp;onto&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517399">for</span>&nbsp;<span class="ident" id="2517403">i</span>&nbsp;<span class="op" id="2517405">=</span>&nbsp;<span class="num" id="2517407">0</span><span class="op" id="2517408">;</span>&nbsp;<span class="ident" id="2517410">i</span>&nbsp;<span class="op" id="2517412">&lt;</span>&nbsp;<span class="builtinfunc" id="2517414">len</span><span class="op" id="2517417">(</span><span class="ident" id="2517418">fd</span><span class="op" id="2517420">)</span><span class="op" id="2517421">;</span>&nbsp;<span class="ident" id="2517423">i</span><span class="op" id="2517424">++</span>&nbsp;<span class="op" id="2517427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517431">if</span>&nbsp;<span class="ident" id="2517434">fd</span><span class="op" id="2517436">[</span><span class="ident" id="2517437">i</span><span class="op" id="2517438">]</span>&nbsp;<span class="op" id="2517440">==</span>&nbsp;<span class="op" id="2517443">-</span><span class="num" id="2517444">1</span>&nbsp;<span class="op" id="2517446">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517451">RawSyscall</span><span class="op" id="2517461">(</span><span class="ident" id="2517462">SYS_CLOSE</span><span class="op" id="2517471">,</span>&nbsp;<span class="builtintype" id="2517473">uintptr</span><span class="op" id="2517480">(</span><span class="ident" id="2517481">i</span><span class="op" id="2517482">)</span><span class="op" id="2517483">,</span>&nbsp;<span class="num" id="2517485">0</span><span class="op" id="2517486">,</span>&nbsp;<span class="num" id="2517488">0</span><span class="op" id="2517489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517494">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2517505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517509">if</span>&nbsp;<span class="ident" id="2517512">fd</span><span class="op" id="2517514">[</span><span class="ident" id="2517515">i</span><span class="op" id="2517516">]</span>&nbsp;<span class="op" id="2517518">==</span>&nbsp;<span class="builtintype" id="2517521">int</span><span class="op" id="2517524">(</span><span class="ident" id="2517525">i</span><span class="op" id="2517526">)</span>&nbsp;<span class="op" id="2517528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2517533">//&nbsp;dup2(i,&nbsp;i)&nbsp;won&#39;t&nbsp;clear&nbsp;close-on-exec&nbsp;flag&nbsp;on&nbsp;Linux,</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2517591">//&nbsp;probably&nbsp;not&nbsp;elsewhere&nbsp;either.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517628">_</span><span class="op" id="2517629">,</span>&nbsp;<span class="ident" id="2517631">_</span><span class="op" id="2517632">,</span>&nbsp;<span class="ident" id="2517634">err1</span>&nbsp;<span class="op" id="2517639">=</span>&nbsp;<span class="ident" id="2517641">RawSyscall</span><span class="op" id="2517651">(</span><span class="ident" id="2517652">SYS_FCNTL</span><span class="op" id="2517661">,</span>&nbsp;<span class="builtintype" id="2517663">uintptr</span><span class="op" id="2517670">(</span><span class="ident" id="2517671">fd</span><span class="op" id="2517673">[</span><span class="ident" id="2517674">i</span><span class="op" id="2517675">]</span><span class="op" id="2517676">)</span><span class="op" id="2517677">,</span>&nbsp;<span class="ident" id="2517679">F_SETFD</span><span class="op" id="2517686">,</span>&nbsp;<span class="num" id="2517688">0</span><span class="op" id="2517689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517694">if</span>&nbsp;<span class="ident" id="2517697">err1</span>&nbsp;<span class="op" id="2517702">!=</span>&nbsp;<span class="num" id="2517705">0</span>&nbsp;<span class="op" id="2517707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517713">goto</span>&nbsp;<span class="ident" id="2517718">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2517732">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517737">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2517748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2517752">//&nbsp;The&nbsp;new&nbsp;fd&nbsp;is&nbsp;created&nbsp;NOT&nbsp;close-on-exec,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2517798">//&nbsp;which&nbsp;is&nbsp;exactly&nbsp;what&nbsp;we&nbsp;want.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517834">_</span><span class="op" id="2517835">,</span>&nbsp;<span class="ident" id="2517837">_</span><span class="op" id="2517838">,</span>&nbsp;<span class="ident" id="2517840">err1</span>&nbsp;<span class="op" id="2517845">=</span>&nbsp;<span class="ident" id="2517847">RawSyscall</span><span class="op" id="2517857">(</span><span class="ident" id="2517858">SYS_DUP2</span><span class="op" id="2517866">,</span>&nbsp;<span class="builtintype" id="2517868">uintptr</span><span class="op" id="2517875">(</span><span class="ident" id="2517876">fd</span><span class="op" id="2517878">[</span><span class="ident" id="2517879">i</span><span class="op" id="2517880">]</span><span class="op" id="2517881">)</span><span class="op" id="2517882">,</span>&nbsp;<span class="builtintype" id="2517884">uintptr</span><span class="op" id="2517891">(</span><span class="ident" id="2517892">i</span><span class="op" id="2517893">)</span><span class="op" id="2517894">,</span>&nbsp;<span class="num" id="2517896">0</span><span class="op" id="2517897">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517901">if</span>&nbsp;<span class="ident" id="2517904">err1</span>&nbsp;<span class="op" id="2517909">!=</span>&nbsp;<span class="num" id="2517912">0</span>&nbsp;<span class="op" id="2517914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517919">goto</span>&nbsp;<span class="ident" id="2517924">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2517937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2517940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2517944">//&nbsp;By&nbsp;convention,&nbsp;we&nbsp;don&#39;t&nbsp;close-on-exec&nbsp;the&nbsp;fds&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2518001">//&nbsp;started&nbsp;with,&nbsp;so&nbsp;if&nbsp;len(fd)&nbsp;&lt;&nbsp;3,&nbsp;close&nbsp;0,&nbsp;1,&nbsp;2&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2518063">//&nbsp;Programs&nbsp;that&nbsp;know&nbsp;they&nbsp;inherit&nbsp;fds&nbsp;&gt;=&nbsp;3&nbsp;will&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2518118">//&nbsp;to&nbsp;set&nbsp;them&nbsp;close-on-exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2518149">for</span>&nbsp;<span class="ident" id="2518153">i</span>&nbsp;<span class="op" id="2518155">=</span>&nbsp;<span class="builtinfunc" id="2518157">len</span><span class="op" id="2518160">(</span><span class="ident" id="2518161">fd</span><span class="op" id="2518163">)</span><span class="op" id="2518164">;</span>&nbsp;<span class="ident" id="2518166">i</span>&nbsp;<span class="op" id="2518168">&lt;</span>&nbsp;<span class="num" id="2518170">3</span><span class="op" id="2518171">;</span>&nbsp;<span class="ident" id="2518173">i</span><span class="op" id="2518174">++</span>&nbsp;<span class="op" id="2518177">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2518181">RawSyscall</span><span class="op" id="2518191">(</span><span class="ident" id="2518192">SYS_CLOSE</span><span class="op" id="2518201">,</span>&nbsp;<span class="builtintype" id="2518203">uintptr</span><span class="op" id="2518210">(</span><span class="ident" id="2518211">i</span><span class="op" id="2518212">)</span><span class="op" id="2518213">,</span>&nbsp;<span class="num" id="2518215">0</span><span class="op" id="2518216">,</span>&nbsp;<span class="num" id="2518218">0</span><span class="op" id="2518219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2518222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2518226">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;tty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2518251">if</span>&nbsp;<span class="ident" id="2518254">sys</span><span class="op" id="2518257">.</span><span class="ident" id="2518258">Noctty</span>&nbsp;<span class="op" id="2518265">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2518269">_</span><span class="op" id="2518270">,</span>&nbsp;<span class="ident" id="2518272">_</span><span class="op" id="2518273">,</span>&nbsp;<span class="ident" id="2518275">err1</span>&nbsp;<span class="op" id="2518280">=</span>&nbsp;<span class="ident" id="2518282">RawSyscall</span><span class="op" id="2518292">(</span><span class="ident" id="2518293">SYS_IOCTL</span><span class="op" id="2518302">,</span>&nbsp;<span class="num" id="2518304">0</span><span class="op" id="2518305">,</span>&nbsp;<span class="builtintype" id="2518307">uintptr</span><span class="op" id="2518314">(</span><span class="ident" id="2518315">TIOCNOTTY</span><span class="op" id="2518324">)</span><span class="op" id="2518325">,</span>&nbsp;<span class="num" id="2518327">0</span><span class="op" id="2518328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2518332">if</span>&nbsp;<span class="ident" id="2518335">err1</span>&nbsp;<span class="op" id="2518340">!=</span>&nbsp;<span class="num" id="2518343">0</span>&nbsp;<span class="op" id="2518345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2518350">goto</span>&nbsp;<span class="ident" id="2518355">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2518368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2518371">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2518375">//&nbsp;Set&nbsp;the&nbsp;controlling&nbsp;TTY&nbsp;to&nbsp;Ctty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2518411">if</span>&nbsp;<span class="ident" id="2518414">sys</span><span class="op" id="2518417">.</span><span class="ident" id="2518418">Setctty</span>&nbsp;<span class="op" id="2518426">&amp;&amp;</span>&nbsp;<span class="ident" id="2518429">sys</span><span class="op" id="2518432">.</span><span class="ident" id="2518433">Ctty</span>&nbsp;<span class="op" id="2518438">&gt;=</span>&nbsp;<span class="num" id="2518441">0</span>&nbsp;<span class="op" id="2518443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2518447">_</span><span class="op" id="2518448">,</span>&nbsp;<span class="ident" id="2518450">_</span><span class="op" id="2518451">,</span>&nbsp;<span class="ident" id="2518453">err1</span>&nbsp;<span class="op" id="2518458">=</span>&nbsp;<span class="ident" id="2518460">RawSyscall</span><span class="op" id="2518470">(</span><span class="ident" id="2518471">SYS_IOCTL</span><span class="op" id="2518480">,</span>&nbsp;<span class="builtintype" id="2518482">uintptr</span><span class="op" id="2518489">(</span><span class="ident" id="2518490">sys</span><span class="op" id="2518493">.</span><span class="ident" id="2518494">Ctty</span><span class="op" id="2518498">)</span><span class="op" id="2518499">,</span>&nbsp;<span class="builtintype" id="2518501">uintptr</span><span class="op" id="2518508">(</span><span class="ident" id="2518509">TIOCSCTTY</span><span class="op" id="2518518">)</span><span class="op" id="2518519">,</span>&nbsp;<span class="num" id="2518521">0</span><span class="op" id="2518522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2518526">if</span>&nbsp;<span class="ident" id="2518529">err1</span>&nbsp;<span class="op" id="2518534">!=</span>&nbsp;<span class="num" id="2518537">0</span>&nbsp;<span class="op" id="2518539">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2518544">goto</span>&nbsp;<span class="ident" id="2518549">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2518562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2518565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2518569">//&nbsp;Time&nbsp;to&nbsp;exec.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2518587">_</span><span class="op" id="2518588">,</span>&nbsp;<span class="ident" id="2518590">_</span><span class="op" id="2518591">,</span>&nbsp;<span class="ident" id="2518593">err1</span>&nbsp;<span class="op" id="2518598">=</span>&nbsp;<span class="ident" id="2518600">RawSyscall</span><span class="op" id="2518610">(</span><span class="ident" id="2518611">SYS_EXECVE</span><span class="op" id="2518621">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2518625">uintptr</span><span class="op" id="2518632">(</span><span class="ident" id="2518633">unsafe</span><span class="op" id="2518639">.</span><span class="ident" id="2518640">Pointer</span><span class="op" id="2518647">(</span><span class="ident" id="2518648">argv0</span><span class="op" id="2518653">)</span><span class="op" id="2518654">)</span><span class="op" id="2518655">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2518659">uintptr</span><span class="op" id="2518666">(</span><span class="ident" id="2518667">unsafe</span><span class="op" id="2518673">.</span><span class="ident" id="2518674">Pointer</span><span class="op" id="2518681">(</span><span class="op" id="2518682">&amp;</span><span class="ident" id="2518683">argv</span><span class="op" id="2518687">[</span><span class="num" id="2518688">0</span><span class="op" id="2518689">]</span><span class="op" id="2518690">)</span><span class="op" id="2518691">)</span><span class="op" id="2518692">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2518696">uintptr</span><span class="op" id="2518703">(</span><span class="ident" id="2518704">unsafe</span><span class="op" id="2518710">.</span><span class="ident" id="2518711">Pointer</span><span class="op" id="2518718">(</span><span class="op" id="2518719">&amp;</span><span class="ident" id="2518720">envv</span><span class="op" id="2518724">[</span><span class="num" id="2518725">0</span><span class="op" id="2518726">]</span><span class="op" id="2518727">)</span><span class="op" id="2518728">)</span><span class="op" id="2518729">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="ident" id="2518732">childerror</span><span class="op" id="2518742">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2518745">//&nbsp;send&nbsp;error&nbsp;code&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2518773">RawSyscall</span><span class="op" id="2518783">(</span><span class="ident" id="2518784">SYS_WRITE</span><span class="op" id="2518793">,</span>&nbsp;<span class="builtintype" id="2518795">uintptr</span><span class="op" id="2518802">(</span><span class="ident" id="2518803">pipe</span><span class="op" id="2518807">)</span><span class="op" id="2518808">,</span>&nbsp;<span class="builtintype" id="2518810">uintptr</span><span class="op" id="2518817">(</span><span class="ident" id="2518818">unsafe</span><span class="op" id="2518824">.</span><span class="ident" id="2518825">Pointer</span><span class="op" id="2518832">(</span><span class="op" id="2518833">&amp;</span><span class="ident" id="2518834">err1</span><span class="op" id="2518838">)</span><span class="op" id="2518839">)</span><span class="op" id="2518840">,</span>&nbsp;<span class="ident" id="2518842">unsafe</span><span class="op" id="2518848">.</span><span class="ident" id="2518849">Sizeof</span><span class="op" id="2518855">(</span><span class="ident" id="2518856">err1</span><span class="op" id="2518860">)</span><span class="op" id="2518861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2518864">for</span>&nbsp;<span class="op" id="2518868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2518872">RawSyscall</span><span class="op" id="2518882">(</span><span class="ident" id="2518883">SYS_EXIT</span><span class="op" id="2518891">,</span>&nbsp;<span class="num" id="2518893">253</span><span class="op" id="2518896">,</span>&nbsp;<span class="num" id="2518898">0</span><span class="op" id="2518899">,</span>&nbsp;<span class="num" id="2518901">0</span><span class="op" id="2518902">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2518905">}</span><br>
<span class="lineno"></span><span class="op" id="2518907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2518910">//&nbsp;Try&nbsp;to&nbsp;open&nbsp;a&nbsp;pipe&nbsp;with&nbsp;O_CLOEXEC&nbsp;set&nbsp;on&nbsp;both&nbsp;file&nbsp;descriptors.</span><br>
<span class="lineno"></span><span class="keyword" id="2518977">func</span>&nbsp;<span class="ident" id="2518982">forkExecPipe</span><span class="op" id="2518994">(</span><span class="ident" id="2518995">p</span>&nbsp;<span class="op" id="2518997">[</span><span class="op" id="2518998">]</span><span class="builtintype" id="2518999">int</span><span class="op" id="2519002">)</span>&nbsp;<span class="op" id="2519004">(</span><span class="ident" id="2519005">err</span>&nbsp;<span class="builtintype" id="2519009">error</span><span class="op" id="2519014">)</span>&nbsp;<span class="op" id="2519016">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2519019">err</span>&nbsp;<span class="op" id="2519023">=</span>&nbsp;<span class="ident" id="2519025">Pipe2</span><span class="op" id="2519030">(</span><span class="ident" id="2519031">p</span><span class="op" id="2519032">,</span>&nbsp;<span class="ident" id="2519034">O_CLOEXEC</span><span class="op" id="2519043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2519046">//&nbsp;pipe2&nbsp;was&nbsp;added&nbsp;in&nbsp;2.6.27&nbsp;and&nbsp;our&nbsp;minimum&nbsp;requirement&nbsp;is&nbsp;2.6.23,&nbsp;so&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2519121">//&nbsp;might&nbsp;not&nbsp;be&nbsp;implemented.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2519151">if</span>&nbsp;<span class="ident" id="2519154">err</span>&nbsp;<span class="op" id="2519158">==</span>&nbsp;<span class="ident" id="2519161">ENOSYS</span>&nbsp;<span class="op" id="2519168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2519172">if</span>&nbsp;<span class="ident" id="2519175">err</span>&nbsp;<span class="op" id="2519179">=</span>&nbsp;<span class="ident" id="2519181">Pipe</span><span class="op" id="2519185">(</span><span class="ident" id="2519186">p</span><span class="op" id="2519187">)</span><span class="op" id="2519188">;</span>&nbsp;<span class="ident" id="2519190">err</span>&nbsp;<span class="op" id="2519194">!=</span>&nbsp;<span class="ident" id="2519197">nil</span>&nbsp;<span class="op" id="2519201">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2519206">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2519215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2519219">if</span>&nbsp;<span class="ident" id="2519222">_</span><span class="op" id="2519223">,</span>&nbsp;<span class="ident" id="2519225">err</span>&nbsp;<span class="op" id="2519229">=</span>&nbsp;<span class="ident" id="2519231">fcntl</span><span class="op" id="2519236">(</span><span class="ident" id="2519237">p</span><span class="op" id="2519238">[</span><span class="num" id="2519239">0</span><span class="op" id="2519240">]</span><span class="op" id="2519241">,</span>&nbsp;<span class="ident" id="2519243">F_SETFD</span><span class="op" id="2519250">,</span>&nbsp;<span class="ident" id="2519252">FD_CLOEXEC</span><span class="op" id="2519262">)</span><span class="op" id="2519263">;</span>&nbsp;<span class="ident" id="2519265">err</span>&nbsp;<span class="op" id="2519269">!=</span>&nbsp;<span class="ident" id="2519272">nil</span>&nbsp;<span class="op" id="2519276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2519281">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2519290">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2519294">_</span><span class="op" id="2519295">,</span>&nbsp;<span class="ident" id="2519297">err</span>&nbsp;<span class="op" id="2519301">=</span>&nbsp;<span class="ident" id="2519303">fcntl</span><span class="op" id="2519308">(</span><span class="ident" id="2519309">p</span><span class="op" id="2519310">[</span><span class="num" id="2519311">1</span><span class="op" id="2519312">]</span><span class="op" id="2519313">,</span>&nbsp;<span class="ident" id="2519315">F_SETFD</span><span class="op" id="2519322">,</span>&nbsp;<span class="ident" id="2519324">FD_CLOEXEC</span><span class="op" id="2519334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2519337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2519340">return</span><br>
<span class="lineno"></span><span class="op" id="2519347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="comment" id="2519350">//&nbsp;writeIDMappings&nbsp;writes&nbsp;the&nbsp;user&nbsp;namespace&nbsp;User&nbsp;ID&nbsp;or&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;the&nbsp;specified&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="2519447">func</span>&nbsp;<span class="ident" id="2519452">writeIDMappings</span><span class="op" id="2519467">(</span><span class="ident" id="2519468">path</span>&nbsp;<span class="builtintype" id="2519473">string</span><span class="op" id="2519479">,</span>&nbsp;<span class="ident" id="2519481">idMap</span>&nbsp;<span class="op" id="2519487">[</span><span class="op" id="2519488">]</span><span class="ident" id="2519489">SysProcIDMap</span><span class="op" id="2519501">)</span>&nbsp;<span class="builtintype" id="2519503">error</span>&nbsp;<span class="op" id="2519509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2519512">fd</span><span class="op" id="2519514">,</span>&nbsp;<span class="ident" id="2519516">err</span>&nbsp;<span class="op" id="2519520">:=</span>&nbsp;<span class="ident" id="2519523">Open</span><span class="op" id="2519527">(</span><span class="ident" id="2519528">path</span><span class="op" id="2519532">,</span>&nbsp;<span class="ident" id="2519534">O_RDWR</span><span class="op" id="2519540">,</span>&nbsp;<span class="num" id="2519542">0</span><span class="op" id="2519543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2519546">if</span>&nbsp;<span class="ident" id="2519549">err</span>&nbsp;<span class="op" id="2519553">!=</span>&nbsp;<span class="ident" id="2519556">nil</span>&nbsp;<span class="op" id="2519560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2519564">return</span>&nbsp;<span class="ident" id="2519571">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2519576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2519580">data</span>&nbsp;<span class="op" id="2519585">:=</span>&nbsp;<span class="string" id="2519588">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2519592">for</span>&nbsp;<span class="ident" id="2519596">_</span><span class="op" id="2519597">,</span>&nbsp;<span class="ident" id="2519599">im</span>&nbsp;<span class="op" id="2519602">:=</span>&nbsp;<span class="keyword" id="2519605">range</span>&nbsp;<span class="ident" id="2519611">idMap</span>&nbsp;<span class="op" id="2519617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2519621">data</span>&nbsp;<span class="op" id="2519626">=</span>&nbsp;<span class="ident" id="2519628">data</span>&nbsp;<span class="op" id="2519633">+</span>&nbsp;<span class="ident" id="2519635">itoa</span><span class="op" id="2519639">(</span><span class="ident" id="2519640">im</span><span class="op" id="2519642">.</span><span class="ident" id="2519643">ContainerID</span><span class="op" id="2519654">)</span>&nbsp;<span class="op" id="2519656">+</span>&nbsp;<span class="string" id="2519658">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2519662">+</span>&nbsp;<span class="ident" id="2519664">itoa</span><span class="op" id="2519668">(</span><span class="ident" id="2519669">im</span><span class="op" id="2519671">.</span><span class="ident" id="2519672">HostID</span><span class="op" id="2519678">)</span>&nbsp;<span class="op" id="2519680">+</span>&nbsp;<span class="string" id="2519682">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2519686">+</span>&nbsp;<span class="ident" id="2519688">itoa</span><span class="op" id="2519692">(</span><span class="ident" id="2519693">im</span><span class="op" id="2519695">.</span><span class="ident" id="2519696">Size</span><span class="op" id="2519700">)</span>&nbsp;<span class="op" id="2519702">+</span>&nbsp;<span class="string" id="2519704">&#34;\n&#34;</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2519710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2519714">bytes</span><span class="op" id="2519719">,</span>&nbsp;<span class="ident" id="2519721">err</span>&nbsp;<span class="op" id="2519725">:=</span>&nbsp;<span class="ident" id="2519728">ByteSliceFromString</span><span class="op" id="2519747">(</span><span class="ident" id="2519748">data</span><span class="op" id="2519752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2519755">if</span>&nbsp;<span class="ident" id="2519758">err</span>&nbsp;<span class="op" id="2519762">!=</span>&nbsp;<span class="ident" id="2519765">nil</span>&nbsp;<span class="op" id="2519769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2519773">Close</span><span class="op" id="2519778">(</span><span class="ident" id="2519779">fd</span><span class="op" id="2519781">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2519785">return</span>&nbsp;<span class="ident" id="2519792">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2519797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2519801">if</span>&nbsp;<span class="ident" id="2519804">_</span><span class="op" id="2519805">,</span>&nbsp;<span class="ident" id="2519807">err</span>&nbsp;<span class="op" id="2519811">:=</span>&nbsp;<span class="ident" id="2519814">Write</span><span class="op" id="2519819">(</span><span class="ident" id="2519820">fd</span><span class="op" id="2519822">,</span>&nbsp;<span class="ident" id="2519824">bytes</span><span class="op" id="2519829">)</span><span class="op" id="2519830">;</span>&nbsp;<span class="ident" id="2519832">err</span>&nbsp;<span class="op" id="2519836">!=</span>&nbsp;<span class="ident" id="2519839">nil</span>&nbsp;<span class="op" id="2519843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2519847">Close</span><span class="op" id="2519852">(</span><span class="ident" id="2519853">fd</span><span class="op" id="2519855">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2519859">return</span>&nbsp;<span class="ident" id="2519866">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2519871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2519875">if</span>&nbsp;<span class="ident" id="2519878">err</span>&nbsp;<span class="op" id="2519882">:=</span>&nbsp;<span class="ident" id="2519885">Close</span><span class="op" id="2519890">(</span><span class="ident" id="2519891">fd</span><span class="op" id="2519893">)</span><span class="op" id="2519894">;</span>&nbsp;<span class="ident" id="2519896">err</span>&nbsp;<span class="op" id="2519900">!=</span>&nbsp;<span class="ident" id="2519903">nil</span>&nbsp;<span class="op" id="2519907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2519911">return</span>&nbsp;<span class="ident" id="2519918">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2519923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2519927">return</span>&nbsp;<span class="ident" id="2519934">nil</span><br>
<span class="lineno"></span><span class="op" id="2519938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span><span class="comment" id="2519941">//&nbsp;writeUidGidMappings&nbsp;writes&nbsp;User&nbsp;ID&nbsp;and&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces</span><br>
<span class="lineno"></span><span class="comment" id="2520021">//&nbsp;for&nbsp;a&nbsp;process&nbsp;and&nbsp;it&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;parent&nbsp;process.</span><br>
<span class="lineno"></span><span class="keyword" id="2520080">func</span>&nbsp;<span class="ident" id="2520085">writeUidGidMappings</span><span class="op" id="2520104">(</span><span class="ident" id="2520105">pid</span>&nbsp;<span class="builtintype" id="2520109">int</span><span class="op" id="2520112">,</span>&nbsp;<span class="ident" id="2520114">sys</span>&nbsp;<span class="op" id="2520118">*</span><span class="ident" id="2520119">SysProcAttr</span><span class="op" id="2520130">)</span>&nbsp;<span class="builtintype" id="2520132">error</span>&nbsp;<span class="op" id="2520138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2520141">if</span>&nbsp;<span class="ident" id="2520144">sys</span><span class="op" id="2520147">.</span><span class="ident" id="2520148">UidMappings</span>&nbsp;<span class="op" id="2520160">!=</span>&nbsp;<span class="ident" id="2520163">nil</span>&nbsp;<span class="op" id="2520167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2520171">uidf</span>&nbsp;<span class="op" id="2520176">:=</span>&nbsp;<span class="string" id="2520179">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2520188">+</span>&nbsp;<span class="ident" id="2520190">itoa</span><span class="op" id="2520194">(</span><span class="ident" id="2520195">pid</span><span class="op" id="2520198">)</span>&nbsp;<span class="op" id="2520200">+</span>&nbsp;<span class="string" id="2520202">&#34;/uid_map&#34;</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2520215">if</span>&nbsp;<span class="ident" id="2520218">err</span>&nbsp;<span class="op" id="2520222">:=</span>&nbsp;<span class="ident" id="2520225">writeIDMappings</span><span class="op" id="2520240">(</span><span class="ident" id="2520241">uidf</span><span class="op" id="2520245">,</span>&nbsp;<span class="ident" id="2520247">sys</span><span class="op" id="2520250">.</span><span class="ident" id="2520251">UidMappings</span><span class="op" id="2520262">)</span><span class="op" id="2520263">;</span>&nbsp;<span class="ident" id="2520265">err</span>&nbsp;<span class="op" id="2520269">!=</span>&nbsp;<span class="ident" id="2520272">nil</span>&nbsp;<span class="op" id="2520276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2520281">return</span>&nbsp;<span class="ident" id="2520288">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2520294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2520297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2520301">if</span>&nbsp;<span class="ident" id="2520304">sys</span><span class="op" id="2520307">.</span><span class="ident" id="2520308">GidMappings</span>&nbsp;<span class="op" id="2520320">!=</span>&nbsp;<span class="ident" id="2520323">nil</span>&nbsp;<span class="op" id="2520327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2520331">gidf</span>&nbsp;<span class="op" id="2520336">:=</span>&nbsp;<span class="string" id="2520339">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2520348">+</span>&nbsp;<span class="ident" id="2520350">itoa</span><span class="op" id="2520354">(</span><span class="ident" id="2520355">pid</span><span class="op" id="2520358">)</span>&nbsp;<span class="op" id="2520360">+</span>&nbsp;<span class="string" id="2520362">&#34;/gid_map&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2520375">if</span>&nbsp;<span class="ident" id="2520378">err</span>&nbsp;<span class="op" id="2520382">:=</span>&nbsp;<span class="ident" id="2520385">writeIDMappings</span><span class="op" id="2520400">(</span><span class="ident" id="2520401">gidf</span><span class="op" id="2520405">,</span>&nbsp;<span class="ident" id="2520407">sys</span><span class="op" id="2520410">.</span><span class="ident" id="2520411">GidMappings</span><span class="op" id="2520422">)</span><span class="op" id="2520423">;</span>&nbsp;<span class="ident" id="2520425">err</span>&nbsp;<span class="op" id="2520429">!=</span>&nbsp;<span class="ident" id="2520432">nil</span>&nbsp;<span class="op" id="2520436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2520441">return</span>&nbsp;<span class="ident" id="2520448">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2520454">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2520457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2520461">return</span>&nbsp;<span class="ident" id="2520468">nil</span><br>
<span class="lineno"></span><span class="op" id="2520472">}</span>
</div>
</body>
</html>
