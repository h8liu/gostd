<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/textproto</h2>
<ul>
<li><a href="/gostd/net/textproto/header.go.html">header.go</a></li>
<li><a href="/gostd/net/textproto/pipeline.go.html" class="current">pipeline.go</a></li>
<li><a href="/gostd/net/textproto/reader.go.html">reader.go</a></li>
<li><a href="/gostd/net/textproto/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/net/textproto/textproto.go.html">textproto.go</a></li>
<li><a href="/gostd/net/textproto/writer.go.html">writer.go</a></li>
<li><a href="/gostd/net/textproto/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3947313">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3947369">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3947423">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3947474">package</span>&nbsp;<span class="ident" id="3947482">textproto</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3947493">import</span>&nbsp;<span class="op" id="3947500">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3947503">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="3947510">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="3947513">//&nbsp;A&nbsp;Pipeline&nbsp;manages&nbsp;a&nbsp;pipelined&nbsp;in-order&nbsp;request/response&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="comment" id="3947583">//</span><br>
<span class="lineno"></span><span class="comment" id="3947586">//&nbsp;To&nbsp;use&nbsp;a&nbsp;Pipeline&nbsp;p&nbsp;to&nbsp;manage&nbsp;multiple&nbsp;clients&nbsp;on&nbsp;a&nbsp;connection,</span><br>
<span class="lineno"></span><span class="comment" id="3947653">//&nbsp;each&nbsp;client&nbsp;should&nbsp;run:</span><br>
<span class="lineno">15</span><span class="comment" id="3947680">//</span><br>
<span class="lineno"></span><span class="comment" id="3947683">//&nbsp;&nbsp;&nbsp;&nbsp;id&nbsp;:=&nbsp;p.Next()&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;take&nbsp;a&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="3947718">//</span><br>
<span class="lineno"></span><span class="comment" id="3947721">//&nbsp;&nbsp;&nbsp;&nbsp;p.StartRequest(id)&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;send&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3947776">//&nbsp;&nbsp;&nbsp;&nbsp;«send&nbsp;request»</span><br>
<span class="lineno">20</span><span class="comment" id="3947796">//&nbsp;&nbsp;&nbsp;&nbsp;p.EndRequest(id)&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;request&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="3947856">//</span><br>
<span class="lineno"></span><span class="comment" id="3947859">//&nbsp;&nbsp;&nbsp;&nbsp;p.StartResponse(id)&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;read&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="3947916">//&nbsp;&nbsp;&nbsp;&nbsp;«read&nbsp;response»</span><br>
<span class="lineno"></span><span class="comment" id="3947937">//&nbsp;&nbsp;&nbsp;&nbsp;p.EndResponse(id)&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;response&nbsp;is&nbsp;read</span><br>
<span class="lineno">25</span><span class="comment" id="3947999">//</span><br>
<span class="lineno"></span><span class="comment" id="3948002">//&nbsp;A&nbsp;pipelined&nbsp;server&nbsp;can&nbsp;use&nbsp;the&nbsp;same&nbsp;calls&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3948062">//&nbsp;responses&nbsp;computed&nbsp;in&nbsp;parallel&nbsp;are&nbsp;written&nbsp;in&nbsp;the&nbsp;correct&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="3948130">type</span>&nbsp;<span class="ident" id="3948135">Pipeline</span>&nbsp;<span class="keyword" id="3948144">struct</span>&nbsp;<span class="op" id="3948151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3948154">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3948163">sync</span><span class="op" id="3948167">.</span><span class="ident" id="3948168">Mutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3948175">id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3948184">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3948190">request</span>&nbsp;&nbsp;<span class="ident" id="3948199">sequencer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3948210">response</span>&nbsp;<span class="ident" id="3948219">sequencer</span><br>
<span class="lineno"></span><span class="op" id="3948229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="3948232">//&nbsp;Next&nbsp;returns&nbsp;the&nbsp;next&nbsp;id&nbsp;for&nbsp;a&nbsp;request/response&nbsp;pair.</span><br>
<span class="lineno"></span><span class="keyword" id="3948289">func</span>&nbsp;<span class="op" id="3948294">(</span><span class="ident" id="3948295">p</span>&nbsp;<span class="op" id="3948297">*</span><span class="ident" id="3948298">Pipeline</span><span class="op" id="3948306">)</span>&nbsp;<span class="ident" id="3948308">Next</span><span class="op" id="3948312">(</span><span class="op" id="3948313">)</span>&nbsp;<span class="builtintype" id="3948315">uint</span>&nbsp;<span class="op" id="3948320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3948323">p</span><span class="op" id="3948324">.</span><span class="ident" id="3948325">mu</span><span class="op" id="3948327">.</span><span class="ident" id="3948328">Lock</span><span class="op" id="3948332">(</span><span class="op" id="3948333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3948336">id</span>&nbsp;<span class="op" id="3948339">:=</span>&nbsp;<span class="ident" id="3948342">p</span><span class="op" id="3948343">.</span><span class="ident" id="3948344">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3948348">p</span><span class="op" id="3948349">.</span><span class="ident" id="3948350">id</span><span class="op" id="3948352">++</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3948356">p</span><span class="op" id="3948357">.</span><span class="ident" id="3948358">mu</span><span class="op" id="3948360">.</span><span class="ident" id="3948361">Unlock</span><span class="op" id="3948367">(</span><span class="op" id="3948368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3948371">return</span>&nbsp;<span class="ident" id="3948378">id</span><br>
<span class="lineno"></span><span class="op" id="3948381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3948384">//&nbsp;StartRequest&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;send&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;receive)</span><br>
<span class="lineno">45</span><span class="comment" id="3948467">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="3948501">func</span>&nbsp;<span class="op" id="3948506">(</span><span class="ident" id="3948507">p</span>&nbsp;<span class="op" id="3948509">*</span><span class="ident" id="3948510">Pipeline</span><span class="op" id="3948518">)</span>&nbsp;<span class="ident" id="3948520">StartRequest</span><span class="op" id="3948532">(</span><span class="ident" id="3948533">id</span>&nbsp;<span class="builtintype" id="3948536">uint</span><span class="op" id="3948540">)</span>&nbsp;<span class="op" id="3948542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3948545">p</span><span class="op" id="3948546">.</span><span class="ident" id="3948547">request</span><span class="op" id="3948554">.</span><span class="ident" id="3948555">Start</span><span class="op" id="3948560">(</span><span class="ident" id="3948561">id</span><span class="op" id="3948563">)</span><br>
<span class="lineno"></span><span class="op" id="3948565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="3948568">//&nbsp;EndRequest&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="3948642">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;received).</span><br>
<span class="lineno"></span><span class="keyword" id="3948682">func</span>&nbsp;<span class="op" id="3948687">(</span><span class="ident" id="3948688">p</span>&nbsp;<span class="op" id="3948690">*</span><span class="ident" id="3948691">Pipeline</span><span class="op" id="3948699">)</span>&nbsp;<span class="ident" id="3948701">EndRequest</span><span class="op" id="3948711">(</span><span class="ident" id="3948712">id</span>&nbsp;<span class="builtintype" id="3948715">uint</span><span class="op" id="3948719">)</span>&nbsp;<span class="op" id="3948721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3948724">p</span><span class="op" id="3948725">.</span><span class="ident" id="3948726">request</span><span class="op" id="3948733">.</span><span class="ident" id="3948734">End</span><span class="op" id="3948737">(</span><span class="ident" id="3948738">id</span><span class="op" id="3948740">)</span><br>
<span class="lineno"></span><span class="op" id="3948742">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="3948745">//&nbsp;StartResponse&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;receive&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;send)</span><br>
<span class="lineno"></span><span class="comment" id="3948829">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="3948863">func</span>&nbsp;<span class="op" id="3948868">(</span><span class="ident" id="3948869">p</span>&nbsp;<span class="op" id="3948871">*</span><span class="ident" id="3948872">Pipeline</span><span class="op" id="3948880">)</span>&nbsp;<span class="ident" id="3948882">StartResponse</span><span class="op" id="3948895">(</span><span class="ident" id="3948896">id</span>&nbsp;<span class="builtintype" id="3948899">uint</span><span class="op" id="3948903">)</span>&nbsp;<span class="op" id="3948905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3948908">p</span><span class="op" id="3948909">.</span><span class="ident" id="3948910">response</span><span class="op" id="3948918">.</span><span class="ident" id="3948919">Start</span><span class="op" id="3948924">(</span><span class="ident" id="3948925">id</span><span class="op" id="3948927">)</span><br>
<span class="lineno">60</span><span class="op" id="3948929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3948932">//&nbsp;EndResponse&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;response&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;received</span><br>
<span class="lineno"></span><span class="comment" id="3949012">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;sent).</span><br>
<span class="lineno"></span><span class="keyword" id="3949048">func</span>&nbsp;<span class="op" id="3949053">(</span><span class="ident" id="3949054">p</span>&nbsp;<span class="op" id="3949056">*</span><span class="ident" id="3949057">Pipeline</span><span class="op" id="3949065">)</span>&nbsp;<span class="ident" id="3949067">EndResponse</span><span class="op" id="3949078">(</span><span class="ident" id="3949079">id</span>&nbsp;<span class="builtintype" id="3949082">uint</span><span class="op" id="3949086">)</span>&nbsp;<span class="op" id="3949088">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3949091">p</span><span class="op" id="3949092">.</span><span class="ident" id="3949093">response</span><span class="op" id="3949101">.</span><span class="ident" id="3949102">End</span><span class="op" id="3949105">(</span><span class="ident" id="3949106">id</span><span class="op" id="3949108">)</span><br>
<span class="lineno"></span><span class="op" id="3949110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3949113">//&nbsp;A&nbsp;sequencer&nbsp;schedules&nbsp;a&nbsp;sequence&nbsp;of&nbsp;numbered&nbsp;events&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="3949178">//&nbsp;happen&nbsp;in&nbsp;order,&nbsp;one&nbsp;after&nbsp;the&nbsp;other.&nbsp;&nbsp;The&nbsp;event&nbsp;numbering&nbsp;must&nbsp;start</span><br>
<span class="lineno">70</span><span class="comment" id="3949251">//&nbsp;at&nbsp;0&nbsp;and&nbsp;increment&nbsp;without&nbsp;skipping.&nbsp;&nbsp;The&nbsp;event&nbsp;number&nbsp;wraps&nbsp;around</span><br>
<span class="lineno"></span><span class="comment" id="3949322">//&nbsp;safely&nbsp;as&nbsp;long&nbsp;as&nbsp;there&nbsp;are&nbsp;not&nbsp;2^32&nbsp;simultaneous&nbsp;events&nbsp;pending.</span><br>
<span class="lineno"></span><span class="keyword" id="3949391">type</span>&nbsp;<span class="ident" id="3949396">sequencer</span>&nbsp;<span class="keyword" id="3949406">struct</span>&nbsp;<span class="op" id="3949413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3949416">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3949421">sync</span><span class="op" id="3949425">.</span><span class="ident" id="3949426">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3949433">id</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3949438">uint</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3949444">wait</span>&nbsp;<span class="keyword" id="3949449">map</span><span class="op" id="3949452">[</span><span class="builtintype" id="3949453">uint</span><span class="op" id="3949457">]</span><span class="keyword" id="3949458">chan</span>&nbsp;<span class="builtintype" id="3949463">uint</span><br>
<span class="lineno"></span><span class="op" id="3949468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3949471">//&nbsp;Start&nbsp;waits&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;for&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;to&nbsp;begin.</span><br>
<span class="lineno"></span><span class="comment" id="3949539">//&nbsp;That&nbsp;is,&nbsp;except&nbsp;for&nbsp;the&nbsp;first&nbsp;event,&nbsp;it&nbsp;waits&nbsp;until&nbsp;End(id-1)&nbsp;has</span><br>
<span class="lineno">80</span><span class="comment" id="3949608">//&nbsp;been&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="3949624">func</span>&nbsp;<span class="op" id="3949629">(</span><span class="ident" id="3949630">s</span>&nbsp;<span class="op" id="3949632">*</span><span class="ident" id="3949633">sequencer</span><span class="op" id="3949642">)</span>&nbsp;<span class="ident" id="3949644">Start</span><span class="op" id="3949649">(</span><span class="ident" id="3949650">id</span>&nbsp;<span class="builtintype" id="3949653">uint</span><span class="op" id="3949657">)</span>&nbsp;<span class="op" id="3949659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3949662">s</span><span class="op" id="3949663">.</span><span class="ident" id="3949664">mu</span><span class="op" id="3949666">.</span><span class="ident" id="3949667">Lock</span><span class="op" id="3949671">(</span><span class="op" id="3949672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3949675">if</span>&nbsp;<span class="ident" id="3949678">s</span><span class="op" id="3949679">.</span><span class="ident" id="3949680">id</span>&nbsp;<span class="op" id="3949683">==</span>&nbsp;<span class="ident" id="3949686">id</span>&nbsp;<span class="op" id="3949689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3949693">s</span><span class="op" id="3949694">.</span><span class="ident" id="3949695">mu</span><span class="op" id="3949697">.</span><span class="ident" id="3949698">Unlock</span><span class="op" id="3949704">(</span><span class="op" id="3949705">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3949709">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3949717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3949720">c</span>&nbsp;<span class="op" id="3949722">:=</span>&nbsp;<span class="builtinfunc" id="3949725">make</span><span class="op" id="3949729">(</span><span class="keyword" id="3949730">chan</span>&nbsp;<span class="builtintype" id="3949735">uint</span><span class="op" id="3949739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3949742">if</span>&nbsp;<span class="ident" id="3949745">s</span><span class="op" id="3949746">.</span><span class="ident" id="3949747">wait</span>&nbsp;<span class="op" id="3949752">==</span>&nbsp;<span class="builtintype" id="3949755">nil</span>&nbsp;<span class="op" id="3949759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3949763">s</span><span class="op" id="3949764">.</span><span class="ident" id="3949765">wait</span>&nbsp;<span class="op" id="3949770">=</span>&nbsp;<span class="builtinfunc" id="3949772">make</span><span class="op" id="3949776">(</span><span class="keyword" id="3949777">map</span><span class="op" id="3949780">[</span><span class="builtintype" id="3949781">uint</span><span class="op" id="3949785">]</span><span class="keyword" id="3949786">chan</span>&nbsp;<span class="builtintype" id="3949791">uint</span><span class="op" id="3949795">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3949798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3949801">s</span><span class="op" id="3949802">.</span><span class="ident" id="3949803">wait</span><span class="op" id="3949807">[</span><span class="ident" id="3949808">id</span><span class="op" id="3949810">]</span>&nbsp;<span class="op" id="3949812">=</span>&nbsp;<span class="ident" id="3949814">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3949817">s</span><span class="op" id="3949818">.</span><span class="ident" id="3949819">mu</span><span class="op" id="3949821">.</span><span class="ident" id="3949822">Unlock</span><span class="op" id="3949828">(</span><span class="op" id="3949829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3949832">&lt;-</span><span class="ident" id="3949834">c</span><br>
<span class="lineno"></span><span class="op" id="3949836">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="3949839">//&nbsp;End&nbsp;notifies&nbsp;the&nbsp;sequencer&nbsp;that&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;has&nbsp;completed,</span><br>
<span class="lineno"></span><span class="comment" id="3949911">//&nbsp;allowing&nbsp;it&nbsp;to&nbsp;schedule&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id+1.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3949987">//&nbsp;to&nbsp;call&nbsp;End&nbsp;with&nbsp;an&nbsp;id&nbsp;that&nbsp;is&nbsp;not&nbsp;the&nbsp;number&nbsp;of&nbsp;the&nbsp;active&nbsp;event.</span><br>
<span class="lineno"></span><span class="keyword" id="3950057">func</span>&nbsp;<span class="op" id="3950062">(</span><span class="ident" id="3950063">s</span>&nbsp;<span class="op" id="3950065">*</span><span class="ident" id="3950066">sequencer</span><span class="op" id="3950075">)</span>&nbsp;<span class="ident" id="3950077">End</span><span class="op" id="3950080">(</span><span class="ident" id="3950081">id</span>&nbsp;<span class="builtintype" id="3950084">uint</span><span class="op" id="3950088">)</span>&nbsp;<span class="op" id="3950090">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3950093">s</span><span class="op" id="3950094">.</span><span class="ident" id="3950095">mu</span><span class="op" id="3950097">.</span><span class="ident" id="3950098">Lock</span><span class="op" id="3950102">(</span><span class="op" id="3950103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3950106">if</span>&nbsp;<span class="ident" id="3950109">s</span><span class="op" id="3950110">.</span><span class="ident" id="3950111">id</span>&nbsp;<span class="op" id="3950114">!=</span>&nbsp;<span class="ident" id="3950117">id</span>&nbsp;<span class="op" id="3950120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3950124">panic</span><span class="op" id="3950129">(</span><span class="string" id="3950130">&#34;out&nbsp;of&nbsp;sync&#34;</span><span class="op" id="3950143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3950146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3950149">id</span><span class="op" id="3950151">++</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3950155">s</span><span class="op" id="3950156">.</span><span class="ident" id="3950157">id</span>&nbsp;<span class="op" id="3950160">=</span>&nbsp;<span class="ident" id="3950162">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3950166">if</span>&nbsp;<span class="ident" id="3950169">s</span><span class="op" id="3950170">.</span><span class="ident" id="3950171">wait</span>&nbsp;<span class="op" id="3950176">==</span>&nbsp;<span class="builtintype" id="3950179">nil</span>&nbsp;<span class="op" id="3950183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3950187">s</span><span class="op" id="3950188">.</span><span class="ident" id="3950189">wait</span>&nbsp;<span class="op" id="3950194">=</span>&nbsp;<span class="builtinfunc" id="3950196">make</span><span class="op" id="3950200">(</span><span class="keyword" id="3950201">map</span><span class="op" id="3950204">[</span><span class="builtintype" id="3950205">uint</span><span class="op" id="3950209">]</span><span class="keyword" id="3950210">chan</span>&nbsp;<span class="builtintype" id="3950215">uint</span><span class="op" id="3950219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3950222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3950225">c</span><span class="op" id="3950226">,</span>&nbsp;<span class="ident" id="3950228">ok</span>&nbsp;<span class="op" id="3950231">:=</span>&nbsp;<span class="ident" id="3950234">s</span><span class="op" id="3950235">.</span><span class="ident" id="3950236">wait</span><span class="op" id="3950240">[</span><span class="ident" id="3950241">id</span><span class="op" id="3950243">]</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3950246">if</span>&nbsp;<span class="ident" id="3950249">ok</span>&nbsp;<span class="op" id="3950252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3950256">delete</span><span class="op" id="3950262">(</span><span class="ident" id="3950263">s</span><span class="op" id="3950264">.</span><span class="ident" id="3950265">wait</span><span class="op" id="3950269">,</span>&nbsp;<span class="ident" id="3950271">id</span><span class="op" id="3950273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3950276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3950279">s</span><span class="op" id="3950280">.</span><span class="ident" id="3950281">mu</span><span class="op" id="3950283">.</span><span class="ident" id="3950284">Unlock</span><span class="op" id="3950290">(</span><span class="op" id="3950291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3950294">if</span>&nbsp;<span class="ident" id="3950297">ok</span>&nbsp;<span class="op" id="3950300">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3950304">c</span>&nbsp;<span class="op" id="3950306">&lt;-</span>&nbsp;<span class="num" id="3950309">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3950312">}</span><br>
<span class="lineno"></span><span class="op" id="3950314">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
