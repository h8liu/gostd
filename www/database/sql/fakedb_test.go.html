<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7232617">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7232672">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7232726">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7232777">package</span>&nbsp;<span class="ident" id="7232785">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7232790">import</span>&nbsp;<span class="op" id="7232797">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232800">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232823">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232833">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232840">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232846">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232853">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232861">&#34;strconv&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232872">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232883">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232891">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232902">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7232909">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7232912">var</span>&nbsp;<span class="ident" id="7232916">_</span>&nbsp;<span class="op" id="7232918">=</span>&nbsp;<span class="ident" id="7232920">log</span><span class="op" id="7232923">.</span><span class="ident" id="7232924">Printf</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7232932">//&nbsp;fakeDriver&nbsp;is&nbsp;a&nbsp;fake&nbsp;database&nbsp;that&nbsp;implements&nbsp;Go&#39;s&nbsp;driver.Driver</span><br>
<span class="lineno"></span><span class="comment" id="7233000">//&nbsp;interface,&nbsp;just&nbsp;for&nbsp;testing.</span><br>
<span class="lineno">25</span><span class="comment" id="7233032">//</span><br>
<span class="lineno"></span><span class="comment" id="7233035">//&nbsp;It&nbsp;speaks&nbsp;a&nbsp;query&nbsp;language&nbsp;that&#39;s&nbsp;semantically&nbsp;similar&nbsp;to&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="7233100">//&nbsp;syntactically&nbsp;different&nbsp;and&nbsp;simpler&nbsp;than&nbsp;SQL.&nbsp;&nbsp;The&nbsp;syntax&nbsp;is&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="7233167">//&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="7233179">//</span><br>
<span class="lineno">30</span><span class="comment" id="7233182">//&nbsp;&nbsp;&nbsp;WIPE</span><br>
<span class="lineno"></span><span class="comment" id="7233192">//&nbsp;&nbsp;&nbsp;CREATE|&lt;tablename&gt;|&lt;col&gt;=&lt;type&gt;,&lt;col&gt;=&lt;type&gt;,...</span><br>
<span class="lineno"></span><span class="comment" id="7233246">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;types&nbsp;are:&nbsp;&#34;string&#34;,&nbsp;[u]int{8,16,32,64},&nbsp;&#34;bool&#34;</span><br>
<span class="lineno"></span><span class="comment" id="7233307">//&nbsp;&nbsp;&nbsp;INSERT|&lt;tablename&gt;|col=val,col2=val2,col3=?</span><br>
<span class="lineno"></span><span class="comment" id="7233356">//&nbsp;&nbsp;&nbsp;SELECT|&lt;tablename&gt;|projectcol1,projectcol2|filtercol=?,filtercol2=?</span><br>
<span class="lineno">35</span><span class="comment" id="7233429">//</span><br>
<span class="lineno"></span><span class="comment" id="7233432">//&nbsp;When&nbsp;opening&nbsp;a&nbsp;fakeDriver&#39;s&nbsp;database,&nbsp;it&nbsp;starts&nbsp;empty&nbsp;with&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="7233497">//&nbsp;tables.&nbsp;&nbsp;All&nbsp;tables&nbsp;and&nbsp;data&nbsp;are&nbsp;stored&nbsp;in&nbsp;memory&nbsp;only.</span><br>
<span class="lineno"></span><span class="keyword" id="7233556">type</span>&nbsp;<span class="ident" id="7233561">fakeDriver</span>&nbsp;<span class="keyword" id="7233572">struct</span>&nbsp;<span class="op" id="7233579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233582">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7233593">sync</span><span class="op" id="7233597">.</span><span class="ident" id="7233598">Mutex</span>&nbsp;<span class="comment" id="7233604">//&nbsp;guards&nbsp;3&nbsp;following&nbsp;fields</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233634">openCount</span>&nbsp;&nbsp;<span class="builtintype" id="7233645">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7233656">//&nbsp;conn&nbsp;opens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233671">closeCount</span>&nbsp;<span class="builtintype" id="7233682">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7233693">//&nbsp;conn&nbsp;closes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233709">waitCh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7233720">chan</span>&nbsp;<span class="keyword" id="7233725">struct</span><span class="op" id="7233731">{</span><span class="op" id="7233732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233735">waitingCh</span>&nbsp;&nbsp;<span class="keyword" id="7233746">chan</span>&nbsp;<span class="keyword" id="7233751">struct</span><span class="op" id="7233757">{</span><span class="op" id="7233758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233761">dbs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7233772">map</span><span class="op" id="7233775">[</span><span class="builtintype" id="7233776">string</span><span class="op" id="7233782">]</span><span class="op" id="7233783">*</span><span class="ident" id="7233784">fakeDB</span><br>
<span class="lineno">45</span><span class="op" id="7233791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7233794">type</span>&nbsp;<span class="ident" id="7233799">fakeDB</span>&nbsp;<span class="keyword" id="7233806">struct</span>&nbsp;<span class="op" id="7233813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233816">name</span>&nbsp;<span class="builtintype" id="7233821">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233830">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7233838">sync</span><span class="op" id="7233842">.</span><span class="ident" id="7233843">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233850">free</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7233858">[</span><span class="op" id="7233859">]</span><span class="op" id="7233860">*</span><span class="ident" id="7233861">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233871">tables</span>&nbsp;&nbsp;<span class="keyword" id="7233879">map</span><span class="op" id="7233882">[</span><span class="builtintype" id="7233883">string</span><span class="op" id="7233889">]</span><span class="op" id="7233890">*</span><span class="ident" id="7233891">table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233898">badConn</span>&nbsp;<span class="builtintype" id="7233906">bool</span><br>
<span class="lineno"></span><span class="op" id="7233911">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="7233914">type</span>&nbsp;<span class="ident" id="7233919">table</span>&nbsp;<span class="keyword" id="7233925">struct</span>&nbsp;<span class="op" id="7233932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233935">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7233943">sync</span><span class="op" id="7233947">.</span><span class="ident" id="7233948">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233955">colname</span>&nbsp;<span class="op" id="7233963">[</span><span class="op" id="7233964">]</span><span class="builtintype" id="7233965">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233973">coltype</span>&nbsp;<span class="op" id="7233981">[</span><span class="op" id="7233982">]</span><span class="builtintype" id="7233983">string</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233991">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7233999">[</span><span class="op" id="7234000">]</span><span class="op" id="7234001">*</span><span class="ident" id="7234002">row</span><br>
<span class="lineno"></span><span class="op" id="7234006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7234009">func</span>&nbsp;<span class="op" id="7234014">(</span><span class="ident" id="7234015">t</span>&nbsp;<span class="op" id="7234017">*</span><span class="ident" id="7234018">table</span><span class="op" id="7234023">)</span>&nbsp;<span class="ident" id="7234025">columnIndex</span><span class="op" id="7234036">(</span><span class="ident" id="7234037">name</span>&nbsp;<span class="builtintype" id="7234042">string</span><span class="op" id="7234048">)</span>&nbsp;<span class="builtintype" id="7234050">int</span>&nbsp;<span class="op" id="7234054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7234057">for</span>&nbsp;<span class="ident" id="7234061">n</span><span class="op" id="7234062">,</span>&nbsp;<span class="ident" id="7234064">nname</span>&nbsp;<span class="op" id="7234070">:=</span>&nbsp;<span class="keyword" id="7234073">range</span>&nbsp;<span class="ident" id="7234079">t</span><span class="op" id="7234080">.</span><span class="ident" id="7234081">colname</span>&nbsp;<span class="op" id="7234089">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7234093">if</span>&nbsp;<span class="ident" id="7234096">name</span>&nbsp;<span class="op" id="7234101">==</span>&nbsp;<span class="ident" id="7234104">nname</span>&nbsp;<span class="op" id="7234110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7234115">return</span>&nbsp;<span class="ident" id="7234122">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7234126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7234129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7234132">return</span>&nbsp;<span class="op" id="7234139">-</span><span class="num" id="7234140">1</span><br>
<span class="lineno">70</span><span class="op" id="7234142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7234145">type</span>&nbsp;<span class="ident" id="7234150">row</span>&nbsp;<span class="keyword" id="7234154">struct</span>&nbsp;<span class="op" id="7234161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234164">cols</span>&nbsp;<span class="op" id="7234169">[</span><span class="op" id="7234170">]</span><span class="keyword" id="7234171">interface</span><span class="op" id="7234180">{</span><span class="op" id="7234181">}</span>&nbsp;<span class="comment" id="7234183">//&nbsp;must&nbsp;be&nbsp;same&nbsp;size&nbsp;as&nbsp;its&nbsp;table&nbsp;colname&nbsp;+&nbsp;coltype</span><br>
<span class="lineno"></span><span class="op" id="7234235">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="7234238">func</span>&nbsp;<span class="op" id="7234243">(</span><span class="ident" id="7234244">r</span>&nbsp;<span class="op" id="7234246">*</span><span class="ident" id="7234247">row</span><span class="op" id="7234250">)</span>&nbsp;<span class="ident" id="7234252">clone</span><span class="op" id="7234257">(</span><span class="op" id="7234258">)</span>&nbsp;<span class="op" id="7234260">*</span><span class="ident" id="7234261">row</span>&nbsp;<span class="op" id="7234265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234268">nrow</span>&nbsp;<span class="op" id="7234273">:=</span>&nbsp;<span class="op" id="7234276">&amp;</span><span class="ident" id="7234277">row</span><span class="op" id="7234280">{</span><span class="ident" id="7234281">cols</span><span class="op" id="7234285">:</span>&nbsp;<span class="builtinfunc" id="7234287">make</span><span class="op" id="7234291">(</span><span class="op" id="7234292">[</span><span class="op" id="7234293">]</span><span class="keyword" id="7234294">interface</span><span class="op" id="7234303">{</span><span class="op" id="7234304">}</span><span class="op" id="7234305">,</span>&nbsp;<span class="builtinfunc" id="7234307">len</span><span class="op" id="7234310">(</span><span class="ident" id="7234311">r</span><span class="op" id="7234312">.</span><span class="ident" id="7234313">cols</span><span class="op" id="7234317">)</span><span class="op" id="7234318">)</span><span class="op" id="7234319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7234322">copy</span><span class="op" id="7234326">(</span><span class="ident" id="7234327">nrow</span><span class="op" id="7234331">.</span><span class="ident" id="7234332">cols</span><span class="op" id="7234336">,</span>&nbsp;<span class="ident" id="7234338">r</span><span class="op" id="7234339">.</span><span class="ident" id="7234340">cols</span><span class="op" id="7234344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7234347">return</span>&nbsp;<span class="ident" id="7234354">nrow</span><br>
<span class="lineno">80</span><span class="op" id="7234359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7234362">type</span>&nbsp;<span class="ident" id="7234367">fakeConn</span>&nbsp;<span class="keyword" id="7234376">struct</span>&nbsp;<span class="op" id="7234383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234386">db</span>&nbsp;<span class="op" id="7234389">*</span><span class="ident" id="7234390">fakeDB</span>&nbsp;<span class="comment" id="7234397">//&nbsp;where&nbsp;to&nbsp;return&nbsp;ourselves&nbsp;to</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234431">currTx</span>&nbsp;<span class="op" id="7234438">*</span><span class="ident" id="7234439">fakeTx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7234448">//&nbsp;Stats&nbsp;for&nbsp;tests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234469">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7234481">sync</span><span class="op" id="7234485">.</span><span class="ident" id="7234486">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234493">stmtsMade</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7234505">int</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234510">stmtsClosed</span>&nbsp;<span class="builtintype" id="7234522">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234527">numPrepare</span>&nbsp;&nbsp;<span class="builtintype" id="7234539">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234544">bad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7234556">bool</span><br>
<span class="lineno"></span><span class="op" id="7234561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7234564">func</span>&nbsp;<span class="op" id="7234569">(</span><span class="ident" id="7234570">c</span>&nbsp;<span class="op" id="7234572">*</span><span class="ident" id="7234573">fakeConn</span><span class="op" id="7234581">)</span>&nbsp;<span class="ident" id="7234583">incrStat</span><span class="op" id="7234591">(</span><span class="ident" id="7234592">v</span>&nbsp;<span class="op" id="7234594">*</span><span class="builtintype" id="7234595">int</span><span class="op" id="7234598">)</span>&nbsp;<span class="op" id="7234600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234603">c</span><span class="op" id="7234604">.</span><span class="ident" id="7234605">mu</span><span class="op" id="7234607">.</span><span class="ident" id="7234608">Lock</span><span class="op" id="7234612">(</span><span class="op" id="7234613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7234616">*</span><span class="ident" id="7234617">v</span><span class="op" id="7234618">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234622">c</span><span class="op" id="7234623">.</span><span class="ident" id="7234624">mu</span><span class="op" id="7234626">.</span><span class="ident" id="7234627">Unlock</span><span class="op" id="7234633">(</span><span class="op" id="7234634">)</span><br>
<span class="lineno"></span><span class="op" id="7234636">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="7234639">type</span>&nbsp;<span class="ident" id="7234644">fakeTx</span>&nbsp;<span class="keyword" id="7234651">struct</span>&nbsp;<span class="op" id="7234658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234661">c</span>&nbsp;<span class="op" id="7234663">*</span><span class="ident" id="7234664">fakeConn</span><br>
<span class="lineno"></span><span class="op" id="7234673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="7234676">type</span>&nbsp;<span class="ident" id="7234681">fakeStmt</span>&nbsp;<span class="keyword" id="7234690">struct</span>&nbsp;<span class="op" id="7234697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234700">c</span>&nbsp;<span class="op" id="7234702">*</span><span class="ident" id="7234703">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234713">q</span>&nbsp;<span class="builtintype" id="7234715">string</span>&nbsp;<span class="comment" id="7234722">//&nbsp;just&nbsp;for&nbsp;debugging</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234746">cmd</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7234752">string</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234760">table</span>&nbsp;<span class="builtintype" id="7234766">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234775">closed</span>&nbsp;<span class="builtintype" id="7234782">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234789">colName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7234802">[</span><span class="op" id="7234803">]</span><span class="builtintype" id="7234804">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7234816">//&nbsp;used&nbsp;by&nbsp;CREATE,&nbsp;INSERT,&nbsp;SELECT&nbsp;(selected&nbsp;columns)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234870">colType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7234883">[</span><span class="op" id="7234884">]</span><span class="builtintype" id="7234885">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7234897">//&nbsp;used&nbsp;by&nbsp;CREATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234916">colValue</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7234929">[</span><span class="op" id="7234930">]</span><span class="keyword" id="7234931">interface</span><span class="op" id="7234940">{</span><span class="op" id="7234941">}</span>&nbsp;<span class="comment" id="7234943">//&nbsp;used&nbsp;by&nbsp;INSERT&nbsp;(mix&nbsp;of&nbsp;strings&nbsp;and&nbsp;&#34;?&#34;&nbsp;for&nbsp;bound&nbsp;params)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235004">placeholders</span>&nbsp;<span class="builtintype" id="7235017">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7235031">//&nbsp;used&nbsp;by&nbsp;INSERT/SELECT:&nbsp;number&nbsp;of&nbsp;?&nbsp;params</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235078">whereCol</span>&nbsp;<span class="op" id="7235087">[</span><span class="op" id="7235088">]</span><span class="builtintype" id="7235089">string</span>&nbsp;<span class="comment" id="7235096">//&nbsp;used&nbsp;by&nbsp;SELECT&nbsp;(all&nbsp;placeholders)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235135">placeholderConverter</span>&nbsp;<span class="op" id="7235156">[</span><span class="op" id="7235157">]</span><span class="ident" id="7235158">driver</span><span class="op" id="7235164">.</span><span class="ident" id="7235165">ValueConverter</span>&nbsp;<span class="comment" id="7235180">//&nbsp;used&nbsp;by&nbsp;INSERT</span><br>
<span class="lineno"></span><span class="op" id="7235198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7235201">var</span>&nbsp;<span class="ident" id="7235205">fdriver</span>&nbsp;<span class="ident" id="7235213">driver</span><span class="op" id="7235219">.</span><span class="ident" id="7235220">Driver</span>&nbsp;<span class="op" id="7235227">=</span>&nbsp;<span class="op" id="7235229">&amp;</span><span class="ident" id="7235230">fakeDriver</span><span class="op" id="7235240">{</span><span class="op" id="7235241">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="7235244">func</span>&nbsp;<span class="ident" id="7235249">init</span><span class="op" id="7235253">(</span><span class="op" id="7235254">)</span>&nbsp;<span class="op" id="7235256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235259">Register</span><span class="op" id="7235267">(</span><span class="string" id="7235268">&#34;test&#34;</span><span class="op" id="7235274">,</span>&nbsp;<span class="ident" id="7235276">fdriver</span><span class="op" id="7235283">)</span><br>
<span class="lineno"></span><span class="op" id="7235285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="7235288">func</span>&nbsp;<span class="ident" id="7235293">contains</span><span class="op" id="7235301">(</span><span class="ident" id="7235302">list</span>&nbsp;<span class="op" id="7235307">[</span><span class="op" id="7235308">]</span><span class="builtintype" id="7235309">string</span><span class="op" id="7235315">,</span>&nbsp;<span class="ident" id="7235317">y</span>&nbsp;<span class="builtintype" id="7235319">string</span><span class="op" id="7235325">)</span>&nbsp;<span class="builtintype" id="7235327">bool</span>&nbsp;<span class="op" id="7235332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7235335">for</span>&nbsp;<span class="ident" id="7235339">_</span><span class="op" id="7235340">,</span>&nbsp;<span class="ident" id="7235342">x</span>&nbsp;<span class="op" id="7235344">:=</span>&nbsp;<span class="keyword" id="7235347">range</span>&nbsp;<span class="ident" id="7235353">list</span>&nbsp;<span class="op" id="7235358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7235362">if</span>&nbsp;<span class="ident" id="7235365">x</span>&nbsp;<span class="op" id="7235367">==</span>&nbsp;<span class="ident" id="7235370">y</span>&nbsp;<span class="op" id="7235372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7235377">return</span>&nbsp;<span class="ident" id="7235384">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7235391">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7235394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7235397">return</span>&nbsp;<span class="ident" id="7235404">false</span><br>
<span class="lineno"></span><span class="op" id="7235410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7235413">type</span>&nbsp;<span class="ident" id="7235418">Dummy</span>&nbsp;<span class="keyword" id="7235424">struct</span>&nbsp;<span class="op" id="7235431">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235434">driver</span><span class="op" id="7235440">.</span><span class="ident" id="7235441">Driver</span><br>
<span class="lineno"></span><span class="op" id="7235448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7235451">func</span>&nbsp;<span class="ident" id="7235456">TestDrivers</span><span class="op" id="7235467">(</span><span class="ident" id="7235468">t</span>&nbsp;<span class="op" id="7235470">*</span><span class="ident" id="7235471">testing</span><span class="op" id="7235478">.</span><span class="ident" id="7235479">T</span><span class="op" id="7235480">)</span>&nbsp;<span class="op" id="7235482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235485">unregisterAllDrivers</span><span class="op" id="7235505">(</span><span class="op" id="7235506">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235509">Register</span><span class="op" id="7235517">(</span><span class="string" id="7235518">&#34;test&#34;</span><span class="op" id="7235524">,</span>&nbsp;<span class="ident" id="7235526">fdriver</span><span class="op" id="7235533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235536">Register</span><span class="op" id="7235544">(</span><span class="string" id="7235545">&#34;invalid&#34;</span><span class="op" id="7235554">,</span>&nbsp;<span class="ident" id="7235556">Dummy</span><span class="op" id="7235561">{</span><span class="op" id="7235562">}</span><span class="op" id="7235563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235566">all</span>&nbsp;<span class="op" id="7235570">:=</span>&nbsp;<span class="ident" id="7235573">Drivers</span><span class="op" id="7235580">(</span><span class="op" id="7235581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7235584">if</span>&nbsp;<span class="builtinfunc" id="7235587">len</span><span class="op" id="7235590">(</span><span class="ident" id="7235591">all</span><span class="op" id="7235594">)</span>&nbsp;<span class="op" id="7235596">&lt;</span>&nbsp;<span class="num" id="7235598">2</span>&nbsp;<span class="op" id="7235600">||</span>&nbsp;<span class="op" id="7235603">!</span><span class="ident" id="7235604">sort</span><span class="op" id="7235608">.</span><span class="ident" id="7235609">StringsAreSorted</span><span class="op" id="7235625">(</span><span class="ident" id="7235626">all</span><span class="op" id="7235629">)</span>&nbsp;<span class="op" id="7235631">||</span>&nbsp;<span class="op" id="7235634">!</span><span class="ident" id="7235635">contains</span><span class="op" id="7235643">(</span><span class="ident" id="7235644">all</span><span class="op" id="7235647">,</span>&nbsp;<span class="string" id="7235649">&#34;test&#34;</span><span class="op" id="7235655">)</span>&nbsp;<span class="op" id="7235657">||</span>&nbsp;<span class="op" id="7235660">!</span><span class="ident" id="7235661">contains</span><span class="op" id="7235669">(</span><span class="ident" id="7235670">all</span><span class="op" id="7235673">,</span>&nbsp;<span class="string" id="7235675">&#34;invalid&#34;</span><span class="op" id="7235684">)</span>&nbsp;<span class="op" id="7235686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235690">t</span><span class="op" id="7235691">.</span><span class="ident" id="7235692">Fatalf</span><span class="op" id="7235698">(</span><span class="string" id="7235699">&#34;Drivers&nbsp;=&nbsp;%v,&nbsp;want&nbsp;sorted&nbsp;list&nbsp;with&nbsp;at&nbsp;least&nbsp;[invalid,&nbsp;test]&#34;</span><span class="op" id="7235761">,</span>&nbsp;<span class="ident" id="7235763">all</span><span class="op" id="7235766">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7235769">}</span><br>
<span class="lineno"></span><span class="op" id="7235771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7235774">//&nbsp;Supports&nbsp;dsn&nbsp;forms:</span><br>
<span class="lineno"></span><span class="comment" id="7235797">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;</span><br>
<span class="lineno">155</span><span class="comment" id="7235812">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;;&lt;opts&gt;&nbsp;&nbsp;(only&nbsp;currently&nbsp;supported&nbsp;option&nbsp;is&nbsp;`badConn`,</span><br>
<span class="lineno"></span><span class="comment" id="7235882">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;causes&nbsp;driver.ErrBadConn&nbsp;to&nbsp;be&nbsp;returned&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="7235955">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;every&nbsp;other&nbsp;conn.Begin())</span><br>
<span class="lineno"></span><span class="keyword" id="7236005">func</span>&nbsp;<span class="op" id="7236010">(</span><span class="ident" id="7236011">d</span>&nbsp;<span class="op" id="7236013">*</span><span class="ident" id="7236014">fakeDriver</span><span class="op" id="7236024">)</span>&nbsp;<span class="ident" id="7236026">Open</span><span class="op" id="7236030">(</span><span class="ident" id="7236031">dsn</span>&nbsp;<span class="builtintype" id="7236035">string</span><span class="op" id="7236041">)</span>&nbsp;<span class="op" id="7236043">(</span><span class="ident" id="7236044">driver</span><span class="op" id="7236050">.</span><span class="ident" id="7236051">Conn</span><span class="op" id="7236055">,</span>&nbsp;<span class="builtintype" id="7236057">error</span><span class="op" id="7236062">)</span>&nbsp;<span class="op" id="7236064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236067">parts</span>&nbsp;<span class="op" id="7236073">:=</span>&nbsp;<span class="ident" id="7236076">strings</span><span class="op" id="7236083">.</span><span class="ident" id="7236084">Split</span><span class="op" id="7236089">(</span><span class="ident" id="7236090">dsn</span><span class="op" id="7236093">,</span>&nbsp;<span class="string" id="7236095">&#34;;&#34;</span><span class="op" id="7236098">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7236101">if</span>&nbsp;<span class="builtinfunc" id="7236104">len</span><span class="op" id="7236107">(</span><span class="ident" id="7236108">parts</span><span class="op" id="7236113">)</span>&nbsp;<span class="op" id="7236115">&lt;</span>&nbsp;<span class="num" id="7236117">1</span>&nbsp;<span class="op" id="7236119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7236123">return</span>&nbsp;<span class="ident" id="7236130">nil</span><span class="op" id="7236133">,</span>&nbsp;<span class="ident" id="7236135">errors</span><span class="op" id="7236141">.</span><span class="ident" id="7236142">New</span><span class="op" id="7236145">(</span><span class="string" id="7236146">&#34;fakedb:&nbsp;no&nbsp;database&nbsp;name&#34;</span><span class="op" id="7236172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7236175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236178">name</span>&nbsp;<span class="op" id="7236183">:=</span>&nbsp;<span class="ident" id="7236186">parts</span><span class="op" id="7236191">[</span><span class="num" id="7236192">0</span><span class="op" id="7236193">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236197">db</span>&nbsp;<span class="op" id="7236200">:=</span>&nbsp;<span class="ident" id="7236203">d</span><span class="op" id="7236204">.</span><span class="ident" id="7236205">getDB</span><span class="op" id="7236210">(</span><span class="ident" id="7236211">name</span><span class="op" id="7236215">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236219">d</span><span class="op" id="7236220">.</span><span class="ident" id="7236221">mu</span><span class="op" id="7236223">.</span><span class="ident" id="7236224">Lock</span><span class="op" id="7236228">(</span><span class="op" id="7236229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236232">d</span><span class="op" id="7236233">.</span><span class="ident" id="7236234">openCount</span><span class="op" id="7236243">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236247">d</span><span class="op" id="7236248">.</span><span class="ident" id="7236249">mu</span><span class="op" id="7236251">.</span><span class="ident" id="7236252">Unlock</span><span class="op" id="7236258">(</span><span class="op" id="7236259">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236262">conn</span>&nbsp;<span class="op" id="7236267">:=</span>&nbsp;<span class="op" id="7236270">&amp;</span><span class="ident" id="7236271">fakeConn</span><span class="op" id="7236279">{</span><span class="ident" id="7236280">db</span><span class="op" id="7236282">:</span>&nbsp;<span class="ident" id="7236284">db</span><span class="op" id="7236286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7236290">if</span>&nbsp;<span class="builtinfunc" id="7236293">len</span><span class="op" id="7236296">(</span><span class="ident" id="7236297">parts</span><span class="op" id="7236302">)</span>&nbsp;<span class="op" id="7236304">&gt;=</span>&nbsp;<span class="num" id="7236307">2</span>&nbsp;<span class="op" id="7236309">&amp;&amp;</span>&nbsp;<span class="ident" id="7236312">parts</span><span class="op" id="7236317">[</span><span class="num" id="7236318">1</span><span class="op" id="7236319">]</span>&nbsp;<span class="op" id="7236321">==</span>&nbsp;<span class="string" id="7236324">&#34;badConn&#34;</span>&nbsp;<span class="op" id="7236334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236338">conn</span><span class="op" id="7236342">.</span><span class="ident" id="7236343">bad</span>&nbsp;<span class="op" id="7236347">=</span>&nbsp;<span class="ident" id="7236349">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7236355">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7236358">if</span>&nbsp;<span class="ident" id="7236361">d</span><span class="op" id="7236362">.</span><span class="ident" id="7236363">waitCh</span>&nbsp;<span class="op" id="7236370">!=</span>&nbsp;<span class="ident" id="7236373">nil</span>&nbsp;<span class="op" id="7236377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236381">d</span><span class="op" id="7236382">.</span><span class="ident" id="7236383">waitingCh</span>&nbsp;<span class="op" id="7236393">&lt;-</span>&nbsp;<span class="keyword" id="7236396">struct</span><span class="op" id="7236402">{</span><span class="op" id="7236403">}</span><span class="op" id="7236404">{</span><span class="op" id="7236405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7236409">&lt;-</span><span class="ident" id="7236411">d</span><span class="op" id="7236412">.</span><span class="ident" id="7236413">waitCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236422">d</span><span class="op" id="7236423">.</span><span class="ident" id="7236424">waitCh</span>&nbsp;<span class="op" id="7236431">=</span>&nbsp;<span class="ident" id="7236433">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236439">d</span><span class="op" id="7236440">.</span><span class="ident" id="7236441">waitingCh</span>&nbsp;<span class="op" id="7236451">=</span>&nbsp;<span class="ident" id="7236453">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7236458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7236461">return</span>&nbsp;<span class="ident" id="7236468">conn</span><span class="op" id="7236472">,</span>&nbsp;<span class="ident" id="7236474">nil</span><br>
<span class="lineno"></span><span class="op" id="7236478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7236481">func</span>&nbsp;<span class="op" id="7236486">(</span><span class="ident" id="7236487">d</span>&nbsp;<span class="op" id="7236489">*</span><span class="ident" id="7236490">fakeDriver</span><span class="op" id="7236500">)</span>&nbsp;<span class="ident" id="7236502">getDB</span><span class="op" id="7236507">(</span><span class="ident" id="7236508">name</span>&nbsp;<span class="builtintype" id="7236513">string</span><span class="op" id="7236519">)</span>&nbsp;<span class="op" id="7236521">*</span><span class="ident" id="7236522">fakeDB</span>&nbsp;<span class="op" id="7236529">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236532">d</span><span class="op" id="7236533">.</span><span class="ident" id="7236534">mu</span><span class="op" id="7236536">.</span><span class="ident" id="7236537">Lock</span><span class="op" id="7236541">(</span><span class="op" id="7236542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7236545">defer</span>&nbsp;<span class="ident" id="7236551">d</span><span class="op" id="7236552">.</span><span class="ident" id="7236553">mu</span><span class="op" id="7236555">.</span><span class="ident" id="7236556">Unlock</span><span class="op" id="7236562">(</span><span class="op" id="7236563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7236566">if</span>&nbsp;<span class="ident" id="7236569">d</span><span class="op" id="7236570">.</span><span class="ident" id="7236571">dbs</span>&nbsp;<span class="op" id="7236575">==</span>&nbsp;<span class="ident" id="7236578">nil</span>&nbsp;<span class="op" id="7236582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236586">d</span><span class="op" id="7236587">.</span><span class="ident" id="7236588">dbs</span>&nbsp;<span class="op" id="7236592">=</span>&nbsp;<span class="builtinfunc" id="7236594">make</span><span class="op" id="7236598">(</span><span class="keyword" id="7236599">map</span><span class="op" id="7236602">[</span><span class="builtintype" id="7236603">string</span><span class="op" id="7236609">]</span><span class="op" id="7236610">*</span><span class="ident" id="7236611">fakeDB</span><span class="op" id="7236617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7236620">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236623">db</span><span class="op" id="7236625">,</span>&nbsp;<span class="ident" id="7236627">ok</span>&nbsp;<span class="op" id="7236630">:=</span>&nbsp;<span class="ident" id="7236633">d</span><span class="op" id="7236634">.</span><span class="ident" id="7236635">dbs</span><span class="op" id="7236638">[</span><span class="ident" id="7236639">name</span><span class="op" id="7236643">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7236646">if</span>&nbsp;<span class="op" id="7236649">!</span><span class="ident" id="7236650">ok</span>&nbsp;<span class="op" id="7236653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236657">db</span>&nbsp;<span class="op" id="7236660">=</span>&nbsp;<span class="op" id="7236662">&amp;</span><span class="ident" id="7236663">fakeDB</span><span class="op" id="7236669">{</span><span class="ident" id="7236670">name</span><span class="op" id="7236674">:</span>&nbsp;<span class="ident" id="7236676">name</span><span class="op" id="7236680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236684">d</span><span class="op" id="7236685">.</span><span class="ident" id="7236686">dbs</span><span class="op" id="7236689">[</span><span class="ident" id="7236690">name</span><span class="op" id="7236694">]</span>&nbsp;<span class="op" id="7236696">=</span>&nbsp;<span class="ident" id="7236698">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7236702">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7236705">return</span>&nbsp;<span class="ident" id="7236712">db</span><br>
<span class="lineno"></span><span class="op" id="7236715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7236718">func</span>&nbsp;<span class="op" id="7236723">(</span><span class="ident" id="7236724">db</span>&nbsp;<span class="op" id="7236727">*</span><span class="ident" id="7236728">fakeDB</span><span class="op" id="7236734">)</span>&nbsp;<span class="ident" id="7236736">wipe</span><span class="op" id="7236740">(</span><span class="op" id="7236741">)</span>&nbsp;<span class="op" id="7236743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236746">db</span><span class="op" id="7236748">.</span><span class="ident" id="7236749">mu</span><span class="op" id="7236751">.</span><span class="ident" id="7236752">Lock</span><span class="op" id="7236756">(</span><span class="op" id="7236757">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7236760">defer</span>&nbsp;<span class="ident" id="7236766">db</span><span class="op" id="7236768">.</span><span class="ident" id="7236769">mu</span><span class="op" id="7236771">.</span><span class="ident" id="7236772">Unlock</span><span class="op" id="7236778">(</span><span class="op" id="7236779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236782">db</span><span class="op" id="7236784">.</span><span class="ident" id="7236785">tables</span>&nbsp;<span class="op" id="7236792">=</span>&nbsp;<span class="ident" id="7236794">nil</span><br>
<span class="lineno"></span><span class="op" id="7236798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7236801">func</span>&nbsp;<span class="op" id="7236806">(</span><span class="ident" id="7236807">db</span>&nbsp;<span class="op" id="7236810">*</span><span class="ident" id="7236811">fakeDB</span><span class="op" id="7236817">)</span>&nbsp;<span class="ident" id="7236819">createTable</span><span class="op" id="7236830">(</span><span class="ident" id="7236831">name</span>&nbsp;<span class="builtintype" id="7236836">string</span><span class="op" id="7236842">,</span>&nbsp;<span class="ident" id="7236844">columnNames</span><span class="op" id="7236855">,</span>&nbsp;<span class="ident" id="7236857">columnTypes</span>&nbsp;<span class="op" id="7236869">[</span><span class="op" id="7236870">]</span><span class="builtintype" id="7236871">string</span><span class="op" id="7236877">)</span>&nbsp;<span class="builtintype" id="7236879">error</span>&nbsp;<span class="op" id="7236885">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236888">db</span><span class="op" id="7236890">.</span><span class="ident" id="7236891">mu</span><span class="op" id="7236893">.</span><span class="ident" id="7236894">Lock</span><span class="op" id="7236898">(</span><span class="op" id="7236899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7236902">defer</span>&nbsp;<span class="ident" id="7236908">db</span><span class="op" id="7236910">.</span><span class="ident" id="7236911">mu</span><span class="op" id="7236913">.</span><span class="ident" id="7236914">Unlock</span><span class="op" id="7236920">(</span><span class="op" id="7236921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7236924">if</span>&nbsp;<span class="ident" id="7236927">db</span><span class="op" id="7236929">.</span><span class="ident" id="7236930">tables</span>&nbsp;<span class="op" id="7236937">==</span>&nbsp;<span class="ident" id="7236940">nil</span>&nbsp;<span class="op" id="7236944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236948">db</span><span class="op" id="7236950">.</span><span class="ident" id="7236951">tables</span>&nbsp;<span class="op" id="7236958">=</span>&nbsp;<span class="builtinfunc" id="7236960">make</span><span class="op" id="7236964">(</span><span class="keyword" id="7236965">map</span><span class="op" id="7236968">[</span><span class="builtintype" id="7236969">string</span><span class="op" id="7236975">]</span><span class="op" id="7236976">*</span><span class="ident" id="7236977">table</span><span class="op" id="7236982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7236985">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7236988">if</span>&nbsp;<span class="ident" id="7236991">_</span><span class="op" id="7236992">,</span>&nbsp;<span class="ident" id="7236994">exist</span>&nbsp;<span class="op" id="7237000">:=</span>&nbsp;<span class="ident" id="7237003">db</span><span class="op" id="7237005">.</span><span class="ident" id="7237006">tables</span><span class="op" id="7237012">[</span><span class="ident" id="7237013">name</span><span class="op" id="7237017">]</span><span class="op" id="7237018">;</span>&nbsp;<span class="ident" id="7237020">exist</span>&nbsp;<span class="op" id="7237026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237030">return</span>&nbsp;<span class="ident" id="7237037">fmt</span><span class="op" id="7237040">.</span><span class="ident" id="7237041">Errorf</span><span class="op" id="7237047">(</span><span class="string" id="7237048">&#34;table&nbsp;%q&nbsp;already&nbsp;exists&#34;</span><span class="op" id="7237073">,</span>&nbsp;<span class="ident" id="7237075">name</span><span class="op" id="7237079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7237082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237085">if</span>&nbsp;<span class="builtinfunc" id="7237088">len</span><span class="op" id="7237091">(</span><span class="ident" id="7237092">columnNames</span><span class="op" id="7237103">)</span>&nbsp;<span class="op" id="7237105">!=</span>&nbsp;<span class="builtinfunc" id="7237108">len</span><span class="op" id="7237111">(</span><span class="ident" id="7237112">columnTypes</span><span class="op" id="7237123">)</span>&nbsp;<span class="op" id="7237125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237129">return</span>&nbsp;<span class="ident" id="7237136">fmt</span><span class="op" id="7237139">.</span><span class="ident" id="7237140">Errorf</span><span class="op" id="7237146">(</span><span class="string" id="7237147">&#34;create&nbsp;table&nbsp;of&nbsp;%q&nbsp;len(names)&nbsp;!=&nbsp;len(types):&nbsp;%d&nbsp;vs&nbsp;%d&#34;</span><span class="op" id="7237202">,</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237207">name</span><span class="op" id="7237211">,</span>&nbsp;<span class="builtinfunc" id="7237213">len</span><span class="op" id="7237216">(</span><span class="ident" id="7237217">columnNames</span><span class="op" id="7237228">)</span><span class="op" id="7237229">,</span>&nbsp;<span class="builtinfunc" id="7237231">len</span><span class="op" id="7237234">(</span><span class="ident" id="7237235">columnTypes</span><span class="op" id="7237246">)</span><span class="op" id="7237247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7237250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237253">db</span><span class="op" id="7237255">.</span><span class="ident" id="7237256">tables</span><span class="op" id="7237262">[</span><span class="ident" id="7237263">name</span><span class="op" id="7237267">]</span>&nbsp;<span class="op" id="7237269">=</span>&nbsp;<span class="op" id="7237271">&amp;</span><span class="ident" id="7237272">table</span><span class="op" id="7237277">{</span><span class="ident" id="7237278">colname</span><span class="op" id="7237285">:</span>&nbsp;<span class="ident" id="7237287">columnNames</span><span class="op" id="7237298">,</span>&nbsp;<span class="ident" id="7237300">coltype</span><span class="op" id="7237307">:</span>&nbsp;<span class="ident" id="7237309">columnTypes</span><span class="op" id="7237320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237323">return</span>&nbsp;<span class="ident" id="7237330">nil</span><br>
<span class="lineno"></span><span class="op" id="7237334">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="7237337">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;db.mu&nbsp;lock&nbsp;held</span><br>
<span class="lineno"></span><span class="keyword" id="7237376">func</span>&nbsp;<span class="op" id="7237381">(</span><span class="ident" id="7237382">db</span>&nbsp;<span class="op" id="7237385">*</span><span class="ident" id="7237386">fakeDB</span><span class="op" id="7237392">)</span>&nbsp;<span class="ident" id="7237394">table</span><span class="op" id="7237399">(</span><span class="ident" id="7237400">table</span>&nbsp;<span class="builtintype" id="7237406">string</span><span class="op" id="7237412">)</span>&nbsp;<span class="op" id="7237414">(</span><span class="op" id="7237415">*</span><span class="ident" id="7237416">table</span><span class="op" id="7237421">,</span>&nbsp;<span class="builtintype" id="7237423">bool</span><span class="op" id="7237427">)</span>&nbsp;<span class="op" id="7237429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237432">if</span>&nbsp;<span class="ident" id="7237435">db</span><span class="op" id="7237437">.</span><span class="ident" id="7237438">tables</span>&nbsp;<span class="op" id="7237445">==</span>&nbsp;<span class="ident" id="7237448">nil</span>&nbsp;<span class="op" id="7237452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237456">return</span>&nbsp;<span class="ident" id="7237463">nil</span><span class="op" id="7237466">,</span>&nbsp;<span class="ident" id="7237468">false</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7237475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237478">t</span><span class="op" id="7237479">,</span>&nbsp;<span class="ident" id="7237481">ok</span>&nbsp;<span class="op" id="7237484">:=</span>&nbsp;<span class="ident" id="7237487">db</span><span class="op" id="7237489">.</span><span class="ident" id="7237490">tables</span><span class="op" id="7237496">[</span><span class="ident" id="7237497">table</span><span class="op" id="7237502">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237505">return</span>&nbsp;<span class="ident" id="7237512">t</span><span class="op" id="7237513">,</span>&nbsp;<span class="ident" id="7237515">ok</span><br>
<span class="lineno"></span><span class="op" id="7237518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="7237521">func</span>&nbsp;<span class="op" id="7237526">(</span><span class="ident" id="7237527">db</span>&nbsp;<span class="op" id="7237530">*</span><span class="ident" id="7237531">fakeDB</span><span class="op" id="7237537">)</span>&nbsp;<span class="ident" id="7237539">columnType</span><span class="op" id="7237549">(</span><span class="ident" id="7237550">table</span><span class="op" id="7237555">,</span>&nbsp;<span class="ident" id="7237557">column</span>&nbsp;<span class="builtintype" id="7237564">string</span><span class="op" id="7237570">)</span>&nbsp;<span class="op" id="7237572">(</span><span class="ident" id="7237573">typ</span>&nbsp;<span class="builtintype" id="7237577">string</span><span class="op" id="7237583">,</span>&nbsp;<span class="ident" id="7237585">ok</span>&nbsp;<span class="builtintype" id="7237588">bool</span><span class="op" id="7237592">)</span>&nbsp;<span class="op" id="7237594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237597">db</span><span class="op" id="7237599">.</span><span class="ident" id="7237600">mu</span><span class="op" id="7237602">.</span><span class="ident" id="7237603">Lock</span><span class="op" id="7237607">(</span><span class="op" id="7237608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237611">defer</span>&nbsp;<span class="ident" id="7237617">db</span><span class="op" id="7237619">.</span><span class="ident" id="7237620">mu</span><span class="op" id="7237622">.</span><span class="ident" id="7237623">Unlock</span><span class="op" id="7237629">(</span><span class="op" id="7237630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237633">t</span><span class="op" id="7237634">,</span>&nbsp;<span class="ident" id="7237636">ok</span>&nbsp;<span class="op" id="7237639">:=</span>&nbsp;<span class="ident" id="7237642">db</span><span class="op" id="7237644">.</span><span class="ident" id="7237645">table</span><span class="op" id="7237650">(</span><span class="ident" id="7237651">table</span><span class="op" id="7237656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237659">if</span>&nbsp;<span class="op" id="7237662">!</span><span class="ident" id="7237663">ok</span>&nbsp;<span class="op" id="7237666">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237670">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7237678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237681">for</span>&nbsp;<span class="ident" id="7237685">n</span><span class="op" id="7237686">,</span>&nbsp;<span class="ident" id="7237688">cname</span>&nbsp;<span class="op" id="7237694">:=</span>&nbsp;<span class="keyword" id="7237697">range</span>&nbsp;<span class="ident" id="7237703">t</span><span class="op" id="7237704">.</span><span class="ident" id="7237705">colname</span>&nbsp;<span class="op" id="7237713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237717">if</span>&nbsp;<span class="ident" id="7237720">cname</span>&nbsp;<span class="op" id="7237726">==</span>&nbsp;<span class="ident" id="7237729">column</span>&nbsp;<span class="op" id="7237736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237741">return</span>&nbsp;<span class="ident" id="7237748">t</span><span class="op" id="7237749">.</span><span class="ident" id="7237750">coltype</span><span class="op" id="7237757">[</span><span class="ident" id="7237758">n</span><span class="op" id="7237759">]</span><span class="op" id="7237760">,</span>&nbsp;<span class="ident" id="7237762">true</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7237769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7237772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237775">return</span>&nbsp;<span class="string" id="7237782">&#34;&#34;</span><span class="op" id="7237784">,</span>&nbsp;<span class="ident" id="7237786">false</span><br>
<span class="lineno"></span><span class="op" id="7237792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="keyword" id="7237795">func</span>&nbsp;<span class="op" id="7237800">(</span><span class="ident" id="7237801">c</span>&nbsp;<span class="op" id="7237803">*</span><span class="ident" id="7237804">fakeConn</span><span class="op" id="7237812">)</span>&nbsp;<span class="ident" id="7237814">isBad</span><span class="op" id="7237819">(</span><span class="op" id="7237820">)</span>&nbsp;<span class="builtintype" id="7237822">bool</span>&nbsp;<span class="op" id="7237827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7237830">//&nbsp;if&nbsp;not&nbsp;simulating&nbsp;bad&nbsp;conn,&nbsp;do&nbsp;nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237873">if</span>&nbsp;<span class="op" id="7237876">!</span><span class="ident" id="7237877">c</span><span class="op" id="7237878">.</span><span class="ident" id="7237879">bad</span>&nbsp;<span class="op" id="7237883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237887">return</span>&nbsp;<span class="ident" id="7237894">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7237901">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7237904">//&nbsp;alternate&nbsp;between&nbsp;bad&nbsp;conn&nbsp;and&nbsp;not&nbsp;bad&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237952">c</span><span class="op" id="7237953">.</span><span class="ident" id="7237954">db</span><span class="op" id="7237956">.</span><span class="ident" id="7237957">badConn</span>&nbsp;<span class="op" id="7237965">=</span>&nbsp;<span class="op" id="7237967">!</span><span class="ident" id="7237968">c</span><span class="op" id="7237969">.</span><span class="ident" id="7237970">db</span><span class="op" id="7237972">.</span><span class="ident" id="7237973">badConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237982">return</span>&nbsp;<span class="ident" id="7237989">c</span><span class="op" id="7237990">.</span><span class="ident" id="7237991">db</span><span class="op" id="7237993">.</span><span class="ident" id="7237994">badConn</span><br>
<span class="lineno"></span><span class="op" id="7238002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="7238005">func</span>&nbsp;<span class="op" id="7238010">(</span><span class="ident" id="7238011">c</span>&nbsp;<span class="op" id="7238013">*</span><span class="ident" id="7238014">fakeConn</span><span class="op" id="7238022">)</span>&nbsp;<span class="ident" id="7238024">Begin</span><span class="op" id="7238029">(</span><span class="op" id="7238030">)</span>&nbsp;<span class="op" id="7238032">(</span><span class="ident" id="7238033">driver</span><span class="op" id="7238039">.</span><span class="ident" id="7238040">Tx</span><span class="op" id="7238042">,</span>&nbsp;<span class="builtintype" id="7238044">error</span><span class="op" id="7238049">)</span>&nbsp;<span class="op" id="7238051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238054">if</span>&nbsp;<span class="ident" id="7238057">c</span><span class="op" id="7238058">.</span><span class="ident" id="7238059">isBad</span><span class="op" id="7238064">(</span><span class="op" id="7238065">)</span>&nbsp;<span class="op" id="7238067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238071">return</span>&nbsp;<span class="ident" id="7238078">nil</span><span class="op" id="7238081">,</span>&nbsp;<span class="ident" id="7238083">driver</span><span class="op" id="7238089">.</span><span class="ident" id="7238090">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7238102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238105">if</span>&nbsp;<span class="ident" id="7238108">c</span><span class="op" id="7238109">.</span><span class="ident" id="7238110">currTx</span>&nbsp;<span class="op" id="7238117">!=</span>&nbsp;<span class="ident" id="7238120">nil</span>&nbsp;<span class="op" id="7238124">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238128">return</span>&nbsp;<span class="ident" id="7238135">nil</span><span class="op" id="7238138">,</span>&nbsp;<span class="ident" id="7238140">errors</span><span class="op" id="7238146">.</span><span class="ident" id="7238147">New</span><span class="op" id="7238150">(</span><span class="string" id="7238151">&#34;already&nbsp;in&nbsp;a&nbsp;transaction&#34;</span><span class="op" id="7238177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7238180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238183">c</span><span class="op" id="7238184">.</span><span class="ident" id="7238185">currTx</span>&nbsp;<span class="op" id="7238192">=</span>&nbsp;<span class="op" id="7238194">&amp;</span><span class="ident" id="7238195">fakeTx</span><span class="op" id="7238201">{</span><span class="ident" id="7238202">c</span><span class="op" id="7238203">:</span>&nbsp;<span class="ident" id="7238205">c</span><span class="op" id="7238206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238209">return</span>&nbsp;<span class="ident" id="7238216">c</span><span class="op" id="7238217">.</span><span class="ident" id="7238218">currTx</span><span class="op" id="7238224">,</span>&nbsp;<span class="ident" id="7238226">nil</span><br>
<span class="lineno"></span><span class="op" id="7238230">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="7238233">var</span>&nbsp;<span class="ident" id="7238237">hookPostCloseConn</span>&nbsp;<span class="keyword" id="7238255">struct</span>&nbsp;<span class="op" id="7238262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238265">sync</span><span class="op" id="7238269">.</span><span class="ident" id="7238270">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238277">fn</span>&nbsp;<span class="keyword" id="7238280">func</span><span class="op" id="7238284">(</span><span class="op" id="7238285">*</span><span class="ident" id="7238286">fakeConn</span><span class="op" id="7238294">,</span>&nbsp;<span class="builtintype" id="7238296">error</span><span class="op" id="7238301">)</span><br>
<span class="lineno"></span><span class="op" id="7238303">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="7238306">func</span>&nbsp;<span class="ident" id="7238311">setHookpostCloseConn</span><span class="op" id="7238331">(</span><span class="ident" id="7238332">fn</span>&nbsp;<span class="keyword" id="7238335">func</span><span class="op" id="7238339">(</span><span class="op" id="7238340">*</span><span class="ident" id="7238341">fakeConn</span><span class="op" id="7238349">,</span>&nbsp;<span class="builtintype" id="7238351">error</span><span class="op" id="7238356">)</span><span class="op" id="7238357">)</span>&nbsp;<span class="op" id="7238359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238362">hookPostCloseConn</span><span class="op" id="7238379">.</span><span class="ident" id="7238380">Lock</span><span class="op" id="7238384">(</span><span class="op" id="7238385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238388">defer</span>&nbsp;<span class="ident" id="7238394">hookPostCloseConn</span><span class="op" id="7238411">.</span><span class="ident" id="7238412">Unlock</span><span class="op" id="7238418">(</span><span class="op" id="7238419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238422">hookPostCloseConn</span><span class="op" id="7238439">.</span><span class="ident" id="7238440">fn</span>&nbsp;<span class="op" id="7238443">=</span>&nbsp;<span class="ident" id="7238445">fn</span><br>
<span class="lineno">275</span><span class="op" id="7238448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7238451">var</span>&nbsp;<span class="ident" id="7238455">testStrictClose</span>&nbsp;<span class="op" id="7238471">*</span><span class="ident" id="7238472">testing</span><span class="op" id="7238479">.</span><span class="ident" id="7238480">T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7238483">//&nbsp;setStrictFakeConnClose&nbsp;sets&nbsp;the&nbsp;t&nbsp;to&nbsp;Errorf&nbsp;on&nbsp;when&nbsp;fakeConn.Close</span><br>
<span class="lineno">280</span><span class="comment" id="7238553">//&nbsp;fails&nbsp;to&nbsp;close.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;check&nbsp;is&nbsp;disabled.</span><br>
<span class="lineno"></span><span class="keyword" id="7238603">func</span>&nbsp;<span class="ident" id="7238608">setStrictFakeConnClose</span><span class="op" id="7238630">(</span><span class="ident" id="7238631">t</span>&nbsp;<span class="op" id="7238633">*</span><span class="ident" id="7238634">testing</span><span class="op" id="7238641">.</span><span class="ident" id="7238642">T</span><span class="op" id="7238643">)</span>&nbsp;<span class="op" id="7238645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238648">testStrictClose</span>&nbsp;<span class="op" id="7238664">=</span>&nbsp;<span class="ident" id="7238666">t</span><br>
<span class="lineno"></span><span class="op" id="7238668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="7238671">func</span>&nbsp;<span class="op" id="7238676">(</span><span class="ident" id="7238677">c</span>&nbsp;<span class="op" id="7238679">*</span><span class="ident" id="7238680">fakeConn</span><span class="op" id="7238688">)</span>&nbsp;<span class="ident" id="7238690">Close</span><span class="op" id="7238695">(</span><span class="op" id="7238696">)</span>&nbsp;<span class="op" id="7238698">(</span><span class="ident" id="7238699">err</span>&nbsp;<span class="builtintype" id="7238703">error</span><span class="op" id="7238708">)</span>&nbsp;<span class="op" id="7238710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238713">drv</span>&nbsp;<span class="op" id="7238717">:=</span>&nbsp;<span class="ident" id="7238720">fdriver</span><span class="op" id="7238727">.</span><span class="op" id="7238728">(</span><span class="op" id="7238729">*</span><span class="ident" id="7238730">fakeDriver</span><span class="op" id="7238740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238743">defer</span>&nbsp;<span class="keyword" id="7238749">func</span><span class="op" id="7238753">(</span><span class="op" id="7238754">)</span>&nbsp;<span class="op" id="7238756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238760">if</span>&nbsp;<span class="ident" id="7238763">err</span>&nbsp;<span class="op" id="7238767">!=</span>&nbsp;<span class="ident" id="7238770">nil</span>&nbsp;<span class="op" id="7238774">&amp;&amp;</span>&nbsp;<span class="ident" id="7238777">testStrictClose</span>&nbsp;<span class="op" id="7238793">!=</span>&nbsp;<span class="ident" id="7238796">nil</span>&nbsp;<span class="op" id="7238800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238805">testStrictClose</span><span class="op" id="7238820">.</span><span class="ident" id="7238821">Errorf</span><span class="op" id="7238827">(</span><span class="string" id="7238828">&#34;failed&nbsp;to&nbsp;close&nbsp;a&nbsp;test&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7238865">,</span>&nbsp;<span class="ident" id="7238867">err</span><span class="op" id="7238870">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7238874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238878">hookPostCloseConn</span><span class="op" id="7238895">.</span><span class="ident" id="7238896">Lock</span><span class="op" id="7238900">(</span><span class="op" id="7238901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238905">fn</span>&nbsp;<span class="op" id="7238908">:=</span>&nbsp;<span class="ident" id="7238911">hookPostCloseConn</span><span class="op" id="7238928">.</span><span class="ident" id="7238929">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238934">hookPostCloseConn</span><span class="op" id="7238951">.</span><span class="ident" id="7238952">Unlock</span><span class="op" id="7238958">(</span><span class="op" id="7238959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238963">if</span>&nbsp;<span class="ident" id="7238966">fn</span>&nbsp;<span class="op" id="7238969">!=</span>&nbsp;<span class="ident" id="7238972">nil</span>&nbsp;<span class="op" id="7238976">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238981">fn</span><span class="op" id="7238983">(</span><span class="ident" id="7238984">c</span><span class="op" id="7238985">,</span>&nbsp;<span class="ident" id="7238987">err</span><span class="op" id="7238990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7238994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238998">if</span>&nbsp;<span class="ident" id="7239001">err</span>&nbsp;<span class="op" id="7239005">==</span>&nbsp;<span class="ident" id="7239008">nil</span>&nbsp;<span class="op" id="7239012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239017">drv</span><span class="op" id="7239020">.</span><span class="ident" id="7239021">mu</span><span class="op" id="7239023">.</span><span class="ident" id="7239024">Lock</span><span class="op" id="7239028">(</span><span class="op" id="7239029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239034">drv</span><span class="op" id="7239037">.</span><span class="ident" id="7239038">closeCount</span><span class="op" id="7239048">++</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239054">drv</span><span class="op" id="7239057">.</span><span class="ident" id="7239058">mu</span><span class="op" id="7239060">.</span><span class="ident" id="7239061">Unlock</span><span class="op" id="7239067">(</span><span class="op" id="7239068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7239072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7239075">}</span><span class="op" id="7239076">(</span><span class="op" id="7239077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239080">if</span>&nbsp;<span class="ident" id="7239083">c</span><span class="op" id="7239084">.</span><span class="ident" id="7239085">currTx</span>&nbsp;<span class="op" id="7239092">!=</span>&nbsp;<span class="ident" id="7239095">nil</span>&nbsp;<span class="op" id="7239099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239103">return</span>&nbsp;<span class="ident" id="7239110">errors</span><span class="op" id="7239116">.</span><span class="ident" id="7239117">New</span><span class="op" id="7239120">(</span><span class="string" id="7239121">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;in&nbsp;a&nbsp;Transaction&#34;</span><span class="op" id="7239161">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7239164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239167">if</span>&nbsp;<span class="ident" id="7239170">c</span><span class="op" id="7239171">.</span><span class="ident" id="7239172">db</span>&nbsp;<span class="op" id="7239175">==</span>&nbsp;<span class="ident" id="7239178">nil</span>&nbsp;<span class="op" id="7239182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239186">return</span>&nbsp;<span class="ident" id="7239193">errors</span><span class="op" id="7239199">.</span><span class="ident" id="7239200">New</span><span class="op" id="7239203">(</span><span class="string" id="7239204">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;already&nbsp;closed&#34;</span><span class="op" id="7239242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7239245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239248">if</span>&nbsp;<span class="ident" id="7239251">c</span><span class="op" id="7239252">.</span><span class="ident" id="7239253">stmtsMade</span>&nbsp;<span class="op" id="7239263">&gt;</span>&nbsp;<span class="ident" id="7239265">c</span><span class="op" id="7239266">.</span><span class="ident" id="7239267">stmtsClosed</span>&nbsp;<span class="op" id="7239279">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239283">return</span>&nbsp;<span class="ident" id="7239290">errors</span><span class="op" id="7239296">.</span><span class="ident" id="7239297">New</span><span class="op" id="7239300">(</span><span class="string" id="7239301">&#34;can&#39;t&nbsp;close;&nbsp;dangling&nbsp;statement(s)&#34;</span><span class="op" id="7239337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7239340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239343">c</span><span class="op" id="7239344">.</span><span class="ident" id="7239345">db</span>&nbsp;<span class="op" id="7239348">=</span>&nbsp;<span class="ident" id="7239350">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239355">return</span>&nbsp;<span class="ident" id="7239362">nil</span><br>
<span class="lineno"></span><span class="op" id="7239366">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="7239369">func</span>&nbsp;<span class="ident" id="7239374">checkSubsetTypes</span><span class="op" id="7239390">(</span><span class="ident" id="7239391">args</span>&nbsp;<span class="op" id="7239396">[</span><span class="op" id="7239397">]</span><span class="ident" id="7239398">driver</span><span class="op" id="7239404">.</span><span class="ident" id="7239405">Value</span><span class="op" id="7239410">)</span>&nbsp;<span class="builtintype" id="7239412">error</span>&nbsp;<span class="op" id="7239418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239421">for</span>&nbsp;<span class="ident" id="7239425">n</span><span class="op" id="7239426">,</span>&nbsp;<span class="ident" id="7239428">arg</span>&nbsp;<span class="op" id="7239432">:=</span>&nbsp;<span class="keyword" id="7239435">range</span>&nbsp;<span class="ident" id="7239441">args</span>&nbsp;<span class="op" id="7239446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239450">switch</span>&nbsp;<span class="ident" id="7239457">arg</span><span class="op" id="7239460">.</span><span class="op" id="7239461">(</span><span class="keyword" id="7239462">type</span><span class="op" id="7239466">)</span>&nbsp;<span class="op" id="7239468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239472">case</span>&nbsp;<span class="ident" id="7239477">int64</span><span class="op" id="7239482">,</span>&nbsp;<span class="builtintype" id="7239484">float64</span><span class="op" id="7239491">,</span>&nbsp;<span class="builtintype" id="7239493">bool</span><span class="op" id="7239497">,</span>&nbsp;<span class="ident" id="7239499">nil</span><span class="op" id="7239502">,</span>&nbsp;<span class="op" id="7239504">[</span><span class="op" id="7239505">]</span><span class="builtintype" id="7239506">byte</span><span class="op" id="7239510">,</span>&nbsp;<span class="builtintype" id="7239512">string</span><span class="op" id="7239518">,</span>&nbsp;<span class="ident" id="7239520">time</span><span class="op" id="7239524">.</span><span class="ident" id="7239525">Time</span><span class="op" id="7239529">:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239533">default</span><span class="op" id="7239540">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239545">return</span>&nbsp;<span class="ident" id="7239552">fmt</span><span class="op" id="7239555">.</span><span class="ident" id="7239556">Errorf</span><span class="op" id="7239562">(</span><span class="string" id="7239563">&#34;fakedb_test:&nbsp;invalid&nbsp;argument&nbsp;#%d:&nbsp;%v,&nbsp;type&nbsp;%T&#34;</span><span class="op" id="7239611">,</span>&nbsp;<span class="ident" id="7239613">n</span><span class="op" id="7239614">+</span><span class="num" id="7239615">1</span><span class="op" id="7239616">,</span>&nbsp;<span class="ident" id="7239618">arg</span><span class="op" id="7239621">,</span>&nbsp;<span class="ident" id="7239623">arg</span><span class="op" id="7239626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7239630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7239633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239636">return</span>&nbsp;<span class="ident" id="7239643">nil</span><br>
<span class="lineno">325</span><span class="op" id="7239647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7239650">func</span>&nbsp;<span class="op" id="7239655">(</span><span class="ident" id="7239656">c</span>&nbsp;<span class="op" id="7239658">*</span><span class="ident" id="7239659">fakeConn</span><span class="op" id="7239667">)</span>&nbsp;<span class="ident" id="7239669">Exec</span><span class="op" id="7239673">(</span><span class="ident" id="7239674">query</span>&nbsp;<span class="builtintype" id="7239680">string</span><span class="op" id="7239686">,</span>&nbsp;<span class="ident" id="7239688">args</span>&nbsp;<span class="op" id="7239693">[</span><span class="op" id="7239694">]</span><span class="ident" id="7239695">driver</span><span class="op" id="7239701">.</span><span class="ident" id="7239702">Value</span><span class="op" id="7239707">)</span>&nbsp;<span class="op" id="7239709">(</span><span class="ident" id="7239710">driver</span><span class="op" id="7239716">.</span><span class="ident" id="7239717">Result</span><span class="op" id="7239723">,</span>&nbsp;<span class="builtintype" id="7239725">error</span><span class="op" id="7239730">)</span>&nbsp;<span class="op" id="7239732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7239735">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7239796">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7239857">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7239916">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239943">err</span>&nbsp;<span class="op" id="7239947">:=</span>&nbsp;<span class="ident" id="7239950">checkSubsetTypes</span><span class="op" id="7239966">(</span><span class="ident" id="7239967">args</span><span class="op" id="7239971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239974">if</span>&nbsp;<span class="ident" id="7239977">err</span>&nbsp;<span class="op" id="7239981">!=</span>&nbsp;<span class="ident" id="7239984">nil</span>&nbsp;<span class="op" id="7239988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239992">return</span>&nbsp;<span class="ident" id="7239999">nil</span><span class="op" id="7240002">,</span>&nbsp;<span class="ident" id="7240004">err</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7240009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7240012">return</span>&nbsp;<span class="ident" id="7240019">nil</span><span class="op" id="7240022">,</span>&nbsp;<span class="ident" id="7240024">driver</span><span class="op" id="7240030">.</span><span class="ident" id="7240031">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="7240039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7240042">func</span>&nbsp;<span class="op" id="7240047">(</span><span class="ident" id="7240048">c</span>&nbsp;<span class="op" id="7240050">*</span><span class="ident" id="7240051">fakeConn</span><span class="op" id="7240059">)</span>&nbsp;<span class="ident" id="7240061">Query</span><span class="op" id="7240066">(</span><span class="ident" id="7240067">query</span>&nbsp;<span class="builtintype" id="7240073">string</span><span class="op" id="7240079">,</span>&nbsp;<span class="ident" id="7240081">args</span>&nbsp;<span class="op" id="7240086">[</span><span class="op" id="7240087">]</span><span class="ident" id="7240088">driver</span><span class="op" id="7240094">.</span><span class="ident" id="7240095">Value</span><span class="op" id="7240100">)</span>&nbsp;<span class="op" id="7240102">(</span><span class="ident" id="7240103">driver</span><span class="op" id="7240109">.</span><span class="ident" id="7240110">Rows</span><span class="op" id="7240114">,</span>&nbsp;<span class="builtintype" id="7240116">error</span><span class="op" id="7240121">)</span>&nbsp;<span class="op" id="7240123">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7240126">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7240187">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7240248">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7240307">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240334">err</span>&nbsp;<span class="op" id="7240338">:=</span>&nbsp;<span class="ident" id="7240341">checkSubsetTypes</span><span class="op" id="7240357">(</span><span class="ident" id="7240358">args</span><span class="op" id="7240362">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7240365">if</span>&nbsp;<span class="ident" id="7240368">err</span>&nbsp;<span class="op" id="7240372">!=</span>&nbsp;<span class="ident" id="7240375">nil</span>&nbsp;<span class="op" id="7240379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7240383">return</span>&nbsp;<span class="ident" id="7240390">nil</span><span class="op" id="7240393">,</span>&nbsp;<span class="ident" id="7240395">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7240400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7240403">return</span>&nbsp;<span class="ident" id="7240410">nil</span><span class="op" id="7240413">,</span>&nbsp;<span class="ident" id="7240415">driver</span><span class="op" id="7240421">.</span><span class="ident" id="7240422">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="7240430">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="7240433">func</span>&nbsp;<span class="ident" id="7240438">errf</span><span class="op" id="7240442">(</span><span class="ident" id="7240443">msg</span>&nbsp;<span class="builtintype" id="7240447">string</span><span class="op" id="7240453">,</span>&nbsp;<span class="ident" id="7240455">args</span>&nbsp;<span class="op" id="7240460">...</span><span class="keyword" id="7240463">interface</span><span class="op" id="7240472">{</span><span class="op" id="7240473">}</span><span class="op" id="7240474">)</span>&nbsp;<span class="builtintype" id="7240476">error</span>&nbsp;<span class="op" id="7240482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7240485">return</span>&nbsp;<span class="ident" id="7240492">errors</span><span class="op" id="7240498">.</span><span class="ident" id="7240499">New</span><span class="op" id="7240502">(</span><span class="string" id="7240503">&#34;fakedb:&nbsp;&#34;</span>&nbsp;<span class="op" id="7240514">+</span>&nbsp;<span class="ident" id="7240516">fmt</span><span class="op" id="7240519">.</span><span class="ident" id="7240520">Sprintf</span><span class="op" id="7240527">(</span><span class="ident" id="7240528">msg</span><span class="op" id="7240531">,</span>&nbsp;<span class="ident" id="7240533">args</span><span class="op" id="7240537">...</span><span class="op" id="7240540">)</span><span class="op" id="7240541">)</span><br>
<span class="lineno"></span><span class="op" id="7240543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="7240546">//&nbsp;parts&nbsp;are&nbsp;table|selectCol1,selectCol2|whereCol=?,whereCol2=?</span><br>
<span class="lineno"></span><span class="comment" id="7240610">//&nbsp;(note&nbsp;that&nbsp;where&nbsp;columns&nbsp;must&nbsp;always&nbsp;contain&nbsp;?&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="7240667">//&nbsp;&nbsp;just&nbsp;a&nbsp;limitation&nbsp;for&nbsp;fakedb)</span><br>
<span class="lineno"></span><span class="keyword" id="7240701">func</span>&nbsp;<span class="op" id="7240706">(</span><span class="ident" id="7240707">c</span>&nbsp;<span class="op" id="7240709">*</span><span class="ident" id="7240710">fakeConn</span><span class="op" id="7240718">)</span>&nbsp;<span class="ident" id="7240720">prepareSelect</span><span class="op" id="7240733">(</span><span class="ident" id="7240734">stmt</span>&nbsp;<span class="op" id="7240739">*</span><span class="ident" id="7240740">fakeStmt</span><span class="op" id="7240748">,</span>&nbsp;<span class="ident" id="7240750">parts</span>&nbsp;<span class="op" id="7240756">[</span><span class="op" id="7240757">]</span><span class="builtintype" id="7240758">string</span><span class="op" id="7240764">)</span>&nbsp;<span class="op" id="7240766">(</span><span class="ident" id="7240767">driver</span><span class="op" id="7240773">.</span><span class="ident" id="7240774">Stmt</span><span class="op" id="7240778">,</span>&nbsp;<span class="builtintype" id="7240780">error</span><span class="op" id="7240785">)</span>&nbsp;<span class="op" id="7240787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7240790">if</span>&nbsp;<span class="builtinfunc" id="7240793">len</span><span class="op" id="7240796">(</span><span class="ident" id="7240797">parts</span><span class="op" id="7240802">)</span>&nbsp;<span class="op" id="7240804">!=</span>&nbsp;<span class="num" id="7240807">3</span>&nbsp;<span class="op" id="7240809">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240813">stmt</span><span class="op" id="7240817">.</span><span class="ident" id="7240818">Close</span><span class="op" id="7240823">(</span><span class="op" id="7240824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7240828">return</span>&nbsp;<span class="ident" id="7240835">nil</span><span class="op" id="7240838">,</span>&nbsp;<span class="ident" id="7240840">errf</span><span class="op" id="7240844">(</span><span class="string" id="7240845">&#34;invalid&nbsp;SELECT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;3&#34;</span><span class="op" id="7240890">,</span>&nbsp;<span class="builtinfunc" id="7240892">len</span><span class="op" id="7240895">(</span><span class="ident" id="7240896">parts</span><span class="op" id="7240901">)</span><span class="op" id="7240902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7240905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240908">stmt</span><span class="op" id="7240912">.</span><span class="ident" id="7240913">table</span>&nbsp;<span class="op" id="7240919">=</span>&nbsp;<span class="ident" id="7240921">parts</span><span class="op" id="7240926">[</span><span class="num" id="7240927">0</span><span class="op" id="7240928">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240931">stmt</span><span class="op" id="7240935">.</span><span class="ident" id="7240936">colName</span>&nbsp;<span class="op" id="7240944">=</span>&nbsp;<span class="ident" id="7240946">strings</span><span class="op" id="7240953">.</span><span class="ident" id="7240954">Split</span><span class="op" id="7240959">(</span><span class="ident" id="7240960">parts</span><span class="op" id="7240965">[</span><span class="num" id="7240966">1</span><span class="op" id="7240967">]</span><span class="op" id="7240968">,</span>&nbsp;<span class="string" id="7240970">&#34;,&#34;</span><span class="op" id="7240973">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7240976">for</span>&nbsp;<span class="ident" id="7240980">n</span><span class="op" id="7240981">,</span>&nbsp;<span class="ident" id="7240983">colspec</span>&nbsp;<span class="op" id="7240991">:=</span>&nbsp;<span class="keyword" id="7240994">range</span>&nbsp;<span class="ident" id="7241000">strings</span><span class="op" id="7241007">.</span><span class="ident" id="7241008">Split</span><span class="op" id="7241013">(</span><span class="ident" id="7241014">parts</span><span class="op" id="7241019">[</span><span class="num" id="7241020">2</span><span class="op" id="7241021">]</span><span class="op" id="7241022">,</span>&nbsp;<span class="string" id="7241024">&#34;,&#34;</span><span class="op" id="7241027">)</span>&nbsp;<span class="op" id="7241029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7241033">if</span>&nbsp;<span class="ident" id="7241036">colspec</span>&nbsp;<span class="op" id="7241044">==</span>&nbsp;<span class="string" id="7241047">&#34;&#34;</span>&nbsp;<span class="op" id="7241050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7241055">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7241066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7241070">nameVal</span>&nbsp;<span class="op" id="7241078">:=</span>&nbsp;<span class="ident" id="7241081">strings</span><span class="op" id="7241088">.</span><span class="ident" id="7241089">Split</span><span class="op" id="7241094">(</span><span class="ident" id="7241095">colspec</span><span class="op" id="7241102">,</span>&nbsp;<span class="string" id="7241104">&#34;=&#34;</span><span class="op" id="7241107">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7241111">if</span>&nbsp;<span class="builtinfunc" id="7241114">len</span><span class="op" id="7241117">(</span><span class="ident" id="7241118">nameVal</span><span class="op" id="7241125">)</span>&nbsp;<span class="op" id="7241127">!=</span>&nbsp;<span class="num" id="7241130">2</span>&nbsp;<span class="op" id="7241132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7241137">stmt</span><span class="op" id="7241141">.</span><span class="ident" id="7241142">Close</span><span class="op" id="7241147">(</span><span class="op" id="7241148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7241153">return</span>&nbsp;<span class="ident" id="7241160">nil</span><span class="op" id="7241163">,</span>&nbsp;<span class="ident" id="7241165">errf</span><span class="op" id="7241169">(</span><span class="string" id="7241170">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7241231">,</span>&nbsp;<span class="ident" id="7241233">stmt</span><span class="op" id="7241237">.</span><span class="ident" id="7241238">table</span><span class="op" id="7241243">,</span>&nbsp;<span class="ident" id="7241245">colspec</span><span class="op" id="7241252">,</span>&nbsp;<span class="ident" id="7241254">n</span><span class="op" id="7241255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7241259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7241263">column</span><span class="op" id="7241269">,</span>&nbsp;<span class="ident" id="7241271">value</span>&nbsp;<span class="op" id="7241277">:=</span>&nbsp;<span class="ident" id="7241280">nameVal</span><span class="op" id="7241287">[</span><span class="num" id="7241288">0</span><span class="op" id="7241289">]</span><span class="op" id="7241290">,</span>&nbsp;<span class="ident" id="7241292">nameVal</span><span class="op" id="7241299">[</span><span class="num" id="7241300">1</span><span class="op" id="7241301">]</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7241305">_</span><span class="op" id="7241306">,</span>&nbsp;<span class="ident" id="7241308">ok</span>&nbsp;<span class="op" id="7241311">:=</span>&nbsp;<span class="ident" id="7241314">c</span><span class="op" id="7241315">.</span><span class="ident" id="7241316">db</span><span class="op" id="7241318">.</span><span class="ident" id="7241319">columnType</span><span class="op" id="7241329">(</span><span class="ident" id="7241330">stmt</span><span class="op" id="7241334">.</span><span class="ident" id="7241335">table</span><span class="op" id="7241340">,</span>&nbsp;<span class="ident" id="7241342">column</span><span class="op" id="7241348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7241352">if</span>&nbsp;<span class="op" id="7241355">!</span><span class="ident" id="7241356">ok</span>&nbsp;<span class="op" id="7241359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7241364">stmt</span><span class="op" id="7241368">.</span><span class="ident" id="7241369">Close</span><span class="op" id="7241374">(</span><span class="op" id="7241375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7241380">return</span>&nbsp;<span class="ident" id="7241387">nil</span><span class="op" id="7241390">,</span>&nbsp;<span class="ident" id="7241392">errf</span><span class="op" id="7241396">(</span><span class="string" id="7241397">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7241451">,</span>&nbsp;<span class="ident" id="7241453">stmt</span><span class="op" id="7241457">.</span><span class="ident" id="7241458">table</span><span class="op" id="7241463">,</span>&nbsp;<span class="ident" id="7241465">column</span><span class="op" id="7241471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7241475">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7241479">if</span>&nbsp;<span class="ident" id="7241482">value</span>&nbsp;<span class="op" id="7241488">!=</span>&nbsp;<span class="string" id="7241491">&#34;?&#34;</span>&nbsp;<span class="op" id="7241495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7241500">stmt</span><span class="op" id="7241504">.</span><span class="ident" id="7241505">Close</span><span class="op" id="7241510">(</span><span class="op" id="7241511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7241516">return</span>&nbsp;<span class="ident" id="7241523">nil</span><span class="op" id="7241526">,</span>&nbsp;<span class="ident" id="7241528">errf</span><span class="op" id="7241532">(</span><span class="string" id="7241533">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;pre-bound&nbsp;value&nbsp;for&nbsp;where&nbsp;column&nbsp;%q;&nbsp;need&nbsp;a&nbsp;question&nbsp;mark&#34;</span><span class="op" id="7241615">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7241621">stmt</span><span class="op" id="7241625">.</span><span class="ident" id="7241626">table</span><span class="op" id="7241631">,</span>&nbsp;<span class="ident" id="7241633">column</span><span class="op" id="7241639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7241643">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7241647">stmt</span><span class="op" id="7241651">.</span><span class="ident" id="7241652">whereCol</span>&nbsp;<span class="op" id="7241661">=</span>&nbsp;<span class="builtinfunc" id="7241663">append</span><span class="op" id="7241669">(</span><span class="ident" id="7241670">stmt</span><span class="op" id="7241674">.</span><span class="ident" id="7241675">whereCol</span><span class="op" id="7241683">,</span>&nbsp;<span class="ident" id="7241685">column</span><span class="op" id="7241691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7241695">stmt</span><span class="op" id="7241699">.</span><span class="ident" id="7241700">placeholders</span><span class="op" id="7241712">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7241716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7241719">return</span>&nbsp;<span class="ident" id="7241726">stmt</span><span class="op" id="7241730">,</span>&nbsp;<span class="ident" id="7241732">nil</span><br>
<span class="lineno"></span><span class="op" id="7241736">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span><span class="comment" id="7241739">//&nbsp;parts&nbsp;are&nbsp;table|col=type,col2=type2</span><br>
<span class="lineno"></span><span class="keyword" id="7241778">func</span>&nbsp;<span class="op" id="7241783">(</span><span class="ident" id="7241784">c</span>&nbsp;<span class="op" id="7241786">*</span><span class="ident" id="7241787">fakeConn</span><span class="op" id="7241795">)</span>&nbsp;<span class="ident" id="7241797">prepareCreate</span><span class="op" id="7241810">(</span><span class="ident" id="7241811">stmt</span>&nbsp;<span class="op" id="7241816">*</span><span class="ident" id="7241817">fakeStmt</span><span class="op" id="7241825">,</span>&nbsp;<span class="ident" id="7241827">parts</span>&nbsp;<span class="op" id="7241833">[</span><span class="op" id="7241834">]</span><span class="builtintype" id="7241835">string</span><span class="op" id="7241841">)</span>&nbsp;<span class="op" id="7241843">(</span><span class="ident" id="7241844">driver</span><span class="op" id="7241850">.</span><span class="ident" id="7241851">Stmt</span><span class="op" id="7241855">,</span>&nbsp;<span class="builtintype" id="7241857">error</span><span class="op" id="7241862">)</span>&nbsp;<span class="op" id="7241864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7241867">if</span>&nbsp;<span class="builtinfunc" id="7241870">len</span><span class="op" id="7241873">(</span><span class="ident" id="7241874">parts</span><span class="op" id="7241879">)</span>&nbsp;<span class="op" id="7241881">!=</span>&nbsp;<span class="num" id="7241884">2</span>&nbsp;<span class="op" id="7241886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7241890">stmt</span><span class="op" id="7241894">.</span><span class="ident" id="7241895">Close</span><span class="op" id="7241900">(</span><span class="op" id="7241901">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7241905">return</span>&nbsp;<span class="ident" id="7241912">nil</span><span class="op" id="7241915">,</span>&nbsp;<span class="ident" id="7241917">errf</span><span class="op" id="7241921">(</span><span class="string" id="7241922">&#34;invalid&nbsp;CREATE&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="7241967">,</span>&nbsp;<span class="builtinfunc" id="7241969">len</span><span class="op" id="7241972">(</span><span class="ident" id="7241973">parts</span><span class="op" id="7241978">)</span><span class="op" id="7241979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7241982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7241985">stmt</span><span class="op" id="7241989">.</span><span class="ident" id="7241990">table</span>&nbsp;<span class="op" id="7241996">=</span>&nbsp;<span class="ident" id="7241998">parts</span><span class="op" id="7242003">[</span><span class="num" id="7242004">0</span><span class="op" id="7242005">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7242008">for</span>&nbsp;<span class="ident" id="7242012">n</span><span class="op" id="7242013">,</span>&nbsp;<span class="ident" id="7242015">colspec</span>&nbsp;<span class="op" id="7242023">:=</span>&nbsp;<span class="keyword" id="7242026">range</span>&nbsp;<span class="ident" id="7242032">strings</span><span class="op" id="7242039">.</span><span class="ident" id="7242040">Split</span><span class="op" id="7242045">(</span><span class="ident" id="7242046">parts</span><span class="op" id="7242051">[</span><span class="num" id="7242052">1</span><span class="op" id="7242053">]</span><span class="op" id="7242054">,</span>&nbsp;<span class="string" id="7242056">&#34;,&#34;</span><span class="op" id="7242059">)</span>&nbsp;<span class="op" id="7242061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7242065">nameType</span>&nbsp;<span class="op" id="7242074">:=</span>&nbsp;<span class="ident" id="7242077">strings</span><span class="op" id="7242084">.</span><span class="ident" id="7242085">Split</span><span class="op" id="7242090">(</span><span class="ident" id="7242091">colspec</span><span class="op" id="7242098">,</span>&nbsp;<span class="string" id="7242100">&#34;=&#34;</span><span class="op" id="7242103">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7242107">if</span>&nbsp;<span class="builtinfunc" id="7242110">len</span><span class="op" id="7242113">(</span><span class="ident" id="7242114">nameType</span><span class="op" id="7242122">)</span>&nbsp;<span class="op" id="7242124">!=</span>&nbsp;<span class="num" id="7242127">2</span>&nbsp;<span class="op" id="7242129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7242134">stmt</span><span class="op" id="7242138">.</span><span class="ident" id="7242139">Close</span><span class="op" id="7242144">(</span><span class="op" id="7242145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7242150">return</span>&nbsp;<span class="ident" id="7242157">nil</span><span class="op" id="7242160">,</span>&nbsp;<span class="ident" id="7242162">errf</span><span class="op" id="7242166">(</span><span class="string" id="7242167">&#34;CREATE&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7242225">,</span>&nbsp;<span class="ident" id="7242227">stmt</span><span class="op" id="7242231">.</span><span class="ident" id="7242232">table</span><span class="op" id="7242237">,</span>&nbsp;<span class="ident" id="7242239">colspec</span><span class="op" id="7242246">,</span>&nbsp;<span class="ident" id="7242248">n</span><span class="op" id="7242249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7242253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7242257">stmt</span><span class="op" id="7242261">.</span><span class="ident" id="7242262">colName</span>&nbsp;<span class="op" id="7242270">=</span>&nbsp;<span class="builtinfunc" id="7242272">append</span><span class="op" id="7242278">(</span><span class="ident" id="7242279">stmt</span><span class="op" id="7242283">.</span><span class="ident" id="7242284">colName</span><span class="op" id="7242291">,</span>&nbsp;<span class="ident" id="7242293">nameType</span><span class="op" id="7242301">[</span><span class="num" id="7242302">0</span><span class="op" id="7242303">]</span><span class="op" id="7242304">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7242308">stmt</span><span class="op" id="7242312">.</span><span class="ident" id="7242313">colType</span>&nbsp;<span class="op" id="7242321">=</span>&nbsp;<span class="builtinfunc" id="7242323">append</span><span class="op" id="7242329">(</span><span class="ident" id="7242330">stmt</span><span class="op" id="7242334">.</span><span class="ident" id="7242335">colType</span><span class="op" id="7242342">,</span>&nbsp;<span class="ident" id="7242344">nameType</span><span class="op" id="7242352">[</span><span class="num" id="7242353">1</span><span class="op" id="7242354">]</span><span class="op" id="7242355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7242358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7242361">return</span>&nbsp;<span class="ident" id="7242368">stmt</span><span class="op" id="7242372">,</span>&nbsp;<span class="ident" id="7242374">nil</span><br>
<span class="lineno"></span><span class="op" id="7242378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="7242381">//&nbsp;parts&nbsp;are&nbsp;table|col=?,col2=val</span><br>
<span class="lineno"></span><span class="keyword" id="7242415">func</span>&nbsp;<span class="op" id="7242420">(</span><span class="ident" id="7242421">c</span>&nbsp;<span class="op" id="7242423">*</span><span class="ident" id="7242424">fakeConn</span><span class="op" id="7242432">)</span>&nbsp;<span class="ident" id="7242434">prepareInsert</span><span class="op" id="7242447">(</span><span class="ident" id="7242448">stmt</span>&nbsp;<span class="op" id="7242453">*</span><span class="ident" id="7242454">fakeStmt</span><span class="op" id="7242462">,</span>&nbsp;<span class="ident" id="7242464">parts</span>&nbsp;<span class="op" id="7242470">[</span><span class="op" id="7242471">]</span><span class="builtintype" id="7242472">string</span><span class="op" id="7242478">)</span>&nbsp;<span class="op" id="7242480">(</span><span class="ident" id="7242481">driver</span><span class="op" id="7242487">.</span><span class="ident" id="7242488">Stmt</span><span class="op" id="7242492">,</span>&nbsp;<span class="builtintype" id="7242494">error</span><span class="op" id="7242499">)</span>&nbsp;<span class="op" id="7242501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7242504">if</span>&nbsp;<span class="builtinfunc" id="7242507">len</span><span class="op" id="7242510">(</span><span class="ident" id="7242511">parts</span><span class="op" id="7242516">)</span>&nbsp;<span class="op" id="7242518">!=</span>&nbsp;<span class="num" id="7242521">2</span>&nbsp;<span class="op" id="7242523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7242527">stmt</span><span class="op" id="7242531">.</span><span class="ident" id="7242532">Close</span><span class="op" id="7242537">(</span><span class="op" id="7242538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7242542">return</span>&nbsp;<span class="ident" id="7242549">nil</span><span class="op" id="7242552">,</span>&nbsp;<span class="ident" id="7242554">errf</span><span class="op" id="7242558">(</span><span class="string" id="7242559">&#34;invalid&nbsp;INSERT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="7242604">,</span>&nbsp;<span class="builtinfunc" id="7242606">len</span><span class="op" id="7242609">(</span><span class="ident" id="7242610">parts</span><span class="op" id="7242615">)</span><span class="op" id="7242616">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7242619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7242622">stmt</span><span class="op" id="7242626">.</span><span class="ident" id="7242627">table</span>&nbsp;<span class="op" id="7242633">=</span>&nbsp;<span class="ident" id="7242635">parts</span><span class="op" id="7242640">[</span><span class="num" id="7242641">0</span><span class="op" id="7242642">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7242645">for</span>&nbsp;<span class="ident" id="7242649">n</span><span class="op" id="7242650">,</span>&nbsp;<span class="ident" id="7242652">colspec</span>&nbsp;<span class="op" id="7242660">:=</span>&nbsp;<span class="keyword" id="7242663">range</span>&nbsp;<span class="ident" id="7242669">strings</span><span class="op" id="7242676">.</span><span class="ident" id="7242677">Split</span><span class="op" id="7242682">(</span><span class="ident" id="7242683">parts</span><span class="op" id="7242688">[</span><span class="num" id="7242689">1</span><span class="op" id="7242690">]</span><span class="op" id="7242691">,</span>&nbsp;<span class="string" id="7242693">&#34;,&#34;</span><span class="op" id="7242696">)</span>&nbsp;<span class="op" id="7242698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7242702">nameVal</span>&nbsp;<span class="op" id="7242710">:=</span>&nbsp;<span class="ident" id="7242713">strings</span><span class="op" id="7242720">.</span><span class="ident" id="7242721">Split</span><span class="op" id="7242726">(</span><span class="ident" id="7242727">colspec</span><span class="op" id="7242734">,</span>&nbsp;<span class="string" id="7242736">&#34;=&#34;</span><span class="op" id="7242739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7242743">if</span>&nbsp;<span class="builtinfunc" id="7242746">len</span><span class="op" id="7242749">(</span><span class="ident" id="7242750">nameVal</span><span class="op" id="7242757">)</span>&nbsp;<span class="op" id="7242759">!=</span>&nbsp;<span class="num" id="7242762">2</span>&nbsp;<span class="op" id="7242764">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7242769">stmt</span><span class="op" id="7242773">.</span><span class="ident" id="7242774">Close</span><span class="op" id="7242779">(</span><span class="op" id="7242780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7242785">return</span>&nbsp;<span class="ident" id="7242792">nil</span><span class="op" id="7242795">,</span>&nbsp;<span class="ident" id="7242797">errf</span><span class="op" id="7242801">(</span><span class="string" id="7242802">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7242860">,</span>&nbsp;<span class="ident" id="7242862">stmt</span><span class="op" id="7242866">.</span><span class="ident" id="7242867">table</span><span class="op" id="7242872">,</span>&nbsp;<span class="ident" id="7242874">colspec</span><span class="op" id="7242881">,</span>&nbsp;<span class="ident" id="7242883">n</span><span class="op" id="7242884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7242888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7242892">column</span><span class="op" id="7242898">,</span>&nbsp;<span class="ident" id="7242900">value</span>&nbsp;<span class="op" id="7242906">:=</span>&nbsp;<span class="ident" id="7242909">nameVal</span><span class="op" id="7242916">[</span><span class="num" id="7242917">0</span><span class="op" id="7242918">]</span><span class="op" id="7242919">,</span>&nbsp;<span class="ident" id="7242921">nameVal</span><span class="op" id="7242928">[</span><span class="num" id="7242929">1</span><span class="op" id="7242930">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7242934">ctype</span><span class="op" id="7242939">,</span>&nbsp;<span class="ident" id="7242941">ok</span>&nbsp;<span class="op" id="7242944">:=</span>&nbsp;<span class="ident" id="7242947">c</span><span class="op" id="7242948">.</span><span class="ident" id="7242949">db</span><span class="op" id="7242951">.</span><span class="ident" id="7242952">columnType</span><span class="op" id="7242962">(</span><span class="ident" id="7242963">stmt</span><span class="op" id="7242967">.</span><span class="ident" id="7242968">table</span><span class="op" id="7242973">,</span>&nbsp;<span class="ident" id="7242975">column</span><span class="op" id="7242981">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7242985">if</span>&nbsp;<span class="op" id="7242988">!</span><span class="ident" id="7242989">ok</span>&nbsp;<span class="op" id="7242992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7242997">stmt</span><span class="op" id="7243001">.</span><span class="ident" id="7243002">Close</span><span class="op" id="7243007">(</span><span class="op" id="7243008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243013">return</span>&nbsp;<span class="ident" id="7243020">nil</span><span class="op" id="7243023">,</span>&nbsp;<span class="ident" id="7243025">errf</span><span class="op" id="7243029">(</span><span class="string" id="7243030">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7243081">,</span>&nbsp;<span class="ident" id="7243083">stmt</span><span class="op" id="7243087">.</span><span class="ident" id="7243088">table</span><span class="op" id="7243093">,</span>&nbsp;<span class="ident" id="7243095">column</span><span class="op" id="7243101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7243105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243109">stmt</span><span class="op" id="7243113">.</span><span class="ident" id="7243114">colName</span>&nbsp;<span class="op" id="7243122">=</span>&nbsp;<span class="builtinfunc" id="7243124">append</span><span class="op" id="7243130">(</span><span class="ident" id="7243131">stmt</span><span class="op" id="7243135">.</span><span class="ident" id="7243136">colName</span><span class="op" id="7243143">,</span>&nbsp;<span class="ident" id="7243145">column</span><span class="op" id="7243151">)</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243156">if</span>&nbsp;<span class="ident" id="7243159">value</span>&nbsp;<span class="op" id="7243165">!=</span>&nbsp;<span class="string" id="7243168">&#34;?&#34;</span>&nbsp;<span class="op" id="7243172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243177">var</span>&nbsp;<span class="ident" id="7243181">subsetVal</span>&nbsp;<span class="keyword" id="7243191">interface</span><span class="op" id="7243200">{</span><span class="op" id="7243201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7243206">//&nbsp;Convert&nbsp;to&nbsp;driver&nbsp;subset&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243242">switch</span>&nbsp;<span class="ident" id="7243249">ctype</span>&nbsp;<span class="op" id="7243255">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243260">case</span>&nbsp;<span class="string" id="7243265">&#34;string&#34;</span><span class="op" id="7243273">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243279">subsetVal</span>&nbsp;<span class="op" id="7243289">=</span>&nbsp;<span class="op" id="7243291">[</span><span class="op" id="7243292">]</span><span class="builtintype" id="7243293">byte</span><span class="op" id="7243297">(</span><span class="ident" id="7243298">value</span><span class="op" id="7243303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243308">case</span>&nbsp;<span class="string" id="7243313">&#34;blob&#34;</span><span class="op" id="7243319">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243325">subsetVal</span>&nbsp;<span class="op" id="7243335">=</span>&nbsp;<span class="op" id="7243337">[</span><span class="op" id="7243338">]</span><span class="builtintype" id="7243339">byte</span><span class="op" id="7243343">(</span><span class="ident" id="7243344">value</span><span class="op" id="7243349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243354">case</span>&nbsp;<span class="string" id="7243359">&#34;int32&#34;</span><span class="op" id="7243366">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243372">i</span><span class="op" id="7243373">,</span>&nbsp;<span class="ident" id="7243375">err</span>&nbsp;<span class="op" id="7243379">:=</span>&nbsp;<span class="ident" id="7243382">strconv</span><span class="op" id="7243389">.</span><span class="ident" id="7243390">Atoi</span><span class="op" id="7243394">(</span><span class="ident" id="7243395">value</span><span class="op" id="7243400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243406">if</span>&nbsp;<span class="ident" id="7243409">err</span>&nbsp;<span class="op" id="7243413">!=</span>&nbsp;<span class="ident" id="7243416">nil</span>&nbsp;<span class="op" id="7243420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243427">stmt</span><span class="op" id="7243431">.</span><span class="ident" id="7243432">Close</span><span class="op" id="7243437">(</span><span class="op" id="7243438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243445">return</span>&nbsp;<span class="ident" id="7243452">nil</span><span class="op" id="7243455">,</span>&nbsp;<span class="ident" id="7243457">errf</span><span class="op" id="7243461">(</span><span class="string" id="7243462">&#34;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;%q&#34;</span><span class="op" id="7243499">,</span>&nbsp;<span class="ident" id="7243501">value</span><span class="op" id="7243506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7243512">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243518">subsetVal</span>&nbsp;<span class="op" id="7243528">=</span>&nbsp;<span class="ident" id="7243530">int64</span><span class="op" id="7243535">(</span><span class="ident" id="7243536">i</span><span class="op" id="7243537">)</span>&nbsp;<span class="comment" id="7243539">//&nbsp;int64&nbsp;is&nbsp;a&nbsp;subset&nbsp;type,&nbsp;but&nbsp;not&nbsp;int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243583">default</span><span class="op" id="7243590">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243596">stmt</span><span class="op" id="7243600">.</span><span class="ident" id="7243601">Close</span><span class="op" id="7243606">(</span><span class="op" id="7243607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243613">return</span>&nbsp;<span class="ident" id="7243620">nil</span><span class="op" id="7243623">,</span>&nbsp;<span class="ident" id="7243625">errf</span><span class="op" id="7243629">(</span><span class="string" id="7243630">&#34;unsupported&nbsp;conversion&nbsp;for&nbsp;pre-bound&nbsp;parameter&nbsp;%q&nbsp;to&nbsp;type&nbsp;%q&#34;</span><span class="op" id="7243692">,</span>&nbsp;<span class="ident" id="7243694">value</span><span class="op" id="7243699">,</span>&nbsp;<span class="ident" id="7243701">ctype</span><span class="op" id="7243706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7243711">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243716">stmt</span><span class="op" id="7243720">.</span><span class="ident" id="7243721">colValue</span>&nbsp;<span class="op" id="7243730">=</span>&nbsp;<span class="builtinfunc" id="7243732">append</span><span class="op" id="7243738">(</span><span class="ident" id="7243739">stmt</span><span class="op" id="7243743">.</span><span class="ident" id="7243744">colValue</span><span class="op" id="7243752">,</span>&nbsp;<span class="ident" id="7243754">subsetVal</span><span class="op" id="7243763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7243767">}</span>&nbsp;<span class="keyword" id="7243769">else</span>&nbsp;<span class="op" id="7243774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243779">stmt</span><span class="op" id="7243783">.</span><span class="ident" id="7243784">placeholders</span><span class="op" id="7243796">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243802">stmt</span><span class="op" id="7243806">.</span><span class="ident" id="7243807">placeholderConverter</span>&nbsp;<span class="op" id="7243828">=</span>&nbsp;<span class="builtinfunc" id="7243830">append</span><span class="op" id="7243836">(</span><span class="ident" id="7243837">stmt</span><span class="op" id="7243841">.</span><span class="ident" id="7243842">placeholderConverter</span><span class="op" id="7243862">,</span>&nbsp;<span class="ident" id="7243864">converterForType</span><span class="op" id="7243880">(</span><span class="ident" id="7243881">ctype</span><span class="op" id="7243886">)</span><span class="op" id="7243887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7243892">stmt</span><span class="op" id="7243896">.</span><span class="ident" id="7243897">colValue</span>&nbsp;<span class="op" id="7243906">=</span>&nbsp;<span class="builtinfunc" id="7243908">append</span><span class="op" id="7243914">(</span><span class="ident" id="7243915">stmt</span><span class="op" id="7243919">.</span><span class="ident" id="7243920">colValue</span><span class="op" id="7243928">,</span>&nbsp;<span class="string" id="7243930">&#34;?&#34;</span><span class="op" id="7243933">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7243937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7243940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7243943">return</span>&nbsp;<span class="ident" id="7243950">stmt</span><span class="op" id="7243954">,</span>&nbsp;<span class="ident" id="7243956">nil</span><br>
<span class="lineno"></span><span class="op" id="7243960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="7243963">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="7244002">var</span>&nbsp;<span class="ident" id="7244006">hookPrepareBadConn</span>&nbsp;<span class="keyword" id="7244025">func</span><span class="op" id="7244029">(</span><span class="op" id="7244030">)</span>&nbsp;<span class="builtintype" id="7244032">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7244038">func</span>&nbsp;<span class="op" id="7244043">(</span><span class="ident" id="7244044">c</span>&nbsp;<span class="op" id="7244046">*</span><span class="ident" id="7244047">fakeConn</span><span class="op" id="7244055">)</span>&nbsp;<span class="ident" id="7244057">Prepare</span><span class="op" id="7244064">(</span><span class="ident" id="7244065">query</span>&nbsp;<span class="builtintype" id="7244071">string</span><span class="op" id="7244077">)</span>&nbsp;<span class="op" id="7244079">(</span><span class="ident" id="7244080">driver</span><span class="op" id="7244086">.</span><span class="ident" id="7244087">Stmt</span><span class="op" id="7244091">,</span>&nbsp;<span class="builtintype" id="7244093">error</span><span class="op" id="7244098">)</span>&nbsp;<span class="op" id="7244100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244103">c</span><span class="op" id="7244104">.</span><span class="ident" id="7244105">numPrepare</span><span class="op" id="7244115">++</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244119">if</span>&nbsp;<span class="ident" id="7244122">c</span><span class="op" id="7244123">.</span><span class="ident" id="7244124">db</span>&nbsp;<span class="op" id="7244127">==</span>&nbsp;<span class="ident" id="7244130">nil</span>&nbsp;<span class="op" id="7244134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7244138">panic</span><span class="op" id="7244143">(</span><span class="string" id="7244144">&#34;nil&nbsp;c.db;&nbsp;conn&nbsp;=&nbsp;&#34;</span>&nbsp;<span class="op" id="7244164">+</span>&nbsp;<span class="ident" id="7244166">fmt</span><span class="op" id="7244169">.</span><span class="ident" id="7244170">Sprintf</span><span class="op" id="7244177">(</span><span class="string" id="7244178">&#34;%#v&#34;</span><span class="op" id="7244183">,</span>&nbsp;<span class="ident" id="7244185">c</span><span class="op" id="7244186">)</span><span class="op" id="7244187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7244190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244194">if</span>&nbsp;<span class="ident" id="7244197">hookPrepareBadConn</span>&nbsp;<span class="op" id="7244216">!=</span>&nbsp;<span class="ident" id="7244219">nil</span>&nbsp;<span class="op" id="7244223">&amp;&amp;</span>&nbsp;<span class="ident" id="7244226">hookPrepareBadConn</span><span class="op" id="7244244">(</span><span class="op" id="7244245">)</span>&nbsp;<span class="op" id="7244247">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244251">return</span>&nbsp;<span class="ident" id="7244258">nil</span><span class="op" id="7244261">,</span>&nbsp;<span class="ident" id="7244263">driver</span><span class="op" id="7244269">.</span><span class="ident" id="7244270">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7244282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244286">parts</span>&nbsp;<span class="op" id="7244292">:=</span>&nbsp;<span class="ident" id="7244295">strings</span><span class="op" id="7244302">.</span><span class="ident" id="7244303">Split</span><span class="op" id="7244308">(</span><span class="ident" id="7244309">query</span><span class="op" id="7244314">,</span>&nbsp;<span class="string" id="7244316">&#34;|&#34;</span><span class="op" id="7244319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244322">if</span>&nbsp;<span class="builtinfunc" id="7244325">len</span><span class="op" id="7244328">(</span><span class="ident" id="7244329">parts</span><span class="op" id="7244334">)</span>&nbsp;<span class="op" id="7244336">&lt;</span>&nbsp;<span class="num" id="7244338">1</span>&nbsp;<span class="op" id="7244340">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244344">return</span>&nbsp;<span class="ident" id="7244351">nil</span><span class="op" id="7244354">,</span>&nbsp;<span class="ident" id="7244356">errf</span><span class="op" id="7244360">(</span><span class="string" id="7244361">&#34;empty&nbsp;query&#34;</span><span class="op" id="7244374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7244377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244380">cmd</span>&nbsp;<span class="op" id="7244384">:=</span>&nbsp;<span class="ident" id="7244387">parts</span><span class="op" id="7244392">[</span><span class="num" id="7244393">0</span><span class="op" id="7244394">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244397">parts</span>&nbsp;<span class="op" id="7244403">=</span>&nbsp;<span class="ident" id="7244405">parts</span><span class="op" id="7244410">[</span><span class="num" id="7244411">1</span><span class="op" id="7244412">:</span><span class="op" id="7244413">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244416">stmt</span>&nbsp;<span class="op" id="7244421">:=</span>&nbsp;<span class="op" id="7244424">&amp;</span><span class="ident" id="7244425">fakeStmt</span><span class="op" id="7244433">{</span><span class="ident" id="7244434">q</span><span class="op" id="7244435">:</span>&nbsp;<span class="ident" id="7244437">query</span><span class="op" id="7244442">,</span>&nbsp;<span class="ident" id="7244444">c</span><span class="op" id="7244445">:</span>&nbsp;<span class="ident" id="7244447">c</span><span class="op" id="7244448">,</span>&nbsp;<span class="ident" id="7244450">cmd</span><span class="op" id="7244453">:</span>&nbsp;<span class="ident" id="7244455">cmd</span><span class="op" id="7244458">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244461">c</span><span class="op" id="7244462">.</span><span class="ident" id="7244463">incrStat</span><span class="op" id="7244471">(</span><span class="op" id="7244472">&amp;</span><span class="ident" id="7244473">c</span><span class="op" id="7244474">.</span><span class="ident" id="7244475">stmtsMade</span><span class="op" id="7244484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244487">switch</span>&nbsp;<span class="ident" id="7244494">cmd</span>&nbsp;<span class="op" id="7244498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244501">case</span>&nbsp;<span class="string" id="7244506">&#34;WIPE&#34;</span><span class="op" id="7244512">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7244516">//&nbsp;Nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244528">case</span>&nbsp;<span class="string" id="7244533">&#34;SELECT&#34;</span><span class="op" id="7244541">:</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244545">return</span>&nbsp;<span class="ident" id="7244552">c</span><span class="op" id="7244553">.</span><span class="ident" id="7244554">prepareSelect</span><span class="op" id="7244567">(</span><span class="ident" id="7244568">stmt</span><span class="op" id="7244572">,</span>&nbsp;<span class="ident" id="7244574">parts</span><span class="op" id="7244579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244582">case</span>&nbsp;<span class="string" id="7244587">&#34;CREATE&#34;</span><span class="op" id="7244595">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244599">return</span>&nbsp;<span class="ident" id="7244606">c</span><span class="op" id="7244607">.</span><span class="ident" id="7244608">prepareCreate</span><span class="op" id="7244621">(</span><span class="ident" id="7244622">stmt</span><span class="op" id="7244626">,</span>&nbsp;<span class="ident" id="7244628">parts</span><span class="op" id="7244633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244636">case</span>&nbsp;<span class="string" id="7244641">&#34;INSERT&#34;</span><span class="op" id="7244649">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244653">return</span>&nbsp;<span class="ident" id="7244660">c</span><span class="op" id="7244661">.</span><span class="ident" id="7244662">prepareInsert</span><span class="op" id="7244675">(</span><span class="ident" id="7244676">stmt</span><span class="op" id="7244680">,</span>&nbsp;<span class="ident" id="7244682">parts</span><span class="op" id="7244687">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244690">case</span>&nbsp;<span class="string" id="7244695">&#34;NOSERT&#34;</span><span class="op" id="7244703">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7244707">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7244787">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244831">return</span>&nbsp;<span class="ident" id="7244838">c</span><span class="op" id="7244839">.</span><span class="ident" id="7244840">prepareInsert</span><span class="op" id="7244853">(</span><span class="ident" id="7244854">stmt</span><span class="op" id="7244858">,</span>&nbsp;<span class="ident" id="7244860">parts</span><span class="op" id="7244865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244868">default</span><span class="op" id="7244875">:</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7244879">stmt</span><span class="op" id="7244883">.</span><span class="ident" id="7244884">Close</span><span class="op" id="7244889">(</span><span class="op" id="7244890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244894">return</span>&nbsp;<span class="ident" id="7244901">nil</span><span class="op" id="7244904">,</span>&nbsp;<span class="ident" id="7244906">errf</span><span class="op" id="7244910">(</span><span class="string" id="7244911">&#34;unsupported&nbsp;command&nbsp;type&nbsp;%q&#34;</span><span class="op" id="7244940">,</span>&nbsp;<span class="ident" id="7244942">cmd</span><span class="op" id="7244945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7244948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7244951">return</span>&nbsp;<span class="ident" id="7244958">stmt</span><span class="op" id="7244962">,</span>&nbsp;<span class="ident" id="7244964">nil</span><br>
<span class="lineno"></span><span class="op" id="7244968">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="7244971">func</span>&nbsp;<span class="op" id="7244976">(</span><span class="ident" id="7244977">s</span>&nbsp;<span class="op" id="7244979">*</span><span class="ident" id="7244980">fakeStmt</span><span class="op" id="7244988">)</span>&nbsp;<span class="ident" id="7244990">ColumnConverter</span><span class="op" id="7245005">(</span><span class="ident" id="7245006">idx</span>&nbsp;<span class="builtintype" id="7245010">int</span><span class="op" id="7245013">)</span>&nbsp;<span class="ident" id="7245015">driver</span><span class="op" id="7245021">.</span><span class="ident" id="7245022">ValueConverter</span>&nbsp;<span class="op" id="7245037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245040">if</span>&nbsp;<span class="builtinfunc" id="7245043">len</span><span class="op" id="7245046">(</span><span class="ident" id="7245047">s</span><span class="op" id="7245048">.</span><span class="ident" id="7245049">placeholderConverter</span><span class="op" id="7245069">)</span>&nbsp;<span class="op" id="7245071">==</span>&nbsp;<span class="num" id="7245074">0</span>&nbsp;<span class="op" id="7245076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245080">return</span>&nbsp;<span class="ident" id="7245087">driver</span><span class="op" id="7245093">.</span><span class="ident" id="7245094">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7245121">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245124">return</span>&nbsp;<span class="ident" id="7245131">s</span><span class="op" id="7245132">.</span><span class="ident" id="7245133">placeholderConverter</span><span class="op" id="7245153">[</span><span class="ident" id="7245154">idx</span><span class="op" id="7245157">]</span><br>
<span class="lineno"></span><span class="op" id="7245159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7245162">func</span>&nbsp;<span class="op" id="7245167">(</span><span class="ident" id="7245168">s</span>&nbsp;<span class="op" id="7245170">*</span><span class="ident" id="7245171">fakeStmt</span><span class="op" id="7245179">)</span>&nbsp;<span class="ident" id="7245181">Close</span><span class="op" id="7245186">(</span><span class="op" id="7245187">)</span>&nbsp;<span class="builtintype" id="7245189">error</span>&nbsp;<span class="op" id="7245195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245198">if</span>&nbsp;<span class="ident" id="7245201">s</span><span class="op" id="7245202">.</span><span class="ident" id="7245203">c</span>&nbsp;<span class="op" id="7245205">==</span>&nbsp;<span class="ident" id="7245208">nil</span>&nbsp;<span class="op" id="7245212">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7245216">panic</span><span class="op" id="7245221">(</span><span class="string" id="7245222">&#34;nil&nbsp;conn&nbsp;in&nbsp;fakeStmt.Close&#34;</span><span class="op" id="7245250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7245253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245256">if</span>&nbsp;<span class="ident" id="7245259">s</span><span class="op" id="7245260">.</span><span class="ident" id="7245261">c</span><span class="op" id="7245262">.</span><span class="ident" id="7245263">db</span>&nbsp;<span class="op" id="7245266">==</span>&nbsp;<span class="ident" id="7245269">nil</span>&nbsp;<span class="op" id="7245273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7245277">panic</span><span class="op" id="7245282">(</span><span class="string" id="7245283">&#34;in&nbsp;fakeStmt.Close,&nbsp;conn&#39;s&nbsp;db&nbsp;is&nbsp;nil&nbsp;(already&nbsp;closed)&#34;</span><span class="op" id="7245337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7245340">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245343">if</span>&nbsp;<span class="op" id="7245346">!</span><span class="ident" id="7245347">s</span><span class="op" id="7245348">.</span><span class="ident" id="7245349">closed</span>&nbsp;<span class="op" id="7245356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7245360">s</span><span class="op" id="7245361">.</span><span class="ident" id="7245362">c</span><span class="op" id="7245363">.</span><span class="ident" id="7245364">incrStat</span><span class="op" id="7245372">(</span><span class="op" id="7245373">&amp;</span><span class="ident" id="7245374">s</span><span class="op" id="7245375">.</span><span class="ident" id="7245376">c</span><span class="op" id="7245377">.</span><span class="ident" id="7245378">stmtsClosed</span><span class="op" id="7245389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7245393">s</span><span class="op" id="7245394">.</span><span class="ident" id="7245395">closed</span>&nbsp;<span class="op" id="7245402">=</span>&nbsp;<span class="ident" id="7245404">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7245410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245413">return</span>&nbsp;<span class="ident" id="7245420">nil</span><br>
<span class="lineno">520</span><span class="op" id="7245424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7245427">var</span>&nbsp;<span class="ident" id="7245431">errClosed</span>&nbsp;<span class="op" id="7245441">=</span>&nbsp;<span class="ident" id="7245443">errors</span><span class="op" id="7245449">.</span><span class="ident" id="7245450">New</span><span class="op" id="7245453">(</span><span class="string" id="7245454">&#34;fakedb:&nbsp;statement&nbsp;has&nbsp;been&nbsp;closed&#34;</span><span class="op" id="7245489">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7245492">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno">525</span><span class="keyword" id="7245531">var</span>&nbsp;<span class="ident" id="7245535">hookExecBadConn</span>&nbsp;<span class="keyword" id="7245551">func</span><span class="op" id="7245555">(</span><span class="op" id="7245556">)</span>&nbsp;<span class="builtintype" id="7245558">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7245564">func</span>&nbsp;<span class="op" id="7245569">(</span><span class="ident" id="7245570">s</span>&nbsp;<span class="op" id="7245572">*</span><span class="ident" id="7245573">fakeStmt</span><span class="op" id="7245581">)</span>&nbsp;<span class="ident" id="7245583">Exec</span><span class="op" id="7245587">(</span><span class="ident" id="7245588">args</span>&nbsp;<span class="op" id="7245593">[</span><span class="op" id="7245594">]</span><span class="ident" id="7245595">driver</span><span class="op" id="7245601">.</span><span class="ident" id="7245602">Value</span><span class="op" id="7245607">)</span>&nbsp;<span class="op" id="7245609">(</span><span class="ident" id="7245610">driver</span><span class="op" id="7245616">.</span><span class="ident" id="7245617">Result</span><span class="op" id="7245623">,</span>&nbsp;<span class="builtintype" id="7245625">error</span><span class="op" id="7245630">)</span>&nbsp;<span class="op" id="7245632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245635">if</span>&nbsp;<span class="ident" id="7245638">s</span><span class="op" id="7245639">.</span><span class="ident" id="7245640">closed</span>&nbsp;<span class="op" id="7245647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245651">return</span>&nbsp;<span class="ident" id="7245658">nil</span><span class="op" id="7245661">,</span>&nbsp;<span class="ident" id="7245663">errClosed</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7245674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245678">if</span>&nbsp;<span class="ident" id="7245681">hookExecBadConn</span>&nbsp;<span class="op" id="7245697">!=</span>&nbsp;<span class="ident" id="7245700">nil</span>&nbsp;<span class="op" id="7245704">&amp;&amp;</span>&nbsp;<span class="ident" id="7245707">hookExecBadConn</span><span class="op" id="7245722">(</span><span class="op" id="7245723">)</span>&nbsp;<span class="op" id="7245725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245729">return</span>&nbsp;<span class="ident" id="7245736">nil</span><span class="op" id="7245739">,</span>&nbsp;<span class="ident" id="7245741">driver</span><span class="op" id="7245747">.</span><span class="ident" id="7245748">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7245760">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7245764">err</span>&nbsp;<span class="op" id="7245768">:=</span>&nbsp;<span class="ident" id="7245771">checkSubsetTypes</span><span class="op" id="7245787">(</span><span class="ident" id="7245788">args</span><span class="op" id="7245792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245795">if</span>&nbsp;<span class="ident" id="7245798">err</span>&nbsp;<span class="op" id="7245802">!=</span>&nbsp;<span class="ident" id="7245805">nil</span>&nbsp;<span class="op" id="7245809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245813">return</span>&nbsp;<span class="ident" id="7245820">nil</span><span class="op" id="7245823">,</span>&nbsp;<span class="ident" id="7245825">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7245830">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7245834">db</span>&nbsp;<span class="op" id="7245837">:=</span>&nbsp;<span class="ident" id="7245840">s</span><span class="op" id="7245841">.</span><span class="ident" id="7245842">c</span><span class="op" id="7245843">.</span><span class="ident" id="7245844">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245848">switch</span>&nbsp;<span class="ident" id="7245855">s</span><span class="op" id="7245856">.</span><span class="ident" id="7245857">cmd</span>&nbsp;<span class="op" id="7245861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245864">case</span>&nbsp;<span class="string" id="7245869">&#34;WIPE&#34;</span><span class="op" id="7245875">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7245879">db</span><span class="op" id="7245881">.</span><span class="ident" id="7245882">wipe</span><span class="op" id="7245886">(</span><span class="op" id="7245887">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245891">return</span>&nbsp;<span class="ident" id="7245898">driver</span><span class="op" id="7245904">.</span><span class="ident" id="7245905">ResultNoRows</span><span class="op" id="7245917">,</span>&nbsp;<span class="ident" id="7245919">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245924">case</span>&nbsp;<span class="string" id="7245929">&#34;CREATE&#34;</span><span class="op" id="7245937">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7245941">if</span>&nbsp;<span class="ident" id="7245944">err</span>&nbsp;<span class="op" id="7245948">:=</span>&nbsp;<span class="ident" id="7245951">db</span><span class="op" id="7245953">.</span><span class="ident" id="7245954">createTable</span><span class="op" id="7245965">(</span><span class="ident" id="7245966">s</span><span class="op" id="7245967">.</span><span class="ident" id="7245968">table</span><span class="op" id="7245973">,</span>&nbsp;<span class="ident" id="7245975">s</span><span class="op" id="7245976">.</span><span class="ident" id="7245977">colName</span><span class="op" id="7245984">,</span>&nbsp;<span class="ident" id="7245986">s</span><span class="op" id="7245987">.</span><span class="ident" id="7245988">colType</span><span class="op" id="7245995">)</span><span class="op" id="7245996">;</span>&nbsp;<span class="ident" id="7245998">err</span>&nbsp;<span class="op" id="7246002">!=</span>&nbsp;<span class="ident" id="7246005">nil</span>&nbsp;<span class="op" id="7246009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246014">return</span>&nbsp;<span class="ident" id="7246021">nil</span><span class="op" id="7246024">,</span>&nbsp;<span class="ident" id="7246026">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7246032">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246036">return</span>&nbsp;<span class="ident" id="7246043">driver</span><span class="op" id="7246049">.</span><span class="ident" id="7246050">ResultNoRows</span><span class="op" id="7246062">,</span>&nbsp;<span class="ident" id="7246064">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246069">case</span>&nbsp;<span class="string" id="7246074">&#34;INSERT&#34;</span><span class="op" id="7246082">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246086">return</span>&nbsp;<span class="ident" id="7246093">s</span><span class="op" id="7246094">.</span><span class="ident" id="7246095">execInsert</span><span class="op" id="7246105">(</span><span class="ident" id="7246106">args</span><span class="op" id="7246110">,</span>&nbsp;<span class="ident" id="7246112">true</span><span class="op" id="7246116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246119">case</span>&nbsp;<span class="string" id="7246124">&#34;NOSERT&#34;</span><span class="op" id="7246132">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7246136">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7246216">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246260">return</span>&nbsp;<span class="ident" id="7246267">s</span><span class="op" id="7246268">.</span><span class="ident" id="7246269">execInsert</span><span class="op" id="7246279">(</span><span class="ident" id="7246280">args</span><span class="op" id="7246284">,</span>&nbsp;<span class="ident" id="7246286">false</span><span class="op" id="7246291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7246294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246297">fmt</span><span class="op" id="7246300">.</span><span class="ident" id="7246301">Printf</span><span class="op" id="7246307">(</span><span class="string" id="7246308">&#34;EXEC&nbsp;statement,&nbsp;cmd=%q:&nbsp;%#v\n&#34;</span><span class="op" id="7246339">,</span>&nbsp;<span class="ident" id="7246341">s</span><span class="op" id="7246342">.</span><span class="ident" id="7246343">cmd</span><span class="op" id="7246346">,</span>&nbsp;<span class="ident" id="7246348">s</span><span class="op" id="7246349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246352">return</span>&nbsp;<span class="ident" id="7246359">nil</span><span class="op" id="7246362">,</span>&nbsp;<span class="ident" id="7246364">fmt</span><span class="op" id="7246367">.</span><span class="ident" id="7246368">Errorf</span><span class="op" id="7246374">(</span><span class="string" id="7246375">&#34;unimplemented&nbsp;statement&nbsp;Exec&nbsp;command&nbsp;type&nbsp;of&nbsp;%q&#34;</span><span class="op" id="7246424">,</span>&nbsp;<span class="ident" id="7246426">s</span><span class="op" id="7246427">.</span><span class="ident" id="7246428">cmd</span><span class="op" id="7246431">)</span><br>
<span class="lineno">560</span><span class="op" id="7246433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7246436">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;true,&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span><span class="comment" id="7246488">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;false&nbsp;do&nbsp;prep-work&nbsp;and&nbsp;error&nbsp;checking,&nbsp;but&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="7246557">//&nbsp;actually&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno">565</span><span class="keyword" id="7246595">func</span>&nbsp;<span class="op" id="7246600">(</span><span class="ident" id="7246601">s</span>&nbsp;<span class="op" id="7246603">*</span><span class="ident" id="7246604">fakeStmt</span><span class="op" id="7246612">)</span>&nbsp;<span class="ident" id="7246614">execInsert</span><span class="op" id="7246624">(</span><span class="ident" id="7246625">args</span>&nbsp;<span class="op" id="7246630">[</span><span class="op" id="7246631">]</span><span class="ident" id="7246632">driver</span><span class="op" id="7246638">.</span><span class="ident" id="7246639">Value</span><span class="op" id="7246644">,</span>&nbsp;<span class="ident" id="7246646">doInsert</span>&nbsp;<span class="builtintype" id="7246655">bool</span><span class="op" id="7246659">)</span>&nbsp;<span class="op" id="7246661">(</span><span class="ident" id="7246662">driver</span><span class="op" id="7246668">.</span><span class="ident" id="7246669">Result</span><span class="op" id="7246675">,</span>&nbsp;<span class="builtintype" id="7246677">error</span><span class="op" id="7246682">)</span>&nbsp;<span class="op" id="7246684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246687">db</span>&nbsp;<span class="op" id="7246690">:=</span>&nbsp;<span class="ident" id="7246693">s</span><span class="op" id="7246694">.</span><span class="ident" id="7246695">c</span><span class="op" id="7246696">.</span><span class="ident" id="7246697">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246701">if</span>&nbsp;<span class="builtinfunc" id="7246704">len</span><span class="op" id="7246707">(</span><span class="ident" id="7246708">args</span><span class="op" id="7246712">)</span>&nbsp;<span class="op" id="7246714">!=</span>&nbsp;<span class="ident" id="7246717">s</span><span class="op" id="7246718">.</span><span class="ident" id="7246719">placeholders</span>&nbsp;<span class="op" id="7246732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7246736">panic</span><span class="op" id="7246741">(</span><span class="string" id="7246742">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="7246800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7246803">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246806">db</span><span class="op" id="7246808">.</span><span class="ident" id="7246809">mu</span><span class="op" id="7246811">.</span><span class="ident" id="7246812">Lock</span><span class="op" id="7246816">(</span><span class="op" id="7246817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246820">t</span><span class="op" id="7246821">,</span>&nbsp;<span class="ident" id="7246823">ok</span>&nbsp;<span class="op" id="7246826">:=</span>&nbsp;<span class="ident" id="7246829">db</span><span class="op" id="7246831">.</span><span class="ident" id="7246832">table</span><span class="op" id="7246837">(</span><span class="ident" id="7246838">s</span><span class="op" id="7246839">.</span><span class="ident" id="7246840">table</span><span class="op" id="7246845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246848">db</span><span class="op" id="7246850">.</span><span class="ident" id="7246851">mu</span><span class="op" id="7246853">.</span><span class="ident" id="7246854">Unlock</span><span class="op" id="7246860">(</span><span class="op" id="7246861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246864">if</span>&nbsp;<span class="op" id="7246867">!</span><span class="ident" id="7246868">ok</span>&nbsp;<span class="op" id="7246871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246875">return</span>&nbsp;<span class="ident" id="7246882">nil</span><span class="op" id="7246885">,</span>&nbsp;<span class="ident" id="7246887">fmt</span><span class="op" id="7246890">.</span><span class="ident" id="7246891">Errorf</span><span class="op" id="7246897">(</span><span class="string" id="7246898">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="7246930">,</span>&nbsp;<span class="ident" id="7246932">s</span><span class="op" id="7246933">.</span><span class="ident" id="7246934">table</span><span class="op" id="7246939">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7246942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7246946">t</span><span class="op" id="7246947">.</span><span class="ident" id="7246948">mu</span><span class="op" id="7246950">.</span><span class="ident" id="7246951">Lock</span><span class="op" id="7246955">(</span><span class="op" id="7246956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246959">defer</span>&nbsp;<span class="ident" id="7246965">t</span><span class="op" id="7246966">.</span><span class="ident" id="7246967">mu</span><span class="op" id="7246969">.</span><span class="ident" id="7246970">Unlock</span><span class="op" id="7246976">(</span><span class="op" id="7246977">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7246981">var</span>&nbsp;<span class="ident" id="7246985">cols</span>&nbsp;<span class="op" id="7246990">[</span><span class="op" id="7246991">]</span><span class="keyword" id="7246992">interface</span><span class="op" id="7247001">{</span><span class="op" id="7247002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7247005">if</span>&nbsp;<span class="ident" id="7247008">doInsert</span>&nbsp;<span class="op" id="7247017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7247021">cols</span>&nbsp;<span class="op" id="7247026">=</span>&nbsp;<span class="builtinfunc" id="7247028">make</span><span class="op" id="7247032">(</span><span class="op" id="7247033">[</span><span class="op" id="7247034">]</span><span class="keyword" id="7247035">interface</span><span class="op" id="7247044">{</span><span class="op" id="7247045">}</span><span class="op" id="7247046">,</span>&nbsp;<span class="builtinfunc" id="7247048">len</span><span class="op" id="7247051">(</span><span class="ident" id="7247052">t</span><span class="op" id="7247053">.</span><span class="ident" id="7247054">colname</span><span class="op" id="7247061">)</span><span class="op" id="7247062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7247065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7247068">argPos</span>&nbsp;<span class="op" id="7247075">:=</span>&nbsp;<span class="num" id="7247078">0</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7247081">for</span>&nbsp;<span class="ident" id="7247085">n</span><span class="op" id="7247086">,</span>&nbsp;<span class="ident" id="7247088">colname</span>&nbsp;<span class="op" id="7247096">:=</span>&nbsp;<span class="keyword" id="7247099">range</span>&nbsp;<span class="ident" id="7247105">s</span><span class="op" id="7247106">.</span><span class="ident" id="7247107">colName</span>&nbsp;<span class="op" id="7247115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7247119">colidx</span>&nbsp;<span class="op" id="7247126">:=</span>&nbsp;<span class="ident" id="7247129">t</span><span class="op" id="7247130">.</span><span class="ident" id="7247131">columnIndex</span><span class="op" id="7247142">(</span><span class="ident" id="7247143">colname</span><span class="op" id="7247150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7247154">if</span>&nbsp;<span class="ident" id="7247157">colidx</span>&nbsp;<span class="op" id="7247164">==</span>&nbsp;<span class="op" id="7247167">-</span><span class="num" id="7247168">1</span>&nbsp;<span class="op" id="7247170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7247175">return</span>&nbsp;<span class="ident" id="7247182">nil</span><span class="op" id="7247185">,</span>&nbsp;<span class="ident" id="7247187">fmt</span><span class="op" id="7247190">.</span><span class="ident" id="7247191">Errorf</span><span class="op" id="7247197">(</span><span class="string" id="7247198">&#34;fakedb:&nbsp;column&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&nbsp;or&nbsp;dropped&nbsp;since&nbsp;prepared&nbsp;statement&nbsp;was&nbsp;created&#34;</span><span class="op" id="7247279">,</span>&nbsp;<span class="ident" id="7247281">colname</span><span class="op" id="7247288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7247292">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7247296">var</span>&nbsp;<span class="ident" id="7247300">val</span>&nbsp;<span class="keyword" id="7247304">interface</span><span class="op" id="7247313">{</span><span class="op" id="7247314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7247318">if</span>&nbsp;<span class="ident" id="7247321">strvalue</span><span class="op" id="7247329">,</span>&nbsp;<span class="ident" id="7247331">ok</span>&nbsp;<span class="op" id="7247334">:=</span>&nbsp;<span class="ident" id="7247337">s</span><span class="op" id="7247338">.</span><span class="ident" id="7247339">colValue</span><span class="op" id="7247347">[</span><span class="ident" id="7247348">n</span><span class="op" id="7247349">]</span><span class="op" id="7247350">.</span><span class="op" id="7247351">(</span><span class="builtintype" id="7247352">string</span><span class="op" id="7247358">)</span><span class="op" id="7247359">;</span>&nbsp;<span class="ident" id="7247361">ok</span>&nbsp;<span class="op" id="7247364">&amp;&amp;</span>&nbsp;<span class="ident" id="7247367">strvalue</span>&nbsp;<span class="op" id="7247376">==</span>&nbsp;<span class="string" id="7247379">&#34;?&#34;</span>&nbsp;<span class="op" id="7247383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7247388">val</span>&nbsp;<span class="op" id="7247392">=</span>&nbsp;<span class="ident" id="7247394">args</span><span class="op" id="7247398">[</span><span class="ident" id="7247399">argPos</span><span class="op" id="7247405">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7247410">argPos</span><span class="op" id="7247416">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7247421">}</span>&nbsp;<span class="keyword" id="7247423">else</span>&nbsp;<span class="op" id="7247428">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7247433">val</span>&nbsp;<span class="op" id="7247437">=</span>&nbsp;<span class="ident" id="7247439">s</span><span class="op" id="7247440">.</span><span class="ident" id="7247441">colValue</span><span class="op" id="7247449">[</span><span class="ident" id="7247450">n</span><span class="op" id="7247451">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7247455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7247459">if</span>&nbsp;<span class="ident" id="7247462">doInsert</span>&nbsp;<span class="op" id="7247471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7247476">cols</span><span class="op" id="7247480">[</span><span class="ident" id="7247481">colidx</span><span class="op" id="7247487">]</span>&nbsp;<span class="op" id="7247489">=</span>&nbsp;<span class="ident" id="7247491">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7247497">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7247500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7247504">if</span>&nbsp;<span class="ident" id="7247507">doInsert</span>&nbsp;<span class="op" id="7247516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7247520">t</span><span class="op" id="7247521">.</span><span class="ident" id="7247522">rows</span>&nbsp;<span class="op" id="7247527">=</span>&nbsp;<span class="builtinfunc" id="7247529">append</span><span class="op" id="7247535">(</span><span class="ident" id="7247536">t</span><span class="op" id="7247537">.</span><span class="ident" id="7247538">rows</span><span class="op" id="7247542">,</span>&nbsp;<span class="op" id="7247544">&amp;</span><span class="ident" id="7247545">row</span><span class="op" id="7247548">{</span><span class="ident" id="7247549">cols</span><span class="op" id="7247553">:</span>&nbsp;<span class="ident" id="7247555">cols</span><span class="op" id="7247559">}</span><span class="op" id="7247560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7247563">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7247566">return</span>&nbsp;<span class="ident" id="7247573">driver</span><span class="op" id="7247579">.</span><span class="ident" id="7247580">RowsAffected</span><span class="op" id="7247592">(</span><span class="num" id="7247593">1</span><span class="op" id="7247594">)</span><span class="op" id="7247595">,</span>&nbsp;<span class="ident" id="7247597">nil</span><br>
<span class="lineno"></span><span class="op" id="7247601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7247604">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="7247643">var</span>&nbsp;<span class="ident" id="7247647">hookQueryBadConn</span>&nbsp;<span class="keyword" id="7247664">func</span><span class="op" id="7247668">(</span><span class="op" id="7247669">)</span>&nbsp;<span class="builtintype" id="7247671">bool</span><br>
<span class="lineno">610</span><br>
<span class="lineno"></span><span class="keyword" id="7247677">func</span>&nbsp;<span class="op" id="7247682">(</span><span class="ident" id="7247683">s</span>&nbsp;<span class="op" id="7247685">*</span><span class="ident" id="7247686">fakeStmt</span><span class="op" id="7247694">)</span>&nbsp;<span class="ident" id="7247696">Query</span><span class="op" id="7247701">(</span><span class="ident" id="7247702">args</span>&nbsp;<span class="op" id="7247707">[</span><span class="op" id="7247708">]</span><span class="ident" id="7247709">driver</span><span class="op" id="7247715">.</span><span class="ident" id="7247716">Value</span><span class="op" id="7247721">)</span>&nbsp;<span class="op" id="7247723">(</span><span class="ident" id="7247724">driver</span><span class="op" id="7247730">.</span><span class="ident" id="7247731">Rows</span><span class="op" id="7247735">,</span>&nbsp;<span class="builtintype" id="7247737">error</span><span class="op" id="7247742">)</span>&nbsp;<span class="op" id="7247744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7247747">if</span>&nbsp;<span class="ident" id="7247750">s</span><span class="op" id="7247751">.</span><span class="ident" id="7247752">closed</span>&nbsp;<span class="op" id="7247759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7247763">return</span>&nbsp;<span class="ident" id="7247770">nil</span><span class="op" id="7247773">,</span>&nbsp;<span class="ident" id="7247775">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7247786">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7247790">if</span>&nbsp;<span class="ident" id="7247793">hookQueryBadConn</span>&nbsp;<span class="op" id="7247810">!=</span>&nbsp;<span class="ident" id="7247813">nil</span>&nbsp;<span class="op" id="7247817">&amp;&amp;</span>&nbsp;<span class="ident" id="7247820">hookQueryBadConn</span><span class="op" id="7247836">(</span><span class="op" id="7247837">)</span>&nbsp;<span class="op" id="7247839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7247843">return</span>&nbsp;<span class="ident" id="7247850">nil</span><span class="op" id="7247853">,</span>&nbsp;<span class="ident" id="7247855">driver</span><span class="op" id="7247861">.</span><span class="ident" id="7247862">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7247874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7247878">err</span>&nbsp;<span class="op" id="7247882">:=</span>&nbsp;<span class="ident" id="7247885">checkSubsetTypes</span><span class="op" id="7247901">(</span><span class="ident" id="7247902">args</span><span class="op" id="7247906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7247909">if</span>&nbsp;<span class="ident" id="7247912">err</span>&nbsp;<span class="op" id="7247916">!=</span>&nbsp;<span class="ident" id="7247919">nil</span>&nbsp;<span class="op" id="7247923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7247927">return</span>&nbsp;<span class="ident" id="7247934">nil</span><span class="op" id="7247937">,</span>&nbsp;<span class="ident" id="7247939">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7247944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7247948">db</span>&nbsp;<span class="op" id="7247951">:=</span>&nbsp;<span class="ident" id="7247954">s</span><span class="op" id="7247955">.</span><span class="ident" id="7247956">c</span><span class="op" id="7247957">.</span><span class="ident" id="7247958">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7247962">if</span>&nbsp;<span class="builtinfunc" id="7247965">len</span><span class="op" id="7247968">(</span><span class="ident" id="7247969">args</span><span class="op" id="7247973">)</span>&nbsp;<span class="op" id="7247975">!=</span>&nbsp;<span class="ident" id="7247978">s</span><span class="op" id="7247979">.</span><span class="ident" id="7247980">placeholders</span>&nbsp;<span class="op" id="7247993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7247997">panic</span><span class="op" id="7248002">(</span><span class="string" id="7248003">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="7248061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7248064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7248068">db</span><span class="op" id="7248070">.</span><span class="ident" id="7248071">mu</span><span class="op" id="7248073">.</span><span class="ident" id="7248074">Lock</span><span class="op" id="7248078">(</span><span class="op" id="7248079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7248082">t</span><span class="op" id="7248083">,</span>&nbsp;<span class="ident" id="7248085">ok</span>&nbsp;<span class="op" id="7248088">:=</span>&nbsp;<span class="ident" id="7248091">db</span><span class="op" id="7248093">.</span><span class="ident" id="7248094">table</span><span class="op" id="7248099">(</span><span class="ident" id="7248100">s</span><span class="op" id="7248101">.</span><span class="ident" id="7248102">table</span><span class="op" id="7248107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7248110">db</span><span class="op" id="7248112">.</span><span class="ident" id="7248113">mu</span><span class="op" id="7248115">.</span><span class="ident" id="7248116">Unlock</span><span class="op" id="7248122">(</span><span class="op" id="7248123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7248126">if</span>&nbsp;<span class="op" id="7248129">!</span><span class="ident" id="7248130">ok</span>&nbsp;<span class="op" id="7248133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7248137">return</span>&nbsp;<span class="ident" id="7248144">nil</span><span class="op" id="7248147">,</span>&nbsp;<span class="ident" id="7248149">fmt</span><span class="op" id="7248152">.</span><span class="ident" id="7248153">Errorf</span><span class="op" id="7248159">(</span><span class="string" id="7248160">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="7248192">,</span>&nbsp;<span class="ident" id="7248194">s</span><span class="op" id="7248195">.</span><span class="ident" id="7248196">table</span><span class="op" id="7248201">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7248204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7248208">if</span>&nbsp;<span class="ident" id="7248211">s</span><span class="op" id="7248212">.</span><span class="ident" id="7248213">table</span>&nbsp;<span class="op" id="7248219">==</span>&nbsp;<span class="string" id="7248222">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="7248235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7248239">if</span>&nbsp;<span class="builtinfunc" id="7248242">len</span><span class="op" id="7248245">(</span><span class="ident" id="7248246">s</span><span class="op" id="7248247">.</span><span class="ident" id="7248248">whereCol</span><span class="op" id="7248256">)</span>&nbsp;<span class="op" id="7248258">==</span>&nbsp;<span class="num" id="7248261">2</span>&nbsp;<span class="op" id="7248263">&amp;&amp;</span>&nbsp;<span class="ident" id="7248266">s</span><span class="op" id="7248267">.</span><span class="ident" id="7248268">whereCol</span><span class="op" id="7248276">[</span><span class="num" id="7248277">0</span><span class="op" id="7248278">]</span>&nbsp;<span class="op" id="7248280">==</span>&nbsp;<span class="string" id="7248283">&#34;op&#34;</span>&nbsp;<span class="op" id="7248288">&amp;&amp;</span>&nbsp;<span class="ident" id="7248291">s</span><span class="op" id="7248292">.</span><span class="ident" id="7248293">whereCol</span><span class="op" id="7248301">[</span><span class="num" id="7248302">1</span><span class="op" id="7248303">]</span>&nbsp;<span class="op" id="7248305">==</span>&nbsp;<span class="string" id="7248308">&#34;millis&#34;</span>&nbsp;<span class="op" id="7248317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7248322">if</span>&nbsp;<span class="ident" id="7248325">args</span><span class="op" id="7248329">[</span><span class="num" id="7248330">0</span><span class="op" id="7248331">]</span>&nbsp;<span class="op" id="7248333">==</span>&nbsp;<span class="string" id="7248336">&#34;sleep&#34;</span>&nbsp;<span class="op" id="7248344">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7248350">time</span><span class="op" id="7248354">.</span><span class="ident" id="7248355">Sleep</span><span class="op" id="7248360">(</span><span class="ident" id="7248361">time</span><span class="op" id="7248365">.</span><span class="ident" id="7248366">Duration</span><span class="op" id="7248374">(</span><span class="ident" id="7248375">args</span><span class="op" id="7248379">[</span><span class="num" id="7248380">1</span><span class="op" id="7248381">]</span><span class="op" id="7248382">.</span><span class="op" id="7248383">(</span><span class="ident" id="7248384">int64</span><span class="op" id="7248389">)</span><span class="op" id="7248390">)</span>&nbsp;<span class="op" id="7248392">*</span>&nbsp;<span class="ident" id="7248394">time</span><span class="op" id="7248398">.</span><span class="ident" id="7248399">Millisecond</span><span class="op" id="7248410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7248415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7248419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7248422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7248426">t</span><span class="op" id="7248427">.</span><span class="ident" id="7248428">mu</span><span class="op" id="7248430">.</span><span class="ident" id="7248431">Lock</span><span class="op" id="7248435">(</span><span class="op" id="7248436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7248439">defer</span>&nbsp;<span class="ident" id="7248445">t</span><span class="op" id="7248446">.</span><span class="ident" id="7248447">mu</span><span class="op" id="7248449">.</span><span class="ident" id="7248450">Unlock</span><span class="op" id="7248456">(</span><span class="op" id="7248457">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7248461">colIdx</span>&nbsp;<span class="op" id="7248468">:=</span>&nbsp;<span class="builtinfunc" id="7248471">make</span><span class="op" id="7248475">(</span><span class="keyword" id="7248476">map</span><span class="op" id="7248479">[</span><span class="builtintype" id="7248480">string</span><span class="op" id="7248486">]</span><span class="builtintype" id="7248487">int</span><span class="op" id="7248490">)</span>&nbsp;<span class="comment" id="7248492">//&nbsp;select&nbsp;column&nbsp;name&nbsp;-&gt;&nbsp;column&nbsp;index&nbsp;in&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7248540">for</span>&nbsp;<span class="ident" id="7248544">_</span><span class="op" id="7248545">,</span>&nbsp;<span class="ident" id="7248547">name</span>&nbsp;<span class="op" id="7248552">:=</span>&nbsp;<span class="keyword" id="7248555">range</span>&nbsp;<span class="ident" id="7248561">s</span><span class="op" id="7248562">.</span><span class="ident" id="7248563">colName</span>&nbsp;<span class="op" id="7248571">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7248575">idx</span>&nbsp;<span class="op" id="7248579">:=</span>&nbsp;<span class="ident" id="7248582">t</span><span class="op" id="7248583">.</span><span class="ident" id="7248584">columnIndex</span><span class="op" id="7248595">(</span><span class="ident" id="7248596">name</span><span class="op" id="7248600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7248604">if</span>&nbsp;<span class="ident" id="7248607">idx</span>&nbsp;<span class="op" id="7248611">==</span>&nbsp;<span class="op" id="7248614">-</span><span class="num" id="7248615">1</span>&nbsp;<span class="op" id="7248617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7248622">return</span>&nbsp;<span class="ident" id="7248629">nil</span><span class="op" id="7248632">,</span>&nbsp;<span class="ident" id="7248634">fmt</span><span class="op" id="7248637">.</span><span class="ident" id="7248638">Errorf</span><span class="op" id="7248644">(</span><span class="string" id="7248645">&#34;fakedb:&nbsp;unknown&nbsp;column&nbsp;name&nbsp;%q&#34;</span><span class="op" id="7248677">,</span>&nbsp;<span class="ident" id="7248679">name</span><span class="op" id="7248683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7248687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7248691">colIdx</span><span class="op" id="7248697">[</span><span class="ident" id="7248698">name</span><span class="op" id="7248702">]</span>&nbsp;<span class="op" id="7248704">=</span>&nbsp;<span class="ident" id="7248706">idx</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7248711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7248715">mrows</span>&nbsp;<span class="op" id="7248721">:=</span>&nbsp;<span class="op" id="7248724">[</span><span class="op" id="7248725">]</span><span class="op" id="7248726">*</span><span class="ident" id="7248727">row</span><span class="op" id="7248730">{</span><span class="op" id="7248731">}</span><br>
<span class="lineno"></span><span class="ident" id="7248733">rows</span><span class="op" id="7248737">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7248740">for</span>&nbsp;<span class="ident" id="7248744">_</span><span class="op" id="7248745">,</span>&nbsp;<span class="ident" id="7248747">trow</span>&nbsp;<span class="op" id="7248752">:=</span>&nbsp;<span class="keyword" id="7248755">range</span>&nbsp;<span class="ident" id="7248761">t</span><span class="op" id="7248762">.</span><span class="ident" id="7248763">rows</span>&nbsp;<span class="op" id="7248768">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7248772">//&nbsp;Process&nbsp;the&nbsp;where&nbsp;clause,&nbsp;skipping&nbsp;non-match&nbsp;rows.&nbsp;This&nbsp;is&nbsp;lazy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7248841">//&nbsp;and&nbsp;just&nbsp;uses&nbsp;fmt.Sprintf(&#34;%v&#34;)&nbsp;to&nbsp;test&nbsp;equality.&nbsp;&nbsp;Good&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7248909">//&nbsp;for&nbsp;test&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7248929">for</span>&nbsp;<span class="ident" id="7248933">widx</span><span class="op" id="7248937">,</span>&nbsp;<span class="ident" id="7248939">wcol</span>&nbsp;<span class="op" id="7248944">:=</span>&nbsp;<span class="keyword" id="7248947">range</span>&nbsp;<span class="ident" id="7248953">s</span><span class="op" id="7248954">.</span><span class="ident" id="7248955">whereCol</span>&nbsp;<span class="op" id="7248964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7248969">idx</span>&nbsp;<span class="op" id="7248973">:=</span>&nbsp;<span class="ident" id="7248976">t</span><span class="op" id="7248977">.</span><span class="ident" id="7248978">columnIndex</span><span class="op" id="7248989">(</span><span class="ident" id="7248990">wcol</span><span class="op" id="7248994">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7248999">if</span>&nbsp;<span class="ident" id="7249002">idx</span>&nbsp;<span class="op" id="7249006">==</span>&nbsp;<span class="op" id="7249009">-</span><span class="num" id="7249010">1</span>&nbsp;<span class="op" id="7249012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7249018">return</span>&nbsp;<span class="ident" id="7249025">nil</span><span class="op" id="7249028">,</span>&nbsp;<span class="ident" id="7249030">fmt</span><span class="op" id="7249033">.</span><span class="ident" id="7249034">Errorf</span><span class="op" id="7249040">(</span><span class="string" id="7249041">&#34;db:&nbsp;invalid&nbsp;where&nbsp;clause&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7249077">,</span>&nbsp;<span class="ident" id="7249079">wcol</span><span class="op" id="7249083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7249088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249093">tcol</span>&nbsp;<span class="op" id="7249098">:=</span>&nbsp;<span class="ident" id="7249101">trow</span><span class="op" id="7249105">.</span><span class="ident" id="7249106">cols</span><span class="op" id="7249110">[</span><span class="ident" id="7249111">idx</span><span class="op" id="7249114">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7249119">if</span>&nbsp;<span class="ident" id="7249122">bs</span><span class="op" id="7249124">,</span>&nbsp;<span class="ident" id="7249126">ok</span>&nbsp;<span class="op" id="7249129">:=</span>&nbsp;<span class="ident" id="7249132">tcol</span><span class="op" id="7249136">.</span><span class="op" id="7249137">(</span><span class="op" id="7249138">[</span><span class="op" id="7249139">]</span><span class="builtintype" id="7249140">byte</span><span class="op" id="7249144">)</span><span class="op" id="7249145">;</span>&nbsp;<span class="ident" id="7249147">ok</span>&nbsp;<span class="op" id="7249150">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7249156">//&nbsp;lazy&nbsp;hack&nbsp;to&nbsp;avoid&nbsp;sprintf&nbsp;%v&nbsp;on&nbsp;a&nbsp;[]byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249205">tcol</span>&nbsp;<span class="op" id="7249210">=</span>&nbsp;<span class="builtintype" id="7249212">string</span><span class="op" id="7249218">(</span><span class="ident" id="7249219">bs</span><span class="op" id="7249221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7249226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7249231">if</span>&nbsp;<span class="ident" id="7249234">fmt</span><span class="op" id="7249237">.</span><span class="ident" id="7249238">Sprintf</span><span class="op" id="7249245">(</span><span class="string" id="7249246">&#34;%v&#34;</span><span class="op" id="7249250">,</span>&nbsp;<span class="ident" id="7249252">tcol</span><span class="op" id="7249256">)</span>&nbsp;<span class="op" id="7249258">!=</span>&nbsp;<span class="ident" id="7249261">fmt</span><span class="op" id="7249264">.</span><span class="ident" id="7249265">Sprintf</span><span class="op" id="7249272">(</span><span class="string" id="7249273">&#34;%v&#34;</span><span class="op" id="7249277">,</span>&nbsp;<span class="ident" id="7249279">args</span><span class="op" id="7249283">[</span><span class="ident" id="7249284">widx</span><span class="op" id="7249288">]</span><span class="op" id="7249289">)</span>&nbsp;<span class="op" id="7249291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7249297">continue</span>&nbsp;<span class="ident" id="7249306">rows</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7249314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7249318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249322">mrow</span>&nbsp;<span class="op" id="7249327">:=</span>&nbsp;<span class="op" id="7249330">&amp;</span><span class="ident" id="7249331">row</span><span class="op" id="7249334">{</span><span class="ident" id="7249335">cols</span><span class="op" id="7249339">:</span>&nbsp;<span class="builtinfunc" id="7249341">make</span><span class="op" id="7249345">(</span><span class="op" id="7249346">[</span><span class="op" id="7249347">]</span><span class="keyword" id="7249348">interface</span><span class="op" id="7249357">{</span><span class="op" id="7249358">}</span><span class="op" id="7249359">,</span>&nbsp;<span class="builtinfunc" id="7249361">len</span><span class="op" id="7249364">(</span><span class="ident" id="7249365">s</span><span class="op" id="7249366">.</span><span class="ident" id="7249367">colName</span><span class="op" id="7249374">)</span><span class="op" id="7249375">)</span><span class="op" id="7249376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7249380">for</span>&nbsp;<span class="ident" id="7249384">seli</span><span class="op" id="7249388">,</span>&nbsp;<span class="ident" id="7249390">name</span>&nbsp;<span class="op" id="7249395">:=</span>&nbsp;<span class="keyword" id="7249398">range</span>&nbsp;<span class="ident" id="7249404">s</span><span class="op" id="7249405">.</span><span class="ident" id="7249406">colName</span>&nbsp;<span class="op" id="7249414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249419">mrow</span><span class="op" id="7249423">.</span><span class="ident" id="7249424">cols</span><span class="op" id="7249428">[</span><span class="ident" id="7249429">seli</span><span class="op" id="7249433">]</span>&nbsp;<span class="op" id="7249435">=</span>&nbsp;<span class="ident" id="7249437">trow</span><span class="op" id="7249441">.</span><span class="ident" id="7249442">cols</span><span class="op" id="7249446">[</span><span class="ident" id="7249447">colIdx</span><span class="op" id="7249453">[</span><span class="ident" id="7249454">name</span><span class="op" id="7249458">]</span><span class="op" id="7249459">]</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7249463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249467">mrows</span>&nbsp;<span class="op" id="7249473">=</span>&nbsp;<span class="builtinfunc" id="7249475">append</span><span class="op" id="7249481">(</span><span class="ident" id="7249482">mrows</span><span class="op" id="7249487">,</span>&nbsp;<span class="ident" id="7249489">mrow</span><span class="op" id="7249493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7249496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249500">cursor</span>&nbsp;<span class="op" id="7249507">:=</span>&nbsp;<span class="op" id="7249510">&amp;</span><span class="ident" id="7249511">rowsCursor</span><span class="op" id="7249521">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249525">pos</span><span class="op" id="7249528">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7249533">-</span><span class="num" id="7249534">1</span><span class="op" id="7249535">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249539">rows</span><span class="op" id="7249543">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7249547">mrows</span><span class="op" id="7249552">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249556">cols</span><span class="op" id="7249560">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7249564">s</span><span class="op" id="7249565">.</span><span class="ident" id="7249566">colName</span><span class="op" id="7249573">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249577">errPos</span><span class="op" id="7249583">:</span>&nbsp;<span class="op" id="7249585">-</span><span class="num" id="7249586">1</span><span class="op" id="7249587">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7249590">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7249593">return</span>&nbsp;<span class="ident" id="7249600">cursor</span><span class="op" id="7249606">,</span>&nbsp;<span class="ident" id="7249608">nil</span><br>
<span class="lineno"></span><span class="op" id="7249612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7249615">func</span>&nbsp;<span class="op" id="7249620">(</span><span class="ident" id="7249621">s</span>&nbsp;<span class="op" id="7249623">*</span><span class="ident" id="7249624">fakeStmt</span><span class="op" id="7249632">)</span>&nbsp;<span class="ident" id="7249634">NumInput</span><span class="op" id="7249642">(</span><span class="op" id="7249643">)</span>&nbsp;<span class="builtintype" id="7249645">int</span>&nbsp;<span class="op" id="7249649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7249652">return</span>&nbsp;<span class="ident" id="7249659">s</span><span class="op" id="7249660">.</span><span class="ident" id="7249661">placeholders</span><br>
<span class="lineno">695</span><span class="op" id="7249674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7249677">func</span>&nbsp;<span class="op" id="7249682">(</span><span class="ident" id="7249683">tx</span>&nbsp;<span class="op" id="7249686">*</span><span class="ident" id="7249687">fakeTx</span><span class="op" id="7249693">)</span>&nbsp;<span class="ident" id="7249695">Commit</span><span class="op" id="7249701">(</span><span class="op" id="7249702">)</span>&nbsp;<span class="builtintype" id="7249704">error</span>&nbsp;<span class="op" id="7249710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249713">tx</span><span class="op" id="7249715">.</span><span class="ident" id="7249716">c</span><span class="op" id="7249717">.</span><span class="ident" id="7249718">currTx</span>&nbsp;<span class="op" id="7249725">=</span>&nbsp;<span class="ident" id="7249727">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7249732">return</span>&nbsp;<span class="ident" id="7249739">nil</span><br>
<span class="lineno">700</span><span class="op" id="7249743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7249746">func</span>&nbsp;<span class="op" id="7249751">(</span><span class="ident" id="7249752">tx</span>&nbsp;<span class="op" id="7249755">*</span><span class="ident" id="7249756">fakeTx</span><span class="op" id="7249762">)</span>&nbsp;<span class="ident" id="7249764">Rollback</span><span class="op" id="7249772">(</span><span class="op" id="7249773">)</span>&nbsp;<span class="builtintype" id="7249775">error</span>&nbsp;<span class="op" id="7249781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249784">tx</span><span class="op" id="7249786">.</span><span class="ident" id="7249787">c</span><span class="op" id="7249788">.</span><span class="ident" id="7249789">currTx</span>&nbsp;<span class="op" id="7249796">=</span>&nbsp;<span class="ident" id="7249798">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7249803">return</span>&nbsp;<span class="ident" id="7249810">nil</span><br>
<span class="lineno">705</span><span class="op" id="7249814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7249817">type</span>&nbsp;<span class="ident" id="7249822">rowsCursor</span>&nbsp;<span class="keyword" id="7249833">struct</span>&nbsp;<span class="op" id="7249840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249843">cols</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7249850">[</span><span class="op" id="7249851">]</span><span class="builtintype" id="7249852">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249860">pos</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7249867">int</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249872">rows</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7249879">[</span><span class="op" id="7249880">]</span><span class="op" id="7249881">*</span><span class="ident" id="7249882">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249887">closed</span>&nbsp;<span class="builtintype" id="7249894">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7249901">//&nbsp;errPos&nbsp;and&nbsp;err&nbsp;are&nbsp;for&nbsp;making&nbsp;Next&nbsp;return&nbsp;early&nbsp;with&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249965">errPos</span>&nbsp;<span class="builtintype" id="7249972">int</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7249977">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7249984">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7249992">//&nbsp;a&nbsp;clone&nbsp;of&nbsp;slices&nbsp;to&nbsp;give&nbsp;out&nbsp;to&nbsp;clients,&nbsp;indexed&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7250053">//&nbsp;the&nbsp;original&nbsp;slice&#39;s&nbsp;first&nbsp;byte&nbsp;address.&nbsp;&nbsp;we&nbsp;clone&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7250113">//&nbsp;just&nbsp;so&nbsp;we&#39;re&nbsp;able&nbsp;to&nbsp;corrupt&nbsp;them&nbsp;on&nbsp;close.</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7250162">bytesClone</span>&nbsp;<span class="keyword" id="7250173">map</span><span class="op" id="7250176">[</span><span class="op" id="7250177">*</span><span class="builtintype" id="7250178">byte</span><span class="op" id="7250182">]</span><span class="op" id="7250183">[</span><span class="op" id="7250184">]</span><span class="builtintype" id="7250185">byte</span><br>
<span class="lineno"></span><span class="op" id="7250190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7250193">func</span>&nbsp;<span class="op" id="7250198">(</span><span class="ident" id="7250199">rc</span>&nbsp;<span class="op" id="7250202">*</span><span class="ident" id="7250203">rowsCursor</span><span class="op" id="7250213">)</span>&nbsp;<span class="ident" id="7250215">Close</span><span class="op" id="7250220">(</span><span class="op" id="7250221">)</span>&nbsp;<span class="builtintype" id="7250223">error</span>&nbsp;<span class="op" id="7250229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7250232">if</span>&nbsp;<span class="op" id="7250235">!</span><span class="ident" id="7250236">rc</span><span class="op" id="7250238">.</span><span class="ident" id="7250239">closed</span>&nbsp;<span class="op" id="7250246">{</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7250250">for</span>&nbsp;<span class="ident" id="7250254">_</span><span class="op" id="7250255">,</span>&nbsp;<span class="ident" id="7250257">bs</span>&nbsp;<span class="op" id="7250260">:=</span>&nbsp;<span class="keyword" id="7250263">range</span>&nbsp;<span class="ident" id="7250269">rc</span><span class="op" id="7250271">.</span><span class="ident" id="7250272">bytesClone</span>&nbsp;<span class="op" id="7250283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7250288">bs</span><span class="op" id="7250290">[</span><span class="num" id="7250291">0</span><span class="op" id="7250292">]</span>&nbsp;<span class="op" id="7250294">=</span>&nbsp;<span class="num" id="7250296">255</span>&nbsp;<span class="comment" id="7250300">//&nbsp;first&nbsp;byte&nbsp;corrupted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7250326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7250329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7250332">rc</span><span class="op" id="7250334">.</span><span class="ident" id="7250335">closed</span>&nbsp;<span class="op" id="7250342">=</span>&nbsp;<span class="ident" id="7250344">true</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7250350">return</span>&nbsp;<span class="ident" id="7250357">nil</span><br>
<span class="lineno"></span><span class="op" id="7250361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7250364">func</span>&nbsp;<span class="op" id="7250369">(</span><span class="ident" id="7250370">rc</span>&nbsp;<span class="op" id="7250373">*</span><span class="ident" id="7250374">rowsCursor</span><span class="op" id="7250384">)</span>&nbsp;<span class="ident" id="7250386">Columns</span><span class="op" id="7250393">(</span><span class="op" id="7250394">)</span>&nbsp;<span class="op" id="7250396">[</span><span class="op" id="7250397">]</span><span class="builtintype" id="7250398">string</span>&nbsp;<span class="op" id="7250405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7250408">return</span>&nbsp;<span class="ident" id="7250415">rc</span><span class="op" id="7250417">.</span><span class="ident" id="7250418">cols</span><br>
<span class="lineno">735</span><span class="op" id="7250423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7250426">var</span>&nbsp;<span class="ident" id="7250430">rowsCursorNextHook</span>&nbsp;<span class="keyword" id="7250449">func</span><span class="op" id="7250453">(</span><span class="ident" id="7250454">dest</span>&nbsp;<span class="op" id="7250459">[</span><span class="op" id="7250460">]</span><span class="ident" id="7250461">driver</span><span class="op" id="7250467">.</span><span class="ident" id="7250468">Value</span><span class="op" id="7250473">)</span>&nbsp;<span class="builtintype" id="7250475">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7250482">func</span>&nbsp;<span class="op" id="7250487">(</span><span class="ident" id="7250488">rc</span>&nbsp;<span class="op" id="7250491">*</span><span class="ident" id="7250492">rowsCursor</span><span class="op" id="7250502">)</span>&nbsp;<span class="ident" id="7250504">Next</span><span class="op" id="7250508">(</span><span class="ident" id="7250509">dest</span>&nbsp;<span class="op" id="7250514">[</span><span class="op" id="7250515">]</span><span class="ident" id="7250516">driver</span><span class="op" id="7250522">.</span><span class="ident" id="7250523">Value</span><span class="op" id="7250528">)</span>&nbsp;<span class="builtintype" id="7250530">error</span>&nbsp;<span class="op" id="7250536">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7250539">if</span>&nbsp;<span class="ident" id="7250542">rowsCursorNextHook</span>&nbsp;<span class="op" id="7250561">!=</span>&nbsp;<span class="ident" id="7250564">nil</span>&nbsp;<span class="op" id="7250568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7250572">return</span>&nbsp;<span class="ident" id="7250579">rowsCursorNextHook</span><span class="op" id="7250597">(</span><span class="ident" id="7250598">dest</span><span class="op" id="7250602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7250605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7250609">if</span>&nbsp;<span class="ident" id="7250612">rc</span><span class="op" id="7250614">.</span><span class="ident" id="7250615">closed</span>&nbsp;<span class="op" id="7250622">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7250626">return</span>&nbsp;<span class="ident" id="7250633">errors</span><span class="op" id="7250639">.</span><span class="ident" id="7250640">New</span><span class="op" id="7250643">(</span><span class="string" id="7250644">&#34;fakedb:&nbsp;cursor&nbsp;is&nbsp;closed&#34;</span><span class="op" id="7250670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7250673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7250676">rc</span><span class="op" id="7250678">.</span><span class="ident" id="7250679">pos</span><span class="op" id="7250682">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7250686">if</span>&nbsp;<span class="ident" id="7250689">rc</span><span class="op" id="7250691">.</span><span class="ident" id="7250692">pos</span>&nbsp;<span class="op" id="7250696">==</span>&nbsp;<span class="ident" id="7250699">rc</span><span class="op" id="7250701">.</span><span class="ident" id="7250702">errPos</span>&nbsp;<span class="op" id="7250709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7250713">return</span>&nbsp;<span class="ident" id="7250720">rc</span><span class="op" id="7250722">.</span><span class="ident" id="7250723">err</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7250728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7250731">if</span>&nbsp;<span class="ident" id="7250734">rc</span><span class="op" id="7250736">.</span><span class="ident" id="7250737">pos</span>&nbsp;<span class="op" id="7250741">&gt;=</span>&nbsp;<span class="builtinfunc" id="7250744">len</span><span class="op" id="7250747">(</span><span class="ident" id="7250748">rc</span><span class="op" id="7250750">.</span><span class="ident" id="7250751">rows</span><span class="op" id="7250755">)</span>&nbsp;<span class="op" id="7250757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7250761">return</span>&nbsp;<span class="ident" id="7250768">io</span><span class="op" id="7250770">.</span><span class="ident" id="7250771">EOF</span>&nbsp;<span class="comment" id="7250775">//&nbsp;per&nbsp;interface&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7250798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7250801">for</span>&nbsp;<span class="ident" id="7250805">i</span><span class="op" id="7250806">,</span>&nbsp;<span class="ident" id="7250808">v</span>&nbsp;<span class="op" id="7250810">:=</span>&nbsp;<span class="keyword" id="7250813">range</span>&nbsp;<span class="ident" id="7250819">rc</span><span class="op" id="7250821">.</span><span class="ident" id="7250822">rows</span><span class="op" id="7250826">[</span><span class="ident" id="7250827">rc</span><span class="op" id="7250829">.</span><span class="ident" id="7250830">pos</span><span class="op" id="7250833">]</span><span class="op" id="7250834">.</span><span class="ident" id="7250835">cols</span>&nbsp;<span class="op" id="7250840">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7250844">//&nbsp;TODO(bradfitz):&nbsp;convert&nbsp;to&nbsp;subset&nbsp;types?&nbsp;naah,&nbsp;I</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7250898">//&nbsp;think&nbsp;the&nbsp;subset&nbsp;types&nbsp;should&nbsp;only&nbsp;be&nbsp;input&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7250950">//&nbsp;driver,&nbsp;but&nbsp;the&nbsp;sql&nbsp;package&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7251008">//&nbsp;a&nbsp;wider&nbsp;range&nbsp;of&nbsp;types&nbsp;coming&nbsp;out&nbsp;of&nbsp;drivers.&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7251063">//&nbsp;for&nbsp;ease&nbsp;of&nbsp;drivers,&nbsp;and&nbsp;to&nbsp;prevent&nbsp;drivers&nbsp;from</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7251117">//&nbsp;messing&nbsp;up&nbsp;conversions&nbsp;or&nbsp;doing&nbsp;them&nbsp;differently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7251172">dest</span><span class="op" id="7251176">[</span><span class="ident" id="7251177">i</span><span class="op" id="7251178">]</span>&nbsp;<span class="op" id="7251180">=</span>&nbsp;<span class="ident" id="7251182">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7251187">if</span>&nbsp;<span class="ident" id="7251190">bs</span><span class="op" id="7251192">,</span>&nbsp;<span class="ident" id="7251194">ok</span>&nbsp;<span class="op" id="7251197">:=</span>&nbsp;<span class="ident" id="7251200">v</span><span class="op" id="7251201">.</span><span class="op" id="7251202">(</span><span class="op" id="7251203">[</span><span class="op" id="7251204">]</span><span class="builtintype" id="7251205">byte</span><span class="op" id="7251209">)</span><span class="op" id="7251210">;</span>&nbsp;<span class="ident" id="7251212">ok</span>&nbsp;<span class="op" id="7251215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7251220">if</span>&nbsp;<span class="ident" id="7251223">rc</span><span class="op" id="7251225">.</span><span class="ident" id="7251226">bytesClone</span>&nbsp;<span class="op" id="7251237">==</span>&nbsp;<span class="ident" id="7251240">nil</span>&nbsp;<span class="op" id="7251244">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7251250">rc</span><span class="op" id="7251252">.</span><span class="ident" id="7251253">bytesClone</span>&nbsp;<span class="op" id="7251264">=</span>&nbsp;<span class="builtinfunc" id="7251266">make</span><span class="op" id="7251270">(</span><span class="keyword" id="7251271">map</span><span class="op" id="7251274">[</span><span class="op" id="7251275">*</span><span class="builtintype" id="7251276">byte</span><span class="op" id="7251280">]</span><span class="op" id="7251281">[</span><span class="op" id="7251282">]</span><span class="builtintype" id="7251283">byte</span><span class="op" id="7251287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7251292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7251297">clone</span><span class="op" id="7251302">,</span>&nbsp;<span class="ident" id="7251304">ok</span>&nbsp;<span class="op" id="7251307">:=</span>&nbsp;<span class="ident" id="7251310">rc</span><span class="op" id="7251312">.</span><span class="ident" id="7251313">bytesClone</span><span class="op" id="7251323">[</span><span class="op" id="7251324">&amp;</span><span class="ident" id="7251325">bs</span><span class="op" id="7251327">[</span><span class="num" id="7251328">0</span><span class="op" id="7251329">]</span><span class="op" id="7251330">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7251335">if</span>&nbsp;<span class="op" id="7251338">!</span><span class="ident" id="7251339">ok</span>&nbsp;<span class="op" id="7251342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7251348">clone</span>&nbsp;<span class="op" id="7251354">=</span>&nbsp;<span class="builtinfunc" id="7251356">make</span><span class="op" id="7251360">(</span><span class="op" id="7251361">[</span><span class="op" id="7251362">]</span><span class="builtintype" id="7251363">byte</span><span class="op" id="7251367">,</span>&nbsp;<span class="builtinfunc" id="7251369">len</span><span class="op" id="7251372">(</span><span class="ident" id="7251373">bs</span><span class="op" id="7251375">)</span><span class="op" id="7251376">)</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7251382">copy</span><span class="op" id="7251386">(</span><span class="ident" id="7251387">clone</span><span class="op" id="7251392">,</span>&nbsp;<span class="ident" id="7251394">bs</span><span class="op" id="7251396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7251402">rc</span><span class="op" id="7251404">.</span><span class="ident" id="7251405">bytesClone</span><span class="op" id="7251415">[</span><span class="op" id="7251416">&amp;</span><span class="ident" id="7251417">bs</span><span class="op" id="7251419">[</span><span class="num" id="7251420">0</span><span class="op" id="7251421">]</span><span class="op" id="7251422">]</span>&nbsp;<span class="op" id="7251424">=</span>&nbsp;<span class="ident" id="7251426">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7251435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7251440">dest</span><span class="op" id="7251444">[</span><span class="ident" id="7251445">i</span><span class="op" id="7251446">]</span>&nbsp;<span class="op" id="7251448">=</span>&nbsp;<span class="ident" id="7251450">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7251458">}</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7251461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7251464">return</span>&nbsp;<span class="ident" id="7251471">nil</span><br>
<span class="lineno"></span><span class="op" id="7251475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7251478">//&nbsp;fakeDriverString&nbsp;is&nbsp;like&nbsp;driver.String,&nbsp;but&nbsp;indirects&nbsp;pointers&nbsp;like</span><br>
<span class="lineno">780</span><span class="comment" id="7251549">//&nbsp;DefaultValueConverter.</span><br>
<span class="lineno"></span><span class="comment" id="7251575">//</span><br>
<span class="lineno"></span><span class="comment" id="7251578">//&nbsp;This&nbsp;could&nbsp;be&nbsp;surprising&nbsp;behavior&nbsp;to&nbsp;retroactively&nbsp;apply&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="7251641">//&nbsp;driver.String&nbsp;now&nbsp;that&nbsp;Go1&nbsp;is&nbsp;out,&nbsp;but&nbsp;this&nbsp;is&nbsp;convenient&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="7251706">//&nbsp;our&nbsp;TestPointerParamsAndScans.</span><br>
<span class="lineno">785</span><span class="comment" id="7251740">//</span><br>
<span class="lineno"></span><span class="keyword" id="7251743">type</span>&nbsp;<span class="ident" id="7251748">fakeDriverString</span>&nbsp;<span class="keyword" id="7251765">struct</span><span class="op" id="7251771">{</span><span class="op" id="7251772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7251775">func</span>&nbsp;<span class="op" id="7251780">(</span><span class="ident" id="7251781">fakeDriverString</span><span class="op" id="7251797">)</span>&nbsp;<span class="ident" id="7251799">ConvertValue</span><span class="op" id="7251811">(</span><span class="ident" id="7251812">v</span>&nbsp;<span class="keyword" id="7251814">interface</span><span class="op" id="7251823">{</span><span class="op" id="7251824">}</span><span class="op" id="7251825">)</span>&nbsp;<span class="op" id="7251827">(</span><span class="ident" id="7251828">driver</span><span class="op" id="7251834">.</span><span class="ident" id="7251835">Value</span><span class="op" id="7251840">,</span>&nbsp;<span class="builtintype" id="7251842">error</span><span class="op" id="7251847">)</span>&nbsp;<span class="op" id="7251849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7251852">switch</span>&nbsp;<span class="ident" id="7251859">c</span>&nbsp;<span class="op" id="7251861">:=</span>&nbsp;<span class="ident" id="7251864">v</span><span class="op" id="7251865">.</span><span class="op" id="7251866">(</span><span class="keyword" id="7251867">type</span><span class="op" id="7251871">)</span>&nbsp;<span class="op" id="7251873">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7251876">case</span>&nbsp;<span class="builtintype" id="7251881">string</span><span class="op" id="7251887">,</span>&nbsp;<span class="op" id="7251889">[</span><span class="op" id="7251890">]</span><span class="builtintype" id="7251891">byte</span><span class="op" id="7251895">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7251899">return</span>&nbsp;<span class="ident" id="7251906">v</span><span class="op" id="7251907">,</span>&nbsp;<span class="ident" id="7251909">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7251914">case</span>&nbsp;<span class="op" id="7251919">*</span><span class="builtintype" id="7251920">string</span><span class="op" id="7251926">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7251930">if</span>&nbsp;<span class="ident" id="7251933">c</span>&nbsp;<span class="op" id="7251935">==</span>&nbsp;<span class="ident" id="7251938">nil</span>&nbsp;<span class="op" id="7251942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7251947">return</span>&nbsp;<span class="ident" id="7251954">nil</span><span class="op" id="7251957">,</span>&nbsp;<span class="ident" id="7251959">nil</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7251965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7251969">return</span>&nbsp;<span class="op" id="7251976">*</span><span class="ident" id="7251977">c</span><span class="op" id="7251978">,</span>&nbsp;<span class="ident" id="7251980">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7251985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7251988">return</span>&nbsp;<span class="ident" id="7251995">fmt</span><span class="op" id="7251998">.</span><span class="ident" id="7251999">Sprintf</span><span class="op" id="7252006">(</span><span class="string" id="7252007">&#34;%v&#34;</span><span class="op" id="7252011">,</span>&nbsp;<span class="ident" id="7252013">v</span><span class="op" id="7252014">)</span><span class="op" id="7252015">,</span>&nbsp;<span class="ident" id="7252017">nil</span><br>
<span class="lineno"></span><span class="op" id="7252021">}</span><br>
<span class="lineno">800</span><br>
<span class="lineno"></span><span class="keyword" id="7252024">func</span>&nbsp;<span class="ident" id="7252029">converterForType</span><span class="op" id="7252045">(</span><span class="ident" id="7252046">typ</span>&nbsp;<span class="builtintype" id="7252050">string</span><span class="op" id="7252056">)</span>&nbsp;<span class="ident" id="7252058">driver</span><span class="op" id="7252064">.</span><span class="ident" id="7252065">ValueConverter</span>&nbsp;<span class="op" id="7252080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252083">switch</span>&nbsp;<span class="ident" id="7252090">typ</span>&nbsp;<span class="op" id="7252094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252097">case</span>&nbsp;<span class="string" id="7252102">&#34;bool&#34;</span><span class="op" id="7252108">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252112">return</span>&nbsp;<span class="ident" id="7252119">driver</span><span class="op" id="7252125">.</span><span class="ident" id="7252126">Bool</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252132">case</span>&nbsp;<span class="string" id="7252137">&#34;nullbool&#34;</span><span class="op" id="7252147">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252151">return</span>&nbsp;<span class="ident" id="7252158">driver</span><span class="op" id="7252164">.</span><span class="ident" id="7252165">Null</span><span class="op" id="7252169">{</span><span class="ident" id="7252170">Converter</span><span class="op" id="7252179">:</span>&nbsp;<span class="ident" id="7252181">driver</span><span class="op" id="7252187">.</span><span class="ident" id="7252188">Bool</span><span class="op" id="7252192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252195">case</span>&nbsp;<span class="string" id="7252200">&#34;int32&#34;</span><span class="op" id="7252207">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252211">return</span>&nbsp;<span class="ident" id="7252218">driver</span><span class="op" id="7252224">.</span><span class="ident" id="7252225">Int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252232">case</span>&nbsp;<span class="string" id="7252237">&#34;string&#34;</span><span class="op" id="7252245">:</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252249">return</span>&nbsp;<span class="ident" id="7252256">driver</span><span class="op" id="7252262">.</span><span class="ident" id="7252263">NotNull</span><span class="op" id="7252270">{</span><span class="ident" id="7252271">Converter</span><span class="op" id="7252280">:</span>&nbsp;<span class="ident" id="7252282">fakeDriverString</span><span class="op" id="7252298">{</span><span class="op" id="7252299">}</span><span class="op" id="7252300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252303">case</span>&nbsp;<span class="string" id="7252308">&#34;nullstring&#34;</span><span class="op" id="7252320">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252324">return</span>&nbsp;<span class="ident" id="7252331">driver</span><span class="op" id="7252337">.</span><span class="ident" id="7252338">Null</span><span class="op" id="7252342">{</span><span class="ident" id="7252343">Converter</span><span class="op" id="7252352">:</span>&nbsp;<span class="ident" id="7252354">fakeDriverString</span><span class="op" id="7252370">{</span><span class="op" id="7252371">}</span><span class="op" id="7252372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252375">case</span>&nbsp;<span class="string" id="7252380">&#34;int64&#34;</span><span class="op" id="7252387">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7252391">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252443">return</span>&nbsp;<span class="ident" id="7252450">driver</span><span class="op" id="7252456">.</span><span class="ident" id="7252457">NotNull</span><span class="op" id="7252464">{</span><span class="ident" id="7252465">Converter</span><span class="op" id="7252474">:</span>&nbsp;<span class="ident" id="7252476">driver</span><span class="op" id="7252482">.</span><span class="ident" id="7252483">DefaultParameterConverter</span><span class="op" id="7252508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252511">case</span>&nbsp;<span class="string" id="7252516">&#34;nullint64&#34;</span><span class="op" id="7252527">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7252531">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252583">return</span>&nbsp;<span class="ident" id="7252590">driver</span><span class="op" id="7252596">.</span><span class="ident" id="7252597">Null</span><span class="op" id="7252601">{</span><span class="ident" id="7252602">Converter</span><span class="op" id="7252611">:</span>&nbsp;<span class="ident" id="7252613">driver</span><span class="op" id="7252619">.</span><span class="ident" id="7252620">DefaultParameterConverter</span><span class="op" id="7252645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252648">case</span>&nbsp;<span class="string" id="7252653">&#34;float64&#34;</span><span class="op" id="7252662">:</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7252666">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252718">return</span>&nbsp;<span class="ident" id="7252725">driver</span><span class="op" id="7252731">.</span><span class="ident" id="7252732">NotNull</span><span class="op" id="7252739">{</span><span class="ident" id="7252740">Converter</span><span class="op" id="7252749">:</span>&nbsp;<span class="ident" id="7252751">driver</span><span class="op" id="7252757">.</span><span class="ident" id="7252758">DefaultParameterConverter</span><span class="op" id="7252783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252786">case</span>&nbsp;<span class="string" id="7252791">&#34;nullfloat64&#34;</span><span class="op" id="7252804">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7252808">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252860">return</span>&nbsp;<span class="ident" id="7252867">driver</span><span class="op" id="7252873">.</span><span class="ident" id="7252874">Null</span><span class="op" id="7252878">{</span><span class="ident" id="7252879">Converter</span><span class="op" id="7252888">:</span>&nbsp;<span class="ident" id="7252890">driver</span><span class="op" id="7252896">.</span><span class="ident" id="7252897">DefaultParameterConverter</span><span class="op" id="7252922">}</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252925">case</span>&nbsp;<span class="string" id="7252930">&#34;datetime&#34;</span><span class="op" id="7252940">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7252944">return</span>&nbsp;<span class="ident" id="7252951">driver</span><span class="op" id="7252957">.</span><span class="ident" id="7252958">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7252985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7252988">panic</span><span class="op" id="7252993">(</span><span class="string" id="7252994">&#34;invalid&nbsp;fakedb&nbsp;column&nbsp;type&nbsp;of&nbsp;&#34;</span>&nbsp;<span class="op" id="7253027">+</span>&nbsp;<span class="ident" id="7253029">typ</span><span class="op" id="7253032">)</span><br>
<span class="lineno"></span><span class="op" id="7253034">}</span>
</div>
</body>
</html>
