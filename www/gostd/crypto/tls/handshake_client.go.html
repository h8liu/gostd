<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html" class="current">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4220351">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4220406">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4220460">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4220511">package</span>&nbsp;<span class="ident" id="4220519">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4220524">import</span>&nbsp;<span class="op" id="4220531">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4220534">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4220543">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4220553">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4220569">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4220583">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4220600">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4220615">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4220625">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4220632">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4220638">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4220645">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="4220655">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4220658">type</span>&nbsp;<span class="ident" id="4220663">clientHandshakeState</span>&nbsp;<span class="keyword" id="4220684">struct</span>&nbsp;<span class="op" id="4220691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220694">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220707">*</span><span class="ident" id="4220708">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220714">serverHello</span>&nbsp;&nbsp;<span class="op" id="4220727">*</span><span class="ident" id="4220728">serverHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220744">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220757">*</span><span class="ident" id="4220758">clientHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220774">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220787">*</span><span class="ident" id="4220788">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220801">finishedHash</span>&nbsp;<span class="ident" id="4220814">finishedHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220828">masterSecret</span>&nbsp;<span class="op" id="4220841">[</span><span class="op" id="4220842">]</span><span class="builtintype" id="4220843">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220849">session</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220862">*</span><span class="ident" id="4220863">ClientSessionState</span><br>
<span class="lineno"></span><span class="op" id="4220882">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="4220885">func</span>&nbsp;<span class="op" id="4220890">(</span><span class="ident" id="4220891">c</span>&nbsp;<span class="op" id="4220893">*</span><span class="ident" id="4220894">Conn</span><span class="op" id="4220898">)</span>&nbsp;<span class="ident" id="4220900">clientHandshake</span><span class="op" id="4220915">(</span><span class="op" id="4220916">)</span>&nbsp;<span class="builtintype" id="4220918">error</span>&nbsp;<span class="op" id="4220924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220927">if</span>&nbsp;<span class="ident" id="4220930">c</span><span class="op" id="4220931">.</span><span class="ident" id="4220932">config</span>&nbsp;<span class="op" id="4220939">==</span>&nbsp;<span class="builtintype" id="4220942">nil</span>&nbsp;<span class="op" id="4220946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220950">c</span><span class="op" id="4220951">.</span><span class="ident" id="4220952">config</span>&nbsp;<span class="op" id="4220959">=</span>&nbsp;<span class="ident" id="4220961">defaultConfig</span><span class="op" id="4220974">(</span><span class="op" id="4220975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220978">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220982">if</span>&nbsp;<span class="builtinfunc" id="4220985">len</span><span class="op" id="4220988">(</span><span class="ident" id="4220989">c</span><span class="op" id="4220990">.</span><span class="ident" id="4220991">config</span><span class="op" id="4220997">.</span><span class="ident" id="4220998">ServerName</span><span class="op" id="4221008">)</span>&nbsp;<span class="op" id="4221010">==</span>&nbsp;<span class="num" id="4221013">0</span>&nbsp;<span class="op" id="4221015">&amp;&amp;</span>&nbsp;<span class="op" id="4221018">!</span><span class="ident" id="4221019">c</span><span class="op" id="4221020">.</span><span class="ident" id="4221021">config</span><span class="op" id="4221027">.</span><span class="ident" id="4221028">InsecureSkipVerify</span>&nbsp;<span class="op" id="4221047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221051">return</span>&nbsp;<span class="ident" id="4221058">errors</span><span class="op" id="4221064">.</span><span class="ident" id="4221065">New</span><span class="op" id="4221068">(</span><span class="string" id="4221069">&#34;tls:&nbsp;either&nbsp;ServerName&nbsp;or&nbsp;InsecureSkipVerify&nbsp;must&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;tls.Config&#34;</span><span class="op" id="4221151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221158">nextProtosLength</span>&nbsp;<span class="op" id="4221175">:=</span>&nbsp;<span class="num" id="4221178">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221181">for</span>&nbsp;<span class="ident" id="4221185">_</span><span class="op" id="4221186">,</span>&nbsp;<span class="ident" id="4221188">proto</span>&nbsp;<span class="op" id="4221194">:=</span>&nbsp;<span class="keyword" id="4221197">range</span>&nbsp;<span class="ident" id="4221203">c</span><span class="op" id="4221204">.</span><span class="ident" id="4221205">config</span><span class="op" id="4221211">.</span><span class="ident" id="4221212">NextProtos</span>&nbsp;<span class="op" id="4221223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221227">if</span>&nbsp;<span class="ident" id="4221230">l</span>&nbsp;<span class="op" id="4221232">:=</span>&nbsp;<span class="builtinfunc" id="4221235">len</span><span class="op" id="4221238">(</span><span class="ident" id="4221239">proto</span><span class="op" id="4221244">)</span><span class="op" id="4221245">;</span>&nbsp;<span class="ident" id="4221247">l</span>&nbsp;<span class="op" id="4221249">==</span>&nbsp;<span class="num" id="4221252">0</span>&nbsp;<span class="op" id="4221254">||</span>&nbsp;<span class="ident" id="4221257">l</span>&nbsp;<span class="op" id="4221259">&gt;</span>&nbsp;<span class="num" id="4221261">255</span>&nbsp;<span class="op" id="4221265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221270">return</span>&nbsp;<span class="ident" id="4221277">errors</span><span class="op" id="4221283">.</span><span class="ident" id="4221284">New</span><span class="op" id="4221287">(</span><span class="string" id="4221288">&#34;tls:&nbsp;invalid&nbsp;NextProtos&nbsp;value&#34;</span><span class="op" id="4221319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221323">}</span>&nbsp;<span class="keyword" id="4221325">else</span>&nbsp;<span class="op" id="4221330">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221335">nextProtosLength</span>&nbsp;<span class="op" id="4221352">+=</span>&nbsp;<span class="num" id="4221355">1</span>&nbsp;<span class="op" id="4221357">+</span>&nbsp;<span class="ident" id="4221359">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221369">if</span>&nbsp;<span class="ident" id="4221372">nextProtosLength</span>&nbsp;<span class="op" id="4221389">&gt;</span>&nbsp;<span class="num" id="4221391">0xffff</span>&nbsp;<span class="op" id="4221398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221402">return</span>&nbsp;<span class="ident" id="4221409">errors</span><span class="op" id="4221415">.</span><span class="ident" id="4221416">New</span><span class="op" id="4221419">(</span><span class="string" id="4221420">&#34;tls:&nbsp;NextProtos&nbsp;values&nbsp;too&nbsp;large&#34;</span><span class="op" id="4221454">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221461">hello</span>&nbsp;<span class="op" id="4221467">:=</span>&nbsp;<span class="op" id="4221470">&amp;</span><span class="ident" id="4221471">clientHelloMsg</span><span class="op" id="4221485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221489">vers</span><span class="op" id="4221493">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221510">c</span><span class="op" id="4221511">.</span><span class="ident" id="4221512">config</span><span class="op" id="4221518">.</span><span class="ident" id="4221519">maxVersion</span><span class="op" id="4221529">(</span><span class="op" id="4221530">)</span><span class="op" id="4221531">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221535">compressionMethods</span><span class="op" id="4221553">:</span>&nbsp;&nbsp;<span class="op" id="4221556">[</span><span class="op" id="4221557">]</span><span class="builtintype" id="4221558">uint8</span><span class="op" id="4221563">{</span><span class="ident" id="4221564">compressionNone</span><span class="op" id="4221579">}</span><span class="op" id="4221580">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221584">random</span><span class="op" id="4221590">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4221605">make</span><span class="op" id="4221609">(</span><span class="op" id="4221610">[</span><span class="op" id="4221611">]</span><span class="builtintype" id="4221612">byte</span><span class="op" id="4221616">,</span>&nbsp;<span class="num" id="4221618">32</span><span class="op" id="4221620">)</span><span class="op" id="4221621">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221625">ocspStapling</span><span class="op" id="4221637">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4221646">true</span><span class="op" id="4221650">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221654">serverName</span><span class="op" id="4221664">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221675">c</span><span class="op" id="4221676">.</span><span class="ident" id="4221677">config</span><span class="op" id="4221683">.</span><span class="ident" id="4221684">ServerName</span><span class="op" id="4221694">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221698">supportedCurves</span><span class="op" id="4221713">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221719">c</span><span class="op" id="4221720">.</span><span class="ident" id="4221721">config</span><span class="op" id="4221727">.</span><span class="ident" id="4221728">curvePreferences</span><span class="op" id="4221744">(</span><span class="op" id="4221745">)</span><span class="op" id="4221746">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221750">supportedPoints</span><span class="op" id="4221765">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221771">[</span><span class="op" id="4221772">]</span><span class="builtintype" id="4221773">uint8</span><span class="op" id="4221778">{</span><span class="ident" id="4221779">pointFormatUncompressed</span><span class="op" id="4221802">}</span><span class="op" id="4221803">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221807">nextProtoNeg</span><span class="op" id="4221819">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4221828">len</span><span class="op" id="4221831">(</span><span class="ident" id="4221832">c</span><span class="op" id="4221833">.</span><span class="ident" id="4221834">config</span><span class="op" id="4221840">.</span><span class="ident" id="4221841">NextProtos</span><span class="op" id="4221851">)</span>&nbsp;<span class="op" id="4221853">&gt;</span>&nbsp;<span class="num" id="4221855">0</span><span class="op" id="4221856">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221860">secureRenegotiation</span><span class="op" id="4221879">:</span>&nbsp;<span class="builtintype" id="4221881">true</span><span class="op" id="4221885">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221889">alpnProtocols</span><span class="op" id="4221902">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221910">c</span><span class="op" id="4221911">.</span><span class="ident" id="4221912">config</span><span class="op" id="4221918">.</span><span class="ident" id="4221919">NextProtos</span><span class="op" id="4221929">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221936">possibleCipherSuites</span>&nbsp;<span class="op" id="4221957">:=</span>&nbsp;<span class="ident" id="4221960">c</span><span class="op" id="4221961">.</span><span class="ident" id="4221962">config</span><span class="op" id="4221968">.</span><span class="ident" id="4221969">cipherSuites</span><span class="op" id="4221981">(</span><span class="op" id="4221982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221985">hello</span><span class="op" id="4221990">.</span><span class="ident" id="4221991">cipherSuites</span>&nbsp;<span class="op" id="4222004">=</span>&nbsp;<span class="builtinfunc" id="4222006">make</span><span class="op" id="4222010">(</span><span class="op" id="4222011">[</span><span class="op" id="4222012">]</span><span class="builtintype" id="4222013">uint16</span><span class="op" id="4222019">,</span>&nbsp;<span class="num" id="4222021">0</span><span class="op" id="4222022">,</span>&nbsp;<span class="builtinfunc" id="4222024">len</span><span class="op" id="4222027">(</span><span class="ident" id="4222028">possibleCipherSuites</span><span class="op" id="4222048">)</span><span class="op" id="4222049">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4222052">NextCipherSuite</span><span class="op" id="4222067">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222070">for</span>&nbsp;<span class="ident" id="4222074">_</span><span class="op" id="4222075">,</span>&nbsp;<span class="ident" id="4222077">suiteId</span>&nbsp;<span class="op" id="4222085">:=</span>&nbsp;<span class="keyword" id="4222088">range</span>&nbsp;<span class="ident" id="4222094">possibleCipherSuites</span>&nbsp;<span class="op" id="4222115">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222119">for</span>&nbsp;<span class="ident" id="4222123">_</span><span class="op" id="4222124">,</span>&nbsp;<span class="ident" id="4222126">suite</span>&nbsp;<span class="op" id="4222132">:=</span>&nbsp;<span class="keyword" id="4222135">range</span>&nbsp;<span class="ident" id="4222141">cipherSuites</span>&nbsp;<span class="op" id="4222154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222159">if</span>&nbsp;<span class="ident" id="4222162">suite</span><span class="op" id="4222167">.</span><span class="ident" id="4222168">id</span>&nbsp;<span class="op" id="4222171">!=</span>&nbsp;<span class="ident" id="4222174">suiteId</span>&nbsp;<span class="op" id="4222182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222188">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4222200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4222205">//&nbsp;Don&#39;t&nbsp;advertise&nbsp;TLS&nbsp;1.2-only&nbsp;cipher&nbsp;suites&nbsp;unless</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4222261">//&nbsp;we&#39;re&nbsp;attempting&nbsp;TLS&nbsp;1.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222293">if</span>&nbsp;<span class="ident" id="4222296">hello</span><span class="op" id="4222301">.</span><span class="ident" id="4222302">vers</span>&nbsp;<span class="op" id="4222307">&lt;</span>&nbsp;<span class="ident" id="4222309">VersionTLS12</span>&nbsp;<span class="op" id="4222322">&amp;&amp;</span>&nbsp;<span class="ident" id="4222325">suite</span><span class="op" id="4222330">.</span><span class="ident" id="4222331">flags</span><span class="op" id="4222336">&amp;</span><span class="ident" id="4222337">suiteTLS12</span>&nbsp;<span class="op" id="4222348">!=</span>&nbsp;<span class="num" id="4222351">0</span>&nbsp;<span class="op" id="4222353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222359">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4222371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222376">hello</span><span class="op" id="4222381">.</span><span class="ident" id="4222382">cipherSuites</span>&nbsp;<span class="op" id="4222395">=</span>&nbsp;<span class="builtinfunc" id="4222397">append</span><span class="op" id="4222403">(</span><span class="ident" id="4222404">hello</span><span class="op" id="4222409">.</span><span class="ident" id="4222410">cipherSuites</span><span class="op" id="4222422">,</span>&nbsp;<span class="ident" id="4222424">suiteId</span><span class="op" id="4222431">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222436">continue</span>&nbsp;<span class="ident" id="4222445">NextCipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4222463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4222466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222470">_</span><span class="op" id="4222471">,</span>&nbsp;<span class="ident" id="4222473">err</span>&nbsp;<span class="op" id="4222477">:=</span>&nbsp;<span class="ident" id="4222480">io</span><span class="op" id="4222482">.</span><span class="ident" id="4222483">ReadFull</span><span class="op" id="4222491">(</span><span class="ident" id="4222492">c</span><span class="op" id="4222493">.</span><span class="ident" id="4222494">config</span><span class="op" id="4222500">.</span><span class="ident" id="4222501">rand</span><span class="op" id="4222505">(</span><span class="op" id="4222506">)</span><span class="op" id="4222507">,</span>&nbsp;<span class="ident" id="4222509">hello</span><span class="op" id="4222514">.</span><span class="ident" id="4222515">random</span><span class="op" id="4222521">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222524">if</span>&nbsp;<span class="ident" id="4222527">err</span>&nbsp;<span class="op" id="4222531">!=</span>&nbsp;<span class="builtintype" id="4222534">nil</span>&nbsp;<span class="op" id="4222538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222542">c</span><span class="op" id="4222543">.</span><span class="ident" id="4222544">sendAlert</span><span class="op" id="4222553">(</span><span class="ident" id="4222554">alertInternalError</span><span class="op" id="4222572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222576">return</span>&nbsp;<span class="ident" id="4222583">errors</span><span class="op" id="4222589">.</span><span class="ident" id="4222590">New</span><span class="op" id="4222593">(</span><span class="string" id="4222594">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="4222624">+</span>&nbsp;<span class="ident" id="4222626">err</span><span class="op" id="4222629">.</span><span class="ident" id="4222630">Error</span><span class="op" id="4222635">(</span><span class="op" id="4222636">)</span><span class="op" id="4222637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4222640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222644">if</span>&nbsp;<span class="ident" id="4222647">hello</span><span class="op" id="4222652">.</span><span class="ident" id="4222653">vers</span>&nbsp;<span class="op" id="4222658">&gt;=</span>&nbsp;<span class="ident" id="4222661">VersionTLS12</span>&nbsp;<span class="op" id="4222674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222678">hello</span><span class="op" id="4222683">.</span><span class="ident" id="4222684">signatureAndHashes</span>&nbsp;<span class="op" id="4222703">=</span>&nbsp;<span class="ident" id="4222705">supportedSKXSignatureAlgorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4222738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222742">var</span>&nbsp;<span class="ident" id="4222746">session</span>&nbsp;<span class="op" id="4222754">*</span><span class="ident" id="4222755">ClientSessionState</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222775">var</span>&nbsp;<span class="ident" id="4222779">cacheKey</span>&nbsp;<span class="builtintype" id="4222788">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222796">sessionCache</span>&nbsp;<span class="op" id="4222809">:=</span>&nbsp;<span class="ident" id="4222812">c</span><span class="op" id="4222813">.</span><span class="ident" id="4222814">config</span><span class="op" id="4222820">.</span><span class="ident" id="4222821">ClientSessionCache</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222841">if</span>&nbsp;<span class="ident" id="4222844">c</span><span class="op" id="4222845">.</span><span class="ident" id="4222846">config</span><span class="op" id="4222852">.</span><span class="ident" id="4222853">SessionTicketsDisabled</span>&nbsp;<span class="op" id="4222876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222880">sessionCache</span>&nbsp;<span class="op" id="4222893">=</span>&nbsp;<span class="builtintype" id="4222895">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4222900">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222904">if</span>&nbsp;<span class="ident" id="4222907">sessionCache</span>&nbsp;<span class="op" id="4222920">!=</span>&nbsp;<span class="builtintype" id="4222923">nil</span>&nbsp;<span class="op" id="4222927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222931">hello</span><span class="op" id="4222936">.</span><span class="ident" id="4222937">ticketSupported</span>&nbsp;<span class="op" id="4222953">=</span>&nbsp;<span class="builtintype" id="4222955">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4222963">//&nbsp;Try&nbsp;to&nbsp;resume&nbsp;a&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;session,&nbsp;if</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223022">//&nbsp;available.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223038">cacheKey</span>&nbsp;<span class="op" id="4223047">=</span>&nbsp;<span class="ident" id="4223049">clientSessionCacheKey</span><span class="op" id="4223070">(</span><span class="ident" id="4223071">c</span><span class="op" id="4223072">.</span><span class="ident" id="4223073">conn</span><span class="op" id="4223077">.</span><span class="ident" id="4223078">RemoteAddr</span><span class="op" id="4223088">(</span><span class="op" id="4223089">)</span><span class="op" id="4223090">,</span>&nbsp;<span class="ident" id="4223092">c</span><span class="op" id="4223093">.</span><span class="ident" id="4223094">config</span><span class="op" id="4223100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223104">candidateSession</span><span class="op" id="4223120">,</span>&nbsp;<span class="ident" id="4223122">ok</span>&nbsp;<span class="op" id="4223125">:=</span>&nbsp;<span class="ident" id="4223128">sessionCache</span><span class="op" id="4223140">.</span><span class="ident" id="4223141">Get</span><span class="op" id="4223144">(</span><span class="ident" id="4223145">cacheKey</span><span class="op" id="4223153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4223157">if</span>&nbsp;<span class="ident" id="4223160">ok</span>&nbsp;<span class="op" id="4223163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223168">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;ciphersuite/version&nbsp;used&nbsp;for&nbsp;the</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223222">//&nbsp;previous&nbsp;session&nbsp;are&nbsp;still&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223262">cipherSuiteOk</span>&nbsp;<span class="op" id="4223276">:=</span>&nbsp;<span class="builtintype" id="4223279">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4223288">for</span>&nbsp;<span class="ident" id="4223292">_</span><span class="op" id="4223293">,</span>&nbsp;<span class="ident" id="4223295">id</span>&nbsp;<span class="op" id="4223298">:=</span>&nbsp;<span class="keyword" id="4223301">range</span>&nbsp;<span class="ident" id="4223307">hello</span><span class="op" id="4223312">.</span><span class="ident" id="4223313">cipherSuites</span>&nbsp;<span class="op" id="4223326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4223332">if</span>&nbsp;<span class="ident" id="4223335">id</span>&nbsp;<span class="op" id="4223338">==</span>&nbsp;<span class="ident" id="4223341">candidateSession</span><span class="op" id="4223357">.</span><span class="ident" id="4223358">cipherSuite</span>&nbsp;<span class="op" id="4223370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223377">cipherSuiteOk</span>&nbsp;<span class="op" id="4223391">=</span>&nbsp;<span class="builtintype" id="4223393">true</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4223403">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4223413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4223418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223424">versOk</span>&nbsp;<span class="op" id="4223431">:=</span>&nbsp;<span class="ident" id="4223434">candidateSession</span><span class="op" id="4223450">.</span><span class="ident" id="4223451">vers</span>&nbsp;<span class="op" id="4223456">&gt;=</span>&nbsp;<span class="ident" id="4223459">c</span><span class="op" id="4223460">.</span><span class="ident" id="4223461">config</span><span class="op" id="4223467">.</span><span class="ident" id="4223468">minVersion</span><span class="op" id="4223478">(</span><span class="op" id="4223479">)</span>&nbsp;<span class="op" id="4223481">&amp;&amp;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223488">candidateSession</span><span class="op" id="4223504">.</span><span class="ident" id="4223505">vers</span>&nbsp;<span class="op" id="4223510">&lt;=</span>&nbsp;<span class="ident" id="4223513">c</span><span class="op" id="4223514">.</span><span class="ident" id="4223515">config</span><span class="op" id="4223521">.</span><span class="ident" id="4223522">maxVersion</span><span class="op" id="4223532">(</span><span class="op" id="4223533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4223538">if</span>&nbsp;<span class="ident" id="4223541">versOk</span>&nbsp;<span class="op" id="4223548">&amp;&amp;</span>&nbsp;<span class="ident" id="4223551">cipherSuiteOk</span>&nbsp;<span class="op" id="4223565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223571">session</span>&nbsp;<span class="op" id="4223579">=</span>&nbsp;<span class="ident" id="4223581">candidateSession</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4223601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4223605">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4223608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4223612">if</span>&nbsp;<span class="ident" id="4223615">session</span>&nbsp;<span class="op" id="4223623">!=</span>&nbsp;<span class="builtintype" id="4223626">nil</span>&nbsp;<span class="op" id="4223630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223634">hello</span><span class="op" id="4223639">.</span><span class="ident" id="4223640">sessionTicket</span>&nbsp;<span class="op" id="4223654">=</span>&nbsp;<span class="ident" id="4223656">session</span><span class="op" id="4223663">.</span><span class="ident" id="4223664">sessionTicket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223680">//&nbsp;A&nbsp;random&nbsp;session&nbsp;ID&nbsp;is&nbsp;used&nbsp;to&nbsp;detect&nbsp;when&nbsp;the</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223732">//&nbsp;server&nbsp;accepted&nbsp;the&nbsp;ticket&nbsp;and&nbsp;is&nbsp;resuming&nbsp;a&nbsp;session</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223790">//&nbsp;(see&nbsp;RFC&nbsp;5077).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223811">hello</span><span class="op" id="4223816">.</span><span class="ident" id="4223817">sessionId</span>&nbsp;<span class="op" id="4223827">=</span>&nbsp;<span class="builtinfunc" id="4223829">make</span><span class="op" id="4223833">(</span><span class="op" id="4223834">[</span><span class="op" id="4223835">]</span><span class="builtintype" id="4223836">byte</span><span class="op" id="4223840">,</span>&nbsp;<span class="num" id="4223842">16</span><span class="op" id="4223844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4223848">if</span>&nbsp;<span class="ident" id="4223851">_</span><span class="op" id="4223852">,</span>&nbsp;<span class="ident" id="4223854">err</span>&nbsp;<span class="op" id="4223858">:=</span>&nbsp;<span class="ident" id="4223861">io</span><span class="op" id="4223863">.</span><span class="ident" id="4223864">ReadFull</span><span class="op" id="4223872">(</span><span class="ident" id="4223873">c</span><span class="op" id="4223874">.</span><span class="ident" id="4223875">config</span><span class="op" id="4223881">.</span><span class="ident" id="4223882">rand</span><span class="op" id="4223886">(</span><span class="op" id="4223887">)</span><span class="op" id="4223888">,</span>&nbsp;<span class="ident" id="4223890">hello</span><span class="op" id="4223895">.</span><span class="ident" id="4223896">sessionId</span><span class="op" id="4223905">)</span><span class="op" id="4223906">;</span>&nbsp;<span class="ident" id="4223908">err</span>&nbsp;<span class="op" id="4223912">!=</span>&nbsp;<span class="builtintype" id="4223915">nil</span>&nbsp;<span class="op" id="4223919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223924">c</span><span class="op" id="4223925">.</span><span class="ident" id="4223926">sendAlert</span><span class="op" id="4223935">(</span><span class="ident" id="4223936">alertInternalError</span><span class="op" id="4223954">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4223959">return</span>&nbsp;<span class="ident" id="4223966">errors</span><span class="op" id="4223972">.</span><span class="ident" id="4223973">New</span><span class="op" id="4223976">(</span><span class="string" id="4223977">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="4224007">+</span>&nbsp;<span class="ident" id="4224009">err</span><span class="op" id="4224012">.</span><span class="ident" id="4224013">Error</span><span class="op" id="4224018">(</span><span class="op" id="4224019">)</span><span class="op" id="4224020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4224024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4224027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224031">c</span><span class="op" id="4224032">.</span><span class="ident" id="4224033">writeRecord</span><span class="op" id="4224044">(</span><span class="ident" id="4224045">recordTypeHandshake</span><span class="op" id="4224064">,</span>&nbsp;<span class="ident" id="4224066">hello</span><span class="op" id="4224071">.</span><span class="ident" id="4224072">marshal</span><span class="op" id="4224079">(</span><span class="op" id="4224080">)</span><span class="op" id="4224081">)</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224085">msg</span><span class="op" id="4224088">,</span>&nbsp;<span class="ident" id="4224090">err</span>&nbsp;<span class="op" id="4224094">:=</span>&nbsp;<span class="ident" id="4224097">c</span><span class="op" id="4224098">.</span><span class="ident" id="4224099">readHandshake</span><span class="op" id="4224112">(</span><span class="op" id="4224113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4224116">if</span>&nbsp;<span class="ident" id="4224119">err</span>&nbsp;<span class="op" id="4224123">!=</span>&nbsp;<span class="builtintype" id="4224126">nil</span>&nbsp;<span class="op" id="4224130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4224134">return</span>&nbsp;<span class="ident" id="4224141">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4224146">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224149">serverHello</span><span class="op" id="4224160">,</span>&nbsp;<span class="ident" id="4224162">ok</span>&nbsp;<span class="op" id="4224165">:=</span>&nbsp;<span class="ident" id="4224168">msg</span><span class="op" id="4224171">.</span><span class="op" id="4224172">(</span><span class="op" id="4224173">*</span><span class="ident" id="4224174">serverHelloMsg</span><span class="op" id="4224188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4224191">if</span>&nbsp;<span class="op" id="4224194">!</span><span class="ident" id="4224195">ok</span>&nbsp;<span class="op" id="4224198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224202">c</span><span class="op" id="4224203">.</span><span class="ident" id="4224204">sendAlert</span><span class="op" id="4224213">(</span><span class="ident" id="4224214">alertUnexpectedMessage</span><span class="op" id="4224236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4224240">return</span>&nbsp;<span class="ident" id="4224247">unexpectedMessageError</span><span class="op" id="4224269">(</span><span class="ident" id="4224270">serverHello</span><span class="op" id="4224281">,</span>&nbsp;<span class="ident" id="4224283">msg</span><span class="op" id="4224286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4224289">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224293">vers</span><span class="op" id="4224297">,</span>&nbsp;<span class="ident" id="4224299">ok</span>&nbsp;<span class="op" id="4224302">:=</span>&nbsp;<span class="ident" id="4224305">c</span><span class="op" id="4224306">.</span><span class="ident" id="4224307">config</span><span class="op" id="4224313">.</span><span class="ident" id="4224314">mutualVersion</span><span class="op" id="4224327">(</span><span class="ident" id="4224328">serverHello</span><span class="op" id="4224339">.</span><span class="ident" id="4224340">vers</span><span class="op" id="4224344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4224347">if</span>&nbsp;<span class="op" id="4224350">!</span><span class="ident" id="4224351">ok</span>&nbsp;<span class="op" id="4224354">||</span>&nbsp;<span class="ident" id="4224357">vers</span>&nbsp;<span class="op" id="4224362">&lt;</span>&nbsp;<span class="ident" id="4224364">VersionTLS10</span>&nbsp;<span class="op" id="4224377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4224381">//&nbsp;TLS&nbsp;1.0&nbsp;is&nbsp;the&nbsp;minimum&nbsp;version&nbsp;supported&nbsp;as&nbsp;a&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224440">c</span><span class="op" id="4224441">.</span><span class="ident" id="4224442">sendAlert</span><span class="op" id="4224451">(</span><span class="ident" id="4224452">alertProtocolVersion</span><span class="op" id="4224472">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4224476">return</span>&nbsp;<span class="ident" id="4224483">fmt</span><span class="op" id="4224486">.</span><span class="ident" id="4224487">Errorf</span><span class="op" id="4224493">(</span><span class="string" id="4224494">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;protocol&nbsp;version&nbsp;%x&#34;</span><span class="op" id="4224548">,</span>&nbsp;<span class="ident" id="4224550">serverHello</span><span class="op" id="4224561">.</span><span class="ident" id="4224562">vers</span><span class="op" id="4224566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4224569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224572">c</span><span class="op" id="4224573">.</span><span class="ident" id="4224574">vers</span>&nbsp;<span class="op" id="4224579">=</span>&nbsp;<span class="ident" id="4224581">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224587">c</span><span class="op" id="4224588">.</span><span class="ident" id="4224589">haveVers</span>&nbsp;<span class="op" id="4224598">=</span>&nbsp;<span class="builtintype" id="4224600">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224607">suite</span>&nbsp;<span class="op" id="4224613">:=</span>&nbsp;<span class="ident" id="4224616">mutualCipherSuite</span><span class="op" id="4224633">(</span><span class="ident" id="4224634">c</span><span class="op" id="4224635">.</span><span class="ident" id="4224636">config</span><span class="op" id="4224642">.</span><span class="ident" id="4224643">cipherSuites</span><span class="op" id="4224655">(</span><span class="op" id="4224656">)</span><span class="op" id="4224657">,</span>&nbsp;<span class="ident" id="4224659">serverHello</span><span class="op" id="4224670">.</span><span class="ident" id="4224671">cipherSuite</span><span class="op" id="4224682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4224685">if</span>&nbsp;<span class="ident" id="4224688">suite</span>&nbsp;<span class="op" id="4224694">==</span>&nbsp;<span class="builtintype" id="4224697">nil</span>&nbsp;<span class="op" id="4224701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224705">c</span><span class="op" id="4224706">.</span><span class="ident" id="4224707">sendAlert</span><span class="op" id="4224716">(</span><span class="ident" id="4224717">alertHandshakeFailure</span><span class="op" id="4224738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4224742">return</span>&nbsp;<span class="ident" id="4224749">fmt</span><span class="op" id="4224752">.</span><span class="ident" id="4224753">Errorf</span><span class="op" id="4224759">(</span><span class="string" id="4224760">&#34;tls:&nbsp;server&nbsp;selected&nbsp;an&nbsp;unsupported&nbsp;cipher&nbsp;suite&#34;</span><span class="op" id="4224810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4224813">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224817">hs</span>&nbsp;<span class="op" id="4224820">:=</span>&nbsp;<span class="op" id="4224823">&amp;</span><span class="ident" id="4224824">clientHandshakeState</span><span class="op" id="4224844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224848">c</span><span class="op" id="4224849">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224862">c</span><span class="op" id="4224863">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224867">serverHello</span><span class="op" id="4224878">:</span>&nbsp;&nbsp;<span class="ident" id="4224881">serverHello</span><span class="op" id="4224892">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224896">hello</span><span class="op" id="4224901">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224910">hello</span><span class="op" id="4224915">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224919">suite</span><span class="op" id="4224924">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224933">suite</span><span class="op" id="4224938">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224942">finishedHash</span><span class="op" id="4224954">:</span>&nbsp;<span class="ident" id="4224956">newFinishedHash</span><span class="op" id="4224971">(</span><span class="ident" id="4224972">c</span><span class="op" id="4224973">.</span><span class="ident" id="4224974">vers</span><span class="op" id="4224978">)</span><span class="op" id="4224979">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224983">session</span><span class="op" id="4224990">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224997">session</span><span class="op" id="4225004">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4225007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4225011">hs</span><span class="op" id="4225013">.</span><span class="ident" id="4225014">finishedHash</span><span class="op" id="4225026">.</span><span class="ident" id="4225027">Write</span><span class="op" id="4225032">(</span><span class="ident" id="4225033">hs</span><span class="op" id="4225035">.</span><span class="ident" id="4225036">hello</span><span class="op" id="4225041">.</span><span class="ident" id="4225042">marshal</span><span class="op" id="4225049">(</span><span class="op" id="4225050">)</span><span class="op" id="4225051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4225054">hs</span><span class="op" id="4225056">.</span><span class="ident" id="4225057">finishedHash</span><span class="op" id="4225069">.</span><span class="ident" id="4225070">Write</span><span class="op" id="4225075">(</span><span class="ident" id="4225076">hs</span><span class="op" id="4225078">.</span><span class="ident" id="4225079">serverHello</span><span class="op" id="4225090">.</span><span class="ident" id="4225091">marshal</span><span class="op" id="4225098">(</span><span class="op" id="4225099">)</span><span class="op" id="4225100">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4225104">isResume</span><span class="op" id="4225112">,</span>&nbsp;<span class="ident" id="4225114">err</span>&nbsp;<span class="op" id="4225118">:=</span>&nbsp;<span class="ident" id="4225121">hs</span><span class="op" id="4225123">.</span><span class="ident" id="4225124">processServerHello</span><span class="op" id="4225142">(</span><span class="op" id="4225143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225146">if</span>&nbsp;<span class="ident" id="4225149">err</span>&nbsp;<span class="op" id="4225153">!=</span>&nbsp;<span class="builtintype" id="4225156">nil</span>&nbsp;<span class="op" id="4225160">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225164">return</span>&nbsp;<span class="ident" id="4225171">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4225176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225180">if</span>&nbsp;<span class="ident" id="4225183">isResume</span>&nbsp;<span class="op" id="4225192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225196">if</span>&nbsp;<span class="ident" id="4225199">err</span>&nbsp;<span class="op" id="4225203">:=</span>&nbsp;<span class="ident" id="4225206">hs</span><span class="op" id="4225208">.</span><span class="ident" id="4225209">establishKeys</span><span class="op" id="4225222">(</span><span class="op" id="4225223">)</span><span class="op" id="4225224">;</span>&nbsp;<span class="ident" id="4225226">err</span>&nbsp;<span class="op" id="4225230">!=</span>&nbsp;<span class="builtintype" id="4225233">nil</span>&nbsp;<span class="op" id="4225237">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225242">return</span>&nbsp;<span class="ident" id="4225249">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4225255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225259">if</span>&nbsp;<span class="ident" id="4225262">err</span>&nbsp;<span class="op" id="4225266">:=</span>&nbsp;<span class="ident" id="4225269">hs</span><span class="op" id="4225271">.</span><span class="ident" id="4225272">readSessionTicket</span><span class="op" id="4225289">(</span><span class="op" id="4225290">)</span><span class="op" id="4225291">;</span>&nbsp;<span class="ident" id="4225293">err</span>&nbsp;<span class="op" id="4225297">!=</span>&nbsp;<span class="builtintype" id="4225300">nil</span>&nbsp;<span class="op" id="4225304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225309">return</span>&nbsp;<span class="ident" id="4225316">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4225322">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225326">if</span>&nbsp;<span class="ident" id="4225329">err</span>&nbsp;<span class="op" id="4225333">:=</span>&nbsp;<span class="ident" id="4225336">hs</span><span class="op" id="4225338">.</span><span class="ident" id="4225339">readFinished</span><span class="op" id="4225351">(</span><span class="ident" id="4225352">c</span><span class="op" id="4225353">.</span><span class="ident" id="4225354">firstFinished</span><span class="op" id="4225367">[</span><span class="op" id="4225368">:</span><span class="op" id="4225369">]</span><span class="op" id="4225370">)</span><span class="op" id="4225371">;</span>&nbsp;<span class="ident" id="4225373">err</span>&nbsp;<span class="op" id="4225377">!=</span>&nbsp;<span class="builtintype" id="4225380">nil</span>&nbsp;<span class="op" id="4225384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225389">return</span>&nbsp;<span class="ident" id="4225396">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4225402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225406">if</span>&nbsp;<span class="ident" id="4225409">err</span>&nbsp;<span class="op" id="4225413">:=</span>&nbsp;<span class="ident" id="4225416">hs</span><span class="op" id="4225418">.</span><span class="ident" id="4225419">sendFinished</span><span class="op" id="4225431">(</span><span class="builtintype" id="4225432">nil</span><span class="op" id="4225435">)</span><span class="op" id="4225436">;</span>&nbsp;<span class="ident" id="4225438">err</span>&nbsp;<span class="op" id="4225442">!=</span>&nbsp;<span class="builtintype" id="4225445">nil</span>&nbsp;<span class="op" id="4225449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225454">return</span>&nbsp;<span class="ident" id="4225461">err</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4225467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4225470">}</span>&nbsp;<span class="keyword" id="4225472">else</span>&nbsp;<span class="op" id="4225477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225481">if</span>&nbsp;<span class="ident" id="4225484">err</span>&nbsp;<span class="op" id="4225488">:=</span>&nbsp;<span class="ident" id="4225491">hs</span><span class="op" id="4225493">.</span><span class="ident" id="4225494">doFullHandshake</span><span class="op" id="4225509">(</span><span class="op" id="4225510">)</span><span class="op" id="4225511">;</span>&nbsp;<span class="ident" id="4225513">err</span>&nbsp;<span class="op" id="4225517">!=</span>&nbsp;<span class="builtintype" id="4225520">nil</span>&nbsp;<span class="op" id="4225524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225529">return</span>&nbsp;<span class="ident" id="4225536">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4225542">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225546">if</span>&nbsp;<span class="ident" id="4225549">err</span>&nbsp;<span class="op" id="4225553">:=</span>&nbsp;<span class="ident" id="4225556">hs</span><span class="op" id="4225558">.</span><span class="ident" id="4225559">establishKeys</span><span class="op" id="4225572">(</span><span class="op" id="4225573">)</span><span class="op" id="4225574">;</span>&nbsp;<span class="ident" id="4225576">err</span>&nbsp;<span class="op" id="4225580">!=</span>&nbsp;<span class="builtintype" id="4225583">nil</span>&nbsp;<span class="op" id="4225587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225592">return</span>&nbsp;<span class="ident" id="4225599">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4225605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225609">if</span>&nbsp;<span class="ident" id="4225612">err</span>&nbsp;<span class="op" id="4225616">:=</span>&nbsp;<span class="ident" id="4225619">hs</span><span class="op" id="4225621">.</span><span class="ident" id="4225622">sendFinished</span><span class="op" id="4225634">(</span><span class="ident" id="4225635">c</span><span class="op" id="4225636">.</span><span class="ident" id="4225637">firstFinished</span><span class="op" id="4225650">[</span><span class="op" id="4225651">:</span><span class="op" id="4225652">]</span><span class="op" id="4225653">)</span><span class="op" id="4225654">;</span>&nbsp;<span class="ident" id="4225656">err</span>&nbsp;<span class="op" id="4225660">!=</span>&nbsp;<span class="builtintype" id="4225663">nil</span>&nbsp;<span class="op" id="4225667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225672">return</span>&nbsp;<span class="ident" id="4225679">err</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4225685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225689">if</span>&nbsp;<span class="ident" id="4225692">err</span>&nbsp;<span class="op" id="4225696">:=</span>&nbsp;<span class="ident" id="4225699">hs</span><span class="op" id="4225701">.</span><span class="ident" id="4225702">readSessionTicket</span><span class="op" id="4225719">(</span><span class="op" id="4225720">)</span><span class="op" id="4225721">;</span>&nbsp;<span class="ident" id="4225723">err</span>&nbsp;<span class="op" id="4225727">!=</span>&nbsp;<span class="builtintype" id="4225730">nil</span>&nbsp;<span class="op" id="4225734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225739">return</span>&nbsp;<span class="ident" id="4225746">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4225752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225756">if</span>&nbsp;<span class="ident" id="4225759">err</span>&nbsp;<span class="op" id="4225763">:=</span>&nbsp;<span class="ident" id="4225766">hs</span><span class="op" id="4225768">.</span><span class="ident" id="4225769">readFinished</span><span class="op" id="4225781">(</span><span class="builtintype" id="4225782">nil</span><span class="op" id="4225785">)</span><span class="op" id="4225786">;</span>&nbsp;<span class="ident" id="4225788">err</span>&nbsp;<span class="op" id="4225792">!=</span>&nbsp;<span class="builtintype" id="4225795">nil</span>&nbsp;<span class="op" id="4225799">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225804">return</span>&nbsp;<span class="ident" id="4225811">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4225817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4225820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225824">if</span>&nbsp;<span class="ident" id="4225827">sessionCache</span>&nbsp;<span class="op" id="4225840">!=</span>&nbsp;<span class="builtintype" id="4225843">nil</span>&nbsp;<span class="op" id="4225847">&amp;&amp;</span>&nbsp;<span class="ident" id="4225850">hs</span><span class="op" id="4225852">.</span><span class="ident" id="4225853">session</span>&nbsp;<span class="op" id="4225861">!=</span>&nbsp;<span class="builtintype" id="4225864">nil</span>&nbsp;<span class="op" id="4225868">&amp;&amp;</span>&nbsp;<span class="ident" id="4225871">session</span>&nbsp;<span class="op" id="4225879">!=</span>&nbsp;<span class="ident" id="4225882">hs</span><span class="op" id="4225884">.</span><span class="ident" id="4225885">session</span>&nbsp;<span class="op" id="4225893">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4225897">sessionCache</span><span class="op" id="4225909">.</span><span class="ident" id="4225910">Put</span><span class="op" id="4225913">(</span><span class="ident" id="4225914">cacheKey</span><span class="op" id="4225922">,</span>&nbsp;<span class="ident" id="4225924">hs</span><span class="op" id="4225926">.</span><span class="ident" id="4225927">session</span><span class="op" id="4225934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4225937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4225941">c</span><span class="op" id="4225942">.</span><span class="ident" id="4225943">didResume</span>&nbsp;<span class="op" id="4225953">=</span>&nbsp;<span class="ident" id="4225955">isResume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4225965">c</span><span class="op" id="4225966">.</span><span class="ident" id="4225967">handshakeComplete</span>&nbsp;<span class="op" id="4225985">=</span>&nbsp;<span class="builtintype" id="4225987">true</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4225993">c</span><span class="op" id="4225994">.</span><span class="ident" id="4225995">cipherSuite</span>&nbsp;<span class="op" id="4226007">=</span>&nbsp;<span class="ident" id="4226009">suite</span><span class="op" id="4226014">.</span><span class="ident" id="4226015">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226019">return</span>&nbsp;<span class="builtintype" id="4226026">nil</span><br>
<span class="lineno"></span><span class="op" id="4226030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4226033">func</span>&nbsp;<span class="op" id="4226038">(</span><span class="ident" id="4226039">hs</span>&nbsp;<span class="op" id="4226042">*</span><span class="ident" id="4226043">clientHandshakeState</span><span class="op" id="4226063">)</span>&nbsp;<span class="ident" id="4226065">doFullHandshake</span><span class="op" id="4226080">(</span><span class="op" id="4226081">)</span>&nbsp;<span class="builtintype" id="4226083">error</span>&nbsp;<span class="op" id="4226089">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226092">c</span>&nbsp;<span class="op" id="4226094">:=</span>&nbsp;<span class="ident" id="4226097">hs</span><span class="op" id="4226099">.</span><span class="ident" id="4226100">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226104">msg</span><span class="op" id="4226107">,</span>&nbsp;<span class="ident" id="4226109">err</span>&nbsp;<span class="op" id="4226113">:=</span>&nbsp;<span class="ident" id="4226116">c</span><span class="op" id="4226117">.</span><span class="ident" id="4226118">readHandshake</span><span class="op" id="4226131">(</span><span class="op" id="4226132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226135">if</span>&nbsp;<span class="ident" id="4226138">err</span>&nbsp;<span class="op" id="4226142">!=</span>&nbsp;<span class="builtintype" id="4226145">nil</span>&nbsp;<span class="op" id="4226149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226153">return</span>&nbsp;<span class="ident" id="4226160">err</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226168">certMsg</span><span class="op" id="4226175">,</span>&nbsp;<span class="ident" id="4226177">ok</span>&nbsp;<span class="op" id="4226180">:=</span>&nbsp;<span class="ident" id="4226183">msg</span><span class="op" id="4226186">.</span><span class="op" id="4226187">(</span><span class="op" id="4226188">*</span><span class="ident" id="4226189">certificateMsg</span><span class="op" id="4226203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226206">if</span>&nbsp;<span class="op" id="4226209">!</span><span class="ident" id="4226210">ok</span>&nbsp;<span class="op" id="4226213">||</span>&nbsp;<span class="builtinfunc" id="4226216">len</span><span class="op" id="4226219">(</span><span class="ident" id="4226220">certMsg</span><span class="op" id="4226227">.</span><span class="ident" id="4226228">certificates</span><span class="op" id="4226240">)</span>&nbsp;<span class="op" id="4226242">==</span>&nbsp;<span class="num" id="4226245">0</span>&nbsp;<span class="op" id="4226247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226251">c</span><span class="op" id="4226252">.</span><span class="ident" id="4226253">sendAlert</span><span class="op" id="4226262">(</span><span class="ident" id="4226263">alertUnexpectedMessage</span><span class="op" id="4226285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226289">return</span>&nbsp;<span class="ident" id="4226296">unexpectedMessageError</span><span class="op" id="4226318">(</span><span class="ident" id="4226319">certMsg</span><span class="op" id="4226326">,</span>&nbsp;<span class="ident" id="4226328">msg</span><span class="op" id="4226331">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226337">hs</span><span class="op" id="4226339">.</span><span class="ident" id="4226340">finishedHash</span><span class="op" id="4226352">.</span><span class="ident" id="4226353">Write</span><span class="op" id="4226358">(</span><span class="ident" id="4226359">certMsg</span><span class="op" id="4226366">.</span><span class="ident" id="4226367">marshal</span><span class="op" id="4226374">(</span><span class="op" id="4226375">)</span><span class="op" id="4226376">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226380">certs</span>&nbsp;<span class="op" id="4226386">:=</span>&nbsp;<span class="builtinfunc" id="4226389">make</span><span class="op" id="4226393">(</span><span class="op" id="4226394">[</span><span class="op" id="4226395">]</span><span class="op" id="4226396">*</span><span class="ident" id="4226397">x509</span><span class="op" id="4226401">.</span><span class="ident" id="4226402">Certificate</span><span class="op" id="4226413">,</span>&nbsp;<span class="builtinfunc" id="4226415">len</span><span class="op" id="4226418">(</span><span class="ident" id="4226419">certMsg</span><span class="op" id="4226426">.</span><span class="ident" id="4226427">certificates</span><span class="op" id="4226439">)</span><span class="op" id="4226440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226443">for</span>&nbsp;<span class="ident" id="4226447">i</span><span class="op" id="4226448">,</span>&nbsp;<span class="ident" id="4226450">asn1Data</span>&nbsp;<span class="op" id="4226459">:=</span>&nbsp;<span class="keyword" id="4226462">range</span>&nbsp;<span class="ident" id="4226468">certMsg</span><span class="op" id="4226475">.</span><span class="ident" id="4226476">certificates</span>&nbsp;<span class="op" id="4226489">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226493">cert</span><span class="op" id="4226497">,</span>&nbsp;<span class="ident" id="4226499">err</span>&nbsp;<span class="op" id="4226503">:=</span>&nbsp;<span class="ident" id="4226506">x509</span><span class="op" id="4226510">.</span><span class="ident" id="4226511">ParseCertificate</span><span class="op" id="4226527">(</span><span class="ident" id="4226528">asn1Data</span><span class="op" id="4226536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226540">if</span>&nbsp;<span class="ident" id="4226543">err</span>&nbsp;<span class="op" id="4226547">!=</span>&nbsp;<span class="builtintype" id="4226550">nil</span>&nbsp;<span class="op" id="4226554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226559">c</span><span class="op" id="4226560">.</span><span class="ident" id="4226561">sendAlert</span><span class="op" id="4226570">(</span><span class="ident" id="4226571">alertBadCertificate</span><span class="op" id="4226590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226595">return</span>&nbsp;<span class="ident" id="4226602">errors</span><span class="op" id="4226608">.</span><span class="ident" id="4226609">New</span><span class="op" id="4226612">(</span><span class="string" id="4226613">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;from&nbsp;server:&nbsp;&#34;</span>&nbsp;<span class="op" id="4226662">+</span>&nbsp;<span class="ident" id="4226664">err</span><span class="op" id="4226667">.</span><span class="ident" id="4226668">Error</span><span class="op" id="4226673">(</span><span class="op" id="4226674">)</span><span class="op" id="4226675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226679">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226683">certs</span><span class="op" id="4226688">[</span><span class="ident" id="4226689">i</span><span class="op" id="4226690">]</span>&nbsp;<span class="op" id="4226692">=</span>&nbsp;<span class="ident" id="4226694">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226704">if</span>&nbsp;<span class="op" id="4226707">!</span><span class="ident" id="4226708">c</span><span class="op" id="4226709">.</span><span class="ident" id="4226710">config</span><span class="op" id="4226716">.</span><span class="ident" id="4226717">InsecureSkipVerify</span>&nbsp;<span class="op" id="4226736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226740">opts</span>&nbsp;<span class="op" id="4226745">:=</span>&nbsp;<span class="ident" id="4226748">x509</span><span class="op" id="4226752">.</span><span class="ident" id="4226753">VerifyOptions</span><span class="op" id="4226766">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226771">Roots</span><span class="op" id="4226776">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226786">c</span><span class="op" id="4226787">.</span><span class="ident" id="4226788">config</span><span class="op" id="4226794">.</span><span class="ident" id="4226795">RootCAs</span><span class="op" id="4226802">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226807">CurrentTime</span><span class="op" id="4226818">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4226822">c</span><span class="op" id="4226823">.</span><span class="ident" id="4226824">config</span><span class="op" id="4226830">.</span><span class="ident" id="4226831">time</span><span class="op" id="4226835">(</span><span class="op" id="4226836">)</span><span class="op" id="4226837">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226842">DNSName</span><span class="op" id="4226849">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226857">c</span><span class="op" id="4226858">.</span><span class="ident" id="4226859">config</span><span class="op" id="4226865">.</span><span class="ident" id="4226866">ServerName</span><span class="op" id="4226876">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226881">Intermediates</span><span class="op" id="4226894">:</span>&nbsp;<span class="ident" id="4226896">x509</span><span class="op" id="4226900">.</span><span class="ident" id="4226901">NewCertPool</span><span class="op" id="4226912">(</span><span class="op" id="4226913">)</span><span class="op" id="4226914">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226918">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226923">for</span>&nbsp;<span class="ident" id="4226927">i</span><span class="op" id="4226928">,</span>&nbsp;<span class="ident" id="4226930">cert</span>&nbsp;<span class="op" id="4226935">:=</span>&nbsp;<span class="keyword" id="4226938">range</span>&nbsp;<span class="ident" id="4226944">certs</span>&nbsp;<span class="op" id="4226950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226955">if</span>&nbsp;<span class="ident" id="4226958">i</span>&nbsp;<span class="op" id="4226960">==</span>&nbsp;<span class="num" id="4226963">0</span>&nbsp;<span class="op" id="4226965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226971">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226983">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226988">opts</span><span class="op" id="4226992">.</span><span class="ident" id="4226993">Intermediates</span><span class="op" id="4227006">.</span><span class="ident" id="4227007">AddCert</span><span class="op" id="4227014">(</span><span class="ident" id="4227015">cert</span><span class="op" id="4227019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4227023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227027">c</span><span class="op" id="4227028">.</span><span class="ident" id="4227029">verifiedChains</span><span class="op" id="4227043">,</span>&nbsp;<span class="ident" id="4227045">err</span>&nbsp;<span class="op" id="4227049">=</span>&nbsp;<span class="ident" id="4227051">certs</span><span class="op" id="4227056">[</span><span class="num" id="4227057">0</span><span class="op" id="4227058">]</span><span class="op" id="4227059">.</span><span class="ident" id="4227060">Verify</span><span class="op" id="4227066">(</span><span class="ident" id="4227067">opts</span><span class="op" id="4227071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227075">if</span>&nbsp;<span class="ident" id="4227078">err</span>&nbsp;<span class="op" id="4227082">!=</span>&nbsp;<span class="builtintype" id="4227085">nil</span>&nbsp;<span class="op" id="4227089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227094">c</span><span class="op" id="4227095">.</span><span class="ident" id="4227096">sendAlert</span><span class="op" id="4227105">(</span><span class="ident" id="4227106">alertBadCertificate</span><span class="op" id="4227125">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227130">return</span>&nbsp;<span class="ident" id="4227137">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4227143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4227146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227150">switch</span>&nbsp;<span class="ident" id="4227157">certs</span><span class="op" id="4227162">[</span><span class="num" id="4227163">0</span><span class="op" id="4227164">]</span><span class="op" id="4227165">.</span><span class="ident" id="4227166">PublicKey</span><span class="op" id="4227175">.</span><span class="op" id="4227176">(</span><span class="keyword" id="4227177">type</span><span class="op" id="4227181">)</span>&nbsp;<span class="op" id="4227183">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227186">case</span>&nbsp;<span class="op" id="4227191">*</span><span class="ident" id="4227192">rsa</span><span class="op" id="4227195">.</span><span class="ident" id="4227196">PublicKey</span><span class="op" id="4227205">,</span>&nbsp;<span class="op" id="4227207">*</span><span class="ident" id="4227208">ecdsa</span><span class="op" id="4227213">.</span><span class="ident" id="4227214">PublicKey</span><span class="op" id="4227223">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227227">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227234">default</span><span class="op" id="4227241">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227245">c</span><span class="op" id="4227246">.</span><span class="ident" id="4227247">sendAlert</span><span class="op" id="4227256">(</span><span class="ident" id="4227257">alertUnsupportedCertificate</span><span class="op" id="4227284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227288">return</span>&nbsp;<span class="ident" id="4227295">fmt</span><span class="op" id="4227298">.</span><span class="ident" id="4227299">Errorf</span><span class="op" id="4227305">(</span><span class="string" id="4227306">&#34;tls:&nbsp;server&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;type&nbsp;of&nbsp;public&nbsp;key:&nbsp;%T&#34;</span><span class="op" id="4227380">,</span>&nbsp;<span class="ident" id="4227382">certs</span><span class="op" id="4227387">[</span><span class="num" id="4227388">0</span><span class="op" id="4227389">]</span><span class="op" id="4227390">.</span><span class="ident" id="4227391">PublicKey</span><span class="op" id="4227400">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4227403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227407">c</span><span class="op" id="4227408">.</span><span class="ident" id="4227409">peerCertificates</span>&nbsp;<span class="op" id="4227426">=</span>&nbsp;<span class="ident" id="4227428">certs</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227436">if</span>&nbsp;<span class="ident" id="4227439">hs</span><span class="op" id="4227441">.</span><span class="ident" id="4227442">serverHello</span><span class="op" id="4227453">.</span><span class="ident" id="4227454">ocspStapling</span>&nbsp;<span class="op" id="4227467">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227471">msg</span><span class="op" id="4227474">,</span>&nbsp;<span class="ident" id="4227476">err</span>&nbsp;<span class="op" id="4227480">=</span>&nbsp;<span class="ident" id="4227482">c</span><span class="op" id="4227483">.</span><span class="ident" id="4227484">readHandshake</span><span class="op" id="4227497">(</span><span class="op" id="4227498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227502">if</span>&nbsp;<span class="ident" id="4227505">err</span>&nbsp;<span class="op" id="4227509">!=</span>&nbsp;<span class="builtintype" id="4227512">nil</span>&nbsp;<span class="op" id="4227516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227521">return</span>&nbsp;<span class="ident" id="4227528">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4227534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227538">cs</span><span class="op" id="4227540">,</span>&nbsp;<span class="ident" id="4227542">ok</span>&nbsp;<span class="op" id="4227545">:=</span>&nbsp;<span class="ident" id="4227548">msg</span><span class="op" id="4227551">.</span><span class="op" id="4227552">(</span><span class="op" id="4227553">*</span><span class="ident" id="4227554">certificateStatusMsg</span><span class="op" id="4227574">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227578">if</span>&nbsp;<span class="op" id="4227581">!</span><span class="ident" id="4227582">ok</span>&nbsp;<span class="op" id="4227585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227590">c</span><span class="op" id="4227591">.</span><span class="ident" id="4227592">sendAlert</span><span class="op" id="4227601">(</span><span class="ident" id="4227602">alertUnexpectedMessage</span><span class="op" id="4227624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227629">return</span>&nbsp;<span class="ident" id="4227636">unexpectedMessageError</span><span class="op" id="4227658">(</span><span class="ident" id="4227659">cs</span><span class="op" id="4227661">,</span>&nbsp;<span class="ident" id="4227663">msg</span><span class="op" id="4227666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4227670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227674">hs</span><span class="op" id="4227676">.</span><span class="ident" id="4227677">finishedHash</span><span class="op" id="4227689">.</span><span class="ident" id="4227690">Write</span><span class="op" id="4227695">(</span><span class="ident" id="4227696">cs</span><span class="op" id="4227698">.</span><span class="ident" id="4227699">marshal</span><span class="op" id="4227706">(</span><span class="op" id="4227707">)</span><span class="op" id="4227708">)</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227713">if</span>&nbsp;<span class="ident" id="4227716">cs</span><span class="op" id="4227718">.</span><span class="ident" id="4227719">statusType</span>&nbsp;<span class="op" id="4227730">==</span>&nbsp;<span class="ident" id="4227733">statusTypeOCSP</span>&nbsp;<span class="op" id="4227748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227753">c</span><span class="op" id="4227754">.</span><span class="ident" id="4227755">ocspResponse</span>&nbsp;<span class="op" id="4227768">=</span>&nbsp;<span class="ident" id="4227770">cs</span><span class="op" id="4227772">.</span><span class="ident" id="4227773">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4227784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4227787">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227791">msg</span><span class="op" id="4227794">,</span>&nbsp;<span class="ident" id="4227796">err</span>&nbsp;<span class="op" id="4227800">=</span>&nbsp;<span class="ident" id="4227802">c</span><span class="op" id="4227803">.</span><span class="ident" id="4227804">readHandshake</span><span class="op" id="4227817">(</span><span class="op" id="4227818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227821">if</span>&nbsp;<span class="ident" id="4227824">err</span>&nbsp;<span class="op" id="4227828">!=</span>&nbsp;<span class="builtintype" id="4227831">nil</span>&nbsp;<span class="op" id="4227835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227839">return</span>&nbsp;<span class="ident" id="4227846">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4227851">}</span><br>
<span class="lineno">300</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227855">keyAgreement</span>&nbsp;<span class="op" id="4227868">:=</span>&nbsp;<span class="ident" id="4227871">hs</span><span class="op" id="4227873">.</span><span class="ident" id="4227874">suite</span><span class="op" id="4227879">.</span><span class="ident" id="4227880">ka</span><span class="op" id="4227882">(</span><span class="ident" id="4227883">c</span><span class="op" id="4227884">.</span><span class="ident" id="4227885">vers</span><span class="op" id="4227889">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227893">skx</span><span class="op" id="4227896">,</span>&nbsp;<span class="ident" id="4227898">ok</span>&nbsp;<span class="op" id="4227901">:=</span>&nbsp;<span class="ident" id="4227904">msg</span><span class="op" id="4227907">.</span><span class="op" id="4227908">(</span><span class="op" id="4227909">*</span><span class="ident" id="4227910">serverKeyExchangeMsg</span><span class="op" id="4227930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227933">if</span>&nbsp;<span class="ident" id="4227936">ok</span>&nbsp;<span class="op" id="4227939">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227943">hs</span><span class="op" id="4227945">.</span><span class="ident" id="4227946">finishedHash</span><span class="op" id="4227958">.</span><span class="ident" id="4227959">Write</span><span class="op" id="4227964">(</span><span class="ident" id="4227965">skx</span><span class="op" id="4227968">.</span><span class="ident" id="4227969">marshal</span><span class="op" id="4227976">(</span><span class="op" id="4227977">)</span><span class="op" id="4227978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227982">err</span>&nbsp;<span class="op" id="4227986">=</span>&nbsp;<span class="ident" id="4227988">keyAgreement</span><span class="op" id="4228000">.</span><span class="ident" id="4228001">processServerKeyExchange</span><span class="op" id="4228025">(</span><span class="ident" id="4228026">c</span><span class="op" id="4228027">.</span><span class="ident" id="4228028">config</span><span class="op" id="4228034">,</span>&nbsp;<span class="ident" id="4228036">hs</span><span class="op" id="4228038">.</span><span class="ident" id="4228039">hello</span><span class="op" id="4228044">,</span>&nbsp;<span class="ident" id="4228046">hs</span><span class="op" id="4228048">.</span><span class="ident" id="4228049">serverHello</span><span class="op" id="4228060">,</span>&nbsp;<span class="ident" id="4228062">certs</span><span class="op" id="4228067">[</span><span class="num" id="4228068">0</span><span class="op" id="4228069">]</span><span class="op" id="4228070">,</span>&nbsp;<span class="ident" id="4228072">skx</span><span class="op" id="4228075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228079">if</span>&nbsp;<span class="ident" id="4228082">err</span>&nbsp;<span class="op" id="4228086">!=</span>&nbsp;<span class="builtintype" id="4228089">nil</span>&nbsp;<span class="op" id="4228093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228098">c</span><span class="op" id="4228099">.</span><span class="ident" id="4228100">sendAlert</span><span class="op" id="4228109">(</span><span class="ident" id="4228110">alertUnexpectedMessage</span><span class="op" id="4228132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228137">return</span>&nbsp;<span class="ident" id="4228144">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4228150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228155">msg</span><span class="op" id="4228158">,</span>&nbsp;<span class="ident" id="4228160">err</span>&nbsp;<span class="op" id="4228164">=</span>&nbsp;<span class="ident" id="4228166">c</span><span class="op" id="4228167">.</span><span class="ident" id="4228168">readHandshake</span><span class="op" id="4228181">(</span><span class="op" id="4228182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228186">if</span>&nbsp;<span class="ident" id="4228189">err</span>&nbsp;<span class="op" id="4228193">!=</span>&nbsp;<span class="builtintype" id="4228196">nil</span>&nbsp;<span class="op" id="4228200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228205">return</span>&nbsp;<span class="ident" id="4228212">err</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4228218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4228221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228225">var</span>&nbsp;<span class="ident" id="4228229">chainToSend</span>&nbsp;<span class="op" id="4228241">*</span><span class="ident" id="4228242">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228255">var</span>&nbsp;<span class="ident" id="4228259">certRequested</span>&nbsp;<span class="builtintype" id="4228273">bool</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228279">certReq</span><span class="op" id="4228286">,</span>&nbsp;<span class="ident" id="4228288">ok</span>&nbsp;<span class="op" id="4228291">:=</span>&nbsp;<span class="ident" id="4228294">msg</span><span class="op" id="4228297">.</span><span class="op" id="4228298">(</span><span class="op" id="4228299">*</span><span class="ident" id="4228300">certificateRequestMsg</span><span class="op" id="4228321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228324">if</span>&nbsp;<span class="ident" id="4228327">ok</span>&nbsp;<span class="op" id="4228330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228334">certRequested</span>&nbsp;<span class="op" id="4228348">=</span>&nbsp;<span class="builtintype" id="4228350">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4228358">//&nbsp;RFC&nbsp;4346&nbsp;on&nbsp;the&nbsp;certificateAuthorities&nbsp;field:</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4228409">//&nbsp;A&nbsp;list&nbsp;of&nbsp;the&nbsp;distinguished&nbsp;names&nbsp;of&nbsp;acceptable&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4228474">//&nbsp;authorities.&nbsp;These&nbsp;distinguished&nbsp;names&nbsp;may&nbsp;specify&nbsp;a&nbsp;desired</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4228540">//&nbsp;distinguished&nbsp;name&nbsp;for&nbsp;a&nbsp;root&nbsp;CA&nbsp;or&nbsp;for&nbsp;a&nbsp;subordinate&nbsp;CA;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4228603">//&nbsp;thus,&nbsp;this&nbsp;message&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;describe&nbsp;both&nbsp;known&nbsp;roots</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4228668">//&nbsp;and&nbsp;a&nbsp;desired&nbsp;authorization&nbsp;space.&nbsp;If&nbsp;the</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4228715">//&nbsp;certificate_authorities&nbsp;list&nbsp;is&nbsp;empty&nbsp;then&nbsp;the&nbsp;client&nbsp;MAY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4228778">//&nbsp;send&nbsp;any&nbsp;certificate&nbsp;of&nbsp;the&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4228823">//&nbsp;ClientCertificateType,&nbsp;unless&nbsp;there&nbsp;is&nbsp;some&nbsp;external</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4228881">//&nbsp;arrangement&nbsp;to&nbsp;the&nbsp;contrary.</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228916">hs</span><span class="op" id="4228918">.</span><span class="ident" id="4228919">finishedHash</span><span class="op" id="4228931">.</span><span class="ident" id="4228932">Write</span><span class="op" id="4228937">(</span><span class="ident" id="4228938">certReq</span><span class="op" id="4228945">.</span><span class="ident" id="4228946">marshal</span><span class="op" id="4228953">(</span><span class="op" id="4228954">)</span><span class="op" id="4228955">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228960">var</span>&nbsp;<span class="ident" id="4228964">rsaAvail</span><span class="op" id="4228972">,</span>&nbsp;<span class="ident" id="4228974">ecdsaAvail</span>&nbsp;<span class="builtintype" id="4228985">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228992">for</span>&nbsp;<span class="ident" id="4228996">_</span><span class="op" id="4228997">,</span>&nbsp;<span class="ident" id="4228999">certType</span>&nbsp;<span class="op" id="4229008">:=</span>&nbsp;<span class="keyword" id="4229011">range</span>&nbsp;<span class="ident" id="4229017">certReq</span><span class="op" id="4229024">.</span><span class="ident" id="4229025">certificateTypes</span>&nbsp;<span class="op" id="4229042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229047">switch</span>&nbsp;<span class="ident" id="4229054">certType</span>&nbsp;<span class="op" id="4229063">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229068">case</span>&nbsp;<span class="ident" id="4229073">certTypeRSASign</span><span class="op" id="4229088">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229094">rsaAvail</span>&nbsp;<span class="op" id="4229103">=</span>&nbsp;<span class="builtintype" id="4229105">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229113">case</span>&nbsp;<span class="ident" id="4229118">certTypeECDSASign</span><span class="op" id="4229135">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229141">ecdsaAvail</span>&nbsp;<span class="op" id="4229152">=</span>&nbsp;<span class="builtintype" id="4229154">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229162">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4229171">//&nbsp;We&nbsp;need&nbsp;to&nbsp;search&nbsp;our&nbsp;list&nbsp;of&nbsp;client&nbsp;certs&nbsp;for&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4229227">//&nbsp;where&nbsp;SignatureAlgorithm&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;the&nbsp;server&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4229293">//&nbsp;Issuer&nbsp;is&nbsp;in&nbsp;certReq.certificateAuthorities</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229341">findCert</span><span class="op" id="4229349">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229353">for</span>&nbsp;<span class="ident" id="4229357">i</span><span class="op" id="4229358">,</span>&nbsp;<span class="ident" id="4229360">chain</span>&nbsp;<span class="op" id="4229366">:=</span>&nbsp;<span class="keyword" id="4229369">range</span>&nbsp;<span class="ident" id="4229375">c</span><span class="op" id="4229376">.</span><span class="ident" id="4229377">config</span><span class="op" id="4229383">.</span><span class="ident" id="4229384">Certificates</span>&nbsp;<span class="op" id="4229397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229402">if</span>&nbsp;<span class="op" id="4229405">!</span><span class="ident" id="4229406">rsaAvail</span>&nbsp;<span class="op" id="4229415">&amp;&amp;</span>&nbsp;<span class="op" id="4229418">!</span><span class="ident" id="4229419">ecdsaAvail</span>&nbsp;<span class="op" id="4229430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229436">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229448">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229454">for</span>&nbsp;<span class="ident" id="4229458">j</span><span class="op" id="4229459">,</span>&nbsp;<span class="ident" id="4229461">cert</span>&nbsp;<span class="op" id="4229466">:=</span>&nbsp;<span class="keyword" id="4229469">range</span>&nbsp;<span class="ident" id="4229475">chain</span><span class="op" id="4229480">.</span><span class="ident" id="4229481">Certificate</span>&nbsp;<span class="op" id="4229493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229499">x509Cert</span>&nbsp;<span class="op" id="4229508">:=</span>&nbsp;<span class="ident" id="4229511">chain</span><span class="op" id="4229516">.</span><span class="ident" id="4229517">Leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4229526">//&nbsp;parse&nbsp;the&nbsp;certificate&nbsp;if&nbsp;this&nbsp;isn&#39;t&nbsp;the&nbsp;leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4229578">//&nbsp;node,&nbsp;or&nbsp;if&nbsp;chain.Leaf&nbsp;was&nbsp;nil</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229616">if</span>&nbsp;<span class="ident" id="4229619">j</span>&nbsp;<span class="op" id="4229621">!=</span>&nbsp;<span class="num" id="4229624">0</span>&nbsp;<span class="op" id="4229626">||</span>&nbsp;<span class="ident" id="4229629">x509Cert</span>&nbsp;<span class="op" id="4229638">==</span>&nbsp;<span class="builtintype" id="4229641">nil</span>&nbsp;<span class="op" id="4229645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229652">if</span>&nbsp;<span class="ident" id="4229655">x509Cert</span><span class="op" id="4229663">,</span>&nbsp;<span class="ident" id="4229665">err</span>&nbsp;<span class="op" id="4229669">=</span>&nbsp;<span class="ident" id="4229671">x509</span><span class="op" id="4229675">.</span><span class="ident" id="4229676">ParseCertificate</span><span class="op" id="4229692">(</span><span class="ident" id="4229693">cert</span><span class="op" id="4229697">)</span><span class="op" id="4229698">;</span>&nbsp;<span class="ident" id="4229700">err</span>&nbsp;<span class="op" id="4229704">!=</span>&nbsp;<span class="builtintype" id="4229707">nil</span>&nbsp;<span class="op" id="4229711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229719">c</span><span class="op" id="4229720">.</span><span class="ident" id="4229721">sendAlert</span><span class="op" id="4229730">(</span><span class="ident" id="4229731">alertInternalError</span><span class="op" id="4229749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229757">return</span>&nbsp;<span class="ident" id="4229764">errors</span><span class="op" id="4229770">.</span><span class="ident" id="4229771">New</span><span class="op" id="4229774">(</span><span class="string" id="4229775">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate&nbsp;#&#34;</span>&nbsp;<span class="op" id="4229819">+</span>&nbsp;<span class="ident" id="4229821">strconv</span><span class="op" id="4229828">.</span><span class="ident" id="4229829">Itoa</span><span class="op" id="4229833">(</span><span class="ident" id="4229834">i</span><span class="op" id="4229835">)</span>&nbsp;<span class="op" id="4229837">+</span>&nbsp;<span class="string" id="4229839">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="4229844">+</span>&nbsp;<span class="ident" id="4229846">err</span><span class="op" id="4229849">.</span><span class="ident" id="4229850">Error</span><span class="op" id="4229855">(</span><span class="op" id="4229856">)</span><span class="op" id="4229857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229864">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229877">switch</span>&nbsp;<span class="op" id="4229884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229890">case</span>&nbsp;<span class="ident" id="4229895">rsaAvail</span>&nbsp;<span class="op" id="4229904">&amp;&amp;</span>&nbsp;<span class="ident" id="4229907">x509Cert</span><span class="op" id="4229915">.</span><span class="ident" id="4229916">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="4229935">==</span>&nbsp;<span class="ident" id="4229938">x509</span><span class="op" id="4229942">.</span><span class="ident" id="4229943">RSA</span><span class="op" id="4229946">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229952">case</span>&nbsp;<span class="ident" id="4229957">ecdsaAvail</span>&nbsp;<span class="op" id="4229968">&amp;&amp;</span>&nbsp;<span class="ident" id="4229971">x509Cert</span><span class="op" id="4229979">.</span><span class="ident" id="4229980">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="4229999">==</span>&nbsp;<span class="ident" id="4230002">x509</span><span class="op" id="4230006">.</span><span class="ident" id="4230007">ECDSA</span><span class="op" id="4230012">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230018">default</span><span class="op" id="4230025">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230032">continue</span>&nbsp;<span class="ident" id="4230041">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230061">if</span>&nbsp;<span class="builtinfunc" id="4230064">len</span><span class="op" id="4230067">(</span><span class="ident" id="4230068">certReq</span><span class="op" id="4230075">.</span><span class="ident" id="4230076">certificateAuthorities</span><span class="op" id="4230098">)</span>&nbsp;<span class="op" id="4230100">==</span>&nbsp;<span class="num" id="4230103">0</span>&nbsp;<span class="op" id="4230105">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4230112">//&nbsp;they&nbsp;gave&nbsp;us&nbsp;an&nbsp;empty&nbsp;list,&nbsp;so&nbsp;just&nbsp;take&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4230165">//&nbsp;first&nbsp;cert&nbsp;from&nbsp;c.config.Certificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230211">chainToSend</span>&nbsp;<span class="op" id="4230223">=</span>&nbsp;<span class="op" id="4230225">&amp;</span><span class="ident" id="4230226">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230237">break</span>&nbsp;<span class="ident" id="4230243">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230256">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230263">for</span>&nbsp;<span class="ident" id="4230267">_</span><span class="op" id="4230268">,</span>&nbsp;<span class="ident" id="4230270">ca</span>&nbsp;<span class="op" id="4230273">:=</span>&nbsp;<span class="keyword" id="4230276">range</span>&nbsp;<span class="ident" id="4230282">certReq</span><span class="op" id="4230289">.</span><span class="ident" id="4230290">certificateAuthorities</span>&nbsp;<span class="op" id="4230313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230320">if</span>&nbsp;<span class="ident" id="4230323">bytes</span><span class="op" id="4230328">.</span><span class="ident" id="4230329">Equal</span><span class="op" id="4230334">(</span><span class="ident" id="4230335">x509Cert</span><span class="op" id="4230343">.</span><span class="ident" id="4230344">RawIssuer</span><span class="op" id="4230353">,</span>&nbsp;<span class="ident" id="4230355">ca</span><span class="op" id="4230357">)</span>&nbsp;<span class="op" id="4230359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230367">chainToSend</span>&nbsp;<span class="op" id="4230379">=</span>&nbsp;<span class="op" id="4230381">&amp;</span><span class="ident" id="4230382">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230394">break</span>&nbsp;<span class="ident" id="4230400">findCert</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230434">msg</span><span class="op" id="4230437">,</span>&nbsp;<span class="ident" id="4230439">err</span>&nbsp;<span class="op" id="4230443">=</span>&nbsp;<span class="ident" id="4230445">c</span><span class="op" id="4230446">.</span><span class="ident" id="4230447">readHandshake</span><span class="op" id="4230460">(</span><span class="op" id="4230461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230465">if</span>&nbsp;<span class="ident" id="4230468">err</span>&nbsp;<span class="op" id="4230472">!=</span>&nbsp;<span class="builtintype" id="4230475">nil</span>&nbsp;<span class="op" id="4230479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230484">return</span>&nbsp;<span class="ident" id="4230491">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230500">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230504">shd</span><span class="op" id="4230507">,</span>&nbsp;<span class="ident" id="4230509">ok</span>&nbsp;<span class="op" id="4230512">:=</span>&nbsp;<span class="ident" id="4230515">msg</span><span class="op" id="4230518">.</span><span class="op" id="4230519">(</span><span class="op" id="4230520">*</span><span class="ident" id="4230521">serverHelloDoneMsg</span><span class="op" id="4230539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230542">if</span>&nbsp;<span class="op" id="4230545">!</span><span class="ident" id="4230546">ok</span>&nbsp;<span class="op" id="4230549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230553">c</span><span class="op" id="4230554">.</span><span class="ident" id="4230555">sendAlert</span><span class="op" id="4230564">(</span><span class="ident" id="4230565">alertUnexpectedMessage</span><span class="op" id="4230587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230591">return</span>&nbsp;<span class="ident" id="4230598">unexpectedMessageError</span><span class="op" id="4230620">(</span><span class="ident" id="4230621">shd</span><span class="op" id="4230624">,</span>&nbsp;<span class="ident" id="4230626">msg</span><span class="op" id="4230629">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230635">hs</span><span class="op" id="4230637">.</span><span class="ident" id="4230638">finishedHash</span><span class="op" id="4230650">.</span><span class="ident" id="4230651">Write</span><span class="op" id="4230656">(</span><span class="ident" id="4230657">shd</span><span class="op" id="4230660">.</span><span class="ident" id="4230661">marshal</span><span class="op" id="4230668">(</span><span class="op" id="4230669">)</span><span class="op" id="4230670">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4230674">//&nbsp;If&nbsp;the&nbsp;server&nbsp;requested&nbsp;a&nbsp;certificate&nbsp;then&nbsp;we&nbsp;have&nbsp;to&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4230739">//&nbsp;Certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4230807">//&nbsp;certificate&nbsp;to&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230832">if</span>&nbsp;<span class="ident" id="4230835">certRequested</span>&nbsp;<span class="op" id="4230849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230853">certMsg</span>&nbsp;<span class="op" id="4230861">=</span>&nbsp;<span class="builtinfunc" id="4230863">new</span><span class="op" id="4230866">(</span><span class="ident" id="4230867">certificateMsg</span><span class="op" id="4230881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230885">if</span>&nbsp;<span class="ident" id="4230888">chainToSend</span>&nbsp;<span class="op" id="4230900">!=</span>&nbsp;<span class="builtintype" id="4230903">nil</span>&nbsp;<span class="op" id="4230907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230912">certMsg</span><span class="op" id="4230919">.</span><span class="ident" id="4230920">certificates</span>&nbsp;<span class="op" id="4230933">=</span>&nbsp;<span class="ident" id="4230935">chainToSend</span><span class="op" id="4230946">.</span><span class="ident" id="4230947">Certificate</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230965">hs</span><span class="op" id="4230967">.</span><span class="ident" id="4230968">finishedHash</span><span class="op" id="4230980">.</span><span class="ident" id="4230981">Write</span><span class="op" id="4230986">(</span><span class="ident" id="4230987">certMsg</span><span class="op" id="4230994">.</span><span class="ident" id="4230995">marshal</span><span class="op" id="4231002">(</span><span class="op" id="4231003">)</span><span class="op" id="4231004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231008">c</span><span class="op" id="4231009">.</span><span class="ident" id="4231010">writeRecord</span><span class="op" id="4231021">(</span><span class="ident" id="4231022">recordTypeHandshake</span><span class="op" id="4231041">,</span>&nbsp;<span class="ident" id="4231043">certMsg</span><span class="op" id="4231050">.</span><span class="ident" id="4231051">marshal</span><span class="op" id="4231058">(</span><span class="op" id="4231059">)</span><span class="op" id="4231060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4231063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231067">preMasterSecret</span><span class="op" id="4231082">,</span>&nbsp;<span class="ident" id="4231084">ckx</span><span class="op" id="4231087">,</span>&nbsp;<span class="ident" id="4231089">err</span>&nbsp;<span class="op" id="4231093">:=</span>&nbsp;<span class="ident" id="4231096">keyAgreement</span><span class="op" id="4231108">.</span><span class="ident" id="4231109">generateClientKeyExchange</span><span class="op" id="4231134">(</span><span class="ident" id="4231135">c</span><span class="op" id="4231136">.</span><span class="ident" id="4231137">config</span><span class="op" id="4231143">,</span>&nbsp;<span class="ident" id="4231145">hs</span><span class="op" id="4231147">.</span><span class="ident" id="4231148">hello</span><span class="op" id="4231153">,</span>&nbsp;<span class="ident" id="4231155">certs</span><span class="op" id="4231160">[</span><span class="num" id="4231161">0</span><span class="op" id="4231162">]</span><span class="op" id="4231163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231166">if</span>&nbsp;<span class="ident" id="4231169">err</span>&nbsp;<span class="op" id="4231173">!=</span>&nbsp;<span class="builtintype" id="4231176">nil</span>&nbsp;<span class="op" id="4231180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231184">c</span><span class="op" id="4231185">.</span><span class="ident" id="4231186">sendAlert</span><span class="op" id="4231195">(</span><span class="ident" id="4231196">alertInternalError</span><span class="op" id="4231214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231218">return</span>&nbsp;<span class="ident" id="4231225">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4231230">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231233">if</span>&nbsp;<span class="ident" id="4231236">ckx</span>&nbsp;<span class="op" id="4231240">!=</span>&nbsp;<span class="builtintype" id="4231243">nil</span>&nbsp;<span class="op" id="4231247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231251">hs</span><span class="op" id="4231253">.</span><span class="ident" id="4231254">finishedHash</span><span class="op" id="4231266">.</span><span class="ident" id="4231267">Write</span><span class="op" id="4231272">(</span><span class="ident" id="4231273">ckx</span><span class="op" id="4231276">.</span><span class="ident" id="4231277">marshal</span><span class="op" id="4231284">(</span><span class="op" id="4231285">)</span><span class="op" id="4231286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231290">c</span><span class="op" id="4231291">.</span><span class="ident" id="4231292">writeRecord</span><span class="op" id="4231303">(</span><span class="ident" id="4231304">recordTypeHandshake</span><span class="op" id="4231323">,</span>&nbsp;<span class="ident" id="4231325">ckx</span><span class="op" id="4231328">.</span><span class="ident" id="4231329">marshal</span><span class="op" id="4231336">(</span><span class="op" id="4231337">)</span><span class="op" id="4231338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4231341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231345">if</span>&nbsp;<span class="ident" id="4231348">chainToSend</span>&nbsp;<span class="op" id="4231360">!=</span>&nbsp;<span class="builtintype" id="4231363">nil</span>&nbsp;<span class="op" id="4231367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231371">var</span>&nbsp;<span class="ident" id="4231375">signed</span>&nbsp;<span class="op" id="4231382">[</span><span class="op" id="4231383">]</span><span class="builtintype" id="4231384">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231391">certVerify</span>&nbsp;<span class="op" id="4231402">:=</span>&nbsp;<span class="op" id="4231405">&amp;</span><span class="ident" id="4231406">certificateVerifyMsg</span><span class="op" id="4231426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231431">hasSignatureAndHash</span><span class="op" id="4231450">:</span>&nbsp;<span class="ident" id="4231452">c</span><span class="op" id="4231453">.</span><span class="ident" id="4231454">vers</span>&nbsp;<span class="op" id="4231459">&gt;=</span>&nbsp;<span class="ident" id="4231462">VersionTLS12</span><span class="op" id="4231474">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4231478">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231483">key</span><span class="op" id="4231486">,</span>&nbsp;<span class="ident" id="4231488">ok</span>&nbsp;<span class="op" id="4231491">:=</span>&nbsp;<span class="ident" id="4231494">chainToSend</span><span class="op" id="4231505">.</span><span class="ident" id="4231506">PrivateKey</span><span class="op" id="4231516">.</span><span class="op" id="4231517">(</span><span class="ident" id="4231518">crypto</span><span class="op" id="4231524">.</span><span class="ident" id="4231525">Signer</span><span class="op" id="4231531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231535">if</span>&nbsp;<span class="op" id="4231538">!</span><span class="ident" id="4231539">ok</span>&nbsp;<span class="op" id="4231542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231547">c</span><span class="op" id="4231548">.</span><span class="ident" id="4231549">sendAlert</span><span class="op" id="4231558">(</span><span class="ident" id="4231559">alertInternalError</span><span class="op" id="4231577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231582">return</span>&nbsp;<span class="ident" id="4231589">fmt</span><span class="op" id="4231592">.</span><span class="ident" id="4231593">Errorf</span><span class="op" id="4231599">(</span><span class="string" id="4231600">&#34;tls:&nbsp;client&nbsp;certificate&nbsp;private&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&nbsp;does&nbsp;not&nbsp;implement&nbsp;crypto.Signer&#34;</span><span class="op" id="4231681">,</span>&nbsp;<span class="ident" id="4231683">chainToSend</span><span class="op" id="4231694">.</span><span class="ident" id="4231695">PrivateKey</span><span class="op" id="4231705">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4231709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231713">switch</span>&nbsp;<span class="ident" id="4231720">key</span><span class="op" id="4231723">.</span><span class="ident" id="4231724">Public</span><span class="op" id="4231730">(</span><span class="op" id="4231731">)</span><span class="op" id="4231732">.</span><span class="op" id="4231733">(</span><span class="keyword" id="4231734">type</span><span class="op" id="4231738">)</span>&nbsp;<span class="op" id="4231740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231744">case</span>&nbsp;<span class="op" id="4231749">*</span><span class="ident" id="4231750">ecdsa</span><span class="op" id="4231755">.</span><span class="ident" id="4231756">PublicKey</span><span class="op" id="4231765">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231770">digest</span><span class="op" id="4231776">,</span>&nbsp;<span class="ident" id="4231778">hashFunc</span><span class="op" id="4231786">,</span>&nbsp;<span class="ident" id="4231788">hashId</span>&nbsp;<span class="op" id="4231795">:=</span>&nbsp;<span class="ident" id="4231798">hs</span><span class="op" id="4231800">.</span><span class="ident" id="4231801">finishedHash</span><span class="op" id="4231813">.</span><span class="ident" id="4231814">hashForClientCertificate</span><span class="op" id="4231838">(</span><span class="ident" id="4231839">signatureECDSA</span><span class="op" id="4231853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231858">signed</span><span class="op" id="4231864">,</span>&nbsp;<span class="ident" id="4231866">err</span>&nbsp;<span class="op" id="4231870">=</span>&nbsp;<span class="ident" id="4231872">key</span><span class="op" id="4231875">.</span><span class="ident" id="4231876">Sign</span><span class="op" id="4231880">(</span><span class="ident" id="4231881">c</span><span class="op" id="4231882">.</span><span class="ident" id="4231883">config</span><span class="op" id="4231889">.</span><span class="ident" id="4231890">rand</span><span class="op" id="4231894">(</span><span class="op" id="4231895">)</span><span class="op" id="4231896">,</span>&nbsp;<span class="ident" id="4231898">digest</span><span class="op" id="4231904">,</span>&nbsp;<span class="ident" id="4231906">hashFunc</span><span class="op" id="4231914">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231919">certVerify</span><span class="op" id="4231929">.</span><span class="ident" id="4231930">signatureAndHash</span><span class="op" id="4231946">.</span><span class="ident" id="4231947">signature</span>&nbsp;<span class="op" id="4231957">=</span>&nbsp;<span class="ident" id="4231959">signatureECDSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231977">certVerify</span><span class="op" id="4231987">.</span><span class="ident" id="4231988">signatureAndHash</span><span class="op" id="4232004">.</span><span class="ident" id="4232005">hash</span>&nbsp;<span class="op" id="4232010">=</span>&nbsp;<span class="ident" id="4232012">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232021">case</span>&nbsp;<span class="op" id="4232026">*</span><span class="ident" id="4232027">rsa</span><span class="op" id="4232030">.</span><span class="ident" id="4232031">PublicKey</span><span class="op" id="4232040">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232045">digest</span><span class="op" id="4232051">,</span>&nbsp;<span class="ident" id="4232053">hashFunc</span><span class="op" id="4232061">,</span>&nbsp;<span class="ident" id="4232063">hashId</span>&nbsp;<span class="op" id="4232070">:=</span>&nbsp;<span class="ident" id="4232073">hs</span><span class="op" id="4232075">.</span><span class="ident" id="4232076">finishedHash</span><span class="op" id="4232088">.</span><span class="ident" id="4232089">hashForClientCertificate</span><span class="op" id="4232113">(</span><span class="ident" id="4232114">signatureRSA</span><span class="op" id="4232126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232131">signed</span><span class="op" id="4232137">,</span>&nbsp;<span class="ident" id="4232139">err</span>&nbsp;<span class="op" id="4232143">=</span>&nbsp;<span class="ident" id="4232145">key</span><span class="op" id="4232148">.</span><span class="ident" id="4232149">Sign</span><span class="op" id="4232153">(</span><span class="ident" id="4232154">c</span><span class="op" id="4232155">.</span><span class="ident" id="4232156">config</span><span class="op" id="4232162">.</span><span class="ident" id="4232163">rand</span><span class="op" id="4232167">(</span><span class="op" id="4232168">)</span><span class="op" id="4232169">,</span>&nbsp;<span class="ident" id="4232171">digest</span><span class="op" id="4232177">,</span>&nbsp;<span class="ident" id="4232179">hashFunc</span><span class="op" id="4232187">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232192">certVerify</span><span class="op" id="4232202">.</span><span class="ident" id="4232203">signatureAndHash</span><span class="op" id="4232219">.</span><span class="ident" id="4232220">signature</span>&nbsp;<span class="op" id="4232230">=</span>&nbsp;<span class="ident" id="4232232">signatureRSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232248">certVerify</span><span class="op" id="4232258">.</span><span class="ident" id="4232259">signatureAndHash</span><span class="op" id="4232275">.</span><span class="ident" id="4232276">hash</span>&nbsp;<span class="op" id="4232281">=</span>&nbsp;<span class="ident" id="4232283">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232292">default</span><span class="op" id="4232299">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232304">err</span>&nbsp;<span class="op" id="4232308">=</span>&nbsp;<span class="ident" id="4232310">fmt</span><span class="op" id="4232313">.</span><span class="ident" id="4232314">Errorf</span><span class="op" id="4232320">(</span><span class="string" id="4232321">&#34;tls:&nbsp;unknown&nbsp;client&nbsp;certificate&nbsp;key&nbsp;type:&nbsp;%T&#34;</span><span class="op" id="4232367">,</span>&nbsp;<span class="ident" id="4232369">key</span><span class="op" id="4232372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4232376">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232380">if</span>&nbsp;<span class="ident" id="4232383">err</span>&nbsp;<span class="op" id="4232387">!=</span>&nbsp;<span class="builtintype" id="4232390">nil</span>&nbsp;<span class="op" id="4232394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232399">c</span><span class="op" id="4232400">.</span><span class="ident" id="4232401">sendAlert</span><span class="op" id="4232410">(</span><span class="ident" id="4232411">alertInternalError</span><span class="op" id="4232429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232434">return</span>&nbsp;<span class="ident" id="4232441">errors</span><span class="op" id="4232447">.</span><span class="ident" id="4232448">New</span><span class="op" id="4232451">(</span><span class="string" id="4232452">&#34;tls:&nbsp;failed&nbsp;to&nbsp;sign&nbsp;handshake&nbsp;with&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4232510">+</span>&nbsp;<span class="ident" id="4232512">err</span><span class="op" id="4232515">.</span><span class="ident" id="4232516">Error</span><span class="op" id="4232521">(</span><span class="op" id="4232522">)</span><span class="op" id="4232523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4232527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232531">certVerify</span><span class="op" id="4232541">.</span><span class="ident" id="4232542">signature</span>&nbsp;<span class="op" id="4232552">=</span>&nbsp;<span class="ident" id="4232554">signed</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232564">hs</span><span class="op" id="4232566">.</span><span class="ident" id="4232567">finishedHash</span><span class="op" id="4232579">.</span><span class="ident" id="4232580">Write</span><span class="op" id="4232585">(</span><span class="ident" id="4232586">certVerify</span><span class="op" id="4232596">.</span><span class="ident" id="4232597">marshal</span><span class="op" id="4232604">(</span><span class="op" id="4232605">)</span><span class="op" id="4232606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232610">c</span><span class="op" id="4232611">.</span><span class="ident" id="4232612">writeRecord</span><span class="op" id="4232623">(</span><span class="ident" id="4232624">recordTypeHandshake</span><span class="op" id="4232643">,</span>&nbsp;<span class="ident" id="4232645">certVerify</span><span class="op" id="4232655">.</span><span class="ident" id="4232656">marshal</span><span class="op" id="4232663">(</span><span class="op" id="4232664">)</span><span class="op" id="4232665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4232668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232672">hs</span><span class="op" id="4232674">.</span><span class="ident" id="4232675">masterSecret</span>&nbsp;<span class="op" id="4232688">=</span>&nbsp;<span class="ident" id="4232690">masterFromPreMasterSecret</span><span class="op" id="4232715">(</span><span class="ident" id="4232716">c</span><span class="op" id="4232717">.</span><span class="ident" id="4232718">vers</span><span class="op" id="4232722">,</span>&nbsp;<span class="ident" id="4232724">preMasterSecret</span><span class="op" id="4232739">,</span>&nbsp;<span class="ident" id="4232741">hs</span><span class="op" id="4232743">.</span><span class="ident" id="4232744">hello</span><span class="op" id="4232749">.</span><span class="ident" id="4232750">random</span><span class="op" id="4232756">,</span>&nbsp;<span class="ident" id="4232758">hs</span><span class="op" id="4232760">.</span><span class="ident" id="4232761">serverHello</span><span class="op" id="4232772">.</span><span class="ident" id="4232773">random</span><span class="op" id="4232779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232782">return</span>&nbsp;<span class="builtintype" id="4232789">nil</span><br>
<span class="lineno"></span><span class="op" id="4232793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4232796">func</span>&nbsp;<span class="op" id="4232801">(</span><span class="ident" id="4232802">hs</span>&nbsp;<span class="op" id="4232805">*</span><span class="ident" id="4232806">clientHandshakeState</span><span class="op" id="4232826">)</span>&nbsp;<span class="ident" id="4232828">establishKeys</span><span class="op" id="4232841">(</span><span class="op" id="4232842">)</span>&nbsp;<span class="builtintype" id="4232844">error</span>&nbsp;<span class="op" id="4232850">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232853">c</span>&nbsp;<span class="op" id="4232855">:=</span>&nbsp;<span class="ident" id="4232858">hs</span><span class="op" id="4232860">.</span><span class="ident" id="4232861">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232865">clientMAC</span><span class="op" id="4232874">,</span>&nbsp;<span class="ident" id="4232876">serverMAC</span><span class="op" id="4232885">,</span>&nbsp;<span class="ident" id="4232887">clientKey</span><span class="op" id="4232896">,</span>&nbsp;<span class="ident" id="4232898">serverKey</span><span class="op" id="4232907">,</span>&nbsp;<span class="ident" id="4232909">clientIV</span><span class="op" id="4232917">,</span>&nbsp;<span class="ident" id="4232919">serverIV</span>&nbsp;<span class="op" id="4232928">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232933">keysFromMasterSecret</span><span class="op" id="4232953">(</span><span class="ident" id="4232954">c</span><span class="op" id="4232955">.</span><span class="ident" id="4232956">vers</span><span class="op" id="4232960">,</span>&nbsp;<span class="ident" id="4232962">hs</span><span class="op" id="4232964">.</span><span class="ident" id="4232965">masterSecret</span><span class="op" id="4232977">,</span>&nbsp;<span class="ident" id="4232979">hs</span><span class="op" id="4232981">.</span><span class="ident" id="4232982">hello</span><span class="op" id="4232987">.</span><span class="ident" id="4232988">random</span><span class="op" id="4232994">,</span>&nbsp;<span class="ident" id="4232996">hs</span><span class="op" id="4232998">.</span><span class="ident" id="4232999">serverHello</span><span class="op" id="4233010">.</span><span class="ident" id="4233011">random</span><span class="op" id="4233017">,</span>&nbsp;<span class="ident" id="4233019">hs</span><span class="op" id="4233021">.</span><span class="ident" id="4233022">suite</span><span class="op" id="4233027">.</span><span class="ident" id="4233028">macLen</span><span class="op" id="4233034">,</span>&nbsp;<span class="ident" id="4233036">hs</span><span class="op" id="4233038">.</span><span class="ident" id="4233039">suite</span><span class="op" id="4233044">.</span><span class="ident" id="4233045">keyLen</span><span class="op" id="4233051">,</span>&nbsp;<span class="ident" id="4233053">hs</span><span class="op" id="4233055">.</span><span class="ident" id="4233056">suite</span><span class="op" id="4233061">.</span><span class="ident" id="4233062">ivLen</span><span class="op" id="4233067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233070">var</span>&nbsp;<span class="ident" id="4233074">clientCipher</span><span class="op" id="4233086">,</span>&nbsp;<span class="ident" id="4233088">serverCipher</span>&nbsp;<span class="keyword" id="4233101">interface</span><span class="op" id="4233110">{</span><span class="op" id="4233111">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233114">var</span>&nbsp;<span class="ident" id="4233118">clientHash</span><span class="op" id="4233128">,</span>&nbsp;<span class="ident" id="4233130">serverHash</span>&nbsp;<span class="ident" id="4233141">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233154">if</span>&nbsp;<span class="ident" id="4233157">hs</span><span class="op" id="4233159">.</span><span class="ident" id="4233160">suite</span><span class="op" id="4233165">.</span><span class="ident" id="4233166">cipher</span>&nbsp;<span class="op" id="4233173">!=</span>&nbsp;<span class="builtintype" id="4233176">nil</span>&nbsp;<span class="op" id="4233180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233184">clientCipher</span>&nbsp;<span class="op" id="4233197">=</span>&nbsp;<span class="ident" id="4233199">hs</span><span class="op" id="4233201">.</span><span class="ident" id="4233202">suite</span><span class="op" id="4233207">.</span><span class="ident" id="4233208">cipher</span><span class="op" id="4233214">(</span><span class="ident" id="4233215">clientKey</span><span class="op" id="4233224">,</span>&nbsp;<span class="ident" id="4233226">clientIV</span><span class="op" id="4233234">,</span>&nbsp;<span class="builtintype" id="4233236">false</span>&nbsp;<span class="comment" id="4233242">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4233263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233267">clientHash</span>&nbsp;<span class="op" id="4233278">=</span>&nbsp;<span class="ident" id="4233280">hs</span><span class="op" id="4233282">.</span><span class="ident" id="4233283">suite</span><span class="op" id="4233288">.</span><span class="ident" id="4233289">mac</span><span class="op" id="4233292">(</span><span class="ident" id="4233293">c</span><span class="op" id="4233294">.</span><span class="ident" id="4233295">vers</span><span class="op" id="4233299">,</span>&nbsp;<span class="ident" id="4233301">clientMAC</span><span class="op" id="4233310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233314">serverCipher</span>&nbsp;<span class="op" id="4233327">=</span>&nbsp;<span class="ident" id="4233329">hs</span><span class="op" id="4233331">.</span><span class="ident" id="4233332">suite</span><span class="op" id="4233337">.</span><span class="ident" id="4233338">cipher</span><span class="op" id="4233344">(</span><span class="ident" id="4233345">serverKey</span><span class="op" id="4233354">,</span>&nbsp;<span class="ident" id="4233356">serverIV</span><span class="op" id="4233364">,</span>&nbsp;<span class="builtintype" id="4233366">true</span>&nbsp;<span class="comment" id="4233371">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4233388">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233392">serverHash</span>&nbsp;<span class="op" id="4233403">=</span>&nbsp;<span class="ident" id="4233405">hs</span><span class="op" id="4233407">.</span><span class="ident" id="4233408">suite</span><span class="op" id="4233413">.</span><span class="ident" id="4233414">mac</span><span class="op" id="4233417">(</span><span class="ident" id="4233418">c</span><span class="op" id="4233419">.</span><span class="ident" id="4233420">vers</span><span class="op" id="4233424">,</span>&nbsp;<span class="ident" id="4233426">serverMAC</span><span class="op" id="4233435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4233438">}</span>&nbsp;<span class="keyword" id="4233440">else</span>&nbsp;<span class="op" id="4233445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233449">clientCipher</span>&nbsp;<span class="op" id="4233462">=</span>&nbsp;<span class="ident" id="4233464">hs</span><span class="op" id="4233466">.</span><span class="ident" id="4233467">suite</span><span class="op" id="4233472">.</span><span class="ident" id="4233473">aead</span><span class="op" id="4233477">(</span><span class="ident" id="4233478">clientKey</span><span class="op" id="4233487">,</span>&nbsp;<span class="ident" id="4233489">clientIV</span><span class="op" id="4233497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233501">serverCipher</span>&nbsp;<span class="op" id="4233514">=</span>&nbsp;<span class="ident" id="4233516">hs</span><span class="op" id="4233518">.</span><span class="ident" id="4233519">suite</span><span class="op" id="4233524">.</span><span class="ident" id="4233525">aead</span><span class="op" id="4233529">(</span><span class="ident" id="4233530">serverKey</span><span class="op" id="4233539">,</span>&nbsp;<span class="ident" id="4233541">serverIV</span><span class="op" id="4233549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4233552">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233556">c</span><span class="op" id="4233557">.</span><span class="ident" id="4233558">in</span><span class="op" id="4233560">.</span><span class="ident" id="4233561">prepareCipherSpec</span><span class="op" id="4233578">(</span><span class="ident" id="4233579">c</span><span class="op" id="4233580">.</span><span class="ident" id="4233581">vers</span><span class="op" id="4233585">,</span>&nbsp;<span class="ident" id="4233587">serverCipher</span><span class="op" id="4233599">,</span>&nbsp;<span class="ident" id="4233601">serverHash</span><span class="op" id="4233611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233614">c</span><span class="op" id="4233615">.</span><span class="ident" id="4233616">out</span><span class="op" id="4233619">.</span><span class="ident" id="4233620">prepareCipherSpec</span><span class="op" id="4233637">(</span><span class="ident" id="4233638">c</span><span class="op" id="4233639">.</span><span class="ident" id="4233640">vers</span><span class="op" id="4233644">,</span>&nbsp;<span class="ident" id="4233646">clientCipher</span><span class="op" id="4233658">,</span>&nbsp;<span class="ident" id="4233660">clientHash</span><span class="op" id="4233670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233673">return</span>&nbsp;<span class="builtintype" id="4233680">nil</span><br>
<span class="lineno"></span><span class="op" id="4233684">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="4233687">func</span>&nbsp;<span class="op" id="4233692">(</span><span class="ident" id="4233693">hs</span>&nbsp;<span class="op" id="4233696">*</span><span class="ident" id="4233697">clientHandshakeState</span><span class="op" id="4233717">)</span>&nbsp;<span class="ident" id="4233719">serverResumedSession</span><span class="op" id="4233739">(</span><span class="op" id="4233740">)</span>&nbsp;<span class="builtintype" id="4233742">bool</span>&nbsp;<span class="op" id="4233747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4233750">//&nbsp;If&nbsp;the&nbsp;server&nbsp;responded&nbsp;with&nbsp;the&nbsp;same&nbsp;sessionId&nbsp;then&nbsp;it&nbsp;means&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4233820">//&nbsp;sessionTicket&nbsp;is&nbsp;being&nbsp;used&nbsp;to&nbsp;resume&nbsp;a&nbsp;TLS&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233877">return</span>&nbsp;<span class="ident" id="4233884">hs</span><span class="op" id="4233886">.</span><span class="ident" id="4233887">session</span>&nbsp;<span class="op" id="4233895">!=</span>&nbsp;<span class="builtintype" id="4233898">nil</span>&nbsp;<span class="op" id="4233902">&amp;&amp;</span>&nbsp;<span class="ident" id="4233905">hs</span><span class="op" id="4233907">.</span><span class="ident" id="4233908">hello</span><span class="op" id="4233913">.</span><span class="ident" id="4233914">sessionId</span>&nbsp;<span class="op" id="4233924">!=</span>&nbsp;<span class="builtintype" id="4233927">nil</span>&nbsp;<span class="op" id="4233931">&amp;&amp;</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233936">bytes</span><span class="op" id="4233941">.</span><span class="ident" id="4233942">Equal</span><span class="op" id="4233947">(</span><span class="ident" id="4233948">hs</span><span class="op" id="4233950">.</span><span class="ident" id="4233951">serverHello</span><span class="op" id="4233962">.</span><span class="ident" id="4233963">sessionId</span><span class="op" id="4233972">,</span>&nbsp;<span class="ident" id="4233974">hs</span><span class="op" id="4233976">.</span><span class="ident" id="4233977">hello</span><span class="op" id="4233982">.</span><span class="ident" id="4233983">sessionId</span><span class="op" id="4233992">)</span><br>
<span class="lineno"></span><span class="op" id="4233994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4233997">func</span>&nbsp;<span class="op" id="4234002">(</span><span class="ident" id="4234003">hs</span>&nbsp;<span class="op" id="4234006">*</span><span class="ident" id="4234007">clientHandshakeState</span><span class="op" id="4234027">)</span>&nbsp;<span class="ident" id="4234029">processServerHello</span><span class="op" id="4234047">(</span><span class="op" id="4234048">)</span>&nbsp;<span class="op" id="4234050">(</span><span class="builtintype" id="4234051">bool</span><span class="op" id="4234055">,</span>&nbsp;<span class="builtintype" id="4234057">error</span><span class="op" id="4234062">)</span>&nbsp;<span class="op" id="4234064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234067">c</span>&nbsp;<span class="op" id="4234069">:=</span>&nbsp;<span class="ident" id="4234072">hs</span><span class="op" id="4234074">.</span><span class="ident" id="4234075">c</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234079">if</span>&nbsp;<span class="ident" id="4234082">hs</span><span class="op" id="4234084">.</span><span class="ident" id="4234085">serverHello</span><span class="op" id="4234096">.</span><span class="ident" id="4234097">compressionMethod</span>&nbsp;<span class="op" id="4234115">!=</span>&nbsp;<span class="ident" id="4234118">compressionNone</span>&nbsp;<span class="op" id="4234134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234138">c</span><span class="op" id="4234139">.</span><span class="ident" id="4234140">sendAlert</span><span class="op" id="4234149">(</span><span class="ident" id="4234150">alertUnexpectedMessage</span><span class="op" id="4234172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234176">return</span>&nbsp;<span class="builtintype" id="4234183">false</span><span class="op" id="4234188">,</span>&nbsp;<span class="ident" id="4234190">errors</span><span class="op" id="4234196">.</span><span class="ident" id="4234197">New</span><span class="op" id="4234200">(</span><span class="string" id="4234201">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;compression&nbsp;format&#34;</span><span class="op" id="4234254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4234257">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234261">clientDidNPN</span>&nbsp;<span class="op" id="4234274">:=</span>&nbsp;<span class="ident" id="4234277">hs</span><span class="op" id="4234279">.</span><span class="ident" id="4234280">hello</span><span class="op" id="4234285">.</span><span class="ident" id="4234286">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234300">clientDidALPN</span>&nbsp;<span class="op" id="4234314">:=</span>&nbsp;<span class="builtinfunc" id="4234317">len</span><span class="op" id="4234320">(</span><span class="ident" id="4234321">hs</span><span class="op" id="4234323">.</span><span class="ident" id="4234324">hello</span><span class="op" id="4234329">.</span><span class="ident" id="4234330">alpnProtocols</span><span class="op" id="4234343">)</span>&nbsp;<span class="op" id="4234345">&gt;</span>&nbsp;<span class="num" id="4234347">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234350">serverHasNPN</span>&nbsp;<span class="op" id="4234363">:=</span>&nbsp;<span class="ident" id="4234366">hs</span><span class="op" id="4234368">.</span><span class="ident" id="4234369">serverHello</span><span class="op" id="4234380">.</span><span class="ident" id="4234381">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234395">serverHasALPN</span>&nbsp;<span class="op" id="4234409">:=</span>&nbsp;<span class="builtinfunc" id="4234412">len</span><span class="op" id="4234415">(</span><span class="ident" id="4234416">hs</span><span class="op" id="4234418">.</span><span class="ident" id="4234419">serverHello</span><span class="op" id="4234430">.</span><span class="ident" id="4234431">alpnProtocol</span><span class="op" id="4234443">)</span>&nbsp;<span class="op" id="4234445">&gt;</span>&nbsp;<span class="num" id="4234447">0</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234451">if</span>&nbsp;<span class="op" id="4234454">!</span><span class="ident" id="4234455">clientDidNPN</span>&nbsp;<span class="op" id="4234468">&amp;&amp;</span>&nbsp;<span class="ident" id="4234471">serverHasNPN</span>&nbsp;<span class="op" id="4234484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234488">c</span><span class="op" id="4234489">.</span><span class="ident" id="4234490">sendAlert</span><span class="op" id="4234499">(</span><span class="ident" id="4234500">alertHandshakeFailure</span><span class="op" id="4234521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234525">return</span>&nbsp;<span class="builtintype" id="4234532">false</span><span class="op" id="4234537">,</span>&nbsp;<span class="ident" id="4234539">errors</span><span class="op" id="4234545">.</span><span class="ident" id="4234546">New</span><span class="op" id="4234549">(</span><span class="string" id="4234550">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;NPN&nbsp;extension&#34;</span><span class="op" id="4234595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4234598">}</span><br>
<span class="lineno">510</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234602">if</span>&nbsp;<span class="op" id="4234605">!</span><span class="ident" id="4234606">clientDidALPN</span>&nbsp;<span class="op" id="4234620">&amp;&amp;</span>&nbsp;<span class="ident" id="4234623">serverHasALPN</span>&nbsp;<span class="op" id="4234637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234641">c</span><span class="op" id="4234642">.</span><span class="ident" id="4234643">sendAlert</span><span class="op" id="4234652">(</span><span class="ident" id="4234653">alertHandshakeFailure</span><span class="op" id="4234674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234678">return</span>&nbsp;<span class="builtintype" id="4234685">false</span><span class="op" id="4234690">,</span>&nbsp;<span class="ident" id="4234692">errors</span><span class="op" id="4234698">.</span><span class="ident" id="4234699">New</span><span class="op" id="4234702">(</span><span class="string" id="4234703">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;ALPN&nbsp;extension&#34;</span><span class="op" id="4234749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4234752">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234756">if</span>&nbsp;<span class="ident" id="4234759">serverHasNPN</span>&nbsp;<span class="op" id="4234772">&amp;&amp;</span>&nbsp;<span class="ident" id="4234775">serverHasALPN</span>&nbsp;<span class="op" id="4234789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234793">c</span><span class="op" id="4234794">.</span><span class="ident" id="4234795">sendAlert</span><span class="op" id="4234804">(</span><span class="ident" id="4234805">alertHandshakeFailure</span><span class="op" id="4234826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234830">return</span>&nbsp;<span class="builtintype" id="4234837">false</span><span class="op" id="4234842">,</span>&nbsp;<span class="ident" id="4234844">errors</span><span class="op" id="4234850">.</span><span class="ident" id="4234851">New</span><span class="op" id="4234854">(</span><span class="string" id="4234855">&#34;server&nbsp;advertised&nbsp;both&nbsp;NPN&nbsp;and&nbsp;ALPN&nbsp;extensions&#34;</span><span class="op" id="4234903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4234906">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234910">if</span>&nbsp;<span class="ident" id="4234913">serverHasALPN</span>&nbsp;<span class="op" id="4234927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234931">c</span><span class="op" id="4234932">.</span><span class="ident" id="4234933">clientProtocol</span>&nbsp;<span class="op" id="4234948">=</span>&nbsp;<span class="ident" id="4234950">hs</span><span class="op" id="4234952">.</span><span class="ident" id="4234953">serverHello</span><span class="op" id="4234964">.</span><span class="ident" id="4234965">alpnProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234980">c</span><span class="op" id="4234981">.</span><span class="ident" id="4234982">clientProtocolFallback</span>&nbsp;<span class="op" id="4235005">=</span>&nbsp;<span class="builtintype" id="4235007">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4235014">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235018">if</span>&nbsp;<span class="ident" id="4235021">hs</span><span class="op" id="4235023">.</span><span class="ident" id="4235024">serverResumedSession</span><span class="op" id="4235044">(</span><span class="op" id="4235045">)</span>&nbsp;<span class="op" id="4235047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4235051">//&nbsp;Restore&nbsp;masterSecret&nbsp;and&nbsp;peerCerts&nbsp;from&nbsp;previous&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235111">hs</span><span class="op" id="4235113">.</span><span class="ident" id="4235114">masterSecret</span>&nbsp;<span class="op" id="4235127">=</span>&nbsp;<span class="ident" id="4235129">hs</span><span class="op" id="4235131">.</span><span class="ident" id="4235132">session</span><span class="op" id="4235139">.</span><span class="ident" id="4235140">masterSecret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235155">c</span><span class="op" id="4235156">.</span><span class="ident" id="4235157">peerCertificates</span>&nbsp;<span class="op" id="4235174">=</span>&nbsp;<span class="ident" id="4235176">hs</span><span class="op" id="4235178">.</span><span class="ident" id="4235179">session</span><span class="op" id="4235186">.</span><span class="ident" id="4235187">serverCertificates</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235208">return</span>&nbsp;<span class="builtintype" id="4235215">true</span><span class="op" id="4235219">,</span>&nbsp;<span class="builtintype" id="4235221">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4235226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235229">return</span>&nbsp;<span class="builtintype" id="4235236">false</span><span class="op" id="4235241">,</span>&nbsp;<span class="builtintype" id="4235243">nil</span><br>
<span class="lineno"></span><span class="op" id="4235247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="4235250">func</span>&nbsp;<span class="op" id="4235255">(</span><span class="ident" id="4235256">hs</span>&nbsp;<span class="op" id="4235259">*</span><span class="ident" id="4235260">clientHandshakeState</span><span class="op" id="4235280">)</span>&nbsp;<span class="ident" id="4235282">readFinished</span><span class="op" id="4235294">(</span><span class="ident" id="4235295">out</span>&nbsp;<span class="op" id="4235299">[</span><span class="op" id="4235300">]</span><span class="builtintype" id="4235301">byte</span><span class="op" id="4235305">)</span>&nbsp;<span class="builtintype" id="4235307">error</span>&nbsp;<span class="op" id="4235313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235316">c</span>&nbsp;<span class="op" id="4235318">:=</span>&nbsp;<span class="ident" id="4235321">hs</span><span class="op" id="4235323">.</span><span class="ident" id="4235324">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235328">c</span><span class="op" id="4235329">.</span><span class="ident" id="4235330">readRecord</span><span class="op" id="4235340">(</span><span class="ident" id="4235341">recordTypeChangeCipherSpec</span><span class="op" id="4235367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235370">if</span>&nbsp;<span class="ident" id="4235373">err</span>&nbsp;<span class="op" id="4235377">:=</span>&nbsp;<span class="ident" id="4235380">c</span><span class="op" id="4235381">.</span><span class="ident" id="4235382">in</span><span class="op" id="4235384">.</span><span class="builtintype" id="4235385">error</span><span class="op" id="4235390">(</span><span class="op" id="4235391">)</span><span class="op" id="4235392">;</span>&nbsp;<span class="ident" id="4235394">err</span>&nbsp;<span class="op" id="4235398">!=</span>&nbsp;<span class="builtintype" id="4235401">nil</span>&nbsp;<span class="op" id="4235405">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235409">return</span>&nbsp;<span class="ident" id="4235416">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4235421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235425">msg</span><span class="op" id="4235428">,</span>&nbsp;<span class="ident" id="4235430">err</span>&nbsp;<span class="op" id="4235434">:=</span>&nbsp;<span class="ident" id="4235437">c</span><span class="op" id="4235438">.</span><span class="ident" id="4235439">readHandshake</span><span class="op" id="4235452">(</span><span class="op" id="4235453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235456">if</span>&nbsp;<span class="ident" id="4235459">err</span>&nbsp;<span class="op" id="4235463">!=</span>&nbsp;<span class="builtintype" id="4235466">nil</span>&nbsp;<span class="op" id="4235470">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235474">return</span>&nbsp;<span class="ident" id="4235481">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4235486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235489">serverFinished</span><span class="op" id="4235503">,</span>&nbsp;<span class="ident" id="4235505">ok</span>&nbsp;<span class="op" id="4235508">:=</span>&nbsp;<span class="ident" id="4235511">msg</span><span class="op" id="4235514">.</span><span class="op" id="4235515">(</span><span class="op" id="4235516">*</span><span class="ident" id="4235517">finishedMsg</span><span class="op" id="4235528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235531">if</span>&nbsp;<span class="op" id="4235534">!</span><span class="ident" id="4235535">ok</span>&nbsp;<span class="op" id="4235538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235542">c</span><span class="op" id="4235543">.</span><span class="ident" id="4235544">sendAlert</span><span class="op" id="4235553">(</span><span class="ident" id="4235554">alertUnexpectedMessage</span><span class="op" id="4235576">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235580">return</span>&nbsp;<span class="ident" id="4235587">unexpectedMessageError</span><span class="op" id="4235609">(</span><span class="ident" id="4235610">serverFinished</span><span class="op" id="4235624">,</span>&nbsp;<span class="ident" id="4235626">msg</span><span class="op" id="4235629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4235632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235636">verify</span>&nbsp;<span class="op" id="4235643">:=</span>&nbsp;<span class="ident" id="4235646">hs</span><span class="op" id="4235648">.</span><span class="ident" id="4235649">finishedHash</span><span class="op" id="4235661">.</span><span class="ident" id="4235662">serverSum</span><span class="op" id="4235671">(</span><span class="ident" id="4235672">hs</span><span class="op" id="4235674">.</span><span class="ident" id="4235675">masterSecret</span><span class="op" id="4235687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235690">if</span>&nbsp;<span class="builtinfunc" id="4235693">len</span><span class="op" id="4235696">(</span><span class="ident" id="4235697">verify</span><span class="op" id="4235703">)</span>&nbsp;<span class="op" id="4235705">!=</span>&nbsp;<span class="builtinfunc" id="4235708">len</span><span class="op" id="4235711">(</span><span class="ident" id="4235712">serverFinished</span><span class="op" id="4235726">.</span><span class="ident" id="4235727">verifyData</span><span class="op" id="4235737">)</span>&nbsp;<span class="op" id="4235739">||</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235744">subtle</span><span class="op" id="4235750">.</span><span class="ident" id="4235751">ConstantTimeCompare</span><span class="op" id="4235770">(</span><span class="ident" id="4235771">verify</span><span class="op" id="4235777">,</span>&nbsp;<span class="ident" id="4235779">serverFinished</span><span class="op" id="4235793">.</span><span class="ident" id="4235794">verifyData</span><span class="op" id="4235804">)</span>&nbsp;<span class="op" id="4235806">!=</span>&nbsp;<span class="num" id="4235809">1</span>&nbsp;<span class="op" id="4235811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235815">c</span><span class="op" id="4235816">.</span><span class="ident" id="4235817">sendAlert</span><span class="op" id="4235826">(</span><span class="ident" id="4235827">alertHandshakeFailure</span><span class="op" id="4235848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235852">return</span>&nbsp;<span class="ident" id="4235859">errors</span><span class="op" id="4235865">.</span><span class="ident" id="4235866">New</span><span class="op" id="4235869">(</span><span class="string" id="4235870">&#34;tls:&nbsp;server&#39;s&nbsp;Finished&nbsp;message&nbsp;was&nbsp;incorrect&#34;</span><span class="op" id="4235916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4235919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235922">hs</span><span class="op" id="4235924">.</span><span class="ident" id="4235925">finishedHash</span><span class="op" id="4235937">.</span><span class="ident" id="4235938">Write</span><span class="op" id="4235943">(</span><span class="ident" id="4235944">serverFinished</span><span class="op" id="4235958">.</span><span class="ident" id="4235959">marshal</span><span class="op" id="4235966">(</span><span class="op" id="4235967">)</span><span class="op" id="4235968">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4235971">copy</span><span class="op" id="4235975">(</span><span class="ident" id="4235976">out</span><span class="op" id="4235979">,</span>&nbsp;<span class="ident" id="4235981">verify</span><span class="op" id="4235987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235990">return</span>&nbsp;<span class="builtintype" id="4235997">nil</span><br>
<span class="lineno"></span><span class="op" id="4236001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4236004">func</span>&nbsp;<span class="op" id="4236009">(</span><span class="ident" id="4236010">hs</span>&nbsp;<span class="op" id="4236013">*</span><span class="ident" id="4236014">clientHandshakeState</span><span class="op" id="4236034">)</span>&nbsp;<span class="ident" id="4236036">readSessionTicket</span><span class="op" id="4236053">(</span><span class="op" id="4236054">)</span>&nbsp;<span class="builtintype" id="4236056">error</span>&nbsp;<span class="op" id="4236062">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236065">if</span>&nbsp;<span class="op" id="4236068">!</span><span class="ident" id="4236069">hs</span><span class="op" id="4236071">.</span><span class="ident" id="4236072">serverHello</span><span class="op" id="4236083">.</span><span class="ident" id="4236084">ticketSupported</span>&nbsp;<span class="op" id="4236100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236104">return</span>&nbsp;<span class="builtintype" id="4236111">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4236116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236120">c</span>&nbsp;<span class="op" id="4236122">:=</span>&nbsp;<span class="ident" id="4236125">hs</span><span class="op" id="4236127">.</span><span class="ident" id="4236128">c</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236131">msg</span><span class="op" id="4236134">,</span>&nbsp;<span class="ident" id="4236136">err</span>&nbsp;<span class="op" id="4236140">:=</span>&nbsp;<span class="ident" id="4236143">c</span><span class="op" id="4236144">.</span><span class="ident" id="4236145">readHandshake</span><span class="op" id="4236158">(</span><span class="op" id="4236159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236162">if</span>&nbsp;<span class="ident" id="4236165">err</span>&nbsp;<span class="op" id="4236169">!=</span>&nbsp;<span class="builtintype" id="4236172">nil</span>&nbsp;<span class="op" id="4236176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236180">return</span>&nbsp;<span class="ident" id="4236187">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4236192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236195">sessionTicketMsg</span><span class="op" id="4236211">,</span>&nbsp;<span class="ident" id="4236213">ok</span>&nbsp;<span class="op" id="4236216">:=</span>&nbsp;<span class="ident" id="4236219">msg</span><span class="op" id="4236222">.</span><span class="op" id="4236223">(</span><span class="op" id="4236224">*</span><span class="ident" id="4236225">newSessionTicketMsg</span><span class="op" id="4236244">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236247">if</span>&nbsp;<span class="op" id="4236250">!</span><span class="ident" id="4236251">ok</span>&nbsp;<span class="op" id="4236254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236258">c</span><span class="op" id="4236259">.</span><span class="ident" id="4236260">sendAlert</span><span class="op" id="4236269">(</span><span class="ident" id="4236270">alertUnexpectedMessage</span><span class="op" id="4236292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236296">return</span>&nbsp;<span class="ident" id="4236303">unexpectedMessageError</span><span class="op" id="4236325">(</span><span class="ident" id="4236326">sessionTicketMsg</span><span class="op" id="4236342">,</span>&nbsp;<span class="ident" id="4236344">msg</span><span class="op" id="4236347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4236350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236353">hs</span><span class="op" id="4236355">.</span><span class="ident" id="4236356">finishedHash</span><span class="op" id="4236368">.</span><span class="ident" id="4236369">Write</span><span class="op" id="4236374">(</span><span class="ident" id="4236375">sessionTicketMsg</span><span class="op" id="4236391">.</span><span class="ident" id="4236392">marshal</span><span class="op" id="4236399">(</span><span class="op" id="4236400">)</span><span class="op" id="4236401">)</span><br>
<span class="lineno">580</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236405">hs</span><span class="op" id="4236407">.</span><span class="ident" id="4236408">session</span>&nbsp;<span class="op" id="4236416">=</span>&nbsp;<span class="op" id="4236418">&amp;</span><span class="ident" id="4236419">ClientSessionState</span><span class="op" id="4236437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236441">sessionTicket</span><span class="op" id="4236454">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236461">sessionTicketMsg</span><span class="op" id="4236477">.</span><span class="ident" id="4236478">ticket</span><span class="op" id="4236484">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236488">vers</span><span class="op" id="4236492">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236508">c</span><span class="op" id="4236509">.</span><span class="ident" id="4236510">vers</span><span class="op" id="4236514">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236518">cipherSuite</span><span class="op" id="4236529">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236538">hs</span><span class="op" id="4236540">.</span><span class="ident" id="4236541">suite</span><span class="op" id="4236546">.</span><span class="ident" id="4236547">id</span><span class="op" id="4236549">,</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236553">masterSecret</span><span class="op" id="4236565">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236573">hs</span><span class="op" id="4236575">.</span><span class="ident" id="4236576">masterSecret</span><span class="op" id="4236588">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236592">serverCertificates</span><span class="op" id="4236610">:</span>&nbsp;<span class="ident" id="4236612">c</span><span class="op" id="4236613">.</span><span class="ident" id="4236614">peerCertificates</span><span class="op" id="4236630">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4236633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236637">return</span>&nbsp;<span class="builtintype" id="4236644">nil</span><br>
<span class="lineno">590</span><span class="op" id="4236648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4236651">func</span>&nbsp;<span class="op" id="4236656">(</span><span class="ident" id="4236657">hs</span>&nbsp;<span class="op" id="4236660">*</span><span class="ident" id="4236661">clientHandshakeState</span><span class="op" id="4236681">)</span>&nbsp;<span class="ident" id="4236683">sendFinished</span><span class="op" id="4236695">(</span><span class="ident" id="4236696">out</span>&nbsp;<span class="op" id="4236700">[</span><span class="op" id="4236701">]</span><span class="builtintype" id="4236702">byte</span><span class="op" id="4236706">)</span>&nbsp;<span class="builtintype" id="4236708">error</span>&nbsp;<span class="op" id="4236714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236717">c</span>&nbsp;<span class="op" id="4236719">:=</span>&nbsp;<span class="ident" id="4236722">hs</span><span class="op" id="4236724">.</span><span class="ident" id="4236725">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236729">c</span><span class="op" id="4236730">.</span><span class="ident" id="4236731">writeRecord</span><span class="op" id="4236742">(</span><span class="ident" id="4236743">recordTypeChangeCipherSpec</span><span class="op" id="4236769">,</span>&nbsp;<span class="op" id="4236771">[</span><span class="op" id="4236772">]</span><span class="builtintype" id="4236773">byte</span><span class="op" id="4236777">{</span><span class="num" id="4236778">1</span><span class="op" id="4236779">}</span><span class="op" id="4236780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236783">if</span>&nbsp;<span class="ident" id="4236786">hs</span><span class="op" id="4236788">.</span><span class="ident" id="4236789">serverHello</span><span class="op" id="4236800">.</span><span class="ident" id="4236801">nextProtoNeg</span>&nbsp;<span class="op" id="4236814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236818">nextProto</span>&nbsp;<span class="op" id="4236828">:=</span>&nbsp;<span class="builtinfunc" id="4236831">new</span><span class="op" id="4236834">(</span><span class="ident" id="4236835">nextProtoMsg</span><span class="op" id="4236847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236851">proto</span><span class="op" id="4236856">,</span>&nbsp;<span class="ident" id="4236858">fallback</span>&nbsp;<span class="op" id="4236867">:=</span>&nbsp;<span class="ident" id="4236870">mutualProtocol</span><span class="op" id="4236884">(</span><span class="ident" id="4236885">c</span><span class="op" id="4236886">.</span><span class="ident" id="4236887">config</span><span class="op" id="4236893">.</span><span class="ident" id="4236894">NextProtos</span><span class="op" id="4236904">,</span>&nbsp;<span class="ident" id="4236906">hs</span><span class="op" id="4236908">.</span><span class="ident" id="4236909">serverHello</span><span class="op" id="4236920">.</span><span class="ident" id="4236921">nextProtos</span><span class="op" id="4236931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236935">nextProto</span><span class="op" id="4236944">.</span><span class="ident" id="4236945">proto</span>&nbsp;<span class="op" id="4236951">=</span>&nbsp;<span class="ident" id="4236953">proto</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236961">c</span><span class="op" id="4236962">.</span><span class="ident" id="4236963">clientProtocol</span>&nbsp;<span class="op" id="4236978">=</span>&nbsp;<span class="ident" id="4236980">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236988">c</span><span class="op" id="4236989">.</span><span class="ident" id="4236990">clientProtocolFallback</span>&nbsp;<span class="op" id="4237013">=</span>&nbsp;<span class="ident" id="4237015">fallback</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237027">hs</span><span class="op" id="4237029">.</span><span class="ident" id="4237030">finishedHash</span><span class="op" id="4237042">.</span><span class="ident" id="4237043">Write</span><span class="op" id="4237048">(</span><span class="ident" id="4237049">nextProto</span><span class="op" id="4237058">.</span><span class="ident" id="4237059">marshal</span><span class="op" id="4237066">(</span><span class="op" id="4237067">)</span><span class="op" id="4237068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237072">c</span><span class="op" id="4237073">.</span><span class="ident" id="4237074">writeRecord</span><span class="op" id="4237085">(</span><span class="ident" id="4237086">recordTypeHandshake</span><span class="op" id="4237105">,</span>&nbsp;<span class="ident" id="4237107">nextProto</span><span class="op" id="4237116">.</span><span class="ident" id="4237117">marshal</span><span class="op" id="4237124">(</span><span class="op" id="4237125">)</span><span class="op" id="4237126">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4237129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237133">finished</span>&nbsp;<span class="op" id="4237142">:=</span>&nbsp;<span class="builtinfunc" id="4237145">new</span><span class="op" id="4237148">(</span><span class="ident" id="4237149">finishedMsg</span><span class="op" id="4237160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237163">finished</span><span class="op" id="4237171">.</span><span class="ident" id="4237172">verifyData</span>&nbsp;<span class="op" id="4237183">=</span>&nbsp;<span class="ident" id="4237185">hs</span><span class="op" id="4237187">.</span><span class="ident" id="4237188">finishedHash</span><span class="op" id="4237200">.</span><span class="ident" id="4237201">clientSum</span><span class="op" id="4237210">(</span><span class="ident" id="4237211">hs</span><span class="op" id="4237213">.</span><span class="ident" id="4237214">masterSecret</span><span class="op" id="4237226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237229">hs</span><span class="op" id="4237231">.</span><span class="ident" id="4237232">finishedHash</span><span class="op" id="4237244">.</span><span class="ident" id="4237245">Write</span><span class="op" id="4237250">(</span><span class="ident" id="4237251">finished</span><span class="op" id="4237259">.</span><span class="ident" id="4237260">marshal</span><span class="op" id="4237267">(</span><span class="op" id="4237268">)</span><span class="op" id="4237269">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237272">c</span><span class="op" id="4237273">.</span><span class="ident" id="4237274">writeRecord</span><span class="op" id="4237285">(</span><span class="ident" id="4237286">recordTypeHandshake</span><span class="op" id="4237305">,</span>&nbsp;<span class="ident" id="4237307">finished</span><span class="op" id="4237315">.</span><span class="ident" id="4237316">marshal</span><span class="op" id="4237323">(</span><span class="op" id="4237324">)</span><span class="op" id="4237325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4237328">copy</span><span class="op" id="4237332">(</span><span class="ident" id="4237333">out</span><span class="op" id="4237336">,</span>&nbsp;<span class="ident" id="4237338">finished</span><span class="op" id="4237346">.</span><span class="ident" id="4237347">verifyData</span><span class="op" id="4237357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4237360">return</span>&nbsp;<span class="builtintype" id="4237367">nil</span><br>
<span class="lineno"></span><span class="op" id="4237371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="comment" id="4237374">//&nbsp;clientSessionCacheKey&nbsp;returns&nbsp;a&nbsp;key&nbsp;used&nbsp;to&nbsp;cache&nbsp;sessionTickets&nbsp;that&nbsp;could</span><br>
<span class="lineno"></span><span class="comment" id="4237453">//&nbsp;be&nbsp;used&nbsp;to&nbsp;resume&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;sessions&nbsp;with&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="4237524">func</span>&nbsp;<span class="ident" id="4237529">clientSessionCacheKey</span><span class="op" id="4237550">(</span><span class="ident" id="4237551">serverAddr</span>&nbsp;<span class="ident" id="4237562">net</span><span class="op" id="4237565">.</span><span class="ident" id="4237566">Addr</span><span class="op" id="4237570">,</span>&nbsp;<span class="ident" id="4237572">config</span>&nbsp;<span class="op" id="4237579">*</span><span class="ident" id="4237580">Config</span><span class="op" id="4237586">)</span>&nbsp;<span class="builtintype" id="4237588">string</span>&nbsp;<span class="op" id="4237595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4237598">if</span>&nbsp;<span class="builtinfunc" id="4237601">len</span><span class="op" id="4237604">(</span><span class="ident" id="4237605">config</span><span class="op" id="4237611">.</span><span class="ident" id="4237612">ServerName</span><span class="op" id="4237622">)</span>&nbsp;<span class="op" id="4237624">&gt;</span>&nbsp;<span class="num" id="4237626">0</span>&nbsp;<span class="op" id="4237628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4237632">return</span>&nbsp;<span class="ident" id="4237639">config</span><span class="op" id="4237645">.</span><span class="ident" id="4237646">ServerName</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4237658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4237661">return</span>&nbsp;<span class="ident" id="4237668">serverAddr</span><span class="op" id="4237678">.</span><span class="ident" id="4237679">String</span><span class="op" id="4237685">(</span><span class="op" id="4237686">)</span><br>
<span class="lineno"></span><span class="op" id="4237688">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4237691">//&nbsp;mutualProtocol&nbsp;finds&nbsp;the&nbsp;mutual&nbsp;Next&nbsp;Protocol&nbsp;Negotiation&nbsp;or&nbsp;ALPN&nbsp;protocol</span><br>
<span class="lineno">625</span><span class="comment" id="4237769">//&nbsp;given&nbsp;list&nbsp;of&nbsp;possible&nbsp;protocols&nbsp;and&nbsp;a&nbsp;list&nbsp;of&nbsp;the&nbsp;preference&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="4237845">//&nbsp;first&nbsp;list&nbsp;must&nbsp;not&nbsp;be&nbsp;empty.&nbsp;It&nbsp;returns&nbsp;the&nbsp;resulting&nbsp;protocol&nbsp;and&nbsp;flag</span><br>
<span class="lineno"></span><span class="comment" id="4237921">//&nbsp;indicating&nbsp;if&nbsp;the&nbsp;fallback&nbsp;case&nbsp;was&nbsp;reached.</span><br>
<span class="lineno"></span><span class="keyword" id="4237969">func</span>&nbsp;<span class="ident" id="4237974">mutualProtocol</span><span class="op" id="4237988">(</span><span class="ident" id="4237989">protos</span><span class="op" id="4237995">,</span>&nbsp;<span class="ident" id="4237997">preferenceProtos</span>&nbsp;<span class="op" id="4238014">[</span><span class="op" id="4238015">]</span><span class="builtintype" id="4238016">string</span><span class="op" id="4238022">)</span>&nbsp;<span class="op" id="4238024">(</span><span class="builtintype" id="4238025">string</span><span class="op" id="4238031">,</span>&nbsp;<span class="builtintype" id="4238033">bool</span><span class="op" id="4238037">)</span>&nbsp;<span class="op" id="4238039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4238042">for</span>&nbsp;<span class="ident" id="4238046">_</span><span class="op" id="4238047">,</span>&nbsp;<span class="ident" id="4238049">s</span>&nbsp;<span class="op" id="4238051">:=</span>&nbsp;<span class="keyword" id="4238054">range</span>&nbsp;<span class="ident" id="4238060">preferenceProtos</span>&nbsp;<span class="op" id="4238077">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4238081">for</span>&nbsp;<span class="ident" id="4238085">_</span><span class="op" id="4238086">,</span>&nbsp;<span class="ident" id="4238088">c</span>&nbsp;<span class="op" id="4238090">:=</span>&nbsp;<span class="keyword" id="4238093">range</span>&nbsp;<span class="ident" id="4238099">protos</span>&nbsp;<span class="op" id="4238106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4238111">if</span>&nbsp;<span class="ident" id="4238114">s</span>&nbsp;<span class="op" id="4238116">==</span>&nbsp;<span class="ident" id="4238119">c</span>&nbsp;<span class="op" id="4238121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4238127">return</span>&nbsp;<span class="ident" id="4238134">s</span><span class="op" id="4238135">,</span>&nbsp;<span class="builtintype" id="4238137">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4238146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4238150">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4238153">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4238157">return</span>&nbsp;<span class="ident" id="4238164">protos</span><span class="op" id="4238170">[</span><span class="num" id="4238171">0</span><span class="op" id="4238172">]</span><span class="op" id="4238173">,</span>&nbsp;<span class="builtintype" id="4238175">true</span><br>
<span class="lineno"></span><span class="op" id="4238180">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
