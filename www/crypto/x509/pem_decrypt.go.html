<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">x509</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;RFC&nbsp;1423&nbsp;describes&nbsp;the&nbsp;encryption&nbsp;of&nbsp;PEM&nbsp;blocks.&nbsp;The&nbsp;algorithm&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;generate&nbsp;a&nbsp;key&nbsp;from&nbsp;the&nbsp;password&nbsp;was&nbsp;derived&nbsp;by&nbsp;looking&nbsp;at&nbsp;the&nbsp;OpenSSL</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;implementation.</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;crypto/aes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;crypto/des&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;crypto/md5&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;encoding/hex&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;encoding/pem&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">PEMCipher</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment">//&nbsp;Possible&nbsp;values&nbsp;for&nbsp;the&nbsp;EncryptPEMBlock&nbsp;encryption&nbsp;algorithm.</span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span>&nbsp;<span class="ident">PEMCipher</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">PEMCipherDES</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">PEMCipher3DES</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">PEMCipherAES128</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">PEMCipherAES192</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">PEMCipherAES256</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment">//&nbsp;rfc1423Algo&nbsp;holds&nbsp;a&nbsp;method&nbsp;for&nbsp;enciphering&nbsp;a&nbsp;PEM&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">rfc1423Algo</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cipher</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">PEMCipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cipherFunc</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">key</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">cipher</span><span class="op">.</span><span class="ident">Block</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">keySize</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">blockSize</span>&nbsp;&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;rfc1423Algos&nbsp;holds&nbsp;a&nbsp;slice&nbsp;of&nbsp;the&nbsp;possible&nbsp;ways&nbsp;to&nbsp;encrypt&nbsp;a&nbsp;PEM</span><br>
<span class="lineno">45</span><span class="comment">//&nbsp;block.&nbsp;&nbsp;The&nbsp;ivSize&nbsp;numbers&nbsp;were&nbsp;taken&nbsp;from&nbsp;the&nbsp;OpenSSL&nbsp;source.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">rfc1423Algos</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">rfc1423Algo</span><span class="op">{</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cipher</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">PEMCipherDES</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;DES-CBC&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cipherFunc</span><span class="op">:</span>&nbsp;<span class="ident">des</span><span class="op">.</span><span class="ident">NewCipher</span><span class="op">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">keySize</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num">8</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">blockSize</span><span class="op">:</span>&nbsp;&nbsp;<span class="ident">des</span><span class="op">.</span><span class="ident">BlockSize</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cipher</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">PEMCipher3DES</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;DES-EDE3-CBC&#34;</span><span class="op">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cipherFunc</span><span class="op">:</span>&nbsp;<span class="ident">des</span><span class="op">.</span><span class="ident">NewTripleDESCipher</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">keySize</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num">24</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">blockSize</span><span class="op">:</span>&nbsp;&nbsp;<span class="ident">des</span><span class="op">.</span><span class="ident">BlockSize</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cipher</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">PEMCipherAES128</span><span class="op">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;AES-128-CBC&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cipherFunc</span><span class="op">:</span>&nbsp;<span class="ident">aes</span><span class="op">.</span><span class="ident">NewCipher</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">keySize</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num">16</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">blockSize</span><span class="op">:</span>&nbsp;&nbsp;<span class="ident">aes</span><span class="op">.</span><span class="ident">BlockSize</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cipher</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">PEMCipherAES192</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;AES-192-CBC&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cipherFunc</span><span class="op">:</span>&nbsp;<span class="ident">aes</span><span class="op">.</span><span class="ident">NewCipher</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">keySize</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num">24</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">blockSize</span><span class="op">:</span>&nbsp;&nbsp;<span class="ident">aes</span><span class="op">.</span><span class="ident">BlockSize</span><span class="op">,</span><br>
<span class="lineno">70</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cipher</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">PEMCipherAES256</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;AES-256-CBC&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cipherFunc</span><span class="op">:</span>&nbsp;<span class="ident">aes</span><span class="op">.</span><span class="ident">NewCipher</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">keySize</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num">32</span><span class="op">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">blockSize</span><span class="op">:</span>&nbsp;&nbsp;<span class="ident">aes</span><span class="op">.</span><span class="ident">BlockSize</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;deriveKey&nbsp;uses&nbsp;a&nbsp;key&nbsp;derivation&nbsp;function&nbsp;to&nbsp;stretch&nbsp;the&nbsp;password&nbsp;into&nbsp;a&nbsp;key</span><br>
<span class="lineno">80</span><span class="comment">//&nbsp;with&nbsp;the&nbsp;number&nbsp;of&nbsp;bits&nbsp;our&nbsp;cipher&nbsp;requires.&nbsp;This&nbsp;algorithm&nbsp;was&nbsp;derived&nbsp;from</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;OpenSSL&nbsp;source.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="ident">rfc1423Algo</span><span class="op">)</span>&nbsp;<span class="ident">deriveKey</span><span class="op">(</span><span class="ident">password</span><span class="op">,</span>&nbsp;<span class="ident">salt</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">hash</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">md5</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">keySize</span><span class="op">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">digest</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">out</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">digest</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">hash</span><span class="op">.</span><span class="ident">Reset</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">hash</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">digest</span><span class="op">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">hash</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">password</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">hash</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">salt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">digest</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">hash</span><span class="op">.</span><span class="ident">Sum</span><span class="op">(</span><span class="ident">digest</span><span class="op">[</span><span class="op">:</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">out</span><span class="op">[</span><span class="ident">i</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">digest</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">out</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;IsEncryptedPEMBlock&nbsp;returns&nbsp;if&nbsp;the&nbsp;PEM&nbsp;block&nbsp;is&nbsp;password&nbsp;encrypted.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">IsEncryptedPEMBlock</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">pem</span><span class="op">.</span><span class="ident">Block</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Headers</span><span class="op">[</span><span class="string">&#34;DEK-Info&#34;</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">ok</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;IncorrectPasswordError&nbsp;is&nbsp;returned&nbsp;when&nbsp;an&nbsp;incorrect&nbsp;password&nbsp;is&nbsp;detected.</span><br>
<span class="lineno">105</span><span class="keyword">var</span>&nbsp;<span class="ident">IncorrectPasswordError</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;x509:&nbsp;decryption&nbsp;password&nbsp;incorrect&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;DecryptPEMBlock&nbsp;takes&nbsp;a&nbsp;password&nbsp;encrypted&nbsp;PEM&nbsp;block&nbsp;and&nbsp;the&nbsp;password&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encrypt&nbsp;it&nbsp;and&nbsp;returns&nbsp;a&nbsp;slice&nbsp;of&nbsp;decrypted&nbsp;DER&nbsp;encoded&nbsp;bytes.&nbsp;It&nbsp;inspects</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;DEK-Info&nbsp;header&nbsp;to&nbsp;determine&nbsp;the&nbsp;algorithm&nbsp;used&nbsp;for&nbsp;decryption.&nbsp;If&nbsp;no</span><br>
<span class="lineno">110</span><span class="comment">//&nbsp;DEK-Info&nbsp;header&nbsp;is&nbsp;present,&nbsp;an&nbsp;error&nbsp;is&nbsp;returned.&nbsp;If&nbsp;an&nbsp;incorrect&nbsp;password</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;is&nbsp;detected&nbsp;an&nbsp;IncorrectPasswordError&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">DecryptPEMBlock</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">pem</span><span class="op">.</span><span class="ident">Block</span><span class="op">,</span>&nbsp;<span class="ident">password</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dek</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Headers</span><span class="op">[</span><span class="string">&#34;DEK-Info&#34;</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;x509:&nbsp;no&nbsp;DEK-Info&nbsp;header&nbsp;in&nbsp;block&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">idx</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">strings</span><span class="op">.</span><span class="ident">Index</span><span class="op">(</span><span class="ident">dek</span><span class="op">,</span>&nbsp;<span class="string">&#34;,&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">idx</span>&nbsp;<span class="op">==</span>&nbsp;<span class="op">-</span><span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;x509:&nbsp;malformed&nbsp;DEK-Info&nbsp;header&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mode</span><span class="op">,</span>&nbsp;<span class="ident">hexIV</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dek</span><span class="op">[</span><span class="op">:</span><span class="ident">idx</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">dek</span><span class="op">[</span><span class="ident">idx</span><span class="op">+</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ciph</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">cipherByName</span><span class="op">(</span><span class="ident">mode</span><span class="op">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ciph</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;x509:&nbsp;unknown&nbsp;encryption&nbsp;mode&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">iv</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">hex</span><span class="op">.</span><span class="ident">DecodeString</span><span class="op">(</span><span class="ident">hexIV</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">iv</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">ciph</span><span class="op">.</span><span class="ident">blockSize</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;x509:&nbsp;incorrect&nbsp;IV&nbsp;size&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Based&nbsp;on&nbsp;the&nbsp;OpenSSL&nbsp;implementation.&nbsp;The&nbsp;salt&nbsp;is&nbsp;the&nbsp;first&nbsp;8&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;of&nbsp;the&nbsp;initialization&nbsp;vector.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">key</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ciph</span><span class="op">.</span><span class="ident">deriveKey</span><span class="op">(</span><span class="ident">password</span><span class="op">,</span>&nbsp;<span class="ident">iv</span><span class="op">[</span><span class="op">:</span><span class="num">8</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">block</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ciph</span><span class="op">.</span><span class="ident">cipherFunc</span><span class="op">(</span><span class="ident">key</span><span class="op">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">data</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">Bytes</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">cipher</span><span class="op">.</span><span class="ident">NewCBCDecrypter</span><span class="op">(</span><span class="ident">block</span><span class="op">,</span>&nbsp;<span class="ident">iv</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span><span class="op">.</span><span class="ident">CryptBlocks</span><span class="op">(</span><span class="ident">data</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Bytes</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Blocks&nbsp;are&nbsp;padded&nbsp;using&nbsp;a&nbsp;scheme&nbsp;where&nbsp;the&nbsp;last&nbsp;n&nbsp;bytes&nbsp;of&nbsp;padding&nbsp;are&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;equal&nbsp;to&nbsp;n.&nbsp;It&nbsp;can&nbsp;pad&nbsp;from&nbsp;1&nbsp;to&nbsp;blocksize&nbsp;bytes&nbsp;inclusive.&nbsp;See&nbsp;RFC&nbsp;1423.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;example:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp[x&nbsp;y&nbsp;z&nbsp;2&nbsp;2]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp[x&nbsp;y&nbsp;7&nbsp;7&nbsp;7&nbsp;7&nbsp;7&nbsp;7&nbsp;7]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;we&nbsp;detect&nbsp;a&nbsp;bad&nbsp;padding,&nbsp;we&nbsp;assume&nbsp;it&nbsp;is&nbsp;an&nbsp;invalid&nbsp;password.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dlen</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">data</span><span class="op">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">dlen</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">dlen</span><span class="op">%</span><span class="ident">ciph</span><span class="op">.</span><span class="ident">blockSize</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;x509:&nbsp;invalid&nbsp;padding&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">last</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">data</span><span class="op">[</span><span class="ident">dlen</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">dlen</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">last</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">IncorrectPasswordError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">last</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">last</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">ciph</span><span class="op">.</span><span class="ident">blockSize</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">IncorrectPasswordError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">val</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">data</span><span class="op">[</span><span class="ident">dlen</span><span class="op">-</span><span class="ident">last</span><span class="op">:</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">val</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">last</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">IncorrectPasswordError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">data</span><span class="op">[</span><span class="op">:</span><span class="ident">dlen</span><span class="op">-</span><span class="ident">last</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;EncryptPEMBlock&nbsp;returns&nbsp;a&nbsp;PEM&nbsp;block&nbsp;of&nbsp;the&nbsp;specified&nbsp;type&nbsp;holding&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;given&nbsp;DER-encoded&nbsp;data&nbsp;encrypted&nbsp;with&nbsp;the&nbsp;specified&nbsp;algorithm&nbsp;and</span><br>
<span class="lineno">175</span><span class="comment">//&nbsp;password.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">EncryptPEMBlock</span><span class="op">(</span><span class="ident">rand</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Reader</span><span class="op">,</span>&nbsp;<span class="ident">blockType</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">data</span><span class="op">,</span>&nbsp;<span class="ident">password</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">alg</span>&nbsp;<span class="ident">PEMCipher</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">pem</span><span class="op">.</span><span class="ident">Block</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ciph</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">cipherByKey</span><span class="op">(</span><span class="ident">alg</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ciph</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;x509:&nbsp;unknown&nbsp;encryption&nbsp;mode&#34;</span><span class="op">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">iv</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">ciph</span><span class="op">.</span><span class="ident">blockSize</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadFull</span><span class="op">(</span><span class="ident">rand</span><span class="op">,</span>&nbsp;<span class="ident">iv</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;x509:&nbsp;cannot&nbsp;generate&nbsp;IV:&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">err</span><span class="op">.</span><span class="ident">Error</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;salt&nbsp;is&nbsp;the&nbsp;first&nbsp;8&nbsp;bytes&nbsp;of&nbsp;the&nbsp;initialization&nbsp;vector,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;matching&nbsp;the&nbsp;key&nbsp;derivation&nbsp;in&nbsp;DecryptPEMBlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">key</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ciph</span><span class="op">.</span><span class="ident">deriveKey</span><span class="op">(</span><span class="ident">password</span><span class="op">,</span>&nbsp;<span class="ident">iv</span><span class="op">[</span><span class="op">:</span><span class="num">8</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">block</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ciph</span><span class="op">.</span><span class="ident">cipherFunc</span><span class="op">(</span><span class="ident">key</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">cipher</span><span class="op">.</span><span class="ident">NewCBCEncrypter</span><span class="op">(</span><span class="ident">block</span><span class="op">,</span>&nbsp;<span class="ident">iv</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pad</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ciph</span><span class="op">.</span><span class="ident">blockSize</span>&nbsp;<span class="op">-</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">data</span><span class="op">)</span><span class="op">%</span><span class="ident">ciph</span><span class="op">.</span><span class="ident">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">encrypted</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">data</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">data</span><span class="op">)</span><span class="op">+</span><span class="ident">pad</span><span class="op">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;could&nbsp;save&nbsp;this&nbsp;copy&nbsp;by&nbsp;encrypting&nbsp;all&nbsp;the&nbsp;whole&nbsp;blocks&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;data&nbsp;separately,&nbsp;but&nbsp;it&nbsp;doesn&#39;t&nbsp;seem&nbsp;worth&nbsp;the&nbsp;additional</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">encrypted</span><span class="op">,</span>&nbsp;<span class="ident">data</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;See&nbsp;RFC&nbsp;1423,&nbsp;section&nbsp;1.1</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">pad</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">encrypted</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">encrypted</span><span class="op">,</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">pad</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">.</span><span class="ident">CryptBlocks</span><span class="op">(</span><span class="ident">encrypted</span><span class="op">,</span>&nbsp;<span class="ident">encrypted</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">pem</span><span class="op">.</span><span class="ident">Block</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Type</span><span class="op">:</span>&nbsp;<span class="ident">blockType</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Headers</span><span class="op">:</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="builtintype">string</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;Proc-Type&#34;</span><span class="op">:</span>&nbsp;<span class="string">&#34;4,ENCRYPTED&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;DEK-Info&#34;</span><span class="op">:</span>&nbsp;&nbsp;<span class="ident">ciph</span><span class="op">.</span><span class="ident">name</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;,&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">hex</span><span class="op">.</span><span class="ident">EncodeToString</span><span class="op">(</span><span class="ident">iv</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Bytes</span><span class="op">:</span>&nbsp;<span class="ident">encrypted</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword">func</span>&nbsp;<span class="ident">cipherByName</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">rfc1423Algo</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">rfc1423Algos</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">alg</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">rfc1423Algos</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">alg</span><span class="op">.</span><span class="ident">name</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">name</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">alg</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword">func</span>&nbsp;<span class="ident">cipherByKey</span><span class="op">(</span><span class="ident">key</span>&nbsp;<span class="ident">PEMCipher</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">rfc1423Algo</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">rfc1423Algos</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">alg</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">rfc1423Algos</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">alg</span><span class="op">.</span><span class="ident">cipher</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">key</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">alg</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
