<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>text/template/parse</h2>
<ul>
<li><a href="/gostd/text/template/parse/lex.go.html">lex.go</a></li>
<li><a href="/gostd/text/template/parse/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/text/template/parse/node.go.html">node.go</a></li>
<li><a href="/gostd/text/template/parse/parse.go.html">parse.go</a></li>
<li><a href="/gostd/text/template/parse/parse_test.go.html">parse_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3285070">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3285125">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3285179">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3285230">//&nbsp;Package&nbsp;parse&nbsp;builds&nbsp;parse&nbsp;trees&nbsp;for&nbsp;templates&nbsp;as&nbsp;defined&nbsp;by&nbsp;text/template</span><br>
<span class="lineno"></span><span class="comment" id="3285308">//&nbsp;and&nbsp;html/template.&nbsp;Clients&nbsp;should&nbsp;use&nbsp;those&nbsp;packages&nbsp;to&nbsp;construct&nbsp;templates</span><br>
<span class="lineno"></span><span class="comment" id="3285387">//&nbsp;rather&nbsp;than&nbsp;this&nbsp;one,&nbsp;which&nbsp;provides&nbsp;shared&nbsp;internal&nbsp;data&nbsp;structures&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="3285463">//&nbsp;intended&nbsp;for&nbsp;general&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3285492">package</span>&nbsp;<span class="ident" id="3285500">parse</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="3285507">import</span>&nbsp;<span class="op" id="3285514">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3285517">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3285526">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3285533">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3285544">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3285555">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="3285565">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3285568">//&nbsp;Tree&nbsp;is&nbsp;the&nbsp;representation&nbsp;of&nbsp;a&nbsp;single&nbsp;parsed&nbsp;template.</span><br>
<span class="lineno">20</span><span class="keyword" id="3285627">type</span>&nbsp;<span class="ident" id="3285632">Tree</span>&nbsp;<span class="keyword" id="3285637">struct</span>&nbsp;<span class="op" id="3285644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285647">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3285657">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3285667">//&nbsp;name&nbsp;of&nbsp;the&nbsp;template&nbsp;represented&nbsp;by&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285717">ParseName</span>&nbsp;<span class="builtintype" id="3285727">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3285737">//&nbsp;name&nbsp;of&nbsp;the&nbsp;top-level&nbsp;template&nbsp;during&nbsp;parsing,&nbsp;for&nbsp;error&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285808">Root</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3285818">*</span><span class="ident" id="3285819">ListNode</span>&nbsp;<span class="comment" id="3285828">//&nbsp;top-level&nbsp;root&nbsp;of&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285860">text</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3285870">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3285880">//&nbsp;text&nbsp;parsed&nbsp;to&nbsp;create&nbsp;the&nbsp;template&nbsp;(or&nbsp;its&nbsp;parent)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3285935">//&nbsp;Parsing&nbsp;only;&nbsp;cleared&nbsp;after&nbsp;parse.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285974">funcs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3285984">[</span><span class="op" id="3285985">]</span><span class="keyword" id="3285986">map</span><span class="op" id="3285989">[</span><span class="builtintype" id="3285990">string</span><span class="op" id="3285996">]</span><span class="keyword" id="3285997">interface</span><span class="op" id="3286006">{</span><span class="op" id="3286007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286010">lex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3286020">*</span><span class="ident" id="3286021">lexer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286028">token</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3286038">[</span><span class="num" id="3286039">3</span><span class="op" id="3286040">]</span><span class="ident" id="3286041">item</span>&nbsp;<span class="comment" id="3286046">//&nbsp;three-token&nbsp;lookahead&nbsp;for&nbsp;parser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286084">peekCount</span>&nbsp;<span class="builtintype" id="3286094">int</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286099">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3286109">[</span><span class="op" id="3286110">]</span><span class="builtintype" id="3286111">string</span>&nbsp;<span class="comment" id="3286118">//&nbsp;variables&nbsp;defined&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span><span class="op" id="3286154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3286157">//&nbsp;Copy&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;Tree.&nbsp;Any&nbsp;parsing&nbsp;state&nbsp;is&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="3286225">func</span>&nbsp;<span class="op" id="3286230">(</span><span class="ident" id="3286231">t</span>&nbsp;<span class="op" id="3286233">*</span><span class="ident" id="3286234">Tree</span><span class="op" id="3286238">)</span>&nbsp;<span class="ident" id="3286240">Copy</span><span class="op" id="3286244">(</span><span class="op" id="3286245">)</span>&nbsp;<span class="op" id="3286247">*</span><span class="ident" id="3286248">Tree</span>&nbsp;<span class="op" id="3286253">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286256">if</span>&nbsp;<span class="ident" id="3286259">t</span>&nbsp;<span class="op" id="3286261">==</span>&nbsp;<span class="ident" id="3286264">nil</span>&nbsp;<span class="op" id="3286268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286272">return</span>&nbsp;<span class="ident" id="3286279">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3286284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286287">return</span>&nbsp;<span class="op" id="3286294">&amp;</span><span class="ident" id="3286295">Tree</span><span class="op" id="3286299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286303">Name</span><span class="op" id="3286307">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3286314">t</span><span class="op" id="3286315">.</span><span class="ident" id="3286316">Name</span><span class="op" id="3286320">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286324">ParseName</span><span class="op" id="3286333">:</span>&nbsp;<span class="ident" id="3286335">t</span><span class="op" id="3286336">.</span><span class="ident" id="3286337">ParseName</span><span class="op" id="3286346">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286350">Root</span><span class="op" id="3286354">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3286361">t</span><span class="op" id="3286362">.</span><span class="ident" id="3286363">Root</span><span class="op" id="3286367">.</span><span class="ident" id="3286368">CopyList</span><span class="op" id="3286376">(</span><span class="op" id="3286377">)</span><span class="op" id="3286378">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286382">text</span><span class="op" id="3286386">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3286393">t</span><span class="op" id="3286394">.</span><span class="ident" id="3286395">text</span><span class="op" id="3286399">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3286402">}</span><br>
<span class="lineno"></span><span class="op" id="3286404">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="3286407">//&nbsp;Parse&nbsp;returns&nbsp;a&nbsp;map&nbsp;from&nbsp;template&nbsp;name&nbsp;to&nbsp;parse.Tree,&nbsp;created&nbsp;by&nbsp;parsing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3286487">//&nbsp;templates&nbsp;described&nbsp;in&nbsp;the&nbsp;argument&nbsp;string.&nbsp;The&nbsp;top-level&nbsp;template&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3286565">//&nbsp;given&nbsp;the&nbsp;specified&nbsp;name.&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;encountered,&nbsp;parsing&nbsp;stops&nbsp;and&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="3286643">//&nbsp;empty&nbsp;map&nbsp;is&nbsp;returned&nbsp;with&nbsp;the&nbsp;error.</span><br>
<span class="lineno">50</span><span class="keyword" id="3286684">func</span>&nbsp;<span class="ident" id="3286689">Parse</span><span class="op" id="3286694">(</span><span class="ident" id="3286695">name</span><span class="op" id="3286699">,</span>&nbsp;<span class="ident" id="3286701">text</span><span class="op" id="3286705">,</span>&nbsp;<span class="ident" id="3286707">leftDelim</span><span class="op" id="3286716">,</span>&nbsp;<span class="ident" id="3286718">rightDelim</span>&nbsp;<span class="builtintype" id="3286729">string</span><span class="op" id="3286735">,</span>&nbsp;<span class="ident" id="3286737">funcs</span>&nbsp;<span class="op" id="3286743">...</span><span class="keyword" id="3286746">map</span><span class="op" id="3286749">[</span><span class="builtintype" id="3286750">string</span><span class="op" id="3286756">]</span><span class="keyword" id="3286757">interface</span><span class="op" id="3286766">{</span><span class="op" id="3286767">}</span><span class="op" id="3286768">)</span>&nbsp;<span class="op" id="3286770">(</span><span class="ident" id="3286771">treeSet</span>&nbsp;<span class="keyword" id="3286779">map</span><span class="op" id="3286782">[</span><span class="builtintype" id="3286783">string</span><span class="op" id="3286789">]</span><span class="op" id="3286790">*</span><span class="ident" id="3286791">Tree</span><span class="op" id="3286795">,</span>&nbsp;<span class="ident" id="3286797">err</span>&nbsp;<span class="builtintype" id="3286801">error</span><span class="op" id="3286806">)</span>&nbsp;<span class="op" id="3286808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286811">treeSet</span>&nbsp;<span class="op" id="3286819">=</span>&nbsp;<span class="builtinfunc" id="3286821">make</span><span class="op" id="3286825">(</span><span class="keyword" id="3286826">map</span><span class="op" id="3286829">[</span><span class="builtintype" id="3286830">string</span><span class="op" id="3286836">]</span><span class="op" id="3286837">*</span><span class="ident" id="3286838">Tree</span><span class="op" id="3286842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286845">t</span>&nbsp;<span class="op" id="3286847">:=</span>&nbsp;<span class="ident" id="3286850">New</span><span class="op" id="3286853">(</span><span class="ident" id="3286854">name</span><span class="op" id="3286858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286861">t</span><span class="op" id="3286862">.</span><span class="ident" id="3286863">text</span>&nbsp;<span class="op" id="3286868">=</span>&nbsp;<span class="ident" id="3286870">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286876">_</span><span class="op" id="3286877">,</span>&nbsp;<span class="ident" id="3286879">err</span>&nbsp;<span class="op" id="3286883">=</span>&nbsp;<span class="ident" id="3286885">t</span><span class="op" id="3286886">.</span><span class="ident" id="3286887">Parse</span><span class="op" id="3286892">(</span><span class="ident" id="3286893">text</span><span class="op" id="3286897">,</span>&nbsp;<span class="ident" id="3286899">leftDelim</span><span class="op" id="3286908">,</span>&nbsp;<span class="ident" id="3286910">rightDelim</span><span class="op" id="3286920">,</span>&nbsp;<span class="ident" id="3286922">treeSet</span><span class="op" id="3286929">,</span>&nbsp;<span class="ident" id="3286931">funcs</span><span class="op" id="3286936">...</span><span class="op" id="3286939">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286942">return</span><br>
<span class="lineno"></span><span class="op" id="3286949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3286952">//&nbsp;next&nbsp;returns&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3286984">func</span>&nbsp;<span class="op" id="3286989">(</span><span class="ident" id="3286990">t</span>&nbsp;<span class="op" id="3286992">*</span><span class="ident" id="3286993">Tree</span><span class="op" id="3286997">)</span>&nbsp;<span class="ident" id="3286999">next</span><span class="op" id="3287003">(</span><span class="op" id="3287004">)</span>&nbsp;<span class="ident" id="3287006">item</span>&nbsp;<span class="op" id="3287011">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287014">if</span>&nbsp;<span class="ident" id="3287017">t</span><span class="op" id="3287018">.</span><span class="ident" id="3287019">peekCount</span>&nbsp;<span class="op" id="3287029">&gt;</span>&nbsp;<span class="num" id="3287031">0</span>&nbsp;<span class="op" id="3287033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287037">t</span><span class="op" id="3287038">.</span><span class="ident" id="3287039">peekCount</span><span class="op" id="3287048">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3287052">}</span>&nbsp;<span class="keyword" id="3287054">else</span>&nbsp;<span class="op" id="3287059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287063">t</span><span class="op" id="3287064">.</span><span class="ident" id="3287065">token</span><span class="op" id="3287070">[</span><span class="num" id="3287071">0</span><span class="op" id="3287072">]</span>&nbsp;<span class="op" id="3287074">=</span>&nbsp;<span class="ident" id="3287076">t</span><span class="op" id="3287077">.</span><span class="ident" id="3287078">lex</span><span class="op" id="3287081">.</span><span class="ident" id="3287082">nextItem</span><span class="op" id="3287090">(</span><span class="op" id="3287091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3287094">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287097">return</span>&nbsp;<span class="ident" id="3287104">t</span><span class="op" id="3287105">.</span><span class="ident" id="3287106">token</span><span class="op" id="3287111">[</span><span class="ident" id="3287112">t</span><span class="op" id="3287113">.</span><span class="ident" id="3287114">peekCount</span><span class="op" id="3287123">]</span><br>
<span class="lineno"></span><span class="op" id="3287125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3287128">//&nbsp;backup&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;one&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3287175">func</span>&nbsp;<span class="op" id="3287180">(</span><span class="ident" id="3287181">t</span>&nbsp;<span class="op" id="3287183">*</span><span class="ident" id="3287184">Tree</span><span class="op" id="3287188">)</span>&nbsp;<span class="ident" id="3287190">backup</span><span class="op" id="3287196">(</span><span class="op" id="3287197">)</span>&nbsp;<span class="op" id="3287199">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287202">t</span><span class="op" id="3287203">.</span><span class="ident" id="3287204">peekCount</span><span class="op" id="3287213">++</span><br>
<span class="lineno"></span><span class="op" id="3287216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3287219">//&nbsp;backup2&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;two&nbsp;tokens.</span><br>
<span class="lineno"></span><span class="comment" id="3287268">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno">75</span><span class="keyword" id="3287306">func</span>&nbsp;<span class="op" id="3287311">(</span><span class="ident" id="3287312">t</span>&nbsp;<span class="op" id="3287314">*</span><span class="ident" id="3287315">Tree</span><span class="op" id="3287319">)</span>&nbsp;<span class="ident" id="3287321">backup2</span><span class="op" id="3287328">(</span><span class="ident" id="3287329">t1</span>&nbsp;<span class="ident" id="3287332">item</span><span class="op" id="3287336">)</span>&nbsp;<span class="op" id="3287338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287341">t</span><span class="op" id="3287342">.</span><span class="ident" id="3287343">token</span><span class="op" id="3287348">[</span><span class="num" id="3287349">1</span><span class="op" id="3287350">]</span>&nbsp;<span class="op" id="3287352">=</span>&nbsp;<span class="ident" id="3287354">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287358">t</span><span class="op" id="3287359">.</span><span class="ident" id="3287360">peekCount</span>&nbsp;<span class="op" id="3287370">=</span>&nbsp;<span class="num" id="3287372">2</span><br>
<span class="lineno"></span><span class="op" id="3287374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="3287377">//&nbsp;backup3&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;three&nbsp;tokens</span><br>
<span class="lineno"></span><span class="comment" id="3287427">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno"></span><span class="keyword" id="3287465">func</span>&nbsp;<span class="op" id="3287470">(</span><span class="ident" id="3287471">t</span>&nbsp;<span class="op" id="3287473">*</span><span class="ident" id="3287474">Tree</span><span class="op" id="3287478">)</span>&nbsp;<span class="ident" id="3287480">backup3</span><span class="op" id="3287487">(</span><span class="ident" id="3287488">t2</span><span class="op" id="3287490">,</span>&nbsp;<span class="ident" id="3287492">t1</span>&nbsp;<span class="ident" id="3287495">item</span><span class="op" id="3287499">)</span>&nbsp;<span class="op" id="3287501">{</span>&nbsp;<span class="comment" id="3287503">//&nbsp;Reverse&nbsp;order:&nbsp;we&#39;re&nbsp;pushing&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287542">t</span><span class="op" id="3287543">.</span><span class="ident" id="3287544">token</span><span class="op" id="3287549">[</span><span class="num" id="3287550">1</span><span class="op" id="3287551">]</span>&nbsp;<span class="op" id="3287553">=</span>&nbsp;<span class="ident" id="3287555">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287559">t</span><span class="op" id="3287560">.</span><span class="ident" id="3287561">token</span><span class="op" id="3287566">[</span><span class="num" id="3287567">2</span><span class="op" id="3287568">]</span>&nbsp;<span class="op" id="3287570">=</span>&nbsp;<span class="ident" id="3287572">t2</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287576">t</span><span class="op" id="3287577">.</span><span class="ident" id="3287578">peekCount</span>&nbsp;<span class="op" id="3287588">=</span>&nbsp;<span class="num" id="3287590">3</span><br>
<span class="lineno"></span><span class="op" id="3287592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3287595">//&nbsp;peek&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3287648">func</span>&nbsp;<span class="op" id="3287653">(</span><span class="ident" id="3287654">t</span>&nbsp;<span class="op" id="3287656">*</span><span class="ident" id="3287657">Tree</span><span class="op" id="3287661">)</span>&nbsp;<span class="ident" id="3287663">peek</span><span class="op" id="3287667">(</span><span class="op" id="3287668">)</span>&nbsp;<span class="ident" id="3287670">item</span>&nbsp;<span class="op" id="3287675">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287678">if</span>&nbsp;<span class="ident" id="3287681">t</span><span class="op" id="3287682">.</span><span class="ident" id="3287683">peekCount</span>&nbsp;<span class="op" id="3287693">&gt;</span>&nbsp;<span class="num" id="3287695">0</span>&nbsp;<span class="op" id="3287697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287701">return</span>&nbsp;<span class="ident" id="3287708">t</span><span class="op" id="3287709">.</span><span class="ident" id="3287710">token</span><span class="op" id="3287715">[</span><span class="ident" id="3287716">t</span><span class="op" id="3287717">.</span><span class="ident" id="3287718">peekCount</span><span class="op" id="3287727">-</span><span class="num" id="3287728">1</span><span class="op" id="3287729">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3287732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287735">t</span><span class="op" id="3287736">.</span><span class="ident" id="3287737">peekCount</span>&nbsp;<span class="op" id="3287747">=</span>&nbsp;<span class="num" id="3287749">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287752">t</span><span class="op" id="3287753">.</span><span class="ident" id="3287754">token</span><span class="op" id="3287759">[</span><span class="num" id="3287760">0</span><span class="op" id="3287761">]</span>&nbsp;<span class="op" id="3287763">=</span>&nbsp;<span class="ident" id="3287765">t</span><span class="op" id="3287766">.</span><span class="ident" id="3287767">lex</span><span class="op" id="3287770">.</span><span class="ident" id="3287771">nextItem</span><span class="op" id="3287779">(</span><span class="op" id="3287780">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287783">return</span>&nbsp;<span class="ident" id="3287790">t</span><span class="op" id="3287791">.</span><span class="ident" id="3287792">token</span><span class="op" id="3287797">[</span><span class="num" id="3287798">0</span><span class="op" id="3287799">]</span><br>
<span class="lineno"></span><span class="op" id="3287801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3287804">//&nbsp;nextNonSpace&nbsp;returns&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3287854">func</span>&nbsp;<span class="op" id="3287859">(</span><span class="ident" id="3287860">t</span>&nbsp;<span class="op" id="3287862">*</span><span class="ident" id="3287863">Tree</span><span class="op" id="3287867">)</span>&nbsp;<span class="ident" id="3287869">nextNonSpace</span><span class="op" id="3287881">(</span><span class="op" id="3287882">)</span>&nbsp;<span class="op" id="3287884">(</span><span class="ident" id="3287885">token</span>&nbsp;<span class="ident" id="3287891">item</span><span class="op" id="3287895">)</span>&nbsp;<span class="op" id="3287897">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287900">for</span>&nbsp;<span class="op" id="3287904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287908">token</span>&nbsp;<span class="op" id="3287914">=</span>&nbsp;<span class="ident" id="3287916">t</span><span class="op" id="3287917">.</span><span class="ident" id="3287918">next</span><span class="op" id="3287922">(</span><span class="op" id="3287923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287927">if</span>&nbsp;<span class="ident" id="3287930">token</span><span class="op" id="3287935">.</span><span class="ident" id="3287936">typ</span>&nbsp;<span class="op" id="3287940">!=</span>&nbsp;<span class="ident" id="3287943">itemSpace</span>&nbsp;<span class="op" id="3287953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287958">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3287966">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3287969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287972">return</span>&nbsp;<span class="ident" id="3287979">token</span><br>
<span class="lineno"></span><span class="op" id="3287985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3287988">//&nbsp;peekNonSpace&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno">110</span><span class="keyword" id="3288059">func</span>&nbsp;<span class="op" id="3288064">(</span><span class="ident" id="3288065">t</span>&nbsp;<span class="op" id="3288067">*</span><span class="ident" id="3288068">Tree</span><span class="op" id="3288072">)</span>&nbsp;<span class="ident" id="3288074">peekNonSpace</span><span class="op" id="3288086">(</span><span class="op" id="3288087">)</span>&nbsp;<span class="op" id="3288089">(</span><span class="ident" id="3288090">token</span>&nbsp;<span class="ident" id="3288096">item</span><span class="op" id="3288100">)</span>&nbsp;<span class="op" id="3288102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288105">for</span>&nbsp;<span class="op" id="3288109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288113">token</span>&nbsp;<span class="op" id="3288119">=</span>&nbsp;<span class="ident" id="3288121">t</span><span class="op" id="3288122">.</span><span class="ident" id="3288123">next</span><span class="op" id="3288127">(</span><span class="op" id="3288128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288132">if</span>&nbsp;<span class="ident" id="3288135">token</span><span class="op" id="3288140">.</span><span class="ident" id="3288141">typ</span>&nbsp;<span class="op" id="3288145">!=</span>&nbsp;<span class="ident" id="3288148">itemSpace</span>&nbsp;<span class="op" id="3288158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288163">break</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288177">t</span><span class="op" id="3288178">.</span><span class="ident" id="3288179">backup</span><span class="op" id="3288185">(</span><span class="op" id="3288186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288189">return</span>&nbsp;<span class="ident" id="3288196">token</span><br>
<span class="lineno"></span><span class="op" id="3288202">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="3288205">//&nbsp;Parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3288218">//&nbsp;New&nbsp;allocates&nbsp;a&nbsp;new&nbsp;parse&nbsp;tree&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="3288273">func</span>&nbsp;<span class="ident" id="3288278">New</span><span class="op" id="3288281">(</span><span class="ident" id="3288282">name</span>&nbsp;<span class="builtintype" id="3288287">string</span><span class="op" id="3288293">,</span>&nbsp;<span class="ident" id="3288295">funcs</span>&nbsp;<span class="op" id="3288301">...</span><span class="keyword" id="3288304">map</span><span class="op" id="3288307">[</span><span class="builtintype" id="3288308">string</span><span class="op" id="3288314">]</span><span class="keyword" id="3288315">interface</span><span class="op" id="3288324">{</span><span class="op" id="3288325">}</span><span class="op" id="3288326">)</span>&nbsp;<span class="op" id="3288328">*</span><span class="ident" id="3288329">Tree</span>&nbsp;<span class="op" id="3288334">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288337">return</span>&nbsp;<span class="op" id="3288344">&amp;</span><span class="ident" id="3288345">Tree</span><span class="op" id="3288349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288353">Name</span><span class="op" id="3288357">:</span>&nbsp;&nbsp;<span class="ident" id="3288360">name</span><span class="op" id="3288364">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288368">funcs</span><span class="op" id="3288373">:</span>&nbsp;<span class="ident" id="3288375">funcs</span><span class="op" id="3288380">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288383">}</span><br>
<span class="lineno"></span><span class="op" id="3288385">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="3288388">//&nbsp;ErrorContext&nbsp;returns&nbsp;a&nbsp;textual&nbsp;representation&nbsp;of&nbsp;the&nbsp;location&nbsp;of&nbsp;the&nbsp;node&nbsp;in&nbsp;the&nbsp;input&nbsp;text.</span><br>
<span class="lineno"></span><span class="comment" id="3288484">//&nbsp;The&nbsp;receiver&nbsp;is&nbsp;only&nbsp;used&nbsp;when&nbsp;the&nbsp;node&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;tree&nbsp;inside,</span><br>
<span class="lineno"></span><span class="comment" id="3288571">//&nbsp;which&nbsp;can&nbsp;occur&nbsp;in&nbsp;old&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="3288603">func</span>&nbsp;<span class="op" id="3288608">(</span><span class="ident" id="3288609">t</span>&nbsp;<span class="op" id="3288611">*</span><span class="ident" id="3288612">Tree</span><span class="op" id="3288616">)</span>&nbsp;<span class="ident" id="3288618">ErrorContext</span><span class="op" id="3288630">(</span><span class="ident" id="3288631">n</span>&nbsp;<span class="ident" id="3288633">Node</span><span class="op" id="3288637">)</span>&nbsp;<span class="op" id="3288639">(</span><span class="ident" id="3288640">location</span><span class="op" id="3288648">,</span>&nbsp;<span class="ident" id="3288650">context</span>&nbsp;<span class="builtintype" id="3288658">string</span><span class="op" id="3288664">)</span>&nbsp;<span class="op" id="3288666">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288669">pos</span>&nbsp;<span class="op" id="3288673">:=</span>&nbsp;<span class="builtintype" id="3288676">int</span><span class="op" id="3288679">(</span><span class="ident" id="3288680">n</span><span class="op" id="3288681">.</span><span class="ident" id="3288682">Position</span><span class="op" id="3288690">(</span><span class="op" id="3288691">)</span><span class="op" id="3288692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288695">tree</span>&nbsp;<span class="op" id="3288700">:=</span>&nbsp;<span class="ident" id="3288703">n</span><span class="op" id="3288704">.</span><span class="ident" id="3288705">tree</span><span class="op" id="3288709">(</span><span class="op" id="3288710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288713">if</span>&nbsp;<span class="ident" id="3288716">tree</span>&nbsp;<span class="op" id="3288721">==</span>&nbsp;<span class="ident" id="3288724">nil</span>&nbsp;<span class="op" id="3288728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288732">tree</span>&nbsp;<span class="op" id="3288737">=</span>&nbsp;<span class="ident" id="3288739">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288742">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288745">text</span>&nbsp;<span class="op" id="3288750">:=</span>&nbsp;<span class="ident" id="3288753">tree</span><span class="op" id="3288757">.</span><span class="ident" id="3288758">text</span><span class="op" id="3288762">[</span><span class="op" id="3288763">:</span><span class="ident" id="3288764">pos</span><span class="op" id="3288767">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288770">byteNum</span>&nbsp;<span class="op" id="3288778">:=</span>&nbsp;<span class="ident" id="3288781">strings</span><span class="op" id="3288788">.</span><span class="ident" id="3288789">LastIndex</span><span class="op" id="3288798">(</span><span class="ident" id="3288799">text</span><span class="op" id="3288803">,</span>&nbsp;<span class="string" id="3288805">&#34;\n&#34;</span><span class="op" id="3288809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288812">if</span>&nbsp;<span class="ident" id="3288815">byteNum</span>&nbsp;<span class="op" id="3288823">==</span>&nbsp;<span class="op" id="3288826">-</span><span class="num" id="3288827">1</span>&nbsp;<span class="op" id="3288829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288833">byteNum</span>&nbsp;<span class="op" id="3288841">=</span>&nbsp;<span class="ident" id="3288843">pos</span>&nbsp;<span class="comment" id="3288847">//&nbsp;On&nbsp;first&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288866">}</span>&nbsp;<span class="keyword" id="3288868">else</span>&nbsp;<span class="op" id="3288873">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288877">byteNum</span><span class="op" id="3288884">++</span>&nbsp;<span class="comment" id="3288887">//&nbsp;After&nbsp;the&nbsp;newline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288911">byteNum</span>&nbsp;<span class="op" id="3288919">=</span>&nbsp;<span class="ident" id="3288921">pos</span>&nbsp;<span class="op" id="3288925">-</span>&nbsp;<span class="ident" id="3288927">byteNum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288939">lineNum</span>&nbsp;<span class="op" id="3288947">:=</span>&nbsp;<span class="num" id="3288950">1</span>&nbsp;<span class="op" id="3288952">+</span>&nbsp;<span class="ident" id="3288954">strings</span><span class="op" id="3288961">.</span><span class="ident" id="3288962">Count</span><span class="op" id="3288967">(</span><span class="ident" id="3288968">text</span><span class="op" id="3288972">,</span>&nbsp;<span class="string" id="3288974">&#34;\n&#34;</span><span class="op" id="3288978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288981">context</span>&nbsp;<span class="op" id="3288989">=</span>&nbsp;<span class="ident" id="3288991">n</span><span class="op" id="3288992">.</span><span class="ident" id="3288993">String</span><span class="op" id="3288999">(</span><span class="op" id="3289000">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289003">if</span>&nbsp;<span class="builtinfunc" id="3289006">len</span><span class="op" id="3289009">(</span><span class="ident" id="3289010">context</span><span class="op" id="3289017">)</span>&nbsp;<span class="op" id="3289019">&gt;</span>&nbsp;<span class="num" id="3289021">20</span>&nbsp;<span class="op" id="3289024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289028">context</span>&nbsp;<span class="op" id="3289036">=</span>&nbsp;<span class="ident" id="3289038">fmt</span><span class="op" id="3289041">.</span><span class="ident" id="3289042">Sprintf</span><span class="op" id="3289049">(</span><span class="string" id="3289050">&#34;%.20s...&#34;</span><span class="op" id="3289060">,</span>&nbsp;<span class="ident" id="3289062">context</span><span class="op" id="3289069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289075">return</span>&nbsp;<span class="ident" id="3289082">fmt</span><span class="op" id="3289085">.</span><span class="ident" id="3289086">Sprintf</span><span class="op" id="3289093">(</span><span class="string" id="3289094">&#34;%s:%d:%d&#34;</span><span class="op" id="3289104">,</span>&nbsp;<span class="ident" id="3289106">tree</span><span class="op" id="3289110">.</span><span class="ident" id="3289111">ParseName</span><span class="op" id="3289120">,</span>&nbsp;<span class="ident" id="3289122">lineNum</span><span class="op" id="3289129">,</span>&nbsp;<span class="ident" id="3289131">byteNum</span><span class="op" id="3289138">)</span><span class="op" id="3289139">,</span>&nbsp;<span class="ident" id="3289141">context</span><br>
<span class="lineno"></span><span class="op" id="3289149">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="3289152">//&nbsp;errorf&nbsp;formats&nbsp;the&nbsp;error&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="3289207">func</span>&nbsp;<span class="op" id="3289212">(</span><span class="ident" id="3289213">t</span>&nbsp;<span class="op" id="3289215">*</span><span class="ident" id="3289216">Tree</span><span class="op" id="3289220">)</span>&nbsp;<span class="ident" id="3289222">errorf</span><span class="op" id="3289228">(</span><span class="ident" id="3289229">format</span>&nbsp;<span class="builtintype" id="3289236">string</span><span class="op" id="3289242">,</span>&nbsp;<span class="ident" id="3289244">args</span>&nbsp;<span class="op" id="3289249">...</span><span class="keyword" id="3289252">interface</span><span class="op" id="3289261">{</span><span class="op" id="3289262">}</span><span class="op" id="3289263">)</span>&nbsp;<span class="op" id="3289265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289268">t</span><span class="op" id="3289269">.</span><span class="ident" id="3289270">Root</span>&nbsp;<span class="op" id="3289275">=</span>&nbsp;<span class="ident" id="3289277">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289282">format</span>&nbsp;<span class="op" id="3289289">=</span>&nbsp;<span class="ident" id="3289291">fmt</span><span class="op" id="3289294">.</span><span class="ident" id="3289295">Sprintf</span><span class="op" id="3289302">(</span><span class="string" id="3289303">&#34;template:&nbsp;%s:%d:&nbsp;%s&#34;</span><span class="op" id="3289324">,</span>&nbsp;<span class="ident" id="3289326">t</span><span class="op" id="3289327">.</span><span class="ident" id="3289328">ParseName</span><span class="op" id="3289337">,</span>&nbsp;<span class="ident" id="3289339">t</span><span class="op" id="3289340">.</span><span class="ident" id="3289341">lex</span><span class="op" id="3289344">.</span><span class="ident" id="3289345">lineNumber</span><span class="op" id="3289355">(</span><span class="op" id="3289356">)</span><span class="op" id="3289357">,</span>&nbsp;<span class="ident" id="3289359">format</span><span class="op" id="3289365">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3289368">panic</span><span class="op" id="3289373">(</span><span class="ident" id="3289374">fmt</span><span class="op" id="3289377">.</span><span class="ident" id="3289378">Errorf</span><span class="op" id="3289384">(</span><span class="ident" id="3289385">format</span><span class="op" id="3289391">,</span>&nbsp;<span class="ident" id="3289393">args</span><span class="op" id="3289397">...</span><span class="op" id="3289400">)</span><span class="op" id="3289401">)</span><br>
<span class="lineno"></span><span class="op" id="3289403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3289406">//&nbsp;error&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="3289438">func</span>&nbsp;<span class="op" id="3289443">(</span><span class="ident" id="3289444">t</span>&nbsp;<span class="op" id="3289446">*</span><span class="ident" id="3289447">Tree</span><span class="op" id="3289451">)</span>&nbsp;<span class="builtintype" id="3289453">error</span><span class="op" id="3289458">(</span><span class="ident" id="3289459">err</span>&nbsp;<span class="builtintype" id="3289463">error</span><span class="op" id="3289468">)</span>&nbsp;<span class="op" id="3289470">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289473">t</span><span class="op" id="3289474">.</span><span class="ident" id="3289475">errorf</span><span class="op" id="3289481">(</span><span class="string" id="3289482">&#34;%s&#34;</span><span class="op" id="3289486">,</span>&nbsp;<span class="ident" id="3289488">err</span><span class="op" id="3289491">)</span><br>
<span class="lineno"></span><span class="op" id="3289493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3289496">//&nbsp;expect&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;the&nbsp;required&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3289571">func</span>&nbsp;<span class="op" id="3289576">(</span><span class="ident" id="3289577">t</span>&nbsp;<span class="op" id="3289579">*</span><span class="ident" id="3289580">Tree</span><span class="op" id="3289584">)</span>&nbsp;<span class="ident" id="3289586">expect</span><span class="op" id="3289592">(</span><span class="ident" id="3289593">expected</span>&nbsp;<span class="ident" id="3289602">itemType</span><span class="op" id="3289610">,</span>&nbsp;<span class="ident" id="3289612">context</span>&nbsp;<span class="builtintype" id="3289620">string</span><span class="op" id="3289626">)</span>&nbsp;<span class="ident" id="3289628">item</span>&nbsp;<span class="op" id="3289633">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289636">token</span>&nbsp;<span class="op" id="3289642">:=</span>&nbsp;<span class="ident" id="3289645">t</span><span class="op" id="3289646">.</span><span class="ident" id="3289647">nextNonSpace</span><span class="op" id="3289659">(</span><span class="op" id="3289660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289663">if</span>&nbsp;<span class="ident" id="3289666">token</span><span class="op" id="3289671">.</span><span class="ident" id="3289672">typ</span>&nbsp;<span class="op" id="3289676">!=</span>&nbsp;<span class="ident" id="3289679">expected</span>&nbsp;<span class="op" id="3289688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289692">t</span><span class="op" id="3289693">.</span><span class="ident" id="3289694">unexpected</span><span class="op" id="3289704">(</span><span class="ident" id="3289705">token</span><span class="op" id="3289710">,</span>&nbsp;<span class="ident" id="3289712">context</span><span class="op" id="3289719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289725">return</span>&nbsp;<span class="ident" id="3289732">token</span><br>
<span class="lineno">175</span><span class="op" id="3289738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3289741">//&nbsp;expectOneOf&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;one&nbsp;of&nbsp;the&nbsp;required&nbsp;types.</span><br>
<span class="lineno"></span><span class="keyword" id="3289829">func</span>&nbsp;<span class="op" id="3289834">(</span><span class="ident" id="3289835">t</span>&nbsp;<span class="op" id="3289837">*</span><span class="ident" id="3289838">Tree</span><span class="op" id="3289842">)</span>&nbsp;<span class="ident" id="3289844">expectOneOf</span><span class="op" id="3289855">(</span><span class="ident" id="3289856">expected1</span><span class="op" id="3289865">,</span>&nbsp;<span class="ident" id="3289867">expected2</span>&nbsp;<span class="ident" id="3289877">itemType</span><span class="op" id="3289885">,</span>&nbsp;<span class="ident" id="3289887">context</span>&nbsp;<span class="builtintype" id="3289895">string</span><span class="op" id="3289901">)</span>&nbsp;<span class="ident" id="3289903">item</span>&nbsp;<span class="op" id="3289908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289911">token</span>&nbsp;<span class="op" id="3289917">:=</span>&nbsp;<span class="ident" id="3289920">t</span><span class="op" id="3289921">.</span><span class="ident" id="3289922">nextNonSpace</span><span class="op" id="3289934">(</span><span class="op" id="3289935">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289938">if</span>&nbsp;<span class="ident" id="3289941">token</span><span class="op" id="3289946">.</span><span class="ident" id="3289947">typ</span>&nbsp;<span class="op" id="3289951">!=</span>&nbsp;<span class="ident" id="3289954">expected1</span>&nbsp;<span class="op" id="3289964">&amp;&amp;</span>&nbsp;<span class="ident" id="3289967">token</span><span class="op" id="3289972">.</span><span class="ident" id="3289973">typ</span>&nbsp;<span class="op" id="3289977">!=</span>&nbsp;<span class="ident" id="3289980">expected2</span>&nbsp;<span class="op" id="3289990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289994">t</span><span class="op" id="3289995">.</span><span class="ident" id="3289996">unexpected</span><span class="op" id="3290006">(</span><span class="ident" id="3290007">token</span><span class="op" id="3290012">,</span>&nbsp;<span class="ident" id="3290014">context</span><span class="op" id="3290021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290027">return</span>&nbsp;<span class="ident" id="3290034">token</span><br>
<span class="lineno"></span><span class="op" id="3290040">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="comment" id="3290043">//&nbsp;unexpected&nbsp;complains&nbsp;about&nbsp;the&nbsp;token&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="3290110">func</span>&nbsp;<span class="op" id="3290115">(</span><span class="ident" id="3290116">t</span>&nbsp;<span class="op" id="3290118">*</span><span class="ident" id="3290119">Tree</span><span class="op" id="3290123">)</span>&nbsp;<span class="ident" id="3290125">unexpected</span><span class="op" id="3290135">(</span><span class="ident" id="3290136">token</span>&nbsp;<span class="ident" id="3290142">item</span><span class="op" id="3290146">,</span>&nbsp;<span class="ident" id="3290148">context</span>&nbsp;<span class="builtintype" id="3290156">string</span><span class="op" id="3290162">)</span>&nbsp;<span class="op" id="3290164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290167">t</span><span class="op" id="3290168">.</span><span class="ident" id="3290169">errorf</span><span class="op" id="3290175">(</span><span class="string" id="3290176">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="3290197">,</span>&nbsp;<span class="ident" id="3290199">token</span><span class="op" id="3290204">,</span>&nbsp;<span class="ident" id="3290206">context</span><span class="op" id="3290213">)</span><br>
<span class="lineno"></span><span class="op" id="3290215">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3290218">//&nbsp;recover&nbsp;is&nbsp;the&nbsp;handler&nbsp;that&nbsp;turns&nbsp;panics&nbsp;into&nbsp;returns&nbsp;from&nbsp;the&nbsp;top&nbsp;level&nbsp;of&nbsp;Parse.</span><br>
<span class="lineno"></span><span class="keyword" id="3290304">func</span>&nbsp;<span class="op" id="3290309">(</span><span class="ident" id="3290310">t</span>&nbsp;<span class="op" id="3290312">*</span><span class="ident" id="3290313">Tree</span><span class="op" id="3290317">)</span>&nbsp;<span class="builtinfunc" id="3290319">recover</span><span class="op" id="3290326">(</span><span class="ident" id="3290327">errp</span>&nbsp;<span class="op" id="3290332">*</span><span class="builtintype" id="3290333">error</span><span class="op" id="3290338">)</span>&nbsp;<span class="op" id="3290340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290343">e</span>&nbsp;<span class="op" id="3290345">:=</span>&nbsp;<span class="builtinfunc" id="3290348">recover</span><span class="op" id="3290355">(</span><span class="op" id="3290356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290359">if</span>&nbsp;<span class="ident" id="3290362">e</span>&nbsp;<span class="op" id="3290364">!=</span>&nbsp;<span class="ident" id="3290367">nil</span>&nbsp;<span class="op" id="3290371">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290375">if</span>&nbsp;<span class="ident" id="3290378">_</span><span class="op" id="3290379">,</span>&nbsp;<span class="ident" id="3290381">ok</span>&nbsp;<span class="op" id="3290384">:=</span>&nbsp;<span class="ident" id="3290387">e</span><span class="op" id="3290388">.</span><span class="op" id="3290389">(</span><span class="ident" id="3290390">runtime</span><span class="op" id="3290397">.</span><span class="ident" id="3290398">Error</span><span class="op" id="3290403">)</span><span class="op" id="3290404">;</span>&nbsp;<span class="ident" id="3290406">ok</span>&nbsp;<span class="op" id="3290409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3290414">panic</span><span class="op" id="3290419">(</span><span class="ident" id="3290420">e</span><span class="op" id="3290421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290429">if</span>&nbsp;<span class="ident" id="3290432">t</span>&nbsp;<span class="op" id="3290434">!=</span>&nbsp;<span class="ident" id="3290437">nil</span>&nbsp;<span class="op" id="3290441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290446">t</span><span class="op" id="3290447">.</span><span class="ident" id="3290448">stopParse</span><span class="op" id="3290457">(</span><span class="op" id="3290458">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290466">*</span><span class="ident" id="3290467">errp</span>&nbsp;<span class="op" id="3290472">=</span>&nbsp;<span class="ident" id="3290474">e</span><span class="op" id="3290475">.</span><span class="op" id="3290476">(</span><span class="builtintype" id="3290477">error</span><span class="op" id="3290482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290488">return</span><br>
<span class="lineno"></span><span class="op" id="3290495">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="comment" id="3290498">//&nbsp;startParse&nbsp;initializes&nbsp;the&nbsp;parser,&nbsp;using&nbsp;the&nbsp;lexer.</span><br>
<span class="lineno"></span><span class="keyword" id="3290553">func</span>&nbsp;<span class="op" id="3290558">(</span><span class="ident" id="3290559">t</span>&nbsp;<span class="op" id="3290561">*</span><span class="ident" id="3290562">Tree</span><span class="op" id="3290566">)</span>&nbsp;<span class="ident" id="3290568">startParse</span><span class="op" id="3290578">(</span><span class="ident" id="3290579">funcs</span>&nbsp;<span class="op" id="3290585">[</span><span class="op" id="3290586">]</span><span class="keyword" id="3290587">map</span><span class="op" id="3290590">[</span><span class="builtintype" id="3290591">string</span><span class="op" id="3290597">]</span><span class="keyword" id="3290598">interface</span><span class="op" id="3290607">{</span><span class="op" id="3290608">}</span><span class="op" id="3290609">,</span>&nbsp;<span class="ident" id="3290611">lex</span>&nbsp;<span class="op" id="3290615">*</span><span class="ident" id="3290616">lexer</span><span class="op" id="3290621">)</span>&nbsp;<span class="op" id="3290623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290626">t</span><span class="op" id="3290627">.</span><span class="ident" id="3290628">Root</span>&nbsp;<span class="op" id="3290633">=</span>&nbsp;<span class="ident" id="3290635">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290640">t</span><span class="op" id="3290641">.</span><span class="ident" id="3290642">lex</span>&nbsp;<span class="op" id="3290646">=</span>&nbsp;<span class="ident" id="3290648">lex</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290653">t</span><span class="op" id="3290654">.</span><span class="ident" id="3290655">vars</span>&nbsp;<span class="op" id="3290660">=</span>&nbsp;<span class="op" id="3290662">[</span><span class="op" id="3290663">]</span><span class="builtintype" id="3290664">string</span><span class="op" id="3290670">{</span><span class="string" id="3290671">&#34;$&#34;</span><span class="op" id="3290674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290677">t</span><span class="op" id="3290678">.</span><span class="ident" id="3290679">funcs</span>&nbsp;<span class="op" id="3290685">=</span>&nbsp;<span class="ident" id="3290687">funcs</span><br>
<span class="lineno"></span><span class="op" id="3290693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3290696">//&nbsp;stopParse&nbsp;terminates&nbsp;parsing.</span><br>
<span class="lineno">215</span><span class="keyword" id="3290729">func</span>&nbsp;<span class="op" id="3290734">(</span><span class="ident" id="3290735">t</span>&nbsp;<span class="op" id="3290737">*</span><span class="ident" id="3290738">Tree</span><span class="op" id="3290742">)</span>&nbsp;<span class="ident" id="3290744">stopParse</span><span class="op" id="3290753">(</span><span class="op" id="3290754">)</span>&nbsp;<span class="op" id="3290756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290759">t</span><span class="op" id="3290760">.</span><span class="ident" id="3290761">lex</span>&nbsp;<span class="op" id="3290765">=</span>&nbsp;<span class="ident" id="3290767">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290772">t</span><span class="op" id="3290773">.</span><span class="ident" id="3290774">vars</span>&nbsp;<span class="op" id="3290779">=</span>&nbsp;<span class="ident" id="3290781">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290786">t</span><span class="op" id="3290787">.</span><span class="ident" id="3290788">funcs</span>&nbsp;<span class="op" id="3290794">=</span>&nbsp;<span class="ident" id="3290796">nil</span><br>
<span class="lineno"></span><span class="op" id="3290800">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="3290803">//&nbsp;Parse&nbsp;parses&nbsp;the&nbsp;template&nbsp;definition&nbsp;string&nbsp;to&nbsp;construct&nbsp;a&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3290883">//&nbsp;the&nbsp;template&nbsp;for&nbsp;execution.&nbsp;If&nbsp;either&nbsp;action&nbsp;delimiter&nbsp;string&nbsp;is&nbsp;empty,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3290962">//&nbsp;default&nbsp;(&#34;{{&#34;&nbsp;or&nbsp;&#34;}}&#34;)&nbsp;is&nbsp;used.&nbsp;Embedded&nbsp;template&nbsp;definitions&nbsp;are&nbsp;added&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3291040">//&nbsp;the&nbsp;treeSet&nbsp;map.</span><br>
<span class="lineno">225</span><span class="keyword" id="3291060">func</span>&nbsp;<span class="op" id="3291065">(</span><span class="ident" id="3291066">t</span>&nbsp;<span class="op" id="3291068">*</span><span class="ident" id="3291069">Tree</span><span class="op" id="3291073">)</span>&nbsp;<span class="ident" id="3291075">Parse</span><span class="op" id="3291080">(</span><span class="ident" id="3291081">text</span><span class="op" id="3291085">,</span>&nbsp;<span class="ident" id="3291087">leftDelim</span><span class="op" id="3291096">,</span>&nbsp;<span class="ident" id="3291098">rightDelim</span>&nbsp;<span class="builtintype" id="3291109">string</span><span class="op" id="3291115">,</span>&nbsp;<span class="ident" id="3291117">treeSet</span>&nbsp;<span class="keyword" id="3291125">map</span><span class="op" id="3291128">[</span><span class="builtintype" id="3291129">string</span><span class="op" id="3291135">]</span><span class="op" id="3291136">*</span><span class="ident" id="3291137">Tree</span><span class="op" id="3291141">,</span>&nbsp;<span class="ident" id="3291143">funcs</span>&nbsp;<span class="op" id="3291149">...</span><span class="keyword" id="3291152">map</span><span class="op" id="3291155">[</span><span class="builtintype" id="3291156">string</span><span class="op" id="3291162">]</span><span class="keyword" id="3291163">interface</span><span class="op" id="3291172">{</span><span class="op" id="3291173">}</span><span class="op" id="3291174">)</span>&nbsp;<span class="op" id="3291176">(</span><span class="ident" id="3291177">tree</span>&nbsp;<span class="op" id="3291182">*</span><span class="ident" id="3291183">Tree</span><span class="op" id="3291187">,</span>&nbsp;<span class="ident" id="3291189">err</span>&nbsp;<span class="builtintype" id="3291193">error</span><span class="op" id="3291198">)</span>&nbsp;<span class="op" id="3291200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291203">defer</span>&nbsp;<span class="ident" id="3291209">t</span><span class="op" id="3291210">.</span><span class="builtinfunc" id="3291211">recover</span><span class="op" id="3291218">(</span><span class="op" id="3291219">&amp;</span><span class="ident" id="3291220">err</span><span class="op" id="3291223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291226">t</span><span class="op" id="3291227">.</span><span class="ident" id="3291228">ParseName</span>&nbsp;<span class="op" id="3291238">=</span>&nbsp;<span class="ident" id="3291240">t</span><span class="op" id="3291241">.</span><span class="ident" id="3291242">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291248">t</span><span class="op" id="3291249">.</span><span class="ident" id="3291250">startParse</span><span class="op" id="3291260">(</span><span class="ident" id="3291261">funcs</span><span class="op" id="3291266">,</span>&nbsp;<span class="ident" id="3291268">lex</span><span class="op" id="3291271">(</span><span class="ident" id="3291272">t</span><span class="op" id="3291273">.</span><span class="ident" id="3291274">Name</span><span class="op" id="3291278">,</span>&nbsp;<span class="ident" id="3291280">text</span><span class="op" id="3291284">,</span>&nbsp;<span class="ident" id="3291286">leftDelim</span><span class="op" id="3291295">,</span>&nbsp;<span class="ident" id="3291297">rightDelim</span><span class="op" id="3291307">)</span><span class="op" id="3291308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291311">t</span><span class="op" id="3291312">.</span><span class="ident" id="3291313">text</span>&nbsp;<span class="op" id="3291318">=</span>&nbsp;<span class="ident" id="3291320">text</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291326">t</span><span class="op" id="3291327">.</span><span class="ident" id="3291328">parse</span><span class="op" id="3291333">(</span><span class="ident" id="3291334">treeSet</span><span class="op" id="3291341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291344">t</span><span class="op" id="3291345">.</span><span class="ident" id="3291346">add</span><span class="op" id="3291349">(</span><span class="ident" id="3291350">treeSet</span><span class="op" id="3291357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291360">t</span><span class="op" id="3291361">.</span><span class="ident" id="3291362">stopParse</span><span class="op" id="3291371">(</span><span class="op" id="3291372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291375">return</span>&nbsp;<span class="ident" id="3291382">t</span><span class="op" id="3291383">,</span>&nbsp;<span class="ident" id="3291385">nil</span><br>
<span class="lineno"></span><span class="op" id="3291389">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="3291392">//&nbsp;add&nbsp;adds&nbsp;tree&nbsp;to&nbsp;the&nbsp;treeSet.</span><br>
<span class="lineno"></span><span class="keyword" id="3291425">func</span>&nbsp;<span class="op" id="3291430">(</span><span class="ident" id="3291431">t</span>&nbsp;<span class="op" id="3291433">*</span><span class="ident" id="3291434">Tree</span><span class="op" id="3291438">)</span>&nbsp;<span class="ident" id="3291440">add</span><span class="op" id="3291443">(</span><span class="ident" id="3291444">treeSet</span>&nbsp;<span class="keyword" id="3291452">map</span><span class="op" id="3291455">[</span><span class="builtintype" id="3291456">string</span><span class="op" id="3291462">]</span><span class="op" id="3291463">*</span><span class="ident" id="3291464">Tree</span><span class="op" id="3291468">)</span>&nbsp;<span class="op" id="3291470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291473">tree</span>&nbsp;<span class="op" id="3291478">:=</span>&nbsp;<span class="ident" id="3291481">treeSet</span><span class="op" id="3291488">[</span><span class="ident" id="3291489">t</span><span class="op" id="3291490">.</span><span class="ident" id="3291491">Name</span><span class="op" id="3291495">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291498">if</span>&nbsp;<span class="ident" id="3291501">tree</span>&nbsp;<span class="op" id="3291506">==</span>&nbsp;<span class="ident" id="3291509">nil</span>&nbsp;<span class="op" id="3291513">||</span>&nbsp;<span class="ident" id="3291516">IsEmptyTree</span><span class="op" id="3291527">(</span><span class="ident" id="3291528">tree</span><span class="op" id="3291532">.</span><span class="ident" id="3291533">Root</span><span class="op" id="3291537">)</span>&nbsp;<span class="op" id="3291539">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291543">treeSet</span><span class="op" id="3291550">[</span><span class="ident" id="3291551">t</span><span class="op" id="3291552">.</span><span class="ident" id="3291553">Name</span><span class="op" id="3291557">]</span>&nbsp;<span class="op" id="3291559">=</span>&nbsp;<span class="ident" id="3291561">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291565">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291576">if</span>&nbsp;<span class="op" id="3291579">!</span><span class="ident" id="3291580">IsEmptyTree</span><span class="op" id="3291591">(</span><span class="ident" id="3291592">t</span><span class="op" id="3291593">.</span><span class="ident" id="3291594">Root</span><span class="op" id="3291598">)</span>&nbsp;<span class="op" id="3291600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291604">t</span><span class="op" id="3291605">.</span><span class="ident" id="3291606">errorf</span><span class="op" id="3291612">(</span><span class="string" id="3291613">&#34;template:&nbsp;multiple&nbsp;definition&nbsp;of&nbsp;template&nbsp;%q&#34;</span><span class="op" id="3291659">,</span>&nbsp;<span class="ident" id="3291661">t</span><span class="op" id="3291662">.</span><span class="ident" id="3291663">Name</span><span class="op" id="3291667">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291670">}</span><br>
<span class="lineno"></span><span class="op" id="3291672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3291675">//&nbsp;IsEmptyTree&nbsp;reports&nbsp;whether&nbsp;this&nbsp;tree&nbsp;(node)&nbsp;is&nbsp;empty&nbsp;of&nbsp;everything&nbsp;but&nbsp;space.</span><br>
<span class="lineno"></span><span class="keyword" id="3291757">func</span>&nbsp;<span class="ident" id="3291762">IsEmptyTree</span><span class="op" id="3291773">(</span><span class="ident" id="3291774">n</span>&nbsp;<span class="ident" id="3291776">Node</span><span class="op" id="3291780">)</span>&nbsp;<span class="builtintype" id="3291782">bool</span>&nbsp;<span class="op" id="3291787">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291790">switch</span>&nbsp;<span class="ident" id="3291797">n</span>&nbsp;<span class="op" id="3291799">:=</span>&nbsp;<span class="ident" id="3291802">n</span><span class="op" id="3291803">.</span><span class="op" id="3291804">(</span><span class="keyword" id="3291805">type</span><span class="op" id="3291809">)</span>&nbsp;<span class="op" id="3291811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291814">case</span>&nbsp;<span class="ident" id="3291819">nil</span><span class="op" id="3291822">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291826">return</span>&nbsp;<span class="builtintype" id="3291833">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291839">case</span>&nbsp;<span class="op" id="3291844">*</span><span class="ident" id="3291845">ActionNode</span><span class="op" id="3291855">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291858">case</span>&nbsp;<span class="op" id="3291863">*</span><span class="ident" id="3291864">IfNode</span><span class="op" id="3291870">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291873">case</span>&nbsp;<span class="op" id="3291878">*</span><span class="ident" id="3291879">ListNode</span><span class="op" id="3291887">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291891">for</span>&nbsp;<span class="ident" id="3291895">_</span><span class="op" id="3291896">,</span>&nbsp;<span class="ident" id="3291898">node</span>&nbsp;<span class="op" id="3291903">:=</span>&nbsp;<span class="keyword" id="3291906">range</span>&nbsp;<span class="ident" id="3291912">n</span><span class="op" id="3291913">.</span><span class="ident" id="3291914">Nodes</span>&nbsp;<span class="op" id="3291920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291925">if</span>&nbsp;<span class="op" id="3291928">!</span><span class="ident" id="3291929">IsEmptyTree</span><span class="op" id="3291940">(</span><span class="ident" id="3291941">node</span><span class="op" id="3291945">)</span>&nbsp;<span class="op" id="3291947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291953">return</span>&nbsp;<span class="builtintype" id="3291960">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291969">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291977">return</span>&nbsp;<span class="builtintype" id="3291984">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291990">case</span>&nbsp;<span class="op" id="3291995">*</span><span class="ident" id="3291996">RangeNode</span><span class="op" id="3292005">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292008">case</span>&nbsp;<span class="op" id="3292013">*</span><span class="ident" id="3292014">TemplateNode</span><span class="op" id="3292026">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292029">case</span>&nbsp;<span class="op" id="3292034">*</span><span class="ident" id="3292035">TextNode</span><span class="op" id="3292043">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292047">return</span>&nbsp;<span class="builtinfunc" id="3292054">len</span><span class="op" id="3292057">(</span><span class="ident" id="3292058">bytes</span><span class="op" id="3292063">.</span><span class="ident" id="3292064">TrimSpace</span><span class="op" id="3292073">(</span><span class="ident" id="3292074">n</span><span class="op" id="3292075">.</span><span class="ident" id="3292076">Text</span><span class="op" id="3292080">)</span><span class="op" id="3292081">)</span>&nbsp;<span class="op" id="3292083">==</span>&nbsp;<span class="num" id="3292086">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292089">case</span>&nbsp;<span class="op" id="3292094">*</span><span class="ident" id="3292095">WithNode</span><span class="op" id="3292103">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292106">default</span><span class="op" id="3292113">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3292117">panic</span><span class="op" id="3292122">(</span><span class="string" id="3292123">&#34;unknown&nbsp;node:&nbsp;&#34;</span>&nbsp;<span class="op" id="3292140">+</span>&nbsp;<span class="ident" id="3292142">n</span><span class="op" id="3292143">.</span><span class="ident" id="3292144">String</span><span class="op" id="3292150">(</span><span class="op" id="3292151">)</span><span class="op" id="3292152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292155">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292158">return</span>&nbsp;<span class="builtintype" id="3292165">false</span><br>
<span class="lineno"></span><span class="op" id="3292171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3292174">//&nbsp;parse&nbsp;is&nbsp;the&nbsp;top-level&nbsp;parser&nbsp;for&nbsp;a&nbsp;template,&nbsp;essentially&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="3292244">//&nbsp;as&nbsp;itemList&nbsp;except&nbsp;it&nbsp;also&nbsp;parses&nbsp;{{define}}&nbsp;actions.</span><br>
<span class="lineno">275</span><span class="comment" id="3292301">//&nbsp;It&nbsp;runs&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="3292320">func</span>&nbsp;<span class="op" id="3292325">(</span><span class="ident" id="3292326">t</span>&nbsp;<span class="op" id="3292328">*</span><span class="ident" id="3292329">Tree</span><span class="op" id="3292333">)</span>&nbsp;<span class="ident" id="3292335">parse</span><span class="op" id="3292340">(</span><span class="ident" id="3292341">treeSet</span>&nbsp;<span class="keyword" id="3292349">map</span><span class="op" id="3292352">[</span><span class="builtintype" id="3292353">string</span><span class="op" id="3292359">]</span><span class="op" id="3292360">*</span><span class="ident" id="3292361">Tree</span><span class="op" id="3292365">)</span>&nbsp;<span class="op" id="3292367">(</span><span class="ident" id="3292368">next</span>&nbsp;<span class="ident" id="3292373">Node</span><span class="op" id="3292377">)</span>&nbsp;<span class="op" id="3292379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292382">t</span><span class="op" id="3292383">.</span><span class="ident" id="3292384">Root</span>&nbsp;<span class="op" id="3292389">=</span>&nbsp;<span class="ident" id="3292391">t</span><span class="op" id="3292392">.</span><span class="ident" id="3292393">newList</span><span class="op" id="3292400">(</span><span class="ident" id="3292401">t</span><span class="op" id="3292402">.</span><span class="ident" id="3292403">peek</span><span class="op" id="3292407">(</span><span class="op" id="3292408">)</span><span class="op" id="3292409">.</span><span class="ident" id="3292410">pos</span><span class="op" id="3292413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292416">for</span>&nbsp;<span class="ident" id="3292420">t</span><span class="op" id="3292421">.</span><span class="ident" id="3292422">peek</span><span class="op" id="3292426">(</span><span class="op" id="3292427">)</span><span class="op" id="3292428">.</span><span class="ident" id="3292429">typ</span>&nbsp;<span class="op" id="3292433">!=</span>&nbsp;<span class="ident" id="3292436">itemEOF</span>&nbsp;<span class="op" id="3292444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292448">if</span>&nbsp;<span class="ident" id="3292451">t</span><span class="op" id="3292452">.</span><span class="ident" id="3292453">peek</span><span class="op" id="3292457">(</span><span class="op" id="3292458">)</span><span class="op" id="3292459">.</span><span class="ident" id="3292460">typ</span>&nbsp;<span class="op" id="3292464">==</span>&nbsp;<span class="ident" id="3292467">itemLeftDelim</span>&nbsp;<span class="op" id="3292481">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292486">delim</span>&nbsp;<span class="op" id="3292492">:=</span>&nbsp;<span class="ident" id="3292495">t</span><span class="op" id="3292496">.</span><span class="ident" id="3292497">next</span><span class="op" id="3292501">(</span><span class="op" id="3292502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292507">if</span>&nbsp;<span class="ident" id="3292510">t</span><span class="op" id="3292511">.</span><span class="ident" id="3292512">nextNonSpace</span><span class="op" id="3292524">(</span><span class="op" id="3292525">)</span><span class="op" id="3292526">.</span><span class="ident" id="3292527">typ</span>&nbsp;<span class="op" id="3292531">==</span>&nbsp;<span class="ident" id="3292534">itemDefine</span>&nbsp;<span class="op" id="3292545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292551">newT</span>&nbsp;<span class="op" id="3292556">:=</span>&nbsp;<span class="ident" id="3292559">New</span><span class="op" id="3292562">(</span><span class="string" id="3292563">&#34;definition&#34;</span><span class="op" id="3292575">)</span>&nbsp;<span class="comment" id="3292577">//&nbsp;name&nbsp;will&nbsp;be&nbsp;updated&nbsp;once&nbsp;we&nbsp;know&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292622">newT</span><span class="op" id="3292626">.</span><span class="ident" id="3292627">text</span>&nbsp;<span class="op" id="3292632">=</span>&nbsp;<span class="ident" id="3292634">t</span><span class="op" id="3292635">.</span><span class="ident" id="3292636">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292645">newT</span><span class="op" id="3292649">.</span><span class="ident" id="3292650">ParseName</span>&nbsp;<span class="op" id="3292660">=</span>&nbsp;<span class="ident" id="3292662">t</span><span class="op" id="3292663">.</span><span class="ident" id="3292664">ParseName</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292678">newT</span><span class="op" id="3292682">.</span><span class="ident" id="3292683">startParse</span><span class="op" id="3292693">(</span><span class="ident" id="3292694">t</span><span class="op" id="3292695">.</span><span class="ident" id="3292696">funcs</span><span class="op" id="3292701">,</span>&nbsp;<span class="ident" id="3292703">t</span><span class="op" id="3292704">.</span><span class="ident" id="3292705">lex</span><span class="op" id="3292708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292714">newT</span><span class="op" id="3292718">.</span><span class="ident" id="3292719">parseDefinition</span><span class="op" id="3292734">(</span><span class="ident" id="3292735">treeSet</span><span class="op" id="3292742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292748">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292765">t</span><span class="op" id="3292766">.</span><span class="ident" id="3292767">backup2</span><span class="op" id="3292774">(</span><span class="ident" id="3292775">delim</span><span class="op" id="3292780">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292788">n</span>&nbsp;<span class="op" id="3292790">:=</span>&nbsp;<span class="ident" id="3292793">t</span><span class="op" id="3292794">.</span><span class="ident" id="3292795">textOrAction</span><span class="op" id="3292807">(</span><span class="op" id="3292808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292812">if</span>&nbsp;<span class="ident" id="3292815">n</span><span class="op" id="3292816">.</span><span class="ident" id="3292817">Type</span><span class="op" id="3292821">(</span><span class="op" id="3292822">)</span>&nbsp;<span class="op" id="3292824">==</span>&nbsp;<span class="ident" id="3292827">nodeEnd</span>&nbsp;<span class="op" id="3292835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292840">t</span><span class="op" id="3292841">.</span><span class="ident" id="3292842">errorf</span><span class="op" id="3292848">(</span><span class="string" id="3292849">&#34;unexpected&nbsp;%s&#34;</span><span class="op" id="3292864">,</span>&nbsp;<span class="ident" id="3292866">n</span><span class="op" id="3292867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292871">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292875">t</span><span class="op" id="3292876">.</span><span class="ident" id="3292877">Root</span><span class="op" id="3292881">.</span><span class="builtinfunc" id="3292882">append</span><span class="op" id="3292888">(</span><span class="ident" id="3292889">n</span><span class="op" id="3292890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292896">return</span>&nbsp;<span class="ident" id="3292903">nil</span><br>
<span class="lineno"></span><span class="op" id="3292907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="3292910">//&nbsp;parseDefinition&nbsp;parses&nbsp;a&nbsp;{{define}}&nbsp;...&nbsp;&nbsp;{{end}}&nbsp;template&nbsp;definition&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3292986">//&nbsp;installs&nbsp;the&nbsp;definition&nbsp;in&nbsp;the&nbsp;treeSet&nbsp;map.&nbsp;&nbsp;The&nbsp;&#34;define&#34;&nbsp;keyword&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="3293067">//&nbsp;been&nbsp;scanned.</span><br>
<span class="lineno"></span><span class="keyword" id="3293084">func</span>&nbsp;<span class="op" id="3293089">(</span><span class="ident" id="3293090">t</span>&nbsp;<span class="op" id="3293092">*</span><span class="ident" id="3293093">Tree</span><span class="op" id="3293097">)</span>&nbsp;<span class="ident" id="3293099">parseDefinition</span><span class="op" id="3293114">(</span><span class="ident" id="3293115">treeSet</span>&nbsp;<span class="keyword" id="3293123">map</span><span class="op" id="3293126">[</span><span class="builtintype" id="3293127">string</span><span class="op" id="3293133">]</span><span class="op" id="3293134">*</span><span class="ident" id="3293135">Tree</span><span class="op" id="3293139">)</span>&nbsp;<span class="op" id="3293141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293144">const</span>&nbsp;<span class="ident" id="3293150">context</span>&nbsp;<span class="op" id="3293158">=</span>&nbsp;<span class="string" id="3293160">&#34;define&nbsp;clause&#34;</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293177">name</span>&nbsp;<span class="op" id="3293182">:=</span>&nbsp;<span class="ident" id="3293185">t</span><span class="op" id="3293186">.</span><span class="ident" id="3293187">expectOneOf</span><span class="op" id="3293198">(</span><span class="ident" id="3293199">itemString</span><span class="op" id="3293209">,</span>&nbsp;<span class="ident" id="3293211">itemRawString</span><span class="op" id="3293224">,</span>&nbsp;<span class="ident" id="3293226">context</span><span class="op" id="3293233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293236">var</span>&nbsp;<span class="ident" id="3293240">err</span>&nbsp;<span class="builtintype" id="3293244">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293251">t</span><span class="op" id="3293252">.</span><span class="ident" id="3293253">Name</span><span class="op" id="3293257">,</span>&nbsp;<span class="ident" id="3293259">err</span>&nbsp;<span class="op" id="3293263">=</span>&nbsp;<span class="ident" id="3293265">strconv</span><span class="op" id="3293272">.</span><span class="ident" id="3293273">Unquote</span><span class="op" id="3293280">(</span><span class="ident" id="3293281">name</span><span class="op" id="3293285">.</span><span class="ident" id="3293286">val</span><span class="op" id="3293289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293292">if</span>&nbsp;<span class="ident" id="3293295">err</span>&nbsp;<span class="op" id="3293299">!=</span>&nbsp;<span class="ident" id="3293302">nil</span>&nbsp;<span class="op" id="3293306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293310">t</span><span class="op" id="3293311">.</span><span class="builtintype" id="3293312">error</span><span class="op" id="3293317">(</span><span class="ident" id="3293318">err</span><span class="op" id="3293321">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293327">t</span><span class="op" id="3293328">.</span><span class="ident" id="3293329">expect</span><span class="op" id="3293335">(</span><span class="ident" id="3293336">itemRightDelim</span><span class="op" id="3293350">,</span>&nbsp;<span class="ident" id="3293352">context</span><span class="op" id="3293359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293362">var</span>&nbsp;<span class="ident" id="3293366">end</span>&nbsp;<span class="ident" id="3293370">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293376">t</span><span class="op" id="3293377">.</span><span class="ident" id="3293378">Root</span><span class="op" id="3293382">,</span>&nbsp;<span class="ident" id="3293384">end</span>&nbsp;<span class="op" id="3293388">=</span>&nbsp;<span class="ident" id="3293390">t</span><span class="op" id="3293391">.</span><span class="ident" id="3293392">itemList</span><span class="op" id="3293400">(</span><span class="op" id="3293401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293404">if</span>&nbsp;<span class="ident" id="3293407">end</span><span class="op" id="3293410">.</span><span class="ident" id="3293411">Type</span><span class="op" id="3293415">(</span><span class="op" id="3293416">)</span>&nbsp;<span class="op" id="3293418">!=</span>&nbsp;<span class="ident" id="3293421">nodeEnd</span>&nbsp;<span class="op" id="3293429">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293433">t</span><span class="op" id="3293434">.</span><span class="ident" id="3293435">errorf</span><span class="op" id="3293441">(</span><span class="string" id="3293442">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="3293463">,</span>&nbsp;<span class="ident" id="3293465">end</span><span class="op" id="3293468">,</span>&nbsp;<span class="ident" id="3293470">context</span><span class="op" id="3293477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293483">t</span><span class="op" id="3293484">.</span><span class="ident" id="3293485">add</span><span class="op" id="3293488">(</span><span class="ident" id="3293489">treeSet</span><span class="op" id="3293496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293499">t</span><span class="op" id="3293500">.</span><span class="ident" id="3293501">stopParse</span><span class="op" id="3293510">(</span><span class="op" id="3293511">)</span><br>
<span class="lineno"></span><span class="op" id="3293513">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span><span class="comment" id="3293516">//&nbsp;itemList:</span><br>
<span class="lineno"></span><span class="comment" id="3293529">//&nbsp;&nbsp;&nbsp;&nbsptextOrAction*</span><br>
<span class="lineno"></span><span class="comment" id="3293546">//&nbsp;Terminates&nbsp;at&nbsp;{{end}}&nbsp;or&nbsp;{{else}},&nbsp;returned&nbsp;separately.</span><br>
<span class="lineno"></span><span class="keyword" id="3293605">func</span>&nbsp;<span class="op" id="3293610">(</span><span class="ident" id="3293611">t</span>&nbsp;<span class="op" id="3293613">*</span><span class="ident" id="3293614">Tree</span><span class="op" id="3293618">)</span>&nbsp;<span class="ident" id="3293620">itemList</span><span class="op" id="3293628">(</span><span class="op" id="3293629">)</span>&nbsp;<span class="op" id="3293631">(</span><span class="ident" id="3293632">list</span>&nbsp;<span class="op" id="3293637">*</span><span class="ident" id="3293638">ListNode</span><span class="op" id="3293646">,</span>&nbsp;<span class="ident" id="3293648">next</span>&nbsp;<span class="ident" id="3293653">Node</span><span class="op" id="3293657">)</span>&nbsp;<span class="op" id="3293659">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293662">list</span>&nbsp;<span class="op" id="3293667">=</span>&nbsp;<span class="ident" id="3293669">t</span><span class="op" id="3293670">.</span><span class="ident" id="3293671">newList</span><span class="op" id="3293678">(</span><span class="ident" id="3293679">t</span><span class="op" id="3293680">.</span><span class="ident" id="3293681">peekNonSpace</span><span class="op" id="3293693">(</span><span class="op" id="3293694">)</span><span class="op" id="3293695">.</span><span class="ident" id="3293696">pos</span><span class="op" id="3293699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293702">for</span>&nbsp;<span class="ident" id="3293706">t</span><span class="op" id="3293707">.</span><span class="ident" id="3293708">peekNonSpace</span><span class="op" id="3293720">(</span><span class="op" id="3293721">)</span><span class="op" id="3293722">.</span><span class="ident" id="3293723">typ</span>&nbsp;<span class="op" id="3293727">!=</span>&nbsp;<span class="ident" id="3293730">itemEOF</span>&nbsp;<span class="op" id="3293738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293742">n</span>&nbsp;<span class="op" id="3293744">:=</span>&nbsp;<span class="ident" id="3293747">t</span><span class="op" id="3293748">.</span><span class="ident" id="3293749">textOrAction</span><span class="op" id="3293761">(</span><span class="op" id="3293762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293766">switch</span>&nbsp;<span class="ident" id="3293773">n</span><span class="op" id="3293774">.</span><span class="ident" id="3293775">Type</span><span class="op" id="3293779">(</span><span class="op" id="3293780">)</span>&nbsp;<span class="op" id="3293782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293786">case</span>&nbsp;<span class="ident" id="3293791">nodeEnd</span><span class="op" id="3293798">,</span>&nbsp;<span class="ident" id="3293800">nodeElse</span><span class="op" id="3293808">:</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293813">return</span>&nbsp;<span class="ident" id="3293820">list</span><span class="op" id="3293824">,</span>&nbsp;<span class="ident" id="3293826">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293834">list</span><span class="op" id="3293838">.</span><span class="builtinfunc" id="3293839">append</span><span class="op" id="3293845">(</span><span class="ident" id="3293846">n</span><span class="op" id="3293847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293853">t</span><span class="op" id="3293854">.</span><span class="ident" id="3293855">errorf</span><span class="op" id="3293861">(</span><span class="string" id="3293862">&#34;unexpected&nbsp;EOF&#34;</span><span class="op" id="3293878">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293881">return</span><br>
<span class="lineno"></span><span class="op" id="3293888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3293891">//&nbsp;textOrAction:</span><br>
<span class="lineno"></span><span class="comment" id="3293908">//&nbsp;&nbsp;&nbsp;&nbsptext&nbsp;|&nbsp;action</span><br>
<span class="lineno">340</span><span class="keyword" id="3293925">func</span>&nbsp;<span class="op" id="3293930">(</span><span class="ident" id="3293931">t</span>&nbsp;<span class="op" id="3293933">*</span><span class="ident" id="3293934">Tree</span><span class="op" id="3293938">)</span>&nbsp;<span class="ident" id="3293940">textOrAction</span><span class="op" id="3293952">(</span><span class="op" id="3293953">)</span>&nbsp;<span class="ident" id="3293955">Node</span>&nbsp;<span class="op" id="3293960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293963">switch</span>&nbsp;<span class="ident" id="3293970">token</span>&nbsp;<span class="op" id="3293976">:=</span>&nbsp;<span class="ident" id="3293979">t</span><span class="op" id="3293980">.</span><span class="ident" id="3293981">nextNonSpace</span><span class="op" id="3293993">(</span><span class="op" id="3293994">)</span><span class="op" id="3293995">;</span>&nbsp;<span class="ident" id="3293997">token</span><span class="op" id="3294002">.</span><span class="ident" id="3294003">typ</span>&nbsp;<span class="op" id="3294007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294010">case</span>&nbsp;<span class="ident" id="3294015">itemText</span><span class="op" id="3294023">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294027">return</span>&nbsp;<span class="ident" id="3294034">t</span><span class="op" id="3294035">.</span><span class="ident" id="3294036">newText</span><span class="op" id="3294043">(</span><span class="ident" id="3294044">token</span><span class="op" id="3294049">.</span><span class="ident" id="3294050">pos</span><span class="op" id="3294053">,</span>&nbsp;<span class="ident" id="3294055">token</span><span class="op" id="3294060">.</span><span class="ident" id="3294061">val</span><span class="op" id="3294064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294067">case</span>&nbsp;<span class="ident" id="3294072">itemLeftDelim</span><span class="op" id="3294085">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294089">return</span>&nbsp;<span class="ident" id="3294096">t</span><span class="op" id="3294097">.</span><span class="ident" id="3294098">action</span><span class="op" id="3294104">(</span><span class="op" id="3294105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294108">default</span><span class="op" id="3294115">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3294119">t</span><span class="op" id="3294120">.</span><span class="ident" id="3294121">unexpected</span><span class="op" id="3294131">(</span><span class="ident" id="3294132">token</span><span class="op" id="3294137">,</span>&nbsp;<span class="string" id="3294139">&#34;input&#34;</span><span class="op" id="3294146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3294149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294152">return</span>&nbsp;<span class="ident" id="3294159">nil</span><br>
<span class="lineno">350</span><span class="op" id="3294163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3294166">//&nbsp;Action:</span><br>
<span class="lineno"></span><span class="comment" id="3294177">//&nbsp;&nbsp;&nbsp;&nbspcontrol</span><br>
<span class="lineno"></span><span class="comment" id="3294188">//&nbsp;&nbsp;&nbsp;&nbspcommand&nbsp;(&#34;|&#34;&nbsp;command)*</span><br>
<span class="lineno">355</span><span class="comment" id="3294214">//&nbsp;Left&nbsp;delim&nbsp;is&nbsp;past.&nbsp;Now&nbsp;get&nbsp;actions.</span><br>
<span class="lineno"></span><span class="comment" id="3294254">//&nbsp;First&nbsp;word&nbsp;could&nbsp;be&nbsp;a&nbsp;keyword&nbsp;such&nbsp;as&nbsp;range.</span><br>
<span class="lineno"></span><span class="keyword" id="3294302">func</span>&nbsp;<span class="op" id="3294307">(</span><span class="ident" id="3294308">t</span>&nbsp;<span class="op" id="3294310">*</span><span class="ident" id="3294311">Tree</span><span class="op" id="3294315">)</span>&nbsp;<span class="ident" id="3294317">action</span><span class="op" id="3294323">(</span><span class="op" id="3294324">)</span>&nbsp;<span class="op" id="3294326">(</span><span class="ident" id="3294327">n</span>&nbsp;<span class="ident" id="3294329">Node</span><span class="op" id="3294333">)</span>&nbsp;<span class="op" id="3294335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294338">switch</span>&nbsp;<span class="ident" id="3294345">token</span>&nbsp;<span class="op" id="3294351">:=</span>&nbsp;<span class="ident" id="3294354">t</span><span class="op" id="3294355">.</span><span class="ident" id="3294356">nextNonSpace</span><span class="op" id="3294368">(</span><span class="op" id="3294369">)</span><span class="op" id="3294370">;</span>&nbsp;<span class="ident" id="3294372">token</span><span class="op" id="3294377">.</span><span class="ident" id="3294378">typ</span>&nbsp;<span class="op" id="3294382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294385">case</span>&nbsp;<span class="ident" id="3294390">itemElse</span><span class="op" id="3294398">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294402">return</span>&nbsp;<span class="ident" id="3294409">t</span><span class="op" id="3294410">.</span><span class="ident" id="3294411">elseControl</span><span class="op" id="3294422">(</span><span class="op" id="3294423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294426">case</span>&nbsp;<span class="ident" id="3294431">itemEnd</span><span class="op" id="3294438">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294442">return</span>&nbsp;<span class="ident" id="3294449">t</span><span class="op" id="3294450">.</span><span class="ident" id="3294451">endControl</span><span class="op" id="3294461">(</span><span class="op" id="3294462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294465">case</span>&nbsp;<span class="ident" id="3294470">itemIf</span><span class="op" id="3294476">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294480">return</span>&nbsp;<span class="ident" id="3294487">t</span><span class="op" id="3294488">.</span><span class="ident" id="3294489">ifControl</span><span class="op" id="3294498">(</span><span class="op" id="3294499">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294502">case</span>&nbsp;<span class="ident" id="3294507">itemRange</span><span class="op" id="3294516">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294520">return</span>&nbsp;<span class="ident" id="3294527">t</span><span class="op" id="3294528">.</span><span class="ident" id="3294529">rangeControl</span><span class="op" id="3294541">(</span><span class="op" id="3294542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294545">case</span>&nbsp;<span class="ident" id="3294550">itemTemplate</span><span class="op" id="3294562">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294566">return</span>&nbsp;<span class="ident" id="3294573">t</span><span class="op" id="3294574">.</span><span class="ident" id="3294575">templateControl</span><span class="op" id="3294590">(</span><span class="op" id="3294591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294594">case</span>&nbsp;<span class="ident" id="3294599">itemWith</span><span class="op" id="3294607">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294611">return</span>&nbsp;<span class="ident" id="3294618">t</span><span class="op" id="3294619">.</span><span class="ident" id="3294620">withControl</span><span class="op" id="3294631">(</span><span class="op" id="3294632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3294635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3294638">t</span><span class="op" id="3294639">.</span><span class="ident" id="3294640">backup</span><span class="op" id="3294646">(</span><span class="op" id="3294647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3294650">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294702">return</span>&nbsp;<span class="ident" id="3294709">t</span><span class="op" id="3294710">.</span><span class="ident" id="3294711">newAction</span><span class="op" id="3294720">(</span><span class="ident" id="3294721">t</span><span class="op" id="3294722">.</span><span class="ident" id="3294723">peek</span><span class="op" id="3294727">(</span><span class="op" id="3294728">)</span><span class="op" id="3294729">.</span><span class="ident" id="3294730">pos</span><span class="op" id="3294733">,</span>&nbsp;<span class="ident" id="3294735">t</span><span class="op" id="3294736">.</span><span class="ident" id="3294737">lex</span><span class="op" id="3294740">.</span><span class="ident" id="3294741">lineNumber</span><span class="op" id="3294751">(</span><span class="op" id="3294752">)</span><span class="op" id="3294753">,</span>&nbsp;<span class="ident" id="3294755">t</span><span class="op" id="3294756">.</span><span class="ident" id="3294757">pipeline</span><span class="op" id="3294765">(</span><span class="string" id="3294766">&#34;command&#34;</span><span class="op" id="3294775">)</span><span class="op" id="3294776">)</span><br>
<span class="lineno">375</span><span class="op" id="3294778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3294781">//&nbsp;Pipeline:</span><br>
<span class="lineno"></span><span class="comment" id="3294794">//&nbsp;&nbsp;&nbsp;&nbspdeclarations?&nbsp;command&nbsp;(&#39;|&#39;&nbsp;command)*</span><br>
<span class="lineno"></span><span class="keyword" id="3294834">func</span>&nbsp;<span class="op" id="3294839">(</span><span class="ident" id="3294840">t</span>&nbsp;<span class="op" id="3294842">*</span><span class="ident" id="3294843">Tree</span><span class="op" id="3294847">)</span>&nbsp;<span class="ident" id="3294849">pipeline</span><span class="op" id="3294857">(</span><span class="ident" id="3294858">context</span>&nbsp;<span class="builtintype" id="3294866">string</span><span class="op" id="3294872">)</span>&nbsp;<span class="op" id="3294874">(</span><span class="ident" id="3294875">pipe</span>&nbsp;<span class="op" id="3294880">*</span><span class="ident" id="3294881">PipeNode</span><span class="op" id="3294889">)</span>&nbsp;<span class="op" id="3294891">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294894">var</span>&nbsp;<span class="ident" id="3294898">decl</span>&nbsp;<span class="op" id="3294903">[</span><span class="op" id="3294904">]</span><span class="op" id="3294905">*</span><span class="ident" id="3294906">VariableNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3294920">pos</span>&nbsp;<span class="op" id="3294924">:=</span>&nbsp;<span class="ident" id="3294927">t</span><span class="op" id="3294928">.</span><span class="ident" id="3294929">peekNonSpace</span><span class="op" id="3294941">(</span><span class="op" id="3294942">)</span><span class="op" id="3294943">.</span><span class="ident" id="3294944">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3294949">//&nbsp;Are&nbsp;there&nbsp;declarations?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294977">for</span>&nbsp;<span class="op" id="3294981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294985">if</span>&nbsp;<span class="ident" id="3294988">v</span>&nbsp;<span class="op" id="3294990">:=</span>&nbsp;<span class="ident" id="3294993">t</span><span class="op" id="3294994">.</span><span class="ident" id="3294995">peekNonSpace</span><span class="op" id="3295007">(</span><span class="op" id="3295008">)</span><span class="op" id="3295009">;</span>&nbsp;<span class="ident" id="3295011">v</span><span class="op" id="3295012">.</span><span class="ident" id="3295013">typ</span>&nbsp;<span class="op" id="3295017">==</span>&nbsp;<span class="ident" id="3295020">itemVariable</span>&nbsp;<span class="op" id="3295033">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295038">t</span><span class="op" id="3295039">.</span><span class="ident" id="3295040">next</span><span class="op" id="3295044">(</span><span class="op" id="3295045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3295050">//&nbsp;Since&nbsp;space&nbsp;is&nbsp;a&nbsp;token,&nbsp;we&nbsp;need&nbsp;3-token&nbsp;look-ahead&nbsp;here&nbsp;in&nbsp;the&nbsp;worst&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3295131">//&nbsp;in&nbsp;&#34;$x&nbsp;foo&#34;&nbsp;we&nbsp;need&nbsp;to&nbsp;read&nbsp;&#34;foo&#34;&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;&#34;:=&#34;)&nbsp;to&nbsp;know&nbsp;that&nbsp;$x&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3295214">//&nbsp;argument&nbsp;variable&nbsp;rather&nbsp;than&nbsp;a&nbsp;declaration.&nbsp;So&nbsp;remember&nbsp;the&nbsp;token</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3295287">//&nbsp;adjacent&nbsp;to&nbsp;the&nbsp;variable&nbsp;so&nbsp;we&nbsp;can&nbsp;push&nbsp;it&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295355">tokenAfterVariable</span>&nbsp;<span class="op" id="3295374">:=</span>&nbsp;<span class="ident" id="3295377">t</span><span class="op" id="3295378">.</span><span class="ident" id="3295379">peek</span><span class="op" id="3295383">(</span><span class="op" id="3295384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295389">if</span>&nbsp;<span class="ident" id="3295392">next</span>&nbsp;<span class="op" id="3295397">:=</span>&nbsp;<span class="ident" id="3295400">t</span><span class="op" id="3295401">.</span><span class="ident" id="3295402">peekNonSpace</span><span class="op" id="3295414">(</span><span class="op" id="3295415">)</span><span class="op" id="3295416">;</span>&nbsp;<span class="ident" id="3295418">next</span><span class="op" id="3295422">.</span><span class="ident" id="3295423">typ</span>&nbsp;<span class="op" id="3295427">==</span>&nbsp;<span class="ident" id="3295430">itemColonEquals</span>&nbsp;<span class="op" id="3295446">||</span>&nbsp;<span class="op" id="3295449">(</span><span class="ident" id="3295450">next</span><span class="op" id="3295454">.</span><span class="ident" id="3295455">typ</span>&nbsp;<span class="op" id="3295459">==</span>&nbsp;<span class="ident" id="3295462">itemChar</span>&nbsp;<span class="op" id="3295471">&amp;&amp;</span>&nbsp;<span class="ident" id="3295474">next</span><span class="op" id="3295478">.</span><span class="ident" id="3295479">val</span>&nbsp;<span class="op" id="3295483">==</span>&nbsp;<span class="string" id="3295486">&#34;,&#34;</span><span class="op" id="3295489">)</span>&nbsp;<span class="op" id="3295491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295497">t</span><span class="op" id="3295498">.</span><span class="ident" id="3295499">nextNonSpace</span><span class="op" id="3295511">(</span><span class="op" id="3295512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295518">variable</span>&nbsp;<span class="op" id="3295527">:=</span>&nbsp;<span class="ident" id="3295530">t</span><span class="op" id="3295531">.</span><span class="ident" id="3295532">newVariable</span><span class="op" id="3295543">(</span><span class="ident" id="3295544">v</span><span class="op" id="3295545">.</span><span class="ident" id="3295546">pos</span><span class="op" id="3295549">,</span>&nbsp;<span class="ident" id="3295551">v</span><span class="op" id="3295552">.</span><span class="ident" id="3295553">val</span><span class="op" id="3295556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295562">decl</span>&nbsp;<span class="op" id="3295567">=</span>&nbsp;<span class="builtinfunc" id="3295569">append</span><span class="op" id="3295575">(</span><span class="ident" id="3295576">decl</span><span class="op" id="3295580">,</span>&nbsp;<span class="ident" id="3295582">variable</span><span class="op" id="3295590">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295596">t</span><span class="op" id="3295597">.</span><span class="ident" id="3295598">vars</span>&nbsp;<span class="op" id="3295603">=</span>&nbsp;<span class="builtinfunc" id="3295605">append</span><span class="op" id="3295611">(</span><span class="ident" id="3295612">t</span><span class="op" id="3295613">.</span><span class="ident" id="3295614">vars</span><span class="op" id="3295618">,</span>&nbsp;<span class="ident" id="3295620">v</span><span class="op" id="3295621">.</span><span class="ident" id="3295622">val</span><span class="op" id="3295625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295631">if</span>&nbsp;<span class="ident" id="3295634">next</span><span class="op" id="3295638">.</span><span class="ident" id="3295639">typ</span>&nbsp;<span class="op" id="3295643">==</span>&nbsp;<span class="ident" id="3295646">itemChar</span>&nbsp;<span class="op" id="3295655">&amp;&amp;</span>&nbsp;<span class="ident" id="3295658">next</span><span class="op" id="3295662">.</span><span class="ident" id="3295663">val</span>&nbsp;<span class="op" id="3295667">==</span>&nbsp;<span class="string" id="3295670">&#34;,&#34;</span>&nbsp;<span class="op" id="3295674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295681">if</span>&nbsp;<span class="ident" id="3295684">context</span>&nbsp;<span class="op" id="3295692">==</span>&nbsp;<span class="string" id="3295695">&#34;range&#34;</span>&nbsp;<span class="op" id="3295703">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3295706">len</span><span class="op" id="3295709">(</span><span class="ident" id="3295710">decl</span><span class="op" id="3295714">)</span>&nbsp;<span class="op" id="3295716">&lt;</span>&nbsp;<span class="num" id="3295718">2</span>&nbsp;<span class="op" id="3295720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295728">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3295742">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295749">t</span><span class="op" id="3295750">.</span><span class="ident" id="3295751">errorf</span><span class="op" id="3295757">(</span><span class="string" id="3295758">&#34;too&nbsp;many&nbsp;declarations&nbsp;in&nbsp;%s&#34;</span><span class="op" id="3295787">,</span>&nbsp;<span class="ident" id="3295789">context</span><span class="op" id="3295796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3295802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3295807">}</span>&nbsp;<span class="keyword" id="3295809">else</span>&nbsp;<span class="keyword" id="3295814">if</span>&nbsp;<span class="ident" id="3295817">tokenAfterVariable</span><span class="op" id="3295835">.</span><span class="ident" id="3295836">typ</span>&nbsp;<span class="op" id="3295840">==</span>&nbsp;<span class="ident" id="3295843">itemSpace</span>&nbsp;<span class="op" id="3295853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295859">t</span><span class="op" id="3295860">.</span><span class="ident" id="3295861">backup3</span><span class="op" id="3295868">(</span><span class="ident" id="3295869">v</span><span class="op" id="3295870">,</span>&nbsp;<span class="ident" id="3295872">tokenAfterVariable</span><span class="op" id="3295890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3295895">}</span>&nbsp;<span class="keyword" id="3295897">else</span>&nbsp;<span class="op" id="3295902">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295908">t</span><span class="op" id="3295909">.</span><span class="ident" id="3295910">backup2</span><span class="op" id="3295917">(</span><span class="ident" id="3295918">v</span><span class="op" id="3295919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3295924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3295928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295932">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3295939">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295942">pipe</span>&nbsp;<span class="op" id="3295947">=</span>&nbsp;<span class="ident" id="3295949">t</span><span class="op" id="3295950">.</span><span class="ident" id="3295951">newPipeline</span><span class="op" id="3295962">(</span><span class="ident" id="3295963">pos</span><span class="op" id="3295966">,</span>&nbsp;<span class="ident" id="3295968">t</span><span class="op" id="3295969">.</span><span class="ident" id="3295970">lex</span><span class="op" id="3295973">.</span><span class="ident" id="3295974">lineNumber</span><span class="op" id="3295984">(</span><span class="op" id="3295985">)</span><span class="op" id="3295986">,</span>&nbsp;<span class="ident" id="3295988">decl</span><span class="op" id="3295992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295995">for</span>&nbsp;<span class="op" id="3295999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296003">switch</span>&nbsp;<span class="ident" id="3296010">token</span>&nbsp;<span class="op" id="3296016">:=</span>&nbsp;<span class="ident" id="3296019">t</span><span class="op" id="3296020">.</span><span class="ident" id="3296021">nextNonSpace</span><span class="op" id="3296033">(</span><span class="op" id="3296034">)</span><span class="op" id="3296035">;</span>&nbsp;<span class="ident" id="3296037">token</span><span class="op" id="3296042">.</span><span class="ident" id="3296043">typ</span>&nbsp;<span class="op" id="3296047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296051">case</span>&nbsp;<span class="ident" id="3296056">itemRightDelim</span><span class="op" id="3296070">,</span>&nbsp;<span class="ident" id="3296072">itemRightParen</span><span class="op" id="3296086">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296091">if</span>&nbsp;<span class="builtinfunc" id="3296094">len</span><span class="op" id="3296097">(</span><span class="ident" id="3296098">pipe</span><span class="op" id="3296102">.</span><span class="ident" id="3296103">Cmds</span><span class="op" id="3296107">)</span>&nbsp;<span class="op" id="3296109">==</span>&nbsp;<span class="num" id="3296112">0</span>&nbsp;<span class="op" id="3296114">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296120">t</span><span class="op" id="3296121">.</span><span class="ident" id="3296122">errorf</span><span class="op" id="3296128">(</span><span class="string" id="3296129">&#34;missing&nbsp;value&nbsp;for&nbsp;%s&#34;</span><span class="op" id="3296151">,</span>&nbsp;<span class="ident" id="3296153">context</span><span class="op" id="3296160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3296165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296170">if</span>&nbsp;<span class="ident" id="3296173">token</span><span class="op" id="3296178">.</span><span class="ident" id="3296179">typ</span>&nbsp;<span class="op" id="3296183">==</span>&nbsp;<span class="ident" id="3296186">itemRightParen</span>&nbsp;<span class="op" id="3296201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296207">t</span><span class="op" id="3296208">.</span><span class="ident" id="3296209">backup</span><span class="op" id="3296215">(</span><span class="op" id="3296216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3296221">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296226">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296235">case</span>&nbsp;<span class="ident" id="3296240">itemBool</span><span class="op" id="3296248">,</span>&nbsp;<span class="ident" id="3296250">itemCharConstant</span><span class="op" id="3296266">,</span>&nbsp;<span class="ident" id="3296268">itemComplex</span><span class="op" id="3296279">,</span>&nbsp;<span class="ident" id="3296281">itemDot</span><span class="op" id="3296288">,</span>&nbsp;<span class="ident" id="3296290">itemField</span><span class="op" id="3296299">,</span>&nbsp;<span class="ident" id="3296301">itemIdentifier</span><span class="op" id="3296315">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296320">itemNumber</span><span class="op" id="3296330">,</span>&nbsp;<span class="ident" id="3296332">itemNil</span><span class="op" id="3296339">,</span>&nbsp;<span class="ident" id="3296341">itemRawString</span><span class="op" id="3296354">,</span>&nbsp;<span class="ident" id="3296356">itemString</span><span class="op" id="3296366">,</span>&nbsp;<span class="ident" id="3296368">itemVariable</span><span class="op" id="3296380">,</span>&nbsp;<span class="ident" id="3296382">itemLeftParen</span><span class="op" id="3296395">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296400">t</span><span class="op" id="3296401">.</span><span class="ident" id="3296402">backup</span><span class="op" id="3296408">(</span><span class="op" id="3296409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296414">pipe</span><span class="op" id="3296418">.</span><span class="builtinfunc" id="3296419">append</span><span class="op" id="3296425">(</span><span class="ident" id="3296426">t</span><span class="op" id="3296427">.</span><span class="ident" id="3296428">command</span><span class="op" id="3296435">(</span><span class="op" id="3296436">)</span><span class="op" id="3296437">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296441">default</span><span class="op" id="3296448">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296453">t</span><span class="op" id="3296454">.</span><span class="ident" id="3296455">unexpected</span><span class="op" id="3296465">(</span><span class="ident" id="3296466">token</span><span class="op" id="3296471">,</span>&nbsp;<span class="ident" id="3296473">context</span><span class="op" id="3296480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3296484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3296487">}</span><br>
<span class="lineno"></span><span class="op" id="3296489">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="3296492">func</span>&nbsp;<span class="op" id="3296497">(</span><span class="ident" id="3296498">t</span>&nbsp;<span class="op" id="3296500">*</span><span class="ident" id="3296501">Tree</span><span class="op" id="3296505">)</span>&nbsp;<span class="ident" id="3296507">parseControl</span><span class="op" id="3296519">(</span><span class="ident" id="3296520">allowElseIf</span>&nbsp;<span class="builtintype" id="3296532">bool</span><span class="op" id="3296536">,</span>&nbsp;<span class="ident" id="3296538">context</span>&nbsp;<span class="builtintype" id="3296546">string</span><span class="op" id="3296552">)</span>&nbsp;<span class="op" id="3296554">(</span><span class="ident" id="3296555">pos</span>&nbsp;<span class="ident" id="3296559">Pos</span><span class="op" id="3296562">,</span>&nbsp;<span class="ident" id="3296564">line</span>&nbsp;<span class="builtintype" id="3296569">int</span><span class="op" id="3296572">,</span>&nbsp;<span class="ident" id="3296574">pipe</span>&nbsp;<span class="op" id="3296579">*</span><span class="ident" id="3296580">PipeNode</span><span class="op" id="3296588">,</span>&nbsp;<span class="ident" id="3296590">list</span><span class="op" id="3296594">,</span>&nbsp;<span class="ident" id="3296596">elseList</span>&nbsp;<span class="op" id="3296605">*</span><span class="ident" id="3296606">ListNode</span><span class="op" id="3296614">)</span>&nbsp;<span class="op" id="3296616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296619">defer</span>&nbsp;<span class="ident" id="3296625">t</span><span class="op" id="3296626">.</span><span class="ident" id="3296627">popVars</span><span class="op" id="3296634">(</span><span class="builtinfunc" id="3296635">len</span><span class="op" id="3296638">(</span><span class="ident" id="3296639">t</span><span class="op" id="3296640">.</span><span class="ident" id="3296641">vars</span><span class="op" id="3296645">)</span><span class="op" id="3296646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296649">line</span>&nbsp;<span class="op" id="3296654">=</span>&nbsp;<span class="ident" id="3296656">t</span><span class="op" id="3296657">.</span><span class="ident" id="3296658">lex</span><span class="op" id="3296661">.</span><span class="ident" id="3296662">lineNumber</span><span class="op" id="3296672">(</span><span class="op" id="3296673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296676">pipe</span>&nbsp;<span class="op" id="3296681">=</span>&nbsp;<span class="ident" id="3296683">t</span><span class="op" id="3296684">.</span><span class="ident" id="3296685">pipeline</span><span class="op" id="3296693">(</span><span class="ident" id="3296694">context</span><span class="op" id="3296701">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296704">var</span>&nbsp;<span class="ident" id="3296708">next</span>&nbsp;<span class="ident" id="3296713">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296719">list</span><span class="op" id="3296723">,</span>&nbsp;<span class="ident" id="3296725">next</span>&nbsp;<span class="op" id="3296730">=</span>&nbsp;<span class="ident" id="3296732">t</span><span class="op" id="3296733">.</span><span class="ident" id="3296734">itemList</span><span class="op" id="3296742">(</span><span class="op" id="3296743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296746">switch</span>&nbsp;<span class="ident" id="3296753">next</span><span class="op" id="3296757">.</span><span class="ident" id="3296758">Type</span><span class="op" id="3296762">(</span><span class="op" id="3296763">)</span>&nbsp;<span class="op" id="3296765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296768">case</span>&nbsp;<span class="ident" id="3296773">nodeEnd</span><span class="op" id="3296780">:</span>&nbsp;<span class="comment" id="3296782">//done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296790">case</span>&nbsp;<span class="ident" id="3296795">nodeElse</span><span class="op" id="3296803">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296807">if</span>&nbsp;<span class="ident" id="3296810">allowElseIf</span>&nbsp;<span class="op" id="3296822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296827">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.&nbsp;If&nbsp;the&nbsp;&#34;else&#34;&nbsp;is&nbsp;followed&nbsp;immediately&nbsp;by&nbsp;an&nbsp;&#34;if&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296911">//&nbsp;the&nbsp;elseControl&nbsp;will&nbsp;have&nbsp;left&nbsp;the&nbsp;&#34;if&#34;&nbsp;token&nbsp;pending.&nbsp;Treat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296978">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;a}}_{{else&nbsp;if&nbsp;b}}_{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297015">//&nbsp;as</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297024">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;a}}_{{else}}{{if&nbsp;b}}_{{end}}{{end}}.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297072">//&nbsp;To&nbsp;do&nbsp;this,&nbsp;parse&nbsp;the&nbsp;if&nbsp;as&nbsp;usual&nbsp;and&nbsp;stop&nbsp;at&nbsp;it&nbsp;{{end}};&nbsp;the&nbsp;subsequent{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297158">//&nbsp;is&nbsp;assumed.&nbsp;This&nbsp;technique&nbsp;works&nbsp;even&nbsp;for&nbsp;long&nbsp;if-else-if&nbsp;chains.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297230">//&nbsp;TODO:&nbsp;Should&nbsp;we&nbsp;allow&nbsp;else-if&nbsp;in&nbsp;with&nbsp;and&nbsp;range?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297285">if</span>&nbsp;<span class="ident" id="3297288">t</span><span class="op" id="3297289">.</span><span class="ident" id="3297290">peek</span><span class="op" id="3297294">(</span><span class="op" id="3297295">)</span><span class="op" id="3297296">.</span><span class="ident" id="3297297">typ</span>&nbsp;<span class="op" id="3297301">==</span>&nbsp;<span class="ident" id="3297304">itemIf</span>&nbsp;<span class="op" id="3297311">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297317">t</span><span class="op" id="3297318">.</span><span class="ident" id="3297319">next</span><span class="op" id="3297323">(</span><span class="op" id="3297324">)</span>&nbsp;<span class="comment" id="3297326">//&nbsp;Consume&nbsp;the&nbsp;&#34;if&#34;&nbsp;token.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297357">elseList</span>&nbsp;<span class="op" id="3297366">=</span>&nbsp;<span class="ident" id="3297368">t</span><span class="op" id="3297369">.</span><span class="ident" id="3297370">newList</span><span class="op" id="3297377">(</span><span class="ident" id="3297378">next</span><span class="op" id="3297382">.</span><span class="ident" id="3297383">Position</span><span class="op" id="3297391">(</span><span class="op" id="3297392">)</span><span class="op" id="3297393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297399">elseList</span><span class="op" id="3297407">.</span><span class="builtinfunc" id="3297408">append</span><span class="op" id="3297414">(</span><span class="ident" id="3297415">t</span><span class="op" id="3297416">.</span><span class="ident" id="3297417">ifControl</span><span class="op" id="3297426">(</span><span class="op" id="3297427">)</span><span class="op" id="3297428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297434">//&nbsp;Do&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;item&nbsp;-&nbsp;only&nbsp;one&nbsp;{{end}}&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297499">break</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297516">elseList</span><span class="op" id="3297524">,</span>&nbsp;<span class="ident" id="3297526">next</span>&nbsp;<span class="op" id="3297531">=</span>&nbsp;<span class="ident" id="3297533">t</span><span class="op" id="3297534">.</span><span class="ident" id="3297535">itemList</span><span class="op" id="3297543">(</span><span class="op" id="3297544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297548">if</span>&nbsp;<span class="ident" id="3297551">next</span><span class="op" id="3297555">.</span><span class="ident" id="3297556">Type</span><span class="op" id="3297560">(</span><span class="op" id="3297561">)</span>&nbsp;<span class="op" id="3297563">!=</span>&nbsp;<span class="ident" id="3297566">nodeEnd</span>&nbsp;<span class="op" id="3297574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297579">t</span><span class="op" id="3297580">.</span><span class="ident" id="3297581">errorf</span><span class="op" id="3297587">(</span><span class="string" id="3297588">&#34;expected&nbsp;end;&nbsp;found&nbsp;%s&#34;</span><span class="op" id="3297612">,</span>&nbsp;<span class="ident" id="3297614">next</span><span class="op" id="3297618">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297628">return</span>&nbsp;<span class="ident" id="3297635">pipe</span><span class="op" id="3297639">.</span><span class="ident" id="3297640">Position</span><span class="op" id="3297648">(</span><span class="op" id="3297649">)</span><span class="op" id="3297650">,</span>&nbsp;<span class="ident" id="3297652">line</span><span class="op" id="3297656">,</span>&nbsp;<span class="ident" id="3297658">pipe</span><span class="op" id="3297662">,</span>&nbsp;<span class="ident" id="3297664">list</span><span class="op" id="3297668">,</span>&nbsp;<span class="ident" id="3297670">elseList</span><br>
<span class="lineno"></span><span class="op" id="3297679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="comment" id="3297682">//&nbsp;If:</span><br>
<span class="lineno"></span><span class="comment" id="3297689">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3297725">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3297779">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3297802">func</span>&nbsp;<span class="op" id="3297807">(</span><span class="ident" id="3297808">t</span>&nbsp;<span class="op" id="3297810">*</span><span class="ident" id="3297811">Tree</span><span class="op" id="3297815">)</span>&nbsp;<span class="ident" id="3297817">ifControl</span><span class="op" id="3297826">(</span><span class="op" id="3297827">)</span>&nbsp;<span class="ident" id="3297829">Node</span>&nbsp;<span class="op" id="3297834">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297837">return</span>&nbsp;<span class="ident" id="3297844">t</span><span class="op" id="3297845">.</span><span class="ident" id="3297846">newIf</span><span class="op" id="3297851">(</span><span class="ident" id="3297852">t</span><span class="op" id="3297853">.</span><span class="ident" id="3297854">parseControl</span><span class="op" id="3297866">(</span><span class="builtintype" id="3297867">true</span><span class="op" id="3297871">,</span>&nbsp;<span class="string" id="3297873">&#34;if&#34;</span><span class="op" id="3297877">)</span><span class="op" id="3297878">)</span><br>
<span class="lineno"></span><span class="op" id="3297880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3297883">//&nbsp;Range:</span><br>
<span class="lineno"></span><span class="comment" id="3297893">//&nbsp;&nbsp;&nbsp;&nbsp{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno">475</span><span class="comment" id="3297932">//&nbsp;&nbsp;&nbsp;&nbsp{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3297989">//&nbsp;Range&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3298015">func</span>&nbsp;<span class="op" id="3298020">(</span><span class="ident" id="3298021">t</span>&nbsp;<span class="op" id="3298023">*</span><span class="ident" id="3298024">Tree</span><span class="op" id="3298028">)</span>&nbsp;<span class="ident" id="3298030">rangeControl</span><span class="op" id="3298042">(</span><span class="op" id="3298043">)</span>&nbsp;<span class="ident" id="3298045">Node</span>&nbsp;<span class="op" id="3298050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298053">return</span>&nbsp;<span class="ident" id="3298060">t</span><span class="op" id="3298061">.</span><span class="ident" id="3298062">newRange</span><span class="op" id="3298070">(</span><span class="ident" id="3298071">t</span><span class="op" id="3298072">.</span><span class="ident" id="3298073">parseControl</span><span class="op" id="3298085">(</span><span class="builtintype" id="3298086">false</span><span class="op" id="3298091">,</span>&nbsp;<span class="string" id="3298093">&#34;range&#34;</span><span class="op" id="3298100">)</span><span class="op" id="3298101">)</span><br>
<span class="lineno"></span><span class="op" id="3298103">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="3298106">//&nbsp;With:</span><br>
<span class="lineno"></span><span class="comment" id="3298115">//&nbsp;&nbsp;&nbsp;&nbsp{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3298153">//&nbsp;&nbsp;&nbsp;&nbsp{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3298209">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno">485</span><span class="keyword" id="3298232">func</span>&nbsp;<span class="op" id="3298237">(</span><span class="ident" id="3298238">t</span>&nbsp;<span class="op" id="3298240">*</span><span class="ident" id="3298241">Tree</span><span class="op" id="3298245">)</span>&nbsp;<span class="ident" id="3298247">withControl</span><span class="op" id="3298258">(</span><span class="op" id="3298259">)</span>&nbsp;<span class="ident" id="3298261">Node</span>&nbsp;<span class="op" id="3298266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298269">return</span>&nbsp;<span class="ident" id="3298276">t</span><span class="op" id="3298277">.</span><span class="ident" id="3298278">newWith</span><span class="op" id="3298285">(</span><span class="ident" id="3298286">t</span><span class="op" id="3298287">.</span><span class="ident" id="3298288">parseControl</span><span class="op" id="3298300">(</span><span class="builtintype" id="3298301">false</span><span class="op" id="3298306">,</span>&nbsp;<span class="string" id="3298308">&#34;with&#34;</span><span class="op" id="3298314">)</span><span class="op" id="3298315">)</span><br>
<span class="lineno"></span><span class="op" id="3298317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3298320">//&nbsp;End:</span><br>
<span class="lineno">490</span><span class="comment" id="3298328">//&nbsp;&nbsp;&nbsp;&nbsp{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3298339">//&nbsp;End&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3298363">func</span>&nbsp;<span class="op" id="3298368">(</span><span class="ident" id="3298369">t</span>&nbsp;<span class="op" id="3298371">*</span><span class="ident" id="3298372">Tree</span><span class="op" id="3298376">)</span>&nbsp;<span class="ident" id="3298378">endControl</span><span class="op" id="3298388">(</span><span class="op" id="3298389">)</span>&nbsp;<span class="ident" id="3298391">Node</span>&nbsp;<span class="op" id="3298396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298399">return</span>&nbsp;<span class="ident" id="3298406">t</span><span class="op" id="3298407">.</span><span class="ident" id="3298408">newEnd</span><span class="op" id="3298414">(</span><span class="ident" id="3298415">t</span><span class="op" id="3298416">.</span><span class="ident" id="3298417">expect</span><span class="op" id="3298423">(</span><span class="ident" id="3298424">itemRightDelim</span><span class="op" id="3298438">,</span>&nbsp;<span class="string" id="3298440">&#34;end&#34;</span><span class="op" id="3298445">)</span><span class="op" id="3298446">.</span><span class="ident" id="3298447">pos</span><span class="op" id="3298450">)</span><br>
<span class="lineno"></span><span class="op" id="3298452">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="comment" id="3298455">//&nbsp;Else:</span><br>
<span class="lineno"></span><span class="comment" id="3298464">//&nbsp;&nbsp;&nbsp;&nbsp{{else}}</span><br>
<span class="lineno"></span><span class="comment" id="3298476">//&nbsp;Else&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3298501">func</span>&nbsp;<span class="op" id="3298506">(</span><span class="ident" id="3298507">t</span>&nbsp;<span class="op" id="3298509">*</span><span class="ident" id="3298510">Tree</span><span class="op" id="3298514">)</span>&nbsp;<span class="ident" id="3298516">elseControl</span><span class="op" id="3298527">(</span><span class="op" id="3298528">)</span>&nbsp;<span class="ident" id="3298530">Node</span>&nbsp;<span class="op" id="3298535">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3298538">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298570">peek</span>&nbsp;<span class="op" id="3298575">:=</span>&nbsp;<span class="ident" id="3298578">t</span><span class="op" id="3298579">.</span><span class="ident" id="3298580">peekNonSpace</span><span class="op" id="3298592">(</span><span class="op" id="3298593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298596">if</span>&nbsp;<span class="ident" id="3298599">peek</span><span class="op" id="3298603">.</span><span class="ident" id="3298604">typ</span>&nbsp;<span class="op" id="3298608">==</span>&nbsp;<span class="ident" id="3298611">itemIf</span>&nbsp;<span class="op" id="3298618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3298622">//&nbsp;We&nbsp;see&nbsp;&#34;{{else&nbsp;if&nbsp;...&nbsp;&#34;&nbsp;but&nbsp;in&nbsp;effect&nbsp;rewrite&nbsp;it&nbsp;to&nbsp;{{else}}{{if&nbsp;...&nbsp;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298699">return</span>&nbsp;<span class="ident" id="3298706">t</span><span class="op" id="3298707">.</span><span class="ident" id="3298708">newElse</span><span class="op" id="3298715">(</span><span class="ident" id="3298716">peek</span><span class="op" id="3298720">.</span><span class="ident" id="3298721">pos</span><span class="op" id="3298724">,</span>&nbsp;<span class="ident" id="3298726">t</span><span class="op" id="3298727">.</span><span class="ident" id="3298728">lex</span><span class="op" id="3298731">.</span><span class="ident" id="3298732">lineNumber</span><span class="op" id="3298742">(</span><span class="op" id="3298743">)</span><span class="op" id="3298744">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3298747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298750">return</span>&nbsp;<span class="ident" id="3298757">t</span><span class="op" id="3298758">.</span><span class="ident" id="3298759">newElse</span><span class="op" id="3298766">(</span><span class="ident" id="3298767">t</span><span class="op" id="3298768">.</span><span class="ident" id="3298769">expect</span><span class="op" id="3298775">(</span><span class="ident" id="3298776">itemRightDelim</span><span class="op" id="3298790">,</span>&nbsp;<span class="string" id="3298792">&#34;else&#34;</span><span class="op" id="3298798">)</span><span class="op" id="3298799">.</span><span class="ident" id="3298800">pos</span><span class="op" id="3298803">,</span>&nbsp;<span class="ident" id="3298805">t</span><span class="op" id="3298806">.</span><span class="ident" id="3298807">lex</span><span class="op" id="3298810">.</span><span class="ident" id="3298811">lineNumber</span><span class="op" id="3298821">(</span><span class="op" id="3298822">)</span><span class="op" id="3298823">)</span><br>
<span class="lineno"></span><span class="op" id="3298825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3298828">//&nbsp;Template:</span><br>
<span class="lineno">510</span><span class="comment" id="3298841">//&nbsp;&nbsp;&nbsp;&nbsp{{template&nbsp;stringValue&nbsp;pipeline}}</span><br>
<span class="lineno"></span><span class="comment" id="3298878">//&nbsp;Template&nbsp;keyword&nbsp;is&nbsp;past.&nbsp;&nbsp;The&nbsp;name&nbsp;must&nbsp;be&nbsp;something&nbsp;that&nbsp;can&nbsp;evaluate</span><br>
<span class="lineno"></span><span class="comment" id="3298953">//&nbsp;to&nbsp;a&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="3298969">func</span>&nbsp;<span class="op" id="3298974">(</span><span class="ident" id="3298975">t</span>&nbsp;<span class="op" id="3298977">*</span><span class="ident" id="3298978">Tree</span><span class="op" id="3298982">)</span>&nbsp;<span class="ident" id="3298984">templateControl</span><span class="op" id="3298999">(</span><span class="op" id="3299000">)</span>&nbsp;<span class="ident" id="3299002">Node</span>&nbsp;<span class="op" id="3299007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299010">var</span>&nbsp;<span class="ident" id="3299014">name</span>&nbsp;<span class="builtintype" id="3299019">string</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299027">token</span>&nbsp;<span class="op" id="3299033">:=</span>&nbsp;<span class="ident" id="3299036">t</span><span class="op" id="3299037">.</span><span class="ident" id="3299038">nextNonSpace</span><span class="op" id="3299050">(</span><span class="op" id="3299051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299054">switch</span>&nbsp;<span class="ident" id="3299061">token</span><span class="op" id="3299066">.</span><span class="ident" id="3299067">typ</span>&nbsp;<span class="op" id="3299071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299074">case</span>&nbsp;<span class="ident" id="3299079">itemString</span><span class="op" id="3299089">,</span>&nbsp;<span class="ident" id="3299091">itemRawString</span><span class="op" id="3299104">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299108">s</span><span class="op" id="3299109">,</span>&nbsp;<span class="ident" id="3299111">err</span>&nbsp;<span class="op" id="3299115">:=</span>&nbsp;<span class="ident" id="3299118">strconv</span><span class="op" id="3299125">.</span><span class="ident" id="3299126">Unquote</span><span class="op" id="3299133">(</span><span class="ident" id="3299134">token</span><span class="op" id="3299139">.</span><span class="ident" id="3299140">val</span><span class="op" id="3299143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299147">if</span>&nbsp;<span class="ident" id="3299150">err</span>&nbsp;<span class="op" id="3299154">!=</span>&nbsp;<span class="ident" id="3299157">nil</span>&nbsp;<span class="op" id="3299161">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299166">t</span><span class="op" id="3299167">.</span><span class="builtintype" id="3299168">error</span><span class="op" id="3299173">(</span><span class="ident" id="3299174">err</span><span class="op" id="3299177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299185">name</span>&nbsp;<span class="op" id="3299190">=</span>&nbsp;<span class="ident" id="3299192">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299195">default</span><span class="op" id="3299202">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299206">t</span><span class="op" id="3299207">.</span><span class="ident" id="3299208">unexpected</span><span class="op" id="3299218">(</span><span class="ident" id="3299219">token</span><span class="op" id="3299224">,</span>&nbsp;<span class="string" id="3299226">&#34;template&nbsp;invocation&#34;</span><span class="op" id="3299247">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299253">var</span>&nbsp;<span class="ident" id="3299257">pipe</span>&nbsp;<span class="op" id="3299262">*</span><span class="ident" id="3299263">PipeNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299273">if</span>&nbsp;<span class="ident" id="3299276">t</span><span class="op" id="3299277">.</span><span class="ident" id="3299278">nextNonSpace</span><span class="op" id="3299290">(</span><span class="op" id="3299291">)</span><span class="op" id="3299292">.</span><span class="ident" id="3299293">typ</span>&nbsp;<span class="op" id="3299297">!=</span>&nbsp;<span class="ident" id="3299300">itemRightDelim</span>&nbsp;<span class="op" id="3299315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299319">t</span><span class="op" id="3299320">.</span><span class="ident" id="3299321">backup</span><span class="op" id="3299327">(</span><span class="op" id="3299328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3299332">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299385">pipe</span>&nbsp;<span class="op" id="3299390">=</span>&nbsp;<span class="ident" id="3299392">t</span><span class="op" id="3299393">.</span><span class="ident" id="3299394">pipeline</span><span class="op" id="3299402">(</span><span class="string" id="3299403">&#34;template&#34;</span><span class="op" id="3299413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299419">return</span>&nbsp;<span class="ident" id="3299426">t</span><span class="op" id="3299427">.</span><span class="ident" id="3299428">newTemplate</span><span class="op" id="3299439">(</span><span class="ident" id="3299440">token</span><span class="op" id="3299445">.</span><span class="ident" id="3299446">pos</span><span class="op" id="3299449">,</span>&nbsp;<span class="ident" id="3299451">t</span><span class="op" id="3299452">.</span><span class="ident" id="3299453">lex</span><span class="op" id="3299456">.</span><span class="ident" id="3299457">lineNumber</span><span class="op" id="3299467">(</span><span class="op" id="3299468">)</span><span class="op" id="3299469">,</span>&nbsp;<span class="ident" id="3299471">name</span><span class="op" id="3299475">,</span>&nbsp;<span class="ident" id="3299477">pipe</span><span class="op" id="3299481">)</span><br>
<span class="lineno"></span><span class="op" id="3299483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="comment" id="3299486">//&nbsp;command:</span><br>
<span class="lineno"></span><span class="comment" id="3299498">//&nbsp;&nbsp;&nbsp;&nbspoperand&nbsp;(space&nbsp;operand)*</span><br>
<span class="lineno"></span><span class="comment" id="3299526">//&nbsp;space-separated&nbsp;arguments&nbsp;up&nbsp;to&nbsp;a&nbsp;pipeline&nbsp;character&nbsp;or&nbsp;right&nbsp;delimiter.</span><br>
<span class="lineno"></span><span class="comment" id="3299602">//&nbsp;we&nbsp;consume&nbsp;the&nbsp;pipe&nbsp;character&nbsp;but&nbsp;leave&nbsp;the&nbsp;right&nbsp;delim&nbsp;to&nbsp;terminate&nbsp;the&nbsp;action.</span><br>
<span class="lineno"></span><span class="keyword" id="3299686">func</span>&nbsp;<span class="op" id="3299691">(</span><span class="ident" id="3299692">t</span>&nbsp;<span class="op" id="3299694">*</span><span class="ident" id="3299695">Tree</span><span class="op" id="3299699">)</span>&nbsp;<span class="ident" id="3299701">command</span><span class="op" id="3299708">(</span><span class="op" id="3299709">)</span>&nbsp;<span class="op" id="3299711">*</span><span class="ident" id="3299712">CommandNode</span>&nbsp;<span class="op" id="3299724">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299727">cmd</span>&nbsp;<span class="op" id="3299731">:=</span>&nbsp;<span class="ident" id="3299734">t</span><span class="op" id="3299735">.</span><span class="ident" id="3299736">newCommand</span><span class="op" id="3299746">(</span><span class="ident" id="3299747">t</span><span class="op" id="3299748">.</span><span class="ident" id="3299749">peekNonSpace</span><span class="op" id="3299761">(</span><span class="op" id="3299762">)</span><span class="op" id="3299763">.</span><span class="ident" id="3299764">pos</span><span class="op" id="3299767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299770">for</span>&nbsp;<span class="op" id="3299774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299778">t</span><span class="op" id="3299779">.</span><span class="ident" id="3299780">peekNonSpace</span><span class="op" id="3299792">(</span><span class="op" id="3299793">)</span>&nbsp;<span class="comment" id="3299795">//&nbsp;skip&nbsp;leading&nbsp;spaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299821">operand</span>&nbsp;<span class="op" id="3299829">:=</span>&nbsp;<span class="ident" id="3299832">t</span><span class="op" id="3299833">.</span><span class="ident" id="3299834">operand</span><span class="op" id="3299841">(</span><span class="op" id="3299842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299846">if</span>&nbsp;<span class="ident" id="3299849">operand</span>&nbsp;<span class="op" id="3299857">!=</span>&nbsp;<span class="ident" id="3299860">nil</span>&nbsp;<span class="op" id="3299864">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299869">cmd</span><span class="op" id="3299872">.</span><span class="builtinfunc" id="3299873">append</span><span class="op" id="3299879">(</span><span class="ident" id="3299880">operand</span><span class="op" id="3299887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299895">switch</span>&nbsp;<span class="ident" id="3299902">token</span>&nbsp;<span class="op" id="3299908">:=</span>&nbsp;<span class="ident" id="3299911">t</span><span class="op" id="3299912">.</span><span class="ident" id="3299913">next</span><span class="op" id="3299917">(</span><span class="op" id="3299918">)</span><span class="op" id="3299919">;</span>&nbsp;<span class="ident" id="3299921">token</span><span class="op" id="3299926">.</span><span class="ident" id="3299927">typ</span>&nbsp;<span class="op" id="3299931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299935">case</span>&nbsp;<span class="ident" id="3299940">itemSpace</span><span class="op" id="3299949">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299954">continue</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299965">case</span>&nbsp;<span class="ident" id="3299970">itemError</span><span class="op" id="3299979">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299984">t</span><span class="op" id="3299985">.</span><span class="ident" id="3299986">errorf</span><span class="op" id="3299992">(</span><span class="string" id="3299993">&#34;%s&#34;</span><span class="op" id="3299997">,</span>&nbsp;<span class="ident" id="3299999">token</span><span class="op" id="3300004">.</span><span class="ident" id="3300005">val</span><span class="op" id="3300008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300012">case</span>&nbsp;<span class="ident" id="3300017">itemRightDelim</span><span class="op" id="3300031">,</span>&nbsp;<span class="ident" id="3300033">itemRightParen</span><span class="op" id="3300047">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300052">t</span><span class="op" id="3300053">.</span><span class="ident" id="3300054">backup</span><span class="op" id="3300060">(</span><span class="op" id="3300061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300065">case</span>&nbsp;<span class="ident" id="3300070">itemPipe</span><span class="op" id="3300078">:</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300082">default</span><span class="op" id="3300089">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300094">t</span><span class="op" id="3300095">.</span><span class="ident" id="3300096">errorf</span><span class="op" id="3300102">(</span><span class="string" id="3300103">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;operand;&nbsp;missing&nbsp;space?&#34;</span><span class="op" id="3300145">,</span>&nbsp;<span class="ident" id="3300147">token</span><span class="op" id="3300152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300160">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300167">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300170">if</span>&nbsp;<span class="builtinfunc" id="3300173">len</span><span class="op" id="3300176">(</span><span class="ident" id="3300177">cmd</span><span class="op" id="3300180">.</span><span class="ident" id="3300181">Args</span><span class="op" id="3300185">)</span>&nbsp;<span class="op" id="3300187">==</span>&nbsp;<span class="num" id="3300190">0</span>&nbsp;<span class="op" id="3300192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300196">t</span><span class="op" id="3300197">.</span><span class="ident" id="3300198">errorf</span><span class="op" id="3300204">(</span><span class="string" id="3300205">&#34;empty&nbsp;command&#34;</span><span class="op" id="3300220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300226">return</span>&nbsp;<span class="ident" id="3300233">cmd</span><br>
<span class="lineno"></span><span class="op" id="3300237">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="comment" id="3300240">//&nbsp;operand:</span><br>
<span class="lineno"></span><span class="comment" id="3300252">//&nbsp;&nbsp;&nbsp;&nbspterm&nbsp;.Field*</span><br>
<span class="lineno"></span><span class="comment" id="3300268">//&nbsp;An&nbsp;operand&nbsp;is&nbsp;a&nbsp;space-separated&nbsp;component&nbsp;of&nbsp;a&nbsp;command,</span><br>
<span class="lineno"></span><span class="comment" id="3300327">//&nbsp;a&nbsp;term&nbsp;possibly&nbsp;followed&nbsp;by&nbsp;field&nbsp;accesses.</span><br>
<span class="lineno">570</span><span class="comment" id="3300374">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;an&nbsp;operand.</span><br>
<span class="lineno"></span><span class="keyword" id="3300429">func</span>&nbsp;<span class="op" id="3300434">(</span><span class="ident" id="3300435">t</span>&nbsp;<span class="op" id="3300437">*</span><span class="ident" id="3300438">Tree</span><span class="op" id="3300442">)</span>&nbsp;<span class="ident" id="3300444">operand</span><span class="op" id="3300451">(</span><span class="op" id="3300452">)</span>&nbsp;<span class="ident" id="3300454">Node</span>&nbsp;<span class="op" id="3300459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300462">node</span>&nbsp;<span class="op" id="3300467">:=</span>&nbsp;<span class="ident" id="3300470">t</span><span class="op" id="3300471">.</span><span class="ident" id="3300472">term</span><span class="op" id="3300476">(</span><span class="op" id="3300477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300480">if</span>&nbsp;<span class="ident" id="3300483">node</span>&nbsp;<span class="op" id="3300488">==</span>&nbsp;<span class="ident" id="3300491">nil</span>&nbsp;<span class="op" id="3300495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300499">return</span>&nbsp;<span class="ident" id="3300506">nil</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300514">if</span>&nbsp;<span class="ident" id="3300517">t</span><span class="op" id="3300518">.</span><span class="ident" id="3300519">peek</span><span class="op" id="3300523">(</span><span class="op" id="3300524">)</span><span class="op" id="3300525">.</span><span class="ident" id="3300526">typ</span>&nbsp;<span class="op" id="3300530">==</span>&nbsp;<span class="ident" id="3300533">itemField</span>&nbsp;<span class="op" id="3300543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300547">chain</span>&nbsp;<span class="op" id="3300553">:=</span>&nbsp;<span class="ident" id="3300556">t</span><span class="op" id="3300557">.</span><span class="ident" id="3300558">newChain</span><span class="op" id="3300566">(</span><span class="ident" id="3300567">t</span><span class="op" id="3300568">.</span><span class="ident" id="3300569">peek</span><span class="op" id="3300573">(</span><span class="op" id="3300574">)</span><span class="op" id="3300575">.</span><span class="ident" id="3300576">pos</span><span class="op" id="3300579">,</span>&nbsp;<span class="ident" id="3300581">node</span><span class="op" id="3300585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300589">for</span>&nbsp;<span class="ident" id="3300593">t</span><span class="op" id="3300594">.</span><span class="ident" id="3300595">peek</span><span class="op" id="3300599">(</span><span class="op" id="3300600">)</span><span class="op" id="3300601">.</span><span class="ident" id="3300602">typ</span>&nbsp;<span class="op" id="3300606">==</span>&nbsp;<span class="ident" id="3300609">itemField</span>&nbsp;<span class="op" id="3300619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300624">chain</span><span class="op" id="3300629">.</span><span class="ident" id="3300630">Add</span><span class="op" id="3300633">(</span><span class="ident" id="3300634">t</span><span class="op" id="3300635">.</span><span class="ident" id="3300636">next</span><span class="op" id="3300640">(</span><span class="op" id="3300641">)</span><span class="op" id="3300642">.</span><span class="ident" id="3300643">val</span><span class="op" id="3300646">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3300654">//&nbsp;Compatibility&nbsp;with&nbsp;original&nbsp;API:&nbsp;If&nbsp;the&nbsp;term&nbsp;is&nbsp;of&nbsp;type&nbsp;NodeField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3300725">//&nbsp;or&nbsp;NodeVariable,&nbsp;just&nbsp;put&nbsp;more&nbsp;fields&nbsp;on&nbsp;the&nbsp;original.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3300785">//&nbsp;Otherwise,&nbsp;keep&nbsp;the&nbsp;Chain&nbsp;node.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3300822">//&nbsp;TODO:&nbsp;Switch&nbsp;to&nbsp;Chains&nbsp;always&nbsp;when&nbsp;we&nbsp;can.</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300870">switch</span>&nbsp;<span class="ident" id="3300877">node</span><span class="op" id="3300881">.</span><span class="ident" id="3300882">Type</span><span class="op" id="3300886">(</span><span class="op" id="3300887">)</span>&nbsp;<span class="op" id="3300889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300893">case</span>&nbsp;<span class="ident" id="3300898">NodeField</span><span class="op" id="3300907">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300912">node</span>&nbsp;<span class="op" id="3300917">=</span>&nbsp;<span class="ident" id="3300919">t</span><span class="op" id="3300920">.</span><span class="ident" id="3300921">newField</span><span class="op" id="3300929">(</span><span class="ident" id="3300930">chain</span><span class="op" id="3300935">.</span><span class="ident" id="3300936">Position</span><span class="op" id="3300944">(</span><span class="op" id="3300945">)</span><span class="op" id="3300946">,</span>&nbsp;<span class="ident" id="3300948">chain</span><span class="op" id="3300953">.</span><span class="ident" id="3300954">String</span><span class="op" id="3300960">(</span><span class="op" id="3300961">)</span><span class="op" id="3300962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300966">case</span>&nbsp;<span class="ident" id="3300971">NodeVariable</span><span class="op" id="3300983">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300988">node</span>&nbsp;<span class="op" id="3300993">=</span>&nbsp;<span class="ident" id="3300995">t</span><span class="op" id="3300996">.</span><span class="ident" id="3300997">newVariable</span><span class="op" id="3301008">(</span><span class="ident" id="3301009">chain</span><span class="op" id="3301014">.</span><span class="ident" id="3301015">Position</span><span class="op" id="3301023">(</span><span class="op" id="3301024">)</span><span class="op" id="3301025">,</span>&nbsp;<span class="ident" id="3301027">chain</span><span class="op" id="3301032">.</span><span class="ident" id="3301033">String</span><span class="op" id="3301039">(</span><span class="op" id="3301040">)</span><span class="op" id="3301041">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301045">default</span><span class="op" id="3301052">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3301057">node</span>&nbsp;<span class="op" id="3301062">=</span>&nbsp;<span class="ident" id="3301064">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3301072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3301075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301078">return</span>&nbsp;<span class="ident" id="3301085">node</span><br>
<span class="lineno">595</span><span class="op" id="3301090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3301093">//&nbsp;term:</span><br>
<span class="lineno"></span><span class="comment" id="3301102">//&nbsp;&nbsp;&nbsp;&nbspliteral&nbsp;(number,&nbsp;string,&nbsp;nil,&nbsp;boolean)</span><br>
<span class="lineno"></span><span class="comment" id="3301144">//&nbsp;&nbsp;&nbsp;&nbspfunction&nbsp;(identifier)</span><br>
<span class="lineno">600</span><span class="comment" id="3301169">//&nbsp;&nbsp;&nbsp;&nbsp.</span><br>
<span class="lineno"></span><span class="comment" id="3301174">//&nbsp;&nbsp;&nbsp;&nbsp.Field</span><br>
<span class="lineno"></span><span class="comment" id="3301184">//&nbsp;&nbsp;&nbsp;&nbsp$</span><br>
<span class="lineno"></span><span class="comment" id="3301189">//&nbsp;&nbsp;&nbsp;&nbsp&#39;(&#39;&nbsp;pipeline&nbsp;&#39;)&#39;</span><br>
<span class="lineno"></span><span class="comment" id="3301209">//&nbsp;A&nbsp;term&nbsp;is&nbsp;a&nbsp;simple&nbsp;&#34;expression&#34;.</span><br>
<span class="lineno">605</span><span class="comment" id="3301245">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;a&nbsp;term.</span><br>
<span class="lineno"></span><span class="keyword" id="3301296">func</span>&nbsp;<span class="op" id="3301301">(</span><span class="ident" id="3301302">t</span>&nbsp;<span class="op" id="3301304">*</span><span class="ident" id="3301305">Tree</span><span class="op" id="3301309">)</span>&nbsp;<span class="ident" id="3301311">term</span><span class="op" id="3301315">(</span><span class="op" id="3301316">)</span>&nbsp;<span class="ident" id="3301318">Node</span>&nbsp;<span class="op" id="3301323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301326">switch</span>&nbsp;<span class="ident" id="3301333">token</span>&nbsp;<span class="op" id="3301339">:=</span>&nbsp;<span class="ident" id="3301342">t</span><span class="op" id="3301343">.</span><span class="ident" id="3301344">nextNonSpace</span><span class="op" id="3301356">(</span><span class="op" id="3301357">)</span><span class="op" id="3301358">;</span>&nbsp;<span class="ident" id="3301360">token</span><span class="op" id="3301365">.</span><span class="ident" id="3301366">typ</span>&nbsp;<span class="op" id="3301370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301373">case</span>&nbsp;<span class="ident" id="3301378">itemError</span><span class="op" id="3301387">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3301391">t</span><span class="op" id="3301392">.</span><span class="ident" id="3301393">errorf</span><span class="op" id="3301399">(</span><span class="string" id="3301400">&#34;%s&#34;</span><span class="op" id="3301404">,</span>&nbsp;<span class="ident" id="3301406">token</span><span class="op" id="3301411">.</span><span class="ident" id="3301412">val</span><span class="op" id="3301415">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301418">case</span>&nbsp;<span class="ident" id="3301423">itemIdentifier</span><span class="op" id="3301437">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301441">if</span>&nbsp;<span class="op" id="3301444">!</span><span class="ident" id="3301445">t</span><span class="op" id="3301446">.</span><span class="ident" id="3301447">hasFunction</span><span class="op" id="3301458">(</span><span class="ident" id="3301459">token</span><span class="op" id="3301464">.</span><span class="ident" id="3301465">val</span><span class="op" id="3301468">)</span>&nbsp;<span class="op" id="3301470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3301475">t</span><span class="op" id="3301476">.</span><span class="ident" id="3301477">errorf</span><span class="op" id="3301483">(</span><span class="string" id="3301484">&#34;function&nbsp;%q&nbsp;not&nbsp;defined&#34;</span><span class="op" id="3301509">,</span>&nbsp;<span class="ident" id="3301511">token</span><span class="op" id="3301516">.</span><span class="ident" id="3301517">val</span><span class="op" id="3301520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3301524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301528">return</span>&nbsp;<span class="ident" id="3301535">NewIdentifier</span><span class="op" id="3301548">(</span><span class="ident" id="3301549">token</span><span class="op" id="3301554">.</span><span class="ident" id="3301555">val</span><span class="op" id="3301558">)</span><span class="op" id="3301559">.</span><span class="ident" id="3301560">SetTree</span><span class="op" id="3301567">(</span><span class="ident" id="3301568">t</span><span class="op" id="3301569">)</span><span class="op" id="3301570">.</span><span class="ident" id="3301571">SetPos</span><span class="op" id="3301577">(</span><span class="ident" id="3301578">token</span><span class="op" id="3301583">.</span><span class="ident" id="3301584">pos</span><span class="op" id="3301587">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301590">case</span>&nbsp;<span class="ident" id="3301595">itemDot</span><span class="op" id="3301602">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301606">return</span>&nbsp;<span class="ident" id="3301613">t</span><span class="op" id="3301614">.</span><span class="ident" id="3301615">newDot</span><span class="op" id="3301621">(</span><span class="ident" id="3301622">token</span><span class="op" id="3301627">.</span><span class="ident" id="3301628">pos</span><span class="op" id="3301631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301634">case</span>&nbsp;<span class="ident" id="3301639">itemNil</span><span class="op" id="3301646">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301650">return</span>&nbsp;<span class="ident" id="3301657">t</span><span class="op" id="3301658">.</span><span class="ident" id="3301659">newNil</span><span class="op" id="3301665">(</span><span class="ident" id="3301666">token</span><span class="op" id="3301671">.</span><span class="ident" id="3301672">pos</span><span class="op" id="3301675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301678">case</span>&nbsp;<span class="ident" id="3301683">itemVariable</span><span class="op" id="3301695">:</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301699">return</span>&nbsp;<span class="ident" id="3301706">t</span><span class="op" id="3301707">.</span><span class="ident" id="3301708">useVar</span><span class="op" id="3301714">(</span><span class="ident" id="3301715">token</span><span class="op" id="3301720">.</span><span class="ident" id="3301721">pos</span><span class="op" id="3301724">,</span>&nbsp;<span class="ident" id="3301726">token</span><span class="op" id="3301731">.</span><span class="ident" id="3301732">val</span><span class="op" id="3301735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301738">case</span>&nbsp;<span class="ident" id="3301743">itemField</span><span class="op" id="3301752">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301756">return</span>&nbsp;<span class="ident" id="3301763">t</span><span class="op" id="3301764">.</span><span class="ident" id="3301765">newField</span><span class="op" id="3301773">(</span><span class="ident" id="3301774">token</span><span class="op" id="3301779">.</span><span class="ident" id="3301780">pos</span><span class="op" id="3301783">,</span>&nbsp;<span class="ident" id="3301785">token</span><span class="op" id="3301790">.</span><span class="ident" id="3301791">val</span><span class="op" id="3301794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301797">case</span>&nbsp;<span class="ident" id="3301802">itemBool</span><span class="op" id="3301810">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301814">return</span>&nbsp;<span class="ident" id="3301821">t</span><span class="op" id="3301822">.</span><span class="ident" id="3301823">newBool</span><span class="op" id="3301830">(</span><span class="ident" id="3301831">token</span><span class="op" id="3301836">.</span><span class="ident" id="3301837">pos</span><span class="op" id="3301840">,</span>&nbsp;<span class="ident" id="3301842">token</span><span class="op" id="3301847">.</span><span class="ident" id="3301848">val</span>&nbsp;<span class="op" id="3301852">==</span>&nbsp;<span class="string" id="3301855">&#34;true&#34;</span><span class="op" id="3301861">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301864">case</span>&nbsp;<span class="ident" id="3301869">itemCharConstant</span><span class="op" id="3301885">,</span>&nbsp;<span class="ident" id="3301887">itemComplex</span><span class="op" id="3301898">,</span>&nbsp;<span class="ident" id="3301900">itemNumber</span><span class="op" id="3301910">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3301914">number</span><span class="op" id="3301920">,</span>&nbsp;<span class="ident" id="3301922">err</span>&nbsp;<span class="op" id="3301926">:=</span>&nbsp;<span class="ident" id="3301929">t</span><span class="op" id="3301930">.</span><span class="ident" id="3301931">newNumber</span><span class="op" id="3301940">(</span><span class="ident" id="3301941">token</span><span class="op" id="3301946">.</span><span class="ident" id="3301947">pos</span><span class="op" id="3301950">,</span>&nbsp;<span class="ident" id="3301952">token</span><span class="op" id="3301957">.</span><span class="ident" id="3301958">val</span><span class="op" id="3301961">,</span>&nbsp;<span class="ident" id="3301963">token</span><span class="op" id="3301968">.</span><span class="ident" id="3301969">typ</span><span class="op" id="3301972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301976">if</span>&nbsp;<span class="ident" id="3301979">err</span>&nbsp;<span class="op" id="3301983">!=</span>&nbsp;<span class="ident" id="3301986">nil</span>&nbsp;<span class="op" id="3301990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3301995">t</span><span class="op" id="3301996">.</span><span class="builtintype" id="3301997">error</span><span class="op" id="3302002">(</span><span class="ident" id="3302003">err</span><span class="op" id="3302006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3302010">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302014">return</span>&nbsp;<span class="ident" id="3302021">number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302029">case</span>&nbsp;<span class="ident" id="3302034">itemLeftParen</span><span class="op" id="3302047">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302051">pipe</span>&nbsp;<span class="op" id="3302056">:=</span>&nbsp;<span class="ident" id="3302059">t</span><span class="op" id="3302060">.</span><span class="ident" id="3302061">pipeline</span><span class="op" id="3302069">(</span><span class="string" id="3302070">&#34;parenthesized&nbsp;pipeline&#34;</span><span class="op" id="3302094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302098">if</span>&nbsp;<span class="ident" id="3302101">token</span>&nbsp;<span class="op" id="3302107">:=</span>&nbsp;<span class="ident" id="3302110">t</span><span class="op" id="3302111">.</span><span class="ident" id="3302112">next</span><span class="op" id="3302116">(</span><span class="op" id="3302117">)</span><span class="op" id="3302118">;</span>&nbsp;<span class="ident" id="3302120">token</span><span class="op" id="3302125">.</span><span class="ident" id="3302126">typ</span>&nbsp;<span class="op" id="3302130">!=</span>&nbsp;<span class="ident" id="3302133">itemRightParen</span>&nbsp;<span class="op" id="3302148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302153">t</span><span class="op" id="3302154">.</span><span class="ident" id="3302155">errorf</span><span class="op" id="3302161">(</span><span class="string" id="3302162">&#34;unclosed&nbsp;right&nbsp;paren:&nbsp;unexpected&nbsp;%s&#34;</span><span class="op" id="3302199">,</span>&nbsp;<span class="ident" id="3302201">token</span><span class="op" id="3302206">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3302210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302214">return</span>&nbsp;<span class="ident" id="3302221">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302227">case</span>&nbsp;<span class="ident" id="3302232">itemString</span><span class="op" id="3302242">,</span>&nbsp;<span class="ident" id="3302244">itemRawString</span><span class="op" id="3302257">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302261">s</span><span class="op" id="3302262">,</span>&nbsp;<span class="ident" id="3302264">err</span>&nbsp;<span class="op" id="3302268">:=</span>&nbsp;<span class="ident" id="3302271">strconv</span><span class="op" id="3302278">.</span><span class="ident" id="3302279">Unquote</span><span class="op" id="3302286">(</span><span class="ident" id="3302287">token</span><span class="op" id="3302292">.</span><span class="ident" id="3302293">val</span><span class="op" id="3302296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302300">if</span>&nbsp;<span class="ident" id="3302303">err</span>&nbsp;<span class="op" id="3302307">!=</span>&nbsp;<span class="ident" id="3302310">nil</span>&nbsp;<span class="op" id="3302314">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302319">t</span><span class="op" id="3302320">.</span><span class="builtintype" id="3302321">error</span><span class="op" id="3302326">(</span><span class="ident" id="3302327">err</span><span class="op" id="3302330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3302334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302338">return</span>&nbsp;<span class="ident" id="3302345">t</span><span class="op" id="3302346">.</span><span class="ident" id="3302347">newString</span><span class="op" id="3302356">(</span><span class="ident" id="3302357">token</span><span class="op" id="3302362">.</span><span class="ident" id="3302363">pos</span><span class="op" id="3302366">,</span>&nbsp;<span class="ident" id="3302368">token</span><span class="op" id="3302373">.</span><span class="ident" id="3302374">val</span><span class="op" id="3302377">,</span>&nbsp;<span class="ident" id="3302379">s</span><span class="op" id="3302380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3302383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302386">t</span><span class="op" id="3302387">.</span><span class="ident" id="3302388">backup</span><span class="op" id="3302394">(</span><span class="op" id="3302395">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302398">return</span>&nbsp;<span class="ident" id="3302405">nil</span><br>
<span class="lineno"></span><span class="op" id="3302409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3302412">//&nbsp;hasFunction&nbsp;reports&nbsp;if&nbsp;a&nbsp;function&nbsp;name&nbsp;exists&nbsp;in&nbsp;the&nbsp;Tree&#39;s&nbsp;maps.</span><br>
<span class="lineno"></span><span class="keyword" id="3302481">func</span>&nbsp;<span class="op" id="3302486">(</span><span class="ident" id="3302487">t</span>&nbsp;<span class="op" id="3302489">*</span><span class="ident" id="3302490">Tree</span><span class="op" id="3302494">)</span>&nbsp;<span class="ident" id="3302496">hasFunction</span><span class="op" id="3302507">(</span><span class="ident" id="3302508">name</span>&nbsp;<span class="builtintype" id="3302513">string</span><span class="op" id="3302519">)</span>&nbsp;<span class="builtintype" id="3302521">bool</span>&nbsp;<span class="op" id="3302526">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302529">for</span>&nbsp;<span class="ident" id="3302533">_</span><span class="op" id="3302534">,</span>&nbsp;<span class="ident" id="3302536">funcMap</span>&nbsp;<span class="op" id="3302544">:=</span>&nbsp;<span class="keyword" id="3302547">range</span>&nbsp;<span class="ident" id="3302553">t</span><span class="op" id="3302554">.</span><span class="ident" id="3302555">funcs</span>&nbsp;<span class="op" id="3302561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302565">if</span>&nbsp;<span class="ident" id="3302568">funcMap</span>&nbsp;<span class="op" id="3302576">==</span>&nbsp;<span class="ident" id="3302579">nil</span>&nbsp;<span class="op" id="3302583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302588">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3302599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302603">if</span>&nbsp;<span class="ident" id="3302606">funcMap</span><span class="op" id="3302613">[</span><span class="ident" id="3302614">name</span><span class="op" id="3302618">]</span>&nbsp;<span class="op" id="3302620">!=</span>&nbsp;<span class="ident" id="3302623">nil</span>&nbsp;<span class="op" id="3302627">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302632">return</span>&nbsp;<span class="builtintype" id="3302639">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3302646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3302649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302652">return</span>&nbsp;<span class="builtintype" id="3302659">false</span><br>
<span class="lineno"></span><span class="op" id="3302665">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="comment" id="3302668">//&nbsp;popVars&nbsp;trims&nbsp;the&nbsp;variable&nbsp;list&nbsp;to&nbsp;the&nbsp;specified&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="3302727">func</span>&nbsp;<span class="op" id="3302732">(</span><span class="ident" id="3302733">t</span>&nbsp;<span class="op" id="3302735">*</span><span class="ident" id="3302736">Tree</span><span class="op" id="3302740">)</span>&nbsp;<span class="ident" id="3302742">popVars</span><span class="op" id="3302749">(</span><span class="ident" id="3302750">n</span>&nbsp;<span class="builtintype" id="3302752">int</span><span class="op" id="3302755">)</span>&nbsp;<span class="op" id="3302757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302760">t</span><span class="op" id="3302761">.</span><span class="ident" id="3302762">vars</span>&nbsp;<span class="op" id="3302767">=</span>&nbsp;<span class="ident" id="3302769">t</span><span class="op" id="3302770">.</span><span class="ident" id="3302771">vars</span><span class="op" id="3302775">[</span><span class="op" id="3302776">:</span><span class="ident" id="3302777">n</span><span class="op" id="3302778">]</span><br>
<span class="lineno"></span><span class="op" id="3302780">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="3302783">//&nbsp;useVar&nbsp;returns&nbsp;a&nbsp;node&nbsp;for&nbsp;a&nbsp;variable&nbsp;reference.&nbsp;It&nbsp;errors&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3302851">//&nbsp;variable&nbsp;is&nbsp;not&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="3302879">func</span>&nbsp;<span class="op" id="3302884">(</span><span class="ident" id="3302885">t</span>&nbsp;<span class="op" id="3302887">*</span><span class="ident" id="3302888">Tree</span><span class="op" id="3302892">)</span>&nbsp;<span class="ident" id="3302894">useVar</span><span class="op" id="3302900">(</span><span class="ident" id="3302901">pos</span>&nbsp;<span class="ident" id="3302905">Pos</span><span class="op" id="3302908">,</span>&nbsp;<span class="ident" id="3302910">name</span>&nbsp;<span class="builtintype" id="3302915">string</span><span class="op" id="3302921">)</span>&nbsp;<span class="ident" id="3302923">Node</span>&nbsp;<span class="op" id="3302928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302931">v</span>&nbsp;<span class="op" id="3302933">:=</span>&nbsp;<span class="ident" id="3302936">t</span><span class="op" id="3302937">.</span><span class="ident" id="3302938">newVariable</span><span class="op" id="3302949">(</span><span class="ident" id="3302950">pos</span><span class="op" id="3302953">,</span>&nbsp;<span class="ident" id="3302955">name</span><span class="op" id="3302959">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302962">for</span>&nbsp;<span class="ident" id="3302966">_</span><span class="op" id="3302967">,</span>&nbsp;<span class="ident" id="3302969">varName</span>&nbsp;<span class="op" id="3302977">:=</span>&nbsp;<span class="keyword" id="3302980">range</span>&nbsp;<span class="ident" id="3302986">t</span><span class="op" id="3302987">.</span><span class="ident" id="3302988">vars</span>&nbsp;<span class="op" id="3302993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302997">if</span>&nbsp;<span class="ident" id="3303000">varName</span>&nbsp;<span class="op" id="3303008">==</span>&nbsp;<span class="ident" id="3303011">v</span><span class="op" id="3303012">.</span><span class="ident" id="3303013">Ident</span><span class="op" id="3303018">[</span><span class="num" id="3303019">0</span><span class="op" id="3303020">]</span>&nbsp;<span class="op" id="3303022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303027">return</span>&nbsp;<span class="ident" id="3303034">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3303038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3303041">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3303044">t</span><span class="op" id="3303045">.</span><span class="ident" id="3303046">errorf</span><span class="op" id="3303052">(</span><span class="string" id="3303053">&#34;undefined&nbsp;variable&nbsp;%q&#34;</span><span class="op" id="3303076">,</span>&nbsp;<span class="ident" id="3303078">v</span><span class="op" id="3303079">.</span><span class="ident" id="3303080">Ident</span><span class="op" id="3303085">[</span><span class="num" id="3303086">0</span><span class="op" id="3303087">]</span><span class="op" id="3303088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303091">return</span>&nbsp;<span class="ident" id="3303098">nil</span><br>
<span class="lineno"></span><span class="op" id="3303102">}</span>
</div>
</body>
</html>
