<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html" class="current">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1578718">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1578773">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1578827">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1578878">//&nbsp;Malloc&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1578899">//&nbsp;Patterned&nbsp;after&nbsp;tcmalloc&#39;s&nbsp;algorithms;&nbsp;shorter&nbsp;code.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1578956">package</span>&nbsp;<span class="ident" id="1578964">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1578973">import</span>&nbsp;<span class="op" id="1578980">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1578983">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1578992">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1578995">//&nbsp;NOTE(rsc):&nbsp;Everything&nbsp;here&nbsp;could&nbsp;use&nbsp;cas&nbsp;if&nbsp;contention&nbsp;became&nbsp;an&nbsp;issue.</span><br>
<span class="lineno">15</span><span class="keyword" id="1579070">var</span>&nbsp;<span class="ident" id="1579074">proflock</span>&nbsp;<span class="ident" id="1579083">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1579090">//&nbsp;All&nbsp;memory&nbsp;allocations&nbsp;are&nbsp;local&nbsp;and&nbsp;do&nbsp;not&nbsp;escape&nbsp;outside&nbsp;of&nbsp;the&nbsp;profiler.</span><br>
<span class="lineno"></span><span class="comment" id="1579169">//&nbsp;The&nbsp;profiler&nbsp;is&nbsp;forbidden&nbsp;from&nbsp;referring&nbsp;to&nbsp;garbage-collected&nbsp;memory.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1579243">const</span>&nbsp;<span class="op" id="1579249">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1579252">//&nbsp;profile&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579270">memProfile</span>&nbsp;<span class="ident" id="1579281">bucketType</span>&nbsp;<span class="op" id="1579292">=</span>&nbsp;<span class="num" id="1579294">1</span>&nbsp;<span class="op" id="1579296">+</span>&nbsp;<span class="ident" id="1579298">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579304">blockProfile</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1579319">//&nbsp;size&nbsp;of&nbsp;bucket&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579349">buckHashSize</span>&nbsp;<span class="op" id="1579362">=</span>&nbsp;<span class="num" id="1579364">179999</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1579373">//&nbsp;max&nbsp;depth&nbsp;of&nbsp;stack&nbsp;to&nbsp;record&nbsp;in&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579416">maxStack</span>&nbsp;<span class="op" id="1579425">=</span>&nbsp;<span class="num" id="1579427">32</span><br>
<span class="lineno">30</span><span class="op" id="1579430">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1579433">type</span>&nbsp;<span class="ident" id="1579438">bucketType</span>&nbsp;<span class="builtintype" id="1579449">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1579454">//&nbsp;A&nbsp;bucket&nbsp;holds&nbsp;per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno">35</span><span class="comment" id="1579510">//&nbsp;The&nbsp;representation&nbsp;is&nbsp;a&nbsp;bit&nbsp;sleazy,&nbsp;inherited&nbsp;from&nbsp;C.</span><br>
<span class="lineno"></span><span class="comment" id="1579567">//&nbsp;This&nbsp;struct&nbsp;defines&nbsp;the&nbsp;bucket&nbsp;header.&nbsp;It&nbsp;is&nbsp;followed&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1579627">//&nbsp;memory&nbsp;by&nbsp;the&nbsp;stack&nbsp;words&nbsp;and&nbsp;then&nbsp;the&nbsp;actual&nbsp;record</span><br>
<span class="lineno"></span><span class="comment" id="1579683">//&nbsp;data,&nbsp;either&nbsp;a&nbsp;memRecord&nbsp;or&nbsp;a&nbsp;blockRecord.</span><br>
<span class="lineno"></span><span class="comment" id="1579729">//</span><br>
<span class="lineno">40</span><span class="comment" id="1579732">//&nbsp;Per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="1579773">//&nbsp;Lookup&nbsp;by&nbsp;hashing&nbsp;call&nbsp;stack&nbsp;into&nbsp;a&nbsp;linked-list&nbsp;hash&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="1579836">type</span>&nbsp;<span class="ident" id="1579841">bucket</span>&nbsp;<span class="keyword" id="1579848">struct</span>&nbsp;<span class="op" id="1579855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579858">next</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1579866">*</span><span class="ident" id="1579867">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579875">allnext</span>&nbsp;<span class="op" id="1579883">*</span><span class="ident" id="1579884">bucket</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579892">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579900">bucketType</span>&nbsp;<span class="comment" id="1579911">//&nbsp;memBucket&nbsp;or&nbsp;blockBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579940">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1579948">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579957">size</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1579965">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579974">nstk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1579982">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1579990">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="1579993">//&nbsp;A&nbsp;memRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;memProfile,</span><br>
<span class="lineno"></span><span class="comment" id="1580060">//&nbsp;part&nbsp;of&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1580091">type</span>&nbsp;<span class="ident" id="1580096">memRecord</span>&nbsp;<span class="keyword" id="1580106">struct</span>&nbsp;<span class="op" id="1580113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1580116">//&nbsp;The&nbsp;following&nbsp;complex&nbsp;3-stage&nbsp;scheme&nbsp;of&nbsp;stats&nbsp;accumulation</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1580179">//&nbsp;is&nbsp;required&nbsp;to&nbsp;obtain&nbsp;a&nbsp;consistent&nbsp;picture&nbsp;of&nbsp;mallocs&nbsp;and&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1580247">//&nbsp;for&nbsp;some&nbsp;point&nbsp;in&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1580275">//&nbsp;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;mallocs&nbsp;come&nbsp;in&nbsp;real&nbsp;time,&nbsp;while&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1580338">//&nbsp;come&nbsp;only&nbsp;after&nbsp;a&nbsp;GC&nbsp;during&nbsp;concurrent&nbsp;sweeping.&nbsp;So&nbsp;if&nbsp;we&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1580406">//&nbsp;naively&nbsp;count&nbsp;them,&nbsp;we&nbsp;would&nbsp;get&nbsp;a&nbsp;skew&nbsp;toward&nbsp;mallocs.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1580466">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1580470">//&nbsp;Mallocs&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1580513">//&nbsp;Explicit&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1580563">//&nbsp;GC&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1580605">//&nbsp;After&nbsp;GC&nbsp;prev&nbsp;stats&nbsp;are&nbsp;added&nbsp;to&nbsp;final&nbsp;stats&nbsp;and</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1580658">//&nbsp;recent&nbsp;stats&nbsp;are&nbsp;moved&nbsp;into&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580702">allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1580714">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580723">frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1580735">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580744">alloc_bytes</span>&nbsp;<span class="builtintype" id="1580756">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580765">free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1580777">uintptr</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1580787">//&nbsp;changes&nbsp;between&nbsp;next-to-last&nbsp;GC&nbsp;and&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580835">prev_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1580852">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580861">prev_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1580878">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580887">prev_alloc_bytes</span>&nbsp;<span class="builtintype" id="1580904">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580913">prev_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1580930">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1580940">//&nbsp;changes&nbsp;since&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580966">recent_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1580985">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580994">recent_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1581013">uintptr</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581022">recent_alloc_bytes</span>&nbsp;<span class="builtintype" id="1581041">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581050">recent_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1581069">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1581077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1581080">//&nbsp;A&nbsp;blockRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;blockProfile,</span><br>
<span class="lineno">85</span><span class="comment" id="1581151">//&nbsp;part&nbsp;of&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1581184">type</span>&nbsp;<span class="ident" id="1581189">blockRecord</span>&nbsp;<span class="keyword" id="1581201">struct</span>&nbsp;<span class="op" id="1581208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581211">count</span>&nbsp;&nbsp;<span class="ident" id="1581218">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581225">cycles</span>&nbsp;<span class="ident" id="1581232">int64</span><br>
<span class="lineno"></span><span class="op" id="1581238">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="1581241">var</span>&nbsp;<span class="op" id="1581245">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581248">mbuckets</span>&nbsp;&nbsp;<span class="op" id="1581258">*</span><span class="ident" id="1581259">bucket</span>&nbsp;<span class="comment" id="1581266">//&nbsp;memory&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581293">bbuckets</span>&nbsp;&nbsp;<span class="op" id="1581303">*</span><span class="ident" id="1581304">bucket</span>&nbsp;<span class="comment" id="1581311">//&nbsp;blocking&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581340">buckhash</span>&nbsp;&nbsp;<span class="op" id="1581350">*</span><span class="op" id="1581351">[</span><span class="num" id="1581352">179999</span><span class="op" id="1581358">]</span><span class="op" id="1581359">*</span><span class="ident" id="1581360">bucket</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581368">bucketmem</span>&nbsp;<span class="builtintype" id="1581378">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1581386">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1581389">//&nbsp;newBucket&nbsp;allocates&nbsp;a&nbsp;bucket&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;number&nbsp;of&nbsp;stack&nbsp;entries.</span><br>
<span class="lineno"></span><span class="keyword" id="1581470">func</span>&nbsp;<span class="ident" id="1581475">newBucket</span><span class="op" id="1581484">(</span><span class="ident" id="1581485">typ</span>&nbsp;<span class="ident" id="1581489">bucketType</span><span class="op" id="1581499">,</span>&nbsp;<span class="ident" id="1581501">nstk</span>&nbsp;<span class="builtintype" id="1581506">int</span><span class="op" id="1581509">)</span>&nbsp;<span class="op" id="1581511">*</span><span class="ident" id="1581512">bucket</span>&nbsp;<span class="op" id="1581519">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581522">size</span>&nbsp;<span class="op" id="1581527">:=</span>&nbsp;<span class="ident" id="1581530">unsafe</span><span class="op" id="1581536">.</span><span class="ident" id="1581537">Sizeof</span><span class="op" id="1581543">(</span><span class="ident" id="1581544">bucket</span><span class="op" id="1581550">{</span><span class="op" id="1581551">}</span><span class="op" id="1581552">)</span>&nbsp;<span class="op" id="1581554">+</span>&nbsp;<span class="builtintype" id="1581556">uintptr</span><span class="op" id="1581563">(</span><span class="ident" id="1581564">nstk</span><span class="op" id="1581568">)</span><span class="op" id="1581569">*</span><span class="ident" id="1581570">unsafe</span><span class="op" id="1581576">.</span><span class="ident" id="1581577">Sizeof</span><span class="op" id="1581583">(</span><span class="builtintype" id="1581584">uintptr</span><span class="op" id="1581591">(</span><span class="num" id="1581592">0</span><span class="op" id="1581593">)</span><span class="op" id="1581594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1581597">switch</span>&nbsp;<span class="ident" id="1581604">typ</span>&nbsp;<span class="op" id="1581608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1581611">default</span><span class="op" id="1581618">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581622">gothrow</span><span class="op" id="1581629">(</span><span class="string" id="1581630">&#34;invalid&nbsp;profile&nbsp;bucket&nbsp;type&#34;</span><span class="op" id="1581659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1581662">case</span>&nbsp;<span class="ident" id="1581667">memProfile</span><span class="op" id="1581677">:</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581681">size</span>&nbsp;<span class="op" id="1581686">+=</span>&nbsp;<span class="ident" id="1581689">unsafe</span><span class="op" id="1581695">.</span><span class="ident" id="1581696">Sizeof</span><span class="op" id="1581702">(</span><span class="ident" id="1581703">memRecord</span><span class="op" id="1581712">{</span><span class="op" id="1581713">}</span><span class="op" id="1581714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1581717">case</span>&nbsp;<span class="ident" id="1581722">blockProfile</span><span class="op" id="1581734">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581738">size</span>&nbsp;<span class="op" id="1581743">+=</span>&nbsp;<span class="ident" id="1581746">unsafe</span><span class="op" id="1581752">.</span><span class="ident" id="1581753">Sizeof</span><span class="op" id="1581759">(</span><span class="ident" id="1581760">blockRecord</span><span class="op" id="1581771">{</span><span class="op" id="1581772">}</span><span class="op" id="1581773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1581776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581780">b</span>&nbsp;<span class="op" id="1581782">:=</span>&nbsp;<span class="op" id="1581785">(</span><span class="op" id="1581786">*</span><span class="ident" id="1581787">bucket</span><span class="op" id="1581793">)</span><span class="op" id="1581794">(</span><span class="ident" id="1581795">persistentalloc</span><span class="op" id="1581810">(</span><span class="ident" id="1581811">size</span><span class="op" id="1581815">,</span>&nbsp;<span class="num" id="1581817">0</span><span class="op" id="1581818">,</span>&nbsp;<span class="op" id="1581820">&amp;</span><span class="ident" id="1581821">memstats</span><span class="op" id="1581829">.</span><span class="ident" id="1581830">buckhash_sys</span><span class="op" id="1581842">)</span><span class="op" id="1581843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581846">bucketmem</span>&nbsp;<span class="op" id="1581856">+=</span>&nbsp;<span class="ident" id="1581859">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581865">b</span><span class="op" id="1581866">.</span><span class="ident" id="1581867">typ</span>&nbsp;<span class="op" id="1581871">=</span>&nbsp;<span class="ident" id="1581873">typ</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581878">b</span><span class="op" id="1581879">.</span><span class="ident" id="1581880">nstk</span>&nbsp;<span class="op" id="1581885">=</span>&nbsp;<span class="builtintype" id="1581887">uintptr</span><span class="op" id="1581894">(</span><span class="ident" id="1581895">nstk</span><span class="op" id="1581899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1581902">return</span>&nbsp;<span class="ident" id="1581909">b</span><br>
<span class="lineno">115</span><span class="op" id="1581911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1581914">//&nbsp;stk&nbsp;returns&nbsp;the&nbsp;slice&nbsp;in&nbsp;b&nbsp;holding&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1581963">func</span>&nbsp;<span class="op" id="1581968">(</span><span class="ident" id="1581969">b</span>&nbsp;<span class="op" id="1581971">*</span><span class="ident" id="1581972">bucket</span><span class="op" id="1581978">)</span>&nbsp;<span class="ident" id="1581980">stk</span><span class="op" id="1581983">(</span><span class="op" id="1581984">)</span>&nbsp;<span class="op" id="1581986">[</span><span class="op" id="1581987">]</span><span class="builtintype" id="1581988">uintptr</span>&nbsp;<span class="op" id="1581996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581999">stk</span>&nbsp;<span class="op" id="1582003">:=</span>&nbsp;<span class="op" id="1582006">(</span><span class="op" id="1582007">*</span><span class="op" id="1582008">[</span><span class="ident" id="1582009">maxStack</span><span class="op" id="1582017">]</span><span class="builtintype" id="1582018">uintptr</span><span class="op" id="1582025">)</span><span class="op" id="1582026">(</span><span class="ident" id="1582027">add</span><span class="op" id="1582030">(</span><span class="ident" id="1582031">unsafe</span><span class="op" id="1582037">.</span><span class="ident" id="1582038">Pointer</span><span class="op" id="1582045">(</span><span class="ident" id="1582046">b</span><span class="op" id="1582047">)</span><span class="op" id="1582048">,</span>&nbsp;<span class="ident" id="1582050">unsafe</span><span class="op" id="1582056">.</span><span class="ident" id="1582057">Sizeof</span><span class="op" id="1582063">(</span><span class="op" id="1582064">*</span><span class="ident" id="1582065">b</span><span class="op" id="1582066">)</span><span class="op" id="1582067">)</span><span class="op" id="1582068">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1582071">return</span>&nbsp;<span class="ident" id="1582078">stk</span><span class="op" id="1582081">[</span><span class="op" id="1582082">:</span><span class="ident" id="1582083">b</span><span class="op" id="1582084">.</span><span class="ident" id="1582085">nstk</span><span class="op" id="1582089">:</span><span class="ident" id="1582090">b</span><span class="op" id="1582091">.</span><span class="ident" id="1582092">nstk</span><span class="op" id="1582096">]</span><br>
<span class="lineno"></span><span class="op" id="1582098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1582101">//&nbsp;mp&nbsp;returns&nbsp;the&nbsp;memRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;memProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1582170">func</span>&nbsp;<span class="op" id="1582175">(</span><span class="ident" id="1582176">b</span>&nbsp;<span class="op" id="1582178">*</span><span class="ident" id="1582179">bucket</span><span class="op" id="1582185">)</span>&nbsp;<span class="ident" id="1582187">mp</span><span class="op" id="1582189">(</span><span class="op" id="1582190">)</span>&nbsp;<span class="op" id="1582192">*</span><span class="ident" id="1582193">memRecord</span>&nbsp;<span class="op" id="1582203">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1582206">if</span>&nbsp;<span class="ident" id="1582209">b</span><span class="op" id="1582210">.</span><span class="ident" id="1582211">typ</span>&nbsp;<span class="op" id="1582215">!=</span>&nbsp;<span class="ident" id="1582218">memProfile</span>&nbsp;<span class="op" id="1582229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582233">gothrow</span><span class="op" id="1582240">(</span><span class="string" id="1582241">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.mp&#34;</span><span class="op" id="1582263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1582266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582269">data</span>&nbsp;<span class="op" id="1582274">:=</span>&nbsp;<span class="ident" id="1582277">add</span><span class="op" id="1582280">(</span><span class="ident" id="1582281">unsafe</span><span class="op" id="1582287">.</span><span class="ident" id="1582288">Pointer</span><span class="op" id="1582295">(</span><span class="ident" id="1582296">b</span><span class="op" id="1582297">)</span><span class="op" id="1582298">,</span>&nbsp;<span class="ident" id="1582300">unsafe</span><span class="op" id="1582306">.</span><span class="ident" id="1582307">Sizeof</span><span class="op" id="1582313">(</span><span class="op" id="1582314">*</span><span class="ident" id="1582315">b</span><span class="op" id="1582316">)</span><span class="op" id="1582317">+</span><span class="ident" id="1582318">b</span><span class="op" id="1582319">.</span><span class="ident" id="1582320">nstk</span><span class="op" id="1582324">*</span><span class="ident" id="1582325">unsafe</span><span class="op" id="1582331">.</span><span class="ident" id="1582332">Sizeof</span><span class="op" id="1582338">(</span><span class="builtintype" id="1582339">uintptr</span><span class="op" id="1582346">(</span><span class="num" id="1582347">0</span><span class="op" id="1582348">)</span><span class="op" id="1582349">)</span><span class="op" id="1582350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1582353">return</span>&nbsp;<span class="op" id="1582360">(</span><span class="op" id="1582361">*</span><span class="ident" id="1582362">memRecord</span><span class="op" id="1582371">)</span><span class="op" id="1582372">(</span><span class="ident" id="1582373">data</span><span class="op" id="1582377">)</span><br>
<span class="lineno">130</span><span class="op" id="1582379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1582382">//&nbsp;bp&nbsp;returns&nbsp;the&nbsp;blockRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;blockProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1582455">func</span>&nbsp;<span class="op" id="1582460">(</span><span class="ident" id="1582461">b</span>&nbsp;<span class="op" id="1582463">*</span><span class="ident" id="1582464">bucket</span><span class="op" id="1582470">)</span>&nbsp;<span class="ident" id="1582472">bp</span><span class="op" id="1582474">(</span><span class="op" id="1582475">)</span>&nbsp;<span class="op" id="1582477">*</span><span class="ident" id="1582478">blockRecord</span>&nbsp;<span class="op" id="1582490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1582493">if</span>&nbsp;<span class="ident" id="1582496">b</span><span class="op" id="1582497">.</span><span class="ident" id="1582498">typ</span>&nbsp;<span class="op" id="1582502">!=</span>&nbsp;<span class="ident" id="1582505">blockProfile</span>&nbsp;<span class="op" id="1582518">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582522">gothrow</span><span class="op" id="1582529">(</span><span class="string" id="1582530">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.bp&#34;</span><span class="op" id="1582552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1582555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582558">data</span>&nbsp;<span class="op" id="1582563">:=</span>&nbsp;<span class="ident" id="1582566">add</span><span class="op" id="1582569">(</span><span class="ident" id="1582570">unsafe</span><span class="op" id="1582576">.</span><span class="ident" id="1582577">Pointer</span><span class="op" id="1582584">(</span><span class="ident" id="1582585">b</span><span class="op" id="1582586">)</span><span class="op" id="1582587">,</span>&nbsp;<span class="ident" id="1582589">unsafe</span><span class="op" id="1582595">.</span><span class="ident" id="1582596">Sizeof</span><span class="op" id="1582602">(</span><span class="op" id="1582603">*</span><span class="ident" id="1582604">b</span><span class="op" id="1582605">)</span><span class="op" id="1582606">+</span><span class="ident" id="1582607">b</span><span class="op" id="1582608">.</span><span class="ident" id="1582609">nstk</span><span class="op" id="1582613">*</span><span class="ident" id="1582614">unsafe</span><span class="op" id="1582620">.</span><span class="ident" id="1582621">Sizeof</span><span class="op" id="1582627">(</span><span class="builtintype" id="1582628">uintptr</span><span class="op" id="1582635">(</span><span class="num" id="1582636">0</span><span class="op" id="1582637">)</span><span class="op" id="1582638">)</span><span class="op" id="1582639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1582642">return</span>&nbsp;<span class="op" id="1582649">(</span><span class="op" id="1582650">*</span><span class="ident" id="1582651">blockRecord</span><span class="op" id="1582662">)</span><span class="op" id="1582663">(</span><span class="ident" id="1582664">data</span><span class="op" id="1582668">)</span><br>
<span class="lineno"></span><span class="op" id="1582670">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="1582673">//&nbsp;Return&nbsp;the&nbsp;bucket&nbsp;for&nbsp;stk[0:nstk],&nbsp;allocating&nbsp;new&nbsp;bucket&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="1582744">func</span>&nbsp;<span class="ident" id="1582749">stkbucket</span><span class="op" id="1582758">(</span><span class="ident" id="1582759">typ</span>&nbsp;<span class="ident" id="1582763">bucketType</span><span class="op" id="1582773">,</span>&nbsp;<span class="ident" id="1582775">size</span>&nbsp;<span class="builtintype" id="1582780">uintptr</span><span class="op" id="1582787">,</span>&nbsp;<span class="ident" id="1582789">stk</span>&nbsp;<span class="op" id="1582793">[</span><span class="op" id="1582794">]</span><span class="builtintype" id="1582795">uintptr</span><span class="op" id="1582802">,</span>&nbsp;<span class="ident" id="1582804">alloc</span>&nbsp;<span class="builtintype" id="1582810">bool</span><span class="op" id="1582814">)</span>&nbsp;<span class="op" id="1582816">*</span><span class="ident" id="1582817">bucket</span>&nbsp;<span class="op" id="1582824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1582827">if</span>&nbsp;<span class="ident" id="1582830">buckhash</span>&nbsp;<span class="op" id="1582839">==</span>&nbsp;<span class="builtintype" id="1582842">nil</span>&nbsp;<span class="op" id="1582846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582850">buckhash</span>&nbsp;<span class="op" id="1582859">=</span>&nbsp;<span class="op" id="1582861">(</span><span class="op" id="1582862">*</span><span class="op" id="1582863">[</span><span class="ident" id="1582864">buckHashSize</span><span class="op" id="1582876">]</span><span class="op" id="1582877">*</span><span class="ident" id="1582878">bucket</span><span class="op" id="1582884">)</span><span class="op" id="1582885">(</span><span class="ident" id="1582886">sysAlloc</span><span class="op" id="1582894">(</span><span class="ident" id="1582895">unsafe</span><span class="op" id="1582901">.</span><span class="ident" id="1582902">Sizeof</span><span class="op" id="1582908">(</span><span class="op" id="1582909">*</span><span class="ident" id="1582910">buckhash</span><span class="op" id="1582918">)</span><span class="op" id="1582919">,</span>&nbsp;<span class="op" id="1582921">&amp;</span><span class="ident" id="1582922">memstats</span><span class="op" id="1582930">.</span><span class="ident" id="1582931">buckhash_sys</span><span class="op" id="1582943">)</span><span class="op" id="1582944">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1582948">if</span>&nbsp;<span class="ident" id="1582951">buckhash</span>&nbsp;<span class="op" id="1582960">==</span>&nbsp;<span class="builtintype" id="1582963">nil</span>&nbsp;<span class="op" id="1582967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582972">gothrow</span><span class="op" id="1582979">(</span><span class="string" id="1582980">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1583013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1583017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1583020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1583024">//&nbsp;Hash&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1583040">var</span>&nbsp;<span class="ident" id="1583044">h</span>&nbsp;<span class="builtintype" id="1583046">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1583055">for</span>&nbsp;<span class="ident" id="1583059">_</span><span class="op" id="1583060">,</span>&nbsp;<span class="ident" id="1583062">pc</span>&nbsp;<span class="op" id="1583065">:=</span>&nbsp;<span class="keyword" id="1583068">range</span>&nbsp;<span class="ident" id="1583074">stk</span>&nbsp;<span class="op" id="1583078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583082">h</span>&nbsp;<span class="op" id="1583084">+=</span>&nbsp;<span class="ident" id="1583087">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583092">h</span>&nbsp;<span class="op" id="1583094">+=</span>&nbsp;<span class="ident" id="1583097">h</span>&nbsp;<span class="op" id="1583099">&lt;&lt;</span>&nbsp;<span class="num" id="1583102">10</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583107">h</span>&nbsp;<span class="op" id="1583109">^=</span>&nbsp;<span class="ident" id="1583112">h</span>&nbsp;<span class="op" id="1583114">&gt;&gt;</span>&nbsp;<span class="num" id="1583117">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1583120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1583123">//&nbsp;hash&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583140">h</span>&nbsp;<span class="op" id="1583142">+=</span>&nbsp;<span class="ident" id="1583145">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583151">h</span>&nbsp;<span class="op" id="1583153">+=</span>&nbsp;<span class="ident" id="1583156">h</span>&nbsp;<span class="op" id="1583158">&lt;&lt;</span>&nbsp;<span class="num" id="1583161">10</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583165">h</span>&nbsp;<span class="op" id="1583167">^=</span>&nbsp;<span class="ident" id="1583170">h</span>&nbsp;<span class="op" id="1583172">&gt;&gt;</span>&nbsp;<span class="num" id="1583175">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1583178">//&nbsp;finalize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583191">h</span>&nbsp;<span class="op" id="1583193">+=</span>&nbsp;<span class="ident" id="1583196">h</span>&nbsp;<span class="op" id="1583198">&lt;&lt;</span>&nbsp;<span class="num" id="1583201">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583204">h</span>&nbsp;<span class="op" id="1583206">^=</span>&nbsp;<span class="ident" id="1583209">h</span>&nbsp;<span class="op" id="1583211">&gt;&gt;</span>&nbsp;<span class="num" id="1583214">11</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583219">i</span>&nbsp;<span class="op" id="1583221">:=</span>&nbsp;<span class="builtintype" id="1583224">int</span><span class="op" id="1583227">(</span><span class="ident" id="1583228">h</span>&nbsp;<span class="op" id="1583230">%</span>&nbsp;<span class="ident" id="1583232">buckHashSize</span><span class="op" id="1583244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1583247">for</span>&nbsp;<span class="ident" id="1583251">b</span>&nbsp;<span class="op" id="1583253">:=</span>&nbsp;<span class="ident" id="1583256">buckhash</span><span class="op" id="1583264">[</span><span class="ident" id="1583265">i</span><span class="op" id="1583266">]</span><span class="op" id="1583267">;</span>&nbsp;<span class="ident" id="1583269">b</span>&nbsp;<span class="op" id="1583271">!=</span>&nbsp;<span class="builtintype" id="1583274">nil</span><span class="op" id="1583277">;</span>&nbsp;<span class="ident" id="1583279">b</span>&nbsp;<span class="op" id="1583281">=</span>&nbsp;<span class="ident" id="1583283">b</span><span class="op" id="1583284">.</span><span class="ident" id="1583285">next</span>&nbsp;<span class="op" id="1583290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1583294">if</span>&nbsp;<span class="ident" id="1583297">b</span><span class="op" id="1583298">.</span><span class="ident" id="1583299">typ</span>&nbsp;<span class="op" id="1583303">==</span>&nbsp;<span class="ident" id="1583306">typ</span>&nbsp;<span class="op" id="1583310">&amp;&amp;</span>&nbsp;<span class="ident" id="1583313">b</span><span class="op" id="1583314">.</span><span class="ident" id="1583315">hash</span>&nbsp;<span class="op" id="1583320">==</span>&nbsp;<span class="ident" id="1583323">h</span>&nbsp;<span class="op" id="1583325">&amp;&amp;</span>&nbsp;<span class="ident" id="1583328">b</span><span class="op" id="1583329">.</span><span class="ident" id="1583330">size</span>&nbsp;<span class="op" id="1583335">==</span>&nbsp;<span class="ident" id="1583338">size</span>&nbsp;<span class="op" id="1583343">&amp;&amp;</span>&nbsp;<span class="ident" id="1583346">eqslice</span><span class="op" id="1583353">(</span><span class="ident" id="1583354">b</span><span class="op" id="1583355">.</span><span class="ident" id="1583356">stk</span><span class="op" id="1583359">(</span><span class="op" id="1583360">)</span><span class="op" id="1583361">,</span>&nbsp;<span class="ident" id="1583363">stk</span><span class="op" id="1583366">)</span>&nbsp;<span class="op" id="1583368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1583373">return</span>&nbsp;<span class="ident" id="1583380">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1583384">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1583387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1583391">if</span>&nbsp;<span class="op" id="1583394">!</span><span class="ident" id="1583395">alloc</span>&nbsp;<span class="op" id="1583401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1583405">return</span>&nbsp;<span class="builtintype" id="1583412">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1583417">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1583421">//&nbsp;Create&nbsp;new&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583444">b</span>&nbsp;<span class="op" id="1583446">:=</span>&nbsp;<span class="ident" id="1583449">newBucket</span><span class="op" id="1583458">(</span><span class="ident" id="1583459">typ</span><span class="op" id="1583462">,</span>&nbsp;<span class="builtinfunc" id="1583464">len</span><span class="op" id="1583467">(</span><span class="ident" id="1583468">stk</span><span class="op" id="1583471">)</span><span class="op" id="1583472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1583475">copy</span><span class="op" id="1583479">(</span><span class="ident" id="1583480">b</span><span class="op" id="1583481">.</span><span class="ident" id="1583482">stk</span><span class="op" id="1583485">(</span><span class="op" id="1583486">)</span><span class="op" id="1583487">,</span>&nbsp;<span class="ident" id="1583489">stk</span><span class="op" id="1583492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583495">b</span><span class="op" id="1583496">.</span><span class="ident" id="1583497">hash</span>&nbsp;<span class="op" id="1583502">=</span>&nbsp;<span class="ident" id="1583504">h</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583507">b</span><span class="op" id="1583508">.</span><span class="ident" id="1583509">size</span>&nbsp;<span class="op" id="1583514">=</span>&nbsp;<span class="ident" id="1583516">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583522">b</span><span class="op" id="1583523">.</span><span class="ident" id="1583524">next</span>&nbsp;<span class="op" id="1583529">=</span>&nbsp;<span class="ident" id="1583531">buckhash</span><span class="op" id="1583539">[</span><span class="ident" id="1583540">i</span><span class="op" id="1583541">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583544">buckhash</span><span class="op" id="1583552">[</span><span class="ident" id="1583553">i</span><span class="op" id="1583554">]</span>&nbsp;<span class="op" id="1583556">=</span>&nbsp;<span class="ident" id="1583558">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1583561">if</span>&nbsp;<span class="ident" id="1583564">typ</span>&nbsp;<span class="op" id="1583568">==</span>&nbsp;<span class="ident" id="1583571">memProfile</span>&nbsp;<span class="op" id="1583582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583586">b</span><span class="op" id="1583587">.</span><span class="ident" id="1583588">allnext</span>&nbsp;<span class="op" id="1583596">=</span>&nbsp;<span class="ident" id="1583598">mbuckets</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583609">mbuckets</span>&nbsp;<span class="op" id="1583618">=</span>&nbsp;<span class="ident" id="1583620">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1583623">}</span>&nbsp;<span class="keyword" id="1583625">else</span>&nbsp;<span class="op" id="1583630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583634">b</span><span class="op" id="1583635">.</span><span class="ident" id="1583636">allnext</span>&nbsp;<span class="op" id="1583644">=</span>&nbsp;<span class="ident" id="1583646">bbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583657">bbuckets</span>&nbsp;<span class="op" id="1583666">=</span>&nbsp;<span class="ident" id="1583668">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1583671">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1583674">return</span>&nbsp;<span class="ident" id="1583681">b</span><br>
<span class="lineno"></span><span class="op" id="1583683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1583686">func</span>&nbsp;<span class="ident" id="1583691">sysAlloc</span><span class="op" id="1583699">(</span><span class="ident" id="1583700">n</span>&nbsp;<span class="builtintype" id="1583702">uintptr</span><span class="op" id="1583709">,</span>&nbsp;<span class="ident" id="1583711">stat</span>&nbsp;<span class="op" id="1583716">*</span><span class="ident" id="1583717">uint64</span><span class="op" id="1583723">)</span>&nbsp;<span class="ident" id="1583725">unsafe</span><span class="op" id="1583731">.</span><span class="ident" id="1583732">Pointer</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="1583741">func</span>&nbsp;<span class="ident" id="1583746">eqslice</span><span class="op" id="1583753">(</span><span class="ident" id="1583754">x</span><span class="op" id="1583755">,</span>&nbsp;<span class="ident" id="1583757">y</span>&nbsp;<span class="op" id="1583759">[</span><span class="op" id="1583760">]</span><span class="builtintype" id="1583761">uintptr</span><span class="op" id="1583768">)</span>&nbsp;<span class="builtintype" id="1583770">bool</span>&nbsp;<span class="op" id="1583775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1583778">if</span>&nbsp;<span class="builtinfunc" id="1583781">len</span><span class="op" id="1583784">(</span><span class="ident" id="1583785">x</span><span class="op" id="1583786">)</span>&nbsp;<span class="op" id="1583788">!=</span>&nbsp;<span class="builtinfunc" id="1583791">len</span><span class="op" id="1583794">(</span><span class="ident" id="1583795">y</span><span class="op" id="1583796">)</span>&nbsp;<span class="op" id="1583798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1583802">return</span>&nbsp;<span class="builtintype" id="1583809">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1583816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1583819">for</span>&nbsp;<span class="ident" id="1583823">i</span><span class="op" id="1583824">,</span>&nbsp;<span class="ident" id="1583826">xi</span>&nbsp;<span class="op" id="1583829">:=</span>&nbsp;<span class="keyword" id="1583832">range</span>&nbsp;<span class="ident" id="1583838">x</span>&nbsp;<span class="op" id="1583840">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1583844">if</span>&nbsp;<span class="ident" id="1583847">xi</span>&nbsp;<span class="op" id="1583850">!=</span>&nbsp;<span class="ident" id="1583853">y</span><span class="op" id="1583854">[</span><span class="ident" id="1583855">i</span><span class="op" id="1583856">]</span>&nbsp;<span class="op" id="1583858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1583863">return</span>&nbsp;<span class="builtintype" id="1583870">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1583878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1583881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1583884">return</span>&nbsp;<span class="builtintype" id="1583891">true</span><br>
<span class="lineno">205</span><span class="op" id="1583896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1583899">func</span>&nbsp;<span class="ident" id="1583904">mprof_GC</span><span class="op" id="1583912">(</span><span class="op" id="1583913">)</span>&nbsp;<span class="op" id="1583915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1583918">for</span>&nbsp;<span class="ident" id="1583922">b</span>&nbsp;<span class="op" id="1583924">:=</span>&nbsp;<span class="ident" id="1583927">mbuckets</span><span class="op" id="1583935">;</span>&nbsp;<span class="ident" id="1583937">b</span>&nbsp;<span class="op" id="1583939">!=</span>&nbsp;<span class="builtintype" id="1583942">nil</span><span class="op" id="1583945">;</span>&nbsp;<span class="ident" id="1583947">b</span>&nbsp;<span class="op" id="1583949">=</span>&nbsp;<span class="ident" id="1583951">b</span><span class="op" id="1583952">.</span><span class="ident" id="1583953">allnext</span>&nbsp;<span class="op" id="1583961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583965">mp</span>&nbsp;<span class="op" id="1583968">:=</span>&nbsp;<span class="ident" id="1583971">b</span><span class="op" id="1583972">.</span><span class="ident" id="1583973">mp</span><span class="op" id="1583975">(</span><span class="op" id="1583976">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583980">mp</span><span class="op" id="1583982">.</span><span class="ident" id="1583983">allocs</span>&nbsp;<span class="op" id="1583990">+=</span>&nbsp;<span class="ident" id="1583993">mp</span><span class="op" id="1583995">.</span><span class="ident" id="1583996">prev_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584010">mp</span><span class="op" id="1584012">.</span><span class="ident" id="1584013">frees</span>&nbsp;<span class="op" id="1584019">+=</span>&nbsp;<span class="ident" id="1584022">mp</span><span class="op" id="1584024">.</span><span class="ident" id="1584025">prev_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584038">mp</span><span class="op" id="1584040">.</span><span class="ident" id="1584041">alloc_bytes</span>&nbsp;<span class="op" id="1584053">+=</span>&nbsp;<span class="ident" id="1584056">mp</span><span class="op" id="1584058">.</span><span class="ident" id="1584059">prev_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584078">mp</span><span class="op" id="1584080">.</span><span class="ident" id="1584081">free_bytes</span>&nbsp;<span class="op" id="1584092">+=</span>&nbsp;<span class="ident" id="1584095">mp</span><span class="op" id="1584097">.</span><span class="ident" id="1584098">prev_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584117">mp</span><span class="op" id="1584119">.</span><span class="ident" id="1584120">prev_allocs</span>&nbsp;<span class="op" id="1584132">=</span>&nbsp;<span class="ident" id="1584134">mp</span><span class="op" id="1584136">.</span><span class="ident" id="1584137">recent_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584153">mp</span><span class="op" id="1584155">.</span><span class="ident" id="1584156">prev_frees</span>&nbsp;<span class="op" id="1584167">=</span>&nbsp;<span class="ident" id="1584169">mp</span><span class="op" id="1584171">.</span><span class="ident" id="1584172">recent_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584187">mp</span><span class="op" id="1584189">.</span><span class="ident" id="1584190">prev_alloc_bytes</span>&nbsp;<span class="op" id="1584207">=</span>&nbsp;<span class="ident" id="1584209">mp</span><span class="op" id="1584211">.</span><span class="ident" id="1584212">recent_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584233">mp</span><span class="op" id="1584235">.</span><span class="ident" id="1584236">prev_free_bytes</span>&nbsp;<span class="op" id="1584252">=</span>&nbsp;<span class="ident" id="1584254">mp</span><span class="op" id="1584256">.</span><span class="ident" id="1584257">recent_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584278">mp</span><span class="op" id="1584280">.</span><span class="ident" id="1584281">recent_allocs</span>&nbsp;<span class="op" id="1584295">=</span>&nbsp;<span class="num" id="1584297">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584301">mp</span><span class="op" id="1584303">.</span><span class="ident" id="1584304">recent_frees</span>&nbsp;<span class="op" id="1584317">=</span>&nbsp;<span class="num" id="1584319">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584323">mp</span><span class="op" id="1584325">.</span><span class="ident" id="1584326">recent_alloc_bytes</span>&nbsp;<span class="op" id="1584345">=</span>&nbsp;<span class="num" id="1584347">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584351">mp</span><span class="op" id="1584353">.</span><span class="ident" id="1584354">recent_free_bytes</span>&nbsp;<span class="op" id="1584372">=</span>&nbsp;<span class="num" id="1584374">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1584377">}</span><br>
<span class="lineno">225</span><span class="op" id="1584379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1584382">//&nbsp;Record&nbsp;that&nbsp;a&nbsp;gc&nbsp;just&nbsp;happened:&nbsp;all&nbsp;the&nbsp;&#39;recent&#39;&nbsp;statistics&nbsp;are&nbsp;now&nbsp;real.</span><br>
<span class="lineno"></span><span class="keyword" id="1584459">func</span>&nbsp;<span class="ident" id="1584464">mProf_GC</span><span class="op" id="1584472">(</span><span class="op" id="1584473">)</span>&nbsp;<span class="op" id="1584475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584478">lock</span><span class="op" id="1584482">(</span><span class="op" id="1584483">&amp;</span><span class="ident" id="1584484">proflock</span><span class="op" id="1584492">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584495">mprof_GC</span><span class="op" id="1584503">(</span><span class="op" id="1584504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584507">unlock</span><span class="op" id="1584513">(</span><span class="op" id="1584514">&amp;</span><span class="ident" id="1584515">proflock</span><span class="op" id="1584523">)</span><br>
<span class="lineno"></span><span class="op" id="1584525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1584528">//&nbsp;Called&nbsp;by&nbsp;malloc&nbsp;to&nbsp;record&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno">235</span><span class="keyword" id="1584576">func</span>&nbsp;<span class="ident" id="1584581">mProf_Malloc</span><span class="op" id="1584593">(</span><span class="ident" id="1584594">p</span>&nbsp;<span class="ident" id="1584596">unsafe</span><span class="op" id="1584602">.</span><span class="ident" id="1584603">Pointer</span><span class="op" id="1584610">,</span>&nbsp;<span class="ident" id="1584612">size</span>&nbsp;<span class="builtintype" id="1584617">uintptr</span><span class="op" id="1584624">)</span>&nbsp;<span class="op" id="1584626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1584629">var</span>&nbsp;<span class="ident" id="1584633">stk</span>&nbsp;<span class="op" id="1584637">[</span><span class="ident" id="1584638">maxStack</span><span class="op" id="1584646">]</span><span class="builtintype" id="1584647">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584656">nstk</span>&nbsp;<span class="op" id="1584661">:=</span>&nbsp;<span class="ident" id="1584664">callers</span><span class="op" id="1584671">(</span><span class="num" id="1584672">4</span><span class="op" id="1584673">,</span>&nbsp;<span class="op" id="1584675">&amp;</span><span class="ident" id="1584676">stk</span><span class="op" id="1584679">[</span><span class="num" id="1584680">0</span><span class="op" id="1584681">]</span><span class="op" id="1584682">,</span>&nbsp;<span class="builtinfunc" id="1584684">len</span><span class="op" id="1584687">(</span><span class="ident" id="1584688">stk</span><span class="op" id="1584691">)</span><span class="op" id="1584692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584695">lock</span><span class="op" id="1584699">(</span><span class="op" id="1584700">&amp;</span><span class="ident" id="1584701">proflock</span><span class="op" id="1584709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584712">b</span>&nbsp;<span class="op" id="1584714">:=</span>&nbsp;<span class="ident" id="1584717">stkbucket</span><span class="op" id="1584726">(</span><span class="ident" id="1584727">memProfile</span><span class="op" id="1584737">,</span>&nbsp;<span class="ident" id="1584739">size</span><span class="op" id="1584743">,</span>&nbsp;<span class="ident" id="1584745">stk</span><span class="op" id="1584748">[</span><span class="op" id="1584749">:</span><span class="ident" id="1584750">nstk</span><span class="op" id="1584754">]</span><span class="op" id="1584755">,</span>&nbsp;<span class="builtintype" id="1584757">true</span><span class="op" id="1584761">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584764">mp</span>&nbsp;<span class="op" id="1584767">:=</span>&nbsp;<span class="ident" id="1584770">b</span><span class="op" id="1584771">.</span><span class="ident" id="1584772">mp</span><span class="op" id="1584774">(</span><span class="op" id="1584775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584778">mp</span><span class="op" id="1584780">.</span><span class="ident" id="1584781">recent_allocs</span><span class="op" id="1584794">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584798">mp</span><span class="op" id="1584800">.</span><span class="ident" id="1584801">recent_alloc_bytes</span>&nbsp;<span class="op" id="1584820">+=</span>&nbsp;<span class="ident" id="1584823">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584829">unlock</span><span class="op" id="1584835">(</span><span class="op" id="1584836">&amp;</span><span class="ident" id="1584837">proflock</span><span class="op" id="1584845">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1584849">//&nbsp;Setprofilebucket&nbsp;locks&nbsp;a&nbsp;bunch&nbsp;of&nbsp;other&nbsp;mutexes,&nbsp;so&nbsp;we&nbsp;call&nbsp;it&nbsp;outside&nbsp;of&nbsp;proflock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1584937">//&nbsp;This&nbsp;reduces&nbsp;potential&nbsp;contention&nbsp;and&nbsp;chances&nbsp;of&nbsp;deadlocks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585001">//&nbsp;Since&nbsp;the&nbsp;object&nbsp;must&nbsp;be&nbsp;alive&nbsp;during&nbsp;call&nbsp;to&nbsp;mProf_Malloc,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585065">//&nbsp;it&#39;s&nbsp;fine&nbsp;to&nbsp;do&nbsp;this&nbsp;non-atomically.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585106">setprofilebucket</span><span class="op" id="1585122">(</span><span class="ident" id="1585123">p</span><span class="op" id="1585124">,</span>&nbsp;<span class="ident" id="1585126">b</span><span class="op" id="1585127">)</span><br>
<span class="lineno">250</span><span class="op" id="1585129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1585132">func</span>&nbsp;<span class="ident" id="1585137">setprofilebucket_m</span><span class="op" id="1585155">(</span><span class="op" id="1585156">)</span>&nbsp;<span class="comment" id="1585158">//&nbsp;mheap.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1585170">func</span>&nbsp;<span class="ident" id="1585175">setprofilebucket</span><span class="op" id="1585191">(</span><span class="ident" id="1585192">p</span>&nbsp;<span class="ident" id="1585194">unsafe</span><span class="op" id="1585200">.</span><span class="ident" id="1585201">Pointer</span><span class="op" id="1585208">,</span>&nbsp;<span class="ident" id="1585210">b</span>&nbsp;<span class="op" id="1585212">*</span><span class="ident" id="1585213">bucket</span><span class="op" id="1585219">)</span>&nbsp;<span class="op" id="1585221">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585224">g</span>&nbsp;<span class="op" id="1585226">:=</span>&nbsp;<span class="ident" id="1585229">getg</span><span class="op" id="1585233">(</span><span class="op" id="1585234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585237">g</span><span class="op" id="1585238">.</span><span class="ident" id="1585239">m</span><span class="op" id="1585240">.</span><span class="ident" id="1585241">ptrarg</span><span class="op" id="1585247">[</span><span class="num" id="1585248">0</span><span class="op" id="1585249">]</span>&nbsp;<span class="op" id="1585251">=</span>&nbsp;<span class="ident" id="1585253">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585256">g</span><span class="op" id="1585257">.</span><span class="ident" id="1585258">m</span><span class="op" id="1585259">.</span><span class="ident" id="1585260">ptrarg</span><span class="op" id="1585266">[</span><span class="num" id="1585267">1</span><span class="op" id="1585268">]</span>&nbsp;<span class="op" id="1585270">=</span>&nbsp;<span class="ident" id="1585272">unsafe</span><span class="op" id="1585278">.</span><span class="ident" id="1585279">Pointer</span><span class="op" id="1585286">(</span><span class="ident" id="1585287">b</span><span class="op" id="1585288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585291">onM</span><span class="op" id="1585294">(</span><span class="ident" id="1585295">setprofilebucket_m</span><span class="op" id="1585313">)</span><br>
<span class="lineno"></span><span class="op" id="1585315">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="1585318">//&nbsp;Called&nbsp;when&nbsp;freeing&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="1585359">func</span>&nbsp;<span class="ident" id="1585364">mProf_Free</span><span class="op" id="1585374">(</span><span class="ident" id="1585375">b</span>&nbsp;<span class="op" id="1585377">*</span><span class="ident" id="1585378">bucket</span><span class="op" id="1585384">,</span>&nbsp;<span class="ident" id="1585386">size</span>&nbsp;<span class="builtintype" id="1585391">uintptr</span><span class="op" id="1585398">,</span>&nbsp;<span class="ident" id="1585400">freed</span>&nbsp;<span class="builtintype" id="1585406">bool</span><span class="op" id="1585410">)</span>&nbsp;<span class="op" id="1585412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585415">lock</span><span class="op" id="1585419">(</span><span class="op" id="1585420">&amp;</span><span class="ident" id="1585421">proflock</span><span class="op" id="1585429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585432">mp</span>&nbsp;<span class="op" id="1585435">:=</span>&nbsp;<span class="ident" id="1585438">b</span><span class="op" id="1585439">.</span><span class="ident" id="1585440">mp</span><span class="op" id="1585442">(</span><span class="op" id="1585443">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1585446">if</span>&nbsp;<span class="ident" id="1585449">freed</span>&nbsp;<span class="op" id="1585455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585459">mp</span><span class="op" id="1585461">.</span><span class="ident" id="1585462">recent_frees</span><span class="op" id="1585474">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585479">mp</span><span class="op" id="1585481">.</span><span class="ident" id="1585482">recent_free_bytes</span>&nbsp;<span class="op" id="1585500">+=</span>&nbsp;<span class="ident" id="1585503">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1585509">}</span>&nbsp;<span class="keyword" id="1585511">else</span>&nbsp;<span class="op" id="1585516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585520">mp</span><span class="op" id="1585522">.</span><span class="ident" id="1585523">prev_frees</span><span class="op" id="1585533">++</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585538">mp</span><span class="op" id="1585540">.</span><span class="ident" id="1585541">prev_free_bytes</span>&nbsp;<span class="op" id="1585557">+=</span>&nbsp;<span class="ident" id="1585560">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1585566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585569">unlock</span><span class="op" id="1585575">(</span><span class="op" id="1585576">&amp;</span><span class="ident" id="1585577">proflock</span><span class="op" id="1585585">)</span><br>
<span class="lineno"></span><span class="op" id="1585587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="1585590">var</span>&nbsp;<span class="ident" id="1585594">blockprofilerate</span>&nbsp;<span class="ident" id="1585611">uint64</span>&nbsp;<span class="comment" id="1585618">//&nbsp;in&nbsp;CPU&nbsp;ticks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1585635">//&nbsp;SetBlockProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;goroutine&nbsp;blocking&nbsp;events</span><br>
<span class="lineno"></span><span class="comment" id="1585709">//&nbsp;that&nbsp;are&nbsp;reported&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.&nbsp;&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample</span><br>
<span class="lineno"></span><span class="comment" id="1585784">//&nbsp;an&nbsp;average&nbsp;of&nbsp;one&nbsp;blocking&nbsp;event&nbsp;per&nbsp;rate&nbsp;nanoseconds&nbsp;spent&nbsp;blocked.</span><br>
<span class="lineno">280</span><span class="comment" id="1585856">//</span><br>
<span class="lineno"></span><span class="comment" id="1585859">//&nbsp;To&nbsp;include&nbsp;every&nbsp;blocking&nbsp;event&nbsp;in&nbsp;the&nbsp;profile,&nbsp;pass&nbsp;rate&nbsp;=&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1585925">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;pass&nbsp;rate&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="1585976">func</span>&nbsp;<span class="ident" id="1585981">SetBlockProfileRate</span><span class="op" id="1586000">(</span><span class="ident" id="1586001">rate</span>&nbsp;<span class="builtintype" id="1586006">int</span><span class="op" id="1586009">)</span>&nbsp;<span class="op" id="1586011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586014">var</span>&nbsp;<span class="ident" id="1586018">r</span>&nbsp;<span class="ident" id="1586020">int64</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586027">if</span>&nbsp;<span class="ident" id="1586030">rate</span>&nbsp;<span class="op" id="1586035">&lt;=</span>&nbsp;<span class="num" id="1586038">0</span>&nbsp;<span class="op" id="1586040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586044">r</span>&nbsp;<span class="op" id="1586046">=</span>&nbsp;<span class="num" id="1586048">0</span>&nbsp;<span class="comment" id="1586050">//&nbsp;disable&nbsp;profiling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586072">}</span>&nbsp;<span class="keyword" id="1586074">else</span>&nbsp;<span class="keyword" id="1586079">if</span>&nbsp;<span class="ident" id="1586082">rate</span>&nbsp;<span class="op" id="1586087">==</span>&nbsp;<span class="num" id="1586090">1</span>&nbsp;<span class="op" id="1586092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586096">r</span>&nbsp;<span class="op" id="1586098">=</span>&nbsp;<span class="num" id="1586100">1</span>&nbsp;<span class="comment" id="1586102">//&nbsp;profile&nbsp;everything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586125">}</span>&nbsp;<span class="keyword" id="1586127">else</span>&nbsp;<span class="op" id="1586132">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586136">//&nbsp;convert&nbsp;ns&nbsp;to&nbsp;cycles,&nbsp;use&nbsp;float64&nbsp;to&nbsp;prevent&nbsp;overflow&nbsp;during&nbsp;multiplication</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586217">r</span>&nbsp;<span class="op" id="1586219">=</span>&nbsp;<span class="ident" id="1586221">int64</span><span class="op" id="1586226">(</span><span class="builtintype" id="1586227">float64</span><span class="op" id="1586234">(</span><span class="ident" id="1586235">rate</span><span class="op" id="1586239">)</span>&nbsp;<span class="op" id="1586241">*</span>&nbsp;<span class="builtintype" id="1586243">float64</span><span class="op" id="1586250">(</span><span class="ident" id="1586251">tickspersecond</span><span class="op" id="1586265">(</span><span class="op" id="1586266">)</span><span class="op" id="1586267">)</span>&nbsp;<span class="op" id="1586269">/</span>&nbsp;<span class="op" id="1586271">(</span><span class="num" id="1586272">1000</span>&nbsp;<span class="op" id="1586277">*</span>&nbsp;<span class="num" id="1586279">1000</span>&nbsp;<span class="op" id="1586284">*</span>&nbsp;<span class="num" id="1586286">1000</span><span class="op" id="1586290">)</span><span class="op" id="1586291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586295">if</span>&nbsp;<span class="ident" id="1586298">r</span>&nbsp;<span class="op" id="1586300">==</span>&nbsp;<span class="num" id="1586303">0</span>&nbsp;<span class="op" id="1586305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586310">r</span>&nbsp;<span class="op" id="1586312">=</span>&nbsp;<span class="num" id="1586314">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586318">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586325">atomicstore64</span><span class="op" id="1586338">(</span><span class="op" id="1586339">&amp;</span><span class="ident" id="1586340">blockprofilerate</span><span class="op" id="1586356">,</span>&nbsp;<span class="ident" id="1586358">uint64</span><span class="op" id="1586364">(</span><span class="ident" id="1586365">r</span><span class="op" id="1586366">)</span><span class="op" id="1586367">)</span><br>
<span class="lineno"></span><span class="op" id="1586369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="keyword" id="1586372">func</span>&nbsp;<span class="ident" id="1586377">blockevent</span><span class="op" id="1586387">(</span><span class="ident" id="1586388">cycles</span>&nbsp;<span class="ident" id="1586395">int64</span><span class="op" id="1586400">,</span>&nbsp;<span class="ident" id="1586402">skip</span>&nbsp;<span class="builtintype" id="1586407">int</span><span class="op" id="1586410">)</span>&nbsp;<span class="op" id="1586412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586415">if</span>&nbsp;<span class="ident" id="1586418">cycles</span>&nbsp;<span class="op" id="1586425">&lt;=</span>&nbsp;<span class="num" id="1586428">0</span>&nbsp;<span class="op" id="1586430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586434">cycles</span>&nbsp;<span class="op" id="1586441">=</span>&nbsp;<span class="num" id="1586443">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586449">rate</span>&nbsp;<span class="op" id="1586454">:=</span>&nbsp;<span class="ident" id="1586457">int64</span><span class="op" id="1586462">(</span><span class="ident" id="1586463">atomicload64</span><span class="op" id="1586475">(</span><span class="op" id="1586476">&amp;</span><span class="ident" id="1586477">blockprofilerate</span><span class="op" id="1586493">)</span><span class="op" id="1586494">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586497">if</span>&nbsp;<span class="ident" id="1586500">rate</span>&nbsp;<span class="op" id="1586505">&lt;=</span>&nbsp;<span class="num" id="1586508">0</span>&nbsp;<span class="op" id="1586510">||</span>&nbsp;<span class="op" id="1586513">(</span><span class="ident" id="1586514">rate</span>&nbsp;<span class="op" id="1586519">&gt;</span>&nbsp;<span class="ident" id="1586521">cycles</span>&nbsp;<span class="op" id="1586528">&amp;&amp;</span>&nbsp;<span class="ident" id="1586531">int64</span><span class="op" id="1586536">(</span><span class="ident" id="1586537">fastrand1</span><span class="op" id="1586546">(</span><span class="op" id="1586547">)</span><span class="op" id="1586548">)</span><span class="op" id="1586549">%</span><span class="ident" id="1586550">rate</span>&nbsp;<span class="op" id="1586555">&gt;</span>&nbsp;<span class="ident" id="1586557">cycles</span><span class="op" id="1586563">)</span>&nbsp;<span class="op" id="1586565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586569">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586580">gp</span>&nbsp;<span class="op" id="1586583">:=</span>&nbsp;<span class="ident" id="1586586">getg</span><span class="op" id="1586590">(</span><span class="op" id="1586591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586594">var</span>&nbsp;<span class="ident" id="1586598">nstk</span>&nbsp;<span class="builtintype" id="1586603">int</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586608">var</span>&nbsp;<span class="ident" id="1586612">stk</span>&nbsp;<span class="op" id="1586616">[</span><span class="ident" id="1586617">maxStack</span><span class="op" id="1586625">]</span><span class="builtintype" id="1586626">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586635">if</span>&nbsp;<span class="ident" id="1586638">gp</span><span class="op" id="1586640">.</span><span class="ident" id="1586641">m</span><span class="op" id="1586642">.</span><span class="ident" id="1586643">curg</span>&nbsp;<span class="op" id="1586648">==</span>&nbsp;<span class="builtintype" id="1586651">nil</span>&nbsp;<span class="op" id="1586655">||</span>&nbsp;<span class="ident" id="1586658">gp</span><span class="op" id="1586660">.</span><span class="ident" id="1586661">m</span><span class="op" id="1586662">.</span><span class="ident" id="1586663">curg</span>&nbsp;<span class="op" id="1586668">==</span>&nbsp;<span class="ident" id="1586671">gp</span>&nbsp;<span class="op" id="1586674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586678">nstk</span>&nbsp;<span class="op" id="1586683">=</span>&nbsp;<span class="ident" id="1586685">callers</span><span class="op" id="1586692">(</span><span class="ident" id="1586693">skip</span><span class="op" id="1586697">,</span>&nbsp;<span class="op" id="1586699">&amp;</span><span class="ident" id="1586700">stk</span><span class="op" id="1586703">[</span><span class="num" id="1586704">0</span><span class="op" id="1586705">]</span><span class="op" id="1586706">,</span>&nbsp;<span class="builtinfunc" id="1586708">len</span><span class="op" id="1586711">(</span><span class="ident" id="1586712">stk</span><span class="op" id="1586715">)</span><span class="op" id="1586716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586719">}</span>&nbsp;<span class="keyword" id="1586721">else</span>&nbsp;<span class="op" id="1586726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586730">nstk</span>&nbsp;<span class="op" id="1586735">=</span>&nbsp;<span class="ident" id="1586737">gcallers</span><span class="op" id="1586745">(</span><span class="ident" id="1586746">gp</span><span class="op" id="1586748">.</span><span class="ident" id="1586749">m</span><span class="op" id="1586750">.</span><span class="ident" id="1586751">curg</span><span class="op" id="1586755">,</span>&nbsp;<span class="ident" id="1586757">skip</span><span class="op" id="1586761">,</span>&nbsp;<span class="op" id="1586763">&amp;</span><span class="ident" id="1586764">stk</span><span class="op" id="1586767">[</span><span class="num" id="1586768">0</span><span class="op" id="1586769">]</span><span class="op" id="1586770">,</span>&nbsp;<span class="builtinfunc" id="1586772">len</span><span class="op" id="1586775">(</span><span class="ident" id="1586776">stk</span><span class="op" id="1586779">)</span><span class="op" id="1586780">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586786">lock</span><span class="op" id="1586790">(</span><span class="op" id="1586791">&amp;</span><span class="ident" id="1586792">proflock</span><span class="op" id="1586800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586803">b</span>&nbsp;<span class="op" id="1586805">:=</span>&nbsp;<span class="ident" id="1586808">stkbucket</span><span class="op" id="1586817">(</span><span class="ident" id="1586818">blockProfile</span><span class="op" id="1586830">,</span>&nbsp;<span class="num" id="1586832">0</span><span class="op" id="1586833">,</span>&nbsp;<span class="ident" id="1586835">stk</span><span class="op" id="1586838">[</span><span class="op" id="1586839">:</span><span class="ident" id="1586840">nstk</span><span class="op" id="1586844">]</span><span class="op" id="1586845">,</span>&nbsp;<span class="builtintype" id="1586847">true</span><span class="op" id="1586851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586854">b</span><span class="op" id="1586855">.</span><span class="ident" id="1586856">bp</span><span class="op" id="1586858">(</span><span class="op" id="1586859">)</span><span class="op" id="1586860">.</span><span class="ident" id="1586861">count</span><span class="op" id="1586866">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586870">b</span><span class="op" id="1586871">.</span><span class="ident" id="1586872">bp</span><span class="op" id="1586874">(</span><span class="op" id="1586875">)</span><span class="op" id="1586876">.</span><span class="ident" id="1586877">cycles</span>&nbsp;<span class="op" id="1586884">+=</span>&nbsp;<span class="ident" id="1586887">cycles</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586895">unlock</span><span class="op" id="1586901">(</span><span class="op" id="1586902">&amp;</span><span class="ident" id="1586903">proflock</span><span class="op" id="1586911">)</span><br>
<span class="lineno"></span><span class="op" id="1586913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1586916">//&nbsp;Go&nbsp;interface&nbsp;to&nbsp;profile&nbsp;data.</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="1586950">//&nbsp;A&nbsp;StackRecord&nbsp;describes&nbsp;a&nbsp;single&nbsp;execution&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1587003">type</span>&nbsp;<span class="ident" id="1587008">StackRecord</span>&nbsp;<span class="keyword" id="1587020">struct</span>&nbsp;<span class="op" id="1587027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587030">Stack0</span>&nbsp;<span class="op" id="1587037">[</span><span class="num" id="1587038">32</span><span class="op" id="1587040">]</span><span class="builtintype" id="1587041">uintptr</span>&nbsp;<span class="comment" id="1587049">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1587103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="1587106">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1587167">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno"></span><span class="keyword" id="1587192">func</span>&nbsp;<span class="op" id="1587197">(</span><span class="ident" id="1587198">r</span>&nbsp;<span class="op" id="1587200">*</span><span class="ident" id="1587201">StackRecord</span><span class="op" id="1587212">)</span>&nbsp;<span class="ident" id="1587214">Stack</span><span class="op" id="1587219">(</span><span class="op" id="1587220">)</span>&nbsp;<span class="op" id="1587222">[</span><span class="op" id="1587223">]</span><span class="builtintype" id="1587224">uintptr</span>&nbsp;<span class="op" id="1587232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587235">for</span>&nbsp;<span class="ident" id="1587239">i</span><span class="op" id="1587240">,</span>&nbsp;<span class="ident" id="1587242">v</span>&nbsp;<span class="op" id="1587244">:=</span>&nbsp;<span class="keyword" id="1587247">range</span>&nbsp;<span class="ident" id="1587253">r</span><span class="op" id="1587254">.</span><span class="ident" id="1587255">Stack0</span>&nbsp;<span class="op" id="1587262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587266">if</span>&nbsp;<span class="ident" id="1587269">v</span>&nbsp;<span class="op" id="1587271">==</span>&nbsp;<span class="num" id="1587274">0</span>&nbsp;<span class="op" id="1587276">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587281">return</span>&nbsp;<span class="ident" id="1587288">r</span><span class="op" id="1587289">.</span><span class="ident" id="1587290">Stack0</span><span class="op" id="1587296">[</span><span class="num" id="1587297">0</span><span class="op" id="1587298">:</span><span class="ident" id="1587299">i</span><span class="op" id="1587300">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587310">return</span>&nbsp;<span class="ident" id="1587317">r</span><span class="op" id="1587318">.</span><span class="ident" id="1587319">Stack0</span><span class="op" id="1587325">[</span><span class="num" id="1587326">0</span><span class="op" id="1587327">:</span><span class="op" id="1587328">]</span><br>
<span class="lineno"></span><span class="op" id="1587330">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="comment" id="1587333">//&nbsp;MemProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;memory&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="1587395">//&nbsp;that&nbsp;are&nbsp;recorded&nbsp;and&nbsp;reported&nbsp;in&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1587452">//&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample&nbsp;an&nbsp;average&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1587497">//&nbsp;one&nbsp;allocation&nbsp;per&nbsp;MemProfileRate&nbsp;bytes&nbsp;allocated.</span><br>
<span class="lineno">345</span><span class="comment" id="1587551">//</span><br>
<span class="lineno"></span><span class="comment" id="1587554">//&nbsp;To&nbsp;include&nbsp;every&nbsp;allocated&nbsp;block&nbsp;in&nbsp;the&nbsp;profile,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1587631">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1587691">//</span><br>
<span class="lineno"></span><span class="comment" id="1587694">//&nbsp;The&nbsp;tools&nbsp;that&nbsp;process&nbsp;the&nbsp;memory&nbsp;profiles&nbsp;assume&nbsp;that&nbsp;the</span><br>
<span class="lineno">350</span><span class="comment" id="1587756">//&nbsp;profile&nbsp;rate&nbsp;is&nbsp;constant&nbsp;across&nbsp;the&nbsp;lifetime&nbsp;of&nbsp;the&nbsp;program</span><br>
<span class="lineno"></span><span class="comment" id="1587819">//&nbsp;and&nbsp;equal&nbsp;to&nbsp;the&nbsp;current&nbsp;value.&nbsp;&nbsp;Programs&nbsp;that&nbsp;change&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1587880">//&nbsp;memory&nbsp;profiling&nbsp;rate&nbsp;should&nbsp;do&nbsp;so&nbsp;just&nbsp;once,&nbsp;as&nbsp;early&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1587941">//&nbsp;possible&nbsp;in&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;program&nbsp;(for&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="1587999">//&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;main).</span><br>
<span class="lineno">355</span><span class="keyword" id="1588029">var</span>&nbsp;<span class="ident" id="1588033">MemProfileRate</span>&nbsp;<span class="builtintype" id="1588048">int</span>&nbsp;<span class="op" id="1588052">=</span>&nbsp;<span class="num" id="1588054">512</span>&nbsp;<span class="op" id="1588058">*</span>&nbsp;<span class="num" id="1588060">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1588066">//&nbsp;A&nbsp;MemProfileRecord&nbsp;describes&nbsp;the&nbsp;live&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1588125">//&nbsp;by&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1588173">type</span>&nbsp;<span class="ident" id="1588178">MemProfileRecord</span>&nbsp;<span class="keyword" id="1588195">struct</span>&nbsp;<span class="op" id="1588202">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588205">AllocBytes</span><span class="op" id="1588215">,</span>&nbsp;<span class="ident" id="1588217">FreeBytes</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588231">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1588243">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588280">AllocObjects</span><span class="op" id="1588292">,</span>&nbsp;<span class="ident" id="1588294">FreeObjects</span>&nbsp;<span class="ident" id="1588306">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1588318">//&nbsp;number&nbsp;of&nbsp;objects&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588357">Stack0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588383">[</span><span class="num" id="1588384">32</span><span class="op" id="1588386">]</span><span class="builtintype" id="1588387">uintptr</span>&nbsp;<span class="comment" id="1588395">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1588449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="1588452">//&nbsp;InUseBytes&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;use&nbsp;(AllocBytes&nbsp;-&nbsp;FreeBytes).</span><br>
<span class="lineno"></span><span class="keyword" id="1588527">func</span>&nbsp;<span class="op" id="1588532">(</span><span class="ident" id="1588533">r</span>&nbsp;<span class="op" id="1588535">*</span><span class="ident" id="1588536">MemProfileRecord</span><span class="op" id="1588552">)</span>&nbsp;<span class="ident" id="1588554">InUseBytes</span><span class="op" id="1588564">(</span><span class="op" id="1588565">)</span>&nbsp;<span class="ident" id="1588567">int64</span>&nbsp;<span class="op" id="1588573">{</span>&nbsp;<span class="keyword" id="1588575">return</span>&nbsp;<span class="ident" id="1588582">r</span><span class="op" id="1588583">.</span><span class="ident" id="1588584">AllocBytes</span>&nbsp;<span class="op" id="1588595">-</span>&nbsp;<span class="ident" id="1588597">r</span><span class="op" id="1588598">.</span><span class="ident" id="1588599">FreeBytes</span>&nbsp;<span class="op" id="1588609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1588612">//&nbsp;InUseObjects&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;objects&nbsp;in&nbsp;use&nbsp;(AllocObjects&nbsp;-&nbsp;FreeObjects).</span><br>
<span class="lineno"></span><span class="keyword" id="1588695">func</span>&nbsp;<span class="op" id="1588700">(</span><span class="ident" id="1588701">r</span>&nbsp;<span class="op" id="1588703">*</span><span class="ident" id="1588704">MemProfileRecord</span><span class="op" id="1588720">)</span>&nbsp;<span class="ident" id="1588722">InUseObjects</span><span class="op" id="1588734">(</span><span class="op" id="1588735">)</span>&nbsp;<span class="ident" id="1588737">int64</span>&nbsp;<span class="op" id="1588743">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588746">return</span>&nbsp;<span class="ident" id="1588753">r</span><span class="op" id="1588754">.</span><span class="ident" id="1588755">AllocObjects</span>&nbsp;<span class="op" id="1588768">-</span>&nbsp;<span class="ident" id="1588770">r</span><span class="op" id="1588771">.</span><span class="ident" id="1588772">FreeObjects</span><br>
<span class="lineno"></span><span class="op" id="1588784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1588787">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1588848">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno">375</span><span class="keyword" id="1588873">func</span>&nbsp;<span class="op" id="1588878">(</span><span class="ident" id="1588879">r</span>&nbsp;<span class="op" id="1588881">*</span><span class="ident" id="1588882">MemProfileRecord</span><span class="op" id="1588898">)</span>&nbsp;<span class="ident" id="1588900">Stack</span><span class="op" id="1588905">(</span><span class="op" id="1588906">)</span>&nbsp;<span class="op" id="1588908">[</span><span class="op" id="1588909">]</span><span class="builtintype" id="1588910">uintptr</span>&nbsp;<span class="op" id="1588918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588921">for</span>&nbsp;<span class="ident" id="1588925">i</span><span class="op" id="1588926">,</span>&nbsp;<span class="ident" id="1588928">v</span>&nbsp;<span class="op" id="1588930">:=</span>&nbsp;<span class="keyword" id="1588933">range</span>&nbsp;<span class="ident" id="1588939">r</span><span class="op" id="1588940">.</span><span class="ident" id="1588941">Stack0</span>&nbsp;<span class="op" id="1588948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588952">if</span>&nbsp;<span class="ident" id="1588955">v</span>&nbsp;<span class="op" id="1588957">==</span>&nbsp;<span class="num" id="1588960">0</span>&nbsp;<span class="op" id="1588962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588967">return</span>&nbsp;<span class="ident" id="1588974">r</span><span class="op" id="1588975">.</span><span class="ident" id="1588976">Stack0</span><span class="op" id="1588982">[</span><span class="num" id="1588983">0</span><span class="op" id="1588984">:</span><span class="ident" id="1588985">i</span><span class="op" id="1588986">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588990">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588996">return</span>&nbsp;<span class="ident" id="1589003">r</span><span class="op" id="1589004">.</span><span class="ident" id="1589005">Stack0</span><span class="op" id="1589011">[</span><span class="num" id="1589012">0</span><span class="op" id="1589013">:</span><span class="op" id="1589014">]</span><br>
<span class="lineno"></span><span class="op" id="1589016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1589019">//&nbsp;MemProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno">385</span><span class="comment" id="1589097">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;MemProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1589174">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;MemProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1589243">//</span><br>
<span class="lineno"></span><span class="comment" id="1589246">//&nbsp;If&nbsp;inuseZero&nbsp;is&nbsp;true,&nbsp;the&nbsp;profile&nbsp;includes&nbsp;allocation&nbsp;records</span><br>
<span class="lineno"></span><span class="comment" id="1589311">//&nbsp;where&nbsp;r.AllocBytes&nbsp;&gt;&nbsp;0&nbsp;but&nbsp;r.AllocBytes&nbsp;==&nbsp;r.FreeBytes.</span><br>
<span class="lineno">390</span><span class="comment" id="1589370">//&nbsp;These&nbsp;are&nbsp;sites&nbsp;where&nbsp;memory&nbsp;was&nbsp;allocated,&nbsp;but&nbsp;it&nbsp;has&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="1589432">//&nbsp;been&nbsp;released&nbsp;back&nbsp;to&nbsp;the&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="1589470">//</span><br>
<span class="lineno"></span><span class="comment" id="1589473">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1589529">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.memprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno">395</span><span class="comment" id="1589584">//&nbsp;of&nbsp;calling&nbsp;MemProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1589619">func</span>&nbsp;<span class="ident" id="1589624">MemProfile</span><span class="op" id="1589634">(</span><span class="ident" id="1589635">p</span>&nbsp;<span class="op" id="1589637">[</span><span class="op" id="1589638">]</span><span class="ident" id="1589639">MemProfileRecord</span><span class="op" id="1589655">,</span>&nbsp;<span class="ident" id="1589657">inuseZero</span>&nbsp;<span class="builtintype" id="1589667">bool</span><span class="op" id="1589671">)</span>&nbsp;<span class="op" id="1589673">(</span><span class="ident" id="1589674">n</span>&nbsp;<span class="builtintype" id="1589676">int</span><span class="op" id="1589679">,</span>&nbsp;<span class="ident" id="1589681">ok</span>&nbsp;<span class="builtintype" id="1589684">bool</span><span class="op" id="1589688">)</span>&nbsp;<span class="op" id="1589690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589693">lock</span><span class="op" id="1589697">(</span><span class="op" id="1589698">&amp;</span><span class="ident" id="1589699">proflock</span><span class="op" id="1589707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589710">clear</span>&nbsp;<span class="op" id="1589716">:=</span>&nbsp;<span class="builtintype" id="1589719">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589725">for</span>&nbsp;<span class="ident" id="1589729">b</span>&nbsp;<span class="op" id="1589731">:=</span>&nbsp;<span class="ident" id="1589734">mbuckets</span><span class="op" id="1589742">;</span>&nbsp;<span class="ident" id="1589744">b</span>&nbsp;<span class="op" id="1589746">!=</span>&nbsp;<span class="builtintype" id="1589749">nil</span><span class="op" id="1589752">;</span>&nbsp;<span class="ident" id="1589754">b</span>&nbsp;<span class="op" id="1589756">=</span>&nbsp;<span class="ident" id="1589758">b</span><span class="op" id="1589759">.</span><span class="ident" id="1589760">allnext</span>&nbsp;<span class="op" id="1589768">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589772">mp</span>&nbsp;<span class="op" id="1589775">:=</span>&nbsp;<span class="ident" id="1589778">b</span><span class="op" id="1589779">.</span><span class="ident" id="1589780">mp</span><span class="op" id="1589782">(</span><span class="op" id="1589783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589787">if</span>&nbsp;<span class="ident" id="1589790">inuseZero</span>&nbsp;<span class="op" id="1589800">||</span>&nbsp;<span class="ident" id="1589803">mp</span><span class="op" id="1589805">.</span><span class="ident" id="1589806">alloc_bytes</span>&nbsp;<span class="op" id="1589818">!=</span>&nbsp;<span class="ident" id="1589821">mp</span><span class="op" id="1589823">.</span><span class="ident" id="1589824">free_bytes</span>&nbsp;<span class="op" id="1589835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589840">n</span><span class="op" id="1589841">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589850">if</span>&nbsp;<span class="ident" id="1589853">mp</span><span class="op" id="1589855">.</span><span class="ident" id="1589856">allocs</span>&nbsp;<span class="op" id="1589863">!=</span>&nbsp;<span class="num" id="1589866">0</span>&nbsp;<span class="op" id="1589868">||</span>&nbsp;<span class="ident" id="1589871">mp</span><span class="op" id="1589873">.</span><span class="ident" id="1589874">frees</span>&nbsp;<span class="op" id="1589880">!=</span>&nbsp;<span class="num" id="1589883">0</span>&nbsp;<span class="op" id="1589885">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589890">clear</span>&nbsp;<span class="op" id="1589896">=</span>&nbsp;<span class="builtintype" id="1589898">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589912">if</span>&nbsp;<span class="ident" id="1589915">clear</span>&nbsp;<span class="op" id="1589921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1589925">//&nbsp;Absolutely&nbsp;no&nbsp;data,&nbsp;suggesting&nbsp;that&nbsp;a&nbsp;garbage&nbsp;collection</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1589987">//&nbsp;has&nbsp;not&nbsp;yet&nbsp;happened.&nbsp;In&nbsp;order&nbsp;to&nbsp;allow&nbsp;profiling&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1590047">//&nbsp;garbage&nbsp;collection&nbsp;is&nbsp;disabled&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;execution,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1590116">//&nbsp;accumulate&nbsp;stats&nbsp;as&nbsp;if&nbsp;a&nbsp;GC&nbsp;just&nbsp;happened,&nbsp;and&nbsp;recount&nbsp;buckets.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590185">mprof_GC</span><span class="op" id="1590193">(</span><span class="op" id="1590194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590198">mprof_GC</span><span class="op" id="1590206">(</span><span class="op" id="1590207">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590211">n</span>&nbsp;<span class="op" id="1590213">=</span>&nbsp;<span class="num" id="1590215">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590219">for</span>&nbsp;<span class="ident" id="1590223">b</span>&nbsp;<span class="op" id="1590225">:=</span>&nbsp;<span class="ident" id="1590228">mbuckets</span><span class="op" id="1590236">;</span>&nbsp;<span class="ident" id="1590238">b</span>&nbsp;<span class="op" id="1590240">!=</span>&nbsp;<span class="builtintype" id="1590243">nil</span><span class="op" id="1590246">;</span>&nbsp;<span class="ident" id="1590248">b</span>&nbsp;<span class="op" id="1590250">=</span>&nbsp;<span class="ident" id="1590252">b</span><span class="op" id="1590253">.</span><span class="ident" id="1590254">allnext</span>&nbsp;<span class="op" id="1590262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590267">mp</span>&nbsp;<span class="op" id="1590270">:=</span>&nbsp;<span class="ident" id="1590273">b</span><span class="op" id="1590274">.</span><span class="ident" id="1590275">mp</span><span class="op" id="1590277">(</span><span class="op" id="1590278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590283">if</span>&nbsp;<span class="ident" id="1590286">inuseZero</span>&nbsp;<span class="op" id="1590296">||</span>&nbsp;<span class="ident" id="1590299">mp</span><span class="op" id="1590301">.</span><span class="ident" id="1590302">alloc_bytes</span>&nbsp;<span class="op" id="1590314">!=</span>&nbsp;<span class="ident" id="1590317">mp</span><span class="op" id="1590319">.</span><span class="ident" id="1590320">free_bytes</span>&nbsp;<span class="op" id="1590331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590337">n</span><span class="op" id="1590338">++</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1590344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1590348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1590351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590354">if</span>&nbsp;<span class="ident" id="1590357">n</span>&nbsp;<span class="op" id="1590359">&lt;=</span>&nbsp;<span class="builtinfunc" id="1590362">len</span><span class="op" id="1590365">(</span><span class="ident" id="1590366">p</span><span class="op" id="1590367">)</span>&nbsp;<span class="op" id="1590369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590373">ok</span>&nbsp;<span class="op" id="1590376">=</span>&nbsp;<span class="builtintype" id="1590378">true</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590385">idx</span>&nbsp;<span class="op" id="1590389">:=</span>&nbsp;<span class="num" id="1590392">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590396">for</span>&nbsp;<span class="ident" id="1590400">b</span>&nbsp;<span class="op" id="1590402">:=</span>&nbsp;<span class="ident" id="1590405">mbuckets</span><span class="op" id="1590413">;</span>&nbsp;<span class="ident" id="1590415">b</span>&nbsp;<span class="op" id="1590417">!=</span>&nbsp;<span class="builtintype" id="1590420">nil</span><span class="op" id="1590423">;</span>&nbsp;<span class="ident" id="1590425">b</span>&nbsp;<span class="op" id="1590427">=</span>&nbsp;<span class="ident" id="1590429">b</span><span class="op" id="1590430">.</span><span class="ident" id="1590431">allnext</span>&nbsp;<span class="op" id="1590439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590444">mp</span>&nbsp;<span class="op" id="1590447">:=</span>&nbsp;<span class="ident" id="1590450">b</span><span class="op" id="1590451">.</span><span class="ident" id="1590452">mp</span><span class="op" id="1590454">(</span><span class="op" id="1590455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590460">if</span>&nbsp;<span class="ident" id="1590463">inuseZero</span>&nbsp;<span class="op" id="1590473">||</span>&nbsp;<span class="ident" id="1590476">mp</span><span class="op" id="1590478">.</span><span class="ident" id="1590479">alloc_bytes</span>&nbsp;<span class="op" id="1590491">!=</span>&nbsp;<span class="ident" id="1590494">mp</span><span class="op" id="1590496">.</span><span class="ident" id="1590497">free_bytes</span>&nbsp;<span class="op" id="1590508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590514">record</span><span class="op" id="1590520">(</span><span class="op" id="1590521">&amp;</span><span class="ident" id="1590522">p</span><span class="op" id="1590523">[</span><span class="ident" id="1590524">idx</span><span class="op" id="1590527">]</span><span class="op" id="1590528">,</span>&nbsp;<span class="ident" id="1590530">b</span><span class="op" id="1590531">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590537">idx</span><span class="op" id="1590540">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1590546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1590550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1590553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590556">unlock</span><span class="op" id="1590562">(</span><span class="op" id="1590563">&amp;</span><span class="ident" id="1590564">proflock</span><span class="op" id="1590572">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590575">return</span><br>
<span class="lineno"></span><span class="op" id="1590582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1590585">//&nbsp;Write&nbsp;b&#39;s&nbsp;data&nbsp;to&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="1590609">func</span>&nbsp;<span class="ident" id="1590614">record</span><span class="op" id="1590620">(</span><span class="ident" id="1590621">r</span>&nbsp;<span class="op" id="1590623">*</span><span class="ident" id="1590624">MemProfileRecord</span><span class="op" id="1590640">,</span>&nbsp;<span class="ident" id="1590642">b</span>&nbsp;<span class="op" id="1590644">*</span><span class="ident" id="1590645">bucket</span><span class="op" id="1590651">)</span>&nbsp;<span class="op" id="1590653">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590656">mp</span>&nbsp;<span class="op" id="1590659">:=</span>&nbsp;<span class="ident" id="1590662">b</span><span class="op" id="1590663">.</span><span class="ident" id="1590664">mp</span><span class="op" id="1590666">(</span><span class="op" id="1590667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590670">r</span><span class="op" id="1590671">.</span><span class="ident" id="1590672">AllocBytes</span>&nbsp;<span class="op" id="1590683">=</span>&nbsp;<span class="ident" id="1590685">int64</span><span class="op" id="1590690">(</span><span class="ident" id="1590691">mp</span><span class="op" id="1590693">.</span><span class="ident" id="1590694">alloc_bytes</span><span class="op" id="1590705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590708">r</span><span class="op" id="1590709">.</span><span class="ident" id="1590710">FreeBytes</span>&nbsp;<span class="op" id="1590720">=</span>&nbsp;<span class="ident" id="1590722">int64</span><span class="op" id="1590727">(</span><span class="ident" id="1590728">mp</span><span class="op" id="1590730">.</span><span class="ident" id="1590731">free_bytes</span><span class="op" id="1590741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590744">r</span><span class="op" id="1590745">.</span><span class="ident" id="1590746">AllocObjects</span>&nbsp;<span class="op" id="1590759">=</span>&nbsp;<span class="ident" id="1590761">int64</span><span class="op" id="1590766">(</span><span class="ident" id="1590767">mp</span><span class="op" id="1590769">.</span><span class="ident" id="1590770">allocs</span><span class="op" id="1590776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590779">r</span><span class="op" id="1590780">.</span><span class="ident" id="1590781">FreeObjects</span>&nbsp;<span class="op" id="1590793">=</span>&nbsp;<span class="ident" id="1590795">int64</span><span class="op" id="1590800">(</span><span class="ident" id="1590801">mp</span><span class="op" id="1590803">.</span><span class="ident" id="1590804">frees</span><span class="op" id="1590809">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1590812">copy</span><span class="op" id="1590816">(</span><span class="ident" id="1590817">r</span><span class="op" id="1590818">.</span><span class="ident" id="1590819">Stack0</span><span class="op" id="1590825">[</span><span class="op" id="1590826">:</span><span class="op" id="1590827">]</span><span class="op" id="1590828">,</span>&nbsp;<span class="ident" id="1590830">b</span><span class="op" id="1590831">.</span><span class="ident" id="1590832">stk</span><span class="op" id="1590835">(</span><span class="op" id="1590836">)</span><span class="op" id="1590837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590840">for</span>&nbsp;<span class="ident" id="1590844">i</span>&nbsp;<span class="op" id="1590846">:=</span>&nbsp;<span class="builtintype" id="1590849">int</span><span class="op" id="1590852">(</span><span class="ident" id="1590853">b</span><span class="op" id="1590854">.</span><span class="ident" id="1590855">nstk</span><span class="op" id="1590859">)</span><span class="op" id="1590860">;</span>&nbsp;<span class="ident" id="1590862">i</span>&nbsp;<span class="op" id="1590864">&lt;</span>&nbsp;<span class="builtinfunc" id="1590866">len</span><span class="op" id="1590869">(</span><span class="ident" id="1590870">r</span><span class="op" id="1590871">.</span><span class="ident" id="1590872">Stack0</span><span class="op" id="1590878">)</span><span class="op" id="1590879">;</span>&nbsp;<span class="ident" id="1590881">i</span><span class="op" id="1590882">++</span>&nbsp;<span class="op" id="1590885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590889">r</span><span class="op" id="1590890">.</span><span class="ident" id="1590891">Stack0</span><span class="op" id="1590897">[</span><span class="ident" id="1590898">i</span><span class="op" id="1590899">]</span>&nbsp;<span class="op" id="1590901">=</span>&nbsp;<span class="num" id="1590903">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1590906">}</span><br>
<span class="lineno"></span><span class="op" id="1590908">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span><span class="keyword" id="1590911">func</span>&nbsp;<span class="ident" id="1590916">iterate_memprof</span><span class="op" id="1590931">(</span><span class="ident" id="1590932">fn</span>&nbsp;<span class="keyword" id="1590935">func</span><span class="op" id="1590939">(</span><span class="op" id="1590940">*</span><span class="ident" id="1590941">bucket</span><span class="op" id="1590947">,</span>&nbsp;<span class="builtintype" id="1590949">uintptr</span><span class="op" id="1590956">,</span>&nbsp;<span class="op" id="1590958">*</span><span class="builtintype" id="1590959">uintptr</span><span class="op" id="1590966">,</span>&nbsp;<span class="builtintype" id="1590968">uintptr</span><span class="op" id="1590975">,</span>&nbsp;<span class="builtintype" id="1590977">uintptr</span><span class="op" id="1590984">,</span>&nbsp;<span class="builtintype" id="1590986">uintptr</span><span class="op" id="1590993">)</span><span class="op" id="1590994">)</span>&nbsp;<span class="op" id="1590996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590999">lock</span><span class="op" id="1591003">(</span><span class="op" id="1591004">&amp;</span><span class="ident" id="1591005">proflock</span><span class="op" id="1591013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591016">for</span>&nbsp;<span class="ident" id="1591020">b</span>&nbsp;<span class="op" id="1591022">:=</span>&nbsp;<span class="ident" id="1591025">mbuckets</span><span class="op" id="1591033">;</span>&nbsp;<span class="ident" id="1591035">b</span>&nbsp;<span class="op" id="1591037">!=</span>&nbsp;<span class="builtintype" id="1591040">nil</span><span class="op" id="1591043">;</span>&nbsp;<span class="ident" id="1591045">b</span>&nbsp;<span class="op" id="1591047">=</span>&nbsp;<span class="ident" id="1591049">b</span><span class="op" id="1591050">.</span><span class="ident" id="1591051">allnext</span>&nbsp;<span class="op" id="1591059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591063">mp</span>&nbsp;<span class="op" id="1591066">:=</span>&nbsp;<span class="ident" id="1591069">b</span><span class="op" id="1591070">.</span><span class="ident" id="1591071">mp</span><span class="op" id="1591073">(</span><span class="op" id="1591074">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591078">fn</span><span class="op" id="1591080">(</span><span class="ident" id="1591081">b</span><span class="op" id="1591082">,</span>&nbsp;<span class="builtintype" id="1591084">uintptr</span><span class="op" id="1591091">(</span><span class="ident" id="1591092">b</span><span class="op" id="1591093">.</span><span class="ident" id="1591094">nstk</span><span class="op" id="1591098">)</span><span class="op" id="1591099">,</span>&nbsp;<span class="op" id="1591101">&amp;</span><span class="ident" id="1591102">b</span><span class="op" id="1591103">.</span><span class="ident" id="1591104">stk</span><span class="op" id="1591107">(</span><span class="op" id="1591108">)</span><span class="op" id="1591109">[</span><span class="num" id="1591110">0</span><span class="op" id="1591111">]</span><span class="op" id="1591112">,</span>&nbsp;<span class="ident" id="1591114">b</span><span class="op" id="1591115">.</span><span class="ident" id="1591116">size</span><span class="op" id="1591120">,</span>&nbsp;<span class="ident" id="1591122">mp</span><span class="op" id="1591124">.</span><span class="ident" id="1591125">allocs</span><span class="op" id="1591131">,</span>&nbsp;<span class="ident" id="1591133">mp</span><span class="op" id="1591135">.</span><span class="ident" id="1591136">frees</span><span class="op" id="1591141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1591144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591147">unlock</span><span class="op" id="1591153">(</span><span class="op" id="1591154">&amp;</span><span class="ident" id="1591155">proflock</span><span class="op" id="1591163">)</span><br>
<span class="lineno"></span><span class="op" id="1591165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="1591168">//&nbsp;BlockProfileRecord&nbsp;describes&nbsp;blocking&nbsp;events&nbsp;originated</span><br>
<span class="lineno"></span><span class="comment" id="1591227">//&nbsp;at&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1591275">type</span>&nbsp;<span class="ident" id="1591280">BlockProfileRecord</span>&nbsp;<span class="keyword" id="1591299">struct</span>&nbsp;<span class="op" id="1591306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591309">Count</span>&nbsp;&nbsp;<span class="ident" id="1591316">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591323">Cycles</span>&nbsp;<span class="ident" id="1591330">int64</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591337">StackRecord</span><br>
<span class="lineno"></span><span class="op" id="1591349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1591352">//&nbsp;BlockProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1591434">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;BlockProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">470</span><span class="comment" id="1591513">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;BlockProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1591584">//</span><br>
<span class="lineno"></span><span class="comment" id="1591587">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1591643">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.blockprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1591700">//&nbsp;of&nbsp;calling&nbsp;BlockProfile&nbsp;directly.</span><br>
<span class="lineno">475</span><span class="keyword" id="1591737">func</span>&nbsp;<span class="ident" id="1591742">BlockProfile</span><span class="op" id="1591754">(</span><span class="ident" id="1591755">p</span>&nbsp;<span class="op" id="1591757">[</span><span class="op" id="1591758">]</span><span class="ident" id="1591759">BlockProfileRecord</span><span class="op" id="1591777">)</span>&nbsp;<span class="op" id="1591779">(</span><span class="ident" id="1591780">n</span>&nbsp;<span class="builtintype" id="1591782">int</span><span class="op" id="1591785">,</span>&nbsp;<span class="ident" id="1591787">ok</span>&nbsp;<span class="builtintype" id="1591790">bool</span><span class="op" id="1591794">)</span>&nbsp;<span class="op" id="1591796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591799">lock</span><span class="op" id="1591803">(</span><span class="op" id="1591804">&amp;</span><span class="ident" id="1591805">proflock</span><span class="op" id="1591813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591816">for</span>&nbsp;<span class="ident" id="1591820">b</span>&nbsp;<span class="op" id="1591822">:=</span>&nbsp;<span class="ident" id="1591825">bbuckets</span><span class="op" id="1591833">;</span>&nbsp;<span class="ident" id="1591835">b</span>&nbsp;<span class="op" id="1591837">!=</span>&nbsp;<span class="builtintype" id="1591840">nil</span><span class="op" id="1591843">;</span>&nbsp;<span class="ident" id="1591845">b</span>&nbsp;<span class="op" id="1591847">=</span>&nbsp;<span class="ident" id="1591849">b</span><span class="op" id="1591850">.</span><span class="ident" id="1591851">allnext</span>&nbsp;<span class="op" id="1591859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591863">n</span><span class="op" id="1591864">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1591868">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591871">if</span>&nbsp;<span class="ident" id="1591874">n</span>&nbsp;<span class="op" id="1591876">&lt;=</span>&nbsp;<span class="builtinfunc" id="1591879">len</span><span class="op" id="1591882">(</span><span class="ident" id="1591883">p</span><span class="op" id="1591884">)</span>&nbsp;<span class="op" id="1591886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591890">ok</span>&nbsp;<span class="op" id="1591893">=</span>&nbsp;<span class="builtintype" id="1591895">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591902">for</span>&nbsp;<span class="ident" id="1591906">b</span>&nbsp;<span class="op" id="1591908">:=</span>&nbsp;<span class="ident" id="1591911">bbuckets</span><span class="op" id="1591919">;</span>&nbsp;<span class="ident" id="1591921">b</span>&nbsp;<span class="op" id="1591923">!=</span>&nbsp;<span class="builtintype" id="1591926">nil</span><span class="op" id="1591929">;</span>&nbsp;<span class="ident" id="1591931">b</span>&nbsp;<span class="op" id="1591933">=</span>&nbsp;<span class="ident" id="1591935">b</span><span class="op" id="1591936">.</span><span class="ident" id="1591937">allnext</span>&nbsp;<span class="op" id="1591945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591950">bp</span>&nbsp;<span class="op" id="1591953">:=</span>&nbsp;<span class="ident" id="1591956">b</span><span class="op" id="1591957">.</span><span class="ident" id="1591958">bp</span><span class="op" id="1591960">(</span><span class="op" id="1591961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591966">r</span>&nbsp;<span class="op" id="1591968">:=</span>&nbsp;<span class="op" id="1591971">&amp;</span><span class="ident" id="1591972">p</span><span class="op" id="1591973">[</span><span class="num" id="1591974">0</span><span class="op" id="1591975">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591980">r</span><span class="op" id="1591981">.</span><span class="ident" id="1591982">Count</span>&nbsp;<span class="op" id="1591988">=</span>&nbsp;<span class="ident" id="1591990">int64</span><span class="op" id="1591995">(</span><span class="ident" id="1591996">bp</span><span class="op" id="1591998">.</span><span class="ident" id="1591999">count</span><span class="op" id="1592004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592009">r</span><span class="op" id="1592010">.</span><span class="ident" id="1592011">Cycles</span>&nbsp;<span class="op" id="1592018">=</span>&nbsp;<span class="ident" id="1592020">int64</span><span class="op" id="1592025">(</span><span class="ident" id="1592026">bp</span><span class="op" id="1592028">.</span><span class="ident" id="1592029">cycles</span><span class="op" id="1592035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592040">i</span>&nbsp;<span class="op" id="1592042">:=</span>&nbsp;<span class="builtinfunc" id="1592045">copy</span><span class="op" id="1592049">(</span><span class="ident" id="1592050">r</span><span class="op" id="1592051">.</span><span class="ident" id="1592052">Stack0</span><span class="op" id="1592058">[</span><span class="op" id="1592059">:</span><span class="op" id="1592060">]</span><span class="op" id="1592061">,</span>&nbsp;<span class="ident" id="1592063">b</span><span class="op" id="1592064">.</span><span class="ident" id="1592065">stk</span><span class="op" id="1592068">(</span><span class="op" id="1592069">)</span><span class="op" id="1592070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592075">for</span>&nbsp;<span class="op" id="1592079">;</span>&nbsp;<span class="ident" id="1592081">i</span>&nbsp;<span class="op" id="1592083">&lt;</span>&nbsp;<span class="builtinfunc" id="1592085">len</span><span class="op" id="1592088">(</span><span class="ident" id="1592089">r</span><span class="op" id="1592090">.</span><span class="ident" id="1592091">Stack0</span><span class="op" id="1592097">)</span><span class="op" id="1592098">;</span>&nbsp;<span class="ident" id="1592100">i</span><span class="op" id="1592101">++</span>&nbsp;<span class="op" id="1592104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592110">r</span><span class="op" id="1592111">.</span><span class="ident" id="1592112">Stack0</span><span class="op" id="1592118">[</span><span class="ident" id="1592119">i</span><span class="op" id="1592120">]</span>&nbsp;<span class="op" id="1592122">=</span>&nbsp;<span class="num" id="1592124">0</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592134">p</span>&nbsp;<span class="op" id="1592136">=</span>&nbsp;<span class="ident" id="1592138">p</span><span class="op" id="1592139">[</span><span class="num" id="1592140">1</span><span class="op" id="1592141">:</span><span class="op" id="1592142">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592152">unlock</span><span class="op" id="1592158">(</span><span class="op" id="1592159">&amp;</span><span class="ident" id="1592160">proflock</span><span class="op" id="1592168">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592171">return</span><br>
<span class="lineno"></span><span class="op" id="1592178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1592181">//&nbsp;ThreadCreateProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;thread&nbsp;creation&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1592269">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">500</span><span class="comment" id="1592355">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1592433">//</span><br>
<span class="lineno"></span><span class="comment" id="1592436">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1592497">//&nbsp;of&nbsp;calling&nbsp;ThreadCreateProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1592541">func</span>&nbsp;<span class="ident" id="1592546">ThreadCreateProfile</span><span class="op" id="1592565">(</span><span class="ident" id="1592566">p</span>&nbsp;<span class="op" id="1592568">[</span><span class="op" id="1592569">]</span><span class="ident" id="1592570">StackRecord</span><span class="op" id="1592581">)</span>&nbsp;<span class="op" id="1592583">(</span><span class="ident" id="1592584">n</span>&nbsp;<span class="builtintype" id="1592586">int</span><span class="op" id="1592589">,</span>&nbsp;<span class="ident" id="1592591">ok</span>&nbsp;<span class="builtintype" id="1592594">bool</span><span class="op" id="1592598">)</span>&nbsp;<span class="op" id="1592600">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592603">first</span>&nbsp;<span class="op" id="1592609">:=</span>&nbsp;<span class="op" id="1592612">(</span><span class="op" id="1592613">*</span><span class="ident" id="1592614">m</span><span class="op" id="1592615">)</span><span class="op" id="1592616">(</span><span class="ident" id="1592617">atomicloadp</span><span class="op" id="1592628">(</span><span class="ident" id="1592629">unsafe</span><span class="op" id="1592635">.</span><span class="ident" id="1592636">Pointer</span><span class="op" id="1592643">(</span><span class="op" id="1592644">&amp;</span><span class="ident" id="1592645">allm</span><span class="op" id="1592649">)</span><span class="op" id="1592650">)</span><span class="op" id="1592651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592654">for</span>&nbsp;<span class="ident" id="1592658">mp</span>&nbsp;<span class="op" id="1592661">:=</span>&nbsp;<span class="ident" id="1592664">first</span><span class="op" id="1592669">;</span>&nbsp;<span class="ident" id="1592671">mp</span>&nbsp;<span class="op" id="1592674">!=</span>&nbsp;<span class="builtintype" id="1592677">nil</span><span class="op" id="1592680">;</span>&nbsp;<span class="ident" id="1592682">mp</span>&nbsp;<span class="op" id="1592685">=</span>&nbsp;<span class="ident" id="1592687">mp</span><span class="op" id="1592689">.</span><span class="ident" id="1592690">alllink</span>&nbsp;<span class="op" id="1592698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592702">n</span><span class="op" id="1592703">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592710">if</span>&nbsp;<span class="ident" id="1592713">n</span>&nbsp;<span class="op" id="1592715">&lt;=</span>&nbsp;<span class="builtinfunc" id="1592718">len</span><span class="op" id="1592721">(</span><span class="ident" id="1592722">p</span><span class="op" id="1592723">)</span>&nbsp;<span class="op" id="1592725">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592729">ok</span>&nbsp;<span class="op" id="1592732">=</span>&nbsp;<span class="builtintype" id="1592734">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592741">i</span>&nbsp;<span class="op" id="1592743">:=</span>&nbsp;<span class="num" id="1592746">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592750">for</span>&nbsp;<span class="ident" id="1592754">mp</span>&nbsp;<span class="op" id="1592757">:=</span>&nbsp;<span class="ident" id="1592760">first</span><span class="op" id="1592765">;</span>&nbsp;<span class="ident" id="1592767">mp</span>&nbsp;<span class="op" id="1592770">!=</span>&nbsp;<span class="builtintype" id="1592773">nil</span><span class="op" id="1592776">;</span>&nbsp;<span class="ident" id="1592778">mp</span>&nbsp;<span class="op" id="1592781">=</span>&nbsp;<span class="ident" id="1592783">mp</span><span class="op" id="1592785">.</span><span class="ident" id="1592786">alllink</span>&nbsp;<span class="op" id="1592794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592799">for</span>&nbsp;<span class="ident" id="1592803">s</span>&nbsp;<span class="op" id="1592805">:=</span>&nbsp;<span class="keyword" id="1592808">range</span>&nbsp;<span class="ident" id="1592814">mp</span><span class="op" id="1592816">.</span><span class="ident" id="1592817">createstack</span>&nbsp;<span class="op" id="1592829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592835">p</span><span class="op" id="1592836">[</span><span class="ident" id="1592837">i</span><span class="op" id="1592838">]</span><span class="op" id="1592839">.</span><span class="ident" id="1592840">Stack0</span><span class="op" id="1592846">[</span><span class="ident" id="1592847">s</span><span class="op" id="1592848">]</span>&nbsp;<span class="op" id="1592850">=</span>&nbsp;<span class="builtintype" id="1592852">uintptr</span><span class="op" id="1592859">(</span><span class="ident" id="1592860">mp</span><span class="op" id="1592862">.</span><span class="ident" id="1592863">createstack</span><span class="op" id="1592874">[</span><span class="ident" id="1592875">s</span><span class="op" id="1592876">]</span><span class="op" id="1592877">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592887">i</span><span class="op" id="1592888">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592899">return</span><br>
<span class="lineno">520</span><span class="op" id="1592906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1592909">var</span>&nbsp;<span class="ident" id="1592913">allgs</span>&nbsp;<span class="op" id="1592919">[</span><span class="op" id="1592920">]</span><span class="op" id="1592921">*</span><span class="ident" id="1592922">g</span>&nbsp;<span class="comment" id="1592924">//&nbsp;proc.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1592935">//&nbsp;GoroutineProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;active&nbsp;goroutine&nbsp;stack&nbsp;profile.</span><br>
<span class="lineno">525</span><span class="comment" id="1593027">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;GoroutineProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1593110">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;GoroutineProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1593185">//</span><br>
<span class="lineno"></span><span class="comment" id="1593188">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1593249">//&nbsp;of&nbsp;calling&nbsp;GoroutineProfile&nbsp;directly.</span><br>
<span class="lineno">530</span><span class="keyword" id="1593290">func</span>&nbsp;<span class="ident" id="1593295">GoroutineProfile</span><span class="op" id="1593311">(</span><span class="ident" id="1593312">p</span>&nbsp;<span class="op" id="1593314">[</span><span class="op" id="1593315">]</span><span class="ident" id="1593316">StackRecord</span><span class="op" id="1593327">)</span>&nbsp;<span class="op" id="1593329">(</span><span class="ident" id="1593330">n</span>&nbsp;<span class="builtintype" id="1593332">int</span><span class="op" id="1593335">,</span>&nbsp;<span class="ident" id="1593337">ok</span>&nbsp;<span class="builtintype" id="1593340">bool</span><span class="op" id="1593344">)</span>&nbsp;<span class="op" id="1593346">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593350">n</span>&nbsp;<span class="op" id="1593352">=</span>&nbsp;<span class="ident" id="1593354">NumGoroutine</span><span class="op" id="1593366">(</span><span class="op" id="1593367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593370">if</span>&nbsp;<span class="ident" id="1593373">n</span>&nbsp;<span class="op" id="1593375">&lt;=</span>&nbsp;<span class="builtinfunc" id="1593378">len</span><span class="op" id="1593381">(</span><span class="ident" id="1593382">p</span><span class="op" id="1593383">)</span>&nbsp;<span class="op" id="1593385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593389">gp</span>&nbsp;<span class="op" id="1593392">:=</span>&nbsp;<span class="ident" id="1593395">getg</span><span class="op" id="1593399">(</span><span class="op" id="1593400">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593404">semacquire</span><span class="op" id="1593414">(</span><span class="op" id="1593415">&amp;</span><span class="ident" id="1593416">worldsema</span><span class="op" id="1593425">,</span>&nbsp;<span class="builtintype" id="1593427">false</span><span class="op" id="1593432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593436">gp</span><span class="op" id="1593438">.</span><span class="ident" id="1593439">m</span><span class="op" id="1593440">.</span><span class="ident" id="1593441">gcing</span>&nbsp;<span class="op" id="1593447">=</span>&nbsp;<span class="num" id="1593449">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593453">onM</span><span class="op" id="1593456">(</span><span class="ident" id="1593457">stoptheworld</span><span class="op" id="1593469">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593474">n</span>&nbsp;<span class="op" id="1593476">=</span>&nbsp;<span class="ident" id="1593478">NumGoroutine</span><span class="op" id="1593490">(</span><span class="op" id="1593491">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593495">if</span>&nbsp;<span class="ident" id="1593498">n</span>&nbsp;<span class="op" id="1593500">&lt;=</span>&nbsp;<span class="builtinfunc" id="1593503">len</span><span class="op" id="1593506">(</span><span class="ident" id="1593507">p</span><span class="op" id="1593508">)</span>&nbsp;<span class="op" id="1593510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593515">ok</span>&nbsp;<span class="op" id="1593518">=</span>&nbsp;<span class="builtintype" id="1593520">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593528">r</span>&nbsp;<span class="op" id="1593530">:=</span>&nbsp;<span class="ident" id="1593533">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593538">sp</span>&nbsp;<span class="op" id="1593541">:=</span>&nbsp;<span class="ident" id="1593544">getcallersp</span><span class="op" id="1593555">(</span><span class="ident" id="1593556">unsafe</span><span class="op" id="1593562">.</span><span class="ident" id="1593563">Pointer</span><span class="op" id="1593570">(</span><span class="op" id="1593571">&amp;</span><span class="ident" id="1593572">p</span><span class="op" id="1593573">)</span><span class="op" id="1593574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593579">pc</span>&nbsp;<span class="op" id="1593582">:=</span>&nbsp;<span class="ident" id="1593585">getcallerpc</span><span class="op" id="1593596">(</span><span class="ident" id="1593597">unsafe</span><span class="op" id="1593603">.</span><span class="ident" id="1593604">Pointer</span><span class="op" id="1593611">(</span><span class="op" id="1593612">&amp;</span><span class="ident" id="1593613">p</span><span class="op" id="1593614">)</span><span class="op" id="1593615">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593620">onM</span><span class="op" id="1593623">(</span><span class="keyword" id="1593624">func</span><span class="op" id="1593628">(</span><span class="op" id="1593629">)</span>&nbsp;<span class="op" id="1593631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593637">saveg</span><span class="op" id="1593642">(</span><span class="ident" id="1593643">pc</span><span class="op" id="1593645">,</span>&nbsp;<span class="ident" id="1593647">sp</span><span class="op" id="1593649">,</span>&nbsp;<span class="ident" id="1593651">gp</span><span class="op" id="1593653">,</span>&nbsp;<span class="op" id="1593655">&amp;</span><span class="ident" id="1593656">r</span><span class="op" id="1593657">[</span><span class="num" id="1593658">0</span><span class="op" id="1593659">]</span><span class="op" id="1593660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1593665">}</span><span class="op" id="1593666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593671">r</span>&nbsp;<span class="op" id="1593673">=</span>&nbsp;<span class="ident" id="1593675">r</span><span class="op" id="1593676">[</span><span class="num" id="1593677">1</span><span class="op" id="1593678">:</span><span class="op" id="1593679">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593684">for</span>&nbsp;<span class="ident" id="1593688">_</span><span class="op" id="1593689">,</span>&nbsp;<span class="ident" id="1593691">gp1</span>&nbsp;<span class="op" id="1593695">:=</span>&nbsp;<span class="keyword" id="1593698">range</span>&nbsp;<span class="ident" id="1593704">allgs</span>&nbsp;<span class="op" id="1593710">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593716">if</span>&nbsp;<span class="ident" id="1593719">gp1</span>&nbsp;<span class="op" id="1593723">==</span>&nbsp;<span class="ident" id="1593726">gp</span>&nbsp;<span class="op" id="1593729">||</span>&nbsp;<span class="ident" id="1593732">readgstatus</span><span class="op" id="1593743">(</span><span class="ident" id="1593744">gp1</span><span class="op" id="1593747">)</span>&nbsp;<span class="op" id="1593749">==</span>&nbsp;<span class="ident" id="1593752">_Gdead</span>&nbsp;<span class="op" id="1593759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593766">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1593779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593785">saveg</span><span class="op" id="1593790">(</span><span class="op" id="1593791">^</span><span class="builtintype" id="1593792">uintptr</span><span class="op" id="1593799">(</span><span class="num" id="1593800">0</span><span class="op" id="1593801">)</span><span class="op" id="1593802">,</span>&nbsp;<span class="op" id="1593804">^</span><span class="builtintype" id="1593805">uintptr</span><span class="op" id="1593812">(</span><span class="num" id="1593813">0</span><span class="op" id="1593814">)</span><span class="op" id="1593815">,</span>&nbsp;<span class="ident" id="1593817">gp1</span><span class="op" id="1593820">,</span>&nbsp;<span class="op" id="1593822">&amp;</span><span class="ident" id="1593823">r</span><span class="op" id="1593824">[</span><span class="num" id="1593825">0</span><span class="op" id="1593826">]</span><span class="op" id="1593827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593833">r</span>&nbsp;<span class="op" id="1593835">=</span>&nbsp;<span class="ident" id="1593837">r</span><span class="op" id="1593838">[</span><span class="num" id="1593839">1</span><span class="op" id="1593840">:</span><span class="op" id="1593841">]</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1593846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1593850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593855">gp</span><span class="op" id="1593857">.</span><span class="ident" id="1593858">m</span><span class="op" id="1593859">.</span><span class="ident" id="1593860">gcing</span>&nbsp;<span class="op" id="1593866">=</span>&nbsp;<span class="num" id="1593868">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593872">semrelease</span><span class="op" id="1593882">(</span><span class="op" id="1593883">&amp;</span><span class="ident" id="1593884">worldsema</span><span class="op" id="1593893">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593897">onM</span><span class="op" id="1593900">(</span><span class="ident" id="1593901">starttheworld</span><span class="op" id="1593914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1593917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593921">return</span>&nbsp;<span class="ident" id="1593928">n</span><span class="op" id="1593929">,</span>&nbsp;<span class="ident" id="1593931">ok</span><br>
<span class="lineno"></span><span class="op" id="1593934">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="keyword" id="1593937">func</span>&nbsp;<span class="ident" id="1593942">saveg</span><span class="op" id="1593947">(</span><span class="ident" id="1593948">pc</span><span class="op" id="1593950">,</span>&nbsp;<span class="ident" id="1593952">sp</span>&nbsp;<span class="builtintype" id="1593955">uintptr</span><span class="op" id="1593962">,</span>&nbsp;<span class="ident" id="1593964">gp</span>&nbsp;<span class="op" id="1593967">*</span><span class="ident" id="1593968">g</span><span class="op" id="1593969">,</span>&nbsp;<span class="ident" id="1593971">r</span>&nbsp;<span class="op" id="1593973">*</span><span class="ident" id="1593974">StackRecord</span><span class="op" id="1593985">)</span>&nbsp;<span class="op" id="1593987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593990">n</span>&nbsp;<span class="op" id="1593992">:=</span>&nbsp;<span class="ident" id="1593995">gentraceback</span><span class="op" id="1594007">(</span><span class="ident" id="1594008">pc</span><span class="op" id="1594010">,</span>&nbsp;<span class="ident" id="1594012">sp</span><span class="op" id="1594014">,</span>&nbsp;<span class="num" id="1594016">0</span><span class="op" id="1594017">,</span>&nbsp;<span class="ident" id="1594019">gp</span><span class="op" id="1594021">,</span>&nbsp;<span class="num" id="1594023">0</span><span class="op" id="1594024">,</span>&nbsp;<span class="op" id="1594026">&amp;</span><span class="ident" id="1594027">r</span><span class="op" id="1594028">.</span><span class="ident" id="1594029">Stack0</span><span class="op" id="1594035">[</span><span class="num" id="1594036">0</span><span class="op" id="1594037">]</span><span class="op" id="1594038">,</span>&nbsp;<span class="builtinfunc" id="1594040">len</span><span class="op" id="1594043">(</span><span class="ident" id="1594044">r</span><span class="op" id="1594045">.</span><span class="ident" id="1594046">Stack0</span><span class="op" id="1594052">)</span><span class="op" id="1594053">,</span>&nbsp;<span class="builtintype" id="1594055">nil</span><span class="op" id="1594058">,</span>&nbsp;<span class="builtintype" id="1594060">nil</span><span class="op" id="1594063">,</span>&nbsp;<span class="num" id="1594065">0</span><span class="op" id="1594066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594069">if</span>&nbsp;<span class="ident" id="1594072">n</span>&nbsp;<span class="op" id="1594074">&lt;</span>&nbsp;<span class="builtinfunc" id="1594076">len</span><span class="op" id="1594079">(</span><span class="ident" id="1594080">r</span><span class="op" id="1594081">.</span><span class="ident" id="1594082">Stack0</span><span class="op" id="1594088">)</span>&nbsp;<span class="op" id="1594090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594094">r</span><span class="op" id="1594095">.</span><span class="ident" id="1594096">Stack0</span><span class="op" id="1594102">[</span><span class="ident" id="1594103">n</span><span class="op" id="1594104">]</span>&nbsp;<span class="op" id="1594106">=</span>&nbsp;<span class="num" id="1594108">0</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1594111">}</span><br>
<span class="lineno"></span><span class="op" id="1594113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1594116">//&nbsp;Stack&nbsp;formats&nbsp;a&nbsp;stack&nbsp;trace&nbsp;of&nbsp;the&nbsp;calling&nbsp;goroutine&nbsp;into&nbsp;buf</span><br>
<span class="lineno"></span><span class="comment" id="1594181">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;to&nbsp;buf.</span><br>
<span class="lineno">575</span><span class="comment" id="1594232">//&nbsp;If&nbsp;all&nbsp;is&nbsp;true,&nbsp;Stack&nbsp;formats&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;other&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="1594302">//&nbsp;into&nbsp;buf&nbsp;after&nbsp;the&nbsp;trace&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1594357">func</span>&nbsp;<span class="ident" id="1594362">Stack</span><span class="op" id="1594367">(</span><span class="ident" id="1594368">buf</span>&nbsp;<span class="op" id="1594372">[</span><span class="op" id="1594373">]</span><span class="builtintype" id="1594374">byte</span><span class="op" id="1594378">,</span>&nbsp;<span class="ident" id="1594380">all</span>&nbsp;<span class="builtintype" id="1594384">bool</span><span class="op" id="1594388">)</span>&nbsp;<span class="builtintype" id="1594390">int</span>&nbsp;<span class="op" id="1594394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594397">mp</span>&nbsp;<span class="op" id="1594400">:=</span>&nbsp;<span class="ident" id="1594403">acquirem</span><span class="op" id="1594411">(</span><span class="op" id="1594412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594415">gp</span>&nbsp;<span class="op" id="1594418">:=</span>&nbsp;<span class="ident" id="1594421">mp</span><span class="op" id="1594423">.</span><span class="ident" id="1594424">curg</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594430">if</span>&nbsp;<span class="ident" id="1594433">all</span>&nbsp;<span class="op" id="1594437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594441">semacquire</span><span class="op" id="1594451">(</span><span class="op" id="1594452">&amp;</span><span class="ident" id="1594453">worldsema</span><span class="op" id="1594462">,</span>&nbsp;<span class="builtintype" id="1594464">false</span><span class="op" id="1594469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594473">mp</span><span class="op" id="1594475">.</span><span class="ident" id="1594476">gcing</span>&nbsp;<span class="op" id="1594482">=</span>&nbsp;<span class="num" id="1594484">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594488">releasem</span><span class="op" id="1594496">(</span><span class="ident" id="1594497">mp</span><span class="op" id="1594499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594503">onM</span><span class="op" id="1594506">(</span><span class="ident" id="1594507">stoptheworld</span><span class="op" id="1594519">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594523">if</span>&nbsp;<span class="ident" id="1594526">mp</span>&nbsp;<span class="op" id="1594529">!=</span>&nbsp;<span class="ident" id="1594532">acquirem</span><span class="op" id="1594540">(</span><span class="op" id="1594541">)</span>&nbsp;<span class="op" id="1594543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594548">gothrow</span><span class="op" id="1594555">(</span><span class="string" id="1594556">&#34;Stack:&nbsp;rescheduled&#34;</span><span class="op" id="1594576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1594580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1594583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594587">n</span>&nbsp;<span class="op" id="1594589">:=</span>&nbsp;<span class="num" id="1594592">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594595">if</span>&nbsp;<span class="builtinfunc" id="1594598">len</span><span class="op" id="1594601">(</span><span class="ident" id="1594602">buf</span><span class="op" id="1594605">)</span>&nbsp;<span class="op" id="1594607">&gt;</span>&nbsp;<span class="num" id="1594609">0</span>&nbsp;<span class="op" id="1594611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594615">sp</span>&nbsp;<span class="op" id="1594618">:=</span>&nbsp;<span class="ident" id="1594621">getcallersp</span><span class="op" id="1594632">(</span><span class="ident" id="1594633">unsafe</span><span class="op" id="1594639">.</span><span class="ident" id="1594640">Pointer</span><span class="op" id="1594647">(</span><span class="op" id="1594648">&amp;</span><span class="ident" id="1594649">buf</span><span class="op" id="1594652">)</span><span class="op" id="1594653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594657">pc</span>&nbsp;<span class="op" id="1594660">:=</span>&nbsp;<span class="ident" id="1594663">getcallerpc</span><span class="op" id="1594674">(</span><span class="ident" id="1594675">unsafe</span><span class="op" id="1594681">.</span><span class="ident" id="1594682">Pointer</span><span class="op" id="1594689">(</span><span class="op" id="1594690">&amp;</span><span class="ident" id="1594691">buf</span><span class="op" id="1594694">)</span><span class="op" id="1594695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594699">onM</span><span class="op" id="1594702">(</span><span class="keyword" id="1594703">func</span><span class="op" id="1594707">(</span><span class="op" id="1594708">)</span>&nbsp;<span class="op" id="1594710">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594715">g0</span>&nbsp;<span class="op" id="1594718">:=</span>&nbsp;<span class="ident" id="1594721">getg</span><span class="op" id="1594725">(</span><span class="op" id="1594726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594731">g0</span><span class="op" id="1594733">.</span><span class="ident" id="1594734">writebuf</span>&nbsp;<span class="op" id="1594743">=</span>&nbsp;<span class="ident" id="1594745">buf</span><span class="op" id="1594748">[</span><span class="num" id="1594749">0</span><span class="op" id="1594750">:</span><span class="num" id="1594751">0</span><span class="op" id="1594752">:</span><span class="builtinfunc" id="1594753">len</span><span class="op" id="1594756">(</span><span class="ident" id="1594757">buf</span><span class="op" id="1594760">)</span><span class="op" id="1594761">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594766">goroutineheader</span><span class="op" id="1594781">(</span><span class="ident" id="1594782">gp</span><span class="op" id="1594784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594789">traceback</span><span class="op" id="1594798">(</span><span class="ident" id="1594799">pc</span><span class="op" id="1594801">,</span>&nbsp;<span class="ident" id="1594803">sp</span><span class="op" id="1594805">,</span>&nbsp;<span class="num" id="1594807">0</span><span class="op" id="1594808">,</span>&nbsp;<span class="ident" id="1594810">gp</span><span class="op" id="1594812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594817">if</span>&nbsp;<span class="ident" id="1594820">all</span>&nbsp;<span class="op" id="1594824">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594830">tracebackothers</span><span class="op" id="1594845">(</span><span class="ident" id="1594846">gp</span><span class="op" id="1594848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1594853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594858">n</span>&nbsp;<span class="op" id="1594860">=</span>&nbsp;<span class="builtinfunc" id="1594862">len</span><span class="op" id="1594865">(</span><span class="ident" id="1594866">g0</span><span class="op" id="1594868">.</span><span class="ident" id="1594869">writebuf</span><span class="op" id="1594877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594882">g0</span><span class="op" id="1594884">.</span><span class="ident" id="1594885">writebuf</span>&nbsp;<span class="op" id="1594894">=</span>&nbsp;<span class="builtintype" id="1594896">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1594902">}</span><span class="op" id="1594903">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1594906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594910">if</span>&nbsp;<span class="ident" id="1594913">all</span>&nbsp;<span class="op" id="1594917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594921">mp</span><span class="op" id="1594923">.</span><span class="ident" id="1594924">gcing</span>&nbsp;<span class="op" id="1594930">=</span>&nbsp;<span class="num" id="1594932">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594936">semrelease</span><span class="op" id="1594946">(</span><span class="op" id="1594947">&amp;</span><span class="ident" id="1594948">worldsema</span><span class="op" id="1594957">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594961">onM</span><span class="op" id="1594964">(</span><span class="ident" id="1594965">starttheworld</span><span class="op" id="1594978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1594981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594984">releasem</span><span class="op" id="1594992">(</span><span class="ident" id="1594993">mp</span><span class="op" id="1594995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594998">return</span>&nbsp;<span class="ident" id="1595005">n</span><br>
<span class="lineno"></span><span class="op" id="1595007">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="comment" id="1595010">//&nbsp;Tracing&nbsp;of&nbsp;alloc/free/gc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1595040">var</span>&nbsp;<span class="ident" id="1595044">tracelock</span>&nbsp;<span class="ident" id="1595054">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="1595061">func</span>&nbsp;<span class="ident" id="1595066">tracealloc</span><span class="op" id="1595076">(</span><span class="ident" id="1595077">p</span>&nbsp;<span class="ident" id="1595079">unsafe</span><span class="op" id="1595085">.</span><span class="ident" id="1595086">Pointer</span><span class="op" id="1595093">,</span>&nbsp;<span class="ident" id="1595095">size</span>&nbsp;<span class="builtintype" id="1595100">uintptr</span><span class="op" id="1595107">,</span>&nbsp;<span class="ident" id="1595109">typ</span>&nbsp;<span class="op" id="1595113">*</span><span class="ident" id="1595114">_type</span><span class="op" id="1595119">)</span>&nbsp;<span class="op" id="1595121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595124">lock</span><span class="op" id="1595128">(</span><span class="op" id="1595129">&amp;</span><span class="ident" id="1595130">tracelock</span><span class="op" id="1595139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595142">gp</span>&nbsp;<span class="op" id="1595145">:=</span>&nbsp;<span class="ident" id="1595148">getg</span><span class="op" id="1595152">(</span><span class="op" id="1595153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595156">gp</span><span class="op" id="1595158">.</span><span class="ident" id="1595159">m</span><span class="op" id="1595160">.</span><span class="ident" id="1595161">traceback</span>&nbsp;<span class="op" id="1595171">=</span>&nbsp;<span class="num" id="1595173">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1595176">if</span>&nbsp;<span class="ident" id="1595179">typ</span>&nbsp;<span class="op" id="1595183">==</span>&nbsp;<span class="builtintype" id="1595186">nil</span>&nbsp;<span class="op" id="1595190">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1595194">print</span><span class="op" id="1595199">(</span><span class="string" id="1595200">&#34;tracealloc(&#34;</span><span class="op" id="1595213">,</span>&nbsp;<span class="ident" id="1595215">p</span><span class="op" id="1595216">,</span>&nbsp;<span class="string" id="1595218">&#34;,&nbsp;&#34;</span><span class="op" id="1595222">,</span>&nbsp;<span class="ident" id="1595224">hex</span><span class="op" id="1595227">(</span><span class="ident" id="1595228">size</span><span class="op" id="1595232">)</span><span class="op" id="1595233">,</span>&nbsp;<span class="string" id="1595235">&#34;)\n&#34;</span><span class="op" id="1595240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1595243">}</span>&nbsp;<span class="keyword" id="1595245">else</span>&nbsp;<span class="op" id="1595250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1595254">print</span><span class="op" id="1595259">(</span><span class="string" id="1595260">&#34;tracealloc(&#34;</span><span class="op" id="1595273">,</span>&nbsp;<span class="ident" id="1595275">p</span><span class="op" id="1595276">,</span>&nbsp;<span class="string" id="1595278">&#34;,&nbsp;&#34;</span><span class="op" id="1595282">,</span>&nbsp;<span class="ident" id="1595284">hex</span><span class="op" id="1595287">(</span><span class="ident" id="1595288">size</span><span class="op" id="1595292">)</span><span class="op" id="1595293">,</span>&nbsp;<span class="string" id="1595295">&#34;,&nbsp;&#34;</span><span class="op" id="1595299">,</span>&nbsp;<span class="op" id="1595301">*</span><span class="ident" id="1595302">typ</span><span class="op" id="1595305">.</span><span class="ident" id="1595306">_string</span><span class="op" id="1595313">,</span>&nbsp;<span class="string" id="1595315">&#34;)\n&#34;</span><span class="op" id="1595320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1595323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1595326">if</span>&nbsp;<span class="ident" id="1595329">gp</span><span class="op" id="1595331">.</span><span class="ident" id="1595332">m</span><span class="op" id="1595333">.</span><span class="ident" id="1595334">curg</span>&nbsp;<span class="op" id="1595339">==</span>&nbsp;<span class="builtintype" id="1595342">nil</span>&nbsp;<span class="op" id="1595346">||</span>&nbsp;<span class="ident" id="1595349">gp</span>&nbsp;<span class="op" id="1595352">==</span>&nbsp;<span class="ident" id="1595355">gp</span><span class="op" id="1595357">.</span><span class="ident" id="1595358">m</span><span class="op" id="1595359">.</span><span class="ident" id="1595360">curg</span>&nbsp;<span class="op" id="1595365">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595369">goroutineheader</span><span class="op" id="1595384">(</span><span class="ident" id="1595385">gp</span><span class="op" id="1595387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595391">pc</span>&nbsp;<span class="op" id="1595394">:=</span>&nbsp;<span class="ident" id="1595397">getcallerpc</span><span class="op" id="1595408">(</span><span class="ident" id="1595409">unsafe</span><span class="op" id="1595415">.</span><span class="ident" id="1595416">Pointer</span><span class="op" id="1595423">(</span><span class="op" id="1595424">&amp;</span><span class="ident" id="1595425">p</span><span class="op" id="1595426">)</span><span class="op" id="1595427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595431">sp</span>&nbsp;<span class="op" id="1595434">:=</span>&nbsp;<span class="ident" id="1595437">getcallersp</span><span class="op" id="1595448">(</span><span class="ident" id="1595449">unsafe</span><span class="op" id="1595455">.</span><span class="ident" id="1595456">Pointer</span><span class="op" id="1595463">(</span><span class="op" id="1595464">&amp;</span><span class="ident" id="1595465">p</span><span class="op" id="1595466">)</span><span class="op" id="1595467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595471">onM</span><span class="op" id="1595474">(</span><span class="keyword" id="1595475">func</span><span class="op" id="1595479">(</span><span class="op" id="1595480">)</span>&nbsp;<span class="op" id="1595482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595487">traceback</span><span class="op" id="1595496">(</span><span class="ident" id="1595497">pc</span><span class="op" id="1595499">,</span>&nbsp;<span class="ident" id="1595501">sp</span><span class="op" id="1595503">,</span>&nbsp;<span class="num" id="1595505">0</span><span class="op" id="1595506">,</span>&nbsp;<span class="ident" id="1595508">gp</span><span class="op" id="1595510">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1595514">}</span><span class="op" id="1595515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1595518">}</span>&nbsp;<span class="keyword" id="1595520">else</span>&nbsp;<span class="op" id="1595525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595529">goroutineheader</span><span class="op" id="1595544">(</span><span class="ident" id="1595545">gp</span><span class="op" id="1595547">.</span><span class="ident" id="1595548">m</span><span class="op" id="1595549">.</span><span class="ident" id="1595550">curg</span><span class="op" id="1595554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595558">traceback</span><span class="op" id="1595567">(</span><span class="op" id="1595568">^</span><span class="builtintype" id="1595569">uintptr</span><span class="op" id="1595576">(</span><span class="num" id="1595577">0</span><span class="op" id="1595578">)</span><span class="op" id="1595579">,</span>&nbsp;<span class="op" id="1595581">^</span><span class="builtintype" id="1595582">uintptr</span><span class="op" id="1595589">(</span><span class="num" id="1595590">0</span><span class="op" id="1595591">)</span><span class="op" id="1595592">,</span>&nbsp;<span class="num" id="1595594">0</span><span class="op" id="1595595">,</span>&nbsp;<span class="ident" id="1595597">gp</span><span class="op" id="1595599">.</span><span class="ident" id="1595600">m</span><span class="op" id="1595601">.</span><span class="ident" id="1595602">curg</span><span class="op" id="1595606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1595609">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1595612">print</span><span class="op" id="1595617">(</span><span class="string" id="1595618">&#34;\n&#34;</span><span class="op" id="1595622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595625">gp</span><span class="op" id="1595627">.</span><span class="ident" id="1595628">m</span><span class="op" id="1595629">.</span><span class="ident" id="1595630">traceback</span>&nbsp;<span class="op" id="1595640">=</span>&nbsp;<span class="num" id="1595642">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595645">unlock</span><span class="op" id="1595651">(</span><span class="op" id="1595652">&amp;</span><span class="ident" id="1595653">tracelock</span><span class="op" id="1595662">)</span><br>
<span class="lineno"></span><span class="op" id="1595664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span><span class="keyword" id="1595667">func</span>&nbsp;<span class="ident" id="1595672">tracefree</span><span class="op" id="1595681">(</span><span class="ident" id="1595682">p</span>&nbsp;<span class="ident" id="1595684">unsafe</span><span class="op" id="1595690">.</span><span class="ident" id="1595691">Pointer</span><span class="op" id="1595698">,</span>&nbsp;<span class="ident" id="1595700">size</span>&nbsp;<span class="builtintype" id="1595705">uintptr</span><span class="op" id="1595712">)</span>&nbsp;<span class="op" id="1595714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595717">lock</span><span class="op" id="1595721">(</span><span class="op" id="1595722">&amp;</span><span class="ident" id="1595723">tracelock</span><span class="op" id="1595732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595735">gp</span>&nbsp;<span class="op" id="1595738">:=</span>&nbsp;<span class="ident" id="1595741">getg</span><span class="op" id="1595745">(</span><span class="op" id="1595746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595749">gp</span><span class="op" id="1595751">.</span><span class="ident" id="1595752">m</span><span class="op" id="1595753">.</span><span class="ident" id="1595754">traceback</span>&nbsp;<span class="op" id="1595764">=</span>&nbsp;<span class="num" id="1595766">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1595769">print</span><span class="op" id="1595774">(</span><span class="string" id="1595775">&#34;tracefree(&#34;</span><span class="op" id="1595787">,</span>&nbsp;<span class="ident" id="1595789">p</span><span class="op" id="1595790">,</span>&nbsp;<span class="string" id="1595792">&#34;,&nbsp;&#34;</span><span class="op" id="1595796">,</span>&nbsp;<span class="ident" id="1595798">hex</span><span class="op" id="1595801">(</span><span class="ident" id="1595802">size</span><span class="op" id="1595806">)</span><span class="op" id="1595807">,</span>&nbsp;<span class="string" id="1595809">&#34;)\n&#34;</span><span class="op" id="1595814">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595817">goroutineheader</span><span class="op" id="1595832">(</span><span class="ident" id="1595833">gp</span><span class="op" id="1595835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595838">pc</span>&nbsp;<span class="op" id="1595841">:=</span>&nbsp;<span class="ident" id="1595844">getcallerpc</span><span class="op" id="1595855">(</span><span class="ident" id="1595856">unsafe</span><span class="op" id="1595862">.</span><span class="ident" id="1595863">Pointer</span><span class="op" id="1595870">(</span><span class="op" id="1595871">&amp;</span><span class="ident" id="1595872">p</span><span class="op" id="1595873">)</span><span class="op" id="1595874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595877">sp</span>&nbsp;<span class="op" id="1595880">:=</span>&nbsp;<span class="ident" id="1595883">getcallersp</span><span class="op" id="1595894">(</span><span class="ident" id="1595895">unsafe</span><span class="op" id="1595901">.</span><span class="ident" id="1595902">Pointer</span><span class="op" id="1595909">(</span><span class="op" id="1595910">&amp;</span><span class="ident" id="1595911">p</span><span class="op" id="1595912">)</span><span class="op" id="1595913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595916">onM</span><span class="op" id="1595919">(</span><span class="keyword" id="1595920">func</span><span class="op" id="1595924">(</span><span class="op" id="1595925">)</span>&nbsp;<span class="op" id="1595927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595931">traceback</span><span class="op" id="1595940">(</span><span class="ident" id="1595941">pc</span><span class="op" id="1595943">,</span>&nbsp;<span class="ident" id="1595945">sp</span><span class="op" id="1595947">,</span>&nbsp;<span class="num" id="1595949">0</span><span class="op" id="1595950">,</span>&nbsp;<span class="ident" id="1595952">gp</span><span class="op" id="1595954">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1595957">}</span><span class="op" id="1595958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1595961">print</span><span class="op" id="1595966">(</span><span class="string" id="1595967">&#34;\n&#34;</span><span class="op" id="1595971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595974">gp</span><span class="op" id="1595976">.</span><span class="ident" id="1595977">m</span><span class="op" id="1595978">.</span><span class="ident" id="1595979">traceback</span>&nbsp;<span class="op" id="1595989">=</span>&nbsp;<span class="num" id="1595991">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595994">unlock</span><span class="op" id="1596000">(</span><span class="op" id="1596001">&amp;</span><span class="ident" id="1596002">tracelock</span><span class="op" id="1596011">)</span><br>
<span class="lineno"></span><span class="op" id="1596013">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="keyword" id="1596016">func</span>&nbsp;<span class="ident" id="1596021">tracegc</span><span class="op" id="1596028">(</span><span class="op" id="1596029">)</span>&nbsp;<span class="op" id="1596031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596034">lock</span><span class="op" id="1596038">(</span><span class="op" id="1596039">&amp;</span><span class="ident" id="1596040">tracelock</span><span class="op" id="1596049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596052">gp</span>&nbsp;<span class="op" id="1596055">:=</span>&nbsp;<span class="ident" id="1596058">getg</span><span class="op" id="1596062">(</span><span class="op" id="1596063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596066">gp</span><span class="op" id="1596068">.</span><span class="ident" id="1596069">m</span><span class="op" id="1596070">.</span><span class="ident" id="1596071">traceback</span>&nbsp;<span class="op" id="1596081">=</span>&nbsp;<span class="num" id="1596083">2</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1596086">print</span><span class="op" id="1596091">(</span><span class="string" id="1596092">&#34;tracegc()\n&#34;</span><span class="op" id="1596105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1596108">//&nbsp;running&nbsp;on&nbsp;m-&gt;g0&nbsp;stack;&nbsp;show&nbsp;all&nbsp;non-g0&nbsp;goroutines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596163">tracebackothers</span><span class="op" id="1596178">(</span><span class="ident" id="1596179">gp</span><span class="op" id="1596181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1596184">print</span><span class="op" id="1596189">(</span><span class="string" id="1596190">&#34;end&nbsp;tracegc\n&#34;</span><span class="op" id="1596205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1596208">print</span><span class="op" id="1596213">(</span><span class="string" id="1596214">&#34;\n&#34;</span><span class="op" id="1596218">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596221">gp</span><span class="op" id="1596223">.</span><span class="ident" id="1596224">m</span><span class="op" id="1596225">.</span><span class="ident" id="1596226">traceback</span>&nbsp;<span class="op" id="1596236">=</span>&nbsp;<span class="num" id="1596238">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596241">unlock</span><span class="op" id="1596247">(</span><span class="op" id="1596248">&amp;</span><span class="ident" id="1596249">tracelock</span><span class="op" id="1596258">)</span><br>
<span class="lineno"></span><span class="op" id="1596260">}</span>
</div>
</body>
</html>
