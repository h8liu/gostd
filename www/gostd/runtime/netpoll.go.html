<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html" class="current">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1583568">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1583623">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1583677">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1583728">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1583806">package</span>&nbsp;<span class="ident" id="1583814">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1583823">import</span>&nbsp;<span class="string" id="1583830">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1583840">//&nbsp;Integrated&nbsp;network&nbsp;poller&nbsp;(platform-independent&nbsp;part).</span><br>
<span class="lineno"></span><span class="comment" id="1583898">//&nbsp;A&nbsp;particular&nbsp;implementation&nbsp;(epoll/kqueue)&nbsp;must&nbsp;define&nbsp;the&nbsp;following&nbsp;functions:</span><br>
<span class="lineno"></span><span class="comment" id="1583981">//&nbsp;func&nbsp;netpollinit()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;to&nbsp;initialize&nbsp;the&nbsp;poller</span><br>
<span class="lineno"></span><span class="comment" id="1584033">//&nbsp;func&nbsp;netpollopen(fd&nbsp;uintptr,&nbsp;pd&nbsp;*pollDesc)&nbsp;int32&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;to&nbsp;arm&nbsp;edge-triggered&nbsp;notifications</span><br>
<span class="lineno">15</span><span class="comment" id="1584124">//&nbsp;and&nbsp;associate&nbsp;fd&nbsp;with&nbsp;pd.</span><br>
<span class="lineno"></span><span class="comment" id="1584153">//&nbsp;An&nbsp;implementation&nbsp;must&nbsp;call&nbsp;the&nbsp;following&nbsp;function&nbsp;to&nbsp;denote&nbsp;that&nbsp;the&nbsp;pd&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="comment" id="1584239">//&nbsp;func&nbsp;netpollready(gpp&nbsp;**g,&nbsp;pd&nbsp;*pollDesc,&nbsp;mode&nbsp;int32)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1584296">//&nbsp;pollDesc&nbsp;contains&nbsp;2&nbsp;binary&nbsp;semaphores,&nbsp;rg&nbsp;and&nbsp;wg,&nbsp;to&nbsp;park&nbsp;reader&nbsp;and&nbsp;writer</span><br>
<span class="lineno">20</span><span class="comment" id="1584375">//&nbsp;goroutines&nbsp;respectively.&nbsp;The&nbsp;semaphore&nbsp;can&nbsp;be&nbsp;in&nbsp;the&nbsp;following&nbsp;states:</span><br>
<span class="lineno"></span><span class="comment" id="1584449">//&nbsp;pdReady&nbsp;-&nbsp;io&nbsp;readiness&nbsp;notification&nbsp;is&nbsp;pending;</span><br>
<span class="lineno"></span><span class="comment" id="1584500">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;goroutine&nbsp;consumes&nbsp;the&nbsp;notification&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1584581">//&nbsp;pdWait&nbsp;-&nbsp;a&nbsp;goroutine&nbsp;prepares&nbsp;to&nbsp;park&nbsp;on&nbsp;the&nbsp;semaphore,&nbsp;but&nbsp;not&nbsp;yet&nbsp;parked;</span><br>
<span class="lineno"></span><span class="comment" id="1584660">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;goroutine&nbsp;commits&nbsp;to&nbsp;park&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;G&nbsp;pointer,</span><br>
<span class="lineno">25</span><span class="comment" id="1584738">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;io&nbsp;notification&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY,</span><br>
<span class="lineno"></span><span class="comment" id="1584824">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1584906">//&nbsp;G&nbsp;pointer&nbsp;-&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;blocked&nbsp;on&nbsp;the&nbsp;semaphore;</span><br>
<span class="lineno"></span><span class="comment" id="1584964">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io&nbsp;notification&nbsp;or&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY&nbsp;or&nbsp;nil&nbsp;respectively</span><br>
<span class="lineno"></span><span class="comment" id="1585059">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;unparks&nbsp;the&nbsp;goroutine.</span><br>
<span class="lineno">30</span><span class="comment" id="1585101">//&nbsp;nil&nbsp;-&nbsp;nothing&nbsp;of&nbsp;the&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="1585132">const</span>&nbsp;<span class="op" id="1585138">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585141">pdReady</span>&nbsp;<span class="builtintype" id="1585149">uintptr</span>&nbsp;<span class="op" id="1585157">=</span>&nbsp;<span class="num" id="1585159">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585162">pdWait</span>&nbsp;&nbsp;<span class="builtintype" id="1585170">uintptr</span>&nbsp;<span class="op" id="1585178">=</span>&nbsp;<span class="num" id="1585180">2</span><br>
<span class="lineno"></span><span class="op" id="1585182">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1585185">const</span>&nbsp;<span class="ident" id="1585191">pollBlockSize</span>&nbsp;<span class="op" id="1585205">=</span>&nbsp;<span class="num" id="1585207">4</span>&nbsp;<span class="op" id="1585209">*</span>&nbsp;<span class="num" id="1585211">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1585217">//&nbsp;Network&nbsp;poller&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="1585247">type</span>&nbsp;<span class="ident" id="1585252">pollDesc</span>&nbsp;<span class="keyword" id="1585261">struct</span>&nbsp;<span class="op" id="1585268">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585271">link</span>&nbsp;<span class="op" id="1585276">*</span><span class="ident" id="1585277">pollDesc</span>&nbsp;<span class="comment" id="1585286">//&nbsp;in&nbsp;pollcache,&nbsp;protected&nbsp;by&nbsp;pollcache.lock</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585333">//&nbsp;The&nbsp;lock&nbsp;protects&nbsp;pollOpen,&nbsp;pollSetDeadline,&nbsp;pollUnblock&nbsp;and&nbsp;deadlineimpl&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585423">//&nbsp;This&nbsp;fully&nbsp;covers&nbsp;seq,&nbsp;rt&nbsp;and&nbsp;wt&nbsp;variables.&nbsp;fd&nbsp;is&nbsp;constant&nbsp;throughout&nbsp;the&nbsp;PollDesc&nbsp;lifetime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585520">//&nbsp;pollReset,&nbsp;pollWait,&nbsp;pollWaitCanceled&nbsp;and&nbsp;runtimeÂ·netpollready&nbsp;(IO&nbsp;readiness&nbsp;notification)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585616">//&nbsp;proceed&nbsp;w/o&nbsp;taking&nbsp;the&nbsp;lock.&nbsp;So&nbsp;closing,&nbsp;rg,&nbsp;rd,&nbsp;wg&nbsp;and&nbsp;wd&nbsp;are&nbsp;manipulated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585695">//&nbsp;in&nbsp;a&nbsp;lock-free&nbsp;way&nbsp;by&nbsp;all&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585737">//&nbsp;NOTE(dvyukov):&nbsp;the&nbsp;following&nbsp;code&nbsp;uses&nbsp;uintptr&nbsp;to&nbsp;store&nbsp;*g&nbsp;(rg/wg),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585809">//&nbsp;that&nbsp;will&nbsp;blow&nbsp;up&nbsp;when&nbsp;GC&nbsp;starts&nbsp;moving&nbsp;objects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585862">lock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585870">mutex</span>&nbsp;<span class="comment" id="1585876">//&nbsp;protectes&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585911">fd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1585919">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585928">closing</span>&nbsp;<span class="builtintype" id="1585936">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585942">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1585950">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585965">//&nbsp;protects&nbsp;from&nbsp;stale&nbsp;timers&nbsp;and&nbsp;ready&nbsp;notifications</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586020">rg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1586028">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586043">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;read&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586090">rt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586098">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586113">//&nbsp;read&nbsp;deadline&nbsp;timer&nbsp;(set&nbsp;if&nbsp;rt.f&nbsp;!=&nbsp;nil)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586158">rd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586166">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586181">//&nbsp;read&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586199">wg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1586207">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586222">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;write&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586270">wt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586278">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586293">//&nbsp;write&nbsp;deadline&nbsp;timer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586318">wd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586326">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586341">//&nbsp;write&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586360">user</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586368">unsafe</span><span class="op" id="1586374">.</span><span class="ident" id="1586375">Pointer</span>&nbsp;<span class="comment" id="1586383">//&nbsp;user&nbsp;settable&nbsp;cookie</span><br>
<span class="lineno">60</span><span class="op" id="1586407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1586410">type</span>&nbsp;<span class="ident" id="1586415">pollCache</span>&nbsp;<span class="keyword" id="1586425">struct</span>&nbsp;<span class="op" id="1586432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586435">lock</span>&nbsp;&nbsp;<span class="ident" id="1586441">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586448">first</span>&nbsp;<span class="op" id="1586454">*</span><span class="ident" id="1586455">pollDesc</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586465">//&nbsp;PollDesc&nbsp;objects&nbsp;must&nbsp;be&nbsp;type-stable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586507">//&nbsp;because&nbsp;we&nbsp;can&nbsp;get&nbsp;ready&nbsp;notification&nbsp;from&nbsp;epoll/kqueue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586567">//&nbsp;after&nbsp;the&nbsp;descriptor&nbsp;is&nbsp;closed/reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586610">//&nbsp;Stale&nbsp;notifications&nbsp;are&nbsp;detected&nbsp;using&nbsp;seq&nbsp;variable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586667">//&nbsp;seq&nbsp;is&nbsp;incremented&nbsp;when&nbsp;deadlines&nbsp;are&nbsp;changed&nbsp;or&nbsp;descriptor&nbsp;is&nbsp;reused.</span><br>
<span class="lineno">70</span><span class="op" id="1586741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1586744">var</span>&nbsp;<span class="ident" id="1586748">pollcache</span>&nbsp;<span class="ident" id="1586758">pollCache</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1586769">func</span>&nbsp;<span class="ident" id="1586774">netpollServerInit</span><span class="op" id="1586791">(</span><span class="op" id="1586792">)</span>&nbsp;<span class="op" id="1586794">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586797">onM</span><span class="op" id="1586800">(</span><span class="ident" id="1586801">netpollinit</span><span class="op" id="1586812">)</span><br>
<span class="lineno"></span><span class="op" id="1586814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1586817">func</span>&nbsp;<span class="ident" id="1586822">netpollOpen</span><span class="op" id="1586833">(</span><span class="ident" id="1586834">fd</span>&nbsp;<span class="builtintype" id="1586837">uintptr</span><span class="op" id="1586844">)</span>&nbsp;<span class="op" id="1586846">(</span><span class="op" id="1586847">*</span><span class="ident" id="1586848">pollDesc</span><span class="op" id="1586856">,</span>&nbsp;<span class="builtintype" id="1586858">int</span><span class="op" id="1586861">)</span>&nbsp;<span class="op" id="1586863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586866">pd</span>&nbsp;<span class="op" id="1586869">:=</span>&nbsp;<span class="ident" id="1586872">pollcache</span><span class="op" id="1586881">.</span><span class="ident" id="1586882">alloc</span><span class="op" id="1586887">(</span><span class="op" id="1586888">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586891">lock</span><span class="op" id="1586895">(</span><span class="op" id="1586896">&amp;</span><span class="ident" id="1586897">pd</span><span class="op" id="1586899">.</span><span class="ident" id="1586900">lock</span><span class="op" id="1586904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1586907">if</span>&nbsp;<span class="ident" id="1586910">pd</span><span class="op" id="1586912">.</span><span class="ident" id="1586913">wg</span>&nbsp;<span class="op" id="1586916">!=</span>&nbsp;<span class="num" id="1586919">0</span>&nbsp;<span class="op" id="1586921">&amp;&amp;</span>&nbsp;<span class="ident" id="1586924">pd</span><span class="op" id="1586926">.</span><span class="ident" id="1586927">wg</span>&nbsp;<span class="op" id="1586930">!=</span>&nbsp;<span class="ident" id="1586933">pdReady</span>&nbsp;<span class="op" id="1586941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586945">gothrow</span><span class="op" id="1586952">(</span><span class="string" id="1586953">&#34;netpollOpen:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1587000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587006">if</span>&nbsp;<span class="ident" id="1587009">pd</span><span class="op" id="1587011">.</span><span class="ident" id="1587012">rg</span>&nbsp;<span class="op" id="1587015">!=</span>&nbsp;<span class="num" id="1587018">0</span>&nbsp;<span class="op" id="1587020">&amp;&amp;</span>&nbsp;<span class="ident" id="1587023">pd</span><span class="op" id="1587025">.</span><span class="ident" id="1587026">rg</span>&nbsp;<span class="op" id="1587029">!=</span>&nbsp;<span class="ident" id="1587032">pdReady</span>&nbsp;<span class="op" id="1587040">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587044">gothrow</span><span class="op" id="1587051">(</span><span class="string" id="1587052">&#34;netpollOpen:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1587098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587104">pd</span><span class="op" id="1587106">.</span><span class="ident" id="1587107">fd</span>&nbsp;<span class="op" id="1587110">=</span>&nbsp;<span class="ident" id="1587112">fd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587116">pd</span><span class="op" id="1587118">.</span><span class="ident" id="1587119">closing</span>&nbsp;<span class="op" id="1587127">=</span>&nbsp;<span class="builtintype" id="1587129">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587136">pd</span><span class="op" id="1587138">.</span><span class="ident" id="1587139">seq</span><span class="op" id="1587142">++</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587146">pd</span><span class="op" id="1587148">.</span><span class="ident" id="1587149">rg</span>&nbsp;<span class="op" id="1587152">=</span>&nbsp;<span class="num" id="1587154">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587157">pd</span><span class="op" id="1587159">.</span><span class="ident" id="1587160">rd</span>&nbsp;<span class="op" id="1587163">=</span>&nbsp;<span class="num" id="1587165">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587168">pd</span><span class="op" id="1587170">.</span><span class="ident" id="1587171">wg</span>&nbsp;<span class="op" id="1587174">=</span>&nbsp;<span class="num" id="1587176">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587179">pd</span><span class="op" id="1587181">.</span><span class="ident" id="1587182">wd</span>&nbsp;<span class="op" id="1587185">=</span>&nbsp;<span class="num" id="1587187">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587190">unlock</span><span class="op" id="1587196">(</span><span class="op" id="1587197">&amp;</span><span class="ident" id="1587198">pd</span><span class="op" id="1587200">.</span><span class="ident" id="1587201">lock</span><span class="op" id="1587205">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587209">var</span>&nbsp;<span class="ident" id="1587213">errno</span>&nbsp;<span class="builtintype" id="1587219">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587226">onM</span><span class="op" id="1587229">(</span><span class="keyword" id="1587230">func</span><span class="op" id="1587234">(</span><span class="op" id="1587235">)</span>&nbsp;<span class="op" id="1587237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587241">errno</span>&nbsp;<span class="op" id="1587247">=</span>&nbsp;<span class="ident" id="1587249">netpollopen</span><span class="op" id="1587260">(</span><span class="ident" id="1587261">fd</span><span class="op" id="1587263">,</span>&nbsp;<span class="ident" id="1587265">pd</span><span class="op" id="1587267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587270">}</span><span class="op" id="1587271">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587274">return</span>&nbsp;<span class="ident" id="1587281">pd</span><span class="op" id="1587283">,</span>&nbsp;<span class="builtintype" id="1587285">int</span><span class="op" id="1587288">(</span><span class="ident" id="1587289">errno</span><span class="op" id="1587294">)</span><br>
<span class="lineno"></span><span class="op" id="1587296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1587299">func</span>&nbsp;<span class="ident" id="1587304">netpollClose</span><span class="op" id="1587316">(</span><span class="ident" id="1587317">pd</span>&nbsp;<span class="op" id="1587320">*</span><span class="ident" id="1587321">pollDesc</span><span class="op" id="1587329">)</span>&nbsp;<span class="op" id="1587331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587334">if</span>&nbsp;<span class="op" id="1587337">!</span><span class="ident" id="1587338">pd</span><span class="op" id="1587340">.</span><span class="ident" id="1587341">closing</span>&nbsp;<span class="op" id="1587349">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587353">gothrow</span><span class="op" id="1587360">(</span><span class="string" id="1587361">&#34;netpollClose:&nbsp;close&nbsp;w/o&nbsp;unblock&#34;</span><span class="op" id="1587394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587400">if</span>&nbsp;<span class="ident" id="1587403">pd</span><span class="op" id="1587405">.</span><span class="ident" id="1587406">wg</span>&nbsp;<span class="op" id="1587409">!=</span>&nbsp;<span class="num" id="1587412">0</span>&nbsp;<span class="op" id="1587414">&amp;&amp;</span>&nbsp;<span class="ident" id="1587417">pd</span><span class="op" id="1587419">.</span><span class="ident" id="1587420">wg</span>&nbsp;<span class="op" id="1587423">!=</span>&nbsp;<span class="ident" id="1587426">pdReady</span>&nbsp;<span class="op" id="1587434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587438">gothrow</span><span class="op" id="1587445">(</span><span class="string" id="1587446">&#34;netpollClose:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1587497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587500">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587503">if</span>&nbsp;<span class="ident" id="1587506">pd</span><span class="op" id="1587508">.</span><span class="ident" id="1587509">rg</span>&nbsp;<span class="op" id="1587512">!=</span>&nbsp;<span class="num" id="1587515">0</span>&nbsp;<span class="op" id="1587517">&amp;&amp;</span>&nbsp;<span class="ident" id="1587520">pd</span><span class="op" id="1587522">.</span><span class="ident" id="1587523">rg</span>&nbsp;<span class="op" id="1587526">!=</span>&nbsp;<span class="ident" id="1587529">pdReady</span>&nbsp;<span class="op" id="1587537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587541">gothrow</span><span class="op" id="1587548">(</span><span class="string" id="1587549">&#34;netpollClose:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1587599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587605">onM</span><span class="op" id="1587608">(</span><span class="keyword" id="1587609">func</span><span class="op" id="1587613">(</span><span class="op" id="1587614">)</span>&nbsp;<span class="op" id="1587616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587620">netpollclose</span><span class="op" id="1587632">(</span><span class="builtintype" id="1587633">uintptr</span><span class="op" id="1587640">(</span><span class="ident" id="1587641">pd</span><span class="op" id="1587643">.</span><span class="ident" id="1587644">fd</span><span class="op" id="1587646">)</span><span class="op" id="1587647">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587650">}</span><span class="op" id="1587651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587654">pollcache</span><span class="op" id="1587663">.</span><span class="ident" id="1587664">free</span><span class="op" id="1587668">(</span><span class="ident" id="1587669">pd</span><span class="op" id="1587671">)</span><br>
<span class="lineno"></span><span class="op" id="1587673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1587676">func</span>&nbsp;<span class="op" id="1587681">(</span><span class="ident" id="1587682">c</span>&nbsp;<span class="op" id="1587684">*</span><span class="ident" id="1587685">pollCache</span><span class="op" id="1587694">)</span>&nbsp;<span class="ident" id="1587696">free</span><span class="op" id="1587700">(</span><span class="ident" id="1587701">pd</span>&nbsp;<span class="op" id="1587704">*</span><span class="ident" id="1587705">pollDesc</span><span class="op" id="1587713">)</span>&nbsp;<span class="op" id="1587715">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587718">lock</span><span class="op" id="1587722">(</span><span class="op" id="1587723">&amp;</span><span class="ident" id="1587724">c</span><span class="op" id="1587725">.</span><span class="ident" id="1587726">lock</span><span class="op" id="1587730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587733">pd</span><span class="op" id="1587735">.</span><span class="ident" id="1587736">link</span>&nbsp;<span class="op" id="1587741">=</span>&nbsp;<span class="ident" id="1587743">c</span><span class="op" id="1587744">.</span><span class="ident" id="1587745">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587752">c</span><span class="op" id="1587753">.</span><span class="ident" id="1587754">first</span>&nbsp;<span class="op" id="1587760">=</span>&nbsp;<span class="ident" id="1587762">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587766">unlock</span><span class="op" id="1587772">(</span><span class="op" id="1587773">&amp;</span><span class="ident" id="1587774">c</span><span class="op" id="1587775">.</span><span class="ident" id="1587776">lock</span><span class="op" id="1587780">)</span><br>
<span class="lineno"></span><span class="op" id="1587782">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="1587785">func</span>&nbsp;<span class="ident" id="1587790">netpollReset</span><span class="op" id="1587802">(</span><span class="ident" id="1587803">pd</span>&nbsp;<span class="op" id="1587806">*</span><span class="ident" id="1587807">pollDesc</span><span class="op" id="1587815">,</span>&nbsp;<span class="ident" id="1587817">mode</span>&nbsp;<span class="builtintype" id="1587822">int</span><span class="op" id="1587825">)</span>&nbsp;<span class="builtintype" id="1587827">int</span>&nbsp;<span class="op" id="1587831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587834">err</span>&nbsp;<span class="op" id="1587838">:=</span>&nbsp;<span class="ident" id="1587841">netpollcheckerr</span><span class="op" id="1587856">(</span><span class="ident" id="1587857">pd</span><span class="op" id="1587859">,</span>&nbsp;<span class="builtintype" id="1587861">int32</span><span class="op" id="1587866">(</span><span class="ident" id="1587867">mode</span><span class="op" id="1587871">)</span><span class="op" id="1587872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587875">if</span>&nbsp;<span class="ident" id="1587878">err</span>&nbsp;<span class="op" id="1587882">!=</span>&nbsp;<span class="num" id="1587885">0</span>&nbsp;<span class="op" id="1587887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587891">return</span>&nbsp;<span class="ident" id="1587898">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587906">if</span>&nbsp;<span class="ident" id="1587909">mode</span>&nbsp;<span class="op" id="1587914">==</span>&nbsp;<span class="string" id="1587917">&#39;r&#39;</span>&nbsp;<span class="op" id="1587921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587925">pd</span><span class="op" id="1587927">.</span><span class="ident" id="1587928">rg</span>&nbsp;<span class="op" id="1587931">=</span>&nbsp;<span class="num" id="1587933">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587936">}</span>&nbsp;<span class="keyword" id="1587938">else</span>&nbsp;<span class="keyword" id="1587943">if</span>&nbsp;<span class="ident" id="1587946">mode</span>&nbsp;<span class="op" id="1587951">==</span>&nbsp;<span class="string" id="1587954">&#39;w&#39;</span>&nbsp;<span class="op" id="1587958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587962">pd</span><span class="op" id="1587964">.</span><span class="ident" id="1587965">wg</span>&nbsp;<span class="op" id="1587968">=</span>&nbsp;<span class="num" id="1587970">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587976">return</span>&nbsp;<span class="num" id="1587983">0</span><br>
<span class="lineno"></span><span class="op" id="1587985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1587988">func</span>&nbsp;<span class="ident" id="1587993">netpollWait</span><span class="op" id="1588004">(</span><span class="ident" id="1588005">pd</span>&nbsp;<span class="op" id="1588008">*</span><span class="ident" id="1588009">pollDesc</span><span class="op" id="1588017">,</span>&nbsp;<span class="ident" id="1588019">mode</span>&nbsp;<span class="builtintype" id="1588024">int</span><span class="op" id="1588027">)</span>&nbsp;<span class="builtintype" id="1588029">int</span>&nbsp;<span class="op" id="1588033">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588036">err</span>&nbsp;<span class="op" id="1588040">:=</span>&nbsp;<span class="ident" id="1588043">netpollcheckerr</span><span class="op" id="1588058">(</span><span class="ident" id="1588059">pd</span><span class="op" id="1588061">,</span>&nbsp;<span class="builtintype" id="1588063">int32</span><span class="op" id="1588068">(</span><span class="ident" id="1588069">mode</span><span class="op" id="1588073">)</span><span class="op" id="1588074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588077">if</span>&nbsp;<span class="ident" id="1588080">err</span>&nbsp;<span class="op" id="1588084">!=</span>&nbsp;<span class="num" id="1588087">0</span>&nbsp;<span class="op" id="1588089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588093">return</span>&nbsp;<span class="ident" id="1588100">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1588108">//&nbsp;As&nbsp;for&nbsp;now&nbsp;only&nbsp;Solaris&nbsp;uses&nbsp;level-triggered&nbsp;IO.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588161">if</span>&nbsp;<span class="ident" id="1588164">GOOS</span>&nbsp;<span class="op" id="1588169">==</span>&nbsp;<span class="string" id="1588172">&#34;solaris&#34;</span>&nbsp;<span class="op" id="1588182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588186">onM</span><span class="op" id="1588189">(</span><span class="keyword" id="1588190">func</span><span class="op" id="1588194">(</span><span class="op" id="1588195">)</span>&nbsp;<span class="op" id="1588197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588202">netpollarm</span><span class="op" id="1588212">(</span><span class="ident" id="1588213">pd</span><span class="op" id="1588215">,</span>&nbsp;<span class="ident" id="1588217">mode</span><span class="op" id="1588221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588225">}</span><span class="op" id="1588226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588229">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588232">for</span>&nbsp;<span class="op" id="1588236">!</span><span class="ident" id="1588237">netpollblock</span><span class="op" id="1588249">(</span><span class="ident" id="1588250">pd</span><span class="op" id="1588252">,</span>&nbsp;<span class="builtintype" id="1588254">int32</span><span class="op" id="1588259">(</span><span class="ident" id="1588260">mode</span><span class="op" id="1588264">)</span><span class="op" id="1588265">,</span>&nbsp;<span class="builtintype" id="1588267">false</span><span class="op" id="1588272">)</span>&nbsp;<span class="op" id="1588274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588278">err</span>&nbsp;<span class="op" id="1588282">=</span>&nbsp;<span class="ident" id="1588284">netpollcheckerr</span><span class="op" id="1588299">(</span><span class="ident" id="1588300">pd</span><span class="op" id="1588302">,</span>&nbsp;<span class="builtintype" id="1588304">int32</span><span class="op" id="1588309">(</span><span class="ident" id="1588310">mode</span><span class="op" id="1588314">)</span><span class="op" id="1588315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588319">if</span>&nbsp;<span class="ident" id="1588322">err</span>&nbsp;<span class="op" id="1588326">!=</span>&nbsp;<span class="num" id="1588329">0</span>&nbsp;<span class="op" id="1588331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588336">return</span>&nbsp;<span class="ident" id="1588343">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588349">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1588353">//&nbsp;Can&nbsp;happen&nbsp;if&nbsp;timeout&nbsp;has&nbsp;fired&nbsp;and&nbsp;unblocked&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1588408">//&nbsp;but&nbsp;before&nbsp;we&nbsp;had&nbsp;a&nbsp;chance&nbsp;to&nbsp;run,&nbsp;timeout&nbsp;has&nbsp;been&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1588472">//&nbsp;Pretend&nbsp;it&nbsp;has&nbsp;not&nbsp;happened&nbsp;and&nbsp;retry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588518">return</span>&nbsp;<span class="num" id="1588525">0</span><br>
<span class="lineno">160</span><span class="op" id="1588527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1588530">func</span>&nbsp;<span class="ident" id="1588535">netpollWaitCanceled</span><span class="op" id="1588554">(</span><span class="ident" id="1588555">pd</span>&nbsp;<span class="op" id="1588558">*</span><span class="ident" id="1588559">pollDesc</span><span class="op" id="1588567">,</span>&nbsp;<span class="ident" id="1588569">mode</span>&nbsp;<span class="builtintype" id="1588574">int</span><span class="op" id="1588577">)</span>&nbsp;<span class="op" id="1588579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1588582">//&nbsp;This&nbsp;function&nbsp;is&nbsp;used&nbsp;only&nbsp;on&nbsp;windows&nbsp;after&nbsp;a&nbsp;failed&nbsp;attempt&nbsp;to&nbsp;cancel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1588657">//&nbsp;a&nbsp;pending&nbsp;async&nbsp;IO&nbsp;operation.&nbsp;Wait&nbsp;for&nbsp;ioready,&nbsp;ignore&nbsp;closing&nbsp;or&nbsp;timeouts.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588737">for</span>&nbsp;<span class="op" id="1588741">!</span><span class="ident" id="1588742">netpollblock</span><span class="op" id="1588754">(</span><span class="ident" id="1588755">pd</span><span class="op" id="1588757">,</span>&nbsp;<span class="builtintype" id="1588759">int32</span><span class="op" id="1588764">(</span><span class="ident" id="1588765">mode</span><span class="op" id="1588769">)</span><span class="op" id="1588770">,</span>&nbsp;<span class="builtintype" id="1588772">true</span><span class="op" id="1588776">)</span>&nbsp;<span class="op" id="1588778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588781">}</span><br>
<span class="lineno"></span><span class="op" id="1588783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1588786">func</span>&nbsp;<span class="ident" id="1588791">netpollSetDeadline</span><span class="op" id="1588809">(</span><span class="ident" id="1588810">pd</span>&nbsp;<span class="op" id="1588813">*</span><span class="ident" id="1588814">pollDesc</span><span class="op" id="1588822">,</span>&nbsp;<span class="ident" id="1588824">d</span>&nbsp;<span class="ident" id="1588826">int64</span><span class="op" id="1588831">,</span>&nbsp;<span class="ident" id="1588833">mode</span>&nbsp;<span class="builtintype" id="1588838">int</span><span class="op" id="1588841">)</span>&nbsp;<span class="op" id="1588843">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588846">lock</span><span class="op" id="1588850">(</span><span class="op" id="1588851">&amp;</span><span class="ident" id="1588852">pd</span><span class="op" id="1588854">.</span><span class="ident" id="1588855">lock</span><span class="op" id="1588859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588862">if</span>&nbsp;<span class="ident" id="1588865">pd</span><span class="op" id="1588867">.</span><span class="ident" id="1588868">closing</span>&nbsp;<span class="op" id="1588876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588880">unlock</span><span class="op" id="1588886">(</span><span class="op" id="1588887">&amp;</span><span class="ident" id="1588888">pd</span><span class="op" id="1588890">.</span><span class="ident" id="1588891">lock</span><span class="op" id="1588895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588899">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588907">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588910">pd</span><span class="op" id="1588912">.</span><span class="ident" id="1588913">seq</span><span class="op" id="1588916">++</span>&nbsp;<span class="comment" id="1588919">//&nbsp;invalidate&nbsp;current&nbsp;timers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1588949">//&nbsp;Reset&nbsp;current&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588975">if</span>&nbsp;<span class="ident" id="1588978">pd</span><span class="op" id="1588980">.</span><span class="ident" id="1588981">rt</span><span class="op" id="1588983">.</span><span class="ident" id="1588984">f</span>&nbsp;<span class="op" id="1588986">!=</span>&nbsp;<span class="ident" id="1588989">nil</span>&nbsp;<span class="op" id="1588993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588997">deltimer</span><span class="op" id="1589005">(</span><span class="op" id="1589006">&amp;</span><span class="ident" id="1589007">pd</span><span class="op" id="1589009">.</span><span class="ident" id="1589010">rt</span><span class="op" id="1589012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589016">pd</span><span class="op" id="1589018">.</span><span class="ident" id="1589019">rt</span><span class="op" id="1589021">.</span><span class="ident" id="1589022">f</span>&nbsp;<span class="op" id="1589024">=</span>&nbsp;<span class="ident" id="1589026">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589034">if</span>&nbsp;<span class="ident" id="1589037">pd</span><span class="op" id="1589039">.</span><span class="ident" id="1589040">wt</span><span class="op" id="1589042">.</span><span class="ident" id="1589043">f</span>&nbsp;<span class="op" id="1589045">!=</span>&nbsp;<span class="ident" id="1589048">nil</span>&nbsp;<span class="op" id="1589052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589056">deltimer</span><span class="op" id="1589064">(</span><span class="op" id="1589065">&amp;</span><span class="ident" id="1589066">pd</span><span class="op" id="1589068">.</span><span class="ident" id="1589069">wt</span><span class="op" id="1589071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589075">pd</span><span class="op" id="1589077">.</span><span class="ident" id="1589078">wt</span><span class="op" id="1589080">.</span><span class="ident" id="1589081">f</span>&nbsp;<span class="op" id="1589083">=</span>&nbsp;<span class="ident" id="1589085">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589090">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1589093">//&nbsp;Setup&nbsp;new&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589115">if</span>&nbsp;<span class="ident" id="1589118">d</span>&nbsp;<span class="op" id="1589120">!=</span>&nbsp;<span class="num" id="1589123">0</span>&nbsp;<span class="op" id="1589125">&amp;&amp;</span>&nbsp;<span class="ident" id="1589128">d</span>&nbsp;<span class="op" id="1589130">&lt;=</span>&nbsp;<span class="ident" id="1589133">nanotime</span><span class="op" id="1589141">(</span><span class="op" id="1589142">)</span>&nbsp;<span class="op" id="1589144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589148">d</span>&nbsp;<span class="op" id="1589150">=</span>&nbsp;<span class="op" id="1589152">-</span><span class="num" id="1589153">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589159">if</span>&nbsp;<span class="ident" id="1589162">mode</span>&nbsp;<span class="op" id="1589167">==</span>&nbsp;<span class="string" id="1589170">&#39;r&#39;</span>&nbsp;<span class="op" id="1589174">||</span>&nbsp;<span class="ident" id="1589177">mode</span>&nbsp;<span class="op" id="1589182">==</span>&nbsp;<span class="string" id="1589185">&#39;r&#39;</span><span class="op" id="1589188">+</span><span class="string" id="1589189">&#39;w&#39;</span>&nbsp;<span class="op" id="1589193">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589197">pd</span><span class="op" id="1589199">.</span><span class="ident" id="1589200">rd</span>&nbsp;<span class="op" id="1589203">=</span>&nbsp;<span class="ident" id="1589205">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589211">if</span>&nbsp;<span class="ident" id="1589214">mode</span>&nbsp;<span class="op" id="1589219">==</span>&nbsp;<span class="string" id="1589222">&#39;w&#39;</span>&nbsp;<span class="op" id="1589226">||</span>&nbsp;<span class="ident" id="1589229">mode</span>&nbsp;<span class="op" id="1589234">==</span>&nbsp;<span class="string" id="1589237">&#39;r&#39;</span><span class="op" id="1589240">+</span><span class="string" id="1589241">&#39;w&#39;</span>&nbsp;<span class="op" id="1589245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589249">pd</span><span class="op" id="1589251">.</span><span class="ident" id="1589252">wd</span>&nbsp;<span class="op" id="1589255">=</span>&nbsp;<span class="ident" id="1589257">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589260">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589263">if</span>&nbsp;<span class="ident" id="1589266">pd</span><span class="op" id="1589268">.</span><span class="ident" id="1589269">rd</span>&nbsp;<span class="op" id="1589272">&gt;</span>&nbsp;<span class="num" id="1589274">0</span>&nbsp;<span class="op" id="1589276">&amp;&amp;</span>&nbsp;<span class="ident" id="1589279">pd</span><span class="op" id="1589281">.</span><span class="ident" id="1589282">rd</span>&nbsp;<span class="op" id="1589285">==</span>&nbsp;<span class="ident" id="1589288">pd</span><span class="op" id="1589290">.</span><span class="ident" id="1589291">wd</span>&nbsp;<span class="op" id="1589294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589298">pd</span><span class="op" id="1589300">.</span><span class="ident" id="1589301">rt</span><span class="op" id="1589303">.</span><span class="ident" id="1589304">f</span>&nbsp;<span class="op" id="1589306">=</span>&nbsp;<span class="ident" id="1589308">netpollDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589326">pd</span><span class="op" id="1589328">.</span><span class="ident" id="1589329">rt</span><span class="op" id="1589331">.</span><span class="ident" id="1589332">when</span>&nbsp;<span class="op" id="1589337">=</span>&nbsp;<span class="ident" id="1589339">pd</span><span class="op" id="1589341">.</span><span class="ident" id="1589342">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1589347">//&nbsp;Copy&nbsp;current&nbsp;seq&nbsp;into&nbsp;the&nbsp;timer&nbsp;arg.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1589389">//&nbsp;Timer&nbsp;func&nbsp;will&nbsp;check&nbsp;the&nbsp;seq&nbsp;against&nbsp;current&nbsp;descriptor&nbsp;seq,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1589456">//&nbsp;if&nbsp;they&nbsp;differ&nbsp;the&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589524">pd</span><span class="op" id="1589526">.</span><span class="ident" id="1589527">rt</span><span class="op" id="1589529">.</span><span class="ident" id="1589530">arg</span>&nbsp;<span class="op" id="1589534">=</span>&nbsp;<span class="ident" id="1589536">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589541">pd</span><span class="op" id="1589543">.</span><span class="ident" id="1589544">rt</span><span class="op" id="1589546">.</span><span class="ident" id="1589547">seq</span>&nbsp;<span class="op" id="1589551">=</span>&nbsp;<span class="ident" id="1589553">pd</span><span class="op" id="1589555">.</span><span class="ident" id="1589556">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589562">addtimer</span><span class="op" id="1589570">(</span><span class="op" id="1589571">&amp;</span><span class="ident" id="1589572">pd</span><span class="op" id="1589574">.</span><span class="ident" id="1589575">rt</span><span class="op" id="1589577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589580">}</span>&nbsp;<span class="keyword" id="1589582">else</span>&nbsp;<span class="op" id="1589587">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589591">if</span>&nbsp;<span class="ident" id="1589594">pd</span><span class="op" id="1589596">.</span><span class="ident" id="1589597">rd</span>&nbsp;<span class="op" id="1589600">&gt;</span>&nbsp;<span class="num" id="1589602">0</span>&nbsp;<span class="op" id="1589604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589609">pd</span><span class="op" id="1589611">.</span><span class="ident" id="1589612">rt</span><span class="op" id="1589614">.</span><span class="ident" id="1589615">f</span>&nbsp;<span class="op" id="1589617">=</span>&nbsp;<span class="ident" id="1589619">netpollReadDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589642">pd</span><span class="op" id="1589644">.</span><span class="ident" id="1589645">rt</span><span class="op" id="1589647">.</span><span class="ident" id="1589648">when</span>&nbsp;<span class="op" id="1589653">=</span>&nbsp;<span class="ident" id="1589655">pd</span><span class="op" id="1589657">.</span><span class="ident" id="1589658">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589664">pd</span><span class="op" id="1589666">.</span><span class="ident" id="1589667">rt</span><span class="op" id="1589669">.</span><span class="ident" id="1589670">arg</span>&nbsp;<span class="op" id="1589674">=</span>&nbsp;<span class="ident" id="1589676">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589682">pd</span><span class="op" id="1589684">.</span><span class="ident" id="1589685">rt</span><span class="op" id="1589687">.</span><span class="ident" id="1589688">seq</span>&nbsp;<span class="op" id="1589692">=</span>&nbsp;<span class="ident" id="1589694">pd</span><span class="op" id="1589696">.</span><span class="ident" id="1589697">seq</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589704">addtimer</span><span class="op" id="1589712">(</span><span class="op" id="1589713">&amp;</span><span class="ident" id="1589714">pd</span><span class="op" id="1589716">.</span><span class="ident" id="1589717">rt</span><span class="op" id="1589719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589727">if</span>&nbsp;<span class="ident" id="1589730">pd</span><span class="op" id="1589732">.</span><span class="ident" id="1589733">wd</span>&nbsp;<span class="op" id="1589736">&gt;</span>&nbsp;<span class="num" id="1589738">0</span>&nbsp;<span class="op" id="1589740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589745">pd</span><span class="op" id="1589747">.</span><span class="ident" id="1589748">wt</span><span class="op" id="1589750">.</span><span class="ident" id="1589751">f</span>&nbsp;<span class="op" id="1589753">=</span>&nbsp;<span class="ident" id="1589755">netpollWriteDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589779">pd</span><span class="op" id="1589781">.</span><span class="ident" id="1589782">wt</span><span class="op" id="1589784">.</span><span class="ident" id="1589785">when</span>&nbsp;<span class="op" id="1589790">=</span>&nbsp;<span class="ident" id="1589792">pd</span><span class="op" id="1589794">.</span><span class="ident" id="1589795">wd</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589801">pd</span><span class="op" id="1589803">.</span><span class="ident" id="1589804">wt</span><span class="op" id="1589806">.</span><span class="ident" id="1589807">arg</span>&nbsp;<span class="op" id="1589811">=</span>&nbsp;<span class="ident" id="1589813">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589819">pd</span><span class="op" id="1589821">.</span><span class="ident" id="1589822">wt</span><span class="op" id="1589824">.</span><span class="ident" id="1589825">seq</span>&nbsp;<span class="op" id="1589829">=</span>&nbsp;<span class="ident" id="1589831">pd</span><span class="op" id="1589833">.</span><span class="ident" id="1589834">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589841">addtimer</span><span class="op" id="1589849">(</span><span class="op" id="1589850">&amp;</span><span class="ident" id="1589851">pd</span><span class="op" id="1589853">.</span><span class="ident" id="1589854">wt</span><span class="op" id="1589856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589863">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1589866">//&nbsp;If&nbsp;we&nbsp;set&nbsp;the&nbsp;new&nbsp;deadline&nbsp;in&nbsp;the&nbsp;past,&nbsp;unblock&nbsp;currently&nbsp;pending&nbsp;IO&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589947">var</span>&nbsp;<span class="ident" id="1589951">rg</span><span class="op" id="1589953">,</span>&nbsp;<span class="ident" id="1589955">wg</span>&nbsp;<span class="op" id="1589958">*</span><span class="ident" id="1589959">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589962">atomicstorep</span><span class="op" id="1589974">(</span><span class="ident" id="1589975">unsafe</span><span class="op" id="1589981">.</span><span class="ident" id="1589982">Pointer</span><span class="op" id="1589989">(</span><span class="op" id="1589990">&amp;</span><span class="ident" id="1589991">wg</span><span class="op" id="1589993">)</span><span class="op" id="1589994">,</span>&nbsp;<span class="ident" id="1589996">nil</span><span class="op" id="1589999">)</span>&nbsp;<span class="comment" id="1590001">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;stores&nbsp;to&nbsp;rd/wd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590085">if</span>&nbsp;<span class="ident" id="1590088">pd</span><span class="op" id="1590090">.</span><span class="ident" id="1590091">rd</span>&nbsp;<span class="op" id="1590094">&lt;</span>&nbsp;<span class="num" id="1590096">0</span>&nbsp;<span class="op" id="1590098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590102">rg</span>&nbsp;<span class="op" id="1590105">=</span>&nbsp;<span class="ident" id="1590107">netpollunblock</span><span class="op" id="1590121">(</span><span class="ident" id="1590122">pd</span><span class="op" id="1590124">,</span>&nbsp;<span class="string" id="1590126">&#39;r&#39;</span><span class="op" id="1590129">,</span>&nbsp;<span class="builtintype" id="1590131">false</span><span class="op" id="1590136">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1590139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590142">if</span>&nbsp;<span class="ident" id="1590145">pd</span><span class="op" id="1590147">.</span><span class="ident" id="1590148">wd</span>&nbsp;<span class="op" id="1590151">&lt;</span>&nbsp;<span class="num" id="1590153">0</span>&nbsp;<span class="op" id="1590155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590159">wg</span>&nbsp;<span class="op" id="1590162">=</span>&nbsp;<span class="ident" id="1590164">netpollunblock</span><span class="op" id="1590178">(</span><span class="ident" id="1590179">pd</span><span class="op" id="1590181">,</span>&nbsp;<span class="string" id="1590183">&#39;w&#39;</span><span class="op" id="1590186">,</span>&nbsp;<span class="builtintype" id="1590188">false</span><span class="op" id="1590193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1590196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590199">unlock</span><span class="op" id="1590205">(</span><span class="op" id="1590206">&amp;</span><span class="ident" id="1590207">pd</span><span class="op" id="1590209">.</span><span class="ident" id="1590210">lock</span><span class="op" id="1590214">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590217">if</span>&nbsp;<span class="ident" id="1590220">rg</span>&nbsp;<span class="op" id="1590223">!=</span>&nbsp;<span class="ident" id="1590226">nil</span>&nbsp;<span class="op" id="1590230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590234">goready</span><span class="op" id="1590241">(</span><span class="ident" id="1590242">rg</span><span class="op" id="1590244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1590247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590250">if</span>&nbsp;<span class="ident" id="1590253">wg</span>&nbsp;<span class="op" id="1590256">!=</span>&nbsp;<span class="ident" id="1590259">nil</span>&nbsp;<span class="op" id="1590263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590267">goready</span><span class="op" id="1590274">(</span><span class="ident" id="1590275">wg</span><span class="op" id="1590277">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1590280">}</span><br>
<span class="lineno"></span><span class="op" id="1590282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1590285">func</span>&nbsp;<span class="ident" id="1590290">netpollUnblock</span><span class="op" id="1590304">(</span><span class="ident" id="1590305">pd</span>&nbsp;<span class="op" id="1590308">*</span><span class="ident" id="1590309">pollDesc</span><span class="op" id="1590317">)</span>&nbsp;<span class="op" id="1590319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590322">lock</span><span class="op" id="1590326">(</span><span class="op" id="1590327">&amp;</span><span class="ident" id="1590328">pd</span><span class="op" id="1590330">.</span><span class="ident" id="1590331">lock</span><span class="op" id="1590335">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590338">if</span>&nbsp;<span class="ident" id="1590341">pd</span><span class="op" id="1590343">.</span><span class="ident" id="1590344">closing</span>&nbsp;<span class="op" id="1590352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590356">gothrow</span><span class="op" id="1590363">(</span><span class="string" id="1590364">&#34;netpollUnblock:&nbsp;already&nbsp;closing&#34;</span><span class="op" id="1590397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1590400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590403">pd</span><span class="op" id="1590405">.</span><span class="ident" id="1590406">closing</span>&nbsp;<span class="op" id="1590414">=</span>&nbsp;<span class="builtintype" id="1590416">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590422">pd</span><span class="op" id="1590424">.</span><span class="ident" id="1590425">seq</span><span class="op" id="1590428">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590432">var</span>&nbsp;<span class="ident" id="1590436">rg</span><span class="op" id="1590438">,</span>&nbsp;<span class="ident" id="1590440">wg</span>&nbsp;<span class="op" id="1590443">*</span><span class="ident" id="1590444">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590447">atomicstorep</span><span class="op" id="1590459">(</span><span class="ident" id="1590460">unsafe</span><span class="op" id="1590466">.</span><span class="ident" id="1590467">Pointer</span><span class="op" id="1590474">(</span><span class="op" id="1590475">&amp;</span><span class="ident" id="1590476">rg</span><span class="op" id="1590478">)</span><span class="op" id="1590479">,</span>&nbsp;<span class="ident" id="1590481">nil</span><span class="op" id="1590484">)</span>&nbsp;<span class="comment" id="1590486">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;closing&nbsp;and&nbsp;read&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590571">rg</span>&nbsp;<span class="op" id="1590574">=</span>&nbsp;<span class="ident" id="1590576">netpollunblock</span><span class="op" id="1590590">(</span><span class="ident" id="1590591">pd</span><span class="op" id="1590593">,</span>&nbsp;<span class="string" id="1590595">&#39;r&#39;</span><span class="op" id="1590598">,</span>&nbsp;<span class="builtintype" id="1590600">false</span><span class="op" id="1590605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590608">wg</span>&nbsp;<span class="op" id="1590611">=</span>&nbsp;<span class="ident" id="1590613">netpollunblock</span><span class="op" id="1590627">(</span><span class="ident" id="1590628">pd</span><span class="op" id="1590630">,</span>&nbsp;<span class="string" id="1590632">&#39;w&#39;</span><span class="op" id="1590635">,</span>&nbsp;<span class="builtintype" id="1590637">false</span><span class="op" id="1590642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590645">if</span>&nbsp;<span class="ident" id="1590648">pd</span><span class="op" id="1590650">.</span><span class="ident" id="1590651">rt</span><span class="op" id="1590653">.</span><span class="ident" id="1590654">f</span>&nbsp;<span class="op" id="1590656">!=</span>&nbsp;<span class="ident" id="1590659">nil</span>&nbsp;<span class="op" id="1590663">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590667">deltimer</span><span class="op" id="1590675">(</span><span class="op" id="1590676">&amp;</span><span class="ident" id="1590677">pd</span><span class="op" id="1590679">.</span><span class="ident" id="1590680">rt</span><span class="op" id="1590682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590686">pd</span><span class="op" id="1590688">.</span><span class="ident" id="1590689">rt</span><span class="op" id="1590691">.</span><span class="ident" id="1590692">f</span>&nbsp;<span class="op" id="1590694">=</span>&nbsp;<span class="ident" id="1590696">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1590701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590704">if</span>&nbsp;<span class="ident" id="1590707">pd</span><span class="op" id="1590709">.</span><span class="ident" id="1590710">wt</span><span class="op" id="1590712">.</span><span class="ident" id="1590713">f</span>&nbsp;<span class="op" id="1590715">!=</span>&nbsp;<span class="ident" id="1590718">nil</span>&nbsp;<span class="op" id="1590722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590726">deltimer</span><span class="op" id="1590734">(</span><span class="op" id="1590735">&amp;</span><span class="ident" id="1590736">pd</span><span class="op" id="1590738">.</span><span class="ident" id="1590739">wt</span><span class="op" id="1590741">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590745">pd</span><span class="op" id="1590747">.</span><span class="ident" id="1590748">wt</span><span class="op" id="1590750">.</span><span class="ident" id="1590751">f</span>&nbsp;<span class="op" id="1590753">=</span>&nbsp;<span class="ident" id="1590755">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1590760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590763">unlock</span><span class="op" id="1590769">(</span><span class="op" id="1590770">&amp;</span><span class="ident" id="1590771">pd</span><span class="op" id="1590773">.</span><span class="ident" id="1590774">lock</span><span class="op" id="1590778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590781">if</span>&nbsp;<span class="ident" id="1590784">rg</span>&nbsp;<span class="op" id="1590787">!=</span>&nbsp;<span class="ident" id="1590790">nil</span>&nbsp;<span class="op" id="1590794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590798">goready</span><span class="op" id="1590805">(</span><span class="ident" id="1590806">rg</span><span class="op" id="1590808">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1590811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590814">if</span>&nbsp;<span class="ident" id="1590817">wg</span>&nbsp;<span class="op" id="1590820">!=</span>&nbsp;<span class="ident" id="1590823">nil</span>&nbsp;<span class="op" id="1590827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590831">goready</span><span class="op" id="1590838">(</span><span class="ident" id="1590839">wg</span><span class="op" id="1590841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1590844">}</span><br>
<span class="lineno"></span><span class="op" id="1590846">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="1590849">func</span>&nbsp;<span class="ident" id="1590854">netpollfd</span><span class="op" id="1590863">(</span><span class="ident" id="1590864">pd</span>&nbsp;<span class="op" id="1590867">*</span><span class="ident" id="1590868">pollDesc</span><span class="op" id="1590876">)</span>&nbsp;<span class="builtintype" id="1590878">uintptr</span>&nbsp;<span class="op" id="1590886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590889">return</span>&nbsp;<span class="ident" id="1590896">pd</span><span class="op" id="1590898">.</span><span class="ident" id="1590899">fd</span><br>
<span class="lineno"></span><span class="op" id="1590902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1590905">func</span>&nbsp;<span class="ident" id="1590910">netpolluser</span><span class="op" id="1590921">(</span><span class="ident" id="1590922">pd</span>&nbsp;<span class="op" id="1590925">*</span><span class="ident" id="1590926">pollDesc</span><span class="op" id="1590934">)</span>&nbsp;<span class="op" id="1590936">*</span><span class="ident" id="1590937">unsafe</span><span class="op" id="1590943">.</span><span class="ident" id="1590944">Pointer</span>&nbsp;<span class="op" id="1590952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590955">return</span>&nbsp;<span class="op" id="1590962">&amp;</span><span class="ident" id="1590963">pd</span><span class="op" id="1590965">.</span><span class="ident" id="1590966">user</span><br>
<span class="lineno"></span><span class="op" id="1590971">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1590974">func</span>&nbsp;<span class="ident" id="1590979">netpollclosing</span><span class="op" id="1590993">(</span><span class="ident" id="1590994">pd</span>&nbsp;<span class="op" id="1590997">*</span><span class="ident" id="1590998">pollDesc</span><span class="op" id="1591006">)</span>&nbsp;<span class="builtintype" id="1591008">bool</span>&nbsp;<span class="op" id="1591013">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591016">return</span>&nbsp;<span class="ident" id="1591023">pd</span><span class="op" id="1591025">.</span><span class="ident" id="1591026">closing</span><br>
<span class="lineno"></span><span class="op" id="1591034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1591037">func</span>&nbsp;<span class="ident" id="1591042">netpolllock</span><span class="op" id="1591053">(</span><span class="ident" id="1591054">pd</span>&nbsp;<span class="op" id="1591057">*</span><span class="ident" id="1591058">pollDesc</span><span class="op" id="1591066">)</span>&nbsp;<span class="op" id="1591068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591071">lock</span><span class="op" id="1591075">(</span><span class="op" id="1591076">&amp;</span><span class="ident" id="1591077">pd</span><span class="op" id="1591079">.</span><span class="ident" id="1591080">lock</span><span class="op" id="1591084">)</span><br>
<span class="lineno">280</span><span class="op" id="1591086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1591089">func</span>&nbsp;<span class="ident" id="1591094">netpollunlock</span><span class="op" id="1591107">(</span><span class="ident" id="1591108">pd</span>&nbsp;<span class="op" id="1591111">*</span><span class="ident" id="1591112">pollDesc</span><span class="op" id="1591120">)</span>&nbsp;<span class="op" id="1591122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591125">unlock</span><span class="op" id="1591131">(</span><span class="op" id="1591132">&amp;</span><span class="ident" id="1591133">pd</span><span class="op" id="1591135">.</span><span class="ident" id="1591136">lock</span><span class="op" id="1591140">)</span><br>
<span class="lineno"></span><span class="op" id="1591142">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="1591145">//&nbsp;make&nbsp;pd&nbsp;ready,&nbsp;newly&nbsp;runnable&nbsp;goroutines&nbsp;(if&nbsp;any)&nbsp;are&nbsp;returned&nbsp;in&nbsp;rg/wg</span><br>
<span class="lineno"></span><span class="keyword" id="1591220">func</span>&nbsp;<span class="ident" id="1591225">netpollready</span><span class="op" id="1591237">(</span><span class="ident" id="1591238">gpp</span>&nbsp;<span class="op" id="1591242">*</span><span class="op" id="1591243">*</span><span class="ident" id="1591244">g</span><span class="op" id="1591245">,</span>&nbsp;<span class="ident" id="1591247">pd</span>&nbsp;<span class="op" id="1591250">*</span><span class="ident" id="1591251">pollDesc</span><span class="op" id="1591259">,</span>&nbsp;<span class="ident" id="1591261">mode</span>&nbsp;<span class="builtintype" id="1591266">int32</span><span class="op" id="1591271">)</span>&nbsp;<span class="op" id="1591273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591276">var</span>&nbsp;<span class="ident" id="1591280">rg</span><span class="op" id="1591282">,</span>&nbsp;<span class="ident" id="1591284">wg</span>&nbsp;<span class="op" id="1591287">*</span><span class="ident" id="1591288">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591291">if</span>&nbsp;<span class="ident" id="1591294">mode</span>&nbsp;<span class="op" id="1591299">==</span>&nbsp;<span class="string" id="1591302">&#39;r&#39;</span>&nbsp;<span class="op" id="1591306">||</span>&nbsp;<span class="ident" id="1591309">mode</span>&nbsp;<span class="op" id="1591314">==</span>&nbsp;<span class="string" id="1591317">&#39;r&#39;</span><span class="op" id="1591320">+</span><span class="string" id="1591321">&#39;w&#39;</span>&nbsp;<span class="op" id="1591325">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591329">rg</span>&nbsp;<span class="op" id="1591332">=</span>&nbsp;<span class="ident" id="1591334">netpollunblock</span><span class="op" id="1591348">(</span><span class="ident" id="1591349">pd</span><span class="op" id="1591351">,</span>&nbsp;<span class="string" id="1591353">&#39;r&#39;</span><span class="op" id="1591356">,</span>&nbsp;<span class="builtintype" id="1591358">true</span><span class="op" id="1591362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1591365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591368">if</span>&nbsp;<span class="ident" id="1591371">mode</span>&nbsp;<span class="op" id="1591376">==</span>&nbsp;<span class="string" id="1591379">&#39;w&#39;</span>&nbsp;<span class="op" id="1591383">||</span>&nbsp;<span class="ident" id="1591386">mode</span>&nbsp;<span class="op" id="1591391">==</span>&nbsp;<span class="string" id="1591394">&#39;r&#39;</span><span class="op" id="1591397">+</span><span class="string" id="1591398">&#39;w&#39;</span>&nbsp;<span class="op" id="1591402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591406">wg</span>&nbsp;<span class="op" id="1591409">=</span>&nbsp;<span class="ident" id="1591411">netpollunblock</span><span class="op" id="1591425">(</span><span class="ident" id="1591426">pd</span><span class="op" id="1591428">,</span>&nbsp;<span class="string" id="1591430">&#39;w&#39;</span><span class="op" id="1591433">,</span>&nbsp;<span class="builtintype" id="1591435">true</span><span class="op" id="1591439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1591442">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591445">if</span>&nbsp;<span class="ident" id="1591448">rg</span>&nbsp;<span class="op" id="1591451">!=</span>&nbsp;<span class="ident" id="1591454">nil</span>&nbsp;<span class="op" id="1591458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591462">rg</span><span class="op" id="1591464">.</span><span class="ident" id="1591465">schedlink</span>&nbsp;<span class="op" id="1591475">=</span>&nbsp;<span class="op" id="1591477">*</span><span class="ident" id="1591478">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1591484">*</span><span class="ident" id="1591485">gpp</span>&nbsp;<span class="op" id="1591489">=</span>&nbsp;<span class="ident" id="1591491">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1591495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591498">if</span>&nbsp;<span class="ident" id="1591501">wg</span>&nbsp;<span class="op" id="1591504">!=</span>&nbsp;<span class="ident" id="1591507">nil</span>&nbsp;<span class="op" id="1591511">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591515">wg</span><span class="op" id="1591517">.</span><span class="ident" id="1591518">schedlink</span>&nbsp;<span class="op" id="1591528">=</span>&nbsp;<span class="op" id="1591530">*</span><span class="ident" id="1591531">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1591537">*</span><span class="ident" id="1591538">gpp</span>&nbsp;<span class="op" id="1591542">=</span>&nbsp;<span class="ident" id="1591544">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1591548">}</span><br>
<span class="lineno"></span><span class="op" id="1591550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="keyword" id="1591553">func</span>&nbsp;<span class="ident" id="1591558">netpollcheckerr</span><span class="op" id="1591573">(</span><span class="ident" id="1591574">pd</span>&nbsp;<span class="op" id="1591577">*</span><span class="ident" id="1591578">pollDesc</span><span class="op" id="1591586">,</span>&nbsp;<span class="ident" id="1591588">mode</span>&nbsp;<span class="builtintype" id="1591593">int32</span><span class="op" id="1591598">)</span>&nbsp;<span class="builtintype" id="1591600">int</span>&nbsp;<span class="op" id="1591604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591607">if</span>&nbsp;<span class="ident" id="1591610">pd</span><span class="op" id="1591612">.</span><span class="ident" id="1591613">closing</span>&nbsp;<span class="op" id="1591621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591625">return</span>&nbsp;<span class="num" id="1591632">1</span>&nbsp;<span class="comment" id="1591634">//&nbsp;errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1591649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591652">if</span>&nbsp;<span class="op" id="1591655">(</span><span class="ident" id="1591656">mode</span>&nbsp;<span class="op" id="1591661">==</span>&nbsp;<span class="string" id="1591664">&#39;r&#39;</span>&nbsp;<span class="op" id="1591668">&amp;&amp;</span>&nbsp;<span class="ident" id="1591671">pd</span><span class="op" id="1591673">.</span><span class="ident" id="1591674">rd</span>&nbsp;<span class="op" id="1591677">&lt;</span>&nbsp;<span class="num" id="1591679">0</span><span class="op" id="1591680">)</span>&nbsp;<span class="op" id="1591682">||</span>&nbsp;<span class="op" id="1591685">(</span><span class="ident" id="1591686">mode</span>&nbsp;<span class="op" id="1591691">==</span>&nbsp;<span class="string" id="1591694">&#39;w&#39;</span>&nbsp;<span class="op" id="1591698">&amp;&amp;</span>&nbsp;<span class="ident" id="1591701">pd</span><span class="op" id="1591703">.</span><span class="ident" id="1591704">wd</span>&nbsp;<span class="op" id="1591707">&lt;</span>&nbsp;<span class="num" id="1591709">0</span><span class="op" id="1591710">)</span>&nbsp;<span class="op" id="1591712">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591716">return</span>&nbsp;<span class="num" id="1591723">2</span>&nbsp;<span class="comment" id="1591725">//&nbsp;errTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1591740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591743">return</span>&nbsp;<span class="num" id="1591750">0</span><br>
<span class="lineno"></span><span class="op" id="1591752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="keyword" id="1591755">func</span>&nbsp;<span class="ident" id="1591760">netpollblockcommit</span><span class="op" id="1591778">(</span><span class="ident" id="1591779">gp</span>&nbsp;<span class="op" id="1591782">*</span><span class="ident" id="1591783">g</span><span class="op" id="1591784">,</span>&nbsp;<span class="ident" id="1591786">gpp</span>&nbsp;<span class="ident" id="1591790">unsafe</span><span class="op" id="1591796">.</span><span class="ident" id="1591797">Pointer</span><span class="op" id="1591804">)</span>&nbsp;<span class="builtintype" id="1591806">bool</span>&nbsp;<span class="op" id="1591811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591814">return</span>&nbsp;<span class="ident" id="1591821">casuintptr</span><span class="op" id="1591831">(</span><span class="op" id="1591832">(</span><span class="op" id="1591833">*</span><span class="builtintype" id="1591834">uintptr</span><span class="op" id="1591841">)</span><span class="op" id="1591842">(</span><span class="ident" id="1591843">gpp</span><span class="op" id="1591846">)</span><span class="op" id="1591847">,</span>&nbsp;<span class="ident" id="1591849">pdWait</span><span class="op" id="1591855">,</span>&nbsp;<span class="builtintype" id="1591857">uintptr</span><span class="op" id="1591864">(</span><span class="ident" id="1591865">unsafe</span><span class="op" id="1591871">.</span><span class="ident" id="1591872">Pointer</span><span class="op" id="1591879">(</span><span class="ident" id="1591880">gp</span><span class="op" id="1591882">)</span><span class="op" id="1591883">)</span><span class="op" id="1591884">)</span><br>
<span class="lineno"></span><span class="op" id="1591886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1591889">//&nbsp;returns&nbsp;true&nbsp;if&nbsp;IO&nbsp;is&nbsp;ready,&nbsp;or&nbsp;false&nbsp;if&nbsp;timedout&nbsp;or&nbsp;closed</span><br>
<span class="lineno">320</span><span class="comment" id="1591952">//&nbsp;waitio&nbsp;-&nbsp;wait&nbsp;only&nbsp;for&nbsp;completed&nbsp;IO,&nbsp;ignore&nbsp;errors</span><br>
<span class="lineno"></span><span class="keyword" id="1592006">func</span>&nbsp;<span class="ident" id="1592011">netpollblock</span><span class="op" id="1592023">(</span><span class="ident" id="1592024">pd</span>&nbsp;<span class="op" id="1592027">*</span><span class="ident" id="1592028">pollDesc</span><span class="op" id="1592036">,</span>&nbsp;<span class="ident" id="1592038">mode</span>&nbsp;<span class="builtintype" id="1592043">int32</span><span class="op" id="1592048">,</span>&nbsp;<span class="ident" id="1592050">waitio</span>&nbsp;<span class="builtintype" id="1592057">bool</span><span class="op" id="1592061">)</span>&nbsp;<span class="builtintype" id="1592063">bool</span>&nbsp;<span class="op" id="1592068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592071">gpp</span>&nbsp;<span class="op" id="1592075">:=</span>&nbsp;<span class="op" id="1592078">&amp;</span><span class="ident" id="1592079">pd</span><span class="op" id="1592081">.</span><span class="ident" id="1592082">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592086">if</span>&nbsp;<span class="ident" id="1592089">mode</span>&nbsp;<span class="op" id="1592094">==</span>&nbsp;<span class="string" id="1592097">&#39;w&#39;</span>&nbsp;<span class="op" id="1592101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592105">gpp</span>&nbsp;<span class="op" id="1592109">=</span>&nbsp;<span class="op" id="1592111">&amp;</span><span class="ident" id="1592112">pd</span><span class="op" id="1592114">.</span><span class="ident" id="1592115">wg</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1592123">//&nbsp;set&nbsp;the&nbsp;gpp&nbsp;semaphore&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592157">for</span>&nbsp;<span class="op" id="1592161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592165">old</span>&nbsp;<span class="op" id="1592169">:=</span>&nbsp;<span class="op" id="1592172">*</span><span class="ident" id="1592173">gpp</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592179">if</span>&nbsp;<span class="ident" id="1592182">old</span>&nbsp;<span class="op" id="1592186">==</span>&nbsp;<span class="ident" id="1592189">pdReady</span>&nbsp;<span class="op" id="1592197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592202">*</span><span class="ident" id="1592203">gpp</span>&nbsp;<span class="op" id="1592207">=</span>&nbsp;<span class="num" id="1592209">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592214">return</span>&nbsp;<span class="builtintype" id="1592221">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592232">if</span>&nbsp;<span class="ident" id="1592235">old</span>&nbsp;<span class="op" id="1592239">!=</span>&nbsp;<span class="num" id="1592242">0</span>&nbsp;<span class="op" id="1592244">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592249">gothrow</span><span class="op" id="1592256">(</span><span class="string" id="1592257">&#34;netpollblock:&nbsp;double&nbsp;wait&#34;</span><span class="op" id="1592284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592292">if</span>&nbsp;<span class="ident" id="1592295">casuintptr</span><span class="op" id="1592305">(</span><span class="ident" id="1592306">gpp</span><span class="op" id="1592309">,</span>&nbsp;<span class="num" id="1592311">0</span><span class="op" id="1592312">,</span>&nbsp;<span class="ident" id="1592314">pdWait</span><span class="op" id="1592320">)</span>&nbsp;<span class="op" id="1592322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592327">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592335">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1592342">//&nbsp;need&nbsp;to&nbsp;recheck&nbsp;error&nbsp;states&nbsp;after&nbsp;setting&nbsp;gpp&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1592401">//&nbsp;this&nbsp;is&nbsp;necessary&nbsp;because&nbsp;runtime_pollUnblock/runtime_pollSetDeadline/deadlineimpl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1592488">//&nbsp;do&nbsp;the&nbsp;opposite:&nbsp;store&nbsp;to&nbsp;closing/rd/wd,&nbsp;membarrier,&nbsp;load&nbsp;of&nbsp;rg/wg</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592559">if</span>&nbsp;<span class="ident" id="1592562">waitio</span>&nbsp;<span class="op" id="1592569">||</span>&nbsp;<span class="ident" id="1592572">netpollcheckerr</span><span class="op" id="1592587">(</span><span class="ident" id="1592588">pd</span><span class="op" id="1592590">,</span>&nbsp;<span class="ident" id="1592592">mode</span><span class="op" id="1592596">)</span>&nbsp;<span class="op" id="1592598">==</span>&nbsp;<span class="num" id="1592601">0</span>&nbsp;<span class="op" id="1592603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592607">f</span>&nbsp;<span class="op" id="1592609">:=</span>&nbsp;<span class="ident" id="1592612">netpollblockcommit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592633">gopark</span><span class="op" id="1592639">(</span><span class="op" id="1592640">*</span><span class="op" id="1592641">*</span><span class="op" id="1592642">(</span><span class="op" id="1592643">*</span><span class="op" id="1592644">*</span><span class="ident" id="1592645">unsafe</span><span class="op" id="1592651">.</span><span class="ident" id="1592652">Pointer</span><span class="op" id="1592659">)</span><span class="op" id="1592660">(</span><span class="ident" id="1592661">unsafe</span><span class="op" id="1592667">.</span><span class="ident" id="1592668">Pointer</span><span class="op" id="1592675">(</span><span class="op" id="1592676">&amp;</span><span class="ident" id="1592677">f</span><span class="op" id="1592678">)</span><span class="op" id="1592679">)</span><span class="op" id="1592680">,</span>&nbsp;<span class="ident" id="1592682">unsafe</span><span class="op" id="1592688">.</span><span class="ident" id="1592689">Pointer</span><span class="op" id="1592696">(</span><span class="ident" id="1592697">gpp</span><span class="op" id="1592700">)</span><span class="op" id="1592701">,</span>&nbsp;<span class="string" id="1592703">&#34;IO&nbsp;wait&#34;</span><span class="op" id="1592712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1592718">//&nbsp;be&nbsp;careful&nbsp;to&nbsp;not&nbsp;lose&nbsp;concurrent&nbsp;READY&nbsp;notification</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592775">old</span>&nbsp;<span class="op" id="1592779">:=</span>&nbsp;<span class="ident" id="1592782">xchguintptr</span><span class="op" id="1592793">(</span><span class="ident" id="1592794">gpp</span><span class="op" id="1592797">,</span>&nbsp;<span class="num" id="1592799">0</span><span class="op" id="1592800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592803">if</span>&nbsp;<span class="ident" id="1592806">old</span>&nbsp;<span class="op" id="1592810">&gt;</span>&nbsp;<span class="ident" id="1592812">pdWait</span>&nbsp;<span class="op" id="1592819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592823">gothrow</span><span class="op" id="1592830">(</span><span class="string" id="1592831">&#34;netpollblock:&nbsp;corrupted&nbsp;state&#34;</span><span class="op" id="1592862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592868">return</span>&nbsp;<span class="ident" id="1592875">old</span>&nbsp;<span class="op" id="1592879">==</span>&nbsp;<span class="ident" id="1592882">pdReady</span><br>
<span class="lineno">355</span><span class="op" id="1592890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1592893">func</span>&nbsp;<span class="ident" id="1592898">netpollunblock</span><span class="op" id="1592912">(</span><span class="ident" id="1592913">pd</span>&nbsp;<span class="op" id="1592916">*</span><span class="ident" id="1592917">pollDesc</span><span class="op" id="1592925">,</span>&nbsp;<span class="ident" id="1592927">mode</span>&nbsp;<span class="builtintype" id="1592932">int32</span><span class="op" id="1592937">,</span>&nbsp;<span class="ident" id="1592939">ioready</span>&nbsp;<span class="builtintype" id="1592947">bool</span><span class="op" id="1592951">)</span>&nbsp;<span class="op" id="1592953">*</span><span class="ident" id="1592954">g</span>&nbsp;<span class="op" id="1592956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592959">gpp</span>&nbsp;<span class="op" id="1592963">:=</span>&nbsp;<span class="op" id="1592966">&amp;</span><span class="ident" id="1592967">pd</span><span class="op" id="1592969">.</span><span class="ident" id="1592970">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592974">if</span>&nbsp;<span class="ident" id="1592977">mode</span>&nbsp;<span class="op" id="1592982">==</span>&nbsp;<span class="string" id="1592985">&#39;w&#39;</span>&nbsp;<span class="op" id="1592989">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592993">gpp</span>&nbsp;<span class="op" id="1592997">=</span>&nbsp;<span class="op" id="1592999">&amp;</span><span class="ident" id="1593000">pd</span><span class="op" id="1593002">.</span><span class="ident" id="1593003">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1593007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593011">for</span>&nbsp;<span class="op" id="1593015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593019">old</span>&nbsp;<span class="op" id="1593023">:=</span>&nbsp;<span class="op" id="1593026">*</span><span class="ident" id="1593027">gpp</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593033">if</span>&nbsp;<span class="ident" id="1593036">old</span>&nbsp;<span class="op" id="1593040">==</span>&nbsp;<span class="ident" id="1593043">pdReady</span>&nbsp;<span class="op" id="1593051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593056">return</span>&nbsp;<span class="ident" id="1593063">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1593069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593073">if</span>&nbsp;<span class="ident" id="1593076">old</span>&nbsp;<span class="op" id="1593080">==</span>&nbsp;<span class="num" id="1593083">0</span>&nbsp;<span class="op" id="1593085">&amp;&amp;</span>&nbsp;<span class="op" id="1593088">!</span><span class="ident" id="1593089">ioready</span>&nbsp;<span class="op" id="1593097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1593102">//&nbsp;Only&nbsp;set&nbsp;READY&nbsp;for&nbsp;ioready.&nbsp;runtime_pollWait</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1593153">//&nbsp;will&nbsp;check&nbsp;for&nbsp;timeout/cancel&nbsp;before&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593205">return</span>&nbsp;<span class="ident" id="1593212">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1593218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593222">var</span>&nbsp;<span class="builtinfunc" id="1593226">new</span>&nbsp;<span class="builtintype" id="1593230">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593240">if</span>&nbsp;<span class="ident" id="1593243">ioready</span>&nbsp;<span class="op" id="1593251">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1593256">new</span>&nbsp;<span class="op" id="1593260">=</span>&nbsp;<span class="ident" id="1593262">pdReady</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1593272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593276">if</span>&nbsp;<span class="ident" id="1593279">casuintptr</span><span class="op" id="1593289">(</span><span class="ident" id="1593290">gpp</span><span class="op" id="1593293">,</span>&nbsp;<span class="ident" id="1593295">old</span><span class="op" id="1593298">,</span>&nbsp;<span class="builtinfunc" id="1593300">new</span><span class="op" id="1593303">)</span>&nbsp;<span class="op" id="1593305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593310">if</span>&nbsp;<span class="ident" id="1593313">old</span>&nbsp;<span class="op" id="1593317">==</span>&nbsp;<span class="ident" id="1593320">pdReady</span>&nbsp;<span class="op" id="1593328">||</span>&nbsp;<span class="ident" id="1593331">old</span>&nbsp;<span class="op" id="1593335">==</span>&nbsp;<span class="ident" id="1593338">pdWait</span>&nbsp;<span class="op" id="1593345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593351">old</span>&nbsp;<span class="op" id="1593355">=</span>&nbsp;<span class="num" id="1593357">0</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1593362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593367">return</span>&nbsp;<span class="op" id="1593374">(</span><span class="op" id="1593375">*</span><span class="ident" id="1593376">g</span><span class="op" id="1593377">)</span><span class="op" id="1593378">(</span><span class="ident" id="1593379">unsafe</span><span class="op" id="1593385">.</span><span class="ident" id="1593386">Pointer</span><span class="op" id="1593393">(</span><span class="ident" id="1593394">old</span><span class="op" id="1593397">)</span><span class="op" id="1593398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1593402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1593405">}</span><br>
<span class="lineno"></span><span class="op" id="1593407">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span><span class="keyword" id="1593410">func</span>&nbsp;<span class="ident" id="1593415">netpolldeadlineimpl</span><span class="op" id="1593434">(</span><span class="ident" id="1593435">pd</span>&nbsp;<span class="op" id="1593438">*</span><span class="ident" id="1593439">pollDesc</span><span class="op" id="1593447">,</span>&nbsp;<span class="ident" id="1593449">seq</span>&nbsp;<span class="builtintype" id="1593453">uintptr</span><span class="op" id="1593460">,</span>&nbsp;<span class="ident" id="1593462">read</span><span class="op" id="1593466">,</span>&nbsp;<span class="ident" id="1593468">write</span>&nbsp;<span class="builtintype" id="1593474">bool</span><span class="op" id="1593478">)</span>&nbsp;<span class="op" id="1593480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593483">lock</span><span class="op" id="1593487">(</span><span class="op" id="1593488">&amp;</span><span class="ident" id="1593489">pd</span><span class="op" id="1593491">.</span><span class="ident" id="1593492">lock</span><span class="op" id="1593496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1593499">//&nbsp;Seq&nbsp;arg&nbsp;is&nbsp;seq&nbsp;when&nbsp;the&nbsp;timer&nbsp;was&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1593542">//&nbsp;If&nbsp;it&#39;s&nbsp;stale,&nbsp;ignore&nbsp;the&nbsp;timer&nbsp;event.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593585">if</span>&nbsp;<span class="ident" id="1593588">seq</span>&nbsp;<span class="op" id="1593592">!=</span>&nbsp;<span class="ident" id="1593595">pd</span><span class="op" id="1593597">.</span><span class="ident" id="1593598">seq</span>&nbsp;<span class="op" id="1593602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1593606">//&nbsp;The&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593659">unlock</span><span class="op" id="1593665">(</span><span class="op" id="1593666">&amp;</span><span class="ident" id="1593667">pd</span><span class="op" id="1593669">.</span><span class="ident" id="1593670">lock</span><span class="op" id="1593674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593678">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1593686">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593689">var</span>&nbsp;<span class="ident" id="1593693">rg</span>&nbsp;<span class="op" id="1593696">*</span><span class="ident" id="1593697">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593700">if</span>&nbsp;<span class="ident" id="1593703">read</span>&nbsp;<span class="op" id="1593708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593712">if</span>&nbsp;<span class="ident" id="1593715">pd</span><span class="op" id="1593717">.</span><span class="ident" id="1593718">rd</span>&nbsp;<span class="op" id="1593721">&lt;=</span>&nbsp;<span class="num" id="1593724">0</span>&nbsp;<span class="op" id="1593726">||</span>&nbsp;<span class="ident" id="1593729">pd</span><span class="op" id="1593731">.</span><span class="ident" id="1593732">rt</span><span class="op" id="1593734">.</span><span class="ident" id="1593735">f</span>&nbsp;<span class="op" id="1593737">==</span>&nbsp;<span class="ident" id="1593740">nil</span>&nbsp;<span class="op" id="1593744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593749">gothrow</span><span class="op" id="1593756">(</span><span class="string" id="1593757">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;read&nbsp;deadline&#34;</span><span class="op" id="1593806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1593810">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593814">pd</span><span class="op" id="1593816">.</span><span class="ident" id="1593817">rd</span>&nbsp;<span class="op" id="1593820">=</span>&nbsp;<span class="op" id="1593822">-</span><span class="num" id="1593823">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593827">atomicstorep</span><span class="op" id="1593839">(</span><span class="ident" id="1593840">unsafe</span><span class="op" id="1593846">.</span><span class="ident" id="1593847">Pointer</span><span class="op" id="1593854">(</span><span class="op" id="1593855">&amp;</span><span class="ident" id="1593856">pd</span><span class="op" id="1593858">.</span><span class="ident" id="1593859">rt</span><span class="op" id="1593861">.</span><span class="ident" id="1593862">f</span><span class="op" id="1593863">)</span><span class="op" id="1593864">,</span>&nbsp;<span class="ident" id="1593866">nil</span><span class="op" id="1593869">)</span>&nbsp;<span class="comment" id="1593871">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;rd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593949">rg</span>&nbsp;<span class="op" id="1593952">=</span>&nbsp;<span class="ident" id="1593954">netpollunblock</span><span class="op" id="1593968">(</span><span class="ident" id="1593969">pd</span><span class="op" id="1593971">,</span>&nbsp;<span class="string" id="1593973">&#39;r&#39;</span><span class="op" id="1593976">,</span>&nbsp;<span class="builtintype" id="1593978">false</span><span class="op" id="1593983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1593986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593989">var</span>&nbsp;<span class="ident" id="1593993">wg</span>&nbsp;<span class="op" id="1593996">*</span><span class="ident" id="1593997">g</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594000">if</span>&nbsp;<span class="ident" id="1594003">write</span>&nbsp;<span class="op" id="1594009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594013">if</span>&nbsp;<span class="ident" id="1594016">pd</span><span class="op" id="1594018">.</span><span class="ident" id="1594019">wd</span>&nbsp;<span class="op" id="1594022">&lt;=</span>&nbsp;<span class="num" id="1594025">0</span>&nbsp;<span class="op" id="1594027">||</span>&nbsp;<span class="ident" id="1594030">pd</span><span class="op" id="1594032">.</span><span class="ident" id="1594033">wt</span><span class="op" id="1594035">.</span><span class="ident" id="1594036">f</span>&nbsp;<span class="op" id="1594038">==</span>&nbsp;<span class="ident" id="1594041">nil</span>&nbsp;<span class="op" id="1594045">&amp;&amp;</span>&nbsp;<span class="op" id="1594048">!</span><span class="ident" id="1594049">read</span>&nbsp;<span class="op" id="1594054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594059">gothrow</span><span class="op" id="1594066">(</span><span class="string" id="1594067">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;write&nbsp;deadline&#34;</span><span class="op" id="1594117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1594121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594125">pd</span><span class="op" id="1594127">.</span><span class="ident" id="1594128">wd</span>&nbsp;<span class="op" id="1594131">=</span>&nbsp;<span class="op" id="1594133">-</span><span class="num" id="1594134">1</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594138">atomicstorep</span><span class="op" id="1594150">(</span><span class="ident" id="1594151">unsafe</span><span class="op" id="1594157">.</span><span class="ident" id="1594158">Pointer</span><span class="op" id="1594165">(</span><span class="op" id="1594166">&amp;</span><span class="ident" id="1594167">pd</span><span class="op" id="1594169">.</span><span class="ident" id="1594170">wt</span><span class="op" id="1594172">.</span><span class="ident" id="1594173">f</span><span class="op" id="1594174">)</span><span class="op" id="1594175">,</span>&nbsp;<span class="ident" id="1594177">nil</span><span class="op" id="1594180">)</span>&nbsp;<span class="comment" id="1594182">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;wd&nbsp;and&nbsp;load&nbsp;of&nbsp;wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594260">wg</span>&nbsp;<span class="op" id="1594263">=</span>&nbsp;<span class="ident" id="1594265">netpollunblock</span><span class="op" id="1594279">(</span><span class="ident" id="1594280">pd</span><span class="op" id="1594282">,</span>&nbsp;<span class="string" id="1594284">&#39;w&#39;</span><span class="op" id="1594287">,</span>&nbsp;<span class="builtintype" id="1594289">false</span><span class="op" id="1594294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1594297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594300">unlock</span><span class="op" id="1594306">(</span><span class="op" id="1594307">&amp;</span><span class="ident" id="1594308">pd</span><span class="op" id="1594310">.</span><span class="ident" id="1594311">lock</span><span class="op" id="1594315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594318">if</span>&nbsp;<span class="ident" id="1594321">rg</span>&nbsp;<span class="op" id="1594324">!=</span>&nbsp;<span class="ident" id="1594327">nil</span>&nbsp;<span class="op" id="1594331">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594335">goready</span><span class="op" id="1594342">(</span><span class="ident" id="1594343">rg</span><span class="op" id="1594345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1594348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594351">if</span>&nbsp;<span class="ident" id="1594354">wg</span>&nbsp;<span class="op" id="1594357">!=</span>&nbsp;<span class="ident" id="1594360">nil</span>&nbsp;<span class="op" id="1594364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594368">goready</span><span class="op" id="1594375">(</span><span class="ident" id="1594376">wg</span><span class="op" id="1594378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1594381">}</span><br>
<span class="lineno">420</span><span class="op" id="1594383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1594386">func</span>&nbsp;<span class="ident" id="1594391">netpollDeadline</span><span class="op" id="1594406">(</span><span class="ident" id="1594407">arg</span>&nbsp;<span class="keyword" id="1594411">interface</span><span class="op" id="1594420">{</span><span class="op" id="1594421">}</span><span class="op" id="1594422">,</span>&nbsp;<span class="ident" id="1594424">seq</span>&nbsp;<span class="builtintype" id="1594428">uintptr</span><span class="op" id="1594435">)</span>&nbsp;<span class="op" id="1594437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594440">netpolldeadlineimpl</span><span class="op" id="1594459">(</span><span class="ident" id="1594460">arg</span><span class="op" id="1594463">.</span><span class="op" id="1594464">(</span><span class="op" id="1594465">*</span><span class="ident" id="1594466">pollDesc</span><span class="op" id="1594474">)</span><span class="op" id="1594475">,</span>&nbsp;<span class="ident" id="1594477">seq</span><span class="op" id="1594480">,</span>&nbsp;<span class="builtintype" id="1594482">true</span><span class="op" id="1594486">,</span>&nbsp;<span class="builtintype" id="1594488">true</span><span class="op" id="1594492">)</span><br>
<span class="lineno"></span><span class="op" id="1594494">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="1594497">func</span>&nbsp;<span class="ident" id="1594502">netpollReadDeadline</span><span class="op" id="1594521">(</span><span class="ident" id="1594522">arg</span>&nbsp;<span class="keyword" id="1594526">interface</span><span class="op" id="1594535">{</span><span class="op" id="1594536">}</span><span class="op" id="1594537">,</span>&nbsp;<span class="ident" id="1594539">seq</span>&nbsp;<span class="builtintype" id="1594543">uintptr</span><span class="op" id="1594550">)</span>&nbsp;<span class="op" id="1594552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594555">netpolldeadlineimpl</span><span class="op" id="1594574">(</span><span class="ident" id="1594575">arg</span><span class="op" id="1594578">.</span><span class="op" id="1594579">(</span><span class="op" id="1594580">*</span><span class="ident" id="1594581">pollDesc</span><span class="op" id="1594589">)</span><span class="op" id="1594590">,</span>&nbsp;<span class="ident" id="1594592">seq</span><span class="op" id="1594595">,</span>&nbsp;<span class="builtintype" id="1594597">true</span><span class="op" id="1594601">,</span>&nbsp;<span class="builtintype" id="1594603">false</span><span class="op" id="1594608">)</span><br>
<span class="lineno"></span><span class="op" id="1594610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="keyword" id="1594613">func</span>&nbsp;<span class="ident" id="1594618">netpollWriteDeadline</span><span class="op" id="1594638">(</span><span class="ident" id="1594639">arg</span>&nbsp;<span class="keyword" id="1594643">interface</span><span class="op" id="1594652">{</span><span class="op" id="1594653">}</span><span class="op" id="1594654">,</span>&nbsp;<span class="ident" id="1594656">seq</span>&nbsp;<span class="builtintype" id="1594660">uintptr</span><span class="op" id="1594667">)</span>&nbsp;<span class="op" id="1594669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594672">netpolldeadlineimpl</span><span class="op" id="1594691">(</span><span class="ident" id="1594692">arg</span><span class="op" id="1594695">.</span><span class="op" id="1594696">(</span><span class="op" id="1594697">*</span><span class="ident" id="1594698">pollDesc</span><span class="op" id="1594706">)</span><span class="op" id="1594707">,</span>&nbsp;<span class="ident" id="1594709">seq</span><span class="op" id="1594712">,</span>&nbsp;<span class="builtintype" id="1594714">false</span><span class="op" id="1594719">,</span>&nbsp;<span class="builtintype" id="1594721">true</span><span class="op" id="1594725">)</span><br>
<span class="lineno"></span><span class="op" id="1594727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1594730">func</span>&nbsp;<span class="op" id="1594735">(</span><span class="ident" id="1594736">c</span>&nbsp;<span class="op" id="1594738">*</span><span class="ident" id="1594739">pollCache</span><span class="op" id="1594748">)</span>&nbsp;<span class="ident" id="1594750">alloc</span><span class="op" id="1594755">(</span><span class="op" id="1594756">)</span>&nbsp;<span class="op" id="1594758">*</span><span class="ident" id="1594759">pollDesc</span>&nbsp;<span class="op" id="1594768">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594771">lock</span><span class="op" id="1594775">(</span><span class="op" id="1594776">&amp;</span><span class="ident" id="1594777">c</span><span class="op" id="1594778">.</span><span class="ident" id="1594779">lock</span><span class="op" id="1594783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594786">if</span>&nbsp;<span class="ident" id="1594789">c</span><span class="op" id="1594790">.</span><span class="ident" id="1594791">first</span>&nbsp;<span class="op" id="1594797">==</span>&nbsp;<span class="ident" id="1594800">nil</span>&nbsp;<span class="op" id="1594804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594808">const</span>&nbsp;<span class="ident" id="1594814">pdSize</span>&nbsp;<span class="op" id="1594821">=</span>&nbsp;<span class="ident" id="1594823">unsafe</span><span class="op" id="1594829">.</span><span class="ident" id="1594830">Sizeof</span><span class="op" id="1594836">(</span><span class="ident" id="1594837">pollDesc</span><span class="op" id="1594845">{</span><span class="op" id="1594846">}</span><span class="op" id="1594847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594851">n</span>&nbsp;<span class="op" id="1594853">:=</span>&nbsp;<span class="ident" id="1594856">pollBlockSize</span>&nbsp;<span class="op" id="1594870">/</span>&nbsp;<span class="ident" id="1594872">pdSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594881">if</span>&nbsp;<span class="ident" id="1594884">n</span>&nbsp;<span class="op" id="1594886">==</span>&nbsp;<span class="num" id="1594889">0</span>&nbsp;<span class="op" id="1594891">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594896">n</span>&nbsp;<span class="op" id="1594898">=</span>&nbsp;<span class="num" id="1594900">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1594904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1594908">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;non-GC&nbsp;memory&nbsp;because&nbsp;can&nbsp;be&nbsp;referenced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1594964">//&nbsp;only&nbsp;from&nbsp;epoll/kqueue&nbsp;internals.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595003">mem</span>&nbsp;<span class="op" id="1595007">:=</span>&nbsp;<span class="ident" id="1595010">persistentalloc</span><span class="op" id="1595025">(</span><span class="ident" id="1595026">n</span><span class="op" id="1595027">*</span><span class="ident" id="1595028">pdSize</span><span class="op" id="1595034">,</span>&nbsp;<span class="num" id="1595036">0</span><span class="op" id="1595037">,</span>&nbsp;<span class="op" id="1595039">&amp;</span><span class="ident" id="1595040">memstats</span><span class="op" id="1595048">.</span><span class="ident" id="1595049">other_sys</span><span class="op" id="1595058">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1595062">for</span>&nbsp;<span class="ident" id="1595066">i</span>&nbsp;<span class="op" id="1595068">:=</span>&nbsp;<span class="builtintype" id="1595071">uintptr</span><span class="op" id="1595078">(</span><span class="num" id="1595079">0</span><span class="op" id="1595080">)</span><span class="op" id="1595081">;</span>&nbsp;<span class="ident" id="1595083">i</span>&nbsp;<span class="op" id="1595085">&lt;</span>&nbsp;<span class="ident" id="1595087">n</span><span class="op" id="1595088">;</span>&nbsp;<span class="ident" id="1595090">i</span><span class="op" id="1595091">++</span>&nbsp;<span class="op" id="1595094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595099">pd</span>&nbsp;<span class="op" id="1595102">:=</span>&nbsp;<span class="op" id="1595105">(</span><span class="op" id="1595106">*</span><span class="ident" id="1595107">pollDesc</span><span class="op" id="1595115">)</span><span class="op" id="1595116">(</span><span class="ident" id="1595117">add</span><span class="op" id="1595120">(</span><span class="ident" id="1595121">mem</span><span class="op" id="1595124">,</span>&nbsp;<span class="ident" id="1595126">i</span><span class="op" id="1595127">*</span><span class="ident" id="1595128">pdSize</span><span class="op" id="1595134">)</span><span class="op" id="1595135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595140">pd</span><span class="op" id="1595142">.</span><span class="ident" id="1595143">link</span>&nbsp;<span class="op" id="1595148">=</span>&nbsp;<span class="ident" id="1595150">c</span><span class="op" id="1595151">.</span><span class="ident" id="1595152">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595161">c</span><span class="op" id="1595162">.</span><span class="ident" id="1595163">first</span>&nbsp;<span class="op" id="1595169">=</span>&nbsp;<span class="ident" id="1595171">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1595176">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1595179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595182">pd</span>&nbsp;<span class="op" id="1595185">:=</span>&nbsp;<span class="ident" id="1595188">c</span><span class="op" id="1595189">.</span><span class="ident" id="1595190">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595197">c</span><span class="op" id="1595198">.</span><span class="ident" id="1595199">first</span>&nbsp;<span class="op" id="1595205">=</span>&nbsp;<span class="ident" id="1595207">pd</span><span class="op" id="1595209">.</span><span class="ident" id="1595210">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595216">unlock</span><span class="op" id="1595222">(</span><span class="op" id="1595223">&amp;</span><span class="ident" id="1595224">c</span><span class="op" id="1595225">.</span><span class="ident" id="1595226">lock</span><span class="op" id="1595230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1595233">return</span>&nbsp;<span class="ident" id="1595240">pd</span><br>
<span class="lineno">455</span><span class="op" id="1595243">}</span>
</div>
</body>
</html>
