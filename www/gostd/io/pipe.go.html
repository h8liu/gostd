<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>io</h2>
<ul>
<li><a href="/gostd/io/io.go.html">io.go</a></li>
<li><a href="/gostd/io/io_test.go.html">io_test.go</a></li>
<li><a href="/gostd/io/multi.go.html">multi.go</a></li>
<li><a href="/gostd/io/multi_test.go.html">multi_test.go</a></li>
<li><a href="/gostd/io/pipe.go.html" class="current">pipe.go</a></li>
<li><a href="/gostd/io/pipe_test.go.html">pipe_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1347957">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1348012">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1348066">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1348117">//&nbsp;Pipe&nbsp;adapter&nbsp;to&nbsp;connect&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Reader</span><br>
<span class="lineno"></span><span class="comment" id="1348172">//&nbsp;with&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1348210">package</span>&nbsp;<span class="ident" id="1348218">io</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1348222">import</span>&nbsp;<span class="op" id="1348229">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1348232">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1348242">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="1348249">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="1348252">//&nbsp;ErrClosedPipe&nbsp;is&nbsp;the&nbsp;error&nbsp;used&nbsp;for&nbsp;read&nbsp;or&nbsp;write&nbsp;operations&nbsp;on&nbsp;a&nbsp;closed&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1348334">var</span>&nbsp;<span class="ident" id="1348338">ErrClosedPipe</span>&nbsp;<span class="op" id="1348352">=</span>&nbsp;<span class="ident" id="1348354">errors</span><span class="op" id="1348360">.</span><span class="ident" id="1348361">New</span><span class="op" id="1348364">(</span><span class="string" id="1348365">&#34;io:&nbsp;read/write&nbsp;on&nbsp;closed&nbsp;pipe&#34;</span><span class="op" id="1348396">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1348399">type</span>&nbsp;<span class="ident" id="1348404">pipeResult</span>&nbsp;<span class="keyword" id="1348415">struct</span>&nbsp;<span class="op" id="1348422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1348425">n</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1348429">int</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1348434">err</span>&nbsp;<span class="builtintype" id="1348438">error</span><br>
<span class="lineno"></span><span class="op" id="1348444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1348447">//&nbsp;A&nbsp;pipe&nbsp;is&nbsp;the&nbsp;shared&nbsp;pipe&nbsp;structure&nbsp;underlying&nbsp;PipeReader&nbsp;and&nbsp;PipeWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="1348524">type</span>&nbsp;<span class="ident" id="1348529">pipe</span>&nbsp;<span class="keyword" id="1348534">struct</span>&nbsp;<span class="op" id="1348541">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1348544">rl</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1348550">sync</span><span class="op" id="1348554">.</span><span class="ident" id="1348555">Mutex</span>&nbsp;<span class="comment" id="1348561">//&nbsp;gates&nbsp;readers&nbsp;one&nbsp;at&nbsp;a&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1348593">wl</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1348599">sync</span><span class="op" id="1348603">.</span><span class="ident" id="1348604">Mutex</span>&nbsp;<span class="comment" id="1348610">//&nbsp;gates&nbsp;writers&nbsp;one&nbsp;at&nbsp;a&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1348642">l</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1348648">sync</span><span class="op" id="1348652">.</span><span class="ident" id="1348653">Mutex</span>&nbsp;<span class="comment" id="1348659">//&nbsp;protects&nbsp;remaining&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1348689">data</span>&nbsp;&nbsp;<span class="op" id="1348695">[</span><span class="op" id="1348696">]</span><span class="builtintype" id="1348697">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1348706">//&nbsp;data&nbsp;remaining&nbsp;in&nbsp;pending&nbsp;write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1348742">rwait</span>&nbsp;<span class="ident" id="1348748">sync</span><span class="op" id="1348752">.</span><span class="ident" id="1348753">Cond</span>&nbsp;&nbsp;<span class="comment" id="1348759">//&nbsp;waiting&nbsp;reader</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1348778">wwait</span>&nbsp;<span class="ident" id="1348784">sync</span><span class="op" id="1348788">.</span><span class="ident" id="1348789">Cond</span>&nbsp;&nbsp;<span class="comment" id="1348795">//&nbsp;waiting&nbsp;writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1348814">rerr</span>&nbsp;&nbsp;<span class="builtintype" id="1348820">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1348831">//&nbsp;if&nbsp;reader&nbsp;closed,&nbsp;error&nbsp;to&nbsp;give&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1348874">werr</span>&nbsp;&nbsp;<span class="builtintype" id="1348880">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1348891">//&nbsp;if&nbsp;writer&nbsp;closed,&nbsp;error&nbsp;to&nbsp;give&nbsp;reads</span><br>
<span class="lineno"></span><span class="op" id="1348932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="1348935">func</span>&nbsp;<span class="op" id="1348940">(</span><span class="ident" id="1348941">p</span>&nbsp;<span class="op" id="1348943">*</span><span class="ident" id="1348944">pipe</span><span class="op" id="1348948">)</span>&nbsp;<span class="ident" id="1348950">read</span><span class="op" id="1348954">(</span><span class="ident" id="1348955">b</span>&nbsp;<span class="op" id="1348957">[</span><span class="op" id="1348958">]</span><span class="builtintype" id="1348959">byte</span><span class="op" id="1348963">)</span>&nbsp;<span class="op" id="1348965">(</span><span class="ident" id="1348966">n</span>&nbsp;<span class="builtintype" id="1348968">int</span><span class="op" id="1348971">,</span>&nbsp;<span class="ident" id="1348973">err</span>&nbsp;<span class="builtintype" id="1348977">error</span><span class="op" id="1348982">)</span>&nbsp;<span class="op" id="1348984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1348987">//&nbsp;One&nbsp;reader&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349013">p</span><span class="op" id="1349014">.</span><span class="ident" id="1349015">rl</span><span class="op" id="1349017">.</span><span class="ident" id="1349018">Lock</span><span class="op" id="1349022">(</span><span class="op" id="1349023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349026">defer</span>&nbsp;<span class="ident" id="1349032">p</span><span class="op" id="1349033">.</span><span class="ident" id="1349034">rl</span><span class="op" id="1349036">.</span><span class="ident" id="1349037">Unlock</span><span class="op" id="1349043">(</span><span class="op" id="1349044">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349048">p</span><span class="op" id="1349049">.</span><span class="ident" id="1349050">l</span><span class="op" id="1349051">.</span><span class="ident" id="1349052">Lock</span><span class="op" id="1349056">(</span><span class="op" id="1349057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349060">defer</span>&nbsp;<span class="ident" id="1349066">p</span><span class="op" id="1349067">.</span><span class="ident" id="1349068">l</span><span class="op" id="1349069">.</span><span class="ident" id="1349070">Unlock</span><span class="op" id="1349076">(</span><span class="op" id="1349077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349080">for</span>&nbsp;<span class="op" id="1349084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349088">if</span>&nbsp;<span class="ident" id="1349091">p</span><span class="op" id="1349092">.</span><span class="ident" id="1349093">rerr</span>&nbsp;<span class="op" id="1349098">!=</span>&nbsp;<span class="builtintype" id="1349101">nil</span>&nbsp;<span class="op" id="1349105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349110">return</span>&nbsp;<span class="num" id="1349117">0</span><span class="op" id="1349118">,</span>&nbsp;<span class="ident" id="1349120">ErrClosedPipe</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1349136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349140">if</span>&nbsp;<span class="ident" id="1349143">p</span><span class="op" id="1349144">.</span><span class="ident" id="1349145">data</span>&nbsp;<span class="op" id="1349150">!=</span>&nbsp;<span class="builtintype" id="1349153">nil</span>&nbsp;<span class="op" id="1349157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349162">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1349170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349174">if</span>&nbsp;<span class="ident" id="1349177">p</span><span class="op" id="1349178">.</span><span class="ident" id="1349179">werr</span>&nbsp;<span class="op" id="1349184">!=</span>&nbsp;<span class="builtintype" id="1349187">nil</span>&nbsp;<span class="op" id="1349191">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349196">return</span>&nbsp;<span class="num" id="1349203">0</span><span class="op" id="1349204">,</span>&nbsp;<span class="ident" id="1349206">p</span><span class="op" id="1349207">.</span><span class="ident" id="1349208">werr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1349215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349219">p</span><span class="op" id="1349220">.</span><span class="ident" id="1349221">rwait</span><span class="op" id="1349226">.</span><span class="ident" id="1349227">Wait</span><span class="op" id="1349231">(</span><span class="op" id="1349232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1349235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349238">n</span>&nbsp;<span class="op" id="1349240">=</span>&nbsp;<span class="builtinfunc" id="1349242">copy</span><span class="op" id="1349246">(</span><span class="ident" id="1349247">b</span><span class="op" id="1349248">,</span>&nbsp;<span class="ident" id="1349250">p</span><span class="op" id="1349251">.</span><span class="ident" id="1349252">data</span><span class="op" id="1349256">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349259">p</span><span class="op" id="1349260">.</span><span class="ident" id="1349261">data</span>&nbsp;<span class="op" id="1349266">=</span>&nbsp;<span class="ident" id="1349268">p</span><span class="op" id="1349269">.</span><span class="ident" id="1349270">data</span><span class="op" id="1349274">[</span><span class="ident" id="1349275">n</span><span class="op" id="1349276">:</span><span class="op" id="1349277">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349280">if</span>&nbsp;<span class="builtinfunc" id="1349283">len</span><span class="op" id="1349286">(</span><span class="ident" id="1349287">p</span><span class="op" id="1349288">.</span><span class="ident" id="1349289">data</span><span class="op" id="1349293">)</span>&nbsp;<span class="op" id="1349295">==</span>&nbsp;<span class="num" id="1349298">0</span>&nbsp;<span class="op" id="1349300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349304">p</span><span class="op" id="1349305">.</span><span class="ident" id="1349306">data</span>&nbsp;<span class="op" id="1349311">=</span>&nbsp;<span class="builtintype" id="1349313">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349319">p</span><span class="op" id="1349320">.</span><span class="ident" id="1349321">wwait</span><span class="op" id="1349326">.</span><span class="ident" id="1349327">Signal</span><span class="op" id="1349333">(</span><span class="op" id="1349334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1349337">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349340">return</span><br>
<span class="lineno"></span><span class="op" id="1349347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1349350">var</span>&nbsp;<span class="ident" id="1349354">zero</span>&nbsp;<span class="op" id="1349359">[</span><span class="num" id="1349360">0</span><span class="op" id="1349361">]</span><span class="builtintype" id="1349362">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="1349368">func</span>&nbsp;<span class="op" id="1349373">(</span><span class="ident" id="1349374">p</span>&nbsp;<span class="op" id="1349376">*</span><span class="ident" id="1349377">pipe</span><span class="op" id="1349381">)</span>&nbsp;<span class="ident" id="1349383">write</span><span class="op" id="1349388">(</span><span class="ident" id="1349389">b</span>&nbsp;<span class="op" id="1349391">[</span><span class="op" id="1349392">]</span><span class="builtintype" id="1349393">byte</span><span class="op" id="1349397">)</span>&nbsp;<span class="op" id="1349399">(</span><span class="ident" id="1349400">n</span>&nbsp;<span class="builtintype" id="1349402">int</span><span class="op" id="1349405">,</span>&nbsp;<span class="ident" id="1349407">err</span>&nbsp;<span class="builtintype" id="1349411">error</span><span class="op" id="1349416">)</span>&nbsp;<span class="op" id="1349418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1349421">//&nbsp;pipe&nbsp;uses&nbsp;nil&nbsp;to&nbsp;mean&nbsp;not&nbsp;available</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349461">if</span>&nbsp;<span class="ident" id="1349464">b</span>&nbsp;<span class="op" id="1349466">==</span>&nbsp;<span class="builtintype" id="1349469">nil</span>&nbsp;<span class="op" id="1349473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349477">b</span>&nbsp;<span class="op" id="1349479">=</span>&nbsp;<span class="ident" id="1349481">zero</span><span class="op" id="1349485">[</span><span class="op" id="1349486">:</span><span class="op" id="1349487">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1349490">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1349494">//&nbsp;One&nbsp;writer&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349520">p</span><span class="op" id="1349521">.</span><span class="ident" id="1349522">wl</span><span class="op" id="1349524">.</span><span class="ident" id="1349525">Lock</span><span class="op" id="1349529">(</span><span class="op" id="1349530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349533">defer</span>&nbsp;<span class="ident" id="1349539">p</span><span class="op" id="1349540">.</span><span class="ident" id="1349541">wl</span><span class="op" id="1349543">.</span><span class="ident" id="1349544">Unlock</span><span class="op" id="1349550">(</span><span class="op" id="1349551">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349555">p</span><span class="op" id="1349556">.</span><span class="ident" id="1349557">l</span><span class="op" id="1349558">.</span><span class="ident" id="1349559">Lock</span><span class="op" id="1349563">(</span><span class="op" id="1349564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349567">defer</span>&nbsp;<span class="ident" id="1349573">p</span><span class="op" id="1349574">.</span><span class="ident" id="1349575">l</span><span class="op" id="1349576">.</span><span class="ident" id="1349577">Unlock</span><span class="op" id="1349583">(</span><span class="op" id="1349584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349587">if</span>&nbsp;<span class="ident" id="1349590">p</span><span class="op" id="1349591">.</span><span class="ident" id="1349592">werr</span>&nbsp;<span class="op" id="1349597">!=</span>&nbsp;<span class="builtintype" id="1349600">nil</span>&nbsp;<span class="op" id="1349604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349608">err</span>&nbsp;<span class="op" id="1349612">=</span>&nbsp;<span class="ident" id="1349614">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349630">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1349638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349641">p</span><span class="op" id="1349642">.</span><span class="ident" id="1349643">data</span>&nbsp;<span class="op" id="1349648">=</span>&nbsp;<span class="ident" id="1349650">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349653">p</span><span class="op" id="1349654">.</span><span class="ident" id="1349655">rwait</span><span class="op" id="1349660">.</span><span class="ident" id="1349661">Signal</span><span class="op" id="1349667">(</span><span class="op" id="1349668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349671">for</span>&nbsp;<span class="op" id="1349675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349679">if</span>&nbsp;<span class="ident" id="1349682">p</span><span class="op" id="1349683">.</span><span class="ident" id="1349684">data</span>&nbsp;<span class="op" id="1349689">==</span>&nbsp;<span class="builtintype" id="1349692">nil</span>&nbsp;<span class="op" id="1349696">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349701">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1349709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349713">if</span>&nbsp;<span class="ident" id="1349716">p</span><span class="op" id="1349717">.</span><span class="ident" id="1349718">rerr</span>&nbsp;<span class="op" id="1349723">!=</span>&nbsp;<span class="builtintype" id="1349726">nil</span>&nbsp;<span class="op" id="1349730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349735">err</span>&nbsp;<span class="op" id="1349739">=</span>&nbsp;<span class="ident" id="1349741">p</span><span class="op" id="1349742">.</span><span class="ident" id="1349743">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349751">break</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1349759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349763">if</span>&nbsp;<span class="ident" id="1349766">p</span><span class="op" id="1349767">.</span><span class="ident" id="1349768">werr</span>&nbsp;<span class="op" id="1349773">!=</span>&nbsp;<span class="builtintype" id="1349776">nil</span>&nbsp;<span class="op" id="1349780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349785">err</span>&nbsp;<span class="op" id="1349789">=</span>&nbsp;<span class="ident" id="1349791">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1349807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349811">p</span><span class="op" id="1349812">.</span><span class="ident" id="1349813">wwait</span><span class="op" id="1349818">.</span><span class="ident" id="1349819">Wait</span><span class="op" id="1349823">(</span><span class="op" id="1349824">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1349827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349830">n</span>&nbsp;<span class="op" id="1349832">=</span>&nbsp;<span class="builtinfunc" id="1349834">len</span><span class="op" id="1349837">(</span><span class="ident" id="1349838">b</span><span class="op" id="1349839">)</span>&nbsp;<span class="op" id="1349841">-</span>&nbsp;<span class="builtinfunc" id="1349843">len</span><span class="op" id="1349846">(</span><span class="ident" id="1349847">p</span><span class="op" id="1349848">.</span><span class="ident" id="1349849">data</span><span class="op" id="1349853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349856">p</span><span class="op" id="1349857">.</span><span class="ident" id="1349858">data</span>&nbsp;<span class="op" id="1349863">=</span>&nbsp;<span class="builtintype" id="1349865">nil</span>&nbsp;<span class="comment" id="1349869">//&nbsp;in&nbsp;case&nbsp;of&nbsp;rerr&nbsp;or&nbsp;werr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349897">return</span><br>
<span class="lineno"></span><span class="op" id="1349904">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="1349907">func</span>&nbsp;<span class="op" id="1349912">(</span><span class="ident" id="1349913">p</span>&nbsp;<span class="op" id="1349915">*</span><span class="ident" id="1349916">pipe</span><span class="op" id="1349920">)</span>&nbsp;<span class="ident" id="1349922">rclose</span><span class="op" id="1349928">(</span><span class="ident" id="1349929">err</span>&nbsp;<span class="builtintype" id="1349933">error</span><span class="op" id="1349938">)</span>&nbsp;<span class="op" id="1349940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349943">if</span>&nbsp;<span class="ident" id="1349946">err</span>&nbsp;<span class="op" id="1349950">==</span>&nbsp;<span class="builtintype" id="1349953">nil</span>&nbsp;<span class="op" id="1349957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349961">err</span>&nbsp;<span class="op" id="1349965">=</span>&nbsp;<span class="ident" id="1349967">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1349982">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1349985">p</span><span class="op" id="1349986">.</span><span class="ident" id="1349987">l</span><span class="op" id="1349988">.</span><span class="ident" id="1349989">Lock</span><span class="op" id="1349993">(</span><span class="op" id="1349994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1349997">defer</span>&nbsp;<span class="ident" id="1350003">p</span><span class="op" id="1350004">.</span><span class="ident" id="1350005">l</span><span class="op" id="1350006">.</span><span class="ident" id="1350007">Unlock</span><span class="op" id="1350013">(</span><span class="op" id="1350014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1350017">p</span><span class="op" id="1350018">.</span><span class="ident" id="1350019">rerr</span>&nbsp;<span class="op" id="1350024">=</span>&nbsp;<span class="ident" id="1350026">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1350031">p</span><span class="op" id="1350032">.</span><span class="ident" id="1350033">rwait</span><span class="op" id="1350038">.</span><span class="ident" id="1350039">Signal</span><span class="op" id="1350045">(</span><span class="op" id="1350046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1350049">p</span><span class="op" id="1350050">.</span><span class="ident" id="1350051">wwait</span><span class="op" id="1350056">.</span><span class="ident" id="1350057">Signal</span><span class="op" id="1350063">(</span><span class="op" id="1350064">)</span><br>
<span class="lineno">110</span><span class="op" id="1350066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1350069">func</span>&nbsp;<span class="op" id="1350074">(</span><span class="ident" id="1350075">p</span>&nbsp;<span class="op" id="1350077">*</span><span class="ident" id="1350078">pipe</span><span class="op" id="1350082">)</span>&nbsp;<span class="ident" id="1350084">wclose</span><span class="op" id="1350090">(</span><span class="ident" id="1350091">err</span>&nbsp;<span class="builtintype" id="1350095">error</span><span class="op" id="1350100">)</span>&nbsp;<span class="op" id="1350102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1350105">if</span>&nbsp;<span class="ident" id="1350108">err</span>&nbsp;<span class="op" id="1350112">==</span>&nbsp;<span class="builtintype" id="1350115">nil</span>&nbsp;<span class="op" id="1350119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1350123">err</span>&nbsp;<span class="op" id="1350127">=</span>&nbsp;<span class="ident" id="1350129">EOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1350134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1350137">p</span><span class="op" id="1350138">.</span><span class="ident" id="1350139">l</span><span class="op" id="1350140">.</span><span class="ident" id="1350141">Lock</span><span class="op" id="1350145">(</span><span class="op" id="1350146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1350149">defer</span>&nbsp;<span class="ident" id="1350155">p</span><span class="op" id="1350156">.</span><span class="ident" id="1350157">l</span><span class="op" id="1350158">.</span><span class="ident" id="1350159">Unlock</span><span class="op" id="1350165">(</span><span class="op" id="1350166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1350169">p</span><span class="op" id="1350170">.</span><span class="ident" id="1350171">werr</span>&nbsp;<span class="op" id="1350176">=</span>&nbsp;<span class="ident" id="1350178">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1350183">p</span><span class="op" id="1350184">.</span><span class="ident" id="1350185">rwait</span><span class="op" id="1350190">.</span><span class="ident" id="1350191">Signal</span><span class="op" id="1350197">(</span><span class="op" id="1350198">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1350201">p</span><span class="op" id="1350202">.</span><span class="ident" id="1350203">wwait</span><span class="op" id="1350208">.</span><span class="ident" id="1350209">Signal</span><span class="op" id="1350215">(</span><span class="op" id="1350216">)</span><br>
<span class="lineno"></span><span class="op" id="1350218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1350221">//&nbsp;A&nbsp;PipeReader&nbsp;is&nbsp;the&nbsp;read&nbsp;half&nbsp;of&nbsp;a&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1350265">type</span>&nbsp;<span class="ident" id="1350270">PipeReader</span>&nbsp;<span class="keyword" id="1350281">struct</span>&nbsp;<span class="op" id="1350288">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1350291">p</span>&nbsp;<span class="op" id="1350293">*</span><span class="ident" id="1350294">pipe</span><br>
<span class="lineno"></span><span class="op" id="1350299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1350302">//&nbsp;Read&nbsp;implements&nbsp;the&nbsp;standard&nbsp;Read&nbsp;interface:</span><br>
<span class="lineno"></span><span class="comment" id="1350350">//&nbsp;it&nbsp;reads&nbsp;data&nbsp;from&nbsp;the&nbsp;pipe,&nbsp;blocking&nbsp;until&nbsp;a&nbsp;writer</span><br>
<span class="lineno">130</span><span class="comment" id="1350406">//&nbsp;arrives&nbsp;or&nbsp;the&nbsp;write&nbsp;end&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="1350445">//&nbsp;If&nbsp;the&nbsp;write&nbsp;end&nbsp;is&nbsp;closed&nbsp;with&nbsp;an&nbsp;error,&nbsp;that&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1350504">//&nbsp;returned&nbsp;as&nbsp;err;&nbsp;otherwise&nbsp;err&nbsp;is&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="1350546">func</span>&nbsp;<span class="op" id="1350551">(</span><span class="ident" id="1350552">r</span>&nbsp;<span class="op" id="1350554">*</span><span class="ident" id="1350555">PipeReader</span><span class="op" id="1350565">)</span>&nbsp;<span class="ident" id="1350567">Read</span><span class="op" id="1350571">(</span><span class="ident" id="1350572">data</span>&nbsp;<span class="op" id="1350577">[</span><span class="op" id="1350578">]</span><span class="builtintype" id="1350579">byte</span><span class="op" id="1350583">)</span>&nbsp;<span class="op" id="1350585">(</span><span class="ident" id="1350586">n</span>&nbsp;<span class="builtintype" id="1350588">int</span><span class="op" id="1350591">,</span>&nbsp;<span class="ident" id="1350593">err</span>&nbsp;<span class="builtintype" id="1350597">error</span><span class="op" id="1350602">)</span>&nbsp;<span class="op" id="1350604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1350607">return</span>&nbsp;<span class="ident" id="1350614">r</span><span class="op" id="1350615">.</span><span class="ident" id="1350616">p</span><span class="op" id="1350617">.</span><span class="ident" id="1350618">read</span><span class="op" id="1350622">(</span><span class="ident" id="1350623">data</span><span class="op" id="1350627">)</span><br>
<span class="lineno">135</span><span class="op" id="1350629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1350632">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;reader;&nbsp;subsequent&nbsp;writes&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1350685">//&nbsp;write&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;the&nbsp;error&nbsp;ErrClosedPipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1350748">func</span>&nbsp;<span class="op" id="1350753">(</span><span class="ident" id="1350754">r</span>&nbsp;<span class="op" id="1350756">*</span><span class="ident" id="1350757">PipeReader</span><span class="op" id="1350767">)</span>&nbsp;<span class="ident" id="1350769">Close</span><span class="op" id="1350774">(</span><span class="op" id="1350775">)</span>&nbsp;<span class="builtintype" id="1350777">error</span>&nbsp;<span class="op" id="1350783">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1350786">return</span>&nbsp;<span class="ident" id="1350793">r</span><span class="op" id="1350794">.</span><span class="ident" id="1350795">CloseWithError</span><span class="op" id="1350809">(</span><span class="builtintype" id="1350810">nil</span><span class="op" id="1350813">)</span><br>
<span class="lineno"></span><span class="op" id="1350815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1350818">//&nbsp;CloseWithError&nbsp;closes&nbsp;the&nbsp;reader;&nbsp;subsequent&nbsp;writes</span><br>
<span class="lineno"></span><span class="comment" id="1350873">//&nbsp;to&nbsp;the&nbsp;write&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;the&nbsp;error&nbsp;err.</span><br>
<span class="lineno">145</span><span class="keyword" id="1350933">func</span>&nbsp;<span class="op" id="1350938">(</span><span class="ident" id="1350939">r</span>&nbsp;<span class="op" id="1350941">*</span><span class="ident" id="1350942">PipeReader</span><span class="op" id="1350952">)</span>&nbsp;<span class="ident" id="1350954">CloseWithError</span><span class="op" id="1350968">(</span><span class="ident" id="1350969">err</span>&nbsp;<span class="builtintype" id="1350973">error</span><span class="op" id="1350978">)</span>&nbsp;<span class="builtintype" id="1350980">error</span>&nbsp;<span class="op" id="1350986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1350989">r</span><span class="op" id="1350990">.</span><span class="ident" id="1350991">p</span><span class="op" id="1350992">.</span><span class="ident" id="1350993">rclose</span><span class="op" id="1350999">(</span><span class="ident" id="1351000">err</span><span class="op" id="1351003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1351006">return</span>&nbsp;<span class="builtintype" id="1351013">nil</span><br>
<span class="lineno"></span><span class="op" id="1351017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1351020">//&nbsp;A&nbsp;PipeWriter&nbsp;is&nbsp;the&nbsp;write&nbsp;half&nbsp;of&nbsp;a&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1351065">type</span>&nbsp;<span class="ident" id="1351070">PipeWriter</span>&nbsp;<span class="keyword" id="1351081">struct</span>&nbsp;<span class="op" id="1351088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351091">p</span>&nbsp;<span class="op" id="1351093">*</span><span class="ident" id="1351094">pipe</span><br>
<span class="lineno"></span><span class="op" id="1351099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="1351102">//&nbsp;Write&nbsp;implements&nbsp;the&nbsp;standard&nbsp;Write&nbsp;interface:</span><br>
<span class="lineno"></span><span class="comment" id="1351152">//&nbsp;it&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;pipe,&nbsp;blocking&nbsp;until&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1351206">//&nbsp;have&nbsp;consumed&nbsp;all&nbsp;the&nbsp;data&nbsp;or&nbsp;the&nbsp;read&nbsp;end&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="1351263">//&nbsp;If&nbsp;the&nbsp;read&nbsp;end&nbsp;is&nbsp;closed&nbsp;with&nbsp;an&nbsp;error,&nbsp;that&nbsp;err&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1351319">//&nbsp;returned&nbsp;as&nbsp;err;&nbsp;otherwise&nbsp;err&nbsp;is&nbsp;ErrClosedPipe.</span><br>
<span class="lineno">160</span><span class="keyword" id="1351371">func</span>&nbsp;<span class="op" id="1351376">(</span><span class="ident" id="1351377">w</span>&nbsp;<span class="op" id="1351379">*</span><span class="ident" id="1351380">PipeWriter</span><span class="op" id="1351390">)</span>&nbsp;<span class="ident" id="1351392">Write</span><span class="op" id="1351397">(</span><span class="ident" id="1351398">data</span>&nbsp;<span class="op" id="1351403">[</span><span class="op" id="1351404">]</span><span class="builtintype" id="1351405">byte</span><span class="op" id="1351409">)</span>&nbsp;<span class="op" id="1351411">(</span><span class="ident" id="1351412">n</span>&nbsp;<span class="builtintype" id="1351414">int</span><span class="op" id="1351417">,</span>&nbsp;<span class="ident" id="1351419">err</span>&nbsp;<span class="builtintype" id="1351423">error</span><span class="op" id="1351428">)</span>&nbsp;<span class="op" id="1351430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1351433">return</span>&nbsp;<span class="ident" id="1351440">w</span><span class="op" id="1351441">.</span><span class="ident" id="1351442">p</span><span class="op" id="1351443">.</span><span class="ident" id="1351444">write</span><span class="op" id="1351449">(</span><span class="ident" id="1351450">data</span><span class="op" id="1351454">)</span><br>
<span class="lineno"></span><span class="op" id="1351456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1351459">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;writer;&nbsp;subsequent&nbsp;reads&nbsp;from&nbsp;the</span><br>
<span class="lineno">165</span><span class="comment" id="1351513">//&nbsp;read&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;no&nbsp;bytes&nbsp;and&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="1351568">func</span>&nbsp;<span class="op" id="1351573">(</span><span class="ident" id="1351574">w</span>&nbsp;<span class="op" id="1351576">*</span><span class="ident" id="1351577">PipeWriter</span><span class="op" id="1351587">)</span>&nbsp;<span class="ident" id="1351589">Close</span><span class="op" id="1351594">(</span><span class="op" id="1351595">)</span>&nbsp;<span class="builtintype" id="1351597">error</span>&nbsp;<span class="op" id="1351603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1351606">return</span>&nbsp;<span class="ident" id="1351613">w</span><span class="op" id="1351614">.</span><span class="ident" id="1351615">CloseWithError</span><span class="op" id="1351629">(</span><span class="builtintype" id="1351630">nil</span><span class="op" id="1351633">)</span><br>
<span class="lineno"></span><span class="op" id="1351635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="1351638">//&nbsp;CloseWithError&nbsp;closes&nbsp;the&nbsp;writer;&nbsp;subsequent&nbsp;reads&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1351701">//&nbsp;read&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;no&nbsp;bytes&nbsp;and&nbsp;the&nbsp;error&nbsp;err.</span><br>
<span class="lineno"></span><span class="keyword" id="1351766">func</span>&nbsp;<span class="op" id="1351771">(</span><span class="ident" id="1351772">w</span>&nbsp;<span class="op" id="1351774">*</span><span class="ident" id="1351775">PipeWriter</span><span class="op" id="1351785">)</span>&nbsp;<span class="ident" id="1351787">CloseWithError</span><span class="op" id="1351801">(</span><span class="ident" id="1351802">err</span>&nbsp;<span class="builtintype" id="1351806">error</span><span class="op" id="1351811">)</span>&nbsp;<span class="builtintype" id="1351813">error</span>&nbsp;<span class="op" id="1351819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1351822">w</span><span class="op" id="1351823">.</span><span class="ident" id="1351824">p</span><span class="op" id="1351825">.</span><span class="ident" id="1351826">wclose</span><span class="op" id="1351832">(</span><span class="ident" id="1351833">err</span><span class="op" id="1351836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1351839">return</span>&nbsp;<span class="builtintype" id="1351846">nil</span><br>
<span class="lineno">175</span><span class="op" id="1351850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1351853">//&nbsp;Pipe&nbsp;creates&nbsp;a&nbsp;synchronous&nbsp;in-memory&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="1351899">//&nbsp;It&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;connect&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Reader</span><br>
<span class="lineno"></span><span class="comment" id="1351956">//&nbsp;with&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno">180</span><span class="comment" id="1351993">//&nbsp;Reads&nbsp;on&nbsp;one&nbsp;end&nbsp;are&nbsp;matched&nbsp;with&nbsp;writes&nbsp;on&nbsp;the&nbsp;other,</span><br>
<span class="lineno"></span><span class="comment" id="1352051">//&nbsp;copying&nbsp;data&nbsp;directly&nbsp;between&nbsp;the&nbsp;two;&nbsp;there&nbsp;is&nbsp;no&nbsp;internal&nbsp;buffering.</span><br>
<span class="lineno"></span><span class="comment" id="1352125">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;Read&nbsp;and&nbsp;Write&nbsp;in&nbsp;parallel&nbsp;with&nbsp;each&nbsp;other&nbsp;or&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1352198">//&nbsp;Close.&nbsp;Close&nbsp;will&nbsp;complete&nbsp;once&nbsp;pending&nbsp;I/O&nbsp;is&nbsp;done.&nbsp;Parallel&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1352272">//&nbsp;Read,&nbsp;and&nbsp;parallel&nbsp;calls&nbsp;to&nbsp;Write,&nbsp;are&nbsp;also&nbsp;safe:</span><br>
<span class="lineno">185</span><span class="comment" id="1352325">//&nbsp;the&nbsp;individual&nbsp;calls&nbsp;will&nbsp;be&nbsp;gated&nbsp;sequentially.</span><br>
<span class="lineno"></span><span class="keyword" id="1352377">func</span>&nbsp;<span class="ident" id="1352382">Pipe</span><span class="op" id="1352386">(</span><span class="op" id="1352387">)</span>&nbsp;<span class="op" id="1352389">(</span><span class="op" id="1352390">*</span><span class="ident" id="1352391">PipeReader</span><span class="op" id="1352401">,</span>&nbsp;<span class="op" id="1352403">*</span><span class="ident" id="1352404">PipeWriter</span><span class="op" id="1352414">)</span>&nbsp;<span class="op" id="1352416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352419">p</span>&nbsp;<span class="op" id="1352421">:=</span>&nbsp;<span class="builtinfunc" id="1352424">new</span><span class="op" id="1352427">(</span><span class="ident" id="1352428">pipe</span><span class="op" id="1352432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352435">p</span><span class="op" id="1352436">.</span><span class="ident" id="1352437">rwait</span><span class="op" id="1352442">.</span><span class="ident" id="1352443">L</span>&nbsp;<span class="op" id="1352445">=</span>&nbsp;<span class="op" id="1352447">&amp;</span><span class="ident" id="1352448">p</span><span class="op" id="1352449">.</span><span class="ident" id="1352450">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352453">p</span><span class="op" id="1352454">.</span><span class="ident" id="1352455">wwait</span><span class="op" id="1352460">.</span><span class="ident" id="1352461">L</span>&nbsp;<span class="op" id="1352463">=</span>&nbsp;<span class="op" id="1352465">&amp;</span><span class="ident" id="1352466">p</span><span class="op" id="1352467">.</span><span class="ident" id="1352468">l</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352471">r</span>&nbsp;<span class="op" id="1352473">:=</span>&nbsp;<span class="op" id="1352476">&amp;</span><span class="ident" id="1352477">PipeReader</span><span class="op" id="1352487">{</span><span class="ident" id="1352488">p</span><span class="op" id="1352489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1352492">w</span>&nbsp;<span class="op" id="1352494">:=</span>&nbsp;<span class="op" id="1352497">&amp;</span><span class="ident" id="1352498">PipeWriter</span><span class="op" id="1352508">{</span><span class="ident" id="1352509">p</span><span class="op" id="1352510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1352513">return</span>&nbsp;<span class="ident" id="1352520">r</span><span class="op" id="1352521">,</span>&nbsp;<span class="ident" id="1352523">w</span><br>
<span class="lineno"></span><span class="op" id="1352525">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
