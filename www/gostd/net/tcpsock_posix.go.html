<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html" class="current">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4009640">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4009696">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4009750">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4009801">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4009879">package</span>&nbsp;<span class="ident" id="4009887">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4009892">import</span>&nbsp;<span class="op" id="4009899">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4009902">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4009908">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4009914">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4009925">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4009932">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="4009935">//&nbsp;BUG(rsc):&nbsp;On&nbsp;OpenBSD,&nbsp;listening&nbsp;on&nbsp;the&nbsp;&#34;tcp&#34;&nbsp;network&nbsp;does&nbsp;not&nbsp;listen&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4010011">//&nbsp;both&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;connections.&nbsp;This&nbsp;is&nbsp;due&nbsp;to&nbsp;the&nbsp;fact&nbsp;that&nbsp;IPv4&nbsp;traffic</span><br>
<span class="lineno"></span><span class="comment" id="4010088">//&nbsp;will&nbsp;not&nbsp;be&nbsp;routed&nbsp;to&nbsp;an&nbsp;IPv6&nbsp;socket&nbsp;-&nbsp;two&nbsp;separate&nbsp;sockets&nbsp;are&nbsp;required</span><br>
<span class="lineno"></span><span class="comment" id="4010164">//&nbsp;if&nbsp;both&nbsp;AFs&nbsp;are&nbsp;to&nbsp;be&nbsp;supported.&nbsp;See&nbsp;inet6(4)&nbsp;on&nbsp;OpenBSD&nbsp;for&nbsp;details.</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4010238">func</span>&nbsp;<span class="ident" id="4010243">sockaddrToTCP</span><span class="op" id="4010256">(</span><span class="ident" id="4010257">sa</span>&nbsp;<span class="ident" id="4010260">syscall</span><span class="op" id="4010267">.</span><span class="ident" id="4010268">Sockaddr</span><span class="op" id="4010276">)</span>&nbsp;<span class="ident" id="4010278">Addr</span>&nbsp;<span class="op" id="4010283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010286">switch</span>&nbsp;<span class="ident" id="4010293">sa</span>&nbsp;<span class="op" id="4010296">:=</span>&nbsp;<span class="ident" id="4010299">sa</span><span class="op" id="4010301">.</span><span class="op" id="4010302">(</span><span class="keyword" id="4010303">type</span><span class="op" id="4010307">)</span>&nbsp;<span class="op" id="4010309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010312">case</span>&nbsp;<span class="op" id="4010317">*</span><span class="ident" id="4010318">syscall</span><span class="op" id="4010325">.</span><span class="ident" id="4010326">SockaddrInet4</span><span class="op" id="4010339">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010343">return</span>&nbsp;<span class="op" id="4010350">&amp;</span><span class="ident" id="4010351">TCPAddr</span><span class="op" id="4010358">{</span><span class="ident" id="4010359">IP</span><span class="op" id="4010361">:</span>&nbsp;<span class="ident" id="4010363">sa</span><span class="op" id="4010365">.</span><span class="ident" id="4010366">Addr</span><span class="op" id="4010370">[</span><span class="num" id="4010371">0</span><span class="op" id="4010372">:</span><span class="op" id="4010373">]</span><span class="op" id="4010374">,</span>&nbsp;<span class="ident" id="4010376">Port</span><span class="op" id="4010380">:</span>&nbsp;<span class="ident" id="4010382">sa</span><span class="op" id="4010384">.</span><span class="ident" id="4010385">Port</span><span class="op" id="4010389">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010392">case</span>&nbsp;<span class="op" id="4010397">*</span><span class="ident" id="4010398">syscall</span><span class="op" id="4010405">.</span><span class="ident" id="4010406">SockaddrInet6</span><span class="op" id="4010419">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010423">return</span>&nbsp;<span class="op" id="4010430">&amp;</span><span class="ident" id="4010431">TCPAddr</span><span class="op" id="4010438">{</span><span class="ident" id="4010439">IP</span><span class="op" id="4010441">:</span>&nbsp;<span class="ident" id="4010443">sa</span><span class="op" id="4010445">.</span><span class="ident" id="4010446">Addr</span><span class="op" id="4010450">[</span><span class="num" id="4010451">0</span><span class="op" id="4010452">:</span><span class="op" id="4010453">]</span><span class="op" id="4010454">,</span>&nbsp;<span class="ident" id="4010456">Port</span><span class="op" id="4010460">:</span>&nbsp;<span class="ident" id="4010462">sa</span><span class="op" id="4010464">.</span><span class="ident" id="4010465">Port</span><span class="op" id="4010469">,</span>&nbsp;<span class="ident" id="4010471">Zone</span><span class="op" id="4010475">:</span>&nbsp;<span class="ident" id="4010477">zoneToString</span><span class="op" id="4010489">(</span><span class="builtintype" id="4010490">int</span><span class="op" id="4010493">(</span><span class="ident" id="4010494">sa</span><span class="op" id="4010496">.</span><span class="ident" id="4010497">ZoneId</span><span class="op" id="4010503">)</span><span class="op" id="4010504">)</span><span class="op" id="4010505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4010508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010511">return</span>&nbsp;<span class="builtintype" id="4010518">nil</span><br>
<span class="lineno"></span><span class="op" id="4010522">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="4010525">func</span>&nbsp;<span class="op" id="4010530">(</span><span class="ident" id="4010531">a</span>&nbsp;<span class="op" id="4010533">*</span><span class="ident" id="4010534">TCPAddr</span><span class="op" id="4010541">)</span>&nbsp;<span class="ident" id="4010543">family</span><span class="op" id="4010549">(</span><span class="op" id="4010550">)</span>&nbsp;<span class="builtintype" id="4010552">int</span>&nbsp;<span class="op" id="4010556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010559">if</span>&nbsp;<span class="ident" id="4010562">a</span>&nbsp;<span class="op" id="4010564">==</span>&nbsp;<span class="builtintype" id="4010567">nil</span>&nbsp;<span class="op" id="4010571">||</span>&nbsp;<span class="builtinfunc" id="4010574">len</span><span class="op" id="4010577">(</span><span class="ident" id="4010578">a</span><span class="op" id="4010579">.</span><span class="ident" id="4010580">IP</span><span class="op" id="4010582">)</span>&nbsp;<span class="op" id="4010584">&lt;=</span>&nbsp;<span class="ident" id="4010587">IPv4len</span>&nbsp;<span class="op" id="4010595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010599">return</span>&nbsp;<span class="ident" id="4010606">syscall</span><span class="op" id="4010613">.</span><span class="ident" id="4010614">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4010623">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010626">if</span>&nbsp;<span class="ident" id="4010629">a</span><span class="op" id="4010630">.</span><span class="ident" id="4010631">IP</span><span class="op" id="4010633">.</span><span class="ident" id="4010634">To4</span><span class="op" id="4010637">(</span><span class="op" id="4010638">)</span>&nbsp;<span class="op" id="4010640">!=</span>&nbsp;<span class="builtintype" id="4010643">nil</span>&nbsp;<span class="op" id="4010647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010651">return</span>&nbsp;<span class="ident" id="4010658">syscall</span><span class="op" id="4010665">.</span><span class="ident" id="4010666">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4010675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010678">return</span>&nbsp;<span class="ident" id="4010685">syscall</span><span class="op" id="4010692">.</span><span class="ident" id="4010693">AF_INET6</span><br>
<span class="lineno"></span><span class="op" id="4010702">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="4010705">func</span>&nbsp;<span class="op" id="4010710">(</span><span class="ident" id="4010711">a</span>&nbsp;<span class="op" id="4010713">*</span><span class="ident" id="4010714">TCPAddr</span><span class="op" id="4010721">)</span>&nbsp;<span class="ident" id="4010723">isWildcard</span><span class="op" id="4010733">(</span><span class="op" id="4010734">)</span>&nbsp;<span class="builtintype" id="4010736">bool</span>&nbsp;<span class="op" id="4010741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010744">if</span>&nbsp;<span class="ident" id="4010747">a</span>&nbsp;<span class="op" id="4010749">==</span>&nbsp;<span class="builtintype" id="4010752">nil</span>&nbsp;<span class="op" id="4010756">||</span>&nbsp;<span class="ident" id="4010759">a</span><span class="op" id="4010760">.</span><span class="ident" id="4010761">IP</span>&nbsp;<span class="op" id="4010764">==</span>&nbsp;<span class="builtintype" id="4010767">nil</span>&nbsp;<span class="op" id="4010771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010775">return</span>&nbsp;<span class="builtintype" id="4010782">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4010788">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010791">return</span>&nbsp;<span class="ident" id="4010798">a</span><span class="op" id="4010799">.</span><span class="ident" id="4010800">IP</span><span class="op" id="4010802">.</span><span class="ident" id="4010803">IsUnspecified</span><span class="op" id="4010816">(</span><span class="op" id="4010817">)</span><br>
<span class="lineno"></span><span class="op" id="4010819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4010822">func</span>&nbsp;<span class="op" id="4010827">(</span><span class="ident" id="4010828">a</span>&nbsp;<span class="op" id="4010830">*</span><span class="ident" id="4010831">TCPAddr</span><span class="op" id="4010838">)</span>&nbsp;<span class="ident" id="4010840">sockaddr</span><span class="op" id="4010848">(</span><span class="ident" id="4010849">family</span>&nbsp;<span class="builtintype" id="4010856">int</span><span class="op" id="4010859">)</span>&nbsp;<span class="op" id="4010861">(</span><span class="ident" id="4010862">syscall</span><span class="op" id="4010869">.</span><span class="ident" id="4010870">Sockaddr</span><span class="op" id="4010878">,</span>&nbsp;<span class="builtintype" id="4010880">error</span><span class="op" id="4010885">)</span>&nbsp;<span class="op" id="4010887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010890">if</span>&nbsp;<span class="ident" id="4010893">a</span>&nbsp;<span class="op" id="4010895">==</span>&nbsp;<span class="builtintype" id="4010898">nil</span>&nbsp;<span class="op" id="4010902">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010906">return</span>&nbsp;<span class="builtintype" id="4010913">nil</span><span class="op" id="4010916">,</span>&nbsp;<span class="builtintype" id="4010918">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4010923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010926">return</span>&nbsp;<span class="ident" id="4010933">ipToSockaddr</span><span class="op" id="4010945">(</span><span class="ident" id="4010946">family</span><span class="op" id="4010952">,</span>&nbsp;<span class="ident" id="4010954">a</span><span class="op" id="4010955">.</span><span class="ident" id="4010956">IP</span><span class="op" id="4010958">,</span>&nbsp;<span class="ident" id="4010960">a</span><span class="op" id="4010961">.</span><span class="ident" id="4010962">Port</span><span class="op" id="4010966">,</span>&nbsp;<span class="ident" id="4010968">a</span><span class="op" id="4010969">.</span><span class="ident" id="4010970">Zone</span><span class="op" id="4010974">)</span><br>
<span class="lineno"></span><span class="op" id="4010976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="4010979">//&nbsp;TCPConn&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Conn&nbsp;interface&nbsp;for&nbsp;TCP&nbsp;network</span><br>
<span class="lineno"></span><span class="comment" id="4011049">//&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="4011065">type</span>&nbsp;<span class="ident" id="4011070">TCPConn</span>&nbsp;<span class="keyword" id="4011078">struct</span>&nbsp;<span class="op" id="4011085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4011088">conn</span><br>
<span class="lineno"></span><span class="op" id="4011093">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="4011096">func</span>&nbsp;<span class="ident" id="4011101">newTCPConn</span><span class="op" id="4011111">(</span><span class="ident" id="4011112">fd</span>&nbsp;<span class="op" id="4011115">*</span><span class="ident" id="4011116">netFD</span><span class="op" id="4011121">)</span>&nbsp;<span class="op" id="4011123">*</span><span class="ident" id="4011124">TCPConn</span>&nbsp;<span class="op" id="4011132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4011135">c</span>&nbsp;<span class="op" id="4011137">:=</span>&nbsp;<span class="op" id="4011140">&amp;</span><span class="ident" id="4011141">TCPConn</span><span class="op" id="4011148">{</span><span class="ident" id="4011149">conn</span><span class="op" id="4011153">{</span><span class="ident" id="4011154">fd</span><span class="op" id="4011156">}</span><span class="op" id="4011157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4011160">c</span><span class="op" id="4011161">.</span><span class="ident" id="4011162">SetNoDelay</span><span class="op" id="4011172">(</span><span class="builtintype" id="4011173">true</span><span class="op" id="4011177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4011180">return</span>&nbsp;<span class="ident" id="4011187">c</span><br>
<span class="lineno">65</span><span class="op" id="4011189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4011192">//&nbsp;ReadFrom&nbsp;implements&nbsp;the&nbsp;io.ReaderFrom&nbsp;ReadFrom&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="4011250">func</span>&nbsp;<span class="op" id="4011255">(</span><span class="ident" id="4011256">c</span>&nbsp;<span class="op" id="4011258">*</span><span class="ident" id="4011259">TCPConn</span><span class="op" id="4011266">)</span>&nbsp;<span class="ident" id="4011268">ReadFrom</span><span class="op" id="4011276">(</span><span class="ident" id="4011277">r</span>&nbsp;<span class="ident" id="4011279">io</span><span class="op" id="4011281">.</span><span class="ident" id="4011282">Reader</span><span class="op" id="4011288">)</span>&nbsp;<span class="op" id="4011290">(</span><span class="ident" id="4011291">int64</span><span class="op" id="4011296">,</span>&nbsp;<span class="builtintype" id="4011298">error</span><span class="op" id="4011303">)</span>&nbsp;<span class="op" id="4011305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4011308">if</span>&nbsp;<span class="ident" id="4011311">n</span><span class="op" id="4011312">,</span>&nbsp;<span class="ident" id="4011314">err</span><span class="op" id="4011317">,</span>&nbsp;<span class="ident" id="4011319">handled</span>&nbsp;<span class="op" id="4011327">:=</span>&nbsp;<span class="ident" id="4011330">sendFile</span><span class="op" id="4011338">(</span><span class="ident" id="4011339">c</span><span class="op" id="4011340">.</span><span class="ident" id="4011341">fd</span><span class="op" id="4011343">,</span>&nbsp;<span class="ident" id="4011345">r</span><span class="op" id="4011346">)</span><span class="op" id="4011347">;</span>&nbsp;<span class="ident" id="4011349">handled</span>&nbsp;<span class="op" id="4011357">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4011361">return</span>&nbsp;<span class="ident" id="4011368">n</span><span class="op" id="4011369">,</span>&nbsp;<span class="ident" id="4011371">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4011376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4011379">return</span>&nbsp;<span class="ident" id="4011386">genericReadFrom</span><span class="op" id="4011401">(</span><span class="ident" id="4011402">c</span><span class="op" id="4011403">,</span>&nbsp;<span class="ident" id="4011405">r</span><span class="op" id="4011406">)</span><br>
<span class="lineno"></span><span class="op" id="4011408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="4011411">//&nbsp;CloseRead&nbsp;shuts&nbsp;down&nbsp;the&nbsp;reading&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4011475">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="4011514">func</span>&nbsp;<span class="op" id="4011519">(</span><span class="ident" id="4011520">c</span>&nbsp;<span class="op" id="4011522">*</span><span class="ident" id="4011523">TCPConn</span><span class="op" id="4011530">)</span>&nbsp;<span class="ident" id="4011532">CloseRead</span><span class="op" id="4011541">(</span><span class="op" id="4011542">)</span>&nbsp;<span class="builtintype" id="4011544">error</span>&nbsp;<span class="op" id="4011550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4011553">if</span>&nbsp;<span class="op" id="4011556">!</span><span class="ident" id="4011557">c</span><span class="op" id="4011558">.</span><span class="ident" id="4011559">ok</span><span class="op" id="4011561">(</span><span class="op" id="4011562">)</span>&nbsp;<span class="op" id="4011564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4011568">return</span>&nbsp;<span class="ident" id="4011575">syscall</span><span class="op" id="4011582">.</span><span class="ident" id="4011583">EINVAL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4011591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4011594">return</span>&nbsp;<span class="ident" id="4011601">c</span><span class="op" id="4011602">.</span><span class="ident" id="4011603">fd</span><span class="op" id="4011605">.</span><span class="ident" id="4011606">closeRead</span><span class="op" id="4011615">(</span><span class="op" id="4011616">)</span><br>
<span class="lineno"></span><span class="op" id="4011618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4011621">//&nbsp;CloseWrite&nbsp;shuts&nbsp;down&nbsp;the&nbsp;writing&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno">85</span><span class="comment" id="4011686">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="4011725">func</span>&nbsp;<span class="op" id="4011730">(</span><span class="ident" id="4011731">c</span>&nbsp;<span class="op" id="4011733">*</span><span class="ident" id="4011734">TCPConn</span><span class="op" id="4011741">)</span>&nbsp;<span class="ident" id="4011743">CloseWrite</span><span class="op" id="4011753">(</span><span class="op" id="4011754">)</span>&nbsp;<span class="builtintype" id="4011756">error</span>&nbsp;<span class="op" id="4011762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4011765">if</span>&nbsp;<span class="op" id="4011768">!</span><span class="ident" id="4011769">c</span><span class="op" id="4011770">.</span><span class="ident" id="4011771">ok</span><span class="op" id="4011773">(</span><span class="op" id="4011774">)</span>&nbsp;<span class="op" id="4011776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4011780">return</span>&nbsp;<span class="ident" id="4011787">syscall</span><span class="op" id="4011794">.</span><span class="ident" id="4011795">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4011803">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4011806">return</span>&nbsp;<span class="ident" id="4011813">c</span><span class="op" id="4011814">.</span><span class="ident" id="4011815">fd</span><span class="op" id="4011817">.</span><span class="ident" id="4011818">closeWrite</span><span class="op" id="4011828">(</span><span class="op" id="4011829">)</span><br>
<span class="lineno"></span><span class="op" id="4011831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4011834">//&nbsp;SetLinger&nbsp;sets&nbsp;the&nbsp;behavior&nbsp;of&nbsp;Close&nbsp;on&nbsp;a&nbsp;connection&nbsp;which&nbsp;still</span><br>
<span class="lineno"></span><span class="comment" id="4011902">//&nbsp;has&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;sent&nbsp;or&nbsp;to&nbsp;be&nbsp;acknowledged.</span><br>
<span class="lineno">95</span><span class="comment" id="4011956">//</span><br>
<span class="lineno"></span><span class="comment" id="4011959">//&nbsp;If&nbsp;sec&nbsp;&lt;&nbsp;0&nbsp;(the&nbsp;default),&nbsp;the&nbsp;operating&nbsp;system&nbsp;finishes&nbsp;sending&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4012030">//&nbsp;data&nbsp;in&nbsp;the&nbsp;background.</span><br>
<span class="lineno"></span><span class="comment" id="4012057">//</span><br>
<span class="lineno"></span><span class="comment" id="4012060">//&nbsp;If&nbsp;sec&nbsp;==&nbsp;0,&nbsp;the&nbsp;operating&nbsp;system&nbsp;discards&nbsp;any&nbsp;unsent&nbsp;or</span><br>
<span class="lineno">100</span><span class="comment" id="4012120">//&nbsp;unacknowledged&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="4012144">//</span><br>
<span class="lineno"></span><span class="comment" id="4012147">//&nbsp;If&nbsp;sec&nbsp;&gt;&nbsp;0,&nbsp;the&nbsp;data&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;background&nbsp;as&nbsp;with&nbsp;sec&nbsp;&lt;&nbsp;0.&nbsp;On</span><br>
<span class="lineno"></span><span class="comment" id="4012217">//&nbsp;some&nbsp;operating&nbsp;systems&nbsp;after&nbsp;sec&nbsp;seconds&nbsp;have&nbsp;elapsed&nbsp;any&nbsp;remaining</span><br>
<span class="lineno"></span><span class="comment" id="4012288">//&nbsp;unsent&nbsp;data&nbsp;may&nbsp;be&nbsp;discarded.</span><br>
<span class="lineno">105</span><span class="keyword" id="4012321">func</span>&nbsp;<span class="op" id="4012326">(</span><span class="ident" id="4012327">c</span>&nbsp;<span class="op" id="4012329">*</span><span class="ident" id="4012330">TCPConn</span><span class="op" id="4012337">)</span>&nbsp;<span class="ident" id="4012339">SetLinger</span><span class="op" id="4012348">(</span><span class="ident" id="4012349">sec</span>&nbsp;<span class="builtintype" id="4012353">int</span><span class="op" id="4012356">)</span>&nbsp;<span class="builtintype" id="4012358">error</span>&nbsp;<span class="op" id="4012364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4012367">if</span>&nbsp;<span class="op" id="4012370">!</span><span class="ident" id="4012371">c</span><span class="op" id="4012372">.</span><span class="ident" id="4012373">ok</span><span class="op" id="4012375">(</span><span class="op" id="4012376">)</span>&nbsp;<span class="op" id="4012378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4012382">return</span>&nbsp;<span class="ident" id="4012389">syscall</span><span class="op" id="4012396">.</span><span class="ident" id="4012397">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4012405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4012408">return</span>&nbsp;<span class="ident" id="4012415">setLinger</span><span class="op" id="4012424">(</span><span class="ident" id="4012425">c</span><span class="op" id="4012426">.</span><span class="ident" id="4012427">fd</span><span class="op" id="4012429">,</span>&nbsp;<span class="ident" id="4012431">sec</span><span class="op" id="4012434">)</span><br>
<span class="lineno">110</span><span class="op" id="4012436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4012439">//&nbsp;SetKeepAlive&nbsp;sets&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;send</span><br>
<span class="lineno"></span><span class="comment" id="4012501">//&nbsp;keepalive&nbsp;messages&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4012542">func</span>&nbsp;<span class="op" id="4012547">(</span><span class="ident" id="4012548">c</span>&nbsp;<span class="op" id="4012550">*</span><span class="ident" id="4012551">TCPConn</span><span class="op" id="4012558">)</span>&nbsp;<span class="ident" id="4012560">SetKeepAlive</span><span class="op" id="4012572">(</span><span class="ident" id="4012573">keepalive</span>&nbsp;<span class="builtintype" id="4012583">bool</span><span class="op" id="4012587">)</span>&nbsp;<span class="builtintype" id="4012589">error</span>&nbsp;<span class="op" id="4012595">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4012598">if</span>&nbsp;<span class="op" id="4012601">!</span><span class="ident" id="4012602">c</span><span class="op" id="4012603">.</span><span class="ident" id="4012604">ok</span><span class="op" id="4012606">(</span><span class="op" id="4012607">)</span>&nbsp;<span class="op" id="4012609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4012613">return</span>&nbsp;<span class="ident" id="4012620">syscall</span><span class="op" id="4012627">.</span><span class="ident" id="4012628">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4012636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4012639">return</span>&nbsp;<span class="ident" id="4012646">setKeepAlive</span><span class="op" id="4012658">(</span><span class="ident" id="4012659">c</span><span class="op" id="4012660">.</span><span class="ident" id="4012661">fd</span><span class="op" id="4012663">,</span>&nbsp;<span class="ident" id="4012665">keepalive</span><span class="op" id="4012674">)</span><br>
<span class="lineno"></span><span class="op" id="4012676">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="4012679">//&nbsp;SetKeepAlivePeriod&nbsp;sets&nbsp;period&nbsp;between&nbsp;keep&nbsp;alives.</span><br>
<span class="lineno"></span><span class="keyword" id="4012734">func</span>&nbsp;<span class="op" id="4012739">(</span><span class="ident" id="4012740">c</span>&nbsp;<span class="op" id="4012742">*</span><span class="ident" id="4012743">TCPConn</span><span class="op" id="4012750">)</span>&nbsp;<span class="ident" id="4012752">SetKeepAlivePeriod</span><span class="op" id="4012770">(</span><span class="ident" id="4012771">d</span>&nbsp;<span class="ident" id="4012773">time</span><span class="op" id="4012777">.</span><span class="ident" id="4012778">Duration</span><span class="op" id="4012786">)</span>&nbsp;<span class="builtintype" id="4012788">error</span>&nbsp;<span class="op" id="4012794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4012797">if</span>&nbsp;<span class="op" id="4012800">!</span><span class="ident" id="4012801">c</span><span class="op" id="4012802">.</span><span class="ident" id="4012803">ok</span><span class="op" id="4012805">(</span><span class="op" id="4012806">)</span>&nbsp;<span class="op" id="4012808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4012812">return</span>&nbsp;<span class="ident" id="4012819">syscall</span><span class="op" id="4012826">.</span><span class="ident" id="4012827">EINVAL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4012835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4012838">return</span>&nbsp;<span class="ident" id="4012845">setKeepAlivePeriod</span><span class="op" id="4012863">(</span><span class="ident" id="4012864">c</span><span class="op" id="4012865">.</span><span class="ident" id="4012866">fd</span><span class="op" id="4012868">,</span>&nbsp;<span class="ident" id="4012870">d</span><span class="op" id="4012871">)</span><br>
<span class="lineno"></span><span class="op" id="4012873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4012876">//&nbsp;SetNoDelay&nbsp;controls&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;delay</span><br>
<span class="lineno">130</span><span class="comment" id="4012941">//&nbsp;packet&nbsp;transmission&nbsp;in&nbsp;hopes&nbsp;of&nbsp;sending&nbsp;fewer&nbsp;packets&nbsp;(Nagle&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4013007">//&nbsp;algorithm).&nbsp;&nbsp;The&nbsp;default&nbsp;is&nbsp;true&nbsp;(no&nbsp;delay),&nbsp;meaning&nbsp;that&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4013076">//&nbsp;sent&nbsp;as&nbsp;soon&nbsp;as&nbsp;possible&nbsp;after&nbsp;a&nbsp;Write.</span><br>
<span class="lineno"></span><span class="keyword" id="4013119">func</span>&nbsp;<span class="op" id="4013124">(</span><span class="ident" id="4013125">c</span>&nbsp;<span class="op" id="4013127">*</span><span class="ident" id="4013128">TCPConn</span><span class="op" id="4013135">)</span>&nbsp;<span class="ident" id="4013137">SetNoDelay</span><span class="op" id="4013147">(</span><span class="ident" id="4013148">noDelay</span>&nbsp;<span class="builtintype" id="4013156">bool</span><span class="op" id="4013160">)</span>&nbsp;<span class="builtintype" id="4013162">error</span>&nbsp;<span class="op" id="4013168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4013171">if</span>&nbsp;<span class="op" id="4013174">!</span><span class="ident" id="4013175">c</span><span class="op" id="4013176">.</span><span class="ident" id="4013177">ok</span><span class="op" id="4013179">(</span><span class="op" id="4013180">)</span>&nbsp;<span class="op" id="4013182">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4013186">return</span>&nbsp;<span class="ident" id="4013193">syscall</span><span class="op" id="4013200">.</span><span class="ident" id="4013201">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4013209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4013212">return</span>&nbsp;<span class="ident" id="4013219">setNoDelay</span><span class="op" id="4013229">(</span><span class="ident" id="4013230">c</span><span class="op" id="4013231">.</span><span class="ident" id="4013232">fd</span><span class="op" id="4013234">,</span>&nbsp;<span class="ident" id="4013236">noDelay</span><span class="op" id="4013243">)</span><br>
<span class="lineno"></span><span class="op" id="4013245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="4013248">//&nbsp;DialTCP&nbsp;connects&nbsp;to&nbsp;the&nbsp;remote&nbsp;address&nbsp;raddr&nbsp;on&nbsp;the&nbsp;network&nbsp;net,</span><br>
<span class="lineno"></span><span class="comment" id="4013316">//&nbsp;which&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;is&nbsp;not&nbsp;nil,&nbsp;it&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4013387">//&nbsp;used&nbsp;as&nbsp;the&nbsp;local&nbsp;address&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4013436">func</span>&nbsp;<span class="ident" id="4013441">DialTCP</span><span class="op" id="4013448">(</span><span class="ident" id="4013449">net</span>&nbsp;<span class="builtintype" id="4013453">string</span><span class="op" id="4013459">,</span>&nbsp;<span class="ident" id="4013461">laddr</span><span class="op" id="4013466">,</span>&nbsp;<span class="ident" id="4013468">raddr</span>&nbsp;<span class="op" id="4013474">*</span><span class="ident" id="4013475">TCPAddr</span><span class="op" id="4013482">)</span>&nbsp;<span class="op" id="4013484">(</span><span class="op" id="4013485">*</span><span class="ident" id="4013486">TCPConn</span><span class="op" id="4013493">,</span>&nbsp;<span class="builtintype" id="4013495">error</span><span class="op" id="4013500">)</span>&nbsp;<span class="op" id="4013502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4013505">switch</span>&nbsp;<span class="ident" id="4013512">net</span>&nbsp;<span class="op" id="4013516">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4013519">case</span>&nbsp;<span class="string" id="4013524">&#34;tcp&#34;</span><span class="op" id="4013529">,</span>&nbsp;<span class="string" id="4013531">&#34;tcp4&#34;</span><span class="op" id="4013537">,</span>&nbsp;<span class="string" id="4013539">&#34;tcp6&#34;</span><span class="op" id="4013545">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4013548">default</span><span class="op" id="4013555">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4013559">return</span>&nbsp;<span class="builtintype" id="4013566">nil</span><span class="op" id="4013569">,</span>&nbsp;<span class="op" id="4013571">&amp;</span><span class="ident" id="4013572">OpError</span><span class="op" id="4013579">{</span><span class="ident" id="4013580">Op</span><span class="op" id="4013582">:</span>&nbsp;<span class="string" id="4013584">&#34;dial&#34;</span><span class="op" id="4013590">,</span>&nbsp;<span class="ident" id="4013592">Net</span><span class="op" id="4013595">:</span>&nbsp;<span class="ident" id="4013597">net</span><span class="op" id="4013600">,</span>&nbsp;<span class="ident" id="4013602">Addr</span><span class="op" id="4013606">:</span>&nbsp;<span class="ident" id="4013608">raddr</span><span class="op" id="4013613">,</span>&nbsp;<span class="ident" id="4013615">Err</span><span class="op" id="4013618">:</span>&nbsp;<span class="ident" id="4013620">UnknownNetworkError</span><span class="op" id="4013639">(</span><span class="ident" id="4013640">net</span><span class="op" id="4013643">)</span><span class="op" id="4013644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4013647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4013650">if</span>&nbsp;<span class="ident" id="4013653">raddr</span>&nbsp;<span class="op" id="4013659">==</span>&nbsp;<span class="builtintype" id="4013662">nil</span>&nbsp;<span class="op" id="4013666">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4013670">return</span>&nbsp;<span class="builtintype" id="4013677">nil</span><span class="op" id="4013680">,</span>&nbsp;<span class="op" id="4013682">&amp;</span><span class="ident" id="4013683">OpError</span><span class="op" id="4013690">{</span><span class="ident" id="4013691">Op</span><span class="op" id="4013693">:</span>&nbsp;<span class="string" id="4013695">&#34;dial&#34;</span><span class="op" id="4013701">,</span>&nbsp;<span class="ident" id="4013703">Net</span><span class="op" id="4013706">:</span>&nbsp;<span class="ident" id="4013708">net</span><span class="op" id="4013711">,</span>&nbsp;<span class="ident" id="4013713">Addr</span><span class="op" id="4013717">:</span>&nbsp;<span class="builtintype" id="4013719">nil</span><span class="op" id="4013722">,</span>&nbsp;<span class="ident" id="4013724">Err</span><span class="op" id="4013727">:</span>&nbsp;<span class="ident" id="4013729">errMissingAddress</span><span class="op" id="4013746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4013749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4013752">return</span>&nbsp;<span class="ident" id="4013759">dialTCP</span><span class="op" id="4013766">(</span><span class="ident" id="4013767">net</span><span class="op" id="4013770">,</span>&nbsp;<span class="ident" id="4013772">laddr</span><span class="op" id="4013777">,</span>&nbsp;<span class="ident" id="4013779">raddr</span><span class="op" id="4013784">,</span>&nbsp;<span class="ident" id="4013786">noDeadline</span><span class="op" id="4013796">)</span><br>
<span class="lineno"></span><span class="op" id="4013798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="keyword" id="4013801">func</span>&nbsp;<span class="ident" id="4013806">dialTCP</span><span class="op" id="4013813">(</span><span class="ident" id="4013814">net</span>&nbsp;<span class="builtintype" id="4013818">string</span><span class="op" id="4013824">,</span>&nbsp;<span class="ident" id="4013826">laddr</span><span class="op" id="4013831">,</span>&nbsp;<span class="ident" id="4013833">raddr</span>&nbsp;<span class="op" id="4013839">*</span><span class="ident" id="4013840">TCPAddr</span><span class="op" id="4013847">,</span>&nbsp;<span class="ident" id="4013849">deadline</span>&nbsp;<span class="ident" id="4013858">time</span><span class="op" id="4013862">.</span><span class="ident" id="4013863">Time</span><span class="op" id="4013867">)</span>&nbsp;<span class="op" id="4013869">(</span><span class="op" id="4013870">*</span><span class="ident" id="4013871">TCPConn</span><span class="op" id="4013878">,</span>&nbsp;<span class="builtintype" id="4013880">error</span><span class="op" id="4013885">)</span>&nbsp;<span class="op" id="4013887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4013890">fd</span><span class="op" id="4013892">,</span>&nbsp;<span class="ident" id="4013894">err</span>&nbsp;<span class="op" id="4013898">:=</span>&nbsp;<span class="ident" id="4013901">internetSocket</span><span class="op" id="4013915">(</span><span class="ident" id="4013916">net</span><span class="op" id="4013919">,</span>&nbsp;<span class="ident" id="4013921">laddr</span><span class="op" id="4013926">,</span>&nbsp;<span class="ident" id="4013928">raddr</span><span class="op" id="4013933">,</span>&nbsp;<span class="ident" id="4013935">deadline</span><span class="op" id="4013943">,</span>&nbsp;<span class="ident" id="4013945">syscall</span><span class="op" id="4013952">.</span><span class="ident" id="4013953">SOCK_STREAM</span><span class="op" id="4013964">,</span>&nbsp;<span class="num" id="4013966">0</span><span class="op" id="4013967">,</span>&nbsp;<span class="string" id="4013969">&#34;dial&#34;</span><span class="op" id="4013975">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4013979">//&nbsp;TCP&nbsp;has&nbsp;a&nbsp;rarely&nbsp;used&nbsp;mechanism&nbsp;called&nbsp;a&nbsp;&#39;simultaneous&nbsp;connection&#39;&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4014053">//&nbsp;which&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr1,&nbsp;addr2)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine&nbsp;at&nbsp;addr1&nbsp;can</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4014121">//&nbsp;connect&nbsp;to&nbsp;a&nbsp;simultaneous&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr2,&nbsp;addr1)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4014196">//&nbsp;at&nbsp;addr2,&nbsp;without&nbsp;either&nbsp;machine&nbsp;executing&nbsp;Listen.&nbsp;&nbsp;If&nbsp;laddr&nbsp;==&nbsp;nil,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4014269">//&nbsp;it&nbsp;means&nbsp;we&nbsp;want&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate&nbsp;originating&nbsp;local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4014342">//&nbsp;address.&nbsp;&nbsp;Some&nbsp;Linux&nbsp;kernels&nbsp;cycle&nbsp;blindly&nbsp;through&nbsp;a&nbsp;fixed&nbsp;range&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4014414">//&nbsp;local&nbsp;ports,&nbsp;regardless&nbsp;of&nbsp;destination&nbsp;port.&nbsp;&nbsp;If&nbsp;a&nbsp;kernel&nbsp;happens&nbsp;to</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4014487">//&nbsp;pick&nbsp;local&nbsp;port&nbsp;50001&nbsp;as&nbsp;the&nbsp;source&nbsp;for&nbsp;a&nbsp;Dial(&#34;tcp&#34;,&nbsp;&#34;&#34;,&nbsp;&#34;localhost:50001&#34;),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4014569">//&nbsp;then&nbsp;the&nbsp;Dial&nbsp;will&nbsp;succeed,&nbsp;having&nbsp;simultaneously&nbsp;connected&nbsp;to&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4014644">//&nbsp;This&nbsp;can&nbsp;only&nbsp;happen&nbsp;when&nbsp;we&nbsp;are&nbsp;letting&nbsp;the&nbsp;kernel&nbsp;pick&nbsp;a&nbsp;port&nbsp;(laddr&nbsp;==&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4014727">//&nbsp;and&nbsp;when&nbsp;there&nbsp;is&nbsp;no&nbsp;listener&nbsp;for&nbsp;the&nbsp;destination&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4014790">//&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;argue&nbsp;this&nbsp;is&nbsp;anything&nbsp;other&nbsp;than&nbsp;a&nbsp;kernel&nbsp;bug.&nbsp;&nbsp;If&nbsp;we</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4014862">//&nbsp;see&nbsp;this&nbsp;happen,&nbsp;rather&nbsp;than&nbsp;expose&nbsp;the&nbsp;buggy&nbsp;effect&nbsp;to&nbsp;users,&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4014932">//&nbsp;close&nbsp;the&nbsp;fd&nbsp;and&nbsp;try&nbsp;again.&nbsp;&nbsp;If&nbsp;it&nbsp;happens&nbsp;twice&nbsp;more,&nbsp;we&nbsp;relent&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4015005">//&nbsp;use&nbsp;the&nbsp;result.&nbsp;&nbsp;See&nbsp;also:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4015036">//&nbsp;&nbsp;&nbsp;&nbsp;http://golang.org/issue/2690</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4015069">//&nbsp;&nbsp;&nbsp;&nbsp;http://stackoverflow.com/questions/4949858/</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4015117">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4015121">//&nbsp;The&nbsp;opposite&nbsp;can&nbsp;also&nbsp;happen:&nbsp;if&nbsp;we&nbsp;ask&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4015199">//&nbsp;originating&nbsp;local&nbsp;address,&nbsp;sometimes&nbsp;it&nbsp;picks&nbsp;one&nbsp;that&nbsp;is&nbsp;already&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4015277">//&nbsp;So&nbsp;if&nbsp;the&nbsp;error&nbsp;is&nbsp;EADDRNOTAVAIL,&nbsp;we&nbsp;have&nbsp;to&nbsp;try&nbsp;again&nbsp;too,&nbsp;just&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4015350">//&nbsp;a&nbsp;different&nbsp;reason.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4015374">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4015378">//&nbsp;The&nbsp;kernel&nbsp;socket&nbsp;code&nbsp;is&nbsp;no&nbsp;doubt&nbsp;enjoying&nbsp;watching&nbsp;us&nbsp;squirm.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4015446">for</span>&nbsp;<span class="ident" id="4015450">i</span>&nbsp;<span class="op" id="4015452">:=</span>&nbsp;<span class="num" id="4015455">0</span><span class="op" id="4015456">;</span>&nbsp;<span class="ident" id="4015458">i</span>&nbsp;<span class="op" id="4015460">&lt;</span>&nbsp;<span class="num" id="4015462">2</span>&nbsp;<span class="op" id="4015464">&amp;&amp;</span>&nbsp;<span class="op" id="4015467">(</span><span class="ident" id="4015468">laddr</span>&nbsp;<span class="op" id="4015474">==</span>&nbsp;<span class="builtintype" id="4015477">nil</span>&nbsp;<span class="op" id="4015481">||</span>&nbsp;<span class="ident" id="4015484">laddr</span><span class="op" id="4015489">.</span><span class="ident" id="4015490">Port</span>&nbsp;<span class="op" id="4015495">==</span>&nbsp;<span class="num" id="4015498">0</span><span class="op" id="4015499">)</span>&nbsp;<span class="op" id="4015501">&amp;&amp;</span>&nbsp;<span class="op" id="4015504">(</span><span class="ident" id="4015505">selfConnect</span><span class="op" id="4015516">(</span><span class="ident" id="4015517">fd</span><span class="op" id="4015519">,</span>&nbsp;<span class="ident" id="4015521">err</span><span class="op" id="4015524">)</span>&nbsp;<span class="op" id="4015526">||</span>&nbsp;<span class="ident" id="4015529">spuriousENOTAVAIL</span><span class="op" id="4015546">(</span><span class="ident" id="4015547">err</span><span class="op" id="4015550">)</span><span class="op" id="4015551">)</span><span class="op" id="4015552">;</span>&nbsp;<span class="ident" id="4015554">i</span><span class="op" id="4015555">++</span>&nbsp;<span class="op" id="4015558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4015562">if</span>&nbsp;<span class="ident" id="4015565">err</span>&nbsp;<span class="op" id="4015569">==</span>&nbsp;<span class="builtintype" id="4015572">nil</span>&nbsp;<span class="op" id="4015576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4015581">fd</span><span class="op" id="4015583">.</span><span class="ident" id="4015584">Close</span><span class="op" id="4015589">(</span><span class="op" id="4015590">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4015594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4015598">fd</span><span class="op" id="4015600">,</span>&nbsp;<span class="ident" id="4015602">err</span>&nbsp;<span class="op" id="4015606">=</span>&nbsp;<span class="ident" id="4015608">internetSocket</span><span class="op" id="4015622">(</span><span class="ident" id="4015623">net</span><span class="op" id="4015626">,</span>&nbsp;<span class="ident" id="4015628">laddr</span><span class="op" id="4015633">,</span>&nbsp;<span class="ident" id="4015635">raddr</span><span class="op" id="4015640">,</span>&nbsp;<span class="ident" id="4015642">deadline</span><span class="op" id="4015650">,</span>&nbsp;<span class="ident" id="4015652">syscall</span><span class="op" id="4015659">.</span><span class="ident" id="4015660">SOCK_STREAM</span><span class="op" id="4015671">,</span>&nbsp;<span class="num" id="4015673">0</span><span class="op" id="4015674">,</span>&nbsp;<span class="string" id="4015676">&#34;dial&#34;</span><span class="op" id="4015682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4015685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4015689">if</span>&nbsp;<span class="ident" id="4015692">err</span>&nbsp;<span class="op" id="4015696">!=</span>&nbsp;<span class="builtintype" id="4015699">nil</span>&nbsp;<span class="op" id="4015703">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4015707">return</span>&nbsp;<span class="builtintype" id="4015714">nil</span><span class="op" id="4015717">,</span>&nbsp;<span class="op" id="4015719">&amp;</span><span class="ident" id="4015720">OpError</span><span class="op" id="4015727">{</span><span class="ident" id="4015728">Op</span><span class="op" id="4015730">:</span>&nbsp;<span class="string" id="4015732">&#34;dial&#34;</span><span class="op" id="4015738">,</span>&nbsp;<span class="ident" id="4015740">Net</span><span class="op" id="4015743">:</span>&nbsp;<span class="ident" id="4015745">net</span><span class="op" id="4015748">,</span>&nbsp;<span class="ident" id="4015750">Addr</span><span class="op" id="4015754">:</span>&nbsp;<span class="ident" id="4015756">raddr</span><span class="op" id="4015761">,</span>&nbsp;<span class="ident" id="4015763">Err</span><span class="op" id="4015766">:</span>&nbsp;<span class="ident" id="4015768">err</span><span class="op" id="4015771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4015774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4015777">return</span>&nbsp;<span class="ident" id="4015784">newTCPConn</span><span class="op" id="4015794">(</span><span class="ident" id="4015795">fd</span><span class="op" id="4015797">)</span><span class="op" id="4015798">,</span>&nbsp;<span class="builtintype" id="4015800">nil</span><br>
<span class="lineno"></span><span class="op" id="4015804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="4015807">func</span>&nbsp;<span class="ident" id="4015812">selfConnect</span><span class="op" id="4015823">(</span><span class="ident" id="4015824">fd</span>&nbsp;<span class="op" id="4015827">*</span><span class="ident" id="4015828">netFD</span><span class="op" id="4015833">,</span>&nbsp;<span class="ident" id="4015835">err</span>&nbsp;<span class="builtintype" id="4015839">error</span><span class="op" id="4015844">)</span>&nbsp;<span class="builtintype" id="4015846">bool</span>&nbsp;<span class="op" id="4015851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4015854">//&nbsp;If&nbsp;the&nbsp;connect&nbsp;failed,&nbsp;we&nbsp;clearly&nbsp;didn&#39;t&nbsp;connect&nbsp;to&nbsp;ourselves.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4015921">if</span>&nbsp;<span class="ident" id="4015924">err</span>&nbsp;<span class="op" id="4015928">!=</span>&nbsp;<span class="builtintype" id="4015931">nil</span>&nbsp;<span class="op" id="4015935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4015939">return</span>&nbsp;<span class="builtintype" id="4015946">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4015953">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4015957">//&nbsp;The&nbsp;socket&nbsp;constructor&nbsp;can&nbsp;return&nbsp;an&nbsp;fd&nbsp;with&nbsp;raddr&nbsp;nil&nbsp;under&nbsp;certain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4016030">//&nbsp;unknown&nbsp;conditions.&nbsp;The&nbsp;errors&nbsp;in&nbsp;the&nbsp;calls&nbsp;there&nbsp;to&nbsp;Getpeername</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4016099">//&nbsp;are&nbsp;discarded,&nbsp;but&nbsp;we&nbsp;can&#39;t&nbsp;catch&nbsp;the&nbsp;problem&nbsp;there&nbsp;because&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4016169">//&nbsp;calls&nbsp;are&nbsp;sometimes&nbsp;legally&nbsp;erroneous&nbsp;with&nbsp;a&nbsp;&#34;socket&nbsp;not&nbsp;connected&#34;.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4016242">//&nbsp;Since&nbsp;this&nbsp;code&nbsp;(selfConnect)&nbsp;is&nbsp;already&nbsp;trying&nbsp;to&nbsp;work&nbsp;around</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4016309">//&nbsp;a&nbsp;problem,&nbsp;we&nbsp;make&nbsp;sure&nbsp;if&nbsp;this&nbsp;happens&nbsp;we&nbsp;recognize&nbsp;trouble&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4016378">//&nbsp;ask&nbsp;the&nbsp;DialTCP&nbsp;routine&nbsp;to&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4016420">//&nbsp;TODO:&nbsp;try&nbsp;to&nbsp;understand&nbsp;what&#39;s&nbsp;really&nbsp;going&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4016472">if</span>&nbsp;<span class="ident" id="4016475">fd</span><span class="op" id="4016477">.</span><span class="ident" id="4016478">laddr</span>&nbsp;<span class="op" id="4016484">==</span>&nbsp;<span class="builtintype" id="4016487">nil</span>&nbsp;<span class="op" id="4016491">||</span>&nbsp;<span class="ident" id="4016494">fd</span><span class="op" id="4016496">.</span><span class="ident" id="4016497">raddr</span>&nbsp;<span class="op" id="4016503">==</span>&nbsp;<span class="builtintype" id="4016506">nil</span>&nbsp;<span class="op" id="4016510">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4016514">return</span>&nbsp;<span class="builtintype" id="4016521">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4016527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4016530">l</span>&nbsp;<span class="op" id="4016532">:=</span>&nbsp;<span class="ident" id="4016535">fd</span><span class="op" id="4016537">.</span><span class="ident" id="4016538">laddr</span><span class="op" id="4016543">.</span><span class="op" id="4016544">(</span><span class="op" id="4016545">*</span><span class="ident" id="4016546">TCPAddr</span><span class="op" id="4016553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4016556">r</span>&nbsp;<span class="op" id="4016558">:=</span>&nbsp;<span class="ident" id="4016561">fd</span><span class="op" id="4016563">.</span><span class="ident" id="4016564">raddr</span><span class="op" id="4016569">.</span><span class="op" id="4016570">(</span><span class="op" id="4016571">*</span><span class="ident" id="4016572">TCPAddr</span><span class="op" id="4016579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4016582">return</span>&nbsp;<span class="ident" id="4016589">l</span><span class="op" id="4016590">.</span><span class="ident" id="4016591">Port</span>&nbsp;<span class="op" id="4016596">==</span>&nbsp;<span class="ident" id="4016599">r</span><span class="op" id="4016600">.</span><span class="ident" id="4016601">Port</span>&nbsp;<span class="op" id="4016606">&amp;&amp;</span>&nbsp;<span class="ident" id="4016609">l</span><span class="op" id="4016610">.</span><span class="ident" id="4016611">IP</span><span class="op" id="4016613">.</span><span class="ident" id="4016614">Equal</span><span class="op" id="4016619">(</span><span class="ident" id="4016620">r</span><span class="op" id="4016621">.</span><span class="ident" id="4016622">IP</span><span class="op" id="4016624">)</span><br>
<span class="lineno">215</span><span class="op" id="4016626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4016629">func</span>&nbsp;<span class="ident" id="4016634">spuriousENOTAVAIL</span><span class="op" id="4016651">(</span><span class="ident" id="4016652">err</span>&nbsp;<span class="builtintype" id="4016656">error</span><span class="op" id="4016661">)</span>&nbsp;<span class="builtintype" id="4016663">bool</span>&nbsp;<span class="op" id="4016668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4016671">e</span><span class="op" id="4016672">,</span>&nbsp;<span class="ident" id="4016674">ok</span>&nbsp;<span class="op" id="4016677">:=</span>&nbsp;<span class="ident" id="4016680">err</span><span class="op" id="4016683">.</span><span class="op" id="4016684">(</span><span class="op" id="4016685">*</span><span class="ident" id="4016686">OpError</span><span class="op" id="4016693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4016696">return</span>&nbsp;<span class="ident" id="4016703">ok</span>&nbsp;<span class="op" id="4016706">&amp;&amp;</span>&nbsp;<span class="ident" id="4016709">e</span><span class="op" id="4016710">.</span><span class="ident" id="4016711">Err</span>&nbsp;<span class="op" id="4016715">==</span>&nbsp;<span class="ident" id="4016718">syscall</span><span class="op" id="4016725">.</span><span class="ident" id="4016726">EADDRNOTAVAIL</span><br>
<span class="lineno">220</span><span class="op" id="4016740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4016743">//&nbsp;TCPListener&nbsp;is&nbsp;a&nbsp;TCP&nbsp;network&nbsp;listener.&nbsp;&nbsp;Clients&nbsp;should&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="4016811">//&nbsp;use&nbsp;variables&nbsp;of&nbsp;type&nbsp;Listener&nbsp;instead&nbsp;of&nbsp;assuming&nbsp;TCP.</span><br>
<span class="lineno"></span><span class="keyword" id="4016870">type</span>&nbsp;<span class="ident" id="4016875">TCPListener</span>&nbsp;<span class="keyword" id="4016887">struct</span>&nbsp;<span class="op" id="4016894">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4016897">fd</span>&nbsp;<span class="op" id="4016900">*</span><span class="ident" id="4016901">netFD</span><br>
<span class="lineno"></span><span class="op" id="4016907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4016910">//&nbsp;AcceptTCP&nbsp;accepts&nbsp;the&nbsp;next&nbsp;incoming&nbsp;call&nbsp;and&nbsp;returns&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="4016974">//&nbsp;connection.</span><br>
<span class="lineno">230</span><span class="keyword" id="4016989">func</span>&nbsp;<span class="op" id="4016994">(</span><span class="ident" id="4016995">l</span>&nbsp;<span class="op" id="4016997">*</span><span class="ident" id="4016998">TCPListener</span><span class="op" id="4017009">)</span>&nbsp;<span class="ident" id="4017011">AcceptTCP</span><span class="op" id="4017020">(</span><span class="op" id="4017021">)</span>&nbsp;<span class="op" id="4017023">(</span><span class="op" id="4017024">*</span><span class="ident" id="4017025">TCPConn</span><span class="op" id="4017032">,</span>&nbsp;<span class="builtintype" id="4017034">error</span><span class="op" id="4017039">)</span>&nbsp;<span class="op" id="4017041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4017044">if</span>&nbsp;<span class="ident" id="4017047">l</span>&nbsp;<span class="op" id="4017049">==</span>&nbsp;<span class="builtintype" id="4017052">nil</span>&nbsp;<span class="op" id="4017056">||</span>&nbsp;<span class="ident" id="4017059">l</span><span class="op" id="4017060">.</span><span class="ident" id="4017061">fd</span>&nbsp;<span class="op" id="4017064">==</span>&nbsp;<span class="builtintype" id="4017067">nil</span>&nbsp;<span class="op" id="4017071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4017075">return</span>&nbsp;<span class="builtintype" id="4017082">nil</span><span class="op" id="4017085">,</span>&nbsp;<span class="ident" id="4017087">syscall</span><span class="op" id="4017094">.</span><span class="ident" id="4017095">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4017103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4017106">fd</span><span class="op" id="4017108">,</span>&nbsp;<span class="ident" id="4017110">err</span>&nbsp;<span class="op" id="4017114">:=</span>&nbsp;<span class="ident" id="4017117">l</span><span class="op" id="4017118">.</span><span class="ident" id="4017119">fd</span><span class="op" id="4017121">.</span><span class="ident" id="4017122">accept</span><span class="op" id="4017128">(</span><span class="op" id="4017129">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4017132">if</span>&nbsp;<span class="ident" id="4017135">err</span>&nbsp;<span class="op" id="4017139">!=</span>&nbsp;<span class="builtintype" id="4017142">nil</span>&nbsp;<span class="op" id="4017146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4017150">return</span>&nbsp;<span class="builtintype" id="4017157">nil</span><span class="op" id="4017160">,</span>&nbsp;<span class="ident" id="4017162">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4017167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4017170">return</span>&nbsp;<span class="ident" id="4017177">newTCPConn</span><span class="op" id="4017187">(</span><span class="ident" id="4017188">fd</span><span class="op" id="4017190">)</span><span class="op" id="4017191">,</span>&nbsp;<span class="builtintype" id="4017193">nil</span><br>
<span class="lineno"></span><span class="op" id="4017197">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment" id="4017200">//&nbsp;Accept&nbsp;implements&nbsp;the&nbsp;Accept&nbsp;method&nbsp;in&nbsp;the&nbsp;Listener&nbsp;interface;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="4017269">//&nbsp;waits&nbsp;for&nbsp;the&nbsp;next&nbsp;call&nbsp;and&nbsp;returns&nbsp;a&nbsp;generic&nbsp;Conn.</span><br>
<span class="lineno"></span><span class="keyword" id="4017324">func</span>&nbsp;<span class="op" id="4017329">(</span><span class="ident" id="4017330">l</span>&nbsp;<span class="op" id="4017332">*</span><span class="ident" id="4017333">TCPListener</span><span class="op" id="4017344">)</span>&nbsp;<span class="ident" id="4017346">Accept</span><span class="op" id="4017352">(</span><span class="op" id="4017353">)</span>&nbsp;<span class="op" id="4017355">(</span><span class="ident" id="4017356">Conn</span><span class="op" id="4017360">,</span>&nbsp;<span class="builtintype" id="4017362">error</span><span class="op" id="4017367">)</span>&nbsp;<span class="op" id="4017369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4017372">c</span><span class="op" id="4017373">,</span>&nbsp;<span class="ident" id="4017375">err</span>&nbsp;<span class="op" id="4017379">:=</span>&nbsp;<span class="ident" id="4017382">l</span><span class="op" id="4017383">.</span><span class="ident" id="4017384">AcceptTCP</span><span class="op" id="4017393">(</span><span class="op" id="4017394">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4017397">if</span>&nbsp;<span class="ident" id="4017400">err</span>&nbsp;<span class="op" id="4017404">!=</span>&nbsp;<span class="builtintype" id="4017407">nil</span>&nbsp;<span class="op" id="4017411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4017415">return</span>&nbsp;<span class="builtintype" id="4017422">nil</span><span class="op" id="4017425">,</span>&nbsp;<span class="ident" id="4017427">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4017432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4017435">return</span>&nbsp;<span class="ident" id="4017442">c</span><span class="op" id="4017443">,</span>&nbsp;<span class="builtintype" id="4017445">nil</span><br>
<span class="lineno"></span><span class="op" id="4017449">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="4017452">//&nbsp;Close&nbsp;stops&nbsp;listening&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="4017497">//&nbsp;Already&nbsp;Accepted&nbsp;connections&nbsp;are&nbsp;not&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="4017545">func</span>&nbsp;<span class="op" id="4017550">(</span><span class="ident" id="4017551">l</span>&nbsp;<span class="op" id="4017553">*</span><span class="ident" id="4017554">TCPListener</span><span class="op" id="4017565">)</span>&nbsp;<span class="ident" id="4017567">Close</span><span class="op" id="4017572">(</span><span class="op" id="4017573">)</span>&nbsp;<span class="builtintype" id="4017575">error</span>&nbsp;<span class="op" id="4017581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4017584">if</span>&nbsp;<span class="ident" id="4017587">l</span>&nbsp;<span class="op" id="4017589">==</span>&nbsp;<span class="builtintype" id="4017592">nil</span>&nbsp;<span class="op" id="4017596">||</span>&nbsp;<span class="ident" id="4017599">l</span><span class="op" id="4017600">.</span><span class="ident" id="4017601">fd</span>&nbsp;<span class="op" id="4017604">==</span>&nbsp;<span class="builtintype" id="4017607">nil</span>&nbsp;<span class="op" id="4017611">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4017615">return</span>&nbsp;<span class="ident" id="4017622">syscall</span><span class="op" id="4017629">.</span><span class="ident" id="4017630">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4017638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4017641">return</span>&nbsp;<span class="ident" id="4017648">l</span><span class="op" id="4017649">.</span><span class="ident" id="4017650">fd</span><span class="op" id="4017652">.</span><span class="ident" id="4017653">Close</span><span class="op" id="4017658">(</span><span class="op" id="4017659">)</span><br>
<span class="lineno"></span><span class="op" id="4017661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="comment" id="4017664">//&nbsp;Addr&nbsp;returns&nbsp;the&nbsp;listener&#39;s&nbsp;network&nbsp;address,&nbsp;a&nbsp;*TCPAddr.</span><br>
<span class="lineno"></span><span class="keyword" id="4017724">func</span>&nbsp;<span class="op" id="4017729">(</span><span class="ident" id="4017730">l</span>&nbsp;<span class="op" id="4017732">*</span><span class="ident" id="4017733">TCPListener</span><span class="op" id="4017744">)</span>&nbsp;<span class="ident" id="4017746">Addr</span><span class="op" id="4017750">(</span><span class="op" id="4017751">)</span>&nbsp;<span class="ident" id="4017753">Addr</span>&nbsp;<span class="op" id="4017758">{</span>&nbsp;<span class="keyword" id="4017760">return</span>&nbsp;<span class="ident" id="4017767">l</span><span class="op" id="4017768">.</span><span class="ident" id="4017769">fd</span><span class="op" id="4017771">.</span><span class="ident" id="4017772">laddr</span>&nbsp;<span class="op" id="4017778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4017781">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;deadline&nbsp;associated&nbsp;with&nbsp;the&nbsp;listener.</span><br>
<span class="lineno"></span><span class="comment" id="4017844">//&nbsp;A&nbsp;zero&nbsp;time&nbsp;value&nbsp;disables&nbsp;the&nbsp;deadline.</span><br>
<span class="lineno">265</span><span class="keyword" id="4017888">func</span>&nbsp;<span class="op" id="4017893">(</span><span class="ident" id="4017894">l</span>&nbsp;<span class="op" id="4017896">*</span><span class="ident" id="4017897">TCPListener</span><span class="op" id="4017908">)</span>&nbsp;<span class="ident" id="4017910">SetDeadline</span><span class="op" id="4017921">(</span><span class="ident" id="4017922">t</span>&nbsp;<span class="ident" id="4017924">time</span><span class="op" id="4017928">.</span><span class="ident" id="4017929">Time</span><span class="op" id="4017933">)</span>&nbsp;<span class="builtintype" id="4017935">error</span>&nbsp;<span class="op" id="4017941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4017944">if</span>&nbsp;<span class="ident" id="4017947">l</span>&nbsp;<span class="op" id="4017949">==</span>&nbsp;<span class="builtintype" id="4017952">nil</span>&nbsp;<span class="op" id="4017956">||</span>&nbsp;<span class="ident" id="4017959">l</span><span class="op" id="4017960">.</span><span class="ident" id="4017961">fd</span>&nbsp;<span class="op" id="4017964">==</span>&nbsp;<span class="builtintype" id="4017967">nil</span>&nbsp;<span class="op" id="4017971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4017975">return</span>&nbsp;<span class="ident" id="4017982">syscall</span><span class="op" id="4017989">.</span><span class="ident" id="4017990">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4017998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4018001">return</span>&nbsp;<span class="ident" id="4018008">l</span><span class="op" id="4018009">.</span><span class="ident" id="4018010">fd</span><span class="op" id="4018012">.</span><span class="ident" id="4018013">setDeadline</span><span class="op" id="4018024">(</span><span class="ident" id="4018025">t</span><span class="op" id="4018026">)</span><br>
<span class="lineno">270</span><span class="op" id="4018028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4018031">//&nbsp;File&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;underlying&nbsp;os.File,&nbsp;set&nbsp;to&nbsp;blocking</span><br>
<span class="lineno"></span><span class="comment" id="4018097">//&nbsp;mode.&nbsp;&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;close&nbsp;f&nbsp;when&nbsp;finished.</span><br>
<span class="lineno"></span><span class="comment" id="4018167">//&nbsp;Closing&nbsp;l&nbsp;does&nbsp;not&nbsp;affect&nbsp;f,&nbsp;and&nbsp;closing&nbsp;f&nbsp;does&nbsp;not&nbsp;affect&nbsp;l.</span><br>
<span class="lineno">275</span><span class="comment" id="4018232">//</span><br>
<span class="lineno"></span><span class="comment" id="4018235">//&nbsp;The&nbsp;returned&nbsp;os.File&#39;s&nbsp;file&nbsp;descriptor&nbsp;is&nbsp;different&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4018299">//&nbsp;connection&#39;s.&nbsp;&nbsp;Attempting&nbsp;to&nbsp;change&nbsp;properties&nbsp;of&nbsp;the&nbsp;original</span><br>
<span class="lineno"></span><span class="comment" id="4018365">//&nbsp;using&nbsp;this&nbsp;duplicate&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;have&nbsp;the&nbsp;desired&nbsp;effect.</span><br>
<span class="lineno"></span><span class="keyword" id="4018429">func</span>&nbsp;<span class="op" id="4018434">(</span><span class="ident" id="4018435">l</span>&nbsp;<span class="op" id="4018437">*</span><span class="ident" id="4018438">TCPListener</span><span class="op" id="4018449">)</span>&nbsp;<span class="ident" id="4018451">File</span><span class="op" id="4018455">(</span><span class="op" id="4018456">)</span>&nbsp;<span class="op" id="4018458">(</span><span class="ident" id="4018459">f</span>&nbsp;<span class="op" id="4018461">*</span><span class="ident" id="4018462">os</span><span class="op" id="4018464">.</span><span class="ident" id="4018465">File</span><span class="op" id="4018469">,</span>&nbsp;<span class="ident" id="4018471">err</span>&nbsp;<span class="builtintype" id="4018475">error</span><span class="op" id="4018480">)</span>&nbsp;<span class="op" id="4018482">{</span>&nbsp;<span class="keyword" id="4018484">return</span>&nbsp;<span class="ident" id="4018491">l</span><span class="op" id="4018492">.</span><span class="ident" id="4018493">fd</span><span class="op" id="4018495">.</span><span class="ident" id="4018496">dup</span><span class="op" id="4018499">(</span><span class="op" id="4018500">)</span>&nbsp;<span class="op" id="4018502">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="4018505">//&nbsp;ListenTCP&nbsp;announces&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address&nbsp;laddr&nbsp;and&nbsp;returns&nbsp;a&nbsp;TCP</span><br>
<span class="lineno"></span><span class="comment" id="4018571">//&nbsp;listener.&nbsp;&nbsp;Net&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;has&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4018639">//&nbsp;port&nbsp;of&nbsp;0,&nbsp;ListenTCP&nbsp;will&nbsp;choose&nbsp;an&nbsp;available&nbsp;port.&nbsp;&nbsp;The&nbsp;caller&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="4018710">//&nbsp;use&nbsp;the&nbsp;Addr&nbsp;method&nbsp;of&nbsp;TCPListener&nbsp;to&nbsp;retrieve&nbsp;the&nbsp;chosen&nbsp;address.</span><br>
<span class="lineno">285</span><span class="keyword" id="4018780">func</span>&nbsp;<span class="ident" id="4018785">ListenTCP</span><span class="op" id="4018794">(</span><span class="ident" id="4018795">net</span>&nbsp;<span class="builtintype" id="4018799">string</span><span class="op" id="4018805">,</span>&nbsp;<span class="ident" id="4018807">laddr</span>&nbsp;<span class="op" id="4018813">*</span><span class="ident" id="4018814">TCPAddr</span><span class="op" id="4018821">)</span>&nbsp;<span class="op" id="4018823">(</span><span class="op" id="4018824">*</span><span class="ident" id="4018825">TCPListener</span><span class="op" id="4018836">,</span>&nbsp;<span class="builtintype" id="4018838">error</span><span class="op" id="4018843">)</span>&nbsp;<span class="op" id="4018845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4018848">switch</span>&nbsp;<span class="ident" id="4018855">net</span>&nbsp;<span class="op" id="4018859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4018862">case</span>&nbsp;<span class="string" id="4018867">&#34;tcp&#34;</span><span class="op" id="4018872">,</span>&nbsp;<span class="string" id="4018874">&#34;tcp4&#34;</span><span class="op" id="4018880">,</span>&nbsp;<span class="string" id="4018882">&#34;tcp6&#34;</span><span class="op" id="4018888">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4018891">default</span><span class="op" id="4018898">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4018902">return</span>&nbsp;<span class="builtintype" id="4018909">nil</span><span class="op" id="4018912">,</span>&nbsp;<span class="op" id="4018914">&amp;</span><span class="ident" id="4018915">OpError</span><span class="op" id="4018922">{</span><span class="ident" id="4018923">Op</span><span class="op" id="4018925">:</span>&nbsp;<span class="string" id="4018927">&#34;listen&#34;</span><span class="op" id="4018935">,</span>&nbsp;<span class="ident" id="4018937">Net</span><span class="op" id="4018940">:</span>&nbsp;<span class="ident" id="4018942">net</span><span class="op" id="4018945">,</span>&nbsp;<span class="ident" id="4018947">Addr</span><span class="op" id="4018951">:</span>&nbsp;<span class="ident" id="4018953">laddr</span><span class="op" id="4018958">,</span>&nbsp;<span class="ident" id="4018960">Err</span><span class="op" id="4018963">:</span>&nbsp;<span class="ident" id="4018965">UnknownNetworkError</span><span class="op" id="4018984">(</span><span class="ident" id="4018985">net</span><span class="op" id="4018988">)</span><span class="op" id="4018989">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4018992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4018995">if</span>&nbsp;<span class="ident" id="4018998">laddr</span>&nbsp;<span class="op" id="4019004">==</span>&nbsp;<span class="builtintype" id="4019007">nil</span>&nbsp;<span class="op" id="4019011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4019015">laddr</span>&nbsp;<span class="op" id="4019021">=</span>&nbsp;<span class="op" id="4019023">&amp;</span><span class="ident" id="4019024">TCPAddr</span><span class="op" id="4019031">{</span><span class="op" id="4019032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4019035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4019038">fd</span><span class="op" id="4019040">,</span>&nbsp;<span class="ident" id="4019042">err</span>&nbsp;<span class="op" id="4019046">:=</span>&nbsp;<span class="ident" id="4019049">internetSocket</span><span class="op" id="4019063">(</span><span class="ident" id="4019064">net</span><span class="op" id="4019067">,</span>&nbsp;<span class="ident" id="4019069">laddr</span><span class="op" id="4019074">,</span>&nbsp;<span class="builtintype" id="4019076">nil</span><span class="op" id="4019079">,</span>&nbsp;<span class="ident" id="4019081">noDeadline</span><span class="op" id="4019091">,</span>&nbsp;<span class="ident" id="4019093">syscall</span><span class="op" id="4019100">.</span><span class="ident" id="4019101">SOCK_STREAM</span><span class="op" id="4019112">,</span>&nbsp;<span class="num" id="4019114">0</span><span class="op" id="4019115">,</span>&nbsp;<span class="string" id="4019117">&#34;listen&#34;</span><span class="op" id="4019125">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4019128">if</span>&nbsp;<span class="ident" id="4019131">err</span>&nbsp;<span class="op" id="4019135">!=</span>&nbsp;<span class="builtintype" id="4019138">nil</span>&nbsp;<span class="op" id="4019142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4019146">return</span>&nbsp;<span class="builtintype" id="4019153">nil</span><span class="op" id="4019156">,</span>&nbsp;<span class="op" id="4019158">&amp;</span><span class="ident" id="4019159">OpError</span><span class="op" id="4019166">{</span><span class="ident" id="4019167">Op</span><span class="op" id="4019169">:</span>&nbsp;<span class="string" id="4019171">&#34;listen&#34;</span><span class="op" id="4019179">,</span>&nbsp;<span class="ident" id="4019181">Net</span><span class="op" id="4019184">:</span>&nbsp;<span class="ident" id="4019186">net</span><span class="op" id="4019189">,</span>&nbsp;<span class="ident" id="4019191">Addr</span><span class="op" id="4019195">:</span>&nbsp;<span class="ident" id="4019197">laddr</span><span class="op" id="4019202">,</span>&nbsp;<span class="ident" id="4019204">Err</span><span class="op" id="4019207">:</span>&nbsp;<span class="ident" id="4019209">err</span><span class="op" id="4019212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4019215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4019218">return</span>&nbsp;<span class="op" id="4019225">&amp;</span><span class="ident" id="4019226">TCPListener</span><span class="op" id="4019237">{</span><span class="ident" id="4019238">fd</span><span class="op" id="4019240">}</span><span class="op" id="4019241">,</span>&nbsp;<span class="builtintype" id="4019243">nil</span><br>
<span class="lineno"></span><span class="op" id="4019247">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
