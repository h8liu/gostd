<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html" class="current">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4957429">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4957484">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4957538">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4957589">//go:generate&nbsp;go&nbsp;run&nbsp;encgen.go&nbsp;-output&nbsp;enc_helpers.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4957644">package</span>&nbsp;<span class="ident" id="4957652">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4957657">import</span>&nbsp;<span class="op" id="4957664">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4957667">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4957679">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4957687">&#34;reflect&#34;</span><br>
<span class="lineno"></span><span class="op" id="4957697">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="4957700">const</span>&nbsp;<span class="ident" id="4957706">uint64Size</span>&nbsp;<span class="op" id="4957717">=</span>&nbsp;<span class="num" id="4957719">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4957722">type</span>&nbsp;<span class="ident" id="4957727">encHelper</span>&nbsp;<span class="keyword" id="4957737">func</span><span class="op" id="4957741">(</span><span class="ident" id="4957742">state</span>&nbsp;<span class="op" id="4957748">*</span><span class="ident" id="4957749">encoderState</span><span class="op" id="4957761">,</span>&nbsp;<span class="ident" id="4957763">v</span>&nbsp;<span class="ident" id="4957765">reflect</span><span class="op" id="4957772">.</span><span class="ident" id="4957773">Value</span><span class="op" id="4957778">)</span>&nbsp;<span class="builtintype" id="4957780">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4957786">//&nbsp;encoderState&nbsp;is&nbsp;the&nbsp;global&nbsp;execution&nbsp;state&nbsp;of&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno">20</span><span class="comment" id="4957863">//&nbsp;Field&nbsp;numbers&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;and&nbsp;always&nbsp;increase.&nbsp;The&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="4957929">//&nbsp;number&nbsp;is&nbsp;initialized&nbsp;to&nbsp;-1&nbsp;so&nbsp;0&nbsp;comes&nbsp;out&nbsp;as&nbsp;delta(1).&nbsp;A&nbsp;delta&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4957999">//&nbsp;0&nbsp;terminates&nbsp;the&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="4958030">type</span>&nbsp;<span class="ident" id="4958035">encoderState</span>&nbsp;<span class="keyword" id="4958048">struct</span>&nbsp;<span class="op" id="4958055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4958058">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4958067">*</span><span class="ident" id="4958068">Encoder</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4958077">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4958086">*</span><span class="ident" id="4958087">encBuffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4958098">sendZero</span>&nbsp;<span class="builtintype" id="4958107">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4958128">//&nbsp;encoding&nbsp;an&nbsp;array&nbsp;element&nbsp;or&nbsp;map&nbsp;key/value&nbsp;pair;&nbsp;send&nbsp;zero&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4958198">fieldnum</span>&nbsp;<span class="builtintype" id="4958207">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4958228">//&nbsp;the&nbsp;last&nbsp;field&nbsp;number&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4958263">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4958272">[</span><span class="num" id="4958273">1</span>&nbsp;<span class="op" id="4958275">+</span>&nbsp;<span class="ident" id="4958277">uint64Size</span><span class="op" id="4958287">]</span><span class="builtintype" id="4958288">byte</span>&nbsp;<span class="comment" id="4958293">//&nbsp;buffer&nbsp;used&nbsp;by&nbsp;the&nbsp;encoder;&nbsp;here&nbsp;to&nbsp;avoid&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4958351">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4958360">*</span><span class="ident" id="4958361">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4958381">//&nbsp;for&nbsp;free&nbsp;list</span><br>
<span class="lineno">30</span><span class="op" id="4958398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4958401">//&nbsp;encBuffer&nbsp;is&nbsp;an&nbsp;extremely&nbsp;simple,&nbsp;fast&nbsp;implementation&nbsp;of&nbsp;a&nbsp;write-only&nbsp;byte&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="4958487">//&nbsp;It&nbsp;never&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;but&nbsp;Write&nbsp;returns&nbsp;an&nbsp;error&nbsp;value&nbsp;so&nbsp;it&nbsp;matches&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4958582">type</span>&nbsp;<span class="ident" id="4958587">encBuffer</span>&nbsp;<span class="keyword" id="4958597">struct</span>&nbsp;<span class="op" id="4958604">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4958607">data</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4958615">[</span><span class="op" id="4958616">]</span><span class="builtintype" id="4958617">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4958623">scratch</span>&nbsp;<span class="op" id="4958631">[</span><span class="num" id="4958632">64</span><span class="op" id="4958634">]</span><span class="builtintype" id="4958635">byte</span><br>
<span class="lineno"></span><span class="op" id="4958640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4958643">func</span>&nbsp;<span class="op" id="4958648">(</span><span class="ident" id="4958649">e</span>&nbsp;<span class="op" id="4958651">*</span><span class="ident" id="4958652">encBuffer</span><span class="op" id="4958661">)</span>&nbsp;<span class="ident" id="4958663">WriteByte</span><span class="op" id="4958672">(</span><span class="ident" id="4958673">c</span>&nbsp;<span class="builtintype" id="4958675">byte</span><span class="op" id="4958679">)</span>&nbsp;<span class="op" id="4958681">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4958684">e</span><span class="op" id="4958685">.</span><span class="ident" id="4958686">data</span>&nbsp;<span class="op" id="4958691">=</span>&nbsp;<span class="builtinfunc" id="4958693">append</span><span class="op" id="4958699">(</span><span class="ident" id="4958700">e</span><span class="op" id="4958701">.</span><span class="ident" id="4958702">data</span><span class="op" id="4958706">,</span>&nbsp;<span class="ident" id="4958708">c</span><span class="op" id="4958709">)</span><br>
<span class="lineno"></span><span class="op" id="4958711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4958714">func</span>&nbsp;<span class="op" id="4958719">(</span><span class="ident" id="4958720">e</span>&nbsp;<span class="op" id="4958722">*</span><span class="ident" id="4958723">encBuffer</span><span class="op" id="4958732">)</span>&nbsp;<span class="ident" id="4958734">Write</span><span class="op" id="4958739">(</span><span class="ident" id="4958740">p</span>&nbsp;<span class="op" id="4958742">[</span><span class="op" id="4958743">]</span><span class="builtintype" id="4958744">byte</span><span class="op" id="4958748">)</span>&nbsp;<span class="op" id="4958750">(</span><span class="builtintype" id="4958751">int</span><span class="op" id="4958754">,</span>&nbsp;<span class="builtintype" id="4958756">error</span><span class="op" id="4958761">)</span>&nbsp;<span class="op" id="4958763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4958766">e</span><span class="op" id="4958767">.</span><span class="ident" id="4958768">data</span>&nbsp;<span class="op" id="4958773">=</span>&nbsp;<span class="builtinfunc" id="4958775">append</span><span class="op" id="4958781">(</span><span class="ident" id="4958782">e</span><span class="op" id="4958783">.</span><span class="ident" id="4958784">data</span><span class="op" id="4958788">,</span>&nbsp;<span class="ident" id="4958790">p</span><span class="op" id="4958791">...</span><span class="op" id="4958794">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4958797">return</span>&nbsp;<span class="builtinfunc" id="4958804">len</span><span class="op" id="4958807">(</span><span class="ident" id="4958808">p</span><span class="op" id="4958809">)</span><span class="op" id="4958810">,</span>&nbsp;<span class="ident" id="4958812">nil</span><br>
<span class="lineno"></span><span class="op" id="4958816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4958819">func</span>&nbsp;<span class="op" id="4958824">(</span><span class="ident" id="4958825">e</span>&nbsp;<span class="op" id="4958827">*</span><span class="ident" id="4958828">encBuffer</span><span class="op" id="4958837">)</span>&nbsp;<span class="ident" id="4958839">WriteString</span><span class="op" id="4958850">(</span><span class="ident" id="4958851">s</span>&nbsp;<span class="builtintype" id="4958853">string</span><span class="op" id="4958859">)</span>&nbsp;<span class="op" id="4958861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4958864">e</span><span class="op" id="4958865">.</span><span class="ident" id="4958866">data</span>&nbsp;<span class="op" id="4958871">=</span>&nbsp;<span class="builtinfunc" id="4958873">append</span><span class="op" id="4958879">(</span><span class="ident" id="4958880">e</span><span class="op" id="4958881">.</span><span class="ident" id="4958882">data</span><span class="op" id="4958886">,</span>&nbsp;<span class="ident" id="4958888">s</span><span class="op" id="4958889">...</span><span class="op" id="4958892">)</span><br>
<span class="lineno">50</span><span class="op" id="4958894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4958897">func</span>&nbsp;<span class="op" id="4958902">(</span><span class="ident" id="4958903">e</span>&nbsp;<span class="op" id="4958905">*</span><span class="ident" id="4958906">encBuffer</span><span class="op" id="4958915">)</span>&nbsp;<span class="ident" id="4958917">Len</span><span class="op" id="4958920">(</span><span class="op" id="4958921">)</span>&nbsp;<span class="builtintype" id="4958923">int</span>&nbsp;<span class="op" id="4958927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4958930">return</span>&nbsp;<span class="builtinfunc" id="4958937">len</span><span class="op" id="4958940">(</span><span class="ident" id="4958941">e</span><span class="op" id="4958942">.</span><span class="ident" id="4958943">data</span><span class="op" id="4958947">)</span><br>
<span class="lineno"></span><span class="op" id="4958949">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="4958952">func</span>&nbsp;<span class="op" id="4958957">(</span><span class="ident" id="4958958">e</span>&nbsp;<span class="op" id="4958960">*</span><span class="ident" id="4958961">encBuffer</span><span class="op" id="4958970">)</span>&nbsp;<span class="ident" id="4958972">Bytes</span><span class="op" id="4958977">(</span><span class="op" id="4958978">)</span>&nbsp;<span class="op" id="4958980">[</span><span class="op" id="4958981">]</span><span class="builtintype" id="4958982">byte</span>&nbsp;<span class="op" id="4958987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4958990">return</span>&nbsp;<span class="ident" id="4958997">e</span><span class="op" id="4958998">.</span><span class="ident" id="4958999">data</span><br>
<span class="lineno"></span><span class="op" id="4959004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4959007">func</span>&nbsp;<span class="op" id="4959012">(</span><span class="ident" id="4959013">e</span>&nbsp;<span class="op" id="4959015">*</span><span class="ident" id="4959016">encBuffer</span><span class="op" id="4959025">)</span>&nbsp;<span class="ident" id="4959027">Reset</span><span class="op" id="4959032">(</span><span class="op" id="4959033">)</span>&nbsp;<span class="op" id="4959035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959038">e</span><span class="op" id="4959039">.</span><span class="ident" id="4959040">data</span>&nbsp;<span class="op" id="4959045">=</span>&nbsp;<span class="ident" id="4959047">e</span><span class="op" id="4959048">.</span><span class="ident" id="4959049">data</span><span class="op" id="4959053">[</span><span class="num" id="4959054">0</span><span class="op" id="4959055">:</span><span class="num" id="4959056">0</span><span class="op" id="4959057">]</span><br>
<span class="lineno"></span><span class="op" id="4959059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4959062">func</span>&nbsp;<span class="op" id="4959067">(</span><span class="ident" id="4959068">enc</span>&nbsp;<span class="op" id="4959072">*</span><span class="ident" id="4959073">Encoder</span><span class="op" id="4959080">)</span>&nbsp;<span class="ident" id="4959082">newEncoderState</span><span class="op" id="4959097">(</span><span class="ident" id="4959098">b</span>&nbsp;<span class="op" id="4959100">*</span><span class="ident" id="4959101">encBuffer</span><span class="op" id="4959110">)</span>&nbsp;<span class="op" id="4959112">*</span><span class="ident" id="4959113">encoderState</span>&nbsp;<span class="op" id="4959126">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959129">e</span>&nbsp;<span class="op" id="4959131">:=</span>&nbsp;<span class="ident" id="4959134">enc</span><span class="op" id="4959137">.</span><span class="ident" id="4959138">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4959148">if</span>&nbsp;<span class="ident" id="4959151">e</span>&nbsp;<span class="op" id="4959153">==</span>&nbsp;<span class="ident" id="4959156">nil</span>&nbsp;<span class="op" id="4959160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959164">e</span>&nbsp;<span class="op" id="4959166">=</span>&nbsp;<span class="builtinfunc" id="4959168">new</span><span class="op" id="4959171">(</span><span class="ident" id="4959172">encoderState</span><span class="op" id="4959184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959188">e</span><span class="op" id="4959189">.</span><span class="ident" id="4959190">enc</span>&nbsp;<span class="op" id="4959194">=</span>&nbsp;<span class="ident" id="4959196">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4959201">}</span>&nbsp;<span class="keyword" id="4959203">else</span>&nbsp;<span class="op" id="4959208">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959212">enc</span><span class="op" id="4959215">.</span><span class="ident" id="4959216">freeList</span>&nbsp;<span class="op" id="4959225">=</span>&nbsp;<span class="ident" id="4959227">e</span><span class="op" id="4959228">.</span><span class="ident" id="4959229">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4959235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959238">e</span><span class="op" id="4959239">.</span><span class="ident" id="4959240">sendZero</span>&nbsp;<span class="op" id="4959249">=</span>&nbsp;<span class="builtintype" id="4959251">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959258">e</span><span class="op" id="4959259">.</span><span class="ident" id="4959260">fieldnum</span>&nbsp;<span class="op" id="4959269">=</span>&nbsp;<span class="num" id="4959271">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959274">e</span><span class="op" id="4959275">.</span><span class="ident" id="4959276">b</span>&nbsp;<span class="op" id="4959278">=</span>&nbsp;<span class="ident" id="4959280">b</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4959283">if</span>&nbsp;<span class="builtinfunc" id="4959286">len</span><span class="op" id="4959289">(</span><span class="ident" id="4959290">b</span><span class="op" id="4959291">.</span><span class="ident" id="4959292">data</span><span class="op" id="4959296">)</span>&nbsp;<span class="op" id="4959298">==</span>&nbsp;<span class="num" id="4959301">0</span>&nbsp;<span class="op" id="4959303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959307">b</span><span class="op" id="4959308">.</span><span class="ident" id="4959309">data</span>&nbsp;<span class="op" id="4959314">=</span>&nbsp;<span class="ident" id="4959316">b</span><span class="op" id="4959317">.</span><span class="ident" id="4959318">scratch</span><span class="op" id="4959325">[</span><span class="num" id="4959326">0</span><span class="op" id="4959327">:</span><span class="num" id="4959328">0</span><span class="op" id="4959329">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4959332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4959335">return</span>&nbsp;<span class="ident" id="4959342">e</span><br>
<span class="lineno"></span><span class="op" id="4959344">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="4959347">func</span>&nbsp;<span class="op" id="4959352">(</span><span class="ident" id="4959353">enc</span>&nbsp;<span class="op" id="4959357">*</span><span class="ident" id="4959358">Encoder</span><span class="op" id="4959365">)</span>&nbsp;<span class="ident" id="4959367">freeEncoderState</span><span class="op" id="4959383">(</span><span class="ident" id="4959384">e</span>&nbsp;<span class="op" id="4959386">*</span><span class="ident" id="4959387">encoderState</span><span class="op" id="4959399">)</span>&nbsp;<span class="op" id="4959401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959404">e</span><span class="op" id="4959405">.</span><span class="ident" id="4959406">next</span>&nbsp;<span class="op" id="4959411">=</span>&nbsp;<span class="ident" id="4959413">enc</span><span class="op" id="4959416">.</span><span class="ident" id="4959417">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959427">enc</span><span class="op" id="4959430">.</span><span class="ident" id="4959431">freeList</span>&nbsp;<span class="op" id="4959440">=</span>&nbsp;<span class="ident" id="4959442">e</span><br>
<span class="lineno"></span><span class="op" id="4959444">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="4959447">//&nbsp;Unsigned&nbsp;integers&nbsp;have&nbsp;a&nbsp;two-state&nbsp;encoding.&nbsp;&nbsp;If&nbsp;the&nbsp;number&nbsp;is&nbsp;less</span><br>
<span class="lineno"></span><span class="comment" id="4959518">//&nbsp;than&nbsp;128&nbsp;(0&nbsp;through&nbsp;0x7F),&nbsp;its&nbsp;value&nbsp;is&nbsp;written&nbsp;directly.</span><br>
<span class="lineno"></span><span class="comment" id="4959579">//&nbsp;Otherwise&nbsp;the&nbsp;value&nbsp;is&nbsp;written&nbsp;in&nbsp;big-endian&nbsp;byte&nbsp;order&nbsp;preceded</span><br>
<span class="lineno"></span><span class="comment" id="4959647">//&nbsp;by&nbsp;the&nbsp;byte&nbsp;length,&nbsp;negated.</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4959680">//&nbsp;encodeUint&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;to&nbsp;state.b.</span><br>
<span class="lineno"></span><span class="keyword" id="4959741">func</span>&nbsp;<span class="op" id="4959746">(</span><span class="ident" id="4959747">state</span>&nbsp;<span class="op" id="4959753">*</span><span class="ident" id="4959754">encoderState</span><span class="op" id="4959766">)</span>&nbsp;<span class="ident" id="4959768">encodeUint</span><span class="op" id="4959778">(</span><span class="ident" id="4959779">x</span>&nbsp;<span class="ident" id="4959781">uint64</span><span class="op" id="4959787">)</span>&nbsp;<span class="op" id="4959789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4959792">if</span>&nbsp;<span class="ident" id="4959795">x</span>&nbsp;<span class="op" id="4959797">&lt;=</span>&nbsp;<span class="num" id="4959800">0x7F</span>&nbsp;<span class="op" id="4959805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959809">state</span><span class="op" id="4959814">.</span><span class="ident" id="4959815">b</span><span class="op" id="4959816">.</span><span class="ident" id="4959817">WriteByte</span><span class="op" id="4959826">(</span><span class="builtintype" id="4959827">uint8</span><span class="op" id="4959832">(</span><span class="ident" id="4959833">x</span><span class="op" id="4959834">)</span><span class="op" id="4959835">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4959839">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4959847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959850">i</span>&nbsp;<span class="op" id="4959852">:=</span>&nbsp;<span class="ident" id="4959855">uint64Size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4959867">for</span>&nbsp;<span class="ident" id="4959871">x</span>&nbsp;<span class="op" id="4959873">&gt;</span>&nbsp;<span class="num" id="4959875">0</span>&nbsp;<span class="op" id="4959877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959881">state</span><span class="op" id="4959886">.</span><span class="ident" id="4959887">buf</span><span class="op" id="4959890">[</span><span class="ident" id="4959891">i</span><span class="op" id="4959892">]</span>&nbsp;<span class="op" id="4959894">=</span>&nbsp;<span class="builtintype" id="4959896">uint8</span><span class="op" id="4959901">(</span><span class="ident" id="4959902">x</span><span class="op" id="4959903">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959907">x</span>&nbsp;<span class="op" id="4959909">&gt;&gt;=</span>&nbsp;<span class="num" id="4959913">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959917">i</span><span class="op" id="4959918">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4959922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959925">state</span><span class="op" id="4959930">.</span><span class="ident" id="4959931">buf</span><span class="op" id="4959934">[</span><span class="ident" id="4959935">i</span><span class="op" id="4959936">]</span>&nbsp;<span class="op" id="4959938">=</span>&nbsp;<span class="builtintype" id="4959940">uint8</span><span class="op" id="4959945">(</span><span class="ident" id="4959946">i</span>&nbsp;<span class="op" id="4959948">-</span>&nbsp;<span class="ident" id="4959950">uint64Size</span><span class="op" id="4959960">)</span>&nbsp;<span class="comment" id="4959962">//&nbsp;=&nbsp;loop&nbsp;count,&nbsp;negated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4959988">state</span><span class="op" id="4959993">.</span><span class="ident" id="4959994">b</span><span class="op" id="4959995">.</span><span class="ident" id="4959996">Write</span><span class="op" id="4960001">(</span><span class="ident" id="4960002">state</span><span class="op" id="4960007">.</span><span class="ident" id="4960008">buf</span><span class="op" id="4960011">[</span><span class="ident" id="4960012">i</span>&nbsp;<span class="op" id="4960014">:</span>&nbsp;<span class="ident" id="4960016">uint64Size</span><span class="op" id="4960026">+</span><span class="num" id="4960027">1</span><span class="op" id="4960028">]</span><span class="op" id="4960029">)</span><br>
<span class="lineno">105</span><span class="op" id="4960031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4960034">//&nbsp;encodeInt&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;signed&nbsp;integer&nbsp;to&nbsp;state.w.</span><br>
<span class="lineno"></span><span class="comment" id="4960092">//&nbsp;The&nbsp;low&nbsp;bit&nbsp;of&nbsp;the&nbsp;encoding&nbsp;says&nbsp;whether&nbsp;to&nbsp;bit&nbsp;complement&nbsp;the&nbsp;(other&nbsp;bits&nbsp;of&nbsp;the)</span><br>
<span class="lineno"></span><span class="comment" id="4960178">//&nbsp;uint&nbsp;to&nbsp;recover&nbsp;the&nbsp;int.</span><br>
<span class="lineno">110</span><span class="keyword" id="4960206">func</span>&nbsp;<span class="op" id="4960211">(</span><span class="ident" id="4960212">state</span>&nbsp;<span class="op" id="4960218">*</span><span class="ident" id="4960219">encoderState</span><span class="op" id="4960231">)</span>&nbsp;<span class="ident" id="4960233">encodeInt</span><span class="op" id="4960242">(</span><span class="ident" id="4960243">i</span>&nbsp;<span class="ident" id="4960245">int64</span><span class="op" id="4960250">)</span>&nbsp;<span class="op" id="4960252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4960255">var</span>&nbsp;<span class="ident" id="4960259">x</span>&nbsp;<span class="ident" id="4960261">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4960269">if</span>&nbsp;<span class="ident" id="4960272">i</span>&nbsp;<span class="op" id="4960274">&lt;</span>&nbsp;<span class="num" id="4960276">0</span>&nbsp;<span class="op" id="4960278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4960282">x</span>&nbsp;<span class="op" id="4960284">=</span>&nbsp;<span class="ident" id="4960286">uint64</span><span class="op" id="4960292">(</span><span class="op" id="4960293">^</span><span class="ident" id="4960294">i</span><span class="op" id="4960295">&lt;&lt;</span><span class="num" id="4960297">1</span><span class="op" id="4960298">)</span>&nbsp;<span class="op" id="4960300">|</span>&nbsp;<span class="num" id="4960302">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4960305">}</span>&nbsp;<span class="keyword" id="4960307">else</span>&nbsp;<span class="op" id="4960312">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4960316">x</span>&nbsp;<span class="op" id="4960318">=</span>&nbsp;<span class="ident" id="4960320">uint64</span><span class="op" id="4960326">(</span><span class="ident" id="4960327">i</span>&nbsp;<span class="op" id="4960329">&lt;&lt;</span>&nbsp;<span class="num" id="4960332">1</span><span class="op" id="4960333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4960336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4960339">state</span><span class="op" id="4960344">.</span><span class="ident" id="4960345">encodeUint</span><span class="op" id="4960355">(</span><span class="ident" id="4960356">uint64</span><span class="op" id="4960362">(</span><span class="ident" id="4960363">x</span><span class="op" id="4960364">)</span><span class="op" id="4960365">)</span><br>
<span class="lineno"></span><span class="op" id="4960367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="4960370">//&nbsp;encOp&nbsp;is&nbsp;the&nbsp;signature&nbsp;of&nbsp;an&nbsp;encoding&nbsp;operator&nbsp;for&nbsp;a&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4960438">type</span>&nbsp;<span class="ident" id="4960443">encOp</span>&nbsp;<span class="keyword" id="4960449">func</span><span class="op" id="4960453">(</span><span class="ident" id="4960454">i</span>&nbsp;<span class="op" id="4960456">*</span><span class="ident" id="4960457">encInstr</span><span class="op" id="4960465">,</span>&nbsp;<span class="ident" id="4960467">state</span>&nbsp;<span class="op" id="4960473">*</span><span class="ident" id="4960474">encoderState</span><span class="op" id="4960486">,</span>&nbsp;<span class="ident" id="4960488">v</span>&nbsp;<span class="ident" id="4960490">reflect</span><span class="op" id="4960497">.</span><span class="ident" id="4960498">Value</span><span class="op" id="4960503">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4960506">//&nbsp;The&nbsp;&#39;instructions&#39;&nbsp;of&nbsp;the&nbsp;encoding&nbsp;machine</span><br>
<span class="lineno"></span><span class="keyword" id="4960552">type</span>&nbsp;<span class="ident" id="4960557">encInstr</span>&nbsp;<span class="keyword" id="4960566">struct</span>&nbsp;<span class="op" id="4960573">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4960576">op</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4960582">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4960589">field</span>&nbsp;<span class="builtintype" id="4960595">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4960601">//&nbsp;field&nbsp;number&nbsp;in&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4960627">index</span>&nbsp;<span class="op" id="4960633">[</span><span class="op" id="4960634">]</span><span class="builtintype" id="4960635">int</span>&nbsp;<span class="comment" id="4960639">//&nbsp;struct&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4960656">indir</span>&nbsp;<span class="builtintype" id="4960662">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4960668">//&nbsp;how&nbsp;many&nbsp;pointer&nbsp;indirections&nbsp;to&nbsp;reach&nbsp;the&nbsp;value&nbsp;in&nbsp;the&nbsp;struct</span><br>
<span class="lineno"></span><span class="op" id="4960734">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="4960737">//&nbsp;update&nbsp;emits&nbsp;a&nbsp;field&nbsp;number&nbsp;and&nbsp;updates&nbsp;the&nbsp;state&nbsp;to&nbsp;record&nbsp;its&nbsp;value&nbsp;for&nbsp;delta&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="comment" id="4960830">//&nbsp;If&nbsp;the&nbsp;instruction&nbsp;pointer&nbsp;is&nbsp;nil,&nbsp;it&nbsp;does&nbsp;nothing</span><br>
<span class="lineno"></span><span class="keyword" id="4960884">func</span>&nbsp;<span class="op" id="4960889">(</span><span class="ident" id="4960890">state</span>&nbsp;<span class="op" id="4960896">*</span><span class="ident" id="4960897">encoderState</span><span class="op" id="4960909">)</span>&nbsp;<span class="ident" id="4960911">update</span><span class="op" id="4960917">(</span><span class="ident" id="4960918">instr</span>&nbsp;<span class="op" id="4960924">*</span><span class="ident" id="4960925">encInstr</span><span class="op" id="4960933">)</span>&nbsp;<span class="op" id="4960935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4960938">if</span>&nbsp;<span class="ident" id="4960941">instr</span>&nbsp;<span class="op" id="4960947">!=</span>&nbsp;<span class="ident" id="4960950">nil</span>&nbsp;<span class="op" id="4960954">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4960958">state</span><span class="op" id="4960963">.</span><span class="ident" id="4960964">encodeUint</span><span class="op" id="4960974">(</span><span class="ident" id="4960975">uint64</span><span class="op" id="4960981">(</span><span class="ident" id="4960982">instr</span><span class="op" id="4960987">.</span><span class="ident" id="4960988">field</span>&nbsp;<span class="op" id="4960994">-</span>&nbsp;<span class="ident" id="4960996">state</span><span class="op" id="4961001">.</span><span class="ident" id="4961002">fieldnum</span><span class="op" id="4961010">)</span><span class="op" id="4961011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4961015">state</span><span class="op" id="4961020">.</span><span class="ident" id="4961021">fieldnum</span>&nbsp;<span class="op" id="4961030">=</span>&nbsp;<span class="ident" id="4961032">instr</span><span class="op" id="4961037">.</span><span class="ident" id="4961038">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4961045">}</span><br>
<span class="lineno"></span><span class="op" id="4961047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="4961050">//&nbsp;Each&nbsp;encoder&nbsp;for&nbsp;a&nbsp;composite&nbsp;is&nbsp;responsible&nbsp;for&nbsp;handling&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="4961114">//&nbsp;indirections&nbsp;associated&nbsp;with&nbsp;the&nbsp;elements&nbsp;of&nbsp;the&nbsp;data&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="4961182">//&nbsp;If&nbsp;any&nbsp;pointer&nbsp;so&nbsp;reached&nbsp;is&nbsp;nil,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4961249">//&nbsp;data&nbsp;item&nbsp;is&nbsp;zero,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;Single&nbsp;values&nbsp;-&nbsp;ints,</span><br>
<span class="lineno"></span><span class="comment" id="4961316">//&nbsp;strings&nbsp;etc.&nbsp;-&nbsp;are&nbsp;indirected&nbsp;before&nbsp;calling&nbsp;their&nbsp;encoders.</span><br>
<span class="lineno">145</span><span class="comment" id="4961380">//&nbsp;Otherwise,&nbsp;the&nbsp;output&nbsp;(for&nbsp;a&nbsp;scalar)&nbsp;is&nbsp;the&nbsp;field&nbsp;number,&nbsp;as&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="4961447">//&nbsp;encoded&nbsp;integer,&nbsp;followed&nbsp;by&nbsp;the&nbsp;field&nbsp;data&nbsp;in&nbsp;its&nbsp;appropriate</span><br>
<span class="lineno"></span><span class="comment" id="4961513">//&nbsp;format.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4961525">//&nbsp;encIndirect&nbsp;dereferences&nbsp;pv&nbsp;indir&nbsp;times&nbsp;and&nbsp;returns&nbsp;the&nbsp;result.</span><br>
<span class="lineno">150</span><span class="keyword" id="4961592">func</span>&nbsp;<span class="ident" id="4961597">encIndirect</span><span class="op" id="4961608">(</span><span class="ident" id="4961609">pv</span>&nbsp;<span class="ident" id="4961612">reflect</span><span class="op" id="4961619">.</span><span class="ident" id="4961620">Value</span><span class="op" id="4961625">,</span>&nbsp;<span class="ident" id="4961627">indir</span>&nbsp;<span class="builtintype" id="4961633">int</span><span class="op" id="4961636">)</span>&nbsp;<span class="ident" id="4961638">reflect</span><span class="op" id="4961645">.</span><span class="ident" id="4961646">Value</span>&nbsp;<span class="op" id="4961652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4961655">for</span>&nbsp;<span class="op" id="4961659">;</span>&nbsp;<span class="ident" id="4961661">indir</span>&nbsp;<span class="op" id="4961667">&gt;</span>&nbsp;<span class="num" id="4961669">0</span><span class="op" id="4961670">;</span>&nbsp;<span class="ident" id="4961672">indir</span><span class="op" id="4961677">--</span>&nbsp;<span class="op" id="4961680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4961684">if</span>&nbsp;<span class="ident" id="4961687">pv</span><span class="op" id="4961689">.</span><span class="ident" id="4961690">IsNil</span><span class="op" id="4961695">(</span><span class="op" id="4961696">)</span>&nbsp;<span class="op" id="4961698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4961703">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4961711">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4961715">pv</span>&nbsp;<span class="op" id="4961718">=</span>&nbsp;<span class="ident" id="4961720">pv</span><span class="op" id="4961722">.</span><span class="ident" id="4961723">Elem</span><span class="op" id="4961727">(</span><span class="op" id="4961728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4961731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4961734">return</span>&nbsp;<span class="ident" id="4961741">pv</span><br>
<span class="lineno"></span><span class="op" id="4961744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="4961747">//&nbsp;encBool&nbsp;encodes&nbsp;the&nbsp;bool&nbsp;referenced&nbsp;by&nbsp;v&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;0&nbsp;or&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="4961814">func</span>&nbsp;<span class="ident" id="4961819">encBool</span><span class="op" id="4961826">(</span><span class="ident" id="4961827">i</span>&nbsp;<span class="op" id="4961829">*</span><span class="ident" id="4961830">encInstr</span><span class="op" id="4961838">,</span>&nbsp;<span class="ident" id="4961840">state</span>&nbsp;<span class="op" id="4961846">*</span><span class="ident" id="4961847">encoderState</span><span class="op" id="4961859">,</span>&nbsp;<span class="ident" id="4961861">v</span>&nbsp;<span class="ident" id="4961863">reflect</span><span class="op" id="4961870">.</span><span class="ident" id="4961871">Value</span><span class="op" id="4961876">)</span>&nbsp;<span class="op" id="4961878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4961881">b</span>&nbsp;<span class="op" id="4961883">:=</span>&nbsp;<span class="ident" id="4961886">v</span><span class="op" id="4961887">.</span><span class="ident" id="4961888">Bool</span><span class="op" id="4961892">(</span><span class="op" id="4961893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4961896">if</span>&nbsp;<span class="ident" id="4961899">b</span>&nbsp;<span class="op" id="4961901">||</span>&nbsp;<span class="ident" id="4961904">state</span><span class="op" id="4961909">.</span><span class="ident" id="4961910">sendZero</span>&nbsp;<span class="op" id="4961919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4961923">state</span><span class="op" id="4961928">.</span><span class="ident" id="4961929">update</span><span class="op" id="4961935">(</span><span class="ident" id="4961936">i</span><span class="op" id="4961937">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4961941">if</span>&nbsp;<span class="ident" id="4961944">b</span>&nbsp;<span class="op" id="4961946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4961951">state</span><span class="op" id="4961956">.</span><span class="ident" id="4961957">encodeUint</span><span class="op" id="4961967">(</span><span class="num" id="4961968">1</span><span class="op" id="4961969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4961973">}</span>&nbsp;<span class="keyword" id="4961975">else</span>&nbsp;<span class="op" id="4961980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4961985">state</span><span class="op" id="4961990">.</span><span class="ident" id="4961991">encodeUint</span><span class="op" id="4962001">(</span><span class="num" id="4962002">0</span><span class="op" id="4962003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4962007">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4962010">}</span><br>
<span class="lineno"></span><span class="op" id="4962012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4962015">//&nbsp;encInt&nbsp;encodes&nbsp;the&nbsp;signed&nbsp;integer&nbsp;(int&nbsp;int8&nbsp;int16&nbsp;int32&nbsp;int64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="4962098">func</span>&nbsp;<span class="ident" id="4962103">encInt</span><span class="op" id="4962109">(</span><span class="ident" id="4962110">i</span>&nbsp;<span class="op" id="4962112">*</span><span class="ident" id="4962113">encInstr</span><span class="op" id="4962121">,</span>&nbsp;<span class="ident" id="4962123">state</span>&nbsp;<span class="op" id="4962129">*</span><span class="ident" id="4962130">encoderState</span><span class="op" id="4962142">,</span>&nbsp;<span class="ident" id="4962144">v</span>&nbsp;<span class="ident" id="4962146">reflect</span><span class="op" id="4962153">.</span><span class="ident" id="4962154">Value</span><span class="op" id="4962159">)</span>&nbsp;<span class="op" id="4962161">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4962164">value</span>&nbsp;<span class="op" id="4962170">:=</span>&nbsp;<span class="ident" id="4962173">v</span><span class="op" id="4962174">.</span><span class="ident" id="4962175">Int</span><span class="op" id="4962178">(</span><span class="op" id="4962179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4962182">if</span>&nbsp;<span class="ident" id="4962185">value</span>&nbsp;<span class="op" id="4962191">!=</span>&nbsp;<span class="num" id="4962194">0</span>&nbsp;<span class="op" id="4962196">||</span>&nbsp;<span class="ident" id="4962199">state</span><span class="op" id="4962204">.</span><span class="ident" id="4962205">sendZero</span>&nbsp;<span class="op" id="4962214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4962218">state</span><span class="op" id="4962223">.</span><span class="ident" id="4962224">update</span><span class="op" id="4962230">(</span><span class="ident" id="4962231">i</span><span class="op" id="4962232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4962236">state</span><span class="op" id="4962241">.</span><span class="ident" id="4962242">encodeInt</span><span class="op" id="4962251">(</span><span class="ident" id="4962252">value</span><span class="op" id="4962257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4962260">}</span><br>
<span class="lineno">180</span><span class="op" id="4962262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4962265">//&nbsp;encUint&nbsp;encodes&nbsp;the&nbsp;unsigned&nbsp;integer&nbsp;(uint&nbsp;uint8&nbsp;uint16&nbsp;uint32&nbsp;uint64&nbsp;uintptr)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="4962364">func</span>&nbsp;<span class="ident" id="4962369">encUint</span><span class="op" id="4962376">(</span><span class="ident" id="4962377">i</span>&nbsp;<span class="op" id="4962379">*</span><span class="ident" id="4962380">encInstr</span><span class="op" id="4962388">,</span>&nbsp;<span class="ident" id="4962390">state</span>&nbsp;<span class="op" id="4962396">*</span><span class="ident" id="4962397">encoderState</span><span class="op" id="4962409">,</span>&nbsp;<span class="ident" id="4962411">v</span>&nbsp;<span class="ident" id="4962413">reflect</span><span class="op" id="4962420">.</span><span class="ident" id="4962421">Value</span><span class="op" id="4962426">)</span>&nbsp;<span class="op" id="4962428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4962431">value</span>&nbsp;<span class="op" id="4962437">:=</span>&nbsp;<span class="ident" id="4962440">v</span><span class="op" id="4962441">.</span><span class="ident" id="4962442">Uint</span><span class="op" id="4962446">(</span><span class="op" id="4962447">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4962450">if</span>&nbsp;<span class="ident" id="4962453">value</span>&nbsp;<span class="op" id="4962459">!=</span>&nbsp;<span class="num" id="4962462">0</span>&nbsp;<span class="op" id="4962464">||</span>&nbsp;<span class="ident" id="4962467">state</span><span class="op" id="4962472">.</span><span class="ident" id="4962473">sendZero</span>&nbsp;<span class="op" id="4962482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4962486">state</span><span class="op" id="4962491">.</span><span class="ident" id="4962492">update</span><span class="op" id="4962498">(</span><span class="ident" id="4962499">i</span><span class="op" id="4962500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4962504">state</span><span class="op" id="4962509">.</span><span class="ident" id="4962510">encodeUint</span><span class="op" id="4962520">(</span><span class="ident" id="4962521">value</span><span class="op" id="4962526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4962529">}</span><br>
<span class="lineno"></span><span class="op" id="4962531">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="4962534">//&nbsp;floatBits&nbsp;returns&nbsp;a&nbsp;uint64&nbsp;holding&nbsp;the&nbsp;bits&nbsp;of&nbsp;a&nbsp;floating-point&nbsp;number.</span><br>
<span class="lineno"></span><span class="comment" id="4962609">//&nbsp;Floating-point&nbsp;numbers&nbsp;are&nbsp;transmitted&nbsp;as&nbsp;uint64s&nbsp;holding&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="4962679">//&nbsp;of&nbsp;the&nbsp;underlying&nbsp;representation.&nbsp;&nbsp;They&nbsp;are&nbsp;sent&nbsp;byte-reversed,&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="4962751">//&nbsp;the&nbsp;exponent&nbsp;end&nbsp;coming&nbsp;out&nbsp;first,&nbsp;so&nbsp;integer&nbsp;floating&nbsp;point&nbsp;numbers</span><br>
<span class="lineno">195</span><span class="comment" id="4962823">//&nbsp;(for&nbsp;example)&nbsp;transmit&nbsp;more&nbsp;compactly.&nbsp;&nbsp;This&nbsp;routine&nbsp;does&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4962888">//&nbsp;swizzling.</span><br>
<span class="lineno"></span><span class="keyword" id="4962902">func</span>&nbsp;<span class="ident" id="4962907">floatBits</span><span class="op" id="4962916">(</span><span class="ident" id="4962917">f</span>&nbsp;<span class="builtintype" id="4962919">float64</span><span class="op" id="4962926">)</span>&nbsp;<span class="ident" id="4962928">uint64</span>&nbsp;<span class="op" id="4962935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4962938">u</span>&nbsp;<span class="op" id="4962940">:=</span>&nbsp;<span class="ident" id="4962943">math</span><span class="op" id="4962947">.</span><span class="ident" id="4962948">Float64bits</span><span class="op" id="4962959">(</span><span class="ident" id="4962960">f</span><span class="op" id="4962961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4962964">var</span>&nbsp;<span class="ident" id="4962968">v</span>&nbsp;<span class="ident" id="4962970">uint64</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4962978">for</span>&nbsp;<span class="ident" id="4962982">i</span>&nbsp;<span class="op" id="4962984">:=</span>&nbsp;<span class="num" id="4962987">0</span><span class="op" id="4962988">;</span>&nbsp;<span class="ident" id="4962990">i</span>&nbsp;<span class="op" id="4962992">&lt;</span>&nbsp;<span class="num" id="4962994">8</span><span class="op" id="4962995">;</span>&nbsp;<span class="ident" id="4962997">i</span><span class="op" id="4962998">++</span>&nbsp;<span class="op" id="4963001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4963005">v</span>&nbsp;<span class="op" id="4963007">&lt;&lt;=</span>&nbsp;<span class="num" id="4963011">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4963015">v</span>&nbsp;<span class="op" id="4963017">|=</span>&nbsp;<span class="ident" id="4963020">u</span>&nbsp;<span class="op" id="4963022">&amp;</span>&nbsp;<span class="num" id="4963024">0xFF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4963031">u</span>&nbsp;<span class="op" id="4963033">&gt;&gt;=</span>&nbsp;<span class="num" id="4963037">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4963040">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4963043">return</span>&nbsp;<span class="ident" id="4963050">v</span><br>
<span class="lineno"></span><span class="op" id="4963052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4963055">//&nbsp;encFloat&nbsp;encodes&nbsp;the&nbsp;floating&nbsp;point&nbsp;value&nbsp;(float32&nbsp;float64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="4963135">func</span>&nbsp;<span class="ident" id="4963140">encFloat</span><span class="op" id="4963148">(</span><span class="ident" id="4963149">i</span>&nbsp;<span class="op" id="4963151">*</span><span class="ident" id="4963152">encInstr</span><span class="op" id="4963160">,</span>&nbsp;<span class="ident" id="4963162">state</span>&nbsp;<span class="op" id="4963168">*</span><span class="ident" id="4963169">encoderState</span><span class="op" id="4963181">,</span>&nbsp;<span class="ident" id="4963183">v</span>&nbsp;<span class="ident" id="4963185">reflect</span><span class="op" id="4963192">.</span><span class="ident" id="4963193">Value</span><span class="op" id="4963198">)</span>&nbsp;<span class="op" id="4963200">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4963203">f</span>&nbsp;<span class="op" id="4963205">:=</span>&nbsp;<span class="ident" id="4963208">v</span><span class="op" id="4963209">.</span><span class="ident" id="4963210">Float</span><span class="op" id="4963215">(</span><span class="op" id="4963216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4963219">if</span>&nbsp;<span class="ident" id="4963222">f</span>&nbsp;<span class="op" id="4963224">!=</span>&nbsp;<span class="num" id="4963227">0</span>&nbsp;<span class="op" id="4963229">||</span>&nbsp;<span class="ident" id="4963232">state</span><span class="op" id="4963237">.</span><span class="ident" id="4963238">sendZero</span>&nbsp;<span class="op" id="4963247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4963251">bits</span>&nbsp;<span class="op" id="4963256">:=</span>&nbsp;<span class="ident" id="4963259">floatBits</span><span class="op" id="4963268">(</span><span class="ident" id="4963269">f</span><span class="op" id="4963270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4963274">state</span><span class="op" id="4963279">.</span><span class="ident" id="4963280">update</span><span class="op" id="4963286">(</span><span class="ident" id="4963287">i</span><span class="op" id="4963288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4963292">state</span><span class="op" id="4963297">.</span><span class="ident" id="4963298">encodeUint</span><span class="op" id="4963308">(</span><span class="ident" id="4963309">bits</span><span class="op" id="4963313">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4963316">}</span><br>
<span class="lineno"></span><span class="op" id="4963318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4963321">//&nbsp;encComplex&nbsp;encodes&nbsp;the&nbsp;complex&nbsp;value&nbsp;(complex64&nbsp;complex128)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="4963401">//&nbsp;Complex&nbsp;numbers&nbsp;are&nbsp;just&nbsp;a&nbsp;pair&nbsp;of&nbsp;floating-point&nbsp;numbers,&nbsp;real&nbsp;part&nbsp;first.</span><br>
<span class="lineno">220</span><span class="keyword" id="4963480">func</span>&nbsp;<span class="ident" id="4963485">encComplex</span><span class="op" id="4963495">(</span><span class="ident" id="4963496">i</span>&nbsp;<span class="op" id="4963498">*</span><span class="ident" id="4963499">encInstr</span><span class="op" id="4963507">,</span>&nbsp;<span class="ident" id="4963509">state</span>&nbsp;<span class="op" id="4963515">*</span><span class="ident" id="4963516">encoderState</span><span class="op" id="4963528">,</span>&nbsp;<span class="ident" id="4963530">v</span>&nbsp;<span class="ident" id="4963532">reflect</span><span class="op" id="4963539">.</span><span class="ident" id="4963540">Value</span><span class="op" id="4963545">)</span>&nbsp;<span class="op" id="4963547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4963550">c</span>&nbsp;<span class="op" id="4963552">:=</span>&nbsp;<span class="ident" id="4963555">v</span><span class="op" id="4963556">.</span><span class="ident" id="4963557">Complex</span><span class="op" id="4963564">(</span><span class="op" id="4963565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4963568">if</span>&nbsp;<span class="ident" id="4963571">c</span>&nbsp;<span class="op" id="4963573">!=</span>&nbsp;<span class="num" id="4963576">0</span><span class="op" id="4963577">+</span><span class="num" id="4963578">0i</span>&nbsp;<span class="op" id="4963581">||</span>&nbsp;<span class="ident" id="4963584">state</span><span class="op" id="4963589">.</span><span class="ident" id="4963590">sendZero</span>&nbsp;<span class="op" id="4963599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4963603">rpart</span>&nbsp;<span class="op" id="4963609">:=</span>&nbsp;<span class="ident" id="4963612">floatBits</span><span class="op" id="4963621">(</span><span class="builtinfunc" id="4963622">real</span><span class="op" id="4963626">(</span><span class="ident" id="4963627">c</span><span class="op" id="4963628">)</span><span class="op" id="4963629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4963633">ipart</span>&nbsp;<span class="op" id="4963639">:=</span>&nbsp;<span class="ident" id="4963642">floatBits</span><span class="op" id="4963651">(</span><span class="builtinfunc" id="4963652">imag</span><span class="op" id="4963656">(</span><span class="ident" id="4963657">c</span><span class="op" id="4963658">)</span><span class="op" id="4963659">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4963663">state</span><span class="op" id="4963668">.</span><span class="ident" id="4963669">update</span><span class="op" id="4963675">(</span><span class="ident" id="4963676">i</span><span class="op" id="4963677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4963681">state</span><span class="op" id="4963686">.</span><span class="ident" id="4963687">encodeUint</span><span class="op" id="4963697">(</span><span class="ident" id="4963698">rpart</span><span class="op" id="4963703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4963707">state</span><span class="op" id="4963712">.</span><span class="ident" id="4963713">encodeUint</span><span class="op" id="4963723">(</span><span class="ident" id="4963724">ipart</span><span class="op" id="4963729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4963732">}</span><br>
<span class="lineno"></span><span class="op" id="4963734">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="4963737">//&nbsp;encUint8Array&nbsp;encodes&nbsp;the&nbsp;byte&nbsp;array&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="4963794">//&nbsp;Byte&nbsp;arrays&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4963869">func</span>&nbsp;<span class="ident" id="4963874">encUint8Array</span><span class="op" id="4963887">(</span><span class="ident" id="4963888">i</span>&nbsp;<span class="op" id="4963890">*</span><span class="ident" id="4963891">encInstr</span><span class="op" id="4963899">,</span>&nbsp;<span class="ident" id="4963901">state</span>&nbsp;<span class="op" id="4963907">*</span><span class="ident" id="4963908">encoderState</span><span class="op" id="4963920">,</span>&nbsp;<span class="ident" id="4963922">v</span>&nbsp;<span class="ident" id="4963924">reflect</span><span class="op" id="4963931">.</span><span class="ident" id="4963932">Value</span><span class="op" id="4963937">)</span>&nbsp;<span class="op" id="4963939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4963942">b</span>&nbsp;<span class="op" id="4963944">:=</span>&nbsp;<span class="ident" id="4963947">v</span><span class="op" id="4963948">.</span><span class="ident" id="4963949">Bytes</span><span class="op" id="4963954">(</span><span class="op" id="4963955">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4963958">if</span>&nbsp;<span class="builtinfunc" id="4963961">len</span><span class="op" id="4963964">(</span><span class="ident" id="4963965">b</span><span class="op" id="4963966">)</span>&nbsp;<span class="op" id="4963968">&gt;</span>&nbsp;<span class="num" id="4963970">0</span>&nbsp;<span class="op" id="4963972">||</span>&nbsp;<span class="ident" id="4963975">state</span><span class="op" id="4963980">.</span><span class="ident" id="4963981">sendZero</span>&nbsp;<span class="op" id="4963990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4963994">state</span><span class="op" id="4963999">.</span><span class="ident" id="4964000">update</span><span class="op" id="4964006">(</span><span class="ident" id="4964007">i</span><span class="op" id="4964008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4964012">state</span><span class="op" id="4964017">.</span><span class="ident" id="4964018">encodeUint</span><span class="op" id="4964028">(</span><span class="ident" id="4964029">uint64</span><span class="op" id="4964035">(</span><span class="builtinfunc" id="4964036">len</span><span class="op" id="4964039">(</span><span class="ident" id="4964040">b</span><span class="op" id="4964041">)</span><span class="op" id="4964042">)</span><span class="op" id="4964043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4964047">state</span><span class="op" id="4964052">.</span><span class="ident" id="4964053">b</span><span class="op" id="4964054">.</span><span class="ident" id="4964055">Write</span><span class="op" id="4964060">(</span><span class="ident" id="4964061">b</span><span class="op" id="4964062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4964065">}</span><br>
<span class="lineno">240</span><span class="op" id="4964067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4964070">//&nbsp;encString&nbsp;encodes&nbsp;the&nbsp;string&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="4964119">//&nbsp;Strings&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4964190">func</span>&nbsp;<span class="ident" id="4964195">encString</span><span class="op" id="4964204">(</span><span class="ident" id="4964205">i</span>&nbsp;<span class="op" id="4964207">*</span><span class="ident" id="4964208">encInstr</span><span class="op" id="4964216">,</span>&nbsp;<span class="ident" id="4964218">state</span>&nbsp;<span class="op" id="4964224">*</span><span class="ident" id="4964225">encoderState</span><span class="op" id="4964237">,</span>&nbsp;<span class="ident" id="4964239">v</span>&nbsp;<span class="ident" id="4964241">reflect</span><span class="op" id="4964248">.</span><span class="ident" id="4964249">Value</span><span class="op" id="4964254">)</span>&nbsp;<span class="op" id="4964256">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4964259">s</span>&nbsp;<span class="op" id="4964261">:=</span>&nbsp;<span class="ident" id="4964264">v</span><span class="op" id="4964265">.</span><span class="ident" id="4964266">String</span><span class="op" id="4964272">(</span><span class="op" id="4964273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4964276">if</span>&nbsp;<span class="builtinfunc" id="4964279">len</span><span class="op" id="4964282">(</span><span class="ident" id="4964283">s</span><span class="op" id="4964284">)</span>&nbsp;<span class="op" id="4964286">&gt;</span>&nbsp;<span class="num" id="4964288">0</span>&nbsp;<span class="op" id="4964290">||</span>&nbsp;<span class="ident" id="4964293">state</span><span class="op" id="4964298">.</span><span class="ident" id="4964299">sendZero</span>&nbsp;<span class="op" id="4964308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4964312">state</span><span class="op" id="4964317">.</span><span class="ident" id="4964318">update</span><span class="op" id="4964324">(</span><span class="ident" id="4964325">i</span><span class="op" id="4964326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4964330">state</span><span class="op" id="4964335">.</span><span class="ident" id="4964336">encodeUint</span><span class="op" id="4964346">(</span><span class="ident" id="4964347">uint64</span><span class="op" id="4964353">(</span><span class="builtinfunc" id="4964354">len</span><span class="op" id="4964357">(</span><span class="ident" id="4964358">s</span><span class="op" id="4964359">)</span><span class="op" id="4964360">)</span><span class="op" id="4964361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4964365">state</span><span class="op" id="4964370">.</span><span class="ident" id="4964371">b</span><span class="op" id="4964372">.</span><span class="ident" id="4964373">WriteString</span><span class="op" id="4964384">(</span><span class="ident" id="4964385">s</span><span class="op" id="4964386">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4964389">}</span><br>
<span class="lineno"></span><span class="op" id="4964391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4964394">//&nbsp;encStructTerminator&nbsp;encodes&nbsp;the&nbsp;end&nbsp;of&nbsp;an&nbsp;encoded&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="4964454">//&nbsp;as&nbsp;delta&nbsp;field&nbsp;number&nbsp;of&nbsp;0.</span><br>
<span class="lineno">255</span><span class="keyword" id="4964485">func</span>&nbsp;<span class="ident" id="4964490">encStructTerminator</span><span class="op" id="4964509">(</span><span class="ident" id="4964510">i</span>&nbsp;<span class="op" id="4964512">*</span><span class="ident" id="4964513">encInstr</span><span class="op" id="4964521">,</span>&nbsp;<span class="ident" id="4964523">state</span>&nbsp;<span class="op" id="4964529">*</span><span class="ident" id="4964530">encoderState</span><span class="op" id="4964542">,</span>&nbsp;<span class="ident" id="4964544">v</span>&nbsp;<span class="ident" id="4964546">reflect</span><span class="op" id="4964553">.</span><span class="ident" id="4964554">Value</span><span class="op" id="4964559">)</span>&nbsp;<span class="op" id="4964561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4964564">state</span><span class="op" id="4964569">.</span><span class="ident" id="4964570">encodeUint</span><span class="op" id="4964580">(</span><span class="num" id="4964581">0</span><span class="op" id="4964582">)</span><br>
<span class="lineno"></span><span class="op" id="4964584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4964587">//&nbsp;Execution&nbsp;engine</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="4964608">//&nbsp;encEngine&nbsp;an&nbsp;array&nbsp;of&nbsp;instructions&nbsp;indexed&nbsp;by&nbsp;field&nbsp;number&nbsp;of&nbsp;the&nbsp;encoding</span><br>
<span class="lineno"></span><span class="comment" id="4964686">//&nbsp;data,&nbsp;typically&nbsp;a&nbsp;struct.&nbsp;&nbsp;It&nbsp;is&nbsp;executed&nbsp;top&nbsp;to&nbsp;bottom,&nbsp;walking&nbsp;the&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="4964766">type</span>&nbsp;<span class="ident" id="4964771">encEngine</span>&nbsp;<span class="keyword" id="4964781">struct</span>&nbsp;<span class="op" id="4964788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4964791">instr</span>&nbsp;<span class="op" id="4964797">[</span><span class="op" id="4964798">]</span><span class="ident" id="4964799">encInstr</span><br>
<span class="lineno">265</span><span class="op" id="4964808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4964811">const</span>&nbsp;<span class="ident" id="4964817">singletonField</span>&nbsp;<span class="op" id="4964832">=</span>&nbsp;<span class="num" id="4964834">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4964837">//&nbsp;valid&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;valid&nbsp;and&nbsp;a&nbsp;non-nil&nbsp;pointer.</span><br>
<span class="lineno">270</span><span class="comment" id="4964904">//&nbsp;(Slices,&nbsp;maps,&nbsp;and&nbsp;chans&nbsp;take&nbsp;care&nbsp;of&nbsp;themselves.)</span><br>
<span class="lineno"></span><span class="keyword" id="4964958">func</span>&nbsp;<span class="ident" id="4964963">valid</span><span class="op" id="4964968">(</span><span class="ident" id="4964969">v</span>&nbsp;<span class="ident" id="4964971">reflect</span><span class="op" id="4964978">.</span><span class="ident" id="4964979">Value</span><span class="op" id="4964984">)</span>&nbsp;<span class="builtintype" id="4964986">bool</span>&nbsp;<span class="op" id="4964991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4964994">switch</span>&nbsp;<span class="ident" id="4965001">v</span><span class="op" id="4965002">.</span><span class="ident" id="4965003">Kind</span><span class="op" id="4965007">(</span><span class="op" id="4965008">)</span>&nbsp;<span class="op" id="4965010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4965013">case</span>&nbsp;<span class="ident" id="4965018">reflect</span><span class="op" id="4965025">.</span><span class="ident" id="4965026">Invalid</span><span class="op" id="4965033">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4965037">return</span>&nbsp;<span class="builtintype" id="4965044">false</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4965051">case</span>&nbsp;<span class="ident" id="4965056">reflect</span><span class="op" id="4965063">.</span><span class="ident" id="4965064">Ptr</span><span class="op" id="4965067">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4965071">return</span>&nbsp;<span class="op" id="4965078">!</span><span class="ident" id="4965079">v</span><span class="op" id="4965080">.</span><span class="ident" id="4965081">IsNil</span><span class="op" id="4965086">(</span><span class="op" id="4965087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4965090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4965093">return</span>&nbsp;<span class="builtintype" id="4965100">true</span><br>
<span class="lineno"></span><span class="op" id="4965105">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="4965108">//&nbsp;encodeSingle&nbsp;encodes&nbsp;a&nbsp;single&nbsp;top-level&nbsp;non-struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4965169">func</span>&nbsp;<span class="op" id="4965174">(</span><span class="ident" id="4965175">enc</span>&nbsp;<span class="op" id="4965179">*</span><span class="ident" id="4965180">Encoder</span><span class="op" id="4965187">)</span>&nbsp;<span class="ident" id="4965189">encodeSingle</span><span class="op" id="4965201">(</span><span class="ident" id="4965202">b</span>&nbsp;<span class="op" id="4965204">*</span><span class="ident" id="4965205">encBuffer</span><span class="op" id="4965214">,</span>&nbsp;<span class="ident" id="4965216">engine</span>&nbsp;<span class="op" id="4965223">*</span><span class="ident" id="4965224">encEngine</span><span class="op" id="4965233">,</span>&nbsp;<span class="ident" id="4965235">value</span>&nbsp;<span class="ident" id="4965241">reflect</span><span class="op" id="4965248">.</span><span class="ident" id="4965249">Value</span><span class="op" id="4965254">)</span>&nbsp;<span class="op" id="4965256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4965259">state</span>&nbsp;<span class="op" id="4965265">:=</span>&nbsp;<span class="ident" id="4965268">enc</span><span class="op" id="4965271">.</span><span class="ident" id="4965272">newEncoderState</span><span class="op" id="4965287">(</span><span class="ident" id="4965288">b</span><span class="op" id="4965289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4965292">defer</span>&nbsp;<span class="ident" id="4965298">enc</span><span class="op" id="4965301">.</span><span class="ident" id="4965302">freeEncoderState</span><span class="op" id="4965318">(</span><span class="ident" id="4965319">state</span><span class="op" id="4965324">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4965327">state</span><span class="op" id="4965332">.</span><span class="ident" id="4965333">fieldnum</span>&nbsp;<span class="op" id="4965342">=</span>&nbsp;<span class="ident" id="4965344">singletonField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4965360">//&nbsp;There&nbsp;is&nbsp;no&nbsp;surrounding&nbsp;struct&nbsp;to&nbsp;frame&nbsp;the&nbsp;transmission,&nbsp;so&nbsp;we&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4965433">//&nbsp;generate&nbsp;data&nbsp;even&nbsp;if&nbsp;the&nbsp;item&nbsp;is&nbsp;zero.&nbsp;&nbsp;To&nbsp;do&nbsp;this,&nbsp;set&nbsp;sendZero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4965504">state</span><span class="op" id="4965509">.</span><span class="ident" id="4965510">sendZero</span>&nbsp;<span class="op" id="4965519">=</span>&nbsp;<span class="builtintype" id="4965521">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4965527">instr</span>&nbsp;<span class="op" id="4965533">:=</span>&nbsp;<span class="op" id="4965536">&amp;</span><span class="ident" id="4965537">engine</span><span class="op" id="4965543">.</span><span class="ident" id="4965544">instr</span><span class="op" id="4965549">[</span><span class="ident" id="4965550">singletonField</span><span class="op" id="4965564">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4965567">if</span>&nbsp;<span class="ident" id="4965570">instr</span><span class="op" id="4965575">.</span><span class="ident" id="4965576">indir</span>&nbsp;<span class="op" id="4965582">&gt;</span>&nbsp;<span class="num" id="4965584">0</span>&nbsp;<span class="op" id="4965586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4965590">value</span>&nbsp;<span class="op" id="4965596">=</span>&nbsp;<span class="ident" id="4965598">encIndirect</span><span class="op" id="4965609">(</span><span class="ident" id="4965610">value</span><span class="op" id="4965615">,</span>&nbsp;<span class="ident" id="4965617">instr</span><span class="op" id="4965622">.</span><span class="ident" id="4965623">indir</span><span class="op" id="4965628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4965631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4965634">if</span>&nbsp;<span class="ident" id="4965637">valid</span><span class="op" id="4965642">(</span><span class="ident" id="4965643">value</span><span class="op" id="4965648">)</span>&nbsp;<span class="op" id="4965650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4965654">instr</span><span class="op" id="4965659">.</span><span class="ident" id="4965660">op</span><span class="op" id="4965662">(</span><span class="ident" id="4965663">instr</span><span class="op" id="4965668">,</span>&nbsp;<span class="ident" id="4965670">state</span><span class="op" id="4965675">,</span>&nbsp;<span class="ident" id="4965677">value</span><span class="op" id="4965682">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4965685">}</span><br>
<span class="lineno"></span><span class="op" id="4965687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4965690">//&nbsp;encodeStruct&nbsp;encodes&nbsp;a&nbsp;single&nbsp;struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4965737">func</span>&nbsp;<span class="op" id="4965742">(</span><span class="ident" id="4965743">enc</span>&nbsp;<span class="op" id="4965747">*</span><span class="ident" id="4965748">Encoder</span><span class="op" id="4965755">)</span>&nbsp;<span class="ident" id="4965757">encodeStruct</span><span class="op" id="4965769">(</span><span class="ident" id="4965770">b</span>&nbsp;<span class="op" id="4965772">*</span><span class="ident" id="4965773">encBuffer</span><span class="op" id="4965782">,</span>&nbsp;<span class="ident" id="4965784">engine</span>&nbsp;<span class="op" id="4965791">*</span><span class="ident" id="4965792">encEngine</span><span class="op" id="4965801">,</span>&nbsp;<span class="ident" id="4965803">value</span>&nbsp;<span class="ident" id="4965809">reflect</span><span class="op" id="4965816">.</span><span class="ident" id="4965817">Value</span><span class="op" id="4965822">)</span>&nbsp;<span class="op" id="4965824">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4965827">if</span>&nbsp;<span class="op" id="4965830">!</span><span class="ident" id="4965831">valid</span><span class="op" id="4965836">(</span><span class="ident" id="4965837">value</span><span class="op" id="4965842">)</span>&nbsp;<span class="op" id="4965844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4965848">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4965856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4965859">state</span>&nbsp;<span class="op" id="4965865">:=</span>&nbsp;<span class="ident" id="4965868">enc</span><span class="op" id="4965871">.</span><span class="ident" id="4965872">newEncoderState</span><span class="op" id="4965887">(</span><span class="ident" id="4965888">b</span><span class="op" id="4965889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4965892">defer</span>&nbsp;<span class="ident" id="4965898">enc</span><span class="op" id="4965901">.</span><span class="ident" id="4965902">freeEncoderState</span><span class="op" id="4965918">(</span><span class="ident" id="4965919">state</span><span class="op" id="4965924">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4965927">state</span><span class="op" id="4965932">.</span><span class="ident" id="4965933">fieldnum</span>&nbsp;<span class="op" id="4965942">=</span>&nbsp;<span class="op" id="4965944">-</span><span class="num" id="4965945">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4965948">for</span>&nbsp;<span class="ident" id="4965952">i</span>&nbsp;<span class="op" id="4965954">:=</span>&nbsp;<span class="num" id="4965957">0</span><span class="op" id="4965958">;</span>&nbsp;<span class="ident" id="4965960">i</span>&nbsp;<span class="op" id="4965962">&lt;</span>&nbsp;<span class="builtinfunc" id="4965964">len</span><span class="op" id="4965967">(</span><span class="ident" id="4965968">engine</span><span class="op" id="4965974">.</span><span class="ident" id="4965975">instr</span><span class="op" id="4965980">)</span><span class="op" id="4965981">;</span>&nbsp;<span class="ident" id="4965983">i</span><span class="op" id="4965984">++</span>&nbsp;<span class="op" id="4965987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4965991">instr</span>&nbsp;<span class="op" id="4965997">:=</span>&nbsp;<span class="op" id="4966000">&amp;</span><span class="ident" id="4966001">engine</span><span class="op" id="4966007">.</span><span class="ident" id="4966008">instr</span><span class="op" id="4966013">[</span><span class="ident" id="4966014">i</span><span class="op" id="4966015">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4966019">if</span>&nbsp;<span class="ident" id="4966022">i</span>&nbsp;<span class="op" id="4966024">&gt;=</span>&nbsp;<span class="ident" id="4966027">value</span><span class="op" id="4966032">.</span><span class="ident" id="4966033">NumField</span><span class="op" id="4966041">(</span><span class="op" id="4966042">)</span>&nbsp;<span class="op" id="4966044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4966049">//&nbsp;encStructTerminator</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4966075">instr</span><span class="op" id="4966080">.</span><span class="ident" id="4966081">op</span><span class="op" id="4966083">(</span><span class="ident" id="4966084">instr</span><span class="op" id="4966089">,</span>&nbsp;<span class="ident" id="4966091">state</span><span class="op" id="4966096">,</span>&nbsp;<span class="ident" id="4966098">reflect</span><span class="op" id="4966105">.</span><span class="ident" id="4966106">Value</span><span class="op" id="4966111">{</span><span class="op" id="4966112">}</span><span class="op" id="4966113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4966118">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4966126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4966130">field</span>&nbsp;<span class="op" id="4966136">:=</span>&nbsp;<span class="ident" id="4966139">value</span><span class="op" id="4966144">.</span><span class="ident" id="4966145">FieldByIndex</span><span class="op" id="4966157">(</span><span class="ident" id="4966158">instr</span><span class="op" id="4966163">.</span><span class="ident" id="4966164">index</span><span class="op" id="4966169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4966173">if</span>&nbsp;<span class="ident" id="4966176">instr</span><span class="op" id="4966181">.</span><span class="ident" id="4966182">indir</span>&nbsp;<span class="op" id="4966188">&gt;</span>&nbsp;<span class="num" id="4966190">0</span>&nbsp;<span class="op" id="4966192">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4966197">field</span>&nbsp;<span class="op" id="4966203">=</span>&nbsp;<span class="ident" id="4966205">encIndirect</span><span class="op" id="4966216">(</span><span class="ident" id="4966217">field</span><span class="op" id="4966222">,</span>&nbsp;<span class="ident" id="4966224">instr</span><span class="op" id="4966229">.</span><span class="ident" id="4966230">indir</span><span class="op" id="4966235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4966240">//&nbsp;TODO:&nbsp;Is&nbsp;field&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4966312">if</span>&nbsp;<span class="op" id="4966315">!</span><span class="ident" id="4966316">valid</span><span class="op" id="4966321">(</span><span class="ident" id="4966322">field</span><span class="op" id="4966327">)</span>&nbsp;<span class="op" id="4966329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4966335">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4966347">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4966351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4966355">instr</span><span class="op" id="4966360">.</span><span class="ident" id="4966361">op</span><span class="op" id="4966363">(</span><span class="ident" id="4966364">instr</span><span class="op" id="4966369">,</span>&nbsp;<span class="ident" id="4966371">state</span><span class="op" id="4966376">,</span>&nbsp;<span class="ident" id="4966378">field</span><span class="op" id="4966383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4966386">}</span><br>
<span class="lineno"></span><span class="op" id="4966388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="4966391">//&nbsp;encodeArray&nbsp;encodes&nbsp;an&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="4966424">func</span>&nbsp;<span class="op" id="4966429">(</span><span class="ident" id="4966430">enc</span>&nbsp;<span class="op" id="4966434">*</span><span class="ident" id="4966435">Encoder</span><span class="op" id="4966442">)</span>&nbsp;<span class="ident" id="4966444">encodeArray</span><span class="op" id="4966455">(</span><span class="ident" id="4966456">b</span>&nbsp;<span class="op" id="4966458">*</span><span class="ident" id="4966459">encBuffer</span><span class="op" id="4966468">,</span>&nbsp;<span class="ident" id="4966470">value</span>&nbsp;<span class="ident" id="4966476">reflect</span><span class="op" id="4966483">.</span><span class="ident" id="4966484">Value</span><span class="op" id="4966489">,</span>&nbsp;<span class="ident" id="4966491">op</span>&nbsp;<span class="ident" id="4966494">encOp</span><span class="op" id="4966499">,</span>&nbsp;<span class="ident" id="4966501">elemIndir</span>&nbsp;<span class="builtintype" id="4966511">int</span><span class="op" id="4966514">,</span>&nbsp;<span class="ident" id="4966516">length</span>&nbsp;<span class="builtintype" id="4966523">int</span><span class="op" id="4966526">,</span>&nbsp;<span class="ident" id="4966528">helper</span>&nbsp;<span class="ident" id="4966535">encHelper</span><span class="op" id="4966544">)</span>&nbsp;<span class="op" id="4966546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4966549">state</span>&nbsp;<span class="op" id="4966555">:=</span>&nbsp;<span class="ident" id="4966558">enc</span><span class="op" id="4966561">.</span><span class="ident" id="4966562">newEncoderState</span><span class="op" id="4966577">(</span><span class="ident" id="4966578">b</span><span class="op" id="4966579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4966582">defer</span>&nbsp;<span class="ident" id="4966588">enc</span><span class="op" id="4966591">.</span><span class="ident" id="4966592">freeEncoderState</span><span class="op" id="4966608">(</span><span class="ident" id="4966609">state</span><span class="op" id="4966614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4966617">state</span><span class="op" id="4966622">.</span><span class="ident" id="4966623">fieldnum</span>&nbsp;<span class="op" id="4966632">=</span>&nbsp;<span class="op" id="4966634">-</span><span class="num" id="4966635">1</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4966638">state</span><span class="op" id="4966643">.</span><span class="ident" id="4966644">sendZero</span>&nbsp;<span class="op" id="4966653">=</span>&nbsp;<span class="builtintype" id="4966655">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4966661">state</span><span class="op" id="4966666">.</span><span class="ident" id="4966667">encodeUint</span><span class="op" id="4966677">(</span><span class="ident" id="4966678">uint64</span><span class="op" id="4966684">(</span><span class="ident" id="4966685">length</span><span class="op" id="4966691">)</span><span class="op" id="4966692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4966695">if</span>&nbsp;<span class="ident" id="4966698">helper</span>&nbsp;<span class="op" id="4966705">!=</span>&nbsp;<span class="ident" id="4966708">nil</span>&nbsp;<span class="op" id="4966712">&amp;&amp;</span>&nbsp;<span class="ident" id="4966715">helper</span><span class="op" id="4966721">(</span><span class="ident" id="4966722">state</span><span class="op" id="4966727">,</span>&nbsp;<span class="ident" id="4966729">value</span><span class="op" id="4966734">)</span>&nbsp;<span class="op" id="4966736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4966740">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4966748">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4966751">for</span>&nbsp;<span class="ident" id="4966755">i</span>&nbsp;<span class="op" id="4966757">:=</span>&nbsp;<span class="num" id="4966760">0</span><span class="op" id="4966761">;</span>&nbsp;<span class="ident" id="4966763">i</span>&nbsp;<span class="op" id="4966765">&lt;</span>&nbsp;<span class="ident" id="4966767">length</span><span class="op" id="4966773">;</span>&nbsp;<span class="ident" id="4966775">i</span><span class="op" id="4966776">++</span>&nbsp;<span class="op" id="4966779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4966783">elem</span>&nbsp;<span class="op" id="4966788">:=</span>&nbsp;<span class="ident" id="4966791">value</span><span class="op" id="4966796">.</span><span class="ident" id="4966797">Index</span><span class="op" id="4966802">(</span><span class="ident" id="4966803">i</span><span class="op" id="4966804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4966808">if</span>&nbsp;<span class="ident" id="4966811">elemIndir</span>&nbsp;<span class="op" id="4966821">&gt;</span>&nbsp;<span class="num" id="4966823">0</span>&nbsp;<span class="op" id="4966825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4966830">elem</span>&nbsp;<span class="op" id="4966835">=</span>&nbsp;<span class="ident" id="4966837">encIndirect</span><span class="op" id="4966848">(</span><span class="ident" id="4966849">elem</span><span class="op" id="4966853">,</span>&nbsp;<span class="ident" id="4966855">elemIndir</span><span class="op" id="4966864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4966869">//&nbsp;TODO:&nbsp;Is&nbsp;elem&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4966940">if</span>&nbsp;<span class="op" id="4966943">!</span><span class="ident" id="4966944">valid</span><span class="op" id="4966949">(</span><span class="ident" id="4966950">elem</span><span class="op" id="4966954">)</span>&nbsp;<span class="op" id="4966956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4966962">errorf</span><span class="op" id="4966968">(</span><span class="string" id="4966969">&#34;encodeArray:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="4966995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4967000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4967004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4967008">op</span><span class="op" id="4967010">(</span><span class="ident" id="4967011">nil</span><span class="op" id="4967014">,</span>&nbsp;<span class="ident" id="4967016">state</span><span class="op" id="4967021">,</span>&nbsp;<span class="ident" id="4967023">elem</span><span class="op" id="4967027">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4967030">}</span><br>
<span class="lineno"></span><span class="op" id="4967032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4967035">//&nbsp;encodeReflectValue&nbsp;is&nbsp;a&nbsp;helper&nbsp;for&nbsp;maps.&nbsp;It&nbsp;encodes&nbsp;the&nbsp;value&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="4967103">func</span>&nbsp;<span class="ident" id="4967108">encodeReflectValue</span><span class="op" id="4967126">(</span><span class="ident" id="4967127">state</span>&nbsp;<span class="op" id="4967133">*</span><span class="ident" id="4967134">encoderState</span><span class="op" id="4967146">,</span>&nbsp;<span class="ident" id="4967148">v</span>&nbsp;<span class="ident" id="4967150">reflect</span><span class="op" id="4967157">.</span><span class="ident" id="4967158">Value</span><span class="op" id="4967163">,</span>&nbsp;<span class="ident" id="4967165">op</span>&nbsp;<span class="ident" id="4967168">encOp</span><span class="op" id="4967173">,</span>&nbsp;<span class="ident" id="4967175">indir</span>&nbsp;<span class="builtintype" id="4967181">int</span><span class="op" id="4967184">)</span>&nbsp;<span class="op" id="4967186">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4967189">for</span>&nbsp;<span class="ident" id="4967193">i</span>&nbsp;<span class="op" id="4967195">:=</span>&nbsp;<span class="num" id="4967198">0</span><span class="op" id="4967199">;</span>&nbsp;<span class="ident" id="4967201">i</span>&nbsp;<span class="op" id="4967203">&lt;</span>&nbsp;<span class="ident" id="4967205">indir</span>&nbsp;<span class="op" id="4967211">&amp;&amp;</span>&nbsp;<span class="ident" id="4967214">v</span><span class="op" id="4967215">.</span><span class="ident" id="4967216">IsValid</span><span class="op" id="4967223">(</span><span class="op" id="4967224">)</span><span class="op" id="4967225">;</span>&nbsp;<span class="ident" id="4967227">i</span><span class="op" id="4967228">++</span>&nbsp;<span class="op" id="4967231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4967235">v</span>&nbsp;<span class="op" id="4967237">=</span>&nbsp;<span class="ident" id="4967239">reflect</span><span class="op" id="4967246">.</span><span class="ident" id="4967247">Indirect</span><span class="op" id="4967255">(</span><span class="ident" id="4967256">v</span><span class="op" id="4967257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4967260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4967263">if</span>&nbsp;<span class="op" id="4967266">!</span><span class="ident" id="4967267">v</span><span class="op" id="4967268">.</span><span class="ident" id="4967269">IsValid</span><span class="op" id="4967276">(</span><span class="op" id="4967277">)</span>&nbsp;<span class="op" id="4967279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4967283">errorf</span><span class="op" id="4967289">(</span><span class="string" id="4967290">&#34;encodeReflectValue:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="4967323">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4967326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4967329">op</span><span class="op" id="4967331">(</span><span class="ident" id="4967332">nil</span><span class="op" id="4967335">,</span>&nbsp;<span class="ident" id="4967337">state</span><span class="op" id="4967342">,</span>&nbsp;<span class="ident" id="4967344">v</span><span class="op" id="4967345">)</span><br>
<span class="lineno"></span><span class="op" id="4967347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4967350">//&nbsp;encodeMap&nbsp;encodes&nbsp;a&nbsp;map&nbsp;as&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;key:value&nbsp;pairs.</span><br>
<span class="lineno">360</span><span class="keyword" id="4967424">func</span>&nbsp;<span class="op" id="4967429">(</span><span class="ident" id="4967430">enc</span>&nbsp;<span class="op" id="4967434">*</span><span class="ident" id="4967435">Encoder</span><span class="op" id="4967442">)</span>&nbsp;<span class="ident" id="4967444">encodeMap</span><span class="op" id="4967453">(</span><span class="ident" id="4967454">b</span>&nbsp;<span class="op" id="4967456">*</span><span class="ident" id="4967457">encBuffer</span><span class="op" id="4967466">,</span>&nbsp;<span class="ident" id="4967468">mv</span>&nbsp;<span class="ident" id="4967471">reflect</span><span class="op" id="4967478">.</span><span class="ident" id="4967479">Value</span><span class="op" id="4967484">,</span>&nbsp;<span class="ident" id="4967486">keyOp</span><span class="op" id="4967491">,</span>&nbsp;<span class="ident" id="4967493">elemOp</span>&nbsp;<span class="ident" id="4967500">encOp</span><span class="op" id="4967505">,</span>&nbsp;<span class="ident" id="4967507">keyIndir</span><span class="op" id="4967515">,</span>&nbsp;<span class="ident" id="4967517">elemIndir</span>&nbsp;<span class="builtintype" id="4967527">int</span><span class="op" id="4967530">)</span>&nbsp;<span class="op" id="4967532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4967535">state</span>&nbsp;<span class="op" id="4967541">:=</span>&nbsp;<span class="ident" id="4967544">enc</span><span class="op" id="4967547">.</span><span class="ident" id="4967548">newEncoderState</span><span class="op" id="4967563">(</span><span class="ident" id="4967564">b</span><span class="op" id="4967565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4967568">state</span><span class="op" id="4967573">.</span><span class="ident" id="4967574">fieldnum</span>&nbsp;<span class="op" id="4967583">=</span>&nbsp;<span class="op" id="4967585">-</span><span class="num" id="4967586">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4967589">state</span><span class="op" id="4967594">.</span><span class="ident" id="4967595">sendZero</span>&nbsp;<span class="op" id="4967604">=</span>&nbsp;<span class="builtintype" id="4967606">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4967612">keys</span>&nbsp;<span class="op" id="4967617">:=</span>&nbsp;<span class="ident" id="4967620">mv</span><span class="op" id="4967622">.</span><span class="ident" id="4967623">MapKeys</span><span class="op" id="4967630">(</span><span class="op" id="4967631">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4967634">state</span><span class="op" id="4967639">.</span><span class="ident" id="4967640">encodeUint</span><span class="op" id="4967650">(</span><span class="ident" id="4967651">uint64</span><span class="op" id="4967657">(</span><span class="builtinfunc" id="4967658">len</span><span class="op" id="4967661">(</span><span class="ident" id="4967662">keys</span><span class="op" id="4967666">)</span><span class="op" id="4967667">)</span><span class="op" id="4967668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4967671">for</span>&nbsp;<span class="ident" id="4967675">_</span><span class="op" id="4967676">,</span>&nbsp;<span class="ident" id="4967678">key</span>&nbsp;<span class="op" id="4967682">:=</span>&nbsp;<span class="keyword" id="4967685">range</span>&nbsp;<span class="ident" id="4967691">keys</span>&nbsp;<span class="op" id="4967696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4967700">encodeReflectValue</span><span class="op" id="4967718">(</span><span class="ident" id="4967719">state</span><span class="op" id="4967724">,</span>&nbsp;<span class="ident" id="4967726">key</span><span class="op" id="4967729">,</span>&nbsp;<span class="ident" id="4967731">keyOp</span><span class="op" id="4967736">,</span>&nbsp;<span class="ident" id="4967738">keyIndir</span><span class="op" id="4967746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4967750">encodeReflectValue</span><span class="op" id="4967768">(</span><span class="ident" id="4967769">state</span><span class="op" id="4967774">,</span>&nbsp;<span class="ident" id="4967776">mv</span><span class="op" id="4967778">.</span><span class="ident" id="4967779">MapIndex</span><span class="op" id="4967787">(</span><span class="ident" id="4967788">key</span><span class="op" id="4967791">)</span><span class="op" id="4967792">,</span>&nbsp;<span class="ident" id="4967794">elemOp</span><span class="op" id="4967800">,</span>&nbsp;<span class="ident" id="4967802">elemIndir</span><span class="op" id="4967811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4967814">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4967817">enc</span><span class="op" id="4967820">.</span><span class="ident" id="4967821">freeEncoderState</span><span class="op" id="4967837">(</span><span class="ident" id="4967838">state</span><span class="op" id="4967843">)</span><br>
<span class="lineno"></span><span class="op" id="4967845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4967848">//&nbsp;encodeInterface&nbsp;encodes&nbsp;the&nbsp;interface&nbsp;value&nbsp;iv.</span><br>
<span class="lineno"></span><span class="comment" id="4967899">//&nbsp;To&nbsp;send&nbsp;an&nbsp;interface,&nbsp;we&nbsp;send&nbsp;a&nbsp;string&nbsp;identifying&nbsp;the&nbsp;concrete&nbsp;type,&nbsp;followed</span><br>
<span class="lineno">375</span><span class="comment" id="4967981">//&nbsp;by&nbsp;the&nbsp;type&nbsp;identifier&nbsp;(which&nbsp;might&nbsp;require&nbsp;defining&nbsp;that&nbsp;type&nbsp;right&nbsp;now),&nbsp;followed</span><br>
<span class="lineno"></span><span class="comment" id="4968068">//&nbsp;by&nbsp;the&nbsp;concrete&nbsp;value.&nbsp;&nbsp;A&nbsp;nil&nbsp;value&nbsp;gets&nbsp;sent&nbsp;as&nbsp;the&nbsp;empty&nbsp;string&nbsp;for&nbsp;the&nbsp;name,</span><br>
<span class="lineno"></span><span class="comment" id="4968151">//&nbsp;followed&nbsp;by&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4968176">func</span>&nbsp;<span class="op" id="4968181">(</span><span class="ident" id="4968182">enc</span>&nbsp;<span class="op" id="4968186">*</span><span class="ident" id="4968187">Encoder</span><span class="op" id="4968194">)</span>&nbsp;<span class="ident" id="4968196">encodeInterface</span><span class="op" id="4968211">(</span><span class="ident" id="4968212">b</span>&nbsp;<span class="op" id="4968214">*</span><span class="ident" id="4968215">encBuffer</span><span class="op" id="4968224">,</span>&nbsp;<span class="ident" id="4968226">iv</span>&nbsp;<span class="ident" id="4968229">reflect</span><span class="op" id="4968236">.</span><span class="ident" id="4968237">Value</span><span class="op" id="4968242">)</span>&nbsp;<span class="op" id="4968244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4968247">//&nbsp;Gobs&nbsp;can&nbsp;encode&nbsp;nil&nbsp;interface&nbsp;values&nbsp;but&nbsp;not&nbsp;typed&nbsp;interface</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4968312">//&nbsp;values&nbsp;holding&nbsp;nil&nbsp;pointers,&nbsp;since&nbsp;nil&nbsp;pointers&nbsp;point&nbsp;to&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4968383">elem</span>&nbsp;<span class="op" id="4968388">:=</span>&nbsp;<span class="ident" id="4968391">iv</span><span class="op" id="4968393">.</span><span class="ident" id="4968394">Elem</span><span class="op" id="4968398">(</span><span class="op" id="4968399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4968402">if</span>&nbsp;<span class="ident" id="4968405">elem</span><span class="op" id="4968409">.</span><span class="ident" id="4968410">Kind</span><span class="op" id="4968414">(</span><span class="op" id="4968415">)</span>&nbsp;<span class="op" id="4968417">==</span>&nbsp;<span class="ident" id="4968420">reflect</span><span class="op" id="4968427">.</span><span class="ident" id="4968428">Ptr</span>&nbsp;<span class="op" id="4968432">&amp;&amp;</span>&nbsp;<span class="ident" id="4968435">elem</span><span class="op" id="4968439">.</span><span class="ident" id="4968440">IsNil</span><span class="op" id="4968445">(</span><span class="op" id="4968446">)</span>&nbsp;<span class="op" id="4968448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4968452">errorf</span><span class="op" id="4968458">(</span><span class="string" id="4968459">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;%s&nbsp;inside&nbsp;interface&#34;</span><span class="op" id="4968519">,</span>&nbsp;<span class="ident" id="4968521">iv</span><span class="op" id="4968523">.</span><span class="ident" id="4968524">Elem</span><span class="op" id="4968528">(</span><span class="op" id="4968529">)</span><span class="op" id="4968530">.</span><span class="ident" id="4968531">Type</span><span class="op" id="4968535">(</span><span class="op" id="4968536">)</span><span class="op" id="4968537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4968540">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4968543">state</span>&nbsp;<span class="op" id="4968549">:=</span>&nbsp;<span class="ident" id="4968552">enc</span><span class="op" id="4968555">.</span><span class="ident" id="4968556">newEncoderState</span><span class="op" id="4968571">(</span><span class="ident" id="4968572">b</span><span class="op" id="4968573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4968576">state</span><span class="op" id="4968581">.</span><span class="ident" id="4968582">fieldnum</span>&nbsp;<span class="op" id="4968591">=</span>&nbsp;<span class="op" id="4968593">-</span><span class="num" id="4968594">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4968597">state</span><span class="op" id="4968602">.</span><span class="ident" id="4968603">sendZero</span>&nbsp;<span class="op" id="4968612">=</span>&nbsp;<span class="builtintype" id="4968614">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4968620">if</span>&nbsp;<span class="ident" id="4968623">iv</span><span class="op" id="4968625">.</span><span class="ident" id="4968626">IsNil</span><span class="op" id="4968631">(</span><span class="op" id="4968632">)</span>&nbsp;<span class="op" id="4968634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4968638">state</span><span class="op" id="4968643">.</span><span class="ident" id="4968644">encodeUint</span><span class="op" id="4968654">(</span><span class="num" id="4968655">0</span><span class="op" id="4968656">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4968660">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4968668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4968672">ut</span>&nbsp;<span class="op" id="4968675">:=</span>&nbsp;<span class="ident" id="4968678">userType</span><span class="op" id="4968686">(</span><span class="ident" id="4968687">iv</span><span class="op" id="4968689">.</span><span class="ident" id="4968690">Elem</span><span class="op" id="4968694">(</span><span class="op" id="4968695">)</span><span class="op" id="4968696">.</span><span class="ident" id="4968697">Type</span><span class="op" id="4968701">(</span><span class="op" id="4968702">)</span><span class="op" id="4968703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4968706">registerLock</span><span class="op" id="4968718">.</span><span class="ident" id="4968719">RLock</span><span class="op" id="4968724">(</span><span class="op" id="4968725">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4968728">name</span><span class="op" id="4968732">,</span>&nbsp;<span class="ident" id="4968734">ok</span>&nbsp;<span class="op" id="4968737">:=</span>&nbsp;<span class="ident" id="4968740">concreteTypeToName</span><span class="op" id="4968758">[</span><span class="ident" id="4968759">ut</span><span class="op" id="4968761">.</span><span class="ident" id="4968762">base</span><span class="op" id="4968766">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4968769">registerLock</span><span class="op" id="4968781">.</span><span class="ident" id="4968782">RUnlock</span><span class="op" id="4968789">(</span><span class="op" id="4968790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4968793">if</span>&nbsp;<span class="op" id="4968796">!</span><span class="ident" id="4968797">ok</span>&nbsp;<span class="op" id="4968800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4968804">errorf</span><span class="op" id="4968810">(</span><span class="string" id="4968811">&#34;type&nbsp;not&nbsp;registered&nbsp;for&nbsp;interface:&nbsp;%s&#34;</span><span class="op" id="4968850">,</span>&nbsp;<span class="ident" id="4968852">ut</span><span class="op" id="4968854">.</span><span class="ident" id="4968855">base</span><span class="op" id="4968859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4968862">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4968865">//&nbsp;Send&nbsp;the&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4968884">state</span><span class="op" id="4968889">.</span><span class="ident" id="4968890">encodeUint</span><span class="op" id="4968900">(</span><span class="ident" id="4968901">uint64</span><span class="op" id="4968907">(</span><span class="builtinfunc" id="4968908">len</span><span class="op" id="4968911">(</span><span class="ident" id="4968912">name</span><span class="op" id="4968916">)</span><span class="op" id="4968917">)</span><span class="op" id="4968918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4968921">state</span><span class="op" id="4968926">.</span><span class="ident" id="4968927">b</span><span class="op" id="4968928">.</span><span class="ident" id="4968929">WriteString</span><span class="op" id="4968940">(</span><span class="ident" id="4968941">name</span><span class="op" id="4968945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4968948">//&nbsp;Define&nbsp;the&nbsp;type&nbsp;id&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4968985">enc</span><span class="op" id="4968988">.</span><span class="ident" id="4968989">sendTypeDescriptor</span><span class="op" id="4969007">(</span><span class="ident" id="4969008">enc</span><span class="op" id="4969011">.</span><span class="ident" id="4969012">writer</span><span class="op" id="4969018">(</span><span class="op" id="4969019">)</span><span class="op" id="4969020">,</span>&nbsp;<span class="ident" id="4969022">state</span><span class="op" id="4969027">,</span>&nbsp;<span class="ident" id="4969029">ut</span><span class="op" id="4969031">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4969034">//&nbsp;Send&nbsp;the&nbsp;type&nbsp;id.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4969056">enc</span><span class="op" id="4969059">.</span><span class="ident" id="4969060">sendTypeId</span><span class="op" id="4969070">(</span><span class="ident" id="4969071">state</span><span class="op" id="4969076">,</span>&nbsp;<span class="ident" id="4969078">ut</span><span class="op" id="4969080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4969083">//&nbsp;Encode&nbsp;the&nbsp;value&nbsp;into&nbsp;a&nbsp;new&nbsp;buffer.&nbsp;&nbsp;Any&nbsp;nested&nbsp;type&nbsp;definitions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4969152">//&nbsp;should&nbsp;be&nbsp;written&nbsp;to&nbsp;b,&nbsp;before&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4969206">enc</span><span class="op" id="4969209">.</span><span class="ident" id="4969210">pushWriter</span><span class="op" id="4969220">(</span><span class="ident" id="4969221">b</span><span class="op" id="4969222">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4969225">data</span>&nbsp;<span class="op" id="4969230">:=</span>&nbsp;<span class="builtinfunc" id="4969233">new</span><span class="op" id="4969236">(</span><span class="ident" id="4969237">encBuffer</span><span class="op" id="4969246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4969249">data</span><span class="op" id="4969253">.</span><span class="ident" id="4969254">Write</span><span class="op" id="4969259">(</span><span class="ident" id="4969260">spaceForLength</span><span class="op" id="4969274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4969277">enc</span><span class="op" id="4969280">.</span><span class="ident" id="4969281">encode</span><span class="op" id="4969287">(</span><span class="ident" id="4969288">data</span><span class="op" id="4969292">,</span>&nbsp;<span class="ident" id="4969294">elem</span><span class="op" id="4969298">,</span>&nbsp;<span class="ident" id="4969300">ut</span><span class="op" id="4969302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4969305">if</span>&nbsp;<span class="ident" id="4969308">enc</span><span class="op" id="4969311">.</span><span class="ident" id="4969312">err</span>&nbsp;<span class="op" id="4969316">!=</span>&nbsp;<span class="ident" id="4969319">nil</span>&nbsp;<span class="op" id="4969323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4969327">error_</span><span class="op" id="4969333">(</span><span class="ident" id="4969334">enc</span><span class="op" id="4969337">.</span><span class="ident" id="4969338">err</span><span class="op" id="4969341">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4969344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4969347">enc</span><span class="op" id="4969350">.</span><span class="ident" id="4969351">popWriter</span><span class="op" id="4969360">(</span><span class="op" id="4969361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4969364">enc</span><span class="op" id="4969367">.</span><span class="ident" id="4969368">writeMessage</span><span class="op" id="4969380">(</span><span class="ident" id="4969381">b</span><span class="op" id="4969382">,</span>&nbsp;<span class="ident" id="4969384">data</span><span class="op" id="4969388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4969391">if</span>&nbsp;<span class="ident" id="4969394">enc</span><span class="op" id="4969397">.</span><span class="ident" id="4969398">err</span>&nbsp;<span class="op" id="4969402">!=</span>&nbsp;<span class="ident" id="4969405">nil</span>&nbsp;<span class="op" id="4969409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4969413">error_</span><span class="op" id="4969419">(</span><span class="ident" id="4969420">enc</span><span class="op" id="4969423">.</span><span class="ident" id="4969424">err</span><span class="op" id="4969427">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4969430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4969433">enc</span><span class="op" id="4969436">.</span><span class="ident" id="4969437">freeEncoderState</span><span class="op" id="4969453">(</span><span class="ident" id="4969454">state</span><span class="op" id="4969459">)</span><br>
<span class="lineno"></span><span class="op" id="4969461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4969464">//&nbsp;isZero&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;the&nbsp;zero&nbsp;of&nbsp;its&nbsp;type.</span><br>
<span class="lineno">425</span><span class="keyword" id="4969525">func</span>&nbsp;<span class="ident" id="4969530">isZero</span><span class="op" id="4969536">(</span><span class="ident" id="4969537">val</span>&nbsp;<span class="ident" id="4969541">reflect</span><span class="op" id="4969548">.</span><span class="ident" id="4969549">Value</span><span class="op" id="4969554">)</span>&nbsp;<span class="builtintype" id="4969556">bool</span>&nbsp;<span class="op" id="4969561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4969564">switch</span>&nbsp;<span class="ident" id="4969571">val</span><span class="op" id="4969574">.</span><span class="ident" id="4969575">Kind</span><span class="op" id="4969579">(</span><span class="op" id="4969580">)</span>&nbsp;<span class="op" id="4969582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4969585">case</span>&nbsp;<span class="ident" id="4969590">reflect</span><span class="op" id="4969597">.</span><span class="ident" id="4969598">Array</span><span class="op" id="4969603">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4969607">for</span>&nbsp;<span class="ident" id="4969611">i</span>&nbsp;<span class="op" id="4969613">:=</span>&nbsp;<span class="num" id="4969616">0</span><span class="op" id="4969617">;</span>&nbsp;<span class="ident" id="4969619">i</span>&nbsp;<span class="op" id="4969621">&lt;</span>&nbsp;<span class="ident" id="4969623">val</span><span class="op" id="4969626">.</span><span class="ident" id="4969627">Len</span><span class="op" id="4969630">(</span><span class="op" id="4969631">)</span><span class="op" id="4969632">;</span>&nbsp;<span class="ident" id="4969634">i</span><span class="op" id="4969635">++</span>&nbsp;<span class="op" id="4969638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4969643">if</span>&nbsp;<span class="op" id="4969646">!</span><span class="ident" id="4969647">isZero</span><span class="op" id="4969653">(</span><span class="ident" id="4969654">val</span><span class="op" id="4969657">.</span><span class="ident" id="4969658">Index</span><span class="op" id="4969663">(</span><span class="ident" id="4969664">i</span><span class="op" id="4969665">)</span><span class="op" id="4969666">)</span>&nbsp;<span class="op" id="4969668">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4969674">return</span>&nbsp;<span class="builtintype" id="4969681">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4969690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4969694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4969698">return</span>&nbsp;<span class="builtintype" id="4969705">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4969711">case</span>&nbsp;<span class="ident" id="4969716">reflect</span><span class="op" id="4969723">.</span><span class="ident" id="4969724">Map</span><span class="op" id="4969727">,</span>&nbsp;<span class="ident" id="4969729">reflect</span><span class="op" id="4969736">.</span><span class="ident" id="4969737">Slice</span><span class="op" id="4969742">,</span>&nbsp;<span class="ident" id="4969744">reflect</span><span class="op" id="4969751">.</span><span class="ident" id="4969752">String</span><span class="op" id="4969758">:</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4969762">return</span>&nbsp;<span class="ident" id="4969769">val</span><span class="op" id="4969772">.</span><span class="ident" id="4969773">Len</span><span class="op" id="4969776">(</span><span class="op" id="4969777">)</span>&nbsp;<span class="op" id="4969779">==</span>&nbsp;<span class="num" id="4969782">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4969785">case</span>&nbsp;<span class="ident" id="4969790">reflect</span><span class="op" id="4969797">.</span><span class="ident" id="4969798">Bool</span><span class="op" id="4969802">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4969806">return</span>&nbsp;<span class="op" id="4969813">!</span><span class="ident" id="4969814">val</span><span class="op" id="4969817">.</span><span class="ident" id="4969818">Bool</span><span class="op" id="4969822">(</span><span class="op" id="4969823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4969826">case</span>&nbsp;<span class="ident" id="4969831">reflect</span><span class="op" id="4969838">.</span><span class="ident" id="4969839">Complex64</span><span class="op" id="4969848">,</span>&nbsp;<span class="ident" id="4969850">reflect</span><span class="op" id="4969857">.</span><span class="ident" id="4969858">Complex128</span><span class="op" id="4969868">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4969872">return</span>&nbsp;<span class="ident" id="4969879">val</span><span class="op" id="4969882">.</span><span class="ident" id="4969883">Complex</span><span class="op" id="4969890">(</span><span class="op" id="4969891">)</span>&nbsp;<span class="op" id="4969893">==</span>&nbsp;<span class="num" id="4969896">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4969899">case</span>&nbsp;<span class="ident" id="4969904">reflect</span><span class="op" id="4969911">.</span><span class="ident" id="4969912">Chan</span><span class="op" id="4969916">,</span>&nbsp;<span class="ident" id="4969918">reflect</span><span class="op" id="4969925">.</span><span class="ident" id="4969926">Func</span><span class="op" id="4969930">,</span>&nbsp;<span class="ident" id="4969932">reflect</span><span class="op" id="4969939">.</span><span class="ident" id="4969940">Interface</span><span class="op" id="4969949">,</span>&nbsp;<span class="ident" id="4969951">reflect</span><span class="op" id="4969958">.</span><span class="ident" id="4969959">Ptr</span><span class="op" id="4969962">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4969966">return</span>&nbsp;<span class="ident" id="4969973">val</span><span class="op" id="4969976">.</span><span class="ident" id="4969977">IsNil</span><span class="op" id="4969982">(</span><span class="op" id="4969983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4969986">case</span>&nbsp;<span class="ident" id="4969991">reflect</span><span class="op" id="4969998">.</span><span class="ident" id="4969999">Int</span><span class="op" id="4970002">,</span>&nbsp;<span class="ident" id="4970004">reflect</span><span class="op" id="4970011">.</span><span class="ident" id="4970012">Int8</span><span class="op" id="4970016">,</span>&nbsp;<span class="ident" id="4970018">reflect</span><span class="op" id="4970025">.</span><span class="ident" id="4970026">Int16</span><span class="op" id="4970031">,</span>&nbsp;<span class="ident" id="4970033">reflect</span><span class="op" id="4970040">.</span><span class="ident" id="4970041">Int32</span><span class="op" id="4970046">,</span>&nbsp;<span class="ident" id="4970048">reflect</span><span class="op" id="4970055">.</span><span class="ident" id="4970056">Int64</span><span class="op" id="4970061">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4970065">return</span>&nbsp;<span class="ident" id="4970072">val</span><span class="op" id="4970075">.</span><span class="ident" id="4970076">Int</span><span class="op" id="4970079">(</span><span class="op" id="4970080">)</span>&nbsp;<span class="op" id="4970082">==</span>&nbsp;<span class="num" id="4970085">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4970088">case</span>&nbsp;<span class="ident" id="4970093">reflect</span><span class="op" id="4970100">.</span><span class="ident" id="4970101">Float32</span><span class="op" id="4970108">,</span>&nbsp;<span class="ident" id="4970110">reflect</span><span class="op" id="4970117">.</span><span class="ident" id="4970118">Float64</span><span class="op" id="4970125">:</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4970129">return</span>&nbsp;<span class="ident" id="4970136">val</span><span class="op" id="4970139">.</span><span class="ident" id="4970140">Float</span><span class="op" id="4970145">(</span><span class="op" id="4970146">)</span>&nbsp;<span class="op" id="4970148">==</span>&nbsp;<span class="num" id="4970151">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4970154">case</span>&nbsp;<span class="ident" id="4970159">reflect</span><span class="op" id="4970166">.</span><span class="ident" id="4970167">Uint</span><span class="op" id="4970171">,</span>&nbsp;<span class="ident" id="4970173">reflect</span><span class="op" id="4970180">.</span><span class="ident" id="4970181">Uint8</span><span class="op" id="4970186">,</span>&nbsp;<span class="ident" id="4970188">reflect</span><span class="op" id="4970195">.</span><span class="ident" id="4970196">Uint16</span><span class="op" id="4970202">,</span>&nbsp;<span class="ident" id="4970204">reflect</span><span class="op" id="4970211">.</span><span class="ident" id="4970212">Uint32</span><span class="op" id="4970218">,</span>&nbsp;<span class="ident" id="4970220">reflect</span><span class="op" id="4970227">.</span><span class="ident" id="4970228">Uint64</span><span class="op" id="4970234">,</span>&nbsp;<span class="ident" id="4970236">reflect</span><span class="op" id="4970243">.</span><span class="ident" id="4970244">Uintptr</span><span class="op" id="4970251">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4970255">return</span>&nbsp;<span class="ident" id="4970262">val</span><span class="op" id="4970265">.</span><span class="ident" id="4970266">Uint</span><span class="op" id="4970270">(</span><span class="op" id="4970271">)</span>&nbsp;<span class="op" id="4970273">==</span>&nbsp;<span class="num" id="4970276">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4970279">case</span>&nbsp;<span class="ident" id="4970284">reflect</span><span class="op" id="4970291">.</span><span class="ident" id="4970292">Struct</span><span class="op" id="4970298">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4970302">for</span>&nbsp;<span class="ident" id="4970306">i</span>&nbsp;<span class="op" id="4970308">:=</span>&nbsp;<span class="num" id="4970311">0</span><span class="op" id="4970312">;</span>&nbsp;<span class="ident" id="4970314">i</span>&nbsp;<span class="op" id="4970316">&lt;</span>&nbsp;<span class="ident" id="4970318">val</span><span class="op" id="4970321">.</span><span class="ident" id="4970322">NumField</span><span class="op" id="4970330">(</span><span class="op" id="4970331">)</span><span class="op" id="4970332">;</span>&nbsp;<span class="ident" id="4970334">i</span><span class="op" id="4970335">++</span>&nbsp;<span class="op" id="4970338">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4970343">if</span>&nbsp;<span class="op" id="4970346">!</span><span class="ident" id="4970347">isZero</span><span class="op" id="4970353">(</span><span class="ident" id="4970354">val</span><span class="op" id="4970357">.</span><span class="ident" id="4970358">Field</span><span class="op" id="4970363">(</span><span class="ident" id="4970364">i</span><span class="op" id="4970365">)</span><span class="op" id="4970366">)</span>&nbsp;<span class="op" id="4970368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4970374">return</span>&nbsp;<span class="builtintype" id="4970381">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4970390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4970394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4970398">return</span>&nbsp;<span class="builtintype" id="4970405">true</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4970411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4970414">panic</span><span class="op" id="4970419">(</span><span class="string" id="4970420">&#34;unknown&nbsp;type&nbsp;in&nbsp;isZero&nbsp;&#34;</span>&nbsp;<span class="op" id="4970446">+</span>&nbsp;<span class="ident" id="4970448">val</span><span class="op" id="4970451">.</span><span class="ident" id="4970452">Type</span><span class="op" id="4970456">(</span><span class="op" id="4970457">)</span><span class="op" id="4970458">.</span><span class="ident" id="4970459">String</span><span class="op" id="4970465">(</span><span class="op" id="4970466">)</span><span class="op" id="4970467">)</span><br>
<span class="lineno"></span><span class="op" id="4970469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4970472">//&nbsp;encGobEncoder&nbsp;encodes&nbsp;a&nbsp;value&nbsp;that&nbsp;implements&nbsp;the&nbsp;GobEncoder&nbsp;interface.</span><br>
<span class="lineno">460</span><span class="comment" id="4970547">//&nbsp;The&nbsp;data&nbsp;is&nbsp;sent&nbsp;as&nbsp;a&nbsp;byte&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="4970584">func</span>&nbsp;<span class="op" id="4970589">(</span><span class="ident" id="4970590">enc</span>&nbsp;<span class="op" id="4970594">*</span><span class="ident" id="4970595">Encoder</span><span class="op" id="4970602">)</span>&nbsp;<span class="ident" id="4970604">encodeGobEncoder</span><span class="op" id="4970620">(</span><span class="ident" id="4970621">b</span>&nbsp;<span class="op" id="4970623">*</span><span class="ident" id="4970624">encBuffer</span><span class="op" id="4970633">,</span>&nbsp;<span class="ident" id="4970635">ut</span>&nbsp;<span class="op" id="4970638">*</span><span class="ident" id="4970639">userTypeInfo</span><span class="op" id="4970651">,</span>&nbsp;<span class="ident" id="4970653">v</span>&nbsp;<span class="ident" id="4970655">reflect</span><span class="op" id="4970662">.</span><span class="ident" id="4970663">Value</span><span class="op" id="4970668">)</span>&nbsp;<span class="op" id="4970670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4970673">//&nbsp;TODO:&nbsp;should&nbsp;we&nbsp;catch&nbsp;panics&nbsp;from&nbsp;the&nbsp;called&nbsp;method?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4970731">var</span>&nbsp;<span class="ident" id="4970735">data</span>&nbsp;<span class="op" id="4970740">[</span><span class="op" id="4970741">]</span><span class="builtintype" id="4970742">byte</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4970748">var</span>&nbsp;<span class="ident" id="4970752">err</span>&nbsp;<span class="builtintype" id="4970756">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4970763">//&nbsp;We&nbsp;know&nbsp;it&#39;s&nbsp;one&nbsp;of&nbsp;these.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4970794">switch</span>&nbsp;<span class="ident" id="4970801">ut</span><span class="op" id="4970803">.</span><span class="ident" id="4970804">externalEnc</span>&nbsp;<span class="op" id="4970816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4970819">case</span>&nbsp;<span class="ident" id="4970824">xGob</span><span class="op" id="4970828">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4970832">data</span><span class="op" id="4970836">,</span>&nbsp;<span class="ident" id="4970838">err</span>&nbsp;<span class="op" id="4970842">=</span>&nbsp;<span class="ident" id="4970844">v</span><span class="op" id="4970845">.</span><span class="ident" id="4970846">Interface</span><span class="op" id="4970855">(</span><span class="op" id="4970856">)</span><span class="op" id="4970857">.</span><span class="op" id="4970858">(</span><span class="ident" id="4970859">GobEncoder</span><span class="op" id="4970869">)</span><span class="op" id="4970870">.</span><span class="ident" id="4970871">GobEncode</span><span class="op" id="4970880">(</span><span class="op" id="4970881">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4970884">case</span>&nbsp;<span class="ident" id="4970889">xBinary</span><span class="op" id="4970896">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4970900">data</span><span class="op" id="4970904">,</span>&nbsp;<span class="ident" id="4970906">err</span>&nbsp;<span class="op" id="4970910">=</span>&nbsp;<span class="ident" id="4970912">v</span><span class="op" id="4970913">.</span><span class="ident" id="4970914">Interface</span><span class="op" id="4970923">(</span><span class="op" id="4970924">)</span><span class="op" id="4970925">.</span><span class="op" id="4970926">(</span><span class="ident" id="4970927">encoding</span><span class="op" id="4970935">.</span><span class="ident" id="4970936">BinaryMarshaler</span><span class="op" id="4970951">)</span><span class="op" id="4970952">.</span><span class="ident" id="4970953">MarshalBinary</span><span class="op" id="4970966">(</span><span class="op" id="4970967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4970970">case</span>&nbsp;<span class="ident" id="4970975">xText</span><span class="op" id="4970980">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4970984">data</span><span class="op" id="4970988">,</span>&nbsp;<span class="ident" id="4970990">err</span>&nbsp;<span class="op" id="4970994">=</span>&nbsp;<span class="ident" id="4970996">v</span><span class="op" id="4970997">.</span><span class="ident" id="4970998">Interface</span><span class="op" id="4971007">(</span><span class="op" id="4971008">)</span><span class="op" id="4971009">.</span><span class="op" id="4971010">(</span><span class="ident" id="4971011">encoding</span><span class="op" id="4971019">.</span><span class="ident" id="4971020">TextMarshaler</span><span class="op" id="4971033">)</span><span class="op" id="4971034">.</span><span class="ident" id="4971035">MarshalText</span><span class="op" id="4971046">(</span><span class="op" id="4971047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4971050">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4971053">if</span>&nbsp;<span class="ident" id="4971056">err</span>&nbsp;<span class="op" id="4971060">!=</span>&nbsp;<span class="ident" id="4971063">nil</span>&nbsp;<span class="op" id="4971067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971071">error_</span><span class="op" id="4971077">(</span><span class="ident" id="4971078">err</span><span class="op" id="4971081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4971084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971087">state</span>&nbsp;<span class="op" id="4971093">:=</span>&nbsp;<span class="ident" id="4971096">enc</span><span class="op" id="4971099">.</span><span class="ident" id="4971100">newEncoderState</span><span class="op" id="4971115">(</span><span class="ident" id="4971116">b</span><span class="op" id="4971117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971120">state</span><span class="op" id="4971125">.</span><span class="ident" id="4971126">fieldnum</span>&nbsp;<span class="op" id="4971135">=</span>&nbsp;<span class="op" id="4971137">-</span><span class="num" id="4971138">1</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971141">state</span><span class="op" id="4971146">.</span><span class="ident" id="4971147">encodeUint</span><span class="op" id="4971157">(</span><span class="ident" id="4971158">uint64</span><span class="op" id="4971164">(</span><span class="builtinfunc" id="4971165">len</span><span class="op" id="4971168">(</span><span class="ident" id="4971169">data</span><span class="op" id="4971173">)</span><span class="op" id="4971174">)</span><span class="op" id="4971175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971178">state</span><span class="op" id="4971183">.</span><span class="ident" id="4971184">b</span><span class="op" id="4971185">.</span><span class="ident" id="4971186">Write</span><span class="op" id="4971191">(</span><span class="ident" id="4971192">data</span><span class="op" id="4971196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971199">enc</span><span class="op" id="4971202">.</span><span class="ident" id="4971203">freeEncoderState</span><span class="op" id="4971219">(</span><span class="ident" id="4971220">state</span><span class="op" id="4971225">)</span><br>
<span class="lineno"></span><span class="op" id="4971227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">485</span><span class="keyword" id="4971230">var</span>&nbsp;<span class="ident" id="4971234">encOpTable</span>&nbsp;<span class="op" id="4971245">=</span>&nbsp;<span class="op" id="4971247">[</span><span class="op" id="4971248">...</span><span class="op" id="4971251">]</span><span class="ident" id="4971252">encOp</span><span class="op" id="4971257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971260">reflect</span><span class="op" id="4971267">.</span><span class="ident" id="4971268">Bool</span><span class="op" id="4971272">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971280">encBool</span><span class="op" id="4971287">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971290">reflect</span><span class="op" id="4971297">.</span><span class="ident" id="4971298">Int</span><span class="op" id="4971301">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971310">encInt</span><span class="op" id="4971316">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971319">reflect</span><span class="op" id="4971326">.</span><span class="ident" id="4971327">Int8</span><span class="op" id="4971331">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971339">encInt</span><span class="op" id="4971345">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971348">reflect</span><span class="op" id="4971355">.</span><span class="ident" id="4971356">Int16</span><span class="op" id="4971361">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971368">encInt</span><span class="op" id="4971374">,</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971377">reflect</span><span class="op" id="4971384">.</span><span class="ident" id="4971385">Int32</span><span class="op" id="4971390">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971397">encInt</span><span class="op" id="4971403">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971406">reflect</span><span class="op" id="4971413">.</span><span class="ident" id="4971414">Int64</span><span class="op" id="4971419">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971426">encInt</span><span class="op" id="4971432">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971435">reflect</span><span class="op" id="4971442">.</span><span class="ident" id="4971443">Uint</span><span class="op" id="4971447">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971455">encUint</span><span class="op" id="4971462">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971465">reflect</span><span class="op" id="4971472">.</span><span class="ident" id="4971473">Uint8</span><span class="op" id="4971478">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971485">encUint</span><span class="op" id="4971492">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971495">reflect</span><span class="op" id="4971502">.</span><span class="ident" id="4971503">Uint16</span><span class="op" id="4971509">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971515">encUint</span><span class="op" id="4971522">,</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971525">reflect</span><span class="op" id="4971532">.</span><span class="ident" id="4971533">Uint32</span><span class="op" id="4971539">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971545">encUint</span><span class="op" id="4971552">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971555">reflect</span><span class="op" id="4971562">.</span><span class="ident" id="4971563">Uint64</span><span class="op" id="4971569">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971575">encUint</span><span class="op" id="4971582">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971585">reflect</span><span class="op" id="4971592">.</span><span class="ident" id="4971593">Uintptr</span><span class="op" id="4971600">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971605">encUint</span><span class="op" id="4971612">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971615">reflect</span><span class="op" id="4971622">.</span><span class="ident" id="4971623">Float32</span><span class="op" id="4971630">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971635">encFloat</span><span class="op" id="4971643">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971646">reflect</span><span class="op" id="4971653">.</span><span class="ident" id="4971654">Float64</span><span class="op" id="4971661">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971666">encFloat</span><span class="op" id="4971674">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971677">reflect</span><span class="op" id="4971684">.</span><span class="ident" id="4971685">Complex64</span><span class="op" id="4971694">:</span>&nbsp;&nbsp;<span class="ident" id="4971697">encComplex</span><span class="op" id="4971707">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971710">reflect</span><span class="op" id="4971717">.</span><span class="ident" id="4971718">Complex128</span><span class="op" id="4971728">:</span>&nbsp;<span class="ident" id="4971730">encComplex</span><span class="op" id="4971740">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971743">reflect</span><span class="op" id="4971750">.</span><span class="ident" id="4971751">String</span><span class="op" id="4971757">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4971763">encString</span><span class="op" id="4971772">,</span><br>
<span class="lineno"></span><span class="op" id="4971774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="comment" id="4971777">//&nbsp;encOpFor&nbsp;returns&nbsp;(a&nbsp;pointer&nbsp;to)&nbsp;the&nbsp;encoding&nbsp;op&nbsp;for&nbsp;the&nbsp;base&nbsp;type&nbsp;under&nbsp;rt&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4971859">//&nbsp;the&nbsp;indirection&nbsp;count&nbsp;to&nbsp;reach&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="4971897">func</span>&nbsp;<span class="ident" id="4971902">encOpFor</span><span class="op" id="4971910">(</span><span class="ident" id="4971911">rt</span>&nbsp;<span class="ident" id="4971914">reflect</span><span class="op" id="4971921">.</span><span class="ident" id="4971922">Type</span><span class="op" id="4971926">,</span>&nbsp;<span class="ident" id="4971928">inProgress</span>&nbsp;<span class="keyword" id="4971939">map</span><span class="op" id="4971942">[</span><span class="ident" id="4971943">reflect</span><span class="op" id="4971950">.</span><span class="ident" id="4971951">Type</span><span class="op" id="4971955">]</span><span class="op" id="4971956">*</span><span class="ident" id="4971957">encOp</span><span class="op" id="4971962">,</span>&nbsp;<span class="ident" id="4971964">building</span>&nbsp;<span class="keyword" id="4971973">map</span><span class="op" id="4971976">[</span><span class="op" id="4971977">*</span><span class="ident" id="4971978">typeInfo</span><span class="op" id="4971986">]</span><span class="builtintype" id="4971987">bool</span><span class="op" id="4971991">)</span>&nbsp;<span class="op" id="4971993">(</span><span class="op" id="4971994">*</span><span class="ident" id="4971995">encOp</span><span class="op" id="4972000">,</span>&nbsp;<span class="builtintype" id="4972002">int</span><span class="op" id="4972005">)</span>&nbsp;<span class="op" id="4972007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4972010">ut</span>&nbsp;<span class="op" id="4972013">:=</span>&nbsp;<span class="ident" id="4972016">userType</span><span class="op" id="4972024">(</span><span class="ident" id="4972025">rt</span><span class="op" id="4972027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4972030">//&nbsp;If&nbsp;the&nbsp;type&nbsp;implements&nbsp;GobEncoder,&nbsp;we&nbsp;handle&nbsp;it&nbsp;without&nbsp;further&nbsp;processing.</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4972110">if</span>&nbsp;<span class="ident" id="4972113">ut</span><span class="op" id="4972115">.</span><span class="ident" id="4972116">externalEnc</span>&nbsp;<span class="op" id="4972128">!=</span>&nbsp;<span class="num" id="4972131">0</span>&nbsp;<span class="op" id="4972133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4972137">return</span>&nbsp;<span class="ident" id="4972144">gobEncodeOpFor</span><span class="op" id="4972158">(</span><span class="ident" id="4972159">ut</span><span class="op" id="4972161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4972164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4972167">//&nbsp;If&nbsp;this&nbsp;type&nbsp;is&nbsp;already&nbsp;in&nbsp;progress,&nbsp;it&#39;s&nbsp;a&nbsp;recursive&nbsp;type&nbsp;(e.g.&nbsp;map[string]*T).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4972252">//&nbsp;Return&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;op&nbsp;we&#39;re&nbsp;already&nbsp;building.</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4972309">if</span>&nbsp;<span class="ident" id="4972312">opPtr</span>&nbsp;<span class="op" id="4972318">:=</span>&nbsp;<span class="ident" id="4972321">inProgress</span><span class="op" id="4972331">[</span><span class="ident" id="4972332">rt</span><span class="op" id="4972334">]</span><span class="op" id="4972335">;</span>&nbsp;<span class="ident" id="4972337">opPtr</span>&nbsp;<span class="op" id="4972343">!=</span>&nbsp;<span class="ident" id="4972346">nil</span>&nbsp;<span class="op" id="4972350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4972354">return</span>&nbsp;<span class="ident" id="4972361">opPtr</span><span class="op" id="4972366">,</span>&nbsp;<span class="ident" id="4972368">ut</span><span class="op" id="4972370">.</span><span class="ident" id="4972371">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4972378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4972381">typ</span>&nbsp;<span class="op" id="4972385">:=</span>&nbsp;<span class="ident" id="4972388">ut</span><span class="op" id="4972390">.</span><span class="ident" id="4972391">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4972397">indir</span>&nbsp;<span class="op" id="4972403">:=</span>&nbsp;<span class="ident" id="4972406">ut</span><span class="op" id="4972408">.</span><span class="ident" id="4972409">indir</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4972416">k</span>&nbsp;<span class="op" id="4972418">:=</span>&nbsp;<span class="ident" id="4972421">typ</span><span class="op" id="4972424">.</span><span class="ident" id="4972425">Kind</span><span class="op" id="4972429">(</span><span class="op" id="4972430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4972433">var</span>&nbsp;<span class="ident" id="4972437">op</span>&nbsp;<span class="ident" id="4972440">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4972447">if</span>&nbsp;<span class="builtintype" id="4972450">int</span><span class="op" id="4972453">(</span><span class="ident" id="4972454">k</span><span class="op" id="4972455">)</span>&nbsp;<span class="op" id="4972457">&lt;</span>&nbsp;<span class="builtinfunc" id="4972459">len</span><span class="op" id="4972462">(</span><span class="ident" id="4972463">encOpTable</span><span class="op" id="4972473">)</span>&nbsp;<span class="op" id="4972475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4972479">op</span>&nbsp;<span class="op" id="4972482">=</span>&nbsp;<span class="ident" id="4972484">encOpTable</span><span class="op" id="4972494">[</span><span class="ident" id="4972495">k</span><span class="op" id="4972496">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4972499">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4972502">if</span>&nbsp;<span class="ident" id="4972505">op</span>&nbsp;<span class="op" id="4972508">==</span>&nbsp;<span class="ident" id="4972511">nil</span>&nbsp;<span class="op" id="4972515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4972519">inProgress</span><span class="op" id="4972529">[</span><span class="ident" id="4972530">rt</span><span class="op" id="4972532">]</span>&nbsp;<span class="op" id="4972534">=</span>&nbsp;<span class="op" id="4972536">&amp;</span><span class="ident" id="4972537">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4972542">//&nbsp;Special&nbsp;cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4972561">switch</span>&nbsp;<span class="ident" id="4972568">t</span>&nbsp;<span class="op" id="4972570">:=</span>&nbsp;<span class="ident" id="4972573">typ</span><span class="op" id="4972576">;</span>&nbsp;<span class="ident" id="4972578">t</span><span class="op" id="4972579">.</span><span class="ident" id="4972580">Kind</span><span class="op" id="4972584">(</span><span class="op" id="4972585">)</span>&nbsp;<span class="op" id="4972587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4972591">case</span>&nbsp;<span class="ident" id="4972596">reflect</span><span class="op" id="4972603">.</span><span class="ident" id="4972604">Slice</span><span class="op" id="4972609">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4972614">if</span>&nbsp;<span class="ident" id="4972617">t</span><span class="op" id="4972618">.</span><span class="ident" id="4972619">Elem</span><span class="op" id="4972623">(</span><span class="op" id="4972624">)</span><span class="op" id="4972625">.</span><span class="ident" id="4972626">Kind</span><span class="op" id="4972630">(</span><span class="op" id="4972631">)</span>&nbsp;<span class="op" id="4972633">==</span>&nbsp;<span class="ident" id="4972636">reflect</span><span class="op" id="4972643">.</span><span class="ident" id="4972644">Uint8</span>&nbsp;<span class="op" id="4972650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4972656">op</span>&nbsp;<span class="op" id="4972659">=</span>&nbsp;<span class="ident" id="4972661">encUint8Array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4972679">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4972688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4972693">//&nbsp;Slices&nbsp;have&nbsp;a&nbsp;header;&nbsp;we&nbsp;decode&nbsp;it&nbsp;to&nbsp;find&nbsp;the&nbsp;underlying&nbsp;array.</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4972764">elemOp</span><span class="op" id="4972770">,</span>&nbsp;<span class="ident" id="4972772">elemIndir</span>&nbsp;<span class="op" id="4972782">:=</span>&nbsp;<span class="ident" id="4972785">encOpFor</span><span class="op" id="4972793">(</span><span class="ident" id="4972794">t</span><span class="op" id="4972795">.</span><span class="ident" id="4972796">Elem</span><span class="op" id="4972800">(</span><span class="op" id="4972801">)</span><span class="op" id="4972802">,</span>&nbsp;<span class="ident" id="4972804">inProgress</span><span class="op" id="4972814">,</span>&nbsp;<span class="ident" id="4972816">building</span><span class="op" id="4972824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4972829">helper</span>&nbsp;<span class="op" id="4972836">:=</span>&nbsp;<span class="ident" id="4972839">encSliceHelper</span><span class="op" id="4972853">[</span><span class="ident" id="4972854">t</span><span class="op" id="4972855">.</span><span class="ident" id="4972856">Elem</span><span class="op" id="4972860">(</span><span class="op" id="4972861">)</span><span class="op" id="4972862">.</span><span class="ident" id="4972863">Kind</span><span class="op" id="4972867">(</span><span class="op" id="4972868">)</span><span class="op" id="4972869">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4972874">op</span>&nbsp;<span class="op" id="4972877">=</span>&nbsp;<span class="keyword" id="4972879">func</span><span class="op" id="4972883">(</span><span class="ident" id="4972884">i</span>&nbsp;<span class="op" id="4972886">*</span><span class="ident" id="4972887">encInstr</span><span class="op" id="4972895">,</span>&nbsp;<span class="ident" id="4972897">state</span>&nbsp;<span class="op" id="4972903">*</span><span class="ident" id="4972904">encoderState</span><span class="op" id="4972916">,</span>&nbsp;<span class="ident" id="4972918">slice</span>&nbsp;<span class="ident" id="4972924">reflect</span><span class="op" id="4972931">.</span><span class="ident" id="4972932">Value</span><span class="op" id="4972937">)</span>&nbsp;<span class="op" id="4972939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4972945">if</span>&nbsp;<span class="op" id="4972948">!</span><span class="ident" id="4972949">state</span><span class="op" id="4972954">.</span><span class="ident" id="4972955">sendZero</span>&nbsp;<span class="op" id="4972964">&amp;&amp;</span>&nbsp;<span class="ident" id="4972967">slice</span><span class="op" id="4972972">.</span><span class="ident" id="4972973">Len</span><span class="op" id="4972976">(</span><span class="op" id="4972977">)</span>&nbsp;<span class="op" id="4972979">==</span>&nbsp;<span class="num" id="4972982">0</span>&nbsp;<span class="op" id="4972984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4972991">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4973002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4973008">state</span><span class="op" id="4973013">.</span><span class="ident" id="4973014">update</span><span class="op" id="4973020">(</span><span class="ident" id="4973021">i</span><span class="op" id="4973022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4973028">state</span><span class="op" id="4973033">.</span><span class="ident" id="4973034">enc</span><span class="op" id="4973037">.</span><span class="ident" id="4973038">encodeArray</span><span class="op" id="4973049">(</span><span class="ident" id="4973050">state</span><span class="op" id="4973055">.</span><span class="ident" id="4973056">b</span><span class="op" id="4973057">,</span>&nbsp;<span class="ident" id="4973059">slice</span><span class="op" id="4973064">,</span>&nbsp;<span class="op" id="4973066">*</span><span class="ident" id="4973067">elemOp</span><span class="op" id="4973073">,</span>&nbsp;<span class="ident" id="4973075">elemIndir</span><span class="op" id="4973084">,</span>&nbsp;<span class="ident" id="4973086">slice</span><span class="op" id="4973091">.</span><span class="ident" id="4973092">Len</span><span class="op" id="4973095">(</span><span class="op" id="4973096">)</span><span class="op" id="4973097">,</span>&nbsp;<span class="ident" id="4973099">helper</span><span class="op" id="4973105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4973110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4973114">case</span>&nbsp;<span class="ident" id="4973119">reflect</span><span class="op" id="4973126">.</span><span class="ident" id="4973127">Array</span><span class="op" id="4973132">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4973137">//&nbsp;True&nbsp;arrays&nbsp;have&nbsp;size&nbsp;in&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4973178">elemOp</span><span class="op" id="4973184">,</span>&nbsp;<span class="ident" id="4973186">elemIndir</span>&nbsp;<span class="op" id="4973196">:=</span>&nbsp;<span class="ident" id="4973199">encOpFor</span><span class="op" id="4973207">(</span><span class="ident" id="4973208">t</span><span class="op" id="4973209">.</span><span class="ident" id="4973210">Elem</span><span class="op" id="4973214">(</span><span class="op" id="4973215">)</span><span class="op" id="4973216">,</span>&nbsp;<span class="ident" id="4973218">inProgress</span><span class="op" id="4973228">,</span>&nbsp;<span class="ident" id="4973230">building</span><span class="op" id="4973238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4973243">helper</span>&nbsp;<span class="op" id="4973250">:=</span>&nbsp;<span class="ident" id="4973253">encArrayHelper</span><span class="op" id="4973267">[</span><span class="ident" id="4973268">t</span><span class="op" id="4973269">.</span><span class="ident" id="4973270">Elem</span><span class="op" id="4973274">(</span><span class="op" id="4973275">)</span><span class="op" id="4973276">.</span><span class="ident" id="4973277">Kind</span><span class="op" id="4973281">(</span><span class="op" id="4973282">)</span><span class="op" id="4973283">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4973288">op</span>&nbsp;<span class="op" id="4973291">=</span>&nbsp;<span class="keyword" id="4973293">func</span><span class="op" id="4973297">(</span><span class="ident" id="4973298">i</span>&nbsp;<span class="op" id="4973300">*</span><span class="ident" id="4973301">encInstr</span><span class="op" id="4973309">,</span>&nbsp;<span class="ident" id="4973311">state</span>&nbsp;<span class="op" id="4973317">*</span><span class="ident" id="4973318">encoderState</span><span class="op" id="4973330">,</span>&nbsp;<span class="ident" id="4973332">array</span>&nbsp;<span class="ident" id="4973338">reflect</span><span class="op" id="4973345">.</span><span class="ident" id="4973346">Value</span><span class="op" id="4973351">)</span>&nbsp;<span class="op" id="4973353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4973359">state</span><span class="op" id="4973364">.</span><span class="ident" id="4973365">update</span><span class="op" id="4973371">(</span><span class="ident" id="4973372">i</span><span class="op" id="4973373">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4973379">state</span><span class="op" id="4973384">.</span><span class="ident" id="4973385">enc</span><span class="op" id="4973388">.</span><span class="ident" id="4973389">encodeArray</span><span class="op" id="4973400">(</span><span class="ident" id="4973401">state</span><span class="op" id="4973406">.</span><span class="ident" id="4973407">b</span><span class="op" id="4973408">,</span>&nbsp;<span class="ident" id="4973410">array</span><span class="op" id="4973415">,</span>&nbsp;<span class="op" id="4973417">*</span><span class="ident" id="4973418">elemOp</span><span class="op" id="4973424">,</span>&nbsp;<span class="ident" id="4973426">elemIndir</span><span class="op" id="4973435">,</span>&nbsp;<span class="ident" id="4973437">array</span><span class="op" id="4973442">.</span><span class="ident" id="4973443">Len</span><span class="op" id="4973446">(</span><span class="op" id="4973447">)</span><span class="op" id="4973448">,</span>&nbsp;<span class="ident" id="4973450">helper</span><span class="op" id="4973456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4973461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4973465">case</span>&nbsp;<span class="ident" id="4973470">reflect</span><span class="op" id="4973477">.</span><span class="ident" id="4973478">Map</span><span class="op" id="4973481">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4973486">keyOp</span><span class="op" id="4973491">,</span>&nbsp;<span class="ident" id="4973493">keyIndir</span>&nbsp;<span class="op" id="4973502">:=</span>&nbsp;<span class="ident" id="4973505">encOpFor</span><span class="op" id="4973513">(</span><span class="ident" id="4973514">t</span><span class="op" id="4973515">.</span><span class="ident" id="4973516">Key</span><span class="op" id="4973519">(</span><span class="op" id="4973520">)</span><span class="op" id="4973521">,</span>&nbsp;<span class="ident" id="4973523">inProgress</span><span class="op" id="4973533">,</span>&nbsp;<span class="ident" id="4973535">building</span><span class="op" id="4973543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4973548">elemOp</span><span class="op" id="4973554">,</span>&nbsp;<span class="ident" id="4973556">elemIndir</span>&nbsp;<span class="op" id="4973566">:=</span>&nbsp;<span class="ident" id="4973569">encOpFor</span><span class="op" id="4973577">(</span><span class="ident" id="4973578">t</span><span class="op" id="4973579">.</span><span class="ident" id="4973580">Elem</span><span class="op" id="4973584">(</span><span class="op" id="4973585">)</span><span class="op" id="4973586">,</span>&nbsp;<span class="ident" id="4973588">inProgress</span><span class="op" id="4973598">,</span>&nbsp;<span class="ident" id="4973600">building</span><span class="op" id="4973608">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4973613">op</span>&nbsp;<span class="op" id="4973616">=</span>&nbsp;<span class="keyword" id="4973618">func</span><span class="op" id="4973622">(</span><span class="ident" id="4973623">i</span>&nbsp;<span class="op" id="4973625">*</span><span class="ident" id="4973626">encInstr</span><span class="op" id="4973634">,</span>&nbsp;<span class="ident" id="4973636">state</span>&nbsp;<span class="op" id="4973642">*</span><span class="ident" id="4973643">encoderState</span><span class="op" id="4973655">,</span>&nbsp;<span class="ident" id="4973657">mv</span>&nbsp;<span class="ident" id="4973660">reflect</span><span class="op" id="4973667">.</span><span class="ident" id="4973668">Value</span><span class="op" id="4973673">)</span>&nbsp;<span class="op" id="4973675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4973681">//&nbsp;We&nbsp;send&nbsp;zero-length&nbsp;(but&nbsp;non-nil)&nbsp;maps&nbsp;because&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4973739">//&nbsp;receiver&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;the&nbsp;map.&nbsp;&nbsp;(Maps&nbsp;don&#39;t&nbsp;use&nbsp;append.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4973808">if</span>&nbsp;<span class="op" id="4973811">!</span><span class="ident" id="4973812">state</span><span class="op" id="4973817">.</span><span class="ident" id="4973818">sendZero</span>&nbsp;<span class="op" id="4973827">&amp;&amp;</span>&nbsp;<span class="ident" id="4973830">mv</span><span class="op" id="4973832">.</span><span class="ident" id="4973833">IsNil</span><span class="op" id="4973838">(</span><span class="op" id="4973839">)</span>&nbsp;<span class="op" id="4973841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4973848">return</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4973859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4973865">state</span><span class="op" id="4973870">.</span><span class="ident" id="4973871">update</span><span class="op" id="4973877">(</span><span class="ident" id="4973878">i</span><span class="op" id="4973879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4973885">state</span><span class="op" id="4973890">.</span><span class="ident" id="4973891">enc</span><span class="op" id="4973894">.</span><span class="ident" id="4973895">encodeMap</span><span class="op" id="4973904">(</span><span class="ident" id="4973905">state</span><span class="op" id="4973910">.</span><span class="ident" id="4973911">b</span><span class="op" id="4973912">,</span>&nbsp;<span class="ident" id="4973914">mv</span><span class="op" id="4973916">,</span>&nbsp;<span class="op" id="4973918">*</span><span class="ident" id="4973919">keyOp</span><span class="op" id="4973924">,</span>&nbsp;<span class="op" id="4973926">*</span><span class="ident" id="4973927">elemOp</span><span class="op" id="4973933">,</span>&nbsp;<span class="ident" id="4973935">keyIndir</span><span class="op" id="4973943">,</span>&nbsp;<span class="ident" id="4973945">elemIndir</span><span class="op" id="4973954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4973959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4973963">case</span>&nbsp;<span class="ident" id="4973968">reflect</span><span class="op" id="4973975">.</span><span class="ident" id="4973976">Struct</span><span class="op" id="4973982">:</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4973987">//&nbsp;Generate&nbsp;a&nbsp;closure&nbsp;that&nbsp;calls&nbsp;out&nbsp;to&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;nested&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4974062">getEncEngine</span><span class="op" id="4974074">(</span><span class="ident" id="4974075">userType</span><span class="op" id="4974083">(</span><span class="ident" id="4974084">typ</span><span class="op" id="4974087">)</span><span class="op" id="4974088">,</span>&nbsp;<span class="ident" id="4974090">building</span><span class="op" id="4974098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4974103">info</span>&nbsp;<span class="op" id="4974108">:=</span>&nbsp;<span class="ident" id="4974111">mustGetTypeInfo</span><span class="op" id="4974126">(</span><span class="ident" id="4974127">typ</span><span class="op" id="4974130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4974135">op</span>&nbsp;<span class="op" id="4974138">=</span>&nbsp;<span class="keyword" id="4974140">func</span><span class="op" id="4974144">(</span><span class="ident" id="4974145">i</span>&nbsp;<span class="op" id="4974147">*</span><span class="ident" id="4974148">encInstr</span><span class="op" id="4974156">,</span>&nbsp;<span class="ident" id="4974158">state</span>&nbsp;<span class="op" id="4974164">*</span><span class="ident" id="4974165">encoderState</span><span class="op" id="4974177">,</span>&nbsp;<span class="ident" id="4974179">sv</span>&nbsp;<span class="ident" id="4974182">reflect</span><span class="op" id="4974189">.</span><span class="ident" id="4974190">Value</span><span class="op" id="4974195">)</span>&nbsp;<span class="op" id="4974197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4974203">state</span><span class="op" id="4974208">.</span><span class="ident" id="4974209">update</span><span class="op" id="4974215">(</span><span class="ident" id="4974216">i</span><span class="op" id="4974217">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4974223">//&nbsp;indirect&nbsp;through&nbsp;info&nbsp;to&nbsp;delay&nbsp;evaluation&nbsp;for&nbsp;recursive&nbsp;structs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4974294">enc</span>&nbsp;<span class="op" id="4974298">:=</span>&nbsp;<span class="ident" id="4974301">info</span><span class="op" id="4974305">.</span><span class="ident" id="4974306">encoder</span><span class="op" id="4974313">.</span><span class="ident" id="4974314">Load</span><span class="op" id="4974318">(</span><span class="op" id="4974319">)</span><span class="op" id="4974320">.</span><span class="op" id="4974321">(</span><span class="op" id="4974322">*</span><span class="ident" id="4974323">encEngine</span><span class="op" id="4974332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4974338">state</span><span class="op" id="4974343">.</span><span class="ident" id="4974344">enc</span><span class="op" id="4974347">.</span><span class="ident" id="4974348">encodeStruct</span><span class="op" id="4974360">(</span><span class="ident" id="4974361">state</span><span class="op" id="4974366">.</span><span class="ident" id="4974367">b</span><span class="op" id="4974368">,</span>&nbsp;<span class="ident" id="4974370">enc</span><span class="op" id="4974373">,</span>&nbsp;<span class="ident" id="4974375">sv</span><span class="op" id="4974377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4974382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4974386">case</span>&nbsp;<span class="ident" id="4974391">reflect</span><span class="op" id="4974398">.</span><span class="ident" id="4974399">Interface</span><span class="op" id="4974408">:</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4974413">op</span>&nbsp;<span class="op" id="4974416">=</span>&nbsp;<span class="keyword" id="4974418">func</span><span class="op" id="4974422">(</span><span class="ident" id="4974423">i</span>&nbsp;<span class="op" id="4974425">*</span><span class="ident" id="4974426">encInstr</span><span class="op" id="4974434">,</span>&nbsp;<span class="ident" id="4974436">state</span>&nbsp;<span class="op" id="4974442">*</span><span class="ident" id="4974443">encoderState</span><span class="op" id="4974455">,</span>&nbsp;<span class="ident" id="4974457">iv</span>&nbsp;<span class="ident" id="4974460">reflect</span><span class="op" id="4974467">.</span><span class="ident" id="4974468">Value</span><span class="op" id="4974473">)</span>&nbsp;<span class="op" id="4974475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4974481">if</span>&nbsp;<span class="op" id="4974484">!</span><span class="ident" id="4974485">state</span><span class="op" id="4974490">.</span><span class="ident" id="4974491">sendZero</span>&nbsp;<span class="op" id="4974500">&amp;&amp;</span>&nbsp;<span class="op" id="4974503">(</span><span class="op" id="4974504">!</span><span class="ident" id="4974505">iv</span><span class="op" id="4974507">.</span><span class="ident" id="4974508">IsValid</span><span class="op" id="4974515">(</span><span class="op" id="4974516">)</span>&nbsp;<span class="op" id="4974518">||</span>&nbsp;<span class="ident" id="4974521">iv</span><span class="op" id="4974523">.</span><span class="ident" id="4974524">IsNil</span><span class="op" id="4974529">(</span><span class="op" id="4974530">)</span><span class="op" id="4974531">)</span>&nbsp;<span class="op" id="4974533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4974540">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4974551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4974557">state</span><span class="op" id="4974562">.</span><span class="ident" id="4974563">update</span><span class="op" id="4974569">(</span><span class="ident" id="4974570">i</span><span class="op" id="4974571">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4974577">state</span><span class="op" id="4974582">.</span><span class="ident" id="4974583">enc</span><span class="op" id="4974586">.</span><span class="ident" id="4974587">encodeInterface</span><span class="op" id="4974602">(</span><span class="ident" id="4974603">state</span><span class="op" id="4974608">.</span><span class="ident" id="4974609">b</span><span class="op" id="4974610">,</span>&nbsp;<span class="ident" id="4974612">iv</span><span class="op" id="4974614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4974619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4974623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4974626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4974629">if</span>&nbsp;<span class="ident" id="4974632">op</span>&nbsp;<span class="op" id="4974635">==</span>&nbsp;<span class="ident" id="4974638">nil</span>&nbsp;<span class="op" id="4974642">{</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4974646">errorf</span><span class="op" id="4974652">(</span><span class="string" id="4974653">&#34;can&#39;t&nbsp;happen:&nbsp;encode&nbsp;type&nbsp;%s&#34;</span><span class="op" id="4974683">,</span>&nbsp;<span class="ident" id="4974685">rt</span><span class="op" id="4974687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4974690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4974693">return</span>&nbsp;<span class="op" id="4974700">&amp;</span><span class="ident" id="4974701">op</span><span class="op" id="4974703">,</span>&nbsp;<span class="ident" id="4974705">indir</span><br>
<span class="lineno"></span><span class="op" id="4974711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="comment" id="4974714">//&nbsp;gobEncodeOpFor&nbsp;returns&nbsp;the&nbsp;op&nbsp;for&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;known&nbsp;to&nbsp;implement&nbsp;GobEncoder.</span><br>
<span class="lineno"></span><span class="keyword" id="4974797">func</span>&nbsp;<span class="ident" id="4974802">gobEncodeOpFor</span><span class="op" id="4974816">(</span><span class="ident" id="4974817">ut</span>&nbsp;<span class="op" id="4974820">*</span><span class="ident" id="4974821">userTypeInfo</span><span class="op" id="4974833">)</span>&nbsp;<span class="op" id="4974835">(</span><span class="op" id="4974836">*</span><span class="ident" id="4974837">encOp</span><span class="op" id="4974842">,</span>&nbsp;<span class="builtintype" id="4974844">int</span><span class="op" id="4974847">)</span>&nbsp;<span class="op" id="4974849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4974852">rt</span>&nbsp;<span class="op" id="4974855">:=</span>&nbsp;<span class="ident" id="4974858">ut</span><span class="op" id="4974860">.</span><span class="ident" id="4974861">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4974867">if</span>&nbsp;<span class="ident" id="4974870">ut</span><span class="op" id="4974872">.</span><span class="ident" id="4974873">encIndir</span>&nbsp;<span class="op" id="4974882">==</span>&nbsp;<span class="op" id="4974885">-</span><span class="num" id="4974886">1</span>&nbsp;<span class="op" id="4974888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4974892">rt</span>&nbsp;<span class="op" id="4974895">=</span>&nbsp;<span class="ident" id="4974897">reflect</span><span class="op" id="4974904">.</span><span class="ident" id="4974905">PtrTo</span><span class="op" id="4974910">(</span><span class="ident" id="4974911">rt</span><span class="op" id="4974913">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4974916">}</span>&nbsp;<span class="keyword" id="4974918">else</span>&nbsp;<span class="keyword" id="4974923">if</span>&nbsp;<span class="ident" id="4974926">ut</span><span class="op" id="4974928">.</span><span class="ident" id="4974929">encIndir</span>&nbsp;<span class="op" id="4974938">&gt;</span>&nbsp;<span class="num" id="4974940">0</span>&nbsp;<span class="op" id="4974942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4974946">for</span>&nbsp;<span class="ident" id="4974950">i</span>&nbsp;<span class="op" id="4974952">:=</span>&nbsp;<span class="builtintype" id="4974955">int8</span><span class="op" id="4974959">(</span><span class="num" id="4974960">0</span><span class="op" id="4974961">)</span><span class="op" id="4974962">;</span>&nbsp;<span class="ident" id="4974964">i</span>&nbsp;<span class="op" id="4974966">&lt;</span>&nbsp;<span class="ident" id="4974968">ut</span><span class="op" id="4974970">.</span><span class="ident" id="4974971">encIndir</span><span class="op" id="4974979">;</span>&nbsp;<span class="ident" id="4974981">i</span><span class="op" id="4974982">++</span>&nbsp;<span class="op" id="4974985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4974990">rt</span>&nbsp;<span class="op" id="4974993">=</span>&nbsp;<span class="ident" id="4974995">rt</span><span class="op" id="4974997">.</span><span class="ident" id="4974998">Elem</span><span class="op" id="4975002">(</span><span class="op" id="4975003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4975007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4975010">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975013">var</span>&nbsp;<span class="ident" id="4975017">op</span>&nbsp;<span class="ident" id="4975020">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975027">op</span>&nbsp;<span class="op" id="4975030">=</span>&nbsp;<span class="keyword" id="4975032">func</span><span class="op" id="4975036">(</span><span class="ident" id="4975037">i</span>&nbsp;<span class="op" id="4975039">*</span><span class="ident" id="4975040">encInstr</span><span class="op" id="4975048">,</span>&nbsp;<span class="ident" id="4975050">state</span>&nbsp;<span class="op" id="4975056">*</span><span class="ident" id="4975057">encoderState</span><span class="op" id="4975069">,</span>&nbsp;<span class="ident" id="4975071">v</span>&nbsp;<span class="ident" id="4975073">reflect</span><span class="op" id="4975080">.</span><span class="ident" id="4975081">Value</span><span class="op" id="4975086">)</span>&nbsp;<span class="op" id="4975088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975092">if</span>&nbsp;<span class="ident" id="4975095">ut</span><span class="op" id="4975097">.</span><span class="ident" id="4975098">encIndir</span>&nbsp;<span class="op" id="4975107">==</span>&nbsp;<span class="op" id="4975110">-</span><span class="num" id="4975111">1</span>&nbsp;<span class="op" id="4975113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4975118">//&nbsp;Need&nbsp;to&nbsp;climb&nbsp;up&nbsp;one&nbsp;level&nbsp;to&nbsp;turn&nbsp;value&nbsp;into&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975179">if</span>&nbsp;<span class="op" id="4975182">!</span><span class="ident" id="4975183">v</span><span class="op" id="4975184">.</span><span class="ident" id="4975185">CanAddr</span><span class="op" id="4975192">(</span><span class="op" id="4975193">)</span>&nbsp;<span class="op" id="4975195">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975201">errorf</span><span class="op" id="4975207">(</span><span class="string" id="4975208">&#34;unaddressable&nbsp;value&nbsp;of&nbsp;type&nbsp;%s&#34;</span><span class="op" id="4975240">,</span>&nbsp;<span class="ident" id="4975242">rt</span><span class="op" id="4975244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4975249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975254">v</span>&nbsp;<span class="op" id="4975256">=</span>&nbsp;<span class="ident" id="4975258">v</span><span class="op" id="4975259">.</span><span class="ident" id="4975260">Addr</span><span class="op" id="4975264">(</span><span class="op" id="4975265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4975269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975273">if</span>&nbsp;<span class="op" id="4975276">!</span><span class="ident" id="4975277">state</span><span class="op" id="4975282">.</span><span class="ident" id="4975283">sendZero</span>&nbsp;<span class="op" id="4975292">&amp;&amp;</span>&nbsp;<span class="ident" id="4975295">isZero</span><span class="op" id="4975301">(</span><span class="ident" id="4975302">v</span><span class="op" id="4975303">)</span>&nbsp;<span class="op" id="4975305">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975310">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4975319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975323">state</span><span class="op" id="4975328">.</span><span class="ident" id="4975329">update</span><span class="op" id="4975335">(</span><span class="ident" id="4975336">i</span><span class="op" id="4975337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975341">state</span><span class="op" id="4975346">.</span><span class="ident" id="4975347">enc</span><span class="op" id="4975350">.</span><span class="ident" id="4975351">encodeGobEncoder</span><span class="op" id="4975367">(</span><span class="ident" id="4975368">state</span><span class="op" id="4975373">.</span><span class="ident" id="4975374">b</span><span class="op" id="4975375">,</span>&nbsp;<span class="ident" id="4975377">ut</span><span class="op" id="4975379">,</span>&nbsp;<span class="ident" id="4975381">v</span><span class="op" id="4975382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4975385">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975388">return</span>&nbsp;<span class="op" id="4975395">&amp;</span><span class="ident" id="4975396">op</span><span class="op" id="4975398">,</span>&nbsp;<span class="builtintype" id="4975400">int</span><span class="op" id="4975403">(</span><span class="ident" id="4975404">ut</span><span class="op" id="4975406">.</span><span class="ident" id="4975407">encIndir</span><span class="op" id="4975415">)</span>&nbsp;<span class="comment" id="4975417">//&nbsp;encIndir:&nbsp;op&nbsp;will&nbsp;get&nbsp;called&nbsp;with&nbsp;p&nbsp;==&nbsp;address&nbsp;of&nbsp;receiver.</span><br>
<span class="lineno"></span><span class="op" id="4975480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4975483">//&nbsp;compileEnc&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4975537">func</span>&nbsp;<span class="ident" id="4975542">compileEnc</span><span class="op" id="4975552">(</span><span class="ident" id="4975553">ut</span>&nbsp;<span class="op" id="4975556">*</span><span class="ident" id="4975557">userTypeInfo</span><span class="op" id="4975569">,</span>&nbsp;<span class="ident" id="4975571">building</span>&nbsp;<span class="keyword" id="4975580">map</span><span class="op" id="4975583">[</span><span class="op" id="4975584">*</span><span class="ident" id="4975585">typeInfo</span><span class="op" id="4975593">]</span><span class="builtintype" id="4975594">bool</span><span class="op" id="4975598">)</span>&nbsp;<span class="op" id="4975600">*</span><span class="ident" id="4975601">encEngine</span>&nbsp;<span class="op" id="4975611">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975614">srt</span>&nbsp;<span class="op" id="4975618">:=</span>&nbsp;<span class="ident" id="4975621">ut</span><span class="op" id="4975623">.</span><span class="ident" id="4975624">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975630">engine</span>&nbsp;<span class="op" id="4975637">:=</span>&nbsp;<span class="builtinfunc" id="4975640">new</span><span class="op" id="4975643">(</span><span class="ident" id="4975644">encEngine</span><span class="op" id="4975653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975656">seen</span>&nbsp;<span class="op" id="4975661">:=</span>&nbsp;<span class="builtinfunc" id="4975664">make</span><span class="op" id="4975668">(</span><span class="keyword" id="4975669">map</span><span class="op" id="4975672">[</span><span class="ident" id="4975673">reflect</span><span class="op" id="4975680">.</span><span class="ident" id="4975681">Type</span><span class="op" id="4975685">]</span><span class="op" id="4975686">*</span><span class="ident" id="4975687">encOp</span><span class="op" id="4975692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975695">rt</span>&nbsp;<span class="op" id="4975698">:=</span>&nbsp;<span class="ident" id="4975701">ut</span><span class="op" id="4975703">.</span><span class="ident" id="4975704">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975710">if</span>&nbsp;<span class="ident" id="4975713">ut</span><span class="op" id="4975715">.</span><span class="ident" id="4975716">externalEnc</span>&nbsp;<span class="op" id="4975728">!=</span>&nbsp;<span class="num" id="4975731">0</span>&nbsp;<span class="op" id="4975733">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975737">rt</span>&nbsp;<span class="op" id="4975740">=</span>&nbsp;<span class="ident" id="4975742">ut</span><span class="op" id="4975744">.</span><span class="ident" id="4975745">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4975751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975754">if</span>&nbsp;<span class="ident" id="4975757">ut</span><span class="op" id="4975759">.</span><span class="ident" id="4975760">externalEnc</span>&nbsp;<span class="op" id="4975772">==</span>&nbsp;<span class="num" id="4975775">0</span>&nbsp;<span class="op" id="4975777">&amp;&amp;</span>&nbsp;<span class="ident" id="4975780">srt</span><span class="op" id="4975783">.</span><span class="ident" id="4975784">Kind</span><span class="op" id="4975788">(</span><span class="op" id="4975789">)</span>&nbsp;<span class="op" id="4975791">==</span>&nbsp;<span class="ident" id="4975794">reflect</span><span class="op" id="4975801">.</span><span class="ident" id="4975802">Struct</span>&nbsp;<span class="op" id="4975809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975813">for</span>&nbsp;<span class="ident" id="4975817">fieldNum</span><span class="op" id="4975825">,</span>&nbsp;<span class="ident" id="4975827">wireFieldNum</span>&nbsp;<span class="op" id="4975840">:=</span>&nbsp;<span class="num" id="4975843">0</span><span class="op" id="4975844">,</span>&nbsp;<span class="num" id="4975846">0</span><span class="op" id="4975847">;</span>&nbsp;<span class="ident" id="4975849">fieldNum</span>&nbsp;<span class="op" id="4975858">&lt;</span>&nbsp;<span class="ident" id="4975860">srt</span><span class="op" id="4975863">.</span><span class="ident" id="4975864">NumField</span><span class="op" id="4975872">(</span><span class="op" id="4975873">)</span><span class="op" id="4975874">;</span>&nbsp;<span class="ident" id="4975876">fieldNum</span><span class="op" id="4975884">++</span>&nbsp;<span class="op" id="4975887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975892">f</span>&nbsp;<span class="op" id="4975894">:=</span>&nbsp;<span class="ident" id="4975897">srt</span><span class="op" id="4975900">.</span><span class="ident" id="4975901">Field</span><span class="op" id="4975906">(</span><span class="ident" id="4975907">fieldNum</span><span class="op" id="4975915">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975920">if</span>&nbsp;<span class="op" id="4975923">!</span><span class="ident" id="4975924">isSent</span><span class="op" id="4975930">(</span><span class="op" id="4975931">&amp;</span><span class="ident" id="4975932">f</span><span class="op" id="4975933">)</span>&nbsp;<span class="op" id="4975935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975941">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4975953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975958">op</span><span class="op" id="4975960">,</span>&nbsp;<span class="ident" id="4975962">indir</span>&nbsp;<span class="op" id="4975968">:=</span>&nbsp;<span class="ident" id="4975971">encOpFor</span><span class="op" id="4975979">(</span><span class="ident" id="4975980">f</span><span class="op" id="4975981">.</span><span class="ident" id="4975982">Type</span><span class="op" id="4975986">,</span>&nbsp;<span class="ident" id="4975988">seen</span><span class="op" id="4975992">,</span>&nbsp;<span class="ident" id="4975994">building</span><span class="op" id="4976002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976007">engine</span><span class="op" id="4976013">.</span><span class="ident" id="4976014">instr</span>&nbsp;<span class="op" id="4976020">=</span>&nbsp;<span class="builtinfunc" id="4976022">append</span><span class="op" id="4976028">(</span><span class="ident" id="4976029">engine</span><span class="op" id="4976035">.</span><span class="ident" id="4976036">instr</span><span class="op" id="4976041">,</span>&nbsp;<span class="ident" id="4976043">encInstr</span><span class="op" id="4976051">{</span><span class="op" id="4976052">*</span><span class="ident" id="4976053">op</span><span class="op" id="4976055">,</span>&nbsp;<span class="ident" id="4976057">wireFieldNum</span><span class="op" id="4976069">,</span>&nbsp;<span class="ident" id="4976071">f</span><span class="op" id="4976072">.</span><span class="ident" id="4976073">Index</span><span class="op" id="4976078">,</span>&nbsp;<span class="ident" id="4976080">indir</span><span class="op" id="4976085">}</span><span class="op" id="4976086">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976091">wireFieldNum</span><span class="op" id="4976103">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4976108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4976112">if</span>&nbsp;<span class="ident" id="4976115">srt</span><span class="op" id="4976118">.</span><span class="ident" id="4976119">NumField</span><span class="op" id="4976127">(</span><span class="op" id="4976128">)</span>&nbsp;<span class="op" id="4976130">&gt;</span>&nbsp;<span class="num" id="4976132">0</span>&nbsp;<span class="op" id="4976134">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4976137">len</span><span class="op" id="4976140">(</span><span class="ident" id="4976141">engine</span><span class="op" id="4976147">.</span><span class="ident" id="4976148">instr</span><span class="op" id="4976153">)</span>&nbsp;<span class="op" id="4976155">==</span>&nbsp;<span class="num" id="4976158">0</span>&nbsp;<span class="op" id="4976160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976165">errorf</span><span class="op" id="4976171">(</span><span class="string" id="4976172">&#34;type&nbsp;%s&nbsp;has&nbsp;no&nbsp;exported&nbsp;fields&#34;</span><span class="op" id="4976204">,</span>&nbsp;<span class="ident" id="4976206">rt</span><span class="op" id="4976208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4976212">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976216">engine</span><span class="op" id="4976222">.</span><span class="ident" id="4976223">instr</span>&nbsp;<span class="op" id="4976229">=</span>&nbsp;<span class="builtinfunc" id="4976231">append</span><span class="op" id="4976237">(</span><span class="ident" id="4976238">engine</span><span class="op" id="4976244">.</span><span class="ident" id="4976245">instr</span><span class="op" id="4976250">,</span>&nbsp;<span class="ident" id="4976252">encInstr</span><span class="op" id="4976260">{</span><span class="ident" id="4976261">encStructTerminator</span><span class="op" id="4976280">,</span>&nbsp;<span class="num" id="4976282">0</span><span class="op" id="4976283">,</span>&nbsp;<span class="ident" id="4976285">nil</span><span class="op" id="4976288">,</span>&nbsp;<span class="num" id="4976290">0</span><span class="op" id="4976291">}</span><span class="op" id="4976292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4976295">}</span>&nbsp;<span class="keyword" id="4976297">else</span>&nbsp;<span class="op" id="4976302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976306">engine</span><span class="op" id="4976312">.</span><span class="ident" id="4976313">instr</span>&nbsp;<span class="op" id="4976319">=</span>&nbsp;<span class="builtinfunc" id="4976321">make</span><span class="op" id="4976325">(</span><span class="op" id="4976326">[</span><span class="op" id="4976327">]</span><span class="ident" id="4976328">encInstr</span><span class="op" id="4976336">,</span>&nbsp;<span class="num" id="4976338">1</span><span class="op" id="4976339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976343">op</span><span class="op" id="4976345">,</span>&nbsp;<span class="ident" id="4976347">indir</span>&nbsp;<span class="op" id="4976353">:=</span>&nbsp;<span class="ident" id="4976356">encOpFor</span><span class="op" id="4976364">(</span><span class="ident" id="4976365">rt</span><span class="op" id="4976367">,</span>&nbsp;<span class="ident" id="4976369">seen</span><span class="op" id="4976373">,</span>&nbsp;<span class="ident" id="4976375">building</span><span class="op" id="4976383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976387">engine</span><span class="op" id="4976393">.</span><span class="ident" id="4976394">instr</span><span class="op" id="4976399">[</span><span class="num" id="4976400">0</span><span class="op" id="4976401">]</span>&nbsp;<span class="op" id="4976403">=</span>&nbsp;<span class="ident" id="4976405">encInstr</span><span class="op" id="4976413">{</span><span class="op" id="4976414">*</span><span class="ident" id="4976415">op</span><span class="op" id="4976417">,</span>&nbsp;<span class="ident" id="4976419">singletonField</span><span class="op" id="4976433">,</span>&nbsp;<span class="ident" id="4976435">nil</span><span class="op" id="4976438">,</span>&nbsp;<span class="ident" id="4976440">indir</span><span class="op" id="4976445">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4976448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4976451">return</span>&nbsp;<span class="ident" id="4976458">engine</span><br>
<span class="lineno"></span><span class="op" id="4976465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4976468">//&nbsp;getEncEngine&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno">650</span><span class="keyword" id="4976524">func</span>&nbsp;<span class="ident" id="4976529">getEncEngine</span><span class="op" id="4976541">(</span><span class="ident" id="4976542">ut</span>&nbsp;<span class="op" id="4976545">*</span><span class="ident" id="4976546">userTypeInfo</span><span class="op" id="4976558">,</span>&nbsp;<span class="ident" id="4976560">building</span>&nbsp;<span class="keyword" id="4976569">map</span><span class="op" id="4976572">[</span><span class="op" id="4976573">*</span><span class="ident" id="4976574">typeInfo</span><span class="op" id="4976582">]</span><span class="builtintype" id="4976583">bool</span><span class="op" id="4976587">)</span>&nbsp;<span class="op" id="4976589">*</span><span class="ident" id="4976590">encEngine</span>&nbsp;<span class="op" id="4976600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976603">info</span><span class="op" id="4976607">,</span>&nbsp;<span class="ident" id="4976609">err</span>&nbsp;<span class="op" id="4976613">:=</span>&nbsp;<span class="ident" id="4976616">getTypeInfo</span><span class="op" id="4976627">(</span><span class="ident" id="4976628">ut</span><span class="op" id="4976630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4976633">if</span>&nbsp;<span class="ident" id="4976636">err</span>&nbsp;<span class="op" id="4976640">!=</span>&nbsp;<span class="ident" id="4976643">nil</span>&nbsp;<span class="op" id="4976647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976651">error_</span><span class="op" id="4976657">(</span><span class="ident" id="4976658">err</span><span class="op" id="4976661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4976664">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976667">enc</span><span class="op" id="4976670">,</span>&nbsp;<span class="ident" id="4976672">ok</span>&nbsp;<span class="op" id="4976675">:=</span>&nbsp;<span class="ident" id="4976678">info</span><span class="op" id="4976682">.</span><span class="ident" id="4976683">encoder</span><span class="op" id="4976690">.</span><span class="ident" id="4976691">Load</span><span class="op" id="4976695">(</span><span class="op" id="4976696">)</span><span class="op" id="4976697">.</span><span class="op" id="4976698">(</span><span class="op" id="4976699">*</span><span class="ident" id="4976700">encEngine</span><span class="op" id="4976709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4976712">if</span>&nbsp;<span class="op" id="4976715">!</span><span class="ident" id="4976716">ok</span>&nbsp;<span class="op" id="4976719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976723">enc</span>&nbsp;<span class="op" id="4976727">=</span>&nbsp;<span class="ident" id="4976729">buildEncEngine</span><span class="op" id="4976743">(</span><span class="ident" id="4976744">info</span><span class="op" id="4976748">,</span>&nbsp;<span class="ident" id="4976750">ut</span><span class="op" id="4976752">,</span>&nbsp;<span class="ident" id="4976754">building</span><span class="op" id="4976762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4976765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4976768">return</span>&nbsp;<span class="ident" id="4976775">enc</span><br>
<span class="lineno">660</span><span class="op" id="4976779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4976782">func</span>&nbsp;<span class="ident" id="4976787">buildEncEngine</span><span class="op" id="4976801">(</span><span class="ident" id="4976802">info</span>&nbsp;<span class="op" id="4976807">*</span><span class="ident" id="4976808">typeInfo</span><span class="op" id="4976816">,</span>&nbsp;<span class="ident" id="4976818">ut</span>&nbsp;<span class="op" id="4976821">*</span><span class="ident" id="4976822">userTypeInfo</span><span class="op" id="4976834">,</span>&nbsp;<span class="ident" id="4976836">building</span>&nbsp;<span class="keyword" id="4976845">map</span><span class="op" id="4976848">[</span><span class="op" id="4976849">*</span><span class="ident" id="4976850">typeInfo</span><span class="op" id="4976858">]</span><span class="builtintype" id="4976859">bool</span><span class="op" id="4976863">)</span>&nbsp;<span class="op" id="4976865">*</span><span class="ident" id="4976866">encEngine</span>&nbsp;<span class="op" id="4976876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4976879">//&nbsp;Check&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4976910">if</span>&nbsp;<span class="ident" id="4976913">building</span>&nbsp;<span class="op" id="4976922">!=</span>&nbsp;<span class="ident" id="4976925">nil</span>&nbsp;<span class="op" id="4976929">&amp;&amp;</span>&nbsp;<span class="ident" id="4976932">building</span><span class="op" id="4976940">[</span><span class="ident" id="4976941">info</span><span class="op" id="4976945">]</span>&nbsp;<span class="op" id="4976947">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4976951">return</span>&nbsp;<span class="ident" id="4976958">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4976963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976966">info</span><span class="op" id="4976970">.</span><span class="ident" id="4976971">encInit</span><span class="op" id="4976978">.</span><span class="ident" id="4976979">Lock</span><span class="op" id="4976983">(</span><span class="op" id="4976984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4976987">defer</span>&nbsp;<span class="ident" id="4976993">info</span><span class="op" id="4976997">.</span><span class="ident" id="4976998">encInit</span><span class="op" id="4977005">.</span><span class="ident" id="4977006">Unlock</span><span class="op" id="4977012">(</span><span class="op" id="4977013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977016">enc</span><span class="op" id="4977019">,</span>&nbsp;<span class="ident" id="4977021">ok</span>&nbsp;<span class="op" id="4977024">:=</span>&nbsp;<span class="ident" id="4977027">info</span><span class="op" id="4977031">.</span><span class="ident" id="4977032">encoder</span><span class="op" id="4977039">.</span><span class="ident" id="4977040">Load</span><span class="op" id="4977044">(</span><span class="op" id="4977045">)</span><span class="op" id="4977046">.</span><span class="op" id="4977047">(</span><span class="op" id="4977048">*</span><span class="ident" id="4977049">encEngine</span><span class="op" id="4977058">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4977061">if</span>&nbsp;<span class="op" id="4977064">!</span><span class="ident" id="4977065">ok</span>&nbsp;<span class="op" id="4977068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4977072">if</span>&nbsp;<span class="ident" id="4977075">building</span>&nbsp;<span class="op" id="4977084">==</span>&nbsp;<span class="ident" id="4977087">nil</span>&nbsp;<span class="op" id="4977091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977096">building</span>&nbsp;<span class="op" id="4977105">=</span>&nbsp;<span class="builtinfunc" id="4977107">make</span><span class="op" id="4977111">(</span><span class="keyword" id="4977112">map</span><span class="op" id="4977115">[</span><span class="op" id="4977116">*</span><span class="ident" id="4977117">typeInfo</span><span class="op" id="4977125">]</span><span class="builtintype" id="4977126">bool</span><span class="op" id="4977130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4977134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977138">building</span><span class="op" id="4977146">[</span><span class="ident" id="4977147">info</span><span class="op" id="4977151">]</span>&nbsp;<span class="op" id="4977153">=</span>&nbsp;<span class="builtintype" id="4977155">true</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977162">enc</span>&nbsp;<span class="op" id="4977166">=</span>&nbsp;<span class="ident" id="4977168">compileEnc</span><span class="op" id="4977178">(</span><span class="ident" id="4977179">ut</span><span class="op" id="4977181">,</span>&nbsp;<span class="ident" id="4977183">building</span><span class="op" id="4977191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977195">info</span><span class="op" id="4977199">.</span><span class="ident" id="4977200">encoder</span><span class="op" id="4977207">.</span><span class="ident" id="4977208">Store</span><span class="op" id="4977213">(</span><span class="ident" id="4977214">enc</span><span class="op" id="4977217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4977220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4977223">return</span>&nbsp;<span class="ident" id="4977230">enc</span><br>
<span class="lineno"></span><span class="op" id="4977234">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="4977237">func</span>&nbsp;<span class="op" id="4977242">(</span><span class="ident" id="4977243">enc</span>&nbsp;<span class="op" id="4977247">*</span><span class="ident" id="4977248">Encoder</span><span class="op" id="4977255">)</span>&nbsp;<span class="ident" id="4977257">encode</span><span class="op" id="4977263">(</span><span class="ident" id="4977264">b</span>&nbsp;<span class="op" id="4977266">*</span><span class="ident" id="4977267">encBuffer</span><span class="op" id="4977276">,</span>&nbsp;<span class="ident" id="4977278">value</span>&nbsp;<span class="ident" id="4977284">reflect</span><span class="op" id="4977291">.</span><span class="ident" id="4977292">Value</span><span class="op" id="4977297">,</span>&nbsp;<span class="ident" id="4977299">ut</span>&nbsp;<span class="op" id="4977302">*</span><span class="ident" id="4977303">userTypeInfo</span><span class="op" id="4977315">)</span>&nbsp;<span class="op" id="4977317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4977320">defer</span>&nbsp;<span class="ident" id="4977326">catchError</span><span class="op" id="4977336">(</span><span class="op" id="4977337">&amp;</span><span class="ident" id="4977338">enc</span><span class="op" id="4977341">.</span><span class="ident" id="4977342">err</span><span class="op" id="4977345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977348">engine</span>&nbsp;<span class="op" id="4977355">:=</span>&nbsp;<span class="ident" id="4977358">getEncEngine</span><span class="op" id="4977370">(</span><span class="ident" id="4977371">ut</span><span class="op" id="4977373">,</span>&nbsp;<span class="ident" id="4977375">nil</span><span class="op" id="4977378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977381">indir</span>&nbsp;<span class="op" id="4977387">:=</span>&nbsp;<span class="ident" id="4977390">ut</span><span class="op" id="4977392">.</span><span class="ident" id="4977393">indir</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4977400">if</span>&nbsp;<span class="ident" id="4977403">ut</span><span class="op" id="4977405">.</span><span class="ident" id="4977406">externalEnc</span>&nbsp;<span class="op" id="4977418">!=</span>&nbsp;<span class="num" id="4977421">0</span>&nbsp;<span class="op" id="4977423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977427">indir</span>&nbsp;<span class="op" id="4977433">=</span>&nbsp;<span class="builtintype" id="4977435">int</span><span class="op" id="4977438">(</span><span class="ident" id="4977439">ut</span><span class="op" id="4977441">.</span><span class="ident" id="4977442">encIndir</span><span class="op" id="4977450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4977453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4977456">for</span>&nbsp;<span class="ident" id="4977460">i</span>&nbsp;<span class="op" id="4977462">:=</span>&nbsp;<span class="num" id="4977465">0</span><span class="op" id="4977466">;</span>&nbsp;<span class="ident" id="4977468">i</span>&nbsp;<span class="op" id="4977470">&lt;</span>&nbsp;<span class="ident" id="4977472">indir</span><span class="op" id="4977477">;</span>&nbsp;<span class="ident" id="4977479">i</span><span class="op" id="4977480">++</span>&nbsp;<span class="op" id="4977483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977487">value</span>&nbsp;<span class="op" id="4977493">=</span>&nbsp;<span class="ident" id="4977495">reflect</span><span class="op" id="4977502">.</span><span class="ident" id="4977503">Indirect</span><span class="op" id="4977511">(</span><span class="ident" id="4977512">value</span><span class="op" id="4977517">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4977520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4977523">if</span>&nbsp;<span class="ident" id="4977526">ut</span><span class="op" id="4977528">.</span><span class="ident" id="4977529">externalEnc</span>&nbsp;<span class="op" id="4977541">==</span>&nbsp;<span class="num" id="4977544">0</span>&nbsp;<span class="op" id="4977546">&amp;&amp;</span>&nbsp;<span class="ident" id="4977549">value</span><span class="op" id="4977554">.</span><span class="ident" id="4977555">Type</span><span class="op" id="4977559">(</span><span class="op" id="4977560">)</span><span class="op" id="4977561">.</span><span class="ident" id="4977562">Kind</span><span class="op" id="4977566">(</span><span class="op" id="4977567">)</span>&nbsp;<span class="op" id="4977569">==</span>&nbsp;<span class="ident" id="4977572">reflect</span><span class="op" id="4977579">.</span><span class="ident" id="4977580">Struct</span>&nbsp;<span class="op" id="4977587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977591">enc</span><span class="op" id="4977594">.</span><span class="ident" id="4977595">encodeStruct</span><span class="op" id="4977607">(</span><span class="ident" id="4977608">b</span><span class="op" id="4977609">,</span>&nbsp;<span class="ident" id="4977611">engine</span><span class="op" id="4977617">,</span>&nbsp;<span class="ident" id="4977619">value</span><span class="op" id="4977624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4977627">}</span>&nbsp;<span class="keyword" id="4977629">else</span>&nbsp;<span class="op" id="4977634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977638">enc</span><span class="op" id="4977641">.</span><span class="ident" id="4977642">encodeSingle</span><span class="op" id="4977654">(</span><span class="ident" id="4977655">b</span><span class="op" id="4977656">,</span>&nbsp;<span class="ident" id="4977658">engine</span><span class="op" id="4977664">,</span>&nbsp;<span class="ident" id="4977666">value</span><span class="op" id="4977671">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4977674">}</span><br>
<span class="lineno"></span><span class="op" id="4977676">}</span>
</div>
</body>
</html>
