<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5452832">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5452887">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5452941">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5452992">//&nbsp;Package&nbsp;bzip2&nbsp;implements&nbsp;bzip2&nbsp;decompression.</span><br>
<span class="lineno"></span><span class="keyword" id="5453041">package</span>&nbsp;<span class="ident" id="5453049">bzip2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5453056">import</span>&nbsp;<span class="string" id="5453063">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="5453069">//&nbsp;There&#39;s&nbsp;no&nbsp;RFC&nbsp;for&nbsp;bzip2.&nbsp;I&nbsp;used&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for&nbsp;reference&nbsp;and&nbsp;a&nbsp;lot</span><br>
<span class="lineno"></span><span class="comment" id="5453148">//&nbsp;of&nbsp;guessing:&nbsp;http://en.wikipedia.org/wiki/Bzip2</span><br>
<span class="lineno"></span><span class="comment" id="5453199">//&nbsp;The&nbsp;source&nbsp;code&nbsp;to&nbsp;pyflate&nbsp;was&nbsp;useful&nbsp;for&nbsp;debugging:</span><br>
<span class="lineno"></span><span class="comment" id="5453255">//&nbsp;http://www.paul.sladen.org/projects/pyflate</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="5453303">//&nbsp;A&nbsp;StructuralError&nbsp;is&nbsp;returned&nbsp;when&nbsp;the&nbsp;bzip2&nbsp;data&nbsp;is&nbsp;found&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5453371">//&nbsp;syntactically&nbsp;invalid.</span><br>
<span class="lineno"></span><span class="keyword" id="5453397">type</span>&nbsp;<span class="ident" id="5453402">StructuralError</span>&nbsp;<span class="builtintype" id="5453418">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5453426">func</span>&nbsp;<span class="op" id="5453431">(</span><span class="ident" id="5453432">s</span>&nbsp;<span class="ident" id="5453434">StructuralError</span><span class="op" id="5453449">)</span>&nbsp;<span class="ident" id="5453451">Error</span><span class="op" id="5453456">(</span><span class="op" id="5453457">)</span>&nbsp;<span class="builtintype" id="5453459">string</span>&nbsp;<span class="op" id="5453466">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453469">return</span>&nbsp;<span class="string" id="5453476">&#34;bzip2&nbsp;data&nbsp;invalid:&nbsp;&#34;</span>&nbsp;<span class="op" id="5453499">+</span>&nbsp;<span class="builtintype" id="5453501">string</span><span class="op" id="5453507">(</span><span class="ident" id="5453508">s</span><span class="op" id="5453509">)</span><br>
<span class="lineno"></span><span class="op" id="5453511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5453514">//&nbsp;A&nbsp;reader&nbsp;decompresses&nbsp;bzip2&nbsp;compressed&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5453562">type</span>&nbsp;<span class="ident" id="5453567">reader</span>&nbsp;<span class="keyword" id="5453574">struct</span>&nbsp;<span class="op" id="5453581">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453584">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453597">bitReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453608">fileCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5453621">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453629">blockCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5453642">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453650">wantBlockCRC</span>&nbsp;<span class="builtintype" id="5453663">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453671">setupDone</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5453684">bool</span>&nbsp;<span class="comment" id="5453689">//&nbsp;true&nbsp;if&nbsp;we&nbsp;have&nbsp;parsed&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453734">blockSize</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5453747">int</span>&nbsp;&nbsp;<span class="comment" id="5453752">//&nbsp;blockSize&nbsp;in&nbsp;bytes,&nbsp;i.e.&nbsp;900&nbsp;*&nbsp;1024.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453793">eof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5453806">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453812">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5453825">[</span><span class="op" id="5453826">]</span><span class="builtintype" id="5453827">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5453835">//&nbsp;stores&nbsp;Burrows-Wheeler&nbsp;transformed&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453880">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5453893">[</span><span class="num" id="5453894">256</span><span class="op" id="5453897">]</span><span class="builtintype" id="5453898">uint</span>&nbsp;<span class="comment" id="5453903">//&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;for&nbsp;the&nbsp;inverse&nbsp;BWT.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453942">tt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5453955">[</span><span class="op" id="5453956">]</span><span class="builtintype" id="5453957">uint32</span>&nbsp;&nbsp;<span class="comment" id="5453965">//&nbsp;mirrors&nbsp;the&nbsp;`tt&#39;&nbsp;array&nbsp;in&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;and&nbsp;contains&nbsp;the&nbsp;P&nbsp;array&nbsp;in&nbsp;the&nbsp;upper&nbsp;24&nbsp;bits.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454059">tPos</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5454072">uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5454082">//&nbsp;Index&nbsp;of&nbsp;the&nbsp;next&nbsp;output&nbsp;byte&nbsp;in&nbsp;tt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454124">preRLE</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5454136">[</span><span class="op" id="5454137">]</span><span class="builtintype" id="5454138">uint32</span>&nbsp;<span class="comment" id="5454145">//&nbsp;contains&nbsp;the&nbsp;RLE&nbsp;data&nbsp;still&nbsp;to&nbsp;be&nbsp;processed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454194">preRLEUsed</span>&nbsp;&nbsp;<span class="builtintype" id="5454206">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5454215">//&nbsp;number&nbsp;of&nbsp;entries&nbsp;of&nbsp;preRLE&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454253">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5454265">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5454274">//&nbsp;the&nbsp;last&nbsp;byte&nbsp;value&nbsp;seen.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454304">byteRepeats</span>&nbsp;<span class="builtintype" id="5454316">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5454325">//&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;lastByte&nbsp;seen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454369">repeats</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5454381">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5454390">//&nbsp;the&nbsp;number&nbsp;of&nbsp;copies&nbsp;of&nbsp;lastByte&nbsp;to&nbsp;output.</span><br>
<span class="lineno"></span><span class="op" id="5454437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5454440">//&nbsp;NewReader&nbsp;returns&nbsp;an&nbsp;io.Reader&nbsp;which&nbsp;decompresses&nbsp;bzip2&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">45</span><span class="comment" id="5454512">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="5454559">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5454621">func</span>&nbsp;<span class="ident" id="5454626">NewReader</span><span class="op" id="5454635">(</span><span class="ident" id="5454636">r</span>&nbsp;<span class="ident" id="5454638">io</span><span class="op" id="5454640">.</span><span class="ident" id="5454641">Reader</span><span class="op" id="5454647">)</span>&nbsp;<span class="ident" id="5454649">io</span><span class="op" id="5454651">.</span><span class="ident" id="5454652">Reader</span>&nbsp;<span class="op" id="5454659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454662">bz2</span>&nbsp;<span class="op" id="5454666">:=</span>&nbsp;<span class="builtinfunc" id="5454669">new</span><span class="op" id="5454672">(</span><span class="ident" id="5454673">reader</span><span class="op" id="5454679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454682">bz2</span><span class="op" id="5454685">.</span><span class="ident" id="5454686">br</span>&nbsp;<span class="op" id="5454689">=</span>&nbsp;<span class="ident" id="5454691">newBitReader</span><span class="op" id="5454703">(</span><span class="ident" id="5454704">r</span><span class="op" id="5454705">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454708">return</span>&nbsp;<span class="ident" id="5454715">bz2</span><br>
<span class="lineno"></span><span class="op" id="5454719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5454722">const</span>&nbsp;<span class="ident" id="5454728">bzip2FileMagic</span>&nbsp;<span class="op" id="5454743">=</span>&nbsp;<span class="num" id="5454745">0x425a</span>&nbsp;<span class="comment" id="5454752">//&nbsp;&#34;BZ&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="5454760">const</span>&nbsp;<span class="ident" id="5454766">bzip2BlockMagic</span>&nbsp;<span class="op" id="5454782">=</span>&nbsp;<span class="num" id="5454784">0x314159265359</span><br>
<span class="lineno">55</span><span class="keyword" id="5454799">const</span>&nbsp;<span class="ident" id="5454805">bzip2FinalMagic</span>&nbsp;<span class="op" id="5454821">=</span>&nbsp;<span class="num" id="5454823">0x177245385090</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5454839">//&nbsp;setup&nbsp;parses&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="5454873">func</span>&nbsp;<span class="op" id="5454878">(</span><span class="ident" id="5454879">bz2</span>&nbsp;<span class="op" id="5454883">*</span><span class="ident" id="5454884">reader</span><span class="op" id="5454890">)</span>&nbsp;<span class="ident" id="5454892">setup</span><span class="op" id="5454897">(</span><span class="ident" id="5454898">needMagic</span>&nbsp;<span class="builtintype" id="5454908">bool</span><span class="op" id="5454912">)</span>&nbsp;<span class="builtintype" id="5454914">error</span>&nbsp;<span class="op" id="5454920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454923">br</span>&nbsp;<span class="op" id="5454926">:=</span>&nbsp;<span class="op" id="5454929">&amp;</span><span class="ident" id="5454930">bz2</span><span class="op" id="5454933">.</span><span class="ident" id="5454934">br</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454939">if</span>&nbsp;<span class="ident" id="5454942">needMagic</span>&nbsp;<span class="op" id="5454952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454956">magic</span>&nbsp;<span class="op" id="5454962">:=</span>&nbsp;<span class="ident" id="5454965">br</span><span class="op" id="5454967">.</span><span class="ident" id="5454968">ReadBits</span><span class="op" id="5454976">(</span><span class="num" id="5454977">16</span><span class="op" id="5454979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454983">if</span>&nbsp;<span class="ident" id="5454986">magic</span>&nbsp;<span class="op" id="5454992">!=</span>&nbsp;<span class="ident" id="5454995">bzip2FileMagic</span>&nbsp;<span class="op" id="5455010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455015">return</span>&nbsp;<span class="ident" id="5455022">StructuralError</span><span class="op" id="5455037">(</span><span class="string" id="5455038">&#34;bad&nbsp;magic&nbsp;value&#34;</span><span class="op" id="5455055">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455066">t</span>&nbsp;<span class="op" id="5455068">:=</span>&nbsp;<span class="ident" id="5455071">br</span><span class="op" id="5455073">.</span><span class="ident" id="5455074">ReadBits</span><span class="op" id="5455082">(</span><span class="num" id="5455083">8</span><span class="op" id="5455084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455087">if</span>&nbsp;<span class="ident" id="5455090">t</span>&nbsp;<span class="op" id="5455092">!=</span>&nbsp;<span class="string" id="5455095">&#39;h&#39;</span>&nbsp;<span class="op" id="5455099">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455103">return</span>&nbsp;<span class="ident" id="5455110">StructuralError</span><span class="op" id="5455125">(</span><span class="string" id="5455126">&#34;non-Huffman&nbsp;entropy&nbsp;encoding&#34;</span><span class="op" id="5455156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455163">level</span>&nbsp;<span class="op" id="5455169">:=</span>&nbsp;<span class="ident" id="5455172">br</span><span class="op" id="5455174">.</span><span class="ident" id="5455175">ReadBits</span><span class="op" id="5455183">(</span><span class="num" id="5455184">8</span><span class="op" id="5455185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455188">if</span>&nbsp;<span class="ident" id="5455191">level</span>&nbsp;<span class="op" id="5455197">&lt;</span>&nbsp;<span class="string" id="5455199">&#39;1&#39;</span>&nbsp;<span class="op" id="5455203">||</span>&nbsp;<span class="ident" id="5455206">level</span>&nbsp;<span class="op" id="5455212">&gt;</span>&nbsp;<span class="string" id="5455214">&#39;9&#39;</span>&nbsp;<span class="op" id="5455218">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455222">return</span>&nbsp;<span class="ident" id="5455229">StructuralError</span><span class="op" id="5455244">(</span><span class="string" id="5455245">&#34;invalid&nbsp;compression&nbsp;level&#34;</span><span class="op" id="5455272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455279">bz2</span><span class="op" id="5455282">.</span><span class="ident" id="5455283">fileCRC</span>&nbsp;<span class="op" id="5455291">=</span>&nbsp;<span class="num" id="5455293">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455296">bz2</span><span class="op" id="5455299">.</span><span class="ident" id="5455300">blockSize</span>&nbsp;<span class="op" id="5455310">=</span>&nbsp;<span class="num" id="5455312">100</span>&nbsp;<span class="op" id="5455316">*</span>&nbsp;<span class="num" id="5455318">1024</span>&nbsp;<span class="op" id="5455323">*</span>&nbsp;<span class="op" id="5455325">(</span><span class="builtintype" id="5455326">int</span><span class="op" id="5455329">(</span><span class="ident" id="5455330">level</span><span class="op" id="5455335">)</span>&nbsp;<span class="op" id="5455337">-</span>&nbsp;<span class="string" id="5455339">&#39;0&#39;</span><span class="op" id="5455342">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455345">if</span>&nbsp;<span class="ident" id="5455348">bz2</span><span class="op" id="5455351">.</span><span class="ident" id="5455352">blockSize</span>&nbsp;<span class="op" id="5455362">&gt;</span>&nbsp;<span class="builtinfunc" id="5455364">len</span><span class="op" id="5455367">(</span><span class="ident" id="5455368">bz2</span><span class="op" id="5455371">.</span><span class="ident" id="5455372">tt</span><span class="op" id="5455374">)</span>&nbsp;<span class="op" id="5455376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455380">bz2</span><span class="op" id="5455383">.</span><span class="ident" id="5455384">tt</span>&nbsp;<span class="op" id="5455387">=</span>&nbsp;<span class="builtinfunc" id="5455389">make</span><span class="op" id="5455393">(</span><span class="op" id="5455394">[</span><span class="op" id="5455395">]</span><span class="builtintype" id="5455396">uint32</span><span class="op" id="5455402">,</span>&nbsp;<span class="ident" id="5455404">bz2</span><span class="op" id="5455407">.</span><span class="ident" id="5455408">blockSize</span><span class="op" id="5455417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455423">return</span>&nbsp;<span class="ident" id="5455430">nil</span><br>
<span class="lineno"></span><span class="op" id="5455434">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="5455437">func</span>&nbsp;<span class="op" id="5455442">(</span><span class="ident" id="5455443">bz2</span>&nbsp;<span class="op" id="5455447">*</span><span class="ident" id="5455448">reader</span><span class="op" id="5455454">)</span>&nbsp;<span class="ident" id="5455456">Read</span><span class="op" id="5455460">(</span><span class="ident" id="5455461">buf</span>&nbsp;<span class="op" id="5455465">[</span><span class="op" id="5455466">]</span><span class="builtintype" id="5455467">byte</span><span class="op" id="5455471">)</span>&nbsp;<span class="op" id="5455473">(</span><span class="ident" id="5455474">n</span>&nbsp;<span class="builtintype" id="5455476">int</span><span class="op" id="5455479">,</span>&nbsp;<span class="ident" id="5455481">err</span>&nbsp;<span class="builtintype" id="5455485">error</span><span class="op" id="5455490">)</span>&nbsp;<span class="op" id="5455492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455495">if</span>&nbsp;<span class="ident" id="5455498">bz2</span><span class="op" id="5455501">.</span><span class="ident" id="5455502">eof</span>&nbsp;<span class="op" id="5455506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455510">return</span>&nbsp;<span class="num" id="5455517">0</span><span class="op" id="5455518">,</span>&nbsp;<span class="ident" id="5455520">io</span><span class="op" id="5455522">.</span><span class="ident" id="5455523">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455528">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455532">if</span>&nbsp;<span class="op" id="5455535">!</span><span class="ident" id="5455536">bz2</span><span class="op" id="5455539">.</span><span class="ident" id="5455540">setupDone</span>&nbsp;<span class="op" id="5455550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455554">err</span>&nbsp;<span class="op" id="5455558">=</span>&nbsp;<span class="ident" id="5455560">bz2</span><span class="op" id="5455563">.</span><span class="ident" id="5455564">setup</span><span class="op" id="5455569">(</span><span class="ident" id="5455570">true</span><span class="op" id="5455574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455578">brErr</span>&nbsp;<span class="op" id="5455584">:=</span>&nbsp;<span class="ident" id="5455587">bz2</span><span class="op" id="5455590">.</span><span class="ident" id="5455591">br</span><span class="op" id="5455593">.</span><span class="ident" id="5455594">Err</span><span class="op" id="5455597">(</span><span class="op" id="5455598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455602">if</span>&nbsp;<span class="ident" id="5455605">brErr</span>&nbsp;<span class="op" id="5455611">!=</span>&nbsp;<span class="ident" id="5455614">nil</span>&nbsp;<span class="op" id="5455618">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455623">err</span>&nbsp;<span class="op" id="5455627">=</span>&nbsp;<span class="ident" id="5455629">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455641">if</span>&nbsp;<span class="ident" id="5455644">err</span>&nbsp;<span class="op" id="5455648">!=</span>&nbsp;<span class="ident" id="5455651">nil</span>&nbsp;<span class="op" id="5455655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455660">return</span>&nbsp;<span class="num" id="5455667">0</span><span class="op" id="5455668">,</span>&nbsp;<span class="ident" id="5455670">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455676">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455680">bz2</span><span class="op" id="5455683">.</span><span class="ident" id="5455684">setupDone</span>&nbsp;<span class="op" id="5455694">=</span>&nbsp;<span class="ident" id="5455696">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455706">n</span><span class="op" id="5455707">,</span>&nbsp;<span class="ident" id="5455709">err</span>&nbsp;<span class="op" id="5455713">=</span>&nbsp;<span class="ident" id="5455715">bz2</span><span class="op" id="5455718">.</span><span class="ident" id="5455719">read</span><span class="op" id="5455723">(</span><span class="ident" id="5455724">buf</span><span class="op" id="5455727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455730">brErr</span>&nbsp;<span class="op" id="5455736">:=</span>&nbsp;<span class="ident" id="5455739">bz2</span><span class="op" id="5455742">.</span><span class="ident" id="5455743">br</span><span class="op" id="5455745">.</span><span class="ident" id="5455746">Err</span><span class="op" id="5455749">(</span><span class="op" id="5455750">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455753">if</span>&nbsp;<span class="ident" id="5455756">brErr</span>&nbsp;<span class="op" id="5455762">!=</span>&nbsp;<span class="ident" id="5455765">nil</span>&nbsp;<span class="op" id="5455769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455773">err</span>&nbsp;<span class="op" id="5455777">=</span>&nbsp;<span class="ident" id="5455779">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455789">return</span><br>
<span class="lineno"></span><span class="op" id="5455796">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="5455799">func</span>&nbsp;<span class="op" id="5455804">(</span><span class="ident" id="5455805">bz2</span>&nbsp;<span class="op" id="5455809">*</span><span class="ident" id="5455810">reader</span><span class="op" id="5455816">)</span>&nbsp;<span class="ident" id="5455818">readFromBlock</span><span class="op" id="5455831">(</span><span class="ident" id="5455832">buf</span>&nbsp;<span class="op" id="5455836">[</span><span class="op" id="5455837">]</span><span class="builtintype" id="5455838">byte</span><span class="op" id="5455842">)</span>&nbsp;<span class="builtintype" id="5455844">int</span>&nbsp;<span class="op" id="5455848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5455851">//&nbsp;bzip2&nbsp;is&nbsp;a&nbsp;block&nbsp;based&nbsp;compressor,&nbsp;except&nbsp;that&nbsp;it&nbsp;has&nbsp;a&nbsp;run-length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5455922">//&nbsp;preprocessing&nbsp;step.&nbsp;The&nbsp;block&nbsp;based&nbsp;nature&nbsp;means&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5455987">//&nbsp;preallocate&nbsp;fixed-size&nbsp;buffers&nbsp;and&nbsp;reuse&nbsp;them.&nbsp;However,&nbsp;the&nbsp;RLE</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5456055">//&nbsp;preprocessing&nbsp;would&nbsp;require&nbsp;allocating&nbsp;huge&nbsp;buffers&nbsp;to&nbsp;store&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5456124">//&nbsp;maximum&nbsp;expansion.&nbsp;Thus&nbsp;we&nbsp;process&nbsp;blocks&nbsp;all&nbsp;at&nbsp;once,&nbsp;except&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5456194">//&nbsp;the&nbsp;RLE&nbsp;which&nbsp;we&nbsp;decompress&nbsp;as&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456239">n</span>&nbsp;<span class="op" id="5456241">:=</span>&nbsp;<span class="num" id="5456244">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5456247">for</span>&nbsp;<span class="op" id="5456251">(</span><span class="ident" id="5456252">bz2</span><span class="op" id="5456255">.</span><span class="ident" id="5456256">repeats</span>&nbsp;<span class="op" id="5456264">&gt;</span>&nbsp;<span class="num" id="5456266">0</span>&nbsp;<span class="op" id="5456268">||</span>&nbsp;<span class="ident" id="5456271">bz2</span><span class="op" id="5456274">.</span><span class="ident" id="5456275">preRLEUsed</span>&nbsp;<span class="op" id="5456286">&lt;</span>&nbsp;<span class="builtinfunc" id="5456288">len</span><span class="op" id="5456291">(</span><span class="ident" id="5456292">bz2</span><span class="op" id="5456295">.</span><span class="ident" id="5456296">preRLE</span><span class="op" id="5456302">)</span><span class="op" id="5456303">)</span>&nbsp;<span class="op" id="5456305">&amp;&amp;</span>&nbsp;<span class="ident" id="5456308">n</span>&nbsp;<span class="op" id="5456310">&lt;</span>&nbsp;<span class="builtinfunc" id="5456312">len</span><span class="op" id="5456315">(</span><span class="ident" id="5456316">buf</span><span class="op" id="5456319">)</span>&nbsp;<span class="op" id="5456321">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5456325">//&nbsp;We&nbsp;have&nbsp;RLE&nbsp;data&nbsp;pending.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5456357">//&nbsp;The&nbsp;run-length&nbsp;encoding&nbsp;works&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5456403">//&nbsp;Any&nbsp;sequence&nbsp;of&nbsp;four&nbsp;equal&nbsp;bytes&nbsp;is&nbsp;followed&nbsp;by&nbsp;a&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5456465">//&nbsp;byte&nbsp;which&nbsp;contains&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;that&nbsp;byte&nbsp;to</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5456528">//&nbsp;include.&nbsp;(The&nbsp;number&nbsp;of&nbsp;repeats&nbsp;can&nbsp;be&nbsp;zero.)&nbsp;Because&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5456594">//&nbsp;decompressing&nbsp;on-demand&nbsp;our&nbsp;state&nbsp;is&nbsp;kept&nbsp;in&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5456655">//&nbsp;object.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5456669">if</span>&nbsp;<span class="ident" id="5456672">bz2</span><span class="op" id="5456675">.</span><span class="ident" id="5456676">repeats</span>&nbsp;<span class="op" id="5456684">&gt;</span>&nbsp;<span class="num" id="5456686">0</span>&nbsp;<span class="op" id="5456688">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456693">buf</span><span class="op" id="5456696">[</span><span class="ident" id="5456697">n</span><span class="op" id="5456698">]</span>&nbsp;<span class="op" id="5456700">=</span>&nbsp;<span class="builtintype" id="5456702">byte</span><span class="op" id="5456706">(</span><span class="ident" id="5456707">bz2</span><span class="op" id="5456710">.</span><span class="ident" id="5456711">lastByte</span><span class="op" id="5456719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456724">n</span><span class="op" id="5456725">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456731">bz2</span><span class="op" id="5456734">.</span><span class="ident" id="5456735">repeats</span><span class="op" id="5456742">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5456748">if</span>&nbsp;<span class="ident" id="5456751">bz2</span><span class="op" id="5456754">.</span><span class="ident" id="5456755">repeats</span>&nbsp;<span class="op" id="5456763">==</span>&nbsp;<span class="num" id="5456766">0</span>&nbsp;<span class="op" id="5456768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456774">bz2</span><span class="op" id="5456777">.</span><span class="ident" id="5456778">lastByte</span>&nbsp;<span class="op" id="5456787">=</span>&nbsp;<span class="op" id="5456789">-</span><span class="num" id="5456790">1</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5456795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5456800">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5456811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456816">bz2</span><span class="op" id="5456819">.</span><span class="ident" id="5456820">tPos</span>&nbsp;<span class="op" id="5456825">=</span>&nbsp;<span class="ident" id="5456827">bz2</span><span class="op" id="5456830">.</span><span class="ident" id="5456831">preRLE</span><span class="op" id="5456837">[</span><span class="ident" id="5456838">bz2</span><span class="op" id="5456841">.</span><span class="ident" id="5456842">tPos</span><span class="op" id="5456846">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456850">b</span>&nbsp;<span class="op" id="5456852">:=</span>&nbsp;<span class="builtintype" id="5456855">byte</span><span class="op" id="5456859">(</span><span class="ident" id="5456860">bz2</span><span class="op" id="5456863">.</span><span class="ident" id="5456864">tPos</span><span class="op" id="5456868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456872">bz2</span><span class="op" id="5456875">.</span><span class="ident" id="5456876">tPos</span>&nbsp;<span class="op" id="5456881">&gt;&gt;=</span>&nbsp;<span class="num" id="5456885">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456889">bz2</span><span class="op" id="5456892">.</span><span class="ident" id="5456893">preRLEUsed</span><span class="op" id="5456903">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5456909">if</span>&nbsp;<span class="ident" id="5456912">bz2</span><span class="op" id="5456915">.</span><span class="ident" id="5456916">byteRepeats</span>&nbsp;<span class="op" id="5456928">==</span>&nbsp;<span class="num" id="5456931">3</span>&nbsp;<span class="op" id="5456933">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456938">bz2</span><span class="op" id="5456941">.</span><span class="ident" id="5456942">repeats</span>&nbsp;<span class="op" id="5456950">=</span>&nbsp;<span class="builtintype" id="5456952">uint</span><span class="op" id="5456956">(</span><span class="ident" id="5456957">b</span><span class="op" id="5456958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456963">bz2</span><span class="op" id="5456966">.</span><span class="ident" id="5456967">byteRepeats</span>&nbsp;<span class="op" id="5456979">=</span>&nbsp;<span class="num" id="5456981">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5456986">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5456997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457002">if</span>&nbsp;<span class="ident" id="5457005">bz2</span><span class="op" id="5457008">.</span><span class="ident" id="5457009">lastByte</span>&nbsp;<span class="op" id="5457018">==</span>&nbsp;<span class="builtintype" id="5457021">int</span><span class="op" id="5457024">(</span><span class="ident" id="5457025">b</span><span class="op" id="5457026">)</span>&nbsp;<span class="op" id="5457028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5457033">bz2</span><span class="op" id="5457036">.</span><span class="ident" id="5457037">byteRepeats</span><span class="op" id="5457048">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5457053">}</span>&nbsp;<span class="keyword" id="5457055">else</span>&nbsp;<span class="op" id="5457060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5457065">bz2</span><span class="op" id="5457068">.</span><span class="ident" id="5457069">byteRepeats</span>&nbsp;<span class="op" id="5457081">=</span>&nbsp;<span class="num" id="5457083">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5457087">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5457091">bz2</span><span class="op" id="5457094">.</span><span class="ident" id="5457095">lastByte</span>&nbsp;<span class="op" id="5457104">=</span>&nbsp;<span class="builtintype" id="5457106">int</span><span class="op" id="5457109">(</span><span class="ident" id="5457110">b</span><span class="op" id="5457111">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5457116">buf</span><span class="op" id="5457119">[</span><span class="ident" id="5457120">n</span><span class="op" id="5457121">]</span>&nbsp;<span class="op" id="5457123">=</span>&nbsp;<span class="ident" id="5457125">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5457129">n</span><span class="op" id="5457130">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5457134">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457138">return</span>&nbsp;<span class="ident" id="5457145">n</span><br>
<span class="lineno"></span><span class="op" id="5457147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5457150">func</span>&nbsp;<span class="op" id="5457155">(</span><span class="ident" id="5457156">bz2</span>&nbsp;<span class="op" id="5457160">*</span><span class="ident" id="5457161">reader</span><span class="op" id="5457167">)</span>&nbsp;<span class="ident" id="5457169">read</span><span class="op" id="5457173">(</span><span class="ident" id="5457174">buf</span>&nbsp;<span class="op" id="5457178">[</span><span class="op" id="5457179">]</span><span class="builtintype" id="5457180">byte</span><span class="op" id="5457184">)</span>&nbsp;<span class="op" id="5457186">(</span><span class="builtintype" id="5457187">int</span><span class="op" id="5457190">,</span>&nbsp;<span class="builtintype" id="5457192">error</span><span class="op" id="5457197">)</span>&nbsp;<span class="op" id="5457199">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457202">for</span>&nbsp;<span class="op" id="5457206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5457210">n</span>&nbsp;<span class="op" id="5457212">:=</span>&nbsp;<span class="ident" id="5457215">bz2</span><span class="op" id="5457218">.</span><span class="ident" id="5457219">readFromBlock</span><span class="op" id="5457232">(</span><span class="ident" id="5457233">buf</span><span class="op" id="5457236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457240">if</span>&nbsp;<span class="ident" id="5457243">n</span>&nbsp;<span class="op" id="5457245">&gt;</span>&nbsp;<span class="num" id="5457247">0</span>&nbsp;<span class="op" id="5457249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5457254">bz2</span><span class="op" id="5457257">.</span><span class="ident" id="5457258">blockCRC</span>&nbsp;<span class="op" id="5457267">=</span>&nbsp;<span class="ident" id="5457269">updateCRC</span><span class="op" id="5457278">(</span><span class="ident" id="5457279">bz2</span><span class="op" id="5457282">.</span><span class="ident" id="5457283">blockCRC</span><span class="op" id="5457291">,</span>&nbsp;<span class="ident" id="5457293">buf</span><span class="op" id="5457296">[</span><span class="op" id="5457297">:</span><span class="ident" id="5457298">n</span><span class="op" id="5457299">]</span><span class="op" id="5457300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457305">return</span>&nbsp;<span class="ident" id="5457312">n</span><span class="op" id="5457313">,</span>&nbsp;<span class="ident" id="5457315">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5457321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5457326">//&nbsp;End&nbsp;of&nbsp;block.&nbsp;Check&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457356">if</span>&nbsp;<span class="ident" id="5457359">bz2</span><span class="op" id="5457362">.</span><span class="ident" id="5457363">blockCRC</span>&nbsp;<span class="op" id="5457372">!=</span>&nbsp;<span class="ident" id="5457375">bz2</span><span class="op" id="5457378">.</span><span class="ident" id="5457379">wantBlockCRC</span>&nbsp;<span class="op" id="5457392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5457397">bz2</span><span class="op" id="5457400">.</span><span class="ident" id="5457401">br</span><span class="op" id="5457403">.</span><span class="ident" id="5457404">err</span>&nbsp;<span class="op" id="5457408">=</span>&nbsp;<span class="ident" id="5457410">StructuralError</span><span class="op" id="5457425">(</span><span class="string" id="5457426">&#34;block&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="5457451">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457456">return</span>&nbsp;<span class="num" id="5457463">0</span><span class="op" id="5457464">,</span>&nbsp;<span class="ident" id="5457466">bz2</span><span class="op" id="5457469">.</span><span class="ident" id="5457470">br</span><span class="op" id="5457472">.</span><span class="ident" id="5457473">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5457479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5457484">//&nbsp;Find&nbsp;next&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5457506">br</span>&nbsp;<span class="op" id="5457509">:=</span>&nbsp;<span class="op" id="5457512">&amp;</span><span class="ident" id="5457513">bz2</span><span class="op" id="5457516">.</span><span class="ident" id="5457517">br</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457522">switch</span>&nbsp;<span class="ident" id="5457529">br</span><span class="op" id="5457531">.</span><span class="ident" id="5457532">ReadBits64</span><span class="op" id="5457542">(</span><span class="num" id="5457543">48</span><span class="op" id="5457545">)</span>&nbsp;<span class="op" id="5457547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457551">default</span><span class="op" id="5457558">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457563">return</span>&nbsp;<span class="num" id="5457570">0</span><span class="op" id="5457571">,</span>&nbsp;<span class="ident" id="5457573">StructuralError</span><span class="op" id="5457588">(</span><span class="string" id="5457589">&#34;bad&nbsp;magic&nbsp;value&nbsp;found&#34;</span><span class="op" id="5457612">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457617">case</span>&nbsp;<span class="ident" id="5457622">bzip2BlockMagic</span><span class="op" id="5457637">:</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5457642">//&nbsp;Start&nbsp;of&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5457664">err</span>&nbsp;<span class="op" id="5457668">:=</span>&nbsp;<span class="ident" id="5457671">bz2</span><span class="op" id="5457674">.</span><span class="ident" id="5457675">readBlock</span><span class="op" id="5457684">(</span><span class="op" id="5457685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457690">if</span>&nbsp;<span class="ident" id="5457693">err</span>&nbsp;<span class="op" id="5457697">!=</span>&nbsp;<span class="ident" id="5457700">nil</span>&nbsp;<span class="op" id="5457704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457710">return</span>&nbsp;<span class="num" id="5457717">0</span><span class="op" id="5457718">,</span>&nbsp;<span class="ident" id="5457720">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5457727">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457732">case</span>&nbsp;<span class="ident" id="5457737">bzip2FinalMagic</span><span class="op" id="5457752">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5457757">//&nbsp;Check&nbsp;end-of-file&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5457786">wantFileCRC</span>&nbsp;<span class="op" id="5457798">:=</span>&nbsp;<span class="builtintype" id="5457801">uint32</span><span class="op" id="5457807">(</span><span class="ident" id="5457808">br</span><span class="op" id="5457810">.</span><span class="ident" id="5457811">ReadBits64</span><span class="op" id="5457821">(</span><span class="num" id="5457822">32</span><span class="op" id="5457824">)</span><span class="op" id="5457825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457830">if</span>&nbsp;<span class="ident" id="5457833">br</span><span class="op" id="5457835">.</span><span class="ident" id="5457836">err</span>&nbsp;<span class="op" id="5457840">!=</span>&nbsp;<span class="ident" id="5457843">nil</span>&nbsp;<span class="op" id="5457847">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457853">return</span>&nbsp;<span class="num" id="5457860">0</span><span class="op" id="5457861">,</span>&nbsp;<span class="ident" id="5457863">br</span><span class="op" id="5457865">.</span><span class="ident" id="5457866">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5457873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457878">if</span>&nbsp;<span class="ident" id="5457881">bz2</span><span class="op" id="5457884">.</span><span class="ident" id="5457885">fileCRC</span>&nbsp;<span class="op" id="5457893">!=</span>&nbsp;<span class="ident" id="5457896">wantFileCRC</span>&nbsp;<span class="op" id="5457908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5457914">br</span><span class="op" id="5457916">.</span><span class="ident" id="5457917">err</span>&nbsp;<span class="op" id="5457921">=</span>&nbsp;<span class="ident" id="5457923">StructuralError</span><span class="op" id="5457938">(</span><span class="string" id="5457939">&#34;file&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="5457963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457969">return</span>&nbsp;<span class="num" id="5457976">0</span><span class="op" id="5457977">,</span>&nbsp;<span class="ident" id="5457979">br</span><span class="op" id="5457981">.</span><span class="ident" id="5457982">err</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5457989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5457995">//&nbsp;Skip&nbsp;ahead&nbsp;to&nbsp;byte&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5458030">//&nbsp;Is&nbsp;there&nbsp;a&nbsp;file&nbsp;concatenated&nbsp;to&nbsp;this&nbsp;one?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5458078">//&nbsp;It&nbsp;would&nbsp;start&nbsp;with&nbsp;BZ.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5458108">if</span>&nbsp;<span class="ident" id="5458111">br</span><span class="op" id="5458113">.</span><span class="ident" id="5458114">bits</span><span class="op" id="5458118">%</span><span class="num" id="5458119">8</span>&nbsp;<span class="op" id="5458121">!=</span>&nbsp;<span class="num" id="5458124">0</span>&nbsp;<span class="op" id="5458126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5458132">br</span><span class="op" id="5458134">.</span><span class="ident" id="5458135">ReadBits</span><span class="op" id="5458143">(</span><span class="ident" id="5458144">br</span><span class="op" id="5458146">.</span><span class="ident" id="5458147">bits</span>&nbsp;<span class="op" id="5458152">%</span>&nbsp;<span class="num" id="5458154">8</span><span class="op" id="5458155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5458160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5458165">b</span><span class="op" id="5458166">,</span>&nbsp;<span class="ident" id="5458168">err</span>&nbsp;<span class="op" id="5458172">:=</span>&nbsp;<span class="ident" id="5458175">br</span><span class="op" id="5458177">.</span><span class="ident" id="5458178">r</span><span class="op" id="5458179">.</span><span class="ident" id="5458180">ReadByte</span><span class="op" id="5458188">(</span><span class="op" id="5458189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5458194">if</span>&nbsp;<span class="ident" id="5458197">err</span>&nbsp;<span class="op" id="5458201">==</span>&nbsp;<span class="ident" id="5458204">io</span><span class="op" id="5458206">.</span><span class="ident" id="5458207">EOF</span>&nbsp;<span class="op" id="5458211">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5458217">br</span><span class="op" id="5458219">.</span><span class="ident" id="5458220">err</span>&nbsp;<span class="op" id="5458224">=</span>&nbsp;<span class="ident" id="5458226">io</span><span class="op" id="5458228">.</span><span class="ident" id="5458229">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5458237">bz2</span><span class="op" id="5458240">.</span><span class="ident" id="5458241">eof</span>&nbsp;<span class="op" id="5458245">=</span>&nbsp;<span class="ident" id="5458247">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5458256">return</span>&nbsp;<span class="num" id="5458263">0</span><span class="op" id="5458264">,</span>&nbsp;<span class="ident" id="5458266">io</span><span class="op" id="5458268">.</span><span class="ident" id="5458269">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5458276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5458281">if</span>&nbsp;<span class="ident" id="5458284">err</span>&nbsp;<span class="op" id="5458288">!=</span>&nbsp;<span class="ident" id="5458291">nil</span>&nbsp;<span class="op" id="5458295">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5458301">br</span><span class="op" id="5458303">.</span><span class="ident" id="5458304">err</span>&nbsp;<span class="op" id="5458308">=</span>&nbsp;<span class="ident" id="5458310">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5458318">return</span>&nbsp;<span class="num" id="5458325">0</span><span class="op" id="5458326">,</span>&nbsp;<span class="ident" id="5458328">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5458335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5458340">z</span><span class="op" id="5458341">,</span>&nbsp;<span class="ident" id="5458343">err</span>&nbsp;<span class="op" id="5458347">:=</span>&nbsp;<span class="ident" id="5458350">br</span><span class="op" id="5458352">.</span><span class="ident" id="5458353">r</span><span class="op" id="5458354">.</span><span class="ident" id="5458355">ReadByte</span><span class="op" id="5458363">(</span><span class="op" id="5458364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5458369">if</span>&nbsp;<span class="ident" id="5458372">err</span>&nbsp;<span class="op" id="5458376">!=</span>&nbsp;<span class="ident" id="5458379">nil</span>&nbsp;<span class="op" id="5458383">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5458389">if</span>&nbsp;<span class="ident" id="5458392">err</span>&nbsp;<span class="op" id="5458396">==</span>&nbsp;<span class="ident" id="5458399">io</span><span class="op" id="5458401">.</span><span class="ident" id="5458402">EOF</span>&nbsp;<span class="op" id="5458406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5458413">err</span>&nbsp;<span class="op" id="5458417">=</span>&nbsp;<span class="ident" id="5458419">io</span><span class="op" id="5458421">.</span><span class="ident" id="5458422">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5458443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5458449">br</span><span class="op" id="5458451">.</span><span class="ident" id="5458452">err</span>&nbsp;<span class="op" id="5458456">=</span>&nbsp;<span class="ident" id="5458458">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5458466">return</span>&nbsp;<span class="num" id="5458473">0</span><span class="op" id="5458474">,</span>&nbsp;<span class="ident" id="5458476">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5458483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5458488">if</span>&nbsp;<span class="ident" id="5458491">b</span>&nbsp;<span class="op" id="5458493">!=</span>&nbsp;<span class="string" id="5458496">&#39;B&#39;</span>&nbsp;<span class="op" id="5458500">||</span>&nbsp;<span class="ident" id="5458503">z</span>&nbsp;<span class="op" id="5458505">!=</span>&nbsp;<span class="string" id="5458508">&#39;Z&#39;</span>&nbsp;<span class="op" id="5458512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5458518">return</span>&nbsp;<span class="num" id="5458525">0</span><span class="op" id="5458526">,</span>&nbsp;<span class="ident" id="5458528">StructuralError</span><span class="op" id="5458543">(</span><span class="string" id="5458544">&#34;bad&nbsp;magic&nbsp;value&nbsp;in&nbsp;continuation&nbsp;file&#34;</span><span class="op" id="5458582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5458587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5458592">if</span>&nbsp;<span class="ident" id="5458595">err</span>&nbsp;<span class="op" id="5458599">:=</span>&nbsp;<span class="ident" id="5458602">bz2</span><span class="op" id="5458605">.</span><span class="ident" id="5458606">setup</span><span class="op" id="5458611">(</span><span class="ident" id="5458612">false</span><span class="op" id="5458617">)</span><span class="op" id="5458618">;</span>&nbsp;<span class="ident" id="5458620">err</span>&nbsp;<span class="op" id="5458624">!=</span>&nbsp;<span class="ident" id="5458627">nil</span>&nbsp;<span class="op" id="5458631">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5458637">return</span>&nbsp;<span class="num" id="5458644">0</span><span class="op" id="5458645">,</span>&nbsp;<span class="ident" id="5458647">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5458654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5458658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5458661">}</span><br>
<span class="lineno"></span><span class="op" id="5458663">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="5458666">//&nbsp;readBlock&nbsp;reads&nbsp;a&nbsp;bzip2&nbsp;block.&nbsp;The&nbsp;magic&nbsp;number&nbsp;should&nbsp;already&nbsp;have&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span><span class="keyword" id="5458752">func</span>&nbsp;<span class="op" id="5458757">(</span><span class="ident" id="5458758">bz2</span>&nbsp;<span class="op" id="5458762">*</span><span class="ident" id="5458763">reader</span><span class="op" id="5458769">)</span>&nbsp;<span class="ident" id="5458771">readBlock</span><span class="op" id="5458780">(</span><span class="op" id="5458781">)</span>&nbsp;<span class="op" id="5458783">(</span><span class="ident" id="5458784">err</span>&nbsp;<span class="builtintype" id="5458788">error</span><span class="op" id="5458793">)</span>&nbsp;<span class="op" id="5458795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5458798">br</span>&nbsp;<span class="op" id="5458801">:=</span>&nbsp;<span class="op" id="5458804">&amp;</span><span class="ident" id="5458805">bz2</span><span class="op" id="5458808">.</span><span class="ident" id="5458809">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5458813">bz2</span><span class="op" id="5458816">.</span><span class="ident" id="5458817">wantBlockCRC</span>&nbsp;<span class="op" id="5458830">=</span>&nbsp;<span class="builtintype" id="5458832">uint32</span><span class="op" id="5458838">(</span><span class="ident" id="5458839">br</span><span class="op" id="5458841">.</span><span class="ident" id="5458842">ReadBits64</span><span class="op" id="5458852">(</span><span class="num" id="5458853">32</span><span class="op" id="5458855">)</span><span class="op" id="5458856">)</span>&nbsp;<span class="comment" id="5458858">//&nbsp;skip&nbsp;checksum.&nbsp;TODO:&nbsp;check&nbsp;it&nbsp;if&nbsp;we&nbsp;can&nbsp;figure&nbsp;out&nbsp;what&nbsp;it&nbsp;is.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5458925">bz2</span><span class="op" id="5458928">.</span><span class="ident" id="5458929">blockCRC</span>&nbsp;<span class="op" id="5458938">=</span>&nbsp;<span class="num" id="5458940">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5458943">bz2</span><span class="op" id="5458946">.</span><span class="ident" id="5458947">fileCRC</span>&nbsp;<span class="op" id="5458955">=</span>&nbsp;<span class="op" id="5458957">(</span><span class="ident" id="5458958">bz2</span><span class="op" id="5458961">.</span><span class="ident" id="5458962">fileCRC</span><span class="op" id="5458969">&lt;&lt;</span><span class="num" id="5458971">1</span>&nbsp;<span class="op" id="5458973">|</span>&nbsp;<span class="ident" id="5458975">bz2</span><span class="op" id="5458978">.</span><span class="ident" id="5458979">fileCRC</span><span class="op" id="5458986">&gt;&gt;</span><span class="num" id="5458988">31</span><span class="op" id="5458990">)</span>&nbsp;<span class="op" id="5458992">^</span>&nbsp;<span class="ident" id="5458994">bz2</span><span class="op" id="5458997">.</span><span class="ident" id="5458998">wantBlockCRC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459012">randomized</span>&nbsp;<span class="op" id="5459023">:=</span>&nbsp;<span class="ident" id="5459026">br</span><span class="op" id="5459028">.</span><span class="ident" id="5459029">ReadBits</span><span class="op" id="5459037">(</span><span class="num" id="5459038">1</span><span class="op" id="5459039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459042">if</span>&nbsp;<span class="ident" id="5459045">randomized</span>&nbsp;<span class="op" id="5459056">!=</span>&nbsp;<span class="num" id="5459059">0</span>&nbsp;<span class="op" id="5459061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459065">return</span>&nbsp;<span class="ident" id="5459072">StructuralError</span><span class="op" id="5459087">(</span><span class="string" id="5459088">&#34;deprecated&nbsp;randomized&nbsp;files&#34;</span><span class="op" id="5459117">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5459120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459123">origPtr</span>&nbsp;<span class="op" id="5459131">:=</span>&nbsp;<span class="builtintype" id="5459134">uint</span><span class="op" id="5459138">(</span><span class="ident" id="5459139">br</span><span class="op" id="5459141">.</span><span class="ident" id="5459142">ReadBits</span><span class="op" id="5459150">(</span><span class="num" id="5459151">24</span><span class="op" id="5459153">)</span><span class="op" id="5459154">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5459158">//&nbsp;If&nbsp;not&nbsp;every&nbsp;byte&nbsp;value&nbsp;is&nbsp;used&nbsp;in&nbsp;the&nbsp;block&nbsp;(i.e.,&nbsp;it&#39;s&nbsp;text)&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5459230">//&nbsp;the&nbsp;symbol&nbsp;set&nbsp;is&nbsp;reduced.&nbsp;The&nbsp;symbols&nbsp;used&nbsp;are&nbsp;stored&nbsp;as&nbsp;a</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5459294">//&nbsp;two-level,&nbsp;16x16&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459323">symbolRangeUsedBitmap</span>&nbsp;<span class="op" id="5459345">:=</span>&nbsp;<span class="ident" id="5459348">br</span><span class="op" id="5459350">.</span><span class="ident" id="5459351">ReadBits</span><span class="op" id="5459359">(</span><span class="num" id="5459360">16</span><span class="op" id="5459362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459365">symbolPresent</span>&nbsp;<span class="op" id="5459379">:=</span>&nbsp;<span class="builtinfunc" id="5459382">make</span><span class="op" id="5459386">(</span><span class="op" id="5459387">[</span><span class="op" id="5459388">]</span><span class="builtintype" id="5459389">bool</span><span class="op" id="5459393">,</span>&nbsp;<span class="num" id="5459395">256</span><span class="op" id="5459398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459401">numSymbols</span>&nbsp;<span class="op" id="5459412">:=</span>&nbsp;<span class="num" id="5459415">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459418">for</span>&nbsp;<span class="ident" id="5459422">symRange</span>&nbsp;<span class="op" id="5459431">:=</span>&nbsp;<span class="builtintype" id="5459434">uint</span><span class="op" id="5459438">(</span><span class="num" id="5459439">0</span><span class="op" id="5459440">)</span><span class="op" id="5459441">;</span>&nbsp;<span class="ident" id="5459443">symRange</span>&nbsp;<span class="op" id="5459452">&lt;</span>&nbsp;<span class="num" id="5459454">16</span><span class="op" id="5459456">;</span>&nbsp;<span class="ident" id="5459458">symRange</span><span class="op" id="5459466">++</span>&nbsp;<span class="op" id="5459469">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459473">if</span>&nbsp;<span class="ident" id="5459476">symbolRangeUsedBitmap</span><span class="op" id="5459497">&amp;</span><span class="op" id="5459498">(</span><span class="num" id="5459499">1</span><span class="op" id="5459500">&lt;&lt;</span><span class="op" id="5459502">(</span><span class="num" id="5459503">15</span><span class="op" id="5459505">-</span><span class="ident" id="5459506">symRange</span><span class="op" id="5459514">)</span><span class="op" id="5459515">)</span>&nbsp;<span class="op" id="5459517">!=</span>&nbsp;<span class="num" id="5459520">0</span>&nbsp;<span class="op" id="5459522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459527">bits</span>&nbsp;<span class="op" id="5459532">:=</span>&nbsp;<span class="ident" id="5459535">br</span><span class="op" id="5459537">.</span><span class="ident" id="5459538">ReadBits</span><span class="op" id="5459546">(</span><span class="num" id="5459547">16</span><span class="op" id="5459549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459554">for</span>&nbsp;<span class="ident" id="5459558">symbol</span>&nbsp;<span class="op" id="5459565">:=</span>&nbsp;<span class="builtintype" id="5459568">uint</span><span class="op" id="5459572">(</span><span class="num" id="5459573">0</span><span class="op" id="5459574">)</span><span class="op" id="5459575">;</span>&nbsp;<span class="ident" id="5459577">symbol</span>&nbsp;<span class="op" id="5459584">&lt;</span>&nbsp;<span class="num" id="5459586">16</span><span class="op" id="5459588">;</span>&nbsp;<span class="ident" id="5459590">symbol</span><span class="op" id="5459596">++</span>&nbsp;<span class="op" id="5459599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459605">if</span>&nbsp;<span class="ident" id="5459608">bits</span><span class="op" id="5459612">&amp;</span><span class="op" id="5459613">(</span><span class="num" id="5459614">1</span><span class="op" id="5459615">&lt;&lt;</span><span class="op" id="5459617">(</span><span class="num" id="5459618">15</span><span class="op" id="5459620">-</span><span class="ident" id="5459621">symbol</span><span class="op" id="5459627">)</span><span class="op" id="5459628">)</span>&nbsp;<span class="op" id="5459630">!=</span>&nbsp;<span class="num" id="5459633">0</span>&nbsp;<span class="op" id="5459635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459642">symbolPresent</span><span class="op" id="5459655">[</span><span class="num" id="5459656">16</span><span class="op" id="5459658">*</span><span class="ident" id="5459659">symRange</span><span class="op" id="5459667">+</span><span class="ident" id="5459668">symbol</span><span class="op" id="5459674">]</span>&nbsp;<span class="op" id="5459676">=</span>&nbsp;<span class="ident" id="5459678">true</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459688">numSymbols</span><span class="op" id="5459698">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5459705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5459710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5459714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5459717">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459721">if</span>&nbsp;<span class="ident" id="5459724">numSymbols</span>&nbsp;<span class="op" id="5459735">==</span>&nbsp;<span class="num" id="5459738">0</span>&nbsp;<span class="op" id="5459740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5459744">//&nbsp;There&nbsp;must&nbsp;be&nbsp;an&nbsp;EOF&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459778">return</span>&nbsp;<span class="ident" id="5459785">StructuralError</span><span class="op" id="5459800">(</span><span class="string" id="5459801">&#34;no&nbsp;symbols&nbsp;in&nbsp;input&#34;</span><span class="op" id="5459822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5459825">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5459829">//&nbsp;A&nbsp;block&nbsp;uses&nbsp;between&nbsp;two&nbsp;and&nbsp;six&nbsp;different&nbsp;Huffman&nbsp;trees.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459891">numHuffmanTrees</span>&nbsp;<span class="op" id="5459907">:=</span>&nbsp;<span class="ident" id="5459910">br</span><span class="op" id="5459912">.</span><span class="ident" id="5459913">ReadBits</span><span class="op" id="5459921">(</span><span class="num" id="5459922">3</span><span class="op" id="5459923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459926">if</span>&nbsp;<span class="ident" id="5459929">numHuffmanTrees</span>&nbsp;<span class="op" id="5459945">&lt;</span>&nbsp;<span class="num" id="5459947">2</span>&nbsp;<span class="op" id="5459949">||</span>&nbsp;<span class="ident" id="5459952">numHuffmanTrees</span>&nbsp;<span class="op" id="5459968">&gt;</span>&nbsp;<span class="num" id="5459970">6</span>&nbsp;<span class="op" id="5459972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459976">return</span>&nbsp;<span class="ident" id="5459983">StructuralError</span><span class="op" id="5459998">(</span><span class="string" id="5459999">&#34;invalid&nbsp;number&nbsp;of&nbsp;Huffman&nbsp;trees&#34;</span><span class="op" id="5460032">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5460035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5460039">//&nbsp;The&nbsp;Huffman&nbsp;tree&nbsp;can&nbsp;switch&nbsp;every&nbsp;50&nbsp;symbols&nbsp;so&nbsp;there&#39;s&nbsp;a&nbsp;list&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5460109">//&nbsp;tree&nbsp;indexes&nbsp;telling&nbsp;us&nbsp;which&nbsp;tree&nbsp;to&nbsp;use&nbsp;for&nbsp;each&nbsp;50&nbsp;symbol&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460181">numSelectors</span>&nbsp;<span class="op" id="5460194">:=</span>&nbsp;<span class="ident" id="5460197">br</span><span class="op" id="5460199">.</span><span class="ident" id="5460200">ReadBits</span><span class="op" id="5460208">(</span><span class="num" id="5460209">15</span><span class="op" id="5460211">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460214">treeIndexes</span>&nbsp;<span class="op" id="5460226">:=</span>&nbsp;<span class="builtinfunc" id="5460229">make</span><span class="op" id="5460233">(</span><span class="op" id="5460234">[</span><span class="op" id="5460235">]</span><span class="builtintype" id="5460236">uint8</span><span class="op" id="5460241">,</span>&nbsp;<span class="ident" id="5460243">numSelectors</span><span class="op" id="5460255">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5460259">//&nbsp;The&nbsp;tree&nbsp;indexes&nbsp;are&nbsp;move-to-front&nbsp;transformed&nbsp;and&nbsp;stored&nbsp;as&nbsp;unary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5460330">//&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460343">mtfTreeDecoder</span>&nbsp;<span class="op" id="5460358">:=</span>&nbsp;<span class="ident" id="5460361">newMTFDecoderWithRange</span><span class="op" id="5460383">(</span><span class="ident" id="5460384">numHuffmanTrees</span><span class="op" id="5460399">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5460402">for</span>&nbsp;<span class="ident" id="5460406">i</span>&nbsp;<span class="op" id="5460408">:=</span>&nbsp;<span class="keyword" id="5460411">range</span>&nbsp;<span class="ident" id="5460417">treeIndexes</span>&nbsp;<span class="op" id="5460429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460433">c</span>&nbsp;<span class="op" id="5460435">:=</span>&nbsp;<span class="num" id="5460438">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5460442">for</span>&nbsp;<span class="op" id="5460446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460451">inc</span>&nbsp;<span class="op" id="5460455">:=</span>&nbsp;<span class="ident" id="5460458">br</span><span class="op" id="5460460">.</span><span class="ident" id="5460461">ReadBits</span><span class="op" id="5460469">(</span><span class="num" id="5460470">1</span><span class="op" id="5460471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5460476">if</span>&nbsp;<span class="ident" id="5460479">inc</span>&nbsp;<span class="op" id="5460483">==</span>&nbsp;<span class="num" id="5460486">0</span>&nbsp;<span class="op" id="5460488">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5460494">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5460503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460508">c</span><span class="op" id="5460509">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5460514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5460518">if</span>&nbsp;<span class="ident" id="5460521">c</span>&nbsp;<span class="op" id="5460523">&gt;=</span>&nbsp;<span class="ident" id="5460526">numHuffmanTrees</span>&nbsp;<span class="op" id="5460542">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5460547">return</span>&nbsp;<span class="ident" id="5460554">StructuralError</span><span class="op" id="5460569">(</span><span class="string" id="5460570">&#34;tree&nbsp;index&nbsp;too&nbsp;large&#34;</span><span class="op" id="5460592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5460596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460600">treeIndexes</span><span class="op" id="5460611">[</span><span class="ident" id="5460612">i</span><span class="op" id="5460613">]</span>&nbsp;<span class="op" id="5460615">=</span>&nbsp;<span class="builtintype" id="5460617">uint8</span><span class="op" id="5460622">(</span><span class="ident" id="5460623">mtfTreeDecoder</span><span class="op" id="5460637">.</span><span class="ident" id="5460638">Decode</span><span class="op" id="5460644">(</span><span class="ident" id="5460645">c</span><span class="op" id="5460646">)</span><span class="op" id="5460647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5460650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5460654">//&nbsp;The&nbsp;list&nbsp;of&nbsp;symbols&nbsp;for&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;taken&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5460724">//&nbsp;the&nbsp;previously&nbsp;decoded&nbsp;symbol&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460766">symbols</span>&nbsp;<span class="op" id="5460774">:=</span>&nbsp;<span class="builtinfunc" id="5460777">make</span><span class="op" id="5460781">(</span><span class="op" id="5460782">[</span><span class="op" id="5460783">]</span><span class="builtintype" id="5460784">byte</span><span class="op" id="5460788">,</span>&nbsp;<span class="ident" id="5460790">numSymbols</span><span class="op" id="5460800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460803">nextSymbol</span>&nbsp;<span class="op" id="5460814">:=</span>&nbsp;<span class="num" id="5460817">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5460820">for</span>&nbsp;<span class="ident" id="5460824">i</span>&nbsp;<span class="op" id="5460826">:=</span>&nbsp;<span class="num" id="5460829">0</span><span class="op" id="5460830">;</span>&nbsp;<span class="ident" id="5460832">i</span>&nbsp;<span class="op" id="5460834">&lt;</span>&nbsp;<span class="num" id="5460836">256</span><span class="op" id="5460839">;</span>&nbsp;<span class="ident" id="5460841">i</span><span class="op" id="5460842">++</span>&nbsp;<span class="op" id="5460845">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5460849">if</span>&nbsp;<span class="ident" id="5460852">symbolPresent</span><span class="op" id="5460865">[</span><span class="ident" id="5460866">i</span><span class="op" id="5460867">]</span>&nbsp;<span class="op" id="5460869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460874">symbols</span><span class="op" id="5460881">[</span><span class="ident" id="5460882">nextSymbol</span><span class="op" id="5460892">]</span>&nbsp;<span class="op" id="5460894">=</span>&nbsp;<span class="builtintype" id="5460896">byte</span><span class="op" id="5460900">(</span><span class="ident" id="5460901">i</span><span class="op" id="5460902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460907">nextSymbol</span><span class="op" id="5460917">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5460922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5460925">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460928">mtf</span>&nbsp;<span class="op" id="5460932">:=</span>&nbsp;<span class="ident" id="5460935">newMTFDecoder</span><span class="op" id="5460948">(</span><span class="ident" id="5460949">symbols</span><span class="op" id="5460956">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460960">numSymbols</span>&nbsp;<span class="op" id="5460971">+=</span>&nbsp;<span class="num" id="5460974">2</span>&nbsp;<span class="comment" id="5460976">//&nbsp;to&nbsp;account&nbsp;for&nbsp;RUNA&nbsp;and&nbsp;RUNB&nbsp;symbols</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461017">huffmanTrees</span>&nbsp;<span class="op" id="5461030">:=</span>&nbsp;<span class="builtinfunc" id="5461033">make</span><span class="op" id="5461037">(</span><span class="op" id="5461038">[</span><span class="op" id="5461039">]</span><span class="ident" id="5461040">huffmanTree</span><span class="op" id="5461051">,</span>&nbsp;<span class="ident" id="5461053">numHuffmanTrees</span><span class="op" id="5461068">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5461072">//&nbsp;Now&nbsp;we&nbsp;decode&nbsp;the&nbsp;arrays&nbsp;of&nbsp;code-lengths&nbsp;for&nbsp;each&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461132">lengths</span>&nbsp;<span class="op" id="5461140">:=</span>&nbsp;<span class="builtinfunc" id="5461143">make</span><span class="op" id="5461147">(</span><span class="op" id="5461148">[</span><span class="op" id="5461149">]</span><span class="builtintype" id="5461150">uint8</span><span class="op" id="5461155">,</span>&nbsp;<span class="ident" id="5461157">numSymbols</span><span class="op" id="5461167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461170">for</span>&nbsp;<span class="ident" id="5461174">i</span>&nbsp;<span class="op" id="5461176">:=</span>&nbsp;<span class="keyword" id="5461179">range</span>&nbsp;<span class="ident" id="5461185">huffmanTrees</span>&nbsp;<span class="op" id="5461198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5461202">//&nbsp;The&nbsp;code&nbsp;lengths&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;from&nbsp;a&nbsp;5-bit&nbsp;base&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461267">length</span>&nbsp;<span class="op" id="5461274">:=</span>&nbsp;<span class="ident" id="5461277">br</span><span class="op" id="5461279">.</span><span class="ident" id="5461280">ReadBits</span><span class="op" id="5461288">(</span><span class="num" id="5461289">5</span><span class="op" id="5461290">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461294">for</span>&nbsp;<span class="ident" id="5461298">j</span>&nbsp;<span class="op" id="5461300">:=</span>&nbsp;<span class="keyword" id="5461303">range</span>&nbsp;<span class="ident" id="5461309">lengths</span>&nbsp;<span class="op" id="5461317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461322">for</span>&nbsp;<span class="op" id="5461326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461332">if</span>&nbsp;<span class="op" id="5461335">!</span><span class="ident" id="5461336">br</span><span class="op" id="5461338">.</span><span class="ident" id="5461339">ReadBit</span><span class="op" id="5461346">(</span><span class="op" id="5461347">)</span>&nbsp;<span class="op" id="5461349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461356">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461366">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461372">if</span>&nbsp;<span class="ident" id="5461375">br</span><span class="op" id="5461377">.</span><span class="ident" id="5461378">ReadBit</span><span class="op" id="5461385">(</span><span class="op" id="5461386">)</span>&nbsp;<span class="op" id="5461388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461395">length</span><span class="op" id="5461401">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461408">}</span>&nbsp;<span class="keyword" id="5461410">else</span>&nbsp;<span class="op" id="5461415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461422">length</span><span class="op" id="5461428">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461435">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461445">if</span>&nbsp;<span class="ident" id="5461448">length</span>&nbsp;<span class="op" id="5461455">&lt;</span>&nbsp;<span class="num" id="5461457">0</span>&nbsp;<span class="op" id="5461459">||</span>&nbsp;<span class="ident" id="5461462">length</span>&nbsp;<span class="op" id="5461469">&gt;</span>&nbsp;<span class="num" id="5461471">20</span>&nbsp;<span class="op" id="5461474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461480">return</span>&nbsp;<span class="ident" id="5461487">StructuralError</span><span class="op" id="5461502">(</span><span class="string" id="5461503">&#34;Huffman&nbsp;length&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5461532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461542">lengths</span><span class="op" id="5461549">[</span><span class="ident" id="5461550">j</span><span class="op" id="5461551">]</span>&nbsp;<span class="op" id="5461553">=</span>&nbsp;<span class="builtintype" id="5461555">uint8</span><span class="op" id="5461560">(</span><span class="ident" id="5461561">length</span><span class="op" id="5461567">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461575">huffmanTrees</span><span class="op" id="5461587">[</span><span class="ident" id="5461588">i</span><span class="op" id="5461589">]</span><span class="op" id="5461590">,</span>&nbsp;<span class="ident" id="5461592">err</span>&nbsp;<span class="op" id="5461596">=</span>&nbsp;<span class="ident" id="5461598">newHuffmanTree</span><span class="op" id="5461612">(</span><span class="ident" id="5461613">lengths</span><span class="op" id="5461620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461624">if</span>&nbsp;<span class="ident" id="5461627">err</span>&nbsp;<span class="op" id="5461631">!=</span>&nbsp;<span class="ident" id="5461634">nil</span>&nbsp;<span class="op" id="5461638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461643">return</span>&nbsp;<span class="ident" id="5461650">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461656">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461663">selectorIndex</span>&nbsp;<span class="op" id="5461677">:=</span>&nbsp;<span class="num" id="5461680">1</span>&nbsp;<span class="comment" id="5461682">//&nbsp;the&nbsp;next&nbsp;tree&nbsp;index&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461713">if</span>&nbsp;<span class="builtinfunc" id="5461716">len</span><span class="op" id="5461719">(</span><span class="ident" id="5461720">treeIndexes</span><span class="op" id="5461731">)</span>&nbsp;<span class="op" id="5461733">==</span>&nbsp;<span class="num" id="5461736">0</span>&nbsp;<span class="op" id="5461738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461742">return</span>&nbsp;<span class="ident" id="5461749">StructuralError</span><span class="op" id="5461764">(</span><span class="string" id="5461765">&#34;no&nbsp;tree&nbsp;selectors&nbsp;given&#34;</span><span class="op" id="5461790">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461796">if</span>&nbsp;<span class="builtintype" id="5461799">int</span><span class="op" id="5461802">(</span><span class="ident" id="5461803">treeIndexes</span><span class="op" id="5461814">[</span><span class="num" id="5461815">0</span><span class="op" id="5461816">]</span><span class="op" id="5461817">)</span>&nbsp;<span class="op" id="5461819">&gt;=</span>&nbsp;<span class="builtinfunc" id="5461822">len</span><span class="op" id="5461825">(</span><span class="ident" id="5461826">huffmanTrees</span><span class="op" id="5461838">)</span>&nbsp;<span class="op" id="5461840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461844">return</span>&nbsp;<span class="ident" id="5461851">StructuralError</span><span class="op" id="5461866">(</span><span class="string" id="5461867">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5461895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461901">currentHuffmanTree</span>&nbsp;<span class="op" id="5461920">:=</span>&nbsp;<span class="ident" id="5461923">huffmanTrees</span><span class="op" id="5461935">[</span><span class="ident" id="5461936">treeIndexes</span><span class="op" id="5461947">[</span><span class="num" id="5461948">0</span><span class="op" id="5461949">]</span><span class="op" id="5461950">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461953">bufIndex</span>&nbsp;<span class="op" id="5461962">:=</span>&nbsp;<span class="num" id="5461965">0</span>&nbsp;<span class="comment" id="5461967">//&nbsp;indexes&nbsp;bz2.buf,&nbsp;the&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462007">//&nbsp;The&nbsp;output&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;run-length&nbsp;encoded&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462079">//&nbsp;we&nbsp;merge&nbsp;the&nbsp;decoding&nbsp;into&nbsp;the&nbsp;Huffman&nbsp;parsing&nbsp;loop.&nbsp;These&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462146">//&nbsp;variables&nbsp;accumulate&nbsp;the&nbsp;repeat&nbsp;count.&nbsp;See&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462216">//&nbsp;details.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462229">repeat</span>&nbsp;<span class="op" id="5462236">:=</span>&nbsp;<span class="num" id="5462239">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462242">repeat_power</span>&nbsp;<span class="op" id="5462255">:=</span>&nbsp;<span class="num" id="5462258">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462262">//&nbsp;The&nbsp;`C&#39;&nbsp;array&nbsp;(used&nbsp;by&nbsp;the&nbsp;inverse&nbsp;BWT)&nbsp;needs&nbsp;to&nbsp;be&nbsp;zero&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462336">for</span>&nbsp;<span class="ident" id="5462340">i</span>&nbsp;<span class="op" id="5462342">:=</span>&nbsp;<span class="keyword" id="5462345">range</span>&nbsp;<span class="ident" id="5462351">bz2</span><span class="op" id="5462354">.</span><span class="ident" id="5462355">c</span>&nbsp;<span class="op" id="5462357">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462361">bz2</span><span class="op" id="5462364">.</span><span class="ident" id="5462365">c</span><span class="op" id="5462366">[</span><span class="ident" id="5462367">i</span><span class="op" id="5462368">]</span>&nbsp;<span class="op" id="5462370">=</span>&nbsp;<span class="num" id="5462372">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5462375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462379">decoded</span>&nbsp;<span class="op" id="5462387">:=</span>&nbsp;<span class="num" id="5462390">0</span>&nbsp;<span class="comment" id="5462392">//&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;symbols&nbsp;decoded&nbsp;by&nbsp;the&nbsp;current&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462454">for</span>&nbsp;<span class="op" id="5462458">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462462">if</span>&nbsp;<span class="ident" id="5462465">decoded</span>&nbsp;<span class="op" id="5462473">==</span>&nbsp;<span class="num" id="5462476">50</span>&nbsp;<span class="op" id="5462479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462484">if</span>&nbsp;<span class="ident" id="5462487">selectorIndex</span>&nbsp;<span class="op" id="5462501">&gt;=</span>&nbsp;<span class="ident" id="5462504">numSelectors</span>&nbsp;<span class="op" id="5462517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462523">return</span>&nbsp;<span class="ident" id="5462530">StructuralError</span><span class="op" id="5462545">(</span><span class="string" id="5462546">&#34;insufficient&nbsp;selector&nbsp;indices&nbsp;for&nbsp;number&nbsp;of&nbsp;symbols&#34;</span><span class="op" id="5462599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5462604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462609">if</span>&nbsp;<span class="builtintype" id="5462612">int</span><span class="op" id="5462615">(</span><span class="ident" id="5462616">treeIndexes</span><span class="op" id="5462627">[</span><span class="ident" id="5462628">selectorIndex</span><span class="op" id="5462641">]</span><span class="op" id="5462642">)</span>&nbsp;<span class="op" id="5462644">&gt;=</span>&nbsp;<span class="builtinfunc" id="5462647">len</span><span class="op" id="5462650">(</span><span class="ident" id="5462651">huffmanTrees</span><span class="op" id="5462663">)</span>&nbsp;<span class="op" id="5462665">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462671">return</span>&nbsp;<span class="ident" id="5462678">StructuralError</span><span class="op" id="5462693">(</span><span class="string" id="5462694">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5462722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5462727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462732">currentHuffmanTree</span>&nbsp;<span class="op" id="5462751">=</span>&nbsp;<span class="ident" id="5462753">huffmanTrees</span><span class="op" id="5462765">[</span><span class="ident" id="5462766">treeIndexes</span><span class="op" id="5462777">[</span><span class="ident" id="5462778">selectorIndex</span><span class="op" id="5462791">]</span><span class="op" id="5462792">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462797">selectorIndex</span><span class="op" id="5462810">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462816">decoded</span>&nbsp;<span class="op" id="5462824">=</span>&nbsp;<span class="num" id="5462826">0</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5462830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462835">v</span>&nbsp;<span class="op" id="5462837">:=</span>&nbsp;<span class="ident" id="5462840">currentHuffmanTree</span><span class="op" id="5462858">.</span><span class="ident" id="5462859">Decode</span><span class="op" id="5462865">(</span><span class="ident" id="5462866">br</span><span class="op" id="5462868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462872">decoded</span><span class="op" id="5462879">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462885">if</span>&nbsp;<span class="ident" id="5462888">v</span>&nbsp;<span class="op" id="5462890">&lt;</span>&nbsp;<span class="num" id="5462892">2</span>&nbsp;<span class="op" id="5462894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462899">//&nbsp;This&nbsp;is&nbsp;either&nbsp;the&nbsp;RUNA&nbsp;or&nbsp;RUNB&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462945">if</span>&nbsp;<span class="ident" id="5462948">repeat</span>&nbsp;<span class="op" id="5462955">==</span>&nbsp;<span class="num" id="5462958">0</span>&nbsp;<span class="op" id="5462960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462966">repeat_power</span>&nbsp;<span class="op" id="5462979">=</span>&nbsp;<span class="num" id="5462981">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5462986">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462991">repeat</span>&nbsp;<span class="op" id="5462998">+=</span>&nbsp;<span class="ident" id="5463001">repeat_power</span>&nbsp;<span class="op" id="5463014">&lt;&lt;</span>&nbsp;<span class="ident" id="5463017">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463022">repeat_power</span>&nbsp;<span class="op" id="5463035">&lt;&lt;=</span>&nbsp;<span class="num" id="5463039">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5463045">//&nbsp;This&nbsp;limit&nbsp;of&nbsp;2&nbsp;million&nbsp;comes&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5463103">//&nbsp;code.&nbsp;It&nbsp;prevents&nbsp;repeat&nbsp;from&nbsp;overflowing.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463152">if</span>&nbsp;<span class="ident" id="5463155">repeat</span>&nbsp;<span class="op" id="5463162">&gt;</span>&nbsp;<span class="num" id="5463164">2</span><span class="op" id="5463165">*</span><span class="num" id="5463166">1024</span><span class="op" id="5463170">*</span><span class="num" id="5463171">1024</span>&nbsp;<span class="op" id="5463176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463182">return</span>&nbsp;<span class="ident" id="5463189">StructuralError</span><span class="op" id="5463204">(</span><span class="string" id="5463205">&#34;repeat&nbsp;count&nbsp;too&nbsp;large&#34;</span><span class="op" id="5463229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463239">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463250">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463255">if</span>&nbsp;<span class="ident" id="5463258">repeat</span>&nbsp;<span class="op" id="5463265">&gt;</span>&nbsp;<span class="num" id="5463267">0</span>&nbsp;<span class="op" id="5463269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5463274">//&nbsp;We&nbsp;have&nbsp;decoded&nbsp;a&nbsp;complete&nbsp;run-length&nbsp;so&nbsp;we&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5463332">//&nbsp;replicate&nbsp;the&nbsp;last&nbsp;output&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463372">if</span>&nbsp;<span class="ident" id="5463375">repeat</span>&nbsp;<span class="op" id="5463382">&gt;</span>&nbsp;<span class="ident" id="5463384">bz2</span><span class="op" id="5463387">.</span><span class="ident" id="5463388">blockSize</span><span class="op" id="5463397">-</span><span class="ident" id="5463398">bufIndex</span>&nbsp;<span class="op" id="5463407">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463413">return</span>&nbsp;<span class="ident" id="5463420">StructuralError</span><span class="op" id="5463435">(</span><span class="string" id="5463436">&#34;repeats&nbsp;past&nbsp;end&nbsp;of&nbsp;block&#34;</span><span class="op" id="5463463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463473">for</span>&nbsp;<span class="ident" id="5463477">i</span>&nbsp;<span class="op" id="5463479">:=</span>&nbsp;<span class="num" id="5463482">0</span><span class="op" id="5463483">;</span>&nbsp;<span class="ident" id="5463485">i</span>&nbsp;<span class="op" id="5463487">&lt;</span>&nbsp;<span class="ident" id="5463489">repeat</span><span class="op" id="5463495">;</span>&nbsp;<span class="ident" id="5463497">i</span><span class="op" id="5463498">++</span>&nbsp;<span class="op" id="5463501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463507">b</span>&nbsp;<span class="op" id="5463509">:=</span>&nbsp;<span class="builtintype" id="5463512">byte</span><span class="op" id="5463516">(</span><span class="ident" id="5463517">mtf</span><span class="op" id="5463520">.</span><span class="ident" id="5463521">First</span><span class="op" id="5463526">(</span><span class="op" id="5463527">)</span><span class="op" id="5463528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463534">bz2</span><span class="op" id="5463537">.</span><span class="ident" id="5463538">tt</span><span class="op" id="5463540">[</span><span class="ident" id="5463541">bufIndex</span><span class="op" id="5463549">]</span>&nbsp;<span class="op" id="5463551">=</span>&nbsp;<span class="builtintype" id="5463553">uint32</span><span class="op" id="5463559">(</span><span class="ident" id="5463560">b</span><span class="op" id="5463561">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463567">bz2</span><span class="op" id="5463570">.</span><span class="ident" id="5463571">c</span><span class="op" id="5463572">[</span><span class="ident" id="5463573">b</span><span class="op" id="5463574">]</span><span class="op" id="5463575">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463582">bufIndex</span><span class="op" id="5463590">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463601">repeat</span>&nbsp;<span class="op" id="5463608">=</span>&nbsp;<span class="num" id="5463610">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463614">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463619">if</span>&nbsp;<span class="builtintype" id="5463622">int</span><span class="op" id="5463625">(</span><span class="ident" id="5463626">v</span><span class="op" id="5463627">)</span>&nbsp;<span class="op" id="5463629">==</span>&nbsp;<span class="ident" id="5463632">numSymbols</span><span class="op" id="5463642">-</span><span class="num" id="5463643">1</span>&nbsp;<span class="op" id="5463645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5463650">//&nbsp;This&nbsp;is&nbsp;the&nbsp;EOF&nbsp;symbol.&nbsp;Because&nbsp;it&#39;s&nbsp;always&nbsp;at&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5463707">//&nbsp;end&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;list,&nbsp;and&nbsp;never&nbsp;gets&nbsp;moved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5463765">//&nbsp;to&nbsp;the&nbsp;front,&nbsp;it&nbsp;has&nbsp;this&nbsp;unique&nbsp;value.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463811">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5463824">//&nbsp;Since&nbsp;two&nbsp;metasymbols&nbsp;(RUNA&nbsp;and&nbsp;RUNB)&nbsp;have&nbsp;values&nbsp;0&nbsp;and&nbsp;1,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5463888">//&nbsp;one&nbsp;would&nbsp;expect&nbsp;|v-2|&nbsp;to&nbsp;be&nbsp;passed&nbsp;to&nbsp;the&nbsp;MTF&nbsp;decoder.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5463949">//&nbsp;However,&nbsp;the&nbsp;front&nbsp;of&nbsp;the&nbsp;MTF&nbsp;list&nbsp;is&nbsp;never&nbsp;referenced&nbsp;as&nbsp;0,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5464015">//&nbsp;it&#39;s&nbsp;always&nbsp;referenced&nbsp;with&nbsp;a&nbsp;run-length&nbsp;of&nbsp;1.&nbsp;Thus&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5464074">//&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;encoded&nbsp;and&nbsp;we&nbsp;have&nbsp;|v-1|&nbsp;in&nbsp;the&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5464136">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464147">b</span>&nbsp;<span class="op" id="5464149">:=</span>&nbsp;<span class="builtintype" id="5464152">byte</span><span class="op" id="5464156">(</span><span class="ident" id="5464157">mtf</span><span class="op" id="5464160">.</span><span class="ident" id="5464161">Decode</span><span class="op" id="5464167">(</span><span class="builtintype" id="5464168">int</span><span class="op" id="5464171">(</span><span class="ident" id="5464172">v</span>&nbsp;<span class="op" id="5464174">-</span>&nbsp;<span class="num" id="5464176">1</span><span class="op" id="5464177">)</span><span class="op" id="5464178">)</span><span class="op" id="5464179">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5464183">if</span>&nbsp;<span class="ident" id="5464186">bufIndex</span>&nbsp;<span class="op" id="5464195">&gt;=</span>&nbsp;<span class="ident" id="5464198">bz2</span><span class="op" id="5464201">.</span><span class="ident" id="5464202">blockSize</span>&nbsp;<span class="op" id="5464212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5464217">return</span>&nbsp;<span class="ident" id="5464224">StructuralError</span><span class="op" id="5464239">(</span><span class="string" id="5464240">&#34;data&nbsp;exceeds&nbsp;block&nbsp;size&#34;</span><span class="op" id="5464265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5464269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464273">bz2</span><span class="op" id="5464276">.</span><span class="ident" id="5464277">tt</span><span class="op" id="5464279">[</span><span class="ident" id="5464280">bufIndex</span><span class="op" id="5464288">]</span>&nbsp;<span class="op" id="5464290">=</span>&nbsp;<span class="builtintype" id="5464292">uint32</span><span class="op" id="5464298">(</span><span class="ident" id="5464299">b</span><span class="op" id="5464300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464304">bz2</span><span class="op" id="5464307">.</span><span class="ident" id="5464308">c</span><span class="op" id="5464309">[</span><span class="ident" id="5464310">b</span><span class="op" id="5464311">]</span><span class="op" id="5464312">++</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464317">bufIndex</span><span class="op" id="5464325">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5464329">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5464333">if</span>&nbsp;<span class="ident" id="5464336">origPtr</span>&nbsp;<span class="op" id="5464344">&gt;=</span>&nbsp;<span class="builtintype" id="5464347">uint</span><span class="op" id="5464351">(</span><span class="ident" id="5464352">bufIndex</span><span class="op" id="5464360">)</span>&nbsp;<span class="op" id="5464362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5464366">return</span>&nbsp;<span class="ident" id="5464373">StructuralError</span><span class="op" id="5464388">(</span><span class="string" id="5464389">&#34;origPtr&nbsp;out&nbsp;of&nbsp;bounds&#34;</span><span class="op" id="5464412">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5464415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5464419">//&nbsp;We&nbsp;have&nbsp;completed&nbsp;the&nbsp;entropy&nbsp;decoding.&nbsp;Now&nbsp;we&nbsp;can&nbsp;perform&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5464486">//&nbsp;inverse&nbsp;BWT&nbsp;and&nbsp;setup&nbsp;the&nbsp;RLE&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464528">bz2</span><span class="op" id="5464531">.</span><span class="ident" id="5464532">preRLE</span>&nbsp;<span class="op" id="5464539">=</span>&nbsp;<span class="ident" id="5464541">bz2</span><span class="op" id="5464544">.</span><span class="ident" id="5464545">tt</span><span class="op" id="5464547">[</span><span class="op" id="5464548">:</span><span class="ident" id="5464549">bufIndex</span><span class="op" id="5464557">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464560">bz2</span><span class="op" id="5464563">.</span><span class="ident" id="5464564">preRLEUsed</span>&nbsp;<span class="op" id="5464575">=</span>&nbsp;<span class="num" id="5464577">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464580">bz2</span><span class="op" id="5464583">.</span><span class="ident" id="5464584">tPos</span>&nbsp;<span class="op" id="5464589">=</span>&nbsp;<span class="ident" id="5464591">inverseBWT</span><span class="op" id="5464601">(</span><span class="ident" id="5464602">bz2</span><span class="op" id="5464605">.</span><span class="ident" id="5464606">preRLE</span><span class="op" id="5464612">,</span>&nbsp;<span class="ident" id="5464614">origPtr</span><span class="op" id="5464621">,</span>&nbsp;<span class="ident" id="5464623">bz2</span><span class="op" id="5464626">.</span><span class="ident" id="5464627">c</span><span class="op" id="5464628">[</span><span class="op" id="5464629">:</span><span class="op" id="5464630">]</span><span class="op" id="5464631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464634">bz2</span><span class="op" id="5464637">.</span><span class="ident" id="5464638">lastByte</span>&nbsp;<span class="op" id="5464647">=</span>&nbsp;<span class="op" id="5464649">-</span><span class="num" id="5464650">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464653">bz2</span><span class="op" id="5464656">.</span><span class="ident" id="5464657">byteRepeats</span>&nbsp;<span class="op" id="5464669">=</span>&nbsp;<span class="num" id="5464671">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464674">bz2</span><span class="op" id="5464677">.</span><span class="ident" id="5464678">repeats</span>&nbsp;<span class="op" id="5464686">=</span>&nbsp;<span class="num" id="5464688">0</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5464692">return</span>&nbsp;<span class="ident" id="5464699">nil</span><br>
<span class="lineno"></span><span class="op" id="5464703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5464706">//&nbsp;inverseBWT&nbsp;implements&nbsp;the&nbsp;inverse&nbsp;Burrows-Wheeler&nbsp;transform&nbsp;as&nbsp;described&nbsp;in</span><br>
<span class="lineno">450</span><span class="comment" id="5464785">//&nbsp;http://www.hpl.hp.com/techreports/Compaq-DEC/SRC-RR-124.pdf,&nbsp;section&nbsp;4.2.</span><br>
<span class="lineno"></span><span class="comment" id="5464862">//&nbsp;In&nbsp;that&nbsp;document,&nbsp;origPtr&nbsp;is&nbsp;called&nbsp;`I&#39;&nbsp;and&nbsp;c&nbsp;is&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5464938">//&nbsp;first&nbsp;pass&nbsp;over&nbsp;the&nbsp;data.&nbsp;It&#39;s&nbsp;an&nbsp;argument&nbsp;here&nbsp;because&nbsp;we&nbsp;merge&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="5465016">//&nbsp;pass&nbsp;with&nbsp;the&nbsp;Huffman&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="comment" id="5465051">//</span><br>
<span class="lineno">455</span><span class="comment" id="5465054">//&nbsp;This&nbsp;also&nbsp;implements&nbsp;the&nbsp;`single&nbsp;array&#39;&nbsp;method&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="5465131">//&nbsp;which&nbsp;leaves&nbsp;the&nbsp;output,&nbsp;still&nbsp;shuffled,&nbsp;in&nbsp;the&nbsp;bottom&nbsp;8&nbsp;bits&nbsp;of&nbsp;tt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5465211">//&nbsp;index&nbsp;of&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;top&nbsp;24-bits.&nbsp;The&nbsp;index&nbsp;of&nbsp;the&nbsp;first&nbsp;byte&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5465288">//&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="5465301">func</span>&nbsp;<span class="ident" id="5465306">inverseBWT</span><span class="op" id="5465316">(</span><span class="ident" id="5465317">tt</span>&nbsp;<span class="op" id="5465320">[</span><span class="op" id="5465321">]</span><span class="builtintype" id="5465322">uint32</span><span class="op" id="5465328">,</span>&nbsp;<span class="ident" id="5465330">origPtr</span>&nbsp;<span class="builtintype" id="5465338">uint</span><span class="op" id="5465342">,</span>&nbsp;<span class="ident" id="5465344">c</span>&nbsp;<span class="op" id="5465346">[</span><span class="op" id="5465347">]</span><span class="builtintype" id="5465348">uint</span><span class="op" id="5465352">)</span>&nbsp;<span class="builtintype" id="5465354">uint32</span>&nbsp;<span class="op" id="5465361">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465364">sum</span>&nbsp;<span class="op" id="5465368">:=</span>&nbsp;<span class="builtintype" id="5465371">uint</span><span class="op" id="5465375">(</span><span class="num" id="5465376">0</span><span class="op" id="5465377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465380">for</span>&nbsp;<span class="ident" id="5465384">i</span>&nbsp;<span class="op" id="5465386">:=</span>&nbsp;<span class="num" id="5465389">0</span><span class="op" id="5465390">;</span>&nbsp;<span class="ident" id="5465392">i</span>&nbsp;<span class="op" id="5465394">&lt;</span>&nbsp;<span class="num" id="5465396">256</span><span class="op" id="5465399">;</span>&nbsp;<span class="ident" id="5465401">i</span><span class="op" id="5465402">++</span>&nbsp;<span class="op" id="5465405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465409">sum</span>&nbsp;<span class="op" id="5465413">+=</span>&nbsp;<span class="ident" id="5465416">c</span><span class="op" id="5465417">[</span><span class="ident" id="5465418">i</span><span class="op" id="5465419">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465423">c</span><span class="op" id="5465424">[</span><span class="ident" id="5465425">i</span><span class="op" id="5465426">]</span>&nbsp;<span class="op" id="5465428">=</span>&nbsp;<span class="ident" id="5465430">sum</span>&nbsp;<span class="op" id="5465434">-</span>&nbsp;<span class="ident" id="5465436">c</span><span class="op" id="5465437">[</span><span class="ident" id="5465438">i</span><span class="op" id="5465439">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465442">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465446">for</span>&nbsp;<span class="ident" id="5465450">i</span>&nbsp;<span class="op" id="5465452">:=</span>&nbsp;<span class="keyword" id="5465455">range</span>&nbsp;<span class="ident" id="5465461">tt</span>&nbsp;<span class="op" id="5465464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465468">b</span>&nbsp;<span class="op" id="5465470">:=</span>&nbsp;<span class="ident" id="5465473">tt</span><span class="op" id="5465475">[</span><span class="ident" id="5465476">i</span><span class="op" id="5465477">]</span>&nbsp;<span class="op" id="5465479">&amp;</span>&nbsp;<span class="num" id="5465481">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465488">tt</span><span class="op" id="5465490">[</span><span class="ident" id="5465491">c</span><span class="op" id="5465492">[</span><span class="ident" id="5465493">b</span><span class="op" id="5465494">]</span><span class="op" id="5465495">]</span>&nbsp;<span class="op" id="5465497">|=</span>&nbsp;<span class="builtintype" id="5465500">uint32</span><span class="op" id="5465506">(</span><span class="ident" id="5465507">i</span><span class="op" id="5465508">)</span>&nbsp;<span class="op" id="5465510">&lt;&lt;</span>&nbsp;<span class="num" id="5465513">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465517">c</span><span class="op" id="5465518">[</span><span class="ident" id="5465519">b</span><span class="op" id="5465520">]</span><span class="op" id="5465521">++</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465529">return</span>&nbsp;<span class="ident" id="5465536">tt</span><span class="op" id="5465538">[</span><span class="ident" id="5465539">origPtr</span><span class="op" id="5465546">]</span>&nbsp;<span class="op" id="5465548">&gt;&gt;</span>&nbsp;<span class="num" id="5465551">8</span><br>
<span class="lineno"></span><span class="op" id="5465553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span><span class="comment" id="5465556">//&nbsp;This&nbsp;is&nbsp;a&nbsp;standard&nbsp;CRC32&nbsp;like&nbsp;in&nbsp;hash/crc32&nbsp;except&nbsp;that&nbsp;all&nbsp;the&nbsp;shifts&nbsp;are&nbsp;reversed,</span><br>
<span class="lineno"></span><span class="comment" id="5465644">//&nbsp;causing&nbsp;the&nbsp;bits&nbsp;in&nbsp;the&nbsp;input&nbsp;to&nbsp;be&nbsp;processed&nbsp;in&nbsp;the&nbsp;reverse&nbsp;of&nbsp;the&nbsp;usual&nbsp;order.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5465729">var</span>&nbsp;<span class="ident" id="5465733">crctab</span>&nbsp;<span class="op" id="5465740">[</span><span class="num" id="5465741">256</span><span class="op" id="5465744">]</span><span class="builtintype" id="5465745">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span><span class="keyword" id="5465753">func</span>&nbsp;<span class="ident" id="5465758">init</span><span class="op" id="5465762">(</span><span class="op" id="5465763">)</span>&nbsp;<span class="op" id="5465765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465768">const</span>&nbsp;<span class="ident" id="5465774">poly</span>&nbsp;<span class="op" id="5465779">=</span>&nbsp;<span class="num" id="5465781">0x04C11DB7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465793">for</span>&nbsp;<span class="ident" id="5465797">i</span>&nbsp;<span class="op" id="5465799">:=</span>&nbsp;<span class="keyword" id="5465802">range</span>&nbsp;<span class="ident" id="5465808">crctab</span>&nbsp;<span class="op" id="5465815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465819">crc</span>&nbsp;<span class="op" id="5465823">:=</span>&nbsp;<span class="builtintype" id="5465826">uint32</span><span class="op" id="5465832">(</span><span class="ident" id="5465833">i</span><span class="op" id="5465834">)</span>&nbsp;<span class="op" id="5465836">&lt;&lt;</span>&nbsp;<span class="num" id="5465839">24</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465844">for</span>&nbsp;<span class="ident" id="5465848">j</span>&nbsp;<span class="op" id="5465850">:=</span>&nbsp;<span class="num" id="5465853">0</span><span class="op" id="5465854">;</span>&nbsp;<span class="ident" id="5465856">j</span>&nbsp;<span class="op" id="5465858">&lt;</span>&nbsp;<span class="num" id="5465860">8</span><span class="op" id="5465861">;</span>&nbsp;<span class="ident" id="5465863">j</span><span class="op" id="5465864">++</span>&nbsp;<span class="op" id="5465867">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465872">if</span>&nbsp;<span class="ident" id="5465875">crc</span><span class="op" id="5465878">&amp;</span><span class="num" id="5465879">0x80000000</span>&nbsp;<span class="op" id="5465890">!=</span>&nbsp;<span class="num" id="5465893">0</span>&nbsp;<span class="op" id="5465895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465901">crc</span>&nbsp;<span class="op" id="5465905">=</span>&nbsp;<span class="op" id="5465907">(</span><span class="ident" id="5465908">crc</span>&nbsp;<span class="op" id="5465912">&lt;&lt;</span>&nbsp;<span class="num" id="5465915">1</span><span class="op" id="5465916">)</span>&nbsp;<span class="op" id="5465918">^</span>&nbsp;<span class="ident" id="5465920">poly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465928">}</span>&nbsp;<span class="keyword" id="5465930">else</span>&nbsp;<span class="op" id="5465935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465941">crc</span>&nbsp;<span class="op" id="5465945">&lt;&lt;=</span>&nbsp;<span class="num" id="5465949">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465954">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465962">crctab</span><span class="op" id="5465968">[</span><span class="ident" id="5465969">i</span><span class="op" id="5465970">]</span>&nbsp;<span class="op" id="5465972">=</span>&nbsp;<span class="ident" id="5465974">crc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465979">}</span><br>
<span class="lineno"></span><span class="op" id="5465981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="5465984">//&nbsp;updateCRC&nbsp;updates&nbsp;the&nbsp;crc&nbsp;value&nbsp;to&nbsp;incorporate&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="5466049">//&nbsp;The&nbsp;initial&nbsp;value&nbsp;is&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="5466076">func</span>&nbsp;<span class="ident" id="5466081">updateCRC</span><span class="op" id="5466090">(</span><span class="ident" id="5466091">val</span>&nbsp;<span class="builtintype" id="5466095">uint32</span><span class="op" id="5466101">,</span>&nbsp;<span class="ident" id="5466103">b</span>&nbsp;<span class="op" id="5466105">[</span><span class="op" id="5466106">]</span><span class="builtintype" id="5466107">byte</span><span class="op" id="5466111">)</span>&nbsp;<span class="builtintype" id="5466113">uint32</span>&nbsp;<span class="op" id="5466120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466123">crc</span>&nbsp;<span class="op" id="5466127">:=</span>&nbsp;<span class="op" id="5466130">^</span><span class="ident" id="5466131">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466136">for</span>&nbsp;<span class="ident" id="5466140">_</span><span class="op" id="5466141">,</span>&nbsp;<span class="ident" id="5466143">v</span>&nbsp;<span class="op" id="5466145">:=</span>&nbsp;<span class="keyword" id="5466148">range</span>&nbsp;<span class="ident" id="5466154">b</span>&nbsp;<span class="op" id="5466156">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466160">crc</span>&nbsp;<span class="op" id="5466164">=</span>&nbsp;<span class="ident" id="5466166">crctab</span><span class="op" id="5466172">[</span><span class="builtintype" id="5466173">byte</span><span class="op" id="5466177">(</span><span class="ident" id="5466178">crc</span><span class="op" id="5466181">&gt;&gt;</span><span class="num" id="5466183">24</span><span class="op" id="5466185">)</span><span class="op" id="5466186">^</span><span class="ident" id="5466187">v</span><span class="op" id="5466188">]</span>&nbsp;<span class="op" id="5466190">^</span>&nbsp;<span class="op" id="5466192">(</span><span class="ident" id="5466193">crc</span>&nbsp;<span class="op" id="5466197">&lt;&lt;</span>&nbsp;<span class="num" id="5466200">8</span><span class="op" id="5466201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5466204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466207">return</span>&nbsp;<span class="op" id="5466214">^</span><span class="ident" id="5466215">crc</span><br>
<span class="lineno"></span><span class="op" id="5466219">}</span>
</div>
</body>
</html>
