<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/json</h2>
<ul>
<li><a href="/gostd/encoding/json/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/encoding/json/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/json/decode_test.go.html">decode_test.go</a></li>
<li><a href="/gostd/encoding/json/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/json/encode_test.go.html">encode_test.go</a></li>
<li><a href="/gostd/encoding/json/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/json/fold.go.html">fold.go</a></li>
<li><a href="/gostd/encoding/json/fold_test.go.html">fold_test.go</a></li>
<li><a href="/gostd/encoding/json/indent.go.html">indent.go</a></li>
<li><a href="/gostd/encoding/json/scanner.go.html">scanner.go</a></li>
<li><a href="/gostd/encoding/json/scanner_test.go.html">scanner_test.go</a></li>
<li><a href="/gostd/encoding/json/stream.go.html">stream.go</a></li>
<li><a href="/gostd/encoding/json/stream_test.go.html" class="current">stream_test.go</a></li>
<li><a href="/gostd/encoding/json/tagkey_test.go.html">tagkey_test.go</a></li>
<li><a href="/gostd/encoding/json/tags.go.html">tags.go</a></li>
<li><a href="/gostd/encoding/json/tags_test.go.html">tags_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6895213">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6895269">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6895323">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6895374">package</span>&nbsp;<span class="ident" id="6895382">json</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6895388">import</span>&nbsp;<span class="op" id="6895395">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6895398">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6895407">&#34;io/ioutil&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6895420">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6895427">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6895438">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6895449">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="6895459">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="6895462">//&nbsp;Test&nbsp;values&nbsp;for&nbsp;the&nbsp;stream&nbsp;test.</span><br>
<span class="lineno"></span><span class="comment" id="6895498">//&nbsp;One&nbsp;of&nbsp;each&nbsp;JSON&nbsp;kind.</span><br>
<span class="lineno"></span><span class="keyword" id="6895524">var</span>&nbsp;<span class="ident" id="6895528">streamTest</span>&nbsp;<span class="op" id="6895539">=</span>&nbsp;<span class="op" id="6895541">[</span><span class="op" id="6895542">]</span><span class="keyword" id="6895543">interface</span><span class="op" id="6895552">{</span><span class="op" id="6895553">}</span><span class="op" id="6895554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="6895557">0.1</span><span class="op" id="6895560">,</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6895563">&#34;hello&#34;</span><span class="op" id="6895570">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6895573">nil</span><span class="op" id="6895576">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6895579">true</span><span class="op" id="6895583">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6895586">false</span><span class="op" id="6895591">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6895594">[</span><span class="op" id="6895595">]</span><span class="keyword" id="6895596">interface</span><span class="op" id="6895605">{</span><span class="op" id="6895606">}</span><span class="op" id="6895607">{</span><span class="string" id="6895608">&#34;a&#34;</span><span class="op" id="6895611">,</span>&nbsp;<span class="string" id="6895613">&#34;b&#34;</span><span class="op" id="6895616">,</span>&nbsp;<span class="string" id="6895618">&#34;c&#34;</span><span class="op" id="6895621">}</span><span class="op" id="6895622">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6895625">map</span><span class="op" id="6895628">[</span><span class="builtintype" id="6895629">string</span><span class="op" id="6895635">]</span><span class="keyword" id="6895636">interface</span><span class="op" id="6895645">{</span><span class="op" id="6895646">}</span><span class="op" id="6895647">{</span><span class="string" id="6895648">&#34;K&#34;</span><span class="op" id="6895653">:</span>&nbsp;<span class="string" id="6895655">&#34;Kelvin&#34;</span><span class="op" id="6895663">,</span>&nbsp;<span class="string" id="6895665">&#34;ß&#34;</span><span class="op" id="6895669">:</span>&nbsp;<span class="string" id="6895671">&#34;long&nbsp;s&#34;</span><span class="op" id="6895679">}</span><span class="op" id="6895680">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="6895683">3.14</span><span class="op" id="6895687">,</span>&nbsp;<span class="comment" id="6895689">//&nbsp;another&nbsp;value&nbsp;to&nbsp;make&nbsp;sure&nbsp;something&nbsp;can&nbsp;follow&nbsp;map</span><br>
<span class="lineno"></span><span class="op" id="6895744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6895747">var</span>&nbsp;<span class="ident" id="6895751">streamEncoded</span>&nbsp;<span class="op" id="6895765">=</span>&nbsp;<span class="string" id="6895767">`0.1<br>
<span class="lineno">30</span>&#34;hello&#34;<br>
<span class="lineno"></span>null<br>
<span class="lineno"></span>true<br>
<span class="lineno"></span>false<br>
<span class="lineno"></span>[&#34;a&#34;,&#34;b&#34;,&#34;c&#34;]<br>
<span class="lineno">35</span>{&#34;ß&#34;:&#34;long&nbsp;s&#34;,&#34;K&#34;:&#34;Kelvin&#34;}<br>
<span class="lineno"></span>3.14<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6895849">func</span>&nbsp;<span class="ident" id="6895854">TestEncoder</span><span class="op" id="6895865">(</span><span class="ident" id="6895866">t</span>&nbsp;<span class="op" id="6895868">*</span><span class="ident" id="6895869">testing</span><span class="op" id="6895876">.</span><span class="ident" id="6895877">T</span><span class="op" id="6895878">)</span>&nbsp;<span class="op" id="6895880">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6895883">for</span>&nbsp;<span class="ident" id="6895887">i</span>&nbsp;<span class="op" id="6895889">:=</span>&nbsp;<span class="num" id="6895892">0</span><span class="op" id="6895893">;</span>&nbsp;<span class="ident" id="6895895">i</span>&nbsp;<span class="op" id="6895897">&lt;=</span>&nbsp;<span class="builtinfunc" id="6895900">len</span><span class="op" id="6895903">(</span><span class="ident" id="6895904">streamTest</span><span class="op" id="6895914">)</span><span class="op" id="6895915">;</span>&nbsp;<span class="ident" id="6895917">i</span><span class="op" id="6895918">++</span>&nbsp;<span class="op" id="6895921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6895925">var</span>&nbsp;<span class="ident" id="6895929">buf</span>&nbsp;<span class="ident" id="6895933">bytes</span><span class="op" id="6895938">.</span><span class="ident" id="6895939">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6895948">enc</span>&nbsp;<span class="op" id="6895952">:=</span>&nbsp;<span class="ident" id="6895955">NewEncoder</span><span class="op" id="6895965">(</span><span class="op" id="6895966">&amp;</span><span class="ident" id="6895967">buf</span><span class="op" id="6895970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6895974">for</span>&nbsp;<span class="ident" id="6895978">j</span><span class="op" id="6895979">,</span>&nbsp;<span class="ident" id="6895981">v</span>&nbsp;<span class="op" id="6895983">:=</span>&nbsp;<span class="keyword" id="6895986">range</span>&nbsp;<span class="ident" id="6895992">streamTest</span><span class="op" id="6896002">[</span><span class="num" id="6896003">0</span><span class="op" id="6896004">:</span><span class="ident" id="6896005">i</span><span class="op" id="6896006">]</span>&nbsp;<span class="op" id="6896008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6896013">if</span>&nbsp;<span class="ident" id="6896016">err</span>&nbsp;<span class="op" id="6896020">:=</span>&nbsp;<span class="ident" id="6896023">enc</span><span class="op" id="6896026">.</span><span class="ident" id="6896027">Encode</span><span class="op" id="6896033">(</span><span class="ident" id="6896034">v</span><span class="op" id="6896035">)</span><span class="op" id="6896036">;</span>&nbsp;<span class="ident" id="6896038">err</span>&nbsp;<span class="op" id="6896042">!=</span>&nbsp;<span class="builtintype" id="6896045">nil</span>&nbsp;<span class="op" id="6896049">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6896055">t</span><span class="op" id="6896056">.</span><span class="ident" id="6896057">Fatalf</span><span class="op" id="6896063">(</span><span class="string" id="6896064">&#34;encode&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="6896080">,</span>&nbsp;<span class="ident" id="6896082">j</span><span class="op" id="6896083">,</span>&nbsp;<span class="ident" id="6896085">err</span><span class="op" id="6896088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6896093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6896097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6896101">if</span>&nbsp;<span class="ident" id="6896104">have</span><span class="op" id="6896108">,</span>&nbsp;<span class="ident" id="6896110">want</span>&nbsp;<span class="op" id="6896115">:=</span>&nbsp;<span class="ident" id="6896118">buf</span><span class="op" id="6896121">.</span><span class="ident" id="6896122">String</span><span class="op" id="6896128">(</span><span class="op" id="6896129">)</span><span class="op" id="6896130">,</span>&nbsp;<span class="ident" id="6896132">nlines</span><span class="op" id="6896138">(</span><span class="ident" id="6896139">streamEncoded</span><span class="op" id="6896152">,</span>&nbsp;<span class="ident" id="6896154">i</span><span class="op" id="6896155">)</span><span class="op" id="6896156">;</span>&nbsp;<span class="ident" id="6896158">have</span>&nbsp;<span class="op" id="6896163">!=</span>&nbsp;<span class="ident" id="6896166">want</span>&nbsp;<span class="op" id="6896171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6896176">t</span><span class="op" id="6896177">.</span><span class="ident" id="6896178">Errorf</span><span class="op" id="6896184">(</span><span class="string" id="6896185">&#34;encoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="6896214">,</span>&nbsp;<span class="ident" id="6896216">i</span><span class="op" id="6896217">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6896222">diff</span><span class="op" id="6896226">(</span><span class="ident" id="6896227">t</span><span class="op" id="6896228">,</span>&nbsp;<span class="op" id="6896230">[</span><span class="op" id="6896231">]</span><span class="builtintype" id="6896232">byte</span><span class="op" id="6896236">(</span><span class="ident" id="6896237">have</span><span class="op" id="6896241">)</span><span class="op" id="6896242">,</span>&nbsp;<span class="op" id="6896244">[</span><span class="op" id="6896245">]</span><span class="builtintype" id="6896246">byte</span><span class="op" id="6896250">(</span><span class="ident" id="6896251">want</span><span class="op" id="6896255">)</span><span class="op" id="6896256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6896261">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6896269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6896272">}</span><br>
<span class="lineno"></span><span class="op" id="6896274">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="6896277">func</span>&nbsp;<span class="ident" id="6896282">TestDecoder</span><span class="op" id="6896293">(</span><span class="ident" id="6896294">t</span>&nbsp;<span class="op" id="6896296">*</span><span class="ident" id="6896297">testing</span><span class="op" id="6896304">.</span><span class="ident" id="6896305">T</span><span class="op" id="6896306">)</span>&nbsp;<span class="op" id="6896308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6896311">for</span>&nbsp;<span class="ident" id="6896315">i</span>&nbsp;<span class="op" id="6896317">:=</span>&nbsp;<span class="num" id="6896320">0</span><span class="op" id="6896321">;</span>&nbsp;<span class="ident" id="6896323">i</span>&nbsp;<span class="op" id="6896325">&lt;=</span>&nbsp;<span class="builtinfunc" id="6896328">len</span><span class="op" id="6896331">(</span><span class="ident" id="6896332">streamTest</span><span class="op" id="6896342">)</span><span class="op" id="6896343">;</span>&nbsp;<span class="ident" id="6896345">i</span><span class="op" id="6896346">++</span>&nbsp;<span class="op" id="6896349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6896353">//&nbsp;Use&nbsp;stream&nbsp;without&nbsp;newlines&nbsp;as&nbsp;input,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6896396">//&nbsp;just&nbsp;to&nbsp;stress&nbsp;the&nbsp;decoder&nbsp;even&nbsp;more.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6896439">//&nbsp;Our&nbsp;test&nbsp;input&nbsp;does&nbsp;not&nbsp;include&nbsp;back-to-back&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6896498">//&nbsp;Otherwise&nbsp;stripping&nbsp;the&nbsp;newlines&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6896542">//&nbsp;merge&nbsp;two&nbsp;adjacent&nbsp;JSON&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6896579">var</span>&nbsp;<span class="ident" id="6896583">buf</span>&nbsp;<span class="ident" id="6896587">bytes</span><span class="op" id="6896592">.</span><span class="ident" id="6896593">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6896602">for</span>&nbsp;<span class="ident" id="6896606">_</span><span class="op" id="6896607">,</span>&nbsp;<span class="ident" id="6896609">c</span>&nbsp;<span class="op" id="6896611">:=</span>&nbsp;<span class="keyword" id="6896614">range</span>&nbsp;<span class="ident" id="6896620">nlines</span><span class="op" id="6896626">(</span><span class="ident" id="6896627">streamEncoded</span><span class="op" id="6896640">,</span>&nbsp;<span class="ident" id="6896642">i</span><span class="op" id="6896643">)</span>&nbsp;<span class="op" id="6896645">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6896650">if</span>&nbsp;<span class="ident" id="6896653">c</span>&nbsp;<span class="op" id="6896655">!=</span>&nbsp;<span class="string" id="6896658">&#39;\n&#39;</span>&nbsp;<span class="op" id="6896663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6896669">buf</span><span class="op" id="6896672">.</span><span class="ident" id="6896673">WriteRune</span><span class="op" id="6896682">(</span><span class="ident" id="6896683">c</span><span class="op" id="6896684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6896689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6896693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6896697">out</span>&nbsp;<span class="op" id="6896701">:=</span>&nbsp;<span class="builtinfunc" id="6896704">make</span><span class="op" id="6896708">(</span><span class="op" id="6896709">[</span><span class="op" id="6896710">]</span><span class="keyword" id="6896711">interface</span><span class="op" id="6896720">{</span><span class="op" id="6896721">}</span><span class="op" id="6896722">,</span>&nbsp;<span class="ident" id="6896724">i</span><span class="op" id="6896725">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6896729">dec</span>&nbsp;<span class="op" id="6896733">:=</span>&nbsp;<span class="ident" id="6896736">NewDecoder</span><span class="op" id="6896746">(</span><span class="op" id="6896747">&amp;</span><span class="ident" id="6896748">buf</span><span class="op" id="6896751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6896755">for</span>&nbsp;<span class="ident" id="6896759">j</span>&nbsp;<span class="op" id="6896761">:=</span>&nbsp;<span class="keyword" id="6896764">range</span>&nbsp;<span class="ident" id="6896770">out</span>&nbsp;<span class="op" id="6896774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6896779">if</span>&nbsp;<span class="ident" id="6896782">err</span>&nbsp;<span class="op" id="6896786">:=</span>&nbsp;<span class="ident" id="6896789">dec</span><span class="op" id="6896792">.</span><span class="ident" id="6896793">Decode</span><span class="op" id="6896799">(</span><span class="op" id="6896800">&amp;</span><span class="ident" id="6896801">out</span><span class="op" id="6896804">[</span><span class="ident" id="6896805">j</span><span class="op" id="6896806">]</span><span class="op" id="6896807">)</span><span class="op" id="6896808">;</span>&nbsp;<span class="ident" id="6896810">err</span>&nbsp;<span class="op" id="6896814">!=</span>&nbsp;<span class="builtintype" id="6896817">nil</span>&nbsp;<span class="op" id="6896821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6896827">t</span><span class="op" id="6896828">.</span><span class="ident" id="6896829">Fatalf</span><span class="op" id="6896835">(</span><span class="string" id="6896836">&#34;decode&nbsp;#%d/%d:&nbsp;%v&#34;</span><span class="op" id="6896855">,</span>&nbsp;<span class="ident" id="6896857">j</span><span class="op" id="6896858">,</span>&nbsp;<span class="ident" id="6896860">i</span><span class="op" id="6896861">,</span>&nbsp;<span class="ident" id="6896863">err</span><span class="op" id="6896866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6896871">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6896875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6896879">if</span>&nbsp;<span class="op" id="6896882">!</span><span class="ident" id="6896883">reflect</span><span class="op" id="6896890">.</span><span class="ident" id="6896891">DeepEqual</span><span class="op" id="6896900">(</span><span class="ident" id="6896901">out</span><span class="op" id="6896904">,</span>&nbsp;<span class="ident" id="6896906">streamTest</span><span class="op" id="6896916">[</span><span class="num" id="6896917">0</span><span class="op" id="6896918">:</span><span class="ident" id="6896919">i</span><span class="op" id="6896920">]</span><span class="op" id="6896921">)</span>&nbsp;<span class="op" id="6896923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6896928">t</span><span class="op" id="6896929">.</span><span class="ident" id="6896930">Errorf</span><span class="op" id="6896936">(</span><span class="string" id="6896937">&#34;decoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="6896966">,</span>&nbsp;<span class="ident" id="6896968">i</span><span class="op" id="6896969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6896974">for</span>&nbsp;<span class="ident" id="6896978">j</span>&nbsp;<span class="op" id="6896980">:=</span>&nbsp;<span class="keyword" id="6896983">range</span>&nbsp;<span class="ident" id="6896989">out</span>&nbsp;<span class="op" id="6896993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6896999">if</span>&nbsp;<span class="op" id="6897002">!</span><span class="ident" id="6897003">reflect</span><span class="op" id="6897010">.</span><span class="ident" id="6897011">DeepEqual</span><span class="op" id="6897020">(</span><span class="ident" id="6897021">out</span><span class="op" id="6897024">[</span><span class="ident" id="6897025">j</span><span class="op" id="6897026">]</span><span class="op" id="6897027">,</span>&nbsp;<span class="ident" id="6897029">streamTest</span><span class="op" id="6897039">[</span><span class="ident" id="6897040">j</span><span class="op" id="6897041">]</span><span class="op" id="6897042">)</span>&nbsp;<span class="op" id="6897044">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6897051">t</span><span class="op" id="6897052">.</span><span class="ident" id="6897053">Errorf</span><span class="op" id="6897059">(</span><span class="string" id="6897060">&#34;#%d:&nbsp;have&nbsp;%v&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6897082">,</span>&nbsp;<span class="ident" id="6897084">j</span><span class="op" id="6897085">,</span>&nbsp;<span class="ident" id="6897087">out</span><span class="op" id="6897090">[</span><span class="ident" id="6897091">j</span><span class="op" id="6897092">]</span><span class="op" id="6897093">,</span>&nbsp;<span class="ident" id="6897095">streamTest</span><span class="op" id="6897105">[</span><span class="ident" id="6897106">j</span><span class="op" id="6897107">]</span><span class="op" id="6897108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6897114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6897119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6897124">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6897132">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6897135">}</span><br>
<span class="lineno"></span><span class="op" id="6897137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6897140">func</span>&nbsp;<span class="ident" id="6897145">TestDecoderBuffered</span><span class="op" id="6897164">(</span><span class="ident" id="6897165">t</span>&nbsp;<span class="op" id="6897167">*</span><span class="ident" id="6897168">testing</span><span class="op" id="6897175">.</span><span class="ident" id="6897176">T</span><span class="op" id="6897177">)</span>&nbsp;<span class="op" id="6897179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6897182">r</span>&nbsp;<span class="op" id="6897184">:=</span>&nbsp;<span class="ident" id="6897187">strings</span><span class="op" id="6897194">.</span><span class="ident" id="6897195">NewReader</span><span class="op" id="6897204">(</span><span class="string" id="6897205">`{&#34;Name&#34;:&nbsp;&#34;Gopher&#34;}&nbsp;extra&nbsp;`</span><span class="op" id="6897232">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6897235">var</span>&nbsp;<span class="ident" id="6897239">m</span>&nbsp;<span class="keyword" id="6897241">struct</span>&nbsp;<span class="op" id="6897248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6897252">Name</span>&nbsp;<span class="builtintype" id="6897257">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6897265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6897268">d</span>&nbsp;<span class="op" id="6897270">:=</span>&nbsp;<span class="ident" id="6897273">NewDecoder</span><span class="op" id="6897283">(</span><span class="ident" id="6897284">r</span><span class="op" id="6897285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6897288">err</span>&nbsp;<span class="op" id="6897292">:=</span>&nbsp;<span class="ident" id="6897295">d</span><span class="op" id="6897296">.</span><span class="ident" id="6897297">Decode</span><span class="op" id="6897303">(</span><span class="op" id="6897304">&amp;</span><span class="ident" id="6897305">m</span><span class="op" id="6897306">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6897309">if</span>&nbsp;<span class="ident" id="6897312">err</span>&nbsp;<span class="op" id="6897316">!=</span>&nbsp;<span class="builtintype" id="6897319">nil</span>&nbsp;<span class="op" id="6897323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6897327">t</span><span class="op" id="6897328">.</span><span class="ident" id="6897329">Fatal</span><span class="op" id="6897334">(</span><span class="ident" id="6897335">err</span><span class="op" id="6897338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6897341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6897344">if</span>&nbsp;<span class="ident" id="6897347">m</span><span class="op" id="6897348">.</span><span class="ident" id="6897349">Name</span>&nbsp;<span class="op" id="6897354">!=</span>&nbsp;<span class="string" id="6897357">&#34;Gopher&#34;</span>&nbsp;<span class="op" id="6897366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6897370">t</span><span class="op" id="6897371">.</span><span class="ident" id="6897372">Errorf</span><span class="op" id="6897378">(</span><span class="string" id="6897379">&#34;Name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;Gopher&#34;</span><span class="op" id="6897403">,</span>&nbsp;<span class="ident" id="6897405">m</span><span class="op" id="6897406">.</span><span class="ident" id="6897407">Name</span><span class="op" id="6897411">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6897414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6897417">rest</span><span class="op" id="6897421">,</span>&nbsp;<span class="ident" id="6897423">err</span>&nbsp;<span class="op" id="6897427">:=</span>&nbsp;<span class="ident" id="6897430">ioutil</span><span class="op" id="6897436">.</span><span class="ident" id="6897437">ReadAll</span><span class="op" id="6897444">(</span><span class="ident" id="6897445">d</span><span class="op" id="6897446">.</span><span class="ident" id="6897447">Buffered</span><span class="op" id="6897455">(</span><span class="op" id="6897456">)</span><span class="op" id="6897457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6897460">if</span>&nbsp;<span class="ident" id="6897463">err</span>&nbsp;<span class="op" id="6897467">!=</span>&nbsp;<span class="builtintype" id="6897470">nil</span>&nbsp;<span class="op" id="6897474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6897478">t</span><span class="op" id="6897479">.</span><span class="ident" id="6897480">Fatal</span><span class="op" id="6897485">(</span><span class="ident" id="6897486">err</span><span class="op" id="6897489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6897492">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6897495">if</span>&nbsp;<span class="ident" id="6897498">g</span><span class="op" id="6897499">,</span>&nbsp;<span class="ident" id="6897501">w</span>&nbsp;<span class="op" id="6897503">:=</span>&nbsp;<span class="builtintype" id="6897506">string</span><span class="op" id="6897512">(</span><span class="ident" id="6897513">rest</span><span class="op" id="6897517">)</span><span class="op" id="6897518">,</span>&nbsp;<span class="string" id="6897520">&#34;&nbsp;extra&nbsp;&#34;</span><span class="op" id="6897529">;</span>&nbsp;<span class="ident" id="6897531">g</span>&nbsp;<span class="op" id="6897533">!=</span>&nbsp;<span class="ident" id="6897536">w</span>&nbsp;<span class="op" id="6897538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6897542">t</span><span class="op" id="6897543">.</span><span class="ident" id="6897544">Errorf</span><span class="op" id="6897550">(</span><span class="string" id="6897551">&#34;Remaining&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6897576">,</span>&nbsp;<span class="ident" id="6897578">g</span><span class="op" id="6897579">,</span>&nbsp;<span class="ident" id="6897581">w</span><span class="op" id="6897582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6897585">}</span><br>
<span class="lineno"></span><span class="op" id="6897587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="6897590">func</span>&nbsp;<span class="ident" id="6897595">nlines</span><span class="op" id="6897601">(</span><span class="ident" id="6897602">s</span>&nbsp;<span class="builtintype" id="6897604">string</span><span class="op" id="6897610">,</span>&nbsp;<span class="ident" id="6897612">n</span>&nbsp;<span class="builtintype" id="6897614">int</span><span class="op" id="6897617">)</span>&nbsp;<span class="builtintype" id="6897619">string</span>&nbsp;<span class="op" id="6897626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6897629">if</span>&nbsp;<span class="ident" id="6897632">n</span>&nbsp;<span class="op" id="6897634">&lt;=</span>&nbsp;<span class="num" id="6897637">0</span>&nbsp;<span class="op" id="6897639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6897643">return</span>&nbsp;<span class="string" id="6897650">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6897654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6897657">for</span>&nbsp;<span class="ident" id="6897661">i</span><span class="op" id="6897662">,</span>&nbsp;<span class="ident" id="6897664">c</span>&nbsp;<span class="op" id="6897666">:=</span>&nbsp;<span class="keyword" id="6897669">range</span>&nbsp;<span class="ident" id="6897675">s</span>&nbsp;<span class="op" id="6897677">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6897681">if</span>&nbsp;<span class="ident" id="6897684">c</span>&nbsp;<span class="op" id="6897686">==</span>&nbsp;<span class="string" id="6897689">&#39;\n&#39;</span>&nbsp;<span class="op" id="6897694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6897699">if</span>&nbsp;<span class="ident" id="6897702">n</span><span class="op" id="6897703">--</span><span class="op" id="6897705">;</span>&nbsp;<span class="ident" id="6897707">n</span>&nbsp;<span class="op" id="6897709">==</span>&nbsp;<span class="num" id="6897712">0</span>&nbsp;<span class="op" id="6897714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6897720">return</span>&nbsp;<span class="ident" id="6897727">s</span><span class="op" id="6897728">[</span><span class="num" id="6897729">0</span>&nbsp;<span class="op" id="6897731">:</span>&nbsp;<span class="ident" id="6897733">i</span><span class="op" id="6897734">+</span><span class="num" id="6897735">1</span><span class="op" id="6897736">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6897741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6897745">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6897748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6897751">return</span>&nbsp;<span class="ident" id="6897758">s</span><br>
<span class="lineno"></span><span class="op" id="6897760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6897763">func</span>&nbsp;<span class="ident" id="6897768">TestRawMessage</span><span class="op" id="6897782">(</span><span class="ident" id="6897783">t</span>&nbsp;<span class="op" id="6897785">*</span><span class="ident" id="6897786">testing</span><span class="op" id="6897793">.</span><span class="ident" id="6897794">T</span><span class="op" id="6897795">)</span>&nbsp;<span class="op" id="6897797">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6897800">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6897852">var</span>&nbsp;<span class="ident" id="6897856">data</span>&nbsp;<span class="keyword" id="6897861">struct</span>&nbsp;<span class="op" id="6897868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6897872">X</span>&nbsp;&nbsp;<span class="builtintype" id="6897875">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6897885">Id</span>&nbsp;<span class="op" id="6897888">*</span><span class="ident" id="6897889">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6897902">Y</span>&nbsp;&nbsp;<span class="builtintype" id="6897905">float32</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6897914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6897917">const</span>&nbsp;<span class="ident" id="6897923">raw</span>&nbsp;<span class="op" id="6897927">=</span>&nbsp;<span class="string" id="6897929">`[&#34;\u0056&#34;,null]`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6897948">const</span>&nbsp;<span class="ident" id="6897954">msg</span>&nbsp;<span class="op" id="6897958">=</span>&nbsp;<span class="string" id="6897960">`{&#34;X&#34;:0.1,&#34;Id&#34;:[&#34;\u0056&#34;,null],&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6898002">err</span>&nbsp;<span class="op" id="6898006">:=</span>&nbsp;<span class="ident" id="6898009">Unmarshal</span><span class="op" id="6898018">(</span><span class="op" id="6898019">[</span><span class="op" id="6898020">]</span><span class="builtintype" id="6898021">byte</span><span class="op" id="6898025">(</span><span class="ident" id="6898026">msg</span><span class="op" id="6898029">)</span><span class="op" id="6898030">,</span>&nbsp;<span class="op" id="6898032">&amp;</span><span class="ident" id="6898033">data</span><span class="op" id="6898037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6898040">if</span>&nbsp;<span class="ident" id="6898043">err</span>&nbsp;<span class="op" id="6898047">!=</span>&nbsp;<span class="builtintype" id="6898050">nil</span>&nbsp;<span class="op" id="6898054">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6898058">t</span><span class="op" id="6898059">.</span><span class="ident" id="6898060">Fatalf</span><span class="op" id="6898066">(</span><span class="string" id="6898067">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="6898082">,</span>&nbsp;<span class="ident" id="6898084">err</span><span class="op" id="6898087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6898090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6898093">if</span>&nbsp;<span class="builtintype" id="6898096">string</span><span class="op" id="6898102">(</span><span class="op" id="6898103">[</span><span class="op" id="6898104">]</span><span class="builtintype" id="6898105">byte</span><span class="op" id="6898109">(</span><span class="op" id="6898110">*</span><span class="ident" id="6898111">data</span><span class="op" id="6898115">.</span><span class="ident" id="6898116">Id</span><span class="op" id="6898118">)</span><span class="op" id="6898119">)</span>&nbsp;<span class="op" id="6898121">!=</span>&nbsp;<span class="ident" id="6898124">raw</span>&nbsp;<span class="op" id="6898128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6898132">t</span><span class="op" id="6898133">.</span><span class="ident" id="6898134">Fatalf</span><span class="op" id="6898140">(</span><span class="string" id="6898141">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="6898174">,</span>&nbsp;<span class="op" id="6898176">[</span><span class="op" id="6898177">]</span><span class="builtintype" id="6898178">byte</span><span class="op" id="6898182">(</span><span class="op" id="6898183">*</span><span class="ident" id="6898184">data</span><span class="op" id="6898188">.</span><span class="ident" id="6898189">Id</span><span class="op" id="6898191">)</span><span class="op" id="6898192">,</span>&nbsp;<span class="ident" id="6898194">raw</span><span class="op" id="6898197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6898200">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6898203">b</span><span class="op" id="6898204">,</span>&nbsp;<span class="ident" id="6898206">err</span>&nbsp;<span class="op" id="6898210">:=</span>&nbsp;<span class="ident" id="6898213">Marshal</span><span class="op" id="6898220">(</span><span class="op" id="6898221">&amp;</span><span class="ident" id="6898222">data</span><span class="op" id="6898226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6898229">if</span>&nbsp;<span class="ident" id="6898232">err</span>&nbsp;<span class="op" id="6898236">!=</span>&nbsp;<span class="builtintype" id="6898239">nil</span>&nbsp;<span class="op" id="6898243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6898247">t</span><span class="op" id="6898248">.</span><span class="ident" id="6898249">Fatalf</span><span class="op" id="6898255">(</span><span class="string" id="6898256">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="6898269">,</span>&nbsp;<span class="ident" id="6898271">err</span><span class="op" id="6898274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6898277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6898280">if</span>&nbsp;<span class="builtintype" id="6898283">string</span><span class="op" id="6898289">(</span><span class="ident" id="6898290">b</span><span class="op" id="6898291">)</span>&nbsp;<span class="op" id="6898293">!=</span>&nbsp;<span class="ident" id="6898296">msg</span>&nbsp;<span class="op" id="6898300">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6898304">t</span><span class="op" id="6898305">.</span><span class="ident" id="6898306">Fatalf</span><span class="op" id="6898312">(</span><span class="string" id="6898313">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="6898341">,</span>&nbsp;<span class="ident" id="6898343">b</span><span class="op" id="6898344">,</span>&nbsp;<span class="ident" id="6898346">msg</span><span class="op" id="6898349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6898352">}</span><br>
<span class="lineno"></span><span class="op" id="6898354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6898357">func</span>&nbsp;<span class="ident" id="6898362">TestNullRawMessage</span><span class="op" id="6898380">(</span><span class="ident" id="6898381">t</span>&nbsp;<span class="op" id="6898383">*</span><span class="ident" id="6898384">testing</span><span class="op" id="6898391">.</span><span class="ident" id="6898392">T</span><span class="op" id="6898393">)</span>&nbsp;<span class="op" id="6898395">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6898398">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6898450">var</span>&nbsp;<span class="ident" id="6898454">data</span>&nbsp;<span class="keyword" id="6898459">struct</span>&nbsp;<span class="op" id="6898466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6898470">X</span>&nbsp;&nbsp;<span class="builtintype" id="6898473">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6898483">Id</span>&nbsp;<span class="op" id="6898486">*</span><span class="ident" id="6898487">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6898500">Y</span>&nbsp;&nbsp;<span class="builtintype" id="6898503">float32</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6898512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6898515">data</span><span class="op" id="6898519">.</span><span class="ident" id="6898520">Id</span>&nbsp;<span class="op" id="6898523">=</span>&nbsp;<span class="builtinfunc" id="6898525">new</span><span class="op" id="6898528">(</span><span class="ident" id="6898529">RawMessage</span><span class="op" id="6898539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6898542">const</span>&nbsp;<span class="ident" id="6898548">msg</span>&nbsp;<span class="op" id="6898552">=</span>&nbsp;<span class="string" id="6898554">`{&#34;X&#34;:0.1,&#34;Id&#34;:null,&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6898585">err</span>&nbsp;<span class="op" id="6898589">:=</span>&nbsp;<span class="ident" id="6898592">Unmarshal</span><span class="op" id="6898601">(</span><span class="op" id="6898602">[</span><span class="op" id="6898603">]</span><span class="builtintype" id="6898604">byte</span><span class="op" id="6898608">(</span><span class="ident" id="6898609">msg</span><span class="op" id="6898612">)</span><span class="op" id="6898613">,</span>&nbsp;<span class="op" id="6898615">&amp;</span><span class="ident" id="6898616">data</span><span class="op" id="6898620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6898623">if</span>&nbsp;<span class="ident" id="6898626">err</span>&nbsp;<span class="op" id="6898630">!=</span>&nbsp;<span class="builtintype" id="6898633">nil</span>&nbsp;<span class="op" id="6898637">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6898641">t</span><span class="op" id="6898642">.</span><span class="ident" id="6898643">Fatalf</span><span class="op" id="6898649">(</span><span class="string" id="6898650">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="6898665">,</span>&nbsp;<span class="ident" id="6898667">err</span><span class="op" id="6898670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6898673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6898676">if</span>&nbsp;<span class="ident" id="6898679">data</span><span class="op" id="6898683">.</span><span class="ident" id="6898684">Id</span>&nbsp;<span class="op" id="6898687">!=</span>&nbsp;<span class="builtintype" id="6898690">nil</span>&nbsp;<span class="op" id="6898694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6898698">t</span><span class="op" id="6898699">.</span><span class="ident" id="6898700">Fatalf</span><span class="op" id="6898706">(</span><span class="string" id="6898707">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;non-nil,&nbsp;want&nbsp;nil&#34;</span><span class="op" id="6898745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6898748">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6898751">b</span><span class="op" id="6898752">,</span>&nbsp;<span class="ident" id="6898754">err</span>&nbsp;<span class="op" id="6898758">:=</span>&nbsp;<span class="ident" id="6898761">Marshal</span><span class="op" id="6898768">(</span><span class="op" id="6898769">&amp;</span><span class="ident" id="6898770">data</span><span class="op" id="6898774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6898777">if</span>&nbsp;<span class="ident" id="6898780">err</span>&nbsp;<span class="op" id="6898784">!=</span>&nbsp;<span class="builtintype" id="6898787">nil</span>&nbsp;<span class="op" id="6898791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6898795">t</span><span class="op" id="6898796">.</span><span class="ident" id="6898797">Fatalf</span><span class="op" id="6898803">(</span><span class="string" id="6898804">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="6898817">,</span>&nbsp;<span class="ident" id="6898819">err</span><span class="op" id="6898822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6898825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6898828">if</span>&nbsp;<span class="builtintype" id="6898831">string</span><span class="op" id="6898837">(</span><span class="ident" id="6898838">b</span><span class="op" id="6898839">)</span>&nbsp;<span class="op" id="6898841">!=</span>&nbsp;<span class="ident" id="6898844">msg</span>&nbsp;<span class="op" id="6898848">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6898852">t</span><span class="op" id="6898853">.</span><span class="ident" id="6898854">Fatalf</span><span class="op" id="6898860">(</span><span class="string" id="6898861">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="6898889">,</span>&nbsp;<span class="ident" id="6898891">b</span><span class="op" id="6898892">,</span>&nbsp;<span class="ident" id="6898894">msg</span><span class="op" id="6898897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6898900">}</span><br>
<span class="lineno"></span><span class="op" id="6898902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6898905">var</span>&nbsp;<span class="ident" id="6898909">blockingTests</span>&nbsp;<span class="op" id="6898923">=</span>&nbsp;<span class="op" id="6898925">[</span><span class="op" id="6898926">]</span><span class="builtintype" id="6898927">string</span><span class="op" id="6898933">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6898936">`{&#34;x&#34;:&nbsp;1}`</span><span class="op" id="6898946">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6898949">`[1,&nbsp;2,&nbsp;3]`</span><span class="op" id="6898960">,</span><br>
<span class="lineno"></span><span class="op" id="6898962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6898965">func</span>&nbsp;<span class="ident" id="6898970">TestBlocking</span><span class="op" id="6898982">(</span><span class="ident" id="6898983">t</span>&nbsp;<span class="op" id="6898985">*</span><span class="ident" id="6898986">testing</span><span class="op" id="6898993">.</span><span class="ident" id="6898994">T</span><span class="op" id="6898995">)</span>&nbsp;<span class="op" id="6898997">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6899000">for</span>&nbsp;<span class="ident" id="6899004">_</span><span class="op" id="6899005">,</span>&nbsp;<span class="ident" id="6899007">enc</span>&nbsp;<span class="op" id="6899011">:=</span>&nbsp;<span class="keyword" id="6899014">range</span>&nbsp;<span class="ident" id="6899020">blockingTests</span>&nbsp;<span class="op" id="6899034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6899038">r</span><span class="op" id="6899039">,</span>&nbsp;<span class="ident" id="6899041">w</span>&nbsp;<span class="op" id="6899043">:=</span>&nbsp;<span class="ident" id="6899046">net</span><span class="op" id="6899049">.</span><span class="ident" id="6899050">Pipe</span><span class="op" id="6899054">(</span><span class="op" id="6899055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6899059">go</span>&nbsp;<span class="ident" id="6899062">w</span><span class="op" id="6899063">.</span><span class="ident" id="6899064">Write</span><span class="op" id="6899069">(</span><span class="op" id="6899070">[</span><span class="op" id="6899071">]</span><span class="builtintype" id="6899072">byte</span><span class="op" id="6899076">(</span><span class="ident" id="6899077">enc</span><span class="op" id="6899080">)</span><span class="op" id="6899081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6899085">var</span>&nbsp;<span class="ident" id="6899089">val</span>&nbsp;<span class="keyword" id="6899093">interface</span><span class="op" id="6899102">{</span><span class="op" id="6899103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6899108">//&nbsp;If&nbsp;Decode&nbsp;reads&nbsp;beyond&nbsp;what&nbsp;w.Write&nbsp;writes&nbsp;above,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6899163">//&nbsp;it&nbsp;will&nbsp;block,&nbsp;and&nbsp;the&nbsp;test&nbsp;will&nbsp;deadlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6899211">if</span>&nbsp;<span class="ident" id="6899214">err</span>&nbsp;<span class="op" id="6899218">:=</span>&nbsp;<span class="ident" id="6899221">NewDecoder</span><span class="op" id="6899231">(</span><span class="ident" id="6899232">r</span><span class="op" id="6899233">)</span><span class="op" id="6899234">.</span><span class="ident" id="6899235">Decode</span><span class="op" id="6899241">(</span><span class="op" id="6899242">&amp;</span><span class="ident" id="6899243">val</span><span class="op" id="6899246">)</span><span class="op" id="6899247">;</span>&nbsp;<span class="ident" id="6899249">err</span>&nbsp;<span class="op" id="6899253">!=</span>&nbsp;<span class="builtintype" id="6899256">nil</span>&nbsp;<span class="op" id="6899260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6899265">t</span><span class="op" id="6899266">.</span><span class="ident" id="6899267">Errorf</span><span class="op" id="6899273">(</span><span class="string" id="6899274">&#34;decoding&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="6899291">,</span>&nbsp;<span class="ident" id="6899293">enc</span><span class="op" id="6899296">,</span>&nbsp;<span class="ident" id="6899298">err</span><span class="op" id="6899301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6899305">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6899309">r</span><span class="op" id="6899310">.</span><span class="ident" id="6899311">Close</span><span class="op" id="6899316">(</span><span class="op" id="6899317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6899321">w</span><span class="op" id="6899322">.</span><span class="ident" id="6899323">Close</span><span class="op" id="6899328">(</span><span class="op" id="6899329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6899332">}</span><br>
<span class="lineno"></span><span class="op" id="6899334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="6899337">func</span>&nbsp;<span class="ident" id="6899342">BenchmarkEncoderEncode</span><span class="op" id="6899364">(</span><span class="ident" id="6899365">b</span>&nbsp;<span class="op" id="6899367">*</span><span class="ident" id="6899368">testing</span><span class="op" id="6899375">.</span><span class="ident" id="6899376">B</span><span class="op" id="6899377">)</span>&nbsp;<span class="op" id="6899379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6899382">b</span><span class="op" id="6899383">.</span><span class="ident" id="6899384">ReportAllocs</span><span class="op" id="6899396">(</span><span class="op" id="6899397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6899400">type</span>&nbsp;<span class="ident" id="6899405">T</span>&nbsp;<span class="keyword" id="6899407">struct</span>&nbsp;<span class="op" id="6899414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6899418">X</span><span class="op" id="6899419">,</span>&nbsp;<span class="ident" id="6899421">Y</span>&nbsp;<span class="builtintype" id="6899423">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6899431">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6899434">v</span>&nbsp;<span class="op" id="6899436">:=</span>&nbsp;<span class="op" id="6899439">&amp;</span><span class="ident" id="6899440">T</span><span class="op" id="6899441">{</span><span class="string" id="6899442">&#34;foo&#34;</span><span class="op" id="6899447">,</span>&nbsp;<span class="string" id="6899449">&#34;bar&#34;</span><span class="op" id="6899454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6899457">for</span>&nbsp;<span class="ident" id="6899461">i</span>&nbsp;<span class="op" id="6899463">:=</span>&nbsp;<span class="num" id="6899466">0</span><span class="op" id="6899467">;</span>&nbsp;<span class="ident" id="6899469">i</span>&nbsp;<span class="op" id="6899471">&lt;</span>&nbsp;<span class="ident" id="6899473">b</span><span class="op" id="6899474">.</span><span class="ident" id="6899475">N</span><span class="op" id="6899476">;</span>&nbsp;<span class="ident" id="6899478">i</span><span class="op" id="6899479">++</span>&nbsp;<span class="op" id="6899482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6899486">if</span>&nbsp;<span class="ident" id="6899489">err</span>&nbsp;<span class="op" id="6899493">:=</span>&nbsp;<span class="ident" id="6899496">NewEncoder</span><span class="op" id="6899506">(</span><span class="ident" id="6899507">ioutil</span><span class="op" id="6899513">.</span><span class="ident" id="6899514">Discard</span><span class="op" id="6899521">)</span><span class="op" id="6899522">.</span><span class="ident" id="6899523">Encode</span><span class="op" id="6899529">(</span><span class="ident" id="6899530">v</span><span class="op" id="6899531">)</span><span class="op" id="6899532">;</span>&nbsp;<span class="ident" id="6899534">err</span>&nbsp;<span class="op" id="6899538">!=</span>&nbsp;<span class="builtintype" id="6899541">nil</span>&nbsp;<span class="op" id="6899545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6899550">b</span><span class="op" id="6899551">.</span><span class="ident" id="6899552">Fatal</span><span class="op" id="6899557">(</span><span class="ident" id="6899558">err</span><span class="op" id="6899561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6899565">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6899568">}</span><br>
<span class="lineno"></span><span class="op" id="6899570">}</span>
</div>
</body>
</html>
