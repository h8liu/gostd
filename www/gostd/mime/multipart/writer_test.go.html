<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>mime/multipart</h2>
<ul>
<li><a href="/gostd/mime/multipart/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/mime/multipart/formdata.go.html">formdata.go</a></li>
<li><a href="/gostd/mime/multipart/formdata_test.go.html">formdata_test.go</a></li>
<li><a href="/gostd/mime/multipart/multipart.go.html">multipart.go</a></li>
<li><a href="/gostd/mime/multipart/multipart_test.go.html">multipart_test.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable.go.html">quotedprintable.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable_test.go.html">quotedprintable_test.go</a></li>
<li><a href="/gostd/mime/multipart/writer.go.html">writer.go</a></li>
<li><a href="/gostd/mime/multipart/writer_test.go.html" class="current">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8415339">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8415394">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8415448">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8415499">package</span>&nbsp;<span class="ident" id="8415507">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8415518">import</span>&nbsp;<span class="op" id="8415525">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8415528">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8415537">&#34;io/ioutil&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8415550">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8415561">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="8415571">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8415574">func</span>&nbsp;<span class="ident" id="8415579">TestWriter</span><span class="op" id="8415589">(</span><span class="ident" id="8415590">t</span>&nbsp;<span class="op" id="8415592">*</span><span class="ident" id="8415593">testing</span><span class="op" id="8415600">.</span><span class="ident" id="8415601">T</span><span class="op" id="8415602">)</span>&nbsp;<span class="op" id="8415604">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415607">fileContents</span>&nbsp;<span class="op" id="8415620">:=</span>&nbsp;<span class="op" id="8415623">[</span><span class="op" id="8415624">]</span><span class="builtintype" id="8415625">byte</span><span class="op" id="8415629">(</span><span class="string" id="8415630">&#34;my&nbsp;file&nbsp;contents&#34;</span><span class="op" id="8415648">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8415652">var</span>&nbsp;<span class="ident" id="8415656">b</span>&nbsp;<span class="ident" id="8415658">bytes</span><span class="op" id="8415663">.</span><span class="ident" id="8415664">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415672">w</span>&nbsp;<span class="op" id="8415674">:=</span>&nbsp;<span class="ident" id="8415677">NewWriter</span><span class="op" id="8415686">(</span><span class="op" id="8415687">&amp;</span><span class="ident" id="8415688">b</span><span class="op" id="8415689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8415692">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415696">part</span><span class="op" id="8415700">,</span>&nbsp;<span class="ident" id="8415702">err</span>&nbsp;<span class="op" id="8415706">:=</span>&nbsp;<span class="ident" id="8415709">w</span><span class="op" id="8415710">.</span><span class="ident" id="8415711">CreateFormFile</span><span class="op" id="8415725">(</span><span class="string" id="8415726">&#34;myfile&#34;</span><span class="op" id="8415734">,</span>&nbsp;<span class="string" id="8415736">&#34;my-file.txt&#34;</span><span class="op" id="8415749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8415753">if</span>&nbsp;<span class="ident" id="8415756">err</span>&nbsp;<span class="op" id="8415760">!=</span>&nbsp;<span class="ident" id="8415763">nil</span>&nbsp;<span class="op" id="8415767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415772">t</span><span class="op" id="8415773">.</span><span class="ident" id="8415774">Fatalf</span><span class="op" id="8415780">(</span><span class="string" id="8415781">&#34;CreateFormFile:&nbsp;%v&#34;</span><span class="op" id="8415801">,</span>&nbsp;<span class="ident" id="8415803">err</span><span class="op" id="8415806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8415810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415814">part</span><span class="op" id="8415818">.</span><span class="ident" id="8415819">Write</span><span class="op" id="8415824">(</span><span class="ident" id="8415825">fileContents</span><span class="op" id="8415837">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415841">err</span>&nbsp;<span class="op" id="8415845">=</span>&nbsp;<span class="ident" id="8415847">w</span><span class="op" id="8415848">.</span><span class="ident" id="8415849">WriteField</span><span class="op" id="8415859">(</span><span class="string" id="8415860">&#34;key&#34;</span><span class="op" id="8415865">,</span>&nbsp;<span class="string" id="8415867">&#34;val&#34;</span><span class="op" id="8415872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8415876">if</span>&nbsp;<span class="ident" id="8415879">err</span>&nbsp;<span class="op" id="8415883">!=</span>&nbsp;<span class="ident" id="8415886">nil</span>&nbsp;<span class="op" id="8415890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415895">t</span><span class="op" id="8415896">.</span><span class="ident" id="8415897">Fatalf</span><span class="op" id="8415903">(</span><span class="string" id="8415904">&#34;WriteField:&nbsp;%v&#34;</span><span class="op" id="8415920">,</span>&nbsp;<span class="ident" id="8415922">err</span><span class="op" id="8415925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8415929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415933">part</span><span class="op" id="8415937">.</span><span class="ident" id="8415938">Write</span><span class="op" id="8415943">(</span><span class="op" id="8415944">[</span><span class="op" id="8415945">]</span><span class="builtintype" id="8415946">byte</span><span class="op" id="8415950">(</span><span class="string" id="8415951">&#34;val&#34;</span><span class="op" id="8415956">)</span><span class="op" id="8415957">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415961">err</span>&nbsp;<span class="op" id="8415965">=</span>&nbsp;<span class="ident" id="8415967">w</span><span class="op" id="8415968">.</span><span class="ident" id="8415969">Close</span><span class="op" id="8415974">(</span><span class="op" id="8415975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8415979">if</span>&nbsp;<span class="ident" id="8415982">err</span>&nbsp;<span class="op" id="8415986">!=</span>&nbsp;<span class="ident" id="8415989">nil</span>&nbsp;<span class="op" id="8415993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415998">t</span><span class="op" id="8415999">.</span><span class="ident" id="8416000">Fatalf</span><span class="op" id="8416006">(</span><span class="string" id="8416007">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="8416018">,</span>&nbsp;<span class="ident" id="8416020">err</span><span class="op" id="8416023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416031">s</span>&nbsp;<span class="op" id="8416033">:=</span>&nbsp;<span class="ident" id="8416036">b</span><span class="op" id="8416037">.</span><span class="ident" id="8416038">String</span><span class="op" id="8416044">(</span><span class="op" id="8416045">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416049">if</span>&nbsp;<span class="builtinfunc" id="8416052">len</span><span class="op" id="8416055">(</span><span class="ident" id="8416056">s</span><span class="op" id="8416057">)</span>&nbsp;<span class="op" id="8416059">==</span>&nbsp;<span class="num" id="8416062">0</span>&nbsp;<span class="op" id="8416064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416069">t</span><span class="op" id="8416070">.</span><span class="ident" id="8416071">Fatal</span><span class="op" id="8416076">(</span><span class="string" id="8416077">&#34;String:&nbsp;unexpected&nbsp;empty&nbsp;result&#34;</span><span class="op" id="8416110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416118">if</span>&nbsp;<span class="ident" id="8416121">s</span><span class="op" id="8416122">[</span><span class="num" id="8416123">0</span><span class="op" id="8416124">]</span>&nbsp;<span class="op" id="8416126">==</span>&nbsp;<span class="string" id="8416129">&#39;\r&#39;</span>&nbsp;<span class="op" id="8416134">||</span>&nbsp;<span class="ident" id="8416137">s</span><span class="op" id="8416138">[</span><span class="num" id="8416139">0</span><span class="op" id="8416140">]</span>&nbsp;<span class="op" id="8416142">==</span>&nbsp;<span class="string" id="8416145">&#39;\n&#39;</span>&nbsp;<span class="op" id="8416150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416155">t</span><span class="op" id="8416156">.</span><span class="ident" id="8416157">Fatal</span><span class="op" id="8416162">(</span><span class="string" id="8416163">&#34;String:&nbsp;unexpected&nbsp;newline&#34;</span><span class="op" id="8416191">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416202">r</span>&nbsp;<span class="op" id="8416204">:=</span>&nbsp;<span class="ident" id="8416207">NewReader</span><span class="op" id="8416216">(</span><span class="op" id="8416217">&amp;</span><span class="ident" id="8416218">b</span><span class="op" id="8416219">,</span>&nbsp;<span class="ident" id="8416221">w</span><span class="op" id="8416222">.</span><span class="ident" id="8416223">Boundary</span><span class="op" id="8416231">(</span><span class="op" id="8416232">)</span><span class="op" id="8416233">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416237">part</span><span class="op" id="8416241">,</span>&nbsp;<span class="ident" id="8416243">err</span>&nbsp;<span class="op" id="8416247">:=</span>&nbsp;<span class="ident" id="8416250">r</span><span class="op" id="8416251">.</span><span class="ident" id="8416252">NextPart</span><span class="op" id="8416260">(</span><span class="op" id="8416261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416264">if</span>&nbsp;<span class="ident" id="8416267">err</span>&nbsp;<span class="op" id="8416271">!=</span>&nbsp;<span class="ident" id="8416274">nil</span>&nbsp;<span class="op" id="8416278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416282">t</span><span class="op" id="8416283">.</span><span class="ident" id="8416284">Fatalf</span><span class="op" id="8416290">(</span><span class="string" id="8416291">&#34;part&nbsp;1:&nbsp;%v&#34;</span><span class="op" id="8416303">,</span>&nbsp;<span class="ident" id="8416305">err</span><span class="op" id="8416308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416314">if</span>&nbsp;<span class="ident" id="8416317">g</span><span class="op" id="8416318">,</span>&nbsp;<span class="ident" id="8416320">e</span>&nbsp;<span class="op" id="8416322">:=</span>&nbsp;<span class="ident" id="8416325">part</span><span class="op" id="8416329">.</span><span class="ident" id="8416330">FormName</span><span class="op" id="8416338">(</span><span class="op" id="8416339">)</span><span class="op" id="8416340">,</span>&nbsp;<span class="string" id="8416342">&#34;myfile&#34;</span><span class="op" id="8416350">;</span>&nbsp;<span class="ident" id="8416352">g</span>&nbsp;<span class="op" id="8416354">!=</span>&nbsp;<span class="ident" id="8416357">e</span>&nbsp;<span class="op" id="8416359">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416363">t</span><span class="op" id="8416364">.</span><span class="ident" id="8416365">Errorf</span><span class="op" id="8416371">(</span><span class="string" id="8416372">&#34;part&nbsp;1:&nbsp;want&nbsp;form&nbsp;name&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8416407">,</span>&nbsp;<span class="ident" id="8416409">e</span><span class="op" id="8416410">,</span>&nbsp;<span class="ident" id="8416412">g</span><span class="op" id="8416413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416419">slurp</span><span class="op" id="8416424">,</span>&nbsp;<span class="ident" id="8416426">err</span>&nbsp;<span class="op" id="8416430">:=</span>&nbsp;<span class="ident" id="8416433">ioutil</span><span class="op" id="8416439">.</span><span class="ident" id="8416440">ReadAll</span><span class="op" id="8416447">(</span><span class="ident" id="8416448">part</span><span class="op" id="8416452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416455">if</span>&nbsp;<span class="ident" id="8416458">err</span>&nbsp;<span class="op" id="8416462">!=</span>&nbsp;<span class="ident" id="8416465">nil</span>&nbsp;<span class="op" id="8416469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416473">t</span><span class="op" id="8416474">.</span><span class="ident" id="8416475">Fatalf</span><span class="op" id="8416481">(</span><span class="string" id="8416482">&#34;part&nbsp;1:&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="8416503">,</span>&nbsp;<span class="ident" id="8416505">err</span><span class="op" id="8416508">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416514">if</span>&nbsp;<span class="ident" id="8416517">e</span><span class="op" id="8416518">,</span>&nbsp;<span class="ident" id="8416520">g</span>&nbsp;<span class="op" id="8416522">:=</span>&nbsp;<span class="builtintype" id="8416525">string</span><span class="op" id="8416531">(</span><span class="ident" id="8416532">fileContents</span><span class="op" id="8416544">)</span><span class="op" id="8416545">,</span>&nbsp;<span class="builtintype" id="8416547">string</span><span class="op" id="8416553">(</span><span class="ident" id="8416554">slurp</span><span class="op" id="8416559">)</span><span class="op" id="8416560">;</span>&nbsp;<span class="ident" id="8416562">e</span>&nbsp;<span class="op" id="8416564">!=</span>&nbsp;<span class="ident" id="8416567">g</span>&nbsp;<span class="op" id="8416569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416573">t</span><span class="op" id="8416574">.</span><span class="ident" id="8416575">Errorf</span><span class="op" id="8416581">(</span><span class="string" id="8416582">&#34;part&nbsp;1:&nbsp;want&nbsp;contents&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8416616">,</span>&nbsp;<span class="ident" id="8416618">e</span><span class="op" id="8416619">,</span>&nbsp;<span class="ident" id="8416621">g</span><span class="op" id="8416622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416629">part</span><span class="op" id="8416633">,</span>&nbsp;<span class="ident" id="8416635">err</span>&nbsp;<span class="op" id="8416639">=</span>&nbsp;<span class="ident" id="8416641">r</span><span class="op" id="8416642">.</span><span class="ident" id="8416643">NextPart</span><span class="op" id="8416651">(</span><span class="op" id="8416652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416655">if</span>&nbsp;<span class="ident" id="8416658">err</span>&nbsp;<span class="op" id="8416662">!=</span>&nbsp;<span class="ident" id="8416665">nil</span>&nbsp;<span class="op" id="8416669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416673">t</span><span class="op" id="8416674">.</span><span class="ident" id="8416675">Fatalf</span><span class="op" id="8416681">(</span><span class="string" id="8416682">&#34;part&nbsp;2:&nbsp;%v&#34;</span><span class="op" id="8416694">,</span>&nbsp;<span class="ident" id="8416696">err</span><span class="op" id="8416699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416705">if</span>&nbsp;<span class="ident" id="8416708">g</span><span class="op" id="8416709">,</span>&nbsp;<span class="ident" id="8416711">e</span>&nbsp;<span class="op" id="8416713">:=</span>&nbsp;<span class="ident" id="8416716">part</span><span class="op" id="8416720">.</span><span class="ident" id="8416721">FormName</span><span class="op" id="8416729">(</span><span class="op" id="8416730">)</span><span class="op" id="8416731">,</span>&nbsp;<span class="string" id="8416733">&#34;key&#34;</span><span class="op" id="8416738">;</span>&nbsp;<span class="ident" id="8416740">g</span>&nbsp;<span class="op" id="8416742">!=</span>&nbsp;<span class="ident" id="8416745">e</span>&nbsp;<span class="op" id="8416747">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416751">t</span><span class="op" id="8416752">.</span><span class="ident" id="8416753">Errorf</span><span class="op" id="8416759">(</span><span class="string" id="8416760">&#34;part&nbsp;2:&nbsp;want&nbsp;form&nbsp;name&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8416795">,</span>&nbsp;<span class="ident" id="8416797">e</span><span class="op" id="8416798">,</span>&nbsp;<span class="ident" id="8416800">g</span><span class="op" id="8416801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416807">slurp</span><span class="op" id="8416812">,</span>&nbsp;<span class="ident" id="8416814">err</span>&nbsp;<span class="op" id="8416818">=</span>&nbsp;<span class="ident" id="8416820">ioutil</span><span class="op" id="8416826">.</span><span class="ident" id="8416827">ReadAll</span><span class="op" id="8416834">(</span><span class="ident" id="8416835">part</span><span class="op" id="8416839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416842">if</span>&nbsp;<span class="ident" id="8416845">err</span>&nbsp;<span class="op" id="8416849">!=</span>&nbsp;<span class="ident" id="8416852">nil</span>&nbsp;<span class="op" id="8416856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416860">t</span><span class="op" id="8416861">.</span><span class="ident" id="8416862">Fatalf</span><span class="op" id="8416868">(</span><span class="string" id="8416869">&#34;part&nbsp;2:&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="8416890">,</span>&nbsp;<span class="ident" id="8416892">err</span><span class="op" id="8416895">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416901">if</span>&nbsp;<span class="ident" id="8416904">e</span><span class="op" id="8416905">,</span>&nbsp;<span class="ident" id="8416907">g</span>&nbsp;<span class="op" id="8416909">:=</span>&nbsp;<span class="string" id="8416912">&#34;val&#34;</span><span class="op" id="8416917">,</span>&nbsp;<span class="builtintype" id="8416919">string</span><span class="op" id="8416925">(</span><span class="ident" id="8416926">slurp</span><span class="op" id="8416931">)</span><span class="op" id="8416932">;</span>&nbsp;<span class="ident" id="8416934">e</span>&nbsp;<span class="op" id="8416936">!=</span>&nbsp;<span class="ident" id="8416939">g</span>&nbsp;<span class="op" id="8416941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416945">t</span><span class="op" id="8416946">.</span><span class="ident" id="8416947">Errorf</span><span class="op" id="8416953">(</span><span class="string" id="8416954">&#34;part&nbsp;2:&nbsp;want&nbsp;contents&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8416988">,</span>&nbsp;<span class="ident" id="8416990">e</span><span class="op" id="8416991">,</span>&nbsp;<span class="ident" id="8416993">g</span><span class="op" id="8416994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417001">part</span><span class="op" id="8417005">,</span>&nbsp;<span class="ident" id="8417007">err</span>&nbsp;<span class="op" id="8417011">=</span>&nbsp;<span class="ident" id="8417013">r</span><span class="op" id="8417014">.</span><span class="ident" id="8417015">NextPart</span><span class="op" id="8417023">(</span><span class="op" id="8417024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417027">if</span>&nbsp;<span class="ident" id="8417030">part</span>&nbsp;<span class="op" id="8417035">!=</span>&nbsp;<span class="ident" id="8417038">nil</span>&nbsp;<span class="op" id="8417042">||</span>&nbsp;<span class="ident" id="8417045">err</span>&nbsp;<span class="op" id="8417049">==</span>&nbsp;<span class="ident" id="8417052">nil</span>&nbsp;<span class="op" id="8417056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417060">t</span><span class="op" id="8417061">.</span><span class="ident" id="8417062">Fatalf</span><span class="op" id="8417068">(</span><span class="string" id="8417069">&#34;expected&nbsp;end&nbsp;of&nbsp;parts;&nbsp;got&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8417104">,</span>&nbsp;<span class="ident" id="8417106">part</span><span class="op" id="8417110">,</span>&nbsp;<span class="ident" id="8417112">err</span><span class="op" id="8417115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417118">}</span><br>
<span class="lineno"></span><span class="op" id="8417120">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="8417123">func</span>&nbsp;<span class="ident" id="8417128">TestWriterSetBoundary</span><span class="op" id="8417149">(</span><span class="ident" id="8417150">t</span>&nbsp;<span class="op" id="8417152">*</span><span class="ident" id="8417153">testing</span><span class="op" id="8417160">.</span><span class="ident" id="8417161">T</span><span class="op" id="8417162">)</span>&nbsp;<span class="op" id="8417164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417167">var</span>&nbsp;<span class="ident" id="8417171">b</span>&nbsp;<span class="ident" id="8417173">bytes</span><span class="op" id="8417178">.</span><span class="ident" id="8417179">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417187">w</span>&nbsp;<span class="op" id="8417189">:=</span>&nbsp;<span class="ident" id="8417192">NewWriter</span><span class="op" id="8417201">(</span><span class="op" id="8417202">&amp;</span><span class="ident" id="8417203">b</span><span class="op" id="8417204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417207">tests</span>&nbsp;<span class="op" id="8417213">:=</span>&nbsp;<span class="op" id="8417216">[</span><span class="op" id="8417217">]</span><span class="keyword" id="8417218">struct</span>&nbsp;<span class="op" id="8417225">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417229">b</span>&nbsp;&nbsp;<span class="builtintype" id="8417232">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417241">ok</span>&nbsp;<span class="builtintype" id="8417244">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417250">}</span><span class="op" id="8417251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417255">{</span><span class="string" id="8417256">&#34;abc&#34;</span><span class="op" id="8417261">,</span>&nbsp;<span class="builtintype" id="8417263">true</span><span class="op" id="8417267">}</span><span class="op" id="8417268">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417272">{</span><span class="string" id="8417273">&#34;&#34;</span><span class="op" id="8417275">,</span>&nbsp;<span class="builtintype" id="8417277">false</span><span class="op" id="8417282">}</span><span class="op" id="8417283">,</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417287">{</span><span class="string" id="8417288">&#34;ungültig&#34;</span><span class="op" id="8417299">,</span>&nbsp;<span class="builtintype" id="8417301">false</span><span class="op" id="8417306">}</span><span class="op" id="8417307">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417311">{</span><span class="string" id="8417312">&#34;!&#34;</span><span class="op" id="8417315">,</span>&nbsp;<span class="builtintype" id="8417317">false</span><span class="op" id="8417322">}</span><span class="op" id="8417323">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417327">{</span><span class="ident" id="8417328">strings</span><span class="op" id="8417335">.</span><span class="ident" id="8417336">Repeat</span><span class="op" id="8417342">(</span><span class="string" id="8417343">&#34;x&#34;</span><span class="op" id="8417346">,</span>&nbsp;<span class="num" id="8417348">69</span><span class="op" id="8417350">)</span><span class="op" id="8417351">,</span>&nbsp;<span class="builtintype" id="8417353">true</span><span class="op" id="8417357">}</span><span class="op" id="8417358">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417362">{</span><span class="ident" id="8417363">strings</span><span class="op" id="8417370">.</span><span class="ident" id="8417371">Repeat</span><span class="op" id="8417377">(</span><span class="string" id="8417378">&#34;x&#34;</span><span class="op" id="8417381">,</span>&nbsp;<span class="num" id="8417383">70</span><span class="op" id="8417385">)</span><span class="op" id="8417386">,</span>&nbsp;<span class="builtintype" id="8417388">false</span><span class="op" id="8417393">}</span><span class="op" id="8417394">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417398">{</span><span class="string" id="8417399">&#34;bad!ascii!&#34;</span><span class="op" id="8417411">,</span>&nbsp;<span class="builtintype" id="8417413">false</span><span class="op" id="8417418">}</span><span class="op" id="8417419">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417423">{</span><span class="string" id="8417424">&#34;my-separator&#34;</span><span class="op" id="8417438">,</span>&nbsp;<span class="builtintype" id="8417440">true</span><span class="op" id="8417444">}</span><span class="op" id="8417445">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417451">for</span>&nbsp;<span class="ident" id="8417455">i</span><span class="op" id="8417456">,</span>&nbsp;<span class="ident" id="8417458">tt</span>&nbsp;<span class="op" id="8417461">:=</span>&nbsp;<span class="keyword" id="8417464">range</span>&nbsp;<span class="ident" id="8417470">tests</span>&nbsp;<span class="op" id="8417476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417480">err</span>&nbsp;<span class="op" id="8417484">:=</span>&nbsp;<span class="ident" id="8417487">w</span><span class="op" id="8417488">.</span><span class="ident" id="8417489">SetBoundary</span><span class="op" id="8417500">(</span><span class="ident" id="8417501">tt</span><span class="op" id="8417503">.</span><span class="ident" id="8417504">b</span><span class="op" id="8417505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417509">got</span>&nbsp;<span class="op" id="8417513">:=</span>&nbsp;<span class="ident" id="8417516">err</span>&nbsp;<span class="op" id="8417520">==</span>&nbsp;<span class="ident" id="8417523">nil</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417529">if</span>&nbsp;<span class="ident" id="8417532">got</span>&nbsp;<span class="op" id="8417536">!=</span>&nbsp;<span class="ident" id="8417539">tt</span><span class="op" id="8417541">.</span><span class="ident" id="8417542">ok</span>&nbsp;<span class="op" id="8417545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417550">t</span><span class="op" id="8417551">.</span><span class="ident" id="8417552">Errorf</span><span class="op" id="8417558">(</span><span class="string" id="8417559">&#34;%d.&nbsp;boundary&nbsp;%q&nbsp;=&nbsp;%v&nbsp;(%v);&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8417595">,</span>&nbsp;<span class="ident" id="8417597">i</span><span class="op" id="8417598">,</span>&nbsp;<span class="ident" id="8417600">tt</span><span class="op" id="8417602">.</span><span class="ident" id="8417603">b</span><span class="op" id="8417604">,</span>&nbsp;<span class="ident" id="8417606">got</span><span class="op" id="8417609">,</span>&nbsp;<span class="ident" id="8417611">err</span><span class="op" id="8417614">,</span>&nbsp;<span class="ident" id="8417616">tt</span><span class="op" id="8417618">.</span><span class="ident" id="8417619">ok</span><span class="op" id="8417621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417625">}</span>&nbsp;<span class="keyword" id="8417627">else</span>&nbsp;<span class="keyword" id="8417632">if</span>&nbsp;<span class="ident" id="8417635">tt</span><span class="op" id="8417637">.</span><span class="ident" id="8417638">ok</span>&nbsp;<span class="op" id="8417641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417646">got</span>&nbsp;<span class="op" id="8417650">:=</span>&nbsp;<span class="ident" id="8417653">w</span><span class="op" id="8417654">.</span><span class="ident" id="8417655">Boundary</span><span class="op" id="8417663">(</span><span class="op" id="8417664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417669">if</span>&nbsp;<span class="ident" id="8417672">got</span>&nbsp;<span class="op" id="8417676">!=</span>&nbsp;<span class="ident" id="8417679">tt</span><span class="op" id="8417681">.</span><span class="ident" id="8417682">b</span>&nbsp;<span class="op" id="8417684">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417690">t</span><span class="op" id="8417691">.</span><span class="ident" id="8417692">Errorf</span><span class="op" id="8417698">(</span><span class="string" id="8417699">&#34;boundary&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8417723">,</span>&nbsp;<span class="ident" id="8417725">got</span><span class="op" id="8417728">,</span>&nbsp;<span class="ident" id="8417730">tt</span><span class="op" id="8417732">.</span><span class="ident" id="8417733">b</span><span class="op" id="8417734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417749">w</span><span class="op" id="8417750">.</span><span class="ident" id="8417751">Close</span><span class="op" id="8417756">(</span><span class="op" id="8417757">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417760">if</span>&nbsp;<span class="ident" id="8417763">got</span>&nbsp;<span class="op" id="8417767">:=</span>&nbsp;<span class="ident" id="8417770">b</span><span class="op" id="8417771">.</span><span class="ident" id="8417772">String</span><span class="op" id="8417778">(</span><span class="op" id="8417779">)</span><span class="op" id="8417780">;</span>&nbsp;<span class="op" id="8417782">!</span><span class="ident" id="8417783">strings</span><span class="op" id="8417790">.</span><span class="ident" id="8417791">Contains</span><span class="op" id="8417799">(</span><span class="ident" id="8417800">got</span><span class="op" id="8417803">,</span>&nbsp;<span class="string" id="8417805">&#34;\r\n--my-separator--\r\n&#34;</span><span class="op" id="8417831">)</span>&nbsp;<span class="op" id="8417833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417837">t</span><span class="op" id="8417838">.</span><span class="ident" id="8417839">Errorf</span><span class="op" id="8417845">(</span><span class="string" id="8417846">&#34;expected&nbsp;my-separator&nbsp;in&nbsp;output.&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="8417888">,</span>&nbsp;<span class="ident" id="8417890">got</span><span class="op" id="8417893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417896">}</span><br>
<span class="lineno"></span><span class="op" id="8417898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="8417901">func</span>&nbsp;<span class="ident" id="8417906">TestWriterBoundaryGoroutines</span><span class="op" id="8417934">(</span><span class="ident" id="8417935">t</span>&nbsp;<span class="op" id="8417937">*</span><span class="ident" id="8417938">testing</span><span class="op" id="8417945">.</span><span class="ident" id="8417946">T</span><span class="op" id="8417947">)</span>&nbsp;<span class="op" id="8417949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8417952">//&nbsp;Verify&nbsp;there&#39;s&nbsp;no&nbsp;data&nbsp;race&nbsp;accessing&nbsp;any&nbsp;lazy&nbsp;boundary&nbsp;if&nbsp;it&#39;s&nbsp;used&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8418028">//&nbsp;different&nbsp;goroutines.&nbsp;This&nbsp;was&nbsp;previously&nbsp;broken&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8418084">//&nbsp;https://codereview.appspot.com/95760043/&nbsp;and&nbsp;reverted&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8418145">//&nbsp;https://codereview.appspot.com/117600043/</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418191">w</span>&nbsp;<span class="op" id="8418193">:=</span>&nbsp;<span class="ident" id="8418196">NewWriter</span><span class="op" id="8418205">(</span><span class="ident" id="8418206">ioutil</span><span class="op" id="8418212">.</span><span class="ident" id="8418213">Discard</span><span class="op" id="8418220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418223">done</span>&nbsp;<span class="op" id="8418228">:=</span>&nbsp;<span class="builtinfunc" id="8418231">make</span><span class="op" id="8418235">(</span><span class="keyword" id="8418236">chan</span>&nbsp;<span class="builtintype" id="8418241">int</span><span class="op" id="8418244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8418247">go</span>&nbsp;<span class="keyword" id="8418250">func</span><span class="op" id="8418254">(</span><span class="op" id="8418255">)</span>&nbsp;<span class="op" id="8418257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418261">w</span><span class="op" id="8418262">.</span><span class="ident" id="8418263">CreateFormField</span><span class="op" id="8418278">(</span><span class="string" id="8418279">&#34;foo&#34;</span><span class="op" id="8418284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418288">done</span>&nbsp;<span class="op" id="8418293">&lt;-</span>&nbsp;<span class="num" id="8418296">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8418299">}</span><span class="op" id="8418300">(</span><span class="op" id="8418301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418304">w</span><span class="op" id="8418305">.</span><span class="ident" id="8418306">Boundary</span><span class="op" id="8418314">(</span><span class="op" id="8418315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8418318">&lt;-</span><span class="ident" id="8418320">done</span><br>
<span class="lineno"></span><span class="op" id="8418325">}</span>
</div>
</body>
</html>
