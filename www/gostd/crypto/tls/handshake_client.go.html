<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html" class="current">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3910365">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3910420">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3910474">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3910525">package</span>&nbsp;<span class="ident" id="3910533">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3910538">import</span>&nbsp;<span class="op" id="3910545">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3910548">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3910557">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3910567">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3910583">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3910597">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3910614">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3910629">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3910639">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3910646">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3910652">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3910659">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="3910669">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3910672">type</span>&nbsp;<span class="ident" id="3910677">clientHandshakeState</span>&nbsp;<span class="keyword" id="3910698">struct</span>&nbsp;<span class="op" id="3910705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3910708">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3910721">*</span><span class="ident" id="3910722">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3910728">serverHello</span>&nbsp;&nbsp;<span class="op" id="3910741">*</span><span class="ident" id="3910742">serverHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3910758">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3910771">*</span><span class="ident" id="3910772">clientHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3910788">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3910801">*</span><span class="ident" id="3910802">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3910815">finishedHash</span>&nbsp;<span class="ident" id="3910828">finishedHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3910842">masterSecret</span>&nbsp;<span class="op" id="3910855">[</span><span class="op" id="3910856">]</span><span class="builtintype" id="3910857">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3910863">session</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3910876">*</span><span class="ident" id="3910877">ClientSessionState</span><br>
<span class="lineno"></span><span class="op" id="3910896">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="3910899">func</span>&nbsp;<span class="op" id="3910904">(</span><span class="ident" id="3910905">c</span>&nbsp;<span class="op" id="3910907">*</span><span class="ident" id="3910908">Conn</span><span class="op" id="3910912">)</span>&nbsp;<span class="ident" id="3910914">clientHandshake</span><span class="op" id="3910929">(</span><span class="op" id="3910930">)</span>&nbsp;<span class="builtintype" id="3910932">error</span>&nbsp;<span class="op" id="3910938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3910941">if</span>&nbsp;<span class="ident" id="3910944">c</span><span class="op" id="3910945">.</span><span class="ident" id="3910946">config</span>&nbsp;<span class="op" id="3910953">==</span>&nbsp;<span class="ident" id="3910956">nil</span>&nbsp;<span class="op" id="3910960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3910964">c</span><span class="op" id="3910965">.</span><span class="ident" id="3910966">config</span>&nbsp;<span class="op" id="3910973">=</span>&nbsp;<span class="ident" id="3910975">defaultConfig</span><span class="op" id="3910988">(</span><span class="op" id="3910989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3910992">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3910996">if</span>&nbsp;<span class="builtinfunc" id="3910999">len</span><span class="op" id="3911002">(</span><span class="ident" id="3911003">c</span><span class="op" id="3911004">.</span><span class="ident" id="3911005">config</span><span class="op" id="3911011">.</span><span class="ident" id="3911012">ServerName</span><span class="op" id="3911022">)</span>&nbsp;<span class="op" id="3911024">==</span>&nbsp;<span class="num" id="3911027">0</span>&nbsp;<span class="op" id="3911029">&amp;&amp;</span>&nbsp;<span class="op" id="3911032">!</span><span class="ident" id="3911033">c</span><span class="op" id="3911034">.</span><span class="ident" id="3911035">config</span><span class="op" id="3911041">.</span><span class="ident" id="3911042">InsecureSkipVerify</span>&nbsp;<span class="op" id="3911061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3911065">return</span>&nbsp;<span class="ident" id="3911072">errors</span><span class="op" id="3911078">.</span><span class="ident" id="3911079">New</span><span class="op" id="3911082">(</span><span class="string" id="3911083">&#34;tls:&nbsp;either&nbsp;ServerName&nbsp;or&nbsp;InsecureSkipVerify&nbsp;must&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;tls.Config&#34;</span><span class="op" id="3911165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3911168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911172">nextProtosLength</span>&nbsp;<span class="op" id="3911189">:=</span>&nbsp;<span class="num" id="3911192">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3911195">for</span>&nbsp;<span class="ident" id="3911199">_</span><span class="op" id="3911200">,</span>&nbsp;<span class="ident" id="3911202">proto</span>&nbsp;<span class="op" id="3911208">:=</span>&nbsp;<span class="keyword" id="3911211">range</span>&nbsp;<span class="ident" id="3911217">c</span><span class="op" id="3911218">.</span><span class="ident" id="3911219">config</span><span class="op" id="3911225">.</span><span class="ident" id="3911226">NextProtos</span>&nbsp;<span class="op" id="3911237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3911241">if</span>&nbsp;<span class="ident" id="3911244">l</span>&nbsp;<span class="op" id="3911246">:=</span>&nbsp;<span class="builtinfunc" id="3911249">len</span><span class="op" id="3911252">(</span><span class="ident" id="3911253">proto</span><span class="op" id="3911258">)</span><span class="op" id="3911259">;</span>&nbsp;<span class="ident" id="3911261">l</span>&nbsp;<span class="op" id="3911263">==</span>&nbsp;<span class="num" id="3911266">0</span>&nbsp;<span class="op" id="3911268">||</span>&nbsp;<span class="ident" id="3911271">l</span>&nbsp;<span class="op" id="3911273">&gt;</span>&nbsp;<span class="num" id="3911275">255</span>&nbsp;<span class="op" id="3911279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3911284">return</span>&nbsp;<span class="ident" id="3911291">errors</span><span class="op" id="3911297">.</span><span class="ident" id="3911298">New</span><span class="op" id="3911301">(</span><span class="string" id="3911302">&#34;tls:&nbsp;invalid&nbsp;NextProtos&nbsp;value&#34;</span><span class="op" id="3911333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3911337">}</span>&nbsp;<span class="keyword" id="3911339">else</span>&nbsp;<span class="op" id="3911344">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911349">nextProtosLength</span>&nbsp;<span class="op" id="3911366">+=</span>&nbsp;<span class="num" id="3911369">1</span>&nbsp;<span class="op" id="3911371">+</span>&nbsp;<span class="ident" id="3911373">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3911377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3911380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3911383">if</span>&nbsp;<span class="ident" id="3911386">nextProtosLength</span>&nbsp;<span class="op" id="3911403">&gt;</span>&nbsp;<span class="num" id="3911405">0xffff</span>&nbsp;<span class="op" id="3911412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3911416">return</span>&nbsp;<span class="ident" id="3911423">errors</span><span class="op" id="3911429">.</span><span class="ident" id="3911430">New</span><span class="op" id="3911433">(</span><span class="string" id="3911434">&#34;tls:&nbsp;NextProtos&nbsp;values&nbsp;too&nbsp;large&#34;</span><span class="op" id="3911468">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3911471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911475">hello</span>&nbsp;<span class="op" id="3911481">:=</span>&nbsp;<span class="op" id="3911484">&amp;</span><span class="ident" id="3911485">clientHelloMsg</span><span class="op" id="3911499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911503">vers</span><span class="op" id="3911507">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911524">c</span><span class="op" id="3911525">.</span><span class="ident" id="3911526">config</span><span class="op" id="3911532">.</span><span class="ident" id="3911533">maxVersion</span><span class="op" id="3911543">(</span><span class="op" id="3911544">)</span><span class="op" id="3911545">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911549">compressionMethods</span><span class="op" id="3911567">:</span>&nbsp;&nbsp;<span class="op" id="3911570">[</span><span class="op" id="3911571">]</span><span class="builtintype" id="3911572">uint8</span><span class="op" id="3911577">{</span><span class="ident" id="3911578">compressionNone</span><span class="op" id="3911593">}</span><span class="op" id="3911594">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911598">random</span><span class="op" id="3911604">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3911619">make</span><span class="op" id="3911623">(</span><span class="op" id="3911624">[</span><span class="op" id="3911625">]</span><span class="builtintype" id="3911626">byte</span><span class="op" id="3911630">,</span>&nbsp;<span class="num" id="3911632">32</span><span class="op" id="3911634">)</span><span class="op" id="3911635">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911639">ocspStapling</span><span class="op" id="3911651">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3911660">true</span><span class="op" id="3911664">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911668">serverName</span><span class="op" id="3911678">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911689">c</span><span class="op" id="3911690">.</span><span class="ident" id="3911691">config</span><span class="op" id="3911697">.</span><span class="ident" id="3911698">ServerName</span><span class="op" id="3911708">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911712">supportedCurves</span><span class="op" id="3911727">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911733">c</span><span class="op" id="3911734">.</span><span class="ident" id="3911735">config</span><span class="op" id="3911741">.</span><span class="ident" id="3911742">curvePreferences</span><span class="op" id="3911758">(</span><span class="op" id="3911759">)</span><span class="op" id="3911760">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911764">supportedPoints</span><span class="op" id="3911779">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3911785">[</span><span class="op" id="3911786">]</span><span class="builtintype" id="3911787">uint8</span><span class="op" id="3911792">{</span><span class="ident" id="3911793">pointFormatUncompressed</span><span class="op" id="3911816">}</span><span class="op" id="3911817">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911821">nextProtoNeg</span><span class="op" id="3911833">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3911842">len</span><span class="op" id="3911845">(</span><span class="ident" id="3911846">c</span><span class="op" id="3911847">.</span><span class="ident" id="3911848">config</span><span class="op" id="3911854">.</span><span class="ident" id="3911855">NextProtos</span><span class="op" id="3911865">)</span>&nbsp;<span class="op" id="3911867">&gt;</span>&nbsp;<span class="num" id="3911869">0</span><span class="op" id="3911870">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911874">secureRenegotiation</span><span class="op" id="3911893">:</span>&nbsp;<span class="builtintype" id="3911895">true</span><span class="op" id="3911899">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911903">alpnProtocols</span><span class="op" id="3911916">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911924">c</span><span class="op" id="3911925">.</span><span class="ident" id="3911926">config</span><span class="op" id="3911932">.</span><span class="ident" id="3911933">NextProtos</span><span class="op" id="3911943">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3911946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911950">possibleCipherSuites</span>&nbsp;<span class="op" id="3911971">:=</span>&nbsp;<span class="ident" id="3911974">c</span><span class="op" id="3911975">.</span><span class="ident" id="3911976">config</span><span class="op" id="3911982">.</span><span class="ident" id="3911983">cipherSuites</span><span class="op" id="3911995">(</span><span class="op" id="3911996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3911999">hello</span><span class="op" id="3912004">.</span><span class="ident" id="3912005">cipherSuites</span>&nbsp;<span class="op" id="3912018">=</span>&nbsp;<span class="builtinfunc" id="3912020">make</span><span class="op" id="3912024">(</span><span class="op" id="3912025">[</span><span class="op" id="3912026">]</span><span class="builtintype" id="3912027">uint16</span><span class="op" id="3912033">,</span>&nbsp;<span class="num" id="3912035">0</span><span class="op" id="3912036">,</span>&nbsp;<span class="builtinfunc" id="3912038">len</span><span class="op" id="3912041">(</span><span class="ident" id="3912042">possibleCipherSuites</span><span class="op" id="3912062">)</span><span class="op" id="3912063">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="3912066">NextCipherSuite</span><span class="op" id="3912081">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3912084">for</span>&nbsp;<span class="ident" id="3912088">_</span><span class="op" id="3912089">,</span>&nbsp;<span class="ident" id="3912091">suiteId</span>&nbsp;<span class="op" id="3912099">:=</span>&nbsp;<span class="keyword" id="3912102">range</span>&nbsp;<span class="ident" id="3912108">possibleCipherSuites</span>&nbsp;<span class="op" id="3912129">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3912133">for</span>&nbsp;<span class="ident" id="3912137">_</span><span class="op" id="3912138">,</span>&nbsp;<span class="ident" id="3912140">suite</span>&nbsp;<span class="op" id="3912146">:=</span>&nbsp;<span class="keyword" id="3912149">range</span>&nbsp;<span class="ident" id="3912155">cipherSuites</span>&nbsp;<span class="op" id="3912168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3912173">if</span>&nbsp;<span class="ident" id="3912176">suite</span><span class="op" id="3912181">.</span><span class="ident" id="3912182">id</span>&nbsp;<span class="op" id="3912185">!=</span>&nbsp;<span class="ident" id="3912188">suiteId</span>&nbsp;<span class="op" id="3912196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3912202">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3912214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3912219">//&nbsp;Don&#39;t&nbsp;advertise&nbsp;TLS&nbsp;1.2-only&nbsp;cipher&nbsp;suites&nbsp;unless</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3912275">//&nbsp;we&#39;re&nbsp;attempting&nbsp;TLS&nbsp;1.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3912307">if</span>&nbsp;<span class="ident" id="3912310">hello</span><span class="op" id="3912315">.</span><span class="ident" id="3912316">vers</span>&nbsp;<span class="op" id="3912321">&lt;</span>&nbsp;<span class="ident" id="3912323">VersionTLS12</span>&nbsp;<span class="op" id="3912336">&amp;&amp;</span>&nbsp;<span class="ident" id="3912339">suite</span><span class="op" id="3912344">.</span><span class="ident" id="3912345">flags</span><span class="op" id="3912350">&amp;</span><span class="ident" id="3912351">suiteTLS12</span>&nbsp;<span class="op" id="3912362">!=</span>&nbsp;<span class="num" id="3912365">0</span>&nbsp;<span class="op" id="3912367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3912373">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3912385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3912390">hello</span><span class="op" id="3912395">.</span><span class="ident" id="3912396">cipherSuites</span>&nbsp;<span class="op" id="3912409">=</span>&nbsp;<span class="builtinfunc" id="3912411">append</span><span class="op" id="3912417">(</span><span class="ident" id="3912418">hello</span><span class="op" id="3912423">.</span><span class="ident" id="3912424">cipherSuites</span><span class="op" id="3912436">,</span>&nbsp;<span class="ident" id="3912438">suiteId</span><span class="op" id="3912445">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3912450">continue</span>&nbsp;<span class="ident" id="3912459">NextCipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3912477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3912480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3912484">_</span><span class="op" id="3912485">,</span>&nbsp;<span class="ident" id="3912487">err</span>&nbsp;<span class="op" id="3912491">:=</span>&nbsp;<span class="ident" id="3912494">io</span><span class="op" id="3912496">.</span><span class="ident" id="3912497">ReadFull</span><span class="op" id="3912505">(</span><span class="ident" id="3912506">c</span><span class="op" id="3912507">.</span><span class="ident" id="3912508">config</span><span class="op" id="3912514">.</span><span class="ident" id="3912515">rand</span><span class="op" id="3912519">(</span><span class="op" id="3912520">)</span><span class="op" id="3912521">,</span>&nbsp;<span class="ident" id="3912523">hello</span><span class="op" id="3912528">.</span><span class="ident" id="3912529">random</span><span class="op" id="3912535">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3912538">if</span>&nbsp;<span class="ident" id="3912541">err</span>&nbsp;<span class="op" id="3912545">!=</span>&nbsp;<span class="ident" id="3912548">nil</span>&nbsp;<span class="op" id="3912552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3912556">c</span><span class="op" id="3912557">.</span><span class="ident" id="3912558">sendAlert</span><span class="op" id="3912567">(</span><span class="ident" id="3912568">alertInternalError</span><span class="op" id="3912586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3912590">return</span>&nbsp;<span class="ident" id="3912597">errors</span><span class="op" id="3912603">.</span><span class="ident" id="3912604">New</span><span class="op" id="3912607">(</span><span class="string" id="3912608">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="3912638">+</span>&nbsp;<span class="ident" id="3912640">err</span><span class="op" id="3912643">.</span><span class="ident" id="3912644">Error</span><span class="op" id="3912649">(</span><span class="op" id="3912650">)</span><span class="op" id="3912651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3912654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3912658">if</span>&nbsp;<span class="ident" id="3912661">hello</span><span class="op" id="3912666">.</span><span class="ident" id="3912667">vers</span>&nbsp;<span class="op" id="3912672">&gt;=</span>&nbsp;<span class="ident" id="3912675">VersionTLS12</span>&nbsp;<span class="op" id="3912688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3912692">hello</span><span class="op" id="3912697">.</span><span class="ident" id="3912698">signatureAndHashes</span>&nbsp;<span class="op" id="3912717">=</span>&nbsp;<span class="ident" id="3912719">supportedSKXSignatureAlgorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3912752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3912756">var</span>&nbsp;<span class="ident" id="3912760">session</span>&nbsp;<span class="op" id="3912768">*</span><span class="ident" id="3912769">ClientSessionState</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3912789">var</span>&nbsp;<span class="ident" id="3912793">cacheKey</span>&nbsp;<span class="builtintype" id="3912802">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3912810">sessionCache</span>&nbsp;<span class="op" id="3912823">:=</span>&nbsp;<span class="ident" id="3912826">c</span><span class="op" id="3912827">.</span><span class="ident" id="3912828">config</span><span class="op" id="3912834">.</span><span class="ident" id="3912835">ClientSessionCache</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3912855">if</span>&nbsp;<span class="ident" id="3912858">c</span><span class="op" id="3912859">.</span><span class="ident" id="3912860">config</span><span class="op" id="3912866">.</span><span class="ident" id="3912867">SessionTicketsDisabled</span>&nbsp;<span class="op" id="3912890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3912894">sessionCache</span>&nbsp;<span class="op" id="3912907">=</span>&nbsp;<span class="ident" id="3912909">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3912914">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3912918">if</span>&nbsp;<span class="ident" id="3912921">sessionCache</span>&nbsp;<span class="op" id="3912934">!=</span>&nbsp;<span class="ident" id="3912937">nil</span>&nbsp;<span class="op" id="3912941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3912945">hello</span><span class="op" id="3912950">.</span><span class="ident" id="3912951">ticketSupported</span>&nbsp;<span class="op" id="3912967">=</span>&nbsp;<span class="builtintype" id="3912969">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3912977">//&nbsp;Try&nbsp;to&nbsp;resume&nbsp;a&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;session,&nbsp;if</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3913036">//&nbsp;available.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3913052">cacheKey</span>&nbsp;<span class="op" id="3913061">=</span>&nbsp;<span class="ident" id="3913063">clientSessionCacheKey</span><span class="op" id="3913084">(</span><span class="ident" id="3913085">c</span><span class="op" id="3913086">.</span><span class="ident" id="3913087">conn</span><span class="op" id="3913091">.</span><span class="ident" id="3913092">RemoteAddr</span><span class="op" id="3913102">(</span><span class="op" id="3913103">)</span><span class="op" id="3913104">,</span>&nbsp;<span class="ident" id="3913106">c</span><span class="op" id="3913107">.</span><span class="ident" id="3913108">config</span><span class="op" id="3913114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3913118">candidateSession</span><span class="op" id="3913134">,</span>&nbsp;<span class="ident" id="3913136">ok</span>&nbsp;<span class="op" id="3913139">:=</span>&nbsp;<span class="ident" id="3913142">sessionCache</span><span class="op" id="3913154">.</span><span class="ident" id="3913155">Get</span><span class="op" id="3913158">(</span><span class="ident" id="3913159">cacheKey</span><span class="op" id="3913167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3913171">if</span>&nbsp;<span class="ident" id="3913174">ok</span>&nbsp;<span class="op" id="3913177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3913182">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;ciphersuite/version&nbsp;used&nbsp;for&nbsp;the</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3913236">//&nbsp;previous&nbsp;session&nbsp;are&nbsp;still&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3913276">cipherSuiteOk</span>&nbsp;<span class="op" id="3913290">:=</span>&nbsp;<span class="builtintype" id="3913293">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3913302">for</span>&nbsp;<span class="ident" id="3913306">_</span><span class="op" id="3913307">,</span>&nbsp;<span class="ident" id="3913309">id</span>&nbsp;<span class="op" id="3913312">:=</span>&nbsp;<span class="keyword" id="3913315">range</span>&nbsp;<span class="ident" id="3913321">hello</span><span class="op" id="3913326">.</span><span class="ident" id="3913327">cipherSuites</span>&nbsp;<span class="op" id="3913340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3913346">if</span>&nbsp;<span class="ident" id="3913349">id</span>&nbsp;<span class="op" id="3913352">==</span>&nbsp;<span class="ident" id="3913355">candidateSession</span><span class="op" id="3913371">.</span><span class="ident" id="3913372">cipherSuite</span>&nbsp;<span class="op" id="3913384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3913391">cipherSuiteOk</span>&nbsp;<span class="op" id="3913405">=</span>&nbsp;<span class="builtintype" id="3913407">true</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3913417">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3913427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3913432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3913438">versOk</span>&nbsp;<span class="op" id="3913445">:=</span>&nbsp;<span class="ident" id="3913448">candidateSession</span><span class="op" id="3913464">.</span><span class="ident" id="3913465">vers</span>&nbsp;<span class="op" id="3913470">&gt;=</span>&nbsp;<span class="ident" id="3913473">c</span><span class="op" id="3913474">.</span><span class="ident" id="3913475">config</span><span class="op" id="3913481">.</span><span class="ident" id="3913482">minVersion</span><span class="op" id="3913492">(</span><span class="op" id="3913493">)</span>&nbsp;<span class="op" id="3913495">&amp;&amp;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3913502">candidateSession</span><span class="op" id="3913518">.</span><span class="ident" id="3913519">vers</span>&nbsp;<span class="op" id="3913524">&lt;=</span>&nbsp;<span class="ident" id="3913527">c</span><span class="op" id="3913528">.</span><span class="ident" id="3913529">config</span><span class="op" id="3913535">.</span><span class="ident" id="3913536">maxVersion</span><span class="op" id="3913546">(</span><span class="op" id="3913547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3913552">if</span>&nbsp;<span class="ident" id="3913555">versOk</span>&nbsp;<span class="op" id="3913562">&amp;&amp;</span>&nbsp;<span class="ident" id="3913565">cipherSuiteOk</span>&nbsp;<span class="op" id="3913579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3913585">session</span>&nbsp;<span class="op" id="3913593">=</span>&nbsp;<span class="ident" id="3913595">candidateSession</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3913615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3913619">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3913622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3913626">if</span>&nbsp;<span class="ident" id="3913629">session</span>&nbsp;<span class="op" id="3913637">!=</span>&nbsp;<span class="ident" id="3913640">nil</span>&nbsp;<span class="op" id="3913644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3913648">hello</span><span class="op" id="3913653">.</span><span class="ident" id="3913654">sessionTicket</span>&nbsp;<span class="op" id="3913668">=</span>&nbsp;<span class="ident" id="3913670">session</span><span class="op" id="3913677">.</span><span class="ident" id="3913678">sessionTicket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3913694">//&nbsp;A&nbsp;random&nbsp;session&nbsp;ID&nbsp;is&nbsp;used&nbsp;to&nbsp;detect&nbsp;when&nbsp;the</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3913746">//&nbsp;server&nbsp;accepted&nbsp;the&nbsp;ticket&nbsp;and&nbsp;is&nbsp;resuming&nbsp;a&nbsp;session</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3913804">//&nbsp;(see&nbsp;RFC&nbsp;5077).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3913825">hello</span><span class="op" id="3913830">.</span><span class="ident" id="3913831">sessionId</span>&nbsp;<span class="op" id="3913841">=</span>&nbsp;<span class="builtinfunc" id="3913843">make</span><span class="op" id="3913847">(</span><span class="op" id="3913848">[</span><span class="op" id="3913849">]</span><span class="builtintype" id="3913850">byte</span><span class="op" id="3913854">,</span>&nbsp;<span class="num" id="3913856">16</span><span class="op" id="3913858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3913862">if</span>&nbsp;<span class="ident" id="3913865">_</span><span class="op" id="3913866">,</span>&nbsp;<span class="ident" id="3913868">err</span>&nbsp;<span class="op" id="3913872">:=</span>&nbsp;<span class="ident" id="3913875">io</span><span class="op" id="3913877">.</span><span class="ident" id="3913878">ReadFull</span><span class="op" id="3913886">(</span><span class="ident" id="3913887">c</span><span class="op" id="3913888">.</span><span class="ident" id="3913889">config</span><span class="op" id="3913895">.</span><span class="ident" id="3913896">rand</span><span class="op" id="3913900">(</span><span class="op" id="3913901">)</span><span class="op" id="3913902">,</span>&nbsp;<span class="ident" id="3913904">hello</span><span class="op" id="3913909">.</span><span class="ident" id="3913910">sessionId</span><span class="op" id="3913919">)</span><span class="op" id="3913920">;</span>&nbsp;<span class="ident" id="3913922">err</span>&nbsp;<span class="op" id="3913926">!=</span>&nbsp;<span class="ident" id="3913929">nil</span>&nbsp;<span class="op" id="3913933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3913938">c</span><span class="op" id="3913939">.</span><span class="ident" id="3913940">sendAlert</span><span class="op" id="3913949">(</span><span class="ident" id="3913950">alertInternalError</span><span class="op" id="3913968">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3913973">return</span>&nbsp;<span class="ident" id="3913980">errors</span><span class="op" id="3913986">.</span><span class="ident" id="3913987">New</span><span class="op" id="3913990">(</span><span class="string" id="3913991">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="3914021">+</span>&nbsp;<span class="ident" id="3914023">err</span><span class="op" id="3914026">.</span><span class="ident" id="3914027">Error</span><span class="op" id="3914032">(</span><span class="op" id="3914033">)</span><span class="op" id="3914034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3914038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3914041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914045">c</span><span class="op" id="3914046">.</span><span class="ident" id="3914047">writeRecord</span><span class="op" id="3914058">(</span><span class="ident" id="3914059">recordTypeHandshake</span><span class="op" id="3914078">,</span>&nbsp;<span class="ident" id="3914080">hello</span><span class="op" id="3914085">.</span><span class="ident" id="3914086">marshal</span><span class="op" id="3914093">(</span><span class="op" id="3914094">)</span><span class="op" id="3914095">)</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914099">msg</span><span class="op" id="3914102">,</span>&nbsp;<span class="ident" id="3914104">err</span>&nbsp;<span class="op" id="3914108">:=</span>&nbsp;<span class="ident" id="3914111">c</span><span class="op" id="3914112">.</span><span class="ident" id="3914113">readHandshake</span><span class="op" id="3914126">(</span><span class="op" id="3914127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3914130">if</span>&nbsp;<span class="ident" id="3914133">err</span>&nbsp;<span class="op" id="3914137">!=</span>&nbsp;<span class="ident" id="3914140">nil</span>&nbsp;<span class="op" id="3914144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3914148">return</span>&nbsp;<span class="ident" id="3914155">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3914160">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914163">serverHello</span><span class="op" id="3914174">,</span>&nbsp;<span class="ident" id="3914176">ok</span>&nbsp;<span class="op" id="3914179">:=</span>&nbsp;<span class="ident" id="3914182">msg</span><span class="op" id="3914185">.</span><span class="op" id="3914186">(</span><span class="op" id="3914187">*</span><span class="ident" id="3914188">serverHelloMsg</span><span class="op" id="3914202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3914205">if</span>&nbsp;<span class="op" id="3914208">!</span><span class="ident" id="3914209">ok</span>&nbsp;<span class="op" id="3914212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914216">c</span><span class="op" id="3914217">.</span><span class="ident" id="3914218">sendAlert</span><span class="op" id="3914227">(</span><span class="ident" id="3914228">alertUnexpectedMessage</span><span class="op" id="3914250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3914254">return</span>&nbsp;<span class="ident" id="3914261">unexpectedMessageError</span><span class="op" id="3914283">(</span><span class="ident" id="3914284">serverHello</span><span class="op" id="3914295">,</span>&nbsp;<span class="ident" id="3914297">msg</span><span class="op" id="3914300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3914303">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914307">vers</span><span class="op" id="3914311">,</span>&nbsp;<span class="ident" id="3914313">ok</span>&nbsp;<span class="op" id="3914316">:=</span>&nbsp;<span class="ident" id="3914319">c</span><span class="op" id="3914320">.</span><span class="ident" id="3914321">config</span><span class="op" id="3914327">.</span><span class="ident" id="3914328">mutualVersion</span><span class="op" id="3914341">(</span><span class="ident" id="3914342">serverHello</span><span class="op" id="3914353">.</span><span class="ident" id="3914354">vers</span><span class="op" id="3914358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3914361">if</span>&nbsp;<span class="op" id="3914364">!</span><span class="ident" id="3914365">ok</span>&nbsp;<span class="op" id="3914368">||</span>&nbsp;<span class="ident" id="3914371">vers</span>&nbsp;<span class="op" id="3914376">&lt;</span>&nbsp;<span class="ident" id="3914378">VersionTLS10</span>&nbsp;<span class="op" id="3914391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3914395">//&nbsp;TLS&nbsp;1.0&nbsp;is&nbsp;the&nbsp;minimum&nbsp;version&nbsp;supported&nbsp;as&nbsp;a&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914454">c</span><span class="op" id="3914455">.</span><span class="ident" id="3914456">sendAlert</span><span class="op" id="3914465">(</span><span class="ident" id="3914466">alertProtocolVersion</span><span class="op" id="3914486">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3914490">return</span>&nbsp;<span class="ident" id="3914497">fmt</span><span class="op" id="3914500">.</span><span class="ident" id="3914501">Errorf</span><span class="op" id="3914507">(</span><span class="string" id="3914508">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;protocol&nbsp;version&nbsp;%x&#34;</span><span class="op" id="3914562">,</span>&nbsp;<span class="ident" id="3914564">serverHello</span><span class="op" id="3914575">.</span><span class="ident" id="3914576">vers</span><span class="op" id="3914580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3914583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914586">c</span><span class="op" id="3914587">.</span><span class="ident" id="3914588">vers</span>&nbsp;<span class="op" id="3914593">=</span>&nbsp;<span class="ident" id="3914595">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914601">c</span><span class="op" id="3914602">.</span><span class="ident" id="3914603">haveVers</span>&nbsp;<span class="op" id="3914612">=</span>&nbsp;<span class="builtintype" id="3914614">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914621">suite</span>&nbsp;<span class="op" id="3914627">:=</span>&nbsp;<span class="ident" id="3914630">mutualCipherSuite</span><span class="op" id="3914647">(</span><span class="ident" id="3914648">c</span><span class="op" id="3914649">.</span><span class="ident" id="3914650">config</span><span class="op" id="3914656">.</span><span class="ident" id="3914657">cipherSuites</span><span class="op" id="3914669">(</span><span class="op" id="3914670">)</span><span class="op" id="3914671">,</span>&nbsp;<span class="ident" id="3914673">serverHello</span><span class="op" id="3914684">.</span><span class="ident" id="3914685">cipherSuite</span><span class="op" id="3914696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3914699">if</span>&nbsp;<span class="ident" id="3914702">suite</span>&nbsp;<span class="op" id="3914708">==</span>&nbsp;<span class="ident" id="3914711">nil</span>&nbsp;<span class="op" id="3914715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914719">c</span><span class="op" id="3914720">.</span><span class="ident" id="3914721">sendAlert</span><span class="op" id="3914730">(</span><span class="ident" id="3914731">alertHandshakeFailure</span><span class="op" id="3914752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3914756">return</span>&nbsp;<span class="ident" id="3914763">fmt</span><span class="op" id="3914766">.</span><span class="ident" id="3914767">Errorf</span><span class="op" id="3914773">(</span><span class="string" id="3914774">&#34;tls:&nbsp;server&nbsp;selected&nbsp;an&nbsp;unsupported&nbsp;cipher&nbsp;suite&#34;</span><span class="op" id="3914824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3914827">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914831">hs</span>&nbsp;<span class="op" id="3914834">:=</span>&nbsp;<span class="op" id="3914837">&amp;</span><span class="ident" id="3914838">clientHandshakeState</span><span class="op" id="3914858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914862">c</span><span class="op" id="3914863">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914876">c</span><span class="op" id="3914877">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914881">serverHello</span><span class="op" id="3914892">:</span>&nbsp;&nbsp;<span class="ident" id="3914895">serverHello</span><span class="op" id="3914906">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914910">hello</span><span class="op" id="3914915">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914924">hello</span><span class="op" id="3914929">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914933">suite</span><span class="op" id="3914938">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914947">suite</span><span class="op" id="3914952">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914956">finishedHash</span><span class="op" id="3914968">:</span>&nbsp;<span class="ident" id="3914970">newFinishedHash</span><span class="op" id="3914985">(</span><span class="ident" id="3914986">c</span><span class="op" id="3914987">.</span><span class="ident" id="3914988">vers</span><span class="op" id="3914992">)</span><span class="op" id="3914993">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3914997">session</span><span class="op" id="3915004">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3915011">session</span><span class="op" id="3915018">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3915021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3915025">hs</span><span class="op" id="3915027">.</span><span class="ident" id="3915028">finishedHash</span><span class="op" id="3915040">.</span><span class="ident" id="3915041">Write</span><span class="op" id="3915046">(</span><span class="ident" id="3915047">hs</span><span class="op" id="3915049">.</span><span class="ident" id="3915050">hello</span><span class="op" id="3915055">.</span><span class="ident" id="3915056">marshal</span><span class="op" id="3915063">(</span><span class="op" id="3915064">)</span><span class="op" id="3915065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3915068">hs</span><span class="op" id="3915070">.</span><span class="ident" id="3915071">finishedHash</span><span class="op" id="3915083">.</span><span class="ident" id="3915084">Write</span><span class="op" id="3915089">(</span><span class="ident" id="3915090">hs</span><span class="op" id="3915092">.</span><span class="ident" id="3915093">serverHello</span><span class="op" id="3915104">.</span><span class="ident" id="3915105">marshal</span><span class="op" id="3915112">(</span><span class="op" id="3915113">)</span><span class="op" id="3915114">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3915118">isResume</span><span class="op" id="3915126">,</span>&nbsp;<span class="ident" id="3915128">err</span>&nbsp;<span class="op" id="3915132">:=</span>&nbsp;<span class="ident" id="3915135">hs</span><span class="op" id="3915137">.</span><span class="ident" id="3915138">processServerHello</span><span class="op" id="3915156">(</span><span class="op" id="3915157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915160">if</span>&nbsp;<span class="ident" id="3915163">err</span>&nbsp;<span class="op" id="3915167">!=</span>&nbsp;<span class="ident" id="3915170">nil</span>&nbsp;<span class="op" id="3915174">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915178">return</span>&nbsp;<span class="ident" id="3915185">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3915190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915194">if</span>&nbsp;<span class="ident" id="3915197">isResume</span>&nbsp;<span class="op" id="3915206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915210">if</span>&nbsp;<span class="ident" id="3915213">err</span>&nbsp;<span class="op" id="3915217">:=</span>&nbsp;<span class="ident" id="3915220">hs</span><span class="op" id="3915222">.</span><span class="ident" id="3915223">establishKeys</span><span class="op" id="3915236">(</span><span class="op" id="3915237">)</span><span class="op" id="3915238">;</span>&nbsp;<span class="ident" id="3915240">err</span>&nbsp;<span class="op" id="3915244">!=</span>&nbsp;<span class="ident" id="3915247">nil</span>&nbsp;<span class="op" id="3915251">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915256">return</span>&nbsp;<span class="ident" id="3915263">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3915269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915273">if</span>&nbsp;<span class="ident" id="3915276">err</span>&nbsp;<span class="op" id="3915280">:=</span>&nbsp;<span class="ident" id="3915283">hs</span><span class="op" id="3915285">.</span><span class="ident" id="3915286">readSessionTicket</span><span class="op" id="3915303">(</span><span class="op" id="3915304">)</span><span class="op" id="3915305">;</span>&nbsp;<span class="ident" id="3915307">err</span>&nbsp;<span class="op" id="3915311">!=</span>&nbsp;<span class="ident" id="3915314">nil</span>&nbsp;<span class="op" id="3915318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915323">return</span>&nbsp;<span class="ident" id="3915330">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3915336">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915340">if</span>&nbsp;<span class="ident" id="3915343">err</span>&nbsp;<span class="op" id="3915347">:=</span>&nbsp;<span class="ident" id="3915350">hs</span><span class="op" id="3915352">.</span><span class="ident" id="3915353">readFinished</span><span class="op" id="3915365">(</span><span class="ident" id="3915366">c</span><span class="op" id="3915367">.</span><span class="ident" id="3915368">firstFinished</span><span class="op" id="3915381">[</span><span class="op" id="3915382">:</span><span class="op" id="3915383">]</span><span class="op" id="3915384">)</span><span class="op" id="3915385">;</span>&nbsp;<span class="ident" id="3915387">err</span>&nbsp;<span class="op" id="3915391">!=</span>&nbsp;<span class="ident" id="3915394">nil</span>&nbsp;<span class="op" id="3915398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915403">return</span>&nbsp;<span class="ident" id="3915410">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3915416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915420">if</span>&nbsp;<span class="ident" id="3915423">err</span>&nbsp;<span class="op" id="3915427">:=</span>&nbsp;<span class="ident" id="3915430">hs</span><span class="op" id="3915432">.</span><span class="ident" id="3915433">sendFinished</span><span class="op" id="3915445">(</span><span class="ident" id="3915446">nil</span><span class="op" id="3915449">)</span><span class="op" id="3915450">;</span>&nbsp;<span class="ident" id="3915452">err</span>&nbsp;<span class="op" id="3915456">!=</span>&nbsp;<span class="ident" id="3915459">nil</span>&nbsp;<span class="op" id="3915463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915468">return</span>&nbsp;<span class="ident" id="3915475">err</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3915481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3915484">}</span>&nbsp;<span class="keyword" id="3915486">else</span>&nbsp;<span class="op" id="3915491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915495">if</span>&nbsp;<span class="ident" id="3915498">err</span>&nbsp;<span class="op" id="3915502">:=</span>&nbsp;<span class="ident" id="3915505">hs</span><span class="op" id="3915507">.</span><span class="ident" id="3915508">doFullHandshake</span><span class="op" id="3915523">(</span><span class="op" id="3915524">)</span><span class="op" id="3915525">;</span>&nbsp;<span class="ident" id="3915527">err</span>&nbsp;<span class="op" id="3915531">!=</span>&nbsp;<span class="ident" id="3915534">nil</span>&nbsp;<span class="op" id="3915538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915543">return</span>&nbsp;<span class="ident" id="3915550">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3915556">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915560">if</span>&nbsp;<span class="ident" id="3915563">err</span>&nbsp;<span class="op" id="3915567">:=</span>&nbsp;<span class="ident" id="3915570">hs</span><span class="op" id="3915572">.</span><span class="ident" id="3915573">establishKeys</span><span class="op" id="3915586">(</span><span class="op" id="3915587">)</span><span class="op" id="3915588">;</span>&nbsp;<span class="ident" id="3915590">err</span>&nbsp;<span class="op" id="3915594">!=</span>&nbsp;<span class="ident" id="3915597">nil</span>&nbsp;<span class="op" id="3915601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915606">return</span>&nbsp;<span class="ident" id="3915613">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3915619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915623">if</span>&nbsp;<span class="ident" id="3915626">err</span>&nbsp;<span class="op" id="3915630">:=</span>&nbsp;<span class="ident" id="3915633">hs</span><span class="op" id="3915635">.</span><span class="ident" id="3915636">sendFinished</span><span class="op" id="3915648">(</span><span class="ident" id="3915649">c</span><span class="op" id="3915650">.</span><span class="ident" id="3915651">firstFinished</span><span class="op" id="3915664">[</span><span class="op" id="3915665">:</span><span class="op" id="3915666">]</span><span class="op" id="3915667">)</span><span class="op" id="3915668">;</span>&nbsp;<span class="ident" id="3915670">err</span>&nbsp;<span class="op" id="3915674">!=</span>&nbsp;<span class="ident" id="3915677">nil</span>&nbsp;<span class="op" id="3915681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915686">return</span>&nbsp;<span class="ident" id="3915693">err</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3915699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915703">if</span>&nbsp;<span class="ident" id="3915706">err</span>&nbsp;<span class="op" id="3915710">:=</span>&nbsp;<span class="ident" id="3915713">hs</span><span class="op" id="3915715">.</span><span class="ident" id="3915716">readSessionTicket</span><span class="op" id="3915733">(</span><span class="op" id="3915734">)</span><span class="op" id="3915735">;</span>&nbsp;<span class="ident" id="3915737">err</span>&nbsp;<span class="op" id="3915741">!=</span>&nbsp;<span class="ident" id="3915744">nil</span>&nbsp;<span class="op" id="3915748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915753">return</span>&nbsp;<span class="ident" id="3915760">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3915766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915770">if</span>&nbsp;<span class="ident" id="3915773">err</span>&nbsp;<span class="op" id="3915777">:=</span>&nbsp;<span class="ident" id="3915780">hs</span><span class="op" id="3915782">.</span><span class="ident" id="3915783">readFinished</span><span class="op" id="3915795">(</span><span class="ident" id="3915796">nil</span><span class="op" id="3915799">)</span><span class="op" id="3915800">;</span>&nbsp;<span class="ident" id="3915802">err</span>&nbsp;<span class="op" id="3915806">!=</span>&nbsp;<span class="ident" id="3915809">nil</span>&nbsp;<span class="op" id="3915813">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915818">return</span>&nbsp;<span class="ident" id="3915825">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3915831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3915834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3915838">if</span>&nbsp;<span class="ident" id="3915841">sessionCache</span>&nbsp;<span class="op" id="3915854">!=</span>&nbsp;<span class="ident" id="3915857">nil</span>&nbsp;<span class="op" id="3915861">&amp;&amp;</span>&nbsp;<span class="ident" id="3915864">hs</span><span class="op" id="3915866">.</span><span class="ident" id="3915867">session</span>&nbsp;<span class="op" id="3915875">!=</span>&nbsp;<span class="ident" id="3915878">nil</span>&nbsp;<span class="op" id="3915882">&amp;&amp;</span>&nbsp;<span class="ident" id="3915885">session</span>&nbsp;<span class="op" id="3915893">!=</span>&nbsp;<span class="ident" id="3915896">hs</span><span class="op" id="3915898">.</span><span class="ident" id="3915899">session</span>&nbsp;<span class="op" id="3915907">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3915911">sessionCache</span><span class="op" id="3915923">.</span><span class="ident" id="3915924">Put</span><span class="op" id="3915927">(</span><span class="ident" id="3915928">cacheKey</span><span class="op" id="3915936">,</span>&nbsp;<span class="ident" id="3915938">hs</span><span class="op" id="3915940">.</span><span class="ident" id="3915941">session</span><span class="op" id="3915948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3915951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3915955">c</span><span class="op" id="3915956">.</span><span class="ident" id="3915957">didResume</span>&nbsp;<span class="op" id="3915967">=</span>&nbsp;<span class="ident" id="3915969">isResume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3915979">c</span><span class="op" id="3915980">.</span><span class="ident" id="3915981">handshakeComplete</span>&nbsp;<span class="op" id="3915999">=</span>&nbsp;<span class="builtintype" id="3916001">true</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3916007">c</span><span class="op" id="3916008">.</span><span class="ident" id="3916009">cipherSuite</span>&nbsp;<span class="op" id="3916021">=</span>&nbsp;<span class="ident" id="3916023">suite</span><span class="op" id="3916028">.</span><span class="ident" id="3916029">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3916033">return</span>&nbsp;<span class="ident" id="3916040">nil</span><br>
<span class="lineno"></span><span class="op" id="3916044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3916047">func</span>&nbsp;<span class="op" id="3916052">(</span><span class="ident" id="3916053">hs</span>&nbsp;<span class="op" id="3916056">*</span><span class="ident" id="3916057">clientHandshakeState</span><span class="op" id="3916077">)</span>&nbsp;<span class="ident" id="3916079">doFullHandshake</span><span class="op" id="3916094">(</span><span class="op" id="3916095">)</span>&nbsp;<span class="builtintype" id="3916097">error</span>&nbsp;<span class="op" id="3916103">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3916106">c</span>&nbsp;<span class="op" id="3916108">:=</span>&nbsp;<span class="ident" id="3916111">hs</span><span class="op" id="3916113">.</span><span class="ident" id="3916114">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3916118">msg</span><span class="op" id="3916121">,</span>&nbsp;<span class="ident" id="3916123">err</span>&nbsp;<span class="op" id="3916127">:=</span>&nbsp;<span class="ident" id="3916130">c</span><span class="op" id="3916131">.</span><span class="ident" id="3916132">readHandshake</span><span class="op" id="3916145">(</span><span class="op" id="3916146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3916149">if</span>&nbsp;<span class="ident" id="3916152">err</span>&nbsp;<span class="op" id="3916156">!=</span>&nbsp;<span class="ident" id="3916159">nil</span>&nbsp;<span class="op" id="3916163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3916167">return</span>&nbsp;<span class="ident" id="3916174">err</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3916179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3916182">certMsg</span><span class="op" id="3916189">,</span>&nbsp;<span class="ident" id="3916191">ok</span>&nbsp;<span class="op" id="3916194">:=</span>&nbsp;<span class="ident" id="3916197">msg</span><span class="op" id="3916200">.</span><span class="op" id="3916201">(</span><span class="op" id="3916202">*</span><span class="ident" id="3916203">certificateMsg</span><span class="op" id="3916217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3916220">if</span>&nbsp;<span class="op" id="3916223">!</span><span class="ident" id="3916224">ok</span>&nbsp;<span class="op" id="3916227">||</span>&nbsp;<span class="builtinfunc" id="3916230">len</span><span class="op" id="3916233">(</span><span class="ident" id="3916234">certMsg</span><span class="op" id="3916241">.</span><span class="ident" id="3916242">certificates</span><span class="op" id="3916254">)</span>&nbsp;<span class="op" id="3916256">==</span>&nbsp;<span class="num" id="3916259">0</span>&nbsp;<span class="op" id="3916261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3916265">c</span><span class="op" id="3916266">.</span><span class="ident" id="3916267">sendAlert</span><span class="op" id="3916276">(</span><span class="ident" id="3916277">alertUnexpectedMessage</span><span class="op" id="3916299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3916303">return</span>&nbsp;<span class="ident" id="3916310">unexpectedMessageError</span><span class="op" id="3916332">(</span><span class="ident" id="3916333">certMsg</span><span class="op" id="3916340">,</span>&nbsp;<span class="ident" id="3916342">msg</span><span class="op" id="3916345">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3916348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3916351">hs</span><span class="op" id="3916353">.</span><span class="ident" id="3916354">finishedHash</span><span class="op" id="3916366">.</span><span class="ident" id="3916367">Write</span><span class="op" id="3916372">(</span><span class="ident" id="3916373">certMsg</span><span class="op" id="3916380">.</span><span class="ident" id="3916381">marshal</span><span class="op" id="3916388">(</span><span class="op" id="3916389">)</span><span class="op" id="3916390">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3916394">certs</span>&nbsp;<span class="op" id="3916400">:=</span>&nbsp;<span class="builtinfunc" id="3916403">make</span><span class="op" id="3916407">(</span><span class="op" id="3916408">[</span><span class="op" id="3916409">]</span><span class="op" id="3916410">*</span><span class="ident" id="3916411">x509</span><span class="op" id="3916415">.</span><span class="ident" id="3916416">Certificate</span><span class="op" id="3916427">,</span>&nbsp;<span class="builtinfunc" id="3916429">len</span><span class="op" id="3916432">(</span><span class="ident" id="3916433">certMsg</span><span class="op" id="3916440">.</span><span class="ident" id="3916441">certificates</span><span class="op" id="3916453">)</span><span class="op" id="3916454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3916457">for</span>&nbsp;<span class="ident" id="3916461">i</span><span class="op" id="3916462">,</span>&nbsp;<span class="ident" id="3916464">asn1Data</span>&nbsp;<span class="op" id="3916473">:=</span>&nbsp;<span class="keyword" id="3916476">range</span>&nbsp;<span class="ident" id="3916482">certMsg</span><span class="op" id="3916489">.</span><span class="ident" id="3916490">certificates</span>&nbsp;<span class="op" id="3916503">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3916507">cert</span><span class="op" id="3916511">,</span>&nbsp;<span class="ident" id="3916513">err</span>&nbsp;<span class="op" id="3916517">:=</span>&nbsp;<span class="ident" id="3916520">x509</span><span class="op" id="3916524">.</span><span class="ident" id="3916525">ParseCertificate</span><span class="op" id="3916541">(</span><span class="ident" id="3916542">asn1Data</span><span class="op" id="3916550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3916554">if</span>&nbsp;<span class="ident" id="3916557">err</span>&nbsp;<span class="op" id="3916561">!=</span>&nbsp;<span class="ident" id="3916564">nil</span>&nbsp;<span class="op" id="3916568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3916573">c</span><span class="op" id="3916574">.</span><span class="ident" id="3916575">sendAlert</span><span class="op" id="3916584">(</span><span class="ident" id="3916585">alertBadCertificate</span><span class="op" id="3916604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3916609">return</span>&nbsp;<span class="ident" id="3916616">errors</span><span class="op" id="3916622">.</span><span class="ident" id="3916623">New</span><span class="op" id="3916626">(</span><span class="string" id="3916627">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;from&nbsp;server:&nbsp;&#34;</span>&nbsp;<span class="op" id="3916676">+</span>&nbsp;<span class="ident" id="3916678">err</span><span class="op" id="3916681">.</span><span class="ident" id="3916682">Error</span><span class="op" id="3916687">(</span><span class="op" id="3916688">)</span><span class="op" id="3916689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3916693">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3916697">certs</span><span class="op" id="3916702">[</span><span class="ident" id="3916703">i</span><span class="op" id="3916704">]</span>&nbsp;<span class="op" id="3916706">=</span>&nbsp;<span class="ident" id="3916708">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3916714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3916718">if</span>&nbsp;<span class="op" id="3916721">!</span><span class="ident" id="3916722">c</span><span class="op" id="3916723">.</span><span class="ident" id="3916724">config</span><span class="op" id="3916730">.</span><span class="ident" id="3916731">InsecureSkipVerify</span>&nbsp;<span class="op" id="3916750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3916754">opts</span>&nbsp;<span class="op" id="3916759">:=</span>&nbsp;<span class="ident" id="3916762">x509</span><span class="op" id="3916766">.</span><span class="ident" id="3916767">VerifyOptions</span><span class="op" id="3916780">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3916785">Roots</span><span class="op" id="3916790">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3916800">c</span><span class="op" id="3916801">.</span><span class="ident" id="3916802">config</span><span class="op" id="3916808">.</span><span class="ident" id="3916809">RootCAs</span><span class="op" id="3916816">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3916821">CurrentTime</span><span class="op" id="3916832">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3916836">c</span><span class="op" id="3916837">.</span><span class="ident" id="3916838">config</span><span class="op" id="3916844">.</span><span class="ident" id="3916845">time</span><span class="op" id="3916849">(</span><span class="op" id="3916850">)</span><span class="op" id="3916851">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3916856">DNSName</span><span class="op" id="3916863">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3916871">c</span><span class="op" id="3916872">.</span><span class="ident" id="3916873">config</span><span class="op" id="3916879">.</span><span class="ident" id="3916880">ServerName</span><span class="op" id="3916890">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3916895">Intermediates</span><span class="op" id="3916908">:</span>&nbsp;<span class="ident" id="3916910">x509</span><span class="op" id="3916914">.</span><span class="ident" id="3916915">NewCertPool</span><span class="op" id="3916926">(</span><span class="op" id="3916927">)</span><span class="op" id="3916928">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3916932">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3916937">for</span>&nbsp;<span class="ident" id="3916941">i</span><span class="op" id="3916942">,</span>&nbsp;<span class="ident" id="3916944">cert</span>&nbsp;<span class="op" id="3916949">:=</span>&nbsp;<span class="keyword" id="3916952">range</span>&nbsp;<span class="ident" id="3916958">certs</span>&nbsp;<span class="op" id="3916964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3916969">if</span>&nbsp;<span class="ident" id="3916972">i</span>&nbsp;<span class="op" id="3916974">==</span>&nbsp;<span class="num" id="3916977">0</span>&nbsp;<span class="op" id="3916979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3916985">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3916997">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3917002">opts</span><span class="op" id="3917006">.</span><span class="ident" id="3917007">Intermediates</span><span class="op" id="3917020">.</span><span class="ident" id="3917021">AddCert</span><span class="op" id="3917028">(</span><span class="ident" id="3917029">cert</span><span class="op" id="3917033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3917037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3917041">c</span><span class="op" id="3917042">.</span><span class="ident" id="3917043">verifiedChains</span><span class="op" id="3917057">,</span>&nbsp;<span class="ident" id="3917059">err</span>&nbsp;<span class="op" id="3917063">=</span>&nbsp;<span class="ident" id="3917065">certs</span><span class="op" id="3917070">[</span><span class="num" id="3917071">0</span><span class="op" id="3917072">]</span><span class="op" id="3917073">.</span><span class="ident" id="3917074">Verify</span><span class="op" id="3917080">(</span><span class="ident" id="3917081">opts</span><span class="op" id="3917085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3917089">if</span>&nbsp;<span class="ident" id="3917092">err</span>&nbsp;<span class="op" id="3917096">!=</span>&nbsp;<span class="ident" id="3917099">nil</span>&nbsp;<span class="op" id="3917103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3917108">c</span><span class="op" id="3917109">.</span><span class="ident" id="3917110">sendAlert</span><span class="op" id="3917119">(</span><span class="ident" id="3917120">alertBadCertificate</span><span class="op" id="3917139">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3917144">return</span>&nbsp;<span class="ident" id="3917151">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3917157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3917160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3917164">switch</span>&nbsp;<span class="ident" id="3917171">certs</span><span class="op" id="3917176">[</span><span class="num" id="3917177">0</span><span class="op" id="3917178">]</span><span class="op" id="3917179">.</span><span class="ident" id="3917180">PublicKey</span><span class="op" id="3917189">.</span><span class="op" id="3917190">(</span><span class="keyword" id="3917191">type</span><span class="op" id="3917195">)</span>&nbsp;<span class="op" id="3917197">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3917200">case</span>&nbsp;<span class="op" id="3917205">*</span><span class="ident" id="3917206">rsa</span><span class="op" id="3917209">.</span><span class="ident" id="3917210">PublicKey</span><span class="op" id="3917219">,</span>&nbsp;<span class="op" id="3917221">*</span><span class="ident" id="3917222">ecdsa</span><span class="op" id="3917227">.</span><span class="ident" id="3917228">PublicKey</span><span class="op" id="3917237">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3917241">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3917248">default</span><span class="op" id="3917255">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3917259">c</span><span class="op" id="3917260">.</span><span class="ident" id="3917261">sendAlert</span><span class="op" id="3917270">(</span><span class="ident" id="3917271">alertUnsupportedCertificate</span><span class="op" id="3917298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3917302">return</span>&nbsp;<span class="ident" id="3917309">fmt</span><span class="op" id="3917312">.</span><span class="ident" id="3917313">Errorf</span><span class="op" id="3917319">(</span><span class="string" id="3917320">&#34;tls:&nbsp;server&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;type&nbsp;of&nbsp;public&nbsp;key:&nbsp;%T&#34;</span><span class="op" id="3917394">,</span>&nbsp;<span class="ident" id="3917396">certs</span><span class="op" id="3917401">[</span><span class="num" id="3917402">0</span><span class="op" id="3917403">]</span><span class="op" id="3917404">.</span><span class="ident" id="3917405">PublicKey</span><span class="op" id="3917414">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3917417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3917421">c</span><span class="op" id="3917422">.</span><span class="ident" id="3917423">peerCertificates</span>&nbsp;<span class="op" id="3917440">=</span>&nbsp;<span class="ident" id="3917442">certs</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3917450">if</span>&nbsp;<span class="ident" id="3917453">hs</span><span class="op" id="3917455">.</span><span class="ident" id="3917456">serverHello</span><span class="op" id="3917467">.</span><span class="ident" id="3917468">ocspStapling</span>&nbsp;<span class="op" id="3917481">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3917485">msg</span><span class="op" id="3917488">,</span>&nbsp;<span class="ident" id="3917490">err</span>&nbsp;<span class="op" id="3917494">=</span>&nbsp;<span class="ident" id="3917496">c</span><span class="op" id="3917497">.</span><span class="ident" id="3917498">readHandshake</span><span class="op" id="3917511">(</span><span class="op" id="3917512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3917516">if</span>&nbsp;<span class="ident" id="3917519">err</span>&nbsp;<span class="op" id="3917523">!=</span>&nbsp;<span class="ident" id="3917526">nil</span>&nbsp;<span class="op" id="3917530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3917535">return</span>&nbsp;<span class="ident" id="3917542">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3917548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3917552">cs</span><span class="op" id="3917554">,</span>&nbsp;<span class="ident" id="3917556">ok</span>&nbsp;<span class="op" id="3917559">:=</span>&nbsp;<span class="ident" id="3917562">msg</span><span class="op" id="3917565">.</span><span class="op" id="3917566">(</span><span class="op" id="3917567">*</span><span class="ident" id="3917568">certificateStatusMsg</span><span class="op" id="3917588">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3917592">if</span>&nbsp;<span class="op" id="3917595">!</span><span class="ident" id="3917596">ok</span>&nbsp;<span class="op" id="3917599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3917604">c</span><span class="op" id="3917605">.</span><span class="ident" id="3917606">sendAlert</span><span class="op" id="3917615">(</span><span class="ident" id="3917616">alertUnexpectedMessage</span><span class="op" id="3917638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3917643">return</span>&nbsp;<span class="ident" id="3917650">unexpectedMessageError</span><span class="op" id="3917672">(</span><span class="ident" id="3917673">cs</span><span class="op" id="3917675">,</span>&nbsp;<span class="ident" id="3917677">msg</span><span class="op" id="3917680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3917684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3917688">hs</span><span class="op" id="3917690">.</span><span class="ident" id="3917691">finishedHash</span><span class="op" id="3917703">.</span><span class="ident" id="3917704">Write</span><span class="op" id="3917709">(</span><span class="ident" id="3917710">cs</span><span class="op" id="3917712">.</span><span class="ident" id="3917713">marshal</span><span class="op" id="3917720">(</span><span class="op" id="3917721">)</span><span class="op" id="3917722">)</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3917727">if</span>&nbsp;<span class="ident" id="3917730">cs</span><span class="op" id="3917732">.</span><span class="ident" id="3917733">statusType</span>&nbsp;<span class="op" id="3917744">==</span>&nbsp;<span class="ident" id="3917747">statusTypeOCSP</span>&nbsp;<span class="op" id="3917762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3917767">c</span><span class="op" id="3917768">.</span><span class="ident" id="3917769">ocspResponse</span>&nbsp;<span class="op" id="3917782">=</span>&nbsp;<span class="ident" id="3917784">cs</span><span class="op" id="3917786">.</span><span class="ident" id="3917787">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3917798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3917801">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3917805">msg</span><span class="op" id="3917808">,</span>&nbsp;<span class="ident" id="3917810">err</span>&nbsp;<span class="op" id="3917814">=</span>&nbsp;<span class="ident" id="3917816">c</span><span class="op" id="3917817">.</span><span class="ident" id="3917818">readHandshake</span><span class="op" id="3917831">(</span><span class="op" id="3917832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3917835">if</span>&nbsp;<span class="ident" id="3917838">err</span>&nbsp;<span class="op" id="3917842">!=</span>&nbsp;<span class="ident" id="3917845">nil</span>&nbsp;<span class="op" id="3917849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3917853">return</span>&nbsp;<span class="ident" id="3917860">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3917865">}</span><br>
<span class="lineno">300</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3917869">keyAgreement</span>&nbsp;<span class="op" id="3917882">:=</span>&nbsp;<span class="ident" id="3917885">hs</span><span class="op" id="3917887">.</span><span class="ident" id="3917888">suite</span><span class="op" id="3917893">.</span><span class="ident" id="3917894">ka</span><span class="op" id="3917896">(</span><span class="ident" id="3917897">c</span><span class="op" id="3917898">.</span><span class="ident" id="3917899">vers</span><span class="op" id="3917903">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3917907">skx</span><span class="op" id="3917910">,</span>&nbsp;<span class="ident" id="3917912">ok</span>&nbsp;<span class="op" id="3917915">:=</span>&nbsp;<span class="ident" id="3917918">msg</span><span class="op" id="3917921">.</span><span class="op" id="3917922">(</span><span class="op" id="3917923">*</span><span class="ident" id="3917924">serverKeyExchangeMsg</span><span class="op" id="3917944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3917947">if</span>&nbsp;<span class="ident" id="3917950">ok</span>&nbsp;<span class="op" id="3917953">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3917957">hs</span><span class="op" id="3917959">.</span><span class="ident" id="3917960">finishedHash</span><span class="op" id="3917972">.</span><span class="ident" id="3917973">Write</span><span class="op" id="3917978">(</span><span class="ident" id="3917979">skx</span><span class="op" id="3917982">.</span><span class="ident" id="3917983">marshal</span><span class="op" id="3917990">(</span><span class="op" id="3917991">)</span><span class="op" id="3917992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3917996">err</span>&nbsp;<span class="op" id="3918000">=</span>&nbsp;<span class="ident" id="3918002">keyAgreement</span><span class="op" id="3918014">.</span><span class="ident" id="3918015">processServerKeyExchange</span><span class="op" id="3918039">(</span><span class="ident" id="3918040">c</span><span class="op" id="3918041">.</span><span class="ident" id="3918042">config</span><span class="op" id="3918048">,</span>&nbsp;<span class="ident" id="3918050">hs</span><span class="op" id="3918052">.</span><span class="ident" id="3918053">hello</span><span class="op" id="3918058">,</span>&nbsp;<span class="ident" id="3918060">hs</span><span class="op" id="3918062">.</span><span class="ident" id="3918063">serverHello</span><span class="op" id="3918074">,</span>&nbsp;<span class="ident" id="3918076">certs</span><span class="op" id="3918081">[</span><span class="num" id="3918082">0</span><span class="op" id="3918083">]</span><span class="op" id="3918084">,</span>&nbsp;<span class="ident" id="3918086">skx</span><span class="op" id="3918089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3918093">if</span>&nbsp;<span class="ident" id="3918096">err</span>&nbsp;<span class="op" id="3918100">!=</span>&nbsp;<span class="ident" id="3918103">nil</span>&nbsp;<span class="op" id="3918107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3918112">c</span><span class="op" id="3918113">.</span><span class="ident" id="3918114">sendAlert</span><span class="op" id="3918123">(</span><span class="ident" id="3918124">alertUnexpectedMessage</span><span class="op" id="3918146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3918151">return</span>&nbsp;<span class="ident" id="3918158">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3918164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3918169">msg</span><span class="op" id="3918172">,</span>&nbsp;<span class="ident" id="3918174">err</span>&nbsp;<span class="op" id="3918178">=</span>&nbsp;<span class="ident" id="3918180">c</span><span class="op" id="3918181">.</span><span class="ident" id="3918182">readHandshake</span><span class="op" id="3918195">(</span><span class="op" id="3918196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3918200">if</span>&nbsp;<span class="ident" id="3918203">err</span>&nbsp;<span class="op" id="3918207">!=</span>&nbsp;<span class="ident" id="3918210">nil</span>&nbsp;<span class="op" id="3918214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3918219">return</span>&nbsp;<span class="ident" id="3918226">err</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3918232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3918235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3918239">var</span>&nbsp;<span class="ident" id="3918243">chainToSend</span>&nbsp;<span class="op" id="3918255">*</span><span class="ident" id="3918256">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3918269">var</span>&nbsp;<span class="ident" id="3918273">certRequested</span>&nbsp;<span class="builtintype" id="3918287">bool</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3918293">certReq</span><span class="op" id="3918300">,</span>&nbsp;<span class="ident" id="3918302">ok</span>&nbsp;<span class="op" id="3918305">:=</span>&nbsp;<span class="ident" id="3918308">msg</span><span class="op" id="3918311">.</span><span class="op" id="3918312">(</span><span class="op" id="3918313">*</span><span class="ident" id="3918314">certificateRequestMsg</span><span class="op" id="3918335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3918338">if</span>&nbsp;<span class="ident" id="3918341">ok</span>&nbsp;<span class="op" id="3918344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3918348">certRequested</span>&nbsp;<span class="op" id="3918362">=</span>&nbsp;<span class="builtintype" id="3918364">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3918372">//&nbsp;RFC&nbsp;4346&nbsp;on&nbsp;the&nbsp;certificateAuthorities&nbsp;field:</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3918423">//&nbsp;A&nbsp;list&nbsp;of&nbsp;the&nbsp;distinguished&nbsp;names&nbsp;of&nbsp;acceptable&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3918488">//&nbsp;authorities.&nbsp;These&nbsp;distinguished&nbsp;names&nbsp;may&nbsp;specify&nbsp;a&nbsp;desired</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3918554">//&nbsp;distinguished&nbsp;name&nbsp;for&nbsp;a&nbsp;root&nbsp;CA&nbsp;or&nbsp;for&nbsp;a&nbsp;subordinate&nbsp;CA;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3918617">//&nbsp;thus,&nbsp;this&nbsp;message&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;describe&nbsp;both&nbsp;known&nbsp;roots</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3918682">//&nbsp;and&nbsp;a&nbsp;desired&nbsp;authorization&nbsp;space.&nbsp;If&nbsp;the</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3918729">//&nbsp;certificate_authorities&nbsp;list&nbsp;is&nbsp;empty&nbsp;then&nbsp;the&nbsp;client&nbsp;MAY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3918792">//&nbsp;send&nbsp;any&nbsp;certificate&nbsp;of&nbsp;the&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3918837">//&nbsp;ClientCertificateType,&nbsp;unless&nbsp;there&nbsp;is&nbsp;some&nbsp;external</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3918895">//&nbsp;arrangement&nbsp;to&nbsp;the&nbsp;contrary.</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3918930">hs</span><span class="op" id="3918932">.</span><span class="ident" id="3918933">finishedHash</span><span class="op" id="3918945">.</span><span class="ident" id="3918946">Write</span><span class="op" id="3918951">(</span><span class="ident" id="3918952">certReq</span><span class="op" id="3918959">.</span><span class="ident" id="3918960">marshal</span><span class="op" id="3918967">(</span><span class="op" id="3918968">)</span><span class="op" id="3918969">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3918974">var</span>&nbsp;<span class="ident" id="3918978">rsaAvail</span><span class="op" id="3918986">,</span>&nbsp;<span class="ident" id="3918988">ecdsaAvail</span>&nbsp;<span class="builtintype" id="3918999">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3919006">for</span>&nbsp;<span class="ident" id="3919010">_</span><span class="op" id="3919011">,</span>&nbsp;<span class="ident" id="3919013">certType</span>&nbsp;<span class="op" id="3919022">:=</span>&nbsp;<span class="keyword" id="3919025">range</span>&nbsp;<span class="ident" id="3919031">certReq</span><span class="op" id="3919038">.</span><span class="ident" id="3919039">certificateTypes</span>&nbsp;<span class="op" id="3919056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3919061">switch</span>&nbsp;<span class="ident" id="3919068">certType</span>&nbsp;<span class="op" id="3919077">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3919082">case</span>&nbsp;<span class="ident" id="3919087">certTypeRSASign</span><span class="op" id="3919102">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3919108">rsaAvail</span>&nbsp;<span class="op" id="3919117">=</span>&nbsp;<span class="builtintype" id="3919119">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3919127">case</span>&nbsp;<span class="ident" id="3919132">certTypeECDSASign</span><span class="op" id="3919149">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3919155">ecdsaAvail</span>&nbsp;<span class="op" id="3919166">=</span>&nbsp;<span class="builtintype" id="3919168">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3919176">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3919180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3919185">//&nbsp;We&nbsp;need&nbsp;to&nbsp;search&nbsp;our&nbsp;list&nbsp;of&nbsp;client&nbsp;certs&nbsp;for&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3919241">//&nbsp;where&nbsp;SignatureAlgorithm&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;the&nbsp;server&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3919307">//&nbsp;Issuer&nbsp;is&nbsp;in&nbsp;certReq.certificateAuthorities</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3919355">findCert</span><span class="op" id="3919363">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3919367">for</span>&nbsp;<span class="ident" id="3919371">i</span><span class="op" id="3919372">,</span>&nbsp;<span class="ident" id="3919374">chain</span>&nbsp;<span class="op" id="3919380">:=</span>&nbsp;<span class="keyword" id="3919383">range</span>&nbsp;<span class="ident" id="3919389">c</span><span class="op" id="3919390">.</span><span class="ident" id="3919391">config</span><span class="op" id="3919397">.</span><span class="ident" id="3919398">Certificates</span>&nbsp;<span class="op" id="3919411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3919416">if</span>&nbsp;<span class="op" id="3919419">!</span><span class="ident" id="3919420">rsaAvail</span>&nbsp;<span class="op" id="3919429">&amp;&amp;</span>&nbsp;<span class="op" id="3919432">!</span><span class="ident" id="3919433">ecdsaAvail</span>&nbsp;<span class="op" id="3919444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3919450">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3919462">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3919468">for</span>&nbsp;<span class="ident" id="3919472">j</span><span class="op" id="3919473">,</span>&nbsp;<span class="ident" id="3919475">cert</span>&nbsp;<span class="op" id="3919480">:=</span>&nbsp;<span class="keyword" id="3919483">range</span>&nbsp;<span class="ident" id="3919489">chain</span><span class="op" id="3919494">.</span><span class="ident" id="3919495">Certificate</span>&nbsp;<span class="op" id="3919507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3919513">x509Cert</span>&nbsp;<span class="op" id="3919522">:=</span>&nbsp;<span class="ident" id="3919525">chain</span><span class="op" id="3919530">.</span><span class="ident" id="3919531">Leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3919540">//&nbsp;parse&nbsp;the&nbsp;certificate&nbsp;if&nbsp;this&nbsp;isn&#39;t&nbsp;the&nbsp;leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3919592">//&nbsp;node,&nbsp;or&nbsp;if&nbsp;chain.Leaf&nbsp;was&nbsp;nil</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3919630">if</span>&nbsp;<span class="ident" id="3919633">j</span>&nbsp;<span class="op" id="3919635">!=</span>&nbsp;<span class="num" id="3919638">0</span>&nbsp;<span class="op" id="3919640">||</span>&nbsp;<span class="ident" id="3919643">x509Cert</span>&nbsp;<span class="op" id="3919652">==</span>&nbsp;<span class="ident" id="3919655">nil</span>&nbsp;<span class="op" id="3919659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3919666">if</span>&nbsp;<span class="ident" id="3919669">x509Cert</span><span class="op" id="3919677">,</span>&nbsp;<span class="ident" id="3919679">err</span>&nbsp;<span class="op" id="3919683">=</span>&nbsp;<span class="ident" id="3919685">x509</span><span class="op" id="3919689">.</span><span class="ident" id="3919690">ParseCertificate</span><span class="op" id="3919706">(</span><span class="ident" id="3919707">cert</span><span class="op" id="3919711">)</span><span class="op" id="3919712">;</span>&nbsp;<span class="ident" id="3919714">err</span>&nbsp;<span class="op" id="3919718">!=</span>&nbsp;<span class="ident" id="3919721">nil</span>&nbsp;<span class="op" id="3919725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3919733">c</span><span class="op" id="3919734">.</span><span class="ident" id="3919735">sendAlert</span><span class="op" id="3919744">(</span><span class="ident" id="3919745">alertInternalError</span><span class="op" id="3919763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3919771">return</span>&nbsp;<span class="ident" id="3919778">errors</span><span class="op" id="3919784">.</span><span class="ident" id="3919785">New</span><span class="op" id="3919788">(</span><span class="string" id="3919789">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate&nbsp;#&#34;</span>&nbsp;<span class="op" id="3919833">+</span>&nbsp;<span class="ident" id="3919835">strconv</span><span class="op" id="3919842">.</span><span class="ident" id="3919843">Itoa</span><span class="op" id="3919847">(</span><span class="ident" id="3919848">i</span><span class="op" id="3919849">)</span>&nbsp;<span class="op" id="3919851">+</span>&nbsp;<span class="string" id="3919853">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="3919858">+</span>&nbsp;<span class="ident" id="3919860">err</span><span class="op" id="3919863">.</span><span class="ident" id="3919864">Error</span><span class="op" id="3919869">(</span><span class="op" id="3919870">)</span><span class="op" id="3919871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3919878">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3919884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3919891">switch</span>&nbsp;<span class="op" id="3919898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3919904">case</span>&nbsp;<span class="ident" id="3919909">rsaAvail</span>&nbsp;<span class="op" id="3919918">&amp;&amp;</span>&nbsp;<span class="ident" id="3919921">x509Cert</span><span class="op" id="3919929">.</span><span class="ident" id="3919930">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="3919949">==</span>&nbsp;<span class="ident" id="3919952">x509</span><span class="op" id="3919956">.</span><span class="ident" id="3919957">RSA</span><span class="op" id="3919960">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3919966">case</span>&nbsp;<span class="ident" id="3919971">ecdsaAvail</span>&nbsp;<span class="op" id="3919982">&amp;&amp;</span>&nbsp;<span class="ident" id="3919985">x509Cert</span><span class="op" id="3919993">.</span><span class="ident" id="3919994">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="3920013">==</span>&nbsp;<span class="ident" id="3920016">x509</span><span class="op" id="3920020">.</span><span class="ident" id="3920021">ECDSA</span><span class="op" id="3920026">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3920032">default</span><span class="op" id="3920039">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3920046">continue</span>&nbsp;<span class="ident" id="3920055">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3920068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3920075">if</span>&nbsp;<span class="builtinfunc" id="3920078">len</span><span class="op" id="3920081">(</span><span class="ident" id="3920082">certReq</span><span class="op" id="3920089">.</span><span class="ident" id="3920090">certificateAuthorities</span><span class="op" id="3920112">)</span>&nbsp;<span class="op" id="3920114">==</span>&nbsp;<span class="num" id="3920117">0</span>&nbsp;<span class="op" id="3920119">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3920126">//&nbsp;they&nbsp;gave&nbsp;us&nbsp;an&nbsp;empty&nbsp;list,&nbsp;so&nbsp;just&nbsp;take&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3920179">//&nbsp;first&nbsp;cert&nbsp;from&nbsp;c.config.Certificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3920225">chainToSend</span>&nbsp;<span class="op" id="3920237">=</span>&nbsp;<span class="op" id="3920239">&amp;</span><span class="ident" id="3920240">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3920251">break</span>&nbsp;<span class="ident" id="3920257">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3920270">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3920277">for</span>&nbsp;<span class="ident" id="3920281">_</span><span class="op" id="3920282">,</span>&nbsp;<span class="ident" id="3920284">ca</span>&nbsp;<span class="op" id="3920287">:=</span>&nbsp;<span class="keyword" id="3920290">range</span>&nbsp;<span class="ident" id="3920296">certReq</span><span class="op" id="3920303">.</span><span class="ident" id="3920304">certificateAuthorities</span>&nbsp;<span class="op" id="3920327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3920334">if</span>&nbsp;<span class="ident" id="3920337">bytes</span><span class="op" id="3920342">.</span><span class="ident" id="3920343">Equal</span><span class="op" id="3920348">(</span><span class="ident" id="3920349">x509Cert</span><span class="op" id="3920357">.</span><span class="ident" id="3920358">RawIssuer</span><span class="op" id="3920367">,</span>&nbsp;<span class="ident" id="3920369">ca</span><span class="op" id="3920371">)</span>&nbsp;<span class="op" id="3920373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3920381">chainToSend</span>&nbsp;<span class="op" id="3920393">=</span>&nbsp;<span class="op" id="3920395">&amp;</span><span class="ident" id="3920396">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3920408">break</span>&nbsp;<span class="ident" id="3920414">findCert</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3920428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3920434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3920439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3920443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3920448">msg</span><span class="op" id="3920451">,</span>&nbsp;<span class="ident" id="3920453">err</span>&nbsp;<span class="op" id="3920457">=</span>&nbsp;<span class="ident" id="3920459">c</span><span class="op" id="3920460">.</span><span class="ident" id="3920461">readHandshake</span><span class="op" id="3920474">(</span><span class="op" id="3920475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3920479">if</span>&nbsp;<span class="ident" id="3920482">err</span>&nbsp;<span class="op" id="3920486">!=</span>&nbsp;<span class="ident" id="3920489">nil</span>&nbsp;<span class="op" id="3920493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3920498">return</span>&nbsp;<span class="ident" id="3920505">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3920511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3920514">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3920518">shd</span><span class="op" id="3920521">,</span>&nbsp;<span class="ident" id="3920523">ok</span>&nbsp;<span class="op" id="3920526">:=</span>&nbsp;<span class="ident" id="3920529">msg</span><span class="op" id="3920532">.</span><span class="op" id="3920533">(</span><span class="op" id="3920534">*</span><span class="ident" id="3920535">serverHelloDoneMsg</span><span class="op" id="3920553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3920556">if</span>&nbsp;<span class="op" id="3920559">!</span><span class="ident" id="3920560">ok</span>&nbsp;<span class="op" id="3920563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3920567">c</span><span class="op" id="3920568">.</span><span class="ident" id="3920569">sendAlert</span><span class="op" id="3920578">(</span><span class="ident" id="3920579">alertUnexpectedMessage</span><span class="op" id="3920601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3920605">return</span>&nbsp;<span class="ident" id="3920612">unexpectedMessageError</span><span class="op" id="3920634">(</span><span class="ident" id="3920635">shd</span><span class="op" id="3920638">,</span>&nbsp;<span class="ident" id="3920640">msg</span><span class="op" id="3920643">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3920646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3920649">hs</span><span class="op" id="3920651">.</span><span class="ident" id="3920652">finishedHash</span><span class="op" id="3920664">.</span><span class="ident" id="3920665">Write</span><span class="op" id="3920670">(</span><span class="ident" id="3920671">shd</span><span class="op" id="3920674">.</span><span class="ident" id="3920675">marshal</span><span class="op" id="3920682">(</span><span class="op" id="3920683">)</span><span class="op" id="3920684">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3920688">//&nbsp;If&nbsp;the&nbsp;server&nbsp;requested&nbsp;a&nbsp;certificate&nbsp;then&nbsp;we&nbsp;have&nbsp;to&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3920753">//&nbsp;Certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3920821">//&nbsp;certificate&nbsp;to&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3920846">if</span>&nbsp;<span class="ident" id="3920849">certRequested</span>&nbsp;<span class="op" id="3920863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3920867">certMsg</span>&nbsp;<span class="op" id="3920875">=</span>&nbsp;<span class="builtinfunc" id="3920877">new</span><span class="op" id="3920880">(</span><span class="ident" id="3920881">certificateMsg</span><span class="op" id="3920895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3920899">if</span>&nbsp;<span class="ident" id="3920902">chainToSend</span>&nbsp;<span class="op" id="3920914">!=</span>&nbsp;<span class="ident" id="3920917">nil</span>&nbsp;<span class="op" id="3920921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3920926">certMsg</span><span class="op" id="3920933">.</span><span class="ident" id="3920934">certificates</span>&nbsp;<span class="op" id="3920947">=</span>&nbsp;<span class="ident" id="3920949">chainToSend</span><span class="op" id="3920960">.</span><span class="ident" id="3920961">Certificate</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3920975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3920979">hs</span><span class="op" id="3920981">.</span><span class="ident" id="3920982">finishedHash</span><span class="op" id="3920994">.</span><span class="ident" id="3920995">Write</span><span class="op" id="3921000">(</span><span class="ident" id="3921001">certMsg</span><span class="op" id="3921008">.</span><span class="ident" id="3921009">marshal</span><span class="op" id="3921016">(</span><span class="op" id="3921017">)</span><span class="op" id="3921018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921022">c</span><span class="op" id="3921023">.</span><span class="ident" id="3921024">writeRecord</span><span class="op" id="3921035">(</span><span class="ident" id="3921036">recordTypeHandshake</span><span class="op" id="3921055">,</span>&nbsp;<span class="ident" id="3921057">certMsg</span><span class="op" id="3921064">.</span><span class="ident" id="3921065">marshal</span><span class="op" id="3921072">(</span><span class="op" id="3921073">)</span><span class="op" id="3921074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3921077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921081">preMasterSecret</span><span class="op" id="3921096">,</span>&nbsp;<span class="ident" id="3921098">ckx</span><span class="op" id="3921101">,</span>&nbsp;<span class="ident" id="3921103">err</span>&nbsp;<span class="op" id="3921107">:=</span>&nbsp;<span class="ident" id="3921110">keyAgreement</span><span class="op" id="3921122">.</span><span class="ident" id="3921123">generateClientKeyExchange</span><span class="op" id="3921148">(</span><span class="ident" id="3921149">c</span><span class="op" id="3921150">.</span><span class="ident" id="3921151">config</span><span class="op" id="3921157">,</span>&nbsp;<span class="ident" id="3921159">hs</span><span class="op" id="3921161">.</span><span class="ident" id="3921162">hello</span><span class="op" id="3921167">,</span>&nbsp;<span class="ident" id="3921169">certs</span><span class="op" id="3921174">[</span><span class="num" id="3921175">0</span><span class="op" id="3921176">]</span><span class="op" id="3921177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921180">if</span>&nbsp;<span class="ident" id="3921183">err</span>&nbsp;<span class="op" id="3921187">!=</span>&nbsp;<span class="ident" id="3921190">nil</span>&nbsp;<span class="op" id="3921194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921198">c</span><span class="op" id="3921199">.</span><span class="ident" id="3921200">sendAlert</span><span class="op" id="3921209">(</span><span class="ident" id="3921210">alertInternalError</span><span class="op" id="3921228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921232">return</span>&nbsp;<span class="ident" id="3921239">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3921244">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921247">if</span>&nbsp;<span class="ident" id="3921250">ckx</span>&nbsp;<span class="op" id="3921254">!=</span>&nbsp;<span class="ident" id="3921257">nil</span>&nbsp;<span class="op" id="3921261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921265">hs</span><span class="op" id="3921267">.</span><span class="ident" id="3921268">finishedHash</span><span class="op" id="3921280">.</span><span class="ident" id="3921281">Write</span><span class="op" id="3921286">(</span><span class="ident" id="3921287">ckx</span><span class="op" id="3921290">.</span><span class="ident" id="3921291">marshal</span><span class="op" id="3921298">(</span><span class="op" id="3921299">)</span><span class="op" id="3921300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921304">c</span><span class="op" id="3921305">.</span><span class="ident" id="3921306">writeRecord</span><span class="op" id="3921317">(</span><span class="ident" id="3921318">recordTypeHandshake</span><span class="op" id="3921337">,</span>&nbsp;<span class="ident" id="3921339">ckx</span><span class="op" id="3921342">.</span><span class="ident" id="3921343">marshal</span><span class="op" id="3921350">(</span><span class="op" id="3921351">)</span><span class="op" id="3921352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3921355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921359">if</span>&nbsp;<span class="ident" id="3921362">chainToSend</span>&nbsp;<span class="op" id="3921374">!=</span>&nbsp;<span class="ident" id="3921377">nil</span>&nbsp;<span class="op" id="3921381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921385">var</span>&nbsp;<span class="ident" id="3921389">signed</span>&nbsp;<span class="op" id="3921396">[</span><span class="op" id="3921397">]</span><span class="builtintype" id="3921398">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921405">certVerify</span>&nbsp;<span class="op" id="3921416">:=</span>&nbsp;<span class="op" id="3921419">&amp;</span><span class="ident" id="3921420">certificateVerifyMsg</span><span class="op" id="3921440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921445">hasSignatureAndHash</span><span class="op" id="3921464">:</span>&nbsp;<span class="ident" id="3921466">c</span><span class="op" id="3921467">.</span><span class="ident" id="3921468">vers</span>&nbsp;<span class="op" id="3921473">&gt;=</span>&nbsp;<span class="ident" id="3921476">VersionTLS12</span><span class="op" id="3921488">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3921492">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921497">key</span><span class="op" id="3921500">,</span>&nbsp;<span class="ident" id="3921502">ok</span>&nbsp;<span class="op" id="3921505">:=</span>&nbsp;<span class="ident" id="3921508">chainToSend</span><span class="op" id="3921519">.</span><span class="ident" id="3921520">PrivateKey</span><span class="op" id="3921530">.</span><span class="op" id="3921531">(</span><span class="ident" id="3921532">crypto</span><span class="op" id="3921538">.</span><span class="ident" id="3921539">Signer</span><span class="op" id="3921545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921549">if</span>&nbsp;<span class="op" id="3921552">!</span><span class="ident" id="3921553">ok</span>&nbsp;<span class="op" id="3921556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921561">c</span><span class="op" id="3921562">.</span><span class="ident" id="3921563">sendAlert</span><span class="op" id="3921572">(</span><span class="ident" id="3921573">alertInternalError</span><span class="op" id="3921591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921596">return</span>&nbsp;<span class="ident" id="3921603">fmt</span><span class="op" id="3921606">.</span><span class="ident" id="3921607">Errorf</span><span class="op" id="3921613">(</span><span class="string" id="3921614">&#34;tls:&nbsp;client&nbsp;certificate&nbsp;private&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&nbsp;does&nbsp;not&nbsp;implement&nbsp;crypto.Signer&#34;</span><span class="op" id="3921695">,</span>&nbsp;<span class="ident" id="3921697">chainToSend</span><span class="op" id="3921708">.</span><span class="ident" id="3921709">PrivateKey</span><span class="op" id="3921719">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3921723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921727">switch</span>&nbsp;<span class="ident" id="3921734">key</span><span class="op" id="3921737">.</span><span class="ident" id="3921738">Public</span><span class="op" id="3921744">(</span><span class="op" id="3921745">)</span><span class="op" id="3921746">.</span><span class="op" id="3921747">(</span><span class="keyword" id="3921748">type</span><span class="op" id="3921752">)</span>&nbsp;<span class="op" id="3921754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921758">case</span>&nbsp;<span class="op" id="3921763">*</span><span class="ident" id="3921764">ecdsa</span><span class="op" id="3921769">.</span><span class="ident" id="3921770">PublicKey</span><span class="op" id="3921779">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921784">digest</span><span class="op" id="3921790">,</span>&nbsp;<span class="ident" id="3921792">hashFunc</span><span class="op" id="3921800">,</span>&nbsp;<span class="ident" id="3921802">hashId</span>&nbsp;<span class="op" id="3921809">:=</span>&nbsp;<span class="ident" id="3921812">hs</span><span class="op" id="3921814">.</span><span class="ident" id="3921815">finishedHash</span><span class="op" id="3921827">.</span><span class="ident" id="3921828">hashForClientCertificate</span><span class="op" id="3921852">(</span><span class="ident" id="3921853">signatureECDSA</span><span class="op" id="3921867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921872">signed</span><span class="op" id="3921878">,</span>&nbsp;<span class="ident" id="3921880">err</span>&nbsp;<span class="op" id="3921884">=</span>&nbsp;<span class="ident" id="3921886">key</span><span class="op" id="3921889">.</span><span class="ident" id="3921890">Sign</span><span class="op" id="3921894">(</span><span class="ident" id="3921895">c</span><span class="op" id="3921896">.</span><span class="ident" id="3921897">config</span><span class="op" id="3921903">.</span><span class="ident" id="3921904">rand</span><span class="op" id="3921908">(</span><span class="op" id="3921909">)</span><span class="op" id="3921910">,</span>&nbsp;<span class="ident" id="3921912">digest</span><span class="op" id="3921918">,</span>&nbsp;<span class="ident" id="3921920">hashFunc</span><span class="op" id="3921928">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921933">certVerify</span><span class="op" id="3921943">.</span><span class="ident" id="3921944">signatureAndHash</span><span class="op" id="3921960">.</span><span class="ident" id="3921961">signature</span>&nbsp;<span class="op" id="3921971">=</span>&nbsp;<span class="ident" id="3921973">signatureECDSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921991">certVerify</span><span class="op" id="3922001">.</span><span class="ident" id="3922002">signatureAndHash</span><span class="op" id="3922018">.</span><span class="ident" id="3922019">hash</span>&nbsp;<span class="op" id="3922024">=</span>&nbsp;<span class="ident" id="3922026">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3922035">case</span>&nbsp;<span class="op" id="3922040">*</span><span class="ident" id="3922041">rsa</span><span class="op" id="3922044">.</span><span class="ident" id="3922045">PublicKey</span><span class="op" id="3922054">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922059">digest</span><span class="op" id="3922065">,</span>&nbsp;<span class="ident" id="3922067">hashFunc</span><span class="op" id="3922075">,</span>&nbsp;<span class="ident" id="3922077">hashId</span>&nbsp;<span class="op" id="3922084">:=</span>&nbsp;<span class="ident" id="3922087">hs</span><span class="op" id="3922089">.</span><span class="ident" id="3922090">finishedHash</span><span class="op" id="3922102">.</span><span class="ident" id="3922103">hashForClientCertificate</span><span class="op" id="3922127">(</span><span class="ident" id="3922128">signatureRSA</span><span class="op" id="3922140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922145">signed</span><span class="op" id="3922151">,</span>&nbsp;<span class="ident" id="3922153">err</span>&nbsp;<span class="op" id="3922157">=</span>&nbsp;<span class="ident" id="3922159">key</span><span class="op" id="3922162">.</span><span class="ident" id="3922163">Sign</span><span class="op" id="3922167">(</span><span class="ident" id="3922168">c</span><span class="op" id="3922169">.</span><span class="ident" id="3922170">config</span><span class="op" id="3922176">.</span><span class="ident" id="3922177">rand</span><span class="op" id="3922181">(</span><span class="op" id="3922182">)</span><span class="op" id="3922183">,</span>&nbsp;<span class="ident" id="3922185">digest</span><span class="op" id="3922191">,</span>&nbsp;<span class="ident" id="3922193">hashFunc</span><span class="op" id="3922201">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922206">certVerify</span><span class="op" id="3922216">.</span><span class="ident" id="3922217">signatureAndHash</span><span class="op" id="3922233">.</span><span class="ident" id="3922234">signature</span>&nbsp;<span class="op" id="3922244">=</span>&nbsp;<span class="ident" id="3922246">signatureRSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922262">certVerify</span><span class="op" id="3922272">.</span><span class="ident" id="3922273">signatureAndHash</span><span class="op" id="3922289">.</span><span class="ident" id="3922290">hash</span>&nbsp;<span class="op" id="3922295">=</span>&nbsp;<span class="ident" id="3922297">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3922306">default</span><span class="op" id="3922313">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922318">err</span>&nbsp;<span class="op" id="3922322">=</span>&nbsp;<span class="ident" id="3922324">fmt</span><span class="op" id="3922327">.</span><span class="ident" id="3922328">Errorf</span><span class="op" id="3922334">(</span><span class="string" id="3922335">&#34;tls:&nbsp;unknown&nbsp;client&nbsp;certificate&nbsp;key&nbsp;type:&nbsp;%T&#34;</span><span class="op" id="3922381">,</span>&nbsp;<span class="ident" id="3922383">key</span><span class="op" id="3922386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3922390">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3922394">if</span>&nbsp;<span class="ident" id="3922397">err</span>&nbsp;<span class="op" id="3922401">!=</span>&nbsp;<span class="ident" id="3922404">nil</span>&nbsp;<span class="op" id="3922408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922413">c</span><span class="op" id="3922414">.</span><span class="ident" id="3922415">sendAlert</span><span class="op" id="3922424">(</span><span class="ident" id="3922425">alertInternalError</span><span class="op" id="3922443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3922448">return</span>&nbsp;<span class="ident" id="3922455">errors</span><span class="op" id="3922461">.</span><span class="ident" id="3922462">New</span><span class="op" id="3922465">(</span><span class="string" id="3922466">&#34;tls:&nbsp;failed&nbsp;to&nbsp;sign&nbsp;handshake&nbsp;with&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3922524">+</span>&nbsp;<span class="ident" id="3922526">err</span><span class="op" id="3922529">.</span><span class="ident" id="3922530">Error</span><span class="op" id="3922535">(</span><span class="op" id="3922536">)</span><span class="op" id="3922537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3922541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922545">certVerify</span><span class="op" id="3922555">.</span><span class="ident" id="3922556">signature</span>&nbsp;<span class="op" id="3922566">=</span>&nbsp;<span class="ident" id="3922568">signed</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922578">hs</span><span class="op" id="3922580">.</span><span class="ident" id="3922581">finishedHash</span><span class="op" id="3922593">.</span><span class="ident" id="3922594">Write</span><span class="op" id="3922599">(</span><span class="ident" id="3922600">certVerify</span><span class="op" id="3922610">.</span><span class="ident" id="3922611">marshal</span><span class="op" id="3922618">(</span><span class="op" id="3922619">)</span><span class="op" id="3922620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922624">c</span><span class="op" id="3922625">.</span><span class="ident" id="3922626">writeRecord</span><span class="op" id="3922637">(</span><span class="ident" id="3922638">recordTypeHandshake</span><span class="op" id="3922657">,</span>&nbsp;<span class="ident" id="3922659">certVerify</span><span class="op" id="3922669">.</span><span class="ident" id="3922670">marshal</span><span class="op" id="3922677">(</span><span class="op" id="3922678">)</span><span class="op" id="3922679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3922682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922686">hs</span><span class="op" id="3922688">.</span><span class="ident" id="3922689">masterSecret</span>&nbsp;<span class="op" id="3922702">=</span>&nbsp;<span class="ident" id="3922704">masterFromPreMasterSecret</span><span class="op" id="3922729">(</span><span class="ident" id="3922730">c</span><span class="op" id="3922731">.</span><span class="ident" id="3922732">vers</span><span class="op" id="3922736">,</span>&nbsp;<span class="ident" id="3922738">preMasterSecret</span><span class="op" id="3922753">,</span>&nbsp;<span class="ident" id="3922755">hs</span><span class="op" id="3922757">.</span><span class="ident" id="3922758">hello</span><span class="op" id="3922763">.</span><span class="ident" id="3922764">random</span><span class="op" id="3922770">,</span>&nbsp;<span class="ident" id="3922772">hs</span><span class="op" id="3922774">.</span><span class="ident" id="3922775">serverHello</span><span class="op" id="3922786">.</span><span class="ident" id="3922787">random</span><span class="op" id="3922793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3922796">return</span>&nbsp;<span class="ident" id="3922803">nil</span><br>
<span class="lineno"></span><span class="op" id="3922807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3922810">func</span>&nbsp;<span class="op" id="3922815">(</span><span class="ident" id="3922816">hs</span>&nbsp;<span class="op" id="3922819">*</span><span class="ident" id="3922820">clientHandshakeState</span><span class="op" id="3922840">)</span>&nbsp;<span class="ident" id="3922842">establishKeys</span><span class="op" id="3922855">(</span><span class="op" id="3922856">)</span>&nbsp;<span class="builtintype" id="3922858">error</span>&nbsp;<span class="op" id="3922864">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922867">c</span>&nbsp;<span class="op" id="3922869">:=</span>&nbsp;<span class="ident" id="3922872">hs</span><span class="op" id="3922874">.</span><span class="ident" id="3922875">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922879">clientMAC</span><span class="op" id="3922888">,</span>&nbsp;<span class="ident" id="3922890">serverMAC</span><span class="op" id="3922899">,</span>&nbsp;<span class="ident" id="3922901">clientKey</span><span class="op" id="3922910">,</span>&nbsp;<span class="ident" id="3922912">serverKey</span><span class="op" id="3922921">,</span>&nbsp;<span class="ident" id="3922923">clientIV</span><span class="op" id="3922931">,</span>&nbsp;<span class="ident" id="3922933">serverIV</span>&nbsp;<span class="op" id="3922942">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922947">keysFromMasterSecret</span><span class="op" id="3922967">(</span><span class="ident" id="3922968">c</span><span class="op" id="3922969">.</span><span class="ident" id="3922970">vers</span><span class="op" id="3922974">,</span>&nbsp;<span class="ident" id="3922976">hs</span><span class="op" id="3922978">.</span><span class="ident" id="3922979">masterSecret</span><span class="op" id="3922991">,</span>&nbsp;<span class="ident" id="3922993">hs</span><span class="op" id="3922995">.</span><span class="ident" id="3922996">hello</span><span class="op" id="3923001">.</span><span class="ident" id="3923002">random</span><span class="op" id="3923008">,</span>&nbsp;<span class="ident" id="3923010">hs</span><span class="op" id="3923012">.</span><span class="ident" id="3923013">serverHello</span><span class="op" id="3923024">.</span><span class="ident" id="3923025">random</span><span class="op" id="3923031">,</span>&nbsp;<span class="ident" id="3923033">hs</span><span class="op" id="3923035">.</span><span class="ident" id="3923036">suite</span><span class="op" id="3923041">.</span><span class="ident" id="3923042">macLen</span><span class="op" id="3923048">,</span>&nbsp;<span class="ident" id="3923050">hs</span><span class="op" id="3923052">.</span><span class="ident" id="3923053">suite</span><span class="op" id="3923058">.</span><span class="ident" id="3923059">keyLen</span><span class="op" id="3923065">,</span>&nbsp;<span class="ident" id="3923067">hs</span><span class="op" id="3923069">.</span><span class="ident" id="3923070">suite</span><span class="op" id="3923075">.</span><span class="ident" id="3923076">ivLen</span><span class="op" id="3923081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3923084">var</span>&nbsp;<span class="ident" id="3923088">clientCipher</span><span class="op" id="3923100">,</span>&nbsp;<span class="ident" id="3923102">serverCipher</span>&nbsp;<span class="keyword" id="3923115">interface</span><span class="op" id="3923124">{</span><span class="op" id="3923125">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3923128">var</span>&nbsp;<span class="ident" id="3923132">clientHash</span><span class="op" id="3923142">,</span>&nbsp;<span class="ident" id="3923144">serverHash</span>&nbsp;<span class="ident" id="3923155">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3923168">if</span>&nbsp;<span class="ident" id="3923171">hs</span><span class="op" id="3923173">.</span><span class="ident" id="3923174">suite</span><span class="op" id="3923179">.</span><span class="ident" id="3923180">cipher</span>&nbsp;<span class="op" id="3923187">!=</span>&nbsp;<span class="ident" id="3923190">nil</span>&nbsp;<span class="op" id="3923194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923198">clientCipher</span>&nbsp;<span class="op" id="3923211">=</span>&nbsp;<span class="ident" id="3923213">hs</span><span class="op" id="3923215">.</span><span class="ident" id="3923216">suite</span><span class="op" id="3923221">.</span><span class="ident" id="3923222">cipher</span><span class="op" id="3923228">(</span><span class="ident" id="3923229">clientKey</span><span class="op" id="3923238">,</span>&nbsp;<span class="ident" id="3923240">clientIV</span><span class="op" id="3923248">,</span>&nbsp;<span class="builtintype" id="3923250">false</span>&nbsp;<span class="comment" id="3923256">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3923277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923281">clientHash</span>&nbsp;<span class="op" id="3923292">=</span>&nbsp;<span class="ident" id="3923294">hs</span><span class="op" id="3923296">.</span><span class="ident" id="3923297">suite</span><span class="op" id="3923302">.</span><span class="ident" id="3923303">mac</span><span class="op" id="3923306">(</span><span class="ident" id="3923307">c</span><span class="op" id="3923308">.</span><span class="ident" id="3923309">vers</span><span class="op" id="3923313">,</span>&nbsp;<span class="ident" id="3923315">clientMAC</span><span class="op" id="3923324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923328">serverCipher</span>&nbsp;<span class="op" id="3923341">=</span>&nbsp;<span class="ident" id="3923343">hs</span><span class="op" id="3923345">.</span><span class="ident" id="3923346">suite</span><span class="op" id="3923351">.</span><span class="ident" id="3923352">cipher</span><span class="op" id="3923358">(</span><span class="ident" id="3923359">serverKey</span><span class="op" id="3923368">,</span>&nbsp;<span class="ident" id="3923370">serverIV</span><span class="op" id="3923378">,</span>&nbsp;<span class="builtintype" id="3923380">true</span>&nbsp;<span class="comment" id="3923385">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3923402">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923406">serverHash</span>&nbsp;<span class="op" id="3923417">=</span>&nbsp;<span class="ident" id="3923419">hs</span><span class="op" id="3923421">.</span><span class="ident" id="3923422">suite</span><span class="op" id="3923427">.</span><span class="ident" id="3923428">mac</span><span class="op" id="3923431">(</span><span class="ident" id="3923432">c</span><span class="op" id="3923433">.</span><span class="ident" id="3923434">vers</span><span class="op" id="3923438">,</span>&nbsp;<span class="ident" id="3923440">serverMAC</span><span class="op" id="3923449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3923452">}</span>&nbsp;<span class="keyword" id="3923454">else</span>&nbsp;<span class="op" id="3923459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923463">clientCipher</span>&nbsp;<span class="op" id="3923476">=</span>&nbsp;<span class="ident" id="3923478">hs</span><span class="op" id="3923480">.</span><span class="ident" id="3923481">suite</span><span class="op" id="3923486">.</span><span class="ident" id="3923487">aead</span><span class="op" id="3923491">(</span><span class="ident" id="3923492">clientKey</span><span class="op" id="3923501">,</span>&nbsp;<span class="ident" id="3923503">clientIV</span><span class="op" id="3923511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923515">serverCipher</span>&nbsp;<span class="op" id="3923528">=</span>&nbsp;<span class="ident" id="3923530">hs</span><span class="op" id="3923532">.</span><span class="ident" id="3923533">suite</span><span class="op" id="3923538">.</span><span class="ident" id="3923539">aead</span><span class="op" id="3923543">(</span><span class="ident" id="3923544">serverKey</span><span class="op" id="3923553">,</span>&nbsp;<span class="ident" id="3923555">serverIV</span><span class="op" id="3923563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3923566">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923570">c</span><span class="op" id="3923571">.</span><span class="ident" id="3923572">in</span><span class="op" id="3923574">.</span><span class="ident" id="3923575">prepareCipherSpec</span><span class="op" id="3923592">(</span><span class="ident" id="3923593">c</span><span class="op" id="3923594">.</span><span class="ident" id="3923595">vers</span><span class="op" id="3923599">,</span>&nbsp;<span class="ident" id="3923601">serverCipher</span><span class="op" id="3923613">,</span>&nbsp;<span class="ident" id="3923615">serverHash</span><span class="op" id="3923625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923628">c</span><span class="op" id="3923629">.</span><span class="ident" id="3923630">out</span><span class="op" id="3923633">.</span><span class="ident" id="3923634">prepareCipherSpec</span><span class="op" id="3923651">(</span><span class="ident" id="3923652">c</span><span class="op" id="3923653">.</span><span class="ident" id="3923654">vers</span><span class="op" id="3923658">,</span>&nbsp;<span class="ident" id="3923660">clientCipher</span><span class="op" id="3923672">,</span>&nbsp;<span class="ident" id="3923674">clientHash</span><span class="op" id="3923684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3923687">return</span>&nbsp;<span class="ident" id="3923694">nil</span><br>
<span class="lineno"></span><span class="op" id="3923698">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="3923701">func</span>&nbsp;<span class="op" id="3923706">(</span><span class="ident" id="3923707">hs</span>&nbsp;<span class="op" id="3923710">*</span><span class="ident" id="3923711">clientHandshakeState</span><span class="op" id="3923731">)</span>&nbsp;<span class="ident" id="3923733">serverResumedSession</span><span class="op" id="3923753">(</span><span class="op" id="3923754">)</span>&nbsp;<span class="builtintype" id="3923756">bool</span>&nbsp;<span class="op" id="3923761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3923764">//&nbsp;If&nbsp;the&nbsp;server&nbsp;responded&nbsp;with&nbsp;the&nbsp;same&nbsp;sessionId&nbsp;then&nbsp;it&nbsp;means&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3923834">//&nbsp;sessionTicket&nbsp;is&nbsp;being&nbsp;used&nbsp;to&nbsp;resume&nbsp;a&nbsp;TLS&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3923891">return</span>&nbsp;<span class="ident" id="3923898">hs</span><span class="op" id="3923900">.</span><span class="ident" id="3923901">session</span>&nbsp;<span class="op" id="3923909">!=</span>&nbsp;<span class="ident" id="3923912">nil</span>&nbsp;<span class="op" id="3923916">&amp;&amp;</span>&nbsp;<span class="ident" id="3923919">hs</span><span class="op" id="3923921">.</span><span class="ident" id="3923922">hello</span><span class="op" id="3923927">.</span><span class="ident" id="3923928">sessionId</span>&nbsp;<span class="op" id="3923938">!=</span>&nbsp;<span class="ident" id="3923941">nil</span>&nbsp;<span class="op" id="3923945">&amp;&amp;</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923950">bytes</span><span class="op" id="3923955">.</span><span class="ident" id="3923956">Equal</span><span class="op" id="3923961">(</span><span class="ident" id="3923962">hs</span><span class="op" id="3923964">.</span><span class="ident" id="3923965">serverHello</span><span class="op" id="3923976">.</span><span class="ident" id="3923977">sessionId</span><span class="op" id="3923986">,</span>&nbsp;<span class="ident" id="3923988">hs</span><span class="op" id="3923990">.</span><span class="ident" id="3923991">hello</span><span class="op" id="3923996">.</span><span class="ident" id="3923997">sessionId</span><span class="op" id="3924006">)</span><br>
<span class="lineno"></span><span class="op" id="3924008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3924011">func</span>&nbsp;<span class="op" id="3924016">(</span><span class="ident" id="3924017">hs</span>&nbsp;<span class="op" id="3924020">*</span><span class="ident" id="3924021">clientHandshakeState</span><span class="op" id="3924041">)</span>&nbsp;<span class="ident" id="3924043">processServerHello</span><span class="op" id="3924061">(</span><span class="op" id="3924062">)</span>&nbsp;<span class="op" id="3924064">(</span><span class="builtintype" id="3924065">bool</span><span class="op" id="3924069">,</span>&nbsp;<span class="builtintype" id="3924071">error</span><span class="op" id="3924076">)</span>&nbsp;<span class="op" id="3924078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924081">c</span>&nbsp;<span class="op" id="3924083">:=</span>&nbsp;<span class="ident" id="3924086">hs</span><span class="op" id="3924088">.</span><span class="ident" id="3924089">c</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3924093">if</span>&nbsp;<span class="ident" id="3924096">hs</span><span class="op" id="3924098">.</span><span class="ident" id="3924099">serverHello</span><span class="op" id="3924110">.</span><span class="ident" id="3924111">compressionMethod</span>&nbsp;<span class="op" id="3924129">!=</span>&nbsp;<span class="ident" id="3924132">compressionNone</span>&nbsp;<span class="op" id="3924148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924152">c</span><span class="op" id="3924153">.</span><span class="ident" id="3924154">sendAlert</span><span class="op" id="3924163">(</span><span class="ident" id="3924164">alertUnexpectedMessage</span><span class="op" id="3924186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3924190">return</span>&nbsp;<span class="builtintype" id="3924197">false</span><span class="op" id="3924202">,</span>&nbsp;<span class="ident" id="3924204">errors</span><span class="op" id="3924210">.</span><span class="ident" id="3924211">New</span><span class="op" id="3924214">(</span><span class="string" id="3924215">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;compression&nbsp;format&#34;</span><span class="op" id="3924268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3924271">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924275">clientDidNPN</span>&nbsp;<span class="op" id="3924288">:=</span>&nbsp;<span class="ident" id="3924291">hs</span><span class="op" id="3924293">.</span><span class="ident" id="3924294">hello</span><span class="op" id="3924299">.</span><span class="ident" id="3924300">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924314">clientDidALPN</span>&nbsp;<span class="op" id="3924328">:=</span>&nbsp;<span class="builtinfunc" id="3924331">len</span><span class="op" id="3924334">(</span><span class="ident" id="3924335">hs</span><span class="op" id="3924337">.</span><span class="ident" id="3924338">hello</span><span class="op" id="3924343">.</span><span class="ident" id="3924344">alpnProtocols</span><span class="op" id="3924357">)</span>&nbsp;<span class="op" id="3924359">&gt;</span>&nbsp;<span class="num" id="3924361">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924364">serverHasNPN</span>&nbsp;<span class="op" id="3924377">:=</span>&nbsp;<span class="ident" id="3924380">hs</span><span class="op" id="3924382">.</span><span class="ident" id="3924383">serverHello</span><span class="op" id="3924394">.</span><span class="ident" id="3924395">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924409">serverHasALPN</span>&nbsp;<span class="op" id="3924423">:=</span>&nbsp;<span class="builtinfunc" id="3924426">len</span><span class="op" id="3924429">(</span><span class="ident" id="3924430">hs</span><span class="op" id="3924432">.</span><span class="ident" id="3924433">serverHello</span><span class="op" id="3924444">.</span><span class="ident" id="3924445">alpnProtocol</span><span class="op" id="3924457">)</span>&nbsp;<span class="op" id="3924459">&gt;</span>&nbsp;<span class="num" id="3924461">0</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3924465">if</span>&nbsp;<span class="op" id="3924468">!</span><span class="ident" id="3924469">clientDidNPN</span>&nbsp;<span class="op" id="3924482">&amp;&amp;</span>&nbsp;<span class="ident" id="3924485">serverHasNPN</span>&nbsp;<span class="op" id="3924498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924502">c</span><span class="op" id="3924503">.</span><span class="ident" id="3924504">sendAlert</span><span class="op" id="3924513">(</span><span class="ident" id="3924514">alertHandshakeFailure</span><span class="op" id="3924535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3924539">return</span>&nbsp;<span class="builtintype" id="3924546">false</span><span class="op" id="3924551">,</span>&nbsp;<span class="ident" id="3924553">errors</span><span class="op" id="3924559">.</span><span class="ident" id="3924560">New</span><span class="op" id="3924563">(</span><span class="string" id="3924564">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;NPN&nbsp;extension&#34;</span><span class="op" id="3924609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3924612">}</span><br>
<span class="lineno">510</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3924616">if</span>&nbsp;<span class="op" id="3924619">!</span><span class="ident" id="3924620">clientDidALPN</span>&nbsp;<span class="op" id="3924634">&amp;&amp;</span>&nbsp;<span class="ident" id="3924637">serverHasALPN</span>&nbsp;<span class="op" id="3924651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924655">c</span><span class="op" id="3924656">.</span><span class="ident" id="3924657">sendAlert</span><span class="op" id="3924666">(</span><span class="ident" id="3924667">alertHandshakeFailure</span><span class="op" id="3924688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3924692">return</span>&nbsp;<span class="builtintype" id="3924699">false</span><span class="op" id="3924704">,</span>&nbsp;<span class="ident" id="3924706">errors</span><span class="op" id="3924712">.</span><span class="ident" id="3924713">New</span><span class="op" id="3924716">(</span><span class="string" id="3924717">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;ALPN&nbsp;extension&#34;</span><span class="op" id="3924763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3924766">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3924770">if</span>&nbsp;<span class="ident" id="3924773">serverHasNPN</span>&nbsp;<span class="op" id="3924786">&amp;&amp;</span>&nbsp;<span class="ident" id="3924789">serverHasALPN</span>&nbsp;<span class="op" id="3924803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924807">c</span><span class="op" id="3924808">.</span><span class="ident" id="3924809">sendAlert</span><span class="op" id="3924818">(</span><span class="ident" id="3924819">alertHandshakeFailure</span><span class="op" id="3924840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3924844">return</span>&nbsp;<span class="builtintype" id="3924851">false</span><span class="op" id="3924856">,</span>&nbsp;<span class="ident" id="3924858">errors</span><span class="op" id="3924864">.</span><span class="ident" id="3924865">New</span><span class="op" id="3924868">(</span><span class="string" id="3924869">&#34;server&nbsp;advertised&nbsp;both&nbsp;NPN&nbsp;and&nbsp;ALPN&nbsp;extensions&#34;</span><span class="op" id="3924917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3924920">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3924924">if</span>&nbsp;<span class="ident" id="3924927">serverHasALPN</span>&nbsp;<span class="op" id="3924941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924945">c</span><span class="op" id="3924946">.</span><span class="ident" id="3924947">clientProtocol</span>&nbsp;<span class="op" id="3924962">=</span>&nbsp;<span class="ident" id="3924964">hs</span><span class="op" id="3924966">.</span><span class="ident" id="3924967">serverHello</span><span class="op" id="3924978">.</span><span class="ident" id="3924979">alpnProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924994">c</span><span class="op" id="3924995">.</span><span class="ident" id="3924996">clientProtocolFallback</span>&nbsp;<span class="op" id="3925019">=</span>&nbsp;<span class="builtintype" id="3925021">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3925028">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925032">if</span>&nbsp;<span class="ident" id="3925035">hs</span><span class="op" id="3925037">.</span><span class="ident" id="3925038">serverResumedSession</span><span class="op" id="3925058">(</span><span class="op" id="3925059">)</span>&nbsp;<span class="op" id="3925061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3925065">//&nbsp;Restore&nbsp;masterSecret&nbsp;and&nbsp;peerCerts&nbsp;from&nbsp;previous&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3925125">hs</span><span class="op" id="3925127">.</span><span class="ident" id="3925128">masterSecret</span>&nbsp;<span class="op" id="3925141">=</span>&nbsp;<span class="ident" id="3925143">hs</span><span class="op" id="3925145">.</span><span class="ident" id="3925146">session</span><span class="op" id="3925153">.</span><span class="ident" id="3925154">masterSecret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3925169">c</span><span class="op" id="3925170">.</span><span class="ident" id="3925171">peerCertificates</span>&nbsp;<span class="op" id="3925188">=</span>&nbsp;<span class="ident" id="3925190">hs</span><span class="op" id="3925192">.</span><span class="ident" id="3925193">session</span><span class="op" id="3925200">.</span><span class="ident" id="3925201">serverCertificates</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925222">return</span>&nbsp;<span class="builtintype" id="3925229">true</span><span class="op" id="3925233">,</span>&nbsp;<span class="ident" id="3925235">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3925240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925243">return</span>&nbsp;<span class="builtintype" id="3925250">false</span><span class="op" id="3925255">,</span>&nbsp;<span class="ident" id="3925257">nil</span><br>
<span class="lineno"></span><span class="op" id="3925261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="3925264">func</span>&nbsp;<span class="op" id="3925269">(</span><span class="ident" id="3925270">hs</span>&nbsp;<span class="op" id="3925273">*</span><span class="ident" id="3925274">clientHandshakeState</span><span class="op" id="3925294">)</span>&nbsp;<span class="ident" id="3925296">readFinished</span><span class="op" id="3925308">(</span><span class="ident" id="3925309">out</span>&nbsp;<span class="op" id="3925313">[</span><span class="op" id="3925314">]</span><span class="builtintype" id="3925315">byte</span><span class="op" id="3925319">)</span>&nbsp;<span class="builtintype" id="3925321">error</span>&nbsp;<span class="op" id="3925327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3925330">c</span>&nbsp;<span class="op" id="3925332">:=</span>&nbsp;<span class="ident" id="3925335">hs</span><span class="op" id="3925337">.</span><span class="ident" id="3925338">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3925342">c</span><span class="op" id="3925343">.</span><span class="ident" id="3925344">readRecord</span><span class="op" id="3925354">(</span><span class="ident" id="3925355">recordTypeChangeCipherSpec</span><span class="op" id="3925381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925384">if</span>&nbsp;<span class="ident" id="3925387">err</span>&nbsp;<span class="op" id="3925391">:=</span>&nbsp;<span class="ident" id="3925394">c</span><span class="op" id="3925395">.</span><span class="ident" id="3925396">in</span><span class="op" id="3925398">.</span><span class="builtintype" id="3925399">error</span><span class="op" id="3925404">(</span><span class="op" id="3925405">)</span><span class="op" id="3925406">;</span>&nbsp;<span class="ident" id="3925408">err</span>&nbsp;<span class="op" id="3925412">!=</span>&nbsp;<span class="ident" id="3925415">nil</span>&nbsp;<span class="op" id="3925419">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925423">return</span>&nbsp;<span class="ident" id="3925430">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3925435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3925439">msg</span><span class="op" id="3925442">,</span>&nbsp;<span class="ident" id="3925444">err</span>&nbsp;<span class="op" id="3925448">:=</span>&nbsp;<span class="ident" id="3925451">c</span><span class="op" id="3925452">.</span><span class="ident" id="3925453">readHandshake</span><span class="op" id="3925466">(</span><span class="op" id="3925467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925470">if</span>&nbsp;<span class="ident" id="3925473">err</span>&nbsp;<span class="op" id="3925477">!=</span>&nbsp;<span class="ident" id="3925480">nil</span>&nbsp;<span class="op" id="3925484">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925488">return</span>&nbsp;<span class="ident" id="3925495">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3925500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3925503">serverFinished</span><span class="op" id="3925517">,</span>&nbsp;<span class="ident" id="3925519">ok</span>&nbsp;<span class="op" id="3925522">:=</span>&nbsp;<span class="ident" id="3925525">msg</span><span class="op" id="3925528">.</span><span class="op" id="3925529">(</span><span class="op" id="3925530">*</span><span class="ident" id="3925531">finishedMsg</span><span class="op" id="3925542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925545">if</span>&nbsp;<span class="op" id="3925548">!</span><span class="ident" id="3925549">ok</span>&nbsp;<span class="op" id="3925552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3925556">c</span><span class="op" id="3925557">.</span><span class="ident" id="3925558">sendAlert</span><span class="op" id="3925567">(</span><span class="ident" id="3925568">alertUnexpectedMessage</span><span class="op" id="3925590">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925594">return</span>&nbsp;<span class="ident" id="3925601">unexpectedMessageError</span><span class="op" id="3925623">(</span><span class="ident" id="3925624">serverFinished</span><span class="op" id="3925638">,</span>&nbsp;<span class="ident" id="3925640">msg</span><span class="op" id="3925643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3925646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3925650">verify</span>&nbsp;<span class="op" id="3925657">:=</span>&nbsp;<span class="ident" id="3925660">hs</span><span class="op" id="3925662">.</span><span class="ident" id="3925663">finishedHash</span><span class="op" id="3925675">.</span><span class="ident" id="3925676">serverSum</span><span class="op" id="3925685">(</span><span class="ident" id="3925686">hs</span><span class="op" id="3925688">.</span><span class="ident" id="3925689">masterSecret</span><span class="op" id="3925701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925704">if</span>&nbsp;<span class="builtinfunc" id="3925707">len</span><span class="op" id="3925710">(</span><span class="ident" id="3925711">verify</span><span class="op" id="3925717">)</span>&nbsp;<span class="op" id="3925719">!=</span>&nbsp;<span class="builtinfunc" id="3925722">len</span><span class="op" id="3925725">(</span><span class="ident" id="3925726">serverFinished</span><span class="op" id="3925740">.</span><span class="ident" id="3925741">verifyData</span><span class="op" id="3925751">)</span>&nbsp;<span class="op" id="3925753">||</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3925758">subtle</span><span class="op" id="3925764">.</span><span class="ident" id="3925765">ConstantTimeCompare</span><span class="op" id="3925784">(</span><span class="ident" id="3925785">verify</span><span class="op" id="3925791">,</span>&nbsp;<span class="ident" id="3925793">serverFinished</span><span class="op" id="3925807">.</span><span class="ident" id="3925808">verifyData</span><span class="op" id="3925818">)</span>&nbsp;<span class="op" id="3925820">!=</span>&nbsp;<span class="num" id="3925823">1</span>&nbsp;<span class="op" id="3925825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3925829">c</span><span class="op" id="3925830">.</span><span class="ident" id="3925831">sendAlert</span><span class="op" id="3925840">(</span><span class="ident" id="3925841">alertHandshakeFailure</span><span class="op" id="3925862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925866">return</span>&nbsp;<span class="ident" id="3925873">errors</span><span class="op" id="3925879">.</span><span class="ident" id="3925880">New</span><span class="op" id="3925883">(</span><span class="string" id="3925884">&#34;tls:&nbsp;server&#39;s&nbsp;Finished&nbsp;message&nbsp;was&nbsp;incorrect&#34;</span><span class="op" id="3925930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3925933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3925936">hs</span><span class="op" id="3925938">.</span><span class="ident" id="3925939">finishedHash</span><span class="op" id="3925951">.</span><span class="ident" id="3925952">Write</span><span class="op" id="3925957">(</span><span class="ident" id="3925958">serverFinished</span><span class="op" id="3925972">.</span><span class="ident" id="3925973">marshal</span><span class="op" id="3925980">(</span><span class="op" id="3925981">)</span><span class="op" id="3925982">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3925985">copy</span><span class="op" id="3925989">(</span><span class="ident" id="3925990">out</span><span class="op" id="3925993">,</span>&nbsp;<span class="ident" id="3925995">verify</span><span class="op" id="3926001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3926004">return</span>&nbsp;<span class="ident" id="3926011">nil</span><br>
<span class="lineno"></span><span class="op" id="3926015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3926018">func</span>&nbsp;<span class="op" id="3926023">(</span><span class="ident" id="3926024">hs</span>&nbsp;<span class="op" id="3926027">*</span><span class="ident" id="3926028">clientHandshakeState</span><span class="op" id="3926048">)</span>&nbsp;<span class="ident" id="3926050">readSessionTicket</span><span class="op" id="3926067">(</span><span class="op" id="3926068">)</span>&nbsp;<span class="builtintype" id="3926070">error</span>&nbsp;<span class="op" id="3926076">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3926079">if</span>&nbsp;<span class="op" id="3926082">!</span><span class="ident" id="3926083">hs</span><span class="op" id="3926085">.</span><span class="ident" id="3926086">serverHello</span><span class="op" id="3926097">.</span><span class="ident" id="3926098">ticketSupported</span>&nbsp;<span class="op" id="3926114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3926118">return</span>&nbsp;<span class="ident" id="3926125">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3926130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926134">c</span>&nbsp;<span class="op" id="3926136">:=</span>&nbsp;<span class="ident" id="3926139">hs</span><span class="op" id="3926141">.</span><span class="ident" id="3926142">c</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926145">msg</span><span class="op" id="3926148">,</span>&nbsp;<span class="ident" id="3926150">err</span>&nbsp;<span class="op" id="3926154">:=</span>&nbsp;<span class="ident" id="3926157">c</span><span class="op" id="3926158">.</span><span class="ident" id="3926159">readHandshake</span><span class="op" id="3926172">(</span><span class="op" id="3926173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3926176">if</span>&nbsp;<span class="ident" id="3926179">err</span>&nbsp;<span class="op" id="3926183">!=</span>&nbsp;<span class="ident" id="3926186">nil</span>&nbsp;<span class="op" id="3926190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3926194">return</span>&nbsp;<span class="ident" id="3926201">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3926206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926209">sessionTicketMsg</span><span class="op" id="3926225">,</span>&nbsp;<span class="ident" id="3926227">ok</span>&nbsp;<span class="op" id="3926230">:=</span>&nbsp;<span class="ident" id="3926233">msg</span><span class="op" id="3926236">.</span><span class="op" id="3926237">(</span><span class="op" id="3926238">*</span><span class="ident" id="3926239">newSessionTicketMsg</span><span class="op" id="3926258">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3926261">if</span>&nbsp;<span class="op" id="3926264">!</span><span class="ident" id="3926265">ok</span>&nbsp;<span class="op" id="3926268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926272">c</span><span class="op" id="3926273">.</span><span class="ident" id="3926274">sendAlert</span><span class="op" id="3926283">(</span><span class="ident" id="3926284">alertUnexpectedMessage</span><span class="op" id="3926306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3926310">return</span>&nbsp;<span class="ident" id="3926317">unexpectedMessageError</span><span class="op" id="3926339">(</span><span class="ident" id="3926340">sessionTicketMsg</span><span class="op" id="3926356">,</span>&nbsp;<span class="ident" id="3926358">msg</span><span class="op" id="3926361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3926364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926367">hs</span><span class="op" id="3926369">.</span><span class="ident" id="3926370">finishedHash</span><span class="op" id="3926382">.</span><span class="ident" id="3926383">Write</span><span class="op" id="3926388">(</span><span class="ident" id="3926389">sessionTicketMsg</span><span class="op" id="3926405">.</span><span class="ident" id="3926406">marshal</span><span class="op" id="3926413">(</span><span class="op" id="3926414">)</span><span class="op" id="3926415">)</span><br>
<span class="lineno">580</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926419">hs</span><span class="op" id="3926421">.</span><span class="ident" id="3926422">session</span>&nbsp;<span class="op" id="3926430">=</span>&nbsp;<span class="op" id="3926432">&amp;</span><span class="ident" id="3926433">ClientSessionState</span><span class="op" id="3926451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926455">sessionTicket</span><span class="op" id="3926468">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926475">sessionTicketMsg</span><span class="op" id="3926491">.</span><span class="ident" id="3926492">ticket</span><span class="op" id="3926498">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926502">vers</span><span class="op" id="3926506">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926522">c</span><span class="op" id="3926523">.</span><span class="ident" id="3926524">vers</span><span class="op" id="3926528">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926532">cipherSuite</span><span class="op" id="3926543">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926552">hs</span><span class="op" id="3926554">.</span><span class="ident" id="3926555">suite</span><span class="op" id="3926560">.</span><span class="ident" id="3926561">id</span><span class="op" id="3926563">,</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926567">masterSecret</span><span class="op" id="3926579">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926587">hs</span><span class="op" id="3926589">.</span><span class="ident" id="3926590">masterSecret</span><span class="op" id="3926602">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926606">serverCertificates</span><span class="op" id="3926624">:</span>&nbsp;<span class="ident" id="3926626">c</span><span class="op" id="3926627">.</span><span class="ident" id="3926628">peerCertificates</span><span class="op" id="3926644">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3926647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3926651">return</span>&nbsp;<span class="ident" id="3926658">nil</span><br>
<span class="lineno">590</span><span class="op" id="3926662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3926665">func</span>&nbsp;<span class="op" id="3926670">(</span><span class="ident" id="3926671">hs</span>&nbsp;<span class="op" id="3926674">*</span><span class="ident" id="3926675">clientHandshakeState</span><span class="op" id="3926695">)</span>&nbsp;<span class="ident" id="3926697">sendFinished</span><span class="op" id="3926709">(</span><span class="ident" id="3926710">out</span>&nbsp;<span class="op" id="3926714">[</span><span class="op" id="3926715">]</span><span class="builtintype" id="3926716">byte</span><span class="op" id="3926720">)</span>&nbsp;<span class="builtintype" id="3926722">error</span>&nbsp;<span class="op" id="3926728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926731">c</span>&nbsp;<span class="op" id="3926733">:=</span>&nbsp;<span class="ident" id="3926736">hs</span><span class="op" id="3926738">.</span><span class="ident" id="3926739">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926743">c</span><span class="op" id="3926744">.</span><span class="ident" id="3926745">writeRecord</span><span class="op" id="3926756">(</span><span class="ident" id="3926757">recordTypeChangeCipherSpec</span><span class="op" id="3926783">,</span>&nbsp;<span class="op" id="3926785">[</span><span class="op" id="3926786">]</span><span class="builtintype" id="3926787">byte</span><span class="op" id="3926791">{</span><span class="num" id="3926792">1</span><span class="op" id="3926793">}</span><span class="op" id="3926794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3926797">if</span>&nbsp;<span class="ident" id="3926800">hs</span><span class="op" id="3926802">.</span><span class="ident" id="3926803">serverHello</span><span class="op" id="3926814">.</span><span class="ident" id="3926815">nextProtoNeg</span>&nbsp;<span class="op" id="3926828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926832">nextProto</span>&nbsp;<span class="op" id="3926842">:=</span>&nbsp;<span class="builtinfunc" id="3926845">new</span><span class="op" id="3926848">(</span><span class="ident" id="3926849">nextProtoMsg</span><span class="op" id="3926861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926865">proto</span><span class="op" id="3926870">,</span>&nbsp;<span class="ident" id="3926872">fallback</span>&nbsp;<span class="op" id="3926881">:=</span>&nbsp;<span class="ident" id="3926884">mutualProtocol</span><span class="op" id="3926898">(</span><span class="ident" id="3926899">c</span><span class="op" id="3926900">.</span><span class="ident" id="3926901">config</span><span class="op" id="3926907">.</span><span class="ident" id="3926908">NextProtos</span><span class="op" id="3926918">,</span>&nbsp;<span class="ident" id="3926920">hs</span><span class="op" id="3926922">.</span><span class="ident" id="3926923">serverHello</span><span class="op" id="3926934">.</span><span class="ident" id="3926935">nextProtos</span><span class="op" id="3926945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926949">nextProto</span><span class="op" id="3926958">.</span><span class="ident" id="3926959">proto</span>&nbsp;<span class="op" id="3926965">=</span>&nbsp;<span class="ident" id="3926967">proto</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926975">c</span><span class="op" id="3926976">.</span><span class="ident" id="3926977">clientProtocol</span>&nbsp;<span class="op" id="3926992">=</span>&nbsp;<span class="ident" id="3926994">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3927002">c</span><span class="op" id="3927003">.</span><span class="ident" id="3927004">clientProtocolFallback</span>&nbsp;<span class="op" id="3927027">=</span>&nbsp;<span class="ident" id="3927029">fallback</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3927041">hs</span><span class="op" id="3927043">.</span><span class="ident" id="3927044">finishedHash</span><span class="op" id="3927056">.</span><span class="ident" id="3927057">Write</span><span class="op" id="3927062">(</span><span class="ident" id="3927063">nextProto</span><span class="op" id="3927072">.</span><span class="ident" id="3927073">marshal</span><span class="op" id="3927080">(</span><span class="op" id="3927081">)</span><span class="op" id="3927082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3927086">c</span><span class="op" id="3927087">.</span><span class="ident" id="3927088">writeRecord</span><span class="op" id="3927099">(</span><span class="ident" id="3927100">recordTypeHandshake</span><span class="op" id="3927119">,</span>&nbsp;<span class="ident" id="3927121">nextProto</span><span class="op" id="3927130">.</span><span class="ident" id="3927131">marshal</span><span class="op" id="3927138">(</span><span class="op" id="3927139">)</span><span class="op" id="3927140">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3927143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3927147">finished</span>&nbsp;<span class="op" id="3927156">:=</span>&nbsp;<span class="builtinfunc" id="3927159">new</span><span class="op" id="3927162">(</span><span class="ident" id="3927163">finishedMsg</span><span class="op" id="3927174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3927177">finished</span><span class="op" id="3927185">.</span><span class="ident" id="3927186">verifyData</span>&nbsp;<span class="op" id="3927197">=</span>&nbsp;<span class="ident" id="3927199">hs</span><span class="op" id="3927201">.</span><span class="ident" id="3927202">finishedHash</span><span class="op" id="3927214">.</span><span class="ident" id="3927215">clientSum</span><span class="op" id="3927224">(</span><span class="ident" id="3927225">hs</span><span class="op" id="3927227">.</span><span class="ident" id="3927228">masterSecret</span><span class="op" id="3927240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3927243">hs</span><span class="op" id="3927245">.</span><span class="ident" id="3927246">finishedHash</span><span class="op" id="3927258">.</span><span class="ident" id="3927259">Write</span><span class="op" id="3927264">(</span><span class="ident" id="3927265">finished</span><span class="op" id="3927273">.</span><span class="ident" id="3927274">marshal</span><span class="op" id="3927281">(</span><span class="op" id="3927282">)</span><span class="op" id="3927283">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3927286">c</span><span class="op" id="3927287">.</span><span class="ident" id="3927288">writeRecord</span><span class="op" id="3927299">(</span><span class="ident" id="3927300">recordTypeHandshake</span><span class="op" id="3927319">,</span>&nbsp;<span class="ident" id="3927321">finished</span><span class="op" id="3927329">.</span><span class="ident" id="3927330">marshal</span><span class="op" id="3927337">(</span><span class="op" id="3927338">)</span><span class="op" id="3927339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3927342">copy</span><span class="op" id="3927346">(</span><span class="ident" id="3927347">out</span><span class="op" id="3927350">,</span>&nbsp;<span class="ident" id="3927352">finished</span><span class="op" id="3927360">.</span><span class="ident" id="3927361">verifyData</span><span class="op" id="3927371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3927374">return</span>&nbsp;<span class="ident" id="3927381">nil</span><br>
<span class="lineno"></span><span class="op" id="3927385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="comment" id="3927388">//&nbsp;clientSessionCacheKey&nbsp;returns&nbsp;a&nbsp;key&nbsp;used&nbsp;to&nbsp;cache&nbsp;sessionTickets&nbsp;that&nbsp;could</span><br>
<span class="lineno"></span><span class="comment" id="3927467">//&nbsp;be&nbsp;used&nbsp;to&nbsp;resume&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;sessions&nbsp;with&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="3927538">func</span>&nbsp;<span class="ident" id="3927543">clientSessionCacheKey</span><span class="op" id="3927564">(</span><span class="ident" id="3927565">serverAddr</span>&nbsp;<span class="ident" id="3927576">net</span><span class="op" id="3927579">.</span><span class="ident" id="3927580">Addr</span><span class="op" id="3927584">,</span>&nbsp;<span class="ident" id="3927586">config</span>&nbsp;<span class="op" id="3927593">*</span><span class="ident" id="3927594">Config</span><span class="op" id="3927600">)</span>&nbsp;<span class="builtintype" id="3927602">string</span>&nbsp;<span class="op" id="3927609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3927612">if</span>&nbsp;<span class="builtinfunc" id="3927615">len</span><span class="op" id="3927618">(</span><span class="ident" id="3927619">config</span><span class="op" id="3927625">.</span><span class="ident" id="3927626">ServerName</span><span class="op" id="3927636">)</span>&nbsp;<span class="op" id="3927638">&gt;</span>&nbsp;<span class="num" id="3927640">0</span>&nbsp;<span class="op" id="3927642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3927646">return</span>&nbsp;<span class="ident" id="3927653">config</span><span class="op" id="3927659">.</span><span class="ident" id="3927660">ServerName</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3927672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3927675">return</span>&nbsp;<span class="ident" id="3927682">serverAddr</span><span class="op" id="3927692">.</span><span class="ident" id="3927693">String</span><span class="op" id="3927699">(</span><span class="op" id="3927700">)</span><br>
<span class="lineno"></span><span class="op" id="3927702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3927705">//&nbsp;mutualProtocol&nbsp;finds&nbsp;the&nbsp;mutual&nbsp;Next&nbsp;Protocol&nbsp;Negotiation&nbsp;or&nbsp;ALPN&nbsp;protocol</span><br>
<span class="lineno">625</span><span class="comment" id="3927783">//&nbsp;given&nbsp;list&nbsp;of&nbsp;possible&nbsp;protocols&nbsp;and&nbsp;a&nbsp;list&nbsp;of&nbsp;the&nbsp;preference&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="3927859">//&nbsp;first&nbsp;list&nbsp;must&nbsp;not&nbsp;be&nbsp;empty.&nbsp;It&nbsp;returns&nbsp;the&nbsp;resulting&nbsp;protocol&nbsp;and&nbsp;flag</span><br>
<span class="lineno"></span><span class="comment" id="3927935">//&nbsp;indicating&nbsp;if&nbsp;the&nbsp;fallback&nbsp;case&nbsp;was&nbsp;reached.</span><br>
<span class="lineno"></span><span class="keyword" id="3927983">func</span>&nbsp;<span class="ident" id="3927988">mutualProtocol</span><span class="op" id="3928002">(</span><span class="ident" id="3928003">protos</span><span class="op" id="3928009">,</span>&nbsp;<span class="ident" id="3928011">preferenceProtos</span>&nbsp;<span class="op" id="3928028">[</span><span class="op" id="3928029">]</span><span class="builtintype" id="3928030">string</span><span class="op" id="3928036">)</span>&nbsp;<span class="op" id="3928038">(</span><span class="builtintype" id="3928039">string</span><span class="op" id="3928045">,</span>&nbsp;<span class="builtintype" id="3928047">bool</span><span class="op" id="3928051">)</span>&nbsp;<span class="op" id="3928053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3928056">for</span>&nbsp;<span class="ident" id="3928060">_</span><span class="op" id="3928061">,</span>&nbsp;<span class="ident" id="3928063">s</span>&nbsp;<span class="op" id="3928065">:=</span>&nbsp;<span class="keyword" id="3928068">range</span>&nbsp;<span class="ident" id="3928074">preferenceProtos</span>&nbsp;<span class="op" id="3928091">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3928095">for</span>&nbsp;<span class="ident" id="3928099">_</span><span class="op" id="3928100">,</span>&nbsp;<span class="ident" id="3928102">c</span>&nbsp;<span class="op" id="3928104">:=</span>&nbsp;<span class="keyword" id="3928107">range</span>&nbsp;<span class="ident" id="3928113">protos</span>&nbsp;<span class="op" id="3928120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3928125">if</span>&nbsp;<span class="ident" id="3928128">s</span>&nbsp;<span class="op" id="3928130">==</span>&nbsp;<span class="ident" id="3928133">c</span>&nbsp;<span class="op" id="3928135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3928141">return</span>&nbsp;<span class="ident" id="3928148">s</span><span class="op" id="3928149">,</span>&nbsp;<span class="builtintype" id="3928151">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3928160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3928164">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3928167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3928171">return</span>&nbsp;<span class="ident" id="3928178">protos</span><span class="op" id="3928184">[</span><span class="num" id="3928185">0</span><span class="op" id="3928186">]</span><span class="op" id="3928187">,</span>&nbsp;<span class="builtintype" id="3928189">true</span><br>
<span class="lineno"></span><span class="op" id="3928194">}</span>
</div>
</body>
</html>
