<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/ast</h2>
<ul>
<li><a href="/gostd/go/ast/ast.go.html">ast.go</a></li>
<li><a href="/gostd/go/ast/ast_test.go.html">ast_test.go</a></li>
<li><a href="/gostd/go/ast/commentmap.go.html">commentmap.go</a></li>
<li><a href="/gostd/go/ast/commentmap_test.go.html">commentmap_test.go</a></li>
<li><a href="/gostd/go/ast/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/go/ast/filter.go.html">filter.go</a></li>
<li><a href="/gostd/go/ast/filter_test.go.html">filter_test.go</a></li>
<li><a href="/gostd/go/ast/import.go.html">import.go</a></li>
<li><a href="/gostd/go/ast/print.go.html">print.go</a></li>
<li><a href="/gostd/go/ast/print_test.go.html">print_test.go</a></li>
<li><a href="/gostd/go/ast/resolve.go.html">resolve.go</a></li>
<li><a href="/gostd/go/ast/scope.go.html">scope.go</a></li>
<li><a href="/gostd/go/ast/walk.go.html">walk.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2330028">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2330083">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2330137">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2330188">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;NewPackage.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2330225">package</span>&nbsp;<span class="ident" id="2330233">ast</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2330238">import</span>&nbsp;<span class="op" id="2330245">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2330248">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2330255">&#34;go/scanner&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2330269">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2330281">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="2330291">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="2330294">type</span>&nbsp;<span class="ident" id="2330299">pkgBuilder</span>&nbsp;<span class="keyword" id="2330310">struct</span>&nbsp;<span class="op" id="2330317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2330320">fset</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2330327">*</span><span class="ident" id="2330328">token</span><span class="op" id="2330333">.</span><span class="ident" id="2330334">FileSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2330343">errors</span>&nbsp;<span class="ident" id="2330350">scanner</span><span class="op" id="2330357">.</span><span class="ident" id="2330358">ErrorList</span><br>
<span class="lineno"></span><span class="op" id="2330368">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="2330371">func</span>&nbsp;<span class="op" id="2330376">(</span><span class="ident" id="2330377">p</span>&nbsp;<span class="op" id="2330379">*</span><span class="ident" id="2330380">pkgBuilder</span><span class="op" id="2330390">)</span>&nbsp;<span class="builtintype" id="2330392">error</span><span class="op" id="2330397">(</span><span class="ident" id="2330398">pos</span>&nbsp;<span class="ident" id="2330402">token</span><span class="op" id="2330407">.</span><span class="ident" id="2330408">Pos</span><span class="op" id="2330411">,</span>&nbsp;<span class="ident" id="2330413">msg</span>&nbsp;<span class="builtintype" id="2330417">string</span><span class="op" id="2330423">)</span>&nbsp;<span class="op" id="2330425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2330428">p</span><span class="op" id="2330429">.</span><span class="ident" id="2330430">errors</span><span class="op" id="2330436">.</span><span class="ident" id="2330437">Add</span><span class="op" id="2330440">(</span><span class="ident" id="2330441">p</span><span class="op" id="2330442">.</span><span class="ident" id="2330443">fset</span><span class="op" id="2330447">.</span><span class="ident" id="2330448">Position</span><span class="op" id="2330456">(</span><span class="ident" id="2330457">pos</span><span class="op" id="2330460">)</span><span class="op" id="2330461">,</span>&nbsp;<span class="ident" id="2330463">msg</span><span class="op" id="2330466">)</span><br>
<span class="lineno"></span><span class="op" id="2330468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="2330471">func</span>&nbsp;<span class="op" id="2330476">(</span><span class="ident" id="2330477">p</span>&nbsp;<span class="op" id="2330479">*</span><span class="ident" id="2330480">pkgBuilder</span><span class="op" id="2330490">)</span>&nbsp;<span class="ident" id="2330492">errorf</span><span class="op" id="2330498">(</span><span class="ident" id="2330499">pos</span>&nbsp;<span class="ident" id="2330503">token</span><span class="op" id="2330508">.</span><span class="ident" id="2330509">Pos</span><span class="op" id="2330512">,</span>&nbsp;<span class="ident" id="2330514">format</span>&nbsp;<span class="builtintype" id="2330521">string</span><span class="op" id="2330527">,</span>&nbsp;<span class="ident" id="2330529">args</span>&nbsp;<span class="op" id="2330534">...</span><span class="keyword" id="2330537">interface</span><span class="op" id="2330546">{</span><span class="op" id="2330547">}</span><span class="op" id="2330548">)</span>&nbsp;<span class="op" id="2330550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2330553">p</span><span class="op" id="2330554">.</span><span class="builtintype" id="2330555">error</span><span class="op" id="2330560">(</span><span class="ident" id="2330561">pos</span><span class="op" id="2330564">,</span>&nbsp;<span class="ident" id="2330566">fmt</span><span class="op" id="2330569">.</span><span class="ident" id="2330570">Sprintf</span><span class="op" id="2330577">(</span><span class="ident" id="2330578">format</span><span class="op" id="2330584">,</span>&nbsp;<span class="ident" id="2330586">args</span><span class="op" id="2330590">...</span><span class="op" id="2330593">)</span><span class="op" id="2330594">)</span><br>
<span class="lineno"></span><span class="op" id="2330596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2330599">func</span>&nbsp;<span class="op" id="2330604">(</span><span class="ident" id="2330605">p</span>&nbsp;<span class="op" id="2330607">*</span><span class="ident" id="2330608">pkgBuilder</span><span class="op" id="2330618">)</span>&nbsp;<span class="ident" id="2330620">declare</span><span class="op" id="2330627">(</span><span class="ident" id="2330628">scope</span><span class="op" id="2330633">,</span>&nbsp;<span class="ident" id="2330635">altScope</span>&nbsp;<span class="op" id="2330644">*</span><span class="ident" id="2330645">Scope</span><span class="op" id="2330650">,</span>&nbsp;<span class="ident" id="2330652">obj</span>&nbsp;<span class="op" id="2330656">*</span><span class="ident" id="2330657">Object</span><span class="op" id="2330663">)</span>&nbsp;<span class="op" id="2330665">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2330668">alt</span>&nbsp;<span class="op" id="2330672">:=</span>&nbsp;<span class="ident" id="2330675">scope</span><span class="op" id="2330680">.</span><span class="ident" id="2330681">Insert</span><span class="op" id="2330687">(</span><span class="ident" id="2330688">obj</span><span class="op" id="2330691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2330694">if</span>&nbsp;<span class="ident" id="2330697">alt</span>&nbsp;<span class="op" id="2330701">==</span>&nbsp;<span class="ident" id="2330704">nil</span>&nbsp;<span class="op" id="2330708">&amp;&amp;</span>&nbsp;<span class="ident" id="2330711">altScope</span>&nbsp;<span class="op" id="2330720">!=</span>&nbsp;<span class="ident" id="2330723">nil</span>&nbsp;<span class="op" id="2330727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2330731">//&nbsp;see&nbsp;if&nbsp;there&nbsp;is&nbsp;a&nbsp;conflicting&nbsp;declaration&nbsp;in&nbsp;altScope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2330790">alt</span>&nbsp;<span class="op" id="2330794">=</span>&nbsp;<span class="ident" id="2330796">altScope</span><span class="op" id="2330804">.</span><span class="ident" id="2330805">Lookup</span><span class="op" id="2330811">(</span><span class="ident" id="2330812">obj</span><span class="op" id="2330815">.</span><span class="ident" id="2330816">Name</span><span class="op" id="2330820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2330823">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2330826">if</span>&nbsp;<span class="ident" id="2330829">alt</span>&nbsp;<span class="op" id="2330833">!=</span>&nbsp;<span class="ident" id="2330836">nil</span>&nbsp;<span class="op" id="2330840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2330844">prevDecl</span>&nbsp;<span class="op" id="2330853">:=</span>&nbsp;<span class="string" id="2330856">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2330861">if</span>&nbsp;<span class="ident" id="2330864">pos</span>&nbsp;<span class="op" id="2330868">:=</span>&nbsp;<span class="ident" id="2330871">alt</span><span class="op" id="2330874">.</span><span class="ident" id="2330875">Pos</span><span class="op" id="2330878">(</span><span class="op" id="2330879">)</span><span class="op" id="2330880">;</span>&nbsp;<span class="ident" id="2330882">pos</span><span class="op" id="2330885">.</span><span class="ident" id="2330886">IsValid</span><span class="op" id="2330893">(</span><span class="op" id="2330894">)</span>&nbsp;<span class="op" id="2330896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2330901">prevDecl</span>&nbsp;<span class="op" id="2330910">=</span>&nbsp;<span class="ident" id="2330912">fmt</span><span class="op" id="2330915">.</span><span class="ident" id="2330916">Sprintf</span><span class="op" id="2330923">(</span><span class="string" id="2330924">&#34;\n\tprevious&nbsp;declaration&nbsp;at&nbsp;%s&#34;</span><span class="op" id="2330956">,</span>&nbsp;<span class="ident" id="2330958">p</span><span class="op" id="2330959">.</span><span class="ident" id="2330960">fset</span><span class="op" id="2330964">.</span><span class="ident" id="2330965">Position</span><span class="op" id="2330973">(</span><span class="ident" id="2330974">pos</span><span class="op" id="2330977">)</span><span class="op" id="2330978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2330982">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2330986">p</span><span class="op" id="2330987">.</span><span class="builtintype" id="2330988">error</span><span class="op" id="2330993">(</span><span class="ident" id="2330994">obj</span><span class="op" id="2330997">.</span><span class="ident" id="2330998">Pos</span><span class="op" id="2331001">(</span><span class="op" id="2331002">)</span><span class="op" id="2331003">,</span>&nbsp;<span class="ident" id="2331005">fmt</span><span class="op" id="2331008">.</span><span class="ident" id="2331009">Sprintf</span><span class="op" id="2331016">(</span><span class="string" id="2331017">&#34;%s&nbsp;redeclared&nbsp;in&nbsp;this&nbsp;block%s&#34;</span><span class="op" id="2331048">,</span>&nbsp;<span class="ident" id="2331050">obj</span><span class="op" id="2331053">.</span><span class="ident" id="2331054">Name</span><span class="op" id="2331058">,</span>&nbsp;<span class="ident" id="2331060">prevDecl</span><span class="op" id="2331068">)</span><span class="op" id="2331069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2331072">}</span><br>
<span class="lineno"></span><span class="op" id="2331074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2331077">func</span>&nbsp;<span class="ident" id="2331082">resolve</span><span class="op" id="2331089">(</span><span class="ident" id="2331090">scope</span>&nbsp;<span class="op" id="2331096">*</span><span class="ident" id="2331097">Scope</span><span class="op" id="2331102">,</span>&nbsp;<span class="ident" id="2331104">ident</span>&nbsp;<span class="op" id="2331110">*</span><span class="ident" id="2331111">Ident</span><span class="op" id="2331116">)</span>&nbsp;<span class="builtintype" id="2331118">bool</span>&nbsp;<span class="op" id="2331123">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2331126">for</span>&nbsp;<span class="op" id="2331130">;</span>&nbsp;<span class="ident" id="2331132">scope</span>&nbsp;<span class="op" id="2331138">!=</span>&nbsp;<span class="ident" id="2331141">nil</span><span class="op" id="2331144">;</span>&nbsp;<span class="ident" id="2331146">scope</span>&nbsp;<span class="op" id="2331152">=</span>&nbsp;<span class="ident" id="2331154">scope</span><span class="op" id="2331159">.</span><span class="ident" id="2331160">Outer</span>&nbsp;<span class="op" id="2331166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2331170">if</span>&nbsp;<span class="ident" id="2331173">obj</span>&nbsp;<span class="op" id="2331177">:=</span>&nbsp;<span class="ident" id="2331180">scope</span><span class="op" id="2331185">.</span><span class="ident" id="2331186">Lookup</span><span class="op" id="2331192">(</span><span class="ident" id="2331193">ident</span><span class="op" id="2331198">.</span><span class="ident" id="2331199">Name</span><span class="op" id="2331203">)</span><span class="op" id="2331204">;</span>&nbsp;<span class="ident" id="2331206">obj</span>&nbsp;<span class="op" id="2331210">!=</span>&nbsp;<span class="ident" id="2331213">nil</span>&nbsp;<span class="op" id="2331217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2331222">ident</span><span class="op" id="2331227">.</span><span class="ident" id="2331228">Obj</span>&nbsp;<span class="op" id="2331232">=</span>&nbsp;<span class="ident" id="2331234">obj</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2331241">return</span>&nbsp;<span class="builtintype" id="2331248">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2331255">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2331258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2331261">return</span>&nbsp;<span class="builtintype" id="2331268">false</span><br>
<span class="lineno"></span><span class="op" id="2331274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2331277">//&nbsp;An&nbsp;Importer&nbsp;resolves&nbsp;import&nbsp;paths&nbsp;to&nbsp;package&nbsp;Objects.</span><br>
<span class="lineno">55</span><span class="comment" id="2331334">//&nbsp;The&nbsp;imports&nbsp;map&nbsp;records&nbsp;the&nbsp;packages&nbsp;already&nbsp;imported,</span><br>
<span class="lineno"></span><span class="comment" id="2331392">//&nbsp;indexed&nbsp;by&nbsp;package&nbsp;id&nbsp;(canonical&nbsp;import&nbsp;path).</span><br>
<span class="lineno"></span><span class="comment" id="2331442">//&nbsp;An&nbsp;Importer&nbsp;must&nbsp;determine&nbsp;the&nbsp;canonical&nbsp;import&nbsp;path&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="2331502">//&nbsp;check&nbsp;the&nbsp;map&nbsp;to&nbsp;see&nbsp;if&nbsp;it&nbsp;is&nbsp;already&nbsp;present&nbsp;in&nbsp;the&nbsp;imports&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="2331571">//&nbsp;If&nbsp;so,&nbsp;the&nbsp;Importer&nbsp;can&nbsp;return&nbsp;the&nbsp;map&nbsp;entry.&nbsp;&nbsp;Otherwise,&nbsp;the</span><br>
<span class="lineno">60</span><span class="comment" id="2331636">//&nbsp;Importer&nbsp;should&nbsp;load&nbsp;the&nbsp;package&nbsp;data&nbsp;for&nbsp;the&nbsp;given&nbsp;path&nbsp;into</span><br>
<span class="lineno"></span><span class="comment" id="2331701">//&nbsp;a&nbsp;new&nbsp;*Object&nbsp;(pkg),&nbsp;record&nbsp;pkg&nbsp;in&nbsp;the&nbsp;imports&nbsp;map,&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="2331765">//&nbsp;return&nbsp;pkg.</span><br>
<span class="lineno"></span><span class="keyword" id="2331780">type</span>&nbsp;<span class="ident" id="2331785">Importer</span>&nbsp;<span class="keyword" id="2331794">func</span><span class="op" id="2331798">(</span><span class="ident" id="2331799">imports</span>&nbsp;<span class="keyword" id="2331807">map</span><span class="op" id="2331810">[</span><span class="builtintype" id="2331811">string</span><span class="op" id="2331817">]</span><span class="op" id="2331818">*</span><span class="ident" id="2331819">Object</span><span class="op" id="2331825">,</span>&nbsp;<span class="ident" id="2331827">path</span>&nbsp;<span class="builtintype" id="2331832">string</span><span class="op" id="2331838">)</span>&nbsp;<span class="op" id="2331840">(</span><span class="ident" id="2331841">pkg</span>&nbsp;<span class="op" id="2331845">*</span><span class="ident" id="2331846">Object</span><span class="op" id="2331852">,</span>&nbsp;<span class="ident" id="2331854">err</span>&nbsp;<span class="builtintype" id="2331858">error</span><span class="op" id="2331863">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="2331866">//&nbsp;NewPackage&nbsp;creates&nbsp;a&nbsp;new&nbsp;Package&nbsp;node&nbsp;from&nbsp;a&nbsp;set&nbsp;of&nbsp;File&nbsp;nodes.&nbsp;It&nbsp;resolves</span><br>
<span class="lineno"></span><span class="comment" id="2331945">//&nbsp;unresolved&nbsp;identifiers&nbsp;across&nbsp;files&nbsp;and&nbsp;updates&nbsp;each&nbsp;file&#39;s&nbsp;Unresolved&nbsp;list</span><br>
<span class="lineno"></span><span class="comment" id="2332024">//&nbsp;accordingly.&nbsp;If&nbsp;a&nbsp;non-nil&nbsp;importer&nbsp;and&nbsp;universe&nbsp;scope&nbsp;are&nbsp;provided,&nbsp;they&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="2332104">//&nbsp;used&nbsp;to&nbsp;resolve&nbsp;identifiers&nbsp;not&nbsp;declared&nbsp;in&nbsp;any&nbsp;of&nbsp;the&nbsp;package&nbsp;files.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="2332181">//&nbsp;remaining&nbsp;unresolved&nbsp;identifiers&nbsp;are&nbsp;reported&nbsp;as&nbsp;undeclared.&nbsp;If&nbsp;the&nbsp;files</span><br>
<span class="lineno">70</span><span class="comment" id="2332258">//&nbsp;belong&nbsp;to&nbsp;different&nbsp;packages,&nbsp;one&nbsp;package&nbsp;name&nbsp;is&nbsp;selected&nbsp;and&nbsp;files&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="2332335">//&nbsp;different&nbsp;package&nbsp;names&nbsp;are&nbsp;reported&nbsp;and&nbsp;then&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="2332393">//&nbsp;The&nbsp;result&nbsp;is&nbsp;a&nbsp;package&nbsp;node&nbsp;and&nbsp;a&nbsp;scanner.ErrorList&nbsp;if&nbsp;there&nbsp;were&nbsp;errors.</span><br>
<span class="lineno"></span><span class="comment" id="2332471">//</span><br>
<span class="lineno"></span><span class="keyword" id="2332474">func</span>&nbsp;<span class="ident" id="2332479">NewPackage</span><span class="op" id="2332489">(</span><span class="ident" id="2332490">fset</span>&nbsp;<span class="op" id="2332495">*</span><span class="ident" id="2332496">token</span><span class="op" id="2332501">.</span><span class="ident" id="2332502">FileSet</span><span class="op" id="2332509">,</span>&nbsp;<span class="ident" id="2332511">files</span>&nbsp;<span class="keyword" id="2332517">map</span><span class="op" id="2332520">[</span><span class="builtintype" id="2332521">string</span><span class="op" id="2332527">]</span><span class="op" id="2332528">*</span><span class="ident" id="2332529">File</span><span class="op" id="2332533">,</span>&nbsp;<span class="ident" id="2332535">importer</span>&nbsp;<span class="ident" id="2332544">Importer</span><span class="op" id="2332552">,</span>&nbsp;<span class="ident" id="2332554">universe</span>&nbsp;<span class="op" id="2332563">*</span><span class="ident" id="2332564">Scope</span><span class="op" id="2332569">)</span>&nbsp;<span class="op" id="2332571">(</span><span class="op" id="2332572">*</span><span class="ident" id="2332573">Package</span><span class="op" id="2332580">,</span>&nbsp;<span class="builtintype" id="2332582">error</span><span class="op" id="2332587">)</span>&nbsp;<span class="op" id="2332589">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2332592">var</span>&nbsp;<span class="ident" id="2332596">p</span>&nbsp;<span class="ident" id="2332598">pkgBuilder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2332610">p</span><span class="op" id="2332611">.</span><span class="ident" id="2332612">fset</span>&nbsp;<span class="op" id="2332617">=</span>&nbsp;<span class="ident" id="2332619">fset</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2332626">//&nbsp;complete&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2332653">pkgName</span>&nbsp;<span class="op" id="2332661">:=</span>&nbsp;<span class="string" id="2332664">&#34;&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2332668">pkgScope</span>&nbsp;<span class="op" id="2332677">:=</span>&nbsp;<span class="ident" id="2332680">NewScope</span><span class="op" id="2332688">(</span><span class="ident" id="2332689">universe</span><span class="op" id="2332697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2332700">for</span>&nbsp;<span class="ident" id="2332704">_</span><span class="op" id="2332705">,</span>&nbsp;<span class="ident" id="2332707">file</span>&nbsp;<span class="op" id="2332712">:=</span>&nbsp;<span class="keyword" id="2332715">range</span>&nbsp;<span class="ident" id="2332721">files</span>&nbsp;<span class="op" id="2332727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2332731">//&nbsp;package&nbsp;names&nbsp;must&nbsp;match</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2332761">switch</span>&nbsp;<span class="ident" id="2332768">name</span>&nbsp;<span class="op" id="2332773">:=</span>&nbsp;<span class="ident" id="2332776">file</span><span class="op" id="2332780">.</span><span class="ident" id="2332781">Name</span><span class="op" id="2332785">.</span><span class="ident" id="2332786">Name</span><span class="op" id="2332790">;</span>&nbsp;<span class="op" id="2332792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2332796">case</span>&nbsp;<span class="ident" id="2332801">pkgName</span>&nbsp;<span class="op" id="2332809">==</span>&nbsp;<span class="string" id="2332812">&#34;&#34;</span><span class="op" id="2332814">:</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2332819">pkgName</span>&nbsp;<span class="op" id="2332827">=</span>&nbsp;<span class="ident" id="2332829">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2332836">case</span>&nbsp;<span class="ident" id="2332841">name</span>&nbsp;<span class="op" id="2332846">!=</span>&nbsp;<span class="ident" id="2332849">pkgName</span><span class="op" id="2332856">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2332861">p</span><span class="op" id="2332862">.</span><span class="ident" id="2332863">errorf</span><span class="op" id="2332869">(</span><span class="ident" id="2332870">file</span><span class="op" id="2332874">.</span><span class="ident" id="2332875">Package</span><span class="op" id="2332882">,</span>&nbsp;<span class="string" id="2332884">&#34;package&nbsp;%s;&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="2332909">,</span>&nbsp;<span class="ident" id="2332911">name</span><span class="op" id="2332915">,</span>&nbsp;<span class="ident" id="2332917">pkgName</span><span class="op" id="2332924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2332929">continue</span>&nbsp;<span class="comment" id="2332938">//&nbsp;ignore&nbsp;this&nbsp;file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2332960">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2332965">//&nbsp;collect&nbsp;top-level&nbsp;file&nbsp;objects&nbsp;in&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2333018">for</span>&nbsp;<span class="ident" id="2333022">_</span><span class="op" id="2333023">,</span>&nbsp;<span class="ident" id="2333025">obj</span>&nbsp;<span class="op" id="2333029">:=</span>&nbsp;<span class="keyword" id="2333032">range</span>&nbsp;<span class="ident" id="2333038">file</span><span class="op" id="2333042">.</span><span class="ident" id="2333043">Scope</span><span class="op" id="2333048">.</span><span class="ident" id="2333049">Objects</span>&nbsp;<span class="op" id="2333057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2333062">p</span><span class="op" id="2333063">.</span><span class="ident" id="2333064">declare</span><span class="op" id="2333071">(</span><span class="ident" id="2333072">pkgScope</span><span class="op" id="2333080">,</span>&nbsp;<span class="ident" id="2333082">nil</span><span class="op" id="2333085">,</span>&nbsp;<span class="ident" id="2333087">obj</span><span class="op" id="2333090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2333094">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2333097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2333101">//&nbsp;package&nbsp;global&nbsp;mapping&nbsp;of&nbsp;imported&nbsp;package&nbsp;ids&nbsp;to&nbsp;package&nbsp;objects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2333171">imports</span>&nbsp;<span class="op" id="2333179">:=</span>&nbsp;<span class="builtinfunc" id="2333182">make</span><span class="op" id="2333186">(</span><span class="keyword" id="2333187">map</span><span class="op" id="2333190">[</span><span class="builtintype" id="2333191">string</span><span class="op" id="2333197">]</span><span class="op" id="2333198">*</span><span class="ident" id="2333199">Object</span><span class="op" id="2333205">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2333209">//&nbsp;complete&nbsp;file&nbsp;scopes&nbsp;with&nbsp;imports&nbsp;and&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2333271">for</span>&nbsp;<span class="ident" id="2333275">_</span><span class="op" id="2333276">,</span>&nbsp;<span class="ident" id="2333278">file</span>&nbsp;<span class="op" id="2333283">:=</span>&nbsp;<span class="keyword" id="2333286">range</span>&nbsp;<span class="ident" id="2333292">files</span>&nbsp;<span class="op" id="2333298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2333302">//&nbsp;ignore&nbsp;file&nbsp;if&nbsp;it&nbsp;belongs&nbsp;to&nbsp;a&nbsp;different&nbsp;package</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2333356">//&nbsp;(error&nbsp;has&nbsp;already&nbsp;been&nbsp;reported)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2333395">if</span>&nbsp;<span class="ident" id="2333398">file</span><span class="op" id="2333402">.</span><span class="ident" id="2333403">Name</span><span class="op" id="2333407">.</span><span class="ident" id="2333408">Name</span>&nbsp;<span class="op" id="2333413">!=</span>&nbsp;<span class="ident" id="2333416">pkgName</span>&nbsp;<span class="op" id="2333424">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2333429">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2333440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2333445">//&nbsp;build&nbsp;file&nbsp;scope&nbsp;by&nbsp;processing&nbsp;all&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2333493">importErrors</span>&nbsp;<span class="op" id="2333506">:=</span>&nbsp;<span class="builtintype" id="2333509">false</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2333517">fileScope</span>&nbsp;<span class="op" id="2333527">:=</span>&nbsp;<span class="ident" id="2333530">NewScope</span><span class="op" id="2333538">(</span><span class="ident" id="2333539">pkgScope</span><span class="op" id="2333547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2333551">for</span>&nbsp;<span class="ident" id="2333555">_</span><span class="op" id="2333556">,</span>&nbsp;<span class="ident" id="2333558">spec</span>&nbsp;<span class="op" id="2333563">:=</span>&nbsp;<span class="keyword" id="2333566">range</span>&nbsp;<span class="ident" id="2333572">file</span><span class="op" id="2333576">.</span><span class="ident" id="2333577">Imports</span>&nbsp;<span class="op" id="2333585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2333590">if</span>&nbsp;<span class="ident" id="2333593">importer</span>&nbsp;<span class="op" id="2333602">==</span>&nbsp;<span class="ident" id="2333605">nil</span>&nbsp;<span class="op" id="2333609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2333615">importErrors</span>&nbsp;<span class="op" id="2333628">=</span>&nbsp;<span class="builtintype" id="2333630">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2333639">continue</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2333651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2333656">path</span><span class="op" id="2333660">,</span>&nbsp;<span class="ident" id="2333662">_</span>&nbsp;<span class="op" id="2333664">:=</span>&nbsp;<span class="ident" id="2333667">strconv</span><span class="op" id="2333674">.</span><span class="ident" id="2333675">Unquote</span><span class="op" id="2333682">(</span><span class="ident" id="2333683">spec</span><span class="op" id="2333687">.</span><span class="ident" id="2333688">Path</span><span class="op" id="2333692">.</span><span class="ident" id="2333693">Value</span><span class="op" id="2333698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2333703">pkg</span><span class="op" id="2333706">,</span>&nbsp;<span class="ident" id="2333708">err</span>&nbsp;<span class="op" id="2333712">:=</span>&nbsp;<span class="ident" id="2333715">importer</span><span class="op" id="2333723">(</span><span class="ident" id="2333724">imports</span><span class="op" id="2333731">,</span>&nbsp;<span class="ident" id="2333733">path</span><span class="op" id="2333737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2333742">if</span>&nbsp;<span class="ident" id="2333745">err</span>&nbsp;<span class="op" id="2333749">!=</span>&nbsp;<span class="ident" id="2333752">nil</span>&nbsp;<span class="op" id="2333756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2333762">p</span><span class="op" id="2333763">.</span><span class="ident" id="2333764">errorf</span><span class="op" id="2333770">(</span><span class="ident" id="2333771">spec</span><span class="op" id="2333775">.</span><span class="ident" id="2333776">Path</span><span class="op" id="2333780">.</span><span class="ident" id="2333781">Pos</span><span class="op" id="2333784">(</span><span class="op" id="2333785">)</span><span class="op" id="2333786">,</span>&nbsp;<span class="string" id="2333788">&#34;could&nbsp;not&nbsp;import&nbsp;%s&nbsp;(%s)&#34;</span><span class="op" id="2333814">,</span>&nbsp;<span class="ident" id="2333816">path</span><span class="op" id="2333820">,</span>&nbsp;<span class="ident" id="2333822">err</span><span class="op" id="2333825">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2333831">importErrors</span>&nbsp;<span class="op" id="2333844">=</span>&nbsp;<span class="builtintype" id="2333846">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2333855">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2333867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2333872">//&nbsp;TODO(gri)&nbsp;If&nbsp;a&nbsp;local&nbsp;package&nbsp;name&nbsp;!=&nbsp;&#34;.&#34;&nbsp;is&nbsp;provided,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2333932">//&nbsp;global&nbsp;identifier&nbsp;resolution&nbsp;could&nbsp;proceed&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2333993">//&nbsp;import&nbsp;failed.&nbsp;Consider&nbsp;adjusting&nbsp;the&nbsp;logic&nbsp;here&nbsp;a&nbsp;bit.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2334056">//&nbsp;local&nbsp;name&nbsp;overrides&nbsp;imported&nbsp;package&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2334105">name</span>&nbsp;<span class="op" id="2334110">:=</span>&nbsp;<span class="ident" id="2334113">pkg</span><span class="op" id="2334116">.</span><span class="ident" id="2334117">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2334125">if</span>&nbsp;<span class="ident" id="2334128">spec</span><span class="op" id="2334132">.</span><span class="ident" id="2334133">Name</span>&nbsp;<span class="op" id="2334138">!=</span>&nbsp;<span class="ident" id="2334141">nil</span>&nbsp;<span class="op" id="2334145">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2334151">name</span>&nbsp;<span class="op" id="2334156">=</span>&nbsp;<span class="ident" id="2334158">spec</span><span class="op" id="2334162">.</span><span class="ident" id="2334163">Name</span><span class="op" id="2334167">.</span><span class="ident" id="2334168">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2334176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2334182">//&nbsp;add&nbsp;import&nbsp;to&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2334213">if</span>&nbsp;<span class="ident" id="2334216">name</span>&nbsp;<span class="op" id="2334221">==</span>&nbsp;<span class="string" id="2334224">&#34;.&#34;</span>&nbsp;<span class="op" id="2334228">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2334234">//&nbsp;merge&nbsp;imported&nbsp;scope&nbsp;with&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2334278">for</span>&nbsp;<span class="ident" id="2334282">_</span><span class="op" id="2334283">,</span>&nbsp;<span class="ident" id="2334285">obj</span>&nbsp;<span class="op" id="2334289">:=</span>&nbsp;<span class="keyword" id="2334292">range</span>&nbsp;<span class="ident" id="2334298">pkg</span><span class="op" id="2334301">.</span><span class="ident" id="2334302">Data</span><span class="op" id="2334306">.</span><span class="op" id="2334307">(</span><span class="op" id="2334308">*</span><span class="ident" id="2334309">Scope</span><span class="op" id="2334314">)</span><span class="op" id="2334315">.</span><span class="ident" id="2334316">Objects</span>&nbsp;<span class="op" id="2334324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2334331">p</span><span class="op" id="2334332">.</span><span class="ident" id="2334333">declare</span><span class="op" id="2334340">(</span><span class="ident" id="2334341">fileScope</span><span class="op" id="2334350">,</span>&nbsp;<span class="ident" id="2334352">pkgScope</span><span class="op" id="2334360">,</span>&nbsp;<span class="ident" id="2334362">obj</span><span class="op" id="2334365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2334371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2334376">}</span>&nbsp;<span class="keyword" id="2334378">else</span>&nbsp;<span class="keyword" id="2334383">if</span>&nbsp;<span class="ident" id="2334386">name</span>&nbsp;<span class="op" id="2334391">!=</span>&nbsp;<span class="string" id="2334394">&#34;_&#34;</span>&nbsp;<span class="op" id="2334398">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2334404">//&nbsp;declare&nbsp;imported&nbsp;package&nbsp;object&nbsp;in&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2334457">//&nbsp;(do&nbsp;not&nbsp;re-use&nbsp;pkg&nbsp;in&nbsp;the&nbsp;file&nbsp;scope&nbsp;but&nbsp;create</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2334512">//&nbsp;a&nbsp;new&nbsp;object&nbsp;instead;&nbsp;the&nbsp;Decl&nbsp;field&nbsp;is&nbsp;different</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2334569">//&nbsp;for&nbsp;different&nbsp;files)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2334597">obj</span>&nbsp;<span class="op" id="2334601">:=</span>&nbsp;<span class="ident" id="2334604">NewObj</span><span class="op" id="2334610">(</span><span class="ident" id="2334611">Pkg</span><span class="op" id="2334614">,</span>&nbsp;<span class="ident" id="2334616">name</span><span class="op" id="2334620">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2334626">obj</span><span class="op" id="2334629">.</span><span class="ident" id="2334630">Decl</span>&nbsp;<span class="op" id="2334635">=</span>&nbsp;<span class="ident" id="2334637">spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2334646">obj</span><span class="op" id="2334649">.</span><span class="ident" id="2334650">Data</span>&nbsp;<span class="op" id="2334655">=</span>&nbsp;<span class="ident" id="2334657">pkg</span><span class="op" id="2334660">.</span><span class="ident" id="2334661">Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2334670">p</span><span class="op" id="2334671">.</span><span class="ident" id="2334672">declare</span><span class="op" id="2334679">(</span><span class="ident" id="2334680">fileScope</span><span class="op" id="2334689">,</span>&nbsp;<span class="ident" id="2334691">pkgScope</span><span class="op" id="2334699">,</span>&nbsp;<span class="ident" id="2334701">obj</span><span class="op" id="2334704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2334709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2334713">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2334718">//&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2334743">if</span>&nbsp;<span class="ident" id="2334746">importErrors</span>&nbsp;<span class="op" id="2334759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2334764">//&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;universe&nbsp;scope&nbsp;without&nbsp;correct&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2334823">//&nbsp;(objects&nbsp;in&nbsp;the&nbsp;universe&nbsp;may&nbsp;be&nbsp;shadowed&nbsp;by&nbsp;imports;</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2334882">//&nbsp;with&nbsp;missing&nbsp;imports,&nbsp;identifiers&nbsp;might&nbsp;get&nbsp;resolved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2334941">//&nbsp;incorrectly&nbsp;to&nbsp;universe&nbsp;objects)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2334980">pkgScope</span><span class="op" id="2334988">.</span><span class="ident" id="2334989">Outer</span>&nbsp;<span class="op" id="2334995">=</span>&nbsp;<span class="ident" id="2334997">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2335003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2335007">i</span>&nbsp;<span class="op" id="2335009">:=</span>&nbsp;<span class="num" id="2335012">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2335016">for</span>&nbsp;<span class="ident" id="2335020">_</span><span class="op" id="2335021">,</span>&nbsp;<span class="ident" id="2335023">ident</span>&nbsp;<span class="op" id="2335029">:=</span>&nbsp;<span class="keyword" id="2335032">range</span>&nbsp;<span class="ident" id="2335038">file</span><span class="op" id="2335042">.</span><span class="ident" id="2335043">Unresolved</span>&nbsp;<span class="op" id="2335054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2335059">if</span>&nbsp;<span class="op" id="2335062">!</span><span class="ident" id="2335063">resolve</span><span class="op" id="2335070">(</span><span class="ident" id="2335071">fileScope</span><span class="op" id="2335080">,</span>&nbsp;<span class="ident" id="2335082">ident</span><span class="op" id="2335087">)</span>&nbsp;<span class="op" id="2335089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2335095">p</span><span class="op" id="2335096">.</span><span class="ident" id="2335097">errorf</span><span class="op" id="2335103">(</span><span class="ident" id="2335104">ident</span><span class="op" id="2335109">.</span><span class="ident" id="2335110">Pos</span><span class="op" id="2335113">(</span><span class="op" id="2335114">)</span><span class="op" id="2335115">,</span>&nbsp;<span class="string" id="2335117">&#34;undeclared&nbsp;name:&nbsp;%s&#34;</span><span class="op" id="2335138">,</span>&nbsp;<span class="ident" id="2335140">ident</span><span class="op" id="2335145">.</span><span class="ident" id="2335146">Name</span><span class="op" id="2335150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2335156">file</span><span class="op" id="2335160">.</span><span class="ident" id="2335161">Unresolved</span><span class="op" id="2335171">[</span><span class="ident" id="2335172">i</span><span class="op" id="2335173">]</span>&nbsp;<span class="op" id="2335175">=</span>&nbsp;<span class="ident" id="2335177">ident</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2335187">i</span><span class="op" id="2335188">++</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2335194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2335199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2335203">file</span><span class="op" id="2335207">.</span><span class="ident" id="2335208">Unresolved</span>&nbsp;<span class="op" id="2335219">=</span>&nbsp;<span class="ident" id="2335221">file</span><span class="op" id="2335225">.</span><span class="ident" id="2335226">Unresolved</span><span class="op" id="2335236">[</span><span class="num" id="2335237">0</span><span class="op" id="2335238">:</span><span class="ident" id="2335239">i</span><span class="op" id="2335240">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2335244">pkgScope</span><span class="op" id="2335252">.</span><span class="ident" id="2335253">Outer</span>&nbsp;<span class="op" id="2335259">=</span>&nbsp;<span class="ident" id="2335261">universe</span>&nbsp;<span class="comment" id="2335270">//&nbsp;reset&nbsp;universe&nbsp;scope</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2335295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2335299">p</span><span class="op" id="2335300">.</span><span class="ident" id="2335301">errors</span><span class="op" id="2335307">.</span><span class="ident" id="2335308">Sort</span><span class="op" id="2335312">(</span><span class="op" id="2335313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2335316">return</span>&nbsp;<span class="op" id="2335323">&amp;</span><span class="ident" id="2335324">Package</span><span class="op" id="2335331">{</span><span class="ident" id="2335332">pkgName</span><span class="op" id="2335339">,</span>&nbsp;<span class="ident" id="2335341">pkgScope</span><span class="op" id="2335349">,</span>&nbsp;<span class="ident" id="2335351">imports</span><span class="op" id="2335358">,</span>&nbsp;<span class="ident" id="2335360">files</span><span class="op" id="2335365">}</span><span class="op" id="2335366">,</span>&nbsp;<span class="ident" id="2335368">p</span><span class="op" id="2335369">.</span><span class="ident" id="2335370">errors</span><span class="op" id="2335376">.</span><span class="ident" id="2335377">Err</span><span class="op" id="2335380">(</span><span class="op" id="2335381">)</span><br>
<span class="lineno"></span><span class="op" id="2335383">}</span>
</div>
</body>
</html>
