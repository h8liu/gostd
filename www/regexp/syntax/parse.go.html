<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5232930">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5232986">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5233040">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5233091">package</span>&nbsp;<span class="ident" id="5233099">syntax</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5233107">import</span>&nbsp;<span class="op" id="5233114">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5233117">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5233125">&#34;strings&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5233136">&#34;unicode&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5233147">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="5233162">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5233165">//&nbsp;An&nbsp;Error&nbsp;describes&nbsp;a&nbsp;failure&nbsp;to&nbsp;parse&nbsp;a&nbsp;regular&nbsp;expression</span><br>
<span class="lineno">15</span><span class="comment" id="5233227">//&nbsp;and&nbsp;gives&nbsp;the&nbsp;offending&nbsp;expression.</span><br>
<span class="lineno"></span><span class="keyword" id="5233266">type</span>&nbsp;<span class="ident" id="5233271">Error</span>&nbsp;<span class="keyword" id="5233277">struct</span>&nbsp;<span class="op" id="5233284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5233287">Code</span>&nbsp;<span class="ident" id="5233292">ErrorCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5233303">Expr</span>&nbsp;<span class="builtintype" id="5233308">string</span><br>
<span class="lineno"></span><span class="op" id="5233315">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="5233318">func</span>&nbsp;<span class="op" id="5233323">(</span><span class="ident" id="5233324">e</span>&nbsp;<span class="op" id="5233326">*</span><span class="ident" id="5233327">Error</span><span class="op" id="5233332">)</span>&nbsp;<span class="ident" id="5233334">Error</span><span class="op" id="5233339">(</span><span class="op" id="5233340">)</span>&nbsp;<span class="builtintype" id="5233342">string</span>&nbsp;<span class="op" id="5233349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5233352">return</span>&nbsp;<span class="string" id="5233359">&#34;error&nbsp;parsing&nbsp;regexp:&nbsp;&#34;</span>&nbsp;<span class="op" id="5233384">+</span>&nbsp;<span class="ident" id="5233386">e</span><span class="op" id="5233387">.</span><span class="ident" id="5233388">Code</span><span class="op" id="5233392">.</span><span class="ident" id="5233393">String</span><span class="op" id="5233399">(</span><span class="op" id="5233400">)</span>&nbsp;<span class="op" id="5233402">+</span>&nbsp;<span class="string" id="5233404">&#34;:&nbsp;`&#34;</span>&nbsp;<span class="op" id="5233410">+</span>&nbsp;<span class="ident" id="5233412">e</span><span class="op" id="5233413">.</span><span class="ident" id="5233414">Expr</span>&nbsp;<span class="op" id="5233419">+</span>&nbsp;<span class="string" id="5233421">&#34;`&#34;</span><br>
<span class="lineno"></span><span class="op" id="5233425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5233428">//&nbsp;An&nbsp;ErrorCode&nbsp;describes&nbsp;a&nbsp;failure&nbsp;to&nbsp;parse&nbsp;a&nbsp;regular&nbsp;expression.</span><br>
<span class="lineno"></span><span class="keyword" id="5233495">type</span>&nbsp;<span class="ident" id="5233500">ErrorCode</span>&nbsp;<span class="builtintype" id="5233510">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5233518">const</span>&nbsp;<span class="op" id="5233524">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5233527">//&nbsp;Unexpected&nbsp;error</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5233548">ErrInternalError</span>&nbsp;<span class="ident" id="5233565">ErrorCode</span>&nbsp;<span class="op" id="5233575">=</span>&nbsp;<span class="string" id="5233577">&#34;regexp/syntax:&nbsp;internal&nbsp;error&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5233611">//&nbsp;Parse&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5233628">ErrInvalidCharClass</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233653">ErrorCode</span>&nbsp;<span class="op" id="5233663">=</span>&nbsp;<span class="string" id="5233665">&#34;invalid&nbsp;character&nbsp;class&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5233692">ErrInvalidCharRange</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233717">ErrorCode</span>&nbsp;<span class="op" id="5233727">=</span>&nbsp;<span class="string" id="5233729">&#34;invalid&nbsp;character&nbsp;class&nbsp;range&#34;</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5233762">ErrInvalidEscape</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233787">ErrorCode</span>&nbsp;<span class="op" id="5233797">=</span>&nbsp;<span class="string" id="5233799">&#34;invalid&nbsp;escape&nbsp;sequence&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5233826">ErrInvalidNamedCapture</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5233851">ErrorCode</span>&nbsp;<span class="op" id="5233861">=</span>&nbsp;<span class="string" id="5233863">&#34;invalid&nbsp;named&nbsp;capture&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5233888">ErrInvalidPerlOp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233913">ErrorCode</span>&nbsp;<span class="op" id="5233923">=</span>&nbsp;<span class="string" id="5233925">&#34;invalid&nbsp;or&nbsp;unsupported&nbsp;Perl&nbsp;syntax&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5233963">ErrInvalidRepeatOp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233988">ErrorCode</span>&nbsp;<span class="op" id="5233998">=</span>&nbsp;<span class="string" id="5234000">&#34;invalid&nbsp;nested&nbsp;repetition&nbsp;operator&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5234038">ErrInvalidRepeatSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234063">ErrorCode</span>&nbsp;<span class="op" id="5234073">=</span>&nbsp;<span class="string" id="5234075">&#34;invalid&nbsp;repeat&nbsp;count&#34;</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5234099">ErrInvalidUTF8</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234124">ErrorCode</span>&nbsp;<span class="op" id="5234134">=</span>&nbsp;<span class="string" id="5234136">&#34;invalid&nbsp;UTF-8&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5234153">ErrMissingBracket</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234178">ErrorCode</span>&nbsp;<span class="op" id="5234188">=</span>&nbsp;<span class="string" id="5234190">&#34;missing&nbsp;closing&nbsp;]&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5234211">ErrMissingParen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234236">ErrorCode</span>&nbsp;<span class="op" id="5234246">=</span>&nbsp;<span class="string" id="5234248">&#34;missing&nbsp;closing&nbsp;)&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5234269">ErrMissingRepeatArgument</span>&nbsp;<span class="ident" id="5234294">ErrorCode</span>&nbsp;<span class="op" id="5234304">=</span>&nbsp;<span class="string" id="5234306">&#34;missing&nbsp;argument&nbsp;to&nbsp;repetition&nbsp;operator&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5234349">ErrTrailingBackslash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234374">ErrorCode</span>&nbsp;<span class="op" id="5234384">=</span>&nbsp;<span class="string" id="5234386">&#34;trailing&nbsp;backslash&nbsp;at&nbsp;end&nbsp;of&nbsp;expression&#34;</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5234429">ErrUnexpectedParen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234454">ErrorCode</span>&nbsp;<span class="op" id="5234464">=</span>&nbsp;<span class="string" id="5234466">&#34;unexpected&nbsp;)&#34;</span><br>
<span class="lineno"></span><span class="op" id="5234481">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5234484">func</span>&nbsp;<span class="op" id="5234489">(</span><span class="ident" id="5234490">e</span>&nbsp;<span class="ident" id="5234492">ErrorCode</span><span class="op" id="5234501">)</span>&nbsp;<span class="ident" id="5234503">String</span><span class="op" id="5234509">(</span><span class="op" id="5234510">)</span>&nbsp;<span class="builtintype" id="5234512">string</span>&nbsp;<span class="op" id="5234519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5234522">return</span>&nbsp;<span class="builtintype" id="5234529">string</span><span class="op" id="5234535">(</span><span class="ident" id="5234536">e</span><span class="op" id="5234537">)</span><br>
<span class="lineno">50</span><span class="op" id="5234539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5234542">//&nbsp;Flags&nbsp;control&nbsp;the&nbsp;behavior&nbsp;of&nbsp;the&nbsp;parser&nbsp;and&nbsp;record&nbsp;information&nbsp;about&nbsp;regexp&nbsp;context.</span><br>
<span class="lineno"></span><span class="keyword" id="5234631">type</span>&nbsp;<span class="ident" id="5234636">Flags</span>&nbsp;<span class="builtintype" id="5234642">uint16</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="5234650">const</span>&nbsp;<span class="op" id="5234656">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5234659">FoldCase</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234673">Flags</span>&nbsp;<span class="op" id="5234679">=</span>&nbsp;<span class="num" id="5234681">1</span>&nbsp;<span class="op" id="5234683">&lt;&lt;</span>&nbsp;<span class="ident" id="5234686">iota</span>&nbsp;<span class="comment" id="5234691">//&nbsp;case-insensitive&nbsp;match</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5234718">Literal</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5234750">//&nbsp;treat&nbsp;pattern&nbsp;as&nbsp;literal&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5234786">ClassNL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5234818">//&nbsp;allow&nbsp;character&nbsp;classes&nbsp;like&nbsp;[^a-z]&nbsp;and&nbsp;[[:space:]]&nbsp;to&nbsp;match&nbsp;newline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5234891">DotNL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5234923">//&nbsp;allow&nbsp;.&nbsp;to&nbsp;match&nbsp;newline</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5234952">OneLine</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5234984">//&nbsp;treat&nbsp;^&nbsp;and&nbsp;$&nbsp;as&nbsp;only&nbsp;matching&nbsp;at&nbsp;beginning&nbsp;and&nbsp;end&nbsp;of&nbsp;text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5235048">NonGreedy</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5235080">//&nbsp;make&nbsp;repetition&nbsp;operators&nbsp;default&nbsp;to&nbsp;non-greedy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5235132">PerlX</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5235164">//&nbsp;allow&nbsp;Perl&nbsp;extensions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5235190">UnicodeGroups</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5235222">//&nbsp;allow&nbsp;\p{Han},&nbsp;\P{Han}&nbsp;for&nbsp;Unicode&nbsp;group&nbsp;and&nbsp;negation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5235280">WasDollar</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5235312">//&nbsp;regexp&nbsp;OpEndText&nbsp;was&nbsp;$,&nbsp;not&nbsp;\z</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5235347">Simple</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5235379">//&nbsp;regexp&nbsp;contains&nbsp;no&nbsp;counted&nbsp;repetition</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5235422">MatchNL</span>&nbsp;<span class="op" id="5235430">=</span>&nbsp;<span class="ident" id="5235432">ClassNL</span>&nbsp;<span class="op" id="5235440">|</span>&nbsp;<span class="ident" id="5235442">DotNL</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5235450">Perl</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5235462">=</span>&nbsp;<span class="ident" id="5235464">ClassNL</span>&nbsp;<span class="op" id="5235472">|</span>&nbsp;<span class="ident" id="5235474">OneLine</span>&nbsp;<span class="op" id="5235482">|</span>&nbsp;<span class="ident" id="5235484">PerlX</span>&nbsp;<span class="op" id="5235490">|</span>&nbsp;<span class="ident" id="5235492">UnicodeGroups</span>&nbsp;<span class="comment" id="5235506">//&nbsp;as&nbsp;close&nbsp;to&nbsp;Perl&nbsp;as&nbsp;possible</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5235539">POSIX</span>&nbsp;<span class="ident" id="5235545">Flags</span>&nbsp;<span class="op" id="5235551">=</span>&nbsp;<span class="num" id="5235553">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5235595">//&nbsp;POSIX&nbsp;syntax</span><br>
<span class="lineno"></span><span class="op" id="5235611">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5235614">//&nbsp;Pseudo-ops&nbsp;for&nbsp;parsing&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="5235647">const</span>&nbsp;<span class="op" id="5235653">(</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5235656">opLeftParen</span>&nbsp;<span class="op" id="5235668">=</span>&nbsp;<span class="ident" id="5235670">opPseudo</span>&nbsp;<span class="op" id="5235679">+</span>&nbsp;<span class="ident" id="5235681">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5235687">opVerticalBar</span><br>
<span class="lineno"></span><span class="op" id="5235701">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5235704">type</span>&nbsp;<span class="ident" id="5235709">parser</span>&nbsp;<span class="keyword" id="5235716">struct</span>&nbsp;<span class="op" id="5235723">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5235726">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235738">Flags</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5235748">//&nbsp;parse&nbsp;mode&nbsp;flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5235769">stack</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5235781">[</span><span class="op" id="5235782">]</span><span class="op" id="5235783">*</span><span class="ident" id="5235784">Regexp</span>&nbsp;<span class="comment" id="5235791">//&nbsp;stack&nbsp;of&nbsp;parsed&nbsp;expressions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5235823">free</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5235835">*</span><span class="ident" id="5235836">Regexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5235844">numCap</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5235856">int</span>&nbsp;<span class="comment" id="5235860">//&nbsp;number&nbsp;of&nbsp;capturing&nbsp;groups&nbsp;seen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5235896">wholeRegexp</span>&nbsp;<span class="builtintype" id="5235908">string</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5235916">tmpClass</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5235928">[</span><span class="op" id="5235929">]</span><span class="builtintype" id="5235930">rune</span>&nbsp;<span class="comment" id="5235935">//&nbsp;temporary&nbsp;char&nbsp;class&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span><span class="op" id="5235970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5235973">func</span>&nbsp;<span class="op" id="5235978">(</span><span class="ident" id="5235979">p</span>&nbsp;<span class="op" id="5235981">*</span><span class="ident" id="5235982">parser</span><span class="op" id="5235988">)</span>&nbsp;<span class="ident" id="5235990">newRegexp</span><span class="op" id="5235999">(</span><span class="ident" id="5236000">op</span>&nbsp;<span class="ident" id="5236003">Op</span><span class="op" id="5236005">)</span>&nbsp;<span class="op" id="5236007">*</span><span class="ident" id="5236008">Regexp</span>&nbsp;<span class="op" id="5236015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236018">re</span>&nbsp;<span class="op" id="5236021">:=</span>&nbsp;<span class="ident" id="5236024">p</span><span class="op" id="5236025">.</span><span class="ident" id="5236026">free</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5236032">if</span>&nbsp;<span class="ident" id="5236035">re</span>&nbsp;<span class="op" id="5236038">!=</span>&nbsp;<span class="ident" id="5236041">nil</span>&nbsp;<span class="op" id="5236045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236049">p</span><span class="op" id="5236050">.</span><span class="ident" id="5236051">free</span>&nbsp;<span class="op" id="5236056">=</span>&nbsp;<span class="ident" id="5236058">re</span><span class="op" id="5236060">.</span><span class="ident" id="5236061">Sub0</span><span class="op" id="5236065">[</span><span class="num" id="5236066">0</span><span class="op" id="5236067">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5236071">*</span><span class="ident" id="5236072">re</span>&nbsp;<span class="op" id="5236075">=</span>&nbsp;<span class="ident" id="5236077">Regexp</span><span class="op" id="5236083">{</span><span class="op" id="5236084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5236087">}</span>&nbsp;<span class="keyword" id="5236089">else</span>&nbsp;<span class="op" id="5236094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236098">re</span>&nbsp;<span class="op" id="5236101">=</span>&nbsp;<span class="builtinfunc" id="5236103">new</span><span class="op" id="5236106">(</span><span class="ident" id="5236107">Regexp</span><span class="op" id="5236113">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5236116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236119">re</span><span class="op" id="5236121">.</span><span class="ident" id="5236122">Op</span>&nbsp;<span class="op" id="5236125">=</span>&nbsp;<span class="ident" id="5236127">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5236131">return</span>&nbsp;<span class="ident" id="5236138">re</span><br>
<span class="lineno"></span><span class="op" id="5236141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5236144">func</span>&nbsp;<span class="op" id="5236149">(</span><span class="ident" id="5236150">p</span>&nbsp;<span class="op" id="5236152">*</span><span class="ident" id="5236153">parser</span><span class="op" id="5236159">)</span>&nbsp;<span class="ident" id="5236161">reuse</span><span class="op" id="5236166">(</span><span class="ident" id="5236167">re</span>&nbsp;<span class="op" id="5236170">*</span><span class="ident" id="5236171">Regexp</span><span class="op" id="5236177">)</span>&nbsp;<span class="op" id="5236179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236182">re</span><span class="op" id="5236184">.</span><span class="ident" id="5236185">Sub0</span><span class="op" id="5236189">[</span><span class="num" id="5236190">0</span><span class="op" id="5236191">]</span>&nbsp;<span class="op" id="5236193">=</span>&nbsp;<span class="ident" id="5236195">p</span><span class="op" id="5236196">.</span><span class="ident" id="5236197">free</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236203">p</span><span class="op" id="5236204">.</span><span class="ident" id="5236205">free</span>&nbsp;<span class="op" id="5236210">=</span>&nbsp;<span class="ident" id="5236212">re</span><br>
<span class="lineno"></span><span class="op" id="5236215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="5236218">//&nbsp;Parse&nbsp;stack&nbsp;manipulation.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5236248">//&nbsp;push&nbsp;pushes&nbsp;the&nbsp;regexp&nbsp;re&nbsp;onto&nbsp;the&nbsp;parse&nbsp;stack&nbsp;and&nbsp;returns&nbsp;the&nbsp;regexp.</span><br>
<span class="lineno"></span><span class="keyword" id="5236322">func</span>&nbsp;<span class="op" id="5236327">(</span><span class="ident" id="5236328">p</span>&nbsp;<span class="op" id="5236330">*</span><span class="ident" id="5236331">parser</span><span class="op" id="5236337">)</span>&nbsp;<span class="ident" id="5236339">push</span><span class="op" id="5236343">(</span><span class="ident" id="5236344">re</span>&nbsp;<span class="op" id="5236347">*</span><span class="ident" id="5236348">Regexp</span><span class="op" id="5236354">)</span>&nbsp;<span class="op" id="5236356">*</span><span class="ident" id="5236357">Regexp</span>&nbsp;<span class="op" id="5236364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5236367">if</span>&nbsp;<span class="ident" id="5236370">re</span><span class="op" id="5236372">.</span><span class="ident" id="5236373">Op</span>&nbsp;<span class="op" id="5236376">==</span>&nbsp;<span class="ident" id="5236379">OpCharClass</span>&nbsp;<span class="op" id="5236391">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5236394">len</span><span class="op" id="5236397">(</span><span class="ident" id="5236398">re</span><span class="op" id="5236400">.</span><span class="ident" id="5236401">Rune</span><span class="op" id="5236405">)</span>&nbsp;<span class="op" id="5236407">==</span>&nbsp;<span class="num" id="5236410">2</span>&nbsp;<span class="op" id="5236412">&amp;&amp;</span>&nbsp;<span class="ident" id="5236415">re</span><span class="op" id="5236417">.</span><span class="ident" id="5236418">Rune</span><span class="op" id="5236422">[</span><span class="num" id="5236423">0</span><span class="op" id="5236424">]</span>&nbsp;<span class="op" id="5236426">==</span>&nbsp;<span class="ident" id="5236429">re</span><span class="op" id="5236431">.</span><span class="ident" id="5236432">Rune</span><span class="op" id="5236436">[</span><span class="num" id="5236437">1</span><span class="op" id="5236438">]</span>&nbsp;<span class="op" id="5236440">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5236444">//&nbsp;Single&nbsp;rune.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5236462">if</span>&nbsp;<span class="ident" id="5236465">p</span><span class="op" id="5236466">.</span><span class="ident" id="5236467">maybeConcat</span><span class="op" id="5236478">(</span><span class="ident" id="5236479">re</span><span class="op" id="5236481">.</span><span class="ident" id="5236482">Rune</span><span class="op" id="5236486">[</span><span class="num" id="5236487">0</span><span class="op" id="5236488">]</span><span class="op" id="5236489">,</span>&nbsp;<span class="ident" id="5236491">p</span><span class="op" id="5236492">.</span><span class="ident" id="5236493">flags</span><span class="op" id="5236498">&amp;^</span><span class="ident" id="5236500">FoldCase</span><span class="op" id="5236508">)</span>&nbsp;<span class="op" id="5236510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5236515">return</span>&nbsp;<span class="ident" id="5236522">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5236528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236532">re</span><span class="op" id="5236534">.</span><span class="ident" id="5236535">Op</span>&nbsp;<span class="op" id="5236538">=</span>&nbsp;<span class="ident" id="5236540">OpLiteral</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236552">re</span><span class="op" id="5236554">.</span><span class="ident" id="5236555">Rune</span>&nbsp;<span class="op" id="5236560">=</span>&nbsp;<span class="ident" id="5236562">re</span><span class="op" id="5236564">.</span><span class="ident" id="5236565">Rune</span><span class="op" id="5236569">[</span><span class="op" id="5236570">:</span><span class="num" id="5236571">1</span><span class="op" id="5236572">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236576">re</span><span class="op" id="5236578">.</span><span class="ident" id="5236579">Flags</span>&nbsp;<span class="op" id="5236585">=</span>&nbsp;<span class="ident" id="5236587">p</span><span class="op" id="5236588">.</span><span class="ident" id="5236589">flags</span>&nbsp;<span class="op" id="5236595">&amp;^</span>&nbsp;<span class="ident" id="5236598">FoldCase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5236608">}</span>&nbsp;<span class="keyword" id="5236610">else</span>&nbsp;<span class="keyword" id="5236615">if</span>&nbsp;<span class="ident" id="5236618">re</span><span class="op" id="5236620">.</span><span class="ident" id="5236621">Op</span>&nbsp;<span class="op" id="5236624">==</span>&nbsp;<span class="ident" id="5236627">OpCharClass</span>&nbsp;<span class="op" id="5236639">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5236642">len</span><span class="op" id="5236645">(</span><span class="ident" id="5236646">re</span><span class="op" id="5236648">.</span><span class="ident" id="5236649">Rune</span><span class="op" id="5236653">)</span>&nbsp;<span class="op" id="5236655">==</span>&nbsp;<span class="num" id="5236658">4</span>&nbsp;<span class="op" id="5236660">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236665">re</span><span class="op" id="5236667">.</span><span class="ident" id="5236668">Rune</span><span class="op" id="5236672">[</span><span class="num" id="5236673">0</span><span class="op" id="5236674">]</span>&nbsp;<span class="op" id="5236676">==</span>&nbsp;<span class="ident" id="5236679">re</span><span class="op" id="5236681">.</span><span class="ident" id="5236682">Rune</span><span class="op" id="5236686">[</span><span class="num" id="5236687">1</span><span class="op" id="5236688">]</span>&nbsp;<span class="op" id="5236690">&amp;&amp;</span>&nbsp;<span class="ident" id="5236693">re</span><span class="op" id="5236695">.</span><span class="ident" id="5236696">Rune</span><span class="op" id="5236700">[</span><span class="num" id="5236701">2</span><span class="op" id="5236702">]</span>&nbsp;<span class="op" id="5236704">==</span>&nbsp;<span class="ident" id="5236707">re</span><span class="op" id="5236709">.</span><span class="ident" id="5236710">Rune</span><span class="op" id="5236714">[</span><span class="num" id="5236715">3</span><span class="op" id="5236716">]</span>&nbsp;<span class="op" id="5236718">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236723">unicode</span><span class="op" id="5236730">.</span><span class="ident" id="5236731">SimpleFold</span><span class="op" id="5236741">(</span><span class="ident" id="5236742">re</span><span class="op" id="5236744">.</span><span class="ident" id="5236745">Rune</span><span class="op" id="5236749">[</span><span class="num" id="5236750">0</span><span class="op" id="5236751">]</span><span class="op" id="5236752">)</span>&nbsp;<span class="op" id="5236754">==</span>&nbsp;<span class="ident" id="5236757">re</span><span class="op" id="5236759">.</span><span class="ident" id="5236760">Rune</span><span class="op" id="5236764">[</span><span class="num" id="5236765">2</span><span class="op" id="5236766">]</span>&nbsp;<span class="op" id="5236768">&amp;&amp;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236773">unicode</span><span class="op" id="5236780">.</span><span class="ident" id="5236781">SimpleFold</span><span class="op" id="5236791">(</span><span class="ident" id="5236792">re</span><span class="op" id="5236794">.</span><span class="ident" id="5236795">Rune</span><span class="op" id="5236799">[</span><span class="num" id="5236800">2</span><span class="op" id="5236801">]</span><span class="op" id="5236802">)</span>&nbsp;<span class="op" id="5236804">==</span>&nbsp;<span class="ident" id="5236807">re</span><span class="op" id="5236809">.</span><span class="ident" id="5236810">Rune</span><span class="op" id="5236814">[</span><span class="num" id="5236815">0</span><span class="op" id="5236816">]</span>&nbsp;<span class="op" id="5236818">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236823">re</span><span class="op" id="5236825">.</span><span class="ident" id="5236826">Op</span>&nbsp;<span class="op" id="5236829">==</span>&nbsp;<span class="ident" id="5236832">OpCharClass</span>&nbsp;<span class="op" id="5236844">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5236847">len</span><span class="op" id="5236850">(</span><span class="ident" id="5236851">re</span><span class="op" id="5236853">.</span><span class="ident" id="5236854">Rune</span><span class="op" id="5236858">)</span>&nbsp;<span class="op" id="5236860">==</span>&nbsp;<span class="num" id="5236863">2</span>&nbsp;<span class="op" id="5236865">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236871">re</span><span class="op" id="5236873">.</span><span class="ident" id="5236874">Rune</span><span class="op" id="5236878">[</span><span class="num" id="5236879">0</span><span class="op" id="5236880">]</span><span class="op" id="5236881">+</span><span class="num" id="5236882">1</span>&nbsp;<span class="op" id="5236884">==</span>&nbsp;<span class="ident" id="5236887">re</span><span class="op" id="5236889">.</span><span class="ident" id="5236890">Rune</span><span class="op" id="5236894">[</span><span class="num" id="5236895">1</span><span class="op" id="5236896">]</span>&nbsp;<span class="op" id="5236898">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236904">unicode</span><span class="op" id="5236911">.</span><span class="ident" id="5236912">SimpleFold</span><span class="op" id="5236922">(</span><span class="ident" id="5236923">re</span><span class="op" id="5236925">.</span><span class="ident" id="5236926">Rune</span><span class="op" id="5236930">[</span><span class="num" id="5236931">0</span><span class="op" id="5236932">]</span><span class="op" id="5236933">)</span>&nbsp;<span class="op" id="5236935">==</span>&nbsp;<span class="ident" id="5236938">re</span><span class="op" id="5236940">.</span><span class="ident" id="5236941">Rune</span><span class="op" id="5236945">[</span><span class="num" id="5236946">1</span><span class="op" id="5236947">]</span>&nbsp;<span class="op" id="5236949">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5236955">unicode</span><span class="op" id="5236962">.</span><span class="ident" id="5236963">SimpleFold</span><span class="op" id="5236973">(</span><span class="ident" id="5236974">re</span><span class="op" id="5236976">.</span><span class="ident" id="5236977">Rune</span><span class="op" id="5236981">[</span><span class="num" id="5236982">1</span><span class="op" id="5236983">]</span><span class="op" id="5236984">)</span>&nbsp;<span class="op" id="5236986">==</span>&nbsp;<span class="ident" id="5236989">re</span><span class="op" id="5236991">.</span><span class="ident" id="5236992">Rune</span><span class="op" id="5236996">[</span><span class="num" id="5236997">0</span><span class="op" id="5236998">]</span>&nbsp;<span class="op" id="5237000">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5237004">//&nbsp;Case-insensitive&nbsp;rune&nbsp;like&nbsp;[Aa]&nbsp;or&nbsp;[Δδ].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237052">if</span>&nbsp;<span class="ident" id="5237055">p</span><span class="op" id="5237056">.</span><span class="ident" id="5237057">maybeConcat</span><span class="op" id="5237068">(</span><span class="ident" id="5237069">re</span><span class="op" id="5237071">.</span><span class="ident" id="5237072">Rune</span><span class="op" id="5237076">[</span><span class="num" id="5237077">0</span><span class="op" id="5237078">]</span><span class="op" id="5237079">,</span>&nbsp;<span class="ident" id="5237081">p</span><span class="op" id="5237082">.</span><span class="ident" id="5237083">flags</span><span class="op" id="5237088">|</span><span class="ident" id="5237089">FoldCase</span><span class="op" id="5237097">)</span>&nbsp;<span class="op" id="5237099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237104">return</span>&nbsp;<span class="ident" id="5237111">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5237117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5237122">//&nbsp;Rewrite&nbsp;as&nbsp;(case-insensitive)&nbsp;literal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237166">re</span><span class="op" id="5237168">.</span><span class="ident" id="5237169">Op</span>&nbsp;<span class="op" id="5237172">=</span>&nbsp;<span class="ident" id="5237174">OpLiteral</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237186">re</span><span class="op" id="5237188">.</span><span class="ident" id="5237189">Rune</span>&nbsp;<span class="op" id="5237194">=</span>&nbsp;<span class="ident" id="5237196">re</span><span class="op" id="5237198">.</span><span class="ident" id="5237199">Rune</span><span class="op" id="5237203">[</span><span class="op" id="5237204">:</span><span class="num" id="5237205">1</span><span class="op" id="5237206">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237210">re</span><span class="op" id="5237212">.</span><span class="ident" id="5237213">Flags</span>&nbsp;<span class="op" id="5237219">=</span>&nbsp;<span class="ident" id="5237221">p</span><span class="op" id="5237222">.</span><span class="ident" id="5237223">flags</span>&nbsp;<span class="op" id="5237229">|</span>&nbsp;<span class="ident" id="5237231">FoldCase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5237241">}</span>&nbsp;<span class="keyword" id="5237243">else</span>&nbsp;<span class="op" id="5237248">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5237252">//&nbsp;Incremental&nbsp;concatenation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237284">p</span><span class="op" id="5237285">.</span><span class="ident" id="5237286">maybeConcat</span><span class="op" id="5237297">(</span><span class="op" id="5237298">-</span><span class="num" id="5237299">1</span><span class="op" id="5237300">,</span>&nbsp;<span class="num" id="5237302">0</span><span class="op" id="5237303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5237306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237310">p</span><span class="op" id="5237311">.</span><span class="ident" id="5237312">stack</span>&nbsp;<span class="op" id="5237318">=</span>&nbsp;<span class="builtinfunc" id="5237320">append</span><span class="op" id="5237326">(</span><span class="ident" id="5237327">p</span><span class="op" id="5237328">.</span><span class="ident" id="5237329">stack</span><span class="op" id="5237334">,</span>&nbsp;<span class="ident" id="5237336">re</span><span class="op" id="5237338">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237341">return</span>&nbsp;<span class="ident" id="5237348">re</span><br>
<span class="lineno"></span><span class="op" id="5237351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5237354">//&nbsp;maybeConcat&nbsp;implements&nbsp;incremental&nbsp;concatenation</span><br>
<span class="lineno"></span><span class="comment" id="5237406">//&nbsp;of&nbsp;literal&nbsp;runes&nbsp;into&nbsp;string&nbsp;nodes.&nbsp;&nbsp;The&nbsp;parser&nbsp;calls&nbsp;this</span><br>
<span class="lineno">145</span><span class="comment" id="5237468">//&nbsp;before&nbsp;each&nbsp;push,&nbsp;so&nbsp;only&nbsp;the&nbsp;top&nbsp;fragment&nbsp;of&nbsp;the&nbsp;stack</span><br>
<span class="lineno"></span><span class="comment" id="5237527">//&nbsp;might&nbsp;need&nbsp;processing.&nbsp;&nbsp;Since&nbsp;this&nbsp;is&nbsp;called&nbsp;before&nbsp;a&nbsp;push,</span><br>
<span class="lineno"></span><span class="comment" id="5237590">//&nbsp;the&nbsp;topmost&nbsp;literal&nbsp;is&nbsp;no&nbsp;longer&nbsp;subject&nbsp;to&nbsp;operators&nbsp;like&nbsp;*</span><br>
<span class="lineno"></span><span class="comment" id="5237654">//&nbsp;(Otherwise&nbsp;ab*&nbsp;would&nbsp;turn&nbsp;into&nbsp;(ab)*.)</span><br>
<span class="lineno"></span><span class="comment" id="5237696">//&nbsp;If&nbsp;r&nbsp;&gt;=&nbsp;0&nbsp;and&nbsp;there&#39;s&nbsp;a&nbsp;node&nbsp;left&nbsp;over,&nbsp;maybeConcat&nbsp;uses&nbsp;it</span><br>
<span class="lineno">150</span><span class="comment" id="5237759">//&nbsp;to&nbsp;push&nbsp;r&nbsp;with&nbsp;the&nbsp;given&nbsp;flags.</span><br>
<span class="lineno"></span><span class="comment" id="5237794">//&nbsp;maybeConcat&nbsp;reports&nbsp;whether&nbsp;r&nbsp;was&nbsp;pushed.</span><br>
<span class="lineno"></span><span class="keyword" id="5237839">func</span>&nbsp;<span class="op" id="5237844">(</span><span class="ident" id="5237845">p</span>&nbsp;<span class="op" id="5237847">*</span><span class="ident" id="5237848">parser</span><span class="op" id="5237854">)</span>&nbsp;<span class="ident" id="5237856">maybeConcat</span><span class="op" id="5237867">(</span><span class="ident" id="5237868">r</span>&nbsp;<span class="builtintype" id="5237870">rune</span><span class="op" id="5237874">,</span>&nbsp;<span class="ident" id="5237876">flags</span>&nbsp;<span class="ident" id="5237882">Flags</span><span class="op" id="5237887">)</span>&nbsp;<span class="builtintype" id="5237889">bool</span>&nbsp;<span class="op" id="5237894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237897">n</span>&nbsp;<span class="op" id="5237899">:=</span>&nbsp;<span class="builtinfunc" id="5237902">len</span><span class="op" id="5237905">(</span><span class="ident" id="5237906">p</span><span class="op" id="5237907">.</span><span class="ident" id="5237908">stack</span><span class="op" id="5237913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237916">if</span>&nbsp;<span class="ident" id="5237919">n</span>&nbsp;<span class="op" id="5237921">&lt;</span>&nbsp;<span class="num" id="5237923">2</span>&nbsp;<span class="op" id="5237925">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237929">return</span>&nbsp;<span class="ident" id="5237936">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5237943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237947">re1</span>&nbsp;<span class="op" id="5237951">:=</span>&nbsp;<span class="ident" id="5237954">p</span><span class="op" id="5237955">.</span><span class="ident" id="5237956">stack</span><span class="op" id="5237961">[</span><span class="ident" id="5237962">n</span><span class="op" id="5237963">-</span><span class="num" id="5237964">1</span><span class="op" id="5237965">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5237968">re2</span>&nbsp;<span class="op" id="5237972">:=</span>&nbsp;<span class="ident" id="5237975">p</span><span class="op" id="5237976">.</span><span class="ident" id="5237977">stack</span><span class="op" id="5237982">[</span><span class="ident" id="5237983">n</span><span class="op" id="5237984">-</span><span class="num" id="5237985">2</span><span class="op" id="5237986">]</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5237989">if</span>&nbsp;<span class="ident" id="5237992">re1</span><span class="op" id="5237995">.</span><span class="ident" id="5237996">Op</span>&nbsp;<span class="op" id="5237999">!=</span>&nbsp;<span class="ident" id="5238002">OpLiteral</span>&nbsp;<span class="op" id="5238012">||</span>&nbsp;<span class="ident" id="5238015">re2</span><span class="op" id="5238018">.</span><span class="ident" id="5238019">Op</span>&nbsp;<span class="op" id="5238022">!=</span>&nbsp;<span class="ident" id="5238025">OpLiteral</span>&nbsp;<span class="op" id="5238035">||</span>&nbsp;<span class="ident" id="5238038">re1</span><span class="op" id="5238041">.</span><span class="ident" id="5238042">Flags</span><span class="op" id="5238047">&amp;</span><span class="ident" id="5238048">FoldCase</span>&nbsp;<span class="op" id="5238057">!=</span>&nbsp;<span class="ident" id="5238060">re2</span><span class="op" id="5238063">.</span><span class="ident" id="5238064">Flags</span><span class="op" id="5238069">&amp;</span><span class="ident" id="5238070">FoldCase</span>&nbsp;<span class="op" id="5238079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238083">return</span>&nbsp;<span class="ident" id="5238090">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238101">//&nbsp;Push&nbsp;re1&nbsp;into&nbsp;re2.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238124">re2</span><span class="op" id="5238127">.</span><span class="ident" id="5238128">Rune</span>&nbsp;<span class="op" id="5238133">=</span>&nbsp;<span class="builtinfunc" id="5238135">append</span><span class="op" id="5238141">(</span><span class="ident" id="5238142">re2</span><span class="op" id="5238145">.</span><span class="ident" id="5238146">Rune</span><span class="op" id="5238150">,</span>&nbsp;<span class="ident" id="5238152">re1</span><span class="op" id="5238155">.</span><span class="ident" id="5238156">Rune</span><span class="op" id="5238160">...</span><span class="op" id="5238163">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5238167">//&nbsp;Reuse&nbsp;re1&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238194">if</span>&nbsp;<span class="ident" id="5238197">r</span>&nbsp;<span class="op" id="5238199">&gt;=</span>&nbsp;<span class="num" id="5238202">0</span>&nbsp;<span class="op" id="5238204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238208">re1</span><span class="op" id="5238211">.</span><span class="ident" id="5238212">Rune</span>&nbsp;<span class="op" id="5238217">=</span>&nbsp;<span class="ident" id="5238219">re1</span><span class="op" id="5238222">.</span><span class="ident" id="5238223">Rune0</span><span class="op" id="5238228">[</span><span class="op" id="5238229">:</span><span class="num" id="5238230">1</span><span class="op" id="5238231">]</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238235">re1</span><span class="op" id="5238238">.</span><span class="ident" id="5238239">Rune</span><span class="op" id="5238243">[</span><span class="num" id="5238244">0</span><span class="op" id="5238245">]</span>&nbsp;<span class="op" id="5238247">=</span>&nbsp;<span class="ident" id="5238249">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238253">re1</span><span class="op" id="5238256">.</span><span class="ident" id="5238257">Flags</span>&nbsp;<span class="op" id="5238263">=</span>&nbsp;<span class="ident" id="5238265">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238273">return</span>&nbsp;<span class="ident" id="5238280">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238290">p</span><span class="op" id="5238291">.</span><span class="ident" id="5238292">stack</span>&nbsp;<span class="op" id="5238298">=</span>&nbsp;<span class="ident" id="5238300">p</span><span class="op" id="5238301">.</span><span class="ident" id="5238302">stack</span><span class="op" id="5238307">[</span><span class="op" id="5238308">:</span><span class="ident" id="5238309">n</span><span class="op" id="5238310">-</span><span class="num" id="5238311">1</span><span class="op" id="5238312">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238315">p</span><span class="op" id="5238316">.</span><span class="ident" id="5238317">reuse</span><span class="op" id="5238322">(</span><span class="ident" id="5238323">re1</span><span class="op" id="5238326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238329">return</span>&nbsp;<span class="ident" id="5238336">false</span>&nbsp;<span class="comment" id="5238342">//&nbsp;did&nbsp;not&nbsp;push&nbsp;r</span><br>
<span class="lineno"></span><span class="op" id="5238360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="comment" id="5238363">//&nbsp;newLiteral&nbsp;returns&nbsp;a&nbsp;new&nbsp;OpLiteral&nbsp;Regexp&nbsp;with&nbsp;the&nbsp;given&nbsp;flags</span><br>
<span class="lineno"></span><span class="keyword" id="5238429">func</span>&nbsp;<span class="op" id="5238434">(</span><span class="ident" id="5238435">p</span>&nbsp;<span class="op" id="5238437">*</span><span class="ident" id="5238438">parser</span><span class="op" id="5238444">)</span>&nbsp;<span class="ident" id="5238446">newLiteral</span><span class="op" id="5238456">(</span><span class="ident" id="5238457">r</span>&nbsp;<span class="builtintype" id="5238459">rune</span><span class="op" id="5238463">,</span>&nbsp;<span class="ident" id="5238465">flags</span>&nbsp;<span class="ident" id="5238471">Flags</span><span class="op" id="5238476">)</span>&nbsp;<span class="op" id="5238478">*</span><span class="ident" id="5238479">Regexp</span>&nbsp;<span class="op" id="5238486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238489">re</span>&nbsp;<span class="op" id="5238492">:=</span>&nbsp;<span class="ident" id="5238495">p</span><span class="op" id="5238496">.</span><span class="ident" id="5238497">newRegexp</span><span class="op" id="5238506">(</span><span class="ident" id="5238507">OpLiteral</span><span class="op" id="5238516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238519">re</span><span class="op" id="5238521">.</span><span class="ident" id="5238522">Flags</span>&nbsp;<span class="op" id="5238528">=</span>&nbsp;<span class="ident" id="5238530">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238537">if</span>&nbsp;<span class="ident" id="5238540">flags</span><span class="op" id="5238545">&amp;</span><span class="ident" id="5238546">FoldCase</span>&nbsp;<span class="op" id="5238555">!=</span>&nbsp;<span class="num" id="5238558">0</span>&nbsp;<span class="op" id="5238560">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238564">r</span>&nbsp;<span class="op" id="5238566">=</span>&nbsp;<span class="ident" id="5238568">minFoldRune</span><span class="op" id="5238579">(</span><span class="ident" id="5238580">r</span><span class="op" id="5238581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238587">re</span><span class="op" id="5238589">.</span><span class="ident" id="5238590">Rune0</span><span class="op" id="5238595">[</span><span class="num" id="5238596">0</span><span class="op" id="5238597">]</span>&nbsp;<span class="op" id="5238599">=</span>&nbsp;<span class="ident" id="5238601">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238604">re</span><span class="op" id="5238606">.</span><span class="ident" id="5238607">Rune</span>&nbsp;<span class="op" id="5238612">=</span>&nbsp;<span class="ident" id="5238614">re</span><span class="op" id="5238616">.</span><span class="ident" id="5238617">Rune0</span><span class="op" id="5238622">[</span><span class="op" id="5238623">:</span><span class="num" id="5238624">1</span><span class="op" id="5238625">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238628">return</span>&nbsp;<span class="ident" id="5238635">re</span><br>
<span class="lineno">190</span><span class="op" id="5238638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5238641">//&nbsp;minFoldRune&nbsp;returns&nbsp;the&nbsp;minimum&nbsp;rune&nbsp;fold-equivalent&nbsp;to&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5238703">func</span>&nbsp;<span class="ident" id="5238708">minFoldRune</span><span class="op" id="5238719">(</span><span class="ident" id="5238720">r</span>&nbsp;<span class="builtintype" id="5238722">rune</span><span class="op" id="5238726">)</span>&nbsp;<span class="builtintype" id="5238728">rune</span>&nbsp;<span class="op" id="5238733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238736">if</span>&nbsp;<span class="ident" id="5238739">r</span>&nbsp;<span class="op" id="5238741">&lt;</span>&nbsp;<span class="ident" id="5238743">minFold</span>&nbsp;<span class="op" id="5238751">||</span>&nbsp;<span class="ident" id="5238754">r</span>&nbsp;<span class="op" id="5238756">&gt;</span>&nbsp;<span class="ident" id="5238758">maxFold</span>&nbsp;<span class="op" id="5238766">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238770">return</span>&nbsp;<span class="ident" id="5238777">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238783">min</span>&nbsp;<span class="op" id="5238787">:=</span>&nbsp;<span class="ident" id="5238790">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238793">r0</span>&nbsp;<span class="op" id="5238796">:=</span>&nbsp;<span class="ident" id="5238799">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238802">for</span>&nbsp;<span class="ident" id="5238806">r</span>&nbsp;<span class="op" id="5238808">=</span>&nbsp;<span class="ident" id="5238810">unicode</span><span class="op" id="5238817">.</span><span class="ident" id="5238818">SimpleFold</span><span class="op" id="5238828">(</span><span class="ident" id="5238829">r</span><span class="op" id="5238830">)</span><span class="op" id="5238831">;</span>&nbsp;<span class="ident" id="5238833">r</span>&nbsp;<span class="op" id="5238835">!=</span>&nbsp;<span class="ident" id="5238838">r0</span><span class="op" id="5238840">;</span>&nbsp;<span class="ident" id="5238842">r</span>&nbsp;<span class="op" id="5238844">=</span>&nbsp;<span class="ident" id="5238846">unicode</span><span class="op" id="5238853">.</span><span class="ident" id="5238854">SimpleFold</span><span class="op" id="5238864">(</span><span class="ident" id="5238865">r</span><span class="op" id="5238866">)</span>&nbsp;<span class="op" id="5238868">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238872">if</span>&nbsp;<span class="ident" id="5238875">min</span>&nbsp;<span class="op" id="5238879">&gt;</span>&nbsp;<span class="ident" id="5238881">r</span>&nbsp;<span class="op" id="5238883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5238888">min</span>&nbsp;<span class="op" id="5238892">=</span>&nbsp;<span class="ident" id="5238894">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5238901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5238904">return</span>&nbsp;<span class="ident" id="5238911">min</span><br>
<span class="lineno">205</span><span class="op" id="5238915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5238918">//&nbsp;literal&nbsp;pushes&nbsp;a&nbsp;literal&nbsp;regexp&nbsp;for&nbsp;the&nbsp;rune&nbsp;r&nbsp;on&nbsp;the&nbsp;stack</span><br>
<span class="lineno"></span><span class="comment" id="5238981">//&nbsp;and&nbsp;returns&nbsp;that&nbsp;regexp.</span><br>
<span class="lineno"></span><span class="keyword" id="5239009">func</span>&nbsp;<span class="op" id="5239014">(</span><span class="ident" id="5239015">p</span>&nbsp;<span class="op" id="5239017">*</span><span class="ident" id="5239018">parser</span><span class="op" id="5239024">)</span>&nbsp;<span class="ident" id="5239026">literal</span><span class="op" id="5239033">(</span><span class="ident" id="5239034">r</span>&nbsp;<span class="builtintype" id="5239036">rune</span><span class="op" id="5239040">)</span>&nbsp;<span class="op" id="5239042">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239045">p</span><span class="op" id="5239046">.</span><span class="ident" id="5239047">push</span><span class="op" id="5239051">(</span><span class="ident" id="5239052">p</span><span class="op" id="5239053">.</span><span class="ident" id="5239054">newLiteral</span><span class="op" id="5239064">(</span><span class="ident" id="5239065">r</span><span class="op" id="5239066">,</span>&nbsp;<span class="ident" id="5239068">p</span><span class="op" id="5239069">.</span><span class="ident" id="5239070">flags</span><span class="op" id="5239075">)</span><span class="op" id="5239076">)</span><br>
<span class="lineno"></span><span class="op" id="5239078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5239081">//&nbsp;op&nbsp;pushes&nbsp;a&nbsp;regexp&nbsp;with&nbsp;the&nbsp;given&nbsp;op&nbsp;onto&nbsp;the&nbsp;stack</span><br>
<span class="lineno"></span><span class="comment" id="5239136">//&nbsp;and&nbsp;returns&nbsp;that&nbsp;regexp.</span><br>
<span class="lineno">215</span><span class="keyword" id="5239164">func</span>&nbsp;<span class="op" id="5239169">(</span><span class="ident" id="5239170">p</span>&nbsp;<span class="op" id="5239172">*</span><span class="ident" id="5239173">parser</span><span class="op" id="5239179">)</span>&nbsp;<span class="ident" id="5239181">op</span><span class="op" id="5239183">(</span><span class="ident" id="5239184">op</span>&nbsp;<span class="ident" id="5239187">Op</span><span class="op" id="5239189">)</span>&nbsp;<span class="op" id="5239191">*</span><span class="ident" id="5239192">Regexp</span>&nbsp;<span class="op" id="5239199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239202">re</span>&nbsp;<span class="op" id="5239205">:=</span>&nbsp;<span class="ident" id="5239208">p</span><span class="op" id="5239209">.</span><span class="ident" id="5239210">newRegexp</span><span class="op" id="5239219">(</span><span class="ident" id="5239220">op</span><span class="op" id="5239222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239225">re</span><span class="op" id="5239227">.</span><span class="ident" id="5239228">Flags</span>&nbsp;<span class="op" id="5239234">=</span>&nbsp;<span class="ident" id="5239236">p</span><span class="op" id="5239237">.</span><span class="ident" id="5239238">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239245">return</span>&nbsp;<span class="ident" id="5239252">p</span><span class="op" id="5239253">.</span><span class="ident" id="5239254">push</span><span class="op" id="5239258">(</span><span class="ident" id="5239259">re</span><span class="op" id="5239261">)</span><br>
<span class="lineno"></span><span class="op" id="5239263">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="5239266">//&nbsp;repeat&nbsp;replaces&nbsp;the&nbsp;top&nbsp;stack&nbsp;element&nbsp;with&nbsp;itself&nbsp;repeated&nbsp;according&nbsp;to&nbsp;op,&nbsp;min,&nbsp;max.</span><br>
<span class="lineno"></span><span class="comment" id="5239355">//&nbsp;before&nbsp;is&nbsp;the&nbsp;regexp&nbsp;suffix&nbsp;starting&nbsp;at&nbsp;the&nbsp;repetition&nbsp;operator.</span><br>
<span class="lineno"></span><span class="comment" id="5239423">//&nbsp;after&nbsp;is&nbsp;the&nbsp;regexp&nbsp;suffix&nbsp;following&nbsp;after&nbsp;the&nbsp;repetition&nbsp;operator.</span><br>
<span class="lineno"></span><span class="comment" id="5239494">//&nbsp;repeat&nbsp;returns&nbsp;an&nbsp;updated&nbsp;&#39;after&#39;&nbsp;and&nbsp;an&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno">225</span><span class="keyword" id="5239553">func</span>&nbsp;<span class="op" id="5239558">(</span><span class="ident" id="5239559">p</span>&nbsp;<span class="op" id="5239561">*</span><span class="ident" id="5239562">parser</span><span class="op" id="5239568">)</span>&nbsp;<span class="ident" id="5239570">repeat</span><span class="op" id="5239576">(</span><span class="ident" id="5239577">op</span>&nbsp;<span class="ident" id="5239580">Op</span><span class="op" id="5239582">,</span>&nbsp;<span class="ident" id="5239584">min</span><span class="op" id="5239587">,</span>&nbsp;<span class="ident" id="5239589">max</span>&nbsp;<span class="builtintype" id="5239593">int</span><span class="op" id="5239596">,</span>&nbsp;<span class="ident" id="5239598">before</span><span class="op" id="5239604">,</span>&nbsp;<span class="ident" id="5239606">after</span><span class="op" id="5239611">,</span>&nbsp;<span class="ident" id="5239613">lastRepeat</span>&nbsp;<span class="builtintype" id="5239624">string</span><span class="op" id="5239630">)</span>&nbsp;<span class="op" id="5239632">(</span><span class="builtintype" id="5239633">string</span><span class="op" id="5239639">,</span>&nbsp;<span class="builtintype" id="5239641">error</span><span class="op" id="5239646">)</span>&nbsp;<span class="op" id="5239648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239651">flags</span>&nbsp;<span class="op" id="5239657">:=</span>&nbsp;<span class="ident" id="5239660">p</span><span class="op" id="5239661">.</span><span class="ident" id="5239662">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239669">if</span>&nbsp;<span class="ident" id="5239672">p</span><span class="op" id="5239673">.</span><span class="ident" id="5239674">flags</span><span class="op" id="5239679">&amp;</span><span class="ident" id="5239680">PerlX</span>&nbsp;<span class="op" id="5239686">!=</span>&nbsp;<span class="num" id="5239689">0</span>&nbsp;<span class="op" id="5239691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239695">if</span>&nbsp;<span class="builtinfunc" id="5239698">len</span><span class="op" id="5239701">(</span><span class="ident" id="5239702">after</span><span class="op" id="5239707">)</span>&nbsp;<span class="op" id="5239709">&gt;</span>&nbsp;<span class="num" id="5239711">0</span>&nbsp;<span class="op" id="5239713">&amp;&amp;</span>&nbsp;<span class="ident" id="5239716">after</span><span class="op" id="5239721">[</span><span class="num" id="5239722">0</span><span class="op" id="5239723">]</span>&nbsp;<span class="op" id="5239725">==</span>&nbsp;<span class="string" id="5239728">&#39;?&#39;</span>&nbsp;<span class="op" id="5239732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239737">after</span>&nbsp;<span class="op" id="5239743">=</span>&nbsp;<span class="ident" id="5239745">after</span><span class="op" id="5239750">[</span><span class="num" id="5239751">1</span><span class="op" id="5239752">:</span><span class="op" id="5239753">]</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5239758">flags</span>&nbsp;<span class="op" id="5239764">^=</span>&nbsp;<span class="ident" id="5239767">NonGreedy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5239779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239783">if</span>&nbsp;<span class="ident" id="5239786">lastRepeat</span>&nbsp;<span class="op" id="5239797">!=</span>&nbsp;<span class="string" id="5239800">&#34;&#34;</span>&nbsp;<span class="op" id="5239803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5239808">//&nbsp;In&nbsp;Perl&nbsp;it&nbsp;is&nbsp;not&nbsp;allowed&nbsp;to&nbsp;stack&nbsp;repetition&nbsp;operators:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5239871">//&nbsp;a**&nbsp;is&nbsp;a&nbsp;syntax&nbsp;error,&nbsp;not&nbsp;a&nbsp;doubled&nbsp;star,&nbsp;and&nbsp;a++&nbsp;means</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5239934">//&nbsp;something&nbsp;else&nbsp;entirely,&nbsp;which&nbsp;we&nbsp;don&#39;t&nbsp;support!</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5239989">return</span>&nbsp;<span class="string" id="5239996">&#34;&#34;</span><span class="op" id="5239998">,</span>&nbsp;<span class="op" id="5240000">&amp;</span><span class="ident" id="5240001">Error</span><span class="op" id="5240006">{</span><span class="ident" id="5240007">ErrInvalidRepeatOp</span><span class="op" id="5240025">,</span>&nbsp;<span class="ident" id="5240027">lastRepeat</span><span class="op" id="5240037">[</span><span class="op" id="5240038">:</span><span class="builtinfunc" id="5240039">len</span><span class="op" id="5240042">(</span><span class="ident" id="5240043">lastRepeat</span><span class="op" id="5240053">)</span><span class="op" id="5240054">-</span><span class="builtinfunc" id="5240055">len</span><span class="op" id="5240058">(</span><span class="ident" id="5240059">after</span><span class="op" id="5240064">)</span><span class="op" id="5240065">]</span><span class="op" id="5240066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240076">n</span>&nbsp;<span class="op" id="5240078">:=</span>&nbsp;<span class="builtinfunc" id="5240081">len</span><span class="op" id="5240084">(</span><span class="ident" id="5240085">p</span><span class="op" id="5240086">.</span><span class="ident" id="5240087">stack</span><span class="op" id="5240092">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240095">if</span>&nbsp;<span class="ident" id="5240098">n</span>&nbsp;<span class="op" id="5240100">==</span>&nbsp;<span class="num" id="5240103">0</span>&nbsp;<span class="op" id="5240105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240109">return</span>&nbsp;<span class="string" id="5240116">&#34;&#34;</span><span class="op" id="5240118">,</span>&nbsp;<span class="op" id="5240120">&amp;</span><span class="ident" id="5240121">Error</span><span class="op" id="5240126">{</span><span class="ident" id="5240127">ErrMissingRepeatArgument</span><span class="op" id="5240151">,</span>&nbsp;<span class="ident" id="5240153">before</span><span class="op" id="5240159">[</span><span class="op" id="5240160">:</span><span class="builtinfunc" id="5240161">len</span><span class="op" id="5240164">(</span><span class="ident" id="5240165">before</span><span class="op" id="5240171">)</span><span class="op" id="5240172">-</span><span class="builtinfunc" id="5240173">len</span><span class="op" id="5240176">(</span><span class="ident" id="5240177">after</span><span class="op" id="5240182">)</span><span class="op" id="5240183">]</span><span class="op" id="5240184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240190">sub</span>&nbsp;<span class="op" id="5240194">:=</span>&nbsp;<span class="ident" id="5240197">p</span><span class="op" id="5240198">.</span><span class="ident" id="5240199">stack</span><span class="op" id="5240204">[</span><span class="ident" id="5240205">n</span><span class="op" id="5240206">-</span><span class="num" id="5240207">1</span><span class="op" id="5240208">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240211">if</span>&nbsp;<span class="ident" id="5240214">sub</span><span class="op" id="5240217">.</span><span class="ident" id="5240218">Op</span>&nbsp;<span class="op" id="5240221">&gt;=</span>&nbsp;<span class="ident" id="5240224">opPseudo</span>&nbsp;<span class="op" id="5240233">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240237">return</span>&nbsp;<span class="string" id="5240244">&#34;&#34;</span><span class="op" id="5240246">,</span>&nbsp;<span class="op" id="5240248">&amp;</span><span class="ident" id="5240249">Error</span><span class="op" id="5240254">{</span><span class="ident" id="5240255">ErrMissingRepeatArgument</span><span class="op" id="5240279">,</span>&nbsp;<span class="ident" id="5240281">before</span><span class="op" id="5240287">[</span><span class="op" id="5240288">:</span><span class="builtinfunc" id="5240289">len</span><span class="op" id="5240292">(</span><span class="ident" id="5240293">before</span><span class="op" id="5240299">)</span><span class="op" id="5240300">-</span><span class="builtinfunc" id="5240301">len</span><span class="op" id="5240304">(</span><span class="ident" id="5240305">after</span><span class="op" id="5240310">)</span><span class="op" id="5240311">]</span><span class="op" id="5240312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240319">re</span>&nbsp;<span class="op" id="5240322">:=</span>&nbsp;<span class="ident" id="5240325">p</span><span class="op" id="5240326">.</span><span class="ident" id="5240327">newRegexp</span><span class="op" id="5240336">(</span><span class="ident" id="5240337">op</span><span class="op" id="5240339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240342">re</span><span class="op" id="5240344">.</span><span class="ident" id="5240345">Min</span>&nbsp;<span class="op" id="5240349">=</span>&nbsp;<span class="ident" id="5240351">min</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240356">re</span><span class="op" id="5240358">.</span><span class="ident" id="5240359">Max</span>&nbsp;<span class="op" id="5240363">=</span>&nbsp;<span class="ident" id="5240365">max</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240370">re</span><span class="op" id="5240372">.</span><span class="ident" id="5240373">Flags</span>&nbsp;<span class="op" id="5240379">=</span>&nbsp;<span class="ident" id="5240381">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240388">re</span><span class="op" id="5240390">.</span><span class="ident" id="5240391">Sub</span>&nbsp;<span class="op" id="5240395">=</span>&nbsp;<span class="ident" id="5240397">re</span><span class="op" id="5240399">.</span><span class="ident" id="5240400">Sub0</span><span class="op" id="5240404">[</span><span class="op" id="5240405">:</span><span class="num" id="5240406">1</span><span class="op" id="5240407">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240410">re</span><span class="op" id="5240412">.</span><span class="ident" id="5240413">Sub</span><span class="op" id="5240416">[</span><span class="num" id="5240417">0</span><span class="op" id="5240418">]</span>&nbsp;<span class="op" id="5240420">=</span>&nbsp;<span class="ident" id="5240422">sub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5240427">p</span><span class="op" id="5240428">.</span><span class="ident" id="5240429">stack</span><span class="op" id="5240434">[</span><span class="ident" id="5240435">n</span><span class="op" id="5240436">-</span><span class="num" id="5240437">1</span><span class="op" id="5240438">]</span>&nbsp;<span class="op" id="5240440">=</span>&nbsp;<span class="ident" id="5240442">re</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240447">if</span>&nbsp;<span class="ident" id="5240450">op</span>&nbsp;<span class="op" id="5240453">==</span>&nbsp;<span class="ident" id="5240456">OpRepeat</span>&nbsp;<span class="op" id="5240465">&amp;&amp;</span>&nbsp;<span class="op" id="5240468">(</span><span class="ident" id="5240469">min</span>&nbsp;<span class="op" id="5240473">&gt;=</span>&nbsp;<span class="num" id="5240476">2</span>&nbsp;<span class="op" id="5240478">||</span>&nbsp;<span class="ident" id="5240481">max</span>&nbsp;<span class="op" id="5240485">&gt;=</span>&nbsp;<span class="num" id="5240488">2</span><span class="op" id="5240489">)</span>&nbsp;<span class="op" id="5240491">&amp;&amp;</span>&nbsp;<span class="op" id="5240494">!</span><span class="ident" id="5240495">repeatIsValid</span><span class="op" id="5240508">(</span><span class="ident" id="5240509">re</span><span class="op" id="5240511">,</span>&nbsp;<span class="num" id="5240513">1000</span><span class="op" id="5240517">)</span>&nbsp;<span class="op" id="5240519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240523">return</span>&nbsp;<span class="string" id="5240530">&#34;&#34;</span><span class="op" id="5240532">,</span>&nbsp;<span class="op" id="5240534">&amp;</span><span class="ident" id="5240535">Error</span><span class="op" id="5240540">{</span><span class="ident" id="5240541">ErrInvalidRepeatSize</span><span class="op" id="5240561">,</span>&nbsp;<span class="ident" id="5240563">before</span><span class="op" id="5240569">[</span><span class="op" id="5240570">:</span><span class="builtinfunc" id="5240571">len</span><span class="op" id="5240574">(</span><span class="ident" id="5240575">before</span><span class="op" id="5240581">)</span><span class="op" id="5240582">-</span><span class="builtinfunc" id="5240583">len</span><span class="op" id="5240586">(</span><span class="ident" id="5240587">after</span><span class="op" id="5240592">)</span><span class="op" id="5240593">]</span><span class="op" id="5240594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5240597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5240601">return</span>&nbsp;<span class="ident" id="5240608">after</span><span class="op" id="5240613">,</span>&nbsp;<span class="ident" id="5240615">nil</span><br>
<span class="lineno"></span><span class="op" id="5240619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5240622">//&nbsp;repeatIsValid&nbsp;reports&nbsp;whether&nbsp;the&nbsp;repetition&nbsp;re&nbsp;is&nbsp;valid.</span><br>
<span class="lineno"></span><span class="comment" id="5240683">//&nbsp;Valid&nbsp;means&nbsp;that&nbsp;the&nbsp;combination&nbsp;of&nbsp;the&nbsp;top-level&nbsp;repetition</span><br>
<span class="lineno">265</span><span class="comment" id="5240747">//&nbsp;and&nbsp;any&nbsp;inner&nbsp;repetitions&nbsp;does&nbsp;not&nbsp;exceed&nbsp;n&nbsp;copies&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5240808">//&nbsp;innermost&nbsp;thing.</span><br>
<span class="lineno"></span><span class="comment" id="5240828">//&nbsp;This&nbsp;function&nbsp;rewalks&nbsp;the&nbsp;regexp&nbsp;tree&nbsp;and&nbsp;is&nbsp;called&nbsp;for&nbsp;every&nbsp;repetition,</span><br>
<span class="lineno"></span><span class="comment" id="5240905">//&nbsp;so&nbsp;we&nbsp;have&nbsp;to&nbsp;worry&nbsp;about&nbsp;inducing&nbsp;quadratic&nbsp;behavior&nbsp;in&nbsp;the&nbsp;parser.</span><br>
<span class="lineno"></span><span class="comment" id="5240977">//&nbsp;We&nbsp;avoid&nbsp;this&nbsp;by&nbsp;only&nbsp;calling&nbsp;repeatIsValid&nbsp;when&nbsp;min&nbsp;or&nbsp;max&nbsp;&gt;=&nbsp;2.</span><br>
<span class="lineno">270</span><span class="comment" id="5241046">//&nbsp;In&nbsp;that&nbsp;case&nbsp;the&nbsp;depth&nbsp;of&nbsp;any&nbsp;&gt;=&nbsp;2&nbsp;nesting&nbsp;can&nbsp;only&nbsp;get&nbsp;to&nbsp;9&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="5241118">//&nbsp;triggering&nbsp;a&nbsp;parse&nbsp;error,&nbsp;so&nbsp;each&nbsp;subtree&nbsp;can&nbsp;only&nbsp;be&nbsp;rewalked&nbsp;9&nbsp;times.</span><br>
<span class="lineno"></span><span class="keyword" id="5241193">func</span>&nbsp;<span class="ident" id="5241198">repeatIsValid</span><span class="op" id="5241211">(</span><span class="ident" id="5241212">re</span>&nbsp;<span class="op" id="5241215">*</span><span class="ident" id="5241216">Regexp</span><span class="op" id="5241222">,</span>&nbsp;<span class="ident" id="5241224">n</span>&nbsp;<span class="builtintype" id="5241226">int</span><span class="op" id="5241229">)</span>&nbsp;<span class="builtintype" id="5241231">bool</span>&nbsp;<span class="op" id="5241236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241239">if</span>&nbsp;<span class="ident" id="5241242">re</span><span class="op" id="5241244">.</span><span class="ident" id="5241245">Op</span>&nbsp;<span class="op" id="5241248">==</span>&nbsp;<span class="ident" id="5241251">OpRepeat</span>&nbsp;<span class="op" id="5241260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241264">m</span>&nbsp;<span class="op" id="5241266">:=</span>&nbsp;<span class="ident" id="5241269">re</span><span class="op" id="5241271">.</span><span class="ident" id="5241272">Max</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241278">if</span>&nbsp;<span class="ident" id="5241281">m</span>&nbsp;<span class="op" id="5241283">==</span>&nbsp;<span class="num" id="5241286">0</span>&nbsp;<span class="op" id="5241288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241293">return</span>&nbsp;<span class="ident" id="5241300">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241311">if</span>&nbsp;<span class="ident" id="5241314">m</span>&nbsp;<span class="op" id="5241316">&lt;</span>&nbsp;<span class="num" id="5241318">0</span>&nbsp;<span class="op" id="5241320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241325">m</span>&nbsp;<span class="op" id="5241327">=</span>&nbsp;<span class="ident" id="5241329">re</span><span class="op" id="5241331">.</span><span class="ident" id="5241332">Min</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241342">if</span>&nbsp;<span class="ident" id="5241345">m</span>&nbsp;<span class="op" id="5241347">&gt;</span>&nbsp;<span class="ident" id="5241349">n</span>&nbsp;<span class="op" id="5241351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241356">return</span>&nbsp;<span class="ident" id="5241363">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241375">if</span>&nbsp;<span class="ident" id="5241378">m</span>&nbsp;<span class="op" id="5241380">&gt;</span>&nbsp;<span class="num" id="5241382">0</span>&nbsp;<span class="op" id="5241384">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241389">n</span>&nbsp;<span class="op" id="5241391">/=</span>&nbsp;<span class="ident" id="5241394">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241404">for</span>&nbsp;<span class="ident" id="5241408">_</span><span class="op" id="5241409">,</span>&nbsp;<span class="ident" id="5241411">sub</span>&nbsp;<span class="op" id="5241415">:=</span>&nbsp;<span class="keyword" id="5241418">range</span>&nbsp;<span class="ident" id="5241424">re</span><span class="op" id="5241426">.</span><span class="ident" id="5241427">Sub</span>&nbsp;<span class="op" id="5241431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241435">if</span>&nbsp;<span class="op" id="5241438">!</span><span class="ident" id="5241439">repeatIsValid</span><span class="op" id="5241452">(</span><span class="ident" id="5241453">sub</span><span class="op" id="5241456">,</span>&nbsp;<span class="ident" id="5241458">n</span><span class="op" id="5241459">)</span>&nbsp;<span class="op" id="5241461">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241466">return</span>&nbsp;<span class="ident" id="5241473">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241487">return</span>&nbsp;<span class="ident" id="5241494">true</span><br>
<span class="lineno"></span><span class="op" id="5241499">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span><span class="comment" id="5241502">//&nbsp;concat&nbsp;replaces&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;stack&nbsp;(above&nbsp;the&nbsp;topmost&nbsp;&#39;|&#39;&nbsp;or&nbsp;&#39;(&#39;)&nbsp;with&nbsp;its&nbsp;concatenation.</span><br>
<span class="lineno"></span><span class="keyword" id="5241597">func</span>&nbsp;<span class="op" id="5241602">(</span><span class="ident" id="5241603">p</span>&nbsp;<span class="op" id="5241605">*</span><span class="ident" id="5241606">parser</span><span class="op" id="5241612">)</span>&nbsp;<span class="ident" id="5241614">concat</span><span class="op" id="5241620">(</span><span class="op" id="5241621">)</span>&nbsp;<span class="op" id="5241623">*</span><span class="ident" id="5241624">Regexp</span>&nbsp;<span class="op" id="5241631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241634">p</span><span class="op" id="5241635">.</span><span class="ident" id="5241636">maybeConcat</span><span class="op" id="5241647">(</span><span class="op" id="5241648">-</span><span class="num" id="5241649">1</span><span class="op" id="5241650">,</span>&nbsp;<span class="num" id="5241652">0</span><span class="op" id="5241653">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5241657">//&nbsp;Scan&nbsp;down&nbsp;to&nbsp;find&nbsp;pseudo-operator&nbsp;|&nbsp;or&nbsp;(.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241703">i</span>&nbsp;<span class="op" id="5241705">:=</span>&nbsp;<span class="builtinfunc" id="5241708">len</span><span class="op" id="5241711">(</span><span class="ident" id="5241712">p</span><span class="op" id="5241713">.</span><span class="ident" id="5241714">stack</span><span class="op" id="5241719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241722">for</span>&nbsp;<span class="ident" id="5241726">i</span>&nbsp;<span class="op" id="5241728">&gt;</span>&nbsp;<span class="num" id="5241730">0</span>&nbsp;<span class="op" id="5241732">&amp;&amp;</span>&nbsp;<span class="ident" id="5241735">p</span><span class="op" id="5241736">.</span><span class="ident" id="5241737">stack</span><span class="op" id="5241742">[</span><span class="ident" id="5241743">i</span><span class="op" id="5241744">-</span><span class="num" id="5241745">1</span><span class="op" id="5241746">]</span><span class="op" id="5241747">.</span><span class="ident" id="5241748">Op</span>&nbsp;<span class="op" id="5241751">&lt;</span>&nbsp;<span class="ident" id="5241753">opPseudo</span>&nbsp;<span class="op" id="5241762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241766">i</span><span class="op" id="5241767">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241771">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241774">subs</span>&nbsp;<span class="op" id="5241779">:=</span>&nbsp;<span class="ident" id="5241782">p</span><span class="op" id="5241783">.</span><span class="ident" id="5241784">stack</span><span class="op" id="5241789">[</span><span class="ident" id="5241790">i</span><span class="op" id="5241791">:</span><span class="op" id="5241792">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5241795">p</span><span class="op" id="5241796">.</span><span class="ident" id="5241797">stack</span>&nbsp;<span class="op" id="5241803">=</span>&nbsp;<span class="ident" id="5241805">p</span><span class="op" id="5241806">.</span><span class="ident" id="5241807">stack</span><span class="op" id="5241812">[</span><span class="op" id="5241813">:</span><span class="ident" id="5241814">i</span><span class="op" id="5241815">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5241819">//&nbsp;Empty&nbsp;concatenation&nbsp;is&nbsp;special&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241860">if</span>&nbsp;<span class="builtinfunc" id="5241863">len</span><span class="op" id="5241866">(</span><span class="ident" id="5241867">subs</span><span class="op" id="5241871">)</span>&nbsp;<span class="op" id="5241873">==</span>&nbsp;<span class="num" id="5241876">0</span>&nbsp;<span class="op" id="5241878">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241882">return</span>&nbsp;<span class="ident" id="5241889">p</span><span class="op" id="5241890">.</span><span class="ident" id="5241891">push</span><span class="op" id="5241895">(</span><span class="ident" id="5241896">p</span><span class="op" id="5241897">.</span><span class="ident" id="5241898">newRegexp</span><span class="op" id="5241907">(</span><span class="ident" id="5241908">OpEmptyMatch</span><span class="op" id="5241920">)</span><span class="op" id="5241921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5241924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5241928">return</span>&nbsp;<span class="ident" id="5241935">p</span><span class="op" id="5241936">.</span><span class="ident" id="5241937">push</span><span class="op" id="5241941">(</span><span class="ident" id="5241942">p</span><span class="op" id="5241943">.</span><span class="ident" id="5241944">collapse</span><span class="op" id="5241952">(</span><span class="ident" id="5241953">subs</span><span class="op" id="5241957">,</span>&nbsp;<span class="ident" id="5241959">OpConcat</span><span class="op" id="5241967">)</span><span class="op" id="5241968">)</span><br>
<span class="lineno"></span><span class="op" id="5241970">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="comment" id="5241973">//&nbsp;alternate&nbsp;replaces&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;stack&nbsp;(above&nbsp;the&nbsp;topmost&nbsp;&#39;(&#39;)&nbsp;with&nbsp;its&nbsp;alternation.</span><br>
<span class="lineno"></span><span class="keyword" id="5242062">func</span>&nbsp;<span class="op" id="5242067">(</span><span class="ident" id="5242068">p</span>&nbsp;<span class="op" id="5242070">*</span><span class="ident" id="5242071">parser</span><span class="op" id="5242077">)</span>&nbsp;<span class="ident" id="5242079">alternate</span><span class="op" id="5242088">(</span><span class="op" id="5242089">)</span>&nbsp;<span class="op" id="5242091">*</span><span class="ident" id="5242092">Regexp</span>&nbsp;<span class="op" id="5242099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242102">//&nbsp;Scan&nbsp;down&nbsp;to&nbsp;find&nbsp;pseudo-operator&nbsp;(.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242143">//&nbsp;There&nbsp;are&nbsp;no&nbsp;|&nbsp;above&nbsp;(.</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242171">i</span>&nbsp;<span class="op" id="5242173">:=</span>&nbsp;<span class="builtinfunc" id="5242176">len</span><span class="op" id="5242179">(</span><span class="ident" id="5242180">p</span><span class="op" id="5242181">.</span><span class="ident" id="5242182">stack</span><span class="op" id="5242187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242190">for</span>&nbsp;<span class="ident" id="5242194">i</span>&nbsp;<span class="op" id="5242196">&gt;</span>&nbsp;<span class="num" id="5242198">0</span>&nbsp;<span class="op" id="5242200">&amp;&amp;</span>&nbsp;<span class="ident" id="5242203">p</span><span class="op" id="5242204">.</span><span class="ident" id="5242205">stack</span><span class="op" id="5242210">[</span><span class="ident" id="5242211">i</span><span class="op" id="5242212">-</span><span class="num" id="5242213">1</span><span class="op" id="5242214">]</span><span class="op" id="5242215">.</span><span class="ident" id="5242216">Op</span>&nbsp;<span class="op" id="5242219">&lt;</span>&nbsp;<span class="ident" id="5242221">opPseudo</span>&nbsp;<span class="op" id="5242230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242234">i</span><span class="op" id="5242235">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5242239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242242">subs</span>&nbsp;<span class="op" id="5242247">:=</span>&nbsp;<span class="ident" id="5242250">p</span><span class="op" id="5242251">.</span><span class="ident" id="5242252">stack</span><span class="op" id="5242257">[</span><span class="ident" id="5242258">i</span><span class="op" id="5242259">:</span><span class="op" id="5242260">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242263">p</span><span class="op" id="5242264">.</span><span class="ident" id="5242265">stack</span>&nbsp;<span class="op" id="5242271">=</span>&nbsp;<span class="ident" id="5242273">p</span><span class="op" id="5242274">.</span><span class="ident" id="5242275">stack</span><span class="op" id="5242280">[</span><span class="op" id="5242281">:</span><span class="ident" id="5242282">i</span><span class="op" id="5242283">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242287">//&nbsp;Make&nbsp;sure&nbsp;top&nbsp;class&nbsp;is&nbsp;clean.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242321">//&nbsp;All&nbsp;the&nbsp;others&nbsp;already&nbsp;are&nbsp;(see&nbsp;swapVerticalBar).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242375">if</span>&nbsp;<span class="builtinfunc" id="5242378">len</span><span class="op" id="5242381">(</span><span class="ident" id="5242382">subs</span><span class="op" id="5242386">)</span>&nbsp;<span class="op" id="5242388">&gt;</span>&nbsp;<span class="num" id="5242390">0</span>&nbsp;<span class="op" id="5242392">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242396">cleanAlt</span><span class="op" id="5242404">(</span><span class="ident" id="5242405">subs</span><span class="op" id="5242409">[</span><span class="builtinfunc" id="5242410">len</span><span class="op" id="5242413">(</span><span class="ident" id="5242414">subs</span><span class="op" id="5242418">)</span><span class="op" id="5242419">-</span><span class="num" id="5242420">1</span><span class="op" id="5242421">]</span><span class="op" id="5242422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5242425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242429">//&nbsp;Empty&nbsp;alternate&nbsp;is&nbsp;special&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5242465">//&nbsp;(shouldn&#39;t&nbsp;happen&nbsp;but&nbsp;easy&nbsp;to&nbsp;handle).</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242508">if</span>&nbsp;<span class="builtinfunc" id="5242511">len</span><span class="op" id="5242514">(</span><span class="ident" id="5242515">subs</span><span class="op" id="5242519">)</span>&nbsp;<span class="op" id="5242521">==</span>&nbsp;<span class="num" id="5242524">0</span>&nbsp;<span class="op" id="5242526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242530">return</span>&nbsp;<span class="ident" id="5242537">p</span><span class="op" id="5242538">.</span><span class="ident" id="5242539">push</span><span class="op" id="5242543">(</span><span class="ident" id="5242544">p</span><span class="op" id="5242545">.</span><span class="ident" id="5242546">newRegexp</span><span class="op" id="5242555">(</span><span class="ident" id="5242556">OpNoMatch</span><span class="op" id="5242565">)</span><span class="op" id="5242566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5242569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242573">return</span>&nbsp;<span class="ident" id="5242580">p</span><span class="op" id="5242581">.</span><span class="ident" id="5242582">push</span><span class="op" id="5242586">(</span><span class="ident" id="5242587">p</span><span class="op" id="5242588">.</span><span class="ident" id="5242589">collapse</span><span class="op" id="5242597">(</span><span class="ident" id="5242598">subs</span><span class="op" id="5242602">,</span>&nbsp;<span class="ident" id="5242604">OpAlternate</span><span class="op" id="5242615">)</span><span class="op" id="5242616">)</span><br>
<span class="lineno">340</span><span class="op" id="5242618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5242621">//&nbsp;cleanAlt&nbsp;cleans&nbsp;re&nbsp;for&nbsp;eventual&nbsp;inclusion&nbsp;in&nbsp;an&nbsp;alternation.</span><br>
<span class="lineno"></span><span class="keyword" id="5242685">func</span>&nbsp;<span class="ident" id="5242690">cleanAlt</span><span class="op" id="5242698">(</span><span class="ident" id="5242699">re</span>&nbsp;<span class="op" id="5242702">*</span><span class="ident" id="5242703">Regexp</span><span class="op" id="5242709">)</span>&nbsp;<span class="op" id="5242711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242714">switch</span>&nbsp;<span class="ident" id="5242721">re</span><span class="op" id="5242723">.</span><span class="ident" id="5242724">Op</span>&nbsp;<span class="op" id="5242727">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242730">case</span>&nbsp;<span class="ident" id="5242735">OpCharClass</span><span class="op" id="5242746">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242750">re</span><span class="op" id="5242752">.</span><span class="ident" id="5242753">Rune</span>&nbsp;<span class="op" id="5242758">=</span>&nbsp;<span class="ident" id="5242760">cleanClass</span><span class="op" id="5242770">(</span><span class="op" id="5242771">&amp;</span><span class="ident" id="5242772">re</span><span class="op" id="5242774">.</span><span class="ident" id="5242775">Rune</span><span class="op" id="5242779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242783">if</span>&nbsp;<span class="builtinfunc" id="5242786">len</span><span class="op" id="5242789">(</span><span class="ident" id="5242790">re</span><span class="op" id="5242792">.</span><span class="ident" id="5242793">Rune</span><span class="op" id="5242797">)</span>&nbsp;<span class="op" id="5242799">==</span>&nbsp;<span class="num" id="5242802">2</span>&nbsp;<span class="op" id="5242804">&amp;&amp;</span>&nbsp;<span class="ident" id="5242807">re</span><span class="op" id="5242809">.</span><span class="ident" id="5242810">Rune</span><span class="op" id="5242814">[</span><span class="num" id="5242815">0</span><span class="op" id="5242816">]</span>&nbsp;<span class="op" id="5242818">==</span>&nbsp;<span class="num" id="5242821">0</span>&nbsp;<span class="op" id="5242823">&amp;&amp;</span>&nbsp;<span class="ident" id="5242826">re</span><span class="op" id="5242828">.</span><span class="ident" id="5242829">Rune</span><span class="op" id="5242833">[</span><span class="num" id="5242834">1</span><span class="op" id="5242835">]</span>&nbsp;<span class="op" id="5242837">==</span>&nbsp;<span class="ident" id="5242840">unicode</span><span class="op" id="5242847">.</span><span class="ident" id="5242848">MaxRune</span>&nbsp;<span class="op" id="5242856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242861">re</span><span class="op" id="5242863">.</span><span class="ident" id="5242864">Rune</span>&nbsp;<span class="op" id="5242869">=</span>&nbsp;<span class="ident" id="5242871">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5242878">re</span><span class="op" id="5242880">.</span><span class="ident" id="5242881">Op</span>&nbsp;<span class="op" id="5242884">=</span>&nbsp;<span class="ident" id="5242886">OpAnyChar</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242899">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5242908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5242912">if</span>&nbsp;<span class="builtinfunc" id="5242915">len</span><span class="op" id="5242918">(</span><span class="ident" id="5242919">re</span><span class="op" id="5242921">.</span><span class="ident" id="5242922">Rune</span><span class="op" id="5242926">)</span>&nbsp;<span class="op" id="5242928">==</span>&nbsp;<span class="num" id="5242931">4</span>&nbsp;<span class="op" id="5242933">&amp;&amp;</span>&nbsp;<span class="ident" id="5242936">re</span><span class="op" id="5242938">.</span><span class="ident" id="5242939">Rune</span><span class="op" id="5242943">[</span><span class="num" id="5242944">0</span><span class="op" id="5242945">]</span>&nbsp;<span class="op" id="5242947">==</span>&nbsp;<span class="num" id="5242950">0</span>&nbsp;<span class="op" id="5242952">&amp;&amp;</span>&nbsp;<span class="ident" id="5242955">re</span><span class="op" id="5242957">.</span><span class="ident" id="5242958">Rune</span><span class="op" id="5242962">[</span><span class="num" id="5242963">1</span><span class="op" id="5242964">]</span>&nbsp;<span class="op" id="5242966">==</span>&nbsp;<span class="string" id="5242969">&#39;\n&#39;</span><span class="op" id="5242973">-</span><span class="num" id="5242974">1</span>&nbsp;<span class="op" id="5242976">&amp;&amp;</span>&nbsp;<span class="ident" id="5242979">re</span><span class="op" id="5242981">.</span><span class="ident" id="5242982">Rune</span><span class="op" id="5242986">[</span><span class="num" id="5242987">2</span><span class="op" id="5242988">]</span>&nbsp;<span class="op" id="5242990">==</span>&nbsp;<span class="string" id="5242993">&#39;\n&#39;</span><span class="op" id="5242997">+</span><span class="num" id="5242998">1</span>&nbsp;<span class="op" id="5243000">&amp;&amp;</span>&nbsp;<span class="ident" id="5243003">re</span><span class="op" id="5243005">.</span><span class="ident" id="5243006">Rune</span><span class="op" id="5243010">[</span><span class="num" id="5243011">3</span><span class="op" id="5243012">]</span>&nbsp;<span class="op" id="5243014">==</span>&nbsp;<span class="ident" id="5243017">unicode</span><span class="op" id="5243024">.</span><span class="ident" id="5243025">MaxRune</span>&nbsp;<span class="op" id="5243033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5243038">re</span><span class="op" id="5243040">.</span><span class="ident" id="5243041">Rune</span>&nbsp;<span class="op" id="5243046">=</span>&nbsp;<span class="ident" id="5243048">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5243055">re</span><span class="op" id="5243057">.</span><span class="ident" id="5243058">Op</span>&nbsp;<span class="op" id="5243061">=</span>&nbsp;<span class="ident" id="5243063">OpAnyCharNotNL</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243081">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243094">if</span>&nbsp;<span class="builtinfunc" id="5243097">cap</span><span class="op" id="5243100">(</span><span class="ident" id="5243101">re</span><span class="op" id="5243103">.</span><span class="ident" id="5243104">Rune</span><span class="op" id="5243108">)</span><span class="op" id="5243109">-</span><span class="builtinfunc" id="5243110">len</span><span class="op" id="5243113">(</span><span class="ident" id="5243114">re</span><span class="op" id="5243116">.</span><span class="ident" id="5243117">Rune</span><span class="op" id="5243121">)</span>&nbsp;<span class="op" id="5243123">&gt;</span>&nbsp;<span class="num" id="5243125">100</span>&nbsp;<span class="op" id="5243129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5243134">//&nbsp;re.Rune&nbsp;will&nbsp;not&nbsp;grow&nbsp;any&nbsp;more.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5243172">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;or&nbsp;inline&nbsp;to&nbsp;reclaim&nbsp;storage.</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5243220">re</span><span class="op" id="5243222">.</span><span class="ident" id="5243223">Rune</span>&nbsp;<span class="op" id="5243228">=</span>&nbsp;<span class="builtinfunc" id="5243230">append</span><span class="op" id="5243236">(</span><span class="ident" id="5243237">re</span><span class="op" id="5243239">.</span><span class="ident" id="5243240">Rune0</span><span class="op" id="5243245">[</span><span class="op" id="5243246">:</span><span class="num" id="5243247">0</span><span class="op" id="5243248">]</span><span class="op" id="5243249">,</span>&nbsp;<span class="ident" id="5243251">re</span><span class="op" id="5243253">.</span><span class="ident" id="5243254">Rune</span><span class="op" id="5243258">...</span><span class="op" id="5243261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243268">}</span><br>
<span class="lineno"></span><span class="op" id="5243270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="5243273">//&nbsp;collapse&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;applying&nbsp;op&nbsp;to&nbsp;sub.</span><br>
<span class="lineno"></span><span class="comment" id="5243327">//&nbsp;If&nbsp;sub&nbsp;contains&nbsp;op&nbsp;nodes,&nbsp;they&nbsp;all&nbsp;get&nbsp;hoisted&nbsp;up</span><br>
<span class="lineno"></span><span class="comment" id="5243380">//&nbsp;so&nbsp;that&nbsp;there&nbsp;is&nbsp;never&nbsp;a&nbsp;concat&nbsp;of&nbsp;a&nbsp;concat&nbsp;or&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5243433">//&nbsp;alternate&nbsp;of&nbsp;an&nbsp;alternate.</span><br>
<span class="lineno"></span><span class="keyword" id="5243463">func</span>&nbsp;<span class="op" id="5243468">(</span><span class="ident" id="5243469">p</span>&nbsp;<span class="op" id="5243471">*</span><span class="ident" id="5243472">parser</span><span class="op" id="5243478">)</span>&nbsp;<span class="ident" id="5243480">collapse</span><span class="op" id="5243488">(</span><span class="ident" id="5243489">subs</span>&nbsp;<span class="op" id="5243494">[</span><span class="op" id="5243495">]</span><span class="op" id="5243496">*</span><span class="ident" id="5243497">Regexp</span><span class="op" id="5243503">,</span>&nbsp;<span class="ident" id="5243505">op</span>&nbsp;<span class="ident" id="5243508">Op</span><span class="op" id="5243510">)</span>&nbsp;<span class="op" id="5243512">*</span><span class="ident" id="5243513">Regexp</span>&nbsp;<span class="op" id="5243520">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243523">if</span>&nbsp;<span class="builtinfunc" id="5243526">len</span><span class="op" id="5243529">(</span><span class="ident" id="5243530">subs</span><span class="op" id="5243534">)</span>&nbsp;<span class="op" id="5243536">==</span>&nbsp;<span class="num" id="5243539">1</span>&nbsp;<span class="op" id="5243541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243545">return</span>&nbsp;<span class="ident" id="5243552">subs</span><span class="op" id="5243556">[</span><span class="num" id="5243557">0</span><span class="op" id="5243558">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5243564">re</span>&nbsp;<span class="op" id="5243567">:=</span>&nbsp;<span class="ident" id="5243570">p</span><span class="op" id="5243571">.</span><span class="ident" id="5243572">newRegexp</span><span class="op" id="5243581">(</span><span class="ident" id="5243582">op</span><span class="op" id="5243584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5243587">re</span><span class="op" id="5243589">.</span><span class="ident" id="5243590">Sub</span>&nbsp;<span class="op" id="5243594">=</span>&nbsp;<span class="ident" id="5243596">re</span><span class="op" id="5243598">.</span><span class="ident" id="5243599">Sub0</span><span class="op" id="5243603">[</span><span class="op" id="5243604">:</span><span class="num" id="5243605">0</span><span class="op" id="5243606">]</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243609">for</span>&nbsp;<span class="ident" id="5243613">_</span><span class="op" id="5243614">,</span>&nbsp;<span class="ident" id="5243616">sub</span>&nbsp;<span class="op" id="5243620">:=</span>&nbsp;<span class="keyword" id="5243623">range</span>&nbsp;<span class="ident" id="5243629">subs</span>&nbsp;<span class="op" id="5243634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243638">if</span>&nbsp;<span class="ident" id="5243641">sub</span><span class="op" id="5243644">.</span><span class="ident" id="5243645">Op</span>&nbsp;<span class="op" id="5243648">==</span>&nbsp;<span class="ident" id="5243651">op</span>&nbsp;<span class="op" id="5243654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5243659">re</span><span class="op" id="5243661">.</span><span class="ident" id="5243662">Sub</span>&nbsp;<span class="op" id="5243666">=</span>&nbsp;<span class="builtinfunc" id="5243668">append</span><span class="op" id="5243674">(</span><span class="ident" id="5243675">re</span><span class="op" id="5243677">.</span><span class="ident" id="5243678">Sub</span><span class="op" id="5243681">,</span>&nbsp;<span class="ident" id="5243683">sub</span><span class="op" id="5243686">.</span><span class="ident" id="5243687">Sub</span><span class="op" id="5243690">...</span><span class="op" id="5243693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5243698">p</span><span class="op" id="5243699">.</span><span class="ident" id="5243700">reuse</span><span class="op" id="5243705">(</span><span class="ident" id="5243706">sub</span><span class="op" id="5243709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243713">}</span>&nbsp;<span class="keyword" id="5243715">else</span>&nbsp;<span class="op" id="5243720">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5243725">re</span><span class="op" id="5243727">.</span><span class="ident" id="5243728">Sub</span>&nbsp;<span class="op" id="5243732">=</span>&nbsp;<span class="builtinfunc" id="5243734">append</span><span class="op" id="5243740">(</span><span class="ident" id="5243741">re</span><span class="op" id="5243743">.</span><span class="ident" id="5243744">Sub</span><span class="op" id="5243747">,</span>&nbsp;<span class="ident" id="5243749">sub</span><span class="op" id="5243752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243762">if</span>&nbsp;<span class="ident" id="5243765">op</span>&nbsp;<span class="op" id="5243768">==</span>&nbsp;<span class="ident" id="5243771">OpAlternate</span>&nbsp;<span class="op" id="5243783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5243787">re</span><span class="op" id="5243789">.</span><span class="ident" id="5243790">Sub</span>&nbsp;<span class="op" id="5243794">=</span>&nbsp;<span class="ident" id="5243796">p</span><span class="op" id="5243797">.</span><span class="ident" id="5243798">factor</span><span class="op" id="5243804">(</span><span class="ident" id="5243805">re</span><span class="op" id="5243807">.</span><span class="ident" id="5243808">Sub</span><span class="op" id="5243811">,</span>&nbsp;<span class="ident" id="5243813">re</span><span class="op" id="5243815">.</span><span class="ident" id="5243816">Flags</span><span class="op" id="5243821">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243825">if</span>&nbsp;<span class="builtinfunc" id="5243828">len</span><span class="op" id="5243831">(</span><span class="ident" id="5243832">re</span><span class="op" id="5243834">.</span><span class="ident" id="5243835">Sub</span><span class="op" id="5243838">)</span>&nbsp;<span class="op" id="5243840">==</span>&nbsp;<span class="num" id="5243843">1</span>&nbsp;<span class="op" id="5243845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5243850">old</span>&nbsp;<span class="op" id="5243854">:=</span>&nbsp;<span class="ident" id="5243857">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5243863">re</span>&nbsp;<span class="op" id="5243866">=</span>&nbsp;<span class="ident" id="5243868">re</span><span class="op" id="5243870">.</span><span class="ident" id="5243871">Sub</span><span class="op" id="5243874">[</span><span class="num" id="5243875">0</span><span class="op" id="5243876">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5243881">p</span><span class="op" id="5243882">.</span><span class="ident" id="5243883">reuse</span><span class="op" id="5243888">(</span><span class="ident" id="5243889">old</span><span class="op" id="5243892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243896">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5243899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5243902">return</span>&nbsp;<span class="ident" id="5243909">re</span><br>
<span class="lineno"></span><span class="op" id="5243912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5243915">//&nbsp;factor&nbsp;factors&nbsp;common&nbsp;prefixes&nbsp;from&nbsp;the&nbsp;alternation&nbsp;list&nbsp;sub.</span><br>
<span class="lineno">395</span><span class="comment" id="5243980">//&nbsp;It&nbsp;returns&nbsp;a&nbsp;replacement&nbsp;list&nbsp;that&nbsp;reuses&nbsp;the&nbsp;same&nbsp;storage&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5244046">//&nbsp;frees&nbsp;(passes&nbsp;to&nbsp;p.reuse)&nbsp;any&nbsp;removed&nbsp;*Regexps.</span><br>
<span class="lineno"></span><span class="comment" id="5244097">//</span><br>
<span class="lineno"></span><span class="comment" id="5244100">//&nbsp;For&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="5244116">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ABC|ABD|AEF|BCX|BCY</span><br>
<span class="lineno">400</span><span class="comment" id="5244143">//&nbsp;simplifies&nbsp;by&nbsp;literal&nbsp;prefix&nbsp;extraction&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5244189">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A(B(C|D)|EF)|BC(X|Y)</span><br>
<span class="lineno"></span><span class="comment" id="5244217">//&nbsp;which&nbsp;simplifies&nbsp;by&nbsp;character&nbsp;class&nbsp;introduction&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5244272">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A(B[CD]|EF)|BC[XY]</span><br>
<span class="lineno"></span><span class="comment" id="5244298">//</span><br>
<span class="lineno">405</span><span class="keyword" id="5244301">func</span>&nbsp;<span class="op" id="5244306">(</span><span class="ident" id="5244307">p</span>&nbsp;<span class="op" id="5244309">*</span><span class="ident" id="5244310">parser</span><span class="op" id="5244316">)</span>&nbsp;<span class="ident" id="5244318">factor</span><span class="op" id="5244324">(</span><span class="ident" id="5244325">sub</span>&nbsp;<span class="op" id="5244329">[</span><span class="op" id="5244330">]</span><span class="op" id="5244331">*</span><span class="ident" id="5244332">Regexp</span><span class="op" id="5244338">,</span>&nbsp;<span class="ident" id="5244340">flags</span>&nbsp;<span class="ident" id="5244346">Flags</span><span class="op" id="5244351">)</span>&nbsp;<span class="op" id="5244353">[</span><span class="op" id="5244354">]</span><span class="op" id="5244355">*</span><span class="ident" id="5244356">Regexp</span>&nbsp;<span class="op" id="5244363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244366">if</span>&nbsp;<span class="builtinfunc" id="5244369">len</span><span class="op" id="5244372">(</span><span class="ident" id="5244373">sub</span><span class="op" id="5244376">)</span>&nbsp;<span class="op" id="5244378">&lt;</span>&nbsp;<span class="num" id="5244380">2</span>&nbsp;<span class="op" id="5244382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244386">return</span>&nbsp;<span class="ident" id="5244393">sub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5244398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5244402">//&nbsp;Round&nbsp;1:&nbsp;Factor&nbsp;out&nbsp;common&nbsp;literal&nbsp;prefixes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244451">var</span>&nbsp;<span class="ident" id="5244455">str</span>&nbsp;<span class="op" id="5244459">[</span><span class="op" id="5244460">]</span><span class="builtintype" id="5244461">rune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244467">var</span>&nbsp;<span class="ident" id="5244471">strflags</span>&nbsp;<span class="ident" id="5244480">Flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244487">start</span>&nbsp;<span class="op" id="5244493">:=</span>&nbsp;<span class="num" id="5244496">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244499">out</span>&nbsp;<span class="op" id="5244503">:=</span>&nbsp;<span class="ident" id="5244506">sub</span><span class="op" id="5244509">[</span><span class="op" id="5244510">:</span><span class="num" id="5244511">0</span><span class="op" id="5244512">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244515">for</span>&nbsp;<span class="ident" id="5244519">i</span>&nbsp;<span class="op" id="5244521">:=</span>&nbsp;<span class="num" id="5244524">0</span><span class="op" id="5244525">;</span>&nbsp;<span class="ident" id="5244527">i</span>&nbsp;<span class="op" id="5244529">&lt;=</span>&nbsp;<span class="builtinfunc" id="5244532">len</span><span class="op" id="5244535">(</span><span class="ident" id="5244536">sub</span><span class="op" id="5244539">)</span><span class="op" id="5244540">;</span>&nbsp;<span class="ident" id="5244542">i</span><span class="op" id="5244543">++</span>&nbsp;<span class="op" id="5244546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5244550">//&nbsp;Invariant:&nbsp;the&nbsp;Regexps&nbsp;that&nbsp;were&nbsp;in&nbsp;sub[0:start]&nbsp;have&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5244614">//&nbsp;used&nbsp;or&nbsp;marked&nbsp;for&nbsp;reuse,&nbsp;and&nbsp;the&nbsp;slice&nbsp;space&nbsp;has&nbsp;been&nbsp;reused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5244681">//&nbsp;for&nbsp;out&nbsp;(len(out)&nbsp;&lt;=&nbsp;start).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5244715">//</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5244720">//&nbsp;Invariant:&nbsp;sub[start:i]&nbsp;consists&nbsp;of&nbsp;regexps&nbsp;that&nbsp;all&nbsp;begin</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5244784">//&nbsp;with&nbsp;str&nbsp;as&nbsp;modified&nbsp;by&nbsp;strflags.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244823">var</span>&nbsp;<span class="ident" id="5244827">istr</span>&nbsp;<span class="op" id="5244832">[</span><span class="op" id="5244833">]</span><span class="builtintype" id="5244834">rune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244841">var</span>&nbsp;<span class="ident" id="5244845">iflags</span>&nbsp;<span class="ident" id="5244852">Flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244860">if</span>&nbsp;<span class="ident" id="5244863">i</span>&nbsp;<span class="op" id="5244865">&lt;</span>&nbsp;<span class="builtinfunc" id="5244867">len</span><span class="op" id="5244870">(</span><span class="ident" id="5244871">sub</span><span class="op" id="5244874">)</span>&nbsp;<span class="op" id="5244876">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244881">istr</span><span class="op" id="5244885">,</span>&nbsp;<span class="ident" id="5244887">iflags</span>&nbsp;<span class="op" id="5244894">=</span>&nbsp;<span class="ident" id="5244896">p</span><span class="op" id="5244897">.</span><span class="ident" id="5244898">leadingString</span><span class="op" id="5244911">(</span><span class="ident" id="5244912">sub</span><span class="op" id="5244915">[</span><span class="ident" id="5244916">i</span><span class="op" id="5244917">]</span><span class="op" id="5244918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244923">if</span>&nbsp;<span class="ident" id="5244926">iflags</span>&nbsp;<span class="op" id="5244933">==</span>&nbsp;<span class="ident" id="5244936">strflags</span>&nbsp;<span class="op" id="5244945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5244951">same</span>&nbsp;<span class="op" id="5244956">:=</span>&nbsp;<span class="num" id="5244959">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5244965">for</span>&nbsp;<span class="ident" id="5244969">same</span>&nbsp;<span class="op" id="5244974">&lt;</span>&nbsp;<span class="builtinfunc" id="5244976">len</span><span class="op" id="5244979">(</span><span class="ident" id="5244980">str</span><span class="op" id="5244983">)</span>&nbsp;<span class="op" id="5244985">&amp;&amp;</span>&nbsp;<span class="ident" id="5244988">same</span>&nbsp;<span class="op" id="5244993">&lt;</span>&nbsp;<span class="builtinfunc" id="5244995">len</span><span class="op" id="5244998">(</span><span class="ident" id="5244999">istr</span><span class="op" id="5245003">)</span>&nbsp;<span class="op" id="5245005">&amp;&amp;</span>&nbsp;<span class="ident" id="5245008">str</span><span class="op" id="5245011">[</span><span class="ident" id="5245012">same</span><span class="op" id="5245016">]</span>&nbsp;<span class="op" id="5245018">==</span>&nbsp;<span class="ident" id="5245021">istr</span><span class="op" id="5245025">[</span><span class="ident" id="5245026">same</span><span class="op" id="5245030">]</span>&nbsp;<span class="op" id="5245032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245039">same</span><span class="op" id="5245043">++</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5245050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5245056">if</span>&nbsp;<span class="ident" id="5245059">same</span>&nbsp;<span class="op" id="5245064">&gt;</span>&nbsp;<span class="num" id="5245066">0</span>&nbsp;<span class="op" id="5245068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5245075">//&nbsp;Matches&nbsp;at&nbsp;least&nbsp;one&nbsp;rune&nbsp;in&nbsp;current&nbsp;range.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5245127">//&nbsp;Keep&nbsp;going&nbsp;around.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245154">str</span>&nbsp;<span class="op" id="5245158">=</span>&nbsp;<span class="ident" id="5245160">str</span><span class="op" id="5245163">[</span><span class="op" id="5245164">:</span><span class="ident" id="5245165">same</span><span class="op" id="5245169">]</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5245176">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5245189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5245194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5245198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5245203">//&nbsp;Found&nbsp;end&nbsp;of&nbsp;a&nbsp;run&nbsp;with&nbsp;common&nbsp;leading&nbsp;literal&nbsp;string:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5245263">//&nbsp;sub[start:i]&nbsp;all&nbsp;begin&nbsp;with&nbsp;str[0:len(str)],&nbsp;but&nbsp;sub[i]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5245324">//&nbsp;does&nbsp;not&nbsp;even&nbsp;begin&nbsp;with&nbsp;str[0].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5245362">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5245367">//&nbsp;Factor&nbsp;out&nbsp;common&nbsp;string&nbsp;and&nbsp;append&nbsp;factored&nbsp;expression&nbsp;to&nbsp;out.</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5245436">if</span>&nbsp;<span class="ident" id="5245439">i</span>&nbsp;<span class="op" id="5245441">==</span>&nbsp;<span class="ident" id="5245444">start</span>&nbsp;<span class="op" id="5245450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5245455">//&nbsp;Nothing&nbsp;to&nbsp;do&nbsp;-&nbsp;run&nbsp;of&nbsp;length&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5245493">}</span>&nbsp;<span class="keyword" id="5245495">else</span>&nbsp;<span class="keyword" id="5245500">if</span>&nbsp;<span class="ident" id="5245503">i</span>&nbsp;<span class="op" id="5245505">==</span>&nbsp;<span class="ident" id="5245508">start</span><span class="op" id="5245513">+</span><span class="num" id="5245514">1</span>&nbsp;<span class="op" id="5245516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5245521">//&nbsp;Just&nbsp;one:&nbsp;don&#39;t&nbsp;bother&nbsp;factoring.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245561">out</span>&nbsp;<span class="op" id="5245565">=</span>&nbsp;<span class="builtinfunc" id="5245567">append</span><span class="op" id="5245573">(</span><span class="ident" id="5245574">out</span><span class="op" id="5245577">,</span>&nbsp;<span class="ident" id="5245579">sub</span><span class="op" id="5245582">[</span><span class="ident" id="5245583">start</span><span class="op" id="5245588">]</span><span class="op" id="5245589">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5245593">}</span>&nbsp;<span class="keyword" id="5245595">else</span>&nbsp;<span class="op" id="5245600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5245605">//&nbsp;Construct&nbsp;factored&nbsp;form:&nbsp;prefix(suffix1|suffix2|...)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245664">prefix</span>&nbsp;<span class="op" id="5245671">:=</span>&nbsp;<span class="ident" id="5245674">p</span><span class="op" id="5245675">.</span><span class="ident" id="5245676">newRegexp</span><span class="op" id="5245685">(</span><span class="ident" id="5245686">OpLiteral</span><span class="op" id="5245695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245700">prefix</span><span class="op" id="5245706">.</span><span class="ident" id="5245707">Flags</span>&nbsp;<span class="op" id="5245713">=</span>&nbsp;<span class="ident" id="5245715">strflags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245727">prefix</span><span class="op" id="5245733">.</span><span class="ident" id="5245734">Rune</span>&nbsp;<span class="op" id="5245739">=</span>&nbsp;<span class="builtinfunc" id="5245741">append</span><span class="op" id="5245747">(</span><span class="ident" id="5245748">prefix</span><span class="op" id="5245754">.</span><span class="ident" id="5245755">Rune</span><span class="op" id="5245759">[</span><span class="op" id="5245760">:</span><span class="num" id="5245761">0</span><span class="op" id="5245762">]</span><span class="op" id="5245763">,</span>&nbsp;<span class="ident" id="5245765">str</span><span class="op" id="5245768">...</span><span class="op" id="5245771">)</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5245777">for</span>&nbsp;<span class="ident" id="5245781">j</span>&nbsp;<span class="op" id="5245783">:=</span>&nbsp;<span class="ident" id="5245786">start</span><span class="op" id="5245791">;</span>&nbsp;<span class="ident" id="5245793">j</span>&nbsp;<span class="op" id="5245795">&lt;</span>&nbsp;<span class="ident" id="5245797">i</span><span class="op" id="5245798">;</span>&nbsp;<span class="ident" id="5245800">j</span><span class="op" id="5245801">++</span>&nbsp;<span class="op" id="5245804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245810">sub</span><span class="op" id="5245813">[</span><span class="ident" id="5245814">j</span><span class="op" id="5245815">]</span>&nbsp;<span class="op" id="5245817">=</span>&nbsp;<span class="ident" id="5245819">p</span><span class="op" id="5245820">.</span><span class="ident" id="5245821">removeLeadingString</span><span class="op" id="5245840">(</span><span class="ident" id="5245841">sub</span><span class="op" id="5245844">[</span><span class="ident" id="5245845">j</span><span class="op" id="5245846">]</span><span class="op" id="5245847">,</span>&nbsp;<span class="builtinfunc" id="5245849">len</span><span class="op" id="5245852">(</span><span class="ident" id="5245853">str</span><span class="op" id="5245856">)</span><span class="op" id="5245857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5245862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245867">suffix</span>&nbsp;<span class="op" id="5245874">:=</span>&nbsp;<span class="ident" id="5245877">p</span><span class="op" id="5245878">.</span><span class="ident" id="5245879">collapse</span><span class="op" id="5245887">(</span><span class="ident" id="5245888">sub</span><span class="op" id="5245891">[</span><span class="ident" id="5245892">start</span><span class="op" id="5245897">:</span><span class="ident" id="5245898">i</span><span class="op" id="5245899">]</span><span class="op" id="5245900">,</span>&nbsp;<span class="ident" id="5245902">OpAlternate</span><span class="op" id="5245913">)</span>&nbsp;<span class="comment" id="5245915">//&nbsp;recurse</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245930">re</span>&nbsp;<span class="op" id="5245933">:=</span>&nbsp;<span class="ident" id="5245936">p</span><span class="op" id="5245937">.</span><span class="ident" id="5245938">newRegexp</span><span class="op" id="5245947">(</span><span class="ident" id="5245948">OpConcat</span><span class="op" id="5245956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5245961">re</span><span class="op" id="5245963">.</span><span class="ident" id="5245964">Sub</span>&nbsp;<span class="op" id="5245968">=</span>&nbsp;<span class="builtinfunc" id="5245970">append</span><span class="op" id="5245976">(</span><span class="ident" id="5245977">re</span><span class="op" id="5245979">.</span><span class="ident" id="5245980">Sub</span><span class="op" id="5245983">[</span><span class="op" id="5245984">:</span><span class="num" id="5245985">0</span><span class="op" id="5245986">]</span><span class="op" id="5245987">,</span>&nbsp;<span class="ident" id="5245989">prefix</span><span class="op" id="5245995">,</span>&nbsp;<span class="ident" id="5245997">suffix</span><span class="op" id="5246003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246008">out</span>&nbsp;<span class="op" id="5246012">=</span>&nbsp;<span class="builtinfunc" id="5246014">append</span><span class="op" id="5246020">(</span><span class="ident" id="5246021">out</span><span class="op" id="5246024">,</span>&nbsp;<span class="ident" id="5246026">re</span><span class="op" id="5246028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5246032">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5246037">//&nbsp;Prepare&nbsp;for&nbsp;next&nbsp;iteration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246070">start</span>&nbsp;<span class="op" id="5246076">=</span>&nbsp;<span class="ident" id="5246078">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246082">str</span>&nbsp;<span class="op" id="5246086">=</span>&nbsp;<span class="ident" id="5246088">istr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246095">strflags</span>&nbsp;<span class="op" id="5246104">=</span>&nbsp;<span class="ident" id="5246106">iflags</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5246114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246117">sub</span>&nbsp;<span class="op" id="5246121">=</span>&nbsp;<span class="ident" id="5246123">out</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5246129">//&nbsp;Round&nbsp;2:&nbsp;Factor&nbsp;out&nbsp;common&nbsp;complex&nbsp;prefixes,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5246178">//&nbsp;just&nbsp;the&nbsp;first&nbsp;piece&nbsp;of&nbsp;each&nbsp;concatenation,</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5246226">//&nbsp;whatever&nbsp;it&nbsp;is.&nbsp;&nbsp;This&nbsp;is&nbsp;good&nbsp;enough&nbsp;a&nbsp;lot&nbsp;of&nbsp;the&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246286">start</span>&nbsp;<span class="op" id="5246292">=</span>&nbsp;<span class="num" id="5246294">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246297">out</span>&nbsp;<span class="op" id="5246301">=</span>&nbsp;<span class="ident" id="5246303">sub</span><span class="op" id="5246306">[</span><span class="op" id="5246307">:</span><span class="num" id="5246308">0</span><span class="op" id="5246309">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246312">var</span>&nbsp;<span class="ident" id="5246316">first</span>&nbsp;<span class="op" id="5246322">*</span><span class="ident" id="5246323">Regexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246331">for</span>&nbsp;<span class="ident" id="5246335">i</span>&nbsp;<span class="op" id="5246337">:=</span>&nbsp;<span class="num" id="5246340">0</span><span class="op" id="5246341">;</span>&nbsp;<span class="ident" id="5246343">i</span>&nbsp;<span class="op" id="5246345">&lt;=</span>&nbsp;<span class="builtinfunc" id="5246348">len</span><span class="op" id="5246351">(</span><span class="ident" id="5246352">sub</span><span class="op" id="5246355">)</span><span class="op" id="5246356">;</span>&nbsp;<span class="ident" id="5246358">i</span><span class="op" id="5246359">++</span>&nbsp;<span class="op" id="5246362">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5246366">//&nbsp;Invariant:&nbsp;the&nbsp;Regexps&nbsp;that&nbsp;were&nbsp;in&nbsp;sub[0:start]&nbsp;have&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5246430">//&nbsp;used&nbsp;or&nbsp;marked&nbsp;for&nbsp;reuse,&nbsp;and&nbsp;the&nbsp;slice&nbsp;space&nbsp;has&nbsp;been&nbsp;reused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5246497">//&nbsp;for&nbsp;out&nbsp;(len(out)&nbsp;&lt;=&nbsp;start).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5246531">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5246536">//&nbsp;Invariant:&nbsp;sub[start:i]&nbsp;consists&nbsp;of&nbsp;regexps&nbsp;that&nbsp;all&nbsp;begin&nbsp;with&nbsp;ifirst.</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246613">var</span>&nbsp;<span class="ident" id="5246617">ifirst</span>&nbsp;<span class="op" id="5246624">*</span><span class="ident" id="5246625">Regexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246634">if</span>&nbsp;<span class="ident" id="5246637">i</span>&nbsp;<span class="op" id="5246639">&lt;</span>&nbsp;<span class="builtinfunc" id="5246641">len</span><span class="op" id="5246644">(</span><span class="ident" id="5246645">sub</span><span class="op" id="5246648">)</span>&nbsp;<span class="op" id="5246650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5246655">ifirst</span>&nbsp;<span class="op" id="5246662">=</span>&nbsp;<span class="ident" id="5246664">p</span><span class="op" id="5246665">.</span><span class="ident" id="5246666">leadingRegexp</span><span class="op" id="5246679">(</span><span class="ident" id="5246680">sub</span><span class="op" id="5246683">[</span><span class="ident" id="5246684">i</span><span class="op" id="5246685">]</span><span class="op" id="5246686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246691">if</span>&nbsp;<span class="ident" id="5246694">first</span>&nbsp;<span class="op" id="5246700">!=</span>&nbsp;<span class="ident" id="5246703">nil</span>&nbsp;<span class="op" id="5246707">&amp;&amp;</span>&nbsp;<span class="ident" id="5246710">first</span><span class="op" id="5246715">.</span><span class="ident" id="5246716">Equal</span><span class="op" id="5246721">(</span><span class="ident" id="5246722">ifirst</span><span class="op" id="5246728">)</span>&nbsp;<span class="op" id="5246730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246736">continue</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5246748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5246752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5246757">//&nbsp;Found&nbsp;end&nbsp;of&nbsp;a&nbsp;run&nbsp;with&nbsp;common&nbsp;leading&nbsp;regexp:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5246809">//&nbsp;sub[start:i]&nbsp;all&nbsp;begin&nbsp;with&nbsp;first&nbsp;but&nbsp;sub[i]&nbsp;does&nbsp;not.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5246869">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5246874">//&nbsp;Factor&nbsp;out&nbsp;common&nbsp;regexp&nbsp;and&nbsp;append&nbsp;factored&nbsp;expression&nbsp;to&nbsp;out.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5246943">if</span>&nbsp;<span class="ident" id="5246946">i</span>&nbsp;<span class="op" id="5246948">==</span>&nbsp;<span class="ident" id="5246951">start</span>&nbsp;<span class="op" id="5246957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5246962">//&nbsp;Nothing&nbsp;to&nbsp;do&nbsp;-&nbsp;run&nbsp;of&nbsp;length&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5247000">}</span>&nbsp;<span class="keyword" id="5247002">else</span>&nbsp;<span class="keyword" id="5247007">if</span>&nbsp;<span class="ident" id="5247010">i</span>&nbsp;<span class="op" id="5247012">==</span>&nbsp;<span class="ident" id="5247015">start</span><span class="op" id="5247020">+</span><span class="num" id="5247021">1</span>&nbsp;<span class="op" id="5247023">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5247028">//&nbsp;Just&nbsp;one:&nbsp;don&#39;t&nbsp;bother&nbsp;factoring.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247068">out</span>&nbsp;<span class="op" id="5247072">=</span>&nbsp;<span class="builtinfunc" id="5247074">append</span><span class="op" id="5247080">(</span><span class="ident" id="5247081">out</span><span class="op" id="5247084">,</span>&nbsp;<span class="ident" id="5247086">sub</span><span class="op" id="5247089">[</span><span class="ident" id="5247090">start</span><span class="op" id="5247095">]</span><span class="op" id="5247096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5247100">}</span>&nbsp;<span class="keyword" id="5247102">else</span>&nbsp;<span class="op" id="5247107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5247112">//&nbsp;Construct&nbsp;factored&nbsp;form:&nbsp;prefix(suffix1|suffix2|...)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247171">prefix</span>&nbsp;<span class="op" id="5247178">:=</span>&nbsp;<span class="ident" id="5247181">first</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5247190">for</span>&nbsp;<span class="ident" id="5247194">j</span>&nbsp;<span class="op" id="5247196">:=</span>&nbsp;<span class="ident" id="5247199">start</span><span class="op" id="5247204">;</span>&nbsp;<span class="ident" id="5247206">j</span>&nbsp;<span class="op" id="5247208">&lt;</span>&nbsp;<span class="ident" id="5247210">i</span><span class="op" id="5247211">;</span>&nbsp;<span class="ident" id="5247213">j</span><span class="op" id="5247214">++</span>&nbsp;<span class="op" id="5247217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247223">reuse</span>&nbsp;<span class="op" id="5247229">:=</span>&nbsp;<span class="ident" id="5247232">j</span>&nbsp;<span class="op" id="5247234">!=</span>&nbsp;<span class="ident" id="5247237">start</span>&nbsp;<span class="comment" id="5247243">//&nbsp;prefix&nbsp;came&nbsp;from&nbsp;sub[start]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247278">sub</span><span class="op" id="5247281">[</span><span class="ident" id="5247282">j</span><span class="op" id="5247283">]</span>&nbsp;<span class="op" id="5247285">=</span>&nbsp;<span class="ident" id="5247287">p</span><span class="op" id="5247288">.</span><span class="ident" id="5247289">removeLeadingRegexp</span><span class="op" id="5247308">(</span><span class="ident" id="5247309">sub</span><span class="op" id="5247312">[</span><span class="ident" id="5247313">j</span><span class="op" id="5247314">]</span><span class="op" id="5247315">,</span>&nbsp;<span class="ident" id="5247317">reuse</span><span class="op" id="5247322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5247327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247332">suffix</span>&nbsp;<span class="op" id="5247339">:=</span>&nbsp;<span class="ident" id="5247342">p</span><span class="op" id="5247343">.</span><span class="ident" id="5247344">collapse</span><span class="op" id="5247352">(</span><span class="ident" id="5247353">sub</span><span class="op" id="5247356">[</span><span class="ident" id="5247357">start</span><span class="op" id="5247362">:</span><span class="ident" id="5247363">i</span><span class="op" id="5247364">]</span><span class="op" id="5247365">,</span>&nbsp;<span class="ident" id="5247367">OpAlternate</span><span class="op" id="5247378">)</span>&nbsp;<span class="comment" id="5247380">//&nbsp;recurse</span><br>
<span class="lineno">510</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247395">re</span>&nbsp;<span class="op" id="5247398">:=</span>&nbsp;<span class="ident" id="5247401">p</span><span class="op" id="5247402">.</span><span class="ident" id="5247403">newRegexp</span><span class="op" id="5247412">(</span><span class="ident" id="5247413">OpConcat</span><span class="op" id="5247421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247426">re</span><span class="op" id="5247428">.</span><span class="ident" id="5247429">Sub</span>&nbsp;<span class="op" id="5247433">=</span>&nbsp;<span class="builtinfunc" id="5247435">append</span><span class="op" id="5247441">(</span><span class="ident" id="5247442">re</span><span class="op" id="5247444">.</span><span class="ident" id="5247445">Sub</span><span class="op" id="5247448">[</span><span class="op" id="5247449">:</span><span class="num" id="5247450">0</span><span class="op" id="5247451">]</span><span class="op" id="5247452">,</span>&nbsp;<span class="ident" id="5247454">prefix</span><span class="op" id="5247460">,</span>&nbsp;<span class="ident" id="5247462">suffix</span><span class="op" id="5247468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247473">out</span>&nbsp;<span class="op" id="5247477">=</span>&nbsp;<span class="builtinfunc" id="5247479">append</span><span class="op" id="5247485">(</span><span class="ident" id="5247486">out</span><span class="op" id="5247489">,</span>&nbsp;<span class="ident" id="5247491">re</span><span class="op" id="5247493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5247497">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5247502">//&nbsp;Prepare&nbsp;for&nbsp;next&nbsp;iteration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247535">start</span>&nbsp;<span class="op" id="5247541">=</span>&nbsp;<span class="ident" id="5247543">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247547">first</span>&nbsp;<span class="op" id="5247553">=</span>&nbsp;<span class="ident" id="5247555">ifirst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5247563">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247566">sub</span>&nbsp;<span class="op" id="5247570">=</span>&nbsp;<span class="ident" id="5247572">out</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5247578">//&nbsp;Round&nbsp;3:&nbsp;Collapse&nbsp;runs&nbsp;of&nbsp;single&nbsp;literals&nbsp;into&nbsp;character&nbsp;classes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247648">start</span>&nbsp;<span class="op" id="5247654">=</span>&nbsp;<span class="num" id="5247656">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5247659">out</span>&nbsp;<span class="op" id="5247663">=</span>&nbsp;<span class="ident" id="5247665">sub</span><span class="op" id="5247668">[</span><span class="op" id="5247669">:</span><span class="num" id="5247670">0</span><span class="op" id="5247671">]</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5247674">for</span>&nbsp;<span class="ident" id="5247678">i</span>&nbsp;<span class="op" id="5247680">:=</span>&nbsp;<span class="num" id="5247683">0</span><span class="op" id="5247684">;</span>&nbsp;<span class="ident" id="5247686">i</span>&nbsp;<span class="op" id="5247688">&lt;=</span>&nbsp;<span class="builtinfunc" id="5247691">len</span><span class="op" id="5247694">(</span><span class="ident" id="5247695">sub</span><span class="op" id="5247698">)</span><span class="op" id="5247699">;</span>&nbsp;<span class="ident" id="5247701">i</span><span class="op" id="5247702">++</span>&nbsp;<span class="op" id="5247705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5247709">//&nbsp;Invariant:&nbsp;the&nbsp;Regexps&nbsp;that&nbsp;were&nbsp;in&nbsp;sub[0:start]&nbsp;have&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5247773">//&nbsp;used&nbsp;or&nbsp;marked&nbsp;for&nbsp;reuse,&nbsp;and&nbsp;the&nbsp;slice&nbsp;space&nbsp;has&nbsp;been&nbsp;reused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5247840">//&nbsp;for&nbsp;out&nbsp;(len(out)&nbsp;&lt;=&nbsp;start).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5247874">//</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5247879">//&nbsp;Invariant:&nbsp;sub[start:i]&nbsp;consists&nbsp;of&nbsp;regexps&nbsp;that&nbsp;are&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5247944">//&nbsp;literal&nbsp;runes&nbsp;or&nbsp;character&nbsp;classes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5247985">if</span>&nbsp;<span class="ident" id="5247988">i</span>&nbsp;<span class="op" id="5247990">&lt;</span>&nbsp;<span class="builtinfunc" id="5247992">len</span><span class="op" id="5247995">(</span><span class="ident" id="5247996">sub</span><span class="op" id="5247999">)</span>&nbsp;<span class="op" id="5248001">&amp;&amp;</span>&nbsp;<span class="ident" id="5248004">isCharClass</span><span class="op" id="5248015">(</span><span class="ident" id="5248016">sub</span><span class="op" id="5248019">[</span><span class="ident" id="5248020">i</span><span class="op" id="5248021">]</span><span class="op" id="5248022">)</span>&nbsp;<span class="op" id="5248024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248029">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5248040">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5248045">//&nbsp;sub[i]&nbsp;is&nbsp;not&nbsp;a&nbsp;char&nbsp;or&nbsp;char&nbsp;class;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5248086">//&nbsp;emit&nbsp;char&nbsp;class&nbsp;for&nbsp;sub[start:i]...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248127">if</span>&nbsp;<span class="ident" id="5248130">i</span>&nbsp;<span class="op" id="5248132">==</span>&nbsp;<span class="ident" id="5248135">start</span>&nbsp;<span class="op" id="5248141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5248146">//&nbsp;Nothing&nbsp;to&nbsp;do&nbsp;-&nbsp;run&nbsp;of&nbsp;length&nbsp;0.</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5248184">}</span>&nbsp;<span class="keyword" id="5248186">else</span>&nbsp;<span class="keyword" id="5248191">if</span>&nbsp;<span class="ident" id="5248194">i</span>&nbsp;<span class="op" id="5248196">==</span>&nbsp;<span class="ident" id="5248199">start</span><span class="op" id="5248204">+</span><span class="num" id="5248205">1</span>&nbsp;<span class="op" id="5248207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248212">out</span>&nbsp;<span class="op" id="5248216">=</span>&nbsp;<span class="builtinfunc" id="5248218">append</span><span class="op" id="5248224">(</span><span class="ident" id="5248225">out</span><span class="op" id="5248228">,</span>&nbsp;<span class="ident" id="5248230">sub</span><span class="op" id="5248233">[</span><span class="ident" id="5248234">start</span><span class="op" id="5248239">]</span><span class="op" id="5248240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5248244">}</span>&nbsp;<span class="keyword" id="5248246">else</span>&nbsp;<span class="op" id="5248251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5248256">//&nbsp;Make&nbsp;new&nbsp;char&nbsp;class.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5248283">//&nbsp;Start&nbsp;with&nbsp;most&nbsp;complex&nbsp;regexp&nbsp;in&nbsp;sub[start].</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248335">max</span>&nbsp;<span class="op" id="5248339">:=</span>&nbsp;<span class="ident" id="5248342">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248351">for</span>&nbsp;<span class="ident" id="5248355">j</span>&nbsp;<span class="op" id="5248357">:=</span>&nbsp;<span class="ident" id="5248360">start</span>&nbsp;<span class="op" id="5248366">+</span>&nbsp;<span class="num" id="5248368">1</span><span class="op" id="5248369">;</span>&nbsp;<span class="ident" id="5248371">j</span>&nbsp;<span class="op" id="5248373">&lt;</span>&nbsp;<span class="ident" id="5248375">i</span><span class="op" id="5248376">;</span>&nbsp;<span class="ident" id="5248378">j</span><span class="op" id="5248379">++</span>&nbsp;<span class="op" id="5248382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248388">if</span>&nbsp;<span class="ident" id="5248391">sub</span><span class="op" id="5248394">[</span><span class="ident" id="5248395">max</span><span class="op" id="5248398">]</span><span class="op" id="5248399">.</span><span class="ident" id="5248400">Op</span>&nbsp;<span class="op" id="5248403">&lt;</span>&nbsp;<span class="ident" id="5248405">sub</span><span class="op" id="5248408">[</span><span class="ident" id="5248409">j</span><span class="op" id="5248410">]</span><span class="op" id="5248411">.</span><span class="ident" id="5248412">Op</span>&nbsp;<span class="op" id="5248415">||</span>&nbsp;<span class="ident" id="5248418">sub</span><span class="op" id="5248421">[</span><span class="ident" id="5248422">max</span><span class="op" id="5248425">]</span><span class="op" id="5248426">.</span><span class="ident" id="5248427">Op</span>&nbsp;<span class="op" id="5248430">==</span>&nbsp;<span class="ident" id="5248433">sub</span><span class="op" id="5248436">[</span><span class="ident" id="5248437">j</span><span class="op" id="5248438">]</span><span class="op" id="5248439">.</span><span class="ident" id="5248440">Op</span>&nbsp;<span class="op" id="5248443">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5248446">len</span><span class="op" id="5248449">(</span><span class="ident" id="5248450">sub</span><span class="op" id="5248453">[</span><span class="ident" id="5248454">max</span><span class="op" id="5248457">]</span><span class="op" id="5248458">.</span><span class="ident" id="5248459">Rune</span><span class="op" id="5248463">)</span>&nbsp;<span class="op" id="5248465">&lt;</span>&nbsp;<span class="builtinfunc" id="5248467">len</span><span class="op" id="5248470">(</span><span class="ident" id="5248471">sub</span><span class="op" id="5248474">[</span><span class="ident" id="5248475">j</span><span class="op" id="5248476">]</span><span class="op" id="5248477">.</span><span class="ident" id="5248478">Rune</span><span class="op" id="5248482">)</span>&nbsp;<span class="op" id="5248484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248491">max</span>&nbsp;<span class="op" id="5248495">=</span>&nbsp;<span class="ident" id="5248497">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5248503">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5248508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248513">sub</span><span class="op" id="5248516">[</span><span class="ident" id="5248517">start</span><span class="op" id="5248522">]</span><span class="op" id="5248523">,</span>&nbsp;<span class="ident" id="5248525">sub</span><span class="op" id="5248528">[</span><span class="ident" id="5248529">max</span><span class="op" id="5248532">]</span>&nbsp;<span class="op" id="5248534">=</span>&nbsp;<span class="ident" id="5248536">sub</span><span class="op" id="5248539">[</span><span class="ident" id="5248540">max</span><span class="op" id="5248543">]</span><span class="op" id="5248544">,</span>&nbsp;<span class="ident" id="5248546">sub</span><span class="op" id="5248549">[</span><span class="ident" id="5248550">start</span><span class="op" id="5248555">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248561">for</span>&nbsp;<span class="ident" id="5248565">j</span>&nbsp;<span class="op" id="5248567">:=</span>&nbsp;<span class="ident" id="5248570">start</span>&nbsp;<span class="op" id="5248576">+</span>&nbsp;<span class="num" id="5248578">1</span><span class="op" id="5248579">;</span>&nbsp;<span class="ident" id="5248581">j</span>&nbsp;<span class="op" id="5248583">&lt;</span>&nbsp;<span class="ident" id="5248585">i</span><span class="op" id="5248586">;</span>&nbsp;<span class="ident" id="5248588">j</span><span class="op" id="5248589">++</span>&nbsp;<span class="op" id="5248592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248598">mergeCharClass</span><span class="op" id="5248612">(</span><span class="ident" id="5248613">sub</span><span class="op" id="5248616">[</span><span class="ident" id="5248617">start</span><span class="op" id="5248622">]</span><span class="op" id="5248623">,</span>&nbsp;<span class="ident" id="5248625">sub</span><span class="op" id="5248628">[</span><span class="ident" id="5248629">j</span><span class="op" id="5248630">]</span><span class="op" id="5248631">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248637">p</span><span class="op" id="5248638">.</span><span class="ident" id="5248639">reuse</span><span class="op" id="5248644">(</span><span class="ident" id="5248645">sub</span><span class="op" id="5248648">[</span><span class="ident" id="5248649">j</span><span class="op" id="5248650">]</span><span class="op" id="5248651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5248656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248661">cleanAlt</span><span class="op" id="5248669">(</span><span class="ident" id="5248670">sub</span><span class="op" id="5248673">[</span><span class="ident" id="5248674">start</span><span class="op" id="5248679">]</span><span class="op" id="5248680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248685">out</span>&nbsp;<span class="op" id="5248689">=</span>&nbsp;<span class="builtinfunc" id="5248691">append</span><span class="op" id="5248697">(</span><span class="ident" id="5248698">out</span><span class="op" id="5248701">,</span>&nbsp;<span class="ident" id="5248703">sub</span><span class="op" id="5248706">[</span><span class="ident" id="5248707">start</span><span class="op" id="5248712">]</span><span class="op" id="5248713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5248717">}</span><br>
<span class="lineno">560</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5248722">//&nbsp;...&nbsp;and&nbsp;then&nbsp;emit&nbsp;sub[i].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248753">if</span>&nbsp;<span class="ident" id="5248756">i</span>&nbsp;<span class="op" id="5248758">&lt;</span>&nbsp;<span class="builtinfunc" id="5248760">len</span><span class="op" id="5248763">(</span><span class="ident" id="5248764">sub</span><span class="op" id="5248767">)</span>&nbsp;<span class="op" id="5248769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248774">out</span>&nbsp;<span class="op" id="5248778">=</span>&nbsp;<span class="builtinfunc" id="5248780">append</span><span class="op" id="5248786">(</span><span class="ident" id="5248787">out</span><span class="op" id="5248790">,</span>&nbsp;<span class="ident" id="5248792">sub</span><span class="op" id="5248795">[</span><span class="ident" id="5248796">i</span><span class="op" id="5248797">]</span><span class="op" id="5248798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5248802">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248806">start</span>&nbsp;<span class="op" id="5248812">=</span>&nbsp;<span class="ident" id="5248814">i</span>&nbsp;<span class="op" id="5248816">+</span>&nbsp;<span class="num" id="5248818">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5248821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248824">sub</span>&nbsp;<span class="op" id="5248828">=</span>&nbsp;<span class="ident" id="5248830">out</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5248836">//&nbsp;Round&nbsp;4:&nbsp;Collapse&nbsp;runs&nbsp;of&nbsp;empty&nbsp;matches&nbsp;into&nbsp;a&nbsp;single&nbsp;empty&nbsp;match.</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248907">start</span>&nbsp;<span class="op" id="5248913">=</span>&nbsp;<span class="num" id="5248915">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5248918">out</span>&nbsp;<span class="op" id="5248922">=</span>&nbsp;<span class="ident" id="5248924">sub</span><span class="op" id="5248927">[</span><span class="op" id="5248928">:</span><span class="num" id="5248929">0</span><span class="op" id="5248930">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248933">for</span>&nbsp;<span class="ident" id="5248937">i</span>&nbsp;<span class="op" id="5248939">:=</span>&nbsp;<span class="keyword" id="5248942">range</span>&nbsp;<span class="ident" id="5248948">sub</span>&nbsp;<span class="op" id="5248952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5248956">if</span>&nbsp;<span class="ident" id="5248959">i</span><span class="op" id="5248960">+</span><span class="num" id="5248961">1</span>&nbsp;<span class="op" id="5248963">&lt;</span>&nbsp;<span class="builtinfunc" id="5248965">len</span><span class="op" id="5248968">(</span><span class="ident" id="5248969">sub</span><span class="op" id="5248972">)</span>&nbsp;<span class="op" id="5248974">&amp;&amp;</span>&nbsp;<span class="ident" id="5248977">sub</span><span class="op" id="5248980">[</span><span class="ident" id="5248981">i</span><span class="op" id="5248982">]</span><span class="op" id="5248983">.</span><span class="ident" id="5248984">Op</span>&nbsp;<span class="op" id="5248987">==</span>&nbsp;<span class="ident" id="5248990">OpEmptyMatch</span>&nbsp;<span class="op" id="5249003">&amp;&amp;</span>&nbsp;<span class="ident" id="5249006">sub</span><span class="op" id="5249009">[</span><span class="ident" id="5249010">i</span><span class="op" id="5249011">+</span><span class="num" id="5249012">1</span><span class="op" id="5249013">]</span><span class="op" id="5249014">.</span><span class="ident" id="5249015">Op</span>&nbsp;<span class="op" id="5249018">==</span>&nbsp;<span class="ident" id="5249021">OpEmptyMatch</span>&nbsp;<span class="op" id="5249034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249039">continue</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5249050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249054">out</span>&nbsp;<span class="op" id="5249058">=</span>&nbsp;<span class="builtinfunc" id="5249060">append</span><span class="op" id="5249066">(</span><span class="ident" id="5249067">out</span><span class="op" id="5249070">,</span>&nbsp;<span class="ident" id="5249072">sub</span><span class="op" id="5249075">[</span><span class="ident" id="5249076">i</span><span class="op" id="5249077">]</span><span class="op" id="5249078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5249081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249084">sub</span>&nbsp;<span class="op" id="5249088">=</span>&nbsp;<span class="ident" id="5249090">out</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249096">return</span>&nbsp;<span class="ident" id="5249103">sub</span><br>
<span class="lineno"></span><span class="op" id="5249107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5249110">//&nbsp;leadingString&nbsp;returns&nbsp;the&nbsp;leading&nbsp;literal&nbsp;string&nbsp;that&nbsp;re&nbsp;begins&nbsp;with.</span><br>
<span class="lineno"></span><span class="comment" id="5249183">//&nbsp;The&nbsp;string&nbsp;refers&nbsp;to&nbsp;storage&nbsp;in&nbsp;re&nbsp;or&nbsp;its&nbsp;children.</span><br>
<span class="lineno">585</span><span class="keyword" id="5249238">func</span>&nbsp;<span class="op" id="5249243">(</span><span class="ident" id="5249244">p</span>&nbsp;<span class="op" id="5249246">*</span><span class="ident" id="5249247">parser</span><span class="op" id="5249253">)</span>&nbsp;<span class="ident" id="5249255">leadingString</span><span class="op" id="5249268">(</span><span class="ident" id="5249269">re</span>&nbsp;<span class="op" id="5249272">*</span><span class="ident" id="5249273">Regexp</span><span class="op" id="5249279">)</span>&nbsp;<span class="op" id="5249281">(</span><span class="op" id="5249282">[</span><span class="op" id="5249283">]</span><span class="builtintype" id="5249284">rune</span><span class="op" id="5249288">,</span>&nbsp;<span class="ident" id="5249290">Flags</span><span class="op" id="5249295">)</span>&nbsp;<span class="op" id="5249297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249300">if</span>&nbsp;<span class="ident" id="5249303">re</span><span class="op" id="5249305">.</span><span class="ident" id="5249306">Op</span>&nbsp;<span class="op" id="5249309">==</span>&nbsp;<span class="ident" id="5249312">OpConcat</span>&nbsp;<span class="op" id="5249321">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5249324">len</span><span class="op" id="5249327">(</span><span class="ident" id="5249328">re</span><span class="op" id="5249330">.</span><span class="ident" id="5249331">Sub</span><span class="op" id="5249334">)</span>&nbsp;<span class="op" id="5249336">&gt;</span>&nbsp;<span class="num" id="5249338">0</span>&nbsp;<span class="op" id="5249340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249344">re</span>&nbsp;<span class="op" id="5249347">=</span>&nbsp;<span class="ident" id="5249349">re</span><span class="op" id="5249351">.</span><span class="ident" id="5249352">Sub</span><span class="op" id="5249355">[</span><span class="num" id="5249356">0</span><span class="op" id="5249357">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5249360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249363">if</span>&nbsp;<span class="ident" id="5249366">re</span><span class="op" id="5249368">.</span><span class="ident" id="5249369">Op</span>&nbsp;<span class="op" id="5249372">!=</span>&nbsp;<span class="ident" id="5249375">OpLiteral</span>&nbsp;<span class="op" id="5249385">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249389">return</span>&nbsp;<span class="ident" id="5249396">nil</span><span class="op" id="5249399">,</span>&nbsp;<span class="num" id="5249401">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5249404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249407">return</span>&nbsp;<span class="ident" id="5249414">re</span><span class="op" id="5249416">.</span><span class="ident" id="5249417">Rune</span><span class="op" id="5249421">,</span>&nbsp;<span class="ident" id="5249423">re</span><span class="op" id="5249425">.</span><span class="ident" id="5249426">Flags</span>&nbsp;<span class="op" id="5249432">&amp;</span>&nbsp;<span class="ident" id="5249434">FoldCase</span><br>
<span class="lineno"></span><span class="op" id="5249443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span><span class="comment" id="5249446">//&nbsp;removeLeadingString&nbsp;removes&nbsp;the&nbsp;first&nbsp;n&nbsp;leading&nbsp;runes</span><br>
<span class="lineno"></span><span class="comment" id="5249503">//&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;re.&nbsp;&nbsp;It&nbsp;returns&nbsp;the&nbsp;replacement&nbsp;for&nbsp;re.</span><br>
<span class="lineno"></span><span class="keyword" id="5249568">func</span>&nbsp;<span class="op" id="5249573">(</span><span class="ident" id="5249574">p</span>&nbsp;<span class="op" id="5249576">*</span><span class="ident" id="5249577">parser</span><span class="op" id="5249583">)</span>&nbsp;<span class="ident" id="5249585">removeLeadingString</span><span class="op" id="5249604">(</span><span class="ident" id="5249605">re</span>&nbsp;<span class="op" id="5249608">*</span><span class="ident" id="5249609">Regexp</span><span class="op" id="5249615">,</span>&nbsp;<span class="ident" id="5249617">n</span>&nbsp;<span class="builtintype" id="5249619">int</span><span class="op" id="5249622">)</span>&nbsp;<span class="op" id="5249624">*</span><span class="ident" id="5249625">Regexp</span>&nbsp;<span class="op" id="5249632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249635">if</span>&nbsp;<span class="ident" id="5249638">re</span><span class="op" id="5249640">.</span><span class="ident" id="5249641">Op</span>&nbsp;<span class="op" id="5249644">==</span>&nbsp;<span class="ident" id="5249647">OpConcat</span>&nbsp;<span class="op" id="5249656">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5249659">len</span><span class="op" id="5249662">(</span><span class="ident" id="5249663">re</span><span class="op" id="5249665">.</span><span class="ident" id="5249666">Sub</span><span class="op" id="5249669">)</span>&nbsp;<span class="op" id="5249671">&gt;</span>&nbsp;<span class="num" id="5249673">0</span>&nbsp;<span class="op" id="5249675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5249679">//&nbsp;Removing&nbsp;a&nbsp;leading&nbsp;string&nbsp;in&nbsp;a&nbsp;concatenation</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5249729">//&nbsp;might&nbsp;simplify&nbsp;the&nbsp;concatenation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249768">sub</span>&nbsp;<span class="op" id="5249772">:=</span>&nbsp;<span class="ident" id="5249775">re</span><span class="op" id="5249777">.</span><span class="ident" id="5249778">Sub</span><span class="op" id="5249781">[</span><span class="num" id="5249782">0</span><span class="op" id="5249783">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249787">sub</span>&nbsp;<span class="op" id="5249791">=</span>&nbsp;<span class="ident" id="5249793">p</span><span class="op" id="5249794">.</span><span class="ident" id="5249795">removeLeadingString</span><span class="op" id="5249814">(</span><span class="ident" id="5249815">sub</span><span class="op" id="5249818">,</span>&nbsp;<span class="ident" id="5249820">n</span><span class="op" id="5249821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249825">re</span><span class="op" id="5249827">.</span><span class="ident" id="5249828">Sub</span><span class="op" id="5249831">[</span><span class="num" id="5249832">0</span><span class="op" id="5249833">]</span>&nbsp;<span class="op" id="5249835">=</span>&nbsp;<span class="ident" id="5249837">sub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249843">if</span>&nbsp;<span class="ident" id="5249846">sub</span><span class="op" id="5249849">.</span><span class="ident" id="5249850">Op</span>&nbsp;<span class="op" id="5249853">==</span>&nbsp;<span class="ident" id="5249856">OpEmptyMatch</span>&nbsp;<span class="op" id="5249869">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249874">p</span><span class="op" id="5249875">.</span><span class="ident" id="5249876">reuse</span><span class="op" id="5249881">(</span><span class="ident" id="5249882">sub</span><span class="op" id="5249885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249890">switch</span>&nbsp;<span class="builtinfunc" id="5249897">len</span><span class="op" id="5249900">(</span><span class="ident" id="5249901">re</span><span class="op" id="5249903">.</span><span class="ident" id="5249904">Sub</span><span class="op" id="5249907">)</span>&nbsp;<span class="op" id="5249909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5249914">case</span>&nbsp;<span class="num" id="5249919">0</span><span class="op" id="5249920">,</span>&nbsp;<span class="num" id="5249922">1</span><span class="op" id="5249923">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5249929">//&nbsp;Impossible&nbsp;but&nbsp;handle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249959">re</span><span class="op" id="5249961">.</span><span class="ident" id="5249962">Op</span>&nbsp;<span class="op" id="5249965">=</span>&nbsp;<span class="ident" id="5249967">OpEmptyMatch</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5249984">re</span><span class="op" id="5249986">.</span><span class="ident" id="5249987">Sub</span>&nbsp;<span class="op" id="5249991">=</span>&nbsp;<span class="ident" id="5249993">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250000">case</span>&nbsp;<span class="num" id="5250005">2</span><span class="op" id="5250006">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5250012">old</span>&nbsp;<span class="op" id="5250016">:=</span>&nbsp;<span class="ident" id="5250019">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5250026">re</span>&nbsp;<span class="op" id="5250029">=</span>&nbsp;<span class="ident" id="5250031">re</span><span class="op" id="5250033">.</span><span class="ident" id="5250034">Sub</span><span class="op" id="5250037">[</span><span class="num" id="5250038">1</span><span class="op" id="5250039">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5250045">p</span><span class="op" id="5250046">.</span><span class="ident" id="5250047">reuse</span><span class="op" id="5250052">(</span><span class="ident" id="5250053">old</span><span class="op" id="5250056">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250061">default</span><span class="op" id="5250068">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5250074">copy</span><span class="op" id="5250078">(</span><span class="ident" id="5250079">re</span><span class="op" id="5250081">.</span><span class="ident" id="5250082">Sub</span><span class="op" id="5250085">,</span>&nbsp;<span class="ident" id="5250087">re</span><span class="op" id="5250089">.</span><span class="ident" id="5250090">Sub</span><span class="op" id="5250093">[</span><span class="num" id="5250094">1</span><span class="op" id="5250095">:</span><span class="op" id="5250096">]</span><span class="op" id="5250097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5250103">re</span><span class="op" id="5250105">.</span><span class="ident" id="5250106">Sub</span>&nbsp;<span class="op" id="5250110">=</span>&nbsp;<span class="ident" id="5250112">re</span><span class="op" id="5250114">.</span><span class="ident" id="5250115">Sub</span><span class="op" id="5250118">[</span><span class="op" id="5250119">:</span><span class="builtinfunc" id="5250120">len</span><span class="op" id="5250123">(</span><span class="ident" id="5250124">re</span><span class="op" id="5250126">.</span><span class="ident" id="5250127">Sub</span><span class="op" id="5250130">)</span><span class="op" id="5250131">-</span><span class="num" id="5250132">1</span><span class="op" id="5250133">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5250138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5250142">}</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250146">return</span>&nbsp;<span class="ident" id="5250153">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5250157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250161">if</span>&nbsp;<span class="ident" id="5250164">re</span><span class="op" id="5250166">.</span><span class="ident" id="5250167">Op</span>&nbsp;<span class="op" id="5250170">==</span>&nbsp;<span class="ident" id="5250173">OpLiteral</span>&nbsp;<span class="op" id="5250183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5250187">re</span><span class="op" id="5250189">.</span><span class="ident" id="5250190">Rune</span>&nbsp;<span class="op" id="5250195">=</span>&nbsp;<span class="ident" id="5250197">re</span><span class="op" id="5250199">.</span><span class="ident" id="5250200">Rune</span><span class="op" id="5250204">[</span><span class="op" id="5250205">:</span><span class="builtinfunc" id="5250206">copy</span><span class="op" id="5250210">(</span><span class="ident" id="5250211">re</span><span class="op" id="5250213">.</span><span class="ident" id="5250214">Rune</span><span class="op" id="5250218">,</span>&nbsp;<span class="ident" id="5250220">re</span><span class="op" id="5250222">.</span><span class="ident" id="5250223">Rune</span><span class="op" id="5250227">[</span><span class="ident" id="5250228">n</span><span class="op" id="5250229">:</span><span class="op" id="5250230">]</span><span class="op" id="5250231">)</span><span class="op" id="5250232">]</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250236">if</span>&nbsp;<span class="builtinfunc" id="5250239">len</span><span class="op" id="5250242">(</span><span class="ident" id="5250243">re</span><span class="op" id="5250245">.</span><span class="ident" id="5250246">Rune</span><span class="op" id="5250250">)</span>&nbsp;<span class="op" id="5250252">==</span>&nbsp;<span class="num" id="5250255">0</span>&nbsp;<span class="op" id="5250257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5250262">re</span><span class="op" id="5250264">.</span><span class="ident" id="5250265">Op</span>&nbsp;<span class="op" id="5250268">=</span>&nbsp;<span class="ident" id="5250270">OpEmptyMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5250285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5250288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250291">return</span>&nbsp;<span class="ident" id="5250298">re</span><br>
<span class="lineno">630</span><span class="op" id="5250301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5250304">//&nbsp;leadingRegexp&nbsp;returns&nbsp;the&nbsp;leading&nbsp;regexp&nbsp;that&nbsp;re&nbsp;begins&nbsp;with.</span><br>
<span class="lineno"></span><span class="comment" id="5250369">//&nbsp;The&nbsp;regexp&nbsp;refers&nbsp;to&nbsp;storage&nbsp;in&nbsp;re&nbsp;or&nbsp;its&nbsp;children.</span><br>
<span class="lineno"></span><span class="keyword" id="5250424">func</span>&nbsp;<span class="op" id="5250429">(</span><span class="ident" id="5250430">p</span>&nbsp;<span class="op" id="5250432">*</span><span class="ident" id="5250433">parser</span><span class="op" id="5250439">)</span>&nbsp;<span class="ident" id="5250441">leadingRegexp</span><span class="op" id="5250454">(</span><span class="ident" id="5250455">re</span>&nbsp;<span class="op" id="5250458">*</span><span class="ident" id="5250459">Regexp</span><span class="op" id="5250465">)</span>&nbsp;<span class="op" id="5250467">*</span><span class="ident" id="5250468">Regexp</span>&nbsp;<span class="op" id="5250475">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250478">if</span>&nbsp;<span class="ident" id="5250481">re</span><span class="op" id="5250483">.</span><span class="ident" id="5250484">Op</span>&nbsp;<span class="op" id="5250487">==</span>&nbsp;<span class="ident" id="5250490">OpEmptyMatch</span>&nbsp;<span class="op" id="5250503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250507">return</span>&nbsp;<span class="ident" id="5250514">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5250519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250522">if</span>&nbsp;<span class="ident" id="5250525">re</span><span class="op" id="5250527">.</span><span class="ident" id="5250528">Op</span>&nbsp;<span class="op" id="5250531">==</span>&nbsp;<span class="ident" id="5250534">OpConcat</span>&nbsp;<span class="op" id="5250543">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5250546">len</span><span class="op" id="5250549">(</span><span class="ident" id="5250550">re</span><span class="op" id="5250552">.</span><span class="ident" id="5250553">Sub</span><span class="op" id="5250556">)</span>&nbsp;<span class="op" id="5250558">&gt;</span>&nbsp;<span class="num" id="5250560">0</span>&nbsp;<span class="op" id="5250562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5250566">sub</span>&nbsp;<span class="op" id="5250570">:=</span>&nbsp;<span class="ident" id="5250573">re</span><span class="op" id="5250575">.</span><span class="ident" id="5250576">Sub</span><span class="op" id="5250579">[</span><span class="num" id="5250580">0</span><span class="op" id="5250581">]</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250585">if</span>&nbsp;<span class="ident" id="5250588">sub</span><span class="op" id="5250591">.</span><span class="ident" id="5250592">Op</span>&nbsp;<span class="op" id="5250595">==</span>&nbsp;<span class="ident" id="5250598">OpEmptyMatch</span>&nbsp;<span class="op" id="5250611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250616">return</span>&nbsp;<span class="ident" id="5250623">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5250629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250633">return</span>&nbsp;<span class="ident" id="5250640">sub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5250645">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250648">return</span>&nbsp;<span class="ident" id="5250655">re</span><br>
<span class="lineno"></span><span class="op" id="5250658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5250661">//&nbsp;removeLeadingRegexp&nbsp;removes&nbsp;the&nbsp;leading&nbsp;regexp&nbsp;in&nbsp;re.</span><br>
<span class="lineno"></span><span class="comment" id="5250718">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;replacement&nbsp;for&nbsp;re.</span><br>
<span class="lineno">650</span><span class="comment" id="5250756">//&nbsp;If&nbsp;reuse&nbsp;is&nbsp;true,&nbsp;it&nbsp;passes&nbsp;the&nbsp;removed&nbsp;regexp&nbsp;(if&nbsp;no&nbsp;longer&nbsp;needed)&nbsp;to&nbsp;p.reuse.</span><br>
<span class="lineno"></span><span class="keyword" id="5250840">func</span>&nbsp;<span class="op" id="5250845">(</span><span class="ident" id="5250846">p</span>&nbsp;<span class="op" id="5250848">*</span><span class="ident" id="5250849">parser</span><span class="op" id="5250855">)</span>&nbsp;<span class="ident" id="5250857">removeLeadingRegexp</span><span class="op" id="5250876">(</span><span class="ident" id="5250877">re</span>&nbsp;<span class="op" id="5250880">*</span><span class="ident" id="5250881">Regexp</span><span class="op" id="5250887">,</span>&nbsp;<span class="ident" id="5250889">reuse</span>&nbsp;<span class="builtintype" id="5250895">bool</span><span class="op" id="5250899">)</span>&nbsp;<span class="op" id="5250901">*</span><span class="ident" id="5250902">Regexp</span>&nbsp;<span class="op" id="5250909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250912">if</span>&nbsp;<span class="ident" id="5250915">re</span><span class="op" id="5250917">.</span><span class="ident" id="5250918">Op</span>&nbsp;<span class="op" id="5250921">==</span>&nbsp;<span class="ident" id="5250924">OpConcat</span>&nbsp;<span class="op" id="5250933">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5250936">len</span><span class="op" id="5250939">(</span><span class="ident" id="5250940">re</span><span class="op" id="5250942">.</span><span class="ident" id="5250943">Sub</span><span class="op" id="5250946">)</span>&nbsp;<span class="op" id="5250948">&gt;</span>&nbsp;<span class="num" id="5250950">0</span>&nbsp;<span class="op" id="5250952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5250956">if</span>&nbsp;<span class="ident" id="5250959">reuse</span>&nbsp;<span class="op" id="5250965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5250970">p</span><span class="op" id="5250971">.</span><span class="ident" id="5250972">reuse</span><span class="op" id="5250977">(</span><span class="ident" id="5250978">re</span><span class="op" id="5250980">.</span><span class="ident" id="5250981">Sub</span><span class="op" id="5250984">[</span><span class="num" id="5250985">0</span><span class="op" id="5250986">]</span><span class="op" id="5250987">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5250991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5250995">re</span><span class="op" id="5250997">.</span><span class="ident" id="5250998">Sub</span>&nbsp;<span class="op" id="5251002">=</span>&nbsp;<span class="ident" id="5251004">re</span><span class="op" id="5251006">.</span><span class="ident" id="5251007">Sub</span><span class="op" id="5251010">[</span><span class="op" id="5251011">:</span><span class="builtinfunc" id="5251012">copy</span><span class="op" id="5251016">(</span><span class="ident" id="5251017">re</span><span class="op" id="5251019">.</span><span class="ident" id="5251020">Sub</span><span class="op" id="5251023">,</span>&nbsp;<span class="ident" id="5251025">re</span><span class="op" id="5251027">.</span><span class="ident" id="5251028">Sub</span><span class="op" id="5251031">[</span><span class="num" id="5251032">1</span><span class="op" id="5251033">:</span><span class="op" id="5251034">]</span><span class="op" id="5251035">)</span><span class="op" id="5251036">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251040">switch</span>&nbsp;<span class="builtinfunc" id="5251047">len</span><span class="op" id="5251050">(</span><span class="ident" id="5251051">re</span><span class="op" id="5251053">.</span><span class="ident" id="5251054">Sub</span><span class="op" id="5251057">)</span>&nbsp;<span class="op" id="5251059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251063">case</span>&nbsp;<span class="num" id="5251068">0</span><span class="op" id="5251069">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5251074">re</span><span class="op" id="5251076">.</span><span class="ident" id="5251077">Op</span>&nbsp;<span class="op" id="5251080">=</span>&nbsp;<span class="ident" id="5251082">OpEmptyMatch</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5251098">re</span><span class="op" id="5251100">.</span><span class="ident" id="5251101">Sub</span>&nbsp;<span class="op" id="5251105">=</span>&nbsp;<span class="ident" id="5251107">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251113">case</span>&nbsp;<span class="num" id="5251118">1</span><span class="op" id="5251119">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5251124">old</span>&nbsp;<span class="op" id="5251128">:=</span>&nbsp;<span class="ident" id="5251131">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5251137">re</span>&nbsp;<span class="op" id="5251140">=</span>&nbsp;<span class="ident" id="5251142">re</span><span class="op" id="5251144">.</span><span class="ident" id="5251145">Sub</span><span class="op" id="5251148">[</span><span class="num" id="5251149">0</span><span class="op" id="5251150">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5251155">p</span><span class="op" id="5251156">.</span><span class="ident" id="5251157">reuse</span><span class="op" id="5251162">(</span><span class="ident" id="5251163">old</span><span class="op" id="5251166">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5251170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251174">return</span>&nbsp;<span class="ident" id="5251181">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5251185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251188">if</span>&nbsp;<span class="ident" id="5251191">reuse</span>&nbsp;<span class="op" id="5251197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5251201">p</span><span class="op" id="5251202">.</span><span class="ident" id="5251203">reuse</span><span class="op" id="5251208">(</span><span class="ident" id="5251209">re</span><span class="op" id="5251211">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5251214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251217">return</span>&nbsp;<span class="ident" id="5251224">p</span><span class="op" id="5251225">.</span><span class="ident" id="5251226">newRegexp</span><span class="op" id="5251235">(</span><span class="ident" id="5251236">OpEmptyMatch</span><span class="op" id="5251248">)</span><br>
<span class="lineno"></span><span class="op" id="5251250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5251253">func</span>&nbsp;<span class="ident" id="5251258">literalRegexp</span><span class="op" id="5251271">(</span><span class="ident" id="5251272">s</span>&nbsp;<span class="builtintype" id="5251274">string</span><span class="op" id="5251280">,</span>&nbsp;<span class="ident" id="5251282">flags</span>&nbsp;<span class="ident" id="5251288">Flags</span><span class="op" id="5251293">)</span>&nbsp;<span class="op" id="5251295">*</span><span class="ident" id="5251296">Regexp</span>&nbsp;<span class="op" id="5251303">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5251306">re</span>&nbsp;<span class="op" id="5251309">:=</span>&nbsp;<span class="op" id="5251312">&amp;</span><span class="ident" id="5251313">Regexp</span><span class="op" id="5251319">{</span><span class="ident" id="5251320">Op</span><span class="op" id="5251322">:</span>&nbsp;<span class="ident" id="5251324">OpLiteral</span><span class="op" id="5251333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5251336">re</span><span class="op" id="5251338">.</span><span class="ident" id="5251339">Flags</span>&nbsp;<span class="op" id="5251345">=</span>&nbsp;<span class="ident" id="5251347">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5251354">re</span><span class="op" id="5251356">.</span><span class="ident" id="5251357">Rune</span>&nbsp;<span class="op" id="5251362">=</span>&nbsp;<span class="ident" id="5251364">re</span><span class="op" id="5251366">.</span><span class="ident" id="5251367">Rune0</span><span class="op" id="5251372">[</span><span class="op" id="5251373">:</span><span class="num" id="5251374">0</span><span class="op" id="5251375">]</span>&nbsp;<span class="comment" id="5251377">//&nbsp;use&nbsp;local&nbsp;storage&nbsp;for&nbsp;small&nbsp;strings</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251417">for</span>&nbsp;<span class="ident" id="5251421">_</span><span class="op" id="5251422">,</span>&nbsp;<span class="ident" id="5251424">c</span>&nbsp;<span class="op" id="5251426">:=</span>&nbsp;<span class="keyword" id="5251429">range</span>&nbsp;<span class="ident" id="5251435">s</span>&nbsp;<span class="op" id="5251437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251441">if</span>&nbsp;<span class="builtinfunc" id="5251444">len</span><span class="op" id="5251447">(</span><span class="ident" id="5251448">re</span><span class="op" id="5251450">.</span><span class="ident" id="5251451">Rune</span><span class="op" id="5251455">)</span>&nbsp;<span class="op" id="5251457">&gt;=</span>&nbsp;<span class="builtinfunc" id="5251460">cap</span><span class="op" id="5251463">(</span><span class="ident" id="5251464">re</span><span class="op" id="5251466">.</span><span class="ident" id="5251467">Rune</span><span class="op" id="5251471">)</span>&nbsp;<span class="op" id="5251473">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5251478">//&nbsp;string&nbsp;is&nbsp;too&nbsp;long&nbsp;to&nbsp;fit&nbsp;in&nbsp;Rune0.&nbsp;&nbsp;let&nbsp;Go&nbsp;handle&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5251538">re</span><span class="op" id="5251540">.</span><span class="ident" id="5251541">Rune</span>&nbsp;<span class="op" id="5251546">=</span>&nbsp;<span class="op" id="5251548">[</span><span class="op" id="5251549">]</span><span class="builtintype" id="5251550">rune</span><span class="op" id="5251554">(</span><span class="ident" id="5251555">s</span><span class="op" id="5251556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251561">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5251569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5251573">re</span><span class="op" id="5251575">.</span><span class="ident" id="5251576">Rune</span>&nbsp;<span class="op" id="5251581">=</span>&nbsp;<span class="builtinfunc" id="5251583">append</span><span class="op" id="5251589">(</span><span class="ident" id="5251590">re</span><span class="op" id="5251592">.</span><span class="ident" id="5251593">Rune</span><span class="op" id="5251597">,</span>&nbsp;<span class="ident" id="5251599">c</span><span class="op" id="5251600">)</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5251603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251606">return</span>&nbsp;<span class="ident" id="5251613">re</span><br>
<span class="lineno"></span><span class="op" id="5251616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5251619">//&nbsp;Parsing.</span><br>
<span class="lineno">690</span><br>
<span class="lineno"></span><span class="comment" id="5251632">//&nbsp;Parse&nbsp;parses&nbsp;a&nbsp;regular&nbsp;expression&nbsp;string&nbsp;s,&nbsp;controlled&nbsp;by&nbsp;the&nbsp;specified</span><br>
<span class="lineno"></span><span class="comment" id="5251707">//&nbsp;Flags,&nbsp;and&nbsp;returns&nbsp;a&nbsp;regular&nbsp;expression&nbsp;parse&nbsp;tree.&nbsp;The&nbsp;syntax&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5251776">//&nbsp;described&nbsp;in&nbsp;the&nbsp;top-level&nbsp;comment.</span><br>
<span class="lineno"></span><span class="keyword" id="5251815">func</span>&nbsp;<span class="ident" id="5251820">Parse</span><span class="op" id="5251825">(</span><span class="ident" id="5251826">s</span>&nbsp;<span class="builtintype" id="5251828">string</span><span class="op" id="5251834">,</span>&nbsp;<span class="ident" id="5251836">flags</span>&nbsp;<span class="ident" id="5251842">Flags</span><span class="op" id="5251847">)</span>&nbsp;<span class="op" id="5251849">(</span><span class="op" id="5251850">*</span><span class="ident" id="5251851">Regexp</span><span class="op" id="5251857">,</span>&nbsp;<span class="builtintype" id="5251859">error</span><span class="op" id="5251864">)</span>&nbsp;<span class="op" id="5251866">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251869">if</span>&nbsp;<span class="ident" id="5251872">flags</span><span class="op" id="5251877">&amp;</span><span class="ident" id="5251878">Literal</span>&nbsp;<span class="op" id="5251886">!=</span>&nbsp;<span class="num" id="5251889">0</span>&nbsp;<span class="op" id="5251891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5251895">//&nbsp;Trivial&nbsp;parser&nbsp;for&nbsp;literal&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251935">if</span>&nbsp;<span class="ident" id="5251938">err</span>&nbsp;<span class="op" id="5251942">:=</span>&nbsp;<span class="ident" id="5251945">checkUTF8</span><span class="op" id="5251954">(</span><span class="ident" id="5251955">s</span><span class="op" id="5251956">)</span><span class="op" id="5251957">;</span>&nbsp;<span class="ident" id="5251959">err</span>&nbsp;<span class="op" id="5251963">!=</span>&nbsp;<span class="ident" id="5251966">nil</span>&nbsp;<span class="op" id="5251970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251975">return</span>&nbsp;<span class="ident" id="5251982">nil</span><span class="op" id="5251985">,</span>&nbsp;<span class="ident" id="5251987">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5251993">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5251997">return</span>&nbsp;<span class="ident" id="5252004">literalRegexp</span><span class="op" id="5252017">(</span><span class="ident" id="5252018">s</span><span class="op" id="5252019">,</span>&nbsp;<span class="ident" id="5252021">flags</span><span class="op" id="5252026">)</span><span class="op" id="5252027">,</span>&nbsp;<span class="ident" id="5252029">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5252034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5252038">//&nbsp;Otherwise,&nbsp;must&nbsp;do&nbsp;real&nbsp;work.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252072">var</span>&nbsp;<span class="op" id="5252076">(</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252080">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5252091">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252100">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5252111">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252119">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5252130">rune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252137">op</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5252148">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252153">lastRepeat</span>&nbsp;<span class="builtintype" id="5252164">string</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5252172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252175">p</span><span class="op" id="5252176">.</span><span class="ident" id="5252177">flags</span>&nbsp;<span class="op" id="5252183">=</span>&nbsp;<span class="ident" id="5252185">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252192">p</span><span class="op" id="5252193">.</span><span class="ident" id="5252194">wholeRegexp</span>&nbsp;<span class="op" id="5252206">=</span>&nbsp;<span class="ident" id="5252208">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252211">t</span>&nbsp;<span class="op" id="5252213">:=</span>&nbsp;<span class="ident" id="5252216">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252219">for</span>&nbsp;<span class="ident" id="5252223">t</span>&nbsp;<span class="op" id="5252225">!=</span>&nbsp;<span class="string" id="5252228">&#34;&#34;</span>&nbsp;<span class="op" id="5252231">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252235">repeat</span>&nbsp;<span class="op" id="5252242">:=</span>&nbsp;<span class="string" id="5252245">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252249">BigSwitch</span><span class="op" id="5252258">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252262">switch</span>&nbsp;<span class="ident" id="5252269">t</span><span class="op" id="5252270">[</span><span class="num" id="5252271">0</span><span class="op" id="5252272">]</span>&nbsp;<span class="op" id="5252274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252278">default</span><span class="op" id="5252285">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252290">if</span>&nbsp;<span class="ident" id="5252293">c</span><span class="op" id="5252294">,</span>&nbsp;<span class="ident" id="5252296">t</span><span class="op" id="5252297">,</span>&nbsp;<span class="ident" id="5252299">err</span>&nbsp;<span class="op" id="5252303">=</span>&nbsp;<span class="ident" id="5252305">nextRune</span><span class="op" id="5252313">(</span><span class="ident" id="5252314">t</span><span class="op" id="5252315">)</span><span class="op" id="5252316">;</span>&nbsp;<span class="ident" id="5252318">err</span>&nbsp;<span class="op" id="5252322">!=</span>&nbsp;<span class="ident" id="5252325">nil</span>&nbsp;<span class="op" id="5252329">{</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252335">return</span>&nbsp;<span class="ident" id="5252342">nil</span><span class="op" id="5252345">,</span>&nbsp;<span class="ident" id="5252347">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5252354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252359">p</span><span class="op" id="5252360">.</span><span class="ident" id="5252361">literal</span><span class="op" id="5252368">(</span><span class="ident" id="5252369">c</span><span class="op" id="5252370">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252375">case</span>&nbsp;<span class="string" id="5252380">&#39;(&#39;</span><span class="op" id="5252383">:</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252388">if</span>&nbsp;<span class="ident" id="5252391">p</span><span class="op" id="5252392">.</span><span class="ident" id="5252393">flags</span><span class="op" id="5252398">&amp;</span><span class="ident" id="5252399">PerlX</span>&nbsp;<span class="op" id="5252405">!=</span>&nbsp;<span class="num" id="5252408">0</span>&nbsp;<span class="op" id="5252410">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5252413">len</span><span class="op" id="5252416">(</span><span class="ident" id="5252417">t</span><span class="op" id="5252418">)</span>&nbsp;<span class="op" id="5252420">&gt;=</span>&nbsp;<span class="num" id="5252423">2</span>&nbsp;<span class="op" id="5252425">&amp;&amp;</span>&nbsp;<span class="ident" id="5252428">t</span><span class="op" id="5252429">[</span><span class="num" id="5252430">1</span><span class="op" id="5252431">]</span>&nbsp;<span class="op" id="5252433">==</span>&nbsp;<span class="string" id="5252436">&#39;?&#39;</span>&nbsp;<span class="op" id="5252440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5252446">//&nbsp;Flag&nbsp;changes&nbsp;and&nbsp;non-capturing&nbsp;groups.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252492">if</span>&nbsp;<span class="ident" id="5252495">t</span><span class="op" id="5252496">,</span>&nbsp;<span class="ident" id="5252498">err</span>&nbsp;<span class="op" id="5252502">=</span>&nbsp;<span class="ident" id="5252504">p</span><span class="op" id="5252505">.</span><span class="ident" id="5252506">parsePerlFlags</span><span class="op" id="5252520">(</span><span class="ident" id="5252521">t</span><span class="op" id="5252522">)</span><span class="op" id="5252523">;</span>&nbsp;<span class="ident" id="5252525">err</span>&nbsp;<span class="op" id="5252529">!=</span>&nbsp;<span class="ident" id="5252532">nil</span>&nbsp;<span class="op" id="5252536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252543">return</span>&nbsp;<span class="ident" id="5252550">nil</span><span class="op" id="5252553">,</span>&nbsp;<span class="ident" id="5252555">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5252563">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252569">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5252578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252583">p</span><span class="op" id="5252584">.</span><span class="ident" id="5252585">numCap</span><span class="op" id="5252591">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252597">p</span><span class="op" id="5252598">.</span><span class="ident" id="5252599">op</span><span class="op" id="5252601">(</span><span class="ident" id="5252602">opLeftParen</span><span class="op" id="5252613">)</span><span class="op" id="5252614">.</span><span class="ident" id="5252615">Cap</span>&nbsp;<span class="op" id="5252619">=</span>&nbsp;<span class="ident" id="5252621">p</span><span class="op" id="5252622">.</span><span class="ident" id="5252623">numCap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252633">t</span>&nbsp;<span class="op" id="5252635">=</span>&nbsp;<span class="ident" id="5252637">t</span><span class="op" id="5252638">[</span><span class="num" id="5252639">1</span><span class="op" id="5252640">:</span><span class="op" id="5252641">]</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252645">case</span>&nbsp;<span class="string" id="5252650">&#39;|&#39;</span><span class="op" id="5252653">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252658">if</span>&nbsp;<span class="ident" id="5252661">err</span>&nbsp;<span class="op" id="5252665">=</span>&nbsp;<span class="ident" id="5252667">p</span><span class="op" id="5252668">.</span><span class="ident" id="5252669">parseVerticalBar</span><span class="op" id="5252685">(</span><span class="op" id="5252686">)</span><span class="op" id="5252687">;</span>&nbsp;<span class="ident" id="5252689">err</span>&nbsp;<span class="op" id="5252693">!=</span>&nbsp;<span class="ident" id="5252696">nil</span>&nbsp;<span class="op" id="5252700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252706">return</span>&nbsp;<span class="ident" id="5252713">nil</span><span class="op" id="5252716">,</span>&nbsp;<span class="ident" id="5252718">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5252725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252730">t</span>&nbsp;<span class="op" id="5252732">=</span>&nbsp;<span class="ident" id="5252734">t</span><span class="op" id="5252735">[</span><span class="num" id="5252736">1</span><span class="op" id="5252737">:</span><span class="op" id="5252738">]</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252742">case</span>&nbsp;<span class="string" id="5252747">&#39;)&#39;</span><span class="op" id="5252750">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252755">if</span>&nbsp;<span class="ident" id="5252758">err</span>&nbsp;<span class="op" id="5252762">=</span>&nbsp;<span class="ident" id="5252764">p</span><span class="op" id="5252765">.</span><span class="ident" id="5252766">parseRightParen</span><span class="op" id="5252781">(</span><span class="op" id="5252782">)</span><span class="op" id="5252783">;</span>&nbsp;<span class="ident" id="5252785">err</span>&nbsp;<span class="op" id="5252789">!=</span>&nbsp;<span class="ident" id="5252792">nil</span>&nbsp;<span class="op" id="5252796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252802">return</span>&nbsp;<span class="ident" id="5252809">nil</span><span class="op" id="5252812">,</span>&nbsp;<span class="ident" id="5252814">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5252821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252826">t</span>&nbsp;<span class="op" id="5252828">=</span>&nbsp;<span class="ident" id="5252830">t</span><span class="op" id="5252831">[</span><span class="num" id="5252832">1</span><span class="op" id="5252833">:</span><span class="op" id="5252834">]</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252838">case</span>&nbsp;<span class="string" id="5252843">&#39;^&#39;</span><span class="op" id="5252846">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252851">if</span>&nbsp;<span class="ident" id="5252854">p</span><span class="op" id="5252855">.</span><span class="ident" id="5252856">flags</span><span class="op" id="5252861">&amp;</span><span class="ident" id="5252862">OneLine</span>&nbsp;<span class="op" id="5252870">!=</span>&nbsp;<span class="num" id="5252873">0</span>&nbsp;<span class="op" id="5252875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252881">p</span><span class="op" id="5252882">.</span><span class="ident" id="5252883">op</span><span class="op" id="5252885">(</span><span class="ident" id="5252886">OpBeginText</span><span class="op" id="5252897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5252902">}</span>&nbsp;<span class="keyword" id="5252904">else</span>&nbsp;<span class="op" id="5252909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252915">p</span><span class="op" id="5252916">.</span><span class="ident" id="5252917">op</span><span class="op" id="5252919">(</span><span class="ident" id="5252920">OpBeginLine</span><span class="op" id="5252931">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5252936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252941">t</span>&nbsp;<span class="op" id="5252943">=</span>&nbsp;<span class="ident" id="5252945">t</span><span class="op" id="5252946">[</span><span class="num" id="5252947">1</span><span class="op" id="5252948">:</span><span class="op" id="5252949">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252953">case</span>&nbsp;<span class="string" id="5252958">&#39;$&#39;</span><span class="op" id="5252961">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5252966">if</span>&nbsp;<span class="ident" id="5252969">p</span><span class="op" id="5252970">.</span><span class="ident" id="5252971">flags</span><span class="op" id="5252976">&amp;</span><span class="ident" id="5252977">OneLine</span>&nbsp;<span class="op" id="5252985">!=</span>&nbsp;<span class="num" id="5252988">0</span>&nbsp;<span class="op" id="5252990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5252996">p</span><span class="op" id="5252997">.</span><span class="ident" id="5252998">op</span><span class="op" id="5253000">(</span><span class="ident" id="5253001">OpEndText</span><span class="op" id="5253010">)</span><span class="op" id="5253011">.</span><span class="ident" id="5253012">Flags</span>&nbsp;<span class="op" id="5253018">|=</span>&nbsp;<span class="ident" id="5253021">WasDollar</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5253034">}</span>&nbsp;<span class="keyword" id="5253036">else</span>&nbsp;<span class="op" id="5253041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5253047">p</span><span class="op" id="5253048">.</span><span class="ident" id="5253049">op</span><span class="op" id="5253051">(</span><span class="ident" id="5253052">OpEndLine</span><span class="op" id="5253061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5253066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5253071">t</span>&nbsp;<span class="op" id="5253073">=</span>&nbsp;<span class="ident" id="5253075">t</span><span class="op" id="5253076">[</span><span class="num" id="5253077">1</span><span class="op" id="5253078">:</span><span class="op" id="5253079">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253083">case</span>&nbsp;<span class="string" id="5253088">&#39;.&#39;</span><span class="op" id="5253091">:</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253096">if</span>&nbsp;<span class="ident" id="5253099">p</span><span class="op" id="5253100">.</span><span class="ident" id="5253101">flags</span><span class="op" id="5253106">&amp;</span><span class="ident" id="5253107">DotNL</span>&nbsp;<span class="op" id="5253113">!=</span>&nbsp;<span class="num" id="5253116">0</span>&nbsp;<span class="op" id="5253118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5253124">p</span><span class="op" id="5253125">.</span><span class="ident" id="5253126">op</span><span class="op" id="5253128">(</span><span class="ident" id="5253129">OpAnyChar</span><span class="op" id="5253138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5253143">}</span>&nbsp;<span class="keyword" id="5253145">else</span>&nbsp;<span class="op" id="5253150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5253156">p</span><span class="op" id="5253157">.</span><span class="ident" id="5253158">op</span><span class="op" id="5253160">(</span><span class="ident" id="5253161">OpAnyCharNotNL</span><span class="op" id="5253175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5253180">}</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5253185">t</span>&nbsp;<span class="op" id="5253187">=</span>&nbsp;<span class="ident" id="5253189">t</span><span class="op" id="5253190">[</span><span class="num" id="5253191">1</span><span class="op" id="5253192">:</span><span class="op" id="5253193">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253197">case</span>&nbsp;<span class="string" id="5253202">&#39;[&#39;</span><span class="op" id="5253205">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253210">if</span>&nbsp;<span class="ident" id="5253213">t</span><span class="op" id="5253214">,</span>&nbsp;<span class="ident" id="5253216">err</span>&nbsp;<span class="op" id="5253220">=</span>&nbsp;<span class="ident" id="5253222">p</span><span class="op" id="5253223">.</span><span class="ident" id="5253224">parseClass</span><span class="op" id="5253234">(</span><span class="ident" id="5253235">t</span><span class="op" id="5253236">)</span><span class="op" id="5253237">;</span>&nbsp;<span class="ident" id="5253239">err</span>&nbsp;<span class="op" id="5253243">!=</span>&nbsp;<span class="ident" id="5253246">nil</span>&nbsp;<span class="op" id="5253250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253256">return</span>&nbsp;<span class="ident" id="5253263">nil</span><span class="op" id="5253266">,</span>&nbsp;<span class="ident" id="5253268">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5253275">}</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253279">case</span>&nbsp;<span class="string" id="5253284">&#39;*&#39;</span><span class="op" id="5253287">,</span>&nbsp;<span class="string" id="5253289">&#39;+&#39;</span><span class="op" id="5253292">,</span>&nbsp;<span class="string" id="5253294">&#39;?&#39;</span><span class="op" id="5253297">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5253302">before</span>&nbsp;<span class="op" id="5253309">:=</span>&nbsp;<span class="ident" id="5253312">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253317">switch</span>&nbsp;<span class="ident" id="5253324">t</span><span class="op" id="5253325">[</span><span class="num" id="5253326">0</span><span class="op" id="5253327">]</span>&nbsp;<span class="op" id="5253329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253334">case</span>&nbsp;<span class="string" id="5253339">&#39;*&#39;</span><span class="op" id="5253342">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5253348">op</span>&nbsp;<span class="op" id="5253351">=</span>&nbsp;<span class="ident" id="5253353">OpStar</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253363">case</span>&nbsp;<span class="string" id="5253368">&#39;+&#39;</span><span class="op" id="5253371">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5253377">op</span>&nbsp;<span class="op" id="5253380">=</span>&nbsp;<span class="ident" id="5253382">OpPlus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253392">case</span>&nbsp;<span class="string" id="5253397">&#39;?&#39;</span><span class="op" id="5253400">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5253406">op</span>&nbsp;<span class="op" id="5253409">=</span>&nbsp;<span class="ident" id="5253411">OpQuest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5253422">}</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5253427">after</span>&nbsp;<span class="op" id="5253433">:=</span>&nbsp;<span class="ident" id="5253436">t</span><span class="op" id="5253437">[</span><span class="num" id="5253438">1</span><span class="op" id="5253439">:</span><span class="op" id="5253440">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253445">if</span>&nbsp;<span class="ident" id="5253448">after</span><span class="op" id="5253453">,</span>&nbsp;<span class="ident" id="5253455">err</span>&nbsp;<span class="op" id="5253459">=</span>&nbsp;<span class="ident" id="5253461">p</span><span class="op" id="5253462">.</span><span class="ident" id="5253463">repeat</span><span class="op" id="5253469">(</span><span class="ident" id="5253470">op</span><span class="op" id="5253472">,</span>&nbsp;<span class="num" id="5253474">0</span><span class="op" id="5253475">,</span>&nbsp;<span class="num" id="5253477">0</span><span class="op" id="5253478">,</span>&nbsp;<span class="ident" id="5253480">before</span><span class="op" id="5253486">,</span>&nbsp;<span class="ident" id="5253488">after</span><span class="op" id="5253493">,</span>&nbsp;<span class="ident" id="5253495">lastRepeat</span><span class="op" id="5253505">)</span><span class="op" id="5253506">;</span>&nbsp;<span class="ident" id="5253508">err</span>&nbsp;<span class="op" id="5253512">!=</span>&nbsp;<span class="ident" id="5253515">nil</span>&nbsp;<span class="op" id="5253519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253525">return</span>&nbsp;<span class="ident" id="5253532">nil</span><span class="op" id="5253535">,</span>&nbsp;<span class="ident" id="5253537">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5253544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5253549">repeat</span>&nbsp;<span class="op" id="5253556">=</span>&nbsp;<span class="ident" id="5253558">before</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5253568">t</span>&nbsp;<span class="op" id="5253570">=</span>&nbsp;<span class="ident" id="5253572">after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253580">case</span>&nbsp;<span class="string" id="5253585">&#39;{&#39;</span><span class="op" id="5253588">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5253593">op</span>&nbsp;<span class="op" id="5253596">=</span>&nbsp;<span class="ident" id="5253598">OpRepeat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5253610">before</span>&nbsp;<span class="op" id="5253617">:=</span>&nbsp;<span class="ident" id="5253620">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5253625">min</span><span class="op" id="5253628">,</span>&nbsp;<span class="ident" id="5253630">max</span><span class="op" id="5253633">,</span>&nbsp;<span class="ident" id="5253635">after</span><span class="op" id="5253640">,</span>&nbsp;<span class="ident" id="5253642">ok</span>&nbsp;<span class="op" id="5253645">:=</span>&nbsp;<span class="ident" id="5253648">p</span><span class="op" id="5253649">.</span><span class="ident" id="5253650">parseRepeat</span><span class="op" id="5253661">(</span><span class="ident" id="5253662">t</span><span class="op" id="5253663">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253668">if</span>&nbsp;<span class="op" id="5253671">!</span><span class="ident" id="5253672">ok</span>&nbsp;<span class="op" id="5253675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5253681">//&nbsp;If&nbsp;the&nbsp;repeat&nbsp;cannot&nbsp;be&nbsp;parsed,&nbsp;{&nbsp;is&nbsp;a&nbsp;literal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5253736">p</span><span class="op" id="5253737">.</span><span class="ident" id="5253738">literal</span><span class="op" id="5253745">(</span><span class="string" id="5253746">&#39;{&#39;</span><span class="op" id="5253749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5253755">t</span>&nbsp;<span class="op" id="5253757">=</span>&nbsp;<span class="ident" id="5253759">t</span><span class="op" id="5253760">[</span><span class="num" id="5253761">1</span><span class="op" id="5253762">:</span><span class="op" id="5253763">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253769">break</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5253778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253783">if</span>&nbsp;<span class="ident" id="5253786">min</span>&nbsp;<span class="op" id="5253790">&lt;</span>&nbsp;<span class="num" id="5253792">0</span>&nbsp;<span class="op" id="5253794">||</span>&nbsp;<span class="ident" id="5253797">min</span>&nbsp;<span class="op" id="5253801">&gt;</span>&nbsp;<span class="num" id="5253803">1000</span>&nbsp;<span class="op" id="5253808">||</span>&nbsp;<span class="ident" id="5253811">max</span>&nbsp;<span class="op" id="5253815">&gt;</span>&nbsp;<span class="num" id="5253817">1000</span>&nbsp;<span class="op" id="5253822">||</span>&nbsp;<span class="ident" id="5253825">max</span>&nbsp;<span class="op" id="5253829">&gt;=</span>&nbsp;<span class="num" id="5253832">0</span>&nbsp;<span class="op" id="5253834">&amp;&amp;</span>&nbsp;<span class="ident" id="5253837">min</span>&nbsp;<span class="op" id="5253841">&gt;</span>&nbsp;<span class="ident" id="5253843">max</span>&nbsp;<span class="op" id="5253847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5253853">//&nbsp;Numbers&nbsp;were&nbsp;too&nbsp;big,&nbsp;or&nbsp;max&nbsp;is&nbsp;present&nbsp;and&nbsp;min&nbsp;&gt;&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253915">return</span>&nbsp;<span class="ident" id="5253922">nil</span><span class="op" id="5253925">,</span>&nbsp;<span class="op" id="5253927">&amp;</span><span class="ident" id="5253928">Error</span><span class="op" id="5253933">{</span><span class="ident" id="5253934">ErrInvalidRepeatSize</span><span class="op" id="5253954">,</span>&nbsp;<span class="ident" id="5253956">before</span><span class="op" id="5253962">[</span><span class="op" id="5253963">:</span><span class="builtinfunc" id="5253964">len</span><span class="op" id="5253967">(</span><span class="ident" id="5253968">before</span><span class="op" id="5253974">)</span><span class="op" id="5253975">-</span><span class="builtinfunc" id="5253976">len</span><span class="op" id="5253979">(</span><span class="ident" id="5253980">after</span><span class="op" id="5253985">)</span><span class="op" id="5253986">]</span><span class="op" id="5253987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5253992">}</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5253997">if</span>&nbsp;<span class="ident" id="5254000">after</span><span class="op" id="5254005">,</span>&nbsp;<span class="ident" id="5254007">err</span>&nbsp;<span class="op" id="5254011">=</span>&nbsp;<span class="ident" id="5254013">p</span><span class="op" id="5254014">.</span><span class="ident" id="5254015">repeat</span><span class="op" id="5254021">(</span><span class="ident" id="5254022">op</span><span class="op" id="5254024">,</span>&nbsp;<span class="ident" id="5254026">min</span><span class="op" id="5254029">,</span>&nbsp;<span class="ident" id="5254031">max</span><span class="op" id="5254034">,</span>&nbsp;<span class="ident" id="5254036">before</span><span class="op" id="5254042">,</span>&nbsp;<span class="ident" id="5254044">after</span><span class="op" id="5254049">,</span>&nbsp;<span class="ident" id="5254051">lastRepeat</span><span class="op" id="5254061">)</span><span class="op" id="5254062">;</span>&nbsp;<span class="ident" id="5254064">err</span>&nbsp;<span class="op" id="5254068">!=</span>&nbsp;<span class="ident" id="5254071">nil</span>&nbsp;<span class="op" id="5254075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254081">return</span>&nbsp;<span class="ident" id="5254088">nil</span><span class="op" id="5254091">,</span>&nbsp;<span class="ident" id="5254093">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5254100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5254105">repeat</span>&nbsp;<span class="op" id="5254112">=</span>&nbsp;<span class="ident" id="5254114">before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5254124">t</span>&nbsp;<span class="op" id="5254126">=</span>&nbsp;<span class="ident" id="5254128">after</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254136">case</span>&nbsp;<span class="string" id="5254141">&#39;\\&#39;</span><span class="op" id="5254145">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254150">if</span>&nbsp;<span class="ident" id="5254153">p</span><span class="op" id="5254154">.</span><span class="ident" id="5254155">flags</span><span class="op" id="5254160">&amp;</span><span class="ident" id="5254161">PerlX</span>&nbsp;<span class="op" id="5254167">!=</span>&nbsp;<span class="num" id="5254170">0</span>&nbsp;<span class="op" id="5254172">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5254175">len</span><span class="op" id="5254178">(</span><span class="ident" id="5254179">t</span><span class="op" id="5254180">)</span>&nbsp;<span class="op" id="5254182">&gt;=</span>&nbsp;<span class="num" id="5254185">2</span>&nbsp;<span class="op" id="5254187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254193">switch</span>&nbsp;<span class="ident" id="5254200">t</span><span class="op" id="5254201">[</span><span class="num" id="5254202">1</span><span class="op" id="5254203">]</span>&nbsp;<span class="op" id="5254205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254211">case</span>&nbsp;<span class="string" id="5254216">&#39;A&#39;</span><span class="op" id="5254219">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5254226">p</span><span class="op" id="5254227">.</span><span class="ident" id="5254228">op</span><span class="op" id="5254230">(</span><span class="ident" id="5254231">OpBeginText</span><span class="op" id="5254242">)</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5254249">t</span>&nbsp;<span class="op" id="5254251">=</span>&nbsp;<span class="ident" id="5254253">t</span><span class="op" id="5254254">[</span><span class="num" id="5254255">2</span><span class="op" id="5254256">:</span><span class="op" id="5254257">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254264">break</span>&nbsp;<span class="ident" id="5254270">BigSwitch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254284">case</span>&nbsp;<span class="string" id="5254289">&#39;b&#39;</span><span class="op" id="5254292">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5254299">p</span><span class="op" id="5254300">.</span><span class="ident" id="5254301">op</span><span class="op" id="5254303">(</span><span class="ident" id="5254304">OpWordBoundary</span><span class="op" id="5254318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5254325">t</span>&nbsp;<span class="op" id="5254327">=</span>&nbsp;<span class="ident" id="5254329">t</span><span class="op" id="5254330">[</span><span class="num" id="5254331">2</span><span class="op" id="5254332">:</span><span class="op" id="5254333">]</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254340">break</span>&nbsp;<span class="ident" id="5254346">BigSwitch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254360">case</span>&nbsp;<span class="string" id="5254365">&#39;B&#39;</span><span class="op" id="5254368">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5254375">p</span><span class="op" id="5254376">.</span><span class="ident" id="5254377">op</span><span class="op" id="5254379">(</span><span class="ident" id="5254380">OpNoWordBoundary</span><span class="op" id="5254396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5254403">t</span>&nbsp;<span class="op" id="5254405">=</span>&nbsp;<span class="ident" id="5254407">t</span><span class="op" id="5254408">[</span><span class="num" id="5254409">2</span><span class="op" id="5254410">:</span><span class="op" id="5254411">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254418">break</span>&nbsp;<span class="ident" id="5254424">BigSwitch</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254438">case</span>&nbsp;<span class="string" id="5254443">&#39;C&#39;</span><span class="op" id="5254446">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5254453">//&nbsp;any&nbsp;byte;&nbsp;not&nbsp;supported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254485">return</span>&nbsp;<span class="ident" id="5254492">nil</span><span class="op" id="5254495">,</span>&nbsp;<span class="op" id="5254497">&amp;</span><span class="ident" id="5254498">Error</span><span class="op" id="5254503">{</span><span class="ident" id="5254504">ErrInvalidEscape</span><span class="op" id="5254520">,</span>&nbsp;<span class="ident" id="5254522">t</span><span class="op" id="5254523">[</span><span class="op" id="5254524">:</span><span class="num" id="5254525">2</span><span class="op" id="5254526">]</span><span class="op" id="5254527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254533">case</span>&nbsp;<span class="string" id="5254538">&#39;Q&#39;</span><span class="op" id="5254541">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5254548">//&nbsp;\Q&nbsp;...&nbsp;\E:&nbsp;the&nbsp;...&nbsp;is&nbsp;always&nbsp;literals</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254594">var</span>&nbsp;<span class="ident" id="5254598">lit</span>&nbsp;<span class="builtintype" id="5254602">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254614">if</span>&nbsp;<span class="ident" id="5254617">i</span>&nbsp;<span class="op" id="5254619">:=</span>&nbsp;<span class="ident" id="5254622">strings</span><span class="op" id="5254629">.</span><span class="ident" id="5254630">Index</span><span class="op" id="5254635">(</span><span class="ident" id="5254636">t</span><span class="op" id="5254637">,</span>&nbsp;<span class="string" id="5254639">`\E`</span><span class="op" id="5254643">)</span><span class="op" id="5254644">;</span>&nbsp;<span class="ident" id="5254646">i</span>&nbsp;<span class="op" id="5254648">&lt;</span>&nbsp;<span class="num" id="5254650">0</span>&nbsp;<span class="op" id="5254652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5254660">lit</span>&nbsp;<span class="op" id="5254664">=</span>&nbsp;<span class="ident" id="5254666">t</span><span class="op" id="5254667">[</span><span class="num" id="5254668">2</span><span class="op" id="5254669">:</span><span class="op" id="5254670">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5254678">t</span>&nbsp;<span class="op" id="5254680">=</span>&nbsp;<span class="string" id="5254682">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5254690">}</span>&nbsp;<span class="keyword" id="5254692">else</span>&nbsp;<span class="op" id="5254697">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5254705">lit</span>&nbsp;<span class="op" id="5254709">=</span>&nbsp;<span class="ident" id="5254711">t</span><span class="op" id="5254712">[</span><span class="num" id="5254713">2</span><span class="op" id="5254714">:</span><span class="ident" id="5254715">i</span><span class="op" id="5254716">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5254724">t</span>&nbsp;<span class="op" id="5254726">=</span>&nbsp;<span class="ident" id="5254728">t</span><span class="op" id="5254729">[</span><span class="ident" id="5254730">i</span><span class="op" id="5254731">+</span><span class="num" id="5254732">2</span><span class="op" id="5254733">:</span><span class="op" id="5254734">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5254741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5254748">p</span><span class="op" id="5254749">.</span><span class="ident" id="5254750">push</span><span class="op" id="5254754">(</span><span class="ident" id="5254755">literalRegexp</span><span class="op" id="5254768">(</span><span class="ident" id="5254769">lit</span><span class="op" id="5254772">,</span>&nbsp;<span class="ident" id="5254774">p</span><span class="op" id="5254775">.</span><span class="ident" id="5254776">flags</span><span class="op" id="5254781">)</span><span class="op" id="5254782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254789">break</span>&nbsp;<span class="ident" id="5254795">BigSwitch</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254809">case</span>&nbsp;<span class="string" id="5254814">&#39;z&#39;</span><span class="op" id="5254817">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5254824">p</span><span class="op" id="5254825">.</span><span class="ident" id="5254826">op</span><span class="op" id="5254828">(</span><span class="ident" id="5254829">OpEndText</span><span class="op" id="5254838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5254845">t</span>&nbsp;<span class="op" id="5254847">=</span>&nbsp;<span class="ident" id="5254849">t</span><span class="op" id="5254850">[</span><span class="num" id="5254851">2</span><span class="op" id="5254852">:</span><span class="op" id="5254853">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5254860">break</span>&nbsp;<span class="ident" id="5254866">BigSwitch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5254880">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5254885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5254891">re</span>&nbsp;<span class="op" id="5254894">:=</span>&nbsp;<span class="ident" id="5254897">p</span><span class="op" id="5254898">.</span><span class="ident" id="5254899">newRegexp</span><span class="op" id="5254908">(</span><span class="ident" id="5254909">OpCharClass</span><span class="op" id="5254920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5254925">re</span><span class="op" id="5254927">.</span><span class="ident" id="5254928">Flags</span>&nbsp;<span class="op" id="5254934">=</span>&nbsp;<span class="ident" id="5254936">p</span><span class="op" id="5254937">.</span><span class="ident" id="5254938">flags</span><br>
<span class="lineno"></span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5254948">//&nbsp;Look&nbsp;for&nbsp;Unicode&nbsp;character&nbsp;group&nbsp;like&nbsp;\p{Han}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255000">if</span>&nbsp;<span class="builtinfunc" id="5255003">len</span><span class="op" id="5255006">(</span><span class="ident" id="5255007">t</span><span class="op" id="5255008">)</span>&nbsp;<span class="op" id="5255010">&gt;=</span>&nbsp;<span class="num" id="5255013">2</span>&nbsp;<span class="op" id="5255015">&amp;&amp;</span>&nbsp;<span class="op" id="5255018">(</span><span class="ident" id="5255019">t</span><span class="op" id="5255020">[</span><span class="num" id="5255021">1</span><span class="op" id="5255022">]</span>&nbsp;<span class="op" id="5255024">==</span>&nbsp;<span class="string" id="5255027">&#39;p&#39;</span>&nbsp;<span class="op" id="5255031">||</span>&nbsp;<span class="ident" id="5255034">t</span><span class="op" id="5255035">[</span><span class="num" id="5255036">1</span><span class="op" id="5255037">]</span>&nbsp;<span class="op" id="5255039">==</span>&nbsp;<span class="string" id="5255042">&#39;P&#39;</span><span class="op" id="5255045">)</span>&nbsp;<span class="op" id="5255047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255053">r</span><span class="op" id="5255054">,</span>&nbsp;<span class="ident" id="5255056">rest</span><span class="op" id="5255060">,</span>&nbsp;<span class="ident" id="5255062">err</span>&nbsp;<span class="op" id="5255066">:=</span>&nbsp;<span class="ident" id="5255069">p</span><span class="op" id="5255070">.</span><span class="ident" id="5255071">parseUnicodeClass</span><span class="op" id="5255088">(</span><span class="ident" id="5255089">t</span><span class="op" id="5255090">,</span>&nbsp;<span class="ident" id="5255092">re</span><span class="op" id="5255094">.</span><span class="ident" id="5255095">Rune0</span><span class="op" id="5255100">[</span><span class="op" id="5255101">:</span><span class="num" id="5255102">0</span><span class="op" id="5255103">]</span><span class="op" id="5255104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255110">if</span>&nbsp;<span class="ident" id="5255113">err</span>&nbsp;<span class="op" id="5255117">!=</span>&nbsp;<span class="ident" id="5255120">nil</span>&nbsp;<span class="op" id="5255124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255131">return</span>&nbsp;<span class="ident" id="5255138">nil</span><span class="op" id="5255141">,</span>&nbsp;<span class="ident" id="5255143">err</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5255151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255157">if</span>&nbsp;<span class="ident" id="5255160">r</span>&nbsp;<span class="op" id="5255162">!=</span>&nbsp;<span class="ident" id="5255165">nil</span>&nbsp;<span class="op" id="5255169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255176">re</span><span class="op" id="5255178">.</span><span class="ident" id="5255179">Rune</span>&nbsp;<span class="op" id="5255184">=</span>&nbsp;<span class="ident" id="5255186">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255193">t</span>&nbsp;<span class="op" id="5255195">=</span>&nbsp;<span class="ident" id="5255197">rest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255207">p</span><span class="op" id="5255208">.</span><span class="ident" id="5255209">push</span><span class="op" id="5255213">(</span><span class="ident" id="5255214">re</span><span class="op" id="5255216">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255223">break</span>&nbsp;<span class="ident" id="5255229">BigSwitch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5255243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5255248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5255254">//&nbsp;Perl&nbsp;character&nbsp;class&nbsp;escape.</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255289">if</span>&nbsp;<span class="ident" id="5255292">r</span><span class="op" id="5255293">,</span>&nbsp;<span class="ident" id="5255295">rest</span>&nbsp;<span class="op" id="5255300">:=</span>&nbsp;<span class="ident" id="5255303">p</span><span class="op" id="5255304">.</span><span class="ident" id="5255305">parsePerlClassEscape</span><span class="op" id="5255325">(</span><span class="ident" id="5255326">t</span><span class="op" id="5255327">,</span>&nbsp;<span class="ident" id="5255329">re</span><span class="op" id="5255331">.</span><span class="ident" id="5255332">Rune0</span><span class="op" id="5255337">[</span><span class="op" id="5255338">:</span><span class="num" id="5255339">0</span><span class="op" id="5255340">]</span><span class="op" id="5255341">)</span><span class="op" id="5255342">;</span>&nbsp;<span class="ident" id="5255344">r</span>&nbsp;<span class="op" id="5255346">!=</span>&nbsp;<span class="ident" id="5255349">nil</span>&nbsp;<span class="op" id="5255353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255359">re</span><span class="op" id="5255361">.</span><span class="ident" id="5255362">Rune</span>&nbsp;<span class="op" id="5255367">=</span>&nbsp;<span class="ident" id="5255369">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255375">t</span>&nbsp;<span class="op" id="5255377">=</span>&nbsp;<span class="ident" id="5255379">rest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255388">p</span><span class="op" id="5255389">.</span><span class="ident" id="5255390">push</span><span class="op" id="5255394">(</span><span class="ident" id="5255395">re</span><span class="op" id="5255397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255403">break</span>&nbsp;<span class="ident" id="5255409">BigSwitch</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5255422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255427">p</span><span class="op" id="5255428">.</span><span class="ident" id="5255429">reuse</span><span class="op" id="5255434">(</span><span class="ident" id="5255435">re</span><span class="op" id="5255437">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5255443">//&nbsp;Ordinary&nbsp;single-character&nbsp;escape.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255483">if</span>&nbsp;<span class="ident" id="5255486">c</span><span class="op" id="5255487">,</span>&nbsp;<span class="ident" id="5255489">t</span><span class="op" id="5255490">,</span>&nbsp;<span class="ident" id="5255492">err</span>&nbsp;<span class="op" id="5255496">=</span>&nbsp;<span class="ident" id="5255498">p</span><span class="op" id="5255499">.</span><span class="ident" id="5255500">parseEscape</span><span class="op" id="5255511">(</span><span class="ident" id="5255512">t</span><span class="op" id="5255513">)</span><span class="op" id="5255514">;</span>&nbsp;<span class="ident" id="5255516">err</span>&nbsp;<span class="op" id="5255520">!=</span>&nbsp;<span class="ident" id="5255523">nil</span>&nbsp;<span class="op" id="5255527">{</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255533">return</span>&nbsp;<span class="ident" id="5255540">nil</span><span class="op" id="5255543">,</span>&nbsp;<span class="ident" id="5255545">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5255552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255557">p</span><span class="op" id="5255558">.</span><span class="ident" id="5255559">literal</span><span class="op" id="5255566">(</span><span class="ident" id="5255567">c</span><span class="op" id="5255568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5255572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255576">lastRepeat</span>&nbsp;<span class="op" id="5255587">=</span>&nbsp;<span class="ident" id="5255589">repeat</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5255597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255601">p</span><span class="op" id="5255602">.</span><span class="ident" id="5255603">concat</span><span class="op" id="5255609">(</span><span class="op" id="5255610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255613">if</span>&nbsp;<span class="ident" id="5255616">p</span><span class="op" id="5255617">.</span><span class="ident" id="5255618">swapVerticalBar</span><span class="op" id="5255633">(</span><span class="op" id="5255634">)</span>&nbsp;<span class="op" id="5255636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5255640">//&nbsp;pop&nbsp;vertical&nbsp;bar</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255662">p</span><span class="op" id="5255663">.</span><span class="ident" id="5255664">stack</span>&nbsp;<span class="op" id="5255670">=</span>&nbsp;<span class="ident" id="5255672">p</span><span class="op" id="5255673">.</span><span class="ident" id="5255674">stack</span><span class="op" id="5255679">[</span><span class="op" id="5255680">:</span><span class="builtinfunc" id="5255681">len</span><span class="op" id="5255684">(</span><span class="ident" id="5255685">p</span><span class="op" id="5255686">.</span><span class="ident" id="5255687">stack</span><span class="op" id="5255692">)</span><span class="op" id="5255693">-</span><span class="num" id="5255694">1</span><span class="op" id="5255695">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5255698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255701">p</span><span class="op" id="5255702">.</span><span class="ident" id="5255703">alternate</span><span class="op" id="5255712">(</span><span class="op" id="5255713">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255717">n</span>&nbsp;<span class="op" id="5255719">:=</span>&nbsp;<span class="builtinfunc" id="5255722">len</span><span class="op" id="5255725">(</span><span class="ident" id="5255726">p</span><span class="op" id="5255727">.</span><span class="ident" id="5255728">stack</span><span class="op" id="5255733">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255736">if</span>&nbsp;<span class="ident" id="5255739">n</span>&nbsp;<span class="op" id="5255741">!=</span>&nbsp;<span class="num" id="5255744">1</span>&nbsp;<span class="op" id="5255746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255750">return</span>&nbsp;<span class="ident" id="5255757">nil</span><span class="op" id="5255760">,</span>&nbsp;<span class="op" id="5255762">&amp;</span><span class="ident" id="5255763">Error</span><span class="op" id="5255768">{</span><span class="ident" id="5255769">ErrMissingParen</span><span class="op" id="5255784">,</span>&nbsp;<span class="ident" id="5255786">s</span><span class="op" id="5255787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5255790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255793">return</span>&nbsp;<span class="ident" id="5255800">p</span><span class="op" id="5255801">.</span><span class="ident" id="5255802">stack</span><span class="op" id="5255807">[</span><span class="num" id="5255808">0</span><span class="op" id="5255809">]</span><span class="op" id="5255810">,</span>&nbsp;<span class="ident" id="5255812">nil</span><br>
<span class="lineno"></span><span class="op" id="5255816">}</span><br>
<span class="lineno">890</span><br>
<span class="lineno"></span><span class="comment" id="5255819">//&nbsp;parseRepeat&nbsp;parses&nbsp;{min}&nbsp;(max=min)&nbsp;or&nbsp;{min,}&nbsp;(max=-1)&nbsp;or&nbsp;{min,max}.</span><br>
<span class="lineno"></span><span class="comment" id="5255890">//&nbsp;If&nbsp;s&nbsp;is&nbsp;not&nbsp;of&nbsp;that&nbsp;form,&nbsp;it&nbsp;returns&nbsp;ok&nbsp;==&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="5255943">//&nbsp;If&nbsp;s&nbsp;has&nbsp;the&nbsp;right&nbsp;form&nbsp;but&nbsp;the&nbsp;values&nbsp;are&nbsp;too&nbsp;big,&nbsp;it&nbsp;returns&nbsp;min&nbsp;==&nbsp;-1,&nbsp;ok&nbsp;==&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="5256032">func</span>&nbsp;<span class="op" id="5256037">(</span><span class="ident" id="5256038">p</span>&nbsp;<span class="op" id="5256040">*</span><span class="ident" id="5256041">parser</span><span class="op" id="5256047">)</span>&nbsp;<span class="ident" id="5256049">parseRepeat</span><span class="op" id="5256060">(</span><span class="ident" id="5256061">s</span>&nbsp;<span class="builtintype" id="5256063">string</span><span class="op" id="5256069">)</span>&nbsp;<span class="op" id="5256071">(</span><span class="ident" id="5256072">min</span><span class="op" id="5256075">,</span>&nbsp;<span class="ident" id="5256077">max</span>&nbsp;<span class="builtintype" id="5256081">int</span><span class="op" id="5256084">,</span>&nbsp;<span class="ident" id="5256086">rest</span>&nbsp;<span class="builtintype" id="5256091">string</span><span class="op" id="5256097">,</span>&nbsp;<span class="ident" id="5256099">ok</span>&nbsp;<span class="builtintype" id="5256102">bool</span><span class="op" id="5256106">)</span>&nbsp;<span class="op" id="5256108">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256111">if</span>&nbsp;<span class="ident" id="5256114">s</span>&nbsp;<span class="op" id="5256116">==</span>&nbsp;<span class="string" id="5256119">&#34;&#34;</span>&nbsp;<span class="op" id="5256122">||</span>&nbsp;<span class="ident" id="5256125">s</span><span class="op" id="5256126">[</span><span class="num" id="5256127">0</span><span class="op" id="5256128">]</span>&nbsp;<span class="op" id="5256130">!=</span>&nbsp;<span class="string" id="5256133">&#39;{&#39;</span>&nbsp;<span class="op" id="5256137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256141">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5256152">s</span>&nbsp;<span class="op" id="5256154">=</span>&nbsp;<span class="ident" id="5256156">s</span><span class="op" id="5256157">[</span><span class="num" id="5256158">1</span><span class="op" id="5256159">:</span><span class="op" id="5256160">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256163">var</span>&nbsp;<span class="ident" id="5256167">ok1</span>&nbsp;<span class="builtintype" id="5256171">bool</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256177">if</span>&nbsp;<span class="ident" id="5256180">min</span><span class="op" id="5256183">,</span>&nbsp;<span class="ident" id="5256185">s</span><span class="op" id="5256186">,</span>&nbsp;<span class="ident" id="5256188">ok1</span>&nbsp;<span class="op" id="5256192">=</span>&nbsp;<span class="ident" id="5256194">p</span><span class="op" id="5256195">.</span><span class="ident" id="5256196">parseInt</span><span class="op" id="5256204">(</span><span class="ident" id="5256205">s</span><span class="op" id="5256206">)</span><span class="op" id="5256207">;</span>&nbsp;<span class="op" id="5256209">!</span><span class="ident" id="5256210">ok1</span>&nbsp;<span class="op" id="5256214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256218">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256229">if</span>&nbsp;<span class="ident" id="5256232">s</span>&nbsp;<span class="op" id="5256234">==</span>&nbsp;<span class="string" id="5256237">&#34;&#34;</span>&nbsp;<span class="op" id="5256240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256244">return</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256255">if</span>&nbsp;<span class="ident" id="5256258">s</span><span class="op" id="5256259">[</span><span class="num" id="5256260">0</span><span class="op" id="5256261">]</span>&nbsp;<span class="op" id="5256263">!=</span>&nbsp;<span class="string" id="5256266">&#39;,&#39;</span>&nbsp;<span class="op" id="5256270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5256274">max</span>&nbsp;<span class="op" id="5256278">=</span>&nbsp;<span class="ident" id="5256280">min</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256285">}</span>&nbsp;<span class="keyword" id="5256287">else</span>&nbsp;<span class="op" id="5256292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5256296">s</span>&nbsp;<span class="op" id="5256298">=</span>&nbsp;<span class="ident" id="5256300">s</span><span class="op" id="5256301">[</span><span class="num" id="5256302">1</span><span class="op" id="5256303">:</span><span class="op" id="5256304">]</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256308">if</span>&nbsp;<span class="ident" id="5256311">s</span>&nbsp;<span class="op" id="5256313">==</span>&nbsp;<span class="string" id="5256316">&#34;&#34;</span>&nbsp;<span class="op" id="5256319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256324">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256337">if</span>&nbsp;<span class="ident" id="5256340">s</span><span class="op" id="5256341">[</span><span class="num" id="5256342">0</span><span class="op" id="5256343">]</span>&nbsp;<span class="op" id="5256345">==</span>&nbsp;<span class="string" id="5256348">&#39;}&#39;</span>&nbsp;<span class="op" id="5256352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5256357">max</span>&nbsp;<span class="op" id="5256361">=</span>&nbsp;<span class="op" id="5256363">-</span><span class="num" id="5256364">1</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256368">}</span>&nbsp;<span class="keyword" id="5256370">else</span>&nbsp;<span class="keyword" id="5256375">if</span>&nbsp;<span class="ident" id="5256378">max</span><span class="op" id="5256381">,</span>&nbsp;<span class="ident" id="5256383">s</span><span class="op" id="5256384">,</span>&nbsp;<span class="ident" id="5256386">ok1</span>&nbsp;<span class="op" id="5256390">=</span>&nbsp;<span class="ident" id="5256392">p</span><span class="op" id="5256393">.</span><span class="ident" id="5256394">parseInt</span><span class="op" id="5256402">(</span><span class="ident" id="5256403">s</span><span class="op" id="5256404">)</span><span class="op" id="5256405">;</span>&nbsp;<span class="op" id="5256407">!</span><span class="ident" id="5256408">ok1</span>&nbsp;<span class="op" id="5256412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256417">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256426">}</span>&nbsp;<span class="keyword" id="5256428">else</span>&nbsp;<span class="keyword" id="5256433">if</span>&nbsp;<span class="ident" id="5256436">max</span>&nbsp;<span class="op" id="5256440">&lt;</span>&nbsp;<span class="num" id="5256442">0</span>&nbsp;<span class="op" id="5256444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5256449">//&nbsp;parseInt&nbsp;found&nbsp;too&nbsp;big&nbsp;a&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5256487">min</span>&nbsp;<span class="op" id="5256491">=</span>&nbsp;<span class="op" id="5256493">-</span><span class="num" id="5256494">1</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256504">if</span>&nbsp;<span class="ident" id="5256507">s</span>&nbsp;<span class="op" id="5256509">==</span>&nbsp;<span class="string" id="5256512">&#34;&#34;</span>&nbsp;<span class="op" id="5256515">||</span>&nbsp;<span class="ident" id="5256518">s</span><span class="op" id="5256519">[</span><span class="num" id="5256520">0</span><span class="op" id="5256521">]</span>&nbsp;<span class="op" id="5256523">!=</span>&nbsp;<span class="string" id="5256526">&#39;}&#39;</span>&nbsp;<span class="op" id="5256530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256534">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256542">}</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5256545">rest</span>&nbsp;<span class="op" id="5256550">=</span>&nbsp;<span class="ident" id="5256552">s</span><span class="op" id="5256553">[</span><span class="num" id="5256554">1</span><span class="op" id="5256555">:</span><span class="op" id="5256556">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5256559">ok</span>&nbsp;<span class="op" id="5256562">=</span>&nbsp;<span class="ident" id="5256564">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256570">return</span><br>
<span class="lineno"></span><span class="op" id="5256577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">930</span><span class="comment" id="5256580">//&nbsp;parsePerlFlags&nbsp;parses&nbsp;a&nbsp;Perl&nbsp;flag&nbsp;setting&nbsp;or&nbsp;non-capturing&nbsp;group&nbsp;or&nbsp;both,</span><br>
<span class="lineno"></span><span class="comment" id="5256657">//&nbsp;like&nbsp;(?i)&nbsp;or&nbsp;(?:&nbsp;or&nbsp;(?i:.&nbsp;&nbsp;It&nbsp;removes&nbsp;the&nbsp;prefix&nbsp;from&nbsp;s&nbsp;and&nbsp;updates&nbsp;the&nbsp;parse&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="5256745">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;have&nbsp;ensured&nbsp;that&nbsp;s&nbsp;begins&nbsp;with&nbsp;&#34;(?&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="5256802">func</span>&nbsp;<span class="op" id="5256807">(</span><span class="ident" id="5256808">p</span>&nbsp;<span class="op" id="5256810">*</span><span class="ident" id="5256811">parser</span><span class="op" id="5256817">)</span>&nbsp;<span class="ident" id="5256819">parsePerlFlags</span><span class="op" id="5256833">(</span><span class="ident" id="5256834">s</span>&nbsp;<span class="builtintype" id="5256836">string</span><span class="op" id="5256842">)</span>&nbsp;<span class="op" id="5256844">(</span><span class="ident" id="5256845">rest</span>&nbsp;<span class="builtintype" id="5256850">string</span><span class="op" id="5256856">,</span>&nbsp;<span class="ident" id="5256858">err</span>&nbsp;<span class="builtintype" id="5256862">error</span><span class="op" id="5256867">)</span>&nbsp;<span class="op" id="5256869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5256872">t</span>&nbsp;<span class="op" id="5256874">:=</span>&nbsp;<span class="ident" id="5256877">s</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5256881">//&nbsp;Check&nbsp;for&nbsp;named&nbsp;captures,&nbsp;first&nbsp;introduced&nbsp;in&nbsp;Python&#39;s&nbsp;regexp&nbsp;library.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5256956">//&nbsp;As&nbsp;usual,&nbsp;there&nbsp;are&nbsp;three&nbsp;slightly&nbsp;different&nbsp;syntaxes:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5257015">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5257019">//&nbsp;&nbsp;&nbsp;(?P&lt;name&gt;expr)&nbsp;&nbsp;&nbsp;the&nbsp;original,&nbsp;introduced&nbsp;by&nbsp;Python</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5257077">//&nbsp;&nbsp;&nbsp;(?&lt;name&gt;expr)&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;.NET&nbsp;alteration,&nbsp;adopted&nbsp;by&nbsp;Perl&nbsp;5.10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5257142">//&nbsp;&nbsp;&nbsp;(?&#39;name&#39;expr)&nbsp;&nbsp;&nbsp;&nbsp;another&nbsp;.NET&nbsp;alteration,&nbsp;adopted&nbsp;by&nbsp;Perl&nbsp;5.10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5257211">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5257215">//&nbsp;Perl&nbsp;5.10&nbsp;gave&nbsp;in&nbsp;and&nbsp;implemented&nbsp;the&nbsp;Python&nbsp;version&nbsp;too,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5257277">//&nbsp;but&nbsp;they&nbsp;claim&nbsp;that&nbsp;the&nbsp;last&nbsp;two&nbsp;are&nbsp;the&nbsp;preferred&nbsp;forms.</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5257339">//&nbsp;PCRE&nbsp;and&nbsp;languages&nbsp;based&nbsp;on&nbsp;it&nbsp;(specifically,&nbsp;PHP&nbsp;and&nbsp;Ruby)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5257403">//&nbsp;support&nbsp;all&nbsp;three&nbsp;as&nbsp;well.&nbsp;&nbsp;EcmaScript&nbsp;4&nbsp;uses&nbsp;only&nbsp;the&nbsp;Python&nbsp;form.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5257475">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5257479">//&nbsp;In&nbsp;both&nbsp;the&nbsp;open&nbsp;source&nbsp;world&nbsp;(via&nbsp;Code&nbsp;Search)&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5257539">//&nbsp;Google&nbsp;source&nbsp;tree,&nbsp;(?P&lt;expr&gt;name)&nbsp;is&nbsp;the&nbsp;dominant&nbsp;form,</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5257600">//&nbsp;so&nbsp;that&#39;s&nbsp;the&nbsp;one&nbsp;we&nbsp;implement.&nbsp;&nbsp;One&nbsp;is&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5257652">if</span>&nbsp;<span class="builtinfunc" id="5257655">len</span><span class="op" id="5257658">(</span><span class="ident" id="5257659">t</span><span class="op" id="5257660">)</span>&nbsp;<span class="op" id="5257662">&gt;</span>&nbsp;<span class="num" id="5257664">4</span>&nbsp;<span class="op" id="5257666">&amp;&amp;</span>&nbsp;<span class="ident" id="5257669">t</span><span class="op" id="5257670">[</span><span class="num" id="5257671">2</span><span class="op" id="5257672">]</span>&nbsp;<span class="op" id="5257674">==</span>&nbsp;<span class="string" id="5257677">&#39;P&#39;</span>&nbsp;<span class="op" id="5257681">&amp;&amp;</span>&nbsp;<span class="ident" id="5257684">t</span><span class="op" id="5257685">[</span><span class="num" id="5257686">3</span><span class="op" id="5257687">]</span>&nbsp;<span class="op" id="5257689">==</span>&nbsp;<span class="string" id="5257692">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5257696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5257700">//&nbsp;Pull&nbsp;out&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5257720">end</span>&nbsp;<span class="op" id="5257724">:=</span>&nbsp;<span class="ident" id="5257727">strings</span><span class="op" id="5257734">.</span><span class="ident" id="5257735">IndexRune</span><span class="op" id="5257744">(</span><span class="ident" id="5257745">t</span><span class="op" id="5257746">,</span>&nbsp;<span class="string" id="5257748">&#39;&gt;&#39;</span><span class="op" id="5257751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5257755">if</span>&nbsp;<span class="ident" id="5257758">end</span>&nbsp;<span class="op" id="5257762">&lt;</span>&nbsp;<span class="num" id="5257764">0</span>&nbsp;<span class="op" id="5257766">{</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5257771">if</span>&nbsp;<span class="ident" id="5257774">err</span>&nbsp;<span class="op" id="5257778">=</span>&nbsp;<span class="ident" id="5257780">checkUTF8</span><span class="op" id="5257789">(</span><span class="ident" id="5257790">t</span><span class="op" id="5257791">)</span><span class="op" id="5257792">;</span>&nbsp;<span class="ident" id="5257794">err</span>&nbsp;<span class="op" id="5257798">!=</span>&nbsp;<span class="ident" id="5257801">nil</span>&nbsp;<span class="op" id="5257805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5257811">return</span>&nbsp;<span class="string" id="5257818">&#34;&#34;</span><span class="op" id="5257820">,</span>&nbsp;<span class="ident" id="5257822">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5257829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5257834">return</span>&nbsp;<span class="string" id="5257841">&#34;&#34;</span><span class="op" id="5257843">,</span>&nbsp;<span class="op" id="5257845">&amp;</span><span class="ident" id="5257846">Error</span><span class="op" id="5257851">{</span><span class="ident" id="5257852">ErrInvalidNamedCapture</span><span class="op" id="5257874">,</span>&nbsp;<span class="ident" id="5257876">s</span><span class="op" id="5257877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5257881">}</span><br>
<span class="lineno">960</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5257886">capture</span>&nbsp;<span class="op" id="5257894">:=</span>&nbsp;<span class="ident" id="5257897">t</span><span class="op" id="5257898">[</span><span class="op" id="5257899">:</span><span class="ident" id="5257900">end</span><span class="op" id="5257903">+</span><span class="num" id="5257904">1</span><span class="op" id="5257905">]</span>&nbsp;<span class="comment" id="5257907">//&nbsp;&#34;(?P&lt;name&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5257924">name</span>&nbsp;<span class="op" id="5257929">:=</span>&nbsp;<span class="ident" id="5257932">t</span><span class="op" id="5257933">[</span><span class="num" id="5257934">4</span><span class="op" id="5257935">:</span><span class="ident" id="5257936">end</span><span class="op" id="5257939">]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5257945">//&nbsp;&#34;name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5257957">if</span>&nbsp;<span class="ident" id="5257960">err</span>&nbsp;<span class="op" id="5257964">=</span>&nbsp;<span class="ident" id="5257966">checkUTF8</span><span class="op" id="5257975">(</span><span class="ident" id="5257976">name</span><span class="op" id="5257980">)</span><span class="op" id="5257981">;</span>&nbsp;<span class="ident" id="5257983">err</span>&nbsp;<span class="op" id="5257987">!=</span>&nbsp;<span class="ident" id="5257990">nil</span>&nbsp;<span class="op" id="5257994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5257999">return</span>&nbsp;<span class="string" id="5258006">&#34;&#34;</span><span class="op" id="5258008">,</span>&nbsp;<span class="ident" id="5258010">err</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5258016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258020">if</span>&nbsp;<span class="op" id="5258023">!</span><span class="ident" id="5258024">isValidCaptureName</span><span class="op" id="5258042">(</span><span class="ident" id="5258043">name</span><span class="op" id="5258047">)</span>&nbsp;<span class="op" id="5258049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258054">return</span>&nbsp;<span class="string" id="5258061">&#34;&#34;</span><span class="op" id="5258063">,</span>&nbsp;<span class="op" id="5258065">&amp;</span><span class="ident" id="5258066">Error</span><span class="op" id="5258071">{</span><span class="ident" id="5258072">ErrInvalidNamedCapture</span><span class="op" id="5258094">,</span>&nbsp;<span class="ident" id="5258096">capture</span><span class="op" id="5258103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5258107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5258112">//&nbsp;Like&nbsp;ordinary&nbsp;capture,&nbsp;but&nbsp;named.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258151">p</span><span class="op" id="5258152">.</span><span class="ident" id="5258153">numCap</span><span class="op" id="5258159">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258164">re</span>&nbsp;<span class="op" id="5258167">:=</span>&nbsp;<span class="ident" id="5258170">p</span><span class="op" id="5258171">.</span><span class="ident" id="5258172">op</span><span class="op" id="5258174">(</span><span class="ident" id="5258175">opLeftParen</span><span class="op" id="5258186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258190">re</span><span class="op" id="5258192">.</span><span class="ident" id="5258193">Cap</span>&nbsp;<span class="op" id="5258197">=</span>&nbsp;<span class="ident" id="5258199">p</span><span class="op" id="5258200">.</span><span class="ident" id="5258201">numCap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258210">re</span><span class="op" id="5258212">.</span><span class="ident" id="5258213">Name</span>&nbsp;<span class="op" id="5258218">=</span>&nbsp;<span class="ident" id="5258220">name</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258227">return</span>&nbsp;<span class="ident" id="5258234">t</span><span class="op" id="5258235">[</span><span class="ident" id="5258236">end</span><span class="op" id="5258239">+</span><span class="num" id="5258240">1</span><span class="op" id="5258241">:</span><span class="op" id="5258242">]</span><span class="op" id="5258243">,</span>&nbsp;<span class="ident" id="5258245">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5258250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5258254">//&nbsp;Non-capturing&nbsp;group.&nbsp;&nbsp;Might&nbsp;also&nbsp;twiddle&nbsp;Perl&nbsp;flags.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258311">var</span>&nbsp;<span class="ident" id="5258315">c</span>&nbsp;<span class="builtintype" id="5258317">rune</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258323">t</span>&nbsp;<span class="op" id="5258325">=</span>&nbsp;<span class="ident" id="5258327">t</span><span class="op" id="5258328">[</span><span class="num" id="5258329">2</span><span class="op" id="5258330">:</span><span class="op" id="5258331">]</span>&nbsp;<span class="comment" id="5258333">//&nbsp;skip&nbsp;(?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258345">flags</span>&nbsp;<span class="op" id="5258351">:=</span>&nbsp;<span class="ident" id="5258354">p</span><span class="op" id="5258355">.</span><span class="ident" id="5258356">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258363">sign</span>&nbsp;<span class="op" id="5258368">:=</span>&nbsp;<span class="op" id="5258371">+</span><span class="num" id="5258372">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258375">sawFlag</span>&nbsp;<span class="op" id="5258383">:=</span>&nbsp;<span class="ident" id="5258386">false</span><br>
<span class="lineno"></span><span class="ident" id="5258392">Loop</span><span class="op" id="5258396">:</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258399">for</span>&nbsp;<span class="ident" id="5258403">t</span>&nbsp;<span class="op" id="5258405">!=</span>&nbsp;<span class="string" id="5258408">&#34;&#34;</span>&nbsp;<span class="op" id="5258411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258415">if</span>&nbsp;<span class="ident" id="5258418">c</span><span class="op" id="5258419">,</span>&nbsp;<span class="ident" id="5258421">t</span><span class="op" id="5258422">,</span>&nbsp;<span class="ident" id="5258424">err</span>&nbsp;<span class="op" id="5258428">=</span>&nbsp;<span class="ident" id="5258430">nextRune</span><span class="op" id="5258438">(</span><span class="ident" id="5258439">t</span><span class="op" id="5258440">)</span><span class="op" id="5258441">;</span>&nbsp;<span class="ident" id="5258443">err</span>&nbsp;<span class="op" id="5258447">!=</span>&nbsp;<span class="ident" id="5258450">nil</span>&nbsp;<span class="op" id="5258454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258459">return</span>&nbsp;<span class="string" id="5258466">&#34;&#34;</span><span class="op" id="5258468">,</span>&nbsp;<span class="ident" id="5258470">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5258476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258480">switch</span>&nbsp;<span class="ident" id="5258487">c</span>&nbsp;<span class="op" id="5258489">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258493">default</span><span class="op" id="5258500">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258505">break</span>&nbsp;<span class="ident" id="5258511">Loop</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5258519">//&nbsp;Flags.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258531">case</span>&nbsp;<span class="string" id="5258536">&#39;i&#39;</span><span class="op" id="5258539">:</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258544">flags</span>&nbsp;<span class="op" id="5258550">|=</span>&nbsp;<span class="ident" id="5258553">FoldCase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258565">sawFlag</span>&nbsp;<span class="op" id="5258573">=</span>&nbsp;<span class="ident" id="5258575">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258582">case</span>&nbsp;<span class="string" id="5258587">&#39;m&#39;</span><span class="op" id="5258590">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258595">flags</span>&nbsp;<span class="op" id="5258601">&amp;^=</span>&nbsp;<span class="ident" id="5258605">OneLine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258616">sawFlag</span>&nbsp;<span class="op" id="5258624">=</span>&nbsp;<span class="ident" id="5258626">true</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258633">case</span>&nbsp;<span class="string" id="5258638">&#39;s&#39;</span><span class="op" id="5258641">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258646">flags</span>&nbsp;<span class="op" id="5258652">|=</span>&nbsp;<span class="ident" id="5258655">DotNL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258664">sawFlag</span>&nbsp;<span class="op" id="5258672">=</span>&nbsp;<span class="ident" id="5258674">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258681">case</span>&nbsp;<span class="string" id="5258686">&#39;U&#39;</span><span class="op" id="5258689">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258694">flags</span>&nbsp;<span class="op" id="5258700">|=</span>&nbsp;<span class="ident" id="5258703">NonGreedy</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258716">sawFlag</span>&nbsp;<span class="op" id="5258724">=</span>&nbsp;<span class="ident" id="5258726">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5258734">//&nbsp;Switch&nbsp;to&nbsp;negation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258759">case</span>&nbsp;<span class="string" id="5258764">&#39;-&#39;</span><span class="op" id="5258767">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258772">if</span>&nbsp;<span class="ident" id="5258775">sign</span>&nbsp;<span class="op" id="5258780">&lt;</span>&nbsp;<span class="num" id="5258782">0</span>&nbsp;<span class="op" id="5258784">{</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258790">break</span>&nbsp;<span class="ident" id="5258796">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5258804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258809">sign</span>&nbsp;<span class="op" id="5258814">=</span>&nbsp;<span class="op" id="5258816">-</span><span class="num" id="5258817">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5258822">//&nbsp;Invert&nbsp;flags&nbsp;so&nbsp;that&nbsp;|&nbsp;above&nbsp;turn&nbsp;into&nbsp;&amp;^&nbsp;and&nbsp;vice&nbsp;versa.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5258886">//&nbsp;We&#39;ll&nbsp;invert&nbsp;flags&nbsp;again&nbsp;before&nbsp;using&nbsp;it&nbsp;below.</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258940">flags</span>&nbsp;<span class="op" id="5258946">=</span>&nbsp;<span class="op" id="5258948">^</span><span class="ident" id="5258949">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258958">sawFlag</span>&nbsp;<span class="op" id="5258966">=</span>&nbsp;<span class="ident" id="5258968">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5258977">//&nbsp;End&nbsp;of&nbsp;flags,&nbsp;starting&nbsp;group&nbsp;or&nbsp;not.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259019">case</span>&nbsp;<span class="string" id="5259024">&#39;:&#39;</span><span class="op" id="5259027">,</span>&nbsp;<span class="string" id="5259029">&#39;)&#39;</span><span class="op" id="5259032">:</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259037">if</span>&nbsp;<span class="ident" id="5259040">sign</span>&nbsp;<span class="op" id="5259045">&lt;</span>&nbsp;<span class="num" id="5259047">0</span>&nbsp;<span class="op" id="5259049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259055">if</span>&nbsp;<span class="op" id="5259058">!</span><span class="ident" id="5259059">sawFlag</span>&nbsp;<span class="op" id="5259067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259074">break</span>&nbsp;<span class="ident" id="5259080">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5259089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5259095">flags</span>&nbsp;<span class="op" id="5259101">=</span>&nbsp;<span class="op" id="5259103">^</span><span class="ident" id="5259104">flags</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5259113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259118">if</span>&nbsp;<span class="ident" id="5259121">c</span>&nbsp;<span class="op" id="5259123">==</span>&nbsp;<span class="string" id="5259126">&#39;:&#39;</span>&nbsp;<span class="op" id="5259130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5259136">//&nbsp;Open&nbsp;new&nbsp;group</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5259158">p</span><span class="op" id="5259159">.</span><span class="ident" id="5259160">op</span><span class="op" id="5259162">(</span><span class="ident" id="5259163">opLeftParen</span><span class="op" id="5259174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5259179">}</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5259184">p</span><span class="op" id="5259185">.</span><span class="ident" id="5259186">flags</span>&nbsp;<span class="op" id="5259192">=</span>&nbsp;<span class="ident" id="5259194">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259203">return</span>&nbsp;<span class="ident" id="5259210">t</span><span class="op" id="5259211">,</span>&nbsp;<span class="ident" id="5259213">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5259219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5259222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259226">return</span>&nbsp;<span class="string" id="5259233">&#34;&#34;</span><span class="op" id="5259235">,</span>&nbsp;<span class="op" id="5259237">&amp;</span><span class="ident" id="5259238">Error</span><span class="op" id="5259243">{</span><span class="ident" id="5259244">ErrInvalidPerlOp</span><span class="op" id="5259260">,</span>&nbsp;<span class="ident" id="5259262">s</span><span class="op" id="5259263">[</span><span class="op" id="5259264">:</span><span class="builtinfunc" id="5259265">len</span><span class="op" id="5259268">(</span><span class="ident" id="5259269">s</span><span class="op" id="5259270">)</span><span class="op" id="5259271">-</span><span class="builtinfunc" id="5259272">len</span><span class="op" id="5259275">(</span><span class="ident" id="5259276">t</span><span class="op" id="5259277">)</span><span class="op" id="5259278">]</span><span class="op" id="5259279">}</span><br>
<span class="lineno"></span><span class="op" id="5259281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5259284">//&nbsp;isValidCaptureName&nbsp;reports&nbsp;whether&nbsp;name</span><br>
<span class="lineno"></span><span class="comment" id="5259327">//&nbsp;is&nbsp;a&nbsp;valid&nbsp;capture&nbsp;name:&nbsp;[A-Za-z0-9_]+.</span><br>
<span class="lineno">1040</span><span class="comment" id="5259370">//&nbsp;PCRE&nbsp;limits&nbsp;names&nbsp;to&nbsp;32&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="5259404">//&nbsp;Python&nbsp;rejects&nbsp;names&nbsp;starting&nbsp;with&nbsp;digits.</span><br>
<span class="lineno"></span><span class="comment" id="5259450">//&nbsp;We&nbsp;don&#39;t&nbsp;enforce&nbsp;either&nbsp;of&nbsp;those.</span><br>
<span class="lineno"></span><span class="keyword" id="5259487">func</span>&nbsp;<span class="ident" id="5259492">isValidCaptureName</span><span class="op" id="5259510">(</span><span class="ident" id="5259511">name</span>&nbsp;<span class="builtintype" id="5259516">string</span><span class="op" id="5259522">)</span>&nbsp;<span class="builtintype" id="5259524">bool</span>&nbsp;<span class="op" id="5259529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259532">if</span>&nbsp;<span class="ident" id="5259535">name</span>&nbsp;<span class="op" id="5259540">==</span>&nbsp;<span class="string" id="5259543">&#34;&#34;</span>&nbsp;<span class="op" id="5259546">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259550">return</span>&nbsp;<span class="ident" id="5259557">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5259564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259567">for</span>&nbsp;<span class="ident" id="5259571">_</span><span class="op" id="5259572">,</span>&nbsp;<span class="ident" id="5259574">c</span>&nbsp;<span class="op" id="5259576">:=</span>&nbsp;<span class="keyword" id="5259579">range</span>&nbsp;<span class="ident" id="5259585">name</span>&nbsp;<span class="op" id="5259590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259594">if</span>&nbsp;<span class="ident" id="5259597">c</span>&nbsp;<span class="op" id="5259599">!=</span>&nbsp;<span class="string" id="5259602">&#39;_&#39;</span>&nbsp;<span class="op" id="5259606">&amp;&amp;</span>&nbsp;<span class="op" id="5259609">!</span><span class="ident" id="5259610">isalnum</span><span class="op" id="5259617">(</span><span class="ident" id="5259618">c</span><span class="op" id="5259619">)</span>&nbsp;<span class="op" id="5259621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259626">return</span>&nbsp;<span class="ident" id="5259633">false</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5259641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5259644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259647">return</span>&nbsp;<span class="ident" id="5259654">true</span><br>
<span class="lineno"></span><span class="op" id="5259659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span><span class="comment" id="5259662">//&nbsp;parseInt&nbsp;parses&nbsp;a&nbsp;decimal&nbsp;integer.</span><br>
<span class="lineno"></span><span class="keyword" id="5259700">func</span>&nbsp;<span class="op" id="5259705">(</span><span class="ident" id="5259706">p</span>&nbsp;<span class="op" id="5259708">*</span><span class="ident" id="5259709">parser</span><span class="op" id="5259715">)</span>&nbsp;<span class="ident" id="5259717">parseInt</span><span class="op" id="5259725">(</span><span class="ident" id="5259726">s</span>&nbsp;<span class="builtintype" id="5259728">string</span><span class="op" id="5259734">)</span>&nbsp;<span class="op" id="5259736">(</span><span class="ident" id="5259737">n</span>&nbsp;<span class="builtintype" id="5259739">int</span><span class="op" id="5259742">,</span>&nbsp;<span class="ident" id="5259744">rest</span>&nbsp;<span class="builtintype" id="5259749">string</span><span class="op" id="5259755">,</span>&nbsp;<span class="ident" id="5259757">ok</span>&nbsp;<span class="builtintype" id="5259760">bool</span><span class="op" id="5259764">)</span>&nbsp;<span class="op" id="5259766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259769">if</span>&nbsp;<span class="ident" id="5259772">s</span>&nbsp;<span class="op" id="5259774">==</span>&nbsp;<span class="string" id="5259777">&#34;&#34;</span>&nbsp;<span class="op" id="5259780">||</span>&nbsp;<span class="ident" id="5259783">s</span><span class="op" id="5259784">[</span><span class="num" id="5259785">0</span><span class="op" id="5259786">]</span>&nbsp;<span class="op" id="5259788">&lt;</span>&nbsp;<span class="string" id="5259790">&#39;0&#39;</span>&nbsp;<span class="op" id="5259794">||</span>&nbsp;<span class="string" id="5259797">&#39;9&#39;</span>&nbsp;<span class="op" id="5259801">&lt;</span>&nbsp;<span class="ident" id="5259803">s</span><span class="op" id="5259804">[</span><span class="num" id="5259805">0</span><span class="op" id="5259806">]</span>&nbsp;<span class="op" id="5259808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259812">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5259820">}</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5259823">//&nbsp;Disallow&nbsp;leading&nbsp;zeros.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259851">if</span>&nbsp;<span class="builtinfunc" id="5259854">len</span><span class="op" id="5259857">(</span><span class="ident" id="5259858">s</span><span class="op" id="5259859">)</span>&nbsp;<span class="op" id="5259861">&gt;=</span>&nbsp;<span class="num" id="5259864">2</span>&nbsp;<span class="op" id="5259866">&amp;&amp;</span>&nbsp;<span class="ident" id="5259869">s</span><span class="op" id="5259870">[</span><span class="num" id="5259871">0</span><span class="op" id="5259872">]</span>&nbsp;<span class="op" id="5259874">==</span>&nbsp;<span class="string" id="5259877">&#39;0&#39;</span>&nbsp;<span class="op" id="5259881">&amp;&amp;</span>&nbsp;<span class="string" id="5259884">&#39;0&#39;</span>&nbsp;<span class="op" id="5259888">&lt;=</span>&nbsp;<span class="ident" id="5259891">s</span><span class="op" id="5259892">[</span><span class="num" id="5259893">1</span><span class="op" id="5259894">]</span>&nbsp;<span class="op" id="5259896">&amp;&amp;</span>&nbsp;<span class="ident" id="5259899">s</span><span class="op" id="5259900">[</span><span class="num" id="5259901">1</span><span class="op" id="5259902">]</span>&nbsp;<span class="op" id="5259904">&lt;=</span>&nbsp;<span class="string" id="5259907">&#39;9&#39;</span>&nbsp;<span class="op" id="5259911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259915">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5259923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5259926">t</span>&nbsp;<span class="op" id="5259928">:=</span>&nbsp;<span class="ident" id="5259931">s</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259934">for</span>&nbsp;<span class="ident" id="5259938">s</span>&nbsp;<span class="op" id="5259940">!=</span>&nbsp;<span class="string" id="5259943">&#34;&#34;</span>&nbsp;<span class="op" id="5259946">&amp;&amp;</span>&nbsp;<span class="string" id="5259949">&#39;0&#39;</span>&nbsp;<span class="op" id="5259953">&lt;=</span>&nbsp;<span class="ident" id="5259956">s</span><span class="op" id="5259957">[</span><span class="num" id="5259958">0</span><span class="op" id="5259959">]</span>&nbsp;<span class="op" id="5259961">&amp;&amp;</span>&nbsp;<span class="ident" id="5259964">s</span><span class="op" id="5259965">[</span><span class="num" id="5259966">0</span><span class="op" id="5259967">]</span>&nbsp;<span class="op" id="5259969">&lt;=</span>&nbsp;<span class="string" id="5259972">&#39;9&#39;</span>&nbsp;<span class="op" id="5259976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5259980">s</span>&nbsp;<span class="op" id="5259982">=</span>&nbsp;<span class="ident" id="5259984">s</span><span class="op" id="5259985">[</span><span class="num" id="5259986">1</span><span class="op" id="5259987">:</span><span class="op" id="5259988">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5259991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5259994">rest</span>&nbsp;<span class="op" id="5259999">=</span>&nbsp;<span class="ident" id="5260001">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5260004">ok</span>&nbsp;<span class="op" id="5260007">=</span>&nbsp;<span class="ident" id="5260009">true</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5260015">//&nbsp;Have&nbsp;digits,&nbsp;compute&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5260047">t</span>&nbsp;<span class="op" id="5260049">=</span>&nbsp;<span class="ident" id="5260051">t</span><span class="op" id="5260052">[</span><span class="op" id="5260053">:</span><span class="builtinfunc" id="5260054">len</span><span class="op" id="5260057">(</span><span class="ident" id="5260058">t</span><span class="op" id="5260059">)</span><span class="op" id="5260060">-</span><span class="builtinfunc" id="5260061">len</span><span class="op" id="5260064">(</span><span class="ident" id="5260065">s</span><span class="op" id="5260066">)</span><span class="op" id="5260067">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260070">for</span>&nbsp;<span class="ident" id="5260074">i</span>&nbsp;<span class="op" id="5260076">:=</span>&nbsp;<span class="num" id="5260079">0</span><span class="op" id="5260080">;</span>&nbsp;<span class="ident" id="5260082">i</span>&nbsp;<span class="op" id="5260084">&lt;</span>&nbsp;<span class="builtinfunc" id="5260086">len</span><span class="op" id="5260089">(</span><span class="ident" id="5260090">t</span><span class="op" id="5260091">)</span><span class="op" id="5260092">;</span>&nbsp;<span class="ident" id="5260094">i</span><span class="op" id="5260095">++</span>&nbsp;<span class="op" id="5260098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5260102">//&nbsp;Avoid&nbsp;overflow.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260123">if</span>&nbsp;<span class="ident" id="5260126">n</span>&nbsp;<span class="op" id="5260128">&gt;=</span>&nbsp;<span class="num" id="5260131">1e8</span>&nbsp;<span class="op" id="5260135">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5260140">n</span>&nbsp;<span class="op" id="5260142">=</span>&nbsp;<span class="op" id="5260144">-</span><span class="num" id="5260145">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260150">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5260158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5260162">n</span>&nbsp;<span class="op" id="5260164">=</span>&nbsp;<span class="ident" id="5260166">n</span><span class="op" id="5260167">*</span><span class="num" id="5260168">10</span>&nbsp;<span class="op" id="5260171">+</span>&nbsp;<span class="builtintype" id="5260173">int</span><span class="op" id="5260176">(</span><span class="ident" id="5260177">t</span><span class="op" id="5260178">[</span><span class="ident" id="5260179">i</span><span class="op" id="5260180">]</span><span class="op" id="5260181">)</span>&nbsp;<span class="op" id="5260183">-</span>&nbsp;<span class="string" id="5260185">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5260190">}</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260193">return</span><br>
<span class="lineno"></span><span class="op" id="5260200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5260203">//&nbsp;can&nbsp;this&nbsp;be&nbsp;represented&nbsp;as&nbsp;a&nbsp;character&nbsp;class?</span><br>
<span class="lineno"></span><span class="comment" id="5260252">//&nbsp;single-rune&nbsp;literal&nbsp;string,&nbsp;char&nbsp;class,&nbsp;.,&nbsp;and&nbsp;.|\n.</span><br>
<span class="lineno">1085</span><span class="keyword" id="5260308">func</span>&nbsp;<span class="ident" id="5260313">isCharClass</span><span class="op" id="5260324">(</span><span class="ident" id="5260325">re</span>&nbsp;<span class="op" id="5260328">*</span><span class="ident" id="5260329">Regexp</span><span class="op" id="5260335">)</span>&nbsp;<span class="builtintype" id="5260337">bool</span>&nbsp;<span class="op" id="5260342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260345">return</span>&nbsp;<span class="ident" id="5260352">re</span><span class="op" id="5260354">.</span><span class="ident" id="5260355">Op</span>&nbsp;<span class="op" id="5260358">==</span>&nbsp;<span class="ident" id="5260361">OpLiteral</span>&nbsp;<span class="op" id="5260371">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5260374">len</span><span class="op" id="5260377">(</span><span class="ident" id="5260378">re</span><span class="op" id="5260380">.</span><span class="ident" id="5260381">Rune</span><span class="op" id="5260385">)</span>&nbsp;<span class="op" id="5260387">==</span>&nbsp;<span class="num" id="5260390">1</span>&nbsp;<span class="op" id="5260392">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5260397">re</span><span class="op" id="5260399">.</span><span class="ident" id="5260400">Op</span>&nbsp;<span class="op" id="5260403">==</span>&nbsp;<span class="ident" id="5260406">OpCharClass</span>&nbsp;<span class="op" id="5260418">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5260423">re</span><span class="op" id="5260425">.</span><span class="ident" id="5260426">Op</span>&nbsp;<span class="op" id="5260429">==</span>&nbsp;<span class="ident" id="5260432">OpAnyCharNotNL</span>&nbsp;<span class="op" id="5260447">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5260452">re</span><span class="op" id="5260454">.</span><span class="ident" id="5260455">Op</span>&nbsp;<span class="op" id="5260458">==</span>&nbsp;<span class="ident" id="5260461">OpAnyChar</span><br>
<span class="lineno">1090</span><span class="op" id="5260471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5260474">//&nbsp;does&nbsp;re&nbsp;match&nbsp;r?</span><br>
<span class="lineno"></span><span class="keyword" id="5260494">func</span>&nbsp;<span class="ident" id="5260499">matchRune</span><span class="op" id="5260508">(</span><span class="ident" id="5260509">re</span>&nbsp;<span class="op" id="5260512">*</span><span class="ident" id="5260513">Regexp</span><span class="op" id="5260519">,</span>&nbsp;<span class="ident" id="5260521">r</span>&nbsp;<span class="builtintype" id="5260523">rune</span><span class="op" id="5260527">)</span>&nbsp;<span class="builtintype" id="5260529">bool</span>&nbsp;<span class="op" id="5260534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260537">switch</span>&nbsp;<span class="ident" id="5260544">re</span><span class="op" id="5260546">.</span><span class="ident" id="5260547">Op</span>&nbsp;<span class="op" id="5260550">{</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260553">case</span>&nbsp;<span class="ident" id="5260558">OpLiteral</span><span class="op" id="5260567">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260571">return</span>&nbsp;<span class="builtinfunc" id="5260578">len</span><span class="op" id="5260581">(</span><span class="ident" id="5260582">re</span><span class="op" id="5260584">.</span><span class="ident" id="5260585">Rune</span><span class="op" id="5260589">)</span>&nbsp;<span class="op" id="5260591">==</span>&nbsp;<span class="num" id="5260594">1</span>&nbsp;<span class="op" id="5260596">&amp;&amp;</span>&nbsp;<span class="ident" id="5260599">re</span><span class="op" id="5260601">.</span><span class="ident" id="5260602">Rune</span><span class="op" id="5260606">[</span><span class="num" id="5260607">0</span><span class="op" id="5260608">]</span>&nbsp;<span class="op" id="5260610">==</span>&nbsp;<span class="ident" id="5260613">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260616">case</span>&nbsp;<span class="ident" id="5260621">OpCharClass</span><span class="op" id="5260632">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260636">for</span>&nbsp;<span class="ident" id="5260640">i</span>&nbsp;<span class="op" id="5260642">:=</span>&nbsp;<span class="num" id="5260645">0</span><span class="op" id="5260646">;</span>&nbsp;<span class="ident" id="5260648">i</span>&nbsp;<span class="op" id="5260650">&lt;</span>&nbsp;<span class="builtinfunc" id="5260652">len</span><span class="op" id="5260655">(</span><span class="ident" id="5260656">re</span><span class="op" id="5260658">.</span><span class="ident" id="5260659">Rune</span><span class="op" id="5260663">)</span><span class="op" id="5260664">;</span>&nbsp;<span class="ident" id="5260666">i</span>&nbsp;<span class="op" id="5260668">+=</span>&nbsp;<span class="num" id="5260671">2</span>&nbsp;<span class="op" id="5260673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260678">if</span>&nbsp;<span class="ident" id="5260681">re</span><span class="op" id="5260683">.</span><span class="ident" id="5260684">Rune</span><span class="op" id="5260688">[</span><span class="ident" id="5260689">i</span><span class="op" id="5260690">]</span>&nbsp;<span class="op" id="5260692">&lt;=</span>&nbsp;<span class="ident" id="5260695">r</span>&nbsp;<span class="op" id="5260697">&amp;&amp;</span>&nbsp;<span class="ident" id="5260700">r</span>&nbsp;<span class="op" id="5260702">&lt;=</span>&nbsp;<span class="ident" id="5260705">re</span><span class="op" id="5260707">.</span><span class="ident" id="5260708">Rune</span><span class="op" id="5260712">[</span><span class="ident" id="5260713">i</span><span class="op" id="5260714">+</span><span class="num" id="5260715">1</span><span class="op" id="5260716">]</span>&nbsp;<span class="op" id="5260718">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260724">return</span>&nbsp;<span class="ident" id="5260731">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5260739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5260743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260747">return</span>&nbsp;<span class="ident" id="5260754">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260761">case</span>&nbsp;<span class="ident" id="5260766">OpAnyCharNotNL</span><span class="op" id="5260780">:</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260784">return</span>&nbsp;<span class="ident" id="5260791">r</span>&nbsp;<span class="op" id="5260793">!=</span>&nbsp;<span class="string" id="5260796">&#39;\n&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260802">case</span>&nbsp;<span class="ident" id="5260807">OpAnyChar</span><span class="op" id="5260816">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260820">return</span>&nbsp;<span class="ident" id="5260827">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5260833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260836">return</span>&nbsp;<span class="ident" id="5260843">false</span><br>
<span class="lineno">1110</span><span class="op" id="5260849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5260852">//&nbsp;parseVerticalBar&nbsp;handles&nbsp;a&nbsp;|&nbsp;in&nbsp;the&nbsp;input.</span><br>
<span class="lineno"></span><span class="keyword" id="5260898">func</span>&nbsp;<span class="op" id="5260903">(</span><span class="ident" id="5260904">p</span>&nbsp;<span class="op" id="5260906">*</span><span class="ident" id="5260907">parser</span><span class="op" id="5260913">)</span>&nbsp;<span class="ident" id="5260915">parseVerticalBar</span><span class="op" id="5260931">(</span><span class="op" id="5260932">)</span>&nbsp;<span class="builtintype" id="5260934">error</span>&nbsp;<span class="op" id="5260940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5260943">p</span><span class="op" id="5260944">.</span><span class="ident" id="5260945">concat</span><span class="op" id="5260951">(</span><span class="op" id="5260952">)</span><br>
<span class="lineno">1115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5260956">//&nbsp;The&nbsp;concatenation&nbsp;we&nbsp;just&nbsp;parsed&nbsp;is&nbsp;on&nbsp;top&nbsp;of&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5261017">//&nbsp;If&nbsp;it&nbsp;sits&nbsp;above&nbsp;an&nbsp;opVerticalBar,&nbsp;swap&nbsp;it&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5261070">//&nbsp;(things&nbsp;below&nbsp;an&nbsp;opVerticalBar&nbsp;become&nbsp;an&nbsp;alternation).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5261129">//&nbsp;Otherwise,&nbsp;push&nbsp;a&nbsp;new&nbsp;vertical&nbsp;bar.</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261169">if</span>&nbsp;<span class="op" id="5261172">!</span><span class="ident" id="5261173">p</span><span class="op" id="5261174">.</span><span class="ident" id="5261175">swapVerticalBar</span><span class="op" id="5261190">(</span><span class="op" id="5261191">)</span>&nbsp;<span class="op" id="5261193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261197">p</span><span class="op" id="5261198">.</span><span class="ident" id="5261199">op</span><span class="op" id="5261201">(</span><span class="ident" id="5261202">opVerticalBar</span><span class="op" id="5261215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5261218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261222">return</span>&nbsp;<span class="ident" id="5261229">nil</span><br>
<span class="lineno">1125</span><span class="op" id="5261233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5261236">//&nbsp;mergeCharClass&nbsp;makes&nbsp;dst&nbsp;=&nbsp;dst|src.</span><br>
<span class="lineno"></span><span class="comment" id="5261275">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;ensure&nbsp;that&nbsp;dst.Op&nbsp;&gt;=&nbsp;src.Op,</span><br>
<span class="lineno"></span><span class="comment" id="5261324">//&nbsp;to&nbsp;reduce&nbsp;the&nbsp;amount&nbsp;of&nbsp;copying.</span><br>
<span class="lineno">1130</span><span class="keyword" id="5261360">func</span>&nbsp;<span class="ident" id="5261365">mergeCharClass</span><span class="op" id="5261379">(</span><span class="ident" id="5261380">dst</span><span class="op" id="5261383">,</span>&nbsp;<span class="ident" id="5261385">src</span>&nbsp;<span class="op" id="5261389">*</span><span class="ident" id="5261390">Regexp</span><span class="op" id="5261396">)</span>&nbsp;<span class="op" id="5261398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261401">switch</span>&nbsp;<span class="ident" id="5261408">dst</span><span class="op" id="5261411">.</span><span class="ident" id="5261412">Op</span>&nbsp;<span class="op" id="5261415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261418">case</span>&nbsp;<span class="ident" id="5261423">OpAnyChar</span><span class="op" id="5261432">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5261436">//&nbsp;src&nbsp;doesn&#39;t&nbsp;add&nbsp;anything.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261466">case</span>&nbsp;<span class="ident" id="5261471">OpAnyCharNotNL</span><span class="op" id="5261485">:</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5261489">//&nbsp;src&nbsp;might&nbsp;add&nbsp;\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261511">if</span>&nbsp;<span class="ident" id="5261514">matchRune</span><span class="op" id="5261523">(</span><span class="ident" id="5261524">src</span><span class="op" id="5261527">,</span>&nbsp;<span class="string" id="5261529">&#39;\n&#39;</span><span class="op" id="5261533">)</span>&nbsp;<span class="op" id="5261535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261540">dst</span><span class="op" id="5261543">.</span><span class="ident" id="5261544">Op</span>&nbsp;<span class="op" id="5261547">=</span>&nbsp;<span class="ident" id="5261549">OpAnyChar</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5261561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261564">case</span>&nbsp;<span class="ident" id="5261569">OpCharClass</span><span class="op" id="5261580">:</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5261584">//&nbsp;src&nbsp;is&nbsp;simpler,&nbsp;so&nbsp;either&nbsp;literal&nbsp;or&nbsp;char&nbsp;class</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261637">if</span>&nbsp;<span class="ident" id="5261640">src</span><span class="op" id="5261643">.</span><span class="ident" id="5261644">Op</span>&nbsp;<span class="op" id="5261647">==</span>&nbsp;<span class="ident" id="5261650">OpLiteral</span>&nbsp;<span class="op" id="5261660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261665">dst</span><span class="op" id="5261668">.</span><span class="ident" id="5261669">Rune</span>&nbsp;<span class="op" id="5261674">=</span>&nbsp;<span class="ident" id="5261676">appendLiteral</span><span class="op" id="5261689">(</span><span class="ident" id="5261690">dst</span><span class="op" id="5261693">.</span><span class="ident" id="5261694">Rune</span><span class="op" id="5261698">,</span>&nbsp;<span class="ident" id="5261700">src</span><span class="op" id="5261703">.</span><span class="ident" id="5261704">Rune</span><span class="op" id="5261708">[</span><span class="num" id="5261709">0</span><span class="op" id="5261710">]</span><span class="op" id="5261711">,</span>&nbsp;<span class="ident" id="5261713">src</span><span class="op" id="5261716">.</span><span class="ident" id="5261717">Flags</span><span class="op" id="5261722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5261726">}</span>&nbsp;<span class="keyword" id="5261728">else</span>&nbsp;<span class="op" id="5261733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261738">dst</span><span class="op" id="5261741">.</span><span class="ident" id="5261742">Rune</span>&nbsp;<span class="op" id="5261747">=</span>&nbsp;<span class="ident" id="5261749">appendClass</span><span class="op" id="5261760">(</span><span class="ident" id="5261761">dst</span><span class="op" id="5261764">.</span><span class="ident" id="5261765">Rune</span><span class="op" id="5261769">,</span>&nbsp;<span class="ident" id="5261771">src</span><span class="op" id="5261774">.</span><span class="ident" id="5261775">Rune</span><span class="op" id="5261779">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5261783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261786">case</span>&nbsp;<span class="ident" id="5261791">OpLiteral</span><span class="op" id="5261800">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5261804">//&nbsp;both&nbsp;literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261822">if</span>&nbsp;<span class="ident" id="5261825">src</span><span class="op" id="5261828">.</span><span class="ident" id="5261829">Rune</span><span class="op" id="5261833">[</span><span class="num" id="5261834">0</span><span class="op" id="5261835">]</span>&nbsp;<span class="op" id="5261837">==</span>&nbsp;<span class="ident" id="5261840">dst</span><span class="op" id="5261843">.</span><span class="ident" id="5261844">Rune</span><span class="op" id="5261848">[</span><span class="num" id="5261849">0</span><span class="op" id="5261850">]</span>&nbsp;<span class="op" id="5261852">&amp;&amp;</span>&nbsp;<span class="ident" id="5261855">src</span><span class="op" id="5261858">.</span><span class="ident" id="5261859">Flags</span>&nbsp;<span class="op" id="5261865">==</span>&nbsp;<span class="ident" id="5261868">dst</span><span class="op" id="5261871">.</span><span class="ident" id="5261872">Flags</span>&nbsp;<span class="op" id="5261878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261883">break</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5261891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261895">dst</span><span class="op" id="5261898">.</span><span class="ident" id="5261899">Op</span>&nbsp;<span class="op" id="5261902">=</span>&nbsp;<span class="ident" id="5261904">OpCharClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261918">dst</span><span class="op" id="5261921">.</span><span class="ident" id="5261922">Rune</span>&nbsp;<span class="op" id="5261927">=</span>&nbsp;<span class="ident" id="5261929">appendLiteral</span><span class="op" id="5261942">(</span><span class="ident" id="5261943">dst</span><span class="op" id="5261946">.</span><span class="ident" id="5261947">Rune</span><span class="op" id="5261951">[</span><span class="op" id="5261952">:</span><span class="num" id="5261953">0</span><span class="op" id="5261954">]</span><span class="op" id="5261955">,</span>&nbsp;<span class="ident" id="5261957">dst</span><span class="op" id="5261960">.</span><span class="ident" id="5261961">Rune</span><span class="op" id="5261965">[</span><span class="num" id="5261966">0</span><span class="op" id="5261967">]</span><span class="op" id="5261968">,</span>&nbsp;<span class="ident" id="5261970">dst</span><span class="op" id="5261973">.</span><span class="ident" id="5261974">Flags</span><span class="op" id="5261979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261983">dst</span><span class="op" id="5261986">.</span><span class="ident" id="5261987">Rune</span>&nbsp;<span class="op" id="5261992">=</span>&nbsp;<span class="ident" id="5261994">appendLiteral</span><span class="op" id="5262007">(</span><span class="ident" id="5262008">dst</span><span class="op" id="5262011">.</span><span class="ident" id="5262012">Rune</span><span class="op" id="5262016">,</span>&nbsp;<span class="ident" id="5262018">src</span><span class="op" id="5262021">.</span><span class="ident" id="5262022">Rune</span><span class="op" id="5262026">[</span><span class="num" id="5262027">0</span><span class="op" id="5262028">]</span><span class="op" id="5262029">,</span>&nbsp;<span class="ident" id="5262031">src</span><span class="op" id="5262034">.</span><span class="ident" id="5262035">Flags</span><span class="op" id="5262040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5262043">}</span><br>
<span class="lineno">1155</span><span class="op" id="5262045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5262048">//&nbsp;If&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;stack&nbsp;is&nbsp;an&nbsp;element&nbsp;followed&nbsp;by&nbsp;an&nbsp;opVerticalBar</span><br>
<span class="lineno"></span><span class="comment" id="5262118">//&nbsp;swapVerticalBar&nbsp;swaps&nbsp;the&nbsp;two&nbsp;and&nbsp;returns&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="5262169">//&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;false.</span><br>
<span class="lineno">1160</span><span class="keyword" id="5262200">func</span>&nbsp;<span class="op" id="5262205">(</span><span class="ident" id="5262206">p</span>&nbsp;<span class="op" id="5262208">*</span><span class="ident" id="5262209">parser</span><span class="op" id="5262215">)</span>&nbsp;<span class="ident" id="5262217">swapVerticalBar</span><span class="op" id="5262232">(</span><span class="op" id="5262233">)</span>&nbsp;<span class="builtintype" id="5262235">bool</span>&nbsp;<span class="op" id="5262240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5262243">//&nbsp;If&nbsp;above&nbsp;and&nbsp;below&nbsp;vertical&nbsp;bar&nbsp;are&nbsp;literal&nbsp;or&nbsp;char&nbsp;class,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5262306">//&nbsp;can&nbsp;merge&nbsp;into&nbsp;a&nbsp;single&nbsp;char&nbsp;class.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262346">n</span>&nbsp;<span class="op" id="5262348">:=</span>&nbsp;<span class="builtinfunc" id="5262351">len</span><span class="op" id="5262354">(</span><span class="ident" id="5262355">p</span><span class="op" id="5262356">.</span><span class="ident" id="5262357">stack</span><span class="op" id="5262362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5262365">if</span>&nbsp;<span class="ident" id="5262368">n</span>&nbsp;<span class="op" id="5262370">&gt;=</span>&nbsp;<span class="num" id="5262373">3</span>&nbsp;<span class="op" id="5262375">&amp;&amp;</span>&nbsp;<span class="ident" id="5262378">p</span><span class="op" id="5262379">.</span><span class="ident" id="5262380">stack</span><span class="op" id="5262385">[</span><span class="ident" id="5262386">n</span><span class="op" id="5262387">-</span><span class="num" id="5262388">2</span><span class="op" id="5262389">]</span><span class="op" id="5262390">.</span><span class="ident" id="5262391">Op</span>&nbsp;<span class="op" id="5262394">==</span>&nbsp;<span class="ident" id="5262397">opVerticalBar</span>&nbsp;<span class="op" id="5262411">&amp;&amp;</span>&nbsp;<span class="ident" id="5262414">isCharClass</span><span class="op" id="5262425">(</span><span class="ident" id="5262426">p</span><span class="op" id="5262427">.</span><span class="ident" id="5262428">stack</span><span class="op" id="5262433">[</span><span class="ident" id="5262434">n</span><span class="op" id="5262435">-</span><span class="num" id="5262436">1</span><span class="op" id="5262437">]</span><span class="op" id="5262438">)</span>&nbsp;<span class="op" id="5262440">&amp;&amp;</span>&nbsp;<span class="ident" id="5262443">isCharClass</span><span class="op" id="5262454">(</span><span class="ident" id="5262455">p</span><span class="op" id="5262456">.</span><span class="ident" id="5262457">stack</span><span class="op" id="5262462">[</span><span class="ident" id="5262463">n</span><span class="op" id="5262464">-</span><span class="num" id="5262465">3</span><span class="op" id="5262466">]</span><span class="op" id="5262467">)</span>&nbsp;<span class="op" id="5262469">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262473">re1</span>&nbsp;<span class="op" id="5262477">:=</span>&nbsp;<span class="ident" id="5262480">p</span><span class="op" id="5262481">.</span><span class="ident" id="5262482">stack</span><span class="op" id="5262487">[</span><span class="ident" id="5262488">n</span><span class="op" id="5262489">-</span><span class="num" id="5262490">1</span><span class="op" id="5262491">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262495">re3</span>&nbsp;<span class="op" id="5262499">:=</span>&nbsp;<span class="ident" id="5262502">p</span><span class="op" id="5262503">.</span><span class="ident" id="5262504">stack</span><span class="op" id="5262509">[</span><span class="ident" id="5262510">n</span><span class="op" id="5262511">-</span><span class="num" id="5262512">3</span><span class="op" id="5262513">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5262517">//&nbsp;Make&nbsp;re3&nbsp;the&nbsp;more&nbsp;complex&nbsp;of&nbsp;the&nbsp;two.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5262560">if</span>&nbsp;<span class="ident" id="5262563">re1</span><span class="op" id="5262566">.</span><span class="ident" id="5262567">Op</span>&nbsp;<span class="op" id="5262570">&gt;</span>&nbsp;<span class="ident" id="5262572">re3</span><span class="op" id="5262575">.</span><span class="ident" id="5262576">Op</span>&nbsp;<span class="op" id="5262579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262584">re1</span><span class="op" id="5262587">,</span>&nbsp;<span class="ident" id="5262589">re3</span>&nbsp;<span class="op" id="5262593">=</span>&nbsp;<span class="ident" id="5262595">re3</span><span class="op" id="5262598">,</span>&nbsp;<span class="ident" id="5262600">re1</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262607">p</span><span class="op" id="5262608">.</span><span class="ident" id="5262609">stack</span><span class="op" id="5262614">[</span><span class="ident" id="5262615">n</span><span class="op" id="5262616">-</span><span class="num" id="5262617">3</span><span class="op" id="5262618">]</span>&nbsp;<span class="op" id="5262620">=</span>&nbsp;<span class="ident" id="5262622">re3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5262628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262632">mergeCharClass</span><span class="op" id="5262646">(</span><span class="ident" id="5262647">re3</span><span class="op" id="5262650">,</span>&nbsp;<span class="ident" id="5262652">re1</span><span class="op" id="5262655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262659">p</span><span class="op" id="5262660">.</span><span class="ident" id="5262661">reuse</span><span class="op" id="5262666">(</span><span class="ident" id="5262667">re1</span><span class="op" id="5262670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262674">p</span><span class="op" id="5262675">.</span><span class="ident" id="5262676">stack</span>&nbsp;<span class="op" id="5262682">=</span>&nbsp;<span class="ident" id="5262684">p</span><span class="op" id="5262685">.</span><span class="ident" id="5262686">stack</span><span class="op" id="5262691">[</span><span class="op" id="5262692">:</span><span class="ident" id="5262693">n</span><span class="op" id="5262694">-</span><span class="num" id="5262695">1</span><span class="op" id="5262696">]</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5262700">return</span>&nbsp;<span class="ident" id="5262707">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5262713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5262717">if</span>&nbsp;<span class="ident" id="5262720">n</span>&nbsp;<span class="op" id="5262722">&gt;=</span>&nbsp;<span class="num" id="5262725">2</span>&nbsp;<span class="op" id="5262727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262731">re1</span>&nbsp;<span class="op" id="5262735">:=</span>&nbsp;<span class="ident" id="5262738">p</span><span class="op" id="5262739">.</span><span class="ident" id="5262740">stack</span><span class="op" id="5262745">[</span><span class="ident" id="5262746">n</span><span class="op" id="5262747">-</span><span class="num" id="5262748">1</span><span class="op" id="5262749">]</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262753">re2</span>&nbsp;<span class="op" id="5262757">:=</span>&nbsp;<span class="ident" id="5262760">p</span><span class="op" id="5262761">.</span><span class="ident" id="5262762">stack</span><span class="op" id="5262767">[</span><span class="ident" id="5262768">n</span><span class="op" id="5262769">-</span><span class="num" id="5262770">2</span><span class="op" id="5262771">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5262775">if</span>&nbsp;<span class="ident" id="5262778">re2</span><span class="op" id="5262781">.</span><span class="ident" id="5262782">Op</span>&nbsp;<span class="op" id="5262785">==</span>&nbsp;<span class="ident" id="5262788">opVerticalBar</span>&nbsp;<span class="op" id="5262802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5262807">if</span>&nbsp;<span class="ident" id="5262810">n</span>&nbsp;<span class="op" id="5262812">&gt;=</span>&nbsp;<span class="num" id="5262815">3</span>&nbsp;<span class="op" id="5262817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5262823">//&nbsp;Now&nbsp;out&nbsp;of&nbsp;reach.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5262848">//&nbsp;Clean&nbsp;opportunistically.</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262880">cleanAlt</span><span class="op" id="5262888">(</span><span class="ident" id="5262889">p</span><span class="op" id="5262890">.</span><span class="ident" id="5262891">stack</span><span class="op" id="5262896">[</span><span class="ident" id="5262897">n</span><span class="op" id="5262898">-</span><span class="num" id="5262899">3</span><span class="op" id="5262900">]</span><span class="op" id="5262901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5262906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262911">p</span><span class="op" id="5262912">.</span><span class="ident" id="5262913">stack</span><span class="op" id="5262918">[</span><span class="ident" id="5262919">n</span><span class="op" id="5262920">-</span><span class="num" id="5262921">2</span><span class="op" id="5262922">]</span>&nbsp;<span class="op" id="5262924">=</span>&nbsp;<span class="ident" id="5262926">re1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262933">p</span><span class="op" id="5262934">.</span><span class="ident" id="5262935">stack</span><span class="op" id="5262940">[</span><span class="ident" id="5262941">n</span><span class="op" id="5262942">-</span><span class="num" id="5262943">1</span><span class="op" id="5262944">]</span>&nbsp;<span class="op" id="5262946">=</span>&nbsp;<span class="ident" id="5262948">re2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5262955">return</span>&nbsp;<span class="ident" id="5262962">true</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5262969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5262972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5262975">return</span>&nbsp;<span class="ident" id="5262982">false</span><br>
<span class="lineno"></span><span class="op" id="5262988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1195</span><span class="comment" id="5262991">//&nbsp;parseRightParen&nbsp;handles&nbsp;a&nbsp;)&nbsp;in&nbsp;the&nbsp;input.</span><br>
<span class="lineno"></span><span class="keyword" id="5263036">func</span>&nbsp;<span class="op" id="5263041">(</span><span class="ident" id="5263042">p</span>&nbsp;<span class="op" id="5263044">*</span><span class="ident" id="5263045">parser</span><span class="op" id="5263051">)</span>&nbsp;<span class="ident" id="5263053">parseRightParen</span><span class="op" id="5263068">(</span><span class="op" id="5263069">)</span>&nbsp;<span class="builtintype" id="5263071">error</span>&nbsp;<span class="op" id="5263077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263080">p</span><span class="op" id="5263081">.</span><span class="ident" id="5263082">concat</span><span class="op" id="5263088">(</span><span class="op" id="5263089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263092">if</span>&nbsp;<span class="ident" id="5263095">p</span><span class="op" id="5263096">.</span><span class="ident" id="5263097">swapVerticalBar</span><span class="op" id="5263112">(</span><span class="op" id="5263113">)</span>&nbsp;<span class="op" id="5263115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5263119">//&nbsp;pop&nbsp;vertical&nbsp;bar</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263141">p</span><span class="op" id="5263142">.</span><span class="ident" id="5263143">stack</span>&nbsp;<span class="op" id="5263149">=</span>&nbsp;<span class="ident" id="5263151">p</span><span class="op" id="5263152">.</span><span class="ident" id="5263153">stack</span><span class="op" id="5263158">[</span><span class="op" id="5263159">:</span><span class="builtinfunc" id="5263160">len</span><span class="op" id="5263163">(</span><span class="ident" id="5263164">p</span><span class="op" id="5263165">.</span><span class="ident" id="5263166">stack</span><span class="op" id="5263171">)</span><span class="op" id="5263172">-</span><span class="num" id="5263173">1</span><span class="op" id="5263174">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5263177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263180">p</span><span class="op" id="5263181">.</span><span class="ident" id="5263182">alternate</span><span class="op" id="5263191">(</span><span class="op" id="5263192">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263196">n</span>&nbsp;<span class="op" id="5263198">:=</span>&nbsp;<span class="builtinfunc" id="5263201">len</span><span class="op" id="5263204">(</span><span class="ident" id="5263205">p</span><span class="op" id="5263206">.</span><span class="ident" id="5263207">stack</span><span class="op" id="5263212">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263215">if</span>&nbsp;<span class="ident" id="5263218">n</span>&nbsp;<span class="op" id="5263220">&lt;</span>&nbsp;<span class="num" id="5263222">2</span>&nbsp;<span class="op" id="5263224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263228">return</span>&nbsp;<span class="op" id="5263235">&amp;</span><span class="ident" id="5263236">Error</span><span class="op" id="5263241">{</span><span class="ident" id="5263242">ErrUnexpectedParen</span><span class="op" id="5263260">,</span>&nbsp;<span class="ident" id="5263262">p</span><span class="op" id="5263263">.</span><span class="ident" id="5263264">wholeRegexp</span><span class="op" id="5263275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5263278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263281">re1</span>&nbsp;<span class="op" id="5263285">:=</span>&nbsp;<span class="ident" id="5263288">p</span><span class="op" id="5263289">.</span><span class="ident" id="5263290">stack</span><span class="op" id="5263295">[</span><span class="ident" id="5263296">n</span><span class="op" id="5263297">-</span><span class="num" id="5263298">1</span><span class="op" id="5263299">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263302">re2</span>&nbsp;<span class="op" id="5263306">:=</span>&nbsp;<span class="ident" id="5263309">p</span><span class="op" id="5263310">.</span><span class="ident" id="5263311">stack</span><span class="op" id="5263316">[</span><span class="ident" id="5263317">n</span><span class="op" id="5263318">-</span><span class="num" id="5263319">2</span><span class="op" id="5263320">]</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263323">p</span><span class="op" id="5263324">.</span><span class="ident" id="5263325">stack</span>&nbsp;<span class="op" id="5263331">=</span>&nbsp;<span class="ident" id="5263333">p</span><span class="op" id="5263334">.</span><span class="ident" id="5263335">stack</span><span class="op" id="5263340">[</span><span class="op" id="5263341">:</span><span class="ident" id="5263342">n</span><span class="op" id="5263343">-</span><span class="num" id="5263344">2</span><span class="op" id="5263345">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263348">if</span>&nbsp;<span class="ident" id="5263351">re2</span><span class="op" id="5263354">.</span><span class="ident" id="5263355">Op</span>&nbsp;<span class="op" id="5263358">!=</span>&nbsp;<span class="ident" id="5263361">opLeftParen</span>&nbsp;<span class="op" id="5263373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263377">return</span>&nbsp;<span class="op" id="5263384">&amp;</span><span class="ident" id="5263385">Error</span><span class="op" id="5263390">{</span><span class="ident" id="5263391">ErrUnexpectedParen</span><span class="op" id="5263409">,</span>&nbsp;<span class="ident" id="5263411">p</span><span class="op" id="5263412">.</span><span class="ident" id="5263413">wholeRegexp</span><span class="op" id="5263424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5263427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5263430">//&nbsp;Restore&nbsp;flags&nbsp;at&nbsp;time&nbsp;of&nbsp;paren.</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263466">p</span><span class="op" id="5263467">.</span><span class="ident" id="5263468">flags</span>&nbsp;<span class="op" id="5263474">=</span>&nbsp;<span class="ident" id="5263476">re2</span><span class="op" id="5263479">.</span><span class="ident" id="5263480">Flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263487">if</span>&nbsp;<span class="ident" id="5263490">re2</span><span class="op" id="5263493">.</span><span class="ident" id="5263494">Cap</span>&nbsp;<span class="op" id="5263498">==</span>&nbsp;<span class="num" id="5263501">0</span>&nbsp;<span class="op" id="5263503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5263507">//&nbsp;Just&nbsp;for&nbsp;grouping.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263531">p</span><span class="op" id="5263532">.</span><span class="ident" id="5263533">push</span><span class="op" id="5263537">(</span><span class="ident" id="5263538">re1</span><span class="op" id="5263541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5263544">}</span>&nbsp;<span class="keyword" id="5263546">else</span>&nbsp;<span class="op" id="5263551">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263555">re2</span><span class="op" id="5263558">.</span><span class="ident" id="5263559">Op</span>&nbsp;<span class="op" id="5263562">=</span>&nbsp;<span class="ident" id="5263564">OpCapture</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263576">re2</span><span class="op" id="5263579">.</span><span class="ident" id="5263580">Sub</span>&nbsp;<span class="op" id="5263584">=</span>&nbsp;<span class="ident" id="5263586">re2</span><span class="op" id="5263589">.</span><span class="ident" id="5263590">Sub0</span><span class="op" id="5263594">[</span><span class="op" id="5263595">:</span><span class="num" id="5263596">1</span><span class="op" id="5263597">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263601">re2</span><span class="op" id="5263604">.</span><span class="ident" id="5263605">Sub</span><span class="op" id="5263608">[</span><span class="num" id="5263609">0</span><span class="op" id="5263610">]</span>&nbsp;<span class="op" id="5263612">=</span>&nbsp;<span class="ident" id="5263614">re1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263620">p</span><span class="op" id="5263621">.</span><span class="ident" id="5263622">push</span><span class="op" id="5263626">(</span><span class="ident" id="5263627">re2</span><span class="op" id="5263630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5263633">}</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263636">return</span>&nbsp;<span class="ident" id="5263643">nil</span><br>
<span class="lineno"></span><span class="op" id="5263647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5263650">//&nbsp;parseEscape&nbsp;parses&nbsp;an&nbsp;escape&nbsp;sequence&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s</span><br>
<span class="lineno"></span><span class="comment" id="5263713">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;rune.</span><br>
<span class="lineno">1230</span><span class="keyword" id="5263738">func</span>&nbsp;<span class="op" id="5263743">(</span><span class="ident" id="5263744">p</span>&nbsp;<span class="op" id="5263746">*</span><span class="ident" id="5263747">parser</span><span class="op" id="5263753">)</span>&nbsp;<span class="ident" id="5263755">parseEscape</span><span class="op" id="5263766">(</span><span class="ident" id="5263767">s</span>&nbsp;<span class="builtintype" id="5263769">string</span><span class="op" id="5263775">)</span>&nbsp;<span class="op" id="5263777">(</span><span class="ident" id="5263778">r</span>&nbsp;<span class="builtintype" id="5263780">rune</span><span class="op" id="5263784">,</span>&nbsp;<span class="ident" id="5263786">rest</span>&nbsp;<span class="builtintype" id="5263791">string</span><span class="op" id="5263797">,</span>&nbsp;<span class="ident" id="5263799">err</span>&nbsp;<span class="builtintype" id="5263803">error</span><span class="op" id="5263808">)</span>&nbsp;<span class="op" id="5263810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263813">t</span>&nbsp;<span class="op" id="5263815">:=</span>&nbsp;<span class="ident" id="5263818">s</span><span class="op" id="5263819">[</span><span class="num" id="5263820">1</span><span class="op" id="5263821">:</span><span class="op" id="5263822">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263825">if</span>&nbsp;<span class="ident" id="5263828">t</span>&nbsp;<span class="op" id="5263830">==</span>&nbsp;<span class="string" id="5263833">&#34;&#34;</span>&nbsp;<span class="op" id="5263836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263840">return</span>&nbsp;<span class="num" id="5263847">0</span><span class="op" id="5263848">,</span>&nbsp;<span class="string" id="5263850">&#34;&#34;</span><span class="op" id="5263852">,</span>&nbsp;<span class="op" id="5263854">&amp;</span><span class="ident" id="5263855">Error</span><span class="op" id="5263860">{</span><span class="ident" id="5263861">ErrTrailingBackslash</span><span class="op" id="5263881">,</span>&nbsp;<span class="string" id="5263883">&#34;&#34;</span><span class="op" id="5263885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5263888">}</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263891">c</span><span class="op" id="5263892">,</span>&nbsp;<span class="ident" id="5263894">t</span><span class="op" id="5263895">,</span>&nbsp;<span class="ident" id="5263897">err</span>&nbsp;<span class="op" id="5263901">:=</span>&nbsp;<span class="ident" id="5263904">nextRune</span><span class="op" id="5263912">(</span><span class="ident" id="5263913">t</span><span class="op" id="5263914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263917">if</span>&nbsp;<span class="ident" id="5263920">err</span>&nbsp;<span class="op" id="5263924">!=</span>&nbsp;<span class="ident" id="5263927">nil</span>&nbsp;<span class="op" id="5263931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263935">return</span>&nbsp;<span class="num" id="5263942">0</span><span class="op" id="5263943">,</span>&nbsp;<span class="string" id="5263945">&#34;&#34;</span><span class="op" id="5263947">,</span>&nbsp;<span class="ident" id="5263949">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5263954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1240</span><span class="ident" id="5263957">Switch</span><span class="op" id="5263963">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263966">switch</span>&nbsp;<span class="ident" id="5263973">c</span>&nbsp;<span class="op" id="5263975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263978">default</span><span class="op" id="5263985">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263989">if</span>&nbsp;<span class="ident" id="5263992">c</span>&nbsp;<span class="op" id="5263994">&lt;</span>&nbsp;<span class="ident" id="5263996">utf8</span><span class="op" id="5264000">.</span><span class="ident" id="5264001">RuneSelf</span>&nbsp;<span class="op" id="5264010">&amp;&amp;</span>&nbsp;<span class="op" id="5264013">!</span><span class="ident" id="5264014">isalnum</span><span class="op" id="5264021">(</span><span class="ident" id="5264022">c</span><span class="op" id="5264023">)</span>&nbsp;<span class="op" id="5264025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5264030">//&nbsp;Escaped&nbsp;non-word&nbsp;characters&nbsp;are&nbsp;always&nbsp;themselves.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5264087">//&nbsp;PCRE&nbsp;is&nbsp;not&nbsp;quite&nbsp;so&nbsp;rigorous:&nbsp;it&nbsp;accepts&nbsp;things&nbsp;like</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5264147">//&nbsp;\q,&nbsp;but&nbsp;we&nbsp;don&#39;t.&nbsp;&nbsp;We&nbsp;once&nbsp;rejected&nbsp;\_,&nbsp;but&nbsp;too&nbsp;many</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5264206">//&nbsp;programs&nbsp;and&nbsp;people&nbsp;insist&nbsp;on&nbsp;using&nbsp;it,&nbsp;so&nbsp;allow&nbsp;\_.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264265">return</span>&nbsp;<span class="ident" id="5264272">c</span><span class="op" id="5264273">,</span>&nbsp;<span class="ident" id="5264275">t</span><span class="op" id="5264276">,</span>&nbsp;<span class="ident" id="5264278">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5264284">}</span><br>
<span class="lineno">1250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5264288">//&nbsp;Octal&nbsp;escapes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264307">case</span>&nbsp;<span class="string" id="5264312">&#39;1&#39;</span><span class="op" id="5264315">,</span>&nbsp;<span class="string" id="5264317">&#39;2&#39;</span><span class="op" id="5264320">,</span>&nbsp;<span class="string" id="5264322">&#39;3&#39;</span><span class="op" id="5264325">,</span>&nbsp;<span class="string" id="5264327">&#39;4&#39;</span><span class="op" id="5264330">,</span>&nbsp;<span class="string" id="5264332">&#39;5&#39;</span><span class="op" id="5264335">,</span>&nbsp;<span class="string" id="5264337">&#39;6&#39;</span><span class="op" id="5264340">,</span>&nbsp;<span class="string" id="5264342">&#39;7&#39;</span><span class="op" id="5264345">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5264349">//&nbsp;Single&nbsp;non-zero&nbsp;digit&nbsp;is&nbsp;a&nbsp;backreference;&nbsp;not&nbsp;supported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264410">if</span>&nbsp;<span class="ident" id="5264413">t</span>&nbsp;<span class="op" id="5264415">==</span>&nbsp;<span class="string" id="5264418">&#34;&#34;</span>&nbsp;<span class="op" id="5264421">||</span>&nbsp;<span class="ident" id="5264424">t</span><span class="op" id="5264425">[</span><span class="num" id="5264426">0</span><span class="op" id="5264427">]</span>&nbsp;<span class="op" id="5264429">&lt;</span>&nbsp;<span class="string" id="5264431">&#39;0&#39;</span>&nbsp;<span class="op" id="5264435">||</span>&nbsp;<span class="ident" id="5264438">t</span><span class="op" id="5264439">[</span><span class="num" id="5264440">0</span><span class="op" id="5264441">]</span>&nbsp;<span class="op" id="5264443">&gt;</span>&nbsp;<span class="string" id="5264445">&#39;7&#39;</span>&nbsp;<span class="op" id="5264449">{</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264454">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5264462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264466">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264479">case</span>&nbsp;<span class="string" id="5264484">&#39;0&#39;</span><span class="op" id="5264487">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5264491">//&nbsp;Consume&nbsp;up&nbsp;to&nbsp;three&nbsp;octal&nbsp;digits;&nbsp;already&nbsp;have&nbsp;one.</span><br>
<span class="lineno">1260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5264548">r</span>&nbsp;<span class="op" id="5264550">=</span>&nbsp;<span class="ident" id="5264552">c</span>&nbsp;<span class="op" id="5264554">-</span>&nbsp;<span class="string" id="5264556">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264562">for</span>&nbsp;<span class="ident" id="5264566">i</span>&nbsp;<span class="op" id="5264568">:=</span>&nbsp;<span class="num" id="5264571">1</span><span class="op" id="5264572">;</span>&nbsp;<span class="ident" id="5264574">i</span>&nbsp;<span class="op" id="5264576">&lt;</span>&nbsp;<span class="num" id="5264578">3</span><span class="op" id="5264579">;</span>&nbsp;<span class="ident" id="5264581">i</span><span class="op" id="5264582">++</span>&nbsp;<span class="op" id="5264585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264590">if</span>&nbsp;<span class="ident" id="5264593">t</span>&nbsp;<span class="op" id="5264595">==</span>&nbsp;<span class="string" id="5264598">&#34;&#34;</span>&nbsp;<span class="op" id="5264601">||</span>&nbsp;<span class="ident" id="5264604">t</span><span class="op" id="5264605">[</span><span class="num" id="5264606">0</span><span class="op" id="5264607">]</span>&nbsp;<span class="op" id="5264609">&lt;</span>&nbsp;<span class="string" id="5264611">&#39;0&#39;</span>&nbsp;<span class="op" id="5264615">||</span>&nbsp;<span class="ident" id="5264618">t</span><span class="op" id="5264619">[</span><span class="num" id="5264620">0</span><span class="op" id="5264621">]</span>&nbsp;<span class="op" id="5264623">&gt;</span>&nbsp;<span class="string" id="5264625">&#39;7&#39;</span>&nbsp;<span class="op" id="5264629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264635">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5264644">}</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5264649">r</span>&nbsp;<span class="op" id="5264651">=</span>&nbsp;<span class="ident" id="5264653">r</span><span class="op" id="5264654">*</span><span class="num" id="5264655">8</span>&nbsp;<span class="op" id="5264657">+</span>&nbsp;<span class="builtintype" id="5264659">rune</span><span class="op" id="5264663">(</span><span class="ident" id="5264664">t</span><span class="op" id="5264665">[</span><span class="num" id="5264666">0</span><span class="op" id="5264667">]</span><span class="op" id="5264668">)</span>&nbsp;<span class="op" id="5264670">-</span>&nbsp;<span class="string" id="5264672">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5264679">t</span>&nbsp;<span class="op" id="5264681">=</span>&nbsp;<span class="ident" id="5264683">t</span><span class="op" id="5264684">[</span><span class="num" id="5264685">1</span><span class="op" id="5264686">:</span><span class="op" id="5264687">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5264691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264695">return</span>&nbsp;<span class="ident" id="5264702">r</span><span class="op" id="5264703">,</span>&nbsp;<span class="ident" id="5264705">t</span><span class="op" id="5264706">,</span>&nbsp;<span class="ident" id="5264708">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5264714">//&nbsp;Hexadecimal&nbsp;escapes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264739">case</span>&nbsp;<span class="string" id="5264744">&#39;x&#39;</span><span class="op" id="5264747">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264751">if</span>&nbsp;<span class="ident" id="5264754">t</span>&nbsp;<span class="op" id="5264756">==</span>&nbsp;<span class="string" id="5264759">&#34;&#34;</span>&nbsp;<span class="op" id="5264762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264767">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5264775">}</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264779">if</span>&nbsp;<span class="ident" id="5264782">c</span><span class="op" id="5264783">,</span>&nbsp;<span class="ident" id="5264785">t</span><span class="op" id="5264786">,</span>&nbsp;<span class="ident" id="5264788">err</span>&nbsp;<span class="op" id="5264792">=</span>&nbsp;<span class="ident" id="5264794">nextRune</span><span class="op" id="5264802">(</span><span class="ident" id="5264803">t</span><span class="op" id="5264804">)</span><span class="op" id="5264805">;</span>&nbsp;<span class="ident" id="5264807">err</span>&nbsp;<span class="op" id="5264811">!=</span>&nbsp;<span class="ident" id="5264814">nil</span>&nbsp;<span class="op" id="5264818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264823">return</span>&nbsp;<span class="num" id="5264830">0</span><span class="op" id="5264831">,</span>&nbsp;<span class="string" id="5264833">&#34;&#34;</span><span class="op" id="5264835">,</span>&nbsp;<span class="ident" id="5264837">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5264843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264847">if</span>&nbsp;<span class="ident" id="5264850">c</span>&nbsp;<span class="op" id="5264852">==</span>&nbsp;<span class="string" id="5264855">&#39;{&#39;</span>&nbsp;<span class="op" id="5264859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5264864">//&nbsp;Any&nbsp;number&nbsp;of&nbsp;digits&nbsp;in&nbsp;braces.</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5264902">//&nbsp;Perl&nbsp;accepts&nbsp;any&nbsp;text&nbsp;at&nbsp;all;&nbsp;it&nbsp;ignores&nbsp;all&nbsp;text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5264958">//&nbsp;after&nbsp;the&nbsp;first&nbsp;non-hex&nbsp;digit.&nbsp;&nbsp;We&nbsp;require&nbsp;only&nbsp;hex&nbsp;digits,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5265024">//&nbsp;and&nbsp;at&nbsp;least&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265048">nhex</span>&nbsp;<span class="op" id="5265053">:=</span>&nbsp;<span class="num" id="5265056">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265061">r</span>&nbsp;<span class="op" id="5265063">=</span>&nbsp;<span class="num" id="5265065">0</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265070">for</span>&nbsp;<span class="op" id="5265074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265080">if</span>&nbsp;<span class="ident" id="5265083">t</span>&nbsp;<span class="op" id="5265085">==</span>&nbsp;<span class="string" id="5265088">&#34;&#34;</span>&nbsp;<span class="op" id="5265091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265098">break</span>&nbsp;<span class="ident" id="5265104">Switch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5265115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265121">if</span>&nbsp;<span class="ident" id="5265124">c</span><span class="op" id="5265125">,</span>&nbsp;<span class="ident" id="5265127">t</span><span class="op" id="5265128">,</span>&nbsp;<span class="ident" id="5265130">err</span>&nbsp;<span class="op" id="5265134">=</span>&nbsp;<span class="ident" id="5265136">nextRune</span><span class="op" id="5265144">(</span><span class="ident" id="5265145">t</span><span class="op" id="5265146">)</span><span class="op" id="5265147">;</span>&nbsp;<span class="ident" id="5265149">err</span>&nbsp;<span class="op" id="5265153">!=</span>&nbsp;<span class="ident" id="5265156">nil</span>&nbsp;<span class="op" id="5265160">{</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265167">return</span>&nbsp;<span class="num" id="5265174">0</span><span class="op" id="5265175">,</span>&nbsp;<span class="string" id="5265177">&#34;&#34;</span><span class="op" id="5265179">,</span>&nbsp;<span class="ident" id="5265181">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5265189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265195">if</span>&nbsp;<span class="ident" id="5265198">c</span>&nbsp;<span class="op" id="5265200">==</span>&nbsp;<span class="string" id="5265203">&#39;}&#39;</span>&nbsp;<span class="op" id="5265207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265214">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5265224">}</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265230">v</span>&nbsp;<span class="op" id="5265232">:=</span>&nbsp;<span class="ident" id="5265235">unhex</span><span class="op" id="5265240">(</span><span class="ident" id="5265241">c</span><span class="op" id="5265242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265248">if</span>&nbsp;<span class="ident" id="5265251">v</span>&nbsp;<span class="op" id="5265253">&lt;</span>&nbsp;<span class="num" id="5265255">0</span>&nbsp;<span class="op" id="5265257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265264">break</span>&nbsp;<span class="ident" id="5265270">Switch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5265281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265287">r</span>&nbsp;<span class="op" id="5265289">=</span>&nbsp;<span class="ident" id="5265291">r</span><span class="op" id="5265292">*</span><span class="num" id="5265293">16</span>&nbsp;<span class="op" id="5265296">+</span>&nbsp;<span class="ident" id="5265298">v</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265304">if</span>&nbsp;<span class="ident" id="5265307">r</span>&nbsp;<span class="op" id="5265309">&gt;</span>&nbsp;<span class="ident" id="5265311">unicode</span><span class="op" id="5265318">.</span><span class="ident" id="5265319">MaxRune</span>&nbsp;<span class="op" id="5265327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265334">break</span>&nbsp;<span class="ident" id="5265340">Switch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5265351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265357">nhex</span><span class="op" id="5265361">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5265367">}</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265372">if</span>&nbsp;<span class="ident" id="5265375">nhex</span>&nbsp;<span class="op" id="5265380">==</span>&nbsp;<span class="num" id="5265383">0</span>&nbsp;<span class="op" id="5265385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265391">break</span>&nbsp;<span class="ident" id="5265397">Switch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5265407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265412">return</span>&nbsp;<span class="ident" id="5265419">r</span><span class="op" id="5265420">,</span>&nbsp;<span class="ident" id="5265422">t</span><span class="op" id="5265423">,</span>&nbsp;<span class="ident" id="5265425">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5265431">}</span><br>
<span class="lineno">1310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5265436">//&nbsp;Easy&nbsp;case:&nbsp;two&nbsp;hex&nbsp;digits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265468">x</span>&nbsp;<span class="op" id="5265470">:=</span>&nbsp;<span class="ident" id="5265473">unhex</span><span class="op" id="5265478">(</span><span class="ident" id="5265479">c</span><span class="op" id="5265480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265484">if</span>&nbsp;<span class="ident" id="5265487">c</span><span class="op" id="5265488">,</span>&nbsp;<span class="ident" id="5265490">t</span><span class="op" id="5265491">,</span>&nbsp;<span class="ident" id="5265493">err</span>&nbsp;<span class="op" id="5265497">=</span>&nbsp;<span class="ident" id="5265499">nextRune</span><span class="op" id="5265507">(</span><span class="ident" id="5265508">t</span><span class="op" id="5265509">)</span><span class="op" id="5265510">;</span>&nbsp;<span class="ident" id="5265512">err</span>&nbsp;<span class="op" id="5265516">!=</span>&nbsp;<span class="ident" id="5265519">nil</span>&nbsp;<span class="op" id="5265523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265528">return</span>&nbsp;<span class="num" id="5265535">0</span><span class="op" id="5265536">,</span>&nbsp;<span class="string" id="5265538">&#34;&#34;</span><span class="op" id="5265540">,</span>&nbsp;<span class="ident" id="5265542">err</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5265548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265552">y</span>&nbsp;<span class="op" id="5265554">:=</span>&nbsp;<span class="ident" id="5265557">unhex</span><span class="op" id="5265562">(</span><span class="ident" id="5265563">c</span><span class="op" id="5265564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265568">if</span>&nbsp;<span class="ident" id="5265571">x</span>&nbsp;<span class="op" id="5265573">&lt;</span>&nbsp;<span class="num" id="5265575">0</span>&nbsp;<span class="op" id="5265577">||</span>&nbsp;<span class="ident" id="5265580">y</span>&nbsp;<span class="op" id="5265582">&lt;</span>&nbsp;<span class="num" id="5265584">0</span>&nbsp;<span class="op" id="5265586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265591">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5265599">}</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265603">return</span>&nbsp;<span class="ident" id="5265610">x</span><span class="op" id="5265611">*</span><span class="num" id="5265612">16</span>&nbsp;<span class="op" id="5265615">+</span>&nbsp;<span class="ident" id="5265617">y</span><span class="op" id="5265618">,</span>&nbsp;<span class="ident" id="5265620">t</span><span class="op" id="5265621">,</span>&nbsp;<span class="ident" id="5265623">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5265629">//&nbsp;C&nbsp;escapes.&nbsp;&nbsp;There&nbsp;is&nbsp;no&nbsp;case&nbsp;&#39;b&#39;,&nbsp;to&nbsp;avoid&nbsp;misparsing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5265687">//&nbsp;the&nbsp;Perl&nbsp;word-boundary&nbsp;\b&nbsp;as&nbsp;the&nbsp;C&nbsp;backspace&nbsp;\b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5265739">//&nbsp;when&nbsp;in&nbsp;POSIX&nbsp;mode.&nbsp;&nbsp;In&nbsp;Perl,&nbsp;/\b/&nbsp;means&nbsp;word-boundary</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5265798">//&nbsp;but&nbsp;/[\b]/&nbsp;means&nbsp;backspace.&nbsp;&nbsp;We&nbsp;don&#39;t&nbsp;support&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5265854">//&nbsp;If&nbsp;you&nbsp;want&nbsp;a&nbsp;backspace,&nbsp;embed&nbsp;a&nbsp;literal&nbsp;backspace</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5265909">//&nbsp;character&nbsp;or&nbsp;use&nbsp;\x08.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265936">case</span>&nbsp;<span class="string" id="5265941">&#39;a&#39;</span><span class="op" id="5265944">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265948">return</span>&nbsp;<span class="string" id="5265955">&#39;\a&#39;</span><span class="op" id="5265959">,</span>&nbsp;<span class="ident" id="5265961">t</span><span class="op" id="5265962">,</span>&nbsp;<span class="ident" id="5265964">err</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265969">case</span>&nbsp;<span class="string" id="5265974">&#39;f&#39;</span><span class="op" id="5265977">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265981">return</span>&nbsp;<span class="string" id="5265988">&#39;\f&#39;</span><span class="op" id="5265992">,</span>&nbsp;<span class="ident" id="5265994">t</span><span class="op" id="5265995">,</span>&nbsp;<span class="ident" id="5265997">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266002">case</span>&nbsp;<span class="string" id="5266007">&#39;n&#39;</span><span class="op" id="5266010">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266014">return</span>&nbsp;<span class="string" id="5266021">&#39;\n&#39;</span><span class="op" id="5266025">,</span>&nbsp;<span class="ident" id="5266027">t</span><span class="op" id="5266028">,</span>&nbsp;<span class="ident" id="5266030">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266035">case</span>&nbsp;<span class="string" id="5266040">&#39;r&#39;</span><span class="op" id="5266043">:</span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266047">return</span>&nbsp;<span class="string" id="5266054">&#39;\r&#39;</span><span class="op" id="5266058">,</span>&nbsp;<span class="ident" id="5266060">t</span><span class="op" id="5266061">,</span>&nbsp;<span class="ident" id="5266063">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266068">case</span>&nbsp;<span class="string" id="5266073">&#39;t&#39;</span><span class="op" id="5266076">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266080">return</span>&nbsp;<span class="string" id="5266087">&#39;\t&#39;</span><span class="op" id="5266091">,</span>&nbsp;<span class="ident" id="5266093">t</span><span class="op" id="5266094">,</span>&nbsp;<span class="ident" id="5266096">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266101">case</span>&nbsp;<span class="string" id="5266106">&#39;v&#39;</span><span class="op" id="5266109">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266113">return</span>&nbsp;<span class="string" id="5266120">&#39;\v&#39;</span><span class="op" id="5266124">,</span>&nbsp;<span class="ident" id="5266126">t</span><span class="op" id="5266127">,</span>&nbsp;<span class="ident" id="5266129">err</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5266134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266137">return</span>&nbsp;<span class="num" id="5266144">0</span><span class="op" id="5266145">,</span>&nbsp;<span class="string" id="5266147">&#34;&#34;</span><span class="op" id="5266149">,</span>&nbsp;<span class="op" id="5266151">&amp;</span><span class="ident" id="5266152">Error</span><span class="op" id="5266157">{</span><span class="ident" id="5266158">ErrInvalidEscape</span><span class="op" id="5266174">,</span>&nbsp;<span class="ident" id="5266176">s</span><span class="op" id="5266177">[</span><span class="op" id="5266178">:</span><span class="builtinfunc" id="5266179">len</span><span class="op" id="5266182">(</span><span class="ident" id="5266183">s</span><span class="op" id="5266184">)</span><span class="op" id="5266185">-</span><span class="builtinfunc" id="5266186">len</span><span class="op" id="5266189">(</span><span class="ident" id="5266190">t</span><span class="op" id="5266191">)</span><span class="op" id="5266192">]</span><span class="op" id="5266193">}</span><br>
<span class="lineno"></span><span class="op" id="5266195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5266198">//&nbsp;parseClassChar&nbsp;parses&nbsp;a&nbsp;character&nbsp;class&nbsp;character&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s</span><br>
<span class="lineno">1345</span><span class="comment" id="5266273">//&nbsp;and&nbsp;returns&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5266292">func</span>&nbsp;<span class="op" id="5266297">(</span><span class="ident" id="5266298">p</span>&nbsp;<span class="op" id="5266300">*</span><span class="ident" id="5266301">parser</span><span class="op" id="5266307">)</span>&nbsp;<span class="ident" id="5266309">parseClassChar</span><span class="op" id="5266323">(</span><span class="ident" id="5266324">s</span><span class="op" id="5266325">,</span>&nbsp;<span class="ident" id="5266327">wholeClass</span>&nbsp;<span class="builtintype" id="5266338">string</span><span class="op" id="5266344">)</span>&nbsp;<span class="op" id="5266346">(</span><span class="ident" id="5266347">r</span>&nbsp;<span class="builtintype" id="5266349">rune</span><span class="op" id="5266353">,</span>&nbsp;<span class="ident" id="5266355">rest</span>&nbsp;<span class="builtintype" id="5266360">string</span><span class="op" id="5266366">,</span>&nbsp;<span class="ident" id="5266368">err</span>&nbsp;<span class="builtintype" id="5266372">error</span><span class="op" id="5266377">)</span>&nbsp;<span class="op" id="5266379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266382">if</span>&nbsp;<span class="ident" id="5266385">s</span>&nbsp;<span class="op" id="5266387">==</span>&nbsp;<span class="string" id="5266390">&#34;&#34;</span>&nbsp;<span class="op" id="5266393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266397">return</span>&nbsp;<span class="num" id="5266404">0</span><span class="op" id="5266405">,</span>&nbsp;<span class="string" id="5266407">&#34;&#34;</span><span class="op" id="5266409">,</span>&nbsp;<span class="op" id="5266411">&amp;</span><span class="ident" id="5266412">Error</span><span class="op" id="5266417">{</span><span class="ident" id="5266418">Code</span><span class="op" id="5266422">:</span>&nbsp;<span class="ident" id="5266424">ErrMissingBracket</span><span class="op" id="5266441">,</span>&nbsp;<span class="ident" id="5266443">Expr</span><span class="op" id="5266447">:</span>&nbsp;<span class="ident" id="5266449">wholeClass</span><span class="op" id="5266459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5266462">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5266466">//&nbsp;Allow&nbsp;regular&nbsp;escape&nbsp;sequences&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5266513">//&nbsp;many&nbsp;need&nbsp;not&nbsp;be&nbsp;escaped&nbsp;in&nbsp;this&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266559">if</span>&nbsp;<span class="ident" id="5266562">s</span><span class="op" id="5266563">[</span><span class="num" id="5266564">0</span><span class="op" id="5266565">]</span>&nbsp;<span class="op" id="5266567">==</span>&nbsp;<span class="string" id="5266570">&#39;\\&#39;</span>&nbsp;<span class="op" id="5266575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266579">return</span>&nbsp;<span class="ident" id="5266586">p</span><span class="op" id="5266587">.</span><span class="ident" id="5266588">parseEscape</span><span class="op" id="5266599">(</span><span class="ident" id="5266600">s</span><span class="op" id="5266601">)</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5266604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266608">return</span>&nbsp;<span class="ident" id="5266615">nextRune</span><span class="op" id="5266623">(</span><span class="ident" id="5266624">s</span><span class="op" id="5266625">)</span><br>
<span class="lineno"></span><span class="op" id="5266627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1360</span><span class="keyword" id="5266630">type</span>&nbsp;<span class="ident" id="5266635">charGroup</span>&nbsp;<span class="keyword" id="5266645">struct</span>&nbsp;<span class="op" id="5266652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5266655">sign</span>&nbsp;&nbsp;<span class="builtintype" id="5266661">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5266666">class</span>&nbsp;<span class="op" id="5266672">[</span><span class="op" id="5266673">]</span><span class="builtintype" id="5266674">rune</span><br>
<span class="lineno"></span><span class="op" id="5266679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1365</span><span class="comment" id="5266682">//&nbsp;parsePerlClassEscape&nbsp;parses&nbsp;a&nbsp;leading&nbsp;Perl&nbsp;character&nbsp;class&nbsp;escape&nbsp;like&nbsp;\d</span><br>
<span class="lineno"></span><span class="comment" id="5266759">//&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s.&nbsp;&nbsp;If&nbsp;one&nbsp;is&nbsp;present,&nbsp;it&nbsp;appends&nbsp;the&nbsp;characters&nbsp;to&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="5266838">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;new&nbsp;slice&nbsp;r&nbsp;and&nbsp;the&nbsp;remainder&nbsp;of&nbsp;the&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="5266902">func</span>&nbsp;<span class="op" id="5266907">(</span><span class="ident" id="5266908">p</span>&nbsp;<span class="op" id="5266910">*</span><span class="ident" id="5266911">parser</span><span class="op" id="5266917">)</span>&nbsp;<span class="ident" id="5266919">parsePerlClassEscape</span><span class="op" id="5266939">(</span><span class="ident" id="5266940">s</span>&nbsp;<span class="builtintype" id="5266942">string</span><span class="op" id="5266948">,</span>&nbsp;<span class="ident" id="5266950">r</span>&nbsp;<span class="op" id="5266952">[</span><span class="op" id="5266953">]</span><span class="builtintype" id="5266954">rune</span><span class="op" id="5266958">)</span>&nbsp;<span class="op" id="5266960">(</span><span class="ident" id="5266961">out</span>&nbsp;<span class="op" id="5266965">[</span><span class="op" id="5266966">]</span><span class="builtintype" id="5266967">rune</span><span class="op" id="5266971">,</span>&nbsp;<span class="ident" id="5266973">rest</span>&nbsp;<span class="builtintype" id="5266978">string</span><span class="op" id="5266984">)</span>&nbsp;<span class="op" id="5266986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266989">if</span>&nbsp;<span class="ident" id="5266992">p</span><span class="op" id="5266993">.</span><span class="ident" id="5266994">flags</span><span class="op" id="5266999">&amp;</span><span class="ident" id="5267000">PerlX</span>&nbsp;<span class="op" id="5267006">==</span>&nbsp;<span class="num" id="5267009">0</span>&nbsp;<span class="op" id="5267011">||</span>&nbsp;<span class="builtinfunc" id="5267014">len</span><span class="op" id="5267017">(</span><span class="ident" id="5267018">s</span><span class="op" id="5267019">)</span>&nbsp;<span class="op" id="5267021">&lt;</span>&nbsp;<span class="num" id="5267023">2</span>&nbsp;<span class="op" id="5267025">||</span>&nbsp;<span class="ident" id="5267028">s</span><span class="op" id="5267029">[</span><span class="num" id="5267030">0</span><span class="op" id="5267031">]</span>&nbsp;<span class="op" id="5267033">!=</span>&nbsp;<span class="string" id="5267036">&#39;\\&#39;</span>&nbsp;<span class="op" id="5267041">{</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267045">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5267053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267056">g</span>&nbsp;<span class="op" id="5267058">:=</span>&nbsp;<span class="ident" id="5267061">perlGroup</span><span class="op" id="5267070">[</span><span class="ident" id="5267071">s</span><span class="op" id="5267072">[</span><span class="num" id="5267073">0</span><span class="op" id="5267074">:</span><span class="num" id="5267075">2</span><span class="op" id="5267076">]</span><span class="op" id="5267077">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267080">if</span>&nbsp;<span class="ident" id="5267083">g</span><span class="op" id="5267084">.</span><span class="ident" id="5267085">sign</span>&nbsp;<span class="op" id="5267090">==</span>&nbsp;<span class="num" id="5267093">0</span>&nbsp;<span class="op" id="5267095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267099">return</span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5267107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267110">return</span>&nbsp;<span class="ident" id="5267117">p</span><span class="op" id="5267118">.</span><span class="ident" id="5267119">appendGroup</span><span class="op" id="5267130">(</span><span class="ident" id="5267131">r</span><span class="op" id="5267132">,</span>&nbsp;<span class="ident" id="5267134">g</span><span class="op" id="5267135">)</span><span class="op" id="5267136">,</span>&nbsp;<span class="ident" id="5267138">s</span><span class="op" id="5267139">[</span><span class="num" id="5267140">2</span><span class="op" id="5267141">:</span><span class="op" id="5267142">]</span><br>
<span class="lineno"></span><span class="op" id="5267144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5267147">//&nbsp;parseNamedClass&nbsp;parses&nbsp;a&nbsp;leading&nbsp;POSIX&nbsp;named&nbsp;character&nbsp;class&nbsp;like&nbsp;[:alnum:]</span><br>
<span class="lineno">1380</span><span class="comment" id="5267226">//&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s.&nbsp;&nbsp;If&nbsp;one&nbsp;is&nbsp;present,&nbsp;it&nbsp;appends&nbsp;the&nbsp;characters&nbsp;to&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="5267305">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;new&nbsp;slice&nbsp;r&nbsp;and&nbsp;the&nbsp;remainder&nbsp;of&nbsp;the&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="5267369">func</span>&nbsp;<span class="op" id="5267374">(</span><span class="ident" id="5267375">p</span>&nbsp;<span class="op" id="5267377">*</span><span class="ident" id="5267378">parser</span><span class="op" id="5267384">)</span>&nbsp;<span class="ident" id="5267386">parseNamedClass</span><span class="op" id="5267401">(</span><span class="ident" id="5267402">s</span>&nbsp;<span class="builtintype" id="5267404">string</span><span class="op" id="5267410">,</span>&nbsp;<span class="ident" id="5267412">r</span>&nbsp;<span class="op" id="5267414">[</span><span class="op" id="5267415">]</span><span class="builtintype" id="5267416">rune</span><span class="op" id="5267420">)</span>&nbsp;<span class="op" id="5267422">(</span><span class="ident" id="5267423">out</span>&nbsp;<span class="op" id="5267427">[</span><span class="op" id="5267428">]</span><span class="builtintype" id="5267429">rune</span><span class="op" id="5267433">,</span>&nbsp;<span class="ident" id="5267435">rest</span>&nbsp;<span class="builtintype" id="5267440">string</span><span class="op" id="5267446">,</span>&nbsp;<span class="ident" id="5267448">err</span>&nbsp;<span class="builtintype" id="5267452">error</span><span class="op" id="5267457">)</span>&nbsp;<span class="op" id="5267459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267462">if</span>&nbsp;<span class="builtinfunc" id="5267465">len</span><span class="op" id="5267468">(</span><span class="ident" id="5267469">s</span><span class="op" id="5267470">)</span>&nbsp;<span class="op" id="5267472">&lt;</span>&nbsp;<span class="num" id="5267474">2</span>&nbsp;<span class="op" id="5267476">||</span>&nbsp;<span class="ident" id="5267479">s</span><span class="op" id="5267480">[</span><span class="num" id="5267481">0</span><span class="op" id="5267482">]</span>&nbsp;<span class="op" id="5267484">!=</span>&nbsp;<span class="string" id="5267487">&#39;[&#39;</span>&nbsp;<span class="op" id="5267491">||</span>&nbsp;<span class="ident" id="5267494">s</span><span class="op" id="5267495">[</span><span class="num" id="5267496">1</span><span class="op" id="5267497">]</span>&nbsp;<span class="op" id="5267499">!=</span>&nbsp;<span class="string" id="5267502">&#39;:&#39;</span>&nbsp;<span class="op" id="5267506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267510">return</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5267518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267522">i</span>&nbsp;<span class="op" id="5267524">:=</span>&nbsp;<span class="ident" id="5267527">strings</span><span class="op" id="5267534">.</span><span class="ident" id="5267535">Index</span><span class="op" id="5267540">(</span><span class="ident" id="5267541">s</span><span class="op" id="5267542">[</span><span class="num" id="5267543">2</span><span class="op" id="5267544">:</span><span class="op" id="5267545">]</span><span class="op" id="5267546">,</span>&nbsp;<span class="string" id="5267548">&#34;:]&#34;</span><span class="op" id="5267552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267555">if</span>&nbsp;<span class="ident" id="5267558">i</span>&nbsp;<span class="op" id="5267560">&lt;</span>&nbsp;<span class="num" id="5267562">0</span>&nbsp;<span class="op" id="5267564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267568">return</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5267576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267579">i</span>&nbsp;<span class="op" id="5267581">+=</span>&nbsp;<span class="num" id="5267584">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267587">name</span><span class="op" id="5267591">,</span>&nbsp;<span class="ident" id="5267593">s</span>&nbsp;<span class="op" id="5267595">:=</span>&nbsp;<span class="ident" id="5267598">s</span><span class="op" id="5267599">[</span><span class="num" id="5267600">0</span><span class="op" id="5267601">:</span><span class="ident" id="5267602">i</span><span class="op" id="5267603">+</span><span class="num" id="5267604">2</span><span class="op" id="5267605">]</span><span class="op" id="5267606">,</span>&nbsp;<span class="ident" id="5267608">s</span><span class="op" id="5267609">[</span><span class="ident" id="5267610">i</span><span class="op" id="5267611">+</span><span class="num" id="5267612">2</span><span class="op" id="5267613">:</span><span class="op" id="5267614">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267617">g</span>&nbsp;<span class="op" id="5267619">:=</span>&nbsp;<span class="ident" id="5267622">posixGroup</span><span class="op" id="5267632">[</span><span class="ident" id="5267633">name</span><span class="op" id="5267637">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267640">if</span>&nbsp;<span class="ident" id="5267643">g</span><span class="op" id="5267644">.</span><span class="ident" id="5267645">sign</span>&nbsp;<span class="op" id="5267650">==</span>&nbsp;<span class="num" id="5267653">0</span>&nbsp;<span class="op" id="5267655">{</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267659">return</span>&nbsp;<span class="ident" id="5267666">nil</span><span class="op" id="5267669">,</span>&nbsp;<span class="string" id="5267671">&#34;&#34;</span><span class="op" id="5267673">,</span>&nbsp;<span class="op" id="5267675">&amp;</span><span class="ident" id="5267676">Error</span><span class="op" id="5267681">{</span><span class="ident" id="5267682">ErrInvalidCharRange</span><span class="op" id="5267701">,</span>&nbsp;<span class="ident" id="5267703">name</span><span class="op" id="5267707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5267710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267713">return</span>&nbsp;<span class="ident" id="5267720">p</span><span class="op" id="5267721">.</span><span class="ident" id="5267722">appendGroup</span><span class="op" id="5267733">(</span><span class="ident" id="5267734">r</span><span class="op" id="5267735">,</span>&nbsp;<span class="ident" id="5267737">g</span><span class="op" id="5267738">)</span><span class="op" id="5267739">,</span>&nbsp;<span class="ident" id="5267741">s</span><span class="op" id="5267742">,</span>&nbsp;<span class="ident" id="5267744">nil</span><br>
<span class="lineno"></span><span class="op" id="5267748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1400</span><span class="keyword" id="5267751">func</span>&nbsp;<span class="op" id="5267756">(</span><span class="ident" id="5267757">p</span>&nbsp;<span class="op" id="5267759">*</span><span class="ident" id="5267760">parser</span><span class="op" id="5267766">)</span>&nbsp;<span class="ident" id="5267768">appendGroup</span><span class="op" id="5267779">(</span><span class="ident" id="5267780">r</span>&nbsp;<span class="op" id="5267782">[</span><span class="op" id="5267783">]</span><span class="builtintype" id="5267784">rune</span><span class="op" id="5267788">,</span>&nbsp;<span class="ident" id="5267790">g</span>&nbsp;<span class="ident" id="5267792">charGroup</span><span class="op" id="5267801">)</span>&nbsp;<span class="op" id="5267803">[</span><span class="op" id="5267804">]</span><span class="builtintype" id="5267805">rune</span>&nbsp;<span class="op" id="5267810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267813">if</span>&nbsp;<span class="ident" id="5267816">p</span><span class="op" id="5267817">.</span><span class="ident" id="5267818">flags</span><span class="op" id="5267823">&amp;</span><span class="ident" id="5267824">FoldCase</span>&nbsp;<span class="op" id="5267833">==</span>&nbsp;<span class="num" id="5267836">0</span>&nbsp;<span class="op" id="5267838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267842">if</span>&nbsp;<span class="ident" id="5267845">g</span><span class="op" id="5267846">.</span><span class="ident" id="5267847">sign</span>&nbsp;<span class="op" id="5267852">&lt;</span>&nbsp;<span class="num" id="5267854">0</span>&nbsp;<span class="op" id="5267856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267861">r</span>&nbsp;<span class="op" id="5267863">=</span>&nbsp;<span class="ident" id="5267865">appendNegatedClass</span><span class="op" id="5267883">(</span><span class="ident" id="5267884">r</span><span class="op" id="5267885">,</span>&nbsp;<span class="ident" id="5267887">g</span><span class="op" id="5267888">.</span><span class="ident" id="5267889">class</span><span class="op" id="5267894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5267898">}</span>&nbsp;<span class="keyword" id="5267900">else</span>&nbsp;<span class="op" id="5267905">{</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267910">r</span>&nbsp;<span class="op" id="5267912">=</span>&nbsp;<span class="ident" id="5267914">appendClass</span><span class="op" id="5267925">(</span><span class="ident" id="5267926">r</span><span class="op" id="5267927">,</span>&nbsp;<span class="ident" id="5267929">g</span><span class="op" id="5267930">.</span><span class="ident" id="5267931">class</span><span class="op" id="5267936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5267940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5267943">}</span>&nbsp;<span class="keyword" id="5267945">else</span>&nbsp;<span class="op" id="5267950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267954">tmp</span>&nbsp;<span class="op" id="5267958">:=</span>&nbsp;<span class="ident" id="5267961">p</span><span class="op" id="5267962">.</span><span class="ident" id="5267963">tmpClass</span><span class="op" id="5267971">[</span><span class="op" id="5267972">:</span><span class="num" id="5267973">0</span><span class="op" id="5267974">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267978">tmp</span>&nbsp;<span class="op" id="5267982">=</span>&nbsp;<span class="ident" id="5267984">appendFoldedClass</span><span class="op" id="5268001">(</span><span class="ident" id="5268002">tmp</span><span class="op" id="5268005">,</span>&nbsp;<span class="ident" id="5268007">g</span><span class="op" id="5268008">.</span><span class="ident" id="5268009">class</span><span class="op" id="5268014">)</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268018">p</span><span class="op" id="5268019">.</span><span class="ident" id="5268020">tmpClass</span>&nbsp;<span class="op" id="5268029">=</span>&nbsp;<span class="ident" id="5268031">tmp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268037">tmp</span>&nbsp;<span class="op" id="5268041">=</span>&nbsp;<span class="ident" id="5268043">cleanClass</span><span class="op" id="5268053">(</span><span class="op" id="5268054">&amp;</span><span class="ident" id="5268055">p</span><span class="op" id="5268056">.</span><span class="ident" id="5268057">tmpClass</span><span class="op" id="5268065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268069">if</span>&nbsp;<span class="ident" id="5268072">g</span><span class="op" id="5268073">.</span><span class="ident" id="5268074">sign</span>&nbsp;<span class="op" id="5268079">&lt;</span>&nbsp;<span class="num" id="5268081">0</span>&nbsp;<span class="op" id="5268083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268088">r</span>&nbsp;<span class="op" id="5268090">=</span>&nbsp;<span class="ident" id="5268092">appendNegatedClass</span><span class="op" id="5268110">(</span><span class="ident" id="5268111">r</span><span class="op" id="5268112">,</span>&nbsp;<span class="ident" id="5268114">tmp</span><span class="op" id="5268117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5268121">}</span>&nbsp;<span class="keyword" id="5268123">else</span>&nbsp;<span class="op" id="5268128">{</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268133">r</span>&nbsp;<span class="op" id="5268135">=</span>&nbsp;<span class="ident" id="5268137">appendClass</span><span class="op" id="5268148">(</span><span class="ident" id="5268149">r</span><span class="op" id="5268150">,</span>&nbsp;<span class="ident" id="5268152">tmp</span><span class="op" id="5268155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5268159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5268162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268165">return</span>&nbsp;<span class="ident" id="5268172">r</span><br>
<span class="lineno"></span><span class="op" id="5268174">}</span><br>
<span class="lineno">1420</span><br>
<span class="lineno"></span><span class="keyword" id="5268177">var</span>&nbsp;<span class="ident" id="5268181">anyTable</span>&nbsp;<span class="op" id="5268190">=</span>&nbsp;<span class="op" id="5268192">&amp;</span><span class="ident" id="5268193">unicode</span><span class="op" id="5268200">.</span><span class="ident" id="5268201">RangeTable</span><span class="op" id="5268211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268214">R16</span><span class="op" id="5268217">:</span>&nbsp;<span class="op" id="5268219">[</span><span class="op" id="5268220">]</span><span class="ident" id="5268221">unicode</span><span class="op" id="5268228">.</span><span class="ident" id="5268229">Range16</span><span class="op" id="5268236">{</span><span class="op" id="5268237">{</span><span class="ident" id="5268238">Lo</span><span class="op" id="5268240">:</span>&nbsp;<span class="num" id="5268242">0</span><span class="op" id="5268243">,</span>&nbsp;<span class="ident" id="5268245">Hi</span><span class="op" id="5268247">:</span>&nbsp;<span class="num" id="5268249">1</span><span class="op" id="5268250">&lt;&lt;</span><span class="num" id="5268252">16</span>&nbsp;<span class="op" id="5268255">-</span>&nbsp;<span class="num" id="5268257">1</span><span class="op" id="5268258">,</span>&nbsp;<span class="ident" id="5268260">Stride</span><span class="op" id="5268266">:</span>&nbsp;<span class="num" id="5268268">1</span><span class="op" id="5268269">}</span><span class="op" id="5268270">}</span><span class="op" id="5268271">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268274">R32</span><span class="op" id="5268277">:</span>&nbsp;<span class="op" id="5268279">[</span><span class="op" id="5268280">]</span><span class="ident" id="5268281">unicode</span><span class="op" id="5268288">.</span><span class="ident" id="5268289">Range32</span><span class="op" id="5268296">{</span><span class="op" id="5268297">{</span><span class="ident" id="5268298">Lo</span><span class="op" id="5268300">:</span>&nbsp;<span class="num" id="5268302">1</span>&nbsp;<span class="op" id="5268304">&lt;&lt;</span>&nbsp;<span class="num" id="5268307">16</span><span class="op" id="5268309">,</span>&nbsp;<span class="ident" id="5268311">Hi</span><span class="op" id="5268313">:</span>&nbsp;<span class="ident" id="5268315">unicode</span><span class="op" id="5268322">.</span><span class="ident" id="5268323">MaxRune</span><span class="op" id="5268330">,</span>&nbsp;<span class="ident" id="5268332">Stride</span><span class="op" id="5268338">:</span>&nbsp;<span class="num" id="5268340">1</span><span class="op" id="5268341">}</span><span class="op" id="5268342">}</span><span class="op" id="5268343">,</span><br>
<span class="lineno"></span><span class="op" id="5268345">}</span><br>
<span class="lineno">1425</span><br>
<span class="lineno"></span><span class="comment" id="5268348">//&nbsp;unicodeTable&nbsp;returns&nbsp;the&nbsp;unicode.RangeTable&nbsp;identified&nbsp;by&nbsp;name</span><br>
<span class="lineno"></span><span class="comment" id="5268414">//&nbsp;and&nbsp;the&nbsp;table&nbsp;of&nbsp;additional&nbsp;fold-equivalent&nbsp;code&nbsp;points.</span><br>
<span class="lineno"></span><span class="keyword" id="5268474">func</span>&nbsp;<span class="ident" id="5268479">unicodeTable</span><span class="op" id="5268491">(</span><span class="ident" id="5268492">name</span>&nbsp;<span class="builtintype" id="5268497">string</span><span class="op" id="5268503">)</span>&nbsp;<span class="op" id="5268505">(</span><span class="op" id="5268506">*</span><span class="ident" id="5268507">unicode</span><span class="op" id="5268514">.</span><span class="ident" id="5268515">RangeTable</span><span class="op" id="5268525">,</span>&nbsp;<span class="op" id="5268527">*</span><span class="ident" id="5268528">unicode</span><span class="op" id="5268535">.</span><span class="ident" id="5268536">RangeTable</span><span class="op" id="5268546">)</span>&nbsp;<span class="op" id="5268548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5268551">//&nbsp;Special&nbsp;case:&nbsp;&#34;Any&#34;&nbsp;means&nbsp;any.</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268586">if</span>&nbsp;<span class="ident" id="5268589">name</span>&nbsp;<span class="op" id="5268594">==</span>&nbsp;<span class="string" id="5268597">&#34;Any&#34;</span>&nbsp;<span class="op" id="5268603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268607">return</span>&nbsp;<span class="ident" id="5268614">anyTable</span><span class="op" id="5268622">,</span>&nbsp;<span class="ident" id="5268624">anyTable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5268634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268637">if</span>&nbsp;<span class="ident" id="5268640">t</span>&nbsp;<span class="op" id="5268642">:=</span>&nbsp;<span class="ident" id="5268645">unicode</span><span class="op" id="5268652">.</span><span class="ident" id="5268653">Categories</span><span class="op" id="5268663">[</span><span class="ident" id="5268664">name</span><span class="op" id="5268668">]</span><span class="op" id="5268669">;</span>&nbsp;<span class="ident" id="5268671">t</span>&nbsp;<span class="op" id="5268673">!=</span>&nbsp;<span class="ident" id="5268676">nil</span>&nbsp;<span class="op" id="5268680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268684">return</span>&nbsp;<span class="ident" id="5268691">t</span><span class="op" id="5268692">,</span>&nbsp;<span class="ident" id="5268694">unicode</span><span class="op" id="5268701">.</span><span class="ident" id="5268702">FoldCategory</span><span class="op" id="5268714">[</span><span class="ident" id="5268715">name</span><span class="op" id="5268719">]</span><br>
<span class="lineno">1435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5268722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268725">if</span>&nbsp;<span class="ident" id="5268728">t</span>&nbsp;<span class="op" id="5268730">:=</span>&nbsp;<span class="ident" id="5268733">unicode</span><span class="op" id="5268740">.</span><span class="ident" id="5268741">Scripts</span><span class="op" id="5268748">[</span><span class="ident" id="5268749">name</span><span class="op" id="5268753">]</span><span class="op" id="5268754">;</span>&nbsp;<span class="ident" id="5268756">t</span>&nbsp;<span class="op" id="5268758">!=</span>&nbsp;<span class="ident" id="5268761">nil</span>&nbsp;<span class="op" id="5268765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268769">return</span>&nbsp;<span class="ident" id="5268776">t</span><span class="op" id="5268777">,</span>&nbsp;<span class="ident" id="5268779">unicode</span><span class="op" id="5268786">.</span><span class="ident" id="5268787">FoldScript</span><span class="op" id="5268797">[</span><span class="ident" id="5268798">name</span><span class="op" id="5268802">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5268805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268808">return</span>&nbsp;<span class="ident" id="5268815">nil</span><span class="op" id="5268818">,</span>&nbsp;<span class="ident" id="5268820">nil</span><br>
<span class="lineno">1440</span><span class="op" id="5268824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5268827">//&nbsp;parseUnicodeClass&nbsp;parses&nbsp;a&nbsp;leading&nbsp;Unicode&nbsp;character&nbsp;class&nbsp;like&nbsp;\p{Han}</span><br>
<span class="lineno"></span><span class="comment" id="5268902">//&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s.&nbsp;&nbsp;If&nbsp;one&nbsp;is&nbsp;present,&nbsp;it&nbsp;appends&nbsp;the&nbsp;characters&nbsp;to&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="5268981">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;new&nbsp;slice&nbsp;r&nbsp;and&nbsp;the&nbsp;remainder&nbsp;of&nbsp;the&nbsp;string.</span><br>
<span class="lineno">1445</span><span class="keyword" id="5269045">func</span>&nbsp;<span class="op" id="5269050">(</span><span class="ident" id="5269051">p</span>&nbsp;<span class="op" id="5269053">*</span><span class="ident" id="5269054">parser</span><span class="op" id="5269060">)</span>&nbsp;<span class="ident" id="5269062">parseUnicodeClass</span><span class="op" id="5269079">(</span><span class="ident" id="5269080">s</span>&nbsp;<span class="builtintype" id="5269082">string</span><span class="op" id="5269088">,</span>&nbsp;<span class="ident" id="5269090">r</span>&nbsp;<span class="op" id="5269092">[</span><span class="op" id="5269093">]</span><span class="builtintype" id="5269094">rune</span><span class="op" id="5269098">)</span>&nbsp;<span class="op" id="5269100">(</span><span class="ident" id="5269101">out</span>&nbsp;<span class="op" id="5269105">[</span><span class="op" id="5269106">]</span><span class="builtintype" id="5269107">rune</span><span class="op" id="5269111">,</span>&nbsp;<span class="ident" id="5269113">rest</span>&nbsp;<span class="builtintype" id="5269118">string</span><span class="op" id="5269124">,</span>&nbsp;<span class="ident" id="5269126">err</span>&nbsp;<span class="builtintype" id="5269130">error</span><span class="op" id="5269135">)</span>&nbsp;<span class="op" id="5269137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269140">if</span>&nbsp;<span class="ident" id="5269143">p</span><span class="op" id="5269144">.</span><span class="ident" id="5269145">flags</span><span class="op" id="5269150">&amp;</span><span class="ident" id="5269151">UnicodeGroups</span>&nbsp;<span class="op" id="5269165">==</span>&nbsp;<span class="num" id="5269168">0</span>&nbsp;<span class="op" id="5269170">||</span>&nbsp;<span class="builtinfunc" id="5269173">len</span><span class="op" id="5269176">(</span><span class="ident" id="5269177">s</span><span class="op" id="5269178">)</span>&nbsp;<span class="op" id="5269180">&lt;</span>&nbsp;<span class="num" id="5269182">2</span>&nbsp;<span class="op" id="5269184">||</span>&nbsp;<span class="ident" id="5269187">s</span><span class="op" id="5269188">[</span><span class="num" id="5269189">0</span><span class="op" id="5269190">]</span>&nbsp;<span class="op" id="5269192">!=</span>&nbsp;<span class="string" id="5269195">&#39;\\&#39;</span>&nbsp;<span class="op" id="5269200">||</span>&nbsp;<span class="ident" id="5269203">s</span><span class="op" id="5269204">[</span><span class="num" id="5269205">1</span><span class="op" id="5269206">]</span>&nbsp;<span class="op" id="5269208">!=</span>&nbsp;<span class="string" id="5269211">&#39;p&#39;</span>&nbsp;<span class="op" id="5269215">&amp;&amp;</span>&nbsp;<span class="ident" id="5269218">s</span><span class="op" id="5269219">[</span><span class="num" id="5269220">1</span><span class="op" id="5269221">]</span>&nbsp;<span class="op" id="5269223">!=</span>&nbsp;<span class="string" id="5269226">&#39;P&#39;</span>&nbsp;<span class="op" id="5269230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269234">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5269242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5269246">//&nbsp;Committed&nbsp;to&nbsp;parse&nbsp;or&nbsp;return&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269286">sign</span>&nbsp;<span class="op" id="5269291">:=</span>&nbsp;<span class="op" id="5269294">+</span><span class="num" id="5269295">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269298">if</span>&nbsp;<span class="ident" id="5269301">s</span><span class="op" id="5269302">[</span><span class="num" id="5269303">1</span><span class="op" id="5269304">]</span>&nbsp;<span class="op" id="5269306">==</span>&nbsp;<span class="string" id="5269309">&#39;P&#39;</span>&nbsp;<span class="op" id="5269313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269317">sign</span>&nbsp;<span class="op" id="5269322">=</span>&nbsp;<span class="op" id="5269324">-</span><span class="num" id="5269325">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5269328">}</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269331">t</span>&nbsp;<span class="op" id="5269333">:=</span>&nbsp;<span class="ident" id="5269336">s</span><span class="op" id="5269337">[</span><span class="num" id="5269338">2</span><span class="op" id="5269339">:</span><span class="op" id="5269340">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269343">c</span><span class="op" id="5269344">,</span>&nbsp;<span class="ident" id="5269346">t</span><span class="op" id="5269347">,</span>&nbsp;<span class="ident" id="5269349">err</span>&nbsp;<span class="op" id="5269353">:=</span>&nbsp;<span class="ident" id="5269356">nextRune</span><span class="op" id="5269364">(</span><span class="ident" id="5269365">t</span><span class="op" id="5269366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269369">if</span>&nbsp;<span class="ident" id="5269372">err</span>&nbsp;<span class="op" id="5269376">!=</span>&nbsp;<span class="ident" id="5269379">nil</span>&nbsp;<span class="op" id="5269383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269387">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5269395">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269398">var</span>&nbsp;<span class="ident" id="5269402">seq</span><span class="op" id="5269405">,</span>&nbsp;<span class="ident" id="5269407">name</span>&nbsp;<span class="builtintype" id="5269412">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269420">if</span>&nbsp;<span class="ident" id="5269423">c</span>&nbsp;<span class="op" id="5269425">!=</span>&nbsp;<span class="string" id="5269428">&#39;{&#39;</span>&nbsp;<span class="op" id="5269432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5269436">//&nbsp;Single-letter&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269461">seq</span>&nbsp;<span class="op" id="5269465">=</span>&nbsp;<span class="ident" id="5269467">s</span><span class="op" id="5269468">[</span><span class="op" id="5269469">:</span><span class="builtinfunc" id="5269470">len</span><span class="op" id="5269473">(</span><span class="ident" id="5269474">s</span><span class="op" id="5269475">)</span><span class="op" id="5269476">-</span><span class="builtinfunc" id="5269477">len</span><span class="op" id="5269480">(</span><span class="ident" id="5269481">t</span><span class="op" id="5269482">)</span><span class="op" id="5269483">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269487">name</span>&nbsp;<span class="op" id="5269492">=</span>&nbsp;<span class="ident" id="5269494">seq</span><span class="op" id="5269497">[</span><span class="num" id="5269498">2</span><span class="op" id="5269499">:</span><span class="op" id="5269500">]</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5269503">}</span>&nbsp;<span class="keyword" id="5269505">else</span>&nbsp;<span class="op" id="5269510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5269514">//&nbsp;Name&nbsp;is&nbsp;in&nbsp;braces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269538">end</span>&nbsp;<span class="op" id="5269542">:=</span>&nbsp;<span class="ident" id="5269545">strings</span><span class="op" id="5269552">.</span><span class="ident" id="5269553">IndexRune</span><span class="op" id="5269562">(</span><span class="ident" id="5269563">s</span><span class="op" id="5269564">,</span>&nbsp;<span class="string" id="5269566">&#39;}&#39;</span><span class="op" id="5269569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269573">if</span>&nbsp;<span class="ident" id="5269576">end</span>&nbsp;<span class="op" id="5269580">&lt;</span>&nbsp;<span class="num" id="5269582">0</span>&nbsp;<span class="op" id="5269584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269589">if</span>&nbsp;<span class="ident" id="5269592">err</span>&nbsp;<span class="op" id="5269596">=</span>&nbsp;<span class="ident" id="5269598">checkUTF8</span><span class="op" id="5269607">(</span><span class="ident" id="5269608">s</span><span class="op" id="5269609">)</span><span class="op" id="5269610">;</span>&nbsp;<span class="ident" id="5269612">err</span>&nbsp;<span class="op" id="5269616">!=</span>&nbsp;<span class="ident" id="5269619">nil</span>&nbsp;<span class="op" id="5269623">{</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269629">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5269639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269644">return</span>&nbsp;<span class="ident" id="5269651">nil</span><span class="op" id="5269654">,</span>&nbsp;<span class="string" id="5269656">&#34;&#34;</span><span class="op" id="5269658">,</span>&nbsp;<span class="op" id="5269660">&amp;</span><span class="ident" id="5269661">Error</span><span class="op" id="5269666">{</span><span class="ident" id="5269667">ErrInvalidCharRange</span><span class="op" id="5269686">,</span>&nbsp;<span class="ident" id="5269688">s</span><span class="op" id="5269689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5269693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269697">seq</span><span class="op" id="5269700">,</span>&nbsp;<span class="ident" id="5269702">t</span>&nbsp;<span class="op" id="5269704">=</span>&nbsp;<span class="ident" id="5269706">s</span><span class="op" id="5269707">[</span><span class="op" id="5269708">:</span><span class="ident" id="5269709">end</span><span class="op" id="5269712">+</span><span class="num" id="5269713">1</span><span class="op" id="5269714">]</span><span class="op" id="5269715">,</span>&nbsp;<span class="ident" id="5269717">s</span><span class="op" id="5269718">[</span><span class="ident" id="5269719">end</span><span class="op" id="5269722">+</span><span class="num" id="5269723">1</span><span class="op" id="5269724">:</span><span class="op" id="5269725">]</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269729">name</span>&nbsp;<span class="op" id="5269734">=</span>&nbsp;<span class="ident" id="5269736">s</span><span class="op" id="5269737">[</span><span class="num" id="5269738">3</span><span class="op" id="5269739">:</span><span class="ident" id="5269740">end</span><span class="op" id="5269743">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269747">if</span>&nbsp;<span class="ident" id="5269750">err</span>&nbsp;<span class="op" id="5269754">=</span>&nbsp;<span class="ident" id="5269756">checkUTF8</span><span class="op" id="5269765">(</span><span class="ident" id="5269766">name</span><span class="op" id="5269770">)</span><span class="op" id="5269771">;</span>&nbsp;<span class="ident" id="5269773">err</span>&nbsp;<span class="op" id="5269777">!=</span>&nbsp;<span class="ident" id="5269780">nil</span>&nbsp;<span class="op" id="5269784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269789">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5269798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5269801">}</span><br>
<span class="lineno">1480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5269805">//&nbsp;Group&nbsp;can&nbsp;have&nbsp;leading&nbsp;negation&nbsp;too.&nbsp;&nbsp;\p{^Han}&nbsp;==&nbsp;\P{Han},&nbsp;\P{^Han}&nbsp;==&nbsp;\p{Han}.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269889">if</span>&nbsp;<span class="ident" id="5269892">name</span>&nbsp;<span class="op" id="5269897">!=</span>&nbsp;<span class="string" id="5269900">&#34;&#34;</span>&nbsp;<span class="op" id="5269903">&amp;&amp;</span>&nbsp;<span class="ident" id="5269906">name</span><span class="op" id="5269910">[</span><span class="num" id="5269911">0</span><span class="op" id="5269912">]</span>&nbsp;<span class="op" id="5269914">==</span>&nbsp;<span class="string" id="5269917">&#39;^&#39;</span>&nbsp;<span class="op" id="5269921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269925">sign</span>&nbsp;<span class="op" id="5269930">=</span>&nbsp;<span class="op" id="5269932">-</span><span class="ident" id="5269933">sign</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269940">name</span>&nbsp;<span class="op" id="5269945">=</span>&nbsp;<span class="ident" id="5269947">name</span><span class="op" id="5269951">[</span><span class="num" id="5269952">1</span><span class="op" id="5269953">:</span><span class="op" id="5269954">]</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5269957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269961">tab</span><span class="op" id="5269964">,</span>&nbsp;<span class="ident" id="5269966">fold</span>&nbsp;<span class="op" id="5269971">:=</span>&nbsp;<span class="ident" id="5269974">unicodeTable</span><span class="op" id="5269986">(</span><span class="ident" id="5269987">name</span><span class="op" id="5269991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269994">if</span>&nbsp;<span class="ident" id="5269997">tab</span>&nbsp;<span class="op" id="5270001">==</span>&nbsp;<span class="ident" id="5270004">nil</span>&nbsp;<span class="op" id="5270008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5270012">return</span>&nbsp;<span class="ident" id="5270019">nil</span><span class="op" id="5270022">,</span>&nbsp;<span class="string" id="5270024">&#34;&#34;</span><span class="op" id="5270026">,</span>&nbsp;<span class="op" id="5270028">&amp;</span><span class="ident" id="5270029">Error</span><span class="op" id="5270034">{</span><span class="ident" id="5270035">ErrInvalidCharRange</span><span class="op" id="5270054">,</span>&nbsp;<span class="ident" id="5270056">seq</span><span class="op" id="5270059">}</span><br>
<span class="lineno">1490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5270062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5270066">if</span>&nbsp;<span class="ident" id="5270069">p</span><span class="op" id="5270070">.</span><span class="ident" id="5270071">flags</span><span class="op" id="5270076">&amp;</span><span class="ident" id="5270077">FoldCase</span>&nbsp;<span class="op" id="5270086">==</span>&nbsp;<span class="num" id="5270089">0</span>&nbsp;<span class="op" id="5270091">||</span>&nbsp;<span class="ident" id="5270094">fold</span>&nbsp;<span class="op" id="5270099">==</span>&nbsp;<span class="ident" id="5270102">nil</span>&nbsp;<span class="op" id="5270106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5270110">if</span>&nbsp;<span class="ident" id="5270113">sign</span>&nbsp;<span class="op" id="5270118">&gt;</span>&nbsp;<span class="num" id="5270120">0</span>&nbsp;<span class="op" id="5270122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270127">r</span>&nbsp;<span class="op" id="5270129">=</span>&nbsp;<span class="ident" id="5270131">appendTable</span><span class="op" id="5270142">(</span><span class="ident" id="5270143">r</span><span class="op" id="5270144">,</span>&nbsp;<span class="ident" id="5270146">tab</span><span class="op" id="5270149">)</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5270153">}</span>&nbsp;<span class="keyword" id="5270155">else</span>&nbsp;<span class="op" id="5270160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270165">r</span>&nbsp;<span class="op" id="5270167">=</span>&nbsp;<span class="ident" id="5270169">appendNegatedTable</span><span class="op" id="5270187">(</span><span class="ident" id="5270188">r</span><span class="op" id="5270189">,</span>&nbsp;<span class="ident" id="5270191">tab</span><span class="op" id="5270194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5270198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5270201">}</span>&nbsp;<span class="keyword" id="5270203">else</span>&nbsp;<span class="op" id="5270208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5270212">//&nbsp;Merge&nbsp;and&nbsp;clean&nbsp;tab&nbsp;and&nbsp;fold&nbsp;in&nbsp;a&nbsp;temporary&nbsp;buffer.</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5270269">//&nbsp;This&nbsp;is&nbsp;necessary&nbsp;for&nbsp;the&nbsp;negative&nbsp;case&nbsp;and&nbsp;just&nbsp;tidy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5270328">//&nbsp;for&nbsp;the&nbsp;positive&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270356">tmp</span>&nbsp;<span class="op" id="5270360">:=</span>&nbsp;<span class="ident" id="5270363">p</span><span class="op" id="5270364">.</span><span class="ident" id="5270365">tmpClass</span><span class="op" id="5270373">[</span><span class="op" id="5270374">:</span><span class="num" id="5270375">0</span><span class="op" id="5270376">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270380">tmp</span>&nbsp;<span class="op" id="5270384">=</span>&nbsp;<span class="ident" id="5270386">appendTable</span><span class="op" id="5270397">(</span><span class="ident" id="5270398">tmp</span><span class="op" id="5270401">,</span>&nbsp;<span class="ident" id="5270403">tab</span><span class="op" id="5270406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270410">tmp</span>&nbsp;<span class="op" id="5270414">=</span>&nbsp;<span class="ident" id="5270416">appendTable</span><span class="op" id="5270427">(</span><span class="ident" id="5270428">tmp</span><span class="op" id="5270431">,</span>&nbsp;<span class="ident" id="5270433">fold</span><span class="op" id="5270437">)</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270441">p</span><span class="op" id="5270442">.</span><span class="ident" id="5270443">tmpClass</span>&nbsp;<span class="op" id="5270452">=</span>&nbsp;<span class="ident" id="5270454">tmp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270460">tmp</span>&nbsp;<span class="op" id="5270464">=</span>&nbsp;<span class="ident" id="5270466">cleanClass</span><span class="op" id="5270476">(</span><span class="op" id="5270477">&amp;</span><span class="ident" id="5270478">p</span><span class="op" id="5270479">.</span><span class="ident" id="5270480">tmpClass</span><span class="op" id="5270488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5270492">if</span>&nbsp;<span class="ident" id="5270495">sign</span>&nbsp;<span class="op" id="5270500">&gt;</span>&nbsp;<span class="num" id="5270502">0</span>&nbsp;<span class="op" id="5270504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270509">r</span>&nbsp;<span class="op" id="5270511">=</span>&nbsp;<span class="ident" id="5270513">appendClass</span><span class="op" id="5270524">(</span><span class="ident" id="5270525">r</span><span class="op" id="5270526">,</span>&nbsp;<span class="ident" id="5270528">tmp</span><span class="op" id="5270531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5270535">}</span>&nbsp;<span class="keyword" id="5270537">else</span>&nbsp;<span class="op" id="5270542">{</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270547">r</span>&nbsp;<span class="op" id="5270549">=</span>&nbsp;<span class="ident" id="5270551">appendNegatedClass</span><span class="op" id="5270569">(</span><span class="ident" id="5270570">r</span><span class="op" id="5270571">,</span>&nbsp;<span class="ident" id="5270573">tmp</span><span class="op" id="5270576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5270580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5270583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5270586">return</span>&nbsp;<span class="ident" id="5270593">r</span><span class="op" id="5270594">,</span>&nbsp;<span class="ident" id="5270596">t</span><span class="op" id="5270597">,</span>&nbsp;<span class="ident" id="5270599">nil</span><br>
<span class="lineno"></span><span class="op" id="5270603">}</span><br>
<span class="lineno">1515</span><br>
<span class="lineno"></span><span class="comment" id="5270606">//&nbsp;parseClass&nbsp;parses&nbsp;a&nbsp;character&nbsp;class&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s</span><br>
<span class="lineno"></span><span class="comment" id="5270667">//&nbsp;and&nbsp;pushes&nbsp;it&nbsp;onto&nbsp;the&nbsp;parse&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="5270706">func</span>&nbsp;<span class="op" id="5270711">(</span><span class="ident" id="5270712">p</span>&nbsp;<span class="op" id="5270714">*</span><span class="ident" id="5270715">parser</span><span class="op" id="5270721">)</span>&nbsp;<span class="ident" id="5270723">parseClass</span><span class="op" id="5270733">(</span><span class="ident" id="5270734">s</span>&nbsp;<span class="builtintype" id="5270736">string</span><span class="op" id="5270742">)</span>&nbsp;<span class="op" id="5270744">(</span><span class="ident" id="5270745">rest</span>&nbsp;<span class="builtintype" id="5270750">string</span><span class="op" id="5270756">,</span>&nbsp;<span class="ident" id="5270758">err</span>&nbsp;<span class="builtintype" id="5270762">error</span><span class="op" id="5270767">)</span>&nbsp;<span class="op" id="5270769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270772">t</span>&nbsp;<span class="op" id="5270774">:=</span>&nbsp;<span class="ident" id="5270777">s</span><span class="op" id="5270778">[</span><span class="num" id="5270779">1</span><span class="op" id="5270780">:</span><span class="op" id="5270781">]</span>&nbsp;<span class="comment" id="5270783">//&nbsp;chop&nbsp;[</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270794">re</span>&nbsp;<span class="op" id="5270797">:=</span>&nbsp;<span class="ident" id="5270800">p</span><span class="op" id="5270801">.</span><span class="ident" id="5270802">newRegexp</span><span class="op" id="5270811">(</span><span class="ident" id="5270812">OpCharClass</span><span class="op" id="5270823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270826">re</span><span class="op" id="5270828">.</span><span class="ident" id="5270829">Flags</span>&nbsp;<span class="op" id="5270835">=</span>&nbsp;<span class="ident" id="5270837">p</span><span class="op" id="5270838">.</span><span class="ident" id="5270839">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270846">re</span><span class="op" id="5270848">.</span><span class="ident" id="5270849">Rune</span>&nbsp;<span class="op" id="5270854">=</span>&nbsp;<span class="ident" id="5270856">re</span><span class="op" id="5270858">.</span><span class="ident" id="5270859">Rune0</span><span class="op" id="5270864">[</span><span class="op" id="5270865">:</span><span class="num" id="5270866">0</span><span class="op" id="5270867">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270871">sign</span>&nbsp;<span class="op" id="5270876">:=</span>&nbsp;<span class="op" id="5270879">+</span><span class="num" id="5270880">1</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5270883">if</span>&nbsp;<span class="ident" id="5270886">t</span>&nbsp;<span class="op" id="5270888">!=</span>&nbsp;<span class="string" id="5270891">&#34;&#34;</span>&nbsp;<span class="op" id="5270894">&amp;&amp;</span>&nbsp;<span class="ident" id="5270897">t</span><span class="op" id="5270898">[</span><span class="num" id="5270899">0</span><span class="op" id="5270900">]</span>&nbsp;<span class="op" id="5270902">==</span>&nbsp;<span class="string" id="5270905">&#39;^&#39;</span>&nbsp;<span class="op" id="5270909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270913">sign</span>&nbsp;<span class="op" id="5270918">=</span>&nbsp;<span class="op" id="5270920">-</span><span class="num" id="5270921">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270925">t</span>&nbsp;<span class="op" id="5270927">=</span>&nbsp;<span class="ident" id="5270929">t</span><span class="op" id="5270930">[</span><span class="num" id="5270931">1</span><span class="op" id="5270932">:</span><span class="op" id="5270933">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5270938">//&nbsp;If&nbsp;character&nbsp;class&nbsp;does&nbsp;not&nbsp;match&nbsp;\n,&nbsp;add&nbsp;it&nbsp;here,</span><br>
<span class="lineno">1530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5270994">//&nbsp;so&nbsp;that&nbsp;negation&nbsp;later&nbsp;will&nbsp;do&nbsp;the&nbsp;right&nbsp;thing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271047">if</span>&nbsp;<span class="ident" id="5271050">p</span><span class="op" id="5271051">.</span><span class="ident" id="5271052">flags</span><span class="op" id="5271057">&amp;</span><span class="ident" id="5271058">ClassNL</span>&nbsp;<span class="op" id="5271066">==</span>&nbsp;<span class="num" id="5271069">0</span>&nbsp;<span class="op" id="5271071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271076">re</span><span class="op" id="5271078">.</span><span class="ident" id="5271079">Rune</span>&nbsp;<span class="op" id="5271084">=</span>&nbsp;<span class="builtinfunc" id="5271086">append</span><span class="op" id="5271092">(</span><span class="ident" id="5271093">re</span><span class="op" id="5271095">.</span><span class="ident" id="5271096">Rune</span><span class="op" id="5271100">,</span>&nbsp;<span class="string" id="5271102">&#39;\n&#39;</span><span class="op" id="5271106">,</span>&nbsp;<span class="string" id="5271108">&#39;\n&#39;</span><span class="op" id="5271112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5271116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5271119">}</span><br>
<span class="lineno">1535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271123">class</span>&nbsp;<span class="op" id="5271129">:=</span>&nbsp;<span class="ident" id="5271132">re</span><span class="op" id="5271134">.</span><span class="ident" id="5271135">Rune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271141">first</span>&nbsp;<span class="op" id="5271147">:=</span>&nbsp;<span class="ident" id="5271150">true</span>&nbsp;<span class="comment" id="5271155">//&nbsp;]&nbsp;and&nbsp;-&nbsp;are&nbsp;okay&nbsp;as&nbsp;first&nbsp;char&nbsp;in&nbsp;class</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271199">for</span>&nbsp;<span class="ident" id="5271203">t</span>&nbsp;<span class="op" id="5271205">==</span>&nbsp;<span class="string" id="5271208">&#34;&#34;</span>&nbsp;<span class="op" id="5271211">||</span>&nbsp;<span class="ident" id="5271214">t</span><span class="op" id="5271215">[</span><span class="num" id="5271216">0</span><span class="op" id="5271217">]</span>&nbsp;<span class="op" id="5271219">!=</span>&nbsp;<span class="string" id="5271222">&#39;]&#39;</span>&nbsp;<span class="op" id="5271226">||</span>&nbsp;<span class="ident" id="5271229">first</span>&nbsp;<span class="op" id="5271235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5271239">//&nbsp;POSIX:&nbsp;-&nbsp;is&nbsp;only&nbsp;okay&nbsp;unescaped&nbsp;as&nbsp;first&nbsp;or&nbsp;last&nbsp;in&nbsp;class.</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5271303">//&nbsp;Perl:&nbsp;-&nbsp;is&nbsp;okay&nbsp;anywhere.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271334">if</span>&nbsp;<span class="ident" id="5271337">t</span>&nbsp;<span class="op" id="5271339">!=</span>&nbsp;<span class="string" id="5271342">&#34;&#34;</span>&nbsp;<span class="op" id="5271345">&amp;&amp;</span>&nbsp;<span class="ident" id="5271348">t</span><span class="op" id="5271349">[</span><span class="num" id="5271350">0</span><span class="op" id="5271351">]</span>&nbsp;<span class="op" id="5271353">==</span>&nbsp;<span class="string" id="5271356">&#39;-&#39;</span>&nbsp;<span class="op" id="5271360">&amp;&amp;</span>&nbsp;<span class="ident" id="5271363">p</span><span class="op" id="5271364">.</span><span class="ident" id="5271365">flags</span><span class="op" id="5271370">&amp;</span><span class="ident" id="5271371">PerlX</span>&nbsp;<span class="op" id="5271377">==</span>&nbsp;<span class="num" id="5271380">0</span>&nbsp;<span class="op" id="5271382">&amp;&amp;</span>&nbsp;<span class="op" id="5271385">!</span><span class="ident" id="5271386">first</span>&nbsp;<span class="op" id="5271392">&amp;&amp;</span>&nbsp;<span class="op" id="5271395">(</span><span class="builtinfunc" id="5271396">len</span><span class="op" id="5271399">(</span><span class="ident" id="5271400">t</span><span class="op" id="5271401">)</span>&nbsp;<span class="op" id="5271403">==</span>&nbsp;<span class="num" id="5271406">1</span>&nbsp;<span class="op" id="5271408">||</span>&nbsp;<span class="ident" id="5271411">t</span><span class="op" id="5271412">[</span><span class="num" id="5271413">1</span><span class="op" id="5271414">]</span>&nbsp;<span class="op" id="5271416">!=</span>&nbsp;<span class="string" id="5271419">&#39;]&#39;</span><span class="op" id="5271422">)</span>&nbsp;<span class="op" id="5271424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271429">_</span><span class="op" id="5271430">,</span>&nbsp;<span class="ident" id="5271432">size</span>&nbsp;<span class="op" id="5271437">:=</span>&nbsp;<span class="ident" id="5271440">utf8</span><span class="op" id="5271444">.</span><span class="ident" id="5271445">DecodeRuneInString</span><span class="op" id="5271463">(</span><span class="ident" id="5271464">t</span><span class="op" id="5271465">[</span><span class="num" id="5271466">1</span><span class="op" id="5271467">:</span><span class="op" id="5271468">]</span><span class="op" id="5271469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271474">return</span>&nbsp;<span class="string" id="5271481">&#34;&#34;</span><span class="op" id="5271483">,</span>&nbsp;<span class="op" id="5271485">&amp;</span><span class="ident" id="5271486">Error</span><span class="op" id="5271491">{</span><span class="ident" id="5271492">Code</span><span class="op" id="5271496">:</span>&nbsp;<span class="ident" id="5271498">ErrInvalidCharRange</span><span class="op" id="5271517">,</span>&nbsp;<span class="ident" id="5271519">Expr</span><span class="op" id="5271523">:</span>&nbsp;<span class="ident" id="5271525">t</span><span class="op" id="5271526">[</span><span class="op" id="5271527">:</span><span class="num" id="5271528">1</span><span class="op" id="5271529">+</span><span class="ident" id="5271530">size</span><span class="op" id="5271534">]</span><span class="op" id="5271535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5271539">}</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271543">first</span>&nbsp;<span class="op" id="5271549">=</span>&nbsp;<span class="ident" id="5271551">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5271560">//&nbsp;Look&nbsp;for&nbsp;POSIX&nbsp;[:alnum:]&nbsp;etc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271595">if</span>&nbsp;<span class="builtinfunc" id="5271598">len</span><span class="op" id="5271601">(</span><span class="ident" id="5271602">t</span><span class="op" id="5271603">)</span>&nbsp;<span class="op" id="5271605">&gt;</span>&nbsp;<span class="num" id="5271607">2</span>&nbsp;<span class="op" id="5271609">&amp;&amp;</span>&nbsp;<span class="ident" id="5271612">t</span><span class="op" id="5271613">[</span><span class="num" id="5271614">0</span><span class="op" id="5271615">]</span>&nbsp;<span class="op" id="5271617">==</span>&nbsp;<span class="string" id="5271620">&#39;[&#39;</span>&nbsp;<span class="op" id="5271624">&amp;&amp;</span>&nbsp;<span class="ident" id="5271627">t</span><span class="op" id="5271628">[</span><span class="num" id="5271629">1</span><span class="op" id="5271630">]</span>&nbsp;<span class="op" id="5271632">==</span>&nbsp;<span class="string" id="5271635">&#39;:&#39;</span>&nbsp;<span class="op" id="5271639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271644">nclass</span><span class="op" id="5271650">,</span>&nbsp;<span class="ident" id="5271652">nt</span><span class="op" id="5271654">,</span>&nbsp;<span class="ident" id="5271656">err</span>&nbsp;<span class="op" id="5271660">:=</span>&nbsp;<span class="ident" id="5271663">p</span><span class="op" id="5271664">.</span><span class="ident" id="5271665">parseNamedClass</span><span class="op" id="5271680">(</span><span class="ident" id="5271681">t</span><span class="op" id="5271682">,</span>&nbsp;<span class="ident" id="5271684">class</span><span class="op" id="5271689">)</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271694">if</span>&nbsp;<span class="ident" id="5271697">err</span>&nbsp;<span class="op" id="5271701">!=</span>&nbsp;<span class="ident" id="5271704">nil</span>&nbsp;<span class="op" id="5271708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271714">return</span>&nbsp;<span class="string" id="5271721">&#34;&#34;</span><span class="op" id="5271723">,</span>&nbsp;<span class="ident" id="5271725">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5271732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271737">if</span>&nbsp;<span class="ident" id="5271740">nclass</span>&nbsp;<span class="op" id="5271747">!=</span>&nbsp;<span class="ident" id="5271750">nil</span>&nbsp;<span class="op" id="5271754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271760">class</span><span class="op" id="5271765">,</span>&nbsp;<span class="ident" id="5271767">t</span>&nbsp;<span class="op" id="5271769">=</span>&nbsp;<span class="ident" id="5271771">nclass</span><span class="op" id="5271777">,</span>&nbsp;<span class="ident" id="5271779">nt</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271786">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5271798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5271802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5271807">//&nbsp;Look&nbsp;for&nbsp;Unicode&nbsp;character&nbsp;group&nbsp;like&nbsp;\p{Han}.</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271859">nclass</span><span class="op" id="5271865">,</span>&nbsp;<span class="ident" id="5271867">nt</span><span class="op" id="5271869">,</span>&nbsp;<span class="ident" id="5271871">err</span>&nbsp;<span class="op" id="5271875">:=</span>&nbsp;<span class="ident" id="5271878">p</span><span class="op" id="5271879">.</span><span class="ident" id="5271880">parseUnicodeClass</span><span class="op" id="5271897">(</span><span class="ident" id="5271898">t</span><span class="op" id="5271899">,</span>&nbsp;<span class="ident" id="5271901">class</span><span class="op" id="5271906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271910">if</span>&nbsp;<span class="ident" id="5271913">err</span>&nbsp;<span class="op" id="5271917">!=</span>&nbsp;<span class="ident" id="5271920">nil</span>&nbsp;<span class="op" id="5271924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271929">return</span>&nbsp;<span class="string" id="5271936">&#34;&#34;</span><span class="op" id="5271938">,</span>&nbsp;<span class="ident" id="5271940">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5271946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271950">if</span>&nbsp;<span class="ident" id="5271953">nclass</span>&nbsp;<span class="op" id="5271960">!=</span>&nbsp;<span class="ident" id="5271963">nil</span>&nbsp;<span class="op" id="5271967">{</span><br>
<span class="lineno">1565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271972">class</span><span class="op" id="5271977">,</span>&nbsp;<span class="ident" id="5271979">t</span>&nbsp;<span class="op" id="5271981">=</span>&nbsp;<span class="ident" id="5271983">nclass</span><span class="op" id="5271989">,</span>&nbsp;<span class="ident" id="5271991">nt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271997">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5272008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5272013">//&nbsp;Look&nbsp;for&nbsp;Perl&nbsp;character&nbsp;class&nbsp;symbols&nbsp;(extension).</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272069">if</span>&nbsp;<span class="ident" id="5272072">nclass</span><span class="op" id="5272078">,</span>&nbsp;<span class="ident" id="5272080">nt</span>&nbsp;<span class="op" id="5272083">:=</span>&nbsp;<span class="ident" id="5272086">p</span><span class="op" id="5272087">.</span><span class="ident" id="5272088">parsePerlClassEscape</span><span class="op" id="5272108">(</span><span class="ident" id="5272109">t</span><span class="op" id="5272110">,</span>&nbsp;<span class="ident" id="5272112">class</span><span class="op" id="5272117">)</span><span class="op" id="5272118">;</span>&nbsp;<span class="ident" id="5272120">nclass</span>&nbsp;<span class="op" id="5272127">!=</span>&nbsp;<span class="ident" id="5272130">nil</span>&nbsp;<span class="op" id="5272134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272139">class</span><span class="op" id="5272144">,</span>&nbsp;<span class="ident" id="5272146">t</span>&nbsp;<span class="op" id="5272148">=</span>&nbsp;<span class="ident" id="5272150">nclass</span><span class="op" id="5272156">,</span>&nbsp;<span class="ident" id="5272158">nt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272164">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5272175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5272180">//&nbsp;Single&nbsp;character&nbsp;or&nbsp;simple&nbsp;range.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272219">rng</span>&nbsp;<span class="op" id="5272223">:=</span>&nbsp;<span class="ident" id="5272226">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272230">var</span>&nbsp;<span class="ident" id="5272234">lo</span><span class="op" id="5272236">,</span>&nbsp;<span class="ident" id="5272238">hi</span>&nbsp;<span class="builtintype" id="5272241">rune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272248">if</span>&nbsp;<span class="ident" id="5272251">lo</span><span class="op" id="5272253">,</span>&nbsp;<span class="ident" id="5272255">t</span><span class="op" id="5272256">,</span>&nbsp;<span class="ident" id="5272258">err</span>&nbsp;<span class="op" id="5272262">=</span>&nbsp;<span class="ident" id="5272264">p</span><span class="op" id="5272265">.</span><span class="ident" id="5272266">parseClassChar</span><span class="op" id="5272280">(</span><span class="ident" id="5272281">t</span><span class="op" id="5272282">,</span>&nbsp;<span class="ident" id="5272284">s</span><span class="op" id="5272285">)</span><span class="op" id="5272286">;</span>&nbsp;<span class="ident" id="5272288">err</span>&nbsp;<span class="op" id="5272292">!=</span>&nbsp;<span class="ident" id="5272295">nil</span>&nbsp;<span class="op" id="5272299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272304">return</span>&nbsp;<span class="string" id="5272311">&#34;&#34;</span><span class="op" id="5272313">,</span>&nbsp;<span class="ident" id="5272315">err</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5272321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272325">hi</span>&nbsp;<span class="op" id="5272328">=</span>&nbsp;<span class="ident" id="5272330">lo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5272335">//&nbsp;[a-]&nbsp;means&nbsp;(a|-)&nbsp;so&nbsp;check&nbsp;for&nbsp;final&nbsp;].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272379">if</span>&nbsp;<span class="builtinfunc" id="5272382">len</span><span class="op" id="5272385">(</span><span class="ident" id="5272386">t</span><span class="op" id="5272387">)</span>&nbsp;<span class="op" id="5272389">&gt;=</span>&nbsp;<span class="num" id="5272392">2</span>&nbsp;<span class="op" id="5272394">&amp;&amp;</span>&nbsp;<span class="ident" id="5272397">t</span><span class="op" id="5272398">[</span><span class="num" id="5272399">0</span><span class="op" id="5272400">]</span>&nbsp;<span class="op" id="5272402">==</span>&nbsp;<span class="string" id="5272405">&#39;-&#39;</span>&nbsp;<span class="op" id="5272409">&amp;&amp;</span>&nbsp;<span class="ident" id="5272412">t</span><span class="op" id="5272413">[</span><span class="num" id="5272414">1</span><span class="op" id="5272415">]</span>&nbsp;<span class="op" id="5272417">!=</span>&nbsp;<span class="string" id="5272420">&#39;]&#39;</span>&nbsp;<span class="op" id="5272424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272429">t</span>&nbsp;<span class="op" id="5272431">=</span>&nbsp;<span class="ident" id="5272433">t</span><span class="op" id="5272434">[</span><span class="num" id="5272435">1</span><span class="op" id="5272436">:</span><span class="op" id="5272437">]</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272442">if</span>&nbsp;<span class="ident" id="5272445">hi</span><span class="op" id="5272447">,</span>&nbsp;<span class="ident" id="5272449">t</span><span class="op" id="5272450">,</span>&nbsp;<span class="ident" id="5272452">err</span>&nbsp;<span class="op" id="5272456">=</span>&nbsp;<span class="ident" id="5272458">p</span><span class="op" id="5272459">.</span><span class="ident" id="5272460">parseClassChar</span><span class="op" id="5272474">(</span><span class="ident" id="5272475">t</span><span class="op" id="5272476">,</span>&nbsp;<span class="ident" id="5272478">s</span><span class="op" id="5272479">)</span><span class="op" id="5272480">;</span>&nbsp;<span class="ident" id="5272482">err</span>&nbsp;<span class="op" id="5272486">!=</span>&nbsp;<span class="ident" id="5272489">nil</span>&nbsp;<span class="op" id="5272493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272499">return</span>&nbsp;<span class="string" id="5272506">&#34;&#34;</span><span class="op" id="5272508">,</span>&nbsp;<span class="ident" id="5272510">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5272517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272522">if</span>&nbsp;<span class="ident" id="5272525">hi</span>&nbsp;<span class="op" id="5272528">&lt;</span>&nbsp;<span class="ident" id="5272530">lo</span>&nbsp;<span class="op" id="5272533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272539">rng</span>&nbsp;<span class="op" id="5272543">=</span>&nbsp;<span class="ident" id="5272545">rng</span><span class="op" id="5272548">[</span><span class="op" id="5272549">:</span><span class="builtinfunc" id="5272550">len</span><span class="op" id="5272553">(</span><span class="ident" id="5272554">rng</span><span class="op" id="5272557">)</span><span class="op" id="5272558">-</span><span class="builtinfunc" id="5272559">len</span><span class="op" id="5272562">(</span><span class="ident" id="5272563">t</span><span class="op" id="5272564">)</span><span class="op" id="5272565">]</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272571">return</span>&nbsp;<span class="string" id="5272578">&#34;&#34;</span><span class="op" id="5272580">,</span>&nbsp;<span class="op" id="5272582">&amp;</span><span class="ident" id="5272583">Error</span><span class="op" id="5272588">{</span><span class="ident" id="5272589">Code</span><span class="op" id="5272593">:</span>&nbsp;<span class="ident" id="5272595">ErrInvalidCharRange</span><span class="op" id="5272614">,</span>&nbsp;<span class="ident" id="5272616">Expr</span><span class="op" id="5272620">:</span>&nbsp;<span class="ident" id="5272622">rng</span><span class="op" id="5272625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5272630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5272634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272638">if</span>&nbsp;<span class="ident" id="5272641">p</span><span class="op" id="5272642">.</span><span class="ident" id="5272643">flags</span><span class="op" id="5272648">&amp;</span><span class="ident" id="5272649">FoldCase</span>&nbsp;<span class="op" id="5272658">==</span>&nbsp;<span class="num" id="5272661">0</span>&nbsp;<span class="op" id="5272663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272668">class</span>&nbsp;<span class="op" id="5272674">=</span>&nbsp;<span class="ident" id="5272676">appendRange</span><span class="op" id="5272687">(</span><span class="ident" id="5272688">class</span><span class="op" id="5272693">,</span>&nbsp;<span class="ident" id="5272695">lo</span><span class="op" id="5272697">,</span>&nbsp;<span class="ident" id="5272699">hi</span><span class="op" id="5272701">)</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5272705">}</span>&nbsp;<span class="keyword" id="5272707">else</span>&nbsp;<span class="op" id="5272712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272717">class</span>&nbsp;<span class="op" id="5272723">=</span>&nbsp;<span class="ident" id="5272725">appendFoldedRange</span><span class="op" id="5272742">(</span><span class="ident" id="5272743">class</span><span class="op" id="5272748">,</span>&nbsp;<span class="ident" id="5272750">lo</span><span class="op" id="5272752">,</span>&nbsp;<span class="ident" id="5272754">hi</span><span class="op" id="5272756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5272760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5272763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272766">t</span>&nbsp;<span class="op" id="5272768">=</span>&nbsp;<span class="ident" id="5272770">t</span><span class="op" id="5272771">[</span><span class="num" id="5272772">1</span><span class="op" id="5272773">:</span><span class="op" id="5272774">]</span>&nbsp;<span class="comment" id="5272776">//&nbsp;chop&nbsp;]</span><br>
<span class="lineno">1600</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5272788">//&nbsp;Use&nbsp;&amp;re.Rune&nbsp;instead&nbsp;of&nbsp;&amp;class&nbsp;to&nbsp;avoid&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272844">re</span><span class="op" id="5272846">.</span><span class="ident" id="5272847">Rune</span>&nbsp;<span class="op" id="5272852">=</span>&nbsp;<span class="ident" id="5272854">class</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272861">class</span>&nbsp;<span class="op" id="5272867">=</span>&nbsp;<span class="ident" id="5272869">cleanClass</span><span class="op" id="5272879">(</span><span class="op" id="5272880">&amp;</span><span class="ident" id="5272881">re</span><span class="op" id="5272883">.</span><span class="ident" id="5272884">Rune</span><span class="op" id="5272888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272891">if</span>&nbsp;<span class="ident" id="5272894">sign</span>&nbsp;<span class="op" id="5272899">&lt;</span>&nbsp;<span class="num" id="5272901">0</span>&nbsp;<span class="op" id="5272903">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272907">class</span>&nbsp;<span class="op" id="5272913">=</span>&nbsp;<span class="ident" id="5272915">negateClass</span><span class="op" id="5272926">(</span><span class="ident" id="5272927">class</span><span class="op" id="5272932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5272935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272938">re</span><span class="op" id="5272940">.</span><span class="ident" id="5272941">Rune</span>&nbsp;<span class="op" id="5272946">=</span>&nbsp;<span class="ident" id="5272948">class</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272955">p</span><span class="op" id="5272956">.</span><span class="ident" id="5272957">push</span><span class="op" id="5272961">(</span><span class="ident" id="5272962">re</span><span class="op" id="5272964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272967">return</span>&nbsp;<span class="ident" id="5272974">t</span><span class="op" id="5272975">,</span>&nbsp;<span class="ident" id="5272977">nil</span><br>
<span class="lineno">1610</span><span class="op" id="5272981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5272984">//&nbsp;cleanClass&nbsp;sorts&nbsp;the&nbsp;ranges&nbsp;(pairs&nbsp;of&nbsp;elements&nbsp;of&nbsp;r),</span><br>
<span class="lineno"></span><span class="comment" id="5273041">//&nbsp;merges&nbsp;them,&nbsp;and&nbsp;eliminates&nbsp;duplicates.</span><br>
<span class="lineno"></span><span class="keyword" id="5273084">func</span>&nbsp;<span class="ident" id="5273089">cleanClass</span><span class="op" id="5273099">(</span><span class="ident" id="5273100">rp</span>&nbsp;<span class="op" id="5273103">*</span><span class="op" id="5273104">[</span><span class="op" id="5273105">]</span><span class="builtintype" id="5273106">rune</span><span class="op" id="5273110">)</span>&nbsp;<span class="op" id="5273112">[</span><span class="op" id="5273113">]</span><span class="builtintype" id="5273114">rune</span>&nbsp;<span class="op" id="5273119">{</span><br>
<span class="lineno">1615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5273123">//&nbsp;Sort&nbsp;by&nbsp;lo&nbsp;increasing,&nbsp;hi&nbsp;decreasing&nbsp;to&nbsp;break&nbsp;ties.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273179">sort</span><span class="op" id="5273183">.</span><span class="ident" id="5273184">Sort</span><span class="op" id="5273188">(</span><span class="ident" id="5273189">ranges</span><span class="op" id="5273195">{</span><span class="ident" id="5273196">rp</span><span class="op" id="5273198">}</span><span class="op" id="5273199">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273203">r</span>&nbsp;<span class="op" id="5273205">:=</span>&nbsp;<span class="op" id="5273208">*</span><span class="ident" id="5273209">rp</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273213">if</span>&nbsp;<span class="builtinfunc" id="5273216">len</span><span class="op" id="5273219">(</span><span class="ident" id="5273220">r</span><span class="op" id="5273221">)</span>&nbsp;<span class="op" id="5273223">&lt;</span>&nbsp;<span class="num" id="5273225">2</span>&nbsp;<span class="op" id="5273227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273231">return</span>&nbsp;<span class="ident" id="5273238">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5273241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5273245">//&nbsp;Merge&nbsp;abutting,&nbsp;overlapping.</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273278">w</span>&nbsp;<span class="op" id="5273280">:=</span>&nbsp;<span class="num" id="5273283">2</span>&nbsp;<span class="comment" id="5273285">//&nbsp;write&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273301">for</span>&nbsp;<span class="ident" id="5273305">i</span>&nbsp;<span class="op" id="5273307">:=</span>&nbsp;<span class="num" id="5273310">2</span><span class="op" id="5273311">;</span>&nbsp;<span class="ident" id="5273313">i</span>&nbsp;<span class="op" id="5273315">&lt;</span>&nbsp;<span class="builtinfunc" id="5273317">len</span><span class="op" id="5273320">(</span><span class="ident" id="5273321">r</span><span class="op" id="5273322">)</span><span class="op" id="5273323">;</span>&nbsp;<span class="ident" id="5273325">i</span>&nbsp;<span class="op" id="5273327">+=</span>&nbsp;<span class="num" id="5273330">2</span>&nbsp;<span class="op" id="5273332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273336">lo</span><span class="op" id="5273338">,</span>&nbsp;<span class="ident" id="5273340">hi</span>&nbsp;<span class="op" id="5273343">:=</span>&nbsp;<span class="ident" id="5273346">r</span><span class="op" id="5273347">[</span><span class="ident" id="5273348">i</span><span class="op" id="5273349">]</span><span class="op" id="5273350">,</span>&nbsp;<span class="ident" id="5273352">r</span><span class="op" id="5273353">[</span><span class="ident" id="5273354">i</span><span class="op" id="5273355">+</span><span class="num" id="5273356">1</span><span class="op" id="5273357">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273361">if</span>&nbsp;<span class="ident" id="5273364">lo</span>&nbsp;<span class="op" id="5273367">&lt;=</span>&nbsp;<span class="ident" id="5273370">r</span><span class="op" id="5273371">[</span><span class="ident" id="5273372">w</span><span class="op" id="5273373">-</span><span class="num" id="5273374">1</span><span class="op" id="5273375">]</span><span class="op" id="5273376">+</span><span class="num" id="5273377">1</span>&nbsp;<span class="op" id="5273379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5273384">//&nbsp;merge&nbsp;with&nbsp;previous&nbsp;range</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273416">if</span>&nbsp;<span class="ident" id="5273419">hi</span>&nbsp;<span class="op" id="5273422">&gt;</span>&nbsp;<span class="ident" id="5273424">r</span><span class="op" id="5273425">[</span><span class="ident" id="5273426">w</span><span class="op" id="5273427">-</span><span class="num" id="5273428">1</span><span class="op" id="5273429">]</span>&nbsp;<span class="op" id="5273431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273437">r</span><span class="op" id="5273438">[</span><span class="ident" id="5273439">w</span><span class="op" id="5273440">-</span><span class="num" id="5273441">1</span><span class="op" id="5273442">]</span>&nbsp;<span class="op" id="5273444">=</span>&nbsp;<span class="ident" id="5273446">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5273452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273457">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5273468">}</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5273472">//&nbsp;new&nbsp;disjoint&nbsp;range</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273496">r</span><span class="op" id="5273497">[</span><span class="ident" id="5273498">w</span><span class="op" id="5273499">]</span>&nbsp;<span class="op" id="5273501">=</span>&nbsp;<span class="ident" id="5273503">lo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273508">r</span><span class="op" id="5273509">[</span><span class="ident" id="5273510">w</span><span class="op" id="5273511">+</span><span class="num" id="5273512">1</span><span class="op" id="5273513">]</span>&nbsp;<span class="op" id="5273515">=</span>&nbsp;<span class="ident" id="5273517">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273522">w</span>&nbsp;<span class="op" id="5273524">+=</span>&nbsp;<span class="num" id="5273527">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5273530">}</span><br>
<span class="lineno">1640</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273534">return</span>&nbsp;<span class="ident" id="5273541">r</span><span class="op" id="5273542">[</span><span class="op" id="5273543">:</span><span class="ident" id="5273544">w</span><span class="op" id="5273545">]</span><br>
<span class="lineno"></span><span class="op" id="5273547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5273550">//&nbsp;appendLiteral&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;literal&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno">1645</span><span class="keyword" id="5273629">func</span>&nbsp;<span class="ident" id="5273634">appendLiteral</span><span class="op" id="5273647">(</span><span class="ident" id="5273648">r</span>&nbsp;<span class="op" id="5273650">[</span><span class="op" id="5273651">]</span><span class="builtintype" id="5273652">rune</span><span class="op" id="5273656">,</span>&nbsp;<span class="ident" id="5273658">x</span>&nbsp;<span class="builtintype" id="5273660">rune</span><span class="op" id="5273664">,</span>&nbsp;<span class="ident" id="5273666">flags</span>&nbsp;<span class="ident" id="5273672">Flags</span><span class="op" id="5273677">)</span>&nbsp;<span class="op" id="5273679">[</span><span class="op" id="5273680">]</span><span class="builtintype" id="5273681">rune</span>&nbsp;<span class="op" id="5273686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273689">if</span>&nbsp;<span class="ident" id="5273692">flags</span><span class="op" id="5273697">&amp;</span><span class="ident" id="5273698">FoldCase</span>&nbsp;<span class="op" id="5273707">!=</span>&nbsp;<span class="num" id="5273710">0</span>&nbsp;<span class="op" id="5273712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273716">return</span>&nbsp;<span class="ident" id="5273723">appendFoldedRange</span><span class="op" id="5273740">(</span><span class="ident" id="5273741">r</span><span class="op" id="5273742">,</span>&nbsp;<span class="ident" id="5273744">x</span><span class="op" id="5273745">,</span>&nbsp;<span class="ident" id="5273747">x</span><span class="op" id="5273748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5273751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273754">return</span>&nbsp;<span class="ident" id="5273761">appendRange</span><span class="op" id="5273772">(</span><span class="ident" id="5273773">r</span><span class="op" id="5273774">,</span>&nbsp;<span class="ident" id="5273776">x</span><span class="op" id="5273777">,</span>&nbsp;<span class="ident" id="5273779">x</span><span class="op" id="5273780">)</span><br>
<span class="lineno">1650</span><span class="op" id="5273782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5273785">//&nbsp;appendRange&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;range&nbsp;lo-hi&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5273864">func</span>&nbsp;<span class="ident" id="5273869">appendRange</span><span class="op" id="5273880">(</span><span class="ident" id="5273881">r</span>&nbsp;<span class="op" id="5273883">[</span><span class="op" id="5273884">]</span><span class="builtintype" id="5273885">rune</span><span class="op" id="5273889">,</span>&nbsp;<span class="ident" id="5273891">lo</span><span class="op" id="5273893">,</span>&nbsp;<span class="ident" id="5273895">hi</span>&nbsp;<span class="builtintype" id="5273898">rune</span><span class="op" id="5273902">)</span>&nbsp;<span class="op" id="5273904">[</span><span class="op" id="5273905">]</span><span class="builtintype" id="5273906">rune</span>&nbsp;<span class="op" id="5273911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5273914">//&nbsp;Expand&nbsp;last&nbsp;range&nbsp;or&nbsp;next&nbsp;to&nbsp;last&nbsp;range&nbsp;if&nbsp;it&nbsp;overlaps&nbsp;or&nbsp;abuts.</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5273983">//&nbsp;Checking&nbsp;two&nbsp;ranges&nbsp;helps&nbsp;when&nbsp;appending&nbsp;case-folded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5274040">//&nbsp;alphabets,&nbsp;so&nbsp;that&nbsp;one&nbsp;range&nbsp;can&nbsp;be&nbsp;expanding&nbsp;A-Z&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5274102">//&nbsp;other&nbsp;expanding&nbsp;a-z.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274127">n</span>&nbsp;<span class="op" id="5274129">:=</span>&nbsp;<span class="builtinfunc" id="5274132">len</span><span class="op" id="5274135">(</span><span class="ident" id="5274136">r</span><span class="op" id="5274137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274140">for</span>&nbsp;<span class="ident" id="5274144">i</span>&nbsp;<span class="op" id="5274146">:=</span>&nbsp;<span class="num" id="5274149">2</span><span class="op" id="5274150">;</span>&nbsp;<span class="ident" id="5274152">i</span>&nbsp;<span class="op" id="5274154">&lt;=</span>&nbsp;<span class="num" id="5274157">4</span><span class="op" id="5274158">;</span>&nbsp;<span class="ident" id="5274160">i</span>&nbsp;<span class="op" id="5274162">+=</span>&nbsp;<span class="num" id="5274165">2</span>&nbsp;<span class="op" id="5274167">{</span>&nbsp;<span class="comment" id="5274169">//&nbsp;twice,&nbsp;using&nbsp;i=2,&nbsp;i=4</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274196">if</span>&nbsp;<span class="ident" id="5274199">n</span>&nbsp;<span class="op" id="5274201">&gt;=</span>&nbsp;<span class="ident" id="5274204">i</span>&nbsp;<span class="op" id="5274206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274211">rlo</span><span class="op" id="5274214">,</span>&nbsp;<span class="ident" id="5274216">rhi</span>&nbsp;<span class="op" id="5274220">:=</span>&nbsp;<span class="ident" id="5274223">r</span><span class="op" id="5274224">[</span><span class="ident" id="5274225">n</span><span class="op" id="5274226">-</span><span class="ident" id="5274227">i</span><span class="op" id="5274228">]</span><span class="op" id="5274229">,</span>&nbsp;<span class="ident" id="5274231">r</span><span class="op" id="5274232">[</span><span class="ident" id="5274233">n</span><span class="op" id="5274234">-</span><span class="ident" id="5274235">i</span><span class="op" id="5274236">+</span><span class="num" id="5274237">1</span><span class="op" id="5274238">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274243">if</span>&nbsp;<span class="ident" id="5274246">lo</span>&nbsp;<span class="op" id="5274249">&lt;=</span>&nbsp;<span class="ident" id="5274252">rhi</span><span class="op" id="5274255">+</span><span class="num" id="5274256">1</span>&nbsp;<span class="op" id="5274258">&amp;&amp;</span>&nbsp;<span class="ident" id="5274261">rlo</span>&nbsp;<span class="op" id="5274265">&lt;=</span>&nbsp;<span class="ident" id="5274268">hi</span><span class="op" id="5274270">+</span><span class="num" id="5274271">1</span>&nbsp;<span class="op" id="5274273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274279">if</span>&nbsp;<span class="ident" id="5274282">lo</span>&nbsp;<span class="op" id="5274285">&lt;</span>&nbsp;<span class="ident" id="5274287">rlo</span>&nbsp;<span class="op" id="5274291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274298">r</span><span class="op" id="5274299">[</span><span class="ident" id="5274300">n</span><span class="op" id="5274301">-</span><span class="ident" id="5274302">i</span><span class="op" id="5274303">]</span>&nbsp;<span class="op" id="5274305">=</span>&nbsp;<span class="ident" id="5274307">lo</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274320">if</span>&nbsp;<span class="ident" id="5274323">hi</span>&nbsp;<span class="op" id="5274326">&gt;</span>&nbsp;<span class="ident" id="5274328">rhi</span>&nbsp;<span class="op" id="5274332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274339">r</span><span class="op" id="5274340">[</span><span class="ident" id="5274341">n</span><span class="op" id="5274342">-</span><span class="ident" id="5274343">i</span><span class="op" id="5274344">+</span><span class="num" id="5274345">1</span><span class="op" id="5274346">]</span>&nbsp;<span class="op" id="5274348">=</span>&nbsp;<span class="ident" id="5274350">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274363">return</span>&nbsp;<span class="ident" id="5274370">r</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274386">return</span>&nbsp;<span class="builtinfunc" id="5274393">append</span><span class="op" id="5274399">(</span><span class="ident" id="5274400">r</span><span class="op" id="5274401">,</span>&nbsp;<span class="ident" id="5274403">lo</span><span class="op" id="5274405">,</span>&nbsp;<span class="ident" id="5274407">hi</span><span class="op" id="5274409">)</span><br>
<span class="lineno">1675</span><span class="op" id="5274411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5274414">const</span>&nbsp;<span class="op" id="5274420">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5274423">//&nbsp;minimum&nbsp;and&nbsp;maximum&nbsp;runes&nbsp;involved&nbsp;in&nbsp;folding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5274474">//&nbsp;checked&nbsp;during&nbsp;test.</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274499">minFold</span>&nbsp;<span class="op" id="5274507">=</span>&nbsp;<span class="num" id="5274509">0x0041</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274517">maxFold</span>&nbsp;<span class="op" id="5274525">=</span>&nbsp;<span class="num" id="5274527">0x118df</span><br>
<span class="lineno"></span><span class="op" id="5274535">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5274538">//&nbsp;appendFoldedRange&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;range&nbsp;lo-hi</span><br>
<span class="lineno">1685</span><span class="comment" id="5274607">//&nbsp;and&nbsp;its&nbsp;case&nbsp;folding-equivalent&nbsp;runes&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5274664">func</span>&nbsp;<span class="ident" id="5274669">appendFoldedRange</span><span class="op" id="5274686">(</span><span class="ident" id="5274687">r</span>&nbsp;<span class="op" id="5274689">[</span><span class="op" id="5274690">]</span><span class="builtintype" id="5274691">rune</span><span class="op" id="5274695">,</span>&nbsp;<span class="ident" id="5274697">lo</span><span class="op" id="5274699">,</span>&nbsp;<span class="ident" id="5274701">hi</span>&nbsp;<span class="builtintype" id="5274704">rune</span><span class="op" id="5274708">)</span>&nbsp;<span class="op" id="5274710">[</span><span class="op" id="5274711">]</span><span class="builtintype" id="5274712">rune</span>&nbsp;<span class="op" id="5274717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5274720">//&nbsp;Optimizations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274739">if</span>&nbsp;<span class="ident" id="5274742">lo</span>&nbsp;<span class="op" id="5274745">&lt;=</span>&nbsp;<span class="ident" id="5274748">minFold</span>&nbsp;<span class="op" id="5274756">&amp;&amp;</span>&nbsp;<span class="ident" id="5274759">hi</span>&nbsp;<span class="op" id="5274762">&gt;=</span>&nbsp;<span class="ident" id="5274765">maxFold</span>&nbsp;<span class="op" id="5274773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5274777">//&nbsp;Range&nbsp;is&nbsp;full:&nbsp;folding&nbsp;can&#39;t&nbsp;add&nbsp;more.</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274821">return</span>&nbsp;<span class="ident" id="5274828">appendRange</span><span class="op" id="5274839">(</span><span class="ident" id="5274840">r</span><span class="op" id="5274841">,</span>&nbsp;<span class="ident" id="5274843">lo</span><span class="op" id="5274845">,</span>&nbsp;<span class="ident" id="5274847">hi</span><span class="op" id="5274849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274855">if</span>&nbsp;<span class="ident" id="5274858">hi</span>&nbsp;<span class="op" id="5274861">&lt;</span>&nbsp;<span class="ident" id="5274863">minFold</span>&nbsp;<span class="op" id="5274871">||</span>&nbsp;<span class="ident" id="5274874">lo</span>&nbsp;<span class="op" id="5274877">&gt;</span>&nbsp;<span class="ident" id="5274879">maxFold</span>&nbsp;<span class="op" id="5274887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5274891">//&nbsp;Range&nbsp;is&nbsp;outside&nbsp;folding&nbsp;possibilities.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274936">return</span>&nbsp;<span class="ident" id="5274943">appendRange</span><span class="op" id="5274954">(</span><span class="ident" id="5274955">r</span><span class="op" id="5274956">,</span>&nbsp;<span class="ident" id="5274958">lo</span><span class="op" id="5274960">,</span>&nbsp;<span class="ident" id="5274962">hi</span><span class="op" id="5274964">)</span><br>
<span class="lineno">1695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274970">if</span>&nbsp;<span class="ident" id="5274973">lo</span>&nbsp;<span class="op" id="5274976">&lt;</span>&nbsp;<span class="ident" id="5274978">minFold</span>&nbsp;<span class="op" id="5274986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5274990">//&nbsp;[lo,&nbsp;minFold-1]&nbsp;needs&nbsp;no&nbsp;folding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275029">r</span>&nbsp;<span class="op" id="5275031">=</span>&nbsp;<span class="ident" id="5275033">appendRange</span><span class="op" id="5275044">(</span><span class="ident" id="5275045">r</span><span class="op" id="5275046">,</span>&nbsp;<span class="ident" id="5275048">lo</span><span class="op" id="5275050">,</span>&nbsp;<span class="ident" id="5275052">minFold</span><span class="op" id="5275059">-</span><span class="num" id="5275060">1</span><span class="op" id="5275061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275065">lo</span>&nbsp;<span class="op" id="5275068">=</span>&nbsp;<span class="ident" id="5275070">minFold</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5275079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275082">if</span>&nbsp;<span class="ident" id="5275085">hi</span>&nbsp;<span class="op" id="5275088">&gt;</span>&nbsp;<span class="ident" id="5275090">maxFold</span>&nbsp;<span class="op" id="5275098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5275102">//&nbsp;[maxFold+1,&nbsp;hi]&nbsp;needs&nbsp;no&nbsp;folding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275141">r</span>&nbsp;<span class="op" id="5275143">=</span>&nbsp;<span class="ident" id="5275145">appendRange</span><span class="op" id="5275156">(</span><span class="ident" id="5275157">r</span><span class="op" id="5275158">,</span>&nbsp;<span class="ident" id="5275160">maxFold</span><span class="op" id="5275167">+</span><span class="num" id="5275168">1</span><span class="op" id="5275169">,</span>&nbsp;<span class="ident" id="5275171">hi</span><span class="op" id="5275173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275177">hi</span>&nbsp;<span class="op" id="5275180">=</span>&nbsp;<span class="ident" id="5275182">maxFold</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5275191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5275195">//&nbsp;Brute&nbsp;force.&nbsp;&nbsp;Depend&nbsp;on&nbsp;appendRange&nbsp;to&nbsp;coalesce&nbsp;ranges&nbsp;on&nbsp;the&nbsp;fly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275266">for</span>&nbsp;<span class="ident" id="5275270">c</span>&nbsp;<span class="op" id="5275272">:=</span>&nbsp;<span class="ident" id="5275275">lo</span><span class="op" id="5275277">;</span>&nbsp;<span class="ident" id="5275279">c</span>&nbsp;<span class="op" id="5275281">&lt;=</span>&nbsp;<span class="ident" id="5275284">hi</span><span class="op" id="5275286">;</span>&nbsp;<span class="ident" id="5275288">c</span><span class="op" id="5275289">++</span>&nbsp;<span class="op" id="5275292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275296">r</span>&nbsp;<span class="op" id="5275298">=</span>&nbsp;<span class="ident" id="5275300">appendRange</span><span class="op" id="5275311">(</span><span class="ident" id="5275312">r</span><span class="op" id="5275313">,</span>&nbsp;<span class="ident" id="5275315">c</span><span class="op" id="5275316">,</span>&nbsp;<span class="ident" id="5275318">c</span><span class="op" id="5275319">)</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275323">f</span>&nbsp;<span class="op" id="5275325">:=</span>&nbsp;<span class="ident" id="5275328">unicode</span><span class="op" id="5275335">.</span><span class="ident" id="5275336">SimpleFold</span><span class="op" id="5275346">(</span><span class="ident" id="5275347">c</span><span class="op" id="5275348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275352">for</span>&nbsp;<span class="ident" id="5275356">f</span>&nbsp;<span class="op" id="5275358">!=</span>&nbsp;<span class="ident" id="5275361">c</span>&nbsp;<span class="op" id="5275363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275368">r</span>&nbsp;<span class="op" id="5275370">=</span>&nbsp;<span class="ident" id="5275372">appendRange</span><span class="op" id="5275383">(</span><span class="ident" id="5275384">r</span><span class="op" id="5275385">,</span>&nbsp;<span class="ident" id="5275387">f</span><span class="op" id="5275388">,</span>&nbsp;<span class="ident" id="5275390">f</span><span class="op" id="5275391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275396">f</span>&nbsp;<span class="op" id="5275398">=</span>&nbsp;<span class="ident" id="5275400">unicode</span><span class="op" id="5275407">.</span><span class="ident" id="5275408">SimpleFold</span><span class="op" id="5275418">(</span><span class="ident" id="5275419">f</span><span class="op" id="5275420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5275424">}</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5275427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275430">return</span>&nbsp;<span class="ident" id="5275437">r</span><br>
<span class="lineno"></span><span class="op" id="5275439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5275442">//&nbsp;appendClass&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;class&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno">1720</span><span class="comment" id="5275517">//&nbsp;It&nbsp;assume&nbsp;x&nbsp;is&nbsp;clean.</span><br>
<span class="lineno"></span><span class="keyword" id="5275542">func</span>&nbsp;<span class="ident" id="5275547">appendClass</span><span class="op" id="5275558">(</span><span class="ident" id="5275559">r</span>&nbsp;<span class="op" id="5275561">[</span><span class="op" id="5275562">]</span><span class="builtintype" id="5275563">rune</span><span class="op" id="5275567">,</span>&nbsp;<span class="ident" id="5275569">x</span>&nbsp;<span class="op" id="5275571">[</span><span class="op" id="5275572">]</span><span class="builtintype" id="5275573">rune</span><span class="op" id="5275577">)</span>&nbsp;<span class="op" id="5275579">[</span><span class="op" id="5275580">]</span><span class="builtintype" id="5275581">rune</span>&nbsp;<span class="op" id="5275586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275589">for</span>&nbsp;<span class="ident" id="5275593">i</span>&nbsp;<span class="op" id="5275595">:=</span>&nbsp;<span class="num" id="5275598">0</span><span class="op" id="5275599">;</span>&nbsp;<span class="ident" id="5275601">i</span>&nbsp;<span class="op" id="5275603">&lt;</span>&nbsp;<span class="builtinfunc" id="5275605">len</span><span class="op" id="5275608">(</span><span class="ident" id="5275609">x</span><span class="op" id="5275610">)</span><span class="op" id="5275611">;</span>&nbsp;<span class="ident" id="5275613">i</span>&nbsp;<span class="op" id="5275615">+=</span>&nbsp;<span class="num" id="5275618">2</span>&nbsp;<span class="op" id="5275620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275624">r</span>&nbsp;<span class="op" id="5275626">=</span>&nbsp;<span class="ident" id="5275628">appendRange</span><span class="op" id="5275639">(</span><span class="ident" id="5275640">r</span><span class="op" id="5275641">,</span>&nbsp;<span class="ident" id="5275643">x</span><span class="op" id="5275644">[</span><span class="ident" id="5275645">i</span><span class="op" id="5275646">]</span><span class="op" id="5275647">,</span>&nbsp;<span class="ident" id="5275649">x</span><span class="op" id="5275650">[</span><span class="ident" id="5275651">i</span><span class="op" id="5275652">+</span><span class="num" id="5275653">1</span><span class="op" id="5275654">]</span><span class="op" id="5275655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5275658">}</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275661">return</span>&nbsp;<span class="ident" id="5275668">r</span><br>
<span class="lineno"></span><span class="op" id="5275670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5275673">//&nbsp;appendFolded&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;case&nbsp;folding&nbsp;of&nbsp;the&nbsp;class&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5275769">func</span>&nbsp;<span class="ident" id="5275774">appendFoldedClass</span><span class="op" id="5275791">(</span><span class="ident" id="5275792">r</span>&nbsp;<span class="op" id="5275794">[</span><span class="op" id="5275795">]</span><span class="builtintype" id="5275796">rune</span><span class="op" id="5275800">,</span>&nbsp;<span class="ident" id="5275802">x</span>&nbsp;<span class="op" id="5275804">[</span><span class="op" id="5275805">]</span><span class="builtintype" id="5275806">rune</span><span class="op" id="5275810">)</span>&nbsp;<span class="op" id="5275812">[</span><span class="op" id="5275813">]</span><span class="builtintype" id="5275814">rune</span>&nbsp;<span class="op" id="5275819">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275822">for</span>&nbsp;<span class="ident" id="5275826">i</span>&nbsp;<span class="op" id="5275828">:=</span>&nbsp;<span class="num" id="5275831">0</span><span class="op" id="5275832">;</span>&nbsp;<span class="ident" id="5275834">i</span>&nbsp;<span class="op" id="5275836">&lt;</span>&nbsp;<span class="builtinfunc" id="5275838">len</span><span class="op" id="5275841">(</span><span class="ident" id="5275842">x</span><span class="op" id="5275843">)</span><span class="op" id="5275844">;</span>&nbsp;<span class="ident" id="5275846">i</span>&nbsp;<span class="op" id="5275848">+=</span>&nbsp;<span class="num" id="5275851">2</span>&nbsp;<span class="op" id="5275853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275857">r</span>&nbsp;<span class="op" id="5275859">=</span>&nbsp;<span class="ident" id="5275861">appendFoldedRange</span><span class="op" id="5275878">(</span><span class="ident" id="5275879">r</span><span class="op" id="5275880">,</span>&nbsp;<span class="ident" id="5275882">x</span><span class="op" id="5275883">[</span><span class="ident" id="5275884">i</span><span class="op" id="5275885">]</span><span class="op" id="5275886">,</span>&nbsp;<span class="ident" id="5275888">x</span><span class="op" id="5275889">[</span><span class="ident" id="5275890">i</span><span class="op" id="5275891">+</span><span class="num" id="5275892">1</span><span class="op" id="5275893">]</span><span class="op" id="5275894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5275897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275900">return</span>&nbsp;<span class="ident" id="5275907">r</span><br>
<span class="lineno"></span><span class="op" id="5275909">}</span><br>
<span class="lineno">1735</span><br>
<span class="lineno"></span><span class="comment" id="5275912">//&nbsp;appendNegatedClass&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;negation&nbsp;of&nbsp;the&nbsp;class&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="5276010">//&nbsp;It&nbsp;assumes&nbsp;x&nbsp;is&nbsp;clean.</span><br>
<span class="lineno"></span><span class="keyword" id="5276036">func</span>&nbsp;<span class="ident" id="5276041">appendNegatedClass</span><span class="op" id="5276059">(</span><span class="ident" id="5276060">r</span>&nbsp;<span class="op" id="5276062">[</span><span class="op" id="5276063">]</span><span class="builtintype" id="5276064">rune</span><span class="op" id="5276068">,</span>&nbsp;<span class="ident" id="5276070">x</span>&nbsp;<span class="op" id="5276072">[</span><span class="op" id="5276073">]</span><span class="builtintype" id="5276074">rune</span><span class="op" id="5276078">)</span>&nbsp;<span class="op" id="5276080">[</span><span class="op" id="5276081">]</span><span class="builtintype" id="5276082">rune</span>&nbsp;<span class="op" id="5276087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276090">nextLo</span>&nbsp;<span class="op" id="5276097">:=</span>&nbsp;<span class="string" id="5276100">&#39;\u0000&#39;</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276110">for</span>&nbsp;<span class="ident" id="5276114">i</span>&nbsp;<span class="op" id="5276116">:=</span>&nbsp;<span class="num" id="5276119">0</span><span class="op" id="5276120">;</span>&nbsp;<span class="ident" id="5276122">i</span>&nbsp;<span class="op" id="5276124">&lt;</span>&nbsp;<span class="builtinfunc" id="5276126">len</span><span class="op" id="5276129">(</span><span class="ident" id="5276130">x</span><span class="op" id="5276131">)</span><span class="op" id="5276132">;</span>&nbsp;<span class="ident" id="5276134">i</span>&nbsp;<span class="op" id="5276136">+=</span>&nbsp;<span class="num" id="5276139">2</span>&nbsp;<span class="op" id="5276141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276145">lo</span><span class="op" id="5276147">,</span>&nbsp;<span class="ident" id="5276149">hi</span>&nbsp;<span class="op" id="5276152">:=</span>&nbsp;<span class="ident" id="5276155">x</span><span class="op" id="5276156">[</span><span class="ident" id="5276157">i</span><span class="op" id="5276158">]</span><span class="op" id="5276159">,</span>&nbsp;<span class="ident" id="5276161">x</span><span class="op" id="5276162">[</span><span class="ident" id="5276163">i</span><span class="op" id="5276164">+</span><span class="num" id="5276165">1</span><span class="op" id="5276166">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276170">if</span>&nbsp;<span class="ident" id="5276173">nextLo</span>&nbsp;<span class="op" id="5276180">&lt;=</span>&nbsp;<span class="ident" id="5276183">lo</span><span class="op" id="5276185">-</span><span class="num" id="5276186">1</span>&nbsp;<span class="op" id="5276188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276193">r</span>&nbsp;<span class="op" id="5276195">=</span>&nbsp;<span class="ident" id="5276197">appendRange</span><span class="op" id="5276208">(</span><span class="ident" id="5276209">r</span><span class="op" id="5276210">,</span>&nbsp;<span class="ident" id="5276212">nextLo</span><span class="op" id="5276218">,</span>&nbsp;<span class="ident" id="5276220">lo</span><span class="op" id="5276222">-</span><span class="num" id="5276223">1</span><span class="op" id="5276224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276228">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276232">nextLo</span>&nbsp;<span class="op" id="5276239">=</span>&nbsp;<span class="ident" id="5276241">hi</span>&nbsp;<span class="op" id="5276244">+</span>&nbsp;<span class="num" id="5276246">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276252">if</span>&nbsp;<span class="ident" id="5276255">nextLo</span>&nbsp;<span class="op" id="5276262">&lt;=</span>&nbsp;<span class="ident" id="5276265">unicode</span><span class="op" id="5276272">.</span><span class="ident" id="5276273">MaxRune</span>&nbsp;<span class="op" id="5276281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276285">r</span>&nbsp;<span class="op" id="5276287">=</span>&nbsp;<span class="ident" id="5276289">appendRange</span><span class="op" id="5276300">(</span><span class="ident" id="5276301">r</span><span class="op" id="5276302">,</span>&nbsp;<span class="ident" id="5276304">nextLo</span><span class="op" id="5276310">,</span>&nbsp;<span class="ident" id="5276312">unicode</span><span class="op" id="5276319">.</span><span class="ident" id="5276320">MaxRune</span><span class="op" id="5276327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276330">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276333">return</span>&nbsp;<span class="ident" id="5276340">r</span><br>
<span class="lineno"></span><span class="op" id="5276342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5276345">//&nbsp;appendTable&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5276410">func</span>&nbsp;<span class="ident" id="5276415">appendTable</span><span class="op" id="5276426">(</span><span class="ident" id="5276427">r</span>&nbsp;<span class="op" id="5276429">[</span><span class="op" id="5276430">]</span><span class="builtintype" id="5276431">rune</span><span class="op" id="5276435">,</span>&nbsp;<span class="ident" id="5276437">x</span>&nbsp;<span class="op" id="5276439">*</span><span class="ident" id="5276440">unicode</span><span class="op" id="5276447">.</span><span class="ident" id="5276448">RangeTable</span><span class="op" id="5276458">)</span>&nbsp;<span class="op" id="5276460">[</span><span class="op" id="5276461">]</span><span class="builtintype" id="5276462">rune</span>&nbsp;<span class="op" id="5276467">{</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276470">for</span>&nbsp;<span class="ident" id="5276474">_</span><span class="op" id="5276475">,</span>&nbsp;<span class="ident" id="5276477">xr</span>&nbsp;<span class="op" id="5276480">:=</span>&nbsp;<span class="keyword" id="5276483">range</span>&nbsp;<span class="ident" id="5276489">x</span><span class="op" id="5276490">.</span><span class="ident" id="5276491">R16</span>&nbsp;<span class="op" id="5276495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276499">lo</span><span class="op" id="5276501">,</span>&nbsp;<span class="ident" id="5276503">hi</span><span class="op" id="5276505">,</span>&nbsp;<span class="ident" id="5276507">stride</span>&nbsp;<span class="op" id="5276514">:=</span>&nbsp;<span class="builtintype" id="5276517">rune</span><span class="op" id="5276521">(</span><span class="ident" id="5276522">xr</span><span class="op" id="5276524">.</span><span class="ident" id="5276525">Lo</span><span class="op" id="5276527">)</span><span class="op" id="5276528">,</span>&nbsp;<span class="builtintype" id="5276530">rune</span><span class="op" id="5276534">(</span><span class="ident" id="5276535">xr</span><span class="op" id="5276537">.</span><span class="ident" id="5276538">Hi</span><span class="op" id="5276540">)</span><span class="op" id="5276541">,</span>&nbsp;<span class="builtintype" id="5276543">rune</span><span class="op" id="5276547">(</span><span class="ident" id="5276548">xr</span><span class="op" id="5276550">.</span><span class="ident" id="5276551">Stride</span><span class="op" id="5276557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276561">if</span>&nbsp;<span class="ident" id="5276564">stride</span>&nbsp;<span class="op" id="5276571">==</span>&nbsp;<span class="num" id="5276574">1</span>&nbsp;<span class="op" id="5276576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276581">r</span>&nbsp;<span class="op" id="5276583">=</span>&nbsp;<span class="ident" id="5276585">appendRange</span><span class="op" id="5276596">(</span><span class="ident" id="5276597">r</span><span class="op" id="5276598">,</span>&nbsp;<span class="ident" id="5276600">lo</span><span class="op" id="5276602">,</span>&nbsp;<span class="ident" id="5276604">hi</span><span class="op" id="5276606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276611">continue</span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276626">for</span>&nbsp;<span class="ident" id="5276630">c</span>&nbsp;<span class="op" id="5276632">:=</span>&nbsp;<span class="ident" id="5276635">lo</span><span class="op" id="5276637">;</span>&nbsp;<span class="ident" id="5276639">c</span>&nbsp;<span class="op" id="5276641">&lt;=</span>&nbsp;<span class="ident" id="5276644">hi</span><span class="op" id="5276646">;</span>&nbsp;<span class="ident" id="5276648">c</span>&nbsp;<span class="op" id="5276650">+=</span>&nbsp;<span class="ident" id="5276653">stride</span>&nbsp;<span class="op" id="5276660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276665">r</span>&nbsp;<span class="op" id="5276667">=</span>&nbsp;<span class="ident" id="5276669">appendRange</span><span class="op" id="5276680">(</span><span class="ident" id="5276681">r</span><span class="op" id="5276682">,</span>&nbsp;<span class="ident" id="5276684">c</span><span class="op" id="5276685">,</span>&nbsp;<span class="ident" id="5276687">c</span><span class="op" id="5276688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276695">}</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276698">for</span>&nbsp;<span class="ident" id="5276702">_</span><span class="op" id="5276703">,</span>&nbsp;<span class="ident" id="5276705">xr</span>&nbsp;<span class="op" id="5276708">:=</span>&nbsp;<span class="keyword" id="5276711">range</span>&nbsp;<span class="ident" id="5276717">x</span><span class="op" id="5276718">.</span><span class="ident" id="5276719">R32</span>&nbsp;<span class="op" id="5276723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276727">lo</span><span class="op" id="5276729">,</span>&nbsp;<span class="ident" id="5276731">hi</span><span class="op" id="5276733">,</span>&nbsp;<span class="ident" id="5276735">stride</span>&nbsp;<span class="op" id="5276742">:=</span>&nbsp;<span class="builtintype" id="5276745">rune</span><span class="op" id="5276749">(</span><span class="ident" id="5276750">xr</span><span class="op" id="5276752">.</span><span class="ident" id="5276753">Lo</span><span class="op" id="5276755">)</span><span class="op" id="5276756">,</span>&nbsp;<span class="builtintype" id="5276758">rune</span><span class="op" id="5276762">(</span><span class="ident" id="5276763">xr</span><span class="op" id="5276765">.</span><span class="ident" id="5276766">Hi</span><span class="op" id="5276768">)</span><span class="op" id="5276769">,</span>&nbsp;<span class="builtintype" id="5276771">rune</span><span class="op" id="5276775">(</span><span class="ident" id="5276776">xr</span><span class="op" id="5276778">.</span><span class="ident" id="5276779">Stride</span><span class="op" id="5276785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276789">if</span>&nbsp;<span class="ident" id="5276792">stride</span>&nbsp;<span class="op" id="5276799">==</span>&nbsp;<span class="num" id="5276802">1</span>&nbsp;<span class="op" id="5276804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276809">r</span>&nbsp;<span class="op" id="5276811">=</span>&nbsp;<span class="ident" id="5276813">appendRange</span><span class="op" id="5276824">(</span><span class="ident" id="5276825">r</span><span class="op" id="5276826">,</span>&nbsp;<span class="ident" id="5276828">lo</span><span class="op" id="5276830">,</span>&nbsp;<span class="ident" id="5276832">hi</span><span class="op" id="5276834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276839">continue</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276854">for</span>&nbsp;<span class="ident" id="5276858">c</span>&nbsp;<span class="op" id="5276860">:=</span>&nbsp;<span class="ident" id="5276863">lo</span><span class="op" id="5276865">;</span>&nbsp;<span class="ident" id="5276867">c</span>&nbsp;<span class="op" id="5276869">&lt;=</span>&nbsp;<span class="ident" id="5276872">hi</span><span class="op" id="5276874">;</span>&nbsp;<span class="ident" id="5276876">c</span>&nbsp;<span class="op" id="5276878">+=</span>&nbsp;<span class="ident" id="5276881">stride</span>&nbsp;<span class="op" id="5276888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276893">r</span>&nbsp;<span class="op" id="5276895">=</span>&nbsp;<span class="ident" id="5276897">appendRange</span><span class="op" id="5276908">(</span><span class="ident" id="5276909">r</span><span class="op" id="5276910">,</span>&nbsp;<span class="ident" id="5276912">c</span><span class="op" id="5276913">,</span>&nbsp;<span class="ident" id="5276915">c</span><span class="op" id="5276916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276923">}</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276926">return</span>&nbsp;<span class="ident" id="5276933">r</span><br>
<span class="lineno"></span><span class="op" id="5276935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5276938">//&nbsp;appendNegatedTable&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;negation&nbsp;of&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5277026">func</span>&nbsp;<span class="ident" id="5277031">appendNegatedTable</span><span class="op" id="5277049">(</span><span class="ident" id="5277050">r</span>&nbsp;<span class="op" id="5277052">[</span><span class="op" id="5277053">]</span><span class="builtintype" id="5277054">rune</span><span class="op" id="5277058">,</span>&nbsp;<span class="ident" id="5277060">x</span>&nbsp;<span class="op" id="5277062">*</span><span class="ident" id="5277063">unicode</span><span class="op" id="5277070">.</span><span class="ident" id="5277071">RangeTable</span><span class="op" id="5277081">)</span>&nbsp;<span class="op" id="5277083">[</span><span class="op" id="5277084">]</span><span class="builtintype" id="5277085">rune</span>&nbsp;<span class="op" id="5277090">{</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277093">nextLo</span>&nbsp;<span class="op" id="5277100">:=</span>&nbsp;<span class="string" id="5277103">&#39;\u0000&#39;</span>&nbsp;<span class="comment" id="5277112">//&nbsp;lo&nbsp;end&nbsp;of&nbsp;next&nbsp;class&nbsp;to&nbsp;add</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277144">for</span>&nbsp;<span class="ident" id="5277148">_</span><span class="op" id="5277149">,</span>&nbsp;<span class="ident" id="5277151">xr</span>&nbsp;<span class="op" id="5277154">:=</span>&nbsp;<span class="keyword" id="5277157">range</span>&nbsp;<span class="ident" id="5277163">x</span><span class="op" id="5277164">.</span><span class="ident" id="5277165">R16</span>&nbsp;<span class="op" id="5277169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277173">lo</span><span class="op" id="5277175">,</span>&nbsp;<span class="ident" id="5277177">hi</span><span class="op" id="5277179">,</span>&nbsp;<span class="ident" id="5277181">stride</span>&nbsp;<span class="op" id="5277188">:=</span>&nbsp;<span class="builtintype" id="5277191">rune</span><span class="op" id="5277195">(</span><span class="ident" id="5277196">xr</span><span class="op" id="5277198">.</span><span class="ident" id="5277199">Lo</span><span class="op" id="5277201">)</span><span class="op" id="5277202">,</span>&nbsp;<span class="builtintype" id="5277204">rune</span><span class="op" id="5277208">(</span><span class="ident" id="5277209">xr</span><span class="op" id="5277211">.</span><span class="ident" id="5277212">Hi</span><span class="op" id="5277214">)</span><span class="op" id="5277215">,</span>&nbsp;<span class="builtintype" id="5277217">rune</span><span class="op" id="5277221">(</span><span class="ident" id="5277222">xr</span><span class="op" id="5277224">.</span><span class="ident" id="5277225">Stride</span><span class="op" id="5277231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277235">if</span>&nbsp;<span class="ident" id="5277238">stride</span>&nbsp;<span class="op" id="5277245">==</span>&nbsp;<span class="num" id="5277248">1</span>&nbsp;<span class="op" id="5277250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277255">if</span>&nbsp;<span class="ident" id="5277258">nextLo</span>&nbsp;<span class="op" id="5277265">&lt;=</span>&nbsp;<span class="ident" id="5277268">lo</span><span class="op" id="5277270">-</span><span class="num" id="5277271">1</span>&nbsp;<span class="op" id="5277273">{</span><br>
<span class="lineno">1785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277279">r</span>&nbsp;<span class="op" id="5277281">=</span>&nbsp;<span class="ident" id="5277283">appendRange</span><span class="op" id="5277294">(</span><span class="ident" id="5277295">r</span><span class="op" id="5277296">,</span>&nbsp;<span class="ident" id="5277298">nextLo</span><span class="op" id="5277304">,</span>&nbsp;<span class="ident" id="5277306">lo</span><span class="op" id="5277308">-</span><span class="num" id="5277309">1</span><span class="op" id="5277310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277320">nextLo</span>&nbsp;<span class="op" id="5277327">=</span>&nbsp;<span class="ident" id="5277329">hi</span>&nbsp;<span class="op" id="5277332">+</span>&nbsp;<span class="num" id="5277334">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277339">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277350">}</span><br>
<span class="lineno">1790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277354">for</span>&nbsp;<span class="ident" id="5277358">c</span>&nbsp;<span class="op" id="5277360">:=</span>&nbsp;<span class="ident" id="5277363">lo</span><span class="op" id="5277365">;</span>&nbsp;<span class="ident" id="5277367">c</span>&nbsp;<span class="op" id="5277369">&lt;=</span>&nbsp;<span class="ident" id="5277372">hi</span><span class="op" id="5277374">;</span>&nbsp;<span class="ident" id="5277376">c</span>&nbsp;<span class="op" id="5277378">+=</span>&nbsp;<span class="ident" id="5277381">stride</span>&nbsp;<span class="op" id="5277388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277393">if</span>&nbsp;<span class="ident" id="5277396">nextLo</span>&nbsp;<span class="op" id="5277403">&lt;=</span>&nbsp;<span class="ident" id="5277406">c</span><span class="op" id="5277407">-</span><span class="num" id="5277408">1</span>&nbsp;<span class="op" id="5277410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277416">r</span>&nbsp;<span class="op" id="5277418">=</span>&nbsp;<span class="ident" id="5277420">appendRange</span><span class="op" id="5277431">(</span><span class="ident" id="5277432">r</span><span class="op" id="5277433">,</span>&nbsp;<span class="ident" id="5277435">nextLo</span><span class="op" id="5277441">,</span>&nbsp;<span class="ident" id="5277443">c</span><span class="op" id="5277444">-</span><span class="num" id="5277445">1</span><span class="op" id="5277446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277456">nextLo</span>&nbsp;<span class="op" id="5277463">=</span>&nbsp;<span class="ident" id="5277465">c</span>&nbsp;<span class="op" id="5277467">+</span>&nbsp;<span class="num" id="5277469">1</span><br>
<span class="lineno">1795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277479">for</span>&nbsp;<span class="ident" id="5277483">_</span><span class="op" id="5277484">,</span>&nbsp;<span class="ident" id="5277486">xr</span>&nbsp;<span class="op" id="5277489">:=</span>&nbsp;<span class="keyword" id="5277492">range</span>&nbsp;<span class="ident" id="5277498">x</span><span class="op" id="5277499">.</span><span class="ident" id="5277500">R32</span>&nbsp;<span class="op" id="5277504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277508">lo</span><span class="op" id="5277510">,</span>&nbsp;<span class="ident" id="5277512">hi</span><span class="op" id="5277514">,</span>&nbsp;<span class="ident" id="5277516">stride</span>&nbsp;<span class="op" id="5277523">:=</span>&nbsp;<span class="builtintype" id="5277526">rune</span><span class="op" id="5277530">(</span><span class="ident" id="5277531">xr</span><span class="op" id="5277533">.</span><span class="ident" id="5277534">Lo</span><span class="op" id="5277536">)</span><span class="op" id="5277537">,</span>&nbsp;<span class="builtintype" id="5277539">rune</span><span class="op" id="5277543">(</span><span class="ident" id="5277544">xr</span><span class="op" id="5277546">.</span><span class="ident" id="5277547">Hi</span><span class="op" id="5277549">)</span><span class="op" id="5277550">,</span>&nbsp;<span class="builtintype" id="5277552">rune</span><span class="op" id="5277556">(</span><span class="ident" id="5277557">xr</span><span class="op" id="5277559">.</span><span class="ident" id="5277560">Stride</span><span class="op" id="5277566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277570">if</span>&nbsp;<span class="ident" id="5277573">stride</span>&nbsp;<span class="op" id="5277580">==</span>&nbsp;<span class="num" id="5277583">1</span>&nbsp;<span class="op" id="5277585">{</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277590">if</span>&nbsp;<span class="ident" id="5277593">nextLo</span>&nbsp;<span class="op" id="5277600">&lt;=</span>&nbsp;<span class="ident" id="5277603">lo</span><span class="op" id="5277605">-</span><span class="num" id="5277606">1</span>&nbsp;<span class="op" id="5277608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277614">r</span>&nbsp;<span class="op" id="5277616">=</span>&nbsp;<span class="ident" id="5277618">appendRange</span><span class="op" id="5277629">(</span><span class="ident" id="5277630">r</span><span class="op" id="5277631">,</span>&nbsp;<span class="ident" id="5277633">nextLo</span><span class="op" id="5277639">,</span>&nbsp;<span class="ident" id="5277641">lo</span><span class="op" id="5277643">-</span><span class="num" id="5277644">1</span><span class="op" id="5277645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277655">nextLo</span>&nbsp;<span class="op" id="5277662">=</span>&nbsp;<span class="ident" id="5277664">hi</span>&nbsp;<span class="op" id="5277667">+</span>&nbsp;<span class="num" id="5277669">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277674">continue</span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277689">for</span>&nbsp;<span class="ident" id="5277693">c</span>&nbsp;<span class="op" id="5277695">:=</span>&nbsp;<span class="ident" id="5277698">lo</span><span class="op" id="5277700">;</span>&nbsp;<span class="ident" id="5277702">c</span>&nbsp;<span class="op" id="5277704">&lt;=</span>&nbsp;<span class="ident" id="5277707">hi</span><span class="op" id="5277709">;</span>&nbsp;<span class="ident" id="5277711">c</span>&nbsp;<span class="op" id="5277713">+=</span>&nbsp;<span class="ident" id="5277716">stride</span>&nbsp;<span class="op" id="5277723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277728">if</span>&nbsp;<span class="ident" id="5277731">nextLo</span>&nbsp;<span class="op" id="5277738">&lt;=</span>&nbsp;<span class="ident" id="5277741">c</span><span class="op" id="5277742">-</span><span class="num" id="5277743">1</span>&nbsp;<span class="op" id="5277745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277751">r</span>&nbsp;<span class="op" id="5277753">=</span>&nbsp;<span class="ident" id="5277755">appendRange</span><span class="op" id="5277766">(</span><span class="ident" id="5277767">r</span><span class="op" id="5277768">,</span>&nbsp;<span class="ident" id="5277770">nextLo</span><span class="op" id="5277776">,</span>&nbsp;<span class="ident" id="5277778">c</span><span class="op" id="5277779">-</span><span class="num" id="5277780">1</span><span class="op" id="5277781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277786">}</span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277791">nextLo</span>&nbsp;<span class="op" id="5277798">=</span>&nbsp;<span class="ident" id="5277800">c</span>&nbsp;<span class="op" id="5277802">+</span>&nbsp;<span class="num" id="5277804">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277814">if</span>&nbsp;<span class="ident" id="5277817">nextLo</span>&nbsp;<span class="op" id="5277824">&lt;=</span>&nbsp;<span class="ident" id="5277827">unicode</span><span class="op" id="5277834">.</span><span class="ident" id="5277835">MaxRune</span>&nbsp;<span class="op" id="5277843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277847">r</span>&nbsp;<span class="op" id="5277849">=</span>&nbsp;<span class="ident" id="5277851">appendRange</span><span class="op" id="5277862">(</span><span class="ident" id="5277863">r</span><span class="op" id="5277864">,</span>&nbsp;<span class="ident" id="5277866">nextLo</span><span class="op" id="5277872">,</span>&nbsp;<span class="ident" id="5277874">unicode</span><span class="op" id="5277881">.</span><span class="ident" id="5277882">MaxRune</span><span class="op" id="5277889">)</span><br>
<span class="lineno">1815</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277895">return</span>&nbsp;<span class="ident" id="5277902">r</span><br>
<span class="lineno"></span><span class="op" id="5277904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5277907">//&nbsp;negateClass&nbsp;overwrites&nbsp;r&nbsp;and&nbsp;returns&nbsp;r&#39;s&nbsp;negation.</span><br>
<span class="lineno">1820</span><span class="comment" id="5277961">//&nbsp;It&nbsp;assumes&nbsp;the&nbsp;class&nbsp;r&nbsp;is&nbsp;already&nbsp;clean.</span><br>
<span class="lineno"></span><span class="keyword" id="5278005">func</span>&nbsp;<span class="ident" id="5278010">negateClass</span><span class="op" id="5278021">(</span><span class="ident" id="5278022">r</span>&nbsp;<span class="op" id="5278024">[</span><span class="op" id="5278025">]</span><span class="builtintype" id="5278026">rune</span><span class="op" id="5278030">)</span>&nbsp;<span class="op" id="5278032">[</span><span class="op" id="5278033">]</span><span class="builtintype" id="5278034">rune</span>&nbsp;<span class="op" id="5278039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278042">nextLo</span>&nbsp;<span class="op" id="5278049">:=</span>&nbsp;<span class="string" id="5278052">&#39;\u0000&#39;</span>&nbsp;<span class="comment" id="5278061">//&nbsp;lo&nbsp;end&nbsp;of&nbsp;next&nbsp;class&nbsp;to&nbsp;add</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278093">w</span>&nbsp;<span class="op" id="5278095">:=</span>&nbsp;<span class="num" id="5278098">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5278112">//&nbsp;write&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278128">for</span>&nbsp;<span class="ident" id="5278132">i</span>&nbsp;<span class="op" id="5278134">:=</span>&nbsp;<span class="num" id="5278137">0</span><span class="op" id="5278138">;</span>&nbsp;<span class="ident" id="5278140">i</span>&nbsp;<span class="op" id="5278142">&lt;</span>&nbsp;<span class="builtinfunc" id="5278144">len</span><span class="op" id="5278147">(</span><span class="ident" id="5278148">r</span><span class="op" id="5278149">)</span><span class="op" id="5278150">;</span>&nbsp;<span class="ident" id="5278152">i</span>&nbsp;<span class="op" id="5278154">+=</span>&nbsp;<span class="num" id="5278157">2</span>&nbsp;<span class="op" id="5278159">{</span><br>
<span class="lineno">1825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278163">lo</span><span class="op" id="5278165">,</span>&nbsp;<span class="ident" id="5278167">hi</span>&nbsp;<span class="op" id="5278170">:=</span>&nbsp;<span class="ident" id="5278173">r</span><span class="op" id="5278174">[</span><span class="ident" id="5278175">i</span><span class="op" id="5278176">]</span><span class="op" id="5278177">,</span>&nbsp;<span class="ident" id="5278179">r</span><span class="op" id="5278180">[</span><span class="ident" id="5278181">i</span><span class="op" id="5278182">+</span><span class="num" id="5278183">1</span><span class="op" id="5278184">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278188">if</span>&nbsp;<span class="ident" id="5278191">nextLo</span>&nbsp;<span class="op" id="5278198">&lt;=</span>&nbsp;<span class="ident" id="5278201">lo</span><span class="op" id="5278203">-</span><span class="num" id="5278204">1</span>&nbsp;<span class="op" id="5278206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278211">r</span><span class="op" id="5278212">[</span><span class="ident" id="5278213">w</span><span class="op" id="5278214">]</span>&nbsp;<span class="op" id="5278216">=</span>&nbsp;<span class="ident" id="5278218">nextLo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278228">r</span><span class="op" id="5278229">[</span><span class="ident" id="5278230">w</span><span class="op" id="5278231">+</span><span class="num" id="5278232">1</span><span class="op" id="5278233">]</span>&nbsp;<span class="op" id="5278235">=</span>&nbsp;<span class="ident" id="5278237">lo</span>&nbsp;<span class="op" id="5278240">-</span>&nbsp;<span class="num" id="5278242">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278247">w</span>&nbsp;<span class="op" id="5278249">+=</span>&nbsp;<span class="num" id="5278252">2</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278260">nextLo</span>&nbsp;<span class="op" id="5278267">=</span>&nbsp;<span class="ident" id="5278269">hi</span>&nbsp;<span class="op" id="5278272">+</span>&nbsp;<span class="num" id="5278274">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278280">r</span>&nbsp;<span class="op" id="5278282">=</span>&nbsp;<span class="ident" id="5278284">r</span><span class="op" id="5278285">[</span><span class="op" id="5278286">:</span><span class="ident" id="5278287">w</span><span class="op" id="5278288">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278291">if</span>&nbsp;<span class="ident" id="5278294">nextLo</span>&nbsp;<span class="op" id="5278301">&lt;=</span>&nbsp;<span class="ident" id="5278304">unicode</span><span class="op" id="5278311">.</span><span class="ident" id="5278312">MaxRune</span>&nbsp;<span class="op" id="5278320">{</span><br>
<span class="lineno">1835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278324">//&nbsp;It&#39;s&nbsp;possible&nbsp;for&nbsp;the&nbsp;negation&nbsp;to&nbsp;have&nbsp;one&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278377">//&nbsp;range&nbsp;-&nbsp;this&nbsp;one&nbsp;-&nbsp;than&nbsp;the&nbsp;original&nbsp;class,&nbsp;so&nbsp;use&nbsp;append.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278441">r</span>&nbsp;<span class="op" id="5278443">=</span>&nbsp;<span class="builtinfunc" id="5278445">append</span><span class="op" id="5278451">(</span><span class="ident" id="5278452">r</span><span class="op" id="5278453">,</span>&nbsp;<span class="ident" id="5278455">nextLo</span><span class="op" id="5278461">,</span>&nbsp;<span class="ident" id="5278463">unicode</span><span class="op" id="5278470">.</span><span class="ident" id="5278471">MaxRune</span><span class="op" id="5278478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278484">return</span>&nbsp;<span class="ident" id="5278491">r</span><br>
<span class="lineno">1840</span><span class="op" id="5278493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5278496">//&nbsp;ranges&nbsp;implements&nbsp;sort.Interface&nbsp;on&nbsp;a&nbsp;[]rune.</span><br>
<span class="lineno"></span><span class="comment" id="5278545">//&nbsp;The&nbsp;choice&nbsp;of&nbsp;receiver&nbsp;type&nbsp;definition&nbsp;is&nbsp;strange</span><br>
<span class="lineno"></span><span class="comment" id="5278598">//&nbsp;but&nbsp;avoids&nbsp;an&nbsp;allocation&nbsp;since&nbsp;we&nbsp;already&nbsp;have</span><br>
<span class="lineno">1845</span><span class="comment" id="5278648">//&nbsp;a&nbsp;*[]rune.</span><br>
<span class="lineno"></span><span class="keyword" id="5278662">type</span>&nbsp;<span class="ident" id="5278667">ranges</span>&nbsp;<span class="keyword" id="5278674">struct</span>&nbsp;<span class="op" id="5278681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278684">p</span>&nbsp;<span class="op" id="5278686">*</span><span class="op" id="5278687">[</span><span class="op" id="5278688">]</span><span class="builtintype" id="5278689">rune</span><br>
<span class="lineno"></span><span class="op" id="5278694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1850</span><span class="keyword" id="5278697">func</span>&nbsp;<span class="op" id="5278702">(</span><span class="ident" id="5278703">ra</span>&nbsp;<span class="ident" id="5278706">ranges</span><span class="op" id="5278712">)</span>&nbsp;<span class="ident" id="5278714">Less</span><span class="op" id="5278718">(</span><span class="ident" id="5278719">i</span><span class="op" id="5278720">,</span>&nbsp;<span class="ident" id="5278722">j</span>&nbsp;<span class="builtintype" id="5278724">int</span><span class="op" id="5278727">)</span>&nbsp;<span class="builtintype" id="5278729">bool</span>&nbsp;<span class="op" id="5278734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278737">p</span>&nbsp;<span class="op" id="5278739">:=</span>&nbsp;<span class="op" id="5278742">*</span><span class="ident" id="5278743">ra</span><span class="op" id="5278745">.</span><span class="ident" id="5278746">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278749">i</span>&nbsp;<span class="op" id="5278751">*=</span>&nbsp;<span class="num" id="5278754">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278757">j</span>&nbsp;<span class="op" id="5278759">*=</span>&nbsp;<span class="num" id="5278762">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278765">return</span>&nbsp;<span class="ident" id="5278772">p</span><span class="op" id="5278773">[</span><span class="ident" id="5278774">i</span><span class="op" id="5278775">]</span>&nbsp;<span class="op" id="5278777">&lt;</span>&nbsp;<span class="ident" id="5278779">p</span><span class="op" id="5278780">[</span><span class="ident" id="5278781">j</span><span class="op" id="5278782">]</span>&nbsp;<span class="op" id="5278784">||</span>&nbsp;<span class="ident" id="5278787">p</span><span class="op" id="5278788">[</span><span class="ident" id="5278789">i</span><span class="op" id="5278790">]</span>&nbsp;<span class="op" id="5278792">==</span>&nbsp;<span class="ident" id="5278795">p</span><span class="op" id="5278796">[</span><span class="ident" id="5278797">j</span><span class="op" id="5278798">]</span>&nbsp;<span class="op" id="5278800">&amp;&amp;</span>&nbsp;<span class="ident" id="5278803">p</span><span class="op" id="5278804">[</span><span class="ident" id="5278805">i</span><span class="op" id="5278806">+</span><span class="num" id="5278807">1</span><span class="op" id="5278808">]</span>&nbsp;<span class="op" id="5278810">&gt;</span>&nbsp;<span class="ident" id="5278812">p</span><span class="op" id="5278813">[</span><span class="ident" id="5278814">j</span><span class="op" id="5278815">+</span><span class="num" id="5278816">1</span><span class="op" id="5278817">]</span><br>
<span class="lineno">1855</span><span class="op" id="5278819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5278822">func</span>&nbsp;<span class="op" id="5278827">(</span><span class="ident" id="5278828">ra</span>&nbsp;<span class="ident" id="5278831">ranges</span><span class="op" id="5278837">)</span>&nbsp;<span class="ident" id="5278839">Len</span><span class="op" id="5278842">(</span><span class="op" id="5278843">)</span>&nbsp;<span class="builtintype" id="5278845">int</span>&nbsp;<span class="op" id="5278849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278852">return</span>&nbsp;<span class="builtinfunc" id="5278859">len</span><span class="op" id="5278862">(</span><span class="op" id="5278863">*</span><span class="ident" id="5278864">ra</span><span class="op" id="5278866">.</span><span class="ident" id="5278867">p</span><span class="op" id="5278868">)</span>&nbsp;<span class="op" id="5278870">/</span>&nbsp;<span class="num" id="5278872">2</span><br>
<span class="lineno"></span><span class="op" id="5278874">}</span><br>
<span class="lineno">1860</span><br>
<span class="lineno"></span><span class="keyword" id="5278877">func</span>&nbsp;<span class="op" id="5278882">(</span><span class="ident" id="5278883">ra</span>&nbsp;<span class="ident" id="5278886">ranges</span><span class="op" id="5278892">)</span>&nbsp;<span class="ident" id="5278894">Swap</span><span class="op" id="5278898">(</span><span class="ident" id="5278899">i</span><span class="op" id="5278900">,</span>&nbsp;<span class="ident" id="5278902">j</span>&nbsp;<span class="builtintype" id="5278904">int</span><span class="op" id="5278907">)</span>&nbsp;<span class="op" id="5278909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278912">p</span>&nbsp;<span class="op" id="5278914">:=</span>&nbsp;<span class="op" id="5278917">*</span><span class="ident" id="5278918">ra</span><span class="op" id="5278920">.</span><span class="ident" id="5278921">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278924">i</span>&nbsp;<span class="op" id="5278926">*=</span>&nbsp;<span class="num" id="5278929">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278932">j</span>&nbsp;<span class="op" id="5278934">*=</span>&nbsp;<span class="num" id="5278937">2</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278940">p</span><span class="op" id="5278941">[</span><span class="ident" id="5278942">i</span><span class="op" id="5278943">]</span><span class="op" id="5278944">,</span>&nbsp;<span class="ident" id="5278946">p</span><span class="op" id="5278947">[</span><span class="ident" id="5278948">i</span><span class="op" id="5278949">+</span><span class="num" id="5278950">1</span><span class="op" id="5278951">]</span><span class="op" id="5278952">,</span>&nbsp;<span class="ident" id="5278954">p</span><span class="op" id="5278955">[</span><span class="ident" id="5278956">j</span><span class="op" id="5278957">]</span><span class="op" id="5278958">,</span>&nbsp;<span class="ident" id="5278960">p</span><span class="op" id="5278961">[</span><span class="ident" id="5278962">j</span><span class="op" id="5278963">+</span><span class="num" id="5278964">1</span><span class="op" id="5278965">]</span>&nbsp;<span class="op" id="5278967">=</span>&nbsp;<span class="ident" id="5278969">p</span><span class="op" id="5278970">[</span><span class="ident" id="5278971">j</span><span class="op" id="5278972">]</span><span class="op" id="5278973">,</span>&nbsp;<span class="ident" id="5278975">p</span><span class="op" id="5278976">[</span><span class="ident" id="5278977">j</span><span class="op" id="5278978">+</span><span class="num" id="5278979">1</span><span class="op" id="5278980">]</span><span class="op" id="5278981">,</span>&nbsp;<span class="ident" id="5278983">p</span><span class="op" id="5278984">[</span><span class="ident" id="5278985">i</span><span class="op" id="5278986">]</span><span class="op" id="5278987">,</span>&nbsp;<span class="ident" id="5278989">p</span><span class="op" id="5278990">[</span><span class="ident" id="5278991">i</span><span class="op" id="5278992">+</span><span class="num" id="5278993">1</span><span class="op" id="5278994">]</span><br>
<span class="lineno"></span><span class="op" id="5278996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5278999">func</span>&nbsp;<span class="ident" id="5279004">checkUTF8</span><span class="op" id="5279013">(</span><span class="ident" id="5279014">s</span>&nbsp;<span class="builtintype" id="5279016">string</span><span class="op" id="5279022">)</span>&nbsp;<span class="builtintype" id="5279024">error</span>&nbsp;<span class="op" id="5279030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279033">for</span>&nbsp;<span class="ident" id="5279037">s</span>&nbsp;<span class="op" id="5279039">!=</span>&nbsp;<span class="string" id="5279042">&#34;&#34;</span>&nbsp;<span class="op" id="5279045">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="5279049">rune</span><span class="op" id="5279053">,</span>&nbsp;<span class="ident" id="5279055">size</span>&nbsp;<span class="op" id="5279060">:=</span>&nbsp;<span class="ident" id="5279063">utf8</span><span class="op" id="5279067">.</span><span class="ident" id="5279068">DecodeRuneInString</span><span class="op" id="5279086">(</span><span class="ident" id="5279087">s</span><span class="op" id="5279088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279092">if</span>&nbsp;<span class="builtintype" id="5279095">rune</span>&nbsp;<span class="op" id="5279100">==</span>&nbsp;<span class="ident" id="5279103">utf8</span><span class="op" id="5279107">.</span><span class="ident" id="5279108">RuneError</span>&nbsp;<span class="op" id="5279118">&amp;&amp;</span>&nbsp;<span class="ident" id="5279121">size</span>&nbsp;<span class="op" id="5279126">==</span>&nbsp;<span class="num" id="5279129">1</span>&nbsp;<span class="op" id="5279131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279136">return</span>&nbsp;<span class="op" id="5279143">&amp;</span><span class="ident" id="5279144">Error</span><span class="op" id="5279149">{</span><span class="ident" id="5279150">Code</span><span class="op" id="5279154">:</span>&nbsp;<span class="ident" id="5279156">ErrInvalidUTF8</span><span class="op" id="5279170">,</span>&nbsp;<span class="ident" id="5279172">Expr</span><span class="op" id="5279176">:</span>&nbsp;<span class="ident" id="5279178">s</span><span class="op" id="5279179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5279183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279187">s</span>&nbsp;<span class="op" id="5279189">=</span>&nbsp;<span class="ident" id="5279191">s</span><span class="op" id="5279192">[</span><span class="ident" id="5279193">size</span><span class="op" id="5279197">:</span><span class="op" id="5279198">]</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5279201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279204">return</span>&nbsp;<span class="ident" id="5279211">nil</span><br>
<span class="lineno"></span><span class="op" id="5279215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5279218">func</span>&nbsp;<span class="ident" id="5279223">nextRune</span><span class="op" id="5279231">(</span><span class="ident" id="5279232">s</span>&nbsp;<span class="builtintype" id="5279234">string</span><span class="op" id="5279240">)</span>&nbsp;<span class="op" id="5279242">(</span><span class="ident" id="5279243">c</span>&nbsp;<span class="builtintype" id="5279245">rune</span><span class="op" id="5279249">,</span>&nbsp;<span class="ident" id="5279251">t</span>&nbsp;<span class="builtintype" id="5279253">string</span><span class="op" id="5279259">,</span>&nbsp;<span class="ident" id="5279261">err</span>&nbsp;<span class="builtintype" id="5279265">error</span><span class="op" id="5279270">)</span>&nbsp;<span class="op" id="5279272">{</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279275">c</span><span class="op" id="5279276">,</span>&nbsp;<span class="ident" id="5279278">size</span>&nbsp;<span class="op" id="5279283">:=</span>&nbsp;<span class="ident" id="5279286">utf8</span><span class="op" id="5279290">.</span><span class="ident" id="5279291">DecodeRuneInString</span><span class="op" id="5279309">(</span><span class="ident" id="5279310">s</span><span class="op" id="5279311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279314">if</span>&nbsp;<span class="ident" id="5279317">c</span>&nbsp;<span class="op" id="5279319">==</span>&nbsp;<span class="ident" id="5279322">utf8</span><span class="op" id="5279326">.</span><span class="ident" id="5279327">RuneError</span>&nbsp;<span class="op" id="5279337">&amp;&amp;</span>&nbsp;<span class="ident" id="5279340">size</span>&nbsp;<span class="op" id="5279345">==</span>&nbsp;<span class="num" id="5279348">1</span>&nbsp;<span class="op" id="5279350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279354">return</span>&nbsp;<span class="num" id="5279361">0</span><span class="op" id="5279362">,</span>&nbsp;<span class="string" id="5279364">&#34;&#34;</span><span class="op" id="5279366">,</span>&nbsp;<span class="op" id="5279368">&amp;</span><span class="ident" id="5279369">Error</span><span class="op" id="5279374">{</span><span class="ident" id="5279375">Code</span><span class="op" id="5279379">:</span>&nbsp;<span class="ident" id="5279381">ErrInvalidUTF8</span><span class="op" id="5279395">,</span>&nbsp;<span class="ident" id="5279397">Expr</span><span class="op" id="5279401">:</span>&nbsp;<span class="ident" id="5279403">s</span><span class="op" id="5279404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5279407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279410">return</span>&nbsp;<span class="ident" id="5279417">c</span><span class="op" id="5279418">,</span>&nbsp;<span class="ident" id="5279420">s</span><span class="op" id="5279421">[</span><span class="ident" id="5279422">size</span><span class="op" id="5279426">:</span><span class="op" id="5279427">]</span><span class="op" id="5279428">,</span>&nbsp;<span class="ident" id="5279430">nil</span><br>
<span class="lineno">1885</span><span class="op" id="5279434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5279437">func</span>&nbsp;<span class="ident" id="5279442">isalnum</span><span class="op" id="5279449">(</span><span class="ident" id="5279450">c</span>&nbsp;<span class="builtintype" id="5279452">rune</span><span class="op" id="5279456">)</span>&nbsp;<span class="builtintype" id="5279458">bool</span>&nbsp;<span class="op" id="5279463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279466">return</span>&nbsp;<span class="string" id="5279473">&#39;0&#39;</span>&nbsp;<span class="op" id="5279477">&lt;=</span>&nbsp;<span class="ident" id="5279480">c</span>&nbsp;<span class="op" id="5279482">&amp;&amp;</span>&nbsp;<span class="ident" id="5279485">c</span>&nbsp;<span class="op" id="5279487">&lt;=</span>&nbsp;<span class="string" id="5279490">&#39;9&#39;</span>&nbsp;<span class="op" id="5279494">||</span>&nbsp;<span class="string" id="5279497">&#39;A&#39;</span>&nbsp;<span class="op" id="5279501">&lt;=</span>&nbsp;<span class="ident" id="5279504">c</span>&nbsp;<span class="op" id="5279506">&amp;&amp;</span>&nbsp;<span class="ident" id="5279509">c</span>&nbsp;<span class="op" id="5279511">&lt;=</span>&nbsp;<span class="string" id="5279514">&#39;Z&#39;</span>&nbsp;<span class="op" id="5279518">||</span>&nbsp;<span class="string" id="5279521">&#39;a&#39;</span>&nbsp;<span class="op" id="5279525">&lt;=</span>&nbsp;<span class="ident" id="5279528">c</span>&nbsp;<span class="op" id="5279530">&amp;&amp;</span>&nbsp;<span class="ident" id="5279533">c</span>&nbsp;<span class="op" id="5279535">&lt;=</span>&nbsp;<span class="string" id="5279538">&#39;z&#39;</span><br>
<span class="lineno"></span><span class="op" id="5279542">}</span><br>
<span class="lineno">1890</span><br>
<span class="lineno"></span><span class="keyword" id="5279545">func</span>&nbsp;<span class="ident" id="5279550">unhex</span><span class="op" id="5279555">(</span><span class="ident" id="5279556">c</span>&nbsp;<span class="builtintype" id="5279558">rune</span><span class="op" id="5279562">)</span>&nbsp;<span class="builtintype" id="5279564">rune</span>&nbsp;<span class="op" id="5279569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279572">if</span>&nbsp;<span class="string" id="5279575">&#39;0&#39;</span>&nbsp;<span class="op" id="5279579">&lt;=</span>&nbsp;<span class="ident" id="5279582">c</span>&nbsp;<span class="op" id="5279584">&amp;&amp;</span>&nbsp;<span class="ident" id="5279587">c</span>&nbsp;<span class="op" id="5279589">&lt;=</span>&nbsp;<span class="string" id="5279592">&#39;9&#39;</span>&nbsp;<span class="op" id="5279596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279600">return</span>&nbsp;<span class="ident" id="5279607">c</span>&nbsp;<span class="op" id="5279609">-</span>&nbsp;<span class="string" id="5279611">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5279616">}</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279619">if</span>&nbsp;<span class="string" id="5279622">&#39;a&#39;</span>&nbsp;<span class="op" id="5279626">&lt;=</span>&nbsp;<span class="ident" id="5279629">c</span>&nbsp;<span class="op" id="5279631">&amp;&amp;</span>&nbsp;<span class="ident" id="5279634">c</span>&nbsp;<span class="op" id="5279636">&lt;=</span>&nbsp;<span class="string" id="5279639">&#39;f&#39;</span>&nbsp;<span class="op" id="5279643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279647">return</span>&nbsp;<span class="ident" id="5279654">c</span>&nbsp;<span class="op" id="5279656">-</span>&nbsp;<span class="string" id="5279658">&#39;a&#39;</span>&nbsp;<span class="op" id="5279662">+</span>&nbsp;<span class="num" id="5279664">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5279668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279671">if</span>&nbsp;<span class="string" id="5279674">&#39;A&#39;</span>&nbsp;<span class="op" id="5279678">&lt;=</span>&nbsp;<span class="ident" id="5279681">c</span>&nbsp;<span class="op" id="5279683">&amp;&amp;</span>&nbsp;<span class="ident" id="5279686">c</span>&nbsp;<span class="op" id="5279688">&lt;=</span>&nbsp;<span class="string" id="5279691">&#39;F&#39;</span>&nbsp;<span class="op" id="5279695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279699">return</span>&nbsp;<span class="ident" id="5279706">c</span>&nbsp;<span class="op" id="5279708">-</span>&nbsp;<span class="string" id="5279710">&#39;A&#39;</span>&nbsp;<span class="op" id="5279714">+</span>&nbsp;<span class="num" id="5279716">10</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5279720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279723">return</span>&nbsp;<span class="op" id="5279730">-</span><span class="num" id="5279731">1</span><br>
<span class="lineno"></span><span class="op" id="5279733">}</span>
</div>
</body>
</html>
