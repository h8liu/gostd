<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8329497">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8329552">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8329606">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8329657">package</span>&nbsp;<span class="ident" id="8329665">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8329670">import</span>&nbsp;<span class="op" id="8329677">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8329680">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8329687">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8329693">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8329704">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8329715">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8329723">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8329734">&#34;time&#34;</span><br>
<span class="lineno">15</span><span class="op" id="8329741">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8329744">func</span>&nbsp;<span class="ident" id="8329749">BenchmarkTCP4OneShot</span><span class="op" id="8329769">(</span><span class="ident" id="8329770">b</span>&nbsp;<span class="op" id="8329772">*</span><span class="ident" id="8329773">testing</span><span class="op" id="8329780">.</span><span class="ident" id="8329781">B</span><span class="op" id="8329782">)</span>&nbsp;<span class="op" id="8329784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8329787">benchmarkTCP</span><span class="op" id="8329799">(</span><span class="ident" id="8329800">b</span><span class="op" id="8329801">,</span>&nbsp;<span class="builtintype" id="8329803">false</span><span class="op" id="8329808">,</span>&nbsp;<span class="builtintype" id="8329810">false</span><span class="op" id="8329815">,</span>&nbsp;<span class="string" id="8329817">&#34;127.0.0.1:0&#34;</span><span class="op" id="8329830">)</span><br>
<span class="lineno"></span><span class="op" id="8329832">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="8329835">func</span>&nbsp;<span class="ident" id="8329840">BenchmarkTCP4OneShotTimeout</span><span class="op" id="8329867">(</span><span class="ident" id="8329868">b</span>&nbsp;<span class="op" id="8329870">*</span><span class="ident" id="8329871">testing</span><span class="op" id="8329878">.</span><span class="ident" id="8329879">B</span><span class="op" id="8329880">)</span>&nbsp;<span class="op" id="8329882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8329885">benchmarkTCP</span><span class="op" id="8329897">(</span><span class="ident" id="8329898">b</span><span class="op" id="8329899">,</span>&nbsp;<span class="builtintype" id="8329901">false</span><span class="op" id="8329906">,</span>&nbsp;<span class="builtintype" id="8329908">true</span><span class="op" id="8329912">,</span>&nbsp;<span class="string" id="8329914">&#34;127.0.0.1:0&#34;</span><span class="op" id="8329927">)</span><br>
<span class="lineno"></span><span class="op" id="8329929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="8329932">func</span>&nbsp;<span class="ident" id="8329937">BenchmarkTCP4Persistent</span><span class="op" id="8329960">(</span><span class="ident" id="8329961">b</span>&nbsp;<span class="op" id="8329963">*</span><span class="ident" id="8329964">testing</span><span class="op" id="8329971">.</span><span class="ident" id="8329972">B</span><span class="op" id="8329973">)</span>&nbsp;<span class="op" id="8329975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8329978">benchmarkTCP</span><span class="op" id="8329990">(</span><span class="ident" id="8329991">b</span><span class="op" id="8329992">,</span>&nbsp;<span class="builtintype" id="8329994">true</span><span class="op" id="8329998">,</span>&nbsp;<span class="builtintype" id="8330000">false</span><span class="op" id="8330005">,</span>&nbsp;<span class="string" id="8330007">&#34;127.0.0.1:0&#34;</span><span class="op" id="8330020">)</span><br>
<span class="lineno"></span><span class="op" id="8330022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8330025">func</span>&nbsp;<span class="ident" id="8330030">BenchmarkTCP4PersistentTimeout</span><span class="op" id="8330060">(</span><span class="ident" id="8330061">b</span>&nbsp;<span class="op" id="8330063">*</span><span class="ident" id="8330064">testing</span><span class="op" id="8330071">.</span><span class="ident" id="8330072">B</span><span class="op" id="8330073">)</span>&nbsp;<span class="op" id="8330075">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8330078">benchmarkTCP</span><span class="op" id="8330090">(</span><span class="ident" id="8330091">b</span><span class="op" id="8330092">,</span>&nbsp;<span class="builtintype" id="8330094">true</span><span class="op" id="8330098">,</span>&nbsp;<span class="builtintype" id="8330100">true</span><span class="op" id="8330104">,</span>&nbsp;<span class="string" id="8330106">&#34;127.0.0.1:0&#34;</span><span class="op" id="8330119">)</span><br>
<span class="lineno"></span><span class="op" id="8330121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8330124">func</span>&nbsp;<span class="ident" id="8330129">BenchmarkTCP6OneShot</span><span class="op" id="8330149">(</span><span class="ident" id="8330150">b</span>&nbsp;<span class="op" id="8330152">*</span><span class="ident" id="8330153">testing</span><span class="op" id="8330160">.</span><span class="ident" id="8330161">B</span><span class="op" id="8330162">)</span>&nbsp;<span class="op" id="8330164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8330167">if</span>&nbsp;<span class="op" id="8330170">!</span><span class="ident" id="8330171">supportsIPv6</span>&nbsp;<span class="op" id="8330184">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8330188">b</span><span class="op" id="8330189">.</span><span class="ident" id="8330190">Skip</span><span class="op" id="8330194">(</span><span class="string" id="8330195">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8330218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8330221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8330224">benchmarkTCP</span><span class="op" id="8330236">(</span><span class="ident" id="8330237">b</span><span class="op" id="8330238">,</span>&nbsp;<span class="builtintype" id="8330240">false</span><span class="op" id="8330245">,</span>&nbsp;<span class="builtintype" id="8330247">false</span><span class="op" id="8330252">,</span>&nbsp;<span class="string" id="8330254">&#34;[::1]:0&#34;</span><span class="op" id="8330263">)</span><br>
<span class="lineno"></span><span class="op" id="8330265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="8330268">func</span>&nbsp;<span class="ident" id="8330273">BenchmarkTCP6OneShotTimeout</span><span class="op" id="8330300">(</span><span class="ident" id="8330301">b</span>&nbsp;<span class="op" id="8330303">*</span><span class="ident" id="8330304">testing</span><span class="op" id="8330311">.</span><span class="ident" id="8330312">B</span><span class="op" id="8330313">)</span>&nbsp;<span class="op" id="8330315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8330318">if</span>&nbsp;<span class="op" id="8330321">!</span><span class="ident" id="8330322">supportsIPv6</span>&nbsp;<span class="op" id="8330335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8330339">b</span><span class="op" id="8330340">.</span><span class="ident" id="8330341">Skip</span><span class="op" id="8330345">(</span><span class="string" id="8330346">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8330369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8330372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8330375">benchmarkTCP</span><span class="op" id="8330387">(</span><span class="ident" id="8330388">b</span><span class="op" id="8330389">,</span>&nbsp;<span class="builtintype" id="8330391">false</span><span class="op" id="8330396">,</span>&nbsp;<span class="builtintype" id="8330398">true</span><span class="op" id="8330402">,</span>&nbsp;<span class="string" id="8330404">&#34;[::1]:0&#34;</span><span class="op" id="8330413">)</span><br>
<span class="lineno">45</span><span class="op" id="8330415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8330418">func</span>&nbsp;<span class="ident" id="8330423">BenchmarkTCP6Persistent</span><span class="op" id="8330446">(</span><span class="ident" id="8330447">b</span>&nbsp;<span class="op" id="8330449">*</span><span class="ident" id="8330450">testing</span><span class="op" id="8330457">.</span><span class="ident" id="8330458">B</span><span class="op" id="8330459">)</span>&nbsp;<span class="op" id="8330461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8330464">if</span>&nbsp;<span class="op" id="8330467">!</span><span class="ident" id="8330468">supportsIPv6</span>&nbsp;<span class="op" id="8330481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8330485">b</span><span class="op" id="8330486">.</span><span class="ident" id="8330487">Skip</span><span class="op" id="8330491">(</span><span class="string" id="8330492">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8330515">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8330518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8330521">benchmarkTCP</span><span class="op" id="8330533">(</span><span class="ident" id="8330534">b</span><span class="op" id="8330535">,</span>&nbsp;<span class="builtintype" id="8330537">true</span><span class="op" id="8330541">,</span>&nbsp;<span class="builtintype" id="8330543">false</span><span class="op" id="8330548">,</span>&nbsp;<span class="string" id="8330550">&#34;[::1]:0&#34;</span><span class="op" id="8330559">)</span><br>
<span class="lineno"></span><span class="op" id="8330561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8330564">func</span>&nbsp;<span class="ident" id="8330569">BenchmarkTCP6PersistentTimeout</span><span class="op" id="8330599">(</span><span class="ident" id="8330600">b</span>&nbsp;<span class="op" id="8330602">*</span><span class="ident" id="8330603">testing</span><span class="op" id="8330610">.</span><span class="ident" id="8330611">B</span><span class="op" id="8330612">)</span>&nbsp;<span class="op" id="8330614">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8330617">if</span>&nbsp;<span class="op" id="8330620">!</span><span class="ident" id="8330621">supportsIPv6</span>&nbsp;<span class="op" id="8330634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8330638">b</span><span class="op" id="8330639">.</span><span class="ident" id="8330640">Skip</span><span class="op" id="8330644">(</span><span class="string" id="8330645">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8330668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8330671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8330674">benchmarkTCP</span><span class="op" id="8330686">(</span><span class="ident" id="8330687">b</span><span class="op" id="8330688">,</span>&nbsp;<span class="builtintype" id="8330690">true</span><span class="op" id="8330694">,</span>&nbsp;<span class="builtintype" id="8330696">true</span><span class="op" id="8330700">,</span>&nbsp;<span class="string" id="8330702">&#34;[::1]:0&#34;</span><span class="op" id="8330711">)</span><br>
<span class="lineno"></span><span class="op" id="8330713">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="8330716">func</span>&nbsp;<span class="ident" id="8330721">benchmarkTCP</span><span class="op" id="8330733">(</span><span class="ident" id="8330734">b</span>&nbsp;<span class="op" id="8330736">*</span><span class="ident" id="8330737">testing</span><span class="op" id="8330744">.</span><span class="ident" id="8330745">B</span><span class="op" id="8330746">,</span>&nbsp;<span class="ident" id="8330748">persistent</span><span class="op" id="8330758">,</span>&nbsp;<span class="ident" id="8330760">timeout</span>&nbsp;<span class="builtintype" id="8330768">bool</span><span class="op" id="8330772">,</span>&nbsp;<span class="ident" id="8330774">laddr</span>&nbsp;<span class="builtintype" id="8330780">string</span><span class="op" id="8330786">)</span>&nbsp;<span class="op" id="8330788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8330791">const</span>&nbsp;<span class="ident" id="8330797">msgLen</span>&nbsp;<span class="op" id="8330804">=</span>&nbsp;<span class="num" id="8330806">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8330811">conns</span>&nbsp;<span class="op" id="8330817">:=</span>&nbsp;<span class="ident" id="8330820">b</span><span class="op" id="8330821">.</span><span class="ident" id="8330822">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8330825">numConcurrent</span>&nbsp;<span class="op" id="8330839">:=</span>&nbsp;<span class="ident" id="8330842">runtime</span><span class="op" id="8330849">.</span><span class="ident" id="8330850">GOMAXPROCS</span><span class="op" id="8330860">(</span><span class="op" id="8330861">-</span><span class="num" id="8330862">1</span><span class="op" id="8330863">)</span>&nbsp;<span class="op" id="8330865">*</span>&nbsp;<span class="num" id="8330867">2</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8330870">msgs</span>&nbsp;<span class="op" id="8330875">:=</span>&nbsp;<span class="num" id="8330878">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8330881">if</span>&nbsp;<span class="ident" id="8330884">persistent</span>&nbsp;<span class="op" id="8330895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8330899">conns</span>&nbsp;<span class="op" id="8330905">=</span>&nbsp;<span class="ident" id="8330907">numConcurrent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8330923">msgs</span>&nbsp;<span class="op" id="8330928">=</span>&nbsp;<span class="ident" id="8330930">b</span><span class="op" id="8330931">.</span><span class="ident" id="8330932">N</span>&nbsp;<span class="op" id="8330934">/</span>&nbsp;<span class="ident" id="8330936">conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8330944">if</span>&nbsp;<span class="ident" id="8330947">msgs</span>&nbsp;<span class="op" id="8330952">==</span>&nbsp;<span class="num" id="8330955">0</span>&nbsp;<span class="op" id="8330957">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8330962">msgs</span>&nbsp;<span class="op" id="8330967">=</span>&nbsp;<span class="num" id="8330969">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8330973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8330977">if</span>&nbsp;<span class="ident" id="8330980">conns</span>&nbsp;<span class="op" id="8330986">&gt;</span>&nbsp;<span class="ident" id="8330988">b</span><span class="op" id="8330989">.</span><span class="ident" id="8330990">N</span>&nbsp;<span class="op" id="8330992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8330997">conns</span>&nbsp;<span class="op" id="8331003">=</span>&nbsp;<span class="ident" id="8331005">b</span><span class="op" id="8331006">.</span><span class="ident" id="8331007">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8331011">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8331014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8331017">sendMsg</span>&nbsp;<span class="op" id="8331025">:=</span>&nbsp;<span class="keyword" id="8331028">func</span><span class="op" id="8331032">(</span><span class="ident" id="8331033">c</span>&nbsp;<span class="ident" id="8331035">Conn</span><span class="op" id="8331039">,</span>&nbsp;<span class="ident" id="8331041">buf</span>&nbsp;<span class="op" id="8331045">[</span><span class="op" id="8331046">]</span><span class="builtintype" id="8331047">byte</span><span class="op" id="8331051">)</span>&nbsp;<span class="builtintype" id="8331053">bool</span>&nbsp;<span class="op" id="8331058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8331062">n</span><span class="op" id="8331063">,</span>&nbsp;<span class="ident" id="8331065">err</span>&nbsp;<span class="op" id="8331069">:=</span>&nbsp;<span class="ident" id="8331072">c</span><span class="op" id="8331073">.</span><span class="ident" id="8331074">Write</span><span class="op" id="8331079">(</span><span class="ident" id="8331080">buf</span><span class="op" id="8331083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331087">if</span>&nbsp;<span class="ident" id="8331090">n</span>&nbsp;<span class="op" id="8331092">!=</span>&nbsp;<span class="builtinfunc" id="8331095">len</span><span class="op" id="8331098">(</span><span class="ident" id="8331099">buf</span><span class="op" id="8331102">)</span>&nbsp;<span class="op" id="8331104">||</span>&nbsp;<span class="ident" id="8331107">err</span>&nbsp;<span class="op" id="8331111">!=</span>&nbsp;<span class="ident" id="8331114">nil</span>&nbsp;<span class="op" id="8331118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8331123">b</span><span class="op" id="8331124">.</span><span class="ident" id="8331125">Logf</span><span class="op" id="8331129">(</span><span class="string" id="8331130">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8331148">,</span>&nbsp;<span class="ident" id="8331150">err</span><span class="op" id="8331153">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331158">return</span>&nbsp;<span class="builtintype" id="8331165">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8331173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331177">return</span>&nbsp;<span class="builtintype" id="8331184">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8331190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8331193">recvMsg</span>&nbsp;<span class="op" id="8331201">:=</span>&nbsp;<span class="keyword" id="8331204">func</span><span class="op" id="8331208">(</span><span class="ident" id="8331209">c</span>&nbsp;<span class="ident" id="8331211">Conn</span><span class="op" id="8331215">,</span>&nbsp;<span class="ident" id="8331217">buf</span>&nbsp;<span class="op" id="8331221">[</span><span class="op" id="8331222">]</span><span class="builtintype" id="8331223">byte</span><span class="op" id="8331227">)</span>&nbsp;<span class="builtintype" id="8331229">bool</span>&nbsp;<span class="op" id="8331234">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331238">for</span>&nbsp;<span class="ident" id="8331242">read</span>&nbsp;<span class="op" id="8331247">:=</span>&nbsp;<span class="num" id="8331250">0</span><span class="op" id="8331251">;</span>&nbsp;<span class="ident" id="8331253">read</span>&nbsp;<span class="op" id="8331258">!=</span>&nbsp;<span class="builtinfunc" id="8331261">len</span><span class="op" id="8331264">(</span><span class="ident" id="8331265">buf</span><span class="op" id="8331268">)</span><span class="op" id="8331269">;</span>&nbsp;<span class="op" id="8331271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8331276">n</span><span class="op" id="8331277">,</span>&nbsp;<span class="ident" id="8331279">err</span>&nbsp;<span class="op" id="8331283">:=</span>&nbsp;<span class="ident" id="8331286">c</span><span class="op" id="8331287">.</span><span class="ident" id="8331288">Read</span><span class="op" id="8331292">(</span><span class="ident" id="8331293">buf</span><span class="op" id="8331296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8331301">read</span>&nbsp;<span class="op" id="8331306">+=</span>&nbsp;<span class="ident" id="8331309">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331314">if</span>&nbsp;<span class="ident" id="8331317">err</span>&nbsp;<span class="op" id="8331321">!=</span>&nbsp;<span class="ident" id="8331324">nil</span>&nbsp;<span class="op" id="8331328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8331334">b</span><span class="op" id="8331335">.</span><span class="ident" id="8331336">Logf</span><span class="op" id="8331340">(</span><span class="string" id="8331341">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8331358">,</span>&nbsp;<span class="ident" id="8331360">err</span><span class="op" id="8331363">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331369">return</span>&nbsp;<span class="builtintype" id="8331376">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8331385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8331389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331393">return</span>&nbsp;<span class="builtintype" id="8331400">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8331406">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8331409">ln</span><span class="op" id="8331411">,</span>&nbsp;<span class="ident" id="8331413">err</span>&nbsp;<span class="op" id="8331417">:=</span>&nbsp;<span class="ident" id="8331420">Listen</span><span class="op" id="8331426">(</span><span class="string" id="8331427">&#34;tcp&#34;</span><span class="op" id="8331432">,</span>&nbsp;<span class="ident" id="8331434">laddr</span><span class="op" id="8331439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331442">if</span>&nbsp;<span class="ident" id="8331445">err</span>&nbsp;<span class="op" id="8331449">!=</span>&nbsp;<span class="ident" id="8331452">nil</span>&nbsp;<span class="op" id="8331456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8331460">b</span><span class="op" id="8331461">.</span><span class="ident" id="8331462">Fatalf</span><span class="op" id="8331468">(</span><span class="string" id="8331469">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8331488">,</span>&nbsp;<span class="ident" id="8331490">err</span><span class="op" id="8331493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8331496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331499">defer</span>&nbsp;<span class="ident" id="8331505">ln</span><span class="op" id="8331507">.</span><span class="ident" id="8331508">Close</span><span class="op" id="8331513">(</span><span class="op" id="8331514">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8331517">serverSem</span>&nbsp;<span class="op" id="8331527">:=</span>&nbsp;<span class="builtinfunc" id="8331530">make</span><span class="op" id="8331534">(</span><span class="keyword" id="8331535">chan</span>&nbsp;<span class="builtintype" id="8331540">bool</span><span class="op" id="8331544">,</span>&nbsp;<span class="ident" id="8331546">numConcurrent</span><span class="op" id="8331559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8331562">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331576">go</span>&nbsp;<span class="keyword" id="8331579">func</span><span class="op" id="8331583">(</span><span class="op" id="8331584">)</span>&nbsp;<span class="op" id="8331586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331590">for</span>&nbsp;<span class="op" id="8331594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8331599">c</span><span class="op" id="8331600">,</span>&nbsp;<span class="ident" id="8331602">err</span>&nbsp;<span class="op" id="8331606">:=</span>&nbsp;<span class="ident" id="8331609">ln</span><span class="op" id="8331611">.</span><span class="ident" id="8331612">Accept</span><span class="op" id="8331618">(</span><span class="op" id="8331619">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331624">if</span>&nbsp;<span class="ident" id="8331627">err</span>&nbsp;<span class="op" id="8331631">!=</span>&nbsp;<span class="ident" id="8331634">nil</span>&nbsp;<span class="op" id="8331638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331644">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8331653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8331658">serverSem</span>&nbsp;<span class="op" id="8331668">&lt;-</span>&nbsp;<span class="builtintype" id="8331671">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8331679">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331704">go</span>&nbsp;<span class="keyword" id="8331707">func</span><span class="op" id="8331711">(</span><span class="ident" id="8331712">c</span>&nbsp;<span class="ident" id="8331714">Conn</span><span class="op" id="8331718">)</span>&nbsp;<span class="op" id="8331720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331726">defer</span>&nbsp;<span class="keyword" id="8331732">func</span><span class="op" id="8331736">(</span><span class="op" id="8331737">)</span>&nbsp;<span class="op" id="8331739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8331746">c</span><span class="op" id="8331747">.</span><span class="ident" id="8331748">Close</span><span class="op" id="8331753">(</span><span class="op" id="8331754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8331761">&lt;-</span><span class="ident" id="8331763">serverSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8331777">}</span><span class="op" id="8331778">(</span><span class="op" id="8331779">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331785">if</span>&nbsp;<span class="ident" id="8331788">timeout</span>&nbsp;<span class="op" id="8331796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8331803">c</span><span class="op" id="8331804">.</span><span class="ident" id="8331805">SetDeadline</span><span class="op" id="8331816">(</span><span class="ident" id="8331817">time</span><span class="op" id="8331821">.</span><span class="ident" id="8331822">Now</span><span class="op" id="8331825">(</span><span class="op" id="8331826">)</span><span class="op" id="8331827">.</span><span class="ident" id="8331828">Add</span><span class="op" id="8331831">(</span><span class="ident" id="8331832">time</span><span class="op" id="8331836">.</span><span class="ident" id="8331837">Hour</span><span class="op" id="8331841">)</span><span class="op" id="8331842">)</span>&nbsp;<span class="comment" id="8331844">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8331873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331879">var</span>&nbsp;<span class="ident" id="8331883">buf</span>&nbsp;<span class="op" id="8331887">[</span><span class="ident" id="8331888">msgLen</span><span class="op" id="8331894">]</span><span class="builtintype" id="8331895">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331904">for</span>&nbsp;<span class="ident" id="8331908">m</span>&nbsp;<span class="op" id="8331910">:=</span>&nbsp;<span class="num" id="8331913">0</span><span class="op" id="8331914">;</span>&nbsp;<span class="ident" id="8331916">m</span>&nbsp;<span class="op" id="8331918">&lt;</span>&nbsp;<span class="ident" id="8331920">msgs</span><span class="op" id="8331924">;</span>&nbsp;<span class="ident" id="8331926">m</span><span class="op" id="8331927">++</span>&nbsp;<span class="op" id="8331930">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331937">if</span>&nbsp;<span class="op" id="8331940">!</span><span class="ident" id="8331941">recvMsg</span><span class="op" id="8331948">(</span><span class="ident" id="8331949">c</span><span class="op" id="8331950">,</span>&nbsp;<span class="ident" id="8331952">buf</span><span class="op" id="8331955">[</span><span class="op" id="8331956">:</span><span class="op" id="8331957">]</span><span class="op" id="8331958">)</span>&nbsp;<span class="op" id="8331960">||</span>&nbsp;<span class="op" id="8331963">!</span><span class="ident" id="8331964">sendMsg</span><span class="op" id="8331971">(</span><span class="ident" id="8331972">c</span><span class="op" id="8331973">,</span>&nbsp;<span class="ident" id="8331975">buf</span><span class="op" id="8331978">[</span><span class="op" id="8331979">:</span><span class="op" id="8331980">]</span><span class="op" id="8331981">)</span>&nbsp;<span class="op" id="8331983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8331991">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8332002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8332008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8332013">}</span><span class="op" id="8332014">(</span><span class="ident" id="8332015">c</span><span class="op" id="8332016">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8332020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8332023">}</span><span class="op" id="8332024">(</span><span class="op" id="8332025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8332028">clientSem</span>&nbsp;<span class="op" id="8332038">:=</span>&nbsp;<span class="builtinfunc" id="8332041">make</span><span class="op" id="8332045">(</span><span class="keyword" id="8332046">chan</span>&nbsp;<span class="builtintype" id="8332051">bool</span><span class="op" id="8332055">,</span>&nbsp;<span class="ident" id="8332057">numConcurrent</span><span class="op" id="8332070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8332073">for</span>&nbsp;<span class="ident" id="8332077">i</span>&nbsp;<span class="op" id="8332079">:=</span>&nbsp;<span class="num" id="8332082">0</span><span class="op" id="8332083">;</span>&nbsp;<span class="ident" id="8332085">i</span>&nbsp;<span class="op" id="8332087">&lt;</span>&nbsp;<span class="ident" id="8332089">conns</span><span class="op" id="8332094">;</span>&nbsp;<span class="ident" id="8332096">i</span><span class="op" id="8332097">++</span>&nbsp;<span class="op" id="8332100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8332104">clientSem</span>&nbsp;<span class="op" id="8332114">&lt;-</span>&nbsp;<span class="builtintype" id="8332117">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8332124">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8332148">go</span>&nbsp;<span class="keyword" id="8332151">func</span><span class="op" id="8332155">(</span><span class="op" id="8332156">)</span>&nbsp;<span class="op" id="8332158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8332163">defer</span>&nbsp;<span class="keyword" id="8332169">func</span><span class="op" id="8332173">(</span><span class="op" id="8332174">)</span>&nbsp;<span class="op" id="8332176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8332182">&lt;-</span><span class="ident" id="8332184">clientSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8332197">}</span><span class="op" id="8332198">(</span><span class="op" id="8332199">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8332204">c</span><span class="op" id="8332205">,</span>&nbsp;<span class="ident" id="8332207">err</span>&nbsp;<span class="op" id="8332211">:=</span>&nbsp;<span class="ident" id="8332214">Dial</span><span class="op" id="8332218">(</span><span class="string" id="8332219">&#34;tcp&#34;</span><span class="op" id="8332224">,</span>&nbsp;<span class="ident" id="8332226">ln</span><span class="op" id="8332228">.</span><span class="ident" id="8332229">Addr</span><span class="op" id="8332233">(</span><span class="op" id="8332234">)</span><span class="op" id="8332235">.</span><span class="ident" id="8332236">String</span><span class="op" id="8332242">(</span><span class="op" id="8332243">)</span><span class="op" id="8332244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8332249">if</span>&nbsp;<span class="ident" id="8332252">err</span>&nbsp;<span class="op" id="8332256">!=</span>&nbsp;<span class="ident" id="8332259">nil</span>&nbsp;<span class="op" id="8332263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8332269">b</span><span class="op" id="8332270">.</span><span class="ident" id="8332271">Logf</span><span class="op" id="8332275">(</span><span class="string" id="8332276">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8332293">,</span>&nbsp;<span class="ident" id="8332295">err</span><span class="op" id="8332298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8332304">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8332314">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8332319">defer</span>&nbsp;<span class="ident" id="8332325">c</span><span class="op" id="8332326">.</span><span class="ident" id="8332327">Close</span><span class="op" id="8332332">(</span><span class="op" id="8332333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8332338">if</span>&nbsp;<span class="ident" id="8332341">timeout</span>&nbsp;<span class="op" id="8332349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8332355">c</span><span class="op" id="8332356">.</span><span class="ident" id="8332357">SetDeadline</span><span class="op" id="8332368">(</span><span class="ident" id="8332369">time</span><span class="op" id="8332373">.</span><span class="ident" id="8332374">Now</span><span class="op" id="8332377">(</span><span class="op" id="8332378">)</span><span class="op" id="8332379">.</span><span class="ident" id="8332380">Add</span><span class="op" id="8332383">(</span><span class="ident" id="8332384">time</span><span class="op" id="8332388">.</span><span class="ident" id="8332389">Hour</span><span class="op" id="8332393">)</span><span class="op" id="8332394">)</span>&nbsp;<span class="comment" id="8332396">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8332424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8332429">var</span>&nbsp;<span class="ident" id="8332433">buf</span>&nbsp;<span class="op" id="8332437">[</span><span class="ident" id="8332438">msgLen</span><span class="op" id="8332444">]</span><span class="builtintype" id="8332445">byte</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8332453">for</span>&nbsp;<span class="ident" id="8332457">m</span>&nbsp;<span class="op" id="8332459">:=</span>&nbsp;<span class="num" id="8332462">0</span><span class="op" id="8332463">;</span>&nbsp;<span class="ident" id="8332465">m</span>&nbsp;<span class="op" id="8332467">&lt;</span>&nbsp;<span class="ident" id="8332469">msgs</span><span class="op" id="8332473">;</span>&nbsp;<span class="ident" id="8332475">m</span><span class="op" id="8332476">++</span>&nbsp;<span class="op" id="8332479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8332485">if</span>&nbsp;<span class="op" id="8332488">!</span><span class="ident" id="8332489">sendMsg</span><span class="op" id="8332496">(</span><span class="ident" id="8332497">c</span><span class="op" id="8332498">,</span>&nbsp;<span class="ident" id="8332500">buf</span><span class="op" id="8332503">[</span><span class="op" id="8332504">:</span><span class="op" id="8332505">]</span><span class="op" id="8332506">)</span>&nbsp;<span class="op" id="8332508">||</span>&nbsp;<span class="op" id="8332511">!</span><span class="ident" id="8332512">recvMsg</span><span class="op" id="8332519">(</span><span class="ident" id="8332520">c</span><span class="op" id="8332521">,</span>&nbsp;<span class="ident" id="8332523">buf</span><span class="op" id="8332526">[</span><span class="op" id="8332527">:</span><span class="op" id="8332528">]</span><span class="op" id="8332529">)</span>&nbsp;<span class="op" id="8332531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8332538">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8332548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8332553">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8332557">}</span><span class="op" id="8332558">(</span><span class="op" id="8332559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8332562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8332565">for</span>&nbsp;<span class="ident" id="8332569">i</span>&nbsp;<span class="op" id="8332571">:=</span>&nbsp;<span class="num" id="8332574">0</span><span class="op" id="8332575">;</span>&nbsp;<span class="ident" id="8332577">i</span>&nbsp;<span class="op" id="8332579">&lt;</span>&nbsp;<span class="ident" id="8332581">numConcurrent</span><span class="op" id="8332594">;</span>&nbsp;<span class="ident" id="8332596">i</span><span class="op" id="8332597">++</span>&nbsp;<span class="op" id="8332600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8332604">clientSem</span>&nbsp;<span class="op" id="8332614">&lt;-</span>&nbsp;<span class="builtintype" id="8332617">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8332624">serverSem</span>&nbsp;<span class="op" id="8332634">&lt;-</span>&nbsp;<span class="builtintype" id="8332637">true</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8332643">}</span><br>
<span class="lineno"></span><span class="op" id="8332645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8332648">func</span>&nbsp;<span class="ident" id="8332653">BenchmarkTCP4ConcurrentReadWrite</span><span class="op" id="8332685">(</span><span class="ident" id="8332686">b</span>&nbsp;<span class="op" id="8332688">*</span><span class="ident" id="8332689">testing</span><span class="op" id="8332696">.</span><span class="ident" id="8332697">B</span><span class="op" id="8332698">)</span>&nbsp;<span class="op" id="8332700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8332703">benchmarkTCPConcurrentReadWrite</span><span class="op" id="8332734">(</span><span class="ident" id="8332735">b</span><span class="op" id="8332736">,</span>&nbsp;<span class="string" id="8332738">&#34;127.0.0.1:0&#34;</span><span class="op" id="8332751">)</span><br>
<span class="lineno">160</span><span class="op" id="8332753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8332756">func</span>&nbsp;<span class="ident" id="8332761">BenchmarkTCP6ConcurrentReadWrite</span><span class="op" id="8332793">(</span><span class="ident" id="8332794">b</span>&nbsp;<span class="op" id="8332796">*</span><span class="ident" id="8332797">testing</span><span class="op" id="8332804">.</span><span class="ident" id="8332805">B</span><span class="op" id="8332806">)</span>&nbsp;<span class="op" id="8332808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8332811">if</span>&nbsp;<span class="op" id="8332814">!</span><span class="ident" id="8332815">supportsIPv6</span>&nbsp;<span class="op" id="8332828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8332832">b</span><span class="op" id="8332833">.</span><span class="ident" id="8332834">Skip</span><span class="op" id="8332838">(</span><span class="string" id="8332839">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8332862">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8332865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8332868">benchmarkTCPConcurrentReadWrite</span><span class="op" id="8332899">(</span><span class="ident" id="8332900">b</span><span class="op" id="8332901">,</span>&nbsp;<span class="string" id="8332903">&#34;[::1]:0&#34;</span><span class="op" id="8332912">)</span><br>
<span class="lineno"></span><span class="op" id="8332914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8332917">func</span>&nbsp;<span class="ident" id="8332922">benchmarkTCPConcurrentReadWrite</span><span class="op" id="8332953">(</span><span class="ident" id="8332954">b</span>&nbsp;<span class="op" id="8332956">*</span><span class="ident" id="8332957">testing</span><span class="op" id="8332964">.</span><span class="ident" id="8332965">B</span><span class="op" id="8332966">,</span>&nbsp;<span class="ident" id="8332968">laddr</span>&nbsp;<span class="builtintype" id="8332974">string</span><span class="op" id="8332980">)</span>&nbsp;<span class="op" id="8332982">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8332985">//&nbsp;The&nbsp;benchmark&nbsp;creates&nbsp;GOMAXPROCS&nbsp;client/server&nbsp;pairs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8333043">//&nbsp;Each&nbsp;pair&nbsp;creates&nbsp;4&nbsp;goroutines:&nbsp;client&nbsp;reader/writer&nbsp;and&nbsp;server&nbsp;reader/writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8333126">//&nbsp;The&nbsp;benchmark&nbsp;stresses&nbsp;concurrent&nbsp;reading&nbsp;and&nbsp;writing&nbsp;to&nbsp;the&nbsp;same&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8333208">//&nbsp;Such&nbsp;pattern&nbsp;is&nbsp;used&nbsp;in&nbsp;net/http&nbsp;and&nbsp;net/rpc.</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333259">b</span><span class="op" id="8333260">.</span><span class="ident" id="8333261">StopTimer</span><span class="op" id="8333270">(</span><span class="op" id="8333271">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333275">P</span>&nbsp;<span class="op" id="8333277">:=</span>&nbsp;<span class="ident" id="8333280">runtime</span><span class="op" id="8333287">.</span><span class="ident" id="8333288">GOMAXPROCS</span><span class="op" id="8333298">(</span><span class="num" id="8333299">0</span><span class="op" id="8333300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333303">N</span>&nbsp;<span class="op" id="8333305">:=</span>&nbsp;<span class="ident" id="8333308">b</span><span class="op" id="8333309">.</span><span class="ident" id="8333310">N</span>&nbsp;<span class="op" id="8333312">/</span>&nbsp;<span class="ident" id="8333314">P</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333317">W</span>&nbsp;<span class="op" id="8333319">:=</span>&nbsp;<span class="num" id="8333322">1000</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8333329">//&nbsp;Setup&nbsp;P&nbsp;client/server&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333368">clients</span>&nbsp;<span class="op" id="8333376">:=</span>&nbsp;<span class="builtinfunc" id="8333379">make</span><span class="op" id="8333383">(</span><span class="op" id="8333384">[</span><span class="op" id="8333385">]</span><span class="ident" id="8333386">Conn</span><span class="op" id="8333390">,</span>&nbsp;<span class="ident" id="8333392">P</span><span class="op" id="8333393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333396">servers</span>&nbsp;<span class="op" id="8333404">:=</span>&nbsp;<span class="builtinfunc" id="8333407">make</span><span class="op" id="8333411">(</span><span class="op" id="8333412">[</span><span class="op" id="8333413">]</span><span class="ident" id="8333414">Conn</span><span class="op" id="8333418">,</span>&nbsp;<span class="ident" id="8333420">P</span><span class="op" id="8333421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333424">ln</span><span class="op" id="8333426">,</span>&nbsp;<span class="ident" id="8333428">err</span>&nbsp;<span class="op" id="8333432">:=</span>&nbsp;<span class="ident" id="8333435">Listen</span><span class="op" id="8333441">(</span><span class="string" id="8333442">&#34;tcp&#34;</span><span class="op" id="8333447">,</span>&nbsp;<span class="ident" id="8333449">laddr</span><span class="op" id="8333454">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8333457">if</span>&nbsp;<span class="ident" id="8333460">err</span>&nbsp;<span class="op" id="8333464">!=</span>&nbsp;<span class="ident" id="8333467">nil</span>&nbsp;<span class="op" id="8333471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333475">b</span><span class="op" id="8333476">.</span><span class="ident" id="8333477">Fatalf</span><span class="op" id="8333483">(</span><span class="string" id="8333484">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8333503">,</span>&nbsp;<span class="ident" id="8333505">err</span><span class="op" id="8333508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8333511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8333514">defer</span>&nbsp;<span class="ident" id="8333520">ln</span><span class="op" id="8333522">.</span><span class="ident" id="8333523">Close</span><span class="op" id="8333528">(</span><span class="op" id="8333529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333532">done</span>&nbsp;<span class="op" id="8333537">:=</span>&nbsp;<span class="builtinfunc" id="8333540">make</span><span class="op" id="8333544">(</span><span class="keyword" id="8333545">chan</span>&nbsp;<span class="builtintype" id="8333550">bool</span><span class="op" id="8333554">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8333557">go</span>&nbsp;<span class="keyword" id="8333560">func</span><span class="op" id="8333564">(</span><span class="op" id="8333565">)</span>&nbsp;<span class="op" id="8333567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8333571">for</span>&nbsp;<span class="ident" id="8333575">p</span>&nbsp;<span class="op" id="8333577">:=</span>&nbsp;<span class="num" id="8333580">0</span><span class="op" id="8333581">;</span>&nbsp;<span class="ident" id="8333583">p</span>&nbsp;<span class="op" id="8333585">&lt;</span>&nbsp;<span class="ident" id="8333587">P</span><span class="op" id="8333588">;</span>&nbsp;<span class="ident" id="8333590">p</span><span class="op" id="8333591">++</span>&nbsp;<span class="op" id="8333594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333599">s</span><span class="op" id="8333600">,</span>&nbsp;<span class="ident" id="8333602">err</span>&nbsp;<span class="op" id="8333606">:=</span>&nbsp;<span class="ident" id="8333609">ln</span><span class="op" id="8333611">.</span><span class="ident" id="8333612">Accept</span><span class="op" id="8333618">(</span><span class="op" id="8333619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8333624">if</span>&nbsp;<span class="ident" id="8333627">err</span>&nbsp;<span class="op" id="8333631">!=</span>&nbsp;<span class="ident" id="8333634">nil</span>&nbsp;<span class="op" id="8333638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333644">b</span><span class="op" id="8333645">.</span><span class="ident" id="8333646">Errorf</span><span class="op" id="8333652">(</span><span class="string" id="8333653">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8333672">,</span>&nbsp;<span class="ident" id="8333674">err</span><span class="op" id="8333677">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8333683">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8333693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333698">servers</span><span class="op" id="8333705">[</span><span class="ident" id="8333706">p</span><span class="op" id="8333707">]</span>&nbsp;<span class="op" id="8333709">=</span>&nbsp;<span class="ident" id="8333711">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8333715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333719">done</span>&nbsp;<span class="op" id="8333724">&lt;-</span>&nbsp;<span class="builtintype" id="8333727">true</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8333733">}</span><span class="op" id="8333734">(</span><span class="op" id="8333735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8333738">for</span>&nbsp;<span class="ident" id="8333742">p</span>&nbsp;<span class="op" id="8333744">:=</span>&nbsp;<span class="num" id="8333747">0</span><span class="op" id="8333748">;</span>&nbsp;<span class="ident" id="8333750">p</span>&nbsp;<span class="op" id="8333752">&lt;</span>&nbsp;<span class="ident" id="8333754">P</span><span class="op" id="8333755">;</span>&nbsp;<span class="ident" id="8333757">p</span><span class="op" id="8333758">++</span>&nbsp;<span class="op" id="8333761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333765">c</span><span class="op" id="8333766">,</span>&nbsp;<span class="ident" id="8333768">err</span>&nbsp;<span class="op" id="8333772">:=</span>&nbsp;<span class="ident" id="8333775">Dial</span><span class="op" id="8333779">(</span><span class="string" id="8333780">&#34;tcp&#34;</span><span class="op" id="8333785">,</span>&nbsp;<span class="ident" id="8333787">ln</span><span class="op" id="8333789">.</span><span class="ident" id="8333790">Addr</span><span class="op" id="8333794">(</span><span class="op" id="8333795">)</span><span class="op" id="8333796">.</span><span class="ident" id="8333797">String</span><span class="op" id="8333803">(</span><span class="op" id="8333804">)</span><span class="op" id="8333805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8333809">if</span>&nbsp;<span class="ident" id="8333812">err</span>&nbsp;<span class="op" id="8333816">!=</span>&nbsp;<span class="ident" id="8333819">nil</span>&nbsp;<span class="op" id="8333823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333828">b</span><span class="op" id="8333829">.</span><span class="ident" id="8333830">Fatalf</span><span class="op" id="8333836">(</span><span class="string" id="8333837">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8333854">,</span>&nbsp;<span class="ident" id="8333856">err</span><span class="op" id="8333859">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8333863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333867">clients</span><span class="op" id="8333874">[</span><span class="ident" id="8333875">p</span><span class="op" id="8333876">]</span>&nbsp;<span class="op" id="8333878">=</span>&nbsp;<span class="ident" id="8333880">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8333883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8333886">&lt;-</span><span class="ident" id="8333888">done</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333895">b</span><span class="op" id="8333896">.</span><span class="ident" id="8333897">StartTimer</span><span class="op" id="8333907">(</span><span class="op" id="8333908">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8333912">var</span>&nbsp;<span class="ident" id="8333916">wg</span>&nbsp;<span class="ident" id="8333919">sync</span><span class="op" id="8333923">.</span><span class="ident" id="8333924">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8333935">wg</span><span class="op" id="8333937">.</span><span class="ident" id="8333938">Add</span><span class="op" id="8333941">(</span><span class="num" id="8333942">4</span>&nbsp;<span class="op" id="8333944">*</span>&nbsp;<span class="ident" id="8333946">P</span><span class="op" id="8333947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8333950">for</span>&nbsp;<span class="ident" id="8333954">p</span>&nbsp;<span class="op" id="8333956">:=</span>&nbsp;<span class="num" id="8333959">0</span><span class="op" id="8333960">;</span>&nbsp;<span class="ident" id="8333962">p</span>&nbsp;<span class="op" id="8333964">&lt;</span>&nbsp;<span class="ident" id="8333966">P</span><span class="op" id="8333967">;</span>&nbsp;<span class="ident" id="8333969">p</span><span class="op" id="8333970">++</span>&nbsp;<span class="op" id="8333973">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8333977">//&nbsp;Client&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8333997">go</span>&nbsp;<span class="keyword" id="8334000">func</span><span class="op" id="8334004">(</span><span class="ident" id="8334005">c</span>&nbsp;<span class="ident" id="8334007">Conn</span><span class="op" id="8334011">)</span>&nbsp;<span class="op" id="8334013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334018">defer</span>&nbsp;<span class="ident" id="8334024">wg</span><span class="op" id="8334026">.</span><span class="ident" id="8334027">Done</span><span class="op" id="8334031">(</span><span class="op" id="8334032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334037">var</span>&nbsp;<span class="ident" id="8334041">buf</span>&nbsp;<span class="op" id="8334045">[</span><span class="num" id="8334046">1</span><span class="op" id="8334047">]</span><span class="builtintype" id="8334048">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334056">for</span>&nbsp;<span class="ident" id="8334060">i</span>&nbsp;<span class="op" id="8334062">:=</span>&nbsp;<span class="num" id="8334065">0</span><span class="op" id="8334066">;</span>&nbsp;<span class="ident" id="8334068">i</span>&nbsp;<span class="op" id="8334070">&lt;</span>&nbsp;<span class="ident" id="8334072">N</span><span class="op" id="8334073">;</span>&nbsp;<span class="ident" id="8334075">i</span><span class="op" id="8334076">++</span>&nbsp;<span class="op" id="8334079">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8334085">v</span>&nbsp;<span class="op" id="8334087">:=</span>&nbsp;<span class="builtintype" id="8334090">byte</span><span class="op" id="8334094">(</span><span class="ident" id="8334095">i</span><span class="op" id="8334096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334102">for</span>&nbsp;<span class="ident" id="8334106">w</span>&nbsp;<span class="op" id="8334108">:=</span>&nbsp;<span class="num" id="8334111">0</span><span class="op" id="8334112">;</span>&nbsp;<span class="ident" id="8334114">w</span>&nbsp;<span class="op" id="8334116">&lt;</span>&nbsp;<span class="ident" id="8334118">W</span><span class="op" id="8334119">;</span>&nbsp;<span class="ident" id="8334121">w</span><span class="op" id="8334122">++</span>&nbsp;<span class="op" id="8334125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8334132">v</span>&nbsp;<span class="op" id="8334134">*=</span>&nbsp;<span class="ident" id="8334137">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8334143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8334149">buf</span><span class="op" id="8334152">[</span><span class="num" id="8334153">0</span><span class="op" id="8334154">]</span>&nbsp;<span class="op" id="8334156">=</span>&nbsp;<span class="ident" id="8334158">v</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8334164">_</span><span class="op" id="8334165">,</span>&nbsp;<span class="ident" id="8334167">err</span>&nbsp;<span class="op" id="8334171">:=</span>&nbsp;<span class="ident" id="8334174">c</span><span class="op" id="8334175">.</span><span class="ident" id="8334176">Write</span><span class="op" id="8334181">(</span><span class="ident" id="8334182">buf</span><span class="op" id="8334185">[</span><span class="op" id="8334186">:</span><span class="op" id="8334187">]</span><span class="op" id="8334188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334194">if</span>&nbsp;<span class="ident" id="8334197">err</span>&nbsp;<span class="op" id="8334201">!=</span>&nbsp;<span class="ident" id="8334204">nil</span>&nbsp;<span class="op" id="8334208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8334215">b</span><span class="op" id="8334216">.</span><span class="ident" id="8334217">Errorf</span><span class="op" id="8334223">(</span><span class="string" id="8334224">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8334242">,</span>&nbsp;<span class="ident" id="8334244">err</span><span class="op" id="8334247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334254">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8334265">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8334270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8334274">}</span><span class="op" id="8334275">(</span><span class="ident" id="8334276">clients</span><span class="op" id="8334283">[</span><span class="ident" id="8334284">p</span><span class="op" id="8334285">]</span><span class="op" id="8334286">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8334291">//&nbsp;Pipe&nbsp;between&nbsp;server&nbsp;reader&nbsp;and&nbsp;server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8334342">pipe</span>&nbsp;<span class="op" id="8334347">:=</span>&nbsp;<span class="builtinfunc" id="8334350">make</span><span class="op" id="8334354">(</span><span class="keyword" id="8334355">chan</span>&nbsp;<span class="builtintype" id="8334360">byte</span><span class="op" id="8334364">,</span>&nbsp;<span class="num" id="8334366">128</span><span class="op" id="8334369">)</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8334374">//&nbsp;Server&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334394">go</span>&nbsp;<span class="keyword" id="8334397">func</span><span class="op" id="8334401">(</span><span class="ident" id="8334402">s</span>&nbsp;<span class="ident" id="8334404">Conn</span><span class="op" id="8334408">)</span>&nbsp;<span class="op" id="8334410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334415">defer</span>&nbsp;<span class="ident" id="8334421">wg</span><span class="op" id="8334423">.</span><span class="ident" id="8334424">Done</span><span class="op" id="8334428">(</span><span class="op" id="8334429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334434">var</span>&nbsp;<span class="ident" id="8334438">buf</span>&nbsp;<span class="op" id="8334442">[</span><span class="num" id="8334443">1</span><span class="op" id="8334444">]</span><span class="builtintype" id="8334445">byte</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334453">for</span>&nbsp;<span class="ident" id="8334457">i</span>&nbsp;<span class="op" id="8334459">:=</span>&nbsp;<span class="num" id="8334462">0</span><span class="op" id="8334463">;</span>&nbsp;<span class="ident" id="8334465">i</span>&nbsp;<span class="op" id="8334467">&lt;</span>&nbsp;<span class="ident" id="8334469">N</span><span class="op" id="8334470">;</span>&nbsp;<span class="ident" id="8334472">i</span><span class="op" id="8334473">++</span>&nbsp;<span class="op" id="8334476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8334482">_</span><span class="op" id="8334483">,</span>&nbsp;<span class="ident" id="8334485">err</span>&nbsp;<span class="op" id="8334489">:=</span>&nbsp;<span class="ident" id="8334492">s</span><span class="op" id="8334493">.</span><span class="ident" id="8334494">Read</span><span class="op" id="8334498">(</span><span class="ident" id="8334499">buf</span><span class="op" id="8334502">[</span><span class="op" id="8334503">:</span><span class="op" id="8334504">]</span><span class="op" id="8334505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334511">if</span>&nbsp;<span class="ident" id="8334514">err</span>&nbsp;<span class="op" id="8334518">!=</span>&nbsp;<span class="ident" id="8334521">nil</span>&nbsp;<span class="op" id="8334525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8334532">b</span><span class="op" id="8334533">.</span><span class="ident" id="8334534">Errorf</span><span class="op" id="8334540">(</span><span class="string" id="8334541">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8334558">,</span>&nbsp;<span class="ident" id="8334560">err</span><span class="op" id="8334563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334570">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8334581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8334587">pipe</span>&nbsp;<span class="op" id="8334592">&lt;-</span>&nbsp;<span class="ident" id="8334595">buf</span><span class="op" id="8334598">[</span><span class="num" id="8334599">0</span><span class="op" id="8334600">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8334605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8334609">}</span><span class="op" id="8334610">(</span><span class="ident" id="8334611">servers</span><span class="op" id="8334618">[</span><span class="ident" id="8334619">p</span><span class="op" id="8334620">]</span><span class="op" id="8334621">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8334626">//&nbsp;Server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334646">go</span>&nbsp;<span class="keyword" id="8334649">func</span><span class="op" id="8334653">(</span><span class="ident" id="8334654">s</span>&nbsp;<span class="ident" id="8334656">Conn</span><span class="op" id="8334660">)</span>&nbsp;<span class="op" id="8334662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334667">defer</span>&nbsp;<span class="ident" id="8334673">wg</span><span class="op" id="8334675">.</span><span class="ident" id="8334676">Done</span><span class="op" id="8334680">(</span><span class="op" id="8334681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334686">var</span>&nbsp;<span class="ident" id="8334690">buf</span>&nbsp;<span class="op" id="8334694">[</span><span class="num" id="8334695">1</span><span class="op" id="8334696">]</span><span class="builtintype" id="8334697">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334705">for</span>&nbsp;<span class="ident" id="8334709">i</span>&nbsp;<span class="op" id="8334711">:=</span>&nbsp;<span class="num" id="8334714">0</span><span class="op" id="8334715">;</span>&nbsp;<span class="ident" id="8334717">i</span>&nbsp;<span class="op" id="8334719">&lt;</span>&nbsp;<span class="ident" id="8334721">N</span><span class="op" id="8334722">;</span>&nbsp;<span class="ident" id="8334724">i</span><span class="op" id="8334725">++</span>&nbsp;<span class="op" id="8334728">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8334734">v</span>&nbsp;<span class="op" id="8334736">:=</span>&nbsp;<span class="op" id="8334739">&lt;-</span><span class="ident" id="8334741">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334750">for</span>&nbsp;<span class="ident" id="8334754">w</span>&nbsp;<span class="op" id="8334756">:=</span>&nbsp;<span class="num" id="8334759">0</span><span class="op" id="8334760">;</span>&nbsp;<span class="ident" id="8334762">w</span>&nbsp;<span class="op" id="8334764">&lt;</span>&nbsp;<span class="ident" id="8334766">W</span><span class="op" id="8334767">;</span>&nbsp;<span class="ident" id="8334769">w</span><span class="op" id="8334770">++</span>&nbsp;<span class="op" id="8334773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8334780">v</span>&nbsp;<span class="op" id="8334782">*=</span>&nbsp;<span class="ident" id="8334785">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8334791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8334797">buf</span><span class="op" id="8334800">[</span><span class="num" id="8334801">0</span><span class="op" id="8334802">]</span>&nbsp;<span class="op" id="8334804">=</span>&nbsp;<span class="ident" id="8334806">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8334812">_</span><span class="op" id="8334813">,</span>&nbsp;<span class="ident" id="8334815">err</span>&nbsp;<span class="op" id="8334819">:=</span>&nbsp;<span class="ident" id="8334822">s</span><span class="op" id="8334823">.</span><span class="ident" id="8334824">Write</span><span class="op" id="8334829">(</span><span class="ident" id="8334830">buf</span><span class="op" id="8334833">[</span><span class="op" id="8334834">:</span><span class="op" id="8334835">]</span><span class="op" id="8334836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334842">if</span>&nbsp;<span class="ident" id="8334845">err</span>&nbsp;<span class="op" id="8334849">!=</span>&nbsp;<span class="ident" id="8334852">nil</span>&nbsp;<span class="op" id="8334856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8334863">b</span><span class="op" id="8334864">.</span><span class="ident" id="8334865">Errorf</span><span class="op" id="8334871">(</span><span class="string" id="8334872">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8334890">,</span>&nbsp;<span class="ident" id="8334892">err</span><span class="op" id="8334895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334902">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8334913">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8334918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8334923">s</span><span class="op" id="8334924">.</span><span class="ident" id="8334925">Close</span><span class="op" id="8334930">(</span><span class="op" id="8334931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8334935">}</span><span class="op" id="8334936">(</span><span class="ident" id="8334937">servers</span><span class="op" id="8334944">[</span><span class="ident" id="8334945">p</span><span class="op" id="8334946">]</span><span class="op" id="8334947">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8334952">//&nbsp;Client&nbsp;reader.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334972">go</span>&nbsp;<span class="keyword" id="8334975">func</span><span class="op" id="8334979">(</span><span class="ident" id="8334980">c</span>&nbsp;<span class="ident" id="8334982">Conn</span><span class="op" id="8334986">)</span>&nbsp;<span class="op" id="8334988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8334993">defer</span>&nbsp;<span class="ident" id="8334999">wg</span><span class="op" id="8335001">.</span><span class="ident" id="8335002">Done</span><span class="op" id="8335006">(</span><span class="op" id="8335007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8335012">var</span>&nbsp;<span class="ident" id="8335016">buf</span>&nbsp;<span class="op" id="8335020">[</span><span class="num" id="8335021">1</span><span class="op" id="8335022">]</span><span class="builtintype" id="8335023">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8335031">for</span>&nbsp;<span class="ident" id="8335035">i</span>&nbsp;<span class="op" id="8335037">:=</span>&nbsp;<span class="num" id="8335040">0</span><span class="op" id="8335041">;</span>&nbsp;<span class="ident" id="8335043">i</span>&nbsp;<span class="op" id="8335045">&lt;</span>&nbsp;<span class="ident" id="8335047">N</span><span class="op" id="8335048">;</span>&nbsp;<span class="ident" id="8335050">i</span><span class="op" id="8335051">++</span>&nbsp;<span class="op" id="8335054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8335060">_</span><span class="op" id="8335061">,</span>&nbsp;<span class="ident" id="8335063">err</span>&nbsp;<span class="op" id="8335067">:=</span>&nbsp;<span class="ident" id="8335070">c</span><span class="op" id="8335071">.</span><span class="ident" id="8335072">Read</span><span class="op" id="8335076">(</span><span class="ident" id="8335077">buf</span><span class="op" id="8335080">[</span><span class="op" id="8335081">:</span><span class="op" id="8335082">]</span><span class="op" id="8335083">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8335089">if</span>&nbsp;<span class="ident" id="8335092">err</span>&nbsp;<span class="op" id="8335096">!=</span>&nbsp;<span class="ident" id="8335099">nil</span>&nbsp;<span class="op" id="8335103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8335110">b</span><span class="op" id="8335111">.</span><span class="ident" id="8335112">Errorf</span><span class="op" id="8335118">(</span><span class="string" id="8335119">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8335136">,</span>&nbsp;<span class="ident" id="8335138">err</span><span class="op" id="8335141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8335148">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8335159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8335164">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8335169">c</span><span class="op" id="8335170">.</span><span class="ident" id="8335171">Close</span><span class="op" id="8335176">(</span><span class="op" id="8335177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8335181">}</span><span class="op" id="8335182">(</span><span class="ident" id="8335183">clients</span><span class="op" id="8335190">[</span><span class="ident" id="8335191">p</span><span class="op" id="8335192">]</span><span class="op" id="8335193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8335196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8335199">wg</span><span class="op" id="8335201">.</span><span class="ident" id="8335202">Wait</span><span class="op" id="8335206">(</span><span class="op" id="8335207">)</span><br>
<span class="lineno"></span><span class="op" id="8335209">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="8335212">type</span>&nbsp;<span class="ident" id="8335217">resolveTCPAddrTest</span>&nbsp;<span class="keyword" id="8335236">struct</span>&nbsp;<span class="op" id="8335243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8335246">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8335260">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8335268">litAddrOrName</span>&nbsp;<span class="builtintype" id="8335282">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8335290">addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8335304">*</span><span class="ident" id="8335305">TCPAddr</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8335314">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8335328">error</span><br>
<span class="lineno"></span><span class="op" id="8335334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8335337">var</span>&nbsp;<span class="ident" id="8335341">resolveTCPAddrTests</span>&nbsp;<span class="op" id="8335361">=</span>&nbsp;<span class="op" id="8335363">[</span><span class="op" id="8335364">]</span><span class="ident" id="8335365">resolveTCPAddrTest</span><span class="op" id="8335383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8335386">{</span><span class="string" id="8335387">&#34;tcp&#34;</span><span class="op" id="8335392">,</span>&nbsp;<span class="string" id="8335394">&#34;127.0.0.1:0&#34;</span><span class="op" id="8335407">,</span>&nbsp;<span class="op" id="8335409">&amp;</span><span class="ident" id="8335410">TCPAddr</span><span class="op" id="8335417">{</span><span class="ident" id="8335418">IP</span><span class="op" id="8335420">:</span>&nbsp;<span class="ident" id="8335422">IPv4</span><span class="op" id="8335426">(</span><span class="num" id="8335427">127</span><span class="op" id="8335430">,</span>&nbsp;<span class="num" id="8335432">0</span><span class="op" id="8335433">,</span>&nbsp;<span class="num" id="8335435">0</span><span class="op" id="8335436">,</span>&nbsp;<span class="num" id="8335438">1</span><span class="op" id="8335439">)</span><span class="op" id="8335440">,</span>&nbsp;<span class="ident" id="8335442">Port</span><span class="op" id="8335446">:</span>&nbsp;<span class="num" id="8335448">0</span><span class="op" id="8335449">}</span><span class="op" id="8335450">,</span>&nbsp;<span class="ident" id="8335452">nil</span><span class="op" id="8335455">}</span><span class="op" id="8335456">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8335459">{</span><span class="string" id="8335460">&#34;tcp4&#34;</span><span class="op" id="8335466">,</span>&nbsp;<span class="string" id="8335468">&#34;127.0.0.1:65535&#34;</span><span class="op" id="8335485">,</span>&nbsp;<span class="op" id="8335487">&amp;</span><span class="ident" id="8335488">TCPAddr</span><span class="op" id="8335495">{</span><span class="ident" id="8335496">IP</span><span class="op" id="8335498">:</span>&nbsp;<span class="ident" id="8335500">IPv4</span><span class="op" id="8335504">(</span><span class="num" id="8335505">127</span><span class="op" id="8335508">,</span>&nbsp;<span class="num" id="8335510">0</span><span class="op" id="8335511">,</span>&nbsp;<span class="num" id="8335513">0</span><span class="op" id="8335514">,</span>&nbsp;<span class="num" id="8335516">1</span><span class="op" id="8335517">)</span><span class="op" id="8335518">,</span>&nbsp;<span class="ident" id="8335520">Port</span><span class="op" id="8335524">:</span>&nbsp;<span class="num" id="8335526">65535</span><span class="op" id="8335531">}</span><span class="op" id="8335532">,</span>&nbsp;<span class="ident" id="8335534">nil</span><span class="op" id="8335537">}</span><span class="op" id="8335538">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8335542">{</span><span class="string" id="8335543">&#34;tcp&#34;</span><span class="op" id="8335548">,</span>&nbsp;<span class="string" id="8335550">&#34;[::1]:1&#34;</span><span class="op" id="8335559">,</span>&nbsp;<span class="op" id="8335561">&amp;</span><span class="ident" id="8335562">TCPAddr</span><span class="op" id="8335569">{</span><span class="ident" id="8335570">IP</span><span class="op" id="8335572">:</span>&nbsp;<span class="ident" id="8335574">ParseIP</span><span class="op" id="8335581">(</span><span class="string" id="8335582">&#34;::1&#34;</span><span class="op" id="8335587">)</span><span class="op" id="8335588">,</span>&nbsp;<span class="ident" id="8335590">Port</span><span class="op" id="8335594">:</span>&nbsp;<span class="num" id="8335596">1</span><span class="op" id="8335597">}</span><span class="op" id="8335598">,</span>&nbsp;<span class="ident" id="8335600">nil</span><span class="op" id="8335603">}</span><span class="op" id="8335604">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8335607">{</span><span class="string" id="8335608">&#34;tcp6&#34;</span><span class="op" id="8335614">,</span>&nbsp;<span class="string" id="8335616">&#34;[::1]:65534&#34;</span><span class="op" id="8335629">,</span>&nbsp;<span class="op" id="8335631">&amp;</span><span class="ident" id="8335632">TCPAddr</span><span class="op" id="8335639">{</span><span class="ident" id="8335640">IP</span><span class="op" id="8335642">:</span>&nbsp;<span class="ident" id="8335644">ParseIP</span><span class="op" id="8335651">(</span><span class="string" id="8335652">&#34;::1&#34;</span><span class="op" id="8335657">)</span><span class="op" id="8335658">,</span>&nbsp;<span class="ident" id="8335660">Port</span><span class="op" id="8335664">:</span>&nbsp;<span class="num" id="8335666">65534</span><span class="op" id="8335671">}</span><span class="op" id="8335672">,</span>&nbsp;<span class="ident" id="8335674">nil</span><span class="op" id="8335677">}</span><span class="op" id="8335678">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8335682">{</span><span class="string" id="8335683">&#34;tcp&#34;</span><span class="op" id="8335688">,</span>&nbsp;<span class="string" id="8335690">&#34;[::1%en0]:1&#34;</span><span class="op" id="8335703">,</span>&nbsp;<span class="op" id="8335705">&amp;</span><span class="ident" id="8335706">TCPAddr</span><span class="op" id="8335713">{</span><span class="ident" id="8335714">IP</span><span class="op" id="8335716">:</span>&nbsp;<span class="ident" id="8335718">ParseIP</span><span class="op" id="8335725">(</span><span class="string" id="8335726">&#34;::1&#34;</span><span class="op" id="8335731">)</span><span class="op" id="8335732">,</span>&nbsp;<span class="ident" id="8335734">Port</span><span class="op" id="8335738">:</span>&nbsp;<span class="num" id="8335740">1</span><span class="op" id="8335741">,</span>&nbsp;<span class="ident" id="8335743">Zone</span><span class="op" id="8335747">:</span>&nbsp;<span class="string" id="8335749">&#34;en0&#34;</span><span class="op" id="8335754">}</span><span class="op" id="8335755">,</span>&nbsp;<span class="ident" id="8335757">nil</span><span class="op" id="8335760">}</span><span class="op" id="8335761">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8335764">{</span><span class="string" id="8335765">&#34;tcp6&#34;</span><span class="op" id="8335771">,</span>&nbsp;<span class="string" id="8335773">&#34;[::1%911]:2&#34;</span><span class="op" id="8335786">,</span>&nbsp;<span class="op" id="8335788">&amp;</span><span class="ident" id="8335789">TCPAddr</span><span class="op" id="8335796">{</span><span class="ident" id="8335797">IP</span><span class="op" id="8335799">:</span>&nbsp;<span class="ident" id="8335801">ParseIP</span><span class="op" id="8335808">(</span><span class="string" id="8335809">&#34;::1&#34;</span><span class="op" id="8335814">)</span><span class="op" id="8335815">,</span>&nbsp;<span class="ident" id="8335817">Port</span><span class="op" id="8335821">:</span>&nbsp;<span class="num" id="8335823">2</span><span class="op" id="8335824">,</span>&nbsp;<span class="ident" id="8335826">Zone</span><span class="op" id="8335830">:</span>&nbsp;<span class="string" id="8335832">&#34;911&#34;</span><span class="op" id="8335837">}</span><span class="op" id="8335838">,</span>&nbsp;<span class="ident" id="8335840">nil</span><span class="op" id="8335843">}</span><span class="op" id="8335844">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8335848">{</span><span class="string" id="8335849">&#34;&#34;</span><span class="op" id="8335851">,</span>&nbsp;<span class="string" id="8335853">&#34;127.0.0.1:0&#34;</span><span class="op" id="8335866">,</span>&nbsp;<span class="op" id="8335868">&amp;</span><span class="ident" id="8335869">TCPAddr</span><span class="op" id="8335876">{</span><span class="ident" id="8335877">IP</span><span class="op" id="8335879">:</span>&nbsp;<span class="ident" id="8335881">IPv4</span><span class="op" id="8335885">(</span><span class="num" id="8335886">127</span><span class="op" id="8335889">,</span>&nbsp;<span class="num" id="8335891">0</span><span class="op" id="8335892">,</span>&nbsp;<span class="num" id="8335894">0</span><span class="op" id="8335895">,</span>&nbsp;<span class="num" id="8335897">1</span><span class="op" id="8335898">)</span><span class="op" id="8335899">,</span>&nbsp;<span class="ident" id="8335901">Port</span><span class="op" id="8335905">:</span>&nbsp;<span class="num" id="8335907">0</span><span class="op" id="8335908">}</span><span class="op" id="8335909">,</span>&nbsp;<span class="ident" id="8335911">nil</span><span class="op" id="8335914">}</span><span class="op" id="8335915">,</span>&nbsp;<span class="comment" id="8335917">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8335937">{</span><span class="string" id="8335938">&#34;&#34;</span><span class="op" id="8335940">,</span>&nbsp;<span class="string" id="8335942">&#34;[::1]:0&#34;</span><span class="op" id="8335951">,</span>&nbsp;<span class="op" id="8335953">&amp;</span><span class="ident" id="8335954">TCPAddr</span><span class="op" id="8335961">{</span><span class="ident" id="8335962">IP</span><span class="op" id="8335964">:</span>&nbsp;<span class="ident" id="8335966">ParseIP</span><span class="op" id="8335973">(</span><span class="string" id="8335974">&#34;::1&#34;</span><span class="op" id="8335979">)</span><span class="op" id="8335980">,</span>&nbsp;<span class="ident" id="8335982">Port</span><span class="op" id="8335986">:</span>&nbsp;<span class="num" id="8335988">0</span><span class="op" id="8335989">}</span><span class="op" id="8335990">,</span>&nbsp;<span class="ident" id="8335992">nil</span><span class="op" id="8335995">}</span><span class="op" id="8335996">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8336006">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8336027">{</span><span class="string" id="8336028">&#34;tcp&#34;</span><span class="op" id="8336033">,</span>&nbsp;<span class="string" id="8336035">&#34;:12345&#34;</span><span class="op" id="8336043">,</span>&nbsp;<span class="op" id="8336045">&amp;</span><span class="ident" id="8336046">TCPAddr</span><span class="op" id="8336053">{</span><span class="ident" id="8336054">Port</span><span class="op" id="8336058">:</span>&nbsp;<span class="num" id="8336060">12345</span><span class="op" id="8336065">}</span><span class="op" id="8336066">,</span>&nbsp;<span class="ident" id="8336068">nil</span><span class="op" id="8336071">}</span><span class="op" id="8336072">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8336076">{</span><span class="string" id="8336077">&#34;http&#34;</span><span class="op" id="8336083">,</span>&nbsp;<span class="string" id="8336085">&#34;127.0.0.1:0&#34;</span><span class="op" id="8336098">,</span>&nbsp;<span class="ident" id="8336100">nil</span><span class="op" id="8336103">,</span>&nbsp;<span class="ident" id="8336105">UnknownNetworkError</span><span class="op" id="8336124">(</span><span class="string" id="8336125">&#34;http&#34;</span><span class="op" id="8336131">)</span><span class="op" id="8336132">}</span><span class="op" id="8336133">,</span><br>
<span class="lineno"></span><span class="op" id="8336135">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span><span class="keyword" id="8336138">func</span>&nbsp;<span class="ident" id="8336143">init</span><span class="op" id="8336147">(</span><span class="op" id="8336148">)</span>&nbsp;<span class="op" id="8336150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8336153">if</span>&nbsp;<span class="ident" id="8336156">ifi</span>&nbsp;<span class="op" id="8336160">:=</span>&nbsp;<span class="ident" id="8336163">loopbackInterface</span><span class="op" id="8336180">(</span><span class="op" id="8336181">)</span><span class="op" id="8336182">;</span>&nbsp;<span class="ident" id="8336184">ifi</span>&nbsp;<span class="op" id="8336188">!=</span>&nbsp;<span class="ident" id="8336191">nil</span>&nbsp;<span class="op" id="8336195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8336199">index</span>&nbsp;<span class="op" id="8336205">:=</span>&nbsp;<span class="ident" id="8336208">fmt</span><span class="op" id="8336211">.</span><span class="ident" id="8336212">Sprintf</span><span class="op" id="8336219">(</span><span class="string" id="8336220">&#34;%v&#34;</span><span class="op" id="8336224">,</span>&nbsp;<span class="ident" id="8336226">ifi</span><span class="op" id="8336229">.</span><span class="ident" id="8336230">Index</span><span class="op" id="8336235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8336239">resolveTCPAddrTests</span>&nbsp;<span class="op" id="8336259">=</span>&nbsp;<span class="builtinfunc" id="8336261">append</span><span class="op" id="8336267">(</span><span class="ident" id="8336268">resolveTCPAddrTests</span><span class="op" id="8336287">,</span>&nbsp;<span class="op" id="8336289">[</span><span class="op" id="8336290">]</span><span class="ident" id="8336291">resolveTCPAddrTest</span><span class="op" id="8336309">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8336314">{</span><span class="string" id="8336315">&#34;tcp6&#34;</span><span class="op" id="8336321">,</span>&nbsp;<span class="string" id="8336323">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="8336335">+</span>&nbsp;<span class="ident" id="8336337">ifi</span><span class="op" id="8336340">.</span><span class="ident" id="8336341">Name</span>&nbsp;<span class="op" id="8336346">+</span>&nbsp;<span class="string" id="8336348">&#34;]:3&#34;</span><span class="op" id="8336353">,</span>&nbsp;<span class="op" id="8336355">&amp;</span><span class="ident" id="8336356">TCPAddr</span><span class="op" id="8336363">{</span><span class="ident" id="8336364">IP</span><span class="op" id="8336366">:</span>&nbsp;<span class="ident" id="8336368">ParseIP</span><span class="op" id="8336375">(</span><span class="string" id="8336376">&#34;fe80::1&#34;</span><span class="op" id="8336385">)</span><span class="op" id="8336386">,</span>&nbsp;<span class="ident" id="8336388">Port</span><span class="op" id="8336392">:</span>&nbsp;<span class="num" id="8336394">3</span><span class="op" id="8336395">,</span>&nbsp;<span class="ident" id="8336397">Zone</span><span class="op" id="8336401">:</span>&nbsp;<span class="ident" id="8336403">zoneToString</span><span class="op" id="8336415">(</span><span class="ident" id="8336416">ifi</span><span class="op" id="8336419">.</span><span class="ident" id="8336420">Index</span><span class="op" id="8336425">)</span><span class="op" id="8336426">}</span><span class="op" id="8336427">,</span>&nbsp;<span class="ident" id="8336429">nil</span><span class="op" id="8336432">}</span><span class="op" id="8336433">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8336438">{</span><span class="string" id="8336439">&#34;tcp6&#34;</span><span class="op" id="8336445">,</span>&nbsp;<span class="string" id="8336447">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="8336459">+</span>&nbsp;<span class="ident" id="8336461">index</span>&nbsp;<span class="op" id="8336467">+</span>&nbsp;<span class="string" id="8336469">&#34;]:4&#34;</span><span class="op" id="8336474">,</span>&nbsp;<span class="op" id="8336476">&amp;</span><span class="ident" id="8336477">TCPAddr</span><span class="op" id="8336484">{</span><span class="ident" id="8336485">IP</span><span class="op" id="8336487">:</span>&nbsp;<span class="ident" id="8336489">ParseIP</span><span class="op" id="8336496">(</span><span class="string" id="8336497">&#34;fe80::1&#34;</span><span class="op" id="8336506">)</span><span class="op" id="8336507">,</span>&nbsp;<span class="ident" id="8336509">Port</span><span class="op" id="8336513">:</span>&nbsp;<span class="num" id="8336515">4</span><span class="op" id="8336516">,</span>&nbsp;<span class="ident" id="8336518">Zone</span><span class="op" id="8336522">:</span>&nbsp;<span class="ident" id="8336524">index</span><span class="op" id="8336529">}</span><span class="op" id="8336530">,</span>&nbsp;<span class="ident" id="8336532">nil</span><span class="op" id="8336535">}</span><span class="op" id="8336536">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8336540">}</span><span class="op" id="8336541">...</span><span class="op" id="8336544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8336547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8336550">if</span>&nbsp;<span class="ident" id="8336553">ips</span><span class="op" id="8336556">,</span>&nbsp;<span class="ident" id="8336558">err</span>&nbsp;<span class="op" id="8336562">:=</span>&nbsp;<span class="ident" id="8336565">LookupIP</span><span class="op" id="8336573">(</span><span class="string" id="8336574">&#34;localhost&#34;</span><span class="op" id="8336585">)</span><span class="op" id="8336586">;</span>&nbsp;<span class="ident" id="8336588">err</span>&nbsp;<span class="op" id="8336592">==</span>&nbsp;<span class="ident" id="8336595">nil</span>&nbsp;<span class="op" id="8336599">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="8336602">len</span><span class="op" id="8336605">(</span><span class="ident" id="8336606">ips</span><span class="op" id="8336609">)</span>&nbsp;<span class="op" id="8336611">&gt;</span>&nbsp;<span class="num" id="8336613">1</span>&nbsp;<span class="op" id="8336615">&amp;&amp;</span>&nbsp;<span class="ident" id="8336618">supportsIPv4</span>&nbsp;<span class="op" id="8336631">&amp;&amp;</span>&nbsp;<span class="ident" id="8336634">supportsIPv6</span>&nbsp;<span class="op" id="8336647">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8336651">resolveTCPAddrTests</span>&nbsp;<span class="op" id="8336671">=</span>&nbsp;<span class="builtinfunc" id="8336673">append</span><span class="op" id="8336679">(</span><span class="ident" id="8336680">resolveTCPAddrTests</span><span class="op" id="8336699">,</span>&nbsp;<span class="op" id="8336701">[</span><span class="op" id="8336702">]</span><span class="ident" id="8336703">resolveTCPAddrTest</span><span class="op" id="8336721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8336726">{</span><span class="string" id="8336727">&#34;tcp&#34;</span><span class="op" id="8336732">,</span>&nbsp;<span class="string" id="8336734">&#34;localhost:5&#34;</span><span class="op" id="8336747">,</span>&nbsp;<span class="op" id="8336749">&amp;</span><span class="ident" id="8336750">TCPAddr</span><span class="op" id="8336757">{</span><span class="ident" id="8336758">IP</span><span class="op" id="8336760">:</span>&nbsp;<span class="ident" id="8336762">IPv4</span><span class="op" id="8336766">(</span><span class="num" id="8336767">127</span><span class="op" id="8336770">,</span>&nbsp;<span class="num" id="8336772">0</span><span class="op" id="8336773">,</span>&nbsp;<span class="num" id="8336775">0</span><span class="op" id="8336776">,</span>&nbsp;<span class="num" id="8336778">1</span><span class="op" id="8336779">)</span><span class="op" id="8336780">,</span>&nbsp;<span class="ident" id="8336782">Port</span><span class="op" id="8336786">:</span>&nbsp;<span class="num" id="8336788">5</span><span class="op" id="8336789">}</span><span class="op" id="8336790">,</span>&nbsp;<span class="ident" id="8336792">nil</span><span class="op" id="8336795">}</span><span class="op" id="8336796">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8336801">{</span><span class="string" id="8336802">&#34;tcp4&#34;</span><span class="op" id="8336808">,</span>&nbsp;<span class="string" id="8336810">&#34;localhost:6&#34;</span><span class="op" id="8336823">,</span>&nbsp;<span class="op" id="8336825">&amp;</span><span class="ident" id="8336826">TCPAddr</span><span class="op" id="8336833">{</span><span class="ident" id="8336834">IP</span><span class="op" id="8336836">:</span>&nbsp;<span class="ident" id="8336838">IPv4</span><span class="op" id="8336842">(</span><span class="num" id="8336843">127</span><span class="op" id="8336846">,</span>&nbsp;<span class="num" id="8336848">0</span><span class="op" id="8336849">,</span>&nbsp;<span class="num" id="8336851">0</span><span class="op" id="8336852">,</span>&nbsp;<span class="num" id="8336854">1</span><span class="op" id="8336855">)</span><span class="op" id="8336856">,</span>&nbsp;<span class="ident" id="8336858">Port</span><span class="op" id="8336862">:</span>&nbsp;<span class="num" id="8336864">6</span><span class="op" id="8336865">}</span><span class="op" id="8336866">,</span>&nbsp;<span class="ident" id="8336868">nil</span><span class="op" id="8336871">}</span><span class="op" id="8336872">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8336877">{</span><span class="string" id="8336878">&#34;tcp6&#34;</span><span class="op" id="8336884">,</span>&nbsp;<span class="string" id="8336886">&#34;localhost:7&#34;</span><span class="op" id="8336899">,</span>&nbsp;<span class="op" id="8336901">&amp;</span><span class="ident" id="8336902">TCPAddr</span><span class="op" id="8336909">{</span><span class="ident" id="8336910">IP</span><span class="op" id="8336912">:</span>&nbsp;<span class="ident" id="8336914">IPv6loopback</span><span class="op" id="8336926">,</span>&nbsp;<span class="ident" id="8336928">Port</span><span class="op" id="8336932">:</span>&nbsp;<span class="num" id="8336934">7</span><span class="op" id="8336935">}</span><span class="op" id="8336936">,</span>&nbsp;<span class="ident" id="8336938">nil</span><span class="op" id="8336941">}</span><span class="op" id="8336942">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8336946">}</span><span class="op" id="8336947">...</span><span class="op" id="8336950">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8336953">}</span><br>
<span class="lineno"></span><span class="op" id="8336955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8336958">func</span>&nbsp;<span class="ident" id="8336963">TestResolveTCPAddr</span><span class="op" id="8336981">(</span><span class="ident" id="8336982">t</span>&nbsp;<span class="op" id="8336984">*</span><span class="ident" id="8336985">testing</span><span class="op" id="8336992">.</span><span class="ident" id="8336993">T</span><span class="op" id="8336994">)</span>&nbsp;<span class="op" id="8336996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8336999">for</span>&nbsp;<span class="ident" id="8337003">_</span><span class="op" id="8337004">,</span>&nbsp;<span class="ident" id="8337006">tt</span>&nbsp;<span class="op" id="8337009">:=</span>&nbsp;<span class="keyword" id="8337012">range</span>&nbsp;<span class="ident" id="8337018">resolveTCPAddrTests</span>&nbsp;<span class="op" id="8337038">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8337042">addr</span><span class="op" id="8337046">,</span>&nbsp;<span class="ident" id="8337048">err</span>&nbsp;<span class="op" id="8337052">:=</span>&nbsp;<span class="ident" id="8337055">ResolveTCPAddr</span><span class="op" id="8337069">(</span><span class="ident" id="8337070">tt</span><span class="op" id="8337072">.</span><span class="ident" id="8337073">net</span><span class="op" id="8337076">,</span>&nbsp;<span class="ident" id="8337078">tt</span><span class="op" id="8337080">.</span><span class="ident" id="8337081">litAddrOrName</span><span class="op" id="8337094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8337098">if</span>&nbsp;<span class="ident" id="8337101">err</span>&nbsp;<span class="op" id="8337105">!=</span>&nbsp;<span class="ident" id="8337108">tt</span><span class="op" id="8337110">.</span><span class="ident" id="8337111">err</span>&nbsp;<span class="op" id="8337115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8337120">t</span><span class="op" id="8337121">.</span><span class="ident" id="8337122">Fatalf</span><span class="op" id="8337128">(</span><span class="string" id="8337129">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8337164">,</span>&nbsp;<span class="ident" id="8337166">tt</span><span class="op" id="8337168">.</span><span class="ident" id="8337169">net</span><span class="op" id="8337172">,</span>&nbsp;<span class="ident" id="8337174">tt</span><span class="op" id="8337176">.</span><span class="ident" id="8337177">litAddrOrName</span><span class="op" id="8337190">,</span>&nbsp;<span class="ident" id="8337192">err</span><span class="op" id="8337195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8337199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8337203">if</span>&nbsp;<span class="op" id="8337206">!</span><span class="ident" id="8337207">reflect</span><span class="op" id="8337214">.</span><span class="ident" id="8337215">DeepEqual</span><span class="op" id="8337224">(</span><span class="ident" id="8337225">addr</span><span class="op" id="8337229">,</span>&nbsp;<span class="ident" id="8337231">tt</span><span class="op" id="8337233">.</span><span class="ident" id="8337234">addr</span><span class="op" id="8337238">)</span>&nbsp;<span class="op" id="8337240">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8337245">t</span><span class="op" id="8337246">.</span><span class="ident" id="8337247">Fatalf</span><span class="op" id="8337253">(</span><span class="string" id="8337254">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="8337294">,</span>&nbsp;<span class="ident" id="8337296">tt</span><span class="op" id="8337298">.</span><span class="ident" id="8337299">net</span><span class="op" id="8337302">,</span>&nbsp;<span class="ident" id="8337304">tt</span><span class="op" id="8337306">.</span><span class="ident" id="8337307">litAddrOrName</span><span class="op" id="8337320">,</span>&nbsp;<span class="ident" id="8337322">addr</span><span class="op" id="8337326">,</span>&nbsp;<span class="ident" id="8337328">tt</span><span class="op" id="8337330">.</span><span class="ident" id="8337331">addr</span><span class="op" id="8337335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8337339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8337343">if</span>&nbsp;<span class="ident" id="8337346">err</span>&nbsp;<span class="op" id="8337350">==</span>&nbsp;<span class="ident" id="8337353">nil</span>&nbsp;<span class="op" id="8337357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8337362">str</span>&nbsp;<span class="op" id="8337366">:=</span>&nbsp;<span class="ident" id="8337369">addr</span><span class="op" id="8337373">.</span><span class="ident" id="8337374">String</span><span class="op" id="8337380">(</span><span class="op" id="8337381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8337386">addr1</span><span class="op" id="8337391">,</span>&nbsp;<span class="ident" id="8337393">err</span>&nbsp;<span class="op" id="8337397">:=</span>&nbsp;<span class="ident" id="8337400">ResolveTCPAddr</span><span class="op" id="8337414">(</span><span class="ident" id="8337415">tt</span><span class="op" id="8337417">.</span><span class="ident" id="8337418">net</span><span class="op" id="8337421">,</span>&nbsp;<span class="ident" id="8337423">str</span><span class="op" id="8337426">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8337431">if</span>&nbsp;<span class="ident" id="8337434">err</span>&nbsp;<span class="op" id="8337438">!=</span>&nbsp;<span class="ident" id="8337441">nil</span>&nbsp;<span class="op" id="8337445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8337451">t</span><span class="op" id="8337452">.</span><span class="ident" id="8337453">Fatalf</span><span class="op" id="8337459">(</span><span class="string" id="8337460">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]:&nbsp;%v&#34;</span><span class="op" id="8337498">,</span>&nbsp;<span class="ident" id="8337500">tt</span><span class="op" id="8337502">.</span><span class="ident" id="8337503">net</span><span class="op" id="8337506">,</span>&nbsp;<span class="ident" id="8337508">str</span><span class="op" id="8337511">,</span>&nbsp;<span class="ident" id="8337513">tt</span><span class="op" id="8337515">.</span><span class="ident" id="8337516">litAddrOrName</span><span class="op" id="8337529">,</span>&nbsp;<span class="ident" id="8337531">err</span><span class="op" id="8337534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8337539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8337544">if</span>&nbsp;<span class="op" id="8337547">!</span><span class="ident" id="8337548">reflect</span><span class="op" id="8337555">.</span><span class="ident" id="8337556">DeepEqual</span><span class="op" id="8337565">(</span><span class="ident" id="8337566">addr1</span><span class="op" id="8337571">,</span>&nbsp;<span class="ident" id="8337573">addr</span><span class="op" id="8337577">)</span>&nbsp;<span class="op" id="8337579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8337585">t</span><span class="op" id="8337586">.</span><span class="ident" id="8337587">Fatalf</span><span class="op" id="8337593">(</span><span class="string" id="8337594">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="8337644">,</span>&nbsp;<span class="ident" id="8337646">tt</span><span class="op" id="8337648">.</span><span class="ident" id="8337649">net</span><span class="op" id="8337652">,</span>&nbsp;<span class="ident" id="8337654">str</span><span class="op" id="8337657">,</span>&nbsp;<span class="ident" id="8337659">tt</span><span class="op" id="8337661">.</span><span class="ident" id="8337662">litAddrOrName</span><span class="op" id="8337675">,</span>&nbsp;<span class="ident" id="8337677">addr1</span><span class="op" id="8337682">,</span>&nbsp;<span class="ident" id="8337684">addr</span><span class="op" id="8337688">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8337693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8337697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8337700">}</span><br>
<span class="lineno"></span><span class="op" id="8337702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="8337705">var</span>&nbsp;<span class="ident" id="8337709">tcpListenerNameTests</span>&nbsp;<span class="op" id="8337730">=</span>&nbsp;<span class="op" id="8337732">[</span><span class="op" id="8337733">]</span><span class="keyword" id="8337734">struct</span>&nbsp;<span class="op" id="8337741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8337744">net</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8337750">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8337758">laddr</span>&nbsp;<span class="op" id="8337764">*</span><span class="ident" id="8337765">TCPAddr</span><br>
<span class="lineno"></span><span class="op" id="8337773">}</span><span class="op" id="8337774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8337777">{</span><span class="string" id="8337778">&#34;tcp4&#34;</span><span class="op" id="8337784">,</span>&nbsp;<span class="op" id="8337786">&amp;</span><span class="ident" id="8337787">TCPAddr</span><span class="op" id="8337794">{</span><span class="ident" id="8337795">IP</span><span class="op" id="8337797">:</span>&nbsp;<span class="ident" id="8337799">IPv4</span><span class="op" id="8337803">(</span><span class="num" id="8337804">127</span><span class="op" id="8337807">,</span>&nbsp;<span class="num" id="8337809">0</span><span class="op" id="8337810">,</span>&nbsp;<span class="num" id="8337812">0</span><span class="op" id="8337813">,</span>&nbsp;<span class="num" id="8337815">1</span><span class="op" id="8337816">)</span><span class="op" id="8337817">}</span><span class="op" id="8337818">}</span><span class="op" id="8337819">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8337822">{</span><span class="string" id="8337823">&#34;tcp4&#34;</span><span class="op" id="8337829">,</span>&nbsp;<span class="op" id="8337831">&amp;</span><span class="ident" id="8337832">TCPAddr</span><span class="op" id="8337839">{</span><span class="op" id="8337840">}</span><span class="op" id="8337841">}</span><span class="op" id="8337842">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8337845">{</span><span class="string" id="8337846">&#34;tcp4&#34;</span><span class="op" id="8337852">,</span>&nbsp;<span class="ident" id="8337854">nil</span><span class="op" id="8337857">}</span><span class="op" id="8337858">,</span><br>
<span class="lineno"></span><span class="op" id="8337860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8337863">func</span>&nbsp;<span class="ident" id="8337868">TestTCPListenerName</span><span class="op" id="8337887">(</span><span class="ident" id="8337888">t</span>&nbsp;<span class="op" id="8337890">*</span><span class="ident" id="8337891">testing</span><span class="op" id="8337898">.</span><span class="ident" id="8337899">T</span><span class="op" id="8337900">)</span>&nbsp;<span class="op" id="8337902">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8337905">if</span>&nbsp;<span class="ident" id="8337908">testing</span><span class="op" id="8337915">.</span><span class="ident" id="8337916">Short</span><span class="op" id="8337921">(</span><span class="op" id="8337922">)</span>&nbsp;<span class="op" id="8337924">||</span>&nbsp;<span class="op" id="8337927">!</span><span class="op" id="8337928">*</span><span class="ident" id="8337929">testExternal</span>&nbsp;<span class="op" id="8337942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8337946">t</span><span class="op" id="8337947">.</span><span class="ident" id="8337948">Skip</span><span class="op" id="8337952">(</span><span class="string" id="8337953">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8337994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8337997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8338001">for</span>&nbsp;<span class="ident" id="8338005">_</span><span class="op" id="8338006">,</span>&nbsp;<span class="ident" id="8338008">tt</span>&nbsp;<span class="op" id="8338011">:=</span>&nbsp;<span class="keyword" id="8338014">range</span>&nbsp;<span class="ident" id="8338020">tcpListenerNameTests</span>&nbsp;<span class="op" id="8338041">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8338045">ln</span><span class="op" id="8338047">,</span>&nbsp;<span class="ident" id="8338049">err</span>&nbsp;<span class="op" id="8338053">:=</span>&nbsp;<span class="ident" id="8338056">ListenTCP</span><span class="op" id="8338065">(</span><span class="ident" id="8338066">tt</span><span class="op" id="8338068">.</span><span class="ident" id="8338069">net</span><span class="op" id="8338072">,</span>&nbsp;<span class="ident" id="8338074">tt</span><span class="op" id="8338076">.</span><span class="ident" id="8338077">laddr</span><span class="op" id="8338082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8338086">if</span>&nbsp;<span class="ident" id="8338089">err</span>&nbsp;<span class="op" id="8338093">!=</span>&nbsp;<span class="ident" id="8338096">nil</span>&nbsp;<span class="op" id="8338100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8338105">t</span><span class="op" id="8338106">.</span><span class="ident" id="8338107">Fatalf</span><span class="op" id="8338113">(</span><span class="string" id="8338114">&#34;ListenTCP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8338136">,</span>&nbsp;<span class="ident" id="8338138">err</span><span class="op" id="8338141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8338145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8338149">defer</span>&nbsp;<span class="ident" id="8338155">ln</span><span class="op" id="8338157">.</span><span class="ident" id="8338158">Close</span><span class="op" id="8338163">(</span><span class="op" id="8338164">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8338168">la</span>&nbsp;<span class="op" id="8338171">:=</span>&nbsp;<span class="ident" id="8338174">ln</span><span class="op" id="8338176">.</span><span class="ident" id="8338177">Addr</span><span class="op" id="8338181">(</span><span class="op" id="8338182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8338186">if</span>&nbsp;<span class="ident" id="8338189">a</span><span class="op" id="8338190">,</span>&nbsp;<span class="ident" id="8338192">ok</span>&nbsp;<span class="op" id="8338195">:=</span>&nbsp;<span class="ident" id="8338198">la</span><span class="op" id="8338200">.</span><span class="op" id="8338201">(</span><span class="op" id="8338202">*</span><span class="ident" id="8338203">TCPAddr</span><span class="op" id="8338210">)</span><span class="op" id="8338211">;</span>&nbsp;<span class="op" id="8338213">!</span><span class="ident" id="8338214">ok</span>&nbsp;<span class="op" id="8338217">||</span>&nbsp;<span class="ident" id="8338220">a</span><span class="op" id="8338221">.</span><span class="ident" id="8338222">Port</span>&nbsp;<span class="op" id="8338227">==</span>&nbsp;<span class="num" id="8338230">0</span>&nbsp;<span class="op" id="8338232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8338237">t</span><span class="op" id="8338238">.</span><span class="ident" id="8338239">Fatalf</span><span class="op" id="8338245">(</span><span class="string" id="8338246">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;non-zero&nbsp;port&nbsp;number&#34;</span><span class="op" id="8338307">,</span>&nbsp;<span class="ident" id="8338309">la</span><span class="op" id="8338311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8338315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8338318">}</span><br>
<span class="lineno">375</span><span class="op" id="8338320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8338323">func</span>&nbsp;<span class="ident" id="8338328">TestIPv6LinkLocalUnicastTCP</span><span class="op" id="8338355">(</span><span class="ident" id="8338356">t</span>&nbsp;<span class="op" id="8338358">*</span><span class="ident" id="8338359">testing</span><span class="op" id="8338366">.</span><span class="ident" id="8338367">T</span><span class="op" id="8338368">)</span>&nbsp;<span class="op" id="8338370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8338373">if</span>&nbsp;<span class="ident" id="8338376">testing</span><span class="op" id="8338383">.</span><span class="ident" id="8338384">Short</span><span class="op" id="8338389">(</span><span class="op" id="8338390">)</span>&nbsp;<span class="op" id="8338392">||</span>&nbsp;<span class="op" id="8338395">!</span><span class="op" id="8338396">*</span><span class="ident" id="8338397">testExternal</span>&nbsp;<span class="op" id="8338410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8338414">t</span><span class="op" id="8338415">.</span><span class="ident" id="8338416">Skip</span><span class="op" id="8338420">(</span><span class="string" id="8338421">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8338462">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8338465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8338468">if</span>&nbsp;<span class="op" id="8338471">!</span><span class="ident" id="8338472">supportsIPv6</span>&nbsp;<span class="op" id="8338485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8338489">t</span><span class="op" id="8338490">.</span><span class="ident" id="8338491">Skip</span><span class="op" id="8338495">(</span><span class="string" id="8338496">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8338519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8338522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8338525">ifi</span>&nbsp;<span class="op" id="8338529">:=</span>&nbsp;<span class="ident" id="8338532">loopbackInterface</span><span class="op" id="8338549">(</span><span class="op" id="8338550">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8338553">if</span>&nbsp;<span class="ident" id="8338556">ifi</span>&nbsp;<span class="op" id="8338560">==</span>&nbsp;<span class="ident" id="8338563">nil</span>&nbsp;<span class="op" id="8338567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8338571">t</span><span class="op" id="8338572">.</span><span class="ident" id="8338573">Skip</span><span class="op" id="8338577">(</span><span class="string" id="8338578">&#34;loopback&nbsp;interface&nbsp;not&nbsp;found&#34;</span><span class="op" id="8338608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8338611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8338614">laddr</span>&nbsp;<span class="op" id="8338620">:=</span>&nbsp;<span class="ident" id="8338623">ipv6LinkLocalUnicastAddr</span><span class="op" id="8338647">(</span><span class="ident" id="8338648">ifi</span><span class="op" id="8338651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8338654">if</span>&nbsp;<span class="ident" id="8338657">laddr</span>&nbsp;<span class="op" id="8338663">==</span>&nbsp;<span class="string" id="8338666">&#34;&#34;</span>&nbsp;<span class="op" id="8338669">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8338673">t</span><span class="op" id="8338674">.</span><span class="ident" id="8338675">Skip</span><span class="op" id="8338679">(</span><span class="string" id="8338680">&#34;ipv6&nbsp;unicast&nbsp;address&nbsp;on&nbsp;loopback&nbsp;not&nbsp;found&#34;</span><span class="op" id="8338724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8338727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8338731">type</span>&nbsp;<span class="ident" id="8338736">test</span>&nbsp;<span class="keyword" id="8338741">struct</span>&nbsp;<span class="op" id="8338748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8338752">net</span><span class="op" id="8338755">,</span>&nbsp;<span class="ident" id="8338757">addr</span>&nbsp;&nbsp;<span class="builtintype" id="8338763">string</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8338772">nameLookup</span>&nbsp;<span class="builtintype" id="8338783">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8338789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8338792">var</span>&nbsp;<span class="ident" id="8338796">tests</span>&nbsp;<span class="op" id="8338802">=</span>&nbsp;<span class="op" id="8338804">[</span><span class="op" id="8338805">]</span><span class="ident" id="8338806">test</span><span class="op" id="8338810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8338814">{</span><span class="string" id="8338815">&#34;tcp&#34;</span><span class="op" id="8338820">,</span>&nbsp;<span class="string" id="8338822">&#34;[&#34;</span>&nbsp;<span class="op" id="8338826">+</span>&nbsp;<span class="ident" id="8338828">laddr</span>&nbsp;<span class="op" id="8338834">+</span>&nbsp;<span class="string" id="8338836">&#34;%&#34;</span>&nbsp;<span class="op" id="8338840">+</span>&nbsp;<span class="ident" id="8338842">ifi</span><span class="op" id="8338845">.</span><span class="ident" id="8338846">Name</span>&nbsp;<span class="op" id="8338851">+</span>&nbsp;<span class="string" id="8338853">&#34;]:0&#34;</span><span class="op" id="8338858">,</span>&nbsp;<span class="builtintype" id="8338860">false</span><span class="op" id="8338865">}</span><span class="op" id="8338866">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8338870">{</span><span class="string" id="8338871">&#34;tcp6&#34;</span><span class="op" id="8338877">,</span>&nbsp;<span class="string" id="8338879">&#34;[&#34;</span>&nbsp;<span class="op" id="8338883">+</span>&nbsp;<span class="ident" id="8338885">laddr</span>&nbsp;<span class="op" id="8338891">+</span>&nbsp;<span class="string" id="8338893">&#34;%&#34;</span>&nbsp;<span class="op" id="8338897">+</span>&nbsp;<span class="ident" id="8338899">ifi</span><span class="op" id="8338902">.</span><span class="ident" id="8338903">Name</span>&nbsp;<span class="op" id="8338908">+</span>&nbsp;<span class="string" id="8338910">&#34;]:0&#34;</span><span class="op" id="8338915">,</span>&nbsp;<span class="builtintype" id="8338917">false</span><span class="op" id="8338922">}</span><span class="op" id="8338923">,</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8338926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8338929">switch</span>&nbsp;<span class="ident" id="8338936">runtime</span><span class="op" id="8338943">.</span><span class="ident" id="8338944">GOOS</span>&nbsp;<span class="op" id="8338949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8338952">case</span>&nbsp;<span class="string" id="8338957">&#34;darwin&#34;</span><span class="op" id="8338965">,</span>&nbsp;<span class="string" id="8338967">&#34;freebsd&#34;</span><span class="op" id="8338976">,</span>&nbsp;<span class="string" id="8338978">&#34;openbsd&#34;</span><span class="op" id="8338987">,</span>&nbsp;<span class="string" id="8338989">&#34;netbsd&#34;</span><span class="op" id="8338997">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8339001">tests</span>&nbsp;<span class="op" id="8339007">=</span>&nbsp;<span class="builtinfunc" id="8339009">append</span><span class="op" id="8339015">(</span><span class="ident" id="8339016">tests</span><span class="op" id="8339021">,</span>&nbsp;<span class="op" id="8339023">[</span><span class="op" id="8339024">]</span><span class="ident" id="8339025">test</span><span class="op" id="8339029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8339034">{</span><span class="string" id="8339035">&#34;tcp&#34;</span><span class="op" id="8339040">,</span>&nbsp;<span class="string" id="8339042">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="8339056">+</span>&nbsp;<span class="ident" id="8339058">ifi</span><span class="op" id="8339061">.</span><span class="ident" id="8339062">Name</span>&nbsp;<span class="op" id="8339067">+</span>&nbsp;<span class="string" id="8339069">&#34;]:0&#34;</span><span class="op" id="8339074">,</span>&nbsp;<span class="builtintype" id="8339076">true</span><span class="op" id="8339080">}</span><span class="op" id="8339081">,</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8339086">{</span><span class="string" id="8339087">&#34;tcp6&#34;</span><span class="op" id="8339093">,</span>&nbsp;<span class="string" id="8339095">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="8339109">+</span>&nbsp;<span class="ident" id="8339111">ifi</span><span class="op" id="8339114">.</span><span class="ident" id="8339115">Name</span>&nbsp;<span class="op" id="8339120">+</span>&nbsp;<span class="string" id="8339122">&#34;]:0&#34;</span><span class="op" id="8339127">,</span>&nbsp;<span class="builtintype" id="8339129">true</span><span class="op" id="8339133">}</span><span class="op" id="8339134">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8339138">}</span><span class="op" id="8339139">...</span><span class="op" id="8339142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8339145">case</span>&nbsp;<span class="string" id="8339150">&#34;linux&#34;</span><span class="op" id="8339157">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8339161">tests</span>&nbsp;<span class="op" id="8339167">=</span>&nbsp;<span class="builtinfunc" id="8339169">append</span><span class="op" id="8339175">(</span><span class="ident" id="8339176">tests</span><span class="op" id="8339181">,</span>&nbsp;<span class="op" id="8339183">[</span><span class="op" id="8339184">]</span><span class="ident" id="8339185">test</span><span class="op" id="8339189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8339194">{</span><span class="string" id="8339195">&#34;tcp&#34;</span><span class="op" id="8339200">,</span>&nbsp;<span class="string" id="8339202">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="8339220">+</span>&nbsp;<span class="ident" id="8339222">ifi</span><span class="op" id="8339225">.</span><span class="ident" id="8339226">Name</span>&nbsp;<span class="op" id="8339231">+</span>&nbsp;<span class="string" id="8339233">&#34;]:0&#34;</span><span class="op" id="8339238">,</span>&nbsp;<span class="builtintype" id="8339240">true</span><span class="op" id="8339244">}</span><span class="op" id="8339245">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8339250">{</span><span class="string" id="8339251">&#34;tcp6&#34;</span><span class="op" id="8339257">,</span>&nbsp;<span class="string" id="8339259">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="8339277">+</span>&nbsp;<span class="ident" id="8339279">ifi</span><span class="op" id="8339282">.</span><span class="ident" id="8339283">Name</span>&nbsp;<span class="op" id="8339288">+</span>&nbsp;<span class="string" id="8339290">&#34;]:0&#34;</span><span class="op" id="8339295">,</span>&nbsp;<span class="builtintype" id="8339297">true</span><span class="op" id="8339301">}</span><span class="op" id="8339302">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8339306">}</span><span class="op" id="8339307">...</span><span class="op" id="8339310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8339313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8339316">for</span>&nbsp;<span class="ident" id="8339320">_</span><span class="op" id="8339321">,</span>&nbsp;<span class="ident" id="8339323">tt</span>&nbsp;<span class="op" id="8339326">:=</span>&nbsp;<span class="keyword" id="8339329">range</span>&nbsp;<span class="ident" id="8339335">tests</span>&nbsp;<span class="op" id="8339341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8339345">ln</span><span class="op" id="8339347">,</span>&nbsp;<span class="ident" id="8339349">err</span>&nbsp;<span class="op" id="8339353">:=</span>&nbsp;<span class="ident" id="8339356">Listen</span><span class="op" id="8339362">(</span><span class="ident" id="8339363">tt</span><span class="op" id="8339365">.</span><span class="ident" id="8339366">net</span><span class="op" id="8339369">,</span>&nbsp;<span class="ident" id="8339371">tt</span><span class="op" id="8339373">.</span><span class="ident" id="8339374">addr</span><span class="op" id="8339378">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8339382">if</span>&nbsp;<span class="ident" id="8339385">err</span>&nbsp;<span class="op" id="8339389">!=</span>&nbsp;<span class="ident" id="8339392">nil</span>&nbsp;<span class="op" id="8339396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8339401">//&nbsp;It&nbsp;might&nbsp;return&nbsp;&#34;LookupHost&nbsp;returned&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8339447">//&nbsp;suitable&nbsp;address&#34;&nbsp;error&nbsp;on&nbsp;some&nbsp;platforms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8339496">t</span><span class="op" id="8339497">.</span><span class="ident" id="8339498">Logf</span><span class="op" id="8339502">(</span><span class="string" id="8339503">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8339522">,</span>&nbsp;<span class="ident" id="8339524">err</span><span class="op" id="8339527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8339532">continue</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8339543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8339547">defer</span>&nbsp;<span class="ident" id="8339553">ln</span><span class="op" id="8339555">.</span><span class="ident" id="8339556">Close</span><span class="op" id="8339561">(</span><span class="op" id="8339562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8339566">if</span>&nbsp;<span class="ident" id="8339569">la</span><span class="op" id="8339571">,</span>&nbsp;<span class="ident" id="8339573">ok</span>&nbsp;<span class="op" id="8339576">:=</span>&nbsp;<span class="ident" id="8339579">ln</span><span class="op" id="8339581">.</span><span class="ident" id="8339582">Addr</span><span class="op" id="8339586">(</span><span class="op" id="8339587">)</span><span class="op" id="8339588">.</span><span class="op" id="8339589">(</span><span class="op" id="8339590">*</span><span class="ident" id="8339591">TCPAddr</span><span class="op" id="8339598">)</span><span class="op" id="8339599">;</span>&nbsp;<span class="op" id="8339601">!</span><span class="ident" id="8339602">ok</span>&nbsp;<span class="op" id="8339605">||</span>&nbsp;<span class="op" id="8339608">!</span><span class="ident" id="8339609">tt</span><span class="op" id="8339611">.</span><span class="ident" id="8339612">nameLookup</span>&nbsp;<span class="op" id="8339623">&amp;&amp;</span>&nbsp;<span class="ident" id="8339626">la</span><span class="op" id="8339628">.</span><span class="ident" id="8339629">Zone</span>&nbsp;<span class="op" id="8339634">==</span>&nbsp;<span class="string" id="8339637">&#34;&#34;</span>&nbsp;<span class="op" id="8339640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8339645">t</span><span class="op" id="8339646">.</span><span class="ident" id="8339647">Fatalf</span><span class="op" id="8339653">(</span><span class="string" id="8339654">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="8339710">,</span>&nbsp;<span class="ident" id="8339712">la</span><span class="op" id="8339714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8339718">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8339723">done</span>&nbsp;<span class="op" id="8339728">:=</span>&nbsp;<span class="builtinfunc" id="8339731">make</span><span class="op" id="8339735">(</span><span class="keyword" id="8339736">chan</span>&nbsp;<span class="builtintype" id="8339741">int</span><span class="op" id="8339744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8339748">go</span>&nbsp;<span class="ident" id="8339751">transponder</span><span class="op" id="8339762">(</span><span class="ident" id="8339763">t</span><span class="op" id="8339764">,</span>&nbsp;<span class="ident" id="8339766">ln</span><span class="op" id="8339768">,</span>&nbsp;<span class="ident" id="8339770">done</span><span class="op" id="8339774">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8339779">c</span><span class="op" id="8339780">,</span>&nbsp;<span class="ident" id="8339782">err</span>&nbsp;<span class="op" id="8339786">:=</span>&nbsp;<span class="ident" id="8339789">Dial</span><span class="op" id="8339793">(</span><span class="ident" id="8339794">tt</span><span class="op" id="8339796">.</span><span class="ident" id="8339797">net</span><span class="op" id="8339800">,</span>&nbsp;<span class="ident" id="8339802">ln</span><span class="op" id="8339804">.</span><span class="ident" id="8339805">Addr</span><span class="op" id="8339809">(</span><span class="op" id="8339810">)</span><span class="op" id="8339811">.</span><span class="ident" id="8339812">String</span><span class="op" id="8339818">(</span><span class="op" id="8339819">)</span><span class="op" id="8339820">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8339824">if</span>&nbsp;<span class="ident" id="8339827">err</span>&nbsp;<span class="op" id="8339831">!=</span>&nbsp;<span class="ident" id="8339834">nil</span>&nbsp;<span class="op" id="8339838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8339843">t</span><span class="op" id="8339844">.</span><span class="ident" id="8339845">Fatalf</span><span class="op" id="8339851">(</span><span class="string" id="8339852">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8339869">,</span>&nbsp;<span class="ident" id="8339871">err</span><span class="op" id="8339874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8339878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8339882">defer</span>&nbsp;<span class="ident" id="8339888">c</span><span class="op" id="8339889">.</span><span class="ident" id="8339890">Close</span><span class="op" id="8339895">(</span><span class="op" id="8339896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8339900">if</span>&nbsp;<span class="ident" id="8339903">la</span><span class="op" id="8339905">,</span>&nbsp;<span class="ident" id="8339907">ok</span>&nbsp;<span class="op" id="8339910">:=</span>&nbsp;<span class="ident" id="8339913">c</span><span class="op" id="8339914">.</span><span class="ident" id="8339915">LocalAddr</span><span class="op" id="8339924">(</span><span class="op" id="8339925">)</span><span class="op" id="8339926">.</span><span class="op" id="8339927">(</span><span class="op" id="8339928">*</span><span class="ident" id="8339929">TCPAddr</span><span class="op" id="8339936">)</span><span class="op" id="8339937">;</span>&nbsp;<span class="op" id="8339939">!</span><span class="ident" id="8339940">ok</span>&nbsp;<span class="op" id="8339943">||</span>&nbsp;<span class="op" id="8339946">!</span><span class="ident" id="8339947">tt</span><span class="op" id="8339949">.</span><span class="ident" id="8339950">nameLookup</span>&nbsp;<span class="op" id="8339961">&amp;&amp;</span>&nbsp;<span class="ident" id="8339964">la</span><span class="op" id="8339966">.</span><span class="ident" id="8339967">Zone</span>&nbsp;<span class="op" id="8339972">==</span>&nbsp;<span class="string" id="8339975">&#34;&#34;</span>&nbsp;<span class="op" id="8339978">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8339983">t</span><span class="op" id="8339984">.</span><span class="ident" id="8339985">Fatalf</span><span class="op" id="8339991">(</span><span class="string" id="8339992">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="8340048">,</span>&nbsp;<span class="ident" id="8340050">la</span><span class="op" id="8340052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8340056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8340060">if</span>&nbsp;<span class="ident" id="8340063">ra</span><span class="op" id="8340065">,</span>&nbsp;<span class="ident" id="8340067">ok</span>&nbsp;<span class="op" id="8340070">:=</span>&nbsp;<span class="ident" id="8340073">c</span><span class="op" id="8340074">.</span><span class="ident" id="8340075">RemoteAddr</span><span class="op" id="8340085">(</span><span class="op" id="8340086">)</span><span class="op" id="8340087">.</span><span class="op" id="8340088">(</span><span class="op" id="8340089">*</span><span class="ident" id="8340090">TCPAddr</span><span class="op" id="8340097">)</span><span class="op" id="8340098">;</span>&nbsp;<span class="op" id="8340100">!</span><span class="ident" id="8340101">ok</span>&nbsp;<span class="op" id="8340104">||</span>&nbsp;<span class="op" id="8340107">!</span><span class="ident" id="8340108">tt</span><span class="op" id="8340110">.</span><span class="ident" id="8340111">nameLookup</span>&nbsp;<span class="op" id="8340122">&amp;&amp;</span>&nbsp;<span class="ident" id="8340125">ra</span><span class="op" id="8340127">.</span><span class="ident" id="8340128">Zone</span>&nbsp;<span class="op" id="8340133">==</span>&nbsp;<span class="string" id="8340136">&#34;&#34;</span>&nbsp;<span class="op" id="8340139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8340144">t</span><span class="op" id="8340145">.</span><span class="ident" id="8340146">Fatalf</span><span class="op" id="8340152">(</span><span class="string" id="8340153">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="8340209">,</span>&nbsp;<span class="ident" id="8340211">ra</span><span class="op" id="8340213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8340217">}</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8340222">if</span>&nbsp;<span class="ident" id="8340225">_</span><span class="op" id="8340226">,</span>&nbsp;<span class="ident" id="8340228">err</span>&nbsp;<span class="op" id="8340232">:=</span>&nbsp;<span class="ident" id="8340235">c</span><span class="op" id="8340236">.</span><span class="ident" id="8340237">Write</span><span class="op" id="8340242">(</span><span class="op" id="8340243">[</span><span class="op" id="8340244">]</span><span class="builtintype" id="8340245">byte</span><span class="op" id="8340249">(</span><span class="string" id="8340250">&#34;TCP&nbsp;OVER&nbsp;IPV6&nbsp;LINKLOCAL&nbsp;TEST&#34;</span><span class="op" id="8340280">)</span><span class="op" id="8340281">)</span><span class="op" id="8340282">;</span>&nbsp;<span class="ident" id="8340284">err</span>&nbsp;<span class="op" id="8340288">!=</span>&nbsp;<span class="ident" id="8340291">nil</span>&nbsp;<span class="op" id="8340295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8340300">t</span><span class="op" id="8340301">.</span><span class="ident" id="8340302">Fatalf</span><span class="op" id="8340308">(</span><span class="string" id="8340309">&#34;Conn.Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8340332">,</span>&nbsp;<span class="ident" id="8340334">err</span><span class="op" id="8340337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8340341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8340345">b</span>&nbsp;<span class="op" id="8340347">:=</span>&nbsp;<span class="builtinfunc" id="8340350">make</span><span class="op" id="8340354">(</span><span class="op" id="8340355">[</span><span class="op" id="8340356">]</span><span class="builtintype" id="8340357">byte</span><span class="op" id="8340361">,</span>&nbsp;<span class="num" id="8340363">32</span><span class="op" id="8340365">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8340369">if</span>&nbsp;<span class="ident" id="8340372">_</span><span class="op" id="8340373">,</span>&nbsp;<span class="ident" id="8340375">err</span>&nbsp;<span class="op" id="8340379">:=</span>&nbsp;<span class="ident" id="8340382">c</span><span class="op" id="8340383">.</span><span class="ident" id="8340384">Read</span><span class="op" id="8340388">(</span><span class="ident" id="8340389">b</span><span class="op" id="8340390">)</span><span class="op" id="8340391">;</span>&nbsp;<span class="ident" id="8340393">err</span>&nbsp;<span class="op" id="8340397">!=</span>&nbsp;<span class="ident" id="8340400">nil</span>&nbsp;<span class="op" id="8340404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8340409">t</span><span class="op" id="8340410">.</span><span class="ident" id="8340411">Fatalf</span><span class="op" id="8340417">(</span><span class="string" id="8340418">&#34;Conn.Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8340440">,</span>&nbsp;<span class="ident" id="8340442">err</span><span class="op" id="8340445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8340449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8340454">&lt;-</span><span class="ident" id="8340456">done</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8340462">}</span><br>
<span class="lineno"></span><span class="op" id="8340464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8340467">func</span>&nbsp;<span class="ident" id="8340472">TestTCPConcurrentAccept</span><span class="op" id="8340495">(</span><span class="ident" id="8340496">t</span>&nbsp;<span class="op" id="8340498">*</span><span class="ident" id="8340499">testing</span><span class="op" id="8340506">.</span><span class="ident" id="8340507">T</span><span class="op" id="8340508">)</span>&nbsp;<span class="op" id="8340510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8340513">defer</span>&nbsp;<span class="ident" id="8340519">runtime</span><span class="op" id="8340526">.</span><span class="ident" id="8340527">GOMAXPROCS</span><span class="op" id="8340537">(</span><span class="ident" id="8340538">runtime</span><span class="op" id="8340545">.</span><span class="ident" id="8340546">GOMAXPROCS</span><span class="op" id="8340556">(</span><span class="num" id="8340557">4</span><span class="op" id="8340558">)</span><span class="op" id="8340559">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8340562">ln</span><span class="op" id="8340564">,</span>&nbsp;<span class="ident" id="8340566">err</span>&nbsp;<span class="op" id="8340570">:=</span>&nbsp;<span class="ident" id="8340573">Listen</span><span class="op" id="8340579">(</span><span class="string" id="8340580">&#34;tcp&#34;</span><span class="op" id="8340585">,</span>&nbsp;<span class="string" id="8340587">&#34;127.0.0.1:0&#34;</span><span class="op" id="8340600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8340603">if</span>&nbsp;<span class="ident" id="8340606">err</span>&nbsp;<span class="op" id="8340610">!=</span>&nbsp;<span class="ident" id="8340613">nil</span>&nbsp;<span class="op" id="8340617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8340621">t</span><span class="op" id="8340622">.</span><span class="ident" id="8340623">Fatalf</span><span class="op" id="8340629">(</span><span class="string" id="8340630">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8340649">,</span>&nbsp;<span class="ident" id="8340651">err</span><span class="op" id="8340654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8340657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8340660">const</span>&nbsp;<span class="ident" id="8340666">N</span>&nbsp;<span class="op" id="8340668">=</span>&nbsp;<span class="num" id="8340670">10</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8340674">var</span>&nbsp;<span class="ident" id="8340678">wg</span>&nbsp;<span class="ident" id="8340681">sync</span><span class="op" id="8340685">.</span><span class="ident" id="8340686">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8340697">wg</span><span class="op" id="8340699">.</span><span class="ident" id="8340700">Add</span><span class="op" id="8340703">(</span><span class="ident" id="8340704">N</span><span class="op" id="8340705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8340708">for</span>&nbsp;<span class="ident" id="8340712">i</span>&nbsp;<span class="op" id="8340714">:=</span>&nbsp;<span class="num" id="8340717">0</span><span class="op" id="8340718">;</span>&nbsp;<span class="ident" id="8340720">i</span>&nbsp;<span class="op" id="8340722">&lt;</span>&nbsp;<span class="ident" id="8340724">N</span><span class="op" id="8340725">;</span>&nbsp;<span class="ident" id="8340727">i</span><span class="op" id="8340728">++</span>&nbsp;<span class="op" id="8340731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8340735">go</span>&nbsp;<span class="keyword" id="8340738">func</span><span class="op" id="8340742">(</span><span class="op" id="8340743">)</span>&nbsp;<span class="op" id="8340745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8340750">for</span>&nbsp;<span class="op" id="8340754">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8340760">c</span><span class="op" id="8340761">,</span>&nbsp;<span class="ident" id="8340763">err</span>&nbsp;<span class="op" id="8340767">:=</span>&nbsp;<span class="ident" id="8340770">ln</span><span class="op" id="8340772">.</span><span class="ident" id="8340773">Accept</span><span class="op" id="8340779">(</span><span class="op" id="8340780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8340786">if</span>&nbsp;<span class="ident" id="8340789">err</span>&nbsp;<span class="op" id="8340793">!=</span>&nbsp;<span class="ident" id="8340796">nil</span>&nbsp;<span class="op" id="8340800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8340807">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8340817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8340823">c</span><span class="op" id="8340824">.</span><span class="ident" id="8340825">Close</span><span class="op" id="8340830">(</span><span class="op" id="8340831">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8340836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8340841">wg</span><span class="op" id="8340843">.</span><span class="ident" id="8340844">Done</span><span class="op" id="8340848">(</span><span class="op" id="8340849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8340853">}</span><span class="op" id="8340854">(</span><span class="op" id="8340855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8340858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8340861">attempts</span>&nbsp;<span class="op" id="8340870">:=</span>&nbsp;<span class="num" id="8340873">10</span>&nbsp;<span class="op" id="8340876">*</span>&nbsp;<span class="ident" id="8340878">N</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8340881">fails</span>&nbsp;<span class="op" id="8340887">:=</span>&nbsp;<span class="num" id="8340890">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8340893">d</span>&nbsp;<span class="op" id="8340895">:=</span>&nbsp;<span class="op" id="8340898">&amp;</span><span class="ident" id="8340899">Dialer</span><span class="op" id="8340905">{</span><span class="ident" id="8340906">Timeout</span><span class="op" id="8340913">:</span>&nbsp;<span class="num" id="8340915">200</span>&nbsp;<span class="op" id="8340919">*</span>&nbsp;<span class="ident" id="8340921">time</span><span class="op" id="8340925">.</span><span class="ident" id="8340926">Millisecond</span><span class="op" id="8340937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8340940">for</span>&nbsp;<span class="ident" id="8340944">i</span>&nbsp;<span class="op" id="8340946">:=</span>&nbsp;<span class="num" id="8340949">0</span><span class="op" id="8340950">;</span>&nbsp;<span class="ident" id="8340952">i</span>&nbsp;<span class="op" id="8340954">&lt;</span>&nbsp;<span class="ident" id="8340956">attempts</span><span class="op" id="8340964">;</span>&nbsp;<span class="ident" id="8340966">i</span><span class="op" id="8340967">++</span>&nbsp;<span class="op" id="8340970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8340974">c</span><span class="op" id="8340975">,</span>&nbsp;<span class="ident" id="8340977">err</span>&nbsp;<span class="op" id="8340981">:=</span>&nbsp;<span class="ident" id="8340984">d</span><span class="op" id="8340985">.</span><span class="ident" id="8340986">Dial</span><span class="op" id="8340990">(</span><span class="string" id="8340991">&#34;tcp&#34;</span><span class="op" id="8340996">,</span>&nbsp;<span class="ident" id="8340998">ln</span><span class="op" id="8341000">.</span><span class="ident" id="8341001">Addr</span><span class="op" id="8341005">(</span><span class="op" id="8341006">)</span><span class="op" id="8341007">.</span><span class="ident" id="8341008">String</span><span class="op" id="8341014">(</span><span class="op" id="8341015">)</span><span class="op" id="8341016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341020">if</span>&nbsp;<span class="ident" id="8341023">err</span>&nbsp;<span class="op" id="8341027">!=</span>&nbsp;<span class="ident" id="8341030">nil</span>&nbsp;<span class="op" id="8341034">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341039">fails</span><span class="op" id="8341044">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8341049">}</span>&nbsp;<span class="keyword" id="8341051">else</span>&nbsp;<span class="op" id="8341056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341061">c</span><span class="op" id="8341062">.</span><span class="ident" id="8341063">Close</span><span class="op" id="8341068">(</span><span class="op" id="8341069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8341073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8341076">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341079">ln</span><span class="op" id="8341081">.</span><span class="ident" id="8341082">Close</span><span class="op" id="8341087">(</span><span class="op" id="8341088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341091">wg</span><span class="op" id="8341093">.</span><span class="ident" id="8341094">Wait</span><span class="op" id="8341098">(</span><span class="op" id="8341099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341102">if</span>&nbsp;<span class="ident" id="8341105">fails</span>&nbsp;<span class="op" id="8341111">&gt;</span>&nbsp;<span class="ident" id="8341113">attempts</span><span class="op" id="8341121">/</span><span class="num" id="8341122">9</span>&nbsp;<span class="op" id="8341124">{</span>&nbsp;<span class="comment" id="8341126">//&nbsp;see&nbsp;issues&nbsp;7400&nbsp;and&nbsp;7541</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341156">t</span><span class="op" id="8341157">.</span><span class="ident" id="8341158">Fatalf</span><span class="op" id="8341164">(</span><span class="string" id="8341165">&#34;too&nbsp;many&nbsp;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8341191">,</span>&nbsp;<span class="ident" id="8341193">fails</span><span class="op" id="8341198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8341201">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341204">if</span>&nbsp;<span class="ident" id="8341207">fails</span>&nbsp;<span class="op" id="8341213">&gt;</span>&nbsp;<span class="num" id="8341215">0</span>&nbsp;<span class="op" id="8341217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341221">t</span><span class="op" id="8341222">.</span><span class="ident" id="8341223">Logf</span><span class="op" id="8341227">(</span><span class="string" id="8341228">&#34;#&nbsp;of&nbsp;failed&nbsp;Dials:&nbsp;%v&#34;</span><span class="op" id="8341251">,</span>&nbsp;<span class="ident" id="8341253">fails</span><span class="op" id="8341258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8341261">}</span><br>
<span class="lineno"></span><span class="op" id="8341263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="keyword" id="8341266">func</span>&nbsp;<span class="ident" id="8341271">TestTCPReadWriteMallocs</span><span class="op" id="8341294">(</span><span class="ident" id="8341295">t</span>&nbsp;<span class="op" id="8341297">*</span><span class="ident" id="8341298">testing</span><span class="op" id="8341305">.</span><span class="ident" id="8341306">T</span><span class="op" id="8341307">)</span>&nbsp;<span class="op" id="8341309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341312">if</span>&nbsp;<span class="ident" id="8341315">testing</span><span class="op" id="8341322">.</span><span class="ident" id="8341323">Short</span><span class="op" id="8341328">(</span><span class="op" id="8341329">)</span>&nbsp;<span class="op" id="8341331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341335">t</span><span class="op" id="8341336">.</span><span class="ident" id="8341337">Skip</span><span class="op" id="8341341">(</span><span class="string" id="8341342">&#34;skipping&nbsp;malloc&nbsp;count&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="8341379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8341382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341385">ln</span><span class="op" id="8341387">,</span>&nbsp;<span class="ident" id="8341389">err</span>&nbsp;<span class="op" id="8341393">:=</span>&nbsp;<span class="ident" id="8341396">Listen</span><span class="op" id="8341402">(</span><span class="string" id="8341403">&#34;tcp&#34;</span><span class="op" id="8341408">,</span>&nbsp;<span class="string" id="8341410">&#34;127.0.0.1:0&#34;</span><span class="op" id="8341423">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341426">if</span>&nbsp;<span class="ident" id="8341429">err</span>&nbsp;<span class="op" id="8341433">!=</span>&nbsp;<span class="ident" id="8341436">nil</span>&nbsp;<span class="op" id="8341440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341444">t</span><span class="op" id="8341445">.</span><span class="ident" id="8341446">Fatalf</span><span class="op" id="8341452">(</span><span class="string" id="8341453">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8341472">,</span>&nbsp;<span class="ident" id="8341474">err</span><span class="op" id="8341477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8341480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341483">defer</span>&nbsp;<span class="ident" id="8341489">ln</span><span class="op" id="8341491">.</span><span class="ident" id="8341492">Close</span><span class="op" id="8341497">(</span><span class="op" id="8341498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341501">var</span>&nbsp;<span class="ident" id="8341505">server</span>&nbsp;<span class="ident" id="8341512">Conn</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341518">errc</span>&nbsp;<span class="op" id="8341523">:=</span>&nbsp;<span class="builtinfunc" id="8341526">make</span><span class="op" id="8341530">(</span><span class="keyword" id="8341531">chan</span>&nbsp;<span class="builtintype" id="8341536">error</span><span class="op" id="8341541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341544">go</span>&nbsp;<span class="keyword" id="8341547">func</span><span class="op" id="8341551">(</span><span class="op" id="8341552">)</span>&nbsp;<span class="op" id="8341554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341558">var</span>&nbsp;<span class="ident" id="8341562">err</span>&nbsp;<span class="builtintype" id="8341566">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341574">server</span><span class="op" id="8341580">,</span>&nbsp;<span class="ident" id="8341582">err</span>&nbsp;<span class="op" id="8341586">=</span>&nbsp;<span class="ident" id="8341588">ln</span><span class="op" id="8341590">.</span><span class="ident" id="8341591">Accept</span><span class="op" id="8341597">(</span><span class="op" id="8341598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341602">errc</span>&nbsp;<span class="op" id="8341607">&lt;-</span>&nbsp;<span class="ident" id="8341610">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8341615">}</span><span class="op" id="8341616">(</span><span class="op" id="8341617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341620">client</span><span class="op" id="8341626">,</span>&nbsp;<span class="ident" id="8341628">err</span>&nbsp;<span class="op" id="8341632">:=</span>&nbsp;<span class="ident" id="8341635">Dial</span><span class="op" id="8341639">(</span><span class="string" id="8341640">&#34;tcp&#34;</span><span class="op" id="8341645">,</span>&nbsp;<span class="ident" id="8341647">ln</span><span class="op" id="8341649">.</span><span class="ident" id="8341650">Addr</span><span class="op" id="8341654">(</span><span class="op" id="8341655">)</span><span class="op" id="8341656">.</span><span class="ident" id="8341657">String</span><span class="op" id="8341663">(</span><span class="op" id="8341664">)</span><span class="op" id="8341665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341668">if</span>&nbsp;<span class="ident" id="8341671">err</span>&nbsp;<span class="op" id="8341675">!=</span>&nbsp;<span class="ident" id="8341678">nil</span>&nbsp;<span class="op" id="8341682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341686">t</span><span class="op" id="8341687">.</span><span class="ident" id="8341688">Fatalf</span><span class="op" id="8341694">(</span><span class="string" id="8341695">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8341712">,</span>&nbsp;<span class="ident" id="8341714">err</span><span class="op" id="8341717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8341720">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341723">if</span>&nbsp;<span class="ident" id="8341726">err</span>&nbsp;<span class="op" id="8341730">:=</span>&nbsp;<span class="op" id="8341733">&lt;-</span><span class="ident" id="8341735">errc</span><span class="op" id="8341739">;</span>&nbsp;<span class="ident" id="8341741">err</span>&nbsp;<span class="op" id="8341745">!=</span>&nbsp;<span class="ident" id="8341748">nil</span>&nbsp;<span class="op" id="8341752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341756">t</span><span class="op" id="8341757">.</span><span class="ident" id="8341758">Fatalf</span><span class="op" id="8341764">(</span><span class="string" id="8341765">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8341784">,</span>&nbsp;<span class="ident" id="8341786">err</span><span class="op" id="8341789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8341792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341795">defer</span>&nbsp;<span class="ident" id="8341801">server</span><span class="op" id="8341807">.</span><span class="ident" id="8341808">Close</span><span class="op" id="8341813">(</span><span class="op" id="8341814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341817">var</span>&nbsp;<span class="ident" id="8341821">buf</span>&nbsp;<span class="op" id="8341825">[</span><span class="num" id="8341826">128</span><span class="op" id="8341829">]</span><span class="builtintype" id="8341830">byte</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341836">mallocs</span>&nbsp;<span class="op" id="8341844">:=</span>&nbsp;<span class="ident" id="8341847">testing</span><span class="op" id="8341854">.</span><span class="ident" id="8341855">AllocsPerRun</span><span class="op" id="8341867">(</span><span class="num" id="8341868">1000</span><span class="op" id="8341872">,</span>&nbsp;<span class="keyword" id="8341874">func</span><span class="op" id="8341878">(</span><span class="op" id="8341879">)</span>&nbsp;<span class="op" id="8341881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341885">_</span><span class="op" id="8341886">,</span>&nbsp;<span class="ident" id="8341888">err</span>&nbsp;<span class="op" id="8341892">:=</span>&nbsp;<span class="ident" id="8341895">server</span><span class="op" id="8341901">.</span><span class="ident" id="8341902">Write</span><span class="op" id="8341907">(</span><span class="ident" id="8341908">buf</span><span class="op" id="8341911">[</span><span class="op" id="8341912">:</span><span class="op" id="8341913">]</span><span class="op" id="8341914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341918">if</span>&nbsp;<span class="ident" id="8341921">err</span>&nbsp;<span class="op" id="8341925">!=</span>&nbsp;<span class="ident" id="8341928">nil</span>&nbsp;<span class="op" id="8341932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341937">t</span><span class="op" id="8341938">.</span><span class="ident" id="8341939">Fatalf</span><span class="op" id="8341945">(</span><span class="string" id="8341946">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8341964">,</span>&nbsp;<span class="ident" id="8341966">err</span><span class="op" id="8341969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8341973">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341977">_</span><span class="op" id="8341978">,</span>&nbsp;<span class="ident" id="8341980">err</span>&nbsp;<span class="op" id="8341984">=</span>&nbsp;<span class="ident" id="8341986">io</span><span class="op" id="8341988">.</span><span class="ident" id="8341989">ReadFull</span><span class="op" id="8341997">(</span><span class="ident" id="8341998">client</span><span class="op" id="8342004">,</span>&nbsp;<span class="ident" id="8342006">buf</span><span class="op" id="8342009">[</span><span class="op" id="8342010">:</span><span class="op" id="8342011">]</span><span class="op" id="8342012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342016">if</span>&nbsp;<span class="ident" id="8342019">err</span>&nbsp;<span class="op" id="8342023">!=</span>&nbsp;<span class="ident" id="8342026">nil</span>&nbsp;<span class="op" id="8342030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8342035">t</span><span class="op" id="8342036">.</span><span class="ident" id="8342037">Fatalf</span><span class="op" id="8342043">(</span><span class="string" id="8342044">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8342061">,</span>&nbsp;<span class="ident" id="8342063">err</span><span class="op" id="8342066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8342070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8342073">}</span><span class="op" id="8342074">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342077">if</span>&nbsp;<span class="ident" id="8342080">mallocs</span>&nbsp;<span class="op" id="8342088">&gt;</span>&nbsp;<span class="num" id="8342090">0</span>&nbsp;<span class="op" id="8342092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8342096">t</span><span class="op" id="8342097">.</span><span class="ident" id="8342098">Fatalf</span><span class="op" id="8342104">(</span><span class="string" id="8342105">&#34;Got&nbsp;%v&nbsp;allocs,&nbsp;want&nbsp;0&#34;</span><span class="op" id="8342128">,</span>&nbsp;<span class="ident" id="8342130">mallocs</span><span class="op" id="8342137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8342140">}</span><br>
<span class="lineno"></span><span class="op" id="8342142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="8342145">func</span>&nbsp;<span class="ident" id="8342150">TestTCPStress</span><span class="op" id="8342163">(</span><span class="ident" id="8342164">t</span>&nbsp;<span class="op" id="8342166">*</span><span class="ident" id="8342167">testing</span><span class="op" id="8342174">.</span><span class="ident" id="8342175">T</span><span class="op" id="8342176">)</span>&nbsp;<span class="op" id="8342178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342181">const</span>&nbsp;<span class="ident" id="8342187">conns</span>&nbsp;<span class="op" id="8342193">=</span>&nbsp;<span class="num" id="8342195">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342198">const</span>&nbsp;<span class="ident" id="8342204">msgLen</span>&nbsp;<span class="op" id="8342211">=</span>&nbsp;<span class="num" id="8342213">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8342218">msgs</span>&nbsp;<span class="op" id="8342223">:=</span>&nbsp;<span class="builtintype" id="8342226">int</span><span class="op" id="8342229">(</span><span class="num" id="8342230">1e4</span><span class="op" id="8342233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342236">if</span>&nbsp;<span class="ident" id="8342239">testing</span><span class="op" id="8342246">.</span><span class="ident" id="8342247">Short</span><span class="op" id="8342252">(</span><span class="op" id="8342253">)</span>&nbsp;<span class="op" id="8342255">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8342259">msgs</span>&nbsp;<span class="op" id="8342264">=</span>&nbsp;<span class="num" id="8342266">1e2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8342271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8342275">sendMsg</span>&nbsp;<span class="op" id="8342283">:=</span>&nbsp;<span class="keyword" id="8342286">func</span><span class="op" id="8342290">(</span><span class="ident" id="8342291">c</span>&nbsp;<span class="ident" id="8342293">Conn</span><span class="op" id="8342297">,</span>&nbsp;<span class="ident" id="8342299">buf</span>&nbsp;<span class="op" id="8342303">[</span><span class="op" id="8342304">]</span><span class="builtintype" id="8342305">byte</span><span class="op" id="8342309">)</span>&nbsp;<span class="builtintype" id="8342311">bool</span>&nbsp;<span class="op" id="8342316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8342320">n</span><span class="op" id="8342321">,</span>&nbsp;<span class="ident" id="8342323">err</span>&nbsp;<span class="op" id="8342327">:=</span>&nbsp;<span class="ident" id="8342330">c</span><span class="op" id="8342331">.</span><span class="ident" id="8342332">Write</span><span class="op" id="8342337">(</span><span class="ident" id="8342338">buf</span><span class="op" id="8342341">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342345">if</span>&nbsp;<span class="ident" id="8342348">n</span>&nbsp;<span class="op" id="8342350">!=</span>&nbsp;<span class="builtinfunc" id="8342353">len</span><span class="op" id="8342356">(</span><span class="ident" id="8342357">buf</span><span class="op" id="8342360">)</span>&nbsp;<span class="op" id="8342362">||</span>&nbsp;<span class="ident" id="8342365">err</span>&nbsp;<span class="op" id="8342369">!=</span>&nbsp;<span class="ident" id="8342372">nil</span>&nbsp;<span class="op" id="8342376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8342381">t</span><span class="op" id="8342382">.</span><span class="ident" id="8342383">Logf</span><span class="op" id="8342387">(</span><span class="string" id="8342388">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8342406">,</span>&nbsp;<span class="ident" id="8342408">err</span><span class="op" id="8342411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342416">return</span>&nbsp;<span class="builtintype" id="8342423">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8342431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342435">return</span>&nbsp;<span class="builtintype" id="8342442">true</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8342448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8342451">recvMsg</span>&nbsp;<span class="op" id="8342459">:=</span>&nbsp;<span class="keyword" id="8342462">func</span><span class="op" id="8342466">(</span><span class="ident" id="8342467">c</span>&nbsp;<span class="ident" id="8342469">Conn</span><span class="op" id="8342473">,</span>&nbsp;<span class="ident" id="8342475">buf</span>&nbsp;<span class="op" id="8342479">[</span><span class="op" id="8342480">]</span><span class="builtintype" id="8342481">byte</span><span class="op" id="8342485">)</span>&nbsp;<span class="builtintype" id="8342487">bool</span>&nbsp;<span class="op" id="8342492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342496">for</span>&nbsp;<span class="ident" id="8342500">read</span>&nbsp;<span class="op" id="8342505">:=</span>&nbsp;<span class="num" id="8342508">0</span><span class="op" id="8342509">;</span>&nbsp;<span class="ident" id="8342511">read</span>&nbsp;<span class="op" id="8342516">!=</span>&nbsp;<span class="builtinfunc" id="8342519">len</span><span class="op" id="8342522">(</span><span class="ident" id="8342523">buf</span><span class="op" id="8342526">)</span><span class="op" id="8342527">;</span>&nbsp;<span class="op" id="8342529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8342534">n</span><span class="op" id="8342535">,</span>&nbsp;<span class="ident" id="8342537">err</span>&nbsp;<span class="op" id="8342541">:=</span>&nbsp;<span class="ident" id="8342544">c</span><span class="op" id="8342545">.</span><span class="ident" id="8342546">Read</span><span class="op" id="8342550">(</span><span class="ident" id="8342551">buf</span><span class="op" id="8342554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8342559">read</span>&nbsp;<span class="op" id="8342564">+=</span>&nbsp;<span class="ident" id="8342567">n</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342572">if</span>&nbsp;<span class="ident" id="8342575">err</span>&nbsp;<span class="op" id="8342579">!=</span>&nbsp;<span class="ident" id="8342582">nil</span>&nbsp;<span class="op" id="8342586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8342592">t</span><span class="op" id="8342593">.</span><span class="ident" id="8342594">Logf</span><span class="op" id="8342598">(</span><span class="string" id="8342599">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8342616">,</span>&nbsp;<span class="ident" id="8342618">err</span><span class="op" id="8342621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342627">return</span>&nbsp;<span class="builtintype" id="8342634">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8342643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8342647">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342651">return</span>&nbsp;<span class="builtintype" id="8342658">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8342664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8342668">ln</span><span class="op" id="8342670">,</span>&nbsp;<span class="ident" id="8342672">err</span>&nbsp;<span class="op" id="8342676">:=</span>&nbsp;<span class="ident" id="8342679">Listen</span><span class="op" id="8342685">(</span><span class="string" id="8342686">&#34;tcp&#34;</span><span class="op" id="8342691">,</span>&nbsp;<span class="string" id="8342693">&#34;127.0.0.1:0&#34;</span><span class="op" id="8342706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342709">if</span>&nbsp;<span class="ident" id="8342712">err</span>&nbsp;<span class="op" id="8342716">!=</span>&nbsp;<span class="ident" id="8342719">nil</span>&nbsp;<span class="op" id="8342723">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8342727">t</span><span class="op" id="8342728">.</span><span class="ident" id="8342729">Fatalf</span><span class="op" id="8342735">(</span><span class="string" id="8342736">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8342755">,</span>&nbsp;<span class="ident" id="8342757">err</span><span class="op" id="8342760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8342763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342766">defer</span>&nbsp;<span class="ident" id="8342772">ln</span><span class="op" id="8342774">.</span><span class="ident" id="8342775">Close</span><span class="op" id="8342780">(</span><span class="op" id="8342781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8342784">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342798">go</span>&nbsp;<span class="keyword" id="8342801">func</span><span class="op" id="8342805">(</span><span class="op" id="8342806">)</span>&nbsp;<span class="op" id="8342808">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342812">for</span>&nbsp;<span class="op" id="8342816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8342821">c</span><span class="op" id="8342822">,</span>&nbsp;<span class="ident" id="8342824">err</span>&nbsp;<span class="op" id="8342828">:=</span>&nbsp;<span class="ident" id="8342831">ln</span><span class="op" id="8342833">.</span><span class="ident" id="8342834">Accept</span><span class="op" id="8342840">(</span><span class="op" id="8342841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342846">if</span>&nbsp;<span class="ident" id="8342849">err</span>&nbsp;<span class="op" id="8342853">!=</span>&nbsp;<span class="ident" id="8342856">nil</span>&nbsp;<span class="op" id="8342860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342866">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8342875">}</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8342880">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342905">go</span>&nbsp;<span class="keyword" id="8342908">func</span><span class="op" id="8342912">(</span><span class="ident" id="8342913">c</span>&nbsp;<span class="ident" id="8342915">Conn</span><span class="op" id="8342919">)</span>&nbsp;<span class="op" id="8342921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342927">defer</span>&nbsp;<span class="ident" id="8342933">c</span><span class="op" id="8342934">.</span><span class="ident" id="8342935">Close</span><span class="op" id="8342940">(</span><span class="op" id="8342941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342947">var</span>&nbsp;<span class="ident" id="8342951">buf</span>&nbsp;<span class="op" id="8342955">[</span><span class="ident" id="8342956">msgLen</span><span class="op" id="8342962">]</span><span class="builtintype" id="8342963">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342972">for</span>&nbsp;<span class="ident" id="8342976">m</span>&nbsp;<span class="op" id="8342978">:=</span>&nbsp;<span class="num" id="8342981">0</span><span class="op" id="8342982">;</span>&nbsp;<span class="ident" id="8342984">m</span>&nbsp;<span class="op" id="8342986">&lt;</span>&nbsp;<span class="ident" id="8342988">msgs</span><span class="op" id="8342992">;</span>&nbsp;<span class="ident" id="8342994">m</span><span class="op" id="8342995">++</span>&nbsp;<span class="op" id="8342998">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343005">if</span>&nbsp;<span class="op" id="8343008">!</span><span class="ident" id="8343009">recvMsg</span><span class="op" id="8343016">(</span><span class="ident" id="8343017">c</span><span class="op" id="8343018">,</span>&nbsp;<span class="ident" id="8343020">buf</span><span class="op" id="8343023">[</span><span class="op" id="8343024">:</span><span class="op" id="8343025">]</span><span class="op" id="8343026">)</span>&nbsp;<span class="op" id="8343028">||</span>&nbsp;<span class="op" id="8343031">!</span><span class="ident" id="8343032">sendMsg</span><span class="op" id="8343039">(</span><span class="ident" id="8343040">c</span><span class="op" id="8343041">,</span>&nbsp;<span class="ident" id="8343043">buf</span><span class="op" id="8343046">[</span><span class="op" id="8343047">:</span><span class="op" id="8343048">]</span><span class="op" id="8343049">)</span>&nbsp;<span class="op" id="8343051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343059">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343081">}</span><span class="op" id="8343082">(</span><span class="ident" id="8343083">c</span><span class="op" id="8343084">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343091">}</span><span class="op" id="8343092">(</span><span class="op" id="8343093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8343096">done</span>&nbsp;<span class="op" id="8343101">:=</span>&nbsp;<span class="builtinfunc" id="8343104">make</span><span class="op" id="8343108">(</span><span class="keyword" id="8343109">chan</span>&nbsp;<span class="builtintype" id="8343114">bool</span><span class="op" id="8343118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343121">for</span>&nbsp;<span class="ident" id="8343125">i</span>&nbsp;<span class="op" id="8343127">:=</span>&nbsp;<span class="num" id="8343130">0</span><span class="op" id="8343131">;</span>&nbsp;<span class="ident" id="8343133">i</span>&nbsp;<span class="op" id="8343135">&lt;</span>&nbsp;<span class="ident" id="8343137">conns</span><span class="op" id="8343142">;</span>&nbsp;<span class="ident" id="8343144">i</span><span class="op" id="8343145">++</span>&nbsp;<span class="op" id="8343148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8343152">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343176">go</span>&nbsp;<span class="keyword" id="8343179">func</span><span class="op" id="8343183">(</span><span class="op" id="8343184">)</span>&nbsp;<span class="op" id="8343186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343191">defer</span>&nbsp;<span class="keyword" id="8343197">func</span><span class="op" id="8343201">(</span><span class="op" id="8343202">)</span>&nbsp;<span class="op" id="8343204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8343210">done</span>&nbsp;<span class="op" id="8343215">&lt;-</span>&nbsp;<span class="builtintype" id="8343218">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343226">}</span><span class="op" id="8343227">(</span><span class="op" id="8343228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8343233">c</span><span class="op" id="8343234">,</span>&nbsp;<span class="ident" id="8343236">err</span>&nbsp;<span class="op" id="8343240">:=</span>&nbsp;<span class="ident" id="8343243">Dial</span><span class="op" id="8343247">(</span><span class="string" id="8343248">&#34;tcp&#34;</span><span class="op" id="8343253">,</span>&nbsp;<span class="ident" id="8343255">ln</span><span class="op" id="8343257">.</span><span class="ident" id="8343258">Addr</span><span class="op" id="8343262">(</span><span class="op" id="8343263">)</span><span class="op" id="8343264">.</span><span class="ident" id="8343265">String</span><span class="op" id="8343271">(</span><span class="op" id="8343272">)</span><span class="op" id="8343273">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343278">if</span>&nbsp;<span class="ident" id="8343281">err</span>&nbsp;<span class="op" id="8343285">!=</span>&nbsp;<span class="ident" id="8343288">nil</span>&nbsp;<span class="op" id="8343292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8343298">t</span><span class="op" id="8343299">.</span><span class="ident" id="8343300">Logf</span><span class="op" id="8343304">(</span><span class="string" id="8343305">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8343322">,</span>&nbsp;<span class="ident" id="8343324">err</span><span class="op" id="8343327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343333">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343348">defer</span>&nbsp;<span class="ident" id="8343354">c</span><span class="op" id="8343355">.</span><span class="ident" id="8343356">Close</span><span class="op" id="8343361">(</span><span class="op" id="8343362">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343367">var</span>&nbsp;<span class="ident" id="8343371">buf</span>&nbsp;<span class="op" id="8343375">[</span><span class="ident" id="8343376">msgLen</span><span class="op" id="8343382">]</span><span class="builtintype" id="8343383">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343391">for</span>&nbsp;<span class="ident" id="8343395">m</span>&nbsp;<span class="op" id="8343397">:=</span>&nbsp;<span class="num" id="8343400">0</span><span class="op" id="8343401">;</span>&nbsp;<span class="ident" id="8343403">m</span>&nbsp;<span class="op" id="8343405">&lt;</span>&nbsp;<span class="ident" id="8343407">msgs</span><span class="op" id="8343411">;</span>&nbsp;<span class="ident" id="8343413">m</span><span class="op" id="8343414">++</span>&nbsp;<span class="op" id="8343417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343423">if</span>&nbsp;<span class="op" id="8343426">!</span><span class="ident" id="8343427">sendMsg</span><span class="op" id="8343434">(</span><span class="ident" id="8343435">c</span><span class="op" id="8343436">,</span>&nbsp;<span class="ident" id="8343438">buf</span><span class="op" id="8343441">[</span><span class="op" id="8343442">:</span><span class="op" id="8343443">]</span><span class="op" id="8343444">)</span>&nbsp;<span class="op" id="8343446">||</span>&nbsp;<span class="op" id="8343449">!</span><span class="ident" id="8343450">recvMsg</span><span class="op" id="8343457">(</span><span class="ident" id="8343458">c</span><span class="op" id="8343459">,</span>&nbsp;<span class="ident" id="8343461">buf</span><span class="op" id="8343464">[</span><span class="op" id="8343465">:</span><span class="op" id="8343466">]</span><span class="op" id="8343467">)</span>&nbsp;<span class="op" id="8343469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343476">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343486">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343495">}</span><span class="op" id="8343496">(</span><span class="op" id="8343497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343503">for</span>&nbsp;<span class="ident" id="8343507">i</span>&nbsp;<span class="op" id="8343509">:=</span>&nbsp;<span class="num" id="8343512">0</span><span class="op" id="8343513">;</span>&nbsp;<span class="ident" id="8343515">i</span>&nbsp;<span class="op" id="8343517">&lt;</span>&nbsp;<span class="ident" id="8343519">conns</span><span class="op" id="8343524">;</span>&nbsp;<span class="ident" id="8343526">i</span><span class="op" id="8343527">++</span>&nbsp;<span class="op" id="8343530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343534">&lt;-</span><span class="ident" id="8343536">done</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343542">}</span><br>
<span class="lineno"></span><span class="op" id="8343544">}</span>
</div>
</body>
</html>
