<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5660785">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5660840">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5660894">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5660945">//&nbsp;Package&nbsp;jpeg&nbsp;implements&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;decoder&nbsp;and&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="comment" id="5661006">//</span><br>
<span class="lineno"></span><span class="comment" id="5661009">//&nbsp;JPEG&nbsp;is&nbsp;defined&nbsp;in&nbsp;ITU-T&nbsp;T.81:&nbsp;http://www.w3.org/Graphics/JPEG/itu-t81.pdf.</span><br>
<span class="lineno"></span><span class="keyword" id="5661088">package</span>&nbsp;<span class="ident" id="5661096">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5661102">import</span>&nbsp;<span class="op" id="5661109">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5661112">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5661121">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5661136">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5661141">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5661144">//&nbsp;TODO(nigeltao):&nbsp;fix&nbsp;up&nbsp;the&nbsp;doc&nbsp;comment&nbsp;style&nbsp;so&nbsp;that&nbsp;sentences&nbsp;start&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="5661221">//&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;or&nbsp;function&nbsp;that&nbsp;they&nbsp;annotate.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5661278">//&nbsp;A&nbsp;FormatError&nbsp;reports&nbsp;that&nbsp;the&nbsp;input&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;JPEG.</span><br>
<span class="lineno">20</span><span class="keyword" id="5661339">type</span>&nbsp;<span class="ident" id="5661344">FormatError</span>&nbsp;<span class="builtintype" id="5661356">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5661364">func</span>&nbsp;<span class="op" id="5661369">(</span><span class="ident" id="5661370">e</span>&nbsp;<span class="ident" id="5661372">FormatError</span><span class="op" id="5661383">)</span>&nbsp;<span class="ident" id="5661385">Error</span><span class="op" id="5661390">(</span><span class="op" id="5661391">)</span>&nbsp;<span class="builtintype" id="5661393">string</span>&nbsp;<span class="op" id="5661400">{</span>&nbsp;<span class="keyword" id="5661402">return</span>&nbsp;<span class="string" id="5661409">&#34;invalid&nbsp;JPEG&nbsp;format:&nbsp;&#34;</span>&nbsp;<span class="op" id="5661433">+</span>&nbsp;<span class="builtintype" id="5661435">string</span><span class="op" id="5661441">(</span><span class="ident" id="5661442">e</span><span class="op" id="5661443">)</span>&nbsp;<span class="op" id="5661445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5661448">//&nbsp;An&nbsp;UnsupportedError&nbsp;reports&nbsp;that&nbsp;the&nbsp;input&nbsp;uses&nbsp;a&nbsp;valid&nbsp;but&nbsp;unimplemented&nbsp;JPEG&nbsp;feature.</span><br>
<span class="lineno">25</span><span class="keyword" id="5661539">type</span>&nbsp;<span class="ident" id="5661544">UnsupportedError</span>&nbsp;<span class="builtintype" id="5661561">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5661569">func</span>&nbsp;<span class="op" id="5661574">(</span><span class="ident" id="5661575">e</span>&nbsp;<span class="ident" id="5661577">UnsupportedError</span><span class="op" id="5661593">)</span>&nbsp;<span class="ident" id="5661595">Error</span><span class="op" id="5661600">(</span><span class="op" id="5661601">)</span>&nbsp;<span class="builtintype" id="5661603">string</span>&nbsp;<span class="op" id="5661610">{</span>&nbsp;<span class="keyword" id="5661612">return</span>&nbsp;<span class="string" id="5661619">&#34;unsupported&nbsp;JPEG&nbsp;feature:&nbsp;&#34;</span>&nbsp;<span class="op" id="5661648">+</span>&nbsp;<span class="builtintype" id="5661650">string</span><span class="op" id="5661656">(</span><span class="ident" id="5661657">e</span><span class="op" id="5661658">)</span>&nbsp;<span class="op" id="5661660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5661663">//&nbsp;Component&nbsp;specification,&nbsp;specified&nbsp;in&nbsp;section&nbsp;B.2.2.</span><br>
<span class="lineno">30</span><span class="keyword" id="5661719">type</span>&nbsp;<span class="ident" id="5661724">component</span>&nbsp;<span class="keyword" id="5661734">struct</span>&nbsp;<span class="op" id="5661741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5661744">h</span>&nbsp;&nbsp;<span class="builtintype" id="5661747">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5661753">//&nbsp;Horizontal&nbsp;sampling&nbsp;factor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5661785">v</span>&nbsp;&nbsp;<span class="builtintype" id="5661788">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5661794">//&nbsp;Vertical&nbsp;sampling&nbsp;factor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5661824">c</span>&nbsp;&nbsp;<span class="builtintype" id="5661827">uint8</span>&nbsp;<span class="comment" id="5661833">//&nbsp;Component&nbsp;identifier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5661859">tq</span>&nbsp;<span class="builtintype" id="5661862">uint8</span>&nbsp;<span class="comment" id="5661868">//&nbsp;Quantization&nbsp;table&nbsp;destination&nbsp;selector.</span><br>
<span class="lineno">35</span><span class="op" id="5661912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5661915">const</span>&nbsp;<span class="op" id="5661921">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5661924">dcTable</span>&nbsp;<span class="op" id="5661932">=</span>&nbsp;<span class="num" id="5661934">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5661937">acTable</span>&nbsp;<span class="op" id="5661945">=</span>&nbsp;<span class="num" id="5661947">1</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5661950">maxTc</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5661958">=</span>&nbsp;<span class="num" id="5661960">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5661963">maxTh</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5661971">=</span>&nbsp;<span class="num" id="5661973">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5661976">maxTq</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5661984">=</span>&nbsp;<span class="num" id="5661986">3</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5661990">//&nbsp;A&nbsp;grayscale&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;only&nbsp;a&nbsp;Y&nbsp;component.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662041">nGrayComponent</span>&nbsp;<span class="op" id="5662056">=</span>&nbsp;<span class="num" id="5662058">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5662061">//&nbsp;A&nbsp;color&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;Y,&nbsp;Cb&nbsp;and&nbsp;Cr&nbsp;components.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662113">nColorComponent</span>&nbsp;<span class="op" id="5662129">=</span>&nbsp;<span class="num" id="5662131">3</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5662135">//&nbsp;We&nbsp;only&nbsp;support&nbsp;4:4:4,&nbsp;4:4:0,&nbsp;4:2:2&nbsp;and&nbsp;4:2:0&nbsp;downsampling,&nbsp;and&nbsp;therefore&nbsp;the</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5662217">//&nbsp;number&nbsp;of&nbsp;luma&nbsp;samples&nbsp;per&nbsp;chroma&nbsp;sample&nbsp;is&nbsp;at&nbsp;most&nbsp;2&nbsp;in&nbsp;the&nbsp;horizontal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5662293">//&nbsp;and&nbsp;2&nbsp;in&nbsp;the&nbsp;vertical&nbsp;direction.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662330">maxH</span>&nbsp;<span class="op" id="5662335">=</span>&nbsp;<span class="num" id="5662337">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662340">maxV</span>&nbsp;<span class="op" id="5662345">=</span>&nbsp;<span class="num" id="5662347">2</span><br>
<span class="lineno"></span><span class="op" id="5662349">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="5662352">const</span>&nbsp;<span class="op" id="5662358">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662361">soiMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5662373">=</span>&nbsp;<span class="num" id="5662375">0xd8</span>&nbsp;<span class="comment" id="5662380">//&nbsp;Start&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662400">eoiMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5662412">=</span>&nbsp;<span class="num" id="5662414">0xd9</span>&nbsp;<span class="comment" id="5662419">//&nbsp;End&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662437">sof0Marker</span>&nbsp;&nbsp;<span class="op" id="5662449">=</span>&nbsp;<span class="num" id="5662451">0xc0</span>&nbsp;<span class="comment" id="5662456">//&nbsp;Start&nbsp;Of&nbsp;Frame&nbsp;(Baseline).</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662487">sof2Marker</span>&nbsp;&nbsp;<span class="op" id="5662499">=</span>&nbsp;<span class="num" id="5662501">0xc2</span>&nbsp;<span class="comment" id="5662506">//&nbsp;Start&nbsp;Of&nbsp;Frame&nbsp;(Progressive).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662540">dhtMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5662552">=</span>&nbsp;<span class="num" id="5662554">0xc4</span>&nbsp;<span class="comment" id="5662559">//&nbsp;Define&nbsp;Huffman&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662585">dqtMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5662597">=</span>&nbsp;<span class="num" id="5662599">0xdb</span>&nbsp;<span class="comment" id="5662604">//&nbsp;Define&nbsp;Quantization&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662635">sosMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5662647">=</span>&nbsp;<span class="num" id="5662649">0xda</span>&nbsp;<span class="comment" id="5662654">//&nbsp;Start&nbsp;Of&nbsp;Scan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662673">driMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5662685">=</span>&nbsp;<span class="num" id="5662687">0xdd</span>&nbsp;<span class="comment" id="5662692">//&nbsp;Define&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662721">rst0Marker</span>&nbsp;&nbsp;<span class="op" id="5662733">=</span>&nbsp;<span class="num" id="5662735">0xd0</span>&nbsp;<span class="comment" id="5662740">//&nbsp;ReSTart&nbsp;(0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662757">rst7Marker</span>&nbsp;&nbsp;<span class="op" id="5662769">=</span>&nbsp;<span class="num" id="5662771">0xd7</span>&nbsp;<span class="comment" id="5662776">//&nbsp;ReSTart&nbsp;(7).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662793">app0Marker</span>&nbsp;&nbsp;<span class="op" id="5662805">=</span>&nbsp;<span class="num" id="5662807">0xe0</span>&nbsp;<span class="comment" id="5662812">//&nbsp;APPlication&nbsp;specific&nbsp;(0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662842">app15Marker</span>&nbsp;<span class="op" id="5662854">=</span>&nbsp;<span class="num" id="5662856">0xef</span>&nbsp;<span class="comment" id="5662861">//&nbsp;APPlication&nbsp;specific&nbsp;(15).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662892">comMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5662904">=</span>&nbsp;<span class="num" id="5662906">0xfe</span>&nbsp;<span class="comment" id="5662911">//&nbsp;COMment.</span><br>
<span class="lineno">70</span><span class="op" id="5662923">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5662926">//&nbsp;unzig&nbsp;maps&nbsp;from&nbsp;the&nbsp;zig-zag&nbsp;ordering&nbsp;to&nbsp;the&nbsp;natural&nbsp;ordering.&nbsp;For&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="5663004">//&nbsp;unzig[3]&nbsp;is&nbsp;the&nbsp;column&nbsp;and&nbsp;row&nbsp;of&nbsp;the&nbsp;fourth&nbsp;element&nbsp;in&nbsp;zig-zag&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="5663082">//&nbsp;value&nbsp;is&nbsp;16,&nbsp;which&nbsp;means&nbsp;first&nbsp;column&nbsp;(16%8&nbsp;==&nbsp;0)&nbsp;and&nbsp;third&nbsp;row&nbsp;(16/8&nbsp;==&nbsp;2).</span><br>
<span class="lineno">75</span><span class="keyword" id="5663162">var</span>&nbsp;<span class="ident" id="5663166">unzig</span>&nbsp;<span class="op" id="5663172">=</span>&nbsp;<span class="op" id="5663174">[</span><span class="ident" id="5663175">blockSize</span><span class="op" id="5663184">]</span><span class="builtintype" id="5663185">int</span><span class="op" id="5663188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5663191">0</span><span class="op" id="5663192">,</span>&nbsp;<span class="num" id="5663194">1</span><span class="op" id="5663195">,</span>&nbsp;<span class="num" id="5663197">8</span><span class="op" id="5663198">,</span>&nbsp;<span class="num" id="5663200">16</span><span class="op" id="5663202">,</span>&nbsp;<span class="num" id="5663204">9</span><span class="op" id="5663205">,</span>&nbsp;<span class="num" id="5663207">2</span><span class="op" id="5663208">,</span>&nbsp;<span class="num" id="5663210">3</span><span class="op" id="5663211">,</span>&nbsp;<span class="num" id="5663213">10</span><span class="op" id="5663215">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5663218">17</span><span class="op" id="5663220">,</span>&nbsp;<span class="num" id="5663222">24</span><span class="op" id="5663224">,</span>&nbsp;<span class="num" id="5663226">32</span><span class="op" id="5663228">,</span>&nbsp;<span class="num" id="5663230">25</span><span class="op" id="5663232">,</span>&nbsp;<span class="num" id="5663234">18</span><span class="op" id="5663236">,</span>&nbsp;<span class="num" id="5663238">11</span><span class="op" id="5663240">,</span>&nbsp;<span class="num" id="5663242">4</span><span class="op" id="5663243">,</span>&nbsp;<span class="num" id="5663245">5</span><span class="op" id="5663246">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5663249">12</span><span class="op" id="5663251">,</span>&nbsp;<span class="num" id="5663253">19</span><span class="op" id="5663255">,</span>&nbsp;<span class="num" id="5663257">26</span><span class="op" id="5663259">,</span>&nbsp;<span class="num" id="5663261">33</span><span class="op" id="5663263">,</span>&nbsp;<span class="num" id="5663265">40</span><span class="op" id="5663267">,</span>&nbsp;<span class="num" id="5663269">48</span><span class="op" id="5663271">,</span>&nbsp;<span class="num" id="5663273">41</span><span class="op" id="5663275">,</span>&nbsp;<span class="num" id="5663277">34</span><span class="op" id="5663279">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5663282">27</span><span class="op" id="5663284">,</span>&nbsp;<span class="num" id="5663286">20</span><span class="op" id="5663288">,</span>&nbsp;<span class="num" id="5663290">13</span><span class="op" id="5663292">,</span>&nbsp;<span class="num" id="5663294">6</span><span class="op" id="5663295">,</span>&nbsp;<span class="num" id="5663297">7</span><span class="op" id="5663298">,</span>&nbsp;<span class="num" id="5663300">14</span><span class="op" id="5663302">,</span>&nbsp;<span class="num" id="5663304">21</span><span class="op" id="5663306">,</span>&nbsp;<span class="num" id="5663308">28</span><span class="op" id="5663310">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5663313">35</span><span class="op" id="5663315">,</span>&nbsp;<span class="num" id="5663317">42</span><span class="op" id="5663319">,</span>&nbsp;<span class="num" id="5663321">49</span><span class="op" id="5663323">,</span>&nbsp;<span class="num" id="5663325">56</span><span class="op" id="5663327">,</span>&nbsp;<span class="num" id="5663329">57</span><span class="op" id="5663331">,</span>&nbsp;<span class="num" id="5663333">50</span><span class="op" id="5663335">,</span>&nbsp;<span class="num" id="5663337">43</span><span class="op" id="5663339">,</span>&nbsp;<span class="num" id="5663341">36</span><span class="op" id="5663343">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5663346">29</span><span class="op" id="5663348">,</span>&nbsp;<span class="num" id="5663350">22</span><span class="op" id="5663352">,</span>&nbsp;<span class="num" id="5663354">15</span><span class="op" id="5663356">,</span>&nbsp;<span class="num" id="5663358">23</span><span class="op" id="5663360">,</span>&nbsp;<span class="num" id="5663362">30</span><span class="op" id="5663364">,</span>&nbsp;<span class="num" id="5663366">37</span><span class="op" id="5663368">,</span>&nbsp;<span class="num" id="5663370">44</span><span class="op" id="5663372">,</span>&nbsp;<span class="num" id="5663374">51</span><span class="op" id="5663376">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5663379">58</span><span class="op" id="5663381">,</span>&nbsp;<span class="num" id="5663383">59</span><span class="op" id="5663385">,</span>&nbsp;<span class="num" id="5663387">52</span><span class="op" id="5663389">,</span>&nbsp;<span class="num" id="5663391">45</span><span class="op" id="5663393">,</span>&nbsp;<span class="num" id="5663395">38</span><span class="op" id="5663397">,</span>&nbsp;<span class="num" id="5663399">31</span><span class="op" id="5663401">,</span>&nbsp;<span class="num" id="5663403">39</span><span class="op" id="5663405">,</span>&nbsp;<span class="num" id="5663407">46</span><span class="op" id="5663409">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5663412">53</span><span class="op" id="5663414">,</span>&nbsp;<span class="num" id="5663416">60</span><span class="op" id="5663418">,</span>&nbsp;<span class="num" id="5663420">61</span><span class="op" id="5663422">,</span>&nbsp;<span class="num" id="5663424">54</span><span class="op" id="5663426">,</span>&nbsp;<span class="num" id="5663428">47</span><span class="op" id="5663430">,</span>&nbsp;<span class="num" id="5663432">55</span><span class="op" id="5663434">,</span>&nbsp;<span class="num" id="5663436">62</span><span class="op" id="5663438">,</span>&nbsp;<span class="num" id="5663440">63</span><span class="op" id="5663442">,</span><br>
<span class="lineno"></span><span class="op" id="5663444">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="5663447">//&nbsp;Reader&nbsp;is&nbsp;deprecated.</span><br>
<span class="lineno"></span><span class="keyword" id="5663472">type</span>&nbsp;<span class="ident" id="5663477">Reader</span>&nbsp;<span class="keyword" id="5663484">interface</span>&nbsp;<span class="op" id="5663494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5663497">io</span><span class="op" id="5663499">.</span><span class="ident" id="5663500">ByteReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5663512">io</span><span class="op" id="5663514">.</span><span class="ident" id="5663515">Reader</span><br>
<span class="lineno">90</span><span class="op" id="5663522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5663525">//&nbsp;bits&nbsp;holds&nbsp;the&nbsp;unprocessed&nbsp;bits&nbsp;that&nbsp;have&nbsp;been&nbsp;taken&nbsp;from&nbsp;the&nbsp;byte-stream.</span><br>
<span class="lineno"></span><span class="comment" id="5663603">//&nbsp;The&nbsp;n&nbsp;least&nbsp;significant&nbsp;bits&nbsp;of&nbsp;a&nbsp;form&nbsp;the&nbsp;unread&nbsp;bits,&nbsp;to&nbsp;be&nbsp;read&nbsp;in&nbsp;MSB&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5663683">//&nbsp;LSB&nbsp;order.</span><br>
<span class="lineno">95</span><span class="keyword" id="5663697">type</span>&nbsp;<span class="ident" id="5663702">bits</span>&nbsp;<span class="keyword" id="5663707">struct</span>&nbsp;<span class="op" id="5663714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5663717">a</span>&nbsp;<span class="builtintype" id="5663719">uint32</span>&nbsp;<span class="comment" id="5663726">//&nbsp;accumulator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5663743">m</span>&nbsp;<span class="builtintype" id="5663745">uint32</span>&nbsp;<span class="comment" id="5663752">//&nbsp;mask.&nbsp;m==1&lt;&lt;(n-1)&nbsp;when&nbsp;n&gt;0,&nbsp;with&nbsp;m==0&nbsp;when&nbsp;n==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5663805">n</span>&nbsp;<span class="builtintype" id="5663807">int32</span>&nbsp;&nbsp;<span class="comment" id="5663814">//&nbsp;the&nbsp;number&nbsp;of&nbsp;unread&nbsp;bits&nbsp;in&nbsp;a.</span><br>
<span class="lineno"></span><span class="op" id="5663849">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="5663852">type</span>&nbsp;<span class="ident" id="5663857">decoder</span>&nbsp;<span class="keyword" id="5663865">struct</span>&nbsp;<span class="op" id="5663872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5663875">r</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5663880">io</span><span class="op" id="5663882">.</span><span class="ident" id="5663883">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5663891">bits</span>&nbsp;<span class="ident" id="5663896">bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5663902">//&nbsp;bytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;buffer,&nbsp;similar&nbsp;to&nbsp;a&nbsp;bufio.Reader,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5663972">//&nbsp;has&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;unread&nbsp;more&nbsp;than&nbsp;1&nbsp;byte,&nbsp;due&nbsp;to&nbsp;byte&nbsp;stuffing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5664041">//&nbsp;Byte&nbsp;stuffing&nbsp;is&nbsp;specified&nbsp;in&nbsp;section&nbsp;F.1.2.3.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5664092">bytes</span>&nbsp;<span class="keyword" id="5664098">struct</span>&nbsp;<span class="op" id="5664105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5664109">//&nbsp;buf[i:j]&nbsp;are&nbsp;the&nbsp;buffered&nbsp;bytes&nbsp;read&nbsp;from&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5664171">//&nbsp;io.Reader&nbsp;that&nbsp;haven&#39;t&nbsp;yet&nbsp;been&nbsp;passed&nbsp;further&nbsp;on.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5664227">buf</span>&nbsp;&nbsp;<span class="op" id="5664232">[</span><span class="num" id="5664233">4096</span><span class="op" id="5664237">]</span><span class="builtintype" id="5664238">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5664245">i</span><span class="op" id="5664246">,</span>&nbsp;<span class="ident" id="5664248">j</span>&nbsp;<span class="builtintype" id="5664250">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5664256">//&nbsp;nUnreadable&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;back&nbsp;up&nbsp;i&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5664315">//&nbsp;overshooting.&nbsp;It&nbsp;can&nbsp;be&nbsp;0,&nbsp;1&nbsp;or&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5664355">nUnreadable</span>&nbsp;<span class="builtintype" id="5664367">int</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5664372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5664375">width</span><span class="op" id="5664380">,</span>&nbsp;<span class="ident" id="5664382">height</span>&nbsp;<span class="builtintype" id="5664389">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5664394">img1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5664408">*</span><span class="ident" id="5664409">image</span><span class="op" id="5664414">.</span><span class="ident" id="5664415">Gray</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5664421">img3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5664435">*</span><span class="ident" id="5664436">image</span><span class="op" id="5664441">.</span><span class="ident" id="5664442">YCbCr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5664449">ri</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5664463">int</span>&nbsp;<span class="comment" id="5664467">//&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5664489">nComp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5664503">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5664508">progressive</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5664522">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5664528">eobRun</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5664542">uint16</span>&nbsp;<span class="comment" id="5664549">//&nbsp;End-of-Band&nbsp;run,&nbsp;specified&nbsp;in&nbsp;section&nbsp;G.1.2.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5664600">comp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5664614">[</span><span class="ident" id="5664615">nColorComponent</span><span class="op" id="5664630">]</span><span class="ident" id="5664631">component</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5664642">progCoeffs</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5664656">[</span><span class="ident" id="5664657">nColorComponent</span><span class="op" id="5664672">]</span><span class="op" id="5664673">[</span><span class="op" id="5664674">]</span><span class="ident" id="5664675">block</span>&nbsp;<span class="comment" id="5664681">//&nbsp;Saved&nbsp;state&nbsp;between&nbsp;progressive-mode&nbsp;scans.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5664729">huff</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5664743">[</span><span class="ident" id="5664744">maxTc</span>&nbsp;<span class="op" id="5664750">+</span>&nbsp;<span class="num" id="5664752">1</span><span class="op" id="5664753">]</span><span class="op" id="5664754">[</span><span class="ident" id="5664755">maxTh</span>&nbsp;<span class="op" id="5664761">+</span>&nbsp;<span class="num" id="5664763">1</span><span class="op" id="5664764">]</span><span class="ident" id="5664765">huffman</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5664774">quant</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5664788">[</span><span class="ident" id="5664789">maxTq</span>&nbsp;<span class="op" id="5664795">+</span>&nbsp;<span class="num" id="5664797">1</span><span class="op" id="5664798">]</span><span class="ident" id="5664799">block</span>&nbsp;<span class="comment" id="5664805">//&nbsp;Quantization&nbsp;tables,&nbsp;in&nbsp;zig-zag&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5664848">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5664862">[</span><span class="ident" id="5664863">blockSize</span>&nbsp;<span class="op" id="5664873">+</span>&nbsp;<span class="num" id="5664875">1</span><span class="op" id="5664876">]</span><span class="builtintype" id="5664877">byte</span><br>
<span class="lineno"></span><span class="op" id="5664882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="5664885">//&nbsp;fill&nbsp;fills&nbsp;up&nbsp;the&nbsp;d.bytes.buf&nbsp;buffer&nbsp;from&nbsp;the&nbsp;underlying&nbsp;io.Reader.&nbsp;It</span><br>
<span class="lineno"></span><span class="comment" id="5664959">//&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;there&nbsp;are&nbsp;no&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;d.bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5665027">func</span>&nbsp;<span class="op" id="5665032">(</span><span class="ident" id="5665033">d</span>&nbsp;<span class="op" id="5665035">*</span><span class="ident" id="5665036">decoder</span><span class="op" id="5665043">)</span>&nbsp;<span class="ident" id="5665045">fill</span><span class="op" id="5665049">(</span><span class="op" id="5665050">)</span>&nbsp;<span class="builtintype" id="5665052">error</span>&nbsp;<span class="op" id="5665058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5665061">if</span>&nbsp;<span class="ident" id="5665064">d</span><span class="op" id="5665065">.</span><span class="ident" id="5665066">bytes</span><span class="op" id="5665071">.</span><span class="ident" id="5665072">i</span>&nbsp;<span class="op" id="5665074">!=</span>&nbsp;<span class="ident" id="5665077">d</span><span class="op" id="5665078">.</span><span class="ident" id="5665079">bytes</span><span class="op" id="5665084">.</span><span class="ident" id="5665085">j</span>&nbsp;<span class="op" id="5665087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5665091">panic</span><span class="op" id="5665096">(</span><span class="string" id="5665097">&#34;jpeg:&nbsp;fill&nbsp;called&nbsp;when&nbsp;unread&nbsp;bytes&nbsp;exist&#34;</span><span class="op" id="5665140">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5665143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5665146">//&nbsp;Move&nbsp;the&nbsp;last&nbsp;2&nbsp;bytes&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer,&nbsp;in&nbsp;case&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5665216">//&nbsp;to&nbsp;call&nbsp;unreadByteStuffedByte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5665251">if</span>&nbsp;<span class="ident" id="5665254">d</span><span class="op" id="5665255">.</span><span class="ident" id="5665256">bytes</span><span class="op" id="5665261">.</span><span class="ident" id="5665262">j</span>&nbsp;<span class="op" id="5665264">&gt;</span>&nbsp;<span class="num" id="5665266">2</span>&nbsp;<span class="op" id="5665268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5665272">d</span><span class="op" id="5665273">.</span><span class="ident" id="5665274">bytes</span><span class="op" id="5665279">.</span><span class="ident" id="5665280">buf</span><span class="op" id="5665283">[</span><span class="num" id="5665284">0</span><span class="op" id="5665285">]</span>&nbsp;<span class="op" id="5665287">=</span>&nbsp;<span class="ident" id="5665289">d</span><span class="op" id="5665290">.</span><span class="ident" id="5665291">bytes</span><span class="op" id="5665296">.</span><span class="ident" id="5665297">buf</span><span class="op" id="5665300">[</span><span class="ident" id="5665301">d</span><span class="op" id="5665302">.</span><span class="ident" id="5665303">bytes</span><span class="op" id="5665308">.</span><span class="ident" id="5665309">j</span><span class="op" id="5665310">-</span><span class="num" id="5665311">2</span><span class="op" id="5665312">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5665316">d</span><span class="op" id="5665317">.</span><span class="ident" id="5665318">bytes</span><span class="op" id="5665323">.</span><span class="ident" id="5665324">buf</span><span class="op" id="5665327">[</span><span class="num" id="5665328">1</span><span class="op" id="5665329">]</span>&nbsp;<span class="op" id="5665331">=</span>&nbsp;<span class="ident" id="5665333">d</span><span class="op" id="5665334">.</span><span class="ident" id="5665335">bytes</span><span class="op" id="5665340">.</span><span class="ident" id="5665341">buf</span><span class="op" id="5665344">[</span><span class="ident" id="5665345">d</span><span class="op" id="5665346">.</span><span class="ident" id="5665347">bytes</span><span class="op" id="5665352">.</span><span class="ident" id="5665353">j</span><span class="op" id="5665354">-</span><span class="num" id="5665355">1</span><span class="op" id="5665356">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5665360">d</span><span class="op" id="5665361">.</span><span class="ident" id="5665362">bytes</span><span class="op" id="5665367">.</span><span class="ident" id="5665368">i</span><span class="op" id="5665369">,</span>&nbsp;<span class="ident" id="5665371">d</span><span class="op" id="5665372">.</span><span class="ident" id="5665373">bytes</span><span class="op" id="5665378">.</span><span class="ident" id="5665379">j</span>&nbsp;<span class="op" id="5665381">=</span>&nbsp;<span class="num" id="5665383">2</span><span class="op" id="5665384">,</span>&nbsp;<span class="num" id="5665386">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5665389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5665392">//&nbsp;Fill&nbsp;in&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5665428">n</span><span class="op" id="5665429">,</span>&nbsp;<span class="ident" id="5665431">err</span>&nbsp;<span class="op" id="5665435">:=</span>&nbsp;<span class="ident" id="5665438">d</span><span class="op" id="5665439">.</span><span class="ident" id="5665440">r</span><span class="op" id="5665441">.</span><span class="ident" id="5665442">Read</span><span class="op" id="5665446">(</span><span class="ident" id="5665447">d</span><span class="op" id="5665448">.</span><span class="ident" id="5665449">bytes</span><span class="op" id="5665454">.</span><span class="ident" id="5665455">buf</span><span class="op" id="5665458">[</span><span class="ident" id="5665459">d</span><span class="op" id="5665460">.</span><span class="ident" id="5665461">bytes</span><span class="op" id="5665466">.</span><span class="ident" id="5665467">j</span><span class="op" id="5665468">:</span><span class="op" id="5665469">]</span><span class="op" id="5665470">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5665473">d</span><span class="op" id="5665474">.</span><span class="ident" id="5665475">bytes</span><span class="op" id="5665480">.</span><span class="ident" id="5665481">j</span>&nbsp;<span class="op" id="5665483">+=</span>&nbsp;<span class="ident" id="5665486">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5665489">if</span>&nbsp;<span class="ident" id="5665492">n</span>&nbsp;<span class="op" id="5665494">&gt;</span>&nbsp;<span class="num" id="5665496">0</span>&nbsp;<span class="op" id="5665498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5665502">err</span>&nbsp;<span class="op" id="5665506">=</span>&nbsp;<span class="ident" id="5665508">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5665513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5665516">return</span>&nbsp;<span class="ident" id="5665523">err</span><br>
<span class="lineno">150</span><span class="op" id="5665527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5665530">//&nbsp;unreadByteStuffedByte&nbsp;undoes&nbsp;the&nbsp;most&nbsp;recent&nbsp;readByteStuffedByte&nbsp;call,</span><br>
<span class="lineno"></span><span class="comment" id="5665604">//&nbsp;giving&nbsp;a&nbsp;byte&nbsp;of&nbsp;data&nbsp;back&nbsp;from&nbsp;d.bits&nbsp;to&nbsp;d.bytes.&nbsp;The&nbsp;Huffman&nbsp;look-up&nbsp;table</span><br>
<span class="lineno"></span><span class="comment" id="5665684">//&nbsp;requires&nbsp;at&nbsp;least&nbsp;8&nbsp;bits&nbsp;for&nbsp;look-up,&nbsp;which&nbsp;means&nbsp;that&nbsp;Huffman&nbsp;decoding&nbsp;can</span><br>
<span class="lineno">155</span><span class="comment" id="5665763">//&nbsp;sometimes&nbsp;overshoot&nbsp;and&nbsp;read&nbsp;one&nbsp;or&nbsp;two&nbsp;too&nbsp;many&nbsp;bytes.&nbsp;Two-byte&nbsp;overshoot</span><br>
<span class="lineno"></span><span class="comment" id="5665841">//&nbsp;can&nbsp;happen&nbsp;when&nbsp;expecting&nbsp;to&nbsp;read&nbsp;a&nbsp;0xff&nbsp;0x00&nbsp;byte-stuffed&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="5665909">func</span>&nbsp;<span class="op" id="5665914">(</span><span class="ident" id="5665915">d</span>&nbsp;<span class="op" id="5665917">*</span><span class="ident" id="5665918">decoder</span><span class="op" id="5665925">)</span>&nbsp;<span class="ident" id="5665927">unreadByteStuffedByte</span><span class="op" id="5665948">(</span><span class="op" id="5665949">)</span>&nbsp;<span class="op" id="5665951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5665954">if</span>&nbsp;<span class="ident" id="5665957">d</span><span class="op" id="5665958">.</span><span class="ident" id="5665959">bytes</span><span class="op" id="5665964">.</span><span class="ident" id="5665965">nUnreadable</span>&nbsp;<span class="op" id="5665977">==</span>&nbsp;<span class="num" id="5665980">0</span>&nbsp;<span class="op" id="5665982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5665986">panic</span><span class="op" id="5665991">(</span><span class="string" id="5665992">&#34;jpeg:&nbsp;unreadByteStuffedByte&nbsp;call&nbsp;cannot&nbsp;be&nbsp;fulfilled&#34;</span><span class="op" id="5666046">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5666049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5666052">d</span><span class="op" id="5666053">.</span><span class="ident" id="5666054">bytes</span><span class="op" id="5666059">.</span><span class="ident" id="5666060">i</span>&nbsp;<span class="op" id="5666062">-=</span>&nbsp;<span class="ident" id="5666065">d</span><span class="op" id="5666066">.</span><span class="ident" id="5666067">bytes</span><span class="op" id="5666072">.</span><span class="ident" id="5666073">nUnreadable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5666086">d</span><span class="op" id="5666087">.</span><span class="ident" id="5666088">bytes</span><span class="op" id="5666093">.</span><span class="ident" id="5666094">nUnreadable</span>&nbsp;<span class="op" id="5666106">=</span>&nbsp;<span class="num" id="5666108">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5666111">if</span>&nbsp;<span class="ident" id="5666114">d</span><span class="op" id="5666115">.</span><span class="ident" id="5666116">bits</span><span class="op" id="5666120">.</span><span class="ident" id="5666121">n</span>&nbsp;<span class="op" id="5666123">&gt;=</span>&nbsp;<span class="num" id="5666126">8</span>&nbsp;<span class="op" id="5666128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5666132">d</span><span class="op" id="5666133">.</span><span class="ident" id="5666134">bits</span><span class="op" id="5666138">.</span><span class="ident" id="5666139">a</span>&nbsp;<span class="op" id="5666141">&gt;&gt;=</span>&nbsp;<span class="num" id="5666145">8</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5666149">d</span><span class="op" id="5666150">.</span><span class="ident" id="5666151">bits</span><span class="op" id="5666155">.</span><span class="ident" id="5666156">n</span>&nbsp;<span class="op" id="5666158">-=</span>&nbsp;<span class="num" id="5666161">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5666165">d</span><span class="op" id="5666166">.</span><span class="ident" id="5666167">bits</span><span class="op" id="5666171">.</span><span class="ident" id="5666172">m</span>&nbsp;<span class="op" id="5666174">&gt;&gt;=</span>&nbsp;<span class="num" id="5666178">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5666181">}</span><br>
<span class="lineno"></span><span class="op" id="5666183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="5666186">//&nbsp;readByte&nbsp;returns&nbsp;the&nbsp;next&nbsp;byte,&nbsp;whether&nbsp;buffered&nbsp;or&nbsp;not&nbsp;buffered.&nbsp;It&nbsp;does</span><br>
<span class="lineno"></span><span class="comment" id="5666263">//&nbsp;not&nbsp;care&nbsp;about&nbsp;byte&nbsp;stuffing.</span><br>
<span class="lineno"></span><span class="keyword" id="5666296">func</span>&nbsp;<span class="op" id="5666301">(</span><span class="ident" id="5666302">d</span>&nbsp;<span class="op" id="5666304">*</span><span class="ident" id="5666305">decoder</span><span class="op" id="5666312">)</span>&nbsp;<span class="ident" id="5666314">readByte</span><span class="op" id="5666322">(</span><span class="op" id="5666323">)</span>&nbsp;<span class="op" id="5666325">(</span><span class="ident" id="5666326">x</span>&nbsp;<span class="builtintype" id="5666328">byte</span><span class="op" id="5666332">,</span>&nbsp;<span class="ident" id="5666334">err</span>&nbsp;<span class="builtintype" id="5666338">error</span><span class="op" id="5666343">)</span>&nbsp;<span class="op" id="5666345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5666348">for</span>&nbsp;<span class="ident" id="5666352">d</span><span class="op" id="5666353">.</span><span class="ident" id="5666354">bytes</span><span class="op" id="5666359">.</span><span class="ident" id="5666360">i</span>&nbsp;<span class="op" id="5666362">==</span>&nbsp;<span class="ident" id="5666365">d</span><span class="op" id="5666366">.</span><span class="ident" id="5666367">bytes</span><span class="op" id="5666372">.</span><span class="ident" id="5666373">j</span>&nbsp;<span class="op" id="5666375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5666379">if</span>&nbsp;<span class="ident" id="5666382">err</span>&nbsp;<span class="op" id="5666386">=</span>&nbsp;<span class="ident" id="5666388">d</span><span class="op" id="5666389">.</span><span class="ident" id="5666390">fill</span><span class="op" id="5666394">(</span><span class="op" id="5666395">)</span><span class="op" id="5666396">;</span>&nbsp;<span class="ident" id="5666398">err</span>&nbsp;<span class="op" id="5666402">!=</span>&nbsp;<span class="ident" id="5666405">nil</span>&nbsp;<span class="op" id="5666409">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5666414">return</span>&nbsp;<span class="num" id="5666421">0</span><span class="op" id="5666422">,</span>&nbsp;<span class="ident" id="5666424">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5666430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5666433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5666436">x</span>&nbsp;<span class="op" id="5666438">=</span>&nbsp;<span class="ident" id="5666440">d</span><span class="op" id="5666441">.</span><span class="ident" id="5666442">bytes</span><span class="op" id="5666447">.</span><span class="ident" id="5666448">buf</span><span class="op" id="5666451">[</span><span class="ident" id="5666452">d</span><span class="op" id="5666453">.</span><span class="ident" id="5666454">bytes</span><span class="op" id="5666459">.</span><span class="ident" id="5666460">i</span><span class="op" id="5666461">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5666464">d</span><span class="op" id="5666465">.</span><span class="ident" id="5666466">bytes</span><span class="op" id="5666471">.</span><span class="ident" id="5666472">i</span><span class="op" id="5666473">++</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5666477">d</span><span class="op" id="5666478">.</span><span class="ident" id="5666479">bytes</span><span class="op" id="5666484">.</span><span class="ident" id="5666485">nUnreadable</span>&nbsp;<span class="op" id="5666497">=</span>&nbsp;<span class="num" id="5666499">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5666502">return</span>&nbsp;<span class="ident" id="5666509">x</span><span class="op" id="5666510">,</span>&nbsp;<span class="ident" id="5666512">nil</span><br>
<span class="lineno"></span><span class="op" id="5666516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5666519">//&nbsp;errMissingFF00&nbsp;means&nbsp;that&nbsp;readByteStuffedByte&nbsp;encountered&nbsp;an&nbsp;0xff&nbsp;byte&nbsp;(a</span><br>
<span class="lineno">185</span><span class="comment" id="5666596">//&nbsp;marker&nbsp;byte)&nbsp;that&nbsp;wasn&#39;t&nbsp;the&nbsp;expected&nbsp;byte-stuffed&nbsp;sequence&nbsp;0xff,&nbsp;0x00.</span><br>
<span class="lineno"></span><span class="keyword" id="5666671">var</span>&nbsp;<span class="ident" id="5666675">errMissingFF00</span>&nbsp;<span class="op" id="5666690">=</span>&nbsp;<span class="ident" id="5666692">FormatError</span><span class="op" id="5666703">(</span><span class="string" id="5666704">&#34;missing&nbsp;0xff00&nbsp;sequence&#34;</span><span class="op" id="5666729">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5666732">//&nbsp;readByteStuffedByte&nbsp;is&nbsp;like&nbsp;readByte&nbsp;but&nbsp;is&nbsp;for&nbsp;byte-stuffed&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5666810">func</span>&nbsp;<span class="op" id="5666815">(</span><span class="ident" id="5666816">d</span>&nbsp;<span class="op" id="5666818">*</span><span class="ident" id="5666819">decoder</span><span class="op" id="5666826">)</span>&nbsp;<span class="ident" id="5666828">readByteStuffedByte</span><span class="op" id="5666847">(</span><span class="op" id="5666848">)</span>&nbsp;<span class="op" id="5666850">(</span><span class="ident" id="5666851">x</span>&nbsp;<span class="builtintype" id="5666853">byte</span><span class="op" id="5666857">,</span>&nbsp;<span class="ident" id="5666859">err</span>&nbsp;<span class="builtintype" id="5666863">error</span><span class="op" id="5666868">)</span>&nbsp;<span class="op" id="5666870">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5666873">//&nbsp;Take&nbsp;the&nbsp;fast&nbsp;path&nbsp;if&nbsp;d.bytes.buf&nbsp;contains&nbsp;at&nbsp;least&nbsp;two&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5666940">if</span>&nbsp;<span class="ident" id="5666943">d</span><span class="op" id="5666944">.</span><span class="ident" id="5666945">bytes</span><span class="op" id="5666950">.</span><span class="ident" id="5666951">i</span><span class="op" id="5666952">+</span><span class="num" id="5666953">2</span>&nbsp;<span class="op" id="5666955">&lt;=</span>&nbsp;<span class="ident" id="5666958">d</span><span class="op" id="5666959">.</span><span class="ident" id="5666960">bytes</span><span class="op" id="5666965">.</span><span class="ident" id="5666966">j</span>&nbsp;<span class="op" id="5666968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5666972">x</span>&nbsp;<span class="op" id="5666974">=</span>&nbsp;<span class="ident" id="5666976">d</span><span class="op" id="5666977">.</span><span class="ident" id="5666978">bytes</span><span class="op" id="5666983">.</span><span class="ident" id="5666984">buf</span><span class="op" id="5666987">[</span><span class="ident" id="5666988">d</span><span class="op" id="5666989">.</span><span class="ident" id="5666990">bytes</span><span class="op" id="5666995">.</span><span class="ident" id="5666996">i</span><span class="op" id="5666997">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5667001">d</span><span class="op" id="5667002">.</span><span class="ident" id="5667003">bytes</span><span class="op" id="5667008">.</span><span class="ident" id="5667009">i</span><span class="op" id="5667010">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5667015">d</span><span class="op" id="5667016">.</span><span class="ident" id="5667017">bytes</span><span class="op" id="5667022">.</span><span class="ident" id="5667023">nUnreadable</span>&nbsp;<span class="op" id="5667035">=</span>&nbsp;<span class="num" id="5667037">1</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667041">if</span>&nbsp;<span class="ident" id="5667044">x</span>&nbsp;<span class="op" id="5667046">!=</span>&nbsp;<span class="num" id="5667049">0xff</span>&nbsp;<span class="op" id="5667054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667059">return</span>&nbsp;<span class="ident" id="5667066">x</span><span class="op" id="5667067">,</span>&nbsp;<span class="ident" id="5667069">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5667075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667079">if</span>&nbsp;<span class="ident" id="5667082">d</span><span class="op" id="5667083">.</span><span class="ident" id="5667084">bytes</span><span class="op" id="5667089">.</span><span class="ident" id="5667090">buf</span><span class="op" id="5667093">[</span><span class="ident" id="5667094">d</span><span class="op" id="5667095">.</span><span class="ident" id="5667096">bytes</span><span class="op" id="5667101">.</span><span class="ident" id="5667102">i</span><span class="op" id="5667103">]</span>&nbsp;<span class="op" id="5667105">!=</span>&nbsp;<span class="num" id="5667108">0x00</span>&nbsp;<span class="op" id="5667113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667118">return</span>&nbsp;<span class="num" id="5667125">0</span><span class="op" id="5667126">,</span>&nbsp;<span class="ident" id="5667128">errMissingFF00</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5667145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5667149">d</span><span class="op" id="5667150">.</span><span class="ident" id="5667151">bytes</span><span class="op" id="5667156">.</span><span class="ident" id="5667157">i</span><span class="op" id="5667158">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5667163">d</span><span class="op" id="5667164">.</span><span class="ident" id="5667165">bytes</span><span class="op" id="5667170">.</span><span class="ident" id="5667171">nUnreadable</span>&nbsp;<span class="op" id="5667183">=</span>&nbsp;<span class="num" id="5667185">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667189">return</span>&nbsp;<span class="num" id="5667196">0xff</span><span class="op" id="5667200">,</span>&nbsp;<span class="ident" id="5667202">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5667207">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5667211">x</span><span class="op" id="5667212">,</span>&nbsp;<span class="ident" id="5667214">err</span>&nbsp;<span class="op" id="5667218">=</span>&nbsp;<span class="ident" id="5667220">d</span><span class="op" id="5667221">.</span><span class="ident" id="5667222">readByte</span><span class="op" id="5667230">(</span><span class="op" id="5667231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667234">if</span>&nbsp;<span class="ident" id="5667237">err</span>&nbsp;<span class="op" id="5667241">!=</span>&nbsp;<span class="ident" id="5667244">nil</span>&nbsp;<span class="op" id="5667248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667252">return</span>&nbsp;<span class="num" id="5667259">0</span><span class="op" id="5667260">,</span>&nbsp;<span class="ident" id="5667262">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5667267">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667270">if</span>&nbsp;<span class="ident" id="5667273">x</span>&nbsp;<span class="op" id="5667275">!=</span>&nbsp;<span class="num" id="5667278">0xff</span>&nbsp;<span class="op" id="5667283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5667287">d</span><span class="op" id="5667288">.</span><span class="ident" id="5667289">bytes</span><span class="op" id="5667294">.</span><span class="ident" id="5667295">nUnreadable</span>&nbsp;<span class="op" id="5667307">=</span>&nbsp;<span class="num" id="5667309">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667313">return</span>&nbsp;<span class="ident" id="5667320">x</span><span class="op" id="5667321">,</span>&nbsp;<span class="ident" id="5667323">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5667328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5667332">x</span><span class="op" id="5667333">,</span>&nbsp;<span class="ident" id="5667335">err</span>&nbsp;<span class="op" id="5667339">=</span>&nbsp;<span class="ident" id="5667341">d</span><span class="op" id="5667342">.</span><span class="ident" id="5667343">readByte</span><span class="op" id="5667351">(</span><span class="op" id="5667352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667355">if</span>&nbsp;<span class="ident" id="5667358">err</span>&nbsp;<span class="op" id="5667362">!=</span>&nbsp;<span class="ident" id="5667365">nil</span>&nbsp;<span class="op" id="5667369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5667373">d</span><span class="op" id="5667374">.</span><span class="ident" id="5667375">bytes</span><span class="op" id="5667380">.</span><span class="ident" id="5667381">nUnreadable</span>&nbsp;<span class="op" id="5667393">=</span>&nbsp;<span class="num" id="5667395">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667399">return</span>&nbsp;<span class="num" id="5667406">0</span><span class="op" id="5667407">,</span>&nbsp;<span class="ident" id="5667409">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5667414">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5667417">d</span><span class="op" id="5667418">.</span><span class="ident" id="5667419">bytes</span><span class="op" id="5667424">.</span><span class="ident" id="5667425">nUnreadable</span>&nbsp;<span class="op" id="5667437">=</span>&nbsp;<span class="num" id="5667439">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667442">if</span>&nbsp;<span class="ident" id="5667445">x</span>&nbsp;<span class="op" id="5667447">!=</span>&nbsp;<span class="num" id="5667450">0x00</span>&nbsp;<span class="op" id="5667455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667459">return</span>&nbsp;<span class="num" id="5667466">0</span><span class="op" id="5667467">,</span>&nbsp;<span class="ident" id="5667469">errMissingFF00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5667485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667488">return</span>&nbsp;<span class="num" id="5667495">0xff</span><span class="op" id="5667499">,</span>&nbsp;<span class="ident" id="5667501">nil</span><br>
<span class="lineno">225</span><span class="op" id="5667505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5667508">//&nbsp;readFull&nbsp;reads&nbsp;exactly&nbsp;len(p)&nbsp;bytes&nbsp;into&nbsp;p.&nbsp;It&nbsp;does&nbsp;not&nbsp;care&nbsp;about&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="5667583">//&nbsp;stuffing.</span><br>
<span class="lineno"></span><span class="keyword" id="5667596">func</span>&nbsp;<span class="op" id="5667601">(</span><span class="ident" id="5667602">d</span>&nbsp;<span class="op" id="5667604">*</span><span class="ident" id="5667605">decoder</span><span class="op" id="5667612">)</span>&nbsp;<span class="ident" id="5667614">readFull</span><span class="op" id="5667622">(</span><span class="ident" id="5667623">p</span>&nbsp;<span class="op" id="5667625">[</span><span class="op" id="5667626">]</span><span class="builtintype" id="5667627">byte</span><span class="op" id="5667631">)</span>&nbsp;<span class="builtintype" id="5667633">error</span>&nbsp;<span class="op" id="5667639">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5667642">//&nbsp;Unread&nbsp;the&nbsp;overshot&nbsp;bytes,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667681">if</span>&nbsp;<span class="ident" id="5667684">d</span><span class="op" id="5667685">.</span><span class="ident" id="5667686">bytes</span><span class="op" id="5667691">.</span><span class="ident" id="5667692">nUnreadable</span>&nbsp;<span class="op" id="5667704">!=</span>&nbsp;<span class="num" id="5667707">0</span>&nbsp;<span class="op" id="5667709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667713">if</span>&nbsp;<span class="ident" id="5667716">d</span><span class="op" id="5667717">.</span><span class="ident" id="5667718">bits</span><span class="op" id="5667722">.</span><span class="ident" id="5667723">n</span>&nbsp;<span class="op" id="5667725">&gt;=</span>&nbsp;<span class="num" id="5667728">8</span>&nbsp;<span class="op" id="5667730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5667735">d</span><span class="op" id="5667736">.</span><span class="ident" id="5667737">unreadByteStuffedByte</span><span class="op" id="5667758">(</span><span class="op" id="5667759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5667763">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5667767">d</span><span class="op" id="5667768">.</span><span class="ident" id="5667769">bytes</span><span class="op" id="5667774">.</span><span class="ident" id="5667775">nUnreadable</span>&nbsp;<span class="op" id="5667787">=</span>&nbsp;<span class="num" id="5667789">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5667792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667796">for</span>&nbsp;<span class="op" id="5667800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5667804">n</span>&nbsp;<span class="op" id="5667806">:=</span>&nbsp;<span class="builtinfunc" id="5667809">copy</span><span class="op" id="5667813">(</span><span class="ident" id="5667814">p</span><span class="op" id="5667815">,</span>&nbsp;<span class="ident" id="5667817">d</span><span class="op" id="5667818">.</span><span class="ident" id="5667819">bytes</span><span class="op" id="5667824">.</span><span class="ident" id="5667825">buf</span><span class="op" id="5667828">[</span><span class="ident" id="5667829">d</span><span class="op" id="5667830">.</span><span class="ident" id="5667831">bytes</span><span class="op" id="5667836">.</span><span class="ident" id="5667837">i</span><span class="op" id="5667838">:</span><span class="ident" id="5667839">d</span><span class="op" id="5667840">.</span><span class="ident" id="5667841">bytes</span><span class="op" id="5667846">.</span><span class="ident" id="5667847">j</span><span class="op" id="5667848">]</span><span class="op" id="5667849">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5667853">p</span>&nbsp;<span class="op" id="5667855">=</span>&nbsp;<span class="ident" id="5667857">p</span><span class="op" id="5667858">[</span><span class="ident" id="5667859">n</span><span class="op" id="5667860">:</span><span class="op" id="5667861">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5667865">d</span><span class="op" id="5667866">.</span><span class="ident" id="5667867">bytes</span><span class="op" id="5667872">.</span><span class="ident" id="5667873">i</span>&nbsp;<span class="op" id="5667875">+=</span>&nbsp;<span class="ident" id="5667878">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667882">if</span>&nbsp;<span class="builtinfunc" id="5667885">len</span><span class="op" id="5667888">(</span><span class="ident" id="5667889">p</span><span class="op" id="5667890">)</span>&nbsp;<span class="op" id="5667892">==</span>&nbsp;<span class="num" id="5667895">0</span>&nbsp;<span class="op" id="5667897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667902">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5667910">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667914">if</span>&nbsp;<span class="ident" id="5667917">err</span>&nbsp;<span class="op" id="5667921">:=</span>&nbsp;<span class="ident" id="5667924">d</span><span class="op" id="5667925">.</span><span class="ident" id="5667926">fill</span><span class="op" id="5667930">(</span><span class="op" id="5667931">)</span><span class="op" id="5667932">;</span>&nbsp;<span class="ident" id="5667934">err</span>&nbsp;<span class="op" id="5667938">!=</span>&nbsp;<span class="ident" id="5667941">nil</span>&nbsp;<span class="op" id="5667945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5667950">if</span>&nbsp;<span class="ident" id="5667953">err</span>&nbsp;<span class="op" id="5667957">==</span>&nbsp;<span class="ident" id="5667960">io</span><span class="op" id="5667962">.</span><span class="ident" id="5667963">EOF</span>&nbsp;<span class="op" id="5667967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5667973">err</span>&nbsp;<span class="op" id="5667977">=</span>&nbsp;<span class="ident" id="5667979">io</span><span class="op" id="5667981">.</span><span class="ident" id="5667982">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5668002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668007">return</span>&nbsp;<span class="ident" id="5668014">err</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5668020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5668023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668026">return</span>&nbsp;<span class="ident" id="5668033">nil</span><br>
<span class="lineno"></span><span class="op" id="5668037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="5668040">//&nbsp;ignore&nbsp;ignores&nbsp;the&nbsp;next&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5668076">func</span>&nbsp;<span class="op" id="5668081">(</span><span class="ident" id="5668082">d</span>&nbsp;<span class="op" id="5668084">*</span><span class="ident" id="5668085">decoder</span><span class="op" id="5668092">)</span>&nbsp;<span class="ident" id="5668094">ignore</span><span class="op" id="5668100">(</span><span class="ident" id="5668101">n</span>&nbsp;<span class="builtintype" id="5668103">int</span><span class="op" id="5668106">)</span>&nbsp;<span class="builtintype" id="5668108">error</span>&nbsp;<span class="op" id="5668114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5668117">//&nbsp;Unread&nbsp;the&nbsp;overshot&nbsp;bytes,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668156">if</span>&nbsp;<span class="ident" id="5668159">d</span><span class="op" id="5668160">.</span><span class="ident" id="5668161">bytes</span><span class="op" id="5668166">.</span><span class="ident" id="5668167">nUnreadable</span>&nbsp;<span class="op" id="5668179">!=</span>&nbsp;<span class="num" id="5668182">0</span>&nbsp;<span class="op" id="5668184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668188">if</span>&nbsp;<span class="ident" id="5668191">d</span><span class="op" id="5668192">.</span><span class="ident" id="5668193">bits</span><span class="op" id="5668197">.</span><span class="ident" id="5668198">n</span>&nbsp;<span class="op" id="5668200">&gt;=</span>&nbsp;<span class="num" id="5668203">8</span>&nbsp;<span class="op" id="5668205">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5668210">d</span><span class="op" id="5668211">.</span><span class="ident" id="5668212">unreadByteStuffedByte</span><span class="op" id="5668233">(</span><span class="op" id="5668234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5668238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5668242">d</span><span class="op" id="5668243">.</span><span class="ident" id="5668244">bytes</span><span class="op" id="5668249">.</span><span class="ident" id="5668250">nUnreadable</span>&nbsp;<span class="op" id="5668262">=</span>&nbsp;<span class="num" id="5668264">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5668267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668271">for</span>&nbsp;<span class="op" id="5668275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5668279">m</span>&nbsp;<span class="op" id="5668281">:=</span>&nbsp;<span class="ident" id="5668284">d</span><span class="op" id="5668285">.</span><span class="ident" id="5668286">bytes</span><span class="op" id="5668291">.</span><span class="ident" id="5668292">j</span>&nbsp;<span class="op" id="5668294">-</span>&nbsp;<span class="ident" id="5668296">d</span><span class="op" id="5668297">.</span><span class="ident" id="5668298">bytes</span><span class="op" id="5668303">.</span><span class="ident" id="5668304">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668308">if</span>&nbsp;<span class="ident" id="5668311">m</span>&nbsp;<span class="op" id="5668313">&gt;</span>&nbsp;<span class="ident" id="5668315">n</span>&nbsp;<span class="op" id="5668317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5668322">m</span>&nbsp;<span class="op" id="5668324">=</span>&nbsp;<span class="ident" id="5668326">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5668330">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5668334">d</span><span class="op" id="5668335">.</span><span class="ident" id="5668336">bytes</span><span class="op" id="5668341">.</span><span class="ident" id="5668342">i</span>&nbsp;<span class="op" id="5668344">+=</span>&nbsp;<span class="ident" id="5668347">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5668351">n</span>&nbsp;<span class="op" id="5668353">-=</span>&nbsp;<span class="ident" id="5668356">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668360">if</span>&nbsp;<span class="ident" id="5668363">n</span>&nbsp;<span class="op" id="5668365">==</span>&nbsp;<span class="num" id="5668368">0</span>&nbsp;<span class="op" id="5668370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668375">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5668383">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668387">if</span>&nbsp;<span class="ident" id="5668390">err</span>&nbsp;<span class="op" id="5668394">:=</span>&nbsp;<span class="ident" id="5668397">d</span><span class="op" id="5668398">.</span><span class="ident" id="5668399">fill</span><span class="op" id="5668403">(</span><span class="op" id="5668404">)</span><span class="op" id="5668405">;</span>&nbsp;<span class="ident" id="5668407">err</span>&nbsp;<span class="op" id="5668411">!=</span>&nbsp;<span class="ident" id="5668414">nil</span>&nbsp;<span class="op" id="5668418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668423">if</span>&nbsp;<span class="ident" id="5668426">err</span>&nbsp;<span class="op" id="5668430">==</span>&nbsp;<span class="ident" id="5668433">io</span><span class="op" id="5668435">.</span><span class="ident" id="5668436">EOF</span>&nbsp;<span class="op" id="5668440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5668446">err</span>&nbsp;<span class="op" id="5668450">=</span>&nbsp;<span class="ident" id="5668452">io</span><span class="op" id="5668454">.</span><span class="ident" id="5668455">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5668475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668480">return</span>&nbsp;<span class="ident" id="5668487">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5668493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5668496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668499">return</span>&nbsp;<span class="ident" id="5668506">nil</span><br>
<span class="lineno"></span><span class="op" id="5668510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="5668513">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.2.</span><br>
<span class="lineno"></span><span class="keyword" id="5668544">func</span>&nbsp;<span class="op" id="5668549">(</span><span class="ident" id="5668550">d</span>&nbsp;<span class="op" id="5668552">*</span><span class="ident" id="5668553">decoder</span><span class="op" id="5668560">)</span>&nbsp;<span class="ident" id="5668562">processSOF</span><span class="op" id="5668572">(</span><span class="ident" id="5668573">n</span>&nbsp;<span class="builtintype" id="5668575">int</span><span class="op" id="5668578">)</span>&nbsp;<span class="builtintype" id="5668580">error</span>&nbsp;<span class="op" id="5668586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668589">switch</span>&nbsp;<span class="ident" id="5668596">n</span>&nbsp;<span class="op" id="5668598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668601">case</span>&nbsp;<span class="num" id="5668606">6</span>&nbsp;<span class="op" id="5668608">+</span>&nbsp;<span class="num" id="5668610">3</span><span class="op" id="5668611">*</span><span class="ident" id="5668612">nGrayComponent</span><span class="op" id="5668626">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5668630">d</span><span class="op" id="5668631">.</span><span class="ident" id="5668632">nComp</span>&nbsp;<span class="op" id="5668638">=</span>&nbsp;<span class="ident" id="5668640">nGrayComponent</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668656">case</span>&nbsp;<span class="num" id="5668661">6</span>&nbsp;<span class="op" id="5668663">+</span>&nbsp;<span class="num" id="5668665">3</span><span class="op" id="5668666">*</span><span class="ident" id="5668667">nColorComponent</span><span class="op" id="5668682">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5668686">d</span><span class="op" id="5668687">.</span><span class="ident" id="5668688">nComp</span>&nbsp;<span class="op" id="5668694">=</span>&nbsp;<span class="ident" id="5668696">nColorComponent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668713">default</span><span class="op" id="5668720">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668724">return</span>&nbsp;<span class="ident" id="5668731">UnsupportedError</span><span class="op" id="5668747">(</span><span class="string" id="5668748">&#34;SOF&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5668770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5668773">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668776">if</span>&nbsp;<span class="ident" id="5668779">err</span>&nbsp;<span class="op" id="5668783">:=</span>&nbsp;<span class="ident" id="5668786">d</span><span class="op" id="5668787">.</span><span class="ident" id="5668788">readFull</span><span class="op" id="5668796">(</span><span class="ident" id="5668797">d</span><span class="op" id="5668798">.</span><span class="ident" id="5668799">tmp</span><span class="op" id="5668802">[</span><span class="op" id="5668803">:</span><span class="ident" id="5668804">n</span><span class="op" id="5668805">]</span><span class="op" id="5668806">)</span><span class="op" id="5668807">;</span>&nbsp;<span class="ident" id="5668809">err</span>&nbsp;<span class="op" id="5668813">!=</span>&nbsp;<span class="ident" id="5668816">nil</span>&nbsp;<span class="op" id="5668820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668824">return</span>&nbsp;<span class="ident" id="5668831">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5668836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5668839">//&nbsp;We&nbsp;only&nbsp;support&nbsp;8-bit&nbsp;precision.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668876">if</span>&nbsp;<span class="ident" id="5668879">d</span><span class="op" id="5668880">.</span><span class="ident" id="5668881">tmp</span><span class="op" id="5668884">[</span><span class="num" id="5668885">0</span><span class="op" id="5668886">]</span>&nbsp;<span class="op" id="5668888">!=</span>&nbsp;<span class="num" id="5668891">8</span>&nbsp;<span class="op" id="5668893">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5668897">return</span>&nbsp;<span class="ident" id="5668904">UnsupportedError</span><span class="op" id="5668920">(</span><span class="string" id="5668921">&#34;precision&#34;</span><span class="op" id="5668932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5668935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5668938">d</span><span class="op" id="5668939">.</span><span class="ident" id="5668940">height</span>&nbsp;<span class="op" id="5668947">=</span>&nbsp;<span class="builtintype" id="5668949">int</span><span class="op" id="5668952">(</span><span class="ident" id="5668953">d</span><span class="op" id="5668954">.</span><span class="ident" id="5668955">tmp</span><span class="op" id="5668958">[</span><span class="num" id="5668959">1</span><span class="op" id="5668960">]</span><span class="op" id="5668961">)</span><span class="op" id="5668962">&lt;&lt;</span><span class="num" id="5668964">8</span>&nbsp;<span class="op" id="5668966">+</span>&nbsp;<span class="builtintype" id="5668968">int</span><span class="op" id="5668971">(</span><span class="ident" id="5668972">d</span><span class="op" id="5668973">.</span><span class="ident" id="5668974">tmp</span><span class="op" id="5668977">[</span><span class="num" id="5668978">2</span><span class="op" id="5668979">]</span><span class="op" id="5668980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5668983">d</span><span class="op" id="5668984">.</span><span class="ident" id="5668985">width</span>&nbsp;<span class="op" id="5668991">=</span>&nbsp;<span class="builtintype" id="5668993">int</span><span class="op" id="5668996">(</span><span class="ident" id="5668997">d</span><span class="op" id="5668998">.</span><span class="ident" id="5668999">tmp</span><span class="op" id="5669002">[</span><span class="num" id="5669003">3</span><span class="op" id="5669004">]</span><span class="op" id="5669005">)</span><span class="op" id="5669006">&lt;&lt;</span><span class="num" id="5669008">8</span>&nbsp;<span class="op" id="5669010">+</span>&nbsp;<span class="builtintype" id="5669012">int</span><span class="op" id="5669015">(</span><span class="ident" id="5669016">d</span><span class="op" id="5669017">.</span><span class="ident" id="5669018">tmp</span><span class="op" id="5669021">[</span><span class="num" id="5669022">4</span><span class="op" id="5669023">]</span><span class="op" id="5669024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5669027">if</span>&nbsp;<span class="builtintype" id="5669030">int</span><span class="op" id="5669033">(</span><span class="ident" id="5669034">d</span><span class="op" id="5669035">.</span><span class="ident" id="5669036">tmp</span><span class="op" id="5669039">[</span><span class="num" id="5669040">5</span><span class="op" id="5669041">]</span><span class="op" id="5669042">)</span>&nbsp;<span class="op" id="5669044">!=</span>&nbsp;<span class="ident" id="5669047">d</span><span class="op" id="5669048">.</span><span class="ident" id="5669049">nComp</span>&nbsp;<span class="op" id="5669055">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5669059">return</span>&nbsp;<span class="ident" id="5669066">UnsupportedError</span><span class="op" id="5669082">(</span><span class="string" id="5669083">&#34;SOF&nbsp;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;image&nbsp;components&#34;</span><span class="op" id="5669125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5669128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5669131">for</span>&nbsp;<span class="ident" id="5669135">i</span>&nbsp;<span class="op" id="5669137">:=</span>&nbsp;<span class="num" id="5669140">0</span><span class="op" id="5669141">;</span>&nbsp;<span class="ident" id="5669143">i</span>&nbsp;<span class="op" id="5669145">&lt;</span>&nbsp;<span class="ident" id="5669147">d</span><span class="op" id="5669148">.</span><span class="ident" id="5669149">nComp</span><span class="op" id="5669154">;</span>&nbsp;<span class="ident" id="5669156">i</span><span class="op" id="5669157">++</span>&nbsp;<span class="op" id="5669160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5669164">d</span><span class="op" id="5669165">.</span><span class="ident" id="5669166">comp</span><span class="op" id="5669170">[</span><span class="ident" id="5669171">i</span><span class="op" id="5669172">]</span><span class="op" id="5669173">.</span><span class="ident" id="5669174">c</span>&nbsp;<span class="op" id="5669176">=</span>&nbsp;<span class="ident" id="5669178">d</span><span class="op" id="5669179">.</span><span class="ident" id="5669180">tmp</span><span class="op" id="5669183">[</span><span class="num" id="5669184">6</span><span class="op" id="5669185">+</span><span class="num" id="5669186">3</span><span class="op" id="5669187">*</span><span class="ident" id="5669188">i</span><span class="op" id="5669189">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5669193">d</span><span class="op" id="5669194">.</span><span class="ident" id="5669195">comp</span><span class="op" id="5669199">[</span><span class="ident" id="5669200">i</span><span class="op" id="5669201">]</span><span class="op" id="5669202">.</span><span class="ident" id="5669203">tq</span>&nbsp;<span class="op" id="5669206">=</span>&nbsp;<span class="ident" id="5669208">d</span><span class="op" id="5669209">.</span><span class="ident" id="5669210">tmp</span><span class="op" id="5669213">[</span><span class="num" id="5669214">8</span><span class="op" id="5669215">+</span><span class="num" id="5669216">3</span><span class="op" id="5669217">*</span><span class="ident" id="5669218">i</span><span class="op" id="5669219">]</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5669223">if</span>&nbsp;<span class="ident" id="5669226">d</span><span class="op" id="5669227">.</span><span class="ident" id="5669228">nComp</span>&nbsp;<span class="op" id="5669234">==</span>&nbsp;<span class="ident" id="5669237">nGrayComponent</span>&nbsp;<span class="op" id="5669252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5669257">//&nbsp;If&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;only&nbsp;one&nbsp;component,&nbsp;section&nbsp;A.2&nbsp;says&nbsp;&#34;this&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5669331">//&nbsp;is&nbsp;non-interleaved&nbsp;by&nbsp;definition&#34;&nbsp;and&nbsp;section&nbsp;A.2.2&nbsp;says&nbsp;&#34;[in&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5669404">//&nbsp;case...]&nbsp;the&nbsp;order&nbsp;of&nbsp;data&nbsp;units&nbsp;within&nbsp;a&nbsp;scan&nbsp;shall&nbsp;be&nbsp;left-to-right</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5669480">//&nbsp;and&nbsp;top-to-bottom...&nbsp;regardless&nbsp;of&nbsp;the&nbsp;values&nbsp;of&nbsp;H_1&nbsp;and&nbsp;V_1&#34;.&nbsp;Section</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5669557">//&nbsp;4.8.2&nbsp;also&nbsp;says&nbsp;&#34;[for&nbsp;non-interleaved&nbsp;data],&nbsp;the&nbsp;MCU&nbsp;is&nbsp;defined&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5669633">//&nbsp;one&nbsp;data&nbsp;unit&#34;.&nbsp;Similarly,&nbsp;section&nbsp;A.1.1&nbsp;explains&nbsp;that&nbsp;it&nbsp;is&nbsp;the&nbsp;ratio</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5669710">//&nbsp;of&nbsp;H_i&nbsp;to&nbsp;max_j(H_j)&nbsp;that&nbsp;matters,&nbsp;and&nbsp;similarly&nbsp;for&nbsp;V.&nbsp;For&nbsp;grayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5669786">//&nbsp;images,&nbsp;H_1&nbsp;is&nbsp;the&nbsp;maximum&nbsp;H_j&nbsp;for&nbsp;all&nbsp;components&nbsp;j,&nbsp;so&nbsp;that&nbsp;ratio&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5669862">//&nbsp;always&nbsp;1.&nbsp;The&nbsp;component&#39;s&nbsp;(h,&nbsp;v)&nbsp;is&nbsp;effectively&nbsp;always&nbsp;(1,&nbsp;1):&nbsp;even&nbsp;if</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5669939">//&nbsp;the&nbsp;nominal&nbsp;(h,&nbsp;v)&nbsp;is&nbsp;(2,&nbsp;1),&nbsp;a&nbsp;20x5&nbsp;image&nbsp;is&nbsp;encoded&nbsp;in&nbsp;three&nbsp;8x8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5670012">//&nbsp;MCUs,&nbsp;not&nbsp;two&nbsp;16x8&nbsp;MCUs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5670043">d</span><span class="op" id="5670044">.</span><span class="ident" id="5670045">comp</span><span class="op" id="5670049">[</span><span class="ident" id="5670050">i</span><span class="op" id="5670051">]</span><span class="op" id="5670052">.</span><span class="ident" id="5670053">h</span>&nbsp;<span class="op" id="5670055">=</span>&nbsp;<span class="num" id="5670057">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5670062">d</span><span class="op" id="5670063">.</span><span class="ident" id="5670064">comp</span><span class="op" id="5670068">[</span><span class="ident" id="5670069">i</span><span class="op" id="5670070">]</span><span class="op" id="5670071">.</span><span class="ident" id="5670072">v</span>&nbsp;<span class="op" id="5670074">=</span>&nbsp;<span class="num" id="5670076">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5670081">continue</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5670092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5670096">hv</span>&nbsp;<span class="op" id="5670099">:=</span>&nbsp;<span class="ident" id="5670102">d</span><span class="op" id="5670103">.</span><span class="ident" id="5670104">tmp</span><span class="op" id="5670107">[</span><span class="num" id="5670108">7</span><span class="op" id="5670109">+</span><span class="num" id="5670110">3</span><span class="op" id="5670111">*</span><span class="ident" id="5670112">i</span><span class="op" id="5670113">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5670117">d</span><span class="op" id="5670118">.</span><span class="ident" id="5670119">comp</span><span class="op" id="5670123">[</span><span class="ident" id="5670124">i</span><span class="op" id="5670125">]</span><span class="op" id="5670126">.</span><span class="ident" id="5670127">h</span>&nbsp;<span class="op" id="5670129">=</span>&nbsp;<span class="builtintype" id="5670131">int</span><span class="op" id="5670134">(</span><span class="ident" id="5670135">hv</span>&nbsp;<span class="op" id="5670138">&gt;&gt;</span>&nbsp;<span class="num" id="5670141">4</span><span class="op" id="5670142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5670146">d</span><span class="op" id="5670147">.</span><span class="ident" id="5670148">comp</span><span class="op" id="5670152">[</span><span class="ident" id="5670153">i</span><span class="op" id="5670154">]</span><span class="op" id="5670155">.</span><span class="ident" id="5670156">v</span>&nbsp;<span class="op" id="5670158">=</span>&nbsp;<span class="builtintype" id="5670160">int</span><span class="op" id="5670163">(</span><span class="ident" id="5670164">hv</span>&nbsp;<span class="op" id="5670167">&amp;</span>&nbsp;<span class="num" id="5670169">0x0f</span><span class="op" id="5670173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5670177">//&nbsp;For&nbsp;color&nbsp;images,&nbsp;we&nbsp;only&nbsp;support&nbsp;4:4:4,&nbsp;4:4:0,&nbsp;4:2:2&nbsp;or&nbsp;4:2:0&nbsp;chroma</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5670252">//&nbsp;downsampling&nbsp;ratios.&nbsp;This&nbsp;implies&nbsp;that&nbsp;the&nbsp;(h,&nbsp;v)&nbsp;values&nbsp;for&nbsp;the&nbsp;Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5670324">//&nbsp;component&nbsp;are&nbsp;either&nbsp;(1,&nbsp;1),&nbsp;(1,&nbsp;2),&nbsp;(2,&nbsp;1)&nbsp;or&nbsp;(2,&nbsp;2),&nbsp;and&nbsp;the&nbsp;(h,&nbsp;v)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5670399">//&nbsp;values&nbsp;for&nbsp;the&nbsp;Cr&nbsp;and&nbsp;Cb&nbsp;components&nbsp;must&nbsp;be&nbsp;(1,&nbsp;1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5670456">if</span>&nbsp;<span class="ident" id="5670459">i</span>&nbsp;<span class="op" id="5670461">==</span>&nbsp;<span class="num" id="5670464">0</span>&nbsp;<span class="op" id="5670466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5670471">if</span>&nbsp;<span class="ident" id="5670474">hv</span>&nbsp;<span class="op" id="5670477">!=</span>&nbsp;<span class="num" id="5670480">0x11</span>&nbsp;<span class="op" id="5670485">&amp;&amp;</span>&nbsp;<span class="ident" id="5670488">hv</span>&nbsp;<span class="op" id="5670491">!=</span>&nbsp;<span class="num" id="5670494">0x21</span>&nbsp;<span class="op" id="5670499">&amp;&amp;</span>&nbsp;<span class="ident" id="5670502">hv</span>&nbsp;<span class="op" id="5670505">!=</span>&nbsp;<span class="num" id="5670508">0x22</span>&nbsp;<span class="op" id="5670513">&amp;&amp;</span>&nbsp;<span class="ident" id="5670516">hv</span>&nbsp;<span class="op" id="5670519">!=</span>&nbsp;<span class="num" id="5670522">0x12</span>&nbsp;<span class="op" id="5670527">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5670533">return</span>&nbsp;<span class="ident" id="5670540">UnsupportedError</span><span class="op" id="5670556">(</span><span class="string" id="5670557">&#34;luma/chroma&nbsp;downsample&nbsp;ratio&#34;</span><span class="op" id="5670587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5670592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5670596">}</span>&nbsp;<span class="keyword" id="5670598">else</span>&nbsp;<span class="keyword" id="5670603">if</span>&nbsp;<span class="ident" id="5670606">hv</span>&nbsp;<span class="op" id="5670609">!=</span>&nbsp;<span class="num" id="5670612">0x11</span>&nbsp;<span class="op" id="5670617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5670622">return</span>&nbsp;<span class="ident" id="5670629">UnsupportedError</span><span class="op" id="5670645">(</span><span class="string" id="5670646">&#34;luma/chroma&nbsp;downsample&nbsp;ratio&#34;</span><span class="op" id="5670676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5670680">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5670683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5670686">return</span>&nbsp;<span class="ident" id="5670693">nil</span><br>
<span class="lineno"></span><span class="op" id="5670697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5670700">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.1.</span><br>
<span class="lineno">345</span><span class="keyword" id="5670733">func</span>&nbsp;<span class="op" id="5670738">(</span><span class="ident" id="5670739">d</span>&nbsp;<span class="op" id="5670741">*</span><span class="ident" id="5670742">decoder</span><span class="op" id="5670749">)</span>&nbsp;<span class="ident" id="5670751">processDQT</span><span class="op" id="5670761">(</span><span class="ident" id="5670762">n</span>&nbsp;<span class="builtintype" id="5670764">int</span><span class="op" id="5670767">)</span>&nbsp;<span class="builtintype" id="5670769">error</span>&nbsp;<span class="op" id="5670775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5670778">const</span>&nbsp;<span class="ident" id="5670784">qtLength</span>&nbsp;<span class="op" id="5670793">=</span>&nbsp;<span class="num" id="5670795">1</span>&nbsp;<span class="op" id="5670797">+</span>&nbsp;<span class="ident" id="5670799">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5670810">for</span>&nbsp;<span class="op" id="5670814">;</span>&nbsp;<span class="ident" id="5670816">n</span>&nbsp;<span class="op" id="5670818">&gt;=</span>&nbsp;<span class="ident" id="5670821">qtLength</span><span class="op" id="5670829">;</span>&nbsp;<span class="ident" id="5670831">n</span>&nbsp;<span class="op" id="5670833">-=</span>&nbsp;<span class="ident" id="5670836">qtLength</span>&nbsp;<span class="op" id="5670845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5670849">if</span>&nbsp;<span class="ident" id="5670852">err</span>&nbsp;<span class="op" id="5670856">:=</span>&nbsp;<span class="ident" id="5670859">d</span><span class="op" id="5670860">.</span><span class="ident" id="5670861">readFull</span><span class="op" id="5670869">(</span><span class="ident" id="5670870">d</span><span class="op" id="5670871">.</span><span class="ident" id="5670872">tmp</span><span class="op" id="5670875">[</span><span class="op" id="5670876">:</span><span class="ident" id="5670877">qtLength</span><span class="op" id="5670885">]</span><span class="op" id="5670886">)</span><span class="op" id="5670887">;</span>&nbsp;<span class="ident" id="5670889">err</span>&nbsp;<span class="op" id="5670893">!=</span>&nbsp;<span class="ident" id="5670896">nil</span>&nbsp;<span class="op" id="5670900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5670905">return</span>&nbsp;<span class="ident" id="5670912">err</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5670918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5670922">pq</span>&nbsp;<span class="op" id="5670925">:=</span>&nbsp;<span class="ident" id="5670928">d</span><span class="op" id="5670929">.</span><span class="ident" id="5670930">tmp</span><span class="op" id="5670933">[</span><span class="num" id="5670934">0</span><span class="op" id="5670935">]</span>&nbsp;<span class="op" id="5670937">&gt;&gt;</span>&nbsp;<span class="num" id="5670940">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5670944">if</span>&nbsp;<span class="ident" id="5670947">pq</span>&nbsp;<span class="op" id="5670950">!=</span>&nbsp;<span class="num" id="5670953">0</span>&nbsp;<span class="op" id="5670955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5670960">return</span>&nbsp;<span class="ident" id="5670967">UnsupportedError</span><span class="op" id="5670983">(</span><span class="string" id="5670984">&#34;bad&nbsp;Pq&nbsp;value&#34;</span><span class="op" id="5670998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5671002">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5671006">tq</span>&nbsp;<span class="op" id="5671009">:=</span>&nbsp;<span class="ident" id="5671012">d</span><span class="op" id="5671013">.</span><span class="ident" id="5671014">tmp</span><span class="op" id="5671017">[</span><span class="num" id="5671018">0</span><span class="op" id="5671019">]</span>&nbsp;<span class="op" id="5671021">&amp;</span>&nbsp;<span class="num" id="5671023">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671030">if</span>&nbsp;<span class="ident" id="5671033">tq</span>&nbsp;<span class="op" id="5671036">&gt;</span>&nbsp;<span class="ident" id="5671038">maxTq</span>&nbsp;<span class="op" id="5671044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671049">return</span>&nbsp;<span class="ident" id="5671056">FormatError</span><span class="op" id="5671067">(</span><span class="string" id="5671068">&#34;bad&nbsp;Tq&nbsp;value&#34;</span><span class="op" id="5671082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5671086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671090">for</span>&nbsp;<span class="ident" id="5671094">i</span>&nbsp;<span class="op" id="5671096">:=</span>&nbsp;<span class="keyword" id="5671099">range</span>&nbsp;<span class="ident" id="5671105">d</span><span class="op" id="5671106">.</span><span class="ident" id="5671107">quant</span><span class="op" id="5671112">[</span><span class="ident" id="5671113">tq</span><span class="op" id="5671115">]</span>&nbsp;<span class="op" id="5671117">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5671122">d</span><span class="op" id="5671123">.</span><span class="ident" id="5671124">quant</span><span class="op" id="5671129">[</span><span class="ident" id="5671130">tq</span><span class="op" id="5671132">]</span><span class="op" id="5671133">[</span><span class="ident" id="5671134">i</span><span class="op" id="5671135">]</span>&nbsp;<span class="op" id="5671137">=</span>&nbsp;<span class="builtintype" id="5671139">int32</span><span class="op" id="5671144">(</span><span class="ident" id="5671145">d</span><span class="op" id="5671146">.</span><span class="ident" id="5671147">tmp</span><span class="op" id="5671150">[</span><span class="ident" id="5671151">i</span><span class="op" id="5671152">+</span><span class="num" id="5671153">1</span><span class="op" id="5671154">]</span><span class="op" id="5671155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5671159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5671162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671165">if</span>&nbsp;<span class="ident" id="5671168">n</span>&nbsp;<span class="op" id="5671170">!=</span>&nbsp;<span class="num" id="5671173">0</span>&nbsp;<span class="op" id="5671175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671179">return</span>&nbsp;<span class="ident" id="5671186">FormatError</span><span class="op" id="5671197">(</span><span class="string" id="5671198">&#34;DQT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5671220">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5671223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671226">return</span>&nbsp;<span class="ident" id="5671233">nil</span><br>
<span class="lineno"></span><span class="op" id="5671237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5671240">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.4.</span><br>
<span class="lineno">370</span><span class="keyword" id="5671273">func</span>&nbsp;<span class="op" id="5671278">(</span><span class="ident" id="5671279">d</span>&nbsp;<span class="op" id="5671281">*</span><span class="ident" id="5671282">decoder</span><span class="op" id="5671289">)</span>&nbsp;<span class="ident" id="5671291">processDRI</span><span class="op" id="5671301">(</span><span class="ident" id="5671302">n</span>&nbsp;<span class="builtintype" id="5671304">int</span><span class="op" id="5671307">)</span>&nbsp;<span class="builtintype" id="5671309">error</span>&nbsp;<span class="op" id="5671315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671318">if</span>&nbsp;<span class="ident" id="5671321">n</span>&nbsp;<span class="op" id="5671323">!=</span>&nbsp;<span class="num" id="5671326">2</span>&nbsp;<span class="op" id="5671328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671332">return</span>&nbsp;<span class="ident" id="5671339">FormatError</span><span class="op" id="5671350">(</span><span class="string" id="5671351">&#34;DRI&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5671373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5671376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671379">if</span>&nbsp;<span class="ident" id="5671382">err</span>&nbsp;<span class="op" id="5671386">:=</span>&nbsp;<span class="ident" id="5671389">d</span><span class="op" id="5671390">.</span><span class="ident" id="5671391">readFull</span><span class="op" id="5671399">(</span><span class="ident" id="5671400">d</span><span class="op" id="5671401">.</span><span class="ident" id="5671402">tmp</span><span class="op" id="5671405">[</span><span class="op" id="5671406">:</span><span class="num" id="5671407">2</span><span class="op" id="5671408">]</span><span class="op" id="5671409">)</span><span class="op" id="5671410">;</span>&nbsp;<span class="ident" id="5671412">err</span>&nbsp;<span class="op" id="5671416">!=</span>&nbsp;<span class="ident" id="5671419">nil</span>&nbsp;<span class="op" id="5671423">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671427">return</span>&nbsp;<span class="ident" id="5671434">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5671439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5671442">d</span><span class="op" id="5671443">.</span><span class="ident" id="5671444">ri</span>&nbsp;<span class="op" id="5671447">=</span>&nbsp;<span class="builtintype" id="5671449">int</span><span class="op" id="5671452">(</span><span class="ident" id="5671453">d</span><span class="op" id="5671454">.</span><span class="ident" id="5671455">tmp</span><span class="op" id="5671458">[</span><span class="num" id="5671459">0</span><span class="op" id="5671460">]</span><span class="op" id="5671461">)</span><span class="op" id="5671462">&lt;&lt;</span><span class="num" id="5671464">8</span>&nbsp;<span class="op" id="5671466">+</span>&nbsp;<span class="builtintype" id="5671468">int</span><span class="op" id="5671471">(</span><span class="ident" id="5671472">d</span><span class="op" id="5671473">.</span><span class="ident" id="5671474">tmp</span><span class="op" id="5671477">[</span><span class="num" id="5671478">1</span><span class="op" id="5671479">]</span><span class="op" id="5671480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671483">return</span>&nbsp;<span class="ident" id="5671490">nil</span><br>
<span class="lineno"></span><span class="op" id="5671494">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="5671497">//&nbsp;decode&nbsp;reads&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="5671567">func</span>&nbsp;<span class="op" id="5671572">(</span><span class="ident" id="5671573">d</span>&nbsp;<span class="op" id="5671575">*</span><span class="ident" id="5671576">decoder</span><span class="op" id="5671583">)</span>&nbsp;<span class="ident" id="5671585">decode</span><span class="op" id="5671591">(</span><span class="ident" id="5671592">r</span>&nbsp;<span class="ident" id="5671594">io</span><span class="op" id="5671596">.</span><span class="ident" id="5671597">Reader</span><span class="op" id="5671603">,</span>&nbsp;<span class="ident" id="5671605">configOnly</span>&nbsp;<span class="builtintype" id="5671616">bool</span><span class="op" id="5671620">)</span>&nbsp;<span class="op" id="5671622">(</span><span class="ident" id="5671623">image</span><span class="op" id="5671628">.</span><span class="ident" id="5671629">Image</span><span class="op" id="5671634">,</span>&nbsp;<span class="builtintype" id="5671636">error</span><span class="op" id="5671641">)</span>&nbsp;<span class="op" id="5671643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5671646">d</span><span class="op" id="5671647">.</span><span class="ident" id="5671648">r</span>&nbsp;<span class="op" id="5671650">=</span>&nbsp;<span class="ident" id="5671652">r</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5671656">//&nbsp;Check&nbsp;for&nbsp;the&nbsp;Start&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671697">if</span>&nbsp;<span class="ident" id="5671700">err</span>&nbsp;<span class="op" id="5671704">:=</span>&nbsp;<span class="ident" id="5671707">d</span><span class="op" id="5671708">.</span><span class="ident" id="5671709">readFull</span><span class="op" id="5671717">(</span><span class="ident" id="5671718">d</span><span class="op" id="5671719">.</span><span class="ident" id="5671720">tmp</span><span class="op" id="5671723">[</span><span class="op" id="5671724">:</span><span class="num" id="5671725">2</span><span class="op" id="5671726">]</span><span class="op" id="5671727">)</span><span class="op" id="5671728">;</span>&nbsp;<span class="ident" id="5671730">err</span>&nbsp;<span class="op" id="5671734">!=</span>&nbsp;<span class="ident" id="5671737">nil</span>&nbsp;<span class="op" id="5671741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671745">return</span>&nbsp;<span class="ident" id="5671752">nil</span><span class="op" id="5671755">,</span>&nbsp;<span class="ident" id="5671757">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5671762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671765">if</span>&nbsp;<span class="ident" id="5671768">d</span><span class="op" id="5671769">.</span><span class="ident" id="5671770">tmp</span><span class="op" id="5671773">[</span><span class="num" id="5671774">0</span><span class="op" id="5671775">]</span>&nbsp;<span class="op" id="5671777">!=</span>&nbsp;<span class="num" id="5671780">0xff</span>&nbsp;<span class="op" id="5671785">||</span>&nbsp;<span class="ident" id="5671788">d</span><span class="op" id="5671789">.</span><span class="ident" id="5671790">tmp</span><span class="op" id="5671793">[</span><span class="num" id="5671794">1</span><span class="op" id="5671795">]</span>&nbsp;<span class="op" id="5671797">!=</span>&nbsp;<span class="ident" id="5671800">soiMarker</span>&nbsp;<span class="op" id="5671810">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671814">return</span>&nbsp;<span class="ident" id="5671821">nil</span><span class="op" id="5671824">,</span>&nbsp;<span class="ident" id="5671826">FormatError</span><span class="op" id="5671837">(</span><span class="string" id="5671838">&#34;missing&nbsp;SOI&nbsp;marker&#34;</span><span class="op" id="5671858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5671861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5671865">//&nbsp;Process&nbsp;the&nbsp;remaining&nbsp;segments&nbsp;until&nbsp;the&nbsp;End&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671931">for</span>&nbsp;<span class="op" id="5671935">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5671939">err</span>&nbsp;<span class="op" id="5671943">:=</span>&nbsp;<span class="ident" id="5671946">d</span><span class="op" id="5671947">.</span><span class="ident" id="5671948">readFull</span><span class="op" id="5671956">(</span><span class="ident" id="5671957">d</span><span class="op" id="5671958">.</span><span class="ident" id="5671959">tmp</span><span class="op" id="5671962">[</span><span class="op" id="5671963">:</span><span class="num" id="5671964">2</span><span class="op" id="5671965">]</span><span class="op" id="5671966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671970">if</span>&nbsp;<span class="ident" id="5671973">err</span>&nbsp;<span class="op" id="5671977">!=</span>&nbsp;<span class="ident" id="5671980">nil</span>&nbsp;<span class="op" id="5671984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5671989">return</span>&nbsp;<span class="ident" id="5671996">nil</span><span class="op" id="5671999">,</span>&nbsp;<span class="ident" id="5672001">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5672007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5672011">for</span>&nbsp;<span class="ident" id="5672015">d</span><span class="op" id="5672016">.</span><span class="ident" id="5672017">tmp</span><span class="op" id="5672020">[</span><span class="num" id="5672021">0</span><span class="op" id="5672022">]</span>&nbsp;<span class="op" id="5672024">!=</span>&nbsp;<span class="num" id="5672027">0xff</span>&nbsp;<span class="op" id="5672032">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672037">//&nbsp;Strictly&nbsp;speaking,&nbsp;this&nbsp;is&nbsp;a&nbsp;format&nbsp;error.&nbsp;However,&nbsp;libjpeg&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672106">//&nbsp;liberal&nbsp;in&nbsp;what&nbsp;it&nbsp;accepts.&nbsp;As&nbsp;of&nbsp;version&nbsp;9,&nbsp;next_marker&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672172">//&nbsp;jdmarker.c&nbsp;treats&nbsp;this&nbsp;as&nbsp;a&nbsp;warning&nbsp;(JWRN_EXTRANEOUS_DATA)&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672241">//&nbsp;continues&nbsp;to&nbsp;decode&nbsp;the&nbsp;stream.&nbsp;Even&nbsp;before&nbsp;next_marker&nbsp;sees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672308">//&nbsp;extraneous&nbsp;data,&nbsp;jpeg_fill_bit_buffer&nbsp;in&nbsp;jdhuff.c&nbsp;reads&nbsp;as&nbsp;many</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672378">//&nbsp;bytes&nbsp;as&nbsp;it&nbsp;can,&nbsp;possibly&nbsp;past&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;scan&#39;s&nbsp;data.&nbsp;It</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672444">//&nbsp;effectively&nbsp;puts&nbsp;back&nbsp;any&nbsp;markers&nbsp;that&nbsp;it&nbsp;overscanned&nbsp;(e.g.&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672513">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker),&nbsp;but&nbsp;it&nbsp;does&nbsp;not&nbsp;put&nbsp;back&nbsp;non-marker&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672585">//&nbsp;and&nbsp;thus&nbsp;it&nbsp;can&nbsp;silently&nbsp;ignore&nbsp;a&nbsp;small&nbsp;number&nbsp;of&nbsp;extraneous</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672652">//&nbsp;non-marker&nbsp;bytes&nbsp;before&nbsp;next_marker&nbsp;has&nbsp;a&nbsp;chance&nbsp;to&nbsp;see&nbsp;them&nbsp;(and</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672724">//&nbsp;print&nbsp;a&nbsp;warning).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672748">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672754">//&nbsp;We&nbsp;are&nbsp;therefore&nbsp;also&nbsp;liberal&nbsp;in&nbsp;what&nbsp;we&nbsp;accept.&nbsp;Extraneous&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672825">//&nbsp;is&nbsp;silently&nbsp;ignored.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672852">//</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672858">//&nbsp;This&nbsp;is&nbsp;similar&nbsp;to,&nbsp;but&nbsp;not&nbsp;exactly&nbsp;the&nbsp;same&nbsp;as,&nbsp;the&nbsp;restart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672925">//&nbsp;mechanism&nbsp;within&nbsp;a&nbsp;scan&nbsp;(the&nbsp;RST[0-7]&nbsp;markers).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672979">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5672985">//&nbsp;Note&nbsp;that&nbsp;extraneous&nbsp;0xff&nbsp;bytes&nbsp;in&nbsp;e.g.&nbsp;SOS&nbsp;data&nbsp;are&nbsp;escaped&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5673055">//&nbsp;&#34;\xff\x00&#34;,&nbsp;and&nbsp;so&nbsp;are&nbsp;detected&nbsp;a&nbsp;little&nbsp;further&nbsp;down&nbsp;below.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5673122">d</span><span class="op" id="5673123">.</span><span class="ident" id="5673124">tmp</span><span class="op" id="5673127">[</span><span class="num" id="5673128">0</span><span class="op" id="5673129">]</span>&nbsp;<span class="op" id="5673131">=</span>&nbsp;<span class="ident" id="5673133">d</span><span class="op" id="5673134">.</span><span class="ident" id="5673135">tmp</span><span class="op" id="5673138">[</span><span class="num" id="5673139">1</span><span class="op" id="5673140">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5673145">d</span><span class="op" id="5673146">.</span><span class="ident" id="5673147">tmp</span><span class="op" id="5673150">[</span><span class="num" id="5673151">1</span><span class="op" id="5673152">]</span><span class="op" id="5673153">,</span>&nbsp;<span class="ident" id="5673155">err</span>&nbsp;<span class="op" id="5673159">=</span>&nbsp;<span class="ident" id="5673161">d</span><span class="op" id="5673162">.</span><span class="ident" id="5673163">readByte</span><span class="op" id="5673171">(</span><span class="op" id="5673172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5673177">if</span>&nbsp;<span class="ident" id="5673180">err</span>&nbsp;<span class="op" id="5673184">!=</span>&nbsp;<span class="ident" id="5673187">nil</span>&nbsp;<span class="op" id="5673191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5673197">return</span>&nbsp;<span class="ident" id="5673204">nil</span><span class="op" id="5673207">,</span>&nbsp;<span class="ident" id="5673209">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5673216">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5673220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5673224">marker</span>&nbsp;<span class="op" id="5673231">:=</span>&nbsp;<span class="ident" id="5673234">d</span><span class="op" id="5673235">.</span><span class="ident" id="5673236">tmp</span><span class="op" id="5673239">[</span><span class="num" id="5673240">1</span><span class="op" id="5673241">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5673245">if</span>&nbsp;<span class="ident" id="5673248">marker</span>&nbsp;<span class="op" id="5673255">==</span>&nbsp;<span class="num" id="5673258">0</span>&nbsp;<span class="op" id="5673260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5673265">//&nbsp;Treat&nbsp;&#34;\xff\x00&#34;&nbsp;as&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5673308">continue</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5673319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5673323">for</span>&nbsp;<span class="ident" id="5673327">marker</span>&nbsp;<span class="op" id="5673334">==</span>&nbsp;<span class="num" id="5673337">0xff</span>&nbsp;<span class="op" id="5673342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5673347">//&nbsp;Section&nbsp;B.1.1.2&nbsp;says,&nbsp;&#34;Any&nbsp;marker&nbsp;may&nbsp;optionally&nbsp;be&nbsp;preceded&nbsp;by&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5673421">//&nbsp;number&nbsp;of&nbsp;fill&nbsp;bytes,&nbsp;which&nbsp;are&nbsp;bytes&nbsp;assigned&nbsp;code&nbsp;X&#39;FF&#39;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5673487">marker</span><span class="op" id="5673493">,</span>&nbsp;<span class="ident" id="5673495">err</span>&nbsp;<span class="op" id="5673499">=</span>&nbsp;<span class="ident" id="5673501">d</span><span class="op" id="5673502">.</span><span class="ident" id="5673503">readByte</span><span class="op" id="5673511">(</span><span class="op" id="5673512">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5673517">if</span>&nbsp;<span class="ident" id="5673520">err</span>&nbsp;<span class="op" id="5673524">!=</span>&nbsp;<span class="ident" id="5673527">nil</span>&nbsp;<span class="op" id="5673531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5673537">return</span>&nbsp;<span class="ident" id="5673544">nil</span><span class="op" id="5673547">,</span>&nbsp;<span class="ident" id="5673549">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5673556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5673560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5673564">if</span>&nbsp;<span class="ident" id="5673567">marker</span>&nbsp;<span class="op" id="5673574">==</span>&nbsp;<span class="ident" id="5673577">eoiMarker</span>&nbsp;<span class="op" id="5673587">{</span>&nbsp;<span class="comment" id="5673589">//&nbsp;End&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5673609">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5673617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5673621">if</span>&nbsp;<span class="ident" id="5673624">rst0Marker</span>&nbsp;<span class="op" id="5673635">&lt;=</span>&nbsp;<span class="ident" id="5673638">marker</span>&nbsp;<span class="op" id="5673645">&amp;&amp;</span>&nbsp;<span class="ident" id="5673648">marker</span>&nbsp;<span class="op" id="5673655">&lt;=</span>&nbsp;<span class="ident" id="5673658">rst7Marker</span>&nbsp;<span class="op" id="5673669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5673674">//&nbsp;Figures&nbsp;B.2&nbsp;and&nbsp;B.16&nbsp;of&nbsp;the&nbsp;specification&nbsp;suggest&nbsp;that&nbsp;restart&nbsp;markers&nbsp;should</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5673758">//&nbsp;only&nbsp;occur&nbsp;between&nbsp;Entropy&nbsp;Coded&nbsp;Segments&nbsp;and&nbsp;not&nbsp;after&nbsp;the&nbsp;final&nbsp;ECS.</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5673835">//&nbsp;However,&nbsp;some&nbsp;encoders&nbsp;may&nbsp;generate&nbsp;incorrect&nbsp;JPEGs&nbsp;with&nbsp;a&nbsp;final&nbsp;restart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5673914">//&nbsp;marker.&nbsp;That&nbsp;restart&nbsp;marker&nbsp;will&nbsp;be&nbsp;seen&nbsp;here&nbsp;instead&nbsp;of&nbsp;inside&nbsp;the&nbsp;processSOS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5673999">//&nbsp;method,&nbsp;and&nbsp;is&nbsp;ignored&nbsp;as&nbsp;a&nbsp;harmless&nbsp;error.&nbsp;Restart&nbsp;markers&nbsp;have&nbsp;no&nbsp;extra&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5674085">//&nbsp;so&nbsp;we&nbsp;check&nbsp;for&nbsp;this&nbsp;before&nbsp;we&nbsp;read&nbsp;the&nbsp;16-bit&nbsp;length&nbsp;of&nbsp;the&nbsp;segment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5674161">continue</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5674172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5674177">//&nbsp;Read&nbsp;the&nbsp;16-bit&nbsp;length&nbsp;of&nbsp;the&nbsp;segment.&nbsp;The&nbsp;value&nbsp;includes&nbsp;the&nbsp;2&nbsp;bytes&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5674260">//&nbsp;length&nbsp;itself,&nbsp;so&nbsp;we&nbsp;subtract&nbsp;2&nbsp;to&nbsp;get&nbsp;the&nbsp;number&nbsp;of&nbsp;remaining&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5674335">if</span>&nbsp;<span class="ident" id="5674338">err</span>&nbsp;<span class="op" id="5674342">=</span>&nbsp;<span class="ident" id="5674344">d</span><span class="op" id="5674345">.</span><span class="ident" id="5674346">readFull</span><span class="op" id="5674354">(</span><span class="ident" id="5674355">d</span><span class="op" id="5674356">.</span><span class="ident" id="5674357">tmp</span><span class="op" id="5674360">[</span><span class="op" id="5674361">:</span><span class="num" id="5674362">2</span><span class="op" id="5674363">]</span><span class="op" id="5674364">)</span><span class="op" id="5674365">;</span>&nbsp;<span class="ident" id="5674367">err</span>&nbsp;<span class="op" id="5674371">!=</span>&nbsp;<span class="ident" id="5674374">nil</span>&nbsp;<span class="op" id="5674378">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5674383">return</span>&nbsp;<span class="ident" id="5674390">nil</span><span class="op" id="5674393">,</span>&nbsp;<span class="ident" id="5674395">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5674401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5674405">n</span>&nbsp;<span class="op" id="5674407">:=</span>&nbsp;<span class="builtintype" id="5674410">int</span><span class="op" id="5674413">(</span><span class="ident" id="5674414">d</span><span class="op" id="5674415">.</span><span class="ident" id="5674416">tmp</span><span class="op" id="5674419">[</span><span class="num" id="5674420">0</span><span class="op" id="5674421">]</span><span class="op" id="5674422">)</span><span class="op" id="5674423">&lt;&lt;</span><span class="num" id="5674425">8</span>&nbsp;<span class="op" id="5674427">+</span>&nbsp;<span class="builtintype" id="5674429">int</span><span class="op" id="5674432">(</span><span class="ident" id="5674433">d</span><span class="op" id="5674434">.</span><span class="ident" id="5674435">tmp</span><span class="op" id="5674438">[</span><span class="num" id="5674439">1</span><span class="op" id="5674440">]</span><span class="op" id="5674441">)</span>&nbsp;<span class="op" id="5674443">-</span>&nbsp;<span class="num" id="5674445">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5674449">if</span>&nbsp;<span class="ident" id="5674452">n</span>&nbsp;<span class="op" id="5674454">&lt;</span>&nbsp;<span class="num" id="5674456">0</span>&nbsp;<span class="op" id="5674458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5674463">return</span>&nbsp;<span class="ident" id="5674470">nil</span><span class="op" id="5674473">,</span>&nbsp;<span class="ident" id="5674475">FormatError</span><span class="op" id="5674486">(</span><span class="string" id="5674487">&#34;short&nbsp;segment&nbsp;length&#34;</span><span class="op" id="5674509">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5674513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5674518">switch</span>&nbsp;<span class="op" id="5674525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5674529">case</span>&nbsp;<span class="ident" id="5674534">marker</span>&nbsp;<span class="op" id="5674541">==</span>&nbsp;<span class="ident" id="5674544">sof0Marker</span>&nbsp;<span class="op" id="5674555">||</span>&nbsp;<span class="ident" id="5674558">marker</span>&nbsp;<span class="op" id="5674565">==</span>&nbsp;<span class="ident" id="5674568">sof2Marker</span><span class="op" id="5674578">:</span>&nbsp;<span class="comment" id="5674580">//&nbsp;Start&nbsp;Of&nbsp;Frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5674602">d</span><span class="op" id="5674603">.</span><span class="ident" id="5674604">progressive</span>&nbsp;<span class="op" id="5674616">=</span>&nbsp;<span class="ident" id="5674618">marker</span>&nbsp;<span class="op" id="5674625">==</span>&nbsp;<span class="ident" id="5674628">sof2Marker</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5674642">err</span>&nbsp;<span class="op" id="5674646">=</span>&nbsp;<span class="ident" id="5674648">d</span><span class="op" id="5674649">.</span><span class="ident" id="5674650">processSOF</span><span class="op" id="5674660">(</span><span class="ident" id="5674661">n</span><span class="op" id="5674662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5674667">if</span>&nbsp;<span class="ident" id="5674670">configOnly</span>&nbsp;<span class="op" id="5674681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5674687">return</span>&nbsp;<span class="ident" id="5674694">nil</span><span class="op" id="5674697">,</span>&nbsp;<span class="ident" id="5674699">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5674706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5674710">case</span>&nbsp;<span class="ident" id="5674715">marker</span>&nbsp;<span class="op" id="5674722">==</span>&nbsp;<span class="ident" id="5674725">dhtMarker</span><span class="op" id="5674734">:</span>&nbsp;<span class="comment" id="5674736">//&nbsp;Define&nbsp;Huffman&nbsp;Table.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5674764">err</span>&nbsp;<span class="op" id="5674768">=</span>&nbsp;<span class="ident" id="5674770">d</span><span class="op" id="5674771">.</span><span class="ident" id="5674772">processDHT</span><span class="op" id="5674782">(</span><span class="ident" id="5674783">n</span><span class="op" id="5674784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5674788">case</span>&nbsp;<span class="ident" id="5674793">marker</span>&nbsp;<span class="op" id="5674800">==</span>&nbsp;<span class="ident" id="5674803">dqtMarker</span><span class="op" id="5674812">:</span>&nbsp;<span class="comment" id="5674814">//&nbsp;Define&nbsp;Quantization&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5674847">err</span>&nbsp;<span class="op" id="5674851">=</span>&nbsp;<span class="ident" id="5674853">d</span><span class="op" id="5674854">.</span><span class="ident" id="5674855">processDQT</span><span class="op" id="5674865">(</span><span class="ident" id="5674866">n</span><span class="op" id="5674867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5674871">case</span>&nbsp;<span class="ident" id="5674876">marker</span>&nbsp;<span class="op" id="5674883">==</span>&nbsp;<span class="ident" id="5674886">sosMarker</span><span class="op" id="5674895">:</span>&nbsp;<span class="comment" id="5674897">//&nbsp;Start&nbsp;Of&nbsp;Scan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5674918">err</span>&nbsp;<span class="op" id="5674922">=</span>&nbsp;<span class="ident" id="5674924">d</span><span class="op" id="5674925">.</span><span class="ident" id="5674926">processSOS</span><span class="op" id="5674936">(</span><span class="ident" id="5674937">n</span><span class="op" id="5674938">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5674942">case</span>&nbsp;<span class="ident" id="5674947">marker</span>&nbsp;<span class="op" id="5674954">==</span>&nbsp;<span class="ident" id="5674957">driMarker</span><span class="op" id="5674966">:</span>&nbsp;<span class="comment" id="5674968">//&nbsp;Define&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5674999">err</span>&nbsp;<span class="op" id="5675003">=</span>&nbsp;<span class="ident" id="5675005">d</span><span class="op" id="5675006">.</span><span class="ident" id="5675007">processDRI</span><span class="op" id="5675017">(</span><span class="ident" id="5675018">n</span><span class="op" id="5675019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675023">case</span>&nbsp;<span class="ident" id="5675028">app0Marker</span>&nbsp;<span class="op" id="5675039">&lt;=</span>&nbsp;<span class="ident" id="5675042">marker</span>&nbsp;<span class="op" id="5675049">&amp;&amp;</span>&nbsp;<span class="ident" id="5675052">marker</span>&nbsp;<span class="op" id="5675059">&lt;=</span>&nbsp;<span class="ident" id="5675062">app15Marker</span>&nbsp;<span class="op" id="5675074">||</span>&nbsp;<span class="ident" id="5675077">marker</span>&nbsp;<span class="op" id="5675084">==</span>&nbsp;<span class="ident" id="5675087">comMarker</span><span class="op" id="5675096">:</span>&nbsp;<span class="comment" id="5675098">//&nbsp;APPlication&nbsp;specific,&nbsp;or&nbsp;COMment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5675138">err</span>&nbsp;<span class="op" id="5675142">=</span>&nbsp;<span class="ident" id="5675144">d</span><span class="op" id="5675145">.</span><span class="ident" id="5675146">ignore</span><span class="op" id="5675152">(</span><span class="ident" id="5675153">n</span><span class="op" id="5675154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675158">default</span><span class="op" id="5675165">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5675170">err</span>&nbsp;<span class="op" id="5675174">=</span>&nbsp;<span class="ident" id="5675176">UnsupportedError</span><span class="op" id="5675192">(</span><span class="string" id="5675193">&#34;unknown&nbsp;marker&#34;</span><span class="op" id="5675209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5675213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675217">if</span>&nbsp;<span class="ident" id="5675220">err</span>&nbsp;<span class="op" id="5675224">!=</span>&nbsp;<span class="ident" id="5675227">nil</span>&nbsp;<span class="op" id="5675231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675236">return</span>&nbsp;<span class="ident" id="5675243">nil</span><span class="op" id="5675246">,</span>&nbsp;<span class="ident" id="5675248">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5675254">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5675257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675260">if</span>&nbsp;<span class="ident" id="5675263">d</span><span class="op" id="5675264">.</span><span class="ident" id="5675265">img1</span>&nbsp;<span class="op" id="5675270">!=</span>&nbsp;<span class="ident" id="5675273">nil</span>&nbsp;<span class="op" id="5675277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675281">return</span>&nbsp;<span class="ident" id="5675288">d</span><span class="op" id="5675289">.</span><span class="ident" id="5675290">img1</span><span class="op" id="5675294">,</span>&nbsp;<span class="ident" id="5675296">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5675301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675304">if</span>&nbsp;<span class="ident" id="5675307">d</span><span class="op" id="5675308">.</span><span class="ident" id="5675309">img3</span>&nbsp;<span class="op" id="5675314">!=</span>&nbsp;<span class="ident" id="5675317">nil</span>&nbsp;<span class="op" id="5675321">{</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675325">return</span>&nbsp;<span class="ident" id="5675332">d</span><span class="op" id="5675333">.</span><span class="ident" id="5675334">img3</span><span class="op" id="5675338">,</span>&nbsp;<span class="ident" id="5675340">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5675345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675348">return</span>&nbsp;<span class="ident" id="5675355">nil</span><span class="op" id="5675358">,</span>&nbsp;<span class="ident" id="5675360">FormatError</span><span class="op" id="5675371">(</span><span class="string" id="5675372">&#34;missing&nbsp;SOS&nbsp;marker&#34;</span><span class="op" id="5675392">)</span><br>
<span class="lineno"></span><span class="op" id="5675394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="5675397">//&nbsp;Decode&nbsp;reads&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="5675467">func</span>&nbsp;<span class="ident" id="5675472">Decode</span><span class="op" id="5675478">(</span><span class="ident" id="5675479">r</span>&nbsp;<span class="ident" id="5675481">io</span><span class="op" id="5675483">.</span><span class="ident" id="5675484">Reader</span><span class="op" id="5675490">)</span>&nbsp;<span class="op" id="5675492">(</span><span class="ident" id="5675493">image</span><span class="op" id="5675498">.</span><span class="ident" id="5675499">Image</span><span class="op" id="5675504">,</span>&nbsp;<span class="builtintype" id="5675506">error</span><span class="op" id="5675511">)</span>&nbsp;<span class="op" id="5675513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675516">var</span>&nbsp;<span class="ident" id="5675520">d</span>&nbsp;<span class="ident" id="5675522">decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675531">return</span>&nbsp;<span class="ident" id="5675538">d</span><span class="op" id="5675539">.</span><span class="ident" id="5675540">decode</span><span class="op" id="5675546">(</span><span class="ident" id="5675547">r</span><span class="op" id="5675548">,</span>&nbsp;<span class="builtintype" id="5675550">false</span><span class="op" id="5675555">)</span><br>
<span class="lineno"></span><span class="op" id="5675557">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="comment" id="5675560">//&nbsp;DecodeConfig&nbsp;returns&nbsp;the&nbsp;color&nbsp;model&nbsp;and&nbsp;dimensions&nbsp;of&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="5675639">//&nbsp;decoding&nbsp;the&nbsp;entire&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="5675669">func</span>&nbsp;<span class="ident" id="5675674">DecodeConfig</span><span class="op" id="5675686">(</span><span class="ident" id="5675687">r</span>&nbsp;<span class="ident" id="5675689">io</span><span class="op" id="5675691">.</span><span class="ident" id="5675692">Reader</span><span class="op" id="5675698">)</span>&nbsp;<span class="op" id="5675700">(</span><span class="ident" id="5675701">image</span><span class="op" id="5675706">.</span><span class="ident" id="5675707">Config</span><span class="op" id="5675713">,</span>&nbsp;<span class="builtintype" id="5675715">error</span><span class="op" id="5675720">)</span>&nbsp;<span class="op" id="5675722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675725">var</span>&nbsp;<span class="ident" id="5675729">d</span>&nbsp;<span class="ident" id="5675731">decoder</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675740">if</span>&nbsp;<span class="ident" id="5675743">_</span><span class="op" id="5675744">,</span>&nbsp;<span class="ident" id="5675746">err</span>&nbsp;<span class="op" id="5675750">:=</span>&nbsp;<span class="ident" id="5675753">d</span><span class="op" id="5675754">.</span><span class="ident" id="5675755">decode</span><span class="op" id="5675761">(</span><span class="ident" id="5675762">r</span><span class="op" id="5675763">,</span>&nbsp;<span class="builtintype" id="5675765">true</span><span class="op" id="5675769">)</span><span class="op" id="5675770">;</span>&nbsp;<span class="ident" id="5675772">err</span>&nbsp;<span class="op" id="5675776">!=</span>&nbsp;<span class="ident" id="5675779">nil</span>&nbsp;<span class="op" id="5675783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675787">return</span>&nbsp;<span class="ident" id="5675794">image</span><span class="op" id="5675799">.</span><span class="ident" id="5675800">Config</span><span class="op" id="5675806">{</span><span class="op" id="5675807">}</span><span class="op" id="5675808">,</span>&nbsp;<span class="ident" id="5675810">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5675815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675818">switch</span>&nbsp;<span class="ident" id="5675825">d</span><span class="op" id="5675826">.</span><span class="ident" id="5675827">nComp</span>&nbsp;<span class="op" id="5675833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675836">case</span>&nbsp;<span class="ident" id="5675841">nGrayComponent</span><span class="op" id="5675855">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675859">return</span>&nbsp;<span class="ident" id="5675866">image</span><span class="op" id="5675871">.</span><span class="ident" id="5675872">Config</span><span class="op" id="5675878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5675883">ColorModel</span><span class="op" id="5675893">:</span>&nbsp;<span class="ident" id="5675895">color</span><span class="op" id="5675900">.</span><span class="ident" id="5675901">GrayModel</span><span class="op" id="5675910">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5675915">Width</span><span class="op" id="5675920">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5675927">d</span><span class="op" id="5675928">.</span><span class="ident" id="5675929">width</span><span class="op" id="5675934">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5675939">Height</span><span class="op" id="5675945">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5675951">d</span><span class="op" id="5675952">.</span><span class="ident" id="5675953">height</span><span class="op" id="5675959">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5675963">}</span><span class="op" id="5675964">,</span>&nbsp;<span class="ident" id="5675966">nil</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675971">case</span>&nbsp;<span class="ident" id="5675976">nColorComponent</span><span class="op" id="5675991">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5675995">return</span>&nbsp;<span class="ident" id="5676002">image</span><span class="op" id="5676007">.</span><span class="ident" id="5676008">Config</span><span class="op" id="5676014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5676019">ColorModel</span><span class="op" id="5676029">:</span>&nbsp;<span class="ident" id="5676031">color</span><span class="op" id="5676036">.</span><span class="ident" id="5676037">YCbCrModel</span><span class="op" id="5676047">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5676052">Width</span><span class="op" id="5676057">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5676064">d</span><span class="op" id="5676065">.</span><span class="ident" id="5676066">width</span><span class="op" id="5676071">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5676076">Height</span><span class="op" id="5676082">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5676088">d</span><span class="op" id="5676089">.</span><span class="ident" id="5676090">height</span><span class="op" id="5676096">,</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5676100">}</span><span class="op" id="5676101">,</span>&nbsp;<span class="ident" id="5676103">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5676108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5676111">return</span>&nbsp;<span class="ident" id="5676118">image</span><span class="op" id="5676123">.</span><span class="ident" id="5676124">Config</span><span class="op" id="5676130">{</span><span class="op" id="5676131">}</span><span class="op" id="5676132">,</span>&nbsp;<span class="ident" id="5676134">FormatError</span><span class="op" id="5676145">(</span><span class="string" id="5676146">&#34;missing&nbsp;SOF&nbsp;marker&#34;</span><span class="op" id="5676166">)</span><br>
<span class="lineno"></span><span class="op" id="5676168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">525</span><span class="keyword" id="5676171">func</span>&nbsp;<span class="ident" id="5676176">init</span><span class="op" id="5676180">(</span><span class="op" id="5676181">)</span>&nbsp;<span class="op" id="5676183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5676186">image</span><span class="op" id="5676191">.</span><span class="ident" id="5676192">RegisterFormat</span><span class="op" id="5676206">(</span><span class="string" id="5676207">&#34;jpeg&#34;</span><span class="op" id="5676213">,</span>&nbsp;<span class="string" id="5676215">&#34;\xff\xd8&#34;</span><span class="op" id="5676225">,</span>&nbsp;<span class="ident" id="5676227">Decode</span><span class="op" id="5676233">,</span>&nbsp;<span class="ident" id="5676235">DecodeConfig</span><span class="op" id="5676247">)</span><br>
<span class="lineno"></span><span class="op" id="5676249">}</span>
</div>
</body>
</html>
