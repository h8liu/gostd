<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html" class="current">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4440665">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4440720">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4440774">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4440825">package</span>&nbsp;<span class="ident" id="4440833">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4440838">import</span>&nbsp;<span class="op" id="4440845">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4440848">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4440858">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4440874">&#34;crypto/elliptic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4440893">&#34;crypto/md5&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4440907">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4440921">&#34;crypto/sha1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4440936">&#34;crypto/sha256&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4440953">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4440968">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4440985">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4440995">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4441001">&#34;math/big&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4441012">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4441015">var</span>&nbsp;<span class="ident" id="4441019">errClientKeyExchange</span>&nbsp;<span class="op" id="4441040">=</span>&nbsp;<span class="ident" id="4441042">errors</span><span class="op" id="4441048">.</span><span class="ident" id="4441049">New</span><span class="op" id="4441052">(</span><span class="string" id="4441053">&#34;tls:&nbsp;invalid&nbsp;ClientKeyExchange&nbsp;message&#34;</span><span class="op" id="4441093">)</span><br>
<span class="lineno"></span><span class="keyword" id="4441095">var</span>&nbsp;<span class="ident" id="4441099">errServerKeyExchange</span>&nbsp;<span class="op" id="4441120">=</span>&nbsp;<span class="ident" id="4441122">errors</span><span class="op" id="4441128">.</span><span class="ident" id="4441129">New</span><span class="op" id="4441132">(</span><span class="string" id="4441133">&#34;tls:&nbsp;invalid&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="4441173">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4441176">//&nbsp;rsaKeyAgreement&nbsp;implements&nbsp;the&nbsp;standard&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="4441254">//&nbsp;encrypts&nbsp;the&nbsp;pre-master&nbsp;secret&nbsp;to&nbsp;the&nbsp;server&#39;s&nbsp;public&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="4441316">type</span>&nbsp;<span class="ident" id="4441321">rsaKeyAgreement</span>&nbsp;<span class="keyword" id="4441337">struct</span><span class="op" id="4441343">{</span><span class="op" id="4441344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4441347">func</span>&nbsp;<span class="op" id="4441352">(</span><span class="ident" id="4441353">ka</span>&nbsp;<span class="ident" id="4441356">rsaKeyAgreement</span><span class="op" id="4441371">)</span>&nbsp;<span class="ident" id="4441373">generateServerKeyExchange</span><span class="op" id="4441398">(</span><span class="ident" id="4441399">config</span>&nbsp;<span class="op" id="4441406">*</span><span class="ident" id="4441407">Config</span><span class="op" id="4441413">,</span>&nbsp;<span class="ident" id="4441415">cert</span>&nbsp;<span class="op" id="4441420">*</span><span class="ident" id="4441421">Certificate</span><span class="op" id="4441432">,</span>&nbsp;<span class="ident" id="4441434">clientHello</span>&nbsp;<span class="op" id="4441446">*</span><span class="ident" id="4441447">clientHelloMsg</span><span class="op" id="4441461">,</span>&nbsp;<span class="ident" id="4441463">hello</span>&nbsp;<span class="op" id="4441469">*</span><span class="ident" id="4441470">serverHelloMsg</span><span class="op" id="4441484">)</span>&nbsp;<span class="op" id="4441486">(</span><span class="op" id="4441487">*</span><span class="ident" id="4441488">serverKeyExchangeMsg</span><span class="op" id="4441508">,</span>&nbsp;<span class="builtintype" id="4441510">error</span><span class="op" id="4441515">)</span>&nbsp;<span class="op" id="4441517">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441520">return</span>&nbsp;<span class="builtintype" id="4441527">nil</span><span class="op" id="4441530">,</span>&nbsp;<span class="builtintype" id="4441532">nil</span><br>
<span class="lineno"></span><span class="op" id="4441536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4441539">func</span>&nbsp;<span class="op" id="4441544">(</span><span class="ident" id="4441545">ka</span>&nbsp;<span class="ident" id="4441548">rsaKeyAgreement</span><span class="op" id="4441563">)</span>&nbsp;<span class="ident" id="4441565">processClientKeyExchange</span><span class="op" id="4441589">(</span><span class="ident" id="4441590">config</span>&nbsp;<span class="op" id="4441597">*</span><span class="ident" id="4441598">Config</span><span class="op" id="4441604">,</span>&nbsp;<span class="ident" id="4441606">cert</span>&nbsp;<span class="op" id="4441611">*</span><span class="ident" id="4441612">Certificate</span><span class="op" id="4441623">,</span>&nbsp;<span class="ident" id="4441625">ckx</span>&nbsp;<span class="op" id="4441629">*</span><span class="ident" id="4441630">clientKeyExchangeMsg</span><span class="op" id="4441650">,</span>&nbsp;<span class="ident" id="4441652">version</span>&nbsp;<span class="builtintype" id="4441660">uint16</span><span class="op" id="4441666">)</span>&nbsp;<span class="op" id="4441668">(</span><span class="op" id="4441669">[</span><span class="op" id="4441670">]</span><span class="builtintype" id="4441671">byte</span><span class="op" id="4441675">,</span>&nbsp;<span class="builtintype" id="4441677">error</span><span class="op" id="4441682">)</span>&nbsp;<span class="op" id="4441684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4441687">preMasterSecret</span>&nbsp;<span class="op" id="4441703">:=</span>&nbsp;<span class="builtinfunc" id="4441706">make</span><span class="op" id="4441710">(</span><span class="op" id="4441711">[</span><span class="op" id="4441712">]</span><span class="builtintype" id="4441713">byte</span><span class="op" id="4441717">,</span>&nbsp;<span class="num" id="4441719">48</span><span class="op" id="4441721">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4441724">_</span><span class="op" id="4441725">,</span>&nbsp;<span class="ident" id="4441727">err</span>&nbsp;<span class="op" id="4441731">:=</span>&nbsp;<span class="ident" id="4441734">io</span><span class="op" id="4441736">.</span><span class="ident" id="4441737">ReadFull</span><span class="op" id="4441745">(</span><span class="ident" id="4441746">config</span><span class="op" id="4441752">.</span><span class="ident" id="4441753">rand</span><span class="op" id="4441757">(</span><span class="op" id="4441758">)</span><span class="op" id="4441759">,</span>&nbsp;<span class="ident" id="4441761">preMasterSecret</span><span class="op" id="4441776">[</span><span class="num" id="4441777">2</span><span class="op" id="4441778">:</span><span class="op" id="4441779">]</span><span class="op" id="4441780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441783">if</span>&nbsp;<span class="ident" id="4441786">err</span>&nbsp;<span class="op" id="4441790">!=</span>&nbsp;<span class="builtintype" id="4441793">nil</span>&nbsp;<span class="op" id="4441797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441801">return</span>&nbsp;<span class="builtintype" id="4441808">nil</span><span class="op" id="4441811">,</span>&nbsp;<span class="ident" id="4441813">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4441818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441822">if</span>&nbsp;<span class="builtinfunc" id="4441825">len</span><span class="op" id="4441828">(</span><span class="ident" id="4441829">ckx</span><span class="op" id="4441832">.</span><span class="ident" id="4441833">ciphertext</span><span class="op" id="4441843">)</span>&nbsp;<span class="op" id="4441845">&lt;</span>&nbsp;<span class="num" id="4441847">2</span>&nbsp;<span class="op" id="4441849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441853">return</span>&nbsp;<span class="builtintype" id="4441860">nil</span><span class="op" id="4441863">,</span>&nbsp;<span class="ident" id="4441865">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4441887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4441891">ciphertext</span>&nbsp;<span class="op" id="4441902">:=</span>&nbsp;<span class="ident" id="4441905">ckx</span><span class="op" id="4441908">.</span><span class="ident" id="4441909">ciphertext</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441921">if</span>&nbsp;<span class="ident" id="4441924">version</span>&nbsp;<span class="op" id="4441932">!=</span>&nbsp;<span class="ident" id="4441935">VersionSSL30</span>&nbsp;<span class="op" id="4441948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4441952">ciphertextLen</span>&nbsp;<span class="op" id="4441966">:=</span>&nbsp;<span class="builtintype" id="4441969">int</span><span class="op" id="4441972">(</span><span class="ident" id="4441973">ckx</span><span class="op" id="4441976">.</span><span class="ident" id="4441977">ciphertext</span><span class="op" id="4441987">[</span><span class="num" id="4441988">0</span><span class="op" id="4441989">]</span><span class="op" id="4441990">)</span><span class="op" id="4441991">&lt;&lt;</span><span class="num" id="4441993">8</span>&nbsp;<span class="op" id="4441995">|</span>&nbsp;<span class="builtintype" id="4441997">int</span><span class="op" id="4442000">(</span><span class="ident" id="4442001">ckx</span><span class="op" id="4442004">.</span><span class="ident" id="4442005">ciphertext</span><span class="op" id="4442015">[</span><span class="num" id="4442016">1</span><span class="op" id="4442017">]</span><span class="op" id="4442018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442022">if</span>&nbsp;<span class="ident" id="4442025">ciphertextLen</span>&nbsp;<span class="op" id="4442039">!=</span>&nbsp;<span class="builtinfunc" id="4442042">len</span><span class="op" id="4442045">(</span><span class="ident" id="4442046">ckx</span><span class="op" id="4442049">.</span><span class="ident" id="4442050">ciphertext</span><span class="op" id="4442060">)</span><span class="op" id="4442061">-</span><span class="num" id="4442062">2</span>&nbsp;<span class="op" id="4442064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442069">return</span>&nbsp;<span class="builtintype" id="4442076">nil</span><span class="op" id="4442079">,</span>&nbsp;<span class="ident" id="4442081">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4442104">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4442108">ciphertext</span>&nbsp;<span class="op" id="4442119">=</span>&nbsp;<span class="ident" id="4442121">ckx</span><span class="op" id="4442124">.</span><span class="ident" id="4442125">ciphertext</span><span class="op" id="4442135">[</span><span class="num" id="4442136">2</span><span class="op" id="4442137">:</span><span class="op" id="4442138">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4442141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4442145">err</span>&nbsp;<span class="op" id="4442149">=</span>&nbsp;<span class="ident" id="4442151">rsa</span><span class="op" id="4442154">.</span><span class="ident" id="4442155">DecryptPKCS1v15SessionKey</span><span class="op" id="4442180">(</span><span class="ident" id="4442181">config</span><span class="op" id="4442187">.</span><span class="ident" id="4442188">rand</span><span class="op" id="4442192">(</span><span class="op" id="4442193">)</span><span class="op" id="4442194">,</span>&nbsp;<span class="ident" id="4442196">cert</span><span class="op" id="4442200">.</span><span class="ident" id="4442201">PrivateKey</span><span class="op" id="4442211">.</span><span class="op" id="4442212">(</span><span class="op" id="4442213">*</span><span class="ident" id="4442214">rsa</span><span class="op" id="4442217">.</span><span class="ident" id="4442218">PrivateKey</span><span class="op" id="4442228">)</span><span class="op" id="4442229">,</span>&nbsp;<span class="ident" id="4442231">ciphertext</span><span class="op" id="4442241">,</span>&nbsp;<span class="ident" id="4442243">preMasterSecret</span><span class="op" id="4442258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442261">if</span>&nbsp;<span class="ident" id="4442264">err</span>&nbsp;<span class="op" id="4442268">!=</span>&nbsp;<span class="builtintype" id="4442271">nil</span>&nbsp;<span class="op" id="4442275">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442279">return</span>&nbsp;<span class="builtintype" id="4442286">nil</span><span class="op" id="4442289">,</span>&nbsp;<span class="ident" id="4442291">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4442296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4442299">//&nbsp;We&nbsp;don&#39;t&nbsp;check&nbsp;the&nbsp;version&nbsp;number&nbsp;in&nbsp;the&nbsp;premaster&nbsp;secret.&nbsp;&nbsp;For&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4442372">//&nbsp;by&nbsp;checking&nbsp;it,&nbsp;we&nbsp;would&nbsp;leak&nbsp;information&nbsp;about&nbsp;the&nbsp;validity&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4442444">//&nbsp;encrypted&nbsp;pre-master&nbsp;secret.&nbsp;Secondly,&nbsp;it&nbsp;provides&nbsp;only&nbsp;a&nbsp;small</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4442512">//&nbsp;benefit&nbsp;against&nbsp;a&nbsp;downgrade&nbsp;attack&nbsp;and&nbsp;some&nbsp;implementations&nbsp;send&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4442585">//&nbsp;wrong&nbsp;version&nbsp;anyway.&nbsp;See&nbsp;the&nbsp;discussion&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;section</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4442652">//&nbsp;7.4.7.1&nbsp;of&nbsp;RFC&nbsp;4346.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442677">return</span>&nbsp;<span class="ident" id="4442684">preMasterSecret</span><span class="op" id="4442699">,</span>&nbsp;<span class="builtintype" id="4442701">nil</span><br>
<span class="lineno"></span><span class="op" id="4442705">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="4442708">func</span>&nbsp;<span class="op" id="4442713">(</span><span class="ident" id="4442714">ka</span>&nbsp;<span class="ident" id="4442717">rsaKeyAgreement</span><span class="op" id="4442732">)</span>&nbsp;<span class="ident" id="4442734">processServerKeyExchange</span><span class="op" id="4442758">(</span><span class="ident" id="4442759">config</span>&nbsp;<span class="op" id="4442766">*</span><span class="ident" id="4442767">Config</span><span class="op" id="4442773">,</span>&nbsp;<span class="ident" id="4442775">clientHello</span>&nbsp;<span class="op" id="4442787">*</span><span class="ident" id="4442788">clientHelloMsg</span><span class="op" id="4442802">,</span>&nbsp;<span class="ident" id="4442804">serverHello</span>&nbsp;<span class="op" id="4442816">*</span><span class="ident" id="4442817">serverHelloMsg</span><span class="op" id="4442831">,</span>&nbsp;<span class="ident" id="4442833">cert</span>&nbsp;<span class="op" id="4442838">*</span><span class="ident" id="4442839">x509</span><span class="op" id="4442843">.</span><span class="ident" id="4442844">Certificate</span><span class="op" id="4442855">,</span>&nbsp;<span class="ident" id="4442857">skx</span>&nbsp;<span class="op" id="4442861">*</span><span class="ident" id="4442862">serverKeyExchangeMsg</span><span class="op" id="4442882">)</span>&nbsp;<span class="builtintype" id="4442884">error</span>&nbsp;<span class="op" id="4442890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442893">return</span>&nbsp;<span class="ident" id="4442900">errors</span><span class="op" id="4442906">.</span><span class="ident" id="4442907">New</span><span class="op" id="4442910">(</span><span class="string" id="4442911">&#34;tls:&nbsp;unexpected&nbsp;ServerKeyExchange&#34;</span><span class="op" id="4442946">)</span><br>
<span class="lineno"></span><span class="op" id="4442948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="4442951">func</span>&nbsp;<span class="op" id="4442956">(</span><span class="ident" id="4442957">ka</span>&nbsp;<span class="ident" id="4442960">rsaKeyAgreement</span><span class="op" id="4442975">)</span>&nbsp;<span class="ident" id="4442977">generateClientKeyExchange</span><span class="op" id="4443002">(</span><span class="ident" id="4443003">config</span>&nbsp;<span class="op" id="4443010">*</span><span class="ident" id="4443011">Config</span><span class="op" id="4443017">,</span>&nbsp;<span class="ident" id="4443019">clientHello</span>&nbsp;<span class="op" id="4443031">*</span><span class="ident" id="4443032">clientHelloMsg</span><span class="op" id="4443046">,</span>&nbsp;<span class="ident" id="4443048">cert</span>&nbsp;<span class="op" id="4443053">*</span><span class="ident" id="4443054">x509</span><span class="op" id="4443058">.</span><span class="ident" id="4443059">Certificate</span><span class="op" id="4443070">)</span>&nbsp;<span class="op" id="4443072">(</span><span class="op" id="4443073">[</span><span class="op" id="4443074">]</span><span class="builtintype" id="4443075">byte</span><span class="op" id="4443079">,</span>&nbsp;<span class="op" id="4443081">*</span><span class="ident" id="4443082">clientKeyExchangeMsg</span><span class="op" id="4443102">,</span>&nbsp;<span class="builtintype" id="4443104">error</span><span class="op" id="4443109">)</span>&nbsp;<span class="op" id="4443111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443114">preMasterSecret</span>&nbsp;<span class="op" id="4443130">:=</span>&nbsp;<span class="builtinfunc" id="4443133">make</span><span class="op" id="4443137">(</span><span class="op" id="4443138">[</span><span class="op" id="4443139">]</span><span class="builtintype" id="4443140">byte</span><span class="op" id="4443144">,</span>&nbsp;<span class="num" id="4443146">48</span><span class="op" id="4443148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443151">preMasterSecret</span><span class="op" id="4443166">[</span><span class="num" id="4443167">0</span><span class="op" id="4443168">]</span>&nbsp;<span class="op" id="4443170">=</span>&nbsp;<span class="builtintype" id="4443172">byte</span><span class="op" id="4443176">(</span><span class="ident" id="4443177">clientHello</span><span class="op" id="4443188">.</span><span class="ident" id="4443189">vers</span>&nbsp;<span class="op" id="4443194">&gt;&gt;</span>&nbsp;<span class="num" id="4443197">8</span><span class="op" id="4443198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443201">preMasterSecret</span><span class="op" id="4443216">[</span><span class="num" id="4443217">1</span><span class="op" id="4443218">]</span>&nbsp;<span class="op" id="4443220">=</span>&nbsp;<span class="builtintype" id="4443222">byte</span><span class="op" id="4443226">(</span><span class="ident" id="4443227">clientHello</span><span class="op" id="4443238">.</span><span class="ident" id="4443239">vers</span><span class="op" id="4443243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443246">_</span><span class="op" id="4443247">,</span>&nbsp;<span class="ident" id="4443249">err</span>&nbsp;<span class="op" id="4443253">:=</span>&nbsp;<span class="ident" id="4443256">io</span><span class="op" id="4443258">.</span><span class="ident" id="4443259">ReadFull</span><span class="op" id="4443267">(</span><span class="ident" id="4443268">config</span><span class="op" id="4443274">.</span><span class="ident" id="4443275">rand</span><span class="op" id="4443279">(</span><span class="op" id="4443280">)</span><span class="op" id="4443281">,</span>&nbsp;<span class="ident" id="4443283">preMasterSecret</span><span class="op" id="4443298">[</span><span class="num" id="4443299">2</span><span class="op" id="4443300">:</span><span class="op" id="4443301">]</span><span class="op" id="4443302">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4443305">if</span>&nbsp;<span class="ident" id="4443308">err</span>&nbsp;<span class="op" id="4443312">!=</span>&nbsp;<span class="builtintype" id="4443315">nil</span>&nbsp;<span class="op" id="4443319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4443323">return</span>&nbsp;<span class="builtintype" id="4443330">nil</span><span class="op" id="4443333">,</span>&nbsp;<span class="builtintype" id="4443335">nil</span><span class="op" id="4443338">,</span>&nbsp;<span class="ident" id="4443340">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4443345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443349">encrypted</span><span class="op" id="4443358">,</span>&nbsp;<span class="ident" id="4443360">err</span>&nbsp;<span class="op" id="4443364">:=</span>&nbsp;<span class="ident" id="4443367">rsa</span><span class="op" id="4443370">.</span><span class="ident" id="4443371">EncryptPKCS1v15</span><span class="op" id="4443386">(</span><span class="ident" id="4443387">config</span><span class="op" id="4443393">.</span><span class="ident" id="4443394">rand</span><span class="op" id="4443398">(</span><span class="op" id="4443399">)</span><span class="op" id="4443400">,</span>&nbsp;<span class="ident" id="4443402">cert</span><span class="op" id="4443406">.</span><span class="ident" id="4443407">PublicKey</span><span class="op" id="4443416">.</span><span class="op" id="4443417">(</span><span class="op" id="4443418">*</span><span class="ident" id="4443419">rsa</span><span class="op" id="4443422">.</span><span class="ident" id="4443423">PublicKey</span><span class="op" id="4443432">)</span><span class="op" id="4443433">,</span>&nbsp;<span class="ident" id="4443435">preMasterSecret</span><span class="op" id="4443450">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4443453">if</span>&nbsp;<span class="ident" id="4443456">err</span>&nbsp;<span class="op" id="4443460">!=</span>&nbsp;<span class="builtintype" id="4443463">nil</span>&nbsp;<span class="op" id="4443467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4443471">return</span>&nbsp;<span class="builtintype" id="4443478">nil</span><span class="op" id="4443481">,</span>&nbsp;<span class="builtintype" id="4443483">nil</span><span class="op" id="4443486">,</span>&nbsp;<span class="ident" id="4443488">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4443493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443496">ckx</span>&nbsp;<span class="op" id="4443500">:=</span>&nbsp;<span class="builtinfunc" id="4443503">new</span><span class="op" id="4443506">(</span><span class="ident" id="4443507">clientKeyExchangeMsg</span><span class="op" id="4443527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443530">ckx</span><span class="op" id="4443533">.</span><span class="ident" id="4443534">ciphertext</span>&nbsp;<span class="op" id="4443545">=</span>&nbsp;<span class="builtinfunc" id="4443547">make</span><span class="op" id="4443551">(</span><span class="op" id="4443552">[</span><span class="op" id="4443553">]</span><span class="builtintype" id="4443554">byte</span><span class="op" id="4443558">,</span>&nbsp;<span class="builtinfunc" id="4443560">len</span><span class="op" id="4443563">(</span><span class="ident" id="4443564">encrypted</span><span class="op" id="4443573">)</span><span class="op" id="4443574">+</span><span class="num" id="4443575">2</span><span class="op" id="4443576">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443579">ckx</span><span class="op" id="4443582">.</span><span class="ident" id="4443583">ciphertext</span><span class="op" id="4443593">[</span><span class="num" id="4443594">0</span><span class="op" id="4443595">]</span>&nbsp;<span class="op" id="4443597">=</span>&nbsp;<span class="builtintype" id="4443599">byte</span><span class="op" id="4443603">(</span><span class="builtinfunc" id="4443604">len</span><span class="op" id="4443607">(</span><span class="ident" id="4443608">encrypted</span><span class="op" id="4443617">)</span>&nbsp;<span class="op" id="4443619">&gt;&gt;</span>&nbsp;<span class="num" id="4443622">8</span><span class="op" id="4443623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443626">ckx</span><span class="op" id="4443629">.</span><span class="ident" id="4443630">ciphertext</span><span class="op" id="4443640">[</span><span class="num" id="4443641">1</span><span class="op" id="4443642">]</span>&nbsp;<span class="op" id="4443644">=</span>&nbsp;<span class="builtintype" id="4443646">byte</span><span class="op" id="4443650">(</span><span class="builtinfunc" id="4443651">len</span><span class="op" id="4443654">(</span><span class="ident" id="4443655">encrypted</span><span class="op" id="4443664">)</span><span class="op" id="4443665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4443668">copy</span><span class="op" id="4443672">(</span><span class="ident" id="4443673">ckx</span><span class="op" id="4443676">.</span><span class="ident" id="4443677">ciphertext</span><span class="op" id="4443687">[</span><span class="num" id="4443688">2</span><span class="op" id="4443689">:</span><span class="op" id="4443690">]</span><span class="op" id="4443691">,</span>&nbsp;<span class="ident" id="4443693">encrypted</span><span class="op" id="4443702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4443705">return</span>&nbsp;<span class="ident" id="4443712">preMasterSecret</span><span class="op" id="4443727">,</span>&nbsp;<span class="ident" id="4443729">ckx</span><span class="op" id="4443732">,</span>&nbsp;<span class="builtintype" id="4443734">nil</span><br>
<span class="lineno"></span><span class="op" id="4443738">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4443741">//&nbsp;sha1Hash&nbsp;calculates&nbsp;a&nbsp;SHA1&nbsp;hash&nbsp;over&nbsp;the&nbsp;given&nbsp;byte&nbsp;slices.</span><br>
<span class="lineno"></span><span class="keyword" id="4443804">func</span>&nbsp;<span class="ident" id="4443809">sha1Hash</span><span class="op" id="4443817">(</span><span class="ident" id="4443818">slices</span>&nbsp;<span class="op" id="4443825">[</span><span class="op" id="4443826">]</span><span class="op" id="4443827">[</span><span class="op" id="4443828">]</span><span class="builtintype" id="4443829">byte</span><span class="op" id="4443833">)</span>&nbsp;<span class="op" id="4443835">[</span><span class="op" id="4443836">]</span><span class="builtintype" id="4443837">byte</span>&nbsp;<span class="op" id="4443842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443845">hsha1</span>&nbsp;<span class="op" id="4443851">:=</span>&nbsp;<span class="ident" id="4443854">sha1</span><span class="op" id="4443858">.</span><span class="ident" id="4443859">New</span><span class="op" id="4443862">(</span><span class="op" id="4443863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4443866">for</span>&nbsp;<span class="ident" id="4443870">_</span><span class="op" id="4443871">,</span>&nbsp;<span class="ident" id="4443873">slice</span>&nbsp;<span class="op" id="4443879">:=</span>&nbsp;<span class="keyword" id="4443882">range</span>&nbsp;<span class="ident" id="4443888">slices</span>&nbsp;<span class="op" id="4443895">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443899">hsha1</span><span class="op" id="4443904">.</span><span class="ident" id="4443905">Write</span><span class="op" id="4443910">(</span><span class="ident" id="4443911">slice</span><span class="op" id="4443916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4443919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4443922">return</span>&nbsp;<span class="ident" id="4443929">hsha1</span><span class="op" id="4443934">.</span><span class="ident" id="4443935">Sum</span><span class="op" id="4443938">(</span><span class="builtintype" id="4443939">nil</span><span class="op" id="4443942">)</span><br>
<span class="lineno"></span><span class="op" id="4443944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="4443947">//&nbsp;md5SHA1Hash&nbsp;implements&nbsp;TLS&nbsp;1.0&#39;s&nbsp;hybrid&nbsp;hash&nbsp;function&nbsp;which&nbsp;consists&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4444026">//&nbsp;concatenation&nbsp;of&nbsp;an&nbsp;MD5&nbsp;and&nbsp;SHA1&nbsp;hash.</span><br>
<span class="lineno"></span><span class="keyword" id="4444068">func</span>&nbsp;<span class="ident" id="4444073">md5SHA1Hash</span><span class="op" id="4444084">(</span><span class="ident" id="4444085">slices</span>&nbsp;<span class="op" id="4444092">[</span><span class="op" id="4444093">]</span><span class="op" id="4444094">[</span><span class="op" id="4444095">]</span><span class="builtintype" id="4444096">byte</span><span class="op" id="4444100">)</span>&nbsp;<span class="op" id="4444102">[</span><span class="op" id="4444103">]</span><span class="builtintype" id="4444104">byte</span>&nbsp;<span class="op" id="4444109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4444112">md5sha1</span>&nbsp;<span class="op" id="4444120">:=</span>&nbsp;<span class="builtinfunc" id="4444123">make</span><span class="op" id="4444127">(</span><span class="op" id="4444128">[</span><span class="op" id="4444129">]</span><span class="builtintype" id="4444130">byte</span><span class="op" id="4444134">,</span>&nbsp;<span class="ident" id="4444136">md5</span><span class="op" id="4444139">.</span><span class="ident" id="4444140">Size</span><span class="op" id="4444144">+</span><span class="ident" id="4444145">sha1</span><span class="op" id="4444149">.</span><span class="ident" id="4444150">Size</span><span class="op" id="4444154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4444157">hmd5</span>&nbsp;<span class="op" id="4444162">:=</span>&nbsp;<span class="ident" id="4444165">md5</span><span class="op" id="4444168">.</span><span class="ident" id="4444169">New</span><span class="op" id="4444172">(</span><span class="op" id="4444173">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444176">for</span>&nbsp;<span class="ident" id="4444180">_</span><span class="op" id="4444181">,</span>&nbsp;<span class="ident" id="4444183">slice</span>&nbsp;<span class="op" id="4444189">:=</span>&nbsp;<span class="keyword" id="4444192">range</span>&nbsp;<span class="ident" id="4444198">slices</span>&nbsp;<span class="op" id="4444205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4444209">hmd5</span><span class="op" id="4444213">.</span><span class="ident" id="4444214">Write</span><span class="op" id="4444219">(</span><span class="ident" id="4444220">slice</span><span class="op" id="4444225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4444228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4444231">copy</span><span class="op" id="4444235">(</span><span class="ident" id="4444236">md5sha1</span><span class="op" id="4444243">,</span>&nbsp;<span class="ident" id="4444245">hmd5</span><span class="op" id="4444249">.</span><span class="ident" id="4444250">Sum</span><span class="op" id="4444253">(</span><span class="builtintype" id="4444254">nil</span><span class="op" id="4444257">)</span><span class="op" id="4444258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4444261">copy</span><span class="op" id="4444265">(</span><span class="ident" id="4444266">md5sha1</span><span class="op" id="4444273">[</span><span class="ident" id="4444274">md5</span><span class="op" id="4444277">.</span><span class="ident" id="4444278">Size</span><span class="op" id="4444282">:</span><span class="op" id="4444283">]</span><span class="op" id="4444284">,</span>&nbsp;<span class="ident" id="4444286">sha1Hash</span><span class="op" id="4444294">(</span><span class="ident" id="4444295">slices</span><span class="op" id="4444301">)</span><span class="op" id="4444302">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444305">return</span>&nbsp;<span class="ident" id="4444312">md5sha1</span><br>
<span class="lineno"></span><span class="op" id="4444320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4444323">//&nbsp;sha256Hash&nbsp;implements&nbsp;TLS&nbsp;1.2&#39;s&nbsp;hash&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="4444373">func</span>&nbsp;<span class="ident" id="4444378">sha256Hash</span><span class="op" id="4444388">(</span><span class="ident" id="4444389">slices</span>&nbsp;<span class="op" id="4444396">[</span><span class="op" id="4444397">]</span><span class="op" id="4444398">[</span><span class="op" id="4444399">]</span><span class="builtintype" id="4444400">byte</span><span class="op" id="4444404">)</span>&nbsp;<span class="op" id="4444406">[</span><span class="op" id="4444407">]</span><span class="builtintype" id="4444408">byte</span>&nbsp;<span class="op" id="4444413">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4444416">h</span>&nbsp;<span class="op" id="4444418">:=</span>&nbsp;<span class="ident" id="4444421">sha256</span><span class="op" id="4444427">.</span><span class="ident" id="4444428">New</span><span class="op" id="4444431">(</span><span class="op" id="4444432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444435">for</span>&nbsp;<span class="ident" id="4444439">_</span><span class="op" id="4444440">,</span>&nbsp;<span class="ident" id="4444442">slice</span>&nbsp;<span class="op" id="4444448">:=</span>&nbsp;<span class="keyword" id="4444451">range</span>&nbsp;<span class="ident" id="4444457">slices</span>&nbsp;<span class="op" id="4444464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4444468">h</span><span class="op" id="4444469">.</span><span class="ident" id="4444470">Write</span><span class="op" id="4444475">(</span><span class="ident" id="4444476">slice</span><span class="op" id="4444481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4444484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444487">return</span>&nbsp;<span class="ident" id="4444494">h</span><span class="op" id="4444495">.</span><span class="ident" id="4444496">Sum</span><span class="op" id="4444499">(</span><span class="builtintype" id="4444500">nil</span><span class="op" id="4444503">)</span><br>
<span class="lineno">120</span><span class="op" id="4444505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4444508">//&nbsp;hashForServerKeyExchange&nbsp;hashes&nbsp;the&nbsp;given&nbsp;slices&nbsp;and&nbsp;returns&nbsp;their&nbsp;digest</span><br>
<span class="lineno"></span><span class="comment" id="4444585">//&nbsp;and&nbsp;the&nbsp;identifier&nbsp;of&nbsp;the&nbsp;hash&nbsp;function&nbsp;used.&nbsp;The&nbsp;hashFunc&nbsp;argument&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="4444664">//&nbsp;used&nbsp;for&nbsp;&gt;=&nbsp;TLS&nbsp;1.2&nbsp;and&nbsp;precisely&nbsp;identifies&nbsp;the&nbsp;hash&nbsp;function&nbsp;to&nbsp;use.</span><br>
<span class="lineno">125</span><span class="keyword" id="4444738">func</span>&nbsp;<span class="ident" id="4444743">hashForServerKeyExchange</span><span class="op" id="4444767">(</span><span class="ident" id="4444768">sigType</span><span class="op" id="4444775">,</span>&nbsp;<span class="ident" id="4444777">hashFunc</span>&nbsp;<span class="builtintype" id="4444786">uint8</span><span class="op" id="4444791">,</span>&nbsp;<span class="ident" id="4444793">version</span>&nbsp;<span class="builtintype" id="4444801">uint16</span><span class="op" id="4444807">,</span>&nbsp;<span class="ident" id="4444809">slices</span>&nbsp;<span class="op" id="4444816">...</span><span class="op" id="4444819">[</span><span class="op" id="4444820">]</span><span class="builtintype" id="4444821">byte</span><span class="op" id="4444825">)</span>&nbsp;<span class="op" id="4444827">(</span><span class="op" id="4444828">[</span><span class="op" id="4444829">]</span><span class="builtintype" id="4444830">byte</span><span class="op" id="4444834">,</span>&nbsp;<span class="ident" id="4444836">crypto</span><span class="op" id="4444842">.</span><span class="ident" id="4444843">Hash</span><span class="op" id="4444847">,</span>&nbsp;<span class="builtintype" id="4444849">error</span><span class="op" id="4444854">)</span>&nbsp;<span class="op" id="4444856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444859">if</span>&nbsp;<span class="ident" id="4444862">version</span>&nbsp;<span class="op" id="4444870">&gt;=</span>&nbsp;<span class="ident" id="4444873">VersionTLS12</span>&nbsp;<span class="op" id="4444886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444890">switch</span>&nbsp;<span class="ident" id="4444897">hashFunc</span>&nbsp;<span class="op" id="4444906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444910">case</span>&nbsp;<span class="ident" id="4444915">hashSHA256</span><span class="op" id="4444925">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444930">return</span>&nbsp;<span class="ident" id="4444937">sha256Hash</span><span class="op" id="4444947">(</span><span class="ident" id="4444948">slices</span><span class="op" id="4444954">)</span><span class="op" id="4444955">,</span>&nbsp;<span class="ident" id="4444957">crypto</span><span class="op" id="4444963">.</span><span class="ident" id="4444964">SHA256</span><span class="op" id="4444970">,</span>&nbsp;<span class="builtintype" id="4444972">nil</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444978">case</span>&nbsp;<span class="ident" id="4444983">hashSHA1</span><span class="op" id="4444991">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444996">return</span>&nbsp;<span class="ident" id="4445003">sha1Hash</span><span class="op" id="4445011">(</span><span class="ident" id="4445012">slices</span><span class="op" id="4445018">)</span><span class="op" id="4445019">,</span>&nbsp;<span class="ident" id="4445021">crypto</span><span class="op" id="4445027">.</span><span class="ident" id="4445028">SHA1</span><span class="op" id="4445032">,</span>&nbsp;<span class="builtintype" id="4445034">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4445040">default</span><span class="op" id="4445047">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4445052">return</span>&nbsp;<span class="builtintype" id="4445059">nil</span><span class="op" id="4445062">,</span>&nbsp;<span class="ident" id="4445064">crypto</span><span class="op" id="4445070">.</span><span class="ident" id="4445071">Hash</span><span class="op" id="4445075">(</span><span class="num" id="4445076">0</span><span class="op" id="4445077">)</span><span class="op" id="4445078">,</span>&nbsp;<span class="ident" id="4445080">errors</span><span class="op" id="4445086">.</span><span class="ident" id="4445087">New</span><span class="op" id="4445090">(</span><span class="string" id="4445091">&#34;tls:&nbsp;unknown&nbsp;hash&nbsp;function&nbsp;used&nbsp;by&nbsp;peer&#34;</span><span class="op" id="4445132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4445136">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4445139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4445142">if</span>&nbsp;<span class="ident" id="4445145">sigType</span>&nbsp;<span class="op" id="4445153">==</span>&nbsp;<span class="ident" id="4445156">signatureECDSA</span>&nbsp;<span class="op" id="4445171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4445175">return</span>&nbsp;<span class="ident" id="4445182">sha1Hash</span><span class="op" id="4445190">(</span><span class="ident" id="4445191">slices</span><span class="op" id="4445197">)</span><span class="op" id="4445198">,</span>&nbsp;<span class="ident" id="4445200">crypto</span><span class="op" id="4445206">.</span><span class="ident" id="4445207">SHA1</span><span class="op" id="4445211">,</span>&nbsp;<span class="builtintype" id="4445213">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4445218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4445221">return</span>&nbsp;<span class="ident" id="4445228">md5SHA1Hash</span><span class="op" id="4445239">(</span><span class="ident" id="4445240">slices</span><span class="op" id="4445246">)</span><span class="op" id="4445247">,</span>&nbsp;<span class="ident" id="4445249">crypto</span><span class="op" id="4445255">.</span><span class="ident" id="4445256">MD5SHA1</span><span class="op" id="4445263">,</span>&nbsp;<span class="builtintype" id="4445265">nil</span><br>
<span class="lineno">140</span><span class="op" id="4445269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4445272">//&nbsp;pickTLS12HashForSignature&nbsp;returns&nbsp;a&nbsp;TLS&nbsp;1.2&nbsp;hash&nbsp;identifier&nbsp;for&nbsp;signing&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4445349">//&nbsp;ServerKeyExchange&nbsp;given&nbsp;the&nbsp;signature&nbsp;type&nbsp;being&nbsp;used&nbsp;and&nbsp;the&nbsp;client&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4445423">//&nbsp;advertised&nbsp;list&nbsp;of&nbsp;supported&nbsp;signature&nbsp;and&nbsp;hash&nbsp;combinations.</span><br>
<span class="lineno">145</span><span class="keyword" id="4445488">func</span>&nbsp;<span class="ident" id="4445493">pickTLS12HashForSignature</span><span class="op" id="4445518">(</span><span class="ident" id="4445519">sigType</span>&nbsp;<span class="builtintype" id="4445527">uint8</span><span class="op" id="4445532">,</span>&nbsp;<span class="ident" id="4445534">clientSignatureAndHashes</span>&nbsp;<span class="op" id="4445559">[</span><span class="op" id="4445560">]</span><span class="ident" id="4445561">signatureAndHash</span><span class="op" id="4445577">)</span>&nbsp;<span class="op" id="4445579">(</span><span class="builtintype" id="4445580">uint8</span><span class="op" id="4445585">,</span>&nbsp;<span class="builtintype" id="4445587">error</span><span class="op" id="4445592">)</span>&nbsp;<span class="op" id="4445594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4445597">if</span>&nbsp;<span class="builtinfunc" id="4445600">len</span><span class="op" id="4445603">(</span><span class="ident" id="4445604">clientSignatureAndHashes</span><span class="op" id="4445628">)</span>&nbsp;<span class="op" id="4445630">==</span>&nbsp;<span class="num" id="4445633">0</span>&nbsp;<span class="op" id="4445635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4445639">//&nbsp;If&nbsp;the&nbsp;client&nbsp;didn&#39;t&nbsp;specify&nbsp;any&nbsp;signature_algorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4445698">//&nbsp;extension&nbsp;then&nbsp;we&nbsp;can&nbsp;assume&nbsp;that&nbsp;it&nbsp;supports&nbsp;SHA1.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4445759">//&nbsp;http://tools.ietf.org/html/rfc5246#section-7.4.1.4.1</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4445817">return</span>&nbsp;<span class="ident" id="4445824">hashSHA1</span><span class="op" id="4445832">,</span>&nbsp;<span class="builtintype" id="4445834">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4445839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4445843">for</span>&nbsp;<span class="ident" id="4445847">_</span><span class="op" id="4445848">,</span>&nbsp;<span class="ident" id="4445850">sigAndHash</span>&nbsp;<span class="op" id="4445861">:=</span>&nbsp;<span class="keyword" id="4445864">range</span>&nbsp;<span class="ident" id="4445870">clientSignatureAndHashes</span>&nbsp;<span class="op" id="4445895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4445899">if</span>&nbsp;<span class="ident" id="4445902">sigAndHash</span><span class="op" id="4445912">.</span><span class="ident" id="4445913">signature</span>&nbsp;<span class="op" id="4445923">!=</span>&nbsp;<span class="ident" id="4445926">sigType</span>&nbsp;<span class="op" id="4445934">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4445939">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4445950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4445954">switch</span>&nbsp;<span class="ident" id="4445961">sigAndHash</span><span class="op" id="4445971">.</span><span class="ident" id="4445972">hash</span>&nbsp;<span class="op" id="4445977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4445981">case</span>&nbsp;<span class="ident" id="4445986">hashSHA1</span><span class="op" id="4445994">,</span>&nbsp;<span class="ident" id="4445996">hashSHA256</span><span class="op" id="4446006">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446011">return</span>&nbsp;<span class="ident" id="4446018">sigAndHash</span><span class="op" id="4446028">.</span><span class="ident" id="4446029">hash</span><span class="op" id="4446033">,</span>&nbsp;<span class="builtintype" id="4446035">nil</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4446041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4446044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446048">return</span>&nbsp;<span class="num" id="4446055">0</span><span class="op" id="4446056">,</span>&nbsp;<span class="ident" id="4446058">errors</span><span class="op" id="4446064">.</span><span class="ident" id="4446065">New</span><span class="op" id="4446068">(</span><span class="string" id="4446069">&#34;tls:&nbsp;client&nbsp;doesn&#39;t&nbsp;support&nbsp;any&nbsp;common&nbsp;hash&nbsp;functions&#34;</span><span class="op" id="4446124">)</span><br>
<span class="lineno"></span><span class="op" id="4446126">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="4446129">func</span>&nbsp;<span class="ident" id="4446134">curveForCurveID</span><span class="op" id="4446149">(</span><span class="ident" id="4446150">id</span>&nbsp;<span class="ident" id="4446153">CurveID</span><span class="op" id="4446160">)</span>&nbsp;<span class="op" id="4446162">(</span><span class="ident" id="4446163">elliptic</span><span class="op" id="4446171">.</span><span class="ident" id="4446172">Curve</span><span class="op" id="4446177">,</span>&nbsp;<span class="builtintype" id="4446179">bool</span><span class="op" id="4446183">)</span>&nbsp;<span class="op" id="4446185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446188">switch</span>&nbsp;<span class="ident" id="4446195">id</span>&nbsp;<span class="op" id="4446198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446201">case</span>&nbsp;<span class="ident" id="4446206">CurveP256</span><span class="op" id="4446215">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446219">return</span>&nbsp;<span class="ident" id="4446226">elliptic</span><span class="op" id="4446234">.</span><span class="ident" id="4446235">P256</span><span class="op" id="4446239">(</span><span class="op" id="4446240">)</span><span class="op" id="4446241">,</span>&nbsp;<span class="builtintype" id="4446243">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446249">case</span>&nbsp;<span class="ident" id="4446254">CurveP384</span><span class="op" id="4446263">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446267">return</span>&nbsp;<span class="ident" id="4446274">elliptic</span><span class="op" id="4446282">.</span><span class="ident" id="4446283">P384</span><span class="op" id="4446287">(</span><span class="op" id="4446288">)</span><span class="op" id="4446289">,</span>&nbsp;<span class="builtintype" id="4446291">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446297">case</span>&nbsp;<span class="ident" id="4446302">CurveP521</span><span class="op" id="4446311">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446315">return</span>&nbsp;<span class="ident" id="4446322">elliptic</span><span class="op" id="4446330">.</span><span class="ident" id="4446331">P521</span><span class="op" id="4446335">(</span><span class="op" id="4446336">)</span><span class="op" id="4446337">,</span>&nbsp;<span class="builtintype" id="4446339">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446345">default</span><span class="op" id="4446352">:</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446356">return</span>&nbsp;<span class="builtintype" id="4446363">nil</span><span class="op" id="4446366">,</span>&nbsp;<span class="builtintype" id="4446368">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4446375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="4446378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="comment" id="4446381">//&nbsp;ecdheRSAKeyAgreement&nbsp;implements&nbsp;a&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="4446453">//&nbsp;generates&nbsp;a&nbsp;ephemeral&nbsp;EC&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;and&nbsp;signs&nbsp;it.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="4446523">//&nbsp;pre-master&nbsp;secret&nbsp;is&nbsp;then&nbsp;calculated&nbsp;using&nbsp;ECDH.&nbsp;The&nbsp;signature&nbsp;may</span><br>
<span class="lineno"></span><span class="comment" id="4446593">//&nbsp;either&nbsp;be&nbsp;ECDSA&nbsp;or&nbsp;RSA.</span><br>
<span class="lineno"></span><span class="keyword" id="4446620">type</span>&nbsp;<span class="ident" id="4446625">ecdheKeyAgreement</span>&nbsp;<span class="keyword" id="4446643">struct</span>&nbsp;<span class="op" id="4446650">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4446653">version</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4446664">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4446672">sigType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4446683">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4446690">privateKey</span>&nbsp;<span class="op" id="4446701">[</span><span class="op" id="4446702">]</span><span class="builtintype" id="4446703">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4446709">curve</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4446720">elliptic</span><span class="op" id="4446728">.</span><span class="ident" id="4446729">Curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4446736">x</span><span class="op" id="4446737">,</span>&nbsp;<span class="ident" id="4446739">y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4446747">*</span><span class="ident" id="4446748">big</span><span class="op" id="4446751">.</span><span class="ident" id="4446752">Int</span><br>
<span class="lineno">190</span><span class="op" id="4446756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4446759">func</span>&nbsp;<span class="op" id="4446764">(</span><span class="ident" id="4446765">ka</span>&nbsp;<span class="op" id="4446768">*</span><span class="ident" id="4446769">ecdheKeyAgreement</span><span class="op" id="4446786">)</span>&nbsp;<span class="ident" id="4446788">generateServerKeyExchange</span><span class="op" id="4446813">(</span><span class="ident" id="4446814">config</span>&nbsp;<span class="op" id="4446821">*</span><span class="ident" id="4446822">Config</span><span class="op" id="4446828">,</span>&nbsp;<span class="ident" id="4446830">cert</span>&nbsp;<span class="op" id="4446835">*</span><span class="ident" id="4446836">Certificate</span><span class="op" id="4446847">,</span>&nbsp;<span class="ident" id="4446849">clientHello</span>&nbsp;<span class="op" id="4446861">*</span><span class="ident" id="4446862">clientHelloMsg</span><span class="op" id="4446876">,</span>&nbsp;<span class="ident" id="4446878">hello</span>&nbsp;<span class="op" id="4446884">*</span><span class="ident" id="4446885">serverHelloMsg</span><span class="op" id="4446899">)</span>&nbsp;<span class="op" id="4446901">(</span><span class="op" id="4446902">*</span><span class="ident" id="4446903">serverKeyExchangeMsg</span><span class="op" id="4446923">,</span>&nbsp;<span class="builtintype" id="4446925">error</span><span class="op" id="4446930">)</span>&nbsp;<span class="op" id="4446932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446935">var</span>&nbsp;<span class="ident" id="4446939">curveid</span>&nbsp;<span class="ident" id="4446947">CurveID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4446956">preferredCurves</span>&nbsp;<span class="op" id="4446972">:=</span>&nbsp;<span class="ident" id="4446975">config</span><span class="op" id="4446981">.</span><span class="ident" id="4446982">curvePreferences</span><span class="op" id="4446998">(</span><span class="op" id="4446999">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="ident" id="4447002">NextCandidate</span><span class="op" id="4447015">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447018">for</span>&nbsp;<span class="ident" id="4447022">_</span><span class="op" id="4447023">,</span>&nbsp;<span class="ident" id="4447025">candidate</span>&nbsp;<span class="op" id="4447035">:=</span>&nbsp;<span class="keyword" id="4447038">range</span>&nbsp;<span class="ident" id="4447044">preferredCurves</span>&nbsp;<span class="op" id="4447060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447064">for</span>&nbsp;<span class="ident" id="4447068">_</span><span class="op" id="4447069">,</span>&nbsp;<span class="ident" id="4447071">c</span>&nbsp;<span class="op" id="4447073">:=</span>&nbsp;<span class="keyword" id="4447076">range</span>&nbsp;<span class="ident" id="4447082">clientHello</span><span class="op" id="4447093">.</span><span class="ident" id="4447094">supportedCurves</span>&nbsp;<span class="op" id="4447110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447115">if</span>&nbsp;<span class="ident" id="4447118">candidate</span>&nbsp;<span class="op" id="4447128">==</span>&nbsp;<span class="ident" id="4447131">c</span>&nbsp;<span class="op" id="4447133">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447139">curveid</span>&nbsp;<span class="op" id="4447147">=</span>&nbsp;<span class="ident" id="4447149">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447155">break</span>&nbsp;<span class="ident" id="4447161">NextCandidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4447178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4447182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4447185">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447189">if</span>&nbsp;<span class="ident" id="4447192">curveid</span>&nbsp;<span class="op" id="4447200">==</span>&nbsp;<span class="num" id="4447203">0</span>&nbsp;<span class="op" id="4447205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447209">return</span>&nbsp;<span class="builtintype" id="4447216">nil</span><span class="op" id="4447219">,</span>&nbsp;<span class="ident" id="4447221">errors</span><span class="op" id="4447227">.</span><span class="ident" id="4447228">New</span><span class="op" id="4447231">(</span><span class="string" id="4447232">&#34;tls:&nbsp;no&nbsp;supported&nbsp;elliptic&nbsp;curves&nbsp;offered&#34;</span><span class="op" id="4447275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4447278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447282">var</span>&nbsp;<span class="ident" id="4447286">ok</span>&nbsp;<span class="builtintype" id="4447289">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447295">if</span>&nbsp;<span class="ident" id="4447298">ka</span><span class="op" id="4447300">.</span><span class="ident" id="4447301">curve</span><span class="op" id="4447306">,</span>&nbsp;<span class="ident" id="4447308">ok</span>&nbsp;<span class="op" id="4447311">=</span>&nbsp;<span class="ident" id="4447313">curveForCurveID</span><span class="op" id="4447328">(</span><span class="ident" id="4447329">curveid</span><span class="op" id="4447336">)</span><span class="op" id="4447337">;</span>&nbsp;<span class="op" id="4447339">!</span><span class="ident" id="4447340">ok</span>&nbsp;<span class="op" id="4447343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447347">return</span>&nbsp;<span class="builtintype" id="4447354">nil</span><span class="op" id="4447357">,</span>&nbsp;<span class="ident" id="4447359">errors</span><span class="op" id="4447365">.</span><span class="ident" id="4447366">New</span><span class="op" id="4447369">(</span><span class="string" id="4447370">&#34;tls:&nbsp;preferredCurves&nbsp;includes&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4447419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4447422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447426">var</span>&nbsp;<span class="ident" id="4447430">x</span><span class="op" id="4447431">,</span>&nbsp;<span class="ident" id="4447433">y</span>&nbsp;<span class="op" id="4447435">*</span><span class="ident" id="4447436">big</span><span class="op" id="4447439">.</span><span class="ident" id="4447440">Int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447445">var</span>&nbsp;<span class="ident" id="4447449">err</span>&nbsp;<span class="builtintype" id="4447453">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447460">ka</span><span class="op" id="4447462">.</span><span class="ident" id="4447463">privateKey</span><span class="op" id="4447473">,</span>&nbsp;<span class="ident" id="4447475">x</span><span class="op" id="4447476">,</span>&nbsp;<span class="ident" id="4447478">y</span><span class="op" id="4447479">,</span>&nbsp;<span class="ident" id="4447481">err</span>&nbsp;<span class="op" id="4447485">=</span>&nbsp;<span class="ident" id="4447487">elliptic</span><span class="op" id="4447495">.</span><span class="ident" id="4447496">GenerateKey</span><span class="op" id="4447507">(</span><span class="ident" id="4447508">ka</span><span class="op" id="4447510">.</span><span class="ident" id="4447511">curve</span><span class="op" id="4447516">,</span>&nbsp;<span class="ident" id="4447518">config</span><span class="op" id="4447524">.</span><span class="ident" id="4447525">rand</span><span class="op" id="4447529">(</span><span class="op" id="4447530">)</span><span class="op" id="4447531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447534">if</span>&nbsp;<span class="ident" id="4447537">err</span>&nbsp;<span class="op" id="4447541">!=</span>&nbsp;<span class="builtintype" id="4447544">nil</span>&nbsp;<span class="op" id="4447548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447552">return</span>&nbsp;<span class="builtintype" id="4447559">nil</span><span class="op" id="4447562">,</span>&nbsp;<span class="ident" id="4447564">err</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4447569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447572">ecdhePublic</span>&nbsp;<span class="op" id="4447584">:=</span>&nbsp;<span class="ident" id="4447587">elliptic</span><span class="op" id="4447595">.</span><span class="ident" id="4447596">Marshal</span><span class="op" id="4447603">(</span><span class="ident" id="4447604">ka</span><span class="op" id="4447606">.</span><span class="ident" id="4447607">curve</span><span class="op" id="4447612">,</span>&nbsp;<span class="ident" id="4447614">x</span><span class="op" id="4447615">,</span>&nbsp;<span class="ident" id="4447617">y</span><span class="op" id="4447618">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4447622">//&nbsp;http://tools.ietf.org/html/rfc4492#section-5.4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447673">serverECDHParams</span>&nbsp;<span class="op" id="4447690">:=</span>&nbsp;<span class="builtinfunc" id="4447693">make</span><span class="op" id="4447697">(</span><span class="op" id="4447698">[</span><span class="op" id="4447699">]</span><span class="builtintype" id="4447700">byte</span><span class="op" id="4447704">,</span>&nbsp;<span class="num" id="4447706">1</span><span class="op" id="4447707">+</span><span class="num" id="4447708">2</span><span class="op" id="4447709">+</span><span class="num" id="4447710">1</span><span class="op" id="4447711">+</span><span class="builtinfunc" id="4447712">len</span><span class="op" id="4447715">(</span><span class="ident" id="4447716">ecdhePublic</span><span class="op" id="4447727">)</span><span class="op" id="4447728">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447731">serverECDHParams</span><span class="op" id="4447747">[</span><span class="num" id="4447748">0</span><span class="op" id="4447749">]</span>&nbsp;<span class="op" id="4447751">=</span>&nbsp;<span class="num" id="4447753">3</span>&nbsp;<span class="comment" id="4447755">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447771">serverECDHParams</span><span class="op" id="4447787">[</span><span class="num" id="4447788">1</span><span class="op" id="4447789">]</span>&nbsp;<span class="op" id="4447791">=</span>&nbsp;<span class="builtintype" id="4447793">byte</span><span class="op" id="4447797">(</span><span class="ident" id="4447798">curveid</span>&nbsp;<span class="op" id="4447806">&gt;&gt;</span>&nbsp;<span class="num" id="4447809">8</span><span class="op" id="4447810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447813">serverECDHParams</span><span class="op" id="4447829">[</span><span class="num" id="4447830">2</span><span class="op" id="4447831">]</span>&nbsp;<span class="op" id="4447833">=</span>&nbsp;<span class="builtintype" id="4447835">byte</span><span class="op" id="4447839">(</span><span class="ident" id="4447840">curveid</span><span class="op" id="4447847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447850">serverECDHParams</span><span class="op" id="4447866">[</span><span class="num" id="4447867">3</span><span class="op" id="4447868">]</span>&nbsp;<span class="op" id="4447870">=</span>&nbsp;<span class="builtintype" id="4447872">byte</span><span class="op" id="4447876">(</span><span class="builtinfunc" id="4447877">len</span><span class="op" id="4447880">(</span><span class="ident" id="4447881">ecdhePublic</span><span class="op" id="4447892">)</span><span class="op" id="4447893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4447896">copy</span><span class="op" id="4447900">(</span><span class="ident" id="4447901">serverECDHParams</span><span class="op" id="4447917">[</span><span class="num" id="4447918">4</span><span class="op" id="4447919">:</span><span class="op" id="4447920">]</span><span class="op" id="4447921">,</span>&nbsp;<span class="ident" id="4447923">ecdhePublic</span><span class="op" id="4447934">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447938">var</span>&nbsp;<span class="ident" id="4447942">tls12HashId</span>&nbsp;<span class="builtintype" id="4447954">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447961">if</span>&nbsp;<span class="ident" id="4447964">ka</span><span class="op" id="4447966">.</span><span class="ident" id="4447967">version</span>&nbsp;<span class="op" id="4447975">&gt;=</span>&nbsp;<span class="ident" id="4447978">VersionTLS12</span>&nbsp;<span class="op" id="4447991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447995">if</span>&nbsp;<span class="ident" id="4447998">tls12HashId</span><span class="op" id="4448009">,</span>&nbsp;<span class="ident" id="4448011">err</span>&nbsp;<span class="op" id="4448015">=</span>&nbsp;<span class="ident" id="4448017">pickTLS12HashForSignature</span><span class="op" id="4448042">(</span><span class="ident" id="4448043">ka</span><span class="op" id="4448045">.</span><span class="ident" id="4448046">sigType</span><span class="op" id="4448053">,</span>&nbsp;<span class="ident" id="4448055">clientHello</span><span class="op" id="4448066">.</span><span class="ident" id="4448067">signatureAndHashes</span><span class="op" id="4448085">)</span><span class="op" id="4448086">;</span>&nbsp;<span class="ident" id="4448088">err</span>&nbsp;<span class="op" id="4448092">!=</span>&nbsp;<span class="builtintype" id="4448095">nil</span>&nbsp;<span class="op" id="4448099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448104">return</span>&nbsp;<span class="builtintype" id="4448111">nil</span><span class="op" id="4448114">,</span>&nbsp;<span class="ident" id="4448116">err</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4448122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4448125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4448129">digest</span><span class="op" id="4448135">,</span>&nbsp;<span class="ident" id="4448137">hashFunc</span><span class="op" id="4448145">,</span>&nbsp;<span class="ident" id="4448147">err</span>&nbsp;<span class="op" id="4448151">:=</span>&nbsp;<span class="ident" id="4448154">hashForServerKeyExchange</span><span class="op" id="4448178">(</span><span class="ident" id="4448179">ka</span><span class="op" id="4448181">.</span><span class="ident" id="4448182">sigType</span><span class="op" id="4448189">,</span>&nbsp;<span class="ident" id="4448191">tls12HashId</span><span class="op" id="4448202">,</span>&nbsp;<span class="ident" id="4448204">ka</span><span class="op" id="4448206">.</span><span class="ident" id="4448207">version</span><span class="op" id="4448214">,</span>&nbsp;<span class="ident" id="4448216">clientHello</span><span class="op" id="4448227">.</span><span class="ident" id="4448228">random</span><span class="op" id="4448234">,</span>&nbsp;<span class="ident" id="4448236">hello</span><span class="op" id="4448241">.</span><span class="ident" id="4448242">random</span><span class="op" id="4448248">,</span>&nbsp;<span class="ident" id="4448250">serverECDHParams</span><span class="op" id="4448266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448269">if</span>&nbsp;<span class="ident" id="4448272">err</span>&nbsp;<span class="op" id="4448276">!=</span>&nbsp;<span class="builtintype" id="4448279">nil</span>&nbsp;<span class="op" id="4448283">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448287">return</span>&nbsp;<span class="builtintype" id="4448294">nil</span><span class="op" id="4448297">,</span>&nbsp;<span class="ident" id="4448299">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4448304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448307">var</span>&nbsp;<span class="ident" id="4448311">sig</span>&nbsp;<span class="op" id="4448315">[</span><span class="op" id="4448316">]</span><span class="builtintype" id="4448317">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448323">switch</span>&nbsp;<span class="ident" id="4448330">ka</span><span class="op" id="4448332">.</span><span class="ident" id="4448333">sigType</span>&nbsp;<span class="op" id="4448341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448344">case</span>&nbsp;<span class="ident" id="4448349">signatureECDSA</span><span class="op" id="4448363">:</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4448367">privKey</span><span class="op" id="4448374">,</span>&nbsp;<span class="ident" id="4448376">ok</span>&nbsp;<span class="op" id="4448379">:=</span>&nbsp;<span class="ident" id="4448382">cert</span><span class="op" id="4448386">.</span><span class="ident" id="4448387">PrivateKey</span><span class="op" id="4448397">.</span><span class="op" id="4448398">(</span><span class="op" id="4448399">*</span><span class="ident" id="4448400">ecdsa</span><span class="op" id="4448405">.</span><span class="ident" id="4448406">PrivateKey</span><span class="op" id="4448416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448420">if</span>&nbsp;<span class="op" id="4448423">!</span><span class="ident" id="4448424">ok</span>&nbsp;<span class="op" id="4448427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448432">return</span>&nbsp;<span class="builtintype" id="4448439">nil</span><span class="op" id="4448442">,</span>&nbsp;<span class="ident" id="4448444">errors</span><span class="op" id="4448450">.</span><span class="ident" id="4448451">New</span><span class="op" id="4448454">(</span><span class="string" id="4448455">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;an&nbsp;ECDSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="4448505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4448509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4448513">r</span><span class="op" id="4448514">,</span>&nbsp;<span class="ident" id="4448516">s</span><span class="op" id="4448517">,</span>&nbsp;<span class="ident" id="4448519">err</span>&nbsp;<span class="op" id="4448523">:=</span>&nbsp;<span class="ident" id="4448526">ecdsa</span><span class="op" id="4448531">.</span><span class="ident" id="4448532">Sign</span><span class="op" id="4448536">(</span><span class="ident" id="4448537">config</span><span class="op" id="4448543">.</span><span class="ident" id="4448544">rand</span><span class="op" id="4448548">(</span><span class="op" id="4448549">)</span><span class="op" id="4448550">,</span>&nbsp;<span class="ident" id="4448552">privKey</span><span class="op" id="4448559">,</span>&nbsp;<span class="ident" id="4448561">digest</span><span class="op" id="4448567">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448571">if</span>&nbsp;<span class="ident" id="4448574">err</span>&nbsp;<span class="op" id="4448578">!=</span>&nbsp;<span class="builtintype" id="4448581">nil</span>&nbsp;<span class="op" id="4448585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448590">return</span>&nbsp;<span class="builtintype" id="4448597">nil</span><span class="op" id="4448600">,</span>&nbsp;<span class="ident" id="4448602">errors</span><span class="op" id="4448608">.</span><span class="ident" id="4448609">New</span><span class="op" id="4448612">(</span><span class="string" id="4448613">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="4448649">+</span>&nbsp;<span class="ident" id="4448651">err</span><span class="op" id="4448654">.</span><span class="ident" id="4448655">Error</span><span class="op" id="4448660">(</span><span class="op" id="4448661">)</span><span class="op" id="4448662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4448666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4448670">sig</span><span class="op" id="4448673">,</span>&nbsp;<span class="ident" id="4448675">err</span>&nbsp;<span class="op" id="4448679">=</span>&nbsp;<span class="ident" id="4448681">asn1</span><span class="op" id="4448685">.</span><span class="ident" id="4448686">Marshal</span><span class="op" id="4448693">(</span><span class="ident" id="4448694">ecdsaSignature</span><span class="op" id="4448708">{</span><span class="ident" id="4448709">r</span><span class="op" id="4448710">,</span>&nbsp;<span class="ident" id="4448712">s</span><span class="op" id="4448713">}</span><span class="op" id="4448714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448717">case</span>&nbsp;<span class="ident" id="4448722">signatureRSA</span><span class="op" id="4448734">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4448738">privKey</span><span class="op" id="4448745">,</span>&nbsp;<span class="ident" id="4448747">ok</span>&nbsp;<span class="op" id="4448750">:=</span>&nbsp;<span class="ident" id="4448753">cert</span><span class="op" id="4448757">.</span><span class="ident" id="4448758">PrivateKey</span><span class="op" id="4448768">.</span><span class="op" id="4448769">(</span><span class="op" id="4448770">*</span><span class="ident" id="4448771">rsa</span><span class="op" id="4448774">.</span><span class="ident" id="4448775">PrivateKey</span><span class="op" id="4448785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448789">if</span>&nbsp;<span class="op" id="4448792">!</span><span class="ident" id="4448793">ok</span>&nbsp;<span class="op" id="4448796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448801">return</span>&nbsp;<span class="builtintype" id="4448808">nil</span><span class="op" id="4448811">,</span>&nbsp;<span class="ident" id="4448813">errors</span><span class="op" id="4448819">.</span><span class="ident" id="4448820">New</span><span class="op" id="4448823">(</span><span class="string" id="4448824">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="4448869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4448873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4448877">sig</span><span class="op" id="4448880">,</span>&nbsp;<span class="ident" id="4448882">err</span>&nbsp;<span class="op" id="4448886">=</span>&nbsp;<span class="ident" id="4448888">rsa</span><span class="op" id="4448891">.</span><span class="ident" id="4448892">SignPKCS1v15</span><span class="op" id="4448904">(</span><span class="ident" id="4448905">config</span><span class="op" id="4448911">.</span><span class="ident" id="4448912">rand</span><span class="op" id="4448916">(</span><span class="op" id="4448917">)</span><span class="op" id="4448918">,</span>&nbsp;<span class="ident" id="4448920">privKey</span><span class="op" id="4448927">,</span>&nbsp;<span class="ident" id="4448929">hashFunc</span><span class="op" id="4448937">,</span>&nbsp;<span class="ident" id="4448939">digest</span><span class="op" id="4448945">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448949">if</span>&nbsp;<span class="ident" id="4448952">err</span>&nbsp;<span class="op" id="4448956">!=</span>&nbsp;<span class="builtintype" id="4448959">nil</span>&nbsp;<span class="op" id="4448963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448968">return</span>&nbsp;<span class="builtintype" id="4448975">nil</span><span class="op" id="4448978">,</span>&nbsp;<span class="ident" id="4448980">errors</span><span class="op" id="4448986">.</span><span class="ident" id="4448987">New</span><span class="op" id="4448990">(</span><span class="string" id="4448991">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="4449027">+</span>&nbsp;<span class="ident" id="4449029">err</span><span class="op" id="4449032">.</span><span class="ident" id="4449033">Error</span><span class="op" id="4449038">(</span><span class="op" id="4449039">)</span><span class="op" id="4449040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4449044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449047">default</span><span class="op" id="4449054">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449058">return</span>&nbsp;<span class="builtintype" id="4449065">nil</span><span class="op" id="4449068">,</span>&nbsp;<span class="ident" id="4449070">errors</span><span class="op" id="4449076">.</span><span class="ident" id="4449077">New</span><span class="op" id="4449080">(</span><span class="string" id="4449081">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="4449116">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4449119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4449123">skx</span>&nbsp;<span class="op" id="4449127">:=</span>&nbsp;<span class="builtinfunc" id="4449130">new</span><span class="op" id="4449133">(</span><span class="ident" id="4449134">serverKeyExchangeMsg</span><span class="op" id="4449154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4449157">sigAndHashLen</span>&nbsp;<span class="op" id="4449171">:=</span>&nbsp;<span class="num" id="4449174">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449177">if</span>&nbsp;<span class="ident" id="4449180">ka</span><span class="op" id="4449182">.</span><span class="ident" id="4449183">version</span>&nbsp;<span class="op" id="4449191">&gt;=</span>&nbsp;<span class="ident" id="4449194">VersionTLS12</span>&nbsp;<span class="op" id="4449207">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4449211">sigAndHashLen</span>&nbsp;<span class="op" id="4449225">=</span>&nbsp;<span class="num" id="4449227">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4449230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4449233">skx</span><span class="op" id="4449236">.</span><span class="ident" id="4449237">key</span>&nbsp;<span class="op" id="4449241">=</span>&nbsp;<span class="builtinfunc" id="4449243">make</span><span class="op" id="4449247">(</span><span class="op" id="4449248">[</span><span class="op" id="4449249">]</span><span class="builtintype" id="4449250">byte</span><span class="op" id="4449254">,</span>&nbsp;<span class="builtinfunc" id="4449256">len</span><span class="op" id="4449259">(</span><span class="ident" id="4449260">serverECDHParams</span><span class="op" id="4449276">)</span><span class="op" id="4449277">+</span><span class="ident" id="4449278">sigAndHashLen</span><span class="op" id="4449291">+</span><span class="num" id="4449292">2</span><span class="op" id="4449293">+</span><span class="builtinfunc" id="4449294">len</span><span class="op" id="4449297">(</span><span class="ident" id="4449298">sig</span><span class="op" id="4449301">)</span><span class="op" id="4449302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4449305">copy</span><span class="op" id="4449309">(</span><span class="ident" id="4449310">skx</span><span class="op" id="4449313">.</span><span class="ident" id="4449314">key</span><span class="op" id="4449317">,</span>&nbsp;<span class="ident" id="4449319">serverECDHParams</span><span class="op" id="4449335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4449338">k</span>&nbsp;<span class="op" id="4449340">:=</span>&nbsp;<span class="ident" id="4449343">skx</span><span class="op" id="4449346">.</span><span class="ident" id="4449347">key</span><span class="op" id="4449350">[</span><span class="builtinfunc" id="4449351">len</span><span class="op" id="4449354">(</span><span class="ident" id="4449355">serverECDHParams</span><span class="op" id="4449371">)</span><span class="op" id="4449372">:</span><span class="op" id="4449373">]</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449376">if</span>&nbsp;<span class="ident" id="4449379">ka</span><span class="op" id="4449381">.</span><span class="ident" id="4449382">version</span>&nbsp;<span class="op" id="4449390">&gt;=</span>&nbsp;<span class="ident" id="4449393">VersionTLS12</span>&nbsp;<span class="op" id="4449406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4449410">k</span><span class="op" id="4449411">[</span><span class="num" id="4449412">0</span><span class="op" id="4449413">]</span>&nbsp;<span class="op" id="4449415">=</span>&nbsp;<span class="ident" id="4449417">tls12HashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4449431">k</span><span class="op" id="4449432">[</span><span class="num" id="4449433">1</span><span class="op" id="4449434">]</span>&nbsp;<span class="op" id="4449436">=</span>&nbsp;<span class="ident" id="4449438">ka</span><span class="op" id="4449440">.</span><span class="ident" id="4449441">sigType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4449451">k</span>&nbsp;<span class="op" id="4449453">=</span>&nbsp;<span class="ident" id="4449455">k</span><span class="op" id="4449456">[</span><span class="num" id="4449457">2</span><span class="op" id="4449458">:</span><span class="op" id="4449459">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4449462">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4449465">k</span><span class="op" id="4449466">[</span><span class="num" id="4449467">0</span><span class="op" id="4449468">]</span>&nbsp;<span class="op" id="4449470">=</span>&nbsp;<span class="builtintype" id="4449472">byte</span><span class="op" id="4449476">(</span><span class="builtinfunc" id="4449477">len</span><span class="op" id="4449480">(</span><span class="ident" id="4449481">sig</span><span class="op" id="4449484">)</span>&nbsp;<span class="op" id="4449486">&gt;&gt;</span>&nbsp;<span class="num" id="4449489">8</span><span class="op" id="4449490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4449493">k</span><span class="op" id="4449494">[</span><span class="num" id="4449495">1</span><span class="op" id="4449496">]</span>&nbsp;<span class="op" id="4449498">=</span>&nbsp;<span class="builtintype" id="4449500">byte</span><span class="op" id="4449504">(</span><span class="builtinfunc" id="4449505">len</span><span class="op" id="4449508">(</span><span class="ident" id="4449509">sig</span><span class="op" id="4449512">)</span><span class="op" id="4449513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4449516">copy</span><span class="op" id="4449520">(</span><span class="ident" id="4449521">k</span><span class="op" id="4449522">[</span><span class="num" id="4449523">2</span><span class="op" id="4449524">:</span><span class="op" id="4449525">]</span><span class="op" id="4449526">,</span>&nbsp;<span class="ident" id="4449528">sig</span><span class="op" id="4449531">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449535">return</span>&nbsp;<span class="ident" id="4449542">skx</span><span class="op" id="4449545">,</span>&nbsp;<span class="builtintype" id="4449547">nil</span><br>
<span class="lineno">285</span><span class="op" id="4449551">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4449554">func</span>&nbsp;<span class="op" id="4449559">(</span><span class="ident" id="4449560">ka</span>&nbsp;<span class="op" id="4449563">*</span><span class="ident" id="4449564">ecdheKeyAgreement</span><span class="op" id="4449581">)</span>&nbsp;<span class="ident" id="4449583">processClientKeyExchange</span><span class="op" id="4449607">(</span><span class="ident" id="4449608">config</span>&nbsp;<span class="op" id="4449615">*</span><span class="ident" id="4449616">Config</span><span class="op" id="4449622">,</span>&nbsp;<span class="ident" id="4449624">cert</span>&nbsp;<span class="op" id="4449629">*</span><span class="ident" id="4449630">Certificate</span><span class="op" id="4449641">,</span>&nbsp;<span class="ident" id="4449643">ckx</span>&nbsp;<span class="op" id="4449647">*</span><span class="ident" id="4449648">clientKeyExchangeMsg</span><span class="op" id="4449668">,</span>&nbsp;<span class="ident" id="4449670">version</span>&nbsp;<span class="builtintype" id="4449678">uint16</span><span class="op" id="4449684">)</span>&nbsp;<span class="op" id="4449686">(</span><span class="op" id="4449687">[</span><span class="op" id="4449688">]</span><span class="builtintype" id="4449689">byte</span><span class="op" id="4449693">,</span>&nbsp;<span class="builtintype" id="4449695">error</span><span class="op" id="4449700">)</span>&nbsp;<span class="op" id="4449702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449705">if</span>&nbsp;<span class="builtinfunc" id="4449708">len</span><span class="op" id="4449711">(</span><span class="ident" id="4449712">ckx</span><span class="op" id="4449715">.</span><span class="ident" id="4449716">ciphertext</span><span class="op" id="4449726">)</span>&nbsp;<span class="op" id="4449728">==</span>&nbsp;<span class="num" id="4449731">0</span>&nbsp;<span class="op" id="4449733">||</span>&nbsp;<span class="builtintype" id="4449736">int</span><span class="op" id="4449739">(</span><span class="ident" id="4449740">ckx</span><span class="op" id="4449743">.</span><span class="ident" id="4449744">ciphertext</span><span class="op" id="4449754">[</span><span class="num" id="4449755">0</span><span class="op" id="4449756">]</span><span class="op" id="4449757">)</span>&nbsp;<span class="op" id="4449759">!=</span>&nbsp;<span class="builtinfunc" id="4449762">len</span><span class="op" id="4449765">(</span><span class="ident" id="4449766">ckx</span><span class="op" id="4449769">.</span><span class="ident" id="4449770">ciphertext</span><span class="op" id="4449780">)</span><span class="op" id="4449781">-</span><span class="num" id="4449782">1</span>&nbsp;<span class="op" id="4449784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449788">return</span>&nbsp;<span class="builtintype" id="4449795">nil</span><span class="op" id="4449798">,</span>&nbsp;<span class="ident" id="4449800">errClientKeyExchange</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4449822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4449825">x</span><span class="op" id="4449826">,</span>&nbsp;<span class="ident" id="4449828">y</span>&nbsp;<span class="op" id="4449830">:=</span>&nbsp;<span class="ident" id="4449833">elliptic</span><span class="op" id="4449841">.</span><span class="ident" id="4449842">Unmarshal</span><span class="op" id="4449851">(</span><span class="ident" id="4449852">ka</span><span class="op" id="4449854">.</span><span class="ident" id="4449855">curve</span><span class="op" id="4449860">,</span>&nbsp;<span class="ident" id="4449862">ckx</span><span class="op" id="4449865">.</span><span class="ident" id="4449866">ciphertext</span><span class="op" id="4449876">[</span><span class="num" id="4449877">1</span><span class="op" id="4449878">:</span><span class="op" id="4449879">]</span><span class="op" id="4449880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449883">if</span>&nbsp;<span class="ident" id="4449886">x</span>&nbsp;<span class="op" id="4449888">==</span>&nbsp;<span class="builtintype" id="4449891">nil</span>&nbsp;<span class="op" id="4449895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449899">return</span>&nbsp;<span class="builtintype" id="4449906">nil</span><span class="op" id="4449909">,</span>&nbsp;<span class="ident" id="4449911">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4449933">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449936">if</span>&nbsp;<span class="op" id="4449939">!</span><span class="ident" id="4449940">ka</span><span class="op" id="4449942">.</span><span class="ident" id="4449943">curve</span><span class="op" id="4449948">.</span><span class="ident" id="4449949">IsOnCurve</span><span class="op" id="4449958">(</span><span class="ident" id="4449959">x</span><span class="op" id="4449960">,</span>&nbsp;<span class="ident" id="4449962">y</span><span class="op" id="4449963">)</span>&nbsp;<span class="op" id="4449965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449969">return</span>&nbsp;<span class="builtintype" id="4449976">nil</span><span class="op" id="4449979">,</span>&nbsp;<span class="ident" id="4449981">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4450003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4450006">x</span><span class="op" id="4450007">,</span>&nbsp;<span class="ident" id="4450009">_</span>&nbsp;<span class="op" id="4450011">=</span>&nbsp;<span class="ident" id="4450013">ka</span><span class="op" id="4450015">.</span><span class="ident" id="4450016">curve</span><span class="op" id="4450021">.</span><span class="ident" id="4450022">ScalarMult</span><span class="op" id="4450032">(</span><span class="ident" id="4450033">x</span><span class="op" id="4450034">,</span>&nbsp;<span class="ident" id="4450036">y</span><span class="op" id="4450037">,</span>&nbsp;<span class="ident" id="4450039">ka</span><span class="op" id="4450041">.</span><span class="ident" id="4450042">privateKey</span><span class="op" id="4450052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4450055">preMasterSecret</span>&nbsp;<span class="op" id="4450071">:=</span>&nbsp;<span class="builtinfunc" id="4450074">make</span><span class="op" id="4450078">(</span><span class="op" id="4450079">[</span><span class="op" id="4450080">]</span><span class="builtintype" id="4450081">byte</span><span class="op" id="4450085">,</span>&nbsp;<span class="op" id="4450087">(</span><span class="ident" id="4450088">ka</span><span class="op" id="4450090">.</span><span class="ident" id="4450091">curve</span><span class="op" id="4450096">.</span><span class="ident" id="4450097">Params</span><span class="op" id="4450103">(</span><span class="op" id="4450104">)</span><span class="op" id="4450105">.</span><span class="ident" id="4450106">BitSize</span><span class="op" id="4450113">+</span><span class="num" id="4450114">7</span><span class="op" id="4450115">)</span><span class="op" id="4450116">&gt;&gt;</span><span class="num" id="4450118">3</span><span class="op" id="4450119">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4450122">xBytes</span>&nbsp;<span class="op" id="4450129">:=</span>&nbsp;<span class="ident" id="4450132">x</span><span class="op" id="4450133">.</span><span class="ident" id="4450134">Bytes</span><span class="op" id="4450139">(</span><span class="op" id="4450140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4450143">copy</span><span class="op" id="4450147">(</span><span class="ident" id="4450148">preMasterSecret</span><span class="op" id="4450163">[</span><span class="builtinfunc" id="4450164">len</span><span class="op" id="4450167">(</span><span class="ident" id="4450168">preMasterSecret</span><span class="op" id="4450183">)</span><span class="op" id="4450184">-</span><span class="builtinfunc" id="4450185">len</span><span class="op" id="4450188">(</span><span class="ident" id="4450189">xBytes</span><span class="op" id="4450195">)</span><span class="op" id="4450196">:</span><span class="op" id="4450197">]</span><span class="op" id="4450198">,</span>&nbsp;<span class="ident" id="4450200">xBytes</span><span class="op" id="4450206">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450210">return</span>&nbsp;<span class="ident" id="4450217">preMasterSecret</span><span class="op" id="4450232">,</span>&nbsp;<span class="builtintype" id="4450234">nil</span><br>
<span class="lineno"></span><span class="op" id="4450238">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="4450241">func</span>&nbsp;<span class="op" id="4450246">(</span><span class="ident" id="4450247">ka</span>&nbsp;<span class="op" id="4450250">*</span><span class="ident" id="4450251">ecdheKeyAgreement</span><span class="op" id="4450268">)</span>&nbsp;<span class="ident" id="4450270">processServerKeyExchange</span><span class="op" id="4450294">(</span><span class="ident" id="4450295">config</span>&nbsp;<span class="op" id="4450302">*</span><span class="ident" id="4450303">Config</span><span class="op" id="4450309">,</span>&nbsp;<span class="ident" id="4450311">clientHello</span>&nbsp;<span class="op" id="4450323">*</span><span class="ident" id="4450324">clientHelloMsg</span><span class="op" id="4450338">,</span>&nbsp;<span class="ident" id="4450340">serverHello</span>&nbsp;<span class="op" id="4450352">*</span><span class="ident" id="4450353">serverHelloMsg</span><span class="op" id="4450367">,</span>&nbsp;<span class="ident" id="4450369">cert</span>&nbsp;<span class="op" id="4450374">*</span><span class="ident" id="4450375">x509</span><span class="op" id="4450379">.</span><span class="ident" id="4450380">Certificate</span><span class="op" id="4450391">,</span>&nbsp;<span class="ident" id="4450393">skx</span>&nbsp;<span class="op" id="4450397">*</span><span class="ident" id="4450398">serverKeyExchangeMsg</span><span class="op" id="4450418">)</span>&nbsp;<span class="builtintype" id="4450420">error</span>&nbsp;<span class="op" id="4450426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450429">if</span>&nbsp;<span class="builtinfunc" id="4450432">len</span><span class="op" id="4450435">(</span><span class="ident" id="4450436">skx</span><span class="op" id="4450439">.</span><span class="ident" id="4450440">key</span><span class="op" id="4450443">)</span>&nbsp;<span class="op" id="4450445">&lt;</span>&nbsp;<span class="num" id="4450447">4</span>&nbsp;<span class="op" id="4450449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450453">return</span>&nbsp;<span class="ident" id="4450460">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4450482">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450485">if</span>&nbsp;<span class="ident" id="4450488">skx</span><span class="op" id="4450491">.</span><span class="ident" id="4450492">key</span><span class="op" id="4450495">[</span><span class="num" id="4450496">0</span><span class="op" id="4450497">]</span>&nbsp;<span class="op" id="4450499">!=</span>&nbsp;<span class="num" id="4450502">3</span>&nbsp;<span class="op" id="4450504">{</span>&nbsp;<span class="comment" id="4450506">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450523">return</span>&nbsp;<span class="ident" id="4450530">errors</span><span class="op" id="4450536">.</span><span class="ident" id="4450537">New</span><span class="op" id="4450540">(</span><span class="string" id="4450541">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4450581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4450584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4450587">curveid</span>&nbsp;<span class="op" id="4450595">:=</span>&nbsp;<span class="ident" id="4450598">CurveID</span><span class="op" id="4450605">(</span><span class="ident" id="4450606">skx</span><span class="op" id="4450609">.</span><span class="ident" id="4450610">key</span><span class="op" id="4450613">[</span><span class="num" id="4450614">1</span><span class="op" id="4450615">]</span><span class="op" id="4450616">)</span><span class="op" id="4450617">&lt;&lt;</span><span class="num" id="4450619">8</span>&nbsp;<span class="op" id="4450621">|</span>&nbsp;<span class="ident" id="4450623">CurveID</span><span class="op" id="4450630">(</span><span class="ident" id="4450631">skx</span><span class="op" id="4450634">.</span><span class="ident" id="4450635">key</span><span class="op" id="4450638">[</span><span class="num" id="4450639">2</span><span class="op" id="4450640">]</span><span class="op" id="4450641">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450645">var</span>&nbsp;<span class="ident" id="4450649">ok</span>&nbsp;<span class="builtintype" id="4450652">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450658">if</span>&nbsp;<span class="ident" id="4450661">ka</span><span class="op" id="4450663">.</span><span class="ident" id="4450664">curve</span><span class="op" id="4450669">,</span>&nbsp;<span class="ident" id="4450671">ok</span>&nbsp;<span class="op" id="4450674">=</span>&nbsp;<span class="ident" id="4450676">curveForCurveID</span><span class="op" id="4450691">(</span><span class="ident" id="4450692">curveid</span><span class="op" id="4450699">)</span><span class="op" id="4450700">;</span>&nbsp;<span class="op" id="4450702">!</span><span class="ident" id="4450703">ok</span>&nbsp;<span class="op" id="4450706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450710">return</span>&nbsp;<span class="ident" id="4450717">errors</span><span class="op" id="4450723">.</span><span class="ident" id="4450724">New</span><span class="op" id="4450727">(</span><span class="string" id="4450728">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4450768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4450771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4450775">publicLen</span>&nbsp;<span class="op" id="4450785">:=</span>&nbsp;<span class="builtintype" id="4450788">int</span><span class="op" id="4450791">(</span><span class="ident" id="4450792">skx</span><span class="op" id="4450795">.</span><span class="ident" id="4450796">key</span><span class="op" id="4450799">[</span><span class="num" id="4450800">3</span><span class="op" id="4450801">]</span><span class="op" id="4450802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450805">if</span>&nbsp;<span class="ident" id="4450808">publicLen</span><span class="op" id="4450817">+</span><span class="num" id="4450818">4</span>&nbsp;<span class="op" id="4450820">&gt;</span>&nbsp;<span class="builtinfunc" id="4450822">len</span><span class="op" id="4450825">(</span><span class="ident" id="4450826">skx</span><span class="op" id="4450829">.</span><span class="ident" id="4450830">key</span><span class="op" id="4450833">)</span>&nbsp;<span class="op" id="4450835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450839">return</span>&nbsp;<span class="ident" id="4450846">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4450868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4450871">ka</span><span class="op" id="4450873">.</span><span class="ident" id="4450874">x</span><span class="op" id="4450875">,</span>&nbsp;<span class="ident" id="4450877">ka</span><span class="op" id="4450879">.</span><span class="ident" id="4450880">y</span>&nbsp;<span class="op" id="4450882">=</span>&nbsp;<span class="ident" id="4450884">elliptic</span><span class="op" id="4450892">.</span><span class="ident" id="4450893">Unmarshal</span><span class="op" id="4450902">(</span><span class="ident" id="4450903">ka</span><span class="op" id="4450905">.</span><span class="ident" id="4450906">curve</span><span class="op" id="4450911">,</span>&nbsp;<span class="ident" id="4450913">skx</span><span class="op" id="4450916">.</span><span class="ident" id="4450917">key</span><span class="op" id="4450920">[</span><span class="num" id="4450921">4</span><span class="op" id="4450922">:</span><span class="num" id="4450923">4</span><span class="op" id="4450924">+</span><span class="ident" id="4450925">publicLen</span><span class="op" id="4450934">]</span><span class="op" id="4450935">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450938">if</span>&nbsp;<span class="ident" id="4450941">ka</span><span class="op" id="4450943">.</span><span class="ident" id="4450944">x</span>&nbsp;<span class="op" id="4450946">==</span>&nbsp;<span class="builtintype" id="4450949">nil</span>&nbsp;<span class="op" id="4450953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450957">return</span>&nbsp;<span class="ident" id="4450964">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4450986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450989">if</span>&nbsp;<span class="op" id="4450992">!</span><span class="ident" id="4450993">ka</span><span class="op" id="4450995">.</span><span class="ident" id="4450996">curve</span><span class="op" id="4451001">.</span><span class="ident" id="4451002">IsOnCurve</span><span class="op" id="4451011">(</span><span class="ident" id="4451012">ka</span><span class="op" id="4451014">.</span><span class="ident" id="4451015">x</span><span class="op" id="4451016">,</span>&nbsp;<span class="ident" id="4451018">ka</span><span class="op" id="4451020">.</span><span class="ident" id="4451021">y</span><span class="op" id="4451022">)</span>&nbsp;<span class="op" id="4451024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451028">return</span>&nbsp;<span class="ident" id="4451035">errServerKeyExchange</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4451057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4451060">serverECDHParams</span>&nbsp;<span class="op" id="4451077">:=</span>&nbsp;<span class="ident" id="4451080">skx</span><span class="op" id="4451083">.</span><span class="ident" id="4451084">key</span><span class="op" id="4451087">[</span><span class="op" id="4451088">:</span><span class="num" id="4451089">4</span><span class="op" id="4451090">+</span><span class="ident" id="4451091">publicLen</span><span class="op" id="4451100">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4451104">sig</span>&nbsp;<span class="op" id="4451108">:=</span>&nbsp;<span class="ident" id="4451111">skx</span><span class="op" id="4451114">.</span><span class="ident" id="4451115">key</span><span class="op" id="4451118">[</span><span class="num" id="4451119">4</span><span class="op" id="4451120">+</span><span class="ident" id="4451121">publicLen</span><span class="op" id="4451130">:</span><span class="op" id="4451131">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451134">if</span>&nbsp;<span class="builtinfunc" id="4451137">len</span><span class="op" id="4451140">(</span><span class="ident" id="4451141">sig</span><span class="op" id="4451144">)</span>&nbsp;<span class="op" id="4451146">&lt;</span>&nbsp;<span class="num" id="4451148">2</span>&nbsp;<span class="op" id="4451150">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451154">return</span>&nbsp;<span class="ident" id="4451161">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4451183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451187">var</span>&nbsp;<span class="ident" id="4451191">tls12HashId</span>&nbsp;<span class="builtintype" id="4451203">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451210">if</span>&nbsp;<span class="ident" id="4451213">ka</span><span class="op" id="4451215">.</span><span class="ident" id="4451216">version</span>&nbsp;<span class="op" id="4451224">&gt;=</span>&nbsp;<span class="ident" id="4451227">VersionTLS12</span>&nbsp;<span class="op" id="4451240">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4451244">//&nbsp;handle&nbsp;SignatureAndHashAlgorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451282">var</span>&nbsp;<span class="ident" id="4451286">sigAndHash</span>&nbsp;<span class="op" id="4451297">[</span><span class="op" id="4451298">]</span><span class="builtintype" id="4451299">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4451307">sigAndHash</span><span class="op" id="4451317">,</span>&nbsp;<span class="ident" id="4451319">sig</span>&nbsp;<span class="op" id="4451323">=</span>&nbsp;<span class="ident" id="4451325">sig</span><span class="op" id="4451328">[</span><span class="op" id="4451329">:</span><span class="num" id="4451330">2</span><span class="op" id="4451331">]</span><span class="op" id="4451332">,</span>&nbsp;<span class="ident" id="4451334">sig</span><span class="op" id="4451337">[</span><span class="num" id="4451338">2</span><span class="op" id="4451339">:</span><span class="op" id="4451340">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451344">if</span>&nbsp;<span class="ident" id="4451347">sigAndHash</span><span class="op" id="4451357">[</span><span class="num" id="4451358">1</span><span class="op" id="4451359">]</span>&nbsp;<span class="op" id="4451361">!=</span>&nbsp;<span class="ident" id="4451364">ka</span><span class="op" id="4451366">.</span><span class="ident" id="4451367">sigType</span>&nbsp;<span class="op" id="4451375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451380">return</span>&nbsp;<span class="ident" id="4451387">errServerKeyExchange</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4451410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4451414">tls12HashId</span>&nbsp;<span class="op" id="4451426">=</span>&nbsp;<span class="ident" id="4451428">sigAndHash</span><span class="op" id="4451438">[</span><span class="num" id="4451439">0</span><span class="op" id="4451440">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451444">if</span>&nbsp;<span class="builtinfunc" id="4451447">len</span><span class="op" id="4451450">(</span><span class="ident" id="4451451">sig</span><span class="op" id="4451454">)</span>&nbsp;<span class="op" id="4451456">&lt;</span>&nbsp;<span class="num" id="4451458">2</span>&nbsp;<span class="op" id="4451460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451465">return</span>&nbsp;<span class="ident" id="4451472">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4451495">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4451498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4451501">sigLen</span>&nbsp;<span class="op" id="4451508">:=</span>&nbsp;<span class="builtintype" id="4451511">int</span><span class="op" id="4451514">(</span><span class="ident" id="4451515">sig</span><span class="op" id="4451518">[</span><span class="num" id="4451519">0</span><span class="op" id="4451520">]</span><span class="op" id="4451521">)</span><span class="op" id="4451522">&lt;&lt;</span><span class="num" id="4451524">8</span>&nbsp;<span class="op" id="4451526">|</span>&nbsp;<span class="builtintype" id="4451528">int</span><span class="op" id="4451531">(</span><span class="ident" id="4451532">sig</span><span class="op" id="4451535">[</span><span class="num" id="4451536">1</span><span class="op" id="4451537">]</span><span class="op" id="4451538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451541">if</span>&nbsp;<span class="ident" id="4451544">sigLen</span><span class="op" id="4451550">+</span><span class="num" id="4451551">2</span>&nbsp;<span class="op" id="4451553">!=</span>&nbsp;<span class="builtinfunc" id="4451556">len</span><span class="op" id="4451559">(</span><span class="ident" id="4451560">sig</span><span class="op" id="4451563">)</span>&nbsp;<span class="op" id="4451565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451569">return</span>&nbsp;<span class="ident" id="4451576">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4451598">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4451601">sig</span>&nbsp;<span class="op" id="4451605">=</span>&nbsp;<span class="ident" id="4451607">sig</span><span class="op" id="4451610">[</span><span class="num" id="4451611">2</span><span class="op" id="4451612">:</span><span class="op" id="4451613">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4451617">digest</span><span class="op" id="4451623">,</span>&nbsp;<span class="ident" id="4451625">hashFunc</span><span class="op" id="4451633">,</span>&nbsp;<span class="ident" id="4451635">err</span>&nbsp;<span class="op" id="4451639">:=</span>&nbsp;<span class="ident" id="4451642">hashForServerKeyExchange</span><span class="op" id="4451666">(</span><span class="ident" id="4451667">ka</span><span class="op" id="4451669">.</span><span class="ident" id="4451670">sigType</span><span class="op" id="4451677">,</span>&nbsp;<span class="ident" id="4451679">tls12HashId</span><span class="op" id="4451690">,</span>&nbsp;<span class="ident" id="4451692">ka</span><span class="op" id="4451694">.</span><span class="ident" id="4451695">version</span><span class="op" id="4451702">,</span>&nbsp;<span class="ident" id="4451704">clientHello</span><span class="op" id="4451715">.</span><span class="ident" id="4451716">random</span><span class="op" id="4451722">,</span>&nbsp;<span class="ident" id="4451724">serverHello</span><span class="op" id="4451735">.</span><span class="ident" id="4451736">random</span><span class="op" id="4451742">,</span>&nbsp;<span class="ident" id="4451744">serverECDHParams</span><span class="op" id="4451760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451763">if</span>&nbsp;<span class="ident" id="4451766">err</span>&nbsp;<span class="op" id="4451770">!=</span>&nbsp;<span class="builtintype" id="4451773">nil</span>&nbsp;<span class="op" id="4451777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451781">return</span>&nbsp;<span class="ident" id="4451788">err</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4451793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451796">switch</span>&nbsp;<span class="ident" id="4451803">ka</span><span class="op" id="4451805">.</span><span class="ident" id="4451806">sigType</span>&nbsp;<span class="op" id="4451814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451817">case</span>&nbsp;<span class="ident" id="4451822">signatureECDSA</span><span class="op" id="4451836">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4451840">pubKey</span><span class="op" id="4451846">,</span>&nbsp;<span class="ident" id="4451848">ok</span>&nbsp;<span class="op" id="4451851">:=</span>&nbsp;<span class="ident" id="4451854">cert</span><span class="op" id="4451858">.</span><span class="ident" id="4451859">PublicKey</span><span class="op" id="4451868">.</span><span class="op" id="4451869">(</span><span class="op" id="4451870">*</span><span class="ident" id="4451871">ecdsa</span><span class="op" id="4451876">.</span><span class="ident" id="4451877">PublicKey</span><span class="op" id="4451886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451890">if</span>&nbsp;<span class="op" id="4451893">!</span><span class="ident" id="4451894">ok</span>&nbsp;<span class="op" id="4451897">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451902">return</span>&nbsp;<span class="ident" id="4451909">errors</span><span class="op" id="4451915">.</span><span class="ident" id="4451916">New</span><span class="op" id="4451919">(</span><span class="string" id="4451920">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;a&nbsp;ECDSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="4451968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4451972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4451976">ecdsaSig</span>&nbsp;<span class="op" id="4451985">:=</span>&nbsp;<span class="builtinfunc" id="4451988">new</span><span class="op" id="4451991">(</span><span class="ident" id="4451992">ecdsaSignature</span><span class="op" id="4452006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452010">if</span>&nbsp;<span class="ident" id="4452013">_</span><span class="op" id="4452014">,</span>&nbsp;<span class="ident" id="4452016">err</span>&nbsp;<span class="op" id="4452020">:=</span>&nbsp;<span class="ident" id="4452023">asn1</span><span class="op" id="4452027">.</span><span class="ident" id="4452028">Unmarshal</span><span class="op" id="4452037">(</span><span class="ident" id="4452038">sig</span><span class="op" id="4452041">,</span>&nbsp;<span class="ident" id="4452043">ecdsaSig</span><span class="op" id="4452051">)</span><span class="op" id="4452052">;</span>&nbsp;<span class="ident" id="4452054">err</span>&nbsp;<span class="op" id="4452058">!=</span>&nbsp;<span class="builtintype" id="4452061">nil</span>&nbsp;<span class="op" id="4452065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452070">return</span>&nbsp;<span class="ident" id="4452077">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4452083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452087">if</span>&nbsp;<span class="ident" id="4452090">ecdsaSig</span><span class="op" id="4452098">.</span><span class="ident" id="4452099">R</span><span class="op" id="4452100">.</span><span class="ident" id="4452101">Sign</span><span class="op" id="4452105">(</span><span class="op" id="4452106">)</span>&nbsp;<span class="op" id="4452108">&lt;=</span>&nbsp;<span class="num" id="4452111">0</span>&nbsp;<span class="op" id="4452113">||</span>&nbsp;<span class="ident" id="4452116">ecdsaSig</span><span class="op" id="4452124">.</span><span class="ident" id="4452125">S</span><span class="op" id="4452126">.</span><span class="ident" id="4452127">Sign</span><span class="op" id="4452131">(</span><span class="op" id="4452132">)</span>&nbsp;<span class="op" id="4452134">&lt;=</span>&nbsp;<span class="num" id="4452137">0</span>&nbsp;<span class="op" id="4452139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452144">return</span>&nbsp;<span class="ident" id="4452151">errors</span><span class="op" id="4452157">.</span><span class="ident" id="4452158">New</span><span class="op" id="4452161">(</span><span class="string" id="4452162">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="4452213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4452217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452221">if</span>&nbsp;<span class="op" id="4452224">!</span><span class="ident" id="4452225">ecdsa</span><span class="op" id="4452230">.</span><span class="ident" id="4452231">Verify</span><span class="op" id="4452237">(</span><span class="ident" id="4452238">pubKey</span><span class="op" id="4452244">,</span>&nbsp;<span class="ident" id="4452246">digest</span><span class="op" id="4452252">,</span>&nbsp;<span class="ident" id="4452254">ecdsaSig</span><span class="op" id="4452262">.</span><span class="ident" id="4452263">R</span><span class="op" id="4452264">,</span>&nbsp;<span class="ident" id="4452266">ecdsaSig</span><span class="op" id="4452274">.</span><span class="ident" id="4452275">S</span><span class="op" id="4452276">)</span>&nbsp;<span class="op" id="4452278">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452283">return</span>&nbsp;<span class="ident" id="4452290">errors</span><span class="op" id="4452296">.</span><span class="ident" id="4452297">New</span><span class="op" id="4452300">(</span><span class="string" id="4452301">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="4452329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4452333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452336">case</span>&nbsp;<span class="ident" id="4452341">signatureRSA</span><span class="op" id="4452353">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4452357">pubKey</span><span class="op" id="4452363">,</span>&nbsp;<span class="ident" id="4452365">ok</span>&nbsp;<span class="op" id="4452368">:=</span>&nbsp;<span class="ident" id="4452371">cert</span><span class="op" id="4452375">.</span><span class="ident" id="4452376">PublicKey</span><span class="op" id="4452385">.</span><span class="op" id="4452386">(</span><span class="op" id="4452387">*</span><span class="ident" id="4452388">rsa</span><span class="op" id="4452391">.</span><span class="ident" id="4452392">PublicKey</span><span class="op" id="4452401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452405">if</span>&nbsp;<span class="op" id="4452408">!</span><span class="ident" id="4452409">ok</span>&nbsp;<span class="op" id="4452412">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452417">return</span>&nbsp;<span class="ident" id="4452424">errors</span><span class="op" id="4452430">.</span><span class="ident" id="4452431">New</span><span class="op" id="4452434">(</span><span class="string" id="4452435">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="4452479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4452483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452487">if</span>&nbsp;<span class="ident" id="4452490">err</span>&nbsp;<span class="op" id="4452494">:=</span>&nbsp;<span class="ident" id="4452497">rsa</span><span class="op" id="4452500">.</span><span class="ident" id="4452501">VerifyPKCS1v15</span><span class="op" id="4452515">(</span><span class="ident" id="4452516">pubKey</span><span class="op" id="4452522">,</span>&nbsp;<span class="ident" id="4452524">hashFunc</span><span class="op" id="4452532">,</span>&nbsp;<span class="ident" id="4452534">digest</span><span class="op" id="4452540">,</span>&nbsp;<span class="ident" id="4452542">sig</span><span class="op" id="4452545">)</span><span class="op" id="4452546">;</span>&nbsp;<span class="ident" id="4452548">err</span>&nbsp;<span class="op" id="4452552">!=</span>&nbsp;<span class="builtintype" id="4452555">nil</span>&nbsp;<span class="op" id="4452559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452564">return</span>&nbsp;<span class="ident" id="4452571">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4452577">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452580">default</span><span class="op" id="4452587">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452591">return</span>&nbsp;<span class="ident" id="4452598">errors</span><span class="op" id="4452604">.</span><span class="ident" id="4452605">New</span><span class="op" id="4452608">(</span><span class="string" id="4452609">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="4452644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4452647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452651">return</span>&nbsp;<span class="builtintype" id="4452658">nil</span><br>
<span class="lineno">390</span><span class="op" id="4452662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4452665">func</span>&nbsp;<span class="op" id="4452670">(</span><span class="ident" id="4452671">ka</span>&nbsp;<span class="op" id="4452674">*</span><span class="ident" id="4452675">ecdheKeyAgreement</span><span class="op" id="4452692">)</span>&nbsp;<span class="ident" id="4452694">generateClientKeyExchange</span><span class="op" id="4452719">(</span><span class="ident" id="4452720">config</span>&nbsp;<span class="op" id="4452727">*</span><span class="ident" id="4452728">Config</span><span class="op" id="4452734">,</span>&nbsp;<span class="ident" id="4452736">clientHello</span>&nbsp;<span class="op" id="4452748">*</span><span class="ident" id="4452749">clientHelloMsg</span><span class="op" id="4452763">,</span>&nbsp;<span class="ident" id="4452765">cert</span>&nbsp;<span class="op" id="4452770">*</span><span class="ident" id="4452771">x509</span><span class="op" id="4452775">.</span><span class="ident" id="4452776">Certificate</span><span class="op" id="4452787">)</span>&nbsp;<span class="op" id="4452789">(</span><span class="op" id="4452790">[</span><span class="op" id="4452791">]</span><span class="builtintype" id="4452792">byte</span><span class="op" id="4452796">,</span>&nbsp;<span class="op" id="4452798">*</span><span class="ident" id="4452799">clientKeyExchangeMsg</span><span class="op" id="4452819">,</span>&nbsp;<span class="builtintype" id="4452821">error</span><span class="op" id="4452826">)</span>&nbsp;<span class="op" id="4452828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452831">if</span>&nbsp;<span class="ident" id="4452834">ka</span><span class="op" id="4452836">.</span><span class="ident" id="4452837">curve</span>&nbsp;<span class="op" id="4452843">==</span>&nbsp;<span class="builtintype" id="4452846">nil</span>&nbsp;<span class="op" id="4452850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452854">return</span>&nbsp;<span class="builtintype" id="4452861">nil</span><span class="op" id="4452864">,</span>&nbsp;<span class="builtintype" id="4452866">nil</span><span class="op" id="4452869">,</span>&nbsp;<span class="ident" id="4452871">errors</span><span class="op" id="4452877">.</span><span class="ident" id="4452878">New</span><span class="op" id="4452881">(</span><span class="string" id="4452882">&#34;missing&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="4452917">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4452920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4452923">priv</span><span class="op" id="4452927">,</span>&nbsp;<span class="ident" id="4452929">mx</span><span class="op" id="4452931">,</span>&nbsp;<span class="ident" id="4452933">my</span><span class="op" id="4452935">,</span>&nbsp;<span class="ident" id="4452937">err</span>&nbsp;<span class="op" id="4452941">:=</span>&nbsp;<span class="ident" id="4452944">elliptic</span><span class="op" id="4452952">.</span><span class="ident" id="4452953">GenerateKey</span><span class="op" id="4452964">(</span><span class="ident" id="4452965">ka</span><span class="op" id="4452967">.</span><span class="ident" id="4452968">curve</span><span class="op" id="4452973">,</span>&nbsp;<span class="ident" id="4452975">config</span><span class="op" id="4452981">.</span><span class="ident" id="4452982">rand</span><span class="op" id="4452986">(</span><span class="op" id="4452987">)</span><span class="op" id="4452988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452991">if</span>&nbsp;<span class="ident" id="4452994">err</span>&nbsp;<span class="op" id="4452998">!=</span>&nbsp;<span class="builtintype" id="4453001">nil</span>&nbsp;<span class="op" id="4453005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4453009">return</span>&nbsp;<span class="builtintype" id="4453016">nil</span><span class="op" id="4453019">,</span>&nbsp;<span class="builtintype" id="4453021">nil</span><span class="op" id="4453024">,</span>&nbsp;<span class="ident" id="4453026">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4453031">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4453034">x</span><span class="op" id="4453035">,</span>&nbsp;<span class="ident" id="4453037">_</span>&nbsp;<span class="op" id="4453039">:=</span>&nbsp;<span class="ident" id="4453042">ka</span><span class="op" id="4453044">.</span><span class="ident" id="4453045">curve</span><span class="op" id="4453050">.</span><span class="ident" id="4453051">ScalarMult</span><span class="op" id="4453061">(</span><span class="ident" id="4453062">ka</span><span class="op" id="4453064">.</span><span class="ident" id="4453065">x</span><span class="op" id="4453066">,</span>&nbsp;<span class="ident" id="4453068">ka</span><span class="op" id="4453070">.</span><span class="ident" id="4453071">y</span><span class="op" id="4453072">,</span>&nbsp;<span class="ident" id="4453074">priv</span><span class="op" id="4453078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4453081">preMasterSecret</span>&nbsp;<span class="op" id="4453097">:=</span>&nbsp;<span class="builtinfunc" id="4453100">make</span><span class="op" id="4453104">(</span><span class="op" id="4453105">[</span><span class="op" id="4453106">]</span><span class="builtintype" id="4453107">byte</span><span class="op" id="4453111">,</span>&nbsp;<span class="op" id="4453113">(</span><span class="ident" id="4453114">ka</span><span class="op" id="4453116">.</span><span class="ident" id="4453117">curve</span><span class="op" id="4453122">.</span><span class="ident" id="4453123">Params</span><span class="op" id="4453129">(</span><span class="op" id="4453130">)</span><span class="op" id="4453131">.</span><span class="ident" id="4453132">BitSize</span><span class="op" id="4453139">+</span><span class="num" id="4453140">7</span><span class="op" id="4453141">)</span><span class="op" id="4453142">&gt;&gt;</span><span class="num" id="4453144">3</span><span class="op" id="4453145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4453148">xBytes</span>&nbsp;<span class="op" id="4453155">:=</span>&nbsp;<span class="ident" id="4453158">x</span><span class="op" id="4453159">.</span><span class="ident" id="4453160">Bytes</span><span class="op" id="4453165">(</span><span class="op" id="4453166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4453169">copy</span><span class="op" id="4453173">(</span><span class="ident" id="4453174">preMasterSecret</span><span class="op" id="4453189">[</span><span class="builtinfunc" id="4453190">len</span><span class="op" id="4453193">(</span><span class="ident" id="4453194">preMasterSecret</span><span class="op" id="4453209">)</span><span class="op" id="4453210">-</span><span class="builtinfunc" id="4453211">len</span><span class="op" id="4453214">(</span><span class="ident" id="4453215">xBytes</span><span class="op" id="4453221">)</span><span class="op" id="4453222">:</span><span class="op" id="4453223">]</span><span class="op" id="4453224">,</span>&nbsp;<span class="ident" id="4453226">xBytes</span><span class="op" id="4453232">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4453236">serialized</span>&nbsp;<span class="op" id="4453247">:=</span>&nbsp;<span class="ident" id="4453250">elliptic</span><span class="op" id="4453258">.</span><span class="ident" id="4453259">Marshal</span><span class="op" id="4453266">(</span><span class="ident" id="4453267">ka</span><span class="op" id="4453269">.</span><span class="ident" id="4453270">curve</span><span class="op" id="4453275">,</span>&nbsp;<span class="ident" id="4453277">mx</span><span class="op" id="4453279">,</span>&nbsp;<span class="ident" id="4453281">my</span><span class="op" id="4453283">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4453287">ckx</span>&nbsp;<span class="op" id="4453291">:=</span>&nbsp;<span class="builtinfunc" id="4453294">new</span><span class="op" id="4453297">(</span><span class="ident" id="4453298">clientKeyExchangeMsg</span><span class="op" id="4453318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4453321">ckx</span><span class="op" id="4453324">.</span><span class="ident" id="4453325">ciphertext</span>&nbsp;<span class="op" id="4453336">=</span>&nbsp;<span class="builtinfunc" id="4453338">make</span><span class="op" id="4453342">(</span><span class="op" id="4453343">[</span><span class="op" id="4453344">]</span><span class="builtintype" id="4453345">byte</span><span class="op" id="4453349">,</span>&nbsp;<span class="num" id="4453351">1</span><span class="op" id="4453352">+</span><span class="builtinfunc" id="4453353">len</span><span class="op" id="4453356">(</span><span class="ident" id="4453357">serialized</span><span class="op" id="4453367">)</span><span class="op" id="4453368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4453371">ckx</span><span class="op" id="4453374">.</span><span class="ident" id="4453375">ciphertext</span><span class="op" id="4453385">[</span><span class="num" id="4453386">0</span><span class="op" id="4453387">]</span>&nbsp;<span class="op" id="4453389">=</span>&nbsp;<span class="builtintype" id="4453391">byte</span><span class="op" id="4453395">(</span><span class="builtinfunc" id="4453396">len</span><span class="op" id="4453399">(</span><span class="ident" id="4453400">serialized</span><span class="op" id="4453410">)</span><span class="op" id="4453411">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4453414">copy</span><span class="op" id="4453418">(</span><span class="ident" id="4453419">ckx</span><span class="op" id="4453422">.</span><span class="ident" id="4453423">ciphertext</span><span class="op" id="4453433">[</span><span class="num" id="4453434">1</span><span class="op" id="4453435">:</span><span class="op" id="4453436">]</span><span class="op" id="4453437">,</span>&nbsp;<span class="ident" id="4453439">serialized</span><span class="op" id="4453449">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4453453">return</span>&nbsp;<span class="ident" id="4453460">preMasterSecret</span><span class="op" id="4453475">,</span>&nbsp;<span class="ident" id="4453477">ckx</span><span class="op" id="4453480">,</span>&nbsp;<span class="builtintype" id="4453482">nil</span><br>
<span class="lineno"></span><span class="op" id="4453486">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
