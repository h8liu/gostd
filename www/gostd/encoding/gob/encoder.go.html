<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4832953">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4833008">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4833062">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4833113">package</span>&nbsp;<span class="ident" id="4833121">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4833126">import</span>&nbsp;<span class="op" id="4833133">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4833136">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4833142">&#34;reflect&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4833153">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="4833160">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4833163">//&nbsp;An&nbsp;Encoder&nbsp;manages&nbsp;the&nbsp;transmission&nbsp;of&nbsp;type&nbsp;and&nbsp;data&nbsp;information&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4833238">//&nbsp;other&nbsp;side&nbsp;of&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">15</span><span class="keyword" id="4833269">type</span>&nbsp;<span class="ident" id="4833274">Encoder</span>&nbsp;<span class="keyword" id="4833282">struct</span>&nbsp;<span class="op" id="4833289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4833292">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4833303">sync</span><span class="op" id="4833307">.</span><span class="ident" id="4833308">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4833327">//&nbsp;each&nbsp;item&nbsp;must&nbsp;be&nbsp;sent&nbsp;atomically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4833365">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4833376">[</span><span class="op" id="4833377">]</span><span class="ident" id="4833378">io</span><span class="op" id="4833380">.</span><span class="ident" id="4833381">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4833400">//&nbsp;where&nbsp;to&nbsp;send&nbsp;the&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4833427">sent</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4833438">map</span><span class="op" id="4833441">[</span><span class="ident" id="4833442">reflect</span><span class="op" id="4833449">.</span><span class="ident" id="4833450">Type</span><span class="op" id="4833454">]</span><span class="ident" id="4833455">typeId</span>&nbsp;<span class="comment" id="4833462">//&nbsp;which&nbsp;types&nbsp;we&#39;ve&nbsp;already&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4833497">countState</span>&nbsp;<span class="op" id="4833508">*</span><span class="ident" id="4833509">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4833532">//&nbsp;stage&nbsp;for&nbsp;writing&nbsp;counts</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4833561">freeList</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4833572">*</span><span class="ident" id="4833573">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4833596">//&nbsp;list&nbsp;of&nbsp;free&nbsp;encoderStates;&nbsp;avoids&nbsp;reallocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4833648">byteBuf</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4833659">encBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4833683">//&nbsp;buffer&nbsp;for&nbsp;top-level&nbsp;encoderState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4833721">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4833732">error</span><br>
<span class="lineno"></span><span class="op" id="4833738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4833741">//&nbsp;Before&nbsp;we&nbsp;encode&nbsp;a&nbsp;message,&nbsp;we&nbsp;reserve&nbsp;space&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4833808">//&nbsp;buffer&nbsp;in&nbsp;which&nbsp;to&nbsp;encode&nbsp;its&nbsp;length.&nbsp;This&nbsp;means&nbsp;we&nbsp;can&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4833875">//&nbsp;buffer&nbsp;to&nbsp;assemble&nbsp;the&nbsp;message&nbsp;without&nbsp;another&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="4833937">const</span>&nbsp;<span class="ident" id="4833943">maxLength</span>&nbsp;<span class="op" id="4833953">=</span>&nbsp;<span class="num" id="4833955">9</span>&nbsp;<span class="comment" id="4833957">//&nbsp;Maximum&nbsp;size&nbsp;of&nbsp;an&nbsp;encoded&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="4833995">var</span>&nbsp;<span class="ident" id="4833999">spaceForLength</span>&nbsp;<span class="op" id="4834014">=</span>&nbsp;<span class="builtinfunc" id="4834016">make</span><span class="op" id="4834020">(</span><span class="op" id="4834021">[</span><span class="op" id="4834022">]</span><span class="builtintype" id="4834023">byte</span><span class="op" id="4834027">,</span>&nbsp;<span class="ident" id="4834029">maxLength</span><span class="op" id="4834038">)</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="4834041">//&nbsp;NewEncoder&nbsp;returns&nbsp;a&nbsp;new&nbsp;encoder&nbsp;that&nbsp;will&nbsp;transmit&nbsp;on&nbsp;the&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4834114">func</span>&nbsp;<span class="ident" id="4834119">NewEncoder</span><span class="op" id="4834129">(</span><span class="ident" id="4834130">w</span>&nbsp;<span class="ident" id="4834132">io</span><span class="op" id="4834134">.</span><span class="ident" id="4834135">Writer</span><span class="op" id="4834141">)</span>&nbsp;<span class="op" id="4834143">*</span><span class="ident" id="4834144">Encoder</span>&nbsp;<span class="op" id="4834152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4834155">enc</span>&nbsp;<span class="op" id="4834159">:=</span>&nbsp;<span class="builtinfunc" id="4834162">new</span><span class="op" id="4834165">(</span><span class="ident" id="4834166">Encoder</span><span class="op" id="4834173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4834176">enc</span><span class="op" id="4834179">.</span><span class="ident" id="4834180">w</span>&nbsp;<span class="op" id="4834182">=</span>&nbsp;<span class="op" id="4834184">[</span><span class="op" id="4834185">]</span><span class="ident" id="4834186">io</span><span class="op" id="4834188">.</span><span class="ident" id="4834189">Writer</span><span class="op" id="4834195">{</span><span class="ident" id="4834196">w</span><span class="op" id="4834197">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4834200">enc</span><span class="op" id="4834203">.</span><span class="ident" id="4834204">sent</span>&nbsp;<span class="op" id="4834209">=</span>&nbsp;<span class="builtinfunc" id="4834211">make</span><span class="op" id="4834215">(</span><span class="keyword" id="4834216">map</span><span class="op" id="4834219">[</span><span class="ident" id="4834220">reflect</span><span class="op" id="4834227">.</span><span class="ident" id="4834228">Type</span><span class="op" id="4834232">]</span><span class="ident" id="4834233">typeId</span><span class="op" id="4834239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4834242">enc</span><span class="op" id="4834245">.</span><span class="ident" id="4834246">countState</span>&nbsp;<span class="op" id="4834257">=</span>&nbsp;<span class="ident" id="4834259">enc</span><span class="op" id="4834262">.</span><span class="ident" id="4834263">newEncoderState</span><span class="op" id="4834278">(</span><span class="builtinfunc" id="4834279">new</span><span class="op" id="4834282">(</span><span class="ident" id="4834283">encBuffer</span><span class="op" id="4834292">)</span><span class="op" id="4834293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4834296">return</span>&nbsp;<span class="ident" id="4834303">enc</span><br>
<span class="lineno"></span><span class="op" id="4834307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="4834310">//&nbsp;writer()&nbsp;returns&nbsp;the&nbsp;innermost&nbsp;writer&nbsp;the&nbsp;encoder&nbsp;is&nbsp;using</span><br>
<span class="lineno"></span><span class="keyword" id="4834372">func</span>&nbsp;<span class="op" id="4834377">(</span><span class="ident" id="4834378">enc</span>&nbsp;<span class="op" id="4834382">*</span><span class="ident" id="4834383">Encoder</span><span class="op" id="4834390">)</span>&nbsp;<span class="ident" id="4834392">writer</span><span class="op" id="4834398">(</span><span class="op" id="4834399">)</span>&nbsp;<span class="ident" id="4834401">io</span><span class="op" id="4834403">.</span><span class="ident" id="4834404">Writer</span>&nbsp;<span class="op" id="4834411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4834414">return</span>&nbsp;<span class="ident" id="4834421">enc</span><span class="op" id="4834424">.</span><span class="ident" id="4834425">w</span><span class="op" id="4834426">[</span><span class="builtinfunc" id="4834427">len</span><span class="op" id="4834430">(</span><span class="ident" id="4834431">enc</span><span class="op" id="4834434">.</span><span class="ident" id="4834435">w</span><span class="op" id="4834436">)</span><span class="op" id="4834437">-</span><span class="num" id="4834438">1</span><span class="op" id="4834439">]</span><br>
<span class="lineno"></span><span class="op" id="4834441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="4834444">//&nbsp;pushWriter&nbsp;adds&nbsp;a&nbsp;writer&nbsp;to&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="keyword" id="4834488">func</span>&nbsp;<span class="op" id="4834493">(</span><span class="ident" id="4834494">enc</span>&nbsp;<span class="op" id="4834498">*</span><span class="ident" id="4834499">Encoder</span><span class="op" id="4834506">)</span>&nbsp;<span class="ident" id="4834508">pushWriter</span><span class="op" id="4834518">(</span><span class="ident" id="4834519">w</span>&nbsp;<span class="ident" id="4834521">io</span><span class="op" id="4834523">.</span><span class="ident" id="4834524">Writer</span><span class="op" id="4834530">)</span>&nbsp;<span class="op" id="4834532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4834535">enc</span><span class="op" id="4834538">.</span><span class="ident" id="4834539">w</span>&nbsp;<span class="op" id="4834541">=</span>&nbsp;<span class="builtinfunc" id="4834543">append</span><span class="op" id="4834549">(</span><span class="ident" id="4834550">enc</span><span class="op" id="4834553">.</span><span class="ident" id="4834554">w</span><span class="op" id="4834555">,</span>&nbsp;<span class="ident" id="4834557">w</span><span class="op" id="4834558">)</span><br>
<span class="lineno"></span><span class="op" id="4834560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4834563">//&nbsp;popWriter&nbsp;pops&nbsp;the&nbsp;innermost&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4834603">func</span>&nbsp;<span class="op" id="4834608">(</span><span class="ident" id="4834609">enc</span>&nbsp;<span class="op" id="4834613">*</span><span class="ident" id="4834614">Encoder</span><span class="op" id="4834621">)</span>&nbsp;<span class="ident" id="4834623">popWriter</span><span class="op" id="4834632">(</span><span class="op" id="4834633">)</span>&nbsp;<span class="op" id="4834635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4834638">enc</span><span class="op" id="4834641">.</span><span class="ident" id="4834642">w</span>&nbsp;<span class="op" id="4834644">=</span>&nbsp;<span class="ident" id="4834646">enc</span><span class="op" id="4834649">.</span><span class="ident" id="4834650">w</span><span class="op" id="4834651">[</span><span class="num" id="4834652">0</span>&nbsp;<span class="op" id="4834654">:</span>&nbsp;<span class="builtinfunc" id="4834656">len</span><span class="op" id="4834659">(</span><span class="ident" id="4834660">enc</span><span class="op" id="4834663">.</span><span class="ident" id="4834664">w</span><span class="op" id="4834665">)</span><span class="op" id="4834666">-</span><span class="num" id="4834667">1</span><span class="op" id="4834668">]</span><br>
<span class="lineno"></span><span class="op" id="4834670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="4834673">func</span>&nbsp;<span class="op" id="4834678">(</span><span class="ident" id="4834679">enc</span>&nbsp;<span class="op" id="4834683">*</span><span class="ident" id="4834684">Encoder</span><span class="op" id="4834691">)</span>&nbsp;<span class="ident" id="4834693">setError</span><span class="op" id="4834701">(</span><span class="ident" id="4834702">err</span>&nbsp;<span class="builtintype" id="4834706">error</span><span class="op" id="4834711">)</span>&nbsp;<span class="op" id="4834713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4834716">if</span>&nbsp;<span class="ident" id="4834719">enc</span><span class="op" id="4834722">.</span><span class="ident" id="4834723">err</span>&nbsp;<span class="op" id="4834727">==</span>&nbsp;<span class="ident" id="4834730">nil</span>&nbsp;<span class="op" id="4834734">{</span>&nbsp;<span class="comment" id="4834736">//&nbsp;remember&nbsp;the&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4834761">enc</span><span class="op" id="4834764">.</span><span class="ident" id="4834765">err</span>&nbsp;<span class="op" id="4834769">=</span>&nbsp;<span class="ident" id="4834771">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4834776">}</span><br>
<span class="lineno"></span><span class="op" id="4834778">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="4834781">//&nbsp;writeMessage&nbsp;sends&nbsp;the&nbsp;data&nbsp;item&nbsp;preceded&nbsp;by&nbsp;a&nbsp;unsigned&nbsp;count&nbsp;of&nbsp;its&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="4834861">func</span>&nbsp;<span class="op" id="4834866">(</span><span class="ident" id="4834867">enc</span>&nbsp;<span class="op" id="4834871">*</span><span class="ident" id="4834872">Encoder</span><span class="op" id="4834879">)</span>&nbsp;<span class="ident" id="4834881">writeMessage</span><span class="op" id="4834893">(</span><span class="ident" id="4834894">w</span>&nbsp;<span class="ident" id="4834896">io</span><span class="op" id="4834898">.</span><span class="ident" id="4834899">Writer</span><span class="op" id="4834905">,</span>&nbsp;<span class="ident" id="4834907">b</span>&nbsp;<span class="op" id="4834909">*</span><span class="ident" id="4834910">encBuffer</span><span class="op" id="4834919">)</span>&nbsp;<span class="op" id="4834921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4834924">//&nbsp;Space&nbsp;has&nbsp;been&nbsp;reserved&nbsp;for&nbsp;the&nbsp;length&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4834995">//&nbsp;This&nbsp;is&nbsp;a&nbsp;little&nbsp;dirty:&nbsp;we&nbsp;grab&nbsp;the&nbsp;slice&nbsp;from&nbsp;the&nbsp;bytes.Buffer&nbsp;and&nbsp;massage</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4835075">//&nbsp;it&nbsp;by&nbsp;hand.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835091">message</span>&nbsp;<span class="op" id="4835099">:=</span>&nbsp;<span class="ident" id="4835102">b</span><span class="op" id="4835103">.</span><span class="ident" id="4835104">Bytes</span><span class="op" id="4835109">(</span><span class="op" id="4835110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835113">messageLen</span>&nbsp;<span class="op" id="4835124">:=</span>&nbsp;<span class="builtinfunc" id="4835127">len</span><span class="op" id="4835130">(</span><span class="ident" id="4835131">message</span><span class="op" id="4835138">)</span>&nbsp;<span class="op" id="4835140">-</span>&nbsp;<span class="ident" id="4835142">maxLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4835153">//&nbsp;Encode&nbsp;the&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835176">enc</span><span class="op" id="4835179">.</span><span class="ident" id="4835180">countState</span><span class="op" id="4835190">.</span><span class="ident" id="4835191">b</span><span class="op" id="4835192">.</span><span class="ident" id="4835193">Reset</span><span class="op" id="4835198">(</span><span class="op" id="4835199">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835202">enc</span><span class="op" id="4835205">.</span><span class="ident" id="4835206">countState</span><span class="op" id="4835216">.</span><span class="ident" id="4835217">encodeUint</span><span class="op" id="4835227">(</span><span class="ident" id="4835228">uint64</span><span class="op" id="4835234">(</span><span class="ident" id="4835235">messageLen</span><span class="op" id="4835245">)</span><span class="op" id="4835246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4835249">//&nbsp;Copy&nbsp;the&nbsp;length&nbsp;to&nbsp;be&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835300">offset</span>&nbsp;<span class="op" id="4835307">:=</span>&nbsp;<span class="ident" id="4835310">maxLength</span>&nbsp;<span class="op" id="4835320">-</span>&nbsp;<span class="ident" id="4835322">enc</span><span class="op" id="4835325">.</span><span class="ident" id="4835326">countState</span><span class="op" id="4835336">.</span><span class="ident" id="4835337">b</span><span class="op" id="4835338">.</span><span class="ident" id="4835339">Len</span><span class="op" id="4835342">(</span><span class="op" id="4835343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4835346">copy</span><span class="op" id="4835350">(</span><span class="ident" id="4835351">message</span><span class="op" id="4835358">[</span><span class="ident" id="4835359">offset</span><span class="op" id="4835365">:</span><span class="op" id="4835366">]</span><span class="op" id="4835367">,</span>&nbsp;<span class="ident" id="4835369">enc</span><span class="op" id="4835372">.</span><span class="ident" id="4835373">countState</span><span class="op" id="4835383">.</span><span class="ident" id="4835384">b</span><span class="op" id="4835385">.</span><span class="ident" id="4835386">Bytes</span><span class="op" id="4835391">(</span><span class="op" id="4835392">)</span><span class="op" id="4835393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4835396">//&nbsp;Write&nbsp;the&nbsp;data.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835416">_</span><span class="op" id="4835417">,</span>&nbsp;<span class="ident" id="4835419">err</span>&nbsp;<span class="op" id="4835423">:=</span>&nbsp;<span class="ident" id="4835426">w</span><span class="op" id="4835427">.</span><span class="ident" id="4835428">Write</span><span class="op" id="4835433">(</span><span class="ident" id="4835434">message</span><span class="op" id="4835441">[</span><span class="ident" id="4835442">offset</span><span class="op" id="4835448">:</span><span class="op" id="4835449">]</span><span class="op" id="4835450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4835453">//&nbsp;Drain&nbsp;the&nbsp;buffer&nbsp;and&nbsp;restore&nbsp;the&nbsp;space&nbsp;at&nbsp;the&nbsp;front&nbsp;for&nbsp;the&nbsp;count&nbsp;of&nbsp;the&nbsp;next&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835544">b</span><span class="op" id="4835545">.</span><span class="ident" id="4835546">Reset</span><span class="op" id="4835551">(</span><span class="op" id="4835552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835555">b</span><span class="op" id="4835556">.</span><span class="ident" id="4835557">Write</span><span class="op" id="4835562">(</span><span class="ident" id="4835563">spaceForLength</span><span class="op" id="4835577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4835580">if</span>&nbsp;<span class="ident" id="4835583">err</span>&nbsp;<span class="op" id="4835587">!=</span>&nbsp;<span class="ident" id="4835590">nil</span>&nbsp;<span class="op" id="4835594">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835598">enc</span><span class="op" id="4835601">.</span><span class="ident" id="4835602">setError</span><span class="op" id="4835610">(</span><span class="ident" id="4835611">err</span><span class="op" id="4835614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4835617">}</span><br>
<span class="lineno"></span><span class="op" id="4835619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4835622">//&nbsp;sendActualType&nbsp;sends&nbsp;the&nbsp;requested&nbsp;type,&nbsp;without&nbsp;further&nbsp;investigation,&nbsp;unless</span><br>
<span class="lineno">85</span><span class="comment" id="4835704">//&nbsp;it&#39;s&nbsp;been&nbsp;sent&nbsp;before.</span><br>
<span class="lineno"></span><span class="keyword" id="4835730">func</span>&nbsp;<span class="op" id="4835735">(</span><span class="ident" id="4835736">enc</span>&nbsp;<span class="op" id="4835740">*</span><span class="ident" id="4835741">Encoder</span><span class="op" id="4835748">)</span>&nbsp;<span class="ident" id="4835750">sendActualType</span><span class="op" id="4835764">(</span><span class="ident" id="4835765">w</span>&nbsp;<span class="ident" id="4835767">io</span><span class="op" id="4835769">.</span><span class="ident" id="4835770">Writer</span><span class="op" id="4835776">,</span>&nbsp;<span class="ident" id="4835778">state</span>&nbsp;<span class="op" id="4835784">*</span><span class="ident" id="4835785">encoderState</span><span class="op" id="4835797">,</span>&nbsp;<span class="ident" id="4835799">ut</span>&nbsp;<span class="op" id="4835802">*</span><span class="ident" id="4835803">userTypeInfo</span><span class="op" id="4835815">,</span>&nbsp;<span class="ident" id="4835817">actual</span>&nbsp;<span class="ident" id="4835824">reflect</span><span class="op" id="4835831">.</span><span class="ident" id="4835832">Type</span><span class="op" id="4835836">)</span>&nbsp;<span class="op" id="4835838">(</span><span class="ident" id="4835839">sent</span>&nbsp;<span class="builtintype" id="4835844">bool</span><span class="op" id="4835848">)</span>&nbsp;<span class="op" id="4835850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4835853">if</span>&nbsp;<span class="ident" id="4835856">_</span><span class="op" id="4835857">,</span>&nbsp;<span class="ident" id="4835859">alreadySent</span>&nbsp;<span class="op" id="4835871">:=</span>&nbsp;<span class="ident" id="4835874">enc</span><span class="op" id="4835877">.</span><span class="ident" id="4835878">sent</span><span class="op" id="4835882">[</span><span class="ident" id="4835883">actual</span><span class="op" id="4835889">]</span><span class="op" id="4835890">;</span>&nbsp;<span class="ident" id="4835892">alreadySent</span>&nbsp;<span class="op" id="4835904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4835908">return</span>&nbsp;<span class="builtintype" id="4835915">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4835922">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835925">info</span><span class="op" id="4835929">,</span>&nbsp;<span class="ident" id="4835931">err</span>&nbsp;<span class="op" id="4835935">:=</span>&nbsp;<span class="ident" id="4835938">getTypeInfo</span><span class="op" id="4835949">(</span><span class="ident" id="4835950">ut</span><span class="op" id="4835952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4835955">if</span>&nbsp;<span class="ident" id="4835958">err</span>&nbsp;<span class="op" id="4835962">!=</span>&nbsp;<span class="ident" id="4835965">nil</span>&nbsp;<span class="op" id="4835969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835973">enc</span><span class="op" id="4835976">.</span><span class="ident" id="4835977">setError</span><span class="op" id="4835985">(</span><span class="ident" id="4835986">err</span><span class="op" id="4835989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4835993">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4836001">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4836004">//&nbsp;Send&nbsp;the&nbsp;pair&nbsp;(-id,&nbsp;type)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4836034">//&nbsp;Id:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836042">state</span><span class="op" id="4836047">.</span><span class="ident" id="4836048">encodeInt</span><span class="op" id="4836057">(</span><span class="op" id="4836058">-</span><span class="ident" id="4836059">int64</span><span class="op" id="4836064">(</span><span class="ident" id="4836065">info</span><span class="op" id="4836069">.</span><span class="ident" id="4836070">id</span><span class="op" id="4836072">)</span><span class="op" id="4836073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4836076">//&nbsp;Type:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836086">enc</span><span class="op" id="4836089">.</span><span class="ident" id="4836090">encode</span><span class="op" id="4836096">(</span><span class="ident" id="4836097">state</span><span class="op" id="4836102">.</span><span class="ident" id="4836103">b</span><span class="op" id="4836104">,</span>&nbsp;<span class="ident" id="4836106">reflect</span><span class="op" id="4836113">.</span><span class="ident" id="4836114">ValueOf</span><span class="op" id="4836121">(</span><span class="ident" id="4836122">info</span><span class="op" id="4836126">.</span><span class="ident" id="4836127">wire</span><span class="op" id="4836131">)</span><span class="op" id="4836132">,</span>&nbsp;<span class="ident" id="4836134">wireTypeUserInfo</span><span class="op" id="4836150">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836153">enc</span><span class="op" id="4836156">.</span><span class="ident" id="4836157">writeMessage</span><span class="op" id="4836169">(</span><span class="ident" id="4836170">w</span><span class="op" id="4836171">,</span>&nbsp;<span class="ident" id="4836173">state</span><span class="op" id="4836178">.</span><span class="ident" id="4836179">b</span><span class="op" id="4836180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4836183">if</span>&nbsp;<span class="ident" id="4836186">enc</span><span class="op" id="4836189">.</span><span class="ident" id="4836190">err</span>&nbsp;<span class="op" id="4836194">!=</span>&nbsp;<span class="ident" id="4836197">nil</span>&nbsp;<span class="op" id="4836201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4836205">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4836213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4836217">//&nbsp;Remember&nbsp;we&#39;ve&nbsp;sent&nbsp;this&nbsp;type,&nbsp;both&nbsp;what&nbsp;the&nbsp;user&nbsp;gave&nbsp;us&nbsp;and&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836298">enc</span><span class="op" id="4836301">.</span><span class="ident" id="4836302">sent</span><span class="op" id="4836306">[</span><span class="ident" id="4836307">ut</span><span class="op" id="4836309">.</span><span class="ident" id="4836310">base</span><span class="op" id="4836314">]</span>&nbsp;<span class="op" id="4836316">=</span>&nbsp;<span class="ident" id="4836318">info</span><span class="op" id="4836322">.</span><span class="ident" id="4836323">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4836327">if</span>&nbsp;<span class="ident" id="4836330">ut</span><span class="op" id="4836332">.</span><span class="ident" id="4836333">user</span>&nbsp;<span class="op" id="4836338">!=</span>&nbsp;<span class="ident" id="4836341">ut</span><span class="op" id="4836343">.</span><span class="ident" id="4836344">base</span>&nbsp;<span class="op" id="4836349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836353">enc</span><span class="op" id="4836356">.</span><span class="ident" id="4836357">sent</span><span class="op" id="4836361">[</span><span class="ident" id="4836362">ut</span><span class="op" id="4836364">.</span><span class="ident" id="4836365">user</span><span class="op" id="4836369">]</span>&nbsp;<span class="op" id="4836371">=</span>&nbsp;<span class="ident" id="4836373">info</span><span class="op" id="4836377">.</span><span class="ident" id="4836378">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4836382">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4836385">//&nbsp;Now&nbsp;send&nbsp;the&nbsp;inner&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4836414">switch</span>&nbsp;<span class="ident" id="4836421">st</span>&nbsp;<span class="op" id="4836424">:=</span>&nbsp;<span class="ident" id="4836427">actual</span><span class="op" id="4836433">;</span>&nbsp;<span class="ident" id="4836435">st</span><span class="op" id="4836437">.</span><span class="ident" id="4836438">Kind</span><span class="op" id="4836442">(</span><span class="op" id="4836443">)</span>&nbsp;<span class="op" id="4836445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4836448">case</span>&nbsp;<span class="ident" id="4836453">reflect</span><span class="op" id="4836460">.</span><span class="ident" id="4836461">Struct</span><span class="op" id="4836467">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4836471">for</span>&nbsp;<span class="ident" id="4836475">i</span>&nbsp;<span class="op" id="4836477">:=</span>&nbsp;<span class="num" id="4836480">0</span><span class="op" id="4836481">;</span>&nbsp;<span class="ident" id="4836483">i</span>&nbsp;<span class="op" id="4836485">&lt;</span>&nbsp;<span class="ident" id="4836487">st</span><span class="op" id="4836489">.</span><span class="ident" id="4836490">NumField</span><span class="op" id="4836498">(</span><span class="op" id="4836499">)</span><span class="op" id="4836500">;</span>&nbsp;<span class="ident" id="4836502">i</span><span class="op" id="4836503">++</span>&nbsp;<span class="op" id="4836506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4836511">if</span>&nbsp;<span class="ident" id="4836514">isExported</span><span class="op" id="4836524">(</span><span class="ident" id="4836525">st</span><span class="op" id="4836527">.</span><span class="ident" id="4836528">Field</span><span class="op" id="4836533">(</span><span class="ident" id="4836534">i</span><span class="op" id="4836535">)</span><span class="op" id="4836536">.</span><span class="ident" id="4836537">Name</span><span class="op" id="4836541">)</span>&nbsp;<span class="op" id="4836543">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836549">enc</span><span class="op" id="4836552">.</span><span class="ident" id="4836553">sendType</span><span class="op" id="4836561">(</span><span class="ident" id="4836562">w</span><span class="op" id="4836563">,</span>&nbsp;<span class="ident" id="4836565">state</span><span class="op" id="4836570">,</span>&nbsp;<span class="ident" id="4836572">st</span><span class="op" id="4836574">.</span><span class="ident" id="4836575">Field</span><span class="op" id="4836580">(</span><span class="ident" id="4836581">i</span><span class="op" id="4836582">)</span><span class="op" id="4836583">.</span><span class="ident" id="4836584">Type</span><span class="op" id="4836588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4836593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4836597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4836600">case</span>&nbsp;<span class="ident" id="4836605">reflect</span><span class="op" id="4836612">.</span><span class="ident" id="4836613">Array</span><span class="op" id="4836618">,</span>&nbsp;<span class="ident" id="4836620">reflect</span><span class="op" id="4836627">.</span><span class="ident" id="4836628">Slice</span><span class="op" id="4836633">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836637">enc</span><span class="op" id="4836640">.</span><span class="ident" id="4836641">sendType</span><span class="op" id="4836649">(</span><span class="ident" id="4836650">w</span><span class="op" id="4836651">,</span>&nbsp;<span class="ident" id="4836653">state</span><span class="op" id="4836658">,</span>&nbsp;<span class="ident" id="4836660">st</span><span class="op" id="4836662">.</span><span class="ident" id="4836663">Elem</span><span class="op" id="4836667">(</span><span class="op" id="4836668">)</span><span class="op" id="4836669">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4836672">case</span>&nbsp;<span class="ident" id="4836677">reflect</span><span class="op" id="4836684">.</span><span class="ident" id="4836685">Map</span><span class="op" id="4836688">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836692">enc</span><span class="op" id="4836695">.</span><span class="ident" id="4836696">sendType</span><span class="op" id="4836704">(</span><span class="ident" id="4836705">w</span><span class="op" id="4836706">,</span>&nbsp;<span class="ident" id="4836708">state</span><span class="op" id="4836713">,</span>&nbsp;<span class="ident" id="4836715">st</span><span class="op" id="4836717">.</span><span class="ident" id="4836718">Key</span><span class="op" id="4836721">(</span><span class="op" id="4836722">)</span><span class="op" id="4836723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836727">enc</span><span class="op" id="4836730">.</span><span class="ident" id="4836731">sendType</span><span class="op" id="4836739">(</span><span class="ident" id="4836740">w</span><span class="op" id="4836741">,</span>&nbsp;<span class="ident" id="4836743">state</span><span class="op" id="4836748">,</span>&nbsp;<span class="ident" id="4836750">st</span><span class="op" id="4836752">.</span><span class="ident" id="4836753">Elem</span><span class="op" id="4836757">(</span><span class="op" id="4836758">)</span><span class="op" id="4836759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4836762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4836765">return</span>&nbsp;<span class="builtintype" id="4836772">true</span><br>
<span class="lineno">125</span><span class="op" id="4836777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4836780">//&nbsp;sendType&nbsp;sends&nbsp;the&nbsp;type&nbsp;info&nbsp;to&nbsp;the&nbsp;other&nbsp;side,&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="4836845">func</span>&nbsp;<span class="op" id="4836850">(</span><span class="ident" id="4836851">enc</span>&nbsp;<span class="op" id="4836855">*</span><span class="ident" id="4836856">Encoder</span><span class="op" id="4836863">)</span>&nbsp;<span class="ident" id="4836865">sendType</span><span class="op" id="4836873">(</span><span class="ident" id="4836874">w</span>&nbsp;<span class="ident" id="4836876">io</span><span class="op" id="4836878">.</span><span class="ident" id="4836879">Writer</span><span class="op" id="4836885">,</span>&nbsp;<span class="ident" id="4836887">state</span>&nbsp;<span class="op" id="4836893">*</span><span class="ident" id="4836894">encoderState</span><span class="op" id="4836906">,</span>&nbsp;<span class="ident" id="4836908">origt</span>&nbsp;<span class="ident" id="4836914">reflect</span><span class="op" id="4836921">.</span><span class="ident" id="4836922">Type</span><span class="op" id="4836926">)</span>&nbsp;<span class="op" id="4836928">(</span><span class="ident" id="4836929">sent</span>&nbsp;<span class="builtintype" id="4836934">bool</span><span class="op" id="4836938">)</span>&nbsp;<span class="op" id="4836940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836943">ut</span>&nbsp;<span class="op" id="4836946">:=</span>&nbsp;<span class="ident" id="4836949">userType</span><span class="op" id="4836957">(</span><span class="ident" id="4836958">origt</span><span class="op" id="4836963">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4836966">if</span>&nbsp;<span class="ident" id="4836969">ut</span><span class="op" id="4836971">.</span><span class="ident" id="4836972">externalEnc</span>&nbsp;<span class="op" id="4836984">!=</span>&nbsp;<span class="num" id="4836987">0</span>&nbsp;<span class="op" id="4836989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4836993">//&nbsp;The&nbsp;rules&nbsp;are&nbsp;different:&nbsp;regardless&nbsp;of&nbsp;the&nbsp;underlying&nbsp;type&#39;s&nbsp;representation,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4837075">//&nbsp;we&nbsp;need&nbsp;to&nbsp;tell&nbsp;the&nbsp;other&nbsp;side&nbsp;that&nbsp;the&nbsp;base&nbsp;type&nbsp;is&nbsp;a&nbsp;GobEncoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837147">return</span>&nbsp;<span class="ident" id="4837154">enc</span><span class="op" id="4837157">.</span><span class="ident" id="4837158">sendActualType</span><span class="op" id="4837172">(</span><span class="ident" id="4837173">w</span><span class="op" id="4837174">,</span>&nbsp;<span class="ident" id="4837176">state</span><span class="op" id="4837181">,</span>&nbsp;<span class="ident" id="4837183">ut</span><span class="op" id="4837185">,</span>&nbsp;<span class="ident" id="4837187">ut</span><span class="op" id="4837189">.</span><span class="ident" id="4837190">base</span><span class="op" id="4837194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4837197">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4837201">//&nbsp;It&#39;s&nbsp;a&nbsp;concrete&nbsp;value,&nbsp;so&nbsp;drill&nbsp;down&nbsp;to&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837260">switch</span>&nbsp;<span class="ident" id="4837267">rt</span>&nbsp;<span class="op" id="4837270">:=</span>&nbsp;<span class="ident" id="4837273">ut</span><span class="op" id="4837275">.</span><span class="ident" id="4837276">base</span><span class="op" id="4837280">;</span>&nbsp;<span class="ident" id="4837282">rt</span><span class="op" id="4837284">.</span><span class="ident" id="4837285">Kind</span><span class="op" id="4837289">(</span><span class="op" id="4837290">)</span>&nbsp;<span class="op" id="4837292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837295">default</span><span class="op" id="4837302">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4837306">//&nbsp;Basic&nbsp;types&nbsp;and&nbsp;interfaces&nbsp;do&nbsp;not&nbsp;need&nbsp;to&nbsp;be&nbsp;described.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837367">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837375">case</span>&nbsp;<span class="ident" id="4837380">reflect</span><span class="op" id="4837387">.</span><span class="ident" id="4837388">Slice</span><span class="op" id="4837393">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4837397">//&nbsp;If&nbsp;it&#39;s&nbsp;[]uint8,&nbsp;don&#39;t&nbsp;send;&nbsp;it&#39;s&nbsp;considered&nbsp;basic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837454">if</span>&nbsp;<span class="ident" id="4837457">rt</span><span class="op" id="4837459">.</span><span class="ident" id="4837460">Elem</span><span class="op" id="4837464">(</span><span class="op" id="4837465">)</span><span class="op" id="4837466">.</span><span class="ident" id="4837467">Kind</span><span class="op" id="4837471">(</span><span class="op" id="4837472">)</span>&nbsp;<span class="op" id="4837474">==</span>&nbsp;<span class="ident" id="4837477">reflect</span><span class="op" id="4837484">.</span><span class="ident" id="4837485">Uint8</span>&nbsp;<span class="op" id="4837491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837496">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4837505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4837509">//&nbsp;Otherwise&nbsp;we&nbsp;do&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837536">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837543">case</span>&nbsp;<span class="ident" id="4837548">reflect</span><span class="op" id="4837555">.</span><span class="ident" id="4837556">Array</span><span class="op" id="4837561">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4837565">//&nbsp;arrays&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;element&nbsp;types.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837634">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837641">case</span>&nbsp;<span class="ident" id="4837646">reflect</span><span class="op" id="4837653">.</span><span class="ident" id="4837654">Map</span><span class="op" id="4837657">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4837661">//&nbsp;maps&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;key/value&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837730">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837737">case</span>&nbsp;<span class="ident" id="4837742">reflect</span><span class="op" id="4837749">.</span><span class="ident" id="4837750">Struct</span><span class="op" id="4837756">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4837760">//&nbsp;structs&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837811">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837818">case</span>&nbsp;<span class="ident" id="4837823">reflect</span><span class="op" id="4837830">.</span><span class="ident" id="4837831">Chan</span><span class="op" id="4837835">,</span>&nbsp;<span class="ident" id="4837837">reflect</span><span class="op" id="4837844">.</span><span class="ident" id="4837845">Func</span><span class="op" id="4837849">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4837853">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here,&nbsp;it&#39;s&nbsp;a&nbsp;field&nbsp;of&nbsp;a&nbsp;struct;&nbsp;ignore&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837911">return</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4837919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837923">return</span>&nbsp;<span class="ident" id="4837930">enc</span><span class="op" id="4837933">.</span><span class="ident" id="4837934">sendActualType</span><span class="op" id="4837948">(</span><span class="ident" id="4837949">w</span><span class="op" id="4837950">,</span>&nbsp;<span class="ident" id="4837952">state</span><span class="op" id="4837957">,</span>&nbsp;<span class="ident" id="4837959">ut</span><span class="op" id="4837961">,</span>&nbsp;<span class="ident" id="4837963">ut</span><span class="op" id="4837965">.</span><span class="ident" id="4837966">base</span><span class="op" id="4837970">)</span><br>
<span class="lineno"></span><span class="op" id="4837972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="4837975">//&nbsp;Encode&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;empty&nbsp;interface&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="4838051">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="4838131">func</span>&nbsp;<span class="op" id="4838136">(</span><span class="ident" id="4838137">enc</span>&nbsp;<span class="op" id="4838141">*</span><span class="ident" id="4838142">Encoder</span><span class="op" id="4838149">)</span>&nbsp;<span class="ident" id="4838151">Encode</span><span class="op" id="4838157">(</span><span class="ident" id="4838158">e</span>&nbsp;<span class="keyword" id="4838160">interface</span><span class="op" id="4838169">{</span><span class="op" id="4838170">}</span><span class="op" id="4838171">)</span>&nbsp;<span class="builtintype" id="4838173">error</span>&nbsp;<span class="op" id="4838179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4838182">return</span>&nbsp;<span class="ident" id="4838189">enc</span><span class="op" id="4838192">.</span><span class="ident" id="4838193">EncodeValue</span><span class="op" id="4838204">(</span><span class="ident" id="4838205">reflect</span><span class="op" id="4838212">.</span><span class="ident" id="4838213">ValueOf</span><span class="op" id="4838220">(</span><span class="ident" id="4838221">e</span><span class="op" id="4838222">)</span><span class="op" id="4838223">)</span><br>
<span class="lineno"></span><span class="op" id="4838225">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="4838228">//&nbsp;sendTypeDescriptor&nbsp;makes&nbsp;sure&nbsp;the&nbsp;remote&nbsp;side&nbsp;knows&nbsp;about&nbsp;this&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="4838300">//&nbsp;It&nbsp;will&nbsp;send&nbsp;a&nbsp;descriptor&nbsp;if&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;time&nbsp;the&nbsp;type&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span><span class="comment" id="4838373">//&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="4838382">func</span>&nbsp;<span class="op" id="4838387">(</span><span class="ident" id="4838388">enc</span>&nbsp;<span class="op" id="4838392">*</span><span class="ident" id="4838393">Encoder</span><span class="op" id="4838400">)</span>&nbsp;<span class="ident" id="4838402">sendTypeDescriptor</span><span class="op" id="4838420">(</span><span class="ident" id="4838421">w</span>&nbsp;<span class="ident" id="4838423">io</span><span class="op" id="4838425">.</span><span class="ident" id="4838426">Writer</span><span class="op" id="4838432">,</span>&nbsp;<span class="ident" id="4838434">state</span>&nbsp;<span class="op" id="4838440">*</span><span class="ident" id="4838441">encoderState</span><span class="op" id="4838453">,</span>&nbsp;<span class="ident" id="4838455">ut</span>&nbsp;<span class="op" id="4838458">*</span><span class="ident" id="4838459">userTypeInfo</span><span class="op" id="4838471">)</span>&nbsp;<span class="op" id="4838473">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4838476">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;type&nbsp;is&nbsp;known&nbsp;to&nbsp;the&nbsp;other&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4838527">//&nbsp;First,&nbsp;have&nbsp;we&nbsp;already&nbsp;sent&nbsp;this&nbsp;type?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838570">rt</span>&nbsp;<span class="op" id="4838573">:=</span>&nbsp;<span class="ident" id="4838576">ut</span><span class="op" id="4838578">.</span><span class="ident" id="4838579">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4838585">if</span>&nbsp;<span class="ident" id="4838588">ut</span><span class="op" id="4838590">.</span><span class="ident" id="4838591">externalEnc</span>&nbsp;<span class="op" id="4838603">!=</span>&nbsp;<span class="num" id="4838606">0</span>&nbsp;<span class="op" id="4838608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838612">rt</span>&nbsp;<span class="op" id="4838615">=</span>&nbsp;<span class="ident" id="4838617">ut</span><span class="op" id="4838619">.</span><span class="ident" id="4838620">user</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4838626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4838629">if</span>&nbsp;<span class="ident" id="4838632">_</span><span class="op" id="4838633">,</span>&nbsp;<span class="ident" id="4838635">alreadySent</span>&nbsp;<span class="op" id="4838647">:=</span>&nbsp;<span class="ident" id="4838650">enc</span><span class="op" id="4838653">.</span><span class="ident" id="4838654">sent</span><span class="op" id="4838658">[</span><span class="ident" id="4838659">rt</span><span class="op" id="4838661">]</span><span class="op" id="4838662">;</span>&nbsp;<span class="op" id="4838664">!</span><span class="ident" id="4838665">alreadySent</span>&nbsp;<span class="op" id="4838677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4838681">//&nbsp;No,&nbsp;so&nbsp;send&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838702">sent</span>&nbsp;<span class="op" id="4838707">:=</span>&nbsp;<span class="ident" id="4838710">enc</span><span class="op" id="4838713">.</span><span class="ident" id="4838714">sendType</span><span class="op" id="4838722">(</span><span class="ident" id="4838723">w</span><span class="op" id="4838724">,</span>&nbsp;<span class="ident" id="4838726">state</span><span class="op" id="4838731">,</span>&nbsp;<span class="ident" id="4838733">rt</span><span class="op" id="4838735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4838739">if</span>&nbsp;<span class="ident" id="4838742">enc</span><span class="op" id="4838745">.</span><span class="ident" id="4838746">err</span>&nbsp;<span class="op" id="4838750">!=</span>&nbsp;<span class="ident" id="4838753">nil</span>&nbsp;<span class="op" id="4838757">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4838762">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4838771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4838775">//&nbsp;If&nbsp;the&nbsp;type&nbsp;info&nbsp;has&nbsp;still&nbsp;not&nbsp;been&nbsp;transmitted,&nbsp;it&nbsp;means&nbsp;we&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4838846">//&nbsp;a&nbsp;singleton&nbsp;basic&nbsp;type&nbsp;(int,&nbsp;[]byte&nbsp;etc.)&nbsp;at&nbsp;top&nbsp;level.&nbsp;&nbsp;We&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4838917">//&nbsp;need&nbsp;to&nbsp;send&nbsp;the&nbsp;type&nbsp;info&nbsp;but&nbsp;we&nbsp;do&nbsp;need&nbsp;to&nbsp;update&nbsp;enc.sent.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4838984">if</span>&nbsp;<span class="op" id="4838987">!</span><span class="ident" id="4838988">sent</span>&nbsp;<span class="op" id="4838993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838998">info</span><span class="op" id="4839002">,</span>&nbsp;<span class="ident" id="4839004">err</span>&nbsp;<span class="op" id="4839008">:=</span>&nbsp;<span class="ident" id="4839011">getTypeInfo</span><span class="op" id="4839022">(</span><span class="ident" id="4839023">ut</span><span class="op" id="4839025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839030">if</span>&nbsp;<span class="ident" id="4839033">err</span>&nbsp;<span class="op" id="4839037">!=</span>&nbsp;<span class="ident" id="4839040">nil</span>&nbsp;<span class="op" id="4839044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839050">enc</span><span class="op" id="4839053">.</span><span class="ident" id="4839054">setError</span><span class="op" id="4839062">(</span><span class="ident" id="4839063">err</span><span class="op" id="4839066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839072">return</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4839082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839087">enc</span><span class="op" id="4839090">.</span><span class="ident" id="4839091">sent</span><span class="op" id="4839095">[</span><span class="ident" id="4839096">rt</span><span class="op" id="4839098">]</span>&nbsp;<span class="op" id="4839100">=</span>&nbsp;<span class="ident" id="4839102">info</span><span class="op" id="4839106">.</span><span class="ident" id="4839107">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4839112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4839115">}</span><br>
<span class="lineno"></span><span class="op" id="4839117">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="4839120">//&nbsp;sendTypeId&nbsp;sends&nbsp;the&nbsp;id,&nbsp;which&nbsp;must&nbsp;have&nbsp;already&nbsp;been&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="4839186">func</span>&nbsp;<span class="op" id="4839191">(</span><span class="ident" id="4839192">enc</span>&nbsp;<span class="op" id="4839196">*</span><span class="ident" id="4839197">Encoder</span><span class="op" id="4839204">)</span>&nbsp;<span class="ident" id="4839206">sendTypeId</span><span class="op" id="4839216">(</span><span class="ident" id="4839217">state</span>&nbsp;<span class="op" id="4839223">*</span><span class="ident" id="4839224">encoderState</span><span class="op" id="4839236">,</span>&nbsp;<span class="ident" id="4839238">ut</span>&nbsp;<span class="op" id="4839241">*</span><span class="ident" id="4839242">userTypeInfo</span><span class="op" id="4839254">)</span>&nbsp;<span class="op" id="4839256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4839259">//&nbsp;Identify&nbsp;the&nbsp;type&nbsp;of&nbsp;this&nbsp;top-level&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839306">state</span><span class="op" id="4839311">.</span><span class="ident" id="4839312">encodeInt</span><span class="op" id="4839321">(</span><span class="ident" id="4839322">int64</span><span class="op" id="4839327">(</span><span class="ident" id="4839328">enc</span><span class="op" id="4839331">.</span><span class="ident" id="4839332">sent</span><span class="op" id="4839336">[</span><span class="ident" id="4839337">ut</span><span class="op" id="4839339">.</span><span class="ident" id="4839340">base</span><span class="op" id="4839344">]</span><span class="op" id="4839345">)</span><span class="op" id="4839346">)</span><br>
<span class="lineno">205</span><span class="op" id="4839348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4839351">//&nbsp;EncodeValue&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;reflection&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="4839427">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="4839507">func</span>&nbsp;<span class="op" id="4839512">(</span><span class="ident" id="4839513">enc</span>&nbsp;<span class="op" id="4839517">*</span><span class="ident" id="4839518">Encoder</span><span class="op" id="4839525">)</span>&nbsp;<span class="ident" id="4839527">EncodeValue</span><span class="op" id="4839538">(</span><span class="ident" id="4839539">value</span>&nbsp;<span class="ident" id="4839545">reflect</span><span class="op" id="4839552">.</span><span class="ident" id="4839553">Value</span><span class="op" id="4839558">)</span>&nbsp;<span class="builtintype" id="4839560">error</span>&nbsp;<span class="op" id="4839566">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4839569">//&nbsp;Gobs&nbsp;contain&nbsp;values.&nbsp;They&nbsp;cannot&nbsp;represent&nbsp;nil&nbsp;pointers,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4839636">//&nbsp;have&nbsp;no&nbsp;value&nbsp;to&nbsp;encode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839665">if</span>&nbsp;<span class="ident" id="4839668">value</span><span class="op" id="4839673">.</span><span class="ident" id="4839674">Kind</span><span class="op" id="4839678">(</span><span class="op" id="4839679">)</span>&nbsp;<span class="op" id="4839681">==</span>&nbsp;<span class="ident" id="4839684">reflect</span><span class="op" id="4839691">.</span><span class="ident" id="4839692">Ptr</span>&nbsp;<span class="op" id="4839696">&amp;&amp;</span>&nbsp;<span class="ident" id="4839699">value</span><span class="op" id="4839704">.</span><span class="ident" id="4839705">IsNil</span><span class="op" id="4839710">(</span><span class="op" id="4839711">)</span>&nbsp;<span class="op" id="4839713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4839717">panic</span><span class="op" id="4839722">(</span><span class="string" id="4839723">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4839765">+</span>&nbsp;<span class="ident" id="4839767">value</span><span class="op" id="4839772">.</span><span class="ident" id="4839773">Type</span><span class="op" id="4839777">(</span><span class="op" id="4839778">)</span><span class="op" id="4839779">.</span><span class="ident" id="4839780">String</span><span class="op" id="4839786">(</span><span class="op" id="4839787">)</span><span class="op" id="4839788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4839791">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4839795">//&nbsp;Make&nbsp;sure&nbsp;we&#39;re&nbsp;single-threaded&nbsp;through&nbsp;here,&nbsp;so&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4839857">//&nbsp;goroutines&nbsp;can&nbsp;share&nbsp;an&nbsp;encoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839894">enc</span><span class="op" id="4839897">.</span><span class="ident" id="4839898">mutex</span><span class="op" id="4839903">.</span><span class="ident" id="4839904">Lock</span><span class="op" id="4839908">(</span><span class="op" id="4839909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839912">defer</span>&nbsp;<span class="ident" id="4839918">enc</span><span class="op" id="4839921">.</span><span class="ident" id="4839922">mutex</span><span class="op" id="4839927">.</span><span class="ident" id="4839928">Unlock</span><span class="op" id="4839934">(</span><span class="op" id="4839935">)</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4839939">//&nbsp;Remove&nbsp;any&nbsp;nested&nbsp;writers&nbsp;remaining&nbsp;due&nbsp;to&nbsp;previous&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4840003">enc</span><span class="op" id="4840006">.</span><span class="ident" id="4840007">w</span>&nbsp;<span class="op" id="4840009">=</span>&nbsp;<span class="ident" id="4840011">enc</span><span class="op" id="4840014">.</span><span class="ident" id="4840015">w</span><span class="op" id="4840016">[</span><span class="num" id="4840017">0</span><span class="op" id="4840018">:</span><span class="num" id="4840019">1</span><span class="op" id="4840020">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4840024">ut</span><span class="op" id="4840026">,</span>&nbsp;<span class="ident" id="4840028">err</span>&nbsp;<span class="op" id="4840032">:=</span>&nbsp;<span class="ident" id="4840035">validUserType</span><span class="op" id="4840048">(</span><span class="ident" id="4840049">value</span><span class="op" id="4840054">.</span><span class="ident" id="4840055">Type</span><span class="op" id="4840059">(</span><span class="op" id="4840060">)</span><span class="op" id="4840061">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4840064">if</span>&nbsp;<span class="ident" id="4840067">err</span>&nbsp;<span class="op" id="4840071">!=</span>&nbsp;<span class="ident" id="4840074">nil</span>&nbsp;<span class="op" id="4840078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4840082">return</span>&nbsp;<span class="ident" id="4840089">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4840094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4840098">enc</span><span class="op" id="4840101">.</span><span class="ident" id="4840102">err</span>&nbsp;<span class="op" id="4840106">=</span>&nbsp;<span class="ident" id="4840108">nil</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4840113">enc</span><span class="op" id="4840116">.</span><span class="ident" id="4840117">byteBuf</span><span class="op" id="4840124">.</span><span class="ident" id="4840125">Reset</span><span class="op" id="4840130">(</span><span class="op" id="4840131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4840134">enc</span><span class="op" id="4840137">.</span><span class="ident" id="4840138">byteBuf</span><span class="op" id="4840145">.</span><span class="ident" id="4840146">Write</span><span class="op" id="4840151">(</span><span class="ident" id="4840152">spaceForLength</span><span class="op" id="4840166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4840169">state</span>&nbsp;<span class="op" id="4840175">:=</span>&nbsp;<span class="ident" id="4840178">enc</span><span class="op" id="4840181">.</span><span class="ident" id="4840182">newEncoderState</span><span class="op" id="4840197">(</span><span class="op" id="4840198">&amp;</span><span class="ident" id="4840199">enc</span><span class="op" id="4840202">.</span><span class="ident" id="4840203">byteBuf</span><span class="op" id="4840210">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4840214">enc</span><span class="op" id="4840217">.</span><span class="ident" id="4840218">sendTypeDescriptor</span><span class="op" id="4840236">(</span><span class="ident" id="4840237">enc</span><span class="op" id="4840240">.</span><span class="ident" id="4840241">writer</span><span class="op" id="4840247">(</span><span class="op" id="4840248">)</span><span class="op" id="4840249">,</span>&nbsp;<span class="ident" id="4840251">state</span><span class="op" id="4840256">,</span>&nbsp;<span class="ident" id="4840258">ut</span><span class="op" id="4840260">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4840263">enc</span><span class="op" id="4840266">.</span><span class="ident" id="4840267">sendTypeId</span><span class="op" id="4840277">(</span><span class="ident" id="4840278">state</span><span class="op" id="4840283">,</span>&nbsp;<span class="ident" id="4840285">ut</span><span class="op" id="4840287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4840290">if</span>&nbsp;<span class="ident" id="4840293">enc</span><span class="op" id="4840296">.</span><span class="ident" id="4840297">err</span>&nbsp;<span class="op" id="4840301">!=</span>&nbsp;<span class="ident" id="4840304">nil</span>&nbsp;<span class="op" id="4840308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4840312">return</span>&nbsp;<span class="ident" id="4840319">enc</span><span class="op" id="4840322">.</span><span class="ident" id="4840323">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4840328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4840332">//&nbsp;Encode&nbsp;the&nbsp;object.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4840355">enc</span><span class="op" id="4840358">.</span><span class="ident" id="4840359">encode</span><span class="op" id="4840365">(</span><span class="ident" id="4840366">state</span><span class="op" id="4840371">.</span><span class="ident" id="4840372">b</span><span class="op" id="4840373">,</span>&nbsp;<span class="ident" id="4840375">value</span><span class="op" id="4840380">,</span>&nbsp;<span class="ident" id="4840382">ut</span><span class="op" id="4840384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4840387">if</span>&nbsp;<span class="ident" id="4840390">enc</span><span class="op" id="4840393">.</span><span class="ident" id="4840394">err</span>&nbsp;<span class="op" id="4840398">==</span>&nbsp;<span class="ident" id="4840401">nil</span>&nbsp;<span class="op" id="4840405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4840409">enc</span><span class="op" id="4840412">.</span><span class="ident" id="4840413">writeMessage</span><span class="op" id="4840425">(</span><span class="ident" id="4840426">enc</span><span class="op" id="4840429">.</span><span class="ident" id="4840430">writer</span><span class="op" id="4840436">(</span><span class="op" id="4840437">)</span><span class="op" id="4840438">,</span>&nbsp;<span class="ident" id="4840440">state</span><span class="op" id="4840445">.</span><span class="ident" id="4840446">b</span><span class="op" id="4840447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4840450">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4840454">enc</span><span class="op" id="4840457">.</span><span class="ident" id="4840458">freeEncoderState</span><span class="op" id="4840474">(</span><span class="ident" id="4840475">state</span><span class="op" id="4840480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4840483">return</span>&nbsp;<span class="ident" id="4840490">enc</span><span class="op" id="4840493">.</span><span class="ident" id="4840494">err</span><br>
<span class="lineno"></span><span class="op" id="4840498">}</span>
</div>
</body>
</html>
