<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8237238">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8237293">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8237347">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8237398">//&nbsp;Reverse&nbsp;proxy&nbsp;tests.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8237423">package</span>&nbsp;<span class="ident" id="8237431">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8237441">import</span>&nbsp;<span class="op" id="8237448">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8237451">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8237464">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8237476">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8237497">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8237508">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8237519">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8237530">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8237537">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8237540">const</span>&nbsp;<span class="ident" id="8237546">fakeHopHeader</span>&nbsp;<span class="op" id="8237560">=</span>&nbsp;<span class="string" id="8237562">&#34;X-Fake-Hop-Header-For-Test&#34;</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="8237592">func</span>&nbsp;<span class="ident" id="8237597">init</span><span class="op" id="8237601">(</span><span class="op" id="8237602">)</span>&nbsp;<span class="op" id="8237604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8237607">hopHeaders</span>&nbsp;<span class="op" id="8237618">=</span>&nbsp;<span class="builtinfunc" id="8237620">append</span><span class="op" id="8237626">(</span><span class="ident" id="8237627">hopHeaders</span><span class="op" id="8237637">,</span>&nbsp;<span class="ident" id="8237639">fakeHopHeader</span><span class="op" id="8237652">)</span><br>
<span class="lineno"></span><span class="op" id="8237654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="8237657">func</span>&nbsp;<span class="ident" id="8237662">TestReverseProxy</span><span class="op" id="8237678">(</span><span class="ident" id="8237679">t</span>&nbsp;<span class="op" id="8237681">*</span><span class="ident" id="8237682">testing</span><span class="op" id="8237689">.</span><span class="ident" id="8237690">T</span><span class="op" id="8237691">)</span>&nbsp;<span class="op" id="8237693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8237696">const</span>&nbsp;<span class="ident" id="8237702">backendResponse</span>&nbsp;<span class="op" id="8237718">=</span>&nbsp;<span class="string" id="8237720">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8237740">const</span>&nbsp;<span class="ident" id="8237746">backendStatus</span>&nbsp;<span class="op" id="8237760">=</span>&nbsp;<span class="num" id="8237762">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8237767">backend</span>&nbsp;<span class="op" id="8237775">:=</span>&nbsp;<span class="ident" id="8237778">httptest</span><span class="op" id="8237786">.</span><span class="ident" id="8237787">NewServer</span><span class="op" id="8237796">(</span><span class="ident" id="8237797">http</span><span class="op" id="8237801">.</span><span class="ident" id="8237802">HandlerFunc</span><span class="op" id="8237813">(</span><span class="keyword" id="8237814">func</span><span class="op" id="8237818">(</span><span class="ident" id="8237819">w</span>&nbsp;<span class="ident" id="8237821">http</span><span class="op" id="8237825">.</span><span class="ident" id="8237826">ResponseWriter</span><span class="op" id="8237840">,</span>&nbsp;<span class="ident" id="8237842">r</span>&nbsp;<span class="op" id="8237844">*</span><span class="ident" id="8237845">http</span><span class="op" id="8237849">.</span><span class="ident" id="8237850">Request</span><span class="op" id="8237857">)</span>&nbsp;<span class="op" id="8237859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8237863">if</span>&nbsp;<span class="builtinfunc" id="8237866">len</span><span class="op" id="8237869">(</span><span class="ident" id="8237870">r</span><span class="op" id="8237871">.</span><span class="ident" id="8237872">TransferEncoding</span><span class="op" id="8237888">)</span>&nbsp;<span class="op" id="8237890">&gt;</span>&nbsp;<span class="num" id="8237892">0</span>&nbsp;<span class="op" id="8237894">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8237899">t</span><span class="op" id="8237900">.</span><span class="ident" id="8237901">Errorf</span><span class="op" id="8237907">(</span><span class="string" id="8237908">&#34;backend&nbsp;got&nbsp;unexpected&nbsp;TransferEncoding:&nbsp;%v&#34;</span><span class="op" id="8237953">,</span>&nbsp;<span class="ident" id="8237955">r</span><span class="op" id="8237956">.</span><span class="ident" id="8237957">TransferEncoding</span><span class="op" id="8237973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8237977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8237981">if</span>&nbsp;<span class="ident" id="8237984">r</span><span class="op" id="8237985">.</span><span class="ident" id="8237986">Header</span><span class="op" id="8237992">.</span><span class="ident" id="8237993">Get</span><span class="op" id="8237996">(</span><span class="string" id="8237997">&#34;X-Forwarded-For&#34;</span><span class="op" id="8238014">)</span>&nbsp;<span class="op" id="8238016">==</span>&nbsp;<span class="string" id="8238019">&#34;&#34;</span>&nbsp;<span class="op" id="8238022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8238027">t</span><span class="op" id="8238028">.</span><span class="ident" id="8238029">Errorf</span><span class="op" id="8238035">(</span><span class="string" id="8238036">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="8238071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8238075">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8238079">if</span>&nbsp;<span class="ident" id="8238082">c</span>&nbsp;<span class="op" id="8238084">:=</span>&nbsp;<span class="ident" id="8238087">r</span><span class="op" id="8238088">.</span><span class="ident" id="8238089">Header</span><span class="op" id="8238095">.</span><span class="ident" id="8238096">Get</span><span class="op" id="8238099">(</span><span class="string" id="8238100">&#34;Connection&#34;</span><span class="op" id="8238112">)</span><span class="op" id="8238113">;</span>&nbsp;<span class="ident" id="8238115">c</span>&nbsp;<span class="op" id="8238117">!=</span>&nbsp;<span class="string" id="8238120">&#34;&#34;</span>&nbsp;<span class="op" id="8238123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8238128">t</span><span class="op" id="8238129">.</span><span class="ident" id="8238130">Errorf</span><span class="op" id="8238136">(</span><span class="string" id="8238137">&#34;handler&nbsp;got&nbsp;Connection&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="8238177">,</span>&nbsp;<span class="ident" id="8238179">c</span><span class="op" id="8238180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8238184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8238188">if</span>&nbsp;<span class="ident" id="8238191">c</span>&nbsp;<span class="op" id="8238193">:=</span>&nbsp;<span class="ident" id="8238196">r</span><span class="op" id="8238197">.</span><span class="ident" id="8238198">Header</span><span class="op" id="8238204">.</span><span class="ident" id="8238205">Get</span><span class="op" id="8238208">(</span><span class="string" id="8238209">&#34;Upgrade&#34;</span><span class="op" id="8238218">)</span><span class="op" id="8238219">;</span>&nbsp;<span class="ident" id="8238221">c</span>&nbsp;<span class="op" id="8238223">!=</span>&nbsp;<span class="string" id="8238226">&#34;&#34;</span>&nbsp;<span class="op" id="8238229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8238234">t</span><span class="op" id="8238235">.</span><span class="ident" id="8238236">Errorf</span><span class="op" id="8238242">(</span><span class="string" id="8238243">&#34;handler&nbsp;got&nbsp;Upgrade&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="8238280">,</span>&nbsp;<span class="ident" id="8238282">c</span><span class="op" id="8238283">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8238287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8238291">if</span>&nbsp;<span class="ident" id="8238294">g</span><span class="op" id="8238295">,</span>&nbsp;<span class="ident" id="8238297">e</span>&nbsp;<span class="op" id="8238299">:=</span>&nbsp;<span class="ident" id="8238302">r</span><span class="op" id="8238303">.</span><span class="ident" id="8238304">Host</span><span class="op" id="8238308">,</span>&nbsp;<span class="string" id="8238310">&#34;some-name&#34;</span><span class="op" id="8238321">;</span>&nbsp;<span class="ident" id="8238323">g</span>&nbsp;<span class="op" id="8238325">!=</span>&nbsp;<span class="ident" id="8238328">e</span>&nbsp;<span class="op" id="8238330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8238335">t</span><span class="op" id="8238336">.</span><span class="ident" id="8238337">Errorf</span><span class="op" id="8238343">(</span><span class="string" id="8238344">&#34;backend&nbsp;got&nbsp;Host&nbsp;header&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8238381">,</span>&nbsp;<span class="ident" id="8238383">g</span><span class="op" id="8238384">,</span>&nbsp;<span class="ident" id="8238386">e</span><span class="op" id="8238387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8238391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8238395">w</span><span class="op" id="8238396">.</span><span class="ident" id="8238397">Header</span><span class="op" id="8238403">(</span><span class="op" id="8238404">)</span><span class="op" id="8238405">.</span><span class="ident" id="8238406">Set</span><span class="op" id="8238409">(</span><span class="string" id="8238410">&#34;X-Foo&#34;</span><span class="op" id="8238417">,</span>&nbsp;<span class="string" id="8238419">&#34;bar&#34;</span><span class="op" id="8238424">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8238428">w</span><span class="op" id="8238429">.</span><span class="ident" id="8238430">Header</span><span class="op" id="8238436">(</span><span class="op" id="8238437">)</span><span class="op" id="8238438">.</span><span class="ident" id="8238439">Set</span><span class="op" id="8238442">(</span><span class="string" id="8238443">&#34;Upgrade&#34;</span><span class="op" id="8238452">,</span>&nbsp;<span class="string" id="8238454">&#34;foo&#34;</span><span class="op" id="8238459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8238463">w</span><span class="op" id="8238464">.</span><span class="ident" id="8238465">Header</span><span class="op" id="8238471">(</span><span class="op" id="8238472">)</span><span class="op" id="8238473">.</span><span class="ident" id="8238474">Set</span><span class="op" id="8238477">(</span><span class="ident" id="8238478">fakeHopHeader</span><span class="op" id="8238491">,</span>&nbsp;<span class="string" id="8238493">&#34;foo&#34;</span><span class="op" id="8238498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8238502">w</span><span class="op" id="8238503">.</span><span class="ident" id="8238504">Header</span><span class="op" id="8238510">(</span><span class="op" id="8238511">)</span><span class="op" id="8238512">.</span><span class="ident" id="8238513">Add</span><span class="op" id="8238516">(</span><span class="string" id="8238517">&#34;X-Multi-Value&#34;</span><span class="op" id="8238532">,</span>&nbsp;<span class="string" id="8238534">&#34;foo&#34;</span><span class="op" id="8238539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8238543">w</span><span class="op" id="8238544">.</span><span class="ident" id="8238545">Header</span><span class="op" id="8238551">(</span><span class="op" id="8238552">)</span><span class="op" id="8238553">.</span><span class="ident" id="8238554">Add</span><span class="op" id="8238557">(</span><span class="string" id="8238558">&#34;X-Multi-Value&#34;</span><span class="op" id="8238573">,</span>&nbsp;<span class="string" id="8238575">&#34;bar&#34;</span><span class="op" id="8238580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8238584">http</span><span class="op" id="8238588">.</span><span class="ident" id="8238589">SetCookie</span><span class="op" id="8238598">(</span><span class="ident" id="8238599">w</span><span class="op" id="8238600">,</span>&nbsp;<span class="op" id="8238602">&amp;</span><span class="ident" id="8238603">http</span><span class="op" id="8238607">.</span><span class="ident" id="8238608">Cookie</span><span class="op" id="8238614">{</span><span class="ident" id="8238615">Name</span><span class="op" id="8238619">:</span>&nbsp;<span class="string" id="8238621">&#34;flavor&#34;</span><span class="op" id="8238629">,</span>&nbsp;<span class="ident" id="8238631">Value</span><span class="op" id="8238636">:</span>&nbsp;<span class="string" id="8238638">&#34;chocolateChip&#34;</span><span class="op" id="8238653">}</span><span class="op" id="8238654">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8238658">w</span><span class="op" id="8238659">.</span><span class="ident" id="8238660">WriteHeader</span><span class="op" id="8238671">(</span><span class="ident" id="8238672">backendStatus</span><span class="op" id="8238685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8238689">w</span><span class="op" id="8238690">.</span><span class="ident" id="8238691">Write</span><span class="op" id="8238696">(</span><span class="op" id="8238697">[</span><span class="op" id="8238698">]</span><span class="builtintype" id="8238699">byte</span><span class="op" id="8238703">(</span><span class="ident" id="8238704">backendResponse</span><span class="op" id="8238719">)</span><span class="op" id="8238720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8238723">}</span><span class="op" id="8238724">)</span><span class="op" id="8238725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8238728">defer</span>&nbsp;<span class="ident" id="8238734">backend</span><span class="op" id="8238741">.</span><span class="ident" id="8238742">Close</span><span class="op" id="8238747">(</span><span class="op" id="8238748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8238751">backendURL</span><span class="op" id="8238761">,</span>&nbsp;<span class="ident" id="8238763">err</span>&nbsp;<span class="op" id="8238767">:=</span>&nbsp;<span class="ident" id="8238770">url</span><span class="op" id="8238773">.</span><span class="ident" id="8238774">Parse</span><span class="op" id="8238779">(</span><span class="ident" id="8238780">backend</span><span class="op" id="8238787">.</span><span class="ident" id="8238788">URL</span><span class="op" id="8238791">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8238794">if</span>&nbsp;<span class="ident" id="8238797">err</span>&nbsp;<span class="op" id="8238801">!=</span>&nbsp;<span class="ident" id="8238804">nil</span>&nbsp;<span class="op" id="8238808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8238812">t</span><span class="op" id="8238813">.</span><span class="ident" id="8238814">Fatal</span><span class="op" id="8238819">(</span><span class="ident" id="8238820">err</span><span class="op" id="8238823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8238826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8238829">proxyHandler</span>&nbsp;<span class="op" id="8238842">:=</span>&nbsp;<span class="ident" id="8238845">NewSingleHostReverseProxy</span><span class="op" id="8238870">(</span><span class="ident" id="8238871">backendURL</span><span class="op" id="8238881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8238884">frontend</span>&nbsp;<span class="op" id="8238893">:=</span>&nbsp;<span class="ident" id="8238896">httptest</span><span class="op" id="8238904">.</span><span class="ident" id="8238905">NewServer</span><span class="op" id="8238914">(</span><span class="ident" id="8238915">proxyHandler</span><span class="op" id="8238927">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8238930">defer</span>&nbsp;<span class="ident" id="8238936">frontend</span><span class="op" id="8238944">.</span><span class="ident" id="8238945">Close</span><span class="op" id="8238950">(</span><span class="op" id="8238951">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8238955">getReq</span><span class="op" id="8238961">,</span>&nbsp;<span class="ident" id="8238963">_</span>&nbsp;<span class="op" id="8238965">:=</span>&nbsp;<span class="ident" id="8238968">http</span><span class="op" id="8238972">.</span><span class="ident" id="8238973">NewRequest</span><span class="op" id="8238983">(</span><span class="string" id="8238984">&#34;GET&#34;</span><span class="op" id="8238989">,</span>&nbsp;<span class="ident" id="8238991">frontend</span><span class="op" id="8238999">.</span><span class="ident" id="8239000">URL</span><span class="op" id="8239003">,</span>&nbsp;<span class="ident" id="8239005">nil</span><span class="op" id="8239008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8239011">getReq</span><span class="op" id="8239017">.</span><span class="ident" id="8239018">Host</span>&nbsp;<span class="op" id="8239023">=</span>&nbsp;<span class="string" id="8239025">&#34;some-name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8239038">getReq</span><span class="op" id="8239044">.</span><span class="ident" id="8239045">Header</span><span class="op" id="8239051">.</span><span class="ident" id="8239052">Set</span><span class="op" id="8239055">(</span><span class="string" id="8239056">&#34;Connection&#34;</span><span class="op" id="8239068">,</span>&nbsp;<span class="string" id="8239070">&#34;close&#34;</span><span class="op" id="8239077">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8239080">getReq</span><span class="op" id="8239086">.</span><span class="ident" id="8239087">Header</span><span class="op" id="8239093">.</span><span class="ident" id="8239094">Set</span><span class="op" id="8239097">(</span><span class="string" id="8239098">&#34;Upgrade&#34;</span><span class="op" id="8239107">,</span>&nbsp;<span class="string" id="8239109">&#34;foo&#34;</span><span class="op" id="8239114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8239117">getReq</span><span class="op" id="8239123">.</span><span class="ident" id="8239124">Close</span>&nbsp;<span class="op" id="8239130">=</span>&nbsp;<span class="builtintype" id="8239132">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8239138">res</span><span class="op" id="8239141">,</span>&nbsp;<span class="ident" id="8239143">err</span>&nbsp;<span class="op" id="8239147">:=</span>&nbsp;<span class="ident" id="8239150">http</span><span class="op" id="8239154">.</span><span class="ident" id="8239155">DefaultClient</span><span class="op" id="8239168">.</span><span class="ident" id="8239169">Do</span><span class="op" id="8239171">(</span><span class="ident" id="8239172">getReq</span><span class="op" id="8239178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8239181">if</span>&nbsp;<span class="ident" id="8239184">err</span>&nbsp;<span class="op" id="8239188">!=</span>&nbsp;<span class="ident" id="8239191">nil</span>&nbsp;<span class="op" id="8239195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8239199">t</span><span class="op" id="8239200">.</span><span class="ident" id="8239201">Fatalf</span><span class="op" id="8239207">(</span><span class="string" id="8239208">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="8239217">,</span>&nbsp;<span class="ident" id="8239219">err</span><span class="op" id="8239222">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8239225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8239228">if</span>&nbsp;<span class="ident" id="8239231">g</span><span class="op" id="8239232">,</span>&nbsp;<span class="ident" id="8239234">e</span>&nbsp;<span class="op" id="8239236">:=</span>&nbsp;<span class="ident" id="8239239">res</span><span class="op" id="8239242">.</span><span class="ident" id="8239243">StatusCode</span><span class="op" id="8239253">,</span>&nbsp;<span class="ident" id="8239255">backendStatus</span><span class="op" id="8239268">;</span>&nbsp;<span class="ident" id="8239270">g</span>&nbsp;<span class="op" id="8239272">!=</span>&nbsp;<span class="ident" id="8239275">e</span>&nbsp;<span class="op" id="8239277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8239281">t</span><span class="op" id="8239282">.</span><span class="ident" id="8239283">Errorf</span><span class="op" id="8239289">(</span><span class="string" id="8239290">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="8239326">,</span>&nbsp;<span class="ident" id="8239328">g</span><span class="op" id="8239329">,</span>&nbsp;<span class="ident" id="8239331">e</span><span class="op" id="8239332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8239335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8239338">if</span>&nbsp;<span class="ident" id="8239341">g</span><span class="op" id="8239342">,</span>&nbsp;<span class="ident" id="8239344">e</span>&nbsp;<span class="op" id="8239346">:=</span>&nbsp;<span class="ident" id="8239349">res</span><span class="op" id="8239352">.</span><span class="ident" id="8239353">Header</span><span class="op" id="8239359">.</span><span class="ident" id="8239360">Get</span><span class="op" id="8239363">(</span><span class="string" id="8239364">&#34;X-Foo&#34;</span><span class="op" id="8239371">)</span><span class="op" id="8239372">,</span>&nbsp;<span class="string" id="8239374">&#34;bar&#34;</span><span class="op" id="8239379">;</span>&nbsp;<span class="ident" id="8239381">g</span>&nbsp;<span class="op" id="8239383">!=</span>&nbsp;<span class="ident" id="8239386">e</span>&nbsp;<span class="op" id="8239388">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8239392">t</span><span class="op" id="8239393">.</span><span class="ident" id="8239394">Errorf</span><span class="op" id="8239400">(</span><span class="string" id="8239401">&#34;got&nbsp;X-Foo&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8239428">,</span>&nbsp;<span class="ident" id="8239430">g</span><span class="op" id="8239431">,</span>&nbsp;<span class="ident" id="8239433">e</span><span class="op" id="8239434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8239437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8239440">if</span>&nbsp;<span class="ident" id="8239443">c</span>&nbsp;<span class="op" id="8239445">:=</span>&nbsp;<span class="ident" id="8239448">res</span><span class="op" id="8239451">.</span><span class="ident" id="8239452">Header</span><span class="op" id="8239458">.</span><span class="ident" id="8239459">Get</span><span class="op" id="8239462">(</span><span class="ident" id="8239463">fakeHopHeader</span><span class="op" id="8239476">)</span><span class="op" id="8239477">;</span>&nbsp;<span class="ident" id="8239479">c</span>&nbsp;<span class="op" id="8239481">!=</span>&nbsp;<span class="string" id="8239484">&#34;&#34;</span>&nbsp;<span class="op" id="8239487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8239491">t</span><span class="op" id="8239492">.</span><span class="ident" id="8239493">Errorf</span><span class="op" id="8239499">(</span><span class="string" id="8239500">&#34;got&nbsp;%s&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="8239524">,</span>&nbsp;<span class="ident" id="8239526">fakeHopHeader</span><span class="op" id="8239539">,</span>&nbsp;<span class="ident" id="8239541">c</span><span class="op" id="8239542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8239545">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8239548">if</span>&nbsp;<span class="ident" id="8239551">g</span><span class="op" id="8239552">,</span>&nbsp;<span class="ident" id="8239554">e</span>&nbsp;<span class="op" id="8239556">:=</span>&nbsp;<span class="builtinfunc" id="8239559">len</span><span class="op" id="8239562">(</span><span class="ident" id="8239563">res</span><span class="op" id="8239566">.</span><span class="ident" id="8239567">Header</span><span class="op" id="8239573">[</span><span class="string" id="8239574">&#34;X-Multi-Value&#34;</span><span class="op" id="8239589">]</span><span class="op" id="8239590">)</span><span class="op" id="8239591">,</span>&nbsp;<span class="num" id="8239593">2</span><span class="op" id="8239594">;</span>&nbsp;<span class="ident" id="8239596">g</span>&nbsp;<span class="op" id="8239598">!=</span>&nbsp;<span class="ident" id="8239601">e</span>&nbsp;<span class="op" id="8239603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8239607">t</span><span class="op" id="8239608">.</span><span class="ident" id="8239609">Errorf</span><span class="op" id="8239615">(</span><span class="string" id="8239616">&#34;got&nbsp;%d&nbsp;X-Multi-Value&nbsp;header&nbsp;values;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="8239665">,</span>&nbsp;<span class="ident" id="8239667">g</span><span class="op" id="8239668">,</span>&nbsp;<span class="ident" id="8239670">e</span><span class="op" id="8239671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8239674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8239677">if</span>&nbsp;<span class="ident" id="8239680">g</span><span class="op" id="8239681">,</span>&nbsp;<span class="ident" id="8239683">e</span>&nbsp;<span class="op" id="8239685">:=</span>&nbsp;<span class="builtinfunc" id="8239688">len</span><span class="op" id="8239691">(</span><span class="ident" id="8239692">res</span><span class="op" id="8239695">.</span><span class="ident" id="8239696">Header</span><span class="op" id="8239702">[</span><span class="string" id="8239703">&#34;Set-Cookie&#34;</span><span class="op" id="8239715">]</span><span class="op" id="8239716">)</span><span class="op" id="8239717">,</span>&nbsp;<span class="num" id="8239719">1</span><span class="op" id="8239720">;</span>&nbsp;<span class="ident" id="8239722">g</span>&nbsp;<span class="op" id="8239724">!=</span>&nbsp;<span class="ident" id="8239727">e</span>&nbsp;<span class="op" id="8239729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8239733">t</span><span class="op" id="8239734">.</span><span class="ident" id="8239735">Fatalf</span><span class="op" id="8239741">(</span><span class="string" id="8239742">&#34;got&nbsp;%d&nbsp;SetCookies,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8239770">,</span>&nbsp;<span class="ident" id="8239772">g</span><span class="op" id="8239773">,</span>&nbsp;<span class="ident" id="8239775">e</span><span class="op" id="8239776">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8239779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8239782">if</span>&nbsp;<span class="ident" id="8239785">cookie</span>&nbsp;<span class="op" id="8239792">:=</span>&nbsp;<span class="ident" id="8239795">res</span><span class="op" id="8239798">.</span><span class="ident" id="8239799">Cookies</span><span class="op" id="8239806">(</span><span class="op" id="8239807">)</span><span class="op" id="8239808">[</span><span class="num" id="8239809">0</span><span class="op" id="8239810">]</span><span class="op" id="8239811">;</span>&nbsp;<span class="ident" id="8239813">cookie</span><span class="op" id="8239819">.</span><span class="ident" id="8239820">Name</span>&nbsp;<span class="op" id="8239825">!=</span>&nbsp;<span class="string" id="8239828">&#34;flavor&#34;</span>&nbsp;<span class="op" id="8239837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8239841">t</span><span class="op" id="8239842">.</span><span class="ident" id="8239843">Errorf</span><span class="op" id="8239849">(</span><span class="string" id="8239850">&#34;unexpected&nbsp;cookie&nbsp;%q&#34;</span><span class="op" id="8239872">,</span>&nbsp;<span class="ident" id="8239874">cookie</span><span class="op" id="8239880">.</span><span class="ident" id="8239881">Name</span><span class="op" id="8239885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8239888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8239891">bodyBytes</span><span class="op" id="8239900">,</span>&nbsp;<span class="ident" id="8239902">_</span>&nbsp;<span class="op" id="8239904">:=</span>&nbsp;<span class="ident" id="8239907">ioutil</span><span class="op" id="8239913">.</span><span class="ident" id="8239914">ReadAll</span><span class="op" id="8239921">(</span><span class="ident" id="8239922">res</span><span class="op" id="8239925">.</span><span class="ident" id="8239926">Body</span><span class="op" id="8239930">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8239933">if</span>&nbsp;<span class="ident" id="8239936">g</span><span class="op" id="8239937">,</span>&nbsp;<span class="ident" id="8239939">e</span>&nbsp;<span class="op" id="8239941">:=</span>&nbsp;<span class="builtintype" id="8239944">string</span><span class="op" id="8239950">(</span><span class="ident" id="8239951">bodyBytes</span><span class="op" id="8239960">)</span><span class="op" id="8239961">,</span>&nbsp;<span class="ident" id="8239963">backendResponse</span><span class="op" id="8239978">;</span>&nbsp;<span class="ident" id="8239980">g</span>&nbsp;<span class="op" id="8239982">!=</span>&nbsp;<span class="ident" id="8239985">e</span>&nbsp;<span class="op" id="8239987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8239991">t</span><span class="op" id="8239992">.</span><span class="ident" id="8239993">Errorf</span><span class="op" id="8239999">(</span><span class="string" id="8240000">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8240026">,</span>&nbsp;<span class="ident" id="8240028">g</span><span class="op" id="8240029">,</span>&nbsp;<span class="ident" id="8240031">e</span><span class="op" id="8240032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8240035">}</span><br>
<span class="lineno"></span><span class="op" id="8240037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="8240040">func</span>&nbsp;<span class="ident" id="8240045">TestXForwardedFor</span><span class="op" id="8240062">(</span><span class="ident" id="8240063">t</span>&nbsp;<span class="op" id="8240065">*</span><span class="ident" id="8240066">testing</span><span class="op" id="8240073">.</span><span class="ident" id="8240074">T</span><span class="op" id="8240075">)</span>&nbsp;<span class="op" id="8240077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8240080">const</span>&nbsp;<span class="ident" id="8240086">prevForwardedFor</span>&nbsp;<span class="op" id="8240103">=</span>&nbsp;<span class="string" id="8240105">&#34;client&nbsp;ip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8240118">const</span>&nbsp;<span class="ident" id="8240124">backendResponse</span>&nbsp;<span class="op" id="8240140">=</span>&nbsp;<span class="string" id="8240142">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8240162">const</span>&nbsp;<span class="ident" id="8240168">backendStatus</span>&nbsp;<span class="op" id="8240182">=</span>&nbsp;<span class="num" id="8240184">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8240189">backend</span>&nbsp;<span class="op" id="8240197">:=</span>&nbsp;<span class="ident" id="8240200">httptest</span><span class="op" id="8240208">.</span><span class="ident" id="8240209">NewServer</span><span class="op" id="8240218">(</span><span class="ident" id="8240219">http</span><span class="op" id="8240223">.</span><span class="ident" id="8240224">HandlerFunc</span><span class="op" id="8240235">(</span><span class="keyword" id="8240236">func</span><span class="op" id="8240240">(</span><span class="ident" id="8240241">w</span>&nbsp;<span class="ident" id="8240243">http</span><span class="op" id="8240247">.</span><span class="ident" id="8240248">ResponseWriter</span><span class="op" id="8240262">,</span>&nbsp;<span class="ident" id="8240264">r</span>&nbsp;<span class="op" id="8240266">*</span><span class="ident" id="8240267">http</span><span class="op" id="8240271">.</span><span class="ident" id="8240272">Request</span><span class="op" id="8240279">)</span>&nbsp;<span class="op" id="8240281">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8240285">if</span>&nbsp;<span class="ident" id="8240288">r</span><span class="op" id="8240289">.</span><span class="ident" id="8240290">Header</span><span class="op" id="8240296">.</span><span class="ident" id="8240297">Get</span><span class="op" id="8240300">(</span><span class="string" id="8240301">&#34;X-Forwarded-For&#34;</span><span class="op" id="8240318">)</span>&nbsp;<span class="op" id="8240320">==</span>&nbsp;<span class="string" id="8240323">&#34;&#34;</span>&nbsp;<span class="op" id="8240326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8240331">t</span><span class="op" id="8240332">.</span><span class="ident" id="8240333">Errorf</span><span class="op" id="8240339">(</span><span class="string" id="8240340">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="8240375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8240379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8240383">if</span>&nbsp;<span class="op" id="8240386">!</span><span class="ident" id="8240387">strings</span><span class="op" id="8240394">.</span><span class="ident" id="8240395">Contains</span><span class="op" id="8240403">(</span><span class="ident" id="8240404">r</span><span class="op" id="8240405">.</span><span class="ident" id="8240406">Header</span><span class="op" id="8240412">.</span><span class="ident" id="8240413">Get</span><span class="op" id="8240416">(</span><span class="string" id="8240417">&#34;X-Forwarded-For&#34;</span><span class="op" id="8240434">)</span><span class="op" id="8240435">,</span>&nbsp;<span class="ident" id="8240437">prevForwardedFor</span><span class="op" id="8240453">)</span>&nbsp;<span class="op" id="8240455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8240460">t</span><span class="op" id="8240461">.</span><span class="ident" id="8240462">Errorf</span><span class="op" id="8240468">(</span><span class="string" id="8240469">&#34;X-Forwarded-For&nbsp;didn&#39;t&nbsp;contain&nbsp;prior&nbsp;data&#34;</span><span class="op" id="8240512">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8240516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8240520">w</span><span class="op" id="8240521">.</span><span class="ident" id="8240522">WriteHeader</span><span class="op" id="8240533">(</span><span class="ident" id="8240534">backendStatus</span><span class="op" id="8240547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8240551">w</span><span class="op" id="8240552">.</span><span class="ident" id="8240553">Write</span><span class="op" id="8240558">(</span><span class="op" id="8240559">[</span><span class="op" id="8240560">]</span><span class="builtintype" id="8240561">byte</span><span class="op" id="8240565">(</span><span class="ident" id="8240566">backendResponse</span><span class="op" id="8240581">)</span><span class="op" id="8240582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8240585">}</span><span class="op" id="8240586">)</span><span class="op" id="8240587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8240590">defer</span>&nbsp;<span class="ident" id="8240596">backend</span><span class="op" id="8240603">.</span><span class="ident" id="8240604">Close</span><span class="op" id="8240609">(</span><span class="op" id="8240610">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8240613">backendURL</span><span class="op" id="8240623">,</span>&nbsp;<span class="ident" id="8240625">err</span>&nbsp;<span class="op" id="8240629">:=</span>&nbsp;<span class="ident" id="8240632">url</span><span class="op" id="8240635">.</span><span class="ident" id="8240636">Parse</span><span class="op" id="8240641">(</span><span class="ident" id="8240642">backend</span><span class="op" id="8240649">.</span><span class="ident" id="8240650">URL</span><span class="op" id="8240653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8240656">if</span>&nbsp;<span class="ident" id="8240659">err</span>&nbsp;<span class="op" id="8240663">!=</span>&nbsp;<span class="ident" id="8240666">nil</span>&nbsp;<span class="op" id="8240670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8240674">t</span><span class="op" id="8240675">.</span><span class="ident" id="8240676">Fatal</span><span class="op" id="8240681">(</span><span class="ident" id="8240682">err</span><span class="op" id="8240685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8240688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8240691">proxyHandler</span>&nbsp;<span class="op" id="8240704">:=</span>&nbsp;<span class="ident" id="8240707">NewSingleHostReverseProxy</span><span class="op" id="8240732">(</span><span class="ident" id="8240733">backendURL</span><span class="op" id="8240743">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8240746">frontend</span>&nbsp;<span class="op" id="8240755">:=</span>&nbsp;<span class="ident" id="8240758">httptest</span><span class="op" id="8240766">.</span><span class="ident" id="8240767">NewServer</span><span class="op" id="8240776">(</span><span class="ident" id="8240777">proxyHandler</span><span class="op" id="8240789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8240792">defer</span>&nbsp;<span class="ident" id="8240798">frontend</span><span class="op" id="8240806">.</span><span class="ident" id="8240807">Close</span><span class="op" id="8240812">(</span><span class="op" id="8240813">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8240817">getReq</span><span class="op" id="8240823">,</span>&nbsp;<span class="ident" id="8240825">_</span>&nbsp;<span class="op" id="8240827">:=</span>&nbsp;<span class="ident" id="8240830">http</span><span class="op" id="8240834">.</span><span class="ident" id="8240835">NewRequest</span><span class="op" id="8240845">(</span><span class="string" id="8240846">&#34;GET&#34;</span><span class="op" id="8240851">,</span>&nbsp;<span class="ident" id="8240853">frontend</span><span class="op" id="8240861">.</span><span class="ident" id="8240862">URL</span><span class="op" id="8240865">,</span>&nbsp;<span class="ident" id="8240867">nil</span><span class="op" id="8240870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8240873">getReq</span><span class="op" id="8240879">.</span><span class="ident" id="8240880">Host</span>&nbsp;<span class="op" id="8240885">=</span>&nbsp;<span class="string" id="8240887">&#34;some-name&#34;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8240900">getReq</span><span class="op" id="8240906">.</span><span class="ident" id="8240907">Header</span><span class="op" id="8240913">.</span><span class="ident" id="8240914">Set</span><span class="op" id="8240917">(</span><span class="string" id="8240918">&#34;Connection&#34;</span><span class="op" id="8240930">,</span>&nbsp;<span class="string" id="8240932">&#34;close&#34;</span><span class="op" id="8240939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8240942">getReq</span><span class="op" id="8240948">.</span><span class="ident" id="8240949">Header</span><span class="op" id="8240955">.</span><span class="ident" id="8240956">Set</span><span class="op" id="8240959">(</span><span class="string" id="8240960">&#34;X-Forwarded-For&#34;</span><span class="op" id="8240977">,</span>&nbsp;<span class="ident" id="8240979">prevForwardedFor</span><span class="op" id="8240995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8240998">getReq</span><span class="op" id="8241004">.</span><span class="ident" id="8241005">Close</span>&nbsp;<span class="op" id="8241011">=</span>&nbsp;<span class="builtintype" id="8241013">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8241019">res</span><span class="op" id="8241022">,</span>&nbsp;<span class="ident" id="8241024">err</span>&nbsp;<span class="op" id="8241028">:=</span>&nbsp;<span class="ident" id="8241031">http</span><span class="op" id="8241035">.</span><span class="ident" id="8241036">DefaultClient</span><span class="op" id="8241049">.</span><span class="ident" id="8241050">Do</span><span class="op" id="8241052">(</span><span class="ident" id="8241053">getReq</span><span class="op" id="8241059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8241062">if</span>&nbsp;<span class="ident" id="8241065">err</span>&nbsp;<span class="op" id="8241069">!=</span>&nbsp;<span class="ident" id="8241072">nil</span>&nbsp;<span class="op" id="8241076">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8241080">t</span><span class="op" id="8241081">.</span><span class="ident" id="8241082">Fatalf</span><span class="op" id="8241088">(</span><span class="string" id="8241089">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="8241098">,</span>&nbsp;<span class="ident" id="8241100">err</span><span class="op" id="8241103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8241106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8241109">if</span>&nbsp;<span class="ident" id="8241112">g</span><span class="op" id="8241113">,</span>&nbsp;<span class="ident" id="8241115">e</span>&nbsp;<span class="op" id="8241117">:=</span>&nbsp;<span class="ident" id="8241120">res</span><span class="op" id="8241123">.</span><span class="ident" id="8241124">StatusCode</span><span class="op" id="8241134">,</span>&nbsp;<span class="ident" id="8241136">backendStatus</span><span class="op" id="8241149">;</span>&nbsp;<span class="ident" id="8241151">g</span>&nbsp;<span class="op" id="8241153">!=</span>&nbsp;<span class="ident" id="8241156">e</span>&nbsp;<span class="op" id="8241158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8241162">t</span><span class="op" id="8241163">.</span><span class="ident" id="8241164">Errorf</span><span class="op" id="8241170">(</span><span class="string" id="8241171">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="8241207">,</span>&nbsp;<span class="ident" id="8241209">g</span><span class="op" id="8241210">,</span>&nbsp;<span class="ident" id="8241212">e</span><span class="op" id="8241213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8241216">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8241219">bodyBytes</span><span class="op" id="8241228">,</span>&nbsp;<span class="ident" id="8241230">_</span>&nbsp;<span class="op" id="8241232">:=</span>&nbsp;<span class="ident" id="8241235">ioutil</span><span class="op" id="8241241">.</span><span class="ident" id="8241242">ReadAll</span><span class="op" id="8241249">(</span><span class="ident" id="8241250">res</span><span class="op" id="8241253">.</span><span class="ident" id="8241254">Body</span><span class="op" id="8241258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8241261">if</span>&nbsp;<span class="ident" id="8241264">g</span><span class="op" id="8241265">,</span>&nbsp;<span class="ident" id="8241267">e</span>&nbsp;<span class="op" id="8241269">:=</span>&nbsp;<span class="builtintype" id="8241272">string</span><span class="op" id="8241278">(</span><span class="ident" id="8241279">bodyBytes</span><span class="op" id="8241288">)</span><span class="op" id="8241289">,</span>&nbsp;<span class="ident" id="8241291">backendResponse</span><span class="op" id="8241306">;</span>&nbsp;<span class="ident" id="8241308">g</span>&nbsp;<span class="op" id="8241310">!=</span>&nbsp;<span class="ident" id="8241313">e</span>&nbsp;<span class="op" id="8241315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8241319">t</span><span class="op" id="8241320">.</span><span class="ident" id="8241321">Errorf</span><span class="op" id="8241327">(</span><span class="string" id="8241328">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8241354">,</span>&nbsp;<span class="ident" id="8241356">g</span><span class="op" id="8241357">,</span>&nbsp;<span class="ident" id="8241359">e</span><span class="op" id="8241360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8241363">}</span><br>
<span class="lineno"></span><span class="op" id="8241365">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="8241368">var</span>&nbsp;<span class="ident" id="8241372">proxyQueryTests</span>&nbsp;<span class="op" id="8241388">=</span>&nbsp;<span class="op" id="8241390">[</span><span class="op" id="8241391">]</span><span class="keyword" id="8241392">struct</span>&nbsp;<span class="op" id="8241399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8241402">baseSuffix</span>&nbsp;<span class="builtintype" id="8241413">string</span>&nbsp;<span class="comment" id="8241420">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;backend&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8241453">reqSuffix</span>&nbsp;&nbsp;<span class="builtintype" id="8241464">string</span>&nbsp;<span class="comment" id="8241471">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;frontend&#39;s&nbsp;request&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8241515">want</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8241526">string</span>&nbsp;<span class="comment" id="8241533">//&nbsp;what&nbsp;backend&nbsp;should&nbsp;see&nbsp;for&nbsp;final&nbsp;request&nbsp;URL&nbsp;(without&nbsp;?)</span><br>
<span class="lineno">140</span><span class="op" id="8241594">}</span><span class="op" id="8241595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8241598">{</span><span class="string" id="8241599">&#34;&#34;</span><span class="op" id="8241601">,</span>&nbsp;<span class="string" id="8241603">&#34;&#34;</span><span class="op" id="8241605">,</span>&nbsp;<span class="string" id="8241607">&#34;&#34;</span><span class="op" id="8241609">}</span><span class="op" id="8241610">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8241613">{</span><span class="string" id="8241614">&#34;?sta=tic&#34;</span><span class="op" id="8241624">,</span>&nbsp;<span class="string" id="8241626">&#34;?us=er&#34;</span><span class="op" id="8241634">,</span>&nbsp;<span class="string" id="8241636">&#34;sta=tic&amp;us=er&#34;</span><span class="op" id="8241651">}</span><span class="op" id="8241652">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8241655">{</span><span class="string" id="8241656">&#34;&#34;</span><span class="op" id="8241658">,</span>&nbsp;<span class="string" id="8241660">&#34;?us=er&#34;</span><span class="op" id="8241668">,</span>&nbsp;<span class="string" id="8241670">&#34;us=er&#34;</span><span class="op" id="8241677">}</span><span class="op" id="8241678">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8241681">{</span><span class="string" id="8241682">&#34;?sta=tic&#34;</span><span class="op" id="8241692">,</span>&nbsp;<span class="string" id="8241694">&#34;&#34;</span><span class="op" id="8241696">,</span>&nbsp;<span class="string" id="8241698">&#34;sta=tic&#34;</span><span class="op" id="8241707">}</span><span class="op" id="8241708">,</span><br>
<span class="lineno">145</span><span class="op" id="8241710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8241713">func</span>&nbsp;<span class="ident" id="8241718">TestReverseProxyQuery</span><span class="op" id="8241739">(</span><span class="ident" id="8241740">t</span>&nbsp;<span class="op" id="8241742">*</span><span class="ident" id="8241743">testing</span><span class="op" id="8241750">.</span><span class="ident" id="8241751">T</span><span class="op" id="8241752">)</span>&nbsp;<span class="op" id="8241754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8241757">backend</span>&nbsp;<span class="op" id="8241765">:=</span>&nbsp;<span class="ident" id="8241768">httptest</span><span class="op" id="8241776">.</span><span class="ident" id="8241777">NewServer</span><span class="op" id="8241786">(</span><span class="ident" id="8241787">http</span><span class="op" id="8241791">.</span><span class="ident" id="8241792">HandlerFunc</span><span class="op" id="8241803">(</span><span class="keyword" id="8241804">func</span><span class="op" id="8241808">(</span><span class="ident" id="8241809">w</span>&nbsp;<span class="ident" id="8241811">http</span><span class="op" id="8241815">.</span><span class="ident" id="8241816">ResponseWriter</span><span class="op" id="8241830">,</span>&nbsp;<span class="ident" id="8241832">r</span>&nbsp;<span class="op" id="8241834">*</span><span class="ident" id="8241835">http</span><span class="op" id="8241839">.</span><span class="ident" id="8241840">Request</span><span class="op" id="8241847">)</span>&nbsp;<span class="op" id="8241849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8241853">w</span><span class="op" id="8241854">.</span><span class="ident" id="8241855">Header</span><span class="op" id="8241861">(</span><span class="op" id="8241862">)</span><span class="op" id="8241863">.</span><span class="ident" id="8241864">Set</span><span class="op" id="8241867">(</span><span class="string" id="8241868">&#34;X-Got-Query&#34;</span><span class="op" id="8241881">,</span>&nbsp;<span class="ident" id="8241883">r</span><span class="op" id="8241884">.</span><span class="ident" id="8241885">URL</span><span class="op" id="8241888">.</span><span class="ident" id="8241889">RawQuery</span><span class="op" id="8241897">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8241901">w</span><span class="op" id="8241902">.</span><span class="ident" id="8241903">Write</span><span class="op" id="8241908">(</span><span class="op" id="8241909">[</span><span class="op" id="8241910">]</span><span class="builtintype" id="8241911">byte</span><span class="op" id="8241915">(</span><span class="string" id="8241916">&#34;hi&#34;</span><span class="op" id="8241920">)</span><span class="op" id="8241921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8241924">}</span><span class="op" id="8241925">)</span><span class="op" id="8241926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8241929">defer</span>&nbsp;<span class="ident" id="8241935">backend</span><span class="op" id="8241942">.</span><span class="ident" id="8241943">Close</span><span class="op" id="8241948">(</span><span class="op" id="8241949">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8241953">for</span>&nbsp;<span class="ident" id="8241957">i</span><span class="op" id="8241958">,</span>&nbsp;<span class="ident" id="8241960">tt</span>&nbsp;<span class="op" id="8241963">:=</span>&nbsp;<span class="keyword" id="8241966">range</span>&nbsp;<span class="ident" id="8241972">proxyQueryTests</span>&nbsp;<span class="op" id="8241988">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8241992">backendURL</span><span class="op" id="8242002">,</span>&nbsp;<span class="ident" id="8242004">err</span>&nbsp;<span class="op" id="8242008">:=</span>&nbsp;<span class="ident" id="8242011">url</span><span class="op" id="8242014">.</span><span class="ident" id="8242015">Parse</span><span class="op" id="8242020">(</span><span class="ident" id="8242021">backend</span><span class="op" id="8242028">.</span><span class="ident" id="8242029">URL</span>&nbsp;<span class="op" id="8242033">+</span>&nbsp;<span class="ident" id="8242035">tt</span><span class="op" id="8242037">.</span><span class="ident" id="8242038">baseSuffix</span><span class="op" id="8242048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8242052">if</span>&nbsp;<span class="ident" id="8242055">err</span>&nbsp;<span class="op" id="8242059">!=</span>&nbsp;<span class="ident" id="8242062">nil</span>&nbsp;<span class="op" id="8242066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8242071">t</span><span class="op" id="8242072">.</span><span class="ident" id="8242073">Fatal</span><span class="op" id="8242078">(</span><span class="ident" id="8242079">err</span><span class="op" id="8242082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8242086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8242090">frontend</span>&nbsp;<span class="op" id="8242099">:=</span>&nbsp;<span class="ident" id="8242102">httptest</span><span class="op" id="8242110">.</span><span class="ident" id="8242111">NewServer</span><span class="op" id="8242120">(</span><span class="ident" id="8242121">NewSingleHostReverseProxy</span><span class="op" id="8242146">(</span><span class="ident" id="8242147">backendURL</span><span class="op" id="8242157">)</span><span class="op" id="8242158">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8242162">req</span><span class="op" id="8242165">,</span>&nbsp;<span class="ident" id="8242167">_</span>&nbsp;<span class="op" id="8242169">:=</span>&nbsp;<span class="ident" id="8242172">http</span><span class="op" id="8242176">.</span><span class="ident" id="8242177">NewRequest</span><span class="op" id="8242187">(</span><span class="string" id="8242188">&#34;GET&#34;</span><span class="op" id="8242193">,</span>&nbsp;<span class="ident" id="8242195">frontend</span><span class="op" id="8242203">.</span><span class="ident" id="8242204">URL</span><span class="op" id="8242207">+</span><span class="ident" id="8242208">tt</span><span class="op" id="8242210">.</span><span class="ident" id="8242211">reqSuffix</span><span class="op" id="8242220">,</span>&nbsp;<span class="ident" id="8242222">nil</span><span class="op" id="8242225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8242229">req</span><span class="op" id="8242232">.</span><span class="ident" id="8242233">Close</span>&nbsp;<span class="op" id="8242239">=</span>&nbsp;<span class="builtintype" id="8242241">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8242248">res</span><span class="op" id="8242251">,</span>&nbsp;<span class="ident" id="8242253">err</span>&nbsp;<span class="op" id="8242257">:=</span>&nbsp;<span class="ident" id="8242260">http</span><span class="op" id="8242264">.</span><span class="ident" id="8242265">DefaultClient</span><span class="op" id="8242278">.</span><span class="ident" id="8242279">Do</span><span class="op" id="8242281">(</span><span class="ident" id="8242282">req</span><span class="op" id="8242285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8242289">if</span>&nbsp;<span class="ident" id="8242292">err</span>&nbsp;<span class="op" id="8242296">!=</span>&nbsp;<span class="ident" id="8242299">nil</span>&nbsp;<span class="op" id="8242303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8242308">t</span><span class="op" id="8242309">.</span><span class="ident" id="8242310">Fatalf</span><span class="op" id="8242316">(</span><span class="string" id="8242317">&#34;%d.&nbsp;Get:&nbsp;%v&#34;</span><span class="op" id="8242330">,</span>&nbsp;<span class="ident" id="8242332">i</span><span class="op" id="8242333">,</span>&nbsp;<span class="ident" id="8242335">err</span><span class="op" id="8242338">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8242342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8242346">if</span>&nbsp;<span class="ident" id="8242349">g</span><span class="op" id="8242350">,</span>&nbsp;<span class="ident" id="8242352">e</span>&nbsp;<span class="op" id="8242354">:=</span>&nbsp;<span class="ident" id="8242357">res</span><span class="op" id="8242360">.</span><span class="ident" id="8242361">Header</span><span class="op" id="8242367">.</span><span class="ident" id="8242368">Get</span><span class="op" id="8242371">(</span><span class="string" id="8242372">&#34;X-Got-Query&#34;</span><span class="op" id="8242385">)</span><span class="op" id="8242386">,</span>&nbsp;<span class="ident" id="8242388">tt</span><span class="op" id="8242390">.</span><span class="ident" id="8242391">want</span><span class="op" id="8242395">;</span>&nbsp;<span class="ident" id="8242397">g</span>&nbsp;<span class="op" id="8242399">!=</span>&nbsp;<span class="ident" id="8242402">e</span>&nbsp;<span class="op" id="8242404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8242409">t</span><span class="op" id="8242410">.</span><span class="ident" id="8242411">Errorf</span><span class="op" id="8242417">(</span><span class="string" id="8242418">&#34;%d.&nbsp;got&nbsp;query&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8242449">,</span>&nbsp;<span class="ident" id="8242451">i</span><span class="op" id="8242452">,</span>&nbsp;<span class="ident" id="8242454">g</span><span class="op" id="8242455">,</span>&nbsp;<span class="ident" id="8242457">e</span><span class="op" id="8242458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8242462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8242466">res</span><span class="op" id="8242469">.</span><span class="ident" id="8242470">Body</span><span class="op" id="8242474">.</span><span class="ident" id="8242475">Close</span><span class="op" id="8242480">(</span><span class="op" id="8242481">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8242485">frontend</span><span class="op" id="8242493">.</span><span class="ident" id="8242494">Close</span><span class="op" id="8242499">(</span><span class="op" id="8242500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8242503">}</span><br>
<span class="lineno"></span><span class="op" id="8242505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8242508">func</span>&nbsp;<span class="ident" id="8242513">TestReverseProxyFlushInterval</span><span class="op" id="8242542">(</span><span class="ident" id="8242543">t</span>&nbsp;<span class="op" id="8242545">*</span><span class="ident" id="8242546">testing</span><span class="op" id="8242553">.</span><span class="ident" id="8242554">T</span><span class="op" id="8242555">)</span>&nbsp;<span class="op" id="8242557">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8242560">const</span>&nbsp;<span class="ident" id="8242566">expected</span>&nbsp;<span class="op" id="8242575">=</span>&nbsp;<span class="string" id="8242577">&#34;hi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8242583">backend</span>&nbsp;<span class="op" id="8242591">:=</span>&nbsp;<span class="ident" id="8242594">httptest</span><span class="op" id="8242602">.</span><span class="ident" id="8242603">NewServer</span><span class="op" id="8242612">(</span><span class="ident" id="8242613">http</span><span class="op" id="8242617">.</span><span class="ident" id="8242618">HandlerFunc</span><span class="op" id="8242629">(</span><span class="keyword" id="8242630">func</span><span class="op" id="8242634">(</span><span class="ident" id="8242635">w</span>&nbsp;<span class="ident" id="8242637">http</span><span class="op" id="8242641">.</span><span class="ident" id="8242642">ResponseWriter</span><span class="op" id="8242656">,</span>&nbsp;<span class="ident" id="8242658">r</span>&nbsp;<span class="op" id="8242660">*</span><span class="ident" id="8242661">http</span><span class="op" id="8242665">.</span><span class="ident" id="8242666">Request</span><span class="op" id="8242673">)</span>&nbsp;<span class="op" id="8242675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8242679">w</span><span class="op" id="8242680">.</span><span class="ident" id="8242681">Write</span><span class="op" id="8242686">(</span><span class="op" id="8242687">[</span><span class="op" id="8242688">]</span><span class="builtintype" id="8242689">byte</span><span class="op" id="8242693">(</span><span class="ident" id="8242694">expected</span><span class="op" id="8242702">)</span><span class="op" id="8242703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8242706">}</span><span class="op" id="8242707">)</span><span class="op" id="8242708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8242711">defer</span>&nbsp;<span class="ident" id="8242717">backend</span><span class="op" id="8242724">.</span><span class="ident" id="8242725">Close</span><span class="op" id="8242730">(</span><span class="op" id="8242731">)</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8242735">backendURL</span><span class="op" id="8242745">,</span>&nbsp;<span class="ident" id="8242747">err</span>&nbsp;<span class="op" id="8242751">:=</span>&nbsp;<span class="ident" id="8242754">url</span><span class="op" id="8242757">.</span><span class="ident" id="8242758">Parse</span><span class="op" id="8242763">(</span><span class="ident" id="8242764">backend</span><span class="op" id="8242771">.</span><span class="ident" id="8242772">URL</span><span class="op" id="8242775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8242778">if</span>&nbsp;<span class="ident" id="8242781">err</span>&nbsp;<span class="op" id="8242785">!=</span>&nbsp;<span class="ident" id="8242788">nil</span>&nbsp;<span class="op" id="8242792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8242796">t</span><span class="op" id="8242797">.</span><span class="ident" id="8242798">Fatal</span><span class="op" id="8242803">(</span><span class="ident" id="8242804">err</span><span class="op" id="8242807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8242810">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8242814">proxyHandler</span>&nbsp;<span class="op" id="8242827">:=</span>&nbsp;<span class="ident" id="8242830">NewSingleHostReverseProxy</span><span class="op" id="8242855">(</span><span class="ident" id="8242856">backendURL</span><span class="op" id="8242866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8242869">proxyHandler</span><span class="op" id="8242881">.</span><span class="ident" id="8242882">FlushInterval</span>&nbsp;<span class="op" id="8242896">=</span>&nbsp;<span class="ident" id="8242898">time</span><span class="op" id="8242902">.</span><span class="ident" id="8242903">Microsecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8242917">done</span>&nbsp;<span class="op" id="8242922">:=</span>&nbsp;<span class="builtinfunc" id="8242925">make</span><span class="op" id="8242929">(</span><span class="keyword" id="8242930">chan</span>&nbsp;<span class="builtintype" id="8242935">bool</span><span class="op" id="8242939">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8242942">onExitFlushLoop</span>&nbsp;<span class="op" id="8242958">=</span>&nbsp;<span class="keyword" id="8242960">func</span><span class="op" id="8242964">(</span><span class="op" id="8242965">)</span>&nbsp;<span class="op" id="8242967">{</span>&nbsp;<span class="ident" id="8242969">done</span>&nbsp;<span class="op" id="8242974">&lt;-</span>&nbsp;<span class="builtintype" id="8242977">true</span>&nbsp;<span class="op" id="8242982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8242985">defer</span>&nbsp;<span class="keyword" id="8242991">func</span><span class="op" id="8242995">(</span><span class="op" id="8242996">)</span>&nbsp;<span class="op" id="8242998">{</span>&nbsp;<span class="ident" id="8243000">onExitFlushLoop</span>&nbsp;<span class="op" id="8243016">=</span>&nbsp;<span class="ident" id="8243018">nil</span>&nbsp;<span class="op" id="8243022">}</span><span class="op" id="8243023">(</span><span class="op" id="8243024">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8243028">frontend</span>&nbsp;<span class="op" id="8243037">:=</span>&nbsp;<span class="ident" id="8243040">httptest</span><span class="op" id="8243048">.</span><span class="ident" id="8243049">NewServer</span><span class="op" id="8243058">(</span><span class="ident" id="8243059">proxyHandler</span><span class="op" id="8243071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8243074">defer</span>&nbsp;<span class="ident" id="8243080">frontend</span><span class="op" id="8243088">.</span><span class="ident" id="8243089">Close</span><span class="op" id="8243094">(</span><span class="op" id="8243095">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8243099">req</span><span class="op" id="8243102">,</span>&nbsp;<span class="ident" id="8243104">_</span>&nbsp;<span class="op" id="8243106">:=</span>&nbsp;<span class="ident" id="8243109">http</span><span class="op" id="8243113">.</span><span class="ident" id="8243114">NewRequest</span><span class="op" id="8243124">(</span><span class="string" id="8243125">&#34;GET&#34;</span><span class="op" id="8243130">,</span>&nbsp;<span class="ident" id="8243132">frontend</span><span class="op" id="8243140">.</span><span class="ident" id="8243141">URL</span><span class="op" id="8243144">,</span>&nbsp;<span class="ident" id="8243146">nil</span><span class="op" id="8243149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8243152">req</span><span class="op" id="8243155">.</span><span class="ident" id="8243156">Close</span>&nbsp;<span class="op" id="8243162">=</span>&nbsp;<span class="builtintype" id="8243164">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8243170">res</span><span class="op" id="8243173">,</span>&nbsp;<span class="ident" id="8243175">err</span>&nbsp;<span class="op" id="8243179">:=</span>&nbsp;<span class="ident" id="8243182">http</span><span class="op" id="8243186">.</span><span class="ident" id="8243187">DefaultClient</span><span class="op" id="8243200">.</span><span class="ident" id="8243201">Do</span><span class="op" id="8243203">(</span><span class="ident" id="8243204">req</span><span class="op" id="8243207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8243210">if</span>&nbsp;<span class="ident" id="8243213">err</span>&nbsp;<span class="op" id="8243217">!=</span>&nbsp;<span class="ident" id="8243220">nil</span>&nbsp;<span class="op" id="8243224">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8243228">t</span><span class="op" id="8243229">.</span><span class="ident" id="8243230">Fatalf</span><span class="op" id="8243236">(</span><span class="string" id="8243237">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="8243246">,</span>&nbsp;<span class="ident" id="8243248">err</span><span class="op" id="8243251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8243254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8243257">defer</span>&nbsp;<span class="ident" id="8243263">res</span><span class="op" id="8243266">.</span><span class="ident" id="8243267">Body</span><span class="op" id="8243271">.</span><span class="ident" id="8243272">Close</span><span class="op" id="8243277">(</span><span class="op" id="8243278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8243281">if</span>&nbsp;<span class="ident" id="8243284">bodyBytes</span><span class="op" id="8243293">,</span>&nbsp;<span class="ident" id="8243295">_</span>&nbsp;<span class="op" id="8243297">:=</span>&nbsp;<span class="ident" id="8243300">ioutil</span><span class="op" id="8243306">.</span><span class="ident" id="8243307">ReadAll</span><span class="op" id="8243314">(</span><span class="ident" id="8243315">res</span><span class="op" id="8243318">.</span><span class="ident" id="8243319">Body</span><span class="op" id="8243323">)</span><span class="op" id="8243324">;</span>&nbsp;<span class="builtintype" id="8243326">string</span><span class="op" id="8243332">(</span><span class="ident" id="8243333">bodyBytes</span><span class="op" id="8243342">)</span>&nbsp;<span class="op" id="8243344">!=</span>&nbsp;<span class="ident" id="8243347">expected</span>&nbsp;<span class="op" id="8243356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8243360">t</span><span class="op" id="8243361">.</span><span class="ident" id="8243362">Errorf</span><span class="op" id="8243368">(</span><span class="string" id="8243369">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8243395">,</span>&nbsp;<span class="ident" id="8243397">bodyBytes</span><span class="op" id="8243406">,</span>&nbsp;<span class="ident" id="8243408">expected</span><span class="op" id="8243416">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8243419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8243423">select</span>&nbsp;<span class="op" id="8243430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8243433">case</span>&nbsp;<span class="op" id="8243438">&lt;-</span><span class="ident" id="8243440">done</span><span class="op" id="8243444">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8243448">//&nbsp;OK</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8243455">case</span>&nbsp;<span class="op" id="8243460">&lt;-</span><span class="ident" id="8243462">time</span><span class="op" id="8243466">.</span><span class="ident" id="8243467">After</span><span class="op" id="8243472">(</span><span class="num" id="8243473">5</span>&nbsp;<span class="op" id="8243475">*</span>&nbsp;<span class="ident" id="8243477">time</span><span class="op" id="8243481">.</span><span class="ident" id="8243482">Second</span><span class="op" id="8243488">)</span><span class="op" id="8243489">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8243493">t</span><span class="op" id="8243494">.</span><span class="ident" id="8243495">Error</span><span class="op" id="8243500">(</span><span class="string" id="8243501">&#34;maxLatencyWriter&nbsp;flushLoop()&nbsp;never&nbsp;exited&#34;</span><span class="op" id="8243544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8243547">}</span><br>
<span class="lineno"></span><span class="op" id="8243549">}</span>
</div>
</body>
</html>
