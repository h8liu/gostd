<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httptest</h2>
<ul>
<li><a href="/gostd/net/http/httptest/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder.go.html">recorder.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder_test.go.html">recorder_test.go</a></li>
<li><a href="/gostd/net/http/httptest/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/http/httptest/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5845772">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5845827">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5845881">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5845932">//&nbsp;Implementation&nbsp;of&nbsp;Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5845961">package</span>&nbsp;<span class="ident" id="5845969">httptest</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5845979">import</span>&nbsp;<span class="op" id="5845986">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5845989">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5846003">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5846011">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5846018">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5846025">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5846037">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5846043">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5846050">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5846053">//&nbsp;A&nbsp;Server&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;server&nbsp;listening&nbsp;on&nbsp;a&nbsp;system-chosen&nbsp;port&nbsp;on&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="5846124">//&nbsp;local&nbsp;loopback&nbsp;interface,&nbsp;for&nbsp;use&nbsp;in&nbsp;end-to-end&nbsp;HTTP&nbsp;tests.</span><br>
<span class="lineno"></span><span class="keyword" id="5846187">type</span>&nbsp;<span class="ident" id="5846192">Server</span>&nbsp;<span class="keyword" id="5846199">struct</span>&nbsp;<span class="op" id="5846206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5846209">URL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5846218">string</span>&nbsp;<span class="comment" id="5846225">//&nbsp;base&nbsp;URL&nbsp;of&nbsp;form&nbsp;http://ipaddr:port&nbsp;with&nbsp;no&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5846288">Listener</span>&nbsp;<span class="ident" id="5846297">net</span><span class="op" id="5846300">.</span><span class="ident" id="5846301">Listener</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5846312">//&nbsp;TLS&nbsp;is&nbsp;the&nbsp;optional&nbsp;TLS&nbsp;configuration,&nbsp;populated&nbsp;with&nbsp;a&nbsp;new&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5846383">//&nbsp;after&nbsp;TLS&nbsp;is&nbsp;started.&nbsp;If&nbsp;set&nbsp;on&nbsp;an&nbsp;unstarted&nbsp;server&nbsp;before&nbsp;StartTLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5846455">//&nbsp;is&nbsp;called,&nbsp;existing&nbsp;fields&nbsp;are&nbsp;copied&nbsp;into&nbsp;the&nbsp;new&nbsp;config.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5846518">TLS</span>&nbsp;<span class="op" id="5846522">*</span><span class="ident" id="5846523">tls</span><span class="op" id="5846526">.</span><span class="ident" id="5846527">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5846536">//&nbsp;Config&nbsp;may&nbsp;be&nbsp;changed&nbsp;after&nbsp;calling&nbsp;NewUnstartedServer&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5846599">//&nbsp;before&nbsp;Start&nbsp;or&nbsp;StartTLS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5846629">Config</span>&nbsp;<span class="op" id="5846636">*</span><span class="ident" id="5846637">http</span><span class="op" id="5846641">.</span><span class="ident" id="5846642">Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5846651">//&nbsp;wg&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;HTTP&nbsp;requests&nbsp;on&nbsp;this&nbsp;server.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5846721">//&nbsp;Close&nbsp;blocks&nbsp;until&nbsp;all&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5846771">wg</span>&nbsp;<span class="ident" id="5846774">sync</span><span class="op" id="5846778">.</span><span class="ident" id="5846779">WaitGroup</span><br>
<span class="lineno"></span><span class="op" id="5846789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5846792">//&nbsp;historyListener&nbsp;keeps&nbsp;track&nbsp;of&nbsp;all&nbsp;connections&nbsp;that&nbsp;it&#39;s&nbsp;ever</span><br>
<span class="lineno">40</span><span class="comment" id="5846857">//&nbsp;accepted.</span><br>
<span class="lineno"></span><span class="keyword" id="5846870">type</span>&nbsp;<span class="ident" id="5846875">historyListener</span>&nbsp;<span class="keyword" id="5846891">struct</span>&nbsp;<span class="op" id="5846898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5846901">net</span><span class="op" id="5846904">.</span><span class="ident" id="5846905">Listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5846915">sync</span><span class="op" id="5846919">.</span><span class="ident" id="5846920">Mutex</span>&nbsp;<span class="comment" id="5846926">//&nbsp;protects&nbsp;history</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5846947">history</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5846958">[</span><span class="op" id="5846959">]</span><span class="ident" id="5846960">net</span><span class="op" id="5846963">.</span><span class="ident" id="5846964">Conn</span><br>
<span class="lineno">45</span><span class="op" id="5846969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5846972">func</span>&nbsp;<span class="op" id="5846977">(</span><span class="ident" id="5846978">hs</span>&nbsp;<span class="op" id="5846981">*</span><span class="ident" id="5846982">historyListener</span><span class="op" id="5846997">)</span>&nbsp;<span class="ident" id="5846999">Accept</span><span class="op" id="5847005">(</span><span class="op" id="5847006">)</span>&nbsp;<span class="op" id="5847008">(</span><span class="ident" id="5847009">c</span>&nbsp;<span class="ident" id="5847011">net</span><span class="op" id="5847014">.</span><span class="ident" id="5847015">Conn</span><span class="op" id="5847019">,</span>&nbsp;<span class="ident" id="5847021">err</span>&nbsp;<span class="builtintype" id="5847025">error</span><span class="op" id="5847030">)</span>&nbsp;<span class="op" id="5847032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5847035">c</span><span class="op" id="5847036">,</span>&nbsp;<span class="ident" id="5847038">err</span>&nbsp;<span class="op" id="5847042">=</span>&nbsp;<span class="ident" id="5847044">hs</span><span class="op" id="5847046">.</span><span class="ident" id="5847047">Listener</span><span class="op" id="5847055">.</span><span class="ident" id="5847056">Accept</span><span class="op" id="5847062">(</span><span class="op" id="5847063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5847066">if</span>&nbsp;<span class="ident" id="5847069">err</span>&nbsp;<span class="op" id="5847073">==</span>&nbsp;<span class="ident" id="5847076">nil</span>&nbsp;<span class="op" id="5847080">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5847084">hs</span><span class="op" id="5847086">.</span><span class="ident" id="5847087">Lock</span><span class="op" id="5847091">(</span><span class="op" id="5847092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5847096">hs</span><span class="op" id="5847098">.</span><span class="ident" id="5847099">history</span>&nbsp;<span class="op" id="5847107">=</span>&nbsp;<span class="builtinfunc" id="5847109">append</span><span class="op" id="5847115">(</span><span class="ident" id="5847116">hs</span><span class="op" id="5847118">.</span><span class="ident" id="5847119">history</span><span class="op" id="5847126">,</span>&nbsp;<span class="ident" id="5847128">c</span><span class="op" id="5847129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5847133">hs</span><span class="op" id="5847135">.</span><span class="ident" id="5847136">Unlock</span><span class="op" id="5847142">(</span><span class="op" id="5847143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5847146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5847149">return</span><br>
<span class="lineno">55</span><span class="op" id="5847156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5847159">func</span>&nbsp;<span class="ident" id="5847164">newLocalListener</span><span class="op" id="5847180">(</span><span class="op" id="5847181">)</span>&nbsp;<span class="ident" id="5847183">net</span><span class="op" id="5847186">.</span><span class="ident" id="5847187">Listener</span>&nbsp;<span class="op" id="5847196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5847199">if</span>&nbsp;<span class="op" id="5847202">*</span><span class="ident" id="5847203">serve</span>&nbsp;<span class="op" id="5847209">!=</span>&nbsp;<span class="string" id="5847212">&#34;&#34;</span>&nbsp;<span class="op" id="5847215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5847219">l</span><span class="op" id="5847220">,</span>&nbsp;<span class="ident" id="5847222">err</span>&nbsp;<span class="op" id="5847226">:=</span>&nbsp;<span class="ident" id="5847229">net</span><span class="op" id="5847232">.</span><span class="ident" id="5847233">Listen</span><span class="op" id="5847239">(</span><span class="string" id="5847240">&#34;tcp&#34;</span><span class="op" id="5847245">,</span>&nbsp;<span class="op" id="5847247">*</span><span class="ident" id="5847248">serve</span><span class="op" id="5847253">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5847257">if</span>&nbsp;<span class="ident" id="5847260">err</span>&nbsp;<span class="op" id="5847264">!=</span>&nbsp;<span class="ident" id="5847267">nil</span>&nbsp;<span class="op" id="5847271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5847276">panic</span><span class="op" id="5847281">(</span><span class="ident" id="5847282">fmt</span><span class="op" id="5847285">.</span><span class="ident" id="5847286">Sprintf</span><span class="op" id="5847293">(</span><span class="string" id="5847294">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;%v:&nbsp;%v&#34;</span><span class="op" id="5847332">,</span>&nbsp;<span class="op" id="5847334">*</span><span class="ident" id="5847335">serve</span><span class="op" id="5847340">,</span>&nbsp;<span class="ident" id="5847342">err</span><span class="op" id="5847345">)</span><span class="op" id="5847346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5847350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5847354">return</span>&nbsp;<span class="ident" id="5847361">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5847364">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5847367">l</span><span class="op" id="5847368">,</span>&nbsp;<span class="ident" id="5847370">err</span>&nbsp;<span class="op" id="5847374">:=</span>&nbsp;<span class="ident" id="5847377">net</span><span class="op" id="5847380">.</span><span class="ident" id="5847381">Listen</span><span class="op" id="5847387">(</span><span class="string" id="5847388">&#34;tcp&#34;</span><span class="op" id="5847393">,</span>&nbsp;<span class="string" id="5847395">&#34;127.0.0.1:0&#34;</span><span class="op" id="5847408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5847411">if</span>&nbsp;<span class="ident" id="5847414">err</span>&nbsp;<span class="op" id="5847418">!=</span>&nbsp;<span class="ident" id="5847421">nil</span>&nbsp;<span class="op" id="5847425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5847429">if</span>&nbsp;<span class="ident" id="5847432">l</span><span class="op" id="5847433">,</span>&nbsp;<span class="ident" id="5847435">err</span>&nbsp;<span class="op" id="5847439">=</span>&nbsp;<span class="ident" id="5847441">net</span><span class="op" id="5847444">.</span><span class="ident" id="5847445">Listen</span><span class="op" id="5847451">(</span><span class="string" id="5847452">&#34;tcp6&#34;</span><span class="op" id="5847458">,</span>&nbsp;<span class="string" id="5847460">&#34;[::1]:0&#34;</span><span class="op" id="5847469">)</span><span class="op" id="5847470">;</span>&nbsp;<span class="ident" id="5847472">err</span>&nbsp;<span class="op" id="5847476">!=</span>&nbsp;<span class="ident" id="5847479">nil</span>&nbsp;<span class="op" id="5847483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5847488">panic</span><span class="op" id="5847493">(</span><span class="ident" id="5847494">fmt</span><span class="op" id="5847497">.</span><span class="ident" id="5847498">Sprintf</span><span class="op" id="5847505">(</span><span class="string" id="5847506">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;a&nbsp;port:&nbsp;%v&#34;</span><span class="op" id="5847548">,</span>&nbsp;<span class="ident" id="5847550">err</span><span class="op" id="5847553">)</span><span class="op" id="5847554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5847558">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5847561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5847564">return</span>&nbsp;<span class="ident" id="5847571">l</span><br>
<span class="lineno"></span><span class="op" id="5847573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5847576">//&nbsp;When&nbsp;debugging&nbsp;a&nbsp;particular&nbsp;http&nbsp;server-based&nbsp;test,</span><br>
<span class="lineno">75</span><span class="comment" id="5847631">//&nbsp;this&nbsp;flag&nbsp;lets&nbsp;you&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="5847657">//&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;test&nbsp;-run=BrokenTest&nbsp;-httptest.serve=127.0.0.1:8000</span><br>
<span class="lineno"></span><span class="comment" id="5847715">//&nbsp;to&nbsp;start&nbsp;the&nbsp;broken&nbsp;server&nbsp;so&nbsp;you&nbsp;can&nbsp;interact&nbsp;with&nbsp;it&nbsp;manually.</span><br>
<span class="lineno"></span><span class="keyword" id="5847783">var</span>&nbsp;<span class="ident" id="5847787">serve</span>&nbsp;<span class="op" id="5847793">=</span>&nbsp;<span class="ident" id="5847795">flag</span><span class="op" id="5847799">.</span><span class="ident" id="5847800">String</span><span class="op" id="5847806">(</span><span class="string" id="5847807">&#34;httptest.serve&#34;</span><span class="op" id="5847823">,</span>&nbsp;<span class="string" id="5847825">&#34;&#34;</span><span class="op" id="5847827">,</span>&nbsp;<span class="string" id="5847829">&#34;if&nbsp;non-empty,&nbsp;httptest.NewServer&nbsp;serves&nbsp;on&nbsp;this&nbsp;address&nbsp;and&nbsp;blocks&#34;</span><span class="op" id="5847897">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="5847900">//&nbsp;NewServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="5847946">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5848010">func</span>&nbsp;<span class="ident" id="5848015">NewServer</span><span class="op" id="5848024">(</span><span class="ident" id="5848025">handler</span>&nbsp;<span class="ident" id="5848033">http</span><span class="op" id="5848037">.</span><span class="ident" id="5848038">Handler</span><span class="op" id="5848045">)</span>&nbsp;<span class="op" id="5848047">*</span><span class="ident" id="5848048">Server</span>&nbsp;<span class="op" id="5848055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5848058">ts</span>&nbsp;<span class="op" id="5848061">:=</span>&nbsp;<span class="ident" id="5848064">NewUnstartedServer</span><span class="op" id="5848082">(</span><span class="ident" id="5848083">handler</span><span class="op" id="5848090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5848093">ts</span><span class="op" id="5848095">.</span><span class="ident" id="5848096">Start</span><span class="op" id="5848101">(</span><span class="op" id="5848102">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5848105">return</span>&nbsp;<span class="ident" id="5848112">ts</span><br>
<span class="lineno"></span><span class="op" id="5848115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5848118">//&nbsp;NewUnstartedServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;but&nbsp;doesn&#39;t&nbsp;start&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="5848183">//</span><br>
<span class="lineno">90</span><span class="comment" id="5848186">//&nbsp;After&nbsp;changing&nbsp;its&nbsp;configuration,&nbsp;the&nbsp;caller&nbsp;should&nbsp;call&nbsp;Start&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5848255">//&nbsp;StartTLS.</span><br>
<span class="lineno"></span><span class="comment" id="5848268">//</span><br>
<span class="lineno"></span><span class="comment" id="5848271">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5848335">func</span>&nbsp;<span class="ident" id="5848340">NewUnstartedServer</span><span class="op" id="5848358">(</span><span class="ident" id="5848359">handler</span>&nbsp;<span class="ident" id="5848367">http</span><span class="op" id="5848371">.</span><span class="ident" id="5848372">Handler</span><span class="op" id="5848379">)</span>&nbsp;<span class="op" id="5848381">*</span><span class="ident" id="5848382">Server</span>&nbsp;<span class="op" id="5848389">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5848392">return</span>&nbsp;<span class="op" id="5848399">&amp;</span><span class="ident" id="5848400">Server</span><span class="op" id="5848406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5848410">Listener</span><span class="op" id="5848418">:</span>&nbsp;<span class="ident" id="5848420">newLocalListener</span><span class="op" id="5848436">(</span><span class="op" id="5848437">)</span><span class="op" id="5848438">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5848442">Config</span><span class="op" id="5848448">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5848452">&amp;</span><span class="ident" id="5848453">http</span><span class="op" id="5848457">.</span><span class="ident" id="5848458">Server</span><span class="op" id="5848464">{</span><span class="ident" id="5848465">Handler</span><span class="op" id="5848472">:</span>&nbsp;<span class="ident" id="5848474">handler</span><span class="op" id="5848481">}</span><span class="op" id="5848482">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5848485">}</span><br>
<span class="lineno"></span><span class="op" id="5848487">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="5848490">//&nbsp;Start&nbsp;starts&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5848540">func</span>&nbsp;<span class="op" id="5848545">(</span><span class="ident" id="5848546">s</span>&nbsp;<span class="op" id="5848548">*</span><span class="ident" id="5848549">Server</span><span class="op" id="5848555">)</span>&nbsp;<span class="ident" id="5848557">Start</span><span class="op" id="5848562">(</span><span class="op" id="5848563">)</span>&nbsp;<span class="op" id="5848565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5848568">if</span>&nbsp;<span class="ident" id="5848571">s</span><span class="op" id="5848572">.</span><span class="ident" id="5848573">URL</span>&nbsp;<span class="op" id="5848577">!=</span>&nbsp;<span class="string" id="5848580">&#34;&#34;</span>&nbsp;<span class="op" id="5848583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5848587">panic</span><span class="op" id="5848592">(</span><span class="string" id="5848593">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="5848617">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5848620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5848623">s</span><span class="op" id="5848624">.</span><span class="ident" id="5848625">Listener</span>&nbsp;<span class="op" id="5848634">=</span>&nbsp;<span class="op" id="5848636">&amp;</span><span class="ident" id="5848637">historyListener</span><span class="op" id="5848652">{</span><span class="ident" id="5848653">Listener</span><span class="op" id="5848661">:</span>&nbsp;<span class="ident" id="5848663">s</span><span class="op" id="5848664">.</span><span class="ident" id="5848665">Listener</span><span class="op" id="5848673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5848676">s</span><span class="op" id="5848677">.</span><span class="ident" id="5848678">URL</span>&nbsp;<span class="op" id="5848682">=</span>&nbsp;<span class="string" id="5848684">&#34;http://&#34;</span>&nbsp;<span class="op" id="5848694">+</span>&nbsp;<span class="ident" id="5848696">s</span><span class="op" id="5848697">.</span><span class="ident" id="5848698">Listener</span><span class="op" id="5848706">.</span><span class="ident" id="5848707">Addr</span><span class="op" id="5848711">(</span><span class="op" id="5848712">)</span><span class="op" id="5848713">.</span><span class="ident" id="5848714">String</span><span class="op" id="5848720">(</span><span class="op" id="5848721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5848724">s</span><span class="op" id="5848725">.</span><span class="ident" id="5848726">wrapHandler</span><span class="op" id="5848737">(</span><span class="op" id="5848738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5848741">go</span>&nbsp;<span class="ident" id="5848744">s</span><span class="op" id="5848745">.</span><span class="ident" id="5848746">Config</span><span class="op" id="5848752">.</span><span class="ident" id="5848753">Serve</span><span class="op" id="5848758">(</span><span class="ident" id="5848759">s</span><span class="op" id="5848760">.</span><span class="ident" id="5848761">Listener</span><span class="op" id="5848769">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5848772">if</span>&nbsp;<span class="op" id="5848775">*</span><span class="ident" id="5848776">serve</span>&nbsp;<span class="op" id="5848782">!=</span>&nbsp;<span class="string" id="5848785">&#34;&#34;</span>&nbsp;<span class="op" id="5848788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5848792">fmt</span><span class="op" id="5848795">.</span><span class="ident" id="5848796">Fprintln</span><span class="op" id="5848804">(</span><span class="ident" id="5848805">os</span><span class="op" id="5848807">.</span><span class="ident" id="5848808">Stderr</span><span class="op" id="5848814">,</span>&nbsp;<span class="string" id="5848816">&#34;httptest:&nbsp;serving&nbsp;on&#34;</span><span class="op" id="5848838">,</span>&nbsp;<span class="ident" id="5848840">s</span><span class="op" id="5848841">.</span><span class="ident" id="5848842">URL</span><span class="op" id="5848845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5848849">select</span>&nbsp;<span class="op" id="5848856">{</span><span class="op" id="5848857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5848860">}</span><br>
<span class="lineno"></span><span class="op" id="5848862">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="5848865">//&nbsp;StartTLS&nbsp;starts&nbsp;TLS&nbsp;on&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5848925">func</span>&nbsp;<span class="op" id="5848930">(</span><span class="ident" id="5848931">s</span>&nbsp;<span class="op" id="5848933">*</span><span class="ident" id="5848934">Server</span><span class="op" id="5848940">)</span>&nbsp;<span class="ident" id="5848942">StartTLS</span><span class="op" id="5848950">(</span><span class="op" id="5848951">)</span>&nbsp;<span class="op" id="5848953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5848956">if</span>&nbsp;<span class="ident" id="5848959">s</span><span class="op" id="5848960">.</span><span class="ident" id="5848961">URL</span>&nbsp;<span class="op" id="5848965">!=</span>&nbsp;<span class="string" id="5848968">&#34;&#34;</span>&nbsp;<span class="op" id="5848971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5848975">panic</span><span class="op" id="5848980">(</span><span class="string" id="5848981">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="5849005">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5849008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5849011">cert</span><span class="op" id="5849015">,</span>&nbsp;<span class="ident" id="5849017">err</span>&nbsp;<span class="op" id="5849021">:=</span>&nbsp;<span class="ident" id="5849024">tls</span><span class="op" id="5849027">.</span><span class="ident" id="5849028">X509KeyPair</span><span class="op" id="5849039">(</span><span class="ident" id="5849040">localhostCert</span><span class="op" id="5849053">,</span>&nbsp;<span class="ident" id="5849055">localhostKey</span><span class="op" id="5849067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5849070">if</span>&nbsp;<span class="ident" id="5849073">err</span>&nbsp;<span class="op" id="5849077">!=</span>&nbsp;<span class="ident" id="5849080">nil</span>&nbsp;<span class="op" id="5849084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5849088">panic</span><span class="op" id="5849093">(</span><span class="ident" id="5849094">fmt</span><span class="op" id="5849097">.</span><span class="ident" id="5849098">Sprintf</span><span class="op" id="5849105">(</span><span class="string" id="5849106">&#34;httptest:&nbsp;NewTLSServer:&nbsp;%v&#34;</span><span class="op" id="5849134">,</span>&nbsp;<span class="ident" id="5849136">err</span><span class="op" id="5849139">)</span><span class="op" id="5849140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5849143">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5849147">existingConfig</span>&nbsp;<span class="op" id="5849162">:=</span>&nbsp;<span class="ident" id="5849165">s</span><span class="op" id="5849166">.</span><span class="ident" id="5849167">TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5849172">s</span><span class="op" id="5849173">.</span><span class="ident" id="5849174">TLS</span>&nbsp;<span class="op" id="5849178">=</span>&nbsp;<span class="builtinfunc" id="5849180">new</span><span class="op" id="5849183">(</span><span class="ident" id="5849184">tls</span><span class="op" id="5849187">.</span><span class="ident" id="5849188">Config</span><span class="op" id="5849194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5849197">if</span>&nbsp;<span class="ident" id="5849200">existingConfig</span>&nbsp;<span class="op" id="5849215">!=</span>&nbsp;<span class="ident" id="5849218">nil</span>&nbsp;<span class="op" id="5849222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5849226">*</span><span class="ident" id="5849227">s</span><span class="op" id="5849228">.</span><span class="ident" id="5849229">TLS</span>&nbsp;<span class="op" id="5849233">=</span>&nbsp;<span class="op" id="5849235">*</span><span class="ident" id="5849236">existingConfig</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5849252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5849255">if</span>&nbsp;<span class="ident" id="5849258">s</span><span class="op" id="5849259">.</span><span class="ident" id="5849260">TLS</span><span class="op" id="5849263">.</span><span class="ident" id="5849264">NextProtos</span>&nbsp;<span class="op" id="5849275">==</span>&nbsp;<span class="ident" id="5849278">nil</span>&nbsp;<span class="op" id="5849282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5849286">s</span><span class="op" id="5849287">.</span><span class="ident" id="5849288">TLS</span><span class="op" id="5849291">.</span><span class="ident" id="5849292">NextProtos</span>&nbsp;<span class="op" id="5849303">=</span>&nbsp;<span class="op" id="5849305">[</span><span class="op" id="5849306">]</span><span class="builtintype" id="5849307">string</span><span class="op" id="5849313">{</span><span class="string" id="5849314">&#34;http/1.1&#34;</span><span class="op" id="5849324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5849327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5849330">if</span>&nbsp;<span class="builtinfunc" id="5849333">len</span><span class="op" id="5849336">(</span><span class="ident" id="5849337">s</span><span class="op" id="5849338">.</span><span class="ident" id="5849339">TLS</span><span class="op" id="5849342">.</span><span class="ident" id="5849343">Certificates</span><span class="op" id="5849355">)</span>&nbsp;<span class="op" id="5849357">==</span>&nbsp;<span class="num" id="5849360">0</span>&nbsp;<span class="op" id="5849362">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5849366">s</span><span class="op" id="5849367">.</span><span class="ident" id="5849368">TLS</span><span class="op" id="5849371">.</span><span class="ident" id="5849372">Certificates</span>&nbsp;<span class="op" id="5849385">=</span>&nbsp;<span class="op" id="5849387">[</span><span class="op" id="5849388">]</span><span class="ident" id="5849389">tls</span><span class="op" id="5849392">.</span><span class="ident" id="5849393">Certificate</span><span class="op" id="5849404">{</span><span class="ident" id="5849405">cert</span><span class="op" id="5849409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5849412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5849415">tlsListener</span>&nbsp;<span class="op" id="5849427">:=</span>&nbsp;<span class="ident" id="5849430">tls</span><span class="op" id="5849433">.</span><span class="ident" id="5849434">NewListener</span><span class="op" id="5849445">(</span><span class="ident" id="5849446">s</span><span class="op" id="5849447">.</span><span class="ident" id="5849448">Listener</span><span class="op" id="5849456">,</span>&nbsp;<span class="ident" id="5849458">s</span><span class="op" id="5849459">.</span><span class="ident" id="5849460">TLS</span><span class="op" id="5849463">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5849467">s</span><span class="op" id="5849468">.</span><span class="ident" id="5849469">Listener</span>&nbsp;<span class="op" id="5849478">=</span>&nbsp;<span class="op" id="5849480">&amp;</span><span class="ident" id="5849481">historyListener</span><span class="op" id="5849496">{</span><span class="ident" id="5849497">Listener</span><span class="op" id="5849505">:</span>&nbsp;<span class="ident" id="5849507">tlsListener</span><span class="op" id="5849518">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5849521">s</span><span class="op" id="5849522">.</span><span class="ident" id="5849523">URL</span>&nbsp;<span class="op" id="5849527">=</span>&nbsp;<span class="string" id="5849529">&#34;https://&#34;</span>&nbsp;<span class="op" id="5849540">+</span>&nbsp;<span class="ident" id="5849542">s</span><span class="op" id="5849543">.</span><span class="ident" id="5849544">Listener</span><span class="op" id="5849552">.</span><span class="ident" id="5849553">Addr</span><span class="op" id="5849557">(</span><span class="op" id="5849558">)</span><span class="op" id="5849559">.</span><span class="ident" id="5849560">String</span><span class="op" id="5849566">(</span><span class="op" id="5849567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5849570">s</span><span class="op" id="5849571">.</span><span class="ident" id="5849572">wrapHandler</span><span class="op" id="5849583">(</span><span class="op" id="5849584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5849587">go</span>&nbsp;<span class="ident" id="5849590">s</span><span class="op" id="5849591">.</span><span class="ident" id="5849592">Config</span><span class="op" id="5849598">.</span><span class="ident" id="5849599">Serve</span><span class="op" id="5849604">(</span><span class="ident" id="5849605">s</span><span class="op" id="5849606">.</span><span class="ident" id="5849607">Listener</span><span class="op" id="5849615">)</span><br>
<span class="lineno"></span><span class="op" id="5849617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="5849620">func</span>&nbsp;<span class="op" id="5849625">(</span><span class="ident" id="5849626">s</span>&nbsp;<span class="op" id="5849628">*</span><span class="ident" id="5849629">Server</span><span class="op" id="5849635">)</span>&nbsp;<span class="ident" id="5849637">wrapHandler</span><span class="op" id="5849648">(</span><span class="op" id="5849649">)</span>&nbsp;<span class="op" id="5849651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5849654">h</span>&nbsp;<span class="op" id="5849656">:=</span>&nbsp;<span class="ident" id="5849659">s</span><span class="op" id="5849660">.</span><span class="ident" id="5849661">Config</span><span class="op" id="5849667">.</span><span class="ident" id="5849668">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5849677">if</span>&nbsp;<span class="ident" id="5849680">h</span>&nbsp;<span class="op" id="5849682">==</span>&nbsp;<span class="ident" id="5849685">nil</span>&nbsp;<span class="op" id="5849689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5849693">h</span>&nbsp;<span class="op" id="5849695">=</span>&nbsp;<span class="ident" id="5849697">http</span><span class="op" id="5849701">.</span><span class="ident" id="5849702">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5849719">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5849722">s</span><span class="op" id="5849723">.</span><span class="ident" id="5849724">Config</span><span class="op" id="5849730">.</span><span class="ident" id="5849731">Handler</span>&nbsp;<span class="op" id="5849739">=</span>&nbsp;<span class="op" id="5849741">&amp;</span><span class="ident" id="5849742">waitGroupHandler</span><span class="op" id="5849758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5849762">s</span><span class="op" id="5849763">:</span>&nbsp;<span class="ident" id="5849765">s</span><span class="op" id="5849766">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5849770">h</span><span class="op" id="5849771">:</span>&nbsp;<span class="ident" id="5849773">h</span><span class="op" id="5849774">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5849777">}</span><br>
<span class="lineno"></span><span class="op" id="5849779">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5849782">//&nbsp;NewTLSServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;using&nbsp;TLS.</span><br>
<span class="lineno"></span><span class="comment" id="5849841">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5849905">func</span>&nbsp;<span class="ident" id="5849910">NewTLSServer</span><span class="op" id="5849922">(</span><span class="ident" id="5849923">handler</span>&nbsp;<span class="ident" id="5849931">http</span><span class="op" id="5849935">.</span><span class="ident" id="5849936">Handler</span><span class="op" id="5849943">)</span>&nbsp;<span class="op" id="5849945">*</span><span class="ident" id="5849946">Server</span>&nbsp;<span class="op" id="5849953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5849956">ts</span>&nbsp;<span class="op" id="5849959">:=</span>&nbsp;<span class="ident" id="5849962">NewUnstartedServer</span><span class="op" id="5849980">(</span><span class="ident" id="5849981">handler</span><span class="op" id="5849988">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5849991">ts</span><span class="op" id="5849993">.</span><span class="ident" id="5849994">StartTLS</span><span class="op" id="5850002">(</span><span class="op" id="5850003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5850006">return</span>&nbsp;<span class="ident" id="5850013">ts</span><br>
<span class="lineno"></span><span class="op" id="5850016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5850019">//&nbsp;Close&nbsp;shuts&nbsp;down&nbsp;the&nbsp;server&nbsp;and&nbsp;blocks&nbsp;until&nbsp;all&nbsp;outstanding</span><br>
<span class="lineno">165</span><span class="comment" id="5850083">//&nbsp;requests&nbsp;on&nbsp;this&nbsp;server&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="5850126">func</span>&nbsp;<span class="op" id="5850131">(</span><span class="ident" id="5850132">s</span>&nbsp;<span class="op" id="5850134">*</span><span class="ident" id="5850135">Server</span><span class="op" id="5850141">)</span>&nbsp;<span class="ident" id="5850143">Close</span><span class="op" id="5850148">(</span><span class="op" id="5850149">)</span>&nbsp;<span class="op" id="5850151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5850154">s</span><span class="op" id="5850155">.</span><span class="ident" id="5850156">Listener</span><span class="op" id="5850164">.</span><span class="ident" id="5850165">Close</span><span class="op" id="5850170">(</span><span class="op" id="5850171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5850174">s</span><span class="op" id="5850175">.</span><span class="ident" id="5850176">wg</span><span class="op" id="5850178">.</span><span class="ident" id="5850179">Wait</span><span class="op" id="5850183">(</span><span class="op" id="5850184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5850187">s</span><span class="op" id="5850188">.</span><span class="ident" id="5850189">CloseClientConnections</span><span class="op" id="5850211">(</span><span class="op" id="5850212">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5850215">if</span>&nbsp;<span class="ident" id="5850218">t</span><span class="op" id="5850219">,</span>&nbsp;<span class="ident" id="5850221">ok</span>&nbsp;<span class="op" id="5850224">:=</span>&nbsp;<span class="ident" id="5850227">http</span><span class="op" id="5850231">.</span><span class="ident" id="5850232">DefaultTransport</span><span class="op" id="5850248">.</span><span class="op" id="5850249">(</span><span class="op" id="5850250">*</span><span class="ident" id="5850251">http</span><span class="op" id="5850255">.</span><span class="ident" id="5850256">Transport</span><span class="op" id="5850265">)</span><span class="op" id="5850266">;</span>&nbsp;<span class="ident" id="5850268">ok</span>&nbsp;<span class="op" id="5850271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5850275">t</span><span class="op" id="5850276">.</span><span class="ident" id="5850277">CloseIdleConnections</span><span class="op" id="5850297">(</span><span class="op" id="5850298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5850301">}</span><br>
<span class="lineno"></span><span class="op" id="5850303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="5850306">//&nbsp;CloseClientConnections&nbsp;closes&nbsp;any&nbsp;currently&nbsp;open&nbsp;HTTP&nbsp;connections</span><br>
<span class="lineno"></span><span class="comment" id="5850375">//&nbsp;to&nbsp;the&nbsp;test&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5850398">func</span>&nbsp;<span class="op" id="5850403">(</span><span class="ident" id="5850404">s</span>&nbsp;<span class="op" id="5850406">*</span><span class="ident" id="5850407">Server</span><span class="op" id="5850413">)</span>&nbsp;<span class="ident" id="5850415">CloseClientConnections</span><span class="op" id="5850437">(</span><span class="op" id="5850438">)</span>&nbsp;<span class="op" id="5850440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5850443">hl</span><span class="op" id="5850445">,</span>&nbsp;<span class="ident" id="5850447">ok</span>&nbsp;<span class="op" id="5850450">:=</span>&nbsp;<span class="ident" id="5850453">s</span><span class="op" id="5850454">.</span><span class="ident" id="5850455">Listener</span><span class="op" id="5850463">.</span><span class="op" id="5850464">(</span><span class="op" id="5850465">*</span><span class="ident" id="5850466">historyListener</span><span class="op" id="5850481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5850484">if</span>&nbsp;<span class="op" id="5850487">!</span><span class="ident" id="5850488">ok</span>&nbsp;<span class="op" id="5850491">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5850495">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5850503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5850506">hl</span><span class="op" id="5850508">.</span><span class="ident" id="5850509">Lock</span><span class="op" id="5850513">(</span><span class="op" id="5850514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5850517">for</span>&nbsp;<span class="ident" id="5850521">_</span><span class="op" id="5850522">,</span>&nbsp;<span class="ident" id="5850524">conn</span>&nbsp;<span class="op" id="5850529">:=</span>&nbsp;<span class="keyword" id="5850532">range</span>&nbsp;<span class="ident" id="5850538">hl</span><span class="op" id="5850540">.</span><span class="ident" id="5850541">history</span>&nbsp;<span class="op" id="5850549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5850553">conn</span><span class="op" id="5850557">.</span><span class="ident" id="5850558">Close</span><span class="op" id="5850563">(</span><span class="op" id="5850564">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5850567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5850570">hl</span><span class="op" id="5850572">.</span><span class="ident" id="5850573">Unlock</span><span class="op" id="5850579">(</span><span class="op" id="5850580">)</span><br>
<span class="lineno"></span><span class="op" id="5850582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5850585">//&nbsp;waitGroupHandler&nbsp;wraps&nbsp;a&nbsp;handler,&nbsp;incrementing&nbsp;and&nbsp;decrementing&nbsp;a</span><br>
<span class="lineno">190</span><span class="comment" id="5850654">//&nbsp;sync.WaitGroup&nbsp;on&nbsp;each&nbsp;request,&nbsp;to&nbsp;enable&nbsp;Server.Close&nbsp;to&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="5850721">//&nbsp;until&nbsp;outstanding&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="5850765">type</span>&nbsp;<span class="ident" id="5850770">waitGroupHandler</span>&nbsp;<span class="keyword" id="5850787">struct</span>&nbsp;<span class="op" id="5850794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5850797">s</span>&nbsp;<span class="op" id="5850799">*</span><span class="ident" id="5850800">Server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5850808">h</span>&nbsp;<span class="ident" id="5850810">http</span><span class="op" id="5850814">.</span><span class="ident" id="5850815">Handler</span>&nbsp;<span class="comment" id="5850823">//&nbsp;non-nil</span><br>
<span class="lineno">195</span><span class="op" id="5850834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5850837">func</span>&nbsp;<span class="op" id="5850842">(</span><span class="ident" id="5850843">h</span>&nbsp;<span class="op" id="5850845">*</span><span class="ident" id="5850846">waitGroupHandler</span><span class="op" id="5850862">)</span>&nbsp;<span class="ident" id="5850864">ServeHTTP</span><span class="op" id="5850873">(</span><span class="ident" id="5850874">w</span>&nbsp;<span class="ident" id="5850876">http</span><span class="op" id="5850880">.</span><span class="ident" id="5850881">ResponseWriter</span><span class="op" id="5850895">,</span>&nbsp;<span class="ident" id="5850897">r</span>&nbsp;<span class="op" id="5850899">*</span><span class="ident" id="5850900">http</span><span class="op" id="5850904">.</span><span class="ident" id="5850905">Request</span><span class="op" id="5850912">)</span>&nbsp;<span class="op" id="5850914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5850917">h</span><span class="op" id="5850918">.</span><span class="ident" id="5850919">s</span><span class="op" id="5850920">.</span><span class="ident" id="5850921">wg</span><span class="op" id="5850923">.</span><span class="ident" id="5850924">Add</span><span class="op" id="5850927">(</span><span class="num" id="5850928">1</span><span class="op" id="5850929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5850932">defer</span>&nbsp;<span class="ident" id="5850938">h</span><span class="op" id="5850939">.</span><span class="ident" id="5850940">s</span><span class="op" id="5850941">.</span><span class="ident" id="5850942">wg</span><span class="op" id="5850944">.</span><span class="ident" id="5850945">Done</span><span class="op" id="5850949">(</span><span class="op" id="5850950">)</span>&nbsp;<span class="comment" id="5850952">//&nbsp;a&nbsp;defer,&nbsp;in&nbsp;case&nbsp;ServeHTTP&nbsp;below&nbsp;panics</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5850996">h</span><span class="op" id="5850997">.</span><span class="ident" id="5850998">h</span><span class="op" id="5850999">.</span><span class="ident" id="5851000">ServeHTTP</span><span class="op" id="5851009">(</span><span class="ident" id="5851010">w</span><span class="op" id="5851011">,</span>&nbsp;<span class="ident" id="5851013">r</span><span class="op" id="5851014">)</span><br>
<span class="lineno"></span><span class="op" id="5851016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5851019">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno"></span><span class="comment" id="5851075">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno">205</span><span class="comment" id="5851148">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="5851167">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="5851201">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="5851337">var</span>&nbsp;<span class="ident" id="5851341">localhostCert</span>&nbsp;<span class="op" id="5851355">=</span>&nbsp;<span class="op" id="5851357">[</span><span class="op" id="5851358">]</span><span class="builtintype" id="5851359">byte</span><span class="op" id="5851363">(</span><span class="string" id="5851364">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno">210</span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno"></span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno">215</span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="5851935">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5851938">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno">220</span><span class="keyword" id="5851992">var</span>&nbsp;<span class="ident" id="5851996">localhostKey</span>&nbsp;<span class="op" id="5852009">=</span>&nbsp;<span class="op" id="5852011">[</span><span class="op" id="5852012">]</span><span class="builtintype" id="5852013">byte</span><span class="op" id="5852017">(</span><span class="string" id="5852018">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno"></span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno">225</span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="5852516">)</span>
</div>
</body>
</html>
