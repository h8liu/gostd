<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3855135">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3855190">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3855244">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3855295">//&nbsp;OFB&nbsp;(Output&nbsp;Feedback)&nbsp;Mode.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3855327">package</span>&nbsp;<span class="ident" id="3855335">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3855343">type</span>&nbsp;<span class="ident" id="3855348">ofb</span>&nbsp;<span class="keyword" id="3855352">struct</span>&nbsp;<span class="op" id="3855359">{</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855362">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3855370">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855377">cipher</span>&nbsp;&nbsp;<span class="op" id="3855385">[</span><span class="op" id="3855386">]</span><span class="builtintype" id="3855387">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855393">out</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3855401">[</span><span class="op" id="3855402">]</span><span class="builtintype" id="3855403">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855409">outUsed</span>&nbsp;<span class="builtintype" id="3855417">int</span><br>
<span class="lineno"></span><span class="op" id="3855421">}</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="3855424">//&nbsp;NewOFB&nbsp;returns&nbsp;a&nbsp;Stream&nbsp;that&nbsp;encrypts&nbsp;or&nbsp;decrypts&nbsp;using&nbsp;the&nbsp;block&nbsp;cipher&nbsp;b</span><br>
<span class="lineno"></span><span class="comment" id="3855502">//&nbsp;in&nbsp;output&nbsp;feedback&nbsp;mode.&nbsp;The&nbsp;initialization&nbsp;vector&nbsp;iv&#39;s&nbsp;length&nbsp;must&nbsp;be&nbsp;equal</span><br>
<span class="lineno"></span><span class="comment" id="3855582">//&nbsp;to&nbsp;b&#39;s&nbsp;block&nbsp;size.</span><br>
<span class="lineno"></span><span class="keyword" id="3855604">func</span>&nbsp;<span class="ident" id="3855609">NewOFB</span><span class="op" id="3855615">(</span><span class="ident" id="3855616">b</span>&nbsp;<span class="ident" id="3855618">Block</span><span class="op" id="3855623">,</span>&nbsp;<span class="ident" id="3855625">iv</span>&nbsp;<span class="op" id="3855628">[</span><span class="op" id="3855629">]</span><span class="builtintype" id="3855630">byte</span><span class="op" id="3855634">)</span>&nbsp;<span class="ident" id="3855636">Stream</span>&nbsp;<span class="op" id="3855643">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855646">blockSize</span>&nbsp;<span class="op" id="3855656">:=</span>&nbsp;<span class="ident" id="3855659">b</span><span class="op" id="3855660">.</span><span class="ident" id="3855661">BlockSize</span><span class="op" id="3855670">(</span><span class="op" id="3855671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855674">if</span>&nbsp;<span class="builtinfunc" id="3855677">len</span><span class="op" id="3855680">(</span><span class="ident" id="3855681">iv</span><span class="op" id="3855683">)</span>&nbsp;<span class="op" id="3855685">!=</span>&nbsp;<span class="ident" id="3855688">blockSize</span>&nbsp;<span class="op" id="3855698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855702">return</span>&nbsp;<span class="ident" id="3855709">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3855714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855717">bufSize</span>&nbsp;<span class="op" id="3855725">:=</span>&nbsp;<span class="ident" id="3855728">streamBufferSize</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855746">if</span>&nbsp;<span class="ident" id="3855749">bufSize</span>&nbsp;<span class="op" id="3855757">&lt;</span>&nbsp;<span class="ident" id="3855759">blockSize</span>&nbsp;<span class="op" id="3855769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855773">bufSize</span>&nbsp;<span class="op" id="3855781">=</span>&nbsp;<span class="ident" id="3855783">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3855794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855797">x</span>&nbsp;<span class="op" id="3855799">:=</span>&nbsp;<span class="op" id="3855802">&amp;</span><span class="ident" id="3855803">ofb</span><span class="op" id="3855806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855810">b</span><span class="op" id="3855811">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3855819">b</span><span class="op" id="3855820">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855824">cipher</span><span class="op" id="3855830">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="3855833">make</span><span class="op" id="3855837">(</span><span class="op" id="3855838">[</span><span class="op" id="3855839">]</span><span class="builtintype" id="3855840">byte</span><span class="op" id="3855844">,</span>&nbsp;<span class="ident" id="3855846">blockSize</span><span class="op" id="3855855">)</span><span class="op" id="3855856">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855860">out</span><span class="op" id="3855863">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3855869">make</span><span class="op" id="3855873">(</span><span class="op" id="3855874">[</span><span class="op" id="3855875">]</span><span class="builtintype" id="3855876">byte</span><span class="op" id="3855880">,</span>&nbsp;<span class="num" id="3855882">0</span><span class="op" id="3855883">,</span>&nbsp;<span class="ident" id="3855885">bufSize</span><span class="op" id="3855892">)</span><span class="op" id="3855893">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855897">outUsed</span><span class="op" id="3855904">:</span>&nbsp;<span class="num" id="3855906">0</span><span class="op" id="3855907">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3855910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3855914">copy</span><span class="op" id="3855918">(</span><span class="ident" id="3855919">x</span><span class="op" id="3855920">.</span><span class="ident" id="3855921">cipher</span><span class="op" id="3855927">,</span>&nbsp;<span class="ident" id="3855929">iv</span><span class="op" id="3855931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855934">return</span>&nbsp;<span class="ident" id="3855941">x</span><br>
<span class="lineno"></span><span class="op" id="3855943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3855946">func</span>&nbsp;<span class="op" id="3855951">(</span><span class="ident" id="3855952">x</span>&nbsp;<span class="op" id="3855954">*</span><span class="ident" id="3855955">ofb</span><span class="op" id="3855958">)</span>&nbsp;<span class="ident" id="3855960">refill</span><span class="op" id="3855966">(</span><span class="op" id="3855967">)</span>&nbsp;<span class="op" id="3855969">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855972">bs</span>&nbsp;<span class="op" id="3855975">:=</span>&nbsp;<span class="ident" id="3855978">x</span><span class="op" id="3855979">.</span><span class="ident" id="3855980">b</span><span class="op" id="3855981">.</span><span class="ident" id="3855982">BlockSize</span><span class="op" id="3855991">(</span><span class="op" id="3855992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855995">remain</span>&nbsp;<span class="op" id="3856002">:=</span>&nbsp;<span class="builtinfunc" id="3856005">len</span><span class="op" id="3856008">(</span><span class="ident" id="3856009">x</span><span class="op" id="3856010">.</span><span class="ident" id="3856011">out</span><span class="op" id="3856014">)</span>&nbsp;<span class="op" id="3856016">-</span>&nbsp;<span class="ident" id="3856018">x</span><span class="op" id="3856019">.</span><span class="ident" id="3856020">outUsed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856029">if</span>&nbsp;<span class="ident" id="3856032">remain</span>&nbsp;<span class="op" id="3856039">&gt;</span>&nbsp;<span class="ident" id="3856041">x</span><span class="op" id="3856042">.</span><span class="ident" id="3856043">outUsed</span>&nbsp;<span class="op" id="3856051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856055">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3856063">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3856066">copy</span><span class="op" id="3856070">(</span><span class="ident" id="3856071">x</span><span class="op" id="3856072">.</span><span class="ident" id="3856073">out</span><span class="op" id="3856076">,</span>&nbsp;<span class="ident" id="3856078">x</span><span class="op" id="3856079">.</span><span class="ident" id="3856080">out</span><span class="op" id="3856083">[</span><span class="ident" id="3856084">x</span><span class="op" id="3856085">.</span><span class="ident" id="3856086">outUsed</span><span class="op" id="3856093">:</span><span class="op" id="3856094">]</span><span class="op" id="3856095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856098">x</span><span class="op" id="3856099">.</span><span class="ident" id="3856100">out</span>&nbsp;<span class="op" id="3856104">=</span>&nbsp;<span class="ident" id="3856106">x</span><span class="op" id="3856107">.</span><span class="ident" id="3856108">out</span><span class="op" id="3856111">[</span><span class="op" id="3856112">:</span><span class="builtinfunc" id="3856113">cap</span><span class="op" id="3856116">(</span><span class="ident" id="3856117">x</span><span class="op" id="3856118">.</span><span class="ident" id="3856119">out</span><span class="op" id="3856122">)</span><span class="op" id="3856123">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856126">for</span>&nbsp;<span class="ident" id="3856130">remain</span>&nbsp;<span class="op" id="3856137">&lt;</span>&nbsp;<span class="builtinfunc" id="3856139">len</span><span class="op" id="3856142">(</span><span class="ident" id="3856143">x</span><span class="op" id="3856144">.</span><span class="ident" id="3856145">out</span><span class="op" id="3856148">)</span><span class="op" id="3856149">-</span><span class="ident" id="3856150">bs</span>&nbsp;<span class="op" id="3856153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856157">x</span><span class="op" id="3856158">.</span><span class="ident" id="3856159">b</span><span class="op" id="3856160">.</span><span class="ident" id="3856161">Encrypt</span><span class="op" id="3856168">(</span><span class="ident" id="3856169">x</span><span class="op" id="3856170">.</span><span class="ident" id="3856171">cipher</span><span class="op" id="3856177">,</span>&nbsp;<span class="ident" id="3856179">x</span><span class="op" id="3856180">.</span><span class="ident" id="3856181">cipher</span><span class="op" id="3856187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3856191">copy</span><span class="op" id="3856195">(</span><span class="ident" id="3856196">x</span><span class="op" id="3856197">.</span><span class="ident" id="3856198">out</span><span class="op" id="3856201">[</span><span class="ident" id="3856202">remain</span><span class="op" id="3856208">:</span><span class="op" id="3856209">]</span><span class="op" id="3856210">,</span>&nbsp;<span class="ident" id="3856212">x</span><span class="op" id="3856213">.</span><span class="ident" id="3856214">cipher</span><span class="op" id="3856220">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856224">remain</span>&nbsp;<span class="op" id="3856231">+=</span>&nbsp;<span class="ident" id="3856234">bs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3856238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856241">x</span><span class="op" id="3856242">.</span><span class="ident" id="3856243">out</span>&nbsp;<span class="op" id="3856247">=</span>&nbsp;<span class="ident" id="3856249">x</span><span class="op" id="3856250">.</span><span class="ident" id="3856251">out</span><span class="op" id="3856254">[</span><span class="op" id="3856255">:</span><span class="ident" id="3856256">remain</span><span class="op" id="3856262">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856265">x</span><span class="op" id="3856266">.</span><span class="ident" id="3856267">outUsed</span>&nbsp;<span class="op" id="3856275">=</span>&nbsp;<span class="num" id="3856277">0</span><br>
<span class="lineno"></span><span class="op" id="3856279">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="3856282">func</span>&nbsp;<span class="op" id="3856287">(</span><span class="ident" id="3856288">x</span>&nbsp;<span class="op" id="3856290">*</span><span class="ident" id="3856291">ofb</span><span class="op" id="3856294">)</span>&nbsp;<span class="ident" id="3856296">XORKeyStream</span><span class="op" id="3856308">(</span><span class="ident" id="3856309">dst</span><span class="op" id="3856312">,</span>&nbsp;<span class="ident" id="3856314">src</span>&nbsp;<span class="op" id="3856318">[</span><span class="op" id="3856319">]</span><span class="builtintype" id="3856320">byte</span><span class="op" id="3856324">)</span>&nbsp;<span class="op" id="3856326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856329">for</span>&nbsp;<span class="builtinfunc" id="3856333">len</span><span class="op" id="3856336">(</span><span class="ident" id="3856337">src</span><span class="op" id="3856340">)</span>&nbsp;<span class="op" id="3856342">&gt;</span>&nbsp;<span class="num" id="3856344">0</span>&nbsp;<span class="op" id="3856346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856350">if</span>&nbsp;<span class="ident" id="3856353">x</span><span class="op" id="3856354">.</span><span class="ident" id="3856355">outUsed</span>&nbsp;<span class="op" id="3856363">&gt;=</span>&nbsp;<span class="builtinfunc" id="3856366">len</span><span class="op" id="3856369">(</span><span class="ident" id="3856370">x</span><span class="op" id="3856371">.</span><span class="ident" id="3856372">out</span><span class="op" id="3856375">)</span><span class="op" id="3856376">-</span><span class="ident" id="3856377">x</span><span class="op" id="3856378">.</span><span class="ident" id="3856379">b</span><span class="op" id="3856380">.</span><span class="ident" id="3856381">BlockSize</span><span class="op" id="3856390">(</span><span class="op" id="3856391">)</span>&nbsp;<span class="op" id="3856393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856398">x</span><span class="op" id="3856399">.</span><span class="ident" id="3856400">refill</span><span class="op" id="3856406">(</span><span class="op" id="3856407">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3856411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856415">n</span>&nbsp;<span class="op" id="3856417">:=</span>&nbsp;<span class="ident" id="3856420">xorBytes</span><span class="op" id="3856428">(</span><span class="ident" id="3856429">dst</span><span class="op" id="3856432">,</span>&nbsp;<span class="ident" id="3856434">src</span><span class="op" id="3856437">,</span>&nbsp;<span class="ident" id="3856439">x</span><span class="op" id="3856440">.</span><span class="ident" id="3856441">out</span><span class="op" id="3856444">[</span><span class="ident" id="3856445">x</span><span class="op" id="3856446">.</span><span class="ident" id="3856447">outUsed</span><span class="op" id="3856454">:</span><span class="op" id="3856455">]</span><span class="op" id="3856456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856460">dst</span>&nbsp;<span class="op" id="3856464">=</span>&nbsp;<span class="ident" id="3856466">dst</span><span class="op" id="3856469">[</span><span class="ident" id="3856470">n</span><span class="op" id="3856471">:</span><span class="op" id="3856472">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856476">src</span>&nbsp;<span class="op" id="3856480">=</span>&nbsp;<span class="ident" id="3856482">src</span><span class="op" id="3856485">[</span><span class="ident" id="3856486">n</span><span class="op" id="3856487">:</span><span class="op" id="3856488">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856492">x</span><span class="op" id="3856493">.</span><span class="ident" id="3856494">outUsed</span>&nbsp;<span class="op" id="3856502">+=</span>&nbsp;<span class="ident" id="3856505">n</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3856508">}</span><br>
<span class="lineno"></span><span class="op" id="3856510">}</span>
</div>
</body>
</html>
