<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>log/syslog</h2>
<ul>
<li><a href="/gostd/log/syslog/syslog.go.html">syslog.go</a></li>
<li><a href="/gostd/log/syslog/syslog_test.go.html" class="current">syslog_test.go</a></li>
<li><a href="/gostd/log/syslog/syslog_unix.go.html">syslog_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7211703">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7211758">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7211812">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7211863">//&nbsp;+build&nbsp;!windows,!nacl,!plan9</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7211896">package</span>&nbsp;<span class="ident" id="7211904">syslog</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7211912">import</span>&nbsp;<span class="op" id="7211919">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7211922">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7211931">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7211938">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7211944">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7211957">&#34;log&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7211964">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7211971">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7211977">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7211985">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7211996">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="7212003">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7212006">func</span>&nbsp;<span class="ident" id="7212011">runPktSyslog</span><span class="op" id="7212023">(</span><span class="ident" id="7212024">c</span>&nbsp;<span class="ident" id="7212026">net</span><span class="op" id="7212029">.</span><span class="ident" id="7212030">PacketConn</span><span class="op" id="7212040">,</span>&nbsp;<span class="ident" id="7212042">done</span>&nbsp;<span class="keyword" id="7212047">chan</span><span class="op" id="7212051">&lt;-</span>&nbsp;<span class="builtintype" id="7212054">string</span><span class="op" id="7212060">)</span>&nbsp;<span class="op" id="7212062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212065">var</span>&nbsp;<span class="ident" id="7212069">buf</span>&nbsp;<span class="op" id="7212073">[</span><span class="num" id="7212074">4096</span><span class="op" id="7212078">]</span><span class="builtintype" id="7212079">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212085">var</span>&nbsp;<span class="ident" id="7212089">rcvd</span>&nbsp;<span class="builtintype" id="7212094">string</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212102">ct</span>&nbsp;<span class="op" id="7212105">:=</span>&nbsp;<span class="num" id="7212108">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212111">for</span>&nbsp;<span class="op" id="7212115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212119">var</span>&nbsp;<span class="ident" id="7212123">n</span>&nbsp;<span class="builtintype" id="7212125">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212131">var</span>&nbsp;<span class="ident" id="7212135">err</span>&nbsp;<span class="builtintype" id="7212139">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212148">c</span><span class="op" id="7212149">.</span><span class="ident" id="7212150">SetReadDeadline</span><span class="op" id="7212165">(</span><span class="ident" id="7212166">time</span><span class="op" id="7212170">.</span><span class="ident" id="7212171">Now</span><span class="op" id="7212174">(</span><span class="op" id="7212175">)</span><span class="op" id="7212176">.</span><span class="ident" id="7212177">Add</span><span class="op" id="7212180">(</span><span class="num" id="7212181">100</span>&nbsp;<span class="op" id="7212185">*</span>&nbsp;<span class="ident" id="7212187">time</span><span class="op" id="7212191">.</span><span class="ident" id="7212192">Millisecond</span><span class="op" id="7212203">)</span><span class="op" id="7212204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212208">n</span><span class="op" id="7212209">,</span>&nbsp;<span class="ident" id="7212211">_</span><span class="op" id="7212212">,</span>&nbsp;<span class="ident" id="7212214">err</span>&nbsp;<span class="op" id="7212218">=</span>&nbsp;<span class="ident" id="7212220">c</span><span class="op" id="7212221">.</span><span class="ident" id="7212222">ReadFrom</span><span class="op" id="7212230">(</span><span class="ident" id="7212231">buf</span><span class="op" id="7212234">[</span><span class="op" id="7212235">:</span><span class="op" id="7212236">]</span><span class="op" id="7212237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212241">rcvd</span>&nbsp;<span class="op" id="7212246">+=</span>&nbsp;<span class="builtintype" id="7212249">string</span><span class="op" id="7212255">(</span><span class="ident" id="7212256">buf</span><span class="op" id="7212259">[</span><span class="op" id="7212260">:</span><span class="ident" id="7212261">n</span><span class="op" id="7212262">]</span><span class="op" id="7212263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212267">if</span>&nbsp;<span class="ident" id="7212270">err</span>&nbsp;<span class="op" id="7212274">!=</span>&nbsp;<span class="ident" id="7212277">nil</span>&nbsp;<span class="op" id="7212281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212286">if</span>&nbsp;<span class="ident" id="7212289">oe</span><span class="op" id="7212291">,</span>&nbsp;<span class="ident" id="7212293">ok</span>&nbsp;<span class="op" id="7212296">:=</span>&nbsp;<span class="ident" id="7212299">err</span><span class="op" id="7212302">.</span><span class="op" id="7212303">(</span><span class="op" id="7212304">*</span><span class="ident" id="7212305">net</span><span class="op" id="7212308">.</span><span class="ident" id="7212309">OpError</span><span class="op" id="7212316">)</span><span class="op" id="7212317">;</span>&nbsp;<span class="ident" id="7212319">ok</span>&nbsp;<span class="op" id="7212322">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212328">if</span>&nbsp;<span class="ident" id="7212331">ct</span>&nbsp;<span class="op" id="7212334">&lt;</span>&nbsp;<span class="num" id="7212336">3</span>&nbsp;<span class="op" id="7212338">&amp;&amp;</span>&nbsp;<span class="ident" id="7212341">oe</span><span class="op" id="7212343">.</span><span class="ident" id="7212344">Temporary</span><span class="op" id="7212353">(</span><span class="op" id="7212354">)</span>&nbsp;<span class="op" id="7212356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212363">ct</span><span class="op" id="7212365">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212373">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7212386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7212391">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212396">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7212404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7212407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212410">c</span><span class="op" id="7212411">.</span><span class="ident" id="7212412">Close</span><span class="op" id="7212417">(</span><span class="op" id="7212418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212421">done</span>&nbsp;<span class="op" id="7212426">&lt;-</span>&nbsp;<span class="ident" id="7212429">rcvd</span><br>
<span class="lineno">45</span><span class="op" id="7212434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7212437">var</span>&nbsp;<span class="ident" id="7212441">crashy</span>&nbsp;<span class="op" id="7212448">=</span>&nbsp;<span class="builtintype" id="7212450">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7212457">func</span>&nbsp;<span class="ident" id="7212462">runStreamSyslog</span><span class="op" id="7212477">(</span><span class="ident" id="7212478">l</span>&nbsp;<span class="ident" id="7212480">net</span><span class="op" id="7212483">.</span><span class="ident" id="7212484">Listener</span><span class="op" id="7212492">,</span>&nbsp;<span class="ident" id="7212494">done</span>&nbsp;<span class="keyword" id="7212499">chan</span><span class="op" id="7212503">&lt;-</span>&nbsp;<span class="builtintype" id="7212506">string</span><span class="op" id="7212512">,</span>&nbsp;<span class="ident" id="7212514">wg</span>&nbsp;<span class="op" id="7212517">*</span><span class="ident" id="7212518">sync</span><span class="op" id="7212522">.</span><span class="ident" id="7212523">WaitGroup</span><span class="op" id="7212532">)</span>&nbsp;<span class="op" id="7212534">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212537">for</span>&nbsp;<span class="op" id="7212541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212545">var</span>&nbsp;<span class="ident" id="7212549">c</span>&nbsp;<span class="ident" id="7212551">net</span><span class="op" id="7212554">.</span><span class="ident" id="7212555">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212562">var</span>&nbsp;<span class="ident" id="7212566">err</span>&nbsp;<span class="builtintype" id="7212570">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212578">if</span>&nbsp;<span class="ident" id="7212581">c</span><span class="op" id="7212582">,</span>&nbsp;<span class="ident" id="7212584">err</span>&nbsp;<span class="op" id="7212588">=</span>&nbsp;<span class="ident" id="7212590">l</span><span class="op" id="7212591">.</span><span class="ident" id="7212592">Accept</span><span class="op" id="7212598">(</span><span class="op" id="7212599">)</span><span class="op" id="7212600">;</span>&nbsp;<span class="ident" id="7212602">err</span>&nbsp;<span class="op" id="7212606">!=</span>&nbsp;<span class="ident" id="7212609">nil</span>&nbsp;<span class="op" id="7212613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212618">return</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7212627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212631">wg</span><span class="op" id="7212633">.</span><span class="ident" id="7212634">Add</span><span class="op" id="7212637">(</span><span class="num" id="7212638">1</span><span class="op" id="7212639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212643">go</span>&nbsp;<span class="keyword" id="7212646">func</span><span class="op" id="7212650">(</span><span class="ident" id="7212651">c</span>&nbsp;<span class="ident" id="7212653">net</span><span class="op" id="7212656">.</span><span class="ident" id="7212657">Conn</span><span class="op" id="7212661">)</span>&nbsp;<span class="op" id="7212663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212668">defer</span>&nbsp;<span class="ident" id="7212674">wg</span><span class="op" id="7212676">.</span><span class="ident" id="7212677">Done</span><span class="op" id="7212681">(</span><span class="op" id="7212682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212687">c</span><span class="op" id="7212688">.</span><span class="ident" id="7212689">SetReadDeadline</span><span class="op" id="7212704">(</span><span class="ident" id="7212705">time</span><span class="op" id="7212709">.</span><span class="ident" id="7212710">Now</span><span class="op" id="7212713">(</span><span class="op" id="7212714">)</span><span class="op" id="7212715">.</span><span class="ident" id="7212716">Add</span><span class="op" id="7212719">(</span><span class="num" id="7212720">5</span>&nbsp;<span class="op" id="7212722">*</span>&nbsp;<span class="ident" id="7212724">time</span><span class="op" id="7212728">.</span><span class="ident" id="7212729">Second</span><span class="op" id="7212735">)</span><span class="op" id="7212736">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212741">b</span>&nbsp;<span class="op" id="7212743">:=</span>&nbsp;<span class="ident" id="7212746">bufio</span><span class="op" id="7212751">.</span><span class="ident" id="7212752">NewReader</span><span class="op" id="7212761">(</span><span class="ident" id="7212762">c</span><span class="op" id="7212763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212768">for</span>&nbsp;<span class="ident" id="7212772">ct</span>&nbsp;<span class="op" id="7212775">:=</span>&nbsp;<span class="num" id="7212778">1</span><span class="op" id="7212779">;</span>&nbsp;<span class="op" id="7212781">!</span><span class="ident" id="7212782">crashy</span>&nbsp;<span class="op" id="7212789">||</span>&nbsp;<span class="ident" id="7212792">ct</span><span class="op" id="7212794">&amp;</span><span class="num" id="7212795">7</span>&nbsp;<span class="op" id="7212797">!=</span>&nbsp;<span class="num" id="7212800">0</span><span class="op" id="7212801">;</span>&nbsp;<span class="ident" id="7212803">ct</span><span class="op" id="7212805">++</span>&nbsp;<span class="op" id="7212808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212814">s</span><span class="op" id="7212815">,</span>&nbsp;<span class="ident" id="7212817">err</span>&nbsp;<span class="op" id="7212821">:=</span>&nbsp;<span class="ident" id="7212824">b</span><span class="op" id="7212825">.</span><span class="ident" id="7212826">ReadString</span><span class="op" id="7212836">(</span><span class="string" id="7212837">&#39;\n&#39;</span><span class="op" id="7212841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212847">if</span>&nbsp;<span class="ident" id="7212850">err</span>&nbsp;<span class="op" id="7212854">!=</span>&nbsp;<span class="ident" id="7212857">nil</span>&nbsp;<span class="op" id="7212861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212868">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7212878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212884">done</span>&nbsp;<span class="op" id="7212889">&lt;-</span>&nbsp;<span class="ident" id="7212892">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7212897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212902">c</span><span class="op" id="7212903">.</span><span class="ident" id="7212904">Close</span><span class="op" id="7212909">(</span><span class="op" id="7212910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7212914">}</span><span class="op" id="7212915">(</span><span class="ident" id="7212916">c</span><span class="op" id="7212917">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7212920">}</span><br>
<span class="lineno"></span><span class="op" id="7212922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7212925">func</span>&nbsp;<span class="ident" id="7212930">startServer</span><span class="op" id="7212941">(</span><span class="ident" id="7212942">n</span><span class="op" id="7212943">,</span>&nbsp;<span class="ident" id="7212945">la</span>&nbsp;<span class="builtintype" id="7212948">string</span><span class="op" id="7212954">,</span>&nbsp;<span class="ident" id="7212956">done</span>&nbsp;<span class="keyword" id="7212961">chan</span><span class="op" id="7212965">&lt;-</span>&nbsp;<span class="builtintype" id="7212968">string</span><span class="op" id="7212974">)</span>&nbsp;<span class="op" id="7212976">(</span><span class="ident" id="7212977">addr</span>&nbsp;<span class="builtintype" id="7212982">string</span><span class="op" id="7212988">,</span>&nbsp;<span class="ident" id="7212990">sock</span>&nbsp;<span class="ident" id="7212995">io</span><span class="op" id="7212997">.</span><span class="ident" id="7212998">Closer</span><span class="op" id="7213004">,</span>&nbsp;<span class="ident" id="7213006">wg</span>&nbsp;<span class="op" id="7213009">*</span><span class="ident" id="7213010">sync</span><span class="op" id="7213014">.</span><span class="ident" id="7213015">WaitGroup</span><span class="op" id="7213024">)</span>&nbsp;<span class="op" id="7213026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213029">if</span>&nbsp;<span class="ident" id="7213032">n</span>&nbsp;<span class="op" id="7213034">==</span>&nbsp;<span class="string" id="7213037">&#34;udp&#34;</span>&nbsp;<span class="op" id="7213043">||</span>&nbsp;<span class="ident" id="7213046">n</span>&nbsp;<span class="op" id="7213048">==</span>&nbsp;<span class="string" id="7213051">&#34;tcp&#34;</span>&nbsp;<span class="op" id="7213057">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213061">la</span>&nbsp;<span class="op" id="7213064">=</span>&nbsp;<span class="string" id="7213066">&#34;127.0.0.1:0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7213081">}</span>&nbsp;<span class="keyword" id="7213083">else</span>&nbsp;<span class="op" id="7213088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7213092">//&nbsp;unix&nbsp;and&nbsp;unixgram:&nbsp;choose&nbsp;an&nbsp;address&nbsp;if&nbsp;none&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213148">if</span>&nbsp;<span class="ident" id="7213151">la</span>&nbsp;<span class="op" id="7213154">==</span>&nbsp;<span class="string" id="7213157">&#34;&#34;</span>&nbsp;<span class="op" id="7213160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7213165">//&nbsp;use&nbsp;ioutil.TempFile&nbsp;to&nbsp;get&nbsp;a&nbsp;name&nbsp;that&nbsp;is&nbsp;unique</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213220">f</span><span class="op" id="7213221">,</span>&nbsp;<span class="ident" id="7213223">err</span>&nbsp;<span class="op" id="7213227">:=</span>&nbsp;<span class="ident" id="7213230">ioutil</span><span class="op" id="7213236">.</span><span class="ident" id="7213237">TempFile</span><span class="op" id="7213245">(</span><span class="string" id="7213246">&#34;&#34;</span><span class="op" id="7213248">,</span>&nbsp;<span class="string" id="7213250">&#34;syslogtest&#34;</span><span class="op" id="7213262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213267">if</span>&nbsp;<span class="ident" id="7213270">err</span>&nbsp;<span class="op" id="7213274">!=</span>&nbsp;<span class="ident" id="7213277">nil</span>&nbsp;<span class="op" id="7213281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213287">log</span><span class="op" id="7213290">.</span><span class="ident" id="7213291">Fatal</span><span class="op" id="7213296">(</span><span class="string" id="7213297">&#34;TempFile:&nbsp;&#34;</span><span class="op" id="7213309">,</span>&nbsp;<span class="ident" id="7213311">err</span><span class="op" id="7213314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7213319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213324">f</span><span class="op" id="7213325">.</span><span class="ident" id="7213326">Close</span><span class="op" id="7213331">(</span><span class="op" id="7213332">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213337">la</span>&nbsp;<span class="op" id="7213340">=</span>&nbsp;<span class="ident" id="7213342">f</span><span class="op" id="7213343">.</span><span class="ident" id="7213344">Name</span><span class="op" id="7213348">(</span><span class="op" id="7213349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7213353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213357">os</span><span class="op" id="7213359">.</span><span class="ident" id="7213360">Remove</span><span class="op" id="7213366">(</span><span class="ident" id="7213367">la</span><span class="op" id="7213369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7213372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213376">wg</span>&nbsp;<span class="op" id="7213379">=</span>&nbsp;<span class="builtinfunc" id="7213381">new</span><span class="op" id="7213384">(</span><span class="ident" id="7213385">sync</span><span class="op" id="7213389">.</span><span class="ident" id="7213390">WaitGroup</span><span class="op" id="7213399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213402">if</span>&nbsp;<span class="ident" id="7213405">n</span>&nbsp;<span class="op" id="7213407">==</span>&nbsp;<span class="string" id="7213410">&#34;udp&#34;</span>&nbsp;<span class="op" id="7213416">||</span>&nbsp;<span class="ident" id="7213419">n</span>&nbsp;<span class="op" id="7213421">==</span>&nbsp;<span class="string" id="7213424">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="7213435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213439">l</span><span class="op" id="7213440">,</span>&nbsp;<span class="ident" id="7213442">e</span>&nbsp;<span class="op" id="7213444">:=</span>&nbsp;<span class="ident" id="7213447">net</span><span class="op" id="7213450">.</span><span class="ident" id="7213451">ListenPacket</span><span class="op" id="7213463">(</span><span class="ident" id="7213464">n</span><span class="op" id="7213465">,</span>&nbsp;<span class="ident" id="7213467">la</span><span class="op" id="7213469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213473">if</span>&nbsp;<span class="ident" id="7213476">e</span>&nbsp;<span class="op" id="7213478">!=</span>&nbsp;<span class="ident" id="7213481">nil</span>&nbsp;<span class="op" id="7213485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213490">log</span><span class="op" id="7213493">.</span><span class="ident" id="7213494">Fatalf</span><span class="op" id="7213500">(</span><span class="string" id="7213501">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7213525">,</span>&nbsp;<span class="ident" id="7213527">e</span><span class="op" id="7213528">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7213532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213536">addr</span>&nbsp;<span class="op" id="7213541">=</span>&nbsp;<span class="ident" id="7213543">l</span><span class="op" id="7213544">.</span><span class="ident" id="7213545">LocalAddr</span><span class="op" id="7213554">(</span><span class="op" id="7213555">)</span><span class="op" id="7213556">.</span><span class="ident" id="7213557">String</span><span class="op" id="7213563">(</span><span class="op" id="7213564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213568">sock</span>&nbsp;<span class="op" id="7213573">=</span>&nbsp;<span class="ident" id="7213575">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213579">wg</span><span class="op" id="7213581">.</span><span class="ident" id="7213582">Add</span><span class="op" id="7213585">(</span><span class="num" id="7213586">1</span><span class="op" id="7213587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213591">go</span>&nbsp;<span class="keyword" id="7213594">func</span><span class="op" id="7213598">(</span><span class="op" id="7213599">)</span>&nbsp;<span class="op" id="7213601">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213606">defer</span>&nbsp;<span class="ident" id="7213612">wg</span><span class="op" id="7213614">.</span><span class="ident" id="7213615">Done</span><span class="op" id="7213619">(</span><span class="op" id="7213620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213625">runPktSyslog</span><span class="op" id="7213637">(</span><span class="ident" id="7213638">l</span><span class="op" id="7213639">,</span>&nbsp;<span class="ident" id="7213641">done</span><span class="op" id="7213645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7213649">}</span><span class="op" id="7213650">(</span><span class="op" id="7213651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7213654">}</span>&nbsp;<span class="keyword" id="7213656">else</span>&nbsp;<span class="op" id="7213661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213665">l</span><span class="op" id="7213666">,</span>&nbsp;<span class="ident" id="7213668">e</span>&nbsp;<span class="op" id="7213670">:=</span>&nbsp;<span class="ident" id="7213673">net</span><span class="op" id="7213676">.</span><span class="ident" id="7213677">Listen</span><span class="op" id="7213683">(</span><span class="ident" id="7213684">n</span><span class="op" id="7213685">,</span>&nbsp;<span class="ident" id="7213687">la</span><span class="op" id="7213689">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213693">if</span>&nbsp;<span class="ident" id="7213696">e</span>&nbsp;<span class="op" id="7213698">!=</span>&nbsp;<span class="ident" id="7213701">nil</span>&nbsp;<span class="op" id="7213705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213710">log</span><span class="op" id="7213713">.</span><span class="ident" id="7213714">Fatalf</span><span class="op" id="7213720">(</span><span class="string" id="7213721">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7213745">,</span>&nbsp;<span class="ident" id="7213747">e</span><span class="op" id="7213748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7213752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213756">addr</span>&nbsp;<span class="op" id="7213761">=</span>&nbsp;<span class="ident" id="7213763">l</span><span class="op" id="7213764">.</span><span class="ident" id="7213765">Addr</span><span class="op" id="7213769">(</span><span class="op" id="7213770">)</span><span class="op" id="7213771">.</span><span class="ident" id="7213772">String</span><span class="op" id="7213778">(</span><span class="op" id="7213779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213783">sock</span>&nbsp;<span class="op" id="7213788">=</span>&nbsp;<span class="ident" id="7213790">l</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213794">wg</span><span class="op" id="7213796">.</span><span class="ident" id="7213797">Add</span><span class="op" id="7213800">(</span><span class="num" id="7213801">1</span><span class="op" id="7213802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213806">go</span>&nbsp;<span class="keyword" id="7213809">func</span><span class="op" id="7213813">(</span><span class="op" id="7213814">)</span>&nbsp;<span class="op" id="7213816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213821">defer</span>&nbsp;<span class="ident" id="7213827">wg</span><span class="op" id="7213829">.</span><span class="ident" id="7213830">Done</span><span class="op" id="7213834">(</span><span class="op" id="7213835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213840">runStreamSyslog</span><span class="op" id="7213855">(</span><span class="ident" id="7213856">l</span><span class="op" id="7213857">,</span>&nbsp;<span class="ident" id="7213859">done</span><span class="op" id="7213863">,</span>&nbsp;<span class="ident" id="7213865">wg</span><span class="op" id="7213867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7213871">}</span><span class="op" id="7213872">(</span><span class="op" id="7213873">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7213876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213879">return</span><br>
<span class="lineno"></span><span class="op" id="7213886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7213889">func</span>&nbsp;<span class="ident" id="7213894">TestWithSimulated</span><span class="op" id="7213911">(</span><span class="ident" id="7213912">t</span>&nbsp;<span class="op" id="7213914">*</span><span class="ident" id="7213915">testing</span><span class="op" id="7213922">.</span><span class="ident" id="7213923">T</span><span class="op" id="7213924">)</span>&nbsp;<span class="op" id="7213926">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213929">msg</span>&nbsp;<span class="op" id="7213933">:=</span>&nbsp;<span class="string" id="7213936">&#34;Test&nbsp;123&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213948">transport</span>&nbsp;<span class="op" id="7213958">:=</span>&nbsp;<span class="op" id="7213961">[</span><span class="op" id="7213962">]</span><span class="builtintype" id="7213963">string</span><span class="op" id="7213969">{</span><span class="string" id="7213970">&#34;unix&#34;</span><span class="op" id="7213976">,</span>&nbsp;<span class="string" id="7213978">&#34;unixgram&#34;</span><span class="op" id="7213988">,</span>&nbsp;<span class="string" id="7213990">&#34;udp&#34;</span><span class="op" id="7213995">,</span>&nbsp;<span class="string" id="7213997">&#34;tcp&#34;</span><span class="op" id="7214002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214006">for</span>&nbsp;<span class="ident" id="7214010">_</span><span class="op" id="7214011">,</span>&nbsp;<span class="ident" id="7214013">tr</span>&nbsp;<span class="op" id="7214016">:=</span>&nbsp;<span class="keyword" id="7214019">range</span>&nbsp;<span class="ident" id="7214025">transport</span>&nbsp;<span class="op" id="7214035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214039">done</span>&nbsp;<span class="op" id="7214044">:=</span>&nbsp;<span class="builtinfunc" id="7214047">make</span><span class="op" id="7214051">(</span><span class="keyword" id="7214052">chan</span>&nbsp;<span class="builtintype" id="7214057">string</span><span class="op" id="7214063">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214067">addr</span><span class="op" id="7214071">,</span>&nbsp;<span class="ident" id="7214073">sock</span><span class="op" id="7214077">,</span>&nbsp;<span class="ident" id="7214079">srvWG</span>&nbsp;<span class="op" id="7214085">:=</span>&nbsp;<span class="ident" id="7214088">startServer</span><span class="op" id="7214099">(</span><span class="ident" id="7214100">tr</span><span class="op" id="7214102">,</span>&nbsp;<span class="string" id="7214104">&#34;&#34;</span><span class="op" id="7214106">,</span>&nbsp;<span class="ident" id="7214108">done</span><span class="op" id="7214112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214116">defer</span>&nbsp;<span class="ident" id="7214122">srvWG</span><span class="op" id="7214127">.</span><span class="ident" id="7214128">Wait</span><span class="op" id="7214132">(</span><span class="op" id="7214133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214137">defer</span>&nbsp;<span class="ident" id="7214143">sock</span><span class="op" id="7214147">.</span><span class="ident" id="7214148">Close</span><span class="op" id="7214153">(</span><span class="op" id="7214154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214158">if</span>&nbsp;<span class="ident" id="7214161">tr</span>&nbsp;<span class="op" id="7214164">==</span>&nbsp;<span class="string" id="7214167">&#34;unix&#34;</span>&nbsp;<span class="op" id="7214174">||</span>&nbsp;<span class="ident" id="7214177">tr</span>&nbsp;<span class="op" id="7214180">==</span>&nbsp;<span class="string" id="7214183">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="7214194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214199">defer</span>&nbsp;<span class="ident" id="7214205">os</span><span class="op" id="7214207">.</span><span class="ident" id="7214208">Remove</span><span class="op" id="7214214">(</span><span class="ident" id="7214215">addr</span><span class="op" id="7214219">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7214223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214227">s</span><span class="op" id="7214228">,</span>&nbsp;<span class="ident" id="7214230">err</span>&nbsp;<span class="op" id="7214234">:=</span>&nbsp;<span class="ident" id="7214237">Dial</span><span class="op" id="7214241">(</span><span class="ident" id="7214242">tr</span><span class="op" id="7214244">,</span>&nbsp;<span class="ident" id="7214246">addr</span><span class="op" id="7214250">,</span>&nbsp;<span class="ident" id="7214252">LOG_INFO</span><span class="op" id="7214260">|</span><span class="ident" id="7214261">LOG_USER</span><span class="op" id="7214269">,</span>&nbsp;<span class="string" id="7214271">&#34;syslog_test&#34;</span><span class="op" id="7214284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214288">if</span>&nbsp;<span class="ident" id="7214291">err</span>&nbsp;<span class="op" id="7214295">!=</span>&nbsp;<span class="ident" id="7214298">nil</span>&nbsp;<span class="op" id="7214302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214307">t</span><span class="op" id="7214308">.</span><span class="ident" id="7214309">Fatalf</span><span class="op" id="7214315">(</span><span class="string" id="7214316">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7214335">,</span>&nbsp;<span class="ident" id="7214337">err</span><span class="op" id="7214340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7214344">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214348">err</span>&nbsp;<span class="op" id="7214352">=</span>&nbsp;<span class="ident" id="7214354">s</span><span class="op" id="7214355">.</span><span class="ident" id="7214356">Info</span><span class="op" id="7214360">(</span><span class="ident" id="7214361">msg</span><span class="op" id="7214364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214368">if</span>&nbsp;<span class="ident" id="7214371">err</span>&nbsp;<span class="op" id="7214375">!=</span>&nbsp;<span class="ident" id="7214378">nil</span>&nbsp;<span class="op" id="7214382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214387">t</span><span class="op" id="7214388">.</span><span class="ident" id="7214389">Fatalf</span><span class="op" id="7214395">(</span><span class="string" id="7214396">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7214412">,</span>&nbsp;<span class="ident" id="7214414">err</span><span class="op" id="7214417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7214421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214425">check</span><span class="op" id="7214430">(</span><span class="ident" id="7214431">t</span><span class="op" id="7214432">,</span>&nbsp;<span class="ident" id="7214434">msg</span><span class="op" id="7214437">,</span>&nbsp;<span class="op" id="7214439">&lt;-</span><span class="ident" id="7214441">done</span><span class="op" id="7214445">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214449">s</span><span class="op" id="7214450">.</span><span class="ident" id="7214451">Close</span><span class="op" id="7214456">(</span><span class="op" id="7214457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7214460">}</span><br>
<span class="lineno"></span><span class="op" id="7214462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7214465">func</span>&nbsp;<span class="ident" id="7214470">TestFlap</span><span class="op" id="7214478">(</span><span class="ident" id="7214479">t</span>&nbsp;<span class="op" id="7214481">*</span><span class="ident" id="7214482">testing</span><span class="op" id="7214489">.</span><span class="ident" id="7214490">T</span><span class="op" id="7214491">)</span>&nbsp;<span class="op" id="7214493">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214496">net</span>&nbsp;<span class="op" id="7214500">:=</span>&nbsp;<span class="string" id="7214503">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214511">done</span>&nbsp;<span class="op" id="7214516">:=</span>&nbsp;<span class="builtinfunc" id="7214519">make</span><span class="op" id="7214523">(</span><span class="keyword" id="7214524">chan</span>&nbsp;<span class="builtintype" id="7214529">string</span><span class="op" id="7214535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214538">addr</span><span class="op" id="7214542">,</span>&nbsp;<span class="ident" id="7214544">sock</span><span class="op" id="7214548">,</span>&nbsp;<span class="ident" id="7214550">srvWG</span>&nbsp;<span class="op" id="7214556">:=</span>&nbsp;<span class="ident" id="7214559">startServer</span><span class="op" id="7214570">(</span><span class="ident" id="7214571">net</span><span class="op" id="7214574">,</span>&nbsp;<span class="string" id="7214576">&#34;&#34;</span><span class="op" id="7214578">,</span>&nbsp;<span class="ident" id="7214580">done</span><span class="op" id="7214584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214587">defer</span>&nbsp;<span class="ident" id="7214593">srvWG</span><span class="op" id="7214598">.</span><span class="ident" id="7214599">Wait</span><span class="op" id="7214603">(</span><span class="op" id="7214604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214607">defer</span>&nbsp;<span class="ident" id="7214613">os</span><span class="op" id="7214615">.</span><span class="ident" id="7214616">Remove</span><span class="op" id="7214622">(</span><span class="ident" id="7214623">addr</span><span class="op" id="7214627">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214630">defer</span>&nbsp;<span class="ident" id="7214636">sock</span><span class="op" id="7214640">.</span><span class="ident" id="7214641">Close</span><span class="op" id="7214646">(</span><span class="op" id="7214647">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214651">s</span><span class="op" id="7214652">,</span>&nbsp;<span class="ident" id="7214654">err</span>&nbsp;<span class="op" id="7214658">:=</span>&nbsp;<span class="ident" id="7214661">Dial</span><span class="op" id="7214665">(</span><span class="ident" id="7214666">net</span><span class="op" id="7214669">,</span>&nbsp;<span class="ident" id="7214671">addr</span><span class="op" id="7214675">,</span>&nbsp;<span class="ident" id="7214677">LOG_INFO</span><span class="op" id="7214685">|</span><span class="ident" id="7214686">LOG_USER</span><span class="op" id="7214694">,</span>&nbsp;<span class="string" id="7214696">&#34;syslog_test&#34;</span><span class="op" id="7214709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214712">if</span>&nbsp;<span class="ident" id="7214715">err</span>&nbsp;<span class="op" id="7214719">!=</span>&nbsp;<span class="ident" id="7214722">nil</span>&nbsp;<span class="op" id="7214726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214730">t</span><span class="op" id="7214731">.</span><span class="ident" id="7214732">Fatalf</span><span class="op" id="7214738">(</span><span class="string" id="7214739">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7214758">,</span>&nbsp;<span class="ident" id="7214760">err</span><span class="op" id="7214763">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7214766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214769">msg</span>&nbsp;<span class="op" id="7214773">:=</span>&nbsp;<span class="string" id="7214776">&#34;Moo&nbsp;2&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214785">err</span>&nbsp;<span class="op" id="7214789">=</span>&nbsp;<span class="ident" id="7214791">s</span><span class="op" id="7214792">.</span><span class="ident" id="7214793">Info</span><span class="op" id="7214797">(</span><span class="ident" id="7214798">msg</span><span class="op" id="7214801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214804">if</span>&nbsp;<span class="ident" id="7214807">err</span>&nbsp;<span class="op" id="7214811">!=</span>&nbsp;<span class="ident" id="7214814">nil</span>&nbsp;<span class="op" id="7214818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214822">t</span><span class="op" id="7214823">.</span><span class="ident" id="7214824">Fatalf</span><span class="op" id="7214830">(</span><span class="string" id="7214831">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7214847">,</span>&nbsp;<span class="ident" id="7214849">err</span><span class="op" id="7214852">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7214855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214858">check</span><span class="op" id="7214863">(</span><span class="ident" id="7214864">t</span><span class="op" id="7214865">,</span>&nbsp;<span class="ident" id="7214867">msg</span><span class="op" id="7214870">,</span>&nbsp;<span class="op" id="7214872">&lt;-</span><span class="ident" id="7214874">done</span><span class="op" id="7214878">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7214882">//&nbsp;restart&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214905">_</span><span class="op" id="7214906">,</span>&nbsp;<span class="ident" id="7214908">sock2</span><span class="op" id="7214913">,</span>&nbsp;<span class="ident" id="7214915">srvWG2</span>&nbsp;<span class="op" id="7214922">:=</span>&nbsp;<span class="ident" id="7214925">startServer</span><span class="op" id="7214936">(</span><span class="ident" id="7214937">net</span><span class="op" id="7214940">,</span>&nbsp;<span class="ident" id="7214942">addr</span><span class="op" id="7214946">,</span>&nbsp;<span class="ident" id="7214948">done</span><span class="op" id="7214952">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214955">defer</span>&nbsp;<span class="ident" id="7214961">srvWG2</span><span class="op" id="7214967">.</span><span class="ident" id="7214968">Wait</span><span class="op" id="7214972">(</span><span class="op" id="7214973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214976">defer</span>&nbsp;<span class="ident" id="7214982">sock2</span><span class="op" id="7214987">.</span><span class="ident" id="7214988">Close</span><span class="op" id="7214993">(</span><span class="op" id="7214994">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7214998">//&nbsp;and&nbsp;try&nbsp;retransmitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215025">msg</span>&nbsp;<span class="op" id="7215029">=</span>&nbsp;<span class="string" id="7215031">&#34;Moo&nbsp;3&#34;</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215040">err</span>&nbsp;<span class="op" id="7215044">=</span>&nbsp;<span class="ident" id="7215046">s</span><span class="op" id="7215047">.</span><span class="ident" id="7215048">Info</span><span class="op" id="7215052">(</span><span class="ident" id="7215053">msg</span><span class="op" id="7215056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215059">if</span>&nbsp;<span class="ident" id="7215062">err</span>&nbsp;<span class="op" id="7215066">!=</span>&nbsp;<span class="ident" id="7215069">nil</span>&nbsp;<span class="op" id="7215073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215077">t</span><span class="op" id="7215078">.</span><span class="ident" id="7215079">Fatalf</span><span class="op" id="7215085">(</span><span class="string" id="7215086">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7215102">,</span>&nbsp;<span class="ident" id="7215104">err</span><span class="op" id="7215107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7215110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215113">check</span><span class="op" id="7215118">(</span><span class="ident" id="7215119">t</span><span class="op" id="7215120">,</span>&nbsp;<span class="ident" id="7215122">msg</span><span class="op" id="7215125">,</span>&nbsp;<span class="op" id="7215127">&lt;-</span><span class="ident" id="7215129">done</span><span class="op" id="7215133">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215137">s</span><span class="op" id="7215138">.</span><span class="ident" id="7215139">Close</span><span class="op" id="7215144">(</span><span class="op" id="7215145">)</span><br>
<span class="lineno"></span><span class="op" id="7215147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7215150">func</span>&nbsp;<span class="ident" id="7215155">TestNew</span><span class="op" id="7215162">(</span><span class="ident" id="7215163">t</span>&nbsp;<span class="op" id="7215165">*</span><span class="ident" id="7215166">testing</span><span class="op" id="7215173">.</span><span class="ident" id="7215174">T</span><span class="op" id="7215175">)</span>&nbsp;<span class="op" id="7215177">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215180">if</span>&nbsp;<span class="ident" id="7215183">LOG_LOCAL7</span>&nbsp;<span class="op" id="7215194">!=</span>&nbsp;<span class="num" id="7215197">23</span><span class="op" id="7215199">&lt;&lt;</span><span class="num" id="7215201">3</span>&nbsp;<span class="op" id="7215203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215207">t</span><span class="op" id="7215208">.</span><span class="ident" id="7215209">Fatalf</span><span class="op" id="7215215">(</span><span class="string" id="7215216">&#34;LOG_LOCAL7&nbsp;has&nbsp;wrong&nbsp;value&#34;</span><span class="op" id="7215244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7215247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215250">if</span>&nbsp;<span class="ident" id="7215253">testing</span><span class="op" id="7215260">.</span><span class="ident" id="7215261">Short</span><span class="op" id="7215266">(</span><span class="op" id="7215267">)</span>&nbsp;<span class="op" id="7215269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7215273">//&nbsp;Depends&nbsp;on&nbsp;syslog&nbsp;daemon&nbsp;running,&nbsp;and&nbsp;sometimes&nbsp;it&#39;s&nbsp;not.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215336">t</span><span class="op" id="7215337">.</span><span class="ident" id="7215338">Skip</span><span class="op" id="7215342">(</span><span class="string" id="7215343">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7215379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7215382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215386">s</span><span class="op" id="7215387">,</span>&nbsp;<span class="ident" id="7215389">err</span>&nbsp;<span class="op" id="7215393">:=</span>&nbsp;<span class="ident" id="7215396">New</span><span class="op" id="7215399">(</span><span class="ident" id="7215400">LOG_INFO</span><span class="op" id="7215408">|</span><span class="ident" id="7215409">LOG_USER</span><span class="op" id="7215417">,</span>&nbsp;<span class="string" id="7215419">&#34;the_tag&#34;</span><span class="op" id="7215428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215431">if</span>&nbsp;<span class="ident" id="7215434">err</span>&nbsp;<span class="op" id="7215438">!=</span>&nbsp;<span class="ident" id="7215441">nil</span>&nbsp;<span class="op" id="7215445">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215449">t</span><span class="op" id="7215450">.</span><span class="ident" id="7215451">Fatalf</span><span class="op" id="7215457">(</span><span class="string" id="7215458">&#34;New()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7215476">,</span>&nbsp;<span class="ident" id="7215478">err</span><span class="op" id="7215481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7215484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7215487">//&nbsp;Don&#39;t&nbsp;send&nbsp;any&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215516">s</span><span class="op" id="7215517">.</span><span class="ident" id="7215518">Close</span><span class="op" id="7215523">(</span><span class="op" id="7215524">)</span><br>
<span class="lineno"></span><span class="op" id="7215526">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="7215529">func</span>&nbsp;<span class="ident" id="7215534">TestNewLogger</span><span class="op" id="7215547">(</span><span class="ident" id="7215548">t</span>&nbsp;<span class="op" id="7215550">*</span><span class="ident" id="7215551">testing</span><span class="op" id="7215558">.</span><span class="ident" id="7215559">T</span><span class="op" id="7215560">)</span>&nbsp;<span class="op" id="7215562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215565">if</span>&nbsp;<span class="ident" id="7215568">testing</span><span class="op" id="7215575">.</span><span class="ident" id="7215576">Short</span><span class="op" id="7215581">(</span><span class="op" id="7215582">)</span>&nbsp;<span class="op" id="7215584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215588">t</span><span class="op" id="7215589">.</span><span class="ident" id="7215590">Skip</span><span class="op" id="7215594">(</span><span class="string" id="7215595">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7215631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7215634">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215637">f</span><span class="op" id="7215638">,</span>&nbsp;<span class="ident" id="7215640">err</span>&nbsp;<span class="op" id="7215644">:=</span>&nbsp;<span class="ident" id="7215647">NewLogger</span><span class="op" id="7215656">(</span><span class="ident" id="7215657">LOG_USER</span><span class="op" id="7215665">|</span><span class="ident" id="7215666">LOG_INFO</span><span class="op" id="7215674">,</span>&nbsp;<span class="num" id="7215676">0</span><span class="op" id="7215677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215680">if</span>&nbsp;<span class="ident" id="7215683">f</span>&nbsp;<span class="op" id="7215685">==</span>&nbsp;<span class="ident" id="7215688">nil</span>&nbsp;<span class="op" id="7215692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215696">t</span><span class="op" id="7215697">.</span><span class="ident" id="7215698">Error</span><span class="op" id="7215703">(</span><span class="ident" id="7215704">err</span><span class="op" id="7215707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7215710">}</span><br>
<span class="lineno"></span><span class="op" id="7215712">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="7215715">func</span>&nbsp;<span class="ident" id="7215720">TestDial</span><span class="op" id="7215728">(</span><span class="ident" id="7215729">t</span>&nbsp;<span class="op" id="7215731">*</span><span class="ident" id="7215732">testing</span><span class="op" id="7215739">.</span><span class="ident" id="7215740">T</span><span class="op" id="7215741">)</span>&nbsp;<span class="op" id="7215743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215746">if</span>&nbsp;<span class="ident" id="7215749">testing</span><span class="op" id="7215756">.</span><span class="ident" id="7215757">Short</span><span class="op" id="7215762">(</span><span class="op" id="7215763">)</span>&nbsp;<span class="op" id="7215765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215769">t</span><span class="op" id="7215770">.</span><span class="ident" id="7215771">Skip</span><span class="op" id="7215775">(</span><span class="string" id="7215776">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7215812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7215815">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215818">f</span><span class="op" id="7215819">,</span>&nbsp;<span class="ident" id="7215821">err</span>&nbsp;<span class="op" id="7215825">:=</span>&nbsp;<span class="ident" id="7215828">Dial</span><span class="op" id="7215832">(</span><span class="string" id="7215833">&#34;&#34;</span><span class="op" id="7215835">,</span>&nbsp;<span class="string" id="7215837">&#34;&#34;</span><span class="op" id="7215839">,</span>&nbsp;<span class="op" id="7215841">(</span><span class="ident" id="7215842">LOG_LOCAL7</span><span class="op" id="7215852">|</span><span class="ident" id="7215853">LOG_DEBUG</span><span class="op" id="7215862">)</span><span class="op" id="7215863">+</span><span class="num" id="7215864">1</span><span class="op" id="7215865">,</span>&nbsp;<span class="string" id="7215867">&#34;syslog_test&#34;</span><span class="op" id="7215880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215883">if</span>&nbsp;<span class="ident" id="7215886">f</span>&nbsp;<span class="op" id="7215888">!=</span>&nbsp;<span class="ident" id="7215891">nil</span>&nbsp;<span class="op" id="7215895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215899">t</span><span class="op" id="7215900">.</span><span class="ident" id="7215901">Fatalf</span><span class="op" id="7215907">(</span><span class="string" id="7215908">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="7215942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7215945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215948">f</span><span class="op" id="7215949">,</span>&nbsp;<span class="ident" id="7215951">err</span>&nbsp;<span class="op" id="7215955">=</span>&nbsp;<span class="ident" id="7215957">Dial</span><span class="op" id="7215961">(</span><span class="string" id="7215962">&#34;&#34;</span><span class="op" id="7215964">,</span>&nbsp;<span class="string" id="7215966">&#34;&#34;</span><span class="op" id="7215968">,</span>&nbsp;<span class="op" id="7215970">-</span><span class="num" id="7215971">1</span><span class="op" id="7215972">,</span>&nbsp;<span class="string" id="7215974">&#34;syslog_test&#34;</span><span class="op" id="7215987">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215990">if</span>&nbsp;<span class="ident" id="7215993">f</span>&nbsp;<span class="op" id="7215995">!=</span>&nbsp;<span class="ident" id="7215998">nil</span>&nbsp;<span class="op" id="7216002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216006">t</span><span class="op" id="7216007">.</span><span class="ident" id="7216008">Fatalf</span><span class="op" id="7216014">(</span><span class="string" id="7216015">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="7216049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7216052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216055">l</span><span class="op" id="7216056">,</span>&nbsp;<span class="ident" id="7216058">err</span>&nbsp;<span class="op" id="7216062">:=</span>&nbsp;<span class="ident" id="7216065">Dial</span><span class="op" id="7216069">(</span><span class="string" id="7216070">&#34;&#34;</span><span class="op" id="7216072">,</span>&nbsp;<span class="string" id="7216074">&#34;&#34;</span><span class="op" id="7216076">,</span>&nbsp;<span class="ident" id="7216078">LOG_USER</span><span class="op" id="7216086">|</span><span class="ident" id="7216087">LOG_ERR</span><span class="op" id="7216094">,</span>&nbsp;<span class="string" id="7216096">&#34;syslog_test&#34;</span><span class="op" id="7216109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216112">if</span>&nbsp;<span class="ident" id="7216115">err</span>&nbsp;<span class="op" id="7216119">!=</span>&nbsp;<span class="ident" id="7216122">nil</span>&nbsp;<span class="op" id="7216126">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216130">t</span><span class="op" id="7216131">.</span><span class="ident" id="7216132">Fatalf</span><span class="op" id="7216138">(</span><span class="string" id="7216139">&#34;Dial()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7216158">,</span>&nbsp;<span class="ident" id="7216160">err</span><span class="op" id="7216163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7216166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216169">l</span><span class="op" id="7216170">.</span><span class="ident" id="7216171">Close</span><span class="op" id="7216176">(</span><span class="op" id="7216177">)</span><br>
<span class="lineno"></span><span class="op" id="7216179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="7216182">func</span>&nbsp;<span class="ident" id="7216187">check</span><span class="op" id="7216192">(</span><span class="ident" id="7216193">t</span>&nbsp;<span class="op" id="7216195">*</span><span class="ident" id="7216196">testing</span><span class="op" id="7216203">.</span><span class="ident" id="7216204">T</span><span class="op" id="7216205">,</span>&nbsp;<span class="ident" id="7216207">in</span><span class="op" id="7216209">,</span>&nbsp;<span class="ident" id="7216211">out</span>&nbsp;<span class="builtintype" id="7216215">string</span><span class="op" id="7216221">)</span>&nbsp;<span class="op" id="7216223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216226">tmpl</span>&nbsp;<span class="op" id="7216231">:=</span>&nbsp;<span class="ident" id="7216234">fmt</span><span class="op" id="7216237">.</span><span class="ident" id="7216238">Sprintf</span><span class="op" id="7216245">(</span><span class="string" id="7216246">&#34;&lt;%d&gt;%%s&nbsp;%%s&nbsp;syslog_test[%%d]:&nbsp;%s\n&#34;</span><span class="op" id="7216282">,</span>&nbsp;<span class="ident" id="7216284">LOG_USER</span><span class="op" id="7216292">+</span><span class="ident" id="7216293">LOG_INFO</span><span class="op" id="7216301">,</span>&nbsp;<span class="ident" id="7216303">in</span><span class="op" id="7216305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216308">if</span>&nbsp;<span class="ident" id="7216311">hostname</span><span class="op" id="7216319">,</span>&nbsp;<span class="ident" id="7216321">err</span>&nbsp;<span class="op" id="7216325">:=</span>&nbsp;<span class="ident" id="7216328">os</span><span class="op" id="7216330">.</span><span class="ident" id="7216331">Hostname</span><span class="op" id="7216339">(</span><span class="op" id="7216340">)</span><span class="op" id="7216341">;</span>&nbsp;<span class="ident" id="7216343">err</span>&nbsp;<span class="op" id="7216347">!=</span>&nbsp;<span class="ident" id="7216350">nil</span>&nbsp;<span class="op" id="7216354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216358">t</span><span class="op" id="7216359">.</span><span class="ident" id="7216360">Error</span><span class="op" id="7216365">(</span><span class="string" id="7216366">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="7216393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7216396">}</span>&nbsp;<span class="keyword" id="7216398">else</span>&nbsp;<span class="op" id="7216403">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216407">var</span>&nbsp;<span class="ident" id="7216411">parsedHostname</span><span class="op" id="7216425">,</span>&nbsp;<span class="ident" id="7216427">timestamp</span>&nbsp;<span class="builtintype" id="7216437">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216446">var</span>&nbsp;<span class="ident" id="7216450">pid</span>&nbsp;<span class="builtintype" id="7216454">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216460">if</span>&nbsp;<span class="ident" id="7216463">n</span><span class="op" id="7216464">,</span>&nbsp;<span class="ident" id="7216466">err</span>&nbsp;<span class="op" id="7216470">:=</span>&nbsp;<span class="ident" id="7216473">fmt</span><span class="op" id="7216476">.</span><span class="ident" id="7216477">Sscanf</span><span class="op" id="7216483">(</span><span class="ident" id="7216484">out</span><span class="op" id="7216487">,</span>&nbsp;<span class="ident" id="7216489">tmpl</span><span class="op" id="7216493">,</span>&nbsp;<span class="op" id="7216495">&amp;</span><span class="ident" id="7216496">timestamp</span><span class="op" id="7216505">,</span>&nbsp;<span class="op" id="7216507">&amp;</span><span class="ident" id="7216508">parsedHostname</span><span class="op" id="7216522">,</span>&nbsp;<span class="op" id="7216524">&amp;</span><span class="ident" id="7216525">pid</span><span class="op" id="7216528">)</span><span class="op" id="7216529">;</span>&nbsp;<span class="ident" id="7216531">n</span>&nbsp;<span class="op" id="7216533">!=</span>&nbsp;<span class="num" id="7216536">3</span>&nbsp;<span class="op" id="7216538">||</span>&nbsp;<span class="ident" id="7216541">err</span>&nbsp;<span class="op" id="7216545">!=</span>&nbsp;<span class="ident" id="7216548">nil</span>&nbsp;<span class="op" id="7216552">||</span>&nbsp;<span class="ident" id="7216555">hostname</span>&nbsp;<span class="op" id="7216564">!=</span>&nbsp;<span class="ident" id="7216567">parsedHostname</span>&nbsp;<span class="op" id="7216582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216587">t</span><span class="op" id="7216588">.</span><span class="ident" id="7216589">Errorf</span><span class="op" id="7216595">(</span><span class="string" id="7216596">&#34;Got&nbsp;%q,&nbsp;does&nbsp;not&nbsp;match&nbsp;template&nbsp;%q&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="7216640">,</span>&nbsp;<span class="ident" id="7216642">out</span><span class="op" id="7216645">,</span>&nbsp;<span class="ident" id="7216647">tmpl</span><span class="op" id="7216651">,</span>&nbsp;<span class="ident" id="7216653">n</span><span class="op" id="7216654">,</span>&nbsp;<span class="ident" id="7216656">err</span><span class="op" id="7216659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7216663">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7216666">}</span><br>
<span class="lineno"></span><span class="op" id="7216668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7216671">func</span>&nbsp;<span class="ident" id="7216676">TestWrite</span><span class="op" id="7216685">(</span><span class="ident" id="7216686">t</span>&nbsp;<span class="op" id="7216688">*</span><span class="ident" id="7216689">testing</span><span class="op" id="7216696">.</span><span class="ident" id="7216697">T</span><span class="op" id="7216698">)</span>&nbsp;<span class="op" id="7216700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216703">tests</span>&nbsp;<span class="op" id="7216709">:=</span>&nbsp;<span class="op" id="7216712">[</span><span class="op" id="7216713">]</span><span class="keyword" id="7216714">struct</span>&nbsp;<span class="op" id="7216721">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216725">pri</span>&nbsp;<span class="ident" id="7216729">Priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216740">pre</span>&nbsp;<span class="builtintype" id="7216744">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216753">msg</span>&nbsp;<span class="builtintype" id="7216757">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216766">exp</span>&nbsp;<span class="builtintype" id="7216770">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7216778">}</span><span class="op" id="7216779">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7216783">{</span><span class="ident" id="7216784">LOG_USER</span>&nbsp;<span class="op" id="7216793">|</span>&nbsp;<span class="ident" id="7216795">LOG_ERR</span><span class="op" id="7216802">,</span>&nbsp;<span class="string" id="7216804">&#34;syslog_test&#34;</span><span class="op" id="7216817">,</span>&nbsp;<span class="string" id="7216819">&#34;&#34;</span><span class="op" id="7216821">,</span>&nbsp;<span class="string" id="7216823">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;\n&#34;</span><span class="op" id="7216850">}</span><span class="op" id="7216851">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7216855">{</span><span class="ident" id="7216856">LOG_USER</span>&nbsp;<span class="op" id="7216865">|</span>&nbsp;<span class="ident" id="7216867">LOG_ERR</span><span class="op" id="7216874">,</span>&nbsp;<span class="string" id="7216876">&#34;syslog_test&#34;</span><span class="op" id="7216889">,</span>&nbsp;<span class="string" id="7216891">&#34;write&nbsp;test&#34;</span><span class="op" id="7216903">,</span>&nbsp;<span class="string" id="7216905">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test\n&#34;</span><span class="op" id="7216942">}</span><span class="op" id="7216943">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7216947">//&nbsp;Write&nbsp;should&nbsp;not&nbsp;add&nbsp;\n&nbsp;if&nbsp;there&nbsp;already&nbsp;is&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7217000">{</span><span class="ident" id="7217001">LOG_USER</span>&nbsp;<span class="op" id="7217010">|</span>&nbsp;<span class="ident" id="7217012">LOG_ERR</span><span class="op" id="7217019">,</span>&nbsp;<span class="string" id="7217021">&#34;syslog_test&#34;</span><span class="op" id="7217034">,</span>&nbsp;<span class="string" id="7217036">&#34;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="7217052">,</span>&nbsp;<span class="string" id="7217054">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="7217093">}</span><span class="op" id="7217094">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7217097">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217101">if</span>&nbsp;<span class="ident" id="7217104">hostname</span><span class="op" id="7217112">,</span>&nbsp;<span class="ident" id="7217114">err</span>&nbsp;<span class="op" id="7217118">:=</span>&nbsp;<span class="ident" id="7217121">os</span><span class="op" id="7217123">.</span><span class="ident" id="7217124">Hostname</span><span class="op" id="7217132">(</span><span class="op" id="7217133">)</span><span class="op" id="7217134">;</span>&nbsp;<span class="ident" id="7217136">err</span>&nbsp;<span class="op" id="7217140">!=</span>&nbsp;<span class="ident" id="7217143">nil</span>&nbsp;<span class="op" id="7217147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217151">t</span><span class="op" id="7217152">.</span><span class="ident" id="7217153">Fatalf</span><span class="op" id="7217159">(</span><span class="string" id="7217160">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="7217187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7217190">}</span>&nbsp;<span class="keyword" id="7217192">else</span>&nbsp;<span class="op" id="7217197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217201">for</span>&nbsp;<span class="ident" id="7217205">_</span><span class="op" id="7217206">,</span>&nbsp;<span class="ident" id="7217208">test</span>&nbsp;<span class="op" id="7217213">:=</span>&nbsp;<span class="keyword" id="7217216">range</span>&nbsp;<span class="ident" id="7217222">tests</span>&nbsp;<span class="op" id="7217228">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217233">done</span>&nbsp;<span class="op" id="7217238">:=</span>&nbsp;<span class="builtinfunc" id="7217241">make</span><span class="op" id="7217245">(</span><span class="keyword" id="7217246">chan</span>&nbsp;<span class="builtintype" id="7217251">string</span><span class="op" id="7217257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217262">addr</span><span class="op" id="7217266">,</span>&nbsp;<span class="ident" id="7217268">sock</span><span class="op" id="7217272">,</span>&nbsp;<span class="ident" id="7217274">srvWG</span>&nbsp;<span class="op" id="7217280">:=</span>&nbsp;<span class="ident" id="7217283">startServer</span><span class="op" id="7217294">(</span><span class="string" id="7217295">&#34;udp&#34;</span><span class="op" id="7217300">,</span>&nbsp;<span class="string" id="7217302">&#34;&#34;</span><span class="op" id="7217304">,</span>&nbsp;<span class="ident" id="7217306">done</span><span class="op" id="7217310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217315">defer</span>&nbsp;<span class="ident" id="7217321">srvWG</span><span class="op" id="7217326">.</span><span class="ident" id="7217327">Wait</span><span class="op" id="7217331">(</span><span class="op" id="7217332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217337">defer</span>&nbsp;<span class="ident" id="7217343">sock</span><span class="op" id="7217347">.</span><span class="ident" id="7217348">Close</span><span class="op" id="7217353">(</span><span class="op" id="7217354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217359">l</span><span class="op" id="7217360">,</span>&nbsp;<span class="ident" id="7217362">err</span>&nbsp;<span class="op" id="7217366">:=</span>&nbsp;<span class="ident" id="7217369">Dial</span><span class="op" id="7217373">(</span><span class="string" id="7217374">&#34;udp&#34;</span><span class="op" id="7217379">,</span>&nbsp;<span class="ident" id="7217381">addr</span><span class="op" id="7217385">,</span>&nbsp;<span class="ident" id="7217387">test</span><span class="op" id="7217391">.</span><span class="ident" id="7217392">pri</span><span class="op" id="7217395">,</span>&nbsp;<span class="ident" id="7217397">test</span><span class="op" id="7217401">.</span><span class="ident" id="7217402">pre</span><span class="op" id="7217405">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217410">if</span>&nbsp;<span class="ident" id="7217413">err</span>&nbsp;<span class="op" id="7217417">!=</span>&nbsp;<span class="ident" id="7217420">nil</span>&nbsp;<span class="op" id="7217424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217430">t</span><span class="op" id="7217431">.</span><span class="ident" id="7217432">Fatalf</span><span class="op" id="7217438">(</span><span class="string" id="7217439">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7217465">,</span>&nbsp;<span class="ident" id="7217467">err</span><span class="op" id="7217470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7217475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217480">defer</span>&nbsp;<span class="ident" id="7217486">l</span><span class="op" id="7217487">.</span><span class="ident" id="7217488">Close</span><span class="op" id="7217493">(</span><span class="op" id="7217494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217499">_</span><span class="op" id="7217500">,</span>&nbsp;<span class="ident" id="7217502">err</span>&nbsp;<span class="op" id="7217506">=</span>&nbsp;<span class="ident" id="7217508">io</span><span class="op" id="7217510">.</span><span class="ident" id="7217511">WriteString</span><span class="op" id="7217522">(</span><span class="ident" id="7217523">l</span><span class="op" id="7217524">,</span>&nbsp;<span class="ident" id="7217526">test</span><span class="op" id="7217530">.</span><span class="ident" id="7217531">msg</span><span class="op" id="7217534">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217539">if</span>&nbsp;<span class="ident" id="7217542">err</span>&nbsp;<span class="op" id="7217546">!=</span>&nbsp;<span class="ident" id="7217549">nil</span>&nbsp;<span class="op" id="7217553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217559">t</span><span class="op" id="7217560">.</span><span class="ident" id="7217561">Fatalf</span><span class="op" id="7217567">(</span><span class="string" id="7217568">&#34;WriteString()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7217594">,</span>&nbsp;<span class="ident" id="7217596">err</span><span class="op" id="7217599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7217604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217609">rcvd</span>&nbsp;<span class="op" id="7217614">:=</span>&nbsp;<span class="op" id="7217617">&lt;-</span><span class="ident" id="7217619">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217627">test</span><span class="op" id="7217631">.</span><span class="ident" id="7217632">exp</span>&nbsp;<span class="op" id="7217636">=</span>&nbsp;<span class="ident" id="7217638">fmt</span><span class="op" id="7217641">.</span><span class="ident" id="7217642">Sprintf</span><span class="op" id="7217649">(</span><span class="string" id="7217650">&#34;&lt;%d&gt;&#34;</span><span class="op" id="7217656">,</span>&nbsp;<span class="ident" id="7217658">test</span><span class="op" id="7217662">.</span><span class="ident" id="7217663">pri</span><span class="op" id="7217666">)</span>&nbsp;<span class="op" id="7217668">+</span>&nbsp;<span class="ident" id="7217670">test</span><span class="op" id="7217674">.</span><span class="ident" id="7217675">exp</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217682">var</span>&nbsp;<span class="ident" id="7217686">parsedHostname</span><span class="op" id="7217700">,</span>&nbsp;<span class="ident" id="7217702">timestamp</span>&nbsp;<span class="builtintype" id="7217712">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217722">var</span>&nbsp;<span class="ident" id="7217726">pid</span>&nbsp;<span class="builtintype" id="7217730">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217737">if</span>&nbsp;<span class="ident" id="7217740">n</span><span class="op" id="7217741">,</span>&nbsp;<span class="ident" id="7217743">err</span>&nbsp;<span class="op" id="7217747">:=</span>&nbsp;<span class="ident" id="7217750">fmt</span><span class="op" id="7217753">.</span><span class="ident" id="7217754">Sscanf</span><span class="op" id="7217760">(</span><span class="ident" id="7217761">rcvd</span><span class="op" id="7217765">,</span>&nbsp;<span class="ident" id="7217767">test</span><span class="op" id="7217771">.</span><span class="ident" id="7217772">exp</span><span class="op" id="7217775">,</span>&nbsp;<span class="op" id="7217777">&amp;</span><span class="ident" id="7217778">timestamp</span><span class="op" id="7217787">,</span>&nbsp;<span class="op" id="7217789">&amp;</span><span class="ident" id="7217790">parsedHostname</span><span class="op" id="7217804">,</span>&nbsp;<span class="op" id="7217806">&amp;</span><span class="ident" id="7217807">pid</span><span class="op" id="7217810">)</span><span class="op" id="7217811">;</span>&nbsp;<span class="ident" id="7217813">n</span>&nbsp;<span class="op" id="7217815">!=</span>&nbsp;<span class="num" id="7217818">3</span>&nbsp;<span class="op" id="7217820">||</span>&nbsp;<span class="ident" id="7217823">err</span>&nbsp;<span class="op" id="7217827">!=</span>&nbsp;<span class="ident" id="7217830">nil</span>&nbsp;<span class="op" id="7217834">||</span>&nbsp;<span class="ident" id="7217837">hostname</span>&nbsp;<span class="op" id="7217846">!=</span>&nbsp;<span class="ident" id="7217849">parsedHostname</span>&nbsp;<span class="op" id="7217864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217870">t</span><span class="op" id="7217871">.</span><span class="ident" id="7217872">Errorf</span><span class="op" id="7217878">(</span><span class="string" id="7217879">&#34;s.Info()&nbsp;=&nbsp;&#39;%q&#39;,&nbsp;didn&#39;t&nbsp;match&nbsp;&#39;%q&#39;&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="7217923">,</span>&nbsp;<span class="ident" id="7217925">rcvd</span><span class="op" id="7217929">,</span>&nbsp;<span class="ident" id="7217931">test</span><span class="op" id="7217935">.</span><span class="ident" id="7217936">exp</span><span class="op" id="7217939">,</span>&nbsp;<span class="ident" id="7217941">n</span><span class="op" id="7217942">,</span>&nbsp;<span class="ident" id="7217944">err</span><span class="op" id="7217947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7217952">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7217956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7217959">}</span><br>
<span class="lineno"></span><span class="op" id="7217961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7217964">func</span>&nbsp;<span class="ident" id="7217969">TestConcurrentWrite</span><span class="op" id="7217988">(</span><span class="ident" id="7217989">t</span>&nbsp;<span class="op" id="7217991">*</span><span class="ident" id="7217992">testing</span><span class="op" id="7217999">.</span><span class="ident" id="7218000">T</span><span class="op" id="7218001">)</span>&nbsp;<span class="op" id="7218003">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218006">addr</span><span class="op" id="7218010">,</span>&nbsp;<span class="ident" id="7218012">sock</span><span class="op" id="7218016">,</span>&nbsp;<span class="ident" id="7218018">srvWG</span>&nbsp;<span class="op" id="7218024">:=</span>&nbsp;<span class="ident" id="7218027">startServer</span><span class="op" id="7218038">(</span><span class="string" id="7218039">&#34;udp&#34;</span><span class="op" id="7218044">,</span>&nbsp;<span class="string" id="7218046">&#34;&#34;</span><span class="op" id="7218048">,</span>&nbsp;<span class="builtinfunc" id="7218050">make</span><span class="op" id="7218054">(</span><span class="keyword" id="7218055">chan</span>&nbsp;<span class="builtintype" id="7218060">string</span><span class="op" id="7218066">,</span>&nbsp;<span class="num" id="7218068">1</span><span class="op" id="7218069">)</span><span class="op" id="7218070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218073">defer</span>&nbsp;<span class="ident" id="7218079">srvWG</span><span class="op" id="7218084">.</span><span class="ident" id="7218085">Wait</span><span class="op" id="7218089">(</span><span class="op" id="7218090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218093">defer</span>&nbsp;<span class="ident" id="7218099">sock</span><span class="op" id="7218103">.</span><span class="ident" id="7218104">Close</span><span class="op" id="7218109">(</span><span class="op" id="7218110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218113">w</span><span class="op" id="7218114">,</span>&nbsp;<span class="ident" id="7218116">err</span>&nbsp;<span class="op" id="7218120">:=</span>&nbsp;<span class="ident" id="7218123">Dial</span><span class="op" id="7218127">(</span><span class="string" id="7218128">&#34;udp&#34;</span><span class="op" id="7218133">,</span>&nbsp;<span class="ident" id="7218135">addr</span><span class="op" id="7218139">,</span>&nbsp;<span class="ident" id="7218141">LOG_USER</span><span class="op" id="7218149">|</span><span class="ident" id="7218150">LOG_ERR</span><span class="op" id="7218157">,</span>&nbsp;<span class="string" id="7218159">&#34;how&#39;s&nbsp;it&nbsp;going?&#34;</span><span class="op" id="7218176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218179">if</span>&nbsp;<span class="ident" id="7218182">err</span>&nbsp;<span class="op" id="7218186">!=</span>&nbsp;<span class="ident" id="7218189">nil</span>&nbsp;<span class="op" id="7218193">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218197">t</span><span class="op" id="7218198">.</span><span class="ident" id="7218199">Fatalf</span><span class="op" id="7218205">(</span><span class="string" id="7218206">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7218232">,</span>&nbsp;<span class="ident" id="7218234">err</span><span class="op" id="7218237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7218240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218243">var</span>&nbsp;<span class="ident" id="7218247">wg</span>&nbsp;<span class="ident" id="7218250">sync</span><span class="op" id="7218254">.</span><span class="ident" id="7218255">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218266">for</span>&nbsp;<span class="ident" id="7218270">i</span>&nbsp;<span class="op" id="7218272">:=</span>&nbsp;<span class="num" id="7218275">0</span><span class="op" id="7218276">;</span>&nbsp;<span class="ident" id="7218278">i</span>&nbsp;<span class="op" id="7218280">&lt;</span>&nbsp;<span class="num" id="7218282">10</span><span class="op" id="7218284">;</span>&nbsp;<span class="ident" id="7218286">i</span><span class="op" id="7218287">++</span>&nbsp;<span class="op" id="7218290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218294">wg</span><span class="op" id="7218296">.</span><span class="ident" id="7218297">Add</span><span class="op" id="7218300">(</span><span class="num" id="7218301">1</span><span class="op" id="7218302">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218306">go</span>&nbsp;<span class="keyword" id="7218309">func</span><span class="op" id="7218313">(</span><span class="op" id="7218314">)</span>&nbsp;<span class="op" id="7218316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218321">defer</span>&nbsp;<span class="ident" id="7218327">wg</span><span class="op" id="7218329">.</span><span class="ident" id="7218330">Done</span><span class="op" id="7218334">(</span><span class="op" id="7218335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218340">err</span>&nbsp;<span class="op" id="7218344">:=</span>&nbsp;<span class="ident" id="7218347">w</span><span class="op" id="7218348">.</span><span class="ident" id="7218349">Info</span><span class="op" id="7218353">(</span><span class="string" id="7218354">&#34;test&#34;</span><span class="op" id="7218360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218365">if</span>&nbsp;<span class="ident" id="7218368">err</span>&nbsp;<span class="op" id="7218372">!=</span>&nbsp;<span class="ident" id="7218375">nil</span>&nbsp;<span class="op" id="7218379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218385">t</span><span class="op" id="7218386">.</span><span class="ident" id="7218387">Errorf</span><span class="op" id="7218393">(</span><span class="string" id="7218394">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7218413">,</span>&nbsp;<span class="ident" id="7218415">err</span><span class="op" id="7218418">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218424">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7218434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7218438">}</span><span class="op" id="7218439">(</span><span class="op" id="7218440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7218443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218446">wg</span><span class="op" id="7218448">.</span><span class="ident" id="7218449">Wait</span><span class="op" id="7218453">(</span><span class="op" id="7218454">)</span><br>
<span class="lineno">300</span><span class="op" id="7218456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7218459">func</span>&nbsp;<span class="ident" id="7218464">TestConcurrentReconnect</span><span class="op" id="7218487">(</span><span class="ident" id="7218488">t</span>&nbsp;<span class="op" id="7218490">*</span><span class="ident" id="7218491">testing</span><span class="op" id="7218498">.</span><span class="ident" id="7218499">T</span><span class="op" id="7218500">)</span>&nbsp;<span class="op" id="7218502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218505">crashy</span>&nbsp;<span class="op" id="7218512">=</span>&nbsp;<span class="builtintype" id="7218514">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218520">defer</span>&nbsp;<span class="keyword" id="7218526">func</span><span class="op" id="7218530">(</span><span class="op" id="7218531">)</span>&nbsp;<span class="op" id="7218533">{</span>&nbsp;<span class="ident" id="7218535">crashy</span>&nbsp;<span class="op" id="7218542">=</span>&nbsp;<span class="builtintype" id="7218544">false</span>&nbsp;<span class="op" id="7218550">}</span><span class="op" id="7218551">(</span><span class="op" id="7218552">)</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218556">const</span>&nbsp;<span class="ident" id="7218562">N</span>&nbsp;<span class="op" id="7218564">=</span>&nbsp;<span class="num" id="7218566">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218570">const</span>&nbsp;<span class="ident" id="7218576">M</span>&nbsp;<span class="op" id="7218578">=</span>&nbsp;<span class="num" id="7218580">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218585">net</span>&nbsp;<span class="op" id="7218589">:=</span>&nbsp;<span class="string" id="7218592">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218600">done</span>&nbsp;<span class="op" id="7218605">:=</span>&nbsp;<span class="builtinfunc" id="7218608">make</span><span class="op" id="7218612">(</span><span class="keyword" id="7218613">chan</span>&nbsp;<span class="builtintype" id="7218618">string</span><span class="op" id="7218624">,</span>&nbsp;<span class="ident" id="7218626">N</span><span class="op" id="7218627">*</span><span class="ident" id="7218628">M</span><span class="op" id="7218629">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218632">addr</span><span class="op" id="7218636">,</span>&nbsp;<span class="ident" id="7218638">sock</span><span class="op" id="7218642">,</span>&nbsp;<span class="ident" id="7218644">srvWG</span>&nbsp;<span class="op" id="7218650">:=</span>&nbsp;<span class="ident" id="7218653">startServer</span><span class="op" id="7218664">(</span><span class="ident" id="7218665">net</span><span class="op" id="7218668">,</span>&nbsp;<span class="string" id="7218670">&#34;&#34;</span><span class="op" id="7218672">,</span>&nbsp;<span class="ident" id="7218674">done</span><span class="op" id="7218678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218681">defer</span>&nbsp;<span class="ident" id="7218687">os</span><span class="op" id="7218689">.</span><span class="ident" id="7218690">Remove</span><span class="op" id="7218696">(</span><span class="ident" id="7218697">addr</span><span class="op" id="7218701">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7218705">//&nbsp;count&nbsp;all&nbsp;the&nbsp;messages&nbsp;arriving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218741">count</span>&nbsp;<span class="op" id="7218747">:=</span>&nbsp;<span class="builtinfunc" id="7218750">make</span><span class="op" id="7218754">(</span><span class="keyword" id="7218755">chan</span>&nbsp;<span class="builtintype" id="7218760">int</span><span class="op" id="7218763">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218766">go</span>&nbsp;<span class="keyword" id="7218769">func</span><span class="op" id="7218773">(</span><span class="op" id="7218774">)</span>&nbsp;<span class="op" id="7218776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218780">ct</span>&nbsp;<span class="op" id="7218783">:=</span>&nbsp;<span class="num" id="7218786">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218790">for</span>&nbsp;<span class="keyword" id="7218794">range</span>&nbsp;<span class="ident" id="7218800">done</span>&nbsp;<span class="op" id="7218805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218810">ct</span><span class="op" id="7218812">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7218818">//&nbsp;we&nbsp;are&nbsp;looking&nbsp;for&nbsp;500&nbsp;out&nbsp;of&nbsp;1000&nbsp;events</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7218866">//&nbsp;here&nbsp;because&nbsp;lots&nbsp;of&nbsp;log&nbsp;messages&nbsp;are&nbsp;lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7218915">//&nbsp;in&nbsp;buffers&nbsp;(kernel&nbsp;and/or&nbsp;bufio)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218954">if</span>&nbsp;<span class="ident" id="7218957">ct</span>&nbsp;<span class="op" id="7218960">&gt;</span>&nbsp;<span class="ident" id="7218962">N</span><span class="op" id="7218963">*</span><span class="ident" id="7218964">M</span><span class="op" id="7218965">/</span><span class="num" id="7218966">2</span>&nbsp;<span class="op" id="7218968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218974">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7218983">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7218987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218991">count</span>&nbsp;<span class="op" id="7218997">&lt;-</span>&nbsp;<span class="ident" id="7219000">ct</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7219004">}</span><span class="op" id="7219005">(</span><span class="op" id="7219006">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219010">var</span>&nbsp;<span class="ident" id="7219014">wg</span>&nbsp;<span class="ident" id="7219017">sync</span><span class="op" id="7219021">.</span><span class="ident" id="7219022">WaitGroup</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219033">wg</span><span class="op" id="7219035">.</span><span class="ident" id="7219036">Add</span><span class="op" id="7219039">(</span><span class="ident" id="7219040">N</span><span class="op" id="7219041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219044">for</span>&nbsp;<span class="ident" id="7219048">i</span>&nbsp;<span class="op" id="7219050">:=</span>&nbsp;<span class="num" id="7219053">0</span><span class="op" id="7219054">;</span>&nbsp;<span class="ident" id="7219056">i</span>&nbsp;<span class="op" id="7219058">&lt;</span>&nbsp;<span class="ident" id="7219060">N</span><span class="op" id="7219061">;</span>&nbsp;<span class="ident" id="7219063">i</span><span class="op" id="7219064">++</span>&nbsp;<span class="op" id="7219067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219071">go</span>&nbsp;<span class="keyword" id="7219074">func</span><span class="op" id="7219078">(</span><span class="op" id="7219079">)</span>&nbsp;<span class="op" id="7219081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219086">defer</span>&nbsp;<span class="ident" id="7219092">wg</span><span class="op" id="7219094">.</span><span class="ident" id="7219095">Done</span><span class="op" id="7219099">(</span><span class="op" id="7219100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219105">w</span><span class="op" id="7219106">,</span>&nbsp;<span class="ident" id="7219108">err</span>&nbsp;<span class="op" id="7219112">:=</span>&nbsp;<span class="ident" id="7219115">Dial</span><span class="op" id="7219119">(</span><span class="ident" id="7219120">net</span><span class="op" id="7219123">,</span>&nbsp;<span class="ident" id="7219125">addr</span><span class="op" id="7219129">,</span>&nbsp;<span class="ident" id="7219131">LOG_USER</span><span class="op" id="7219139">|</span><span class="ident" id="7219140">LOG_ERR</span><span class="op" id="7219147">,</span>&nbsp;<span class="string" id="7219149">&#34;tag&#34;</span><span class="op" id="7219154">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219159">if</span>&nbsp;<span class="ident" id="7219162">err</span>&nbsp;<span class="op" id="7219166">!=</span>&nbsp;<span class="ident" id="7219169">nil</span>&nbsp;<span class="op" id="7219173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219179">t</span><span class="op" id="7219180">.</span><span class="ident" id="7219181">Fatalf</span><span class="op" id="7219187">(</span><span class="string" id="7219188">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7219214">,</span>&nbsp;<span class="ident" id="7219216">err</span><span class="op" id="7219219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7219224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219229">defer</span>&nbsp;<span class="ident" id="7219235">w</span><span class="op" id="7219236">.</span><span class="ident" id="7219237">Close</span><span class="op" id="7219242">(</span><span class="op" id="7219243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219248">for</span>&nbsp;<span class="ident" id="7219252">i</span>&nbsp;<span class="op" id="7219254">:=</span>&nbsp;<span class="num" id="7219257">0</span><span class="op" id="7219258">;</span>&nbsp;<span class="ident" id="7219260">i</span>&nbsp;<span class="op" id="7219262">&lt;</span>&nbsp;<span class="ident" id="7219264">M</span><span class="op" id="7219265">;</span>&nbsp;<span class="ident" id="7219267">i</span><span class="op" id="7219268">++</span>&nbsp;<span class="op" id="7219271">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219277">err</span>&nbsp;<span class="op" id="7219281">:=</span>&nbsp;<span class="ident" id="7219284">w</span><span class="op" id="7219285">.</span><span class="ident" id="7219286">Info</span><span class="op" id="7219290">(</span><span class="string" id="7219291">&#34;test&#34;</span><span class="op" id="7219297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219303">if</span>&nbsp;<span class="ident" id="7219306">err</span>&nbsp;<span class="op" id="7219310">!=</span>&nbsp;<span class="ident" id="7219313">nil</span>&nbsp;<span class="op" id="7219317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219324">t</span><span class="op" id="7219325">.</span><span class="ident" id="7219326">Errorf</span><span class="op" id="7219332">(</span><span class="string" id="7219333">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7219352">,</span>&nbsp;<span class="ident" id="7219354">err</span><span class="op" id="7219357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219364">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7219375">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7219380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7219384">}</span><span class="op" id="7219385">(</span><span class="op" id="7219386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7219389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219392">wg</span><span class="op" id="7219394">.</span><span class="ident" id="7219395">Wait</span><span class="op" id="7219399">(</span><span class="op" id="7219400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219403">sock</span><span class="op" id="7219407">.</span><span class="ident" id="7219408">Close</span><span class="op" id="7219413">(</span><span class="op" id="7219414">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219417">srvWG</span><span class="op" id="7219422">.</span><span class="ident" id="7219423">Wait</span><span class="op" id="7219427">(</span><span class="op" id="7219428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7219431">close</span><span class="op" id="7219436">(</span><span class="ident" id="7219437">done</span><span class="op" id="7219441">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219445">select</span>&nbsp;<span class="op" id="7219452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219455">case</span>&nbsp;<span class="op" id="7219460">&lt;-</span><span class="ident" id="7219462">count</span><span class="op" id="7219467">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219470">case</span>&nbsp;<span class="op" id="7219475">&lt;-</span><span class="ident" id="7219477">time</span><span class="op" id="7219481">.</span><span class="ident" id="7219482">After</span><span class="op" id="7219487">(</span><span class="num" id="7219488">100</span>&nbsp;<span class="op" id="7219492">*</span>&nbsp;<span class="ident" id="7219494">time</span><span class="op" id="7219498">.</span><span class="ident" id="7219499">Millisecond</span><span class="op" id="7219510">)</span><span class="op" id="7219511">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219515">t</span><span class="op" id="7219516">.</span><span class="ident" id="7219517">Error</span><span class="op" id="7219522">(</span><span class="string" id="7219523">&#34;timeout&nbsp;in&nbsp;concurrent&nbsp;reconnect&#34;</span><span class="op" id="7219556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7219559">}</span><br>
<span class="lineno"></span><span class="op" id="7219561">}</span>
</div>
</body>
</html>
