<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6859079">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6859134">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6859188">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6859239">package</span>&nbsp;<span class="ident" id="6859247">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6859252">import</span>&nbsp;<span class="op" id="6859259">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6859262">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6859285">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6859295">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6859302">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6859308">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6859315">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6859323">&#34;strconv&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6859334">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6859345">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6859353">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6859364">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6859371">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="6859374">var</span>&nbsp;<span class="ident" id="6859378">_</span>&nbsp;<span class="op" id="6859380">=</span>&nbsp;<span class="ident" id="6859382">log</span><span class="op" id="6859385">.</span><span class="ident" id="6859386">Printf</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6859394">//&nbsp;fakeDriver&nbsp;is&nbsp;a&nbsp;fake&nbsp;database&nbsp;that&nbsp;implements&nbsp;Go&#39;s&nbsp;driver.Driver</span><br>
<span class="lineno"></span><span class="comment" id="6859462">//&nbsp;interface,&nbsp;just&nbsp;for&nbsp;testing.</span><br>
<span class="lineno">25</span><span class="comment" id="6859494">//</span><br>
<span class="lineno"></span><span class="comment" id="6859497">//&nbsp;It&nbsp;speaks&nbsp;a&nbsp;query&nbsp;language&nbsp;that&#39;s&nbsp;semantically&nbsp;similar&nbsp;to&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="6859562">//&nbsp;syntactically&nbsp;different&nbsp;and&nbsp;simpler&nbsp;than&nbsp;SQL.&nbsp;&nbsp;The&nbsp;syntax&nbsp;is&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="6859629">//&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="6859641">//</span><br>
<span class="lineno">30</span><span class="comment" id="6859644">//&nbsp;&nbsp;&nbsp;WIPE</span><br>
<span class="lineno"></span><span class="comment" id="6859654">//&nbsp;&nbsp;&nbsp;CREATE|&lt;tablename&gt;|&lt;col&gt;=&lt;type&gt;,&lt;col&gt;=&lt;type&gt;,...</span><br>
<span class="lineno"></span><span class="comment" id="6859708">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;types&nbsp;are:&nbsp;&#34;string&#34;,&nbsp;[u]int{8,16,32,64},&nbsp;&#34;bool&#34;</span><br>
<span class="lineno"></span><span class="comment" id="6859769">//&nbsp;&nbsp;&nbsp;INSERT|&lt;tablename&gt;|col=val,col2=val2,col3=?</span><br>
<span class="lineno"></span><span class="comment" id="6859818">//&nbsp;&nbsp;&nbsp;SELECT|&lt;tablename&gt;|projectcol1,projectcol2|filtercol=?,filtercol2=?</span><br>
<span class="lineno">35</span><span class="comment" id="6859891">//</span><br>
<span class="lineno"></span><span class="comment" id="6859894">//&nbsp;When&nbsp;opening&nbsp;a&nbsp;fakeDriver&#39;s&nbsp;database,&nbsp;it&nbsp;starts&nbsp;empty&nbsp;with&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="6859959">//&nbsp;tables.&nbsp;&nbsp;All&nbsp;tables&nbsp;and&nbsp;data&nbsp;are&nbsp;stored&nbsp;in&nbsp;memory&nbsp;only.</span><br>
<span class="lineno"></span><span class="keyword" id="6860018">type</span>&nbsp;<span class="ident" id="6860023">fakeDriver</span>&nbsp;<span class="keyword" id="6860034">struct</span>&nbsp;<span class="op" id="6860041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860044">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6860055">sync</span><span class="op" id="6860059">.</span><span class="ident" id="6860060">Mutex</span>&nbsp;<span class="comment" id="6860066">//&nbsp;guards&nbsp;3&nbsp;following&nbsp;fields</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860096">openCount</span>&nbsp;&nbsp;<span class="builtintype" id="6860107">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6860118">//&nbsp;conn&nbsp;opens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860133">closeCount</span>&nbsp;<span class="builtintype" id="6860144">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6860155">//&nbsp;conn&nbsp;closes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860171">waitCh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6860182">chan</span>&nbsp;<span class="keyword" id="6860187">struct</span><span class="op" id="6860193">{</span><span class="op" id="6860194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860197">waitingCh</span>&nbsp;&nbsp;<span class="keyword" id="6860208">chan</span>&nbsp;<span class="keyword" id="6860213">struct</span><span class="op" id="6860219">{</span><span class="op" id="6860220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860223">dbs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6860234">map</span><span class="op" id="6860237">[</span><span class="builtintype" id="6860238">string</span><span class="op" id="6860244">]</span><span class="op" id="6860245">*</span><span class="ident" id="6860246">fakeDB</span><br>
<span class="lineno">45</span><span class="op" id="6860253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6860256">type</span>&nbsp;<span class="ident" id="6860261">fakeDB</span>&nbsp;<span class="keyword" id="6860268">struct</span>&nbsp;<span class="op" id="6860275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860278">name</span>&nbsp;<span class="builtintype" id="6860283">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860292">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6860300">sync</span><span class="op" id="6860304">.</span><span class="ident" id="6860305">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860312">free</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6860320">[</span><span class="op" id="6860321">]</span><span class="op" id="6860322">*</span><span class="ident" id="6860323">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860333">tables</span>&nbsp;&nbsp;<span class="keyword" id="6860341">map</span><span class="op" id="6860344">[</span><span class="builtintype" id="6860345">string</span><span class="op" id="6860351">]</span><span class="op" id="6860352">*</span><span class="ident" id="6860353">table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860360">badConn</span>&nbsp;<span class="builtintype" id="6860368">bool</span><br>
<span class="lineno"></span><span class="op" id="6860373">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="6860376">type</span>&nbsp;<span class="ident" id="6860381">table</span>&nbsp;<span class="keyword" id="6860387">struct</span>&nbsp;<span class="op" id="6860394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860397">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6860405">sync</span><span class="op" id="6860409">.</span><span class="ident" id="6860410">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860417">colname</span>&nbsp;<span class="op" id="6860425">[</span><span class="op" id="6860426">]</span><span class="builtintype" id="6860427">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860435">coltype</span>&nbsp;<span class="op" id="6860443">[</span><span class="op" id="6860444">]</span><span class="builtintype" id="6860445">string</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860453">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6860461">[</span><span class="op" id="6860462">]</span><span class="op" id="6860463">*</span><span class="ident" id="6860464">row</span><br>
<span class="lineno"></span><span class="op" id="6860468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6860471">func</span>&nbsp;<span class="op" id="6860476">(</span><span class="ident" id="6860477">t</span>&nbsp;<span class="op" id="6860479">*</span><span class="ident" id="6860480">table</span><span class="op" id="6860485">)</span>&nbsp;<span class="ident" id="6860487">columnIndex</span><span class="op" id="6860498">(</span><span class="ident" id="6860499">name</span>&nbsp;<span class="builtintype" id="6860504">string</span><span class="op" id="6860510">)</span>&nbsp;<span class="builtintype" id="6860512">int</span>&nbsp;<span class="op" id="6860516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6860519">for</span>&nbsp;<span class="ident" id="6860523">n</span><span class="op" id="6860524">,</span>&nbsp;<span class="ident" id="6860526">nname</span>&nbsp;<span class="op" id="6860532">:=</span>&nbsp;<span class="keyword" id="6860535">range</span>&nbsp;<span class="ident" id="6860541">t</span><span class="op" id="6860542">.</span><span class="ident" id="6860543">colname</span>&nbsp;<span class="op" id="6860551">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6860555">if</span>&nbsp;<span class="ident" id="6860558">name</span>&nbsp;<span class="op" id="6860563">==</span>&nbsp;<span class="ident" id="6860566">nname</span>&nbsp;<span class="op" id="6860572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6860577">return</span>&nbsp;<span class="ident" id="6860584">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6860588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6860591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6860594">return</span>&nbsp;<span class="op" id="6860601">-</span><span class="num" id="6860602">1</span><br>
<span class="lineno">70</span><span class="op" id="6860604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6860607">type</span>&nbsp;<span class="ident" id="6860612">row</span>&nbsp;<span class="keyword" id="6860616">struct</span>&nbsp;<span class="op" id="6860623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860626">cols</span>&nbsp;<span class="op" id="6860631">[</span><span class="op" id="6860632">]</span><span class="keyword" id="6860633">interface</span><span class="op" id="6860642">{</span><span class="op" id="6860643">}</span>&nbsp;<span class="comment" id="6860645">//&nbsp;must&nbsp;be&nbsp;same&nbsp;size&nbsp;as&nbsp;its&nbsp;table&nbsp;colname&nbsp;+&nbsp;coltype</span><br>
<span class="lineno"></span><span class="op" id="6860697">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="6860700">func</span>&nbsp;<span class="op" id="6860705">(</span><span class="ident" id="6860706">r</span>&nbsp;<span class="op" id="6860708">*</span><span class="ident" id="6860709">row</span><span class="op" id="6860712">)</span>&nbsp;<span class="ident" id="6860714">clone</span><span class="op" id="6860719">(</span><span class="op" id="6860720">)</span>&nbsp;<span class="op" id="6860722">*</span><span class="ident" id="6860723">row</span>&nbsp;<span class="op" id="6860727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860730">nrow</span>&nbsp;<span class="op" id="6860735">:=</span>&nbsp;<span class="op" id="6860738">&amp;</span><span class="ident" id="6860739">row</span><span class="op" id="6860742">{</span><span class="ident" id="6860743">cols</span><span class="op" id="6860747">:</span>&nbsp;<span class="builtinfunc" id="6860749">make</span><span class="op" id="6860753">(</span><span class="op" id="6860754">[</span><span class="op" id="6860755">]</span><span class="keyword" id="6860756">interface</span><span class="op" id="6860765">{</span><span class="op" id="6860766">}</span><span class="op" id="6860767">,</span>&nbsp;<span class="builtinfunc" id="6860769">len</span><span class="op" id="6860772">(</span><span class="ident" id="6860773">r</span><span class="op" id="6860774">.</span><span class="ident" id="6860775">cols</span><span class="op" id="6860779">)</span><span class="op" id="6860780">)</span><span class="op" id="6860781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6860784">copy</span><span class="op" id="6860788">(</span><span class="ident" id="6860789">nrow</span><span class="op" id="6860793">.</span><span class="ident" id="6860794">cols</span><span class="op" id="6860798">,</span>&nbsp;<span class="ident" id="6860800">r</span><span class="op" id="6860801">.</span><span class="ident" id="6860802">cols</span><span class="op" id="6860806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6860809">return</span>&nbsp;<span class="ident" id="6860816">nrow</span><br>
<span class="lineno">80</span><span class="op" id="6860821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6860824">type</span>&nbsp;<span class="ident" id="6860829">fakeConn</span>&nbsp;<span class="keyword" id="6860838">struct</span>&nbsp;<span class="op" id="6860845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860848">db</span>&nbsp;<span class="op" id="6860851">*</span><span class="ident" id="6860852">fakeDB</span>&nbsp;<span class="comment" id="6860859">//&nbsp;where&nbsp;to&nbsp;return&nbsp;ourselves&nbsp;to</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860893">currTx</span>&nbsp;<span class="op" id="6860900">*</span><span class="ident" id="6860901">fakeTx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6860910">//&nbsp;Stats&nbsp;for&nbsp;tests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860931">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6860943">sync</span><span class="op" id="6860947">.</span><span class="ident" id="6860948">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860955">stmtsMade</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6860967">int</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860972">stmtsClosed</span>&nbsp;<span class="builtintype" id="6860984">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6860989">numPrepare</span>&nbsp;&nbsp;<span class="builtintype" id="6861001">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861006">bad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6861018">bool</span><br>
<span class="lineno"></span><span class="op" id="6861023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="6861026">func</span>&nbsp;<span class="op" id="6861031">(</span><span class="ident" id="6861032">c</span>&nbsp;<span class="op" id="6861034">*</span><span class="ident" id="6861035">fakeConn</span><span class="op" id="6861043">)</span>&nbsp;<span class="ident" id="6861045">incrStat</span><span class="op" id="6861053">(</span><span class="ident" id="6861054">v</span>&nbsp;<span class="op" id="6861056">*</span><span class="builtintype" id="6861057">int</span><span class="op" id="6861060">)</span>&nbsp;<span class="op" id="6861062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861065">c</span><span class="op" id="6861066">.</span><span class="ident" id="6861067">mu</span><span class="op" id="6861069">.</span><span class="ident" id="6861070">Lock</span><span class="op" id="6861074">(</span><span class="op" id="6861075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6861078">*</span><span class="ident" id="6861079">v</span><span class="op" id="6861080">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861084">c</span><span class="op" id="6861085">.</span><span class="ident" id="6861086">mu</span><span class="op" id="6861088">.</span><span class="ident" id="6861089">Unlock</span><span class="op" id="6861095">(</span><span class="op" id="6861096">)</span><br>
<span class="lineno"></span><span class="op" id="6861098">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="6861101">type</span>&nbsp;<span class="ident" id="6861106">fakeTx</span>&nbsp;<span class="keyword" id="6861113">struct</span>&nbsp;<span class="op" id="6861120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861123">c</span>&nbsp;<span class="op" id="6861125">*</span><span class="ident" id="6861126">fakeConn</span><br>
<span class="lineno"></span><span class="op" id="6861135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="6861138">type</span>&nbsp;<span class="ident" id="6861143">fakeStmt</span>&nbsp;<span class="keyword" id="6861152">struct</span>&nbsp;<span class="op" id="6861159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861162">c</span>&nbsp;<span class="op" id="6861164">*</span><span class="ident" id="6861165">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861175">q</span>&nbsp;<span class="builtintype" id="6861177">string</span>&nbsp;<span class="comment" id="6861184">//&nbsp;just&nbsp;for&nbsp;debugging</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861208">cmd</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6861214">string</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861222">table</span>&nbsp;<span class="builtintype" id="6861228">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861237">closed</span>&nbsp;<span class="builtintype" id="6861244">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861251">colName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6861264">[</span><span class="op" id="6861265">]</span><span class="builtintype" id="6861266">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6861278">//&nbsp;used&nbsp;by&nbsp;CREATE,&nbsp;INSERT,&nbsp;SELECT&nbsp;(selected&nbsp;columns)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861332">colType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6861345">[</span><span class="op" id="6861346">]</span><span class="builtintype" id="6861347">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6861359">//&nbsp;used&nbsp;by&nbsp;CREATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861378">colValue</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6861391">[</span><span class="op" id="6861392">]</span><span class="keyword" id="6861393">interface</span><span class="op" id="6861402">{</span><span class="op" id="6861403">}</span>&nbsp;<span class="comment" id="6861405">//&nbsp;used&nbsp;by&nbsp;INSERT&nbsp;(mix&nbsp;of&nbsp;strings&nbsp;and&nbsp;&#34;?&#34;&nbsp;for&nbsp;bound&nbsp;params)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861466">placeholders</span>&nbsp;<span class="builtintype" id="6861479">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6861493">//&nbsp;used&nbsp;by&nbsp;INSERT/SELECT:&nbsp;number&nbsp;of&nbsp;?&nbsp;params</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861540">whereCol</span>&nbsp;<span class="op" id="6861549">[</span><span class="op" id="6861550">]</span><span class="builtintype" id="6861551">string</span>&nbsp;<span class="comment" id="6861558">//&nbsp;used&nbsp;by&nbsp;SELECT&nbsp;(all&nbsp;placeholders)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861597">placeholderConverter</span>&nbsp;<span class="op" id="6861618">[</span><span class="op" id="6861619">]</span><span class="ident" id="6861620">driver</span><span class="op" id="6861626">.</span><span class="ident" id="6861627">ValueConverter</span>&nbsp;<span class="comment" id="6861642">//&nbsp;used&nbsp;by&nbsp;INSERT</span><br>
<span class="lineno"></span><span class="op" id="6861660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6861663">var</span>&nbsp;<span class="ident" id="6861667">fdriver</span>&nbsp;<span class="ident" id="6861675">driver</span><span class="op" id="6861681">.</span><span class="ident" id="6861682">Driver</span>&nbsp;<span class="op" id="6861689">=</span>&nbsp;<span class="op" id="6861691">&amp;</span><span class="ident" id="6861692">fakeDriver</span><span class="op" id="6861702">{</span><span class="op" id="6861703">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="6861706">func</span>&nbsp;<span class="ident" id="6861711">init</span><span class="op" id="6861715">(</span><span class="op" id="6861716">)</span>&nbsp;<span class="op" id="6861718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861721">Register</span><span class="op" id="6861729">(</span><span class="string" id="6861730">&#34;test&#34;</span><span class="op" id="6861736">,</span>&nbsp;<span class="ident" id="6861738">fdriver</span><span class="op" id="6861745">)</span><br>
<span class="lineno"></span><span class="op" id="6861747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="6861750">func</span>&nbsp;<span class="ident" id="6861755">contains</span><span class="op" id="6861763">(</span><span class="ident" id="6861764">list</span>&nbsp;<span class="op" id="6861769">[</span><span class="op" id="6861770">]</span><span class="builtintype" id="6861771">string</span><span class="op" id="6861777">,</span>&nbsp;<span class="ident" id="6861779">y</span>&nbsp;<span class="builtintype" id="6861781">string</span><span class="op" id="6861787">)</span>&nbsp;<span class="builtintype" id="6861789">bool</span>&nbsp;<span class="op" id="6861794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6861797">for</span>&nbsp;<span class="ident" id="6861801">_</span><span class="op" id="6861802">,</span>&nbsp;<span class="ident" id="6861804">x</span>&nbsp;<span class="op" id="6861806">:=</span>&nbsp;<span class="keyword" id="6861809">range</span>&nbsp;<span class="ident" id="6861815">list</span>&nbsp;<span class="op" id="6861820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6861824">if</span>&nbsp;<span class="ident" id="6861827">x</span>&nbsp;<span class="op" id="6861829">==</span>&nbsp;<span class="ident" id="6861832">y</span>&nbsp;<span class="op" id="6861834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6861839">return</span>&nbsp;<span class="builtintype" id="6861846">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6861853">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6861856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6861859">return</span>&nbsp;<span class="builtintype" id="6861866">false</span><br>
<span class="lineno"></span><span class="op" id="6861872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6861875">type</span>&nbsp;<span class="ident" id="6861880">Dummy</span>&nbsp;<span class="keyword" id="6861886">struct</span>&nbsp;<span class="op" id="6861893">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861896">driver</span><span class="op" id="6861902">.</span><span class="ident" id="6861903">Driver</span><br>
<span class="lineno"></span><span class="op" id="6861910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6861913">func</span>&nbsp;<span class="ident" id="6861918">TestDrivers</span><span class="op" id="6861929">(</span><span class="ident" id="6861930">t</span>&nbsp;<span class="op" id="6861932">*</span><span class="ident" id="6861933">testing</span><span class="op" id="6861940">.</span><span class="ident" id="6861941">T</span><span class="op" id="6861942">)</span>&nbsp;<span class="op" id="6861944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861947">unregisterAllDrivers</span><span class="op" id="6861967">(</span><span class="op" id="6861968">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861971">Register</span><span class="op" id="6861979">(</span><span class="string" id="6861980">&#34;test&#34;</span><span class="op" id="6861986">,</span>&nbsp;<span class="ident" id="6861988">fdriver</span><span class="op" id="6861995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6861998">Register</span><span class="op" id="6862006">(</span><span class="string" id="6862007">&#34;invalid&#34;</span><span class="op" id="6862016">,</span>&nbsp;<span class="ident" id="6862018">Dummy</span><span class="op" id="6862023">{</span><span class="op" id="6862024">}</span><span class="op" id="6862025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6862028">all</span>&nbsp;<span class="op" id="6862032">:=</span>&nbsp;<span class="ident" id="6862035">Drivers</span><span class="op" id="6862042">(</span><span class="op" id="6862043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6862046">if</span>&nbsp;<span class="builtinfunc" id="6862049">len</span><span class="op" id="6862052">(</span><span class="ident" id="6862053">all</span><span class="op" id="6862056">)</span>&nbsp;<span class="op" id="6862058">&lt;</span>&nbsp;<span class="num" id="6862060">2</span>&nbsp;<span class="op" id="6862062">||</span>&nbsp;<span class="op" id="6862065">!</span><span class="ident" id="6862066">sort</span><span class="op" id="6862070">.</span><span class="ident" id="6862071">StringsAreSorted</span><span class="op" id="6862087">(</span><span class="ident" id="6862088">all</span><span class="op" id="6862091">)</span>&nbsp;<span class="op" id="6862093">||</span>&nbsp;<span class="op" id="6862096">!</span><span class="ident" id="6862097">contains</span><span class="op" id="6862105">(</span><span class="ident" id="6862106">all</span><span class="op" id="6862109">,</span>&nbsp;<span class="string" id="6862111">&#34;test&#34;</span><span class="op" id="6862117">)</span>&nbsp;<span class="op" id="6862119">||</span>&nbsp;<span class="op" id="6862122">!</span><span class="ident" id="6862123">contains</span><span class="op" id="6862131">(</span><span class="ident" id="6862132">all</span><span class="op" id="6862135">,</span>&nbsp;<span class="string" id="6862137">&#34;invalid&#34;</span><span class="op" id="6862146">)</span>&nbsp;<span class="op" id="6862148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6862152">t</span><span class="op" id="6862153">.</span><span class="ident" id="6862154">Fatalf</span><span class="op" id="6862160">(</span><span class="string" id="6862161">&#34;Drivers&nbsp;=&nbsp;%v,&nbsp;want&nbsp;sorted&nbsp;list&nbsp;with&nbsp;at&nbsp;least&nbsp;[invalid,&nbsp;test]&#34;</span><span class="op" id="6862223">,</span>&nbsp;<span class="ident" id="6862225">all</span><span class="op" id="6862228">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6862231">}</span><br>
<span class="lineno"></span><span class="op" id="6862233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6862236">//&nbsp;Supports&nbsp;dsn&nbsp;forms:</span><br>
<span class="lineno"></span><span class="comment" id="6862259">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;</span><br>
<span class="lineno">155</span><span class="comment" id="6862274">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;;&lt;opts&gt;&nbsp;&nbsp;(only&nbsp;currently&nbsp;supported&nbsp;option&nbsp;is&nbsp;`badConn`,</span><br>
<span class="lineno"></span><span class="comment" id="6862344">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;causes&nbsp;driver.ErrBadConn&nbsp;to&nbsp;be&nbsp;returned&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="6862417">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;every&nbsp;other&nbsp;conn.Begin())</span><br>
<span class="lineno"></span><span class="keyword" id="6862467">func</span>&nbsp;<span class="op" id="6862472">(</span><span class="ident" id="6862473">d</span>&nbsp;<span class="op" id="6862475">*</span><span class="ident" id="6862476">fakeDriver</span><span class="op" id="6862486">)</span>&nbsp;<span class="ident" id="6862488">Open</span><span class="op" id="6862492">(</span><span class="ident" id="6862493">dsn</span>&nbsp;<span class="builtintype" id="6862497">string</span><span class="op" id="6862503">)</span>&nbsp;<span class="op" id="6862505">(</span><span class="ident" id="6862506">driver</span><span class="op" id="6862512">.</span><span class="ident" id="6862513">Conn</span><span class="op" id="6862517">,</span>&nbsp;<span class="builtintype" id="6862519">error</span><span class="op" id="6862524">)</span>&nbsp;<span class="op" id="6862526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6862529">parts</span>&nbsp;<span class="op" id="6862535">:=</span>&nbsp;<span class="ident" id="6862538">strings</span><span class="op" id="6862545">.</span><span class="ident" id="6862546">Split</span><span class="op" id="6862551">(</span><span class="ident" id="6862552">dsn</span><span class="op" id="6862555">,</span>&nbsp;<span class="string" id="6862557">&#34;;&#34;</span><span class="op" id="6862560">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6862563">if</span>&nbsp;<span class="builtinfunc" id="6862566">len</span><span class="op" id="6862569">(</span><span class="ident" id="6862570">parts</span><span class="op" id="6862575">)</span>&nbsp;<span class="op" id="6862577">&lt;</span>&nbsp;<span class="num" id="6862579">1</span>&nbsp;<span class="op" id="6862581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6862585">return</span>&nbsp;<span class="ident" id="6862592">nil</span><span class="op" id="6862595">,</span>&nbsp;<span class="ident" id="6862597">errors</span><span class="op" id="6862603">.</span><span class="ident" id="6862604">New</span><span class="op" id="6862607">(</span><span class="string" id="6862608">&#34;fakedb:&nbsp;no&nbsp;database&nbsp;name&#34;</span><span class="op" id="6862634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6862637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6862640">name</span>&nbsp;<span class="op" id="6862645">:=</span>&nbsp;<span class="ident" id="6862648">parts</span><span class="op" id="6862653">[</span><span class="num" id="6862654">0</span><span class="op" id="6862655">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6862659">db</span>&nbsp;<span class="op" id="6862662">:=</span>&nbsp;<span class="ident" id="6862665">d</span><span class="op" id="6862666">.</span><span class="ident" id="6862667">getDB</span><span class="op" id="6862672">(</span><span class="ident" id="6862673">name</span><span class="op" id="6862677">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6862681">d</span><span class="op" id="6862682">.</span><span class="ident" id="6862683">mu</span><span class="op" id="6862685">.</span><span class="ident" id="6862686">Lock</span><span class="op" id="6862690">(</span><span class="op" id="6862691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6862694">d</span><span class="op" id="6862695">.</span><span class="ident" id="6862696">openCount</span><span class="op" id="6862705">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6862709">d</span><span class="op" id="6862710">.</span><span class="ident" id="6862711">mu</span><span class="op" id="6862713">.</span><span class="ident" id="6862714">Unlock</span><span class="op" id="6862720">(</span><span class="op" id="6862721">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6862724">conn</span>&nbsp;<span class="op" id="6862729">:=</span>&nbsp;<span class="op" id="6862732">&amp;</span><span class="ident" id="6862733">fakeConn</span><span class="op" id="6862741">{</span><span class="ident" id="6862742">db</span><span class="op" id="6862744">:</span>&nbsp;<span class="ident" id="6862746">db</span><span class="op" id="6862748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6862752">if</span>&nbsp;<span class="builtinfunc" id="6862755">len</span><span class="op" id="6862758">(</span><span class="ident" id="6862759">parts</span><span class="op" id="6862764">)</span>&nbsp;<span class="op" id="6862766">&gt;=</span>&nbsp;<span class="num" id="6862769">2</span>&nbsp;<span class="op" id="6862771">&amp;&amp;</span>&nbsp;<span class="ident" id="6862774">parts</span><span class="op" id="6862779">[</span><span class="num" id="6862780">1</span><span class="op" id="6862781">]</span>&nbsp;<span class="op" id="6862783">==</span>&nbsp;<span class="string" id="6862786">&#34;badConn&#34;</span>&nbsp;<span class="op" id="6862796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6862800">conn</span><span class="op" id="6862804">.</span><span class="ident" id="6862805">bad</span>&nbsp;<span class="op" id="6862809">=</span>&nbsp;<span class="builtintype" id="6862811">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6862817">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6862820">if</span>&nbsp;<span class="ident" id="6862823">d</span><span class="op" id="6862824">.</span><span class="ident" id="6862825">waitCh</span>&nbsp;<span class="op" id="6862832">!=</span>&nbsp;<span class="ident" id="6862835">nil</span>&nbsp;<span class="op" id="6862839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6862843">d</span><span class="op" id="6862844">.</span><span class="ident" id="6862845">waitingCh</span>&nbsp;<span class="op" id="6862855">&lt;-</span>&nbsp;<span class="keyword" id="6862858">struct</span><span class="op" id="6862864">{</span><span class="op" id="6862865">}</span><span class="op" id="6862866">{</span><span class="op" id="6862867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6862871">&lt;-</span><span class="ident" id="6862873">d</span><span class="op" id="6862874">.</span><span class="ident" id="6862875">waitCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6862884">d</span><span class="op" id="6862885">.</span><span class="ident" id="6862886">waitCh</span>&nbsp;<span class="op" id="6862893">=</span>&nbsp;<span class="ident" id="6862895">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6862901">d</span><span class="op" id="6862902">.</span><span class="ident" id="6862903">waitingCh</span>&nbsp;<span class="op" id="6862913">=</span>&nbsp;<span class="ident" id="6862915">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6862920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6862923">return</span>&nbsp;<span class="ident" id="6862930">conn</span><span class="op" id="6862934">,</span>&nbsp;<span class="ident" id="6862936">nil</span><br>
<span class="lineno"></span><span class="op" id="6862940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6862943">func</span>&nbsp;<span class="op" id="6862948">(</span><span class="ident" id="6862949">d</span>&nbsp;<span class="op" id="6862951">*</span><span class="ident" id="6862952">fakeDriver</span><span class="op" id="6862962">)</span>&nbsp;<span class="ident" id="6862964">getDB</span><span class="op" id="6862969">(</span><span class="ident" id="6862970">name</span>&nbsp;<span class="builtintype" id="6862975">string</span><span class="op" id="6862981">)</span>&nbsp;<span class="op" id="6862983">*</span><span class="ident" id="6862984">fakeDB</span>&nbsp;<span class="op" id="6862991">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6862994">d</span><span class="op" id="6862995">.</span><span class="ident" id="6862996">mu</span><span class="op" id="6862998">.</span><span class="ident" id="6862999">Lock</span><span class="op" id="6863003">(</span><span class="op" id="6863004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6863007">defer</span>&nbsp;<span class="ident" id="6863013">d</span><span class="op" id="6863014">.</span><span class="ident" id="6863015">mu</span><span class="op" id="6863017">.</span><span class="ident" id="6863018">Unlock</span><span class="op" id="6863024">(</span><span class="op" id="6863025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6863028">if</span>&nbsp;<span class="ident" id="6863031">d</span><span class="op" id="6863032">.</span><span class="ident" id="6863033">dbs</span>&nbsp;<span class="op" id="6863037">==</span>&nbsp;<span class="ident" id="6863040">nil</span>&nbsp;<span class="op" id="6863044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6863048">d</span><span class="op" id="6863049">.</span><span class="ident" id="6863050">dbs</span>&nbsp;<span class="op" id="6863054">=</span>&nbsp;<span class="builtinfunc" id="6863056">make</span><span class="op" id="6863060">(</span><span class="keyword" id="6863061">map</span><span class="op" id="6863064">[</span><span class="builtintype" id="6863065">string</span><span class="op" id="6863071">]</span><span class="op" id="6863072">*</span><span class="ident" id="6863073">fakeDB</span><span class="op" id="6863079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6863082">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6863085">db</span><span class="op" id="6863087">,</span>&nbsp;<span class="ident" id="6863089">ok</span>&nbsp;<span class="op" id="6863092">:=</span>&nbsp;<span class="ident" id="6863095">d</span><span class="op" id="6863096">.</span><span class="ident" id="6863097">dbs</span><span class="op" id="6863100">[</span><span class="ident" id="6863101">name</span><span class="op" id="6863105">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6863108">if</span>&nbsp;<span class="op" id="6863111">!</span><span class="ident" id="6863112">ok</span>&nbsp;<span class="op" id="6863115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6863119">db</span>&nbsp;<span class="op" id="6863122">=</span>&nbsp;<span class="op" id="6863124">&amp;</span><span class="ident" id="6863125">fakeDB</span><span class="op" id="6863131">{</span><span class="ident" id="6863132">name</span><span class="op" id="6863136">:</span>&nbsp;<span class="ident" id="6863138">name</span><span class="op" id="6863142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6863146">d</span><span class="op" id="6863147">.</span><span class="ident" id="6863148">dbs</span><span class="op" id="6863151">[</span><span class="ident" id="6863152">name</span><span class="op" id="6863156">]</span>&nbsp;<span class="op" id="6863158">=</span>&nbsp;<span class="ident" id="6863160">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6863164">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6863167">return</span>&nbsp;<span class="ident" id="6863174">db</span><br>
<span class="lineno"></span><span class="op" id="6863177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6863180">func</span>&nbsp;<span class="op" id="6863185">(</span><span class="ident" id="6863186">db</span>&nbsp;<span class="op" id="6863189">*</span><span class="ident" id="6863190">fakeDB</span><span class="op" id="6863196">)</span>&nbsp;<span class="ident" id="6863198">wipe</span><span class="op" id="6863202">(</span><span class="op" id="6863203">)</span>&nbsp;<span class="op" id="6863205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6863208">db</span><span class="op" id="6863210">.</span><span class="ident" id="6863211">mu</span><span class="op" id="6863213">.</span><span class="ident" id="6863214">Lock</span><span class="op" id="6863218">(</span><span class="op" id="6863219">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6863222">defer</span>&nbsp;<span class="ident" id="6863228">db</span><span class="op" id="6863230">.</span><span class="ident" id="6863231">mu</span><span class="op" id="6863233">.</span><span class="ident" id="6863234">Unlock</span><span class="op" id="6863240">(</span><span class="op" id="6863241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6863244">db</span><span class="op" id="6863246">.</span><span class="ident" id="6863247">tables</span>&nbsp;<span class="op" id="6863254">=</span>&nbsp;<span class="ident" id="6863256">nil</span><br>
<span class="lineno"></span><span class="op" id="6863260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6863263">func</span>&nbsp;<span class="op" id="6863268">(</span><span class="ident" id="6863269">db</span>&nbsp;<span class="op" id="6863272">*</span><span class="ident" id="6863273">fakeDB</span><span class="op" id="6863279">)</span>&nbsp;<span class="ident" id="6863281">createTable</span><span class="op" id="6863292">(</span><span class="ident" id="6863293">name</span>&nbsp;<span class="builtintype" id="6863298">string</span><span class="op" id="6863304">,</span>&nbsp;<span class="ident" id="6863306">columnNames</span><span class="op" id="6863317">,</span>&nbsp;<span class="ident" id="6863319">columnTypes</span>&nbsp;<span class="op" id="6863331">[</span><span class="op" id="6863332">]</span><span class="builtintype" id="6863333">string</span><span class="op" id="6863339">)</span>&nbsp;<span class="builtintype" id="6863341">error</span>&nbsp;<span class="op" id="6863347">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6863350">db</span><span class="op" id="6863352">.</span><span class="ident" id="6863353">mu</span><span class="op" id="6863355">.</span><span class="ident" id="6863356">Lock</span><span class="op" id="6863360">(</span><span class="op" id="6863361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6863364">defer</span>&nbsp;<span class="ident" id="6863370">db</span><span class="op" id="6863372">.</span><span class="ident" id="6863373">mu</span><span class="op" id="6863375">.</span><span class="ident" id="6863376">Unlock</span><span class="op" id="6863382">(</span><span class="op" id="6863383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6863386">if</span>&nbsp;<span class="ident" id="6863389">db</span><span class="op" id="6863391">.</span><span class="ident" id="6863392">tables</span>&nbsp;<span class="op" id="6863399">==</span>&nbsp;<span class="ident" id="6863402">nil</span>&nbsp;<span class="op" id="6863406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6863410">db</span><span class="op" id="6863412">.</span><span class="ident" id="6863413">tables</span>&nbsp;<span class="op" id="6863420">=</span>&nbsp;<span class="builtinfunc" id="6863422">make</span><span class="op" id="6863426">(</span><span class="keyword" id="6863427">map</span><span class="op" id="6863430">[</span><span class="builtintype" id="6863431">string</span><span class="op" id="6863437">]</span><span class="op" id="6863438">*</span><span class="ident" id="6863439">table</span><span class="op" id="6863444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6863447">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6863450">if</span>&nbsp;<span class="ident" id="6863453">_</span><span class="op" id="6863454">,</span>&nbsp;<span class="ident" id="6863456">exist</span>&nbsp;<span class="op" id="6863462">:=</span>&nbsp;<span class="ident" id="6863465">db</span><span class="op" id="6863467">.</span><span class="ident" id="6863468">tables</span><span class="op" id="6863474">[</span><span class="ident" id="6863475">name</span><span class="op" id="6863479">]</span><span class="op" id="6863480">;</span>&nbsp;<span class="ident" id="6863482">exist</span>&nbsp;<span class="op" id="6863488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6863492">return</span>&nbsp;<span class="ident" id="6863499">fmt</span><span class="op" id="6863502">.</span><span class="ident" id="6863503">Errorf</span><span class="op" id="6863509">(</span><span class="string" id="6863510">&#34;table&nbsp;%q&nbsp;already&nbsp;exists&#34;</span><span class="op" id="6863535">,</span>&nbsp;<span class="ident" id="6863537">name</span><span class="op" id="6863541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6863544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6863547">if</span>&nbsp;<span class="builtinfunc" id="6863550">len</span><span class="op" id="6863553">(</span><span class="ident" id="6863554">columnNames</span><span class="op" id="6863565">)</span>&nbsp;<span class="op" id="6863567">!=</span>&nbsp;<span class="builtinfunc" id="6863570">len</span><span class="op" id="6863573">(</span><span class="ident" id="6863574">columnTypes</span><span class="op" id="6863585">)</span>&nbsp;<span class="op" id="6863587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6863591">return</span>&nbsp;<span class="ident" id="6863598">fmt</span><span class="op" id="6863601">.</span><span class="ident" id="6863602">Errorf</span><span class="op" id="6863608">(</span><span class="string" id="6863609">&#34;create&nbsp;table&nbsp;of&nbsp;%q&nbsp;len(names)&nbsp;!=&nbsp;len(types):&nbsp;%d&nbsp;vs&nbsp;%d&#34;</span><span class="op" id="6863664">,</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6863669">name</span><span class="op" id="6863673">,</span>&nbsp;<span class="builtinfunc" id="6863675">len</span><span class="op" id="6863678">(</span><span class="ident" id="6863679">columnNames</span><span class="op" id="6863690">)</span><span class="op" id="6863691">,</span>&nbsp;<span class="builtinfunc" id="6863693">len</span><span class="op" id="6863696">(</span><span class="ident" id="6863697">columnTypes</span><span class="op" id="6863708">)</span><span class="op" id="6863709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6863712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6863715">db</span><span class="op" id="6863717">.</span><span class="ident" id="6863718">tables</span><span class="op" id="6863724">[</span><span class="ident" id="6863725">name</span><span class="op" id="6863729">]</span>&nbsp;<span class="op" id="6863731">=</span>&nbsp;<span class="op" id="6863733">&amp;</span><span class="ident" id="6863734">table</span><span class="op" id="6863739">{</span><span class="ident" id="6863740">colname</span><span class="op" id="6863747">:</span>&nbsp;<span class="ident" id="6863749">columnNames</span><span class="op" id="6863760">,</span>&nbsp;<span class="ident" id="6863762">coltype</span><span class="op" id="6863769">:</span>&nbsp;<span class="ident" id="6863771">columnTypes</span><span class="op" id="6863782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6863785">return</span>&nbsp;<span class="ident" id="6863792">nil</span><br>
<span class="lineno"></span><span class="op" id="6863796">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="6863799">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;db.mu&nbsp;lock&nbsp;held</span><br>
<span class="lineno"></span><span class="keyword" id="6863838">func</span>&nbsp;<span class="op" id="6863843">(</span><span class="ident" id="6863844">db</span>&nbsp;<span class="op" id="6863847">*</span><span class="ident" id="6863848">fakeDB</span><span class="op" id="6863854">)</span>&nbsp;<span class="ident" id="6863856">table</span><span class="op" id="6863861">(</span><span class="ident" id="6863862">table</span>&nbsp;<span class="builtintype" id="6863868">string</span><span class="op" id="6863874">)</span>&nbsp;<span class="op" id="6863876">(</span><span class="op" id="6863877">*</span><span class="ident" id="6863878">table</span><span class="op" id="6863883">,</span>&nbsp;<span class="builtintype" id="6863885">bool</span><span class="op" id="6863889">)</span>&nbsp;<span class="op" id="6863891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6863894">if</span>&nbsp;<span class="ident" id="6863897">db</span><span class="op" id="6863899">.</span><span class="ident" id="6863900">tables</span>&nbsp;<span class="op" id="6863907">==</span>&nbsp;<span class="ident" id="6863910">nil</span>&nbsp;<span class="op" id="6863914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6863918">return</span>&nbsp;<span class="ident" id="6863925">nil</span><span class="op" id="6863928">,</span>&nbsp;<span class="builtintype" id="6863930">false</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6863937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6863940">t</span><span class="op" id="6863941">,</span>&nbsp;<span class="ident" id="6863943">ok</span>&nbsp;<span class="op" id="6863946">:=</span>&nbsp;<span class="ident" id="6863949">db</span><span class="op" id="6863951">.</span><span class="ident" id="6863952">tables</span><span class="op" id="6863958">[</span><span class="ident" id="6863959">table</span><span class="op" id="6863964">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6863967">return</span>&nbsp;<span class="ident" id="6863974">t</span><span class="op" id="6863975">,</span>&nbsp;<span class="ident" id="6863977">ok</span><br>
<span class="lineno"></span><span class="op" id="6863980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="6863983">func</span>&nbsp;<span class="op" id="6863988">(</span><span class="ident" id="6863989">db</span>&nbsp;<span class="op" id="6863992">*</span><span class="ident" id="6863993">fakeDB</span><span class="op" id="6863999">)</span>&nbsp;<span class="ident" id="6864001">columnType</span><span class="op" id="6864011">(</span><span class="ident" id="6864012">table</span><span class="op" id="6864017">,</span>&nbsp;<span class="ident" id="6864019">column</span>&nbsp;<span class="builtintype" id="6864026">string</span><span class="op" id="6864032">)</span>&nbsp;<span class="op" id="6864034">(</span><span class="ident" id="6864035">typ</span>&nbsp;<span class="builtintype" id="6864039">string</span><span class="op" id="6864045">,</span>&nbsp;<span class="ident" id="6864047">ok</span>&nbsp;<span class="builtintype" id="6864050">bool</span><span class="op" id="6864054">)</span>&nbsp;<span class="op" id="6864056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6864059">db</span><span class="op" id="6864061">.</span><span class="ident" id="6864062">mu</span><span class="op" id="6864064">.</span><span class="ident" id="6864065">Lock</span><span class="op" id="6864069">(</span><span class="op" id="6864070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6864073">defer</span>&nbsp;<span class="ident" id="6864079">db</span><span class="op" id="6864081">.</span><span class="ident" id="6864082">mu</span><span class="op" id="6864084">.</span><span class="ident" id="6864085">Unlock</span><span class="op" id="6864091">(</span><span class="op" id="6864092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6864095">t</span><span class="op" id="6864096">,</span>&nbsp;<span class="ident" id="6864098">ok</span>&nbsp;<span class="op" id="6864101">:=</span>&nbsp;<span class="ident" id="6864104">db</span><span class="op" id="6864106">.</span><span class="ident" id="6864107">table</span><span class="op" id="6864112">(</span><span class="ident" id="6864113">table</span><span class="op" id="6864118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6864121">if</span>&nbsp;<span class="op" id="6864124">!</span><span class="ident" id="6864125">ok</span>&nbsp;<span class="op" id="6864128">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6864132">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6864140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6864143">for</span>&nbsp;<span class="ident" id="6864147">n</span><span class="op" id="6864148">,</span>&nbsp;<span class="ident" id="6864150">cname</span>&nbsp;<span class="op" id="6864156">:=</span>&nbsp;<span class="keyword" id="6864159">range</span>&nbsp;<span class="ident" id="6864165">t</span><span class="op" id="6864166">.</span><span class="ident" id="6864167">colname</span>&nbsp;<span class="op" id="6864175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6864179">if</span>&nbsp;<span class="ident" id="6864182">cname</span>&nbsp;<span class="op" id="6864188">==</span>&nbsp;<span class="ident" id="6864191">column</span>&nbsp;<span class="op" id="6864198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6864203">return</span>&nbsp;<span class="ident" id="6864210">t</span><span class="op" id="6864211">.</span><span class="ident" id="6864212">coltype</span><span class="op" id="6864219">[</span><span class="ident" id="6864220">n</span><span class="op" id="6864221">]</span><span class="op" id="6864222">,</span>&nbsp;<span class="builtintype" id="6864224">true</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6864231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6864234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6864237">return</span>&nbsp;<span class="string" id="6864244">&#34;&#34;</span><span class="op" id="6864246">,</span>&nbsp;<span class="builtintype" id="6864248">false</span><br>
<span class="lineno"></span><span class="op" id="6864254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="keyword" id="6864257">func</span>&nbsp;<span class="op" id="6864262">(</span><span class="ident" id="6864263">c</span>&nbsp;<span class="op" id="6864265">*</span><span class="ident" id="6864266">fakeConn</span><span class="op" id="6864274">)</span>&nbsp;<span class="ident" id="6864276">isBad</span><span class="op" id="6864281">(</span><span class="op" id="6864282">)</span>&nbsp;<span class="builtintype" id="6864284">bool</span>&nbsp;<span class="op" id="6864289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6864292">//&nbsp;if&nbsp;not&nbsp;simulating&nbsp;bad&nbsp;conn,&nbsp;do&nbsp;nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6864335">if</span>&nbsp;<span class="op" id="6864338">!</span><span class="ident" id="6864339">c</span><span class="op" id="6864340">.</span><span class="ident" id="6864341">bad</span>&nbsp;<span class="op" id="6864345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6864349">return</span>&nbsp;<span class="builtintype" id="6864356">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6864363">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6864366">//&nbsp;alternate&nbsp;between&nbsp;bad&nbsp;conn&nbsp;and&nbsp;not&nbsp;bad&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6864414">c</span><span class="op" id="6864415">.</span><span class="ident" id="6864416">db</span><span class="op" id="6864418">.</span><span class="ident" id="6864419">badConn</span>&nbsp;<span class="op" id="6864427">=</span>&nbsp;<span class="op" id="6864429">!</span><span class="ident" id="6864430">c</span><span class="op" id="6864431">.</span><span class="ident" id="6864432">db</span><span class="op" id="6864434">.</span><span class="ident" id="6864435">badConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6864444">return</span>&nbsp;<span class="ident" id="6864451">c</span><span class="op" id="6864452">.</span><span class="ident" id="6864453">db</span><span class="op" id="6864455">.</span><span class="ident" id="6864456">badConn</span><br>
<span class="lineno"></span><span class="op" id="6864464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="6864467">func</span>&nbsp;<span class="op" id="6864472">(</span><span class="ident" id="6864473">c</span>&nbsp;<span class="op" id="6864475">*</span><span class="ident" id="6864476">fakeConn</span><span class="op" id="6864484">)</span>&nbsp;<span class="ident" id="6864486">Begin</span><span class="op" id="6864491">(</span><span class="op" id="6864492">)</span>&nbsp;<span class="op" id="6864494">(</span><span class="ident" id="6864495">driver</span><span class="op" id="6864501">.</span><span class="ident" id="6864502">Tx</span><span class="op" id="6864504">,</span>&nbsp;<span class="builtintype" id="6864506">error</span><span class="op" id="6864511">)</span>&nbsp;<span class="op" id="6864513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6864516">if</span>&nbsp;<span class="ident" id="6864519">c</span><span class="op" id="6864520">.</span><span class="ident" id="6864521">isBad</span><span class="op" id="6864526">(</span><span class="op" id="6864527">)</span>&nbsp;<span class="op" id="6864529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6864533">return</span>&nbsp;<span class="ident" id="6864540">nil</span><span class="op" id="6864543">,</span>&nbsp;<span class="ident" id="6864545">driver</span><span class="op" id="6864551">.</span><span class="ident" id="6864552">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6864564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6864567">if</span>&nbsp;<span class="ident" id="6864570">c</span><span class="op" id="6864571">.</span><span class="ident" id="6864572">currTx</span>&nbsp;<span class="op" id="6864579">!=</span>&nbsp;<span class="ident" id="6864582">nil</span>&nbsp;<span class="op" id="6864586">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6864590">return</span>&nbsp;<span class="ident" id="6864597">nil</span><span class="op" id="6864600">,</span>&nbsp;<span class="ident" id="6864602">errors</span><span class="op" id="6864608">.</span><span class="ident" id="6864609">New</span><span class="op" id="6864612">(</span><span class="string" id="6864613">&#34;already&nbsp;in&nbsp;a&nbsp;transaction&#34;</span><span class="op" id="6864639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6864642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6864645">c</span><span class="op" id="6864646">.</span><span class="ident" id="6864647">currTx</span>&nbsp;<span class="op" id="6864654">=</span>&nbsp;<span class="op" id="6864656">&amp;</span><span class="ident" id="6864657">fakeTx</span><span class="op" id="6864663">{</span><span class="ident" id="6864664">c</span><span class="op" id="6864665">:</span>&nbsp;<span class="ident" id="6864667">c</span><span class="op" id="6864668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6864671">return</span>&nbsp;<span class="ident" id="6864678">c</span><span class="op" id="6864679">.</span><span class="ident" id="6864680">currTx</span><span class="op" id="6864686">,</span>&nbsp;<span class="ident" id="6864688">nil</span><br>
<span class="lineno"></span><span class="op" id="6864692">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="6864695">var</span>&nbsp;<span class="ident" id="6864699">hookPostCloseConn</span>&nbsp;<span class="keyword" id="6864717">struct</span>&nbsp;<span class="op" id="6864724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6864727">sync</span><span class="op" id="6864731">.</span><span class="ident" id="6864732">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6864739">fn</span>&nbsp;<span class="keyword" id="6864742">func</span><span class="op" id="6864746">(</span><span class="op" id="6864747">*</span><span class="ident" id="6864748">fakeConn</span><span class="op" id="6864756">,</span>&nbsp;<span class="builtintype" id="6864758">error</span><span class="op" id="6864763">)</span><br>
<span class="lineno"></span><span class="op" id="6864765">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="6864768">func</span>&nbsp;<span class="ident" id="6864773">setHookpostCloseConn</span><span class="op" id="6864793">(</span><span class="ident" id="6864794">fn</span>&nbsp;<span class="keyword" id="6864797">func</span><span class="op" id="6864801">(</span><span class="op" id="6864802">*</span><span class="ident" id="6864803">fakeConn</span><span class="op" id="6864811">,</span>&nbsp;<span class="builtintype" id="6864813">error</span><span class="op" id="6864818">)</span><span class="op" id="6864819">)</span>&nbsp;<span class="op" id="6864821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6864824">hookPostCloseConn</span><span class="op" id="6864841">.</span><span class="ident" id="6864842">Lock</span><span class="op" id="6864846">(</span><span class="op" id="6864847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6864850">defer</span>&nbsp;<span class="ident" id="6864856">hookPostCloseConn</span><span class="op" id="6864873">.</span><span class="ident" id="6864874">Unlock</span><span class="op" id="6864880">(</span><span class="op" id="6864881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6864884">hookPostCloseConn</span><span class="op" id="6864901">.</span><span class="ident" id="6864902">fn</span>&nbsp;<span class="op" id="6864905">=</span>&nbsp;<span class="ident" id="6864907">fn</span><br>
<span class="lineno">275</span><span class="op" id="6864910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6864913">var</span>&nbsp;<span class="ident" id="6864917">testStrictClose</span>&nbsp;<span class="op" id="6864933">*</span><span class="ident" id="6864934">testing</span><span class="op" id="6864941">.</span><span class="ident" id="6864942">T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6864945">//&nbsp;setStrictFakeConnClose&nbsp;sets&nbsp;the&nbsp;t&nbsp;to&nbsp;Errorf&nbsp;on&nbsp;when&nbsp;fakeConn.Close</span><br>
<span class="lineno">280</span><span class="comment" id="6865015">//&nbsp;fails&nbsp;to&nbsp;close.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;check&nbsp;is&nbsp;disabled.</span><br>
<span class="lineno"></span><span class="keyword" id="6865065">func</span>&nbsp;<span class="ident" id="6865070">setStrictFakeConnClose</span><span class="op" id="6865092">(</span><span class="ident" id="6865093">t</span>&nbsp;<span class="op" id="6865095">*</span><span class="ident" id="6865096">testing</span><span class="op" id="6865103">.</span><span class="ident" id="6865104">T</span><span class="op" id="6865105">)</span>&nbsp;<span class="op" id="6865107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6865110">testStrictClose</span>&nbsp;<span class="op" id="6865126">=</span>&nbsp;<span class="ident" id="6865128">t</span><br>
<span class="lineno"></span><span class="op" id="6865130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="6865133">func</span>&nbsp;<span class="op" id="6865138">(</span><span class="ident" id="6865139">c</span>&nbsp;<span class="op" id="6865141">*</span><span class="ident" id="6865142">fakeConn</span><span class="op" id="6865150">)</span>&nbsp;<span class="ident" id="6865152">Close</span><span class="op" id="6865157">(</span><span class="op" id="6865158">)</span>&nbsp;<span class="op" id="6865160">(</span><span class="ident" id="6865161">err</span>&nbsp;<span class="builtintype" id="6865165">error</span><span class="op" id="6865170">)</span>&nbsp;<span class="op" id="6865172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6865175">drv</span>&nbsp;<span class="op" id="6865179">:=</span>&nbsp;<span class="ident" id="6865182">fdriver</span><span class="op" id="6865189">.</span><span class="op" id="6865190">(</span><span class="op" id="6865191">*</span><span class="ident" id="6865192">fakeDriver</span><span class="op" id="6865202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6865205">defer</span>&nbsp;<span class="keyword" id="6865211">func</span><span class="op" id="6865215">(</span><span class="op" id="6865216">)</span>&nbsp;<span class="op" id="6865218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6865222">if</span>&nbsp;<span class="ident" id="6865225">err</span>&nbsp;<span class="op" id="6865229">!=</span>&nbsp;<span class="ident" id="6865232">nil</span>&nbsp;<span class="op" id="6865236">&amp;&amp;</span>&nbsp;<span class="ident" id="6865239">testStrictClose</span>&nbsp;<span class="op" id="6865255">!=</span>&nbsp;<span class="ident" id="6865258">nil</span>&nbsp;<span class="op" id="6865262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6865267">testStrictClose</span><span class="op" id="6865282">.</span><span class="ident" id="6865283">Errorf</span><span class="op" id="6865289">(</span><span class="string" id="6865290">&#34;failed&nbsp;to&nbsp;close&nbsp;a&nbsp;test&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="6865327">,</span>&nbsp;<span class="ident" id="6865329">err</span><span class="op" id="6865332">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6865336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6865340">hookPostCloseConn</span><span class="op" id="6865357">.</span><span class="ident" id="6865358">Lock</span><span class="op" id="6865362">(</span><span class="op" id="6865363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6865367">fn</span>&nbsp;<span class="op" id="6865370">:=</span>&nbsp;<span class="ident" id="6865373">hookPostCloseConn</span><span class="op" id="6865390">.</span><span class="ident" id="6865391">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6865396">hookPostCloseConn</span><span class="op" id="6865413">.</span><span class="ident" id="6865414">Unlock</span><span class="op" id="6865420">(</span><span class="op" id="6865421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6865425">if</span>&nbsp;<span class="ident" id="6865428">fn</span>&nbsp;<span class="op" id="6865431">!=</span>&nbsp;<span class="ident" id="6865434">nil</span>&nbsp;<span class="op" id="6865438">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6865443">fn</span><span class="op" id="6865445">(</span><span class="ident" id="6865446">c</span><span class="op" id="6865447">,</span>&nbsp;<span class="ident" id="6865449">err</span><span class="op" id="6865452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6865456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6865460">if</span>&nbsp;<span class="ident" id="6865463">err</span>&nbsp;<span class="op" id="6865467">==</span>&nbsp;<span class="ident" id="6865470">nil</span>&nbsp;<span class="op" id="6865474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6865479">drv</span><span class="op" id="6865482">.</span><span class="ident" id="6865483">mu</span><span class="op" id="6865485">.</span><span class="ident" id="6865486">Lock</span><span class="op" id="6865490">(</span><span class="op" id="6865491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6865496">drv</span><span class="op" id="6865499">.</span><span class="ident" id="6865500">closeCount</span><span class="op" id="6865510">++</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6865516">drv</span><span class="op" id="6865519">.</span><span class="ident" id="6865520">mu</span><span class="op" id="6865522">.</span><span class="ident" id="6865523">Unlock</span><span class="op" id="6865529">(</span><span class="op" id="6865530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6865534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6865537">}</span><span class="op" id="6865538">(</span><span class="op" id="6865539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6865542">if</span>&nbsp;<span class="ident" id="6865545">c</span><span class="op" id="6865546">.</span><span class="ident" id="6865547">currTx</span>&nbsp;<span class="op" id="6865554">!=</span>&nbsp;<span class="ident" id="6865557">nil</span>&nbsp;<span class="op" id="6865561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6865565">return</span>&nbsp;<span class="ident" id="6865572">errors</span><span class="op" id="6865578">.</span><span class="ident" id="6865579">New</span><span class="op" id="6865582">(</span><span class="string" id="6865583">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;in&nbsp;a&nbsp;Transaction&#34;</span><span class="op" id="6865623">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6865626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6865629">if</span>&nbsp;<span class="ident" id="6865632">c</span><span class="op" id="6865633">.</span><span class="ident" id="6865634">db</span>&nbsp;<span class="op" id="6865637">==</span>&nbsp;<span class="ident" id="6865640">nil</span>&nbsp;<span class="op" id="6865644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6865648">return</span>&nbsp;<span class="ident" id="6865655">errors</span><span class="op" id="6865661">.</span><span class="ident" id="6865662">New</span><span class="op" id="6865665">(</span><span class="string" id="6865666">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;already&nbsp;closed&#34;</span><span class="op" id="6865704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6865707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6865710">if</span>&nbsp;<span class="ident" id="6865713">c</span><span class="op" id="6865714">.</span><span class="ident" id="6865715">stmtsMade</span>&nbsp;<span class="op" id="6865725">&gt;</span>&nbsp;<span class="ident" id="6865727">c</span><span class="op" id="6865728">.</span><span class="ident" id="6865729">stmtsClosed</span>&nbsp;<span class="op" id="6865741">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6865745">return</span>&nbsp;<span class="ident" id="6865752">errors</span><span class="op" id="6865758">.</span><span class="ident" id="6865759">New</span><span class="op" id="6865762">(</span><span class="string" id="6865763">&#34;can&#39;t&nbsp;close;&nbsp;dangling&nbsp;statement(s)&#34;</span><span class="op" id="6865799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6865802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6865805">c</span><span class="op" id="6865806">.</span><span class="ident" id="6865807">db</span>&nbsp;<span class="op" id="6865810">=</span>&nbsp;<span class="ident" id="6865812">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6865817">return</span>&nbsp;<span class="ident" id="6865824">nil</span><br>
<span class="lineno"></span><span class="op" id="6865828">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="6865831">func</span>&nbsp;<span class="ident" id="6865836">checkSubsetTypes</span><span class="op" id="6865852">(</span><span class="ident" id="6865853">args</span>&nbsp;<span class="op" id="6865858">[</span><span class="op" id="6865859">]</span><span class="ident" id="6865860">driver</span><span class="op" id="6865866">.</span><span class="ident" id="6865867">Value</span><span class="op" id="6865872">)</span>&nbsp;<span class="builtintype" id="6865874">error</span>&nbsp;<span class="op" id="6865880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6865883">for</span>&nbsp;<span class="ident" id="6865887">n</span><span class="op" id="6865888">,</span>&nbsp;<span class="ident" id="6865890">arg</span>&nbsp;<span class="op" id="6865894">:=</span>&nbsp;<span class="keyword" id="6865897">range</span>&nbsp;<span class="ident" id="6865903">args</span>&nbsp;<span class="op" id="6865908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6865912">switch</span>&nbsp;<span class="ident" id="6865919">arg</span><span class="op" id="6865922">.</span><span class="op" id="6865923">(</span><span class="keyword" id="6865924">type</span><span class="op" id="6865928">)</span>&nbsp;<span class="op" id="6865930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6865934">case</span>&nbsp;<span class="ident" id="6865939">int64</span><span class="op" id="6865944">,</span>&nbsp;<span class="builtintype" id="6865946">float64</span><span class="op" id="6865953">,</span>&nbsp;<span class="builtintype" id="6865955">bool</span><span class="op" id="6865959">,</span>&nbsp;<span class="ident" id="6865961">nil</span><span class="op" id="6865964">,</span>&nbsp;<span class="op" id="6865966">[</span><span class="op" id="6865967">]</span><span class="builtintype" id="6865968">byte</span><span class="op" id="6865972">,</span>&nbsp;<span class="builtintype" id="6865974">string</span><span class="op" id="6865980">,</span>&nbsp;<span class="ident" id="6865982">time</span><span class="op" id="6865986">.</span><span class="ident" id="6865987">Time</span><span class="op" id="6865991">:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6865995">default</span><span class="op" id="6866002">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6866007">return</span>&nbsp;<span class="ident" id="6866014">fmt</span><span class="op" id="6866017">.</span><span class="ident" id="6866018">Errorf</span><span class="op" id="6866024">(</span><span class="string" id="6866025">&#34;fakedb_test:&nbsp;invalid&nbsp;argument&nbsp;#%d:&nbsp;%v,&nbsp;type&nbsp;%T&#34;</span><span class="op" id="6866073">,</span>&nbsp;<span class="ident" id="6866075">n</span><span class="op" id="6866076">+</span><span class="num" id="6866077">1</span><span class="op" id="6866078">,</span>&nbsp;<span class="ident" id="6866080">arg</span><span class="op" id="6866083">,</span>&nbsp;<span class="ident" id="6866085">arg</span><span class="op" id="6866088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6866092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6866095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6866098">return</span>&nbsp;<span class="ident" id="6866105">nil</span><br>
<span class="lineno">325</span><span class="op" id="6866109">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6866112">func</span>&nbsp;<span class="op" id="6866117">(</span><span class="ident" id="6866118">c</span>&nbsp;<span class="op" id="6866120">*</span><span class="ident" id="6866121">fakeConn</span><span class="op" id="6866129">)</span>&nbsp;<span class="ident" id="6866131">Exec</span><span class="op" id="6866135">(</span><span class="ident" id="6866136">query</span>&nbsp;<span class="builtintype" id="6866142">string</span><span class="op" id="6866148">,</span>&nbsp;<span class="ident" id="6866150">args</span>&nbsp;<span class="op" id="6866155">[</span><span class="op" id="6866156">]</span><span class="ident" id="6866157">driver</span><span class="op" id="6866163">.</span><span class="ident" id="6866164">Value</span><span class="op" id="6866169">)</span>&nbsp;<span class="op" id="6866171">(</span><span class="ident" id="6866172">driver</span><span class="op" id="6866178">.</span><span class="ident" id="6866179">Result</span><span class="op" id="6866185">,</span>&nbsp;<span class="builtintype" id="6866187">error</span><span class="op" id="6866192">)</span>&nbsp;<span class="op" id="6866194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6866197">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6866258">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6866319">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6866378">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6866405">err</span>&nbsp;<span class="op" id="6866409">:=</span>&nbsp;<span class="ident" id="6866412">checkSubsetTypes</span><span class="op" id="6866428">(</span><span class="ident" id="6866429">args</span><span class="op" id="6866433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6866436">if</span>&nbsp;<span class="ident" id="6866439">err</span>&nbsp;<span class="op" id="6866443">!=</span>&nbsp;<span class="ident" id="6866446">nil</span>&nbsp;<span class="op" id="6866450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6866454">return</span>&nbsp;<span class="ident" id="6866461">nil</span><span class="op" id="6866464">,</span>&nbsp;<span class="ident" id="6866466">err</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6866471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6866474">return</span>&nbsp;<span class="ident" id="6866481">nil</span><span class="op" id="6866484">,</span>&nbsp;<span class="ident" id="6866486">driver</span><span class="op" id="6866492">.</span><span class="ident" id="6866493">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="6866501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6866504">func</span>&nbsp;<span class="op" id="6866509">(</span><span class="ident" id="6866510">c</span>&nbsp;<span class="op" id="6866512">*</span><span class="ident" id="6866513">fakeConn</span><span class="op" id="6866521">)</span>&nbsp;<span class="ident" id="6866523">Query</span><span class="op" id="6866528">(</span><span class="ident" id="6866529">query</span>&nbsp;<span class="builtintype" id="6866535">string</span><span class="op" id="6866541">,</span>&nbsp;<span class="ident" id="6866543">args</span>&nbsp;<span class="op" id="6866548">[</span><span class="op" id="6866549">]</span><span class="ident" id="6866550">driver</span><span class="op" id="6866556">.</span><span class="ident" id="6866557">Value</span><span class="op" id="6866562">)</span>&nbsp;<span class="op" id="6866564">(</span><span class="ident" id="6866565">driver</span><span class="op" id="6866571">.</span><span class="ident" id="6866572">Rows</span><span class="op" id="6866576">,</span>&nbsp;<span class="builtintype" id="6866578">error</span><span class="op" id="6866583">)</span>&nbsp;<span class="op" id="6866585">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6866588">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6866649">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6866710">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6866769">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6866796">err</span>&nbsp;<span class="op" id="6866800">:=</span>&nbsp;<span class="ident" id="6866803">checkSubsetTypes</span><span class="op" id="6866819">(</span><span class="ident" id="6866820">args</span><span class="op" id="6866824">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6866827">if</span>&nbsp;<span class="ident" id="6866830">err</span>&nbsp;<span class="op" id="6866834">!=</span>&nbsp;<span class="ident" id="6866837">nil</span>&nbsp;<span class="op" id="6866841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6866845">return</span>&nbsp;<span class="ident" id="6866852">nil</span><span class="op" id="6866855">,</span>&nbsp;<span class="ident" id="6866857">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6866862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6866865">return</span>&nbsp;<span class="ident" id="6866872">nil</span><span class="op" id="6866875">,</span>&nbsp;<span class="ident" id="6866877">driver</span><span class="op" id="6866883">.</span><span class="ident" id="6866884">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="6866892">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="6866895">func</span>&nbsp;<span class="ident" id="6866900">errf</span><span class="op" id="6866904">(</span><span class="ident" id="6866905">msg</span>&nbsp;<span class="builtintype" id="6866909">string</span><span class="op" id="6866915">,</span>&nbsp;<span class="ident" id="6866917">args</span>&nbsp;<span class="op" id="6866922">...</span><span class="keyword" id="6866925">interface</span><span class="op" id="6866934">{</span><span class="op" id="6866935">}</span><span class="op" id="6866936">)</span>&nbsp;<span class="builtintype" id="6866938">error</span>&nbsp;<span class="op" id="6866944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6866947">return</span>&nbsp;<span class="ident" id="6866954">errors</span><span class="op" id="6866960">.</span><span class="ident" id="6866961">New</span><span class="op" id="6866964">(</span><span class="string" id="6866965">&#34;fakedb:&nbsp;&#34;</span>&nbsp;<span class="op" id="6866976">+</span>&nbsp;<span class="ident" id="6866978">fmt</span><span class="op" id="6866981">.</span><span class="ident" id="6866982">Sprintf</span><span class="op" id="6866989">(</span><span class="ident" id="6866990">msg</span><span class="op" id="6866993">,</span>&nbsp;<span class="ident" id="6866995">args</span><span class="op" id="6866999">...</span><span class="op" id="6867002">)</span><span class="op" id="6867003">)</span><br>
<span class="lineno"></span><span class="op" id="6867005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="6867008">//&nbsp;parts&nbsp;are&nbsp;table|selectCol1,selectCol2|whereCol=?,whereCol2=?</span><br>
<span class="lineno"></span><span class="comment" id="6867072">//&nbsp;(note&nbsp;that&nbsp;where&nbsp;columns&nbsp;must&nbsp;always&nbsp;contain&nbsp;?&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="6867129">//&nbsp;&nbsp;just&nbsp;a&nbsp;limitation&nbsp;for&nbsp;fakedb)</span><br>
<span class="lineno"></span><span class="keyword" id="6867163">func</span>&nbsp;<span class="op" id="6867168">(</span><span class="ident" id="6867169">c</span>&nbsp;<span class="op" id="6867171">*</span><span class="ident" id="6867172">fakeConn</span><span class="op" id="6867180">)</span>&nbsp;<span class="ident" id="6867182">prepareSelect</span><span class="op" id="6867195">(</span><span class="ident" id="6867196">stmt</span>&nbsp;<span class="op" id="6867201">*</span><span class="ident" id="6867202">fakeStmt</span><span class="op" id="6867210">,</span>&nbsp;<span class="ident" id="6867212">parts</span>&nbsp;<span class="op" id="6867218">[</span><span class="op" id="6867219">]</span><span class="builtintype" id="6867220">string</span><span class="op" id="6867226">)</span>&nbsp;<span class="op" id="6867228">(</span><span class="ident" id="6867229">driver</span><span class="op" id="6867235">.</span><span class="ident" id="6867236">Stmt</span><span class="op" id="6867240">,</span>&nbsp;<span class="builtintype" id="6867242">error</span><span class="op" id="6867247">)</span>&nbsp;<span class="op" id="6867249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6867252">if</span>&nbsp;<span class="builtinfunc" id="6867255">len</span><span class="op" id="6867258">(</span><span class="ident" id="6867259">parts</span><span class="op" id="6867264">)</span>&nbsp;<span class="op" id="6867266">!=</span>&nbsp;<span class="num" id="6867269">3</span>&nbsp;<span class="op" id="6867271">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6867275">stmt</span><span class="op" id="6867279">.</span><span class="ident" id="6867280">Close</span><span class="op" id="6867285">(</span><span class="op" id="6867286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6867290">return</span>&nbsp;<span class="ident" id="6867297">nil</span><span class="op" id="6867300">,</span>&nbsp;<span class="ident" id="6867302">errf</span><span class="op" id="6867306">(</span><span class="string" id="6867307">&#34;invalid&nbsp;SELECT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;3&#34;</span><span class="op" id="6867352">,</span>&nbsp;<span class="builtinfunc" id="6867354">len</span><span class="op" id="6867357">(</span><span class="ident" id="6867358">parts</span><span class="op" id="6867363">)</span><span class="op" id="6867364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6867367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6867370">stmt</span><span class="op" id="6867374">.</span><span class="ident" id="6867375">table</span>&nbsp;<span class="op" id="6867381">=</span>&nbsp;<span class="ident" id="6867383">parts</span><span class="op" id="6867388">[</span><span class="num" id="6867389">0</span><span class="op" id="6867390">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6867393">stmt</span><span class="op" id="6867397">.</span><span class="ident" id="6867398">colName</span>&nbsp;<span class="op" id="6867406">=</span>&nbsp;<span class="ident" id="6867408">strings</span><span class="op" id="6867415">.</span><span class="ident" id="6867416">Split</span><span class="op" id="6867421">(</span><span class="ident" id="6867422">parts</span><span class="op" id="6867427">[</span><span class="num" id="6867428">1</span><span class="op" id="6867429">]</span><span class="op" id="6867430">,</span>&nbsp;<span class="string" id="6867432">&#34;,&#34;</span><span class="op" id="6867435">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6867438">for</span>&nbsp;<span class="ident" id="6867442">n</span><span class="op" id="6867443">,</span>&nbsp;<span class="ident" id="6867445">colspec</span>&nbsp;<span class="op" id="6867453">:=</span>&nbsp;<span class="keyword" id="6867456">range</span>&nbsp;<span class="ident" id="6867462">strings</span><span class="op" id="6867469">.</span><span class="ident" id="6867470">Split</span><span class="op" id="6867475">(</span><span class="ident" id="6867476">parts</span><span class="op" id="6867481">[</span><span class="num" id="6867482">2</span><span class="op" id="6867483">]</span><span class="op" id="6867484">,</span>&nbsp;<span class="string" id="6867486">&#34;,&#34;</span><span class="op" id="6867489">)</span>&nbsp;<span class="op" id="6867491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6867495">if</span>&nbsp;<span class="ident" id="6867498">colspec</span>&nbsp;<span class="op" id="6867506">==</span>&nbsp;<span class="string" id="6867509">&#34;&#34;</span>&nbsp;<span class="op" id="6867512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6867517">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6867528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6867532">nameVal</span>&nbsp;<span class="op" id="6867540">:=</span>&nbsp;<span class="ident" id="6867543">strings</span><span class="op" id="6867550">.</span><span class="ident" id="6867551">Split</span><span class="op" id="6867556">(</span><span class="ident" id="6867557">colspec</span><span class="op" id="6867564">,</span>&nbsp;<span class="string" id="6867566">&#34;=&#34;</span><span class="op" id="6867569">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6867573">if</span>&nbsp;<span class="builtinfunc" id="6867576">len</span><span class="op" id="6867579">(</span><span class="ident" id="6867580">nameVal</span><span class="op" id="6867587">)</span>&nbsp;<span class="op" id="6867589">!=</span>&nbsp;<span class="num" id="6867592">2</span>&nbsp;<span class="op" id="6867594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6867599">stmt</span><span class="op" id="6867603">.</span><span class="ident" id="6867604">Close</span><span class="op" id="6867609">(</span><span class="op" id="6867610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6867615">return</span>&nbsp;<span class="ident" id="6867622">nil</span><span class="op" id="6867625">,</span>&nbsp;<span class="ident" id="6867627">errf</span><span class="op" id="6867631">(</span><span class="string" id="6867632">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="6867693">,</span>&nbsp;<span class="ident" id="6867695">stmt</span><span class="op" id="6867699">.</span><span class="ident" id="6867700">table</span><span class="op" id="6867705">,</span>&nbsp;<span class="ident" id="6867707">colspec</span><span class="op" id="6867714">,</span>&nbsp;<span class="ident" id="6867716">n</span><span class="op" id="6867717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6867721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6867725">column</span><span class="op" id="6867731">,</span>&nbsp;<span class="ident" id="6867733">value</span>&nbsp;<span class="op" id="6867739">:=</span>&nbsp;<span class="ident" id="6867742">nameVal</span><span class="op" id="6867749">[</span><span class="num" id="6867750">0</span><span class="op" id="6867751">]</span><span class="op" id="6867752">,</span>&nbsp;<span class="ident" id="6867754">nameVal</span><span class="op" id="6867761">[</span><span class="num" id="6867762">1</span><span class="op" id="6867763">]</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6867767">_</span><span class="op" id="6867768">,</span>&nbsp;<span class="ident" id="6867770">ok</span>&nbsp;<span class="op" id="6867773">:=</span>&nbsp;<span class="ident" id="6867776">c</span><span class="op" id="6867777">.</span><span class="ident" id="6867778">db</span><span class="op" id="6867780">.</span><span class="ident" id="6867781">columnType</span><span class="op" id="6867791">(</span><span class="ident" id="6867792">stmt</span><span class="op" id="6867796">.</span><span class="ident" id="6867797">table</span><span class="op" id="6867802">,</span>&nbsp;<span class="ident" id="6867804">column</span><span class="op" id="6867810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6867814">if</span>&nbsp;<span class="op" id="6867817">!</span><span class="ident" id="6867818">ok</span>&nbsp;<span class="op" id="6867821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6867826">stmt</span><span class="op" id="6867830">.</span><span class="ident" id="6867831">Close</span><span class="op" id="6867836">(</span><span class="op" id="6867837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6867842">return</span>&nbsp;<span class="ident" id="6867849">nil</span><span class="op" id="6867852">,</span>&nbsp;<span class="ident" id="6867854">errf</span><span class="op" id="6867858">(</span><span class="string" id="6867859">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="6867913">,</span>&nbsp;<span class="ident" id="6867915">stmt</span><span class="op" id="6867919">.</span><span class="ident" id="6867920">table</span><span class="op" id="6867925">,</span>&nbsp;<span class="ident" id="6867927">column</span><span class="op" id="6867933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6867937">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6867941">if</span>&nbsp;<span class="ident" id="6867944">value</span>&nbsp;<span class="op" id="6867950">!=</span>&nbsp;<span class="string" id="6867953">&#34;?&#34;</span>&nbsp;<span class="op" id="6867957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6867962">stmt</span><span class="op" id="6867966">.</span><span class="ident" id="6867967">Close</span><span class="op" id="6867972">(</span><span class="op" id="6867973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6867978">return</span>&nbsp;<span class="ident" id="6867985">nil</span><span class="op" id="6867988">,</span>&nbsp;<span class="ident" id="6867990">errf</span><span class="op" id="6867994">(</span><span class="string" id="6867995">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;pre-bound&nbsp;value&nbsp;for&nbsp;where&nbsp;column&nbsp;%q;&nbsp;need&nbsp;a&nbsp;question&nbsp;mark&#34;</span><span class="op" id="6868077">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868083">stmt</span><span class="op" id="6868087">.</span><span class="ident" id="6868088">table</span><span class="op" id="6868093">,</span>&nbsp;<span class="ident" id="6868095">column</span><span class="op" id="6868101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6868105">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868109">stmt</span><span class="op" id="6868113">.</span><span class="ident" id="6868114">whereCol</span>&nbsp;<span class="op" id="6868123">=</span>&nbsp;<span class="builtinfunc" id="6868125">append</span><span class="op" id="6868131">(</span><span class="ident" id="6868132">stmt</span><span class="op" id="6868136">.</span><span class="ident" id="6868137">whereCol</span><span class="op" id="6868145">,</span>&nbsp;<span class="ident" id="6868147">column</span><span class="op" id="6868153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868157">stmt</span><span class="op" id="6868161">.</span><span class="ident" id="6868162">placeholders</span><span class="op" id="6868174">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6868178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6868181">return</span>&nbsp;<span class="ident" id="6868188">stmt</span><span class="op" id="6868192">,</span>&nbsp;<span class="ident" id="6868194">nil</span><br>
<span class="lineno"></span><span class="op" id="6868198">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span><span class="comment" id="6868201">//&nbsp;parts&nbsp;are&nbsp;table|col=type,col2=type2</span><br>
<span class="lineno"></span><span class="keyword" id="6868240">func</span>&nbsp;<span class="op" id="6868245">(</span><span class="ident" id="6868246">c</span>&nbsp;<span class="op" id="6868248">*</span><span class="ident" id="6868249">fakeConn</span><span class="op" id="6868257">)</span>&nbsp;<span class="ident" id="6868259">prepareCreate</span><span class="op" id="6868272">(</span><span class="ident" id="6868273">stmt</span>&nbsp;<span class="op" id="6868278">*</span><span class="ident" id="6868279">fakeStmt</span><span class="op" id="6868287">,</span>&nbsp;<span class="ident" id="6868289">parts</span>&nbsp;<span class="op" id="6868295">[</span><span class="op" id="6868296">]</span><span class="builtintype" id="6868297">string</span><span class="op" id="6868303">)</span>&nbsp;<span class="op" id="6868305">(</span><span class="ident" id="6868306">driver</span><span class="op" id="6868312">.</span><span class="ident" id="6868313">Stmt</span><span class="op" id="6868317">,</span>&nbsp;<span class="builtintype" id="6868319">error</span><span class="op" id="6868324">)</span>&nbsp;<span class="op" id="6868326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6868329">if</span>&nbsp;<span class="builtinfunc" id="6868332">len</span><span class="op" id="6868335">(</span><span class="ident" id="6868336">parts</span><span class="op" id="6868341">)</span>&nbsp;<span class="op" id="6868343">!=</span>&nbsp;<span class="num" id="6868346">2</span>&nbsp;<span class="op" id="6868348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868352">stmt</span><span class="op" id="6868356">.</span><span class="ident" id="6868357">Close</span><span class="op" id="6868362">(</span><span class="op" id="6868363">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6868367">return</span>&nbsp;<span class="ident" id="6868374">nil</span><span class="op" id="6868377">,</span>&nbsp;<span class="ident" id="6868379">errf</span><span class="op" id="6868383">(</span><span class="string" id="6868384">&#34;invalid&nbsp;CREATE&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="6868429">,</span>&nbsp;<span class="builtinfunc" id="6868431">len</span><span class="op" id="6868434">(</span><span class="ident" id="6868435">parts</span><span class="op" id="6868440">)</span><span class="op" id="6868441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6868444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868447">stmt</span><span class="op" id="6868451">.</span><span class="ident" id="6868452">table</span>&nbsp;<span class="op" id="6868458">=</span>&nbsp;<span class="ident" id="6868460">parts</span><span class="op" id="6868465">[</span><span class="num" id="6868466">0</span><span class="op" id="6868467">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6868470">for</span>&nbsp;<span class="ident" id="6868474">n</span><span class="op" id="6868475">,</span>&nbsp;<span class="ident" id="6868477">colspec</span>&nbsp;<span class="op" id="6868485">:=</span>&nbsp;<span class="keyword" id="6868488">range</span>&nbsp;<span class="ident" id="6868494">strings</span><span class="op" id="6868501">.</span><span class="ident" id="6868502">Split</span><span class="op" id="6868507">(</span><span class="ident" id="6868508">parts</span><span class="op" id="6868513">[</span><span class="num" id="6868514">1</span><span class="op" id="6868515">]</span><span class="op" id="6868516">,</span>&nbsp;<span class="string" id="6868518">&#34;,&#34;</span><span class="op" id="6868521">)</span>&nbsp;<span class="op" id="6868523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868527">nameType</span>&nbsp;<span class="op" id="6868536">:=</span>&nbsp;<span class="ident" id="6868539">strings</span><span class="op" id="6868546">.</span><span class="ident" id="6868547">Split</span><span class="op" id="6868552">(</span><span class="ident" id="6868553">colspec</span><span class="op" id="6868560">,</span>&nbsp;<span class="string" id="6868562">&#34;=&#34;</span><span class="op" id="6868565">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6868569">if</span>&nbsp;<span class="builtinfunc" id="6868572">len</span><span class="op" id="6868575">(</span><span class="ident" id="6868576">nameType</span><span class="op" id="6868584">)</span>&nbsp;<span class="op" id="6868586">!=</span>&nbsp;<span class="num" id="6868589">2</span>&nbsp;<span class="op" id="6868591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868596">stmt</span><span class="op" id="6868600">.</span><span class="ident" id="6868601">Close</span><span class="op" id="6868606">(</span><span class="op" id="6868607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6868612">return</span>&nbsp;<span class="ident" id="6868619">nil</span><span class="op" id="6868622">,</span>&nbsp;<span class="ident" id="6868624">errf</span><span class="op" id="6868628">(</span><span class="string" id="6868629">&#34;CREATE&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="6868687">,</span>&nbsp;<span class="ident" id="6868689">stmt</span><span class="op" id="6868693">.</span><span class="ident" id="6868694">table</span><span class="op" id="6868699">,</span>&nbsp;<span class="ident" id="6868701">colspec</span><span class="op" id="6868708">,</span>&nbsp;<span class="ident" id="6868710">n</span><span class="op" id="6868711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6868715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868719">stmt</span><span class="op" id="6868723">.</span><span class="ident" id="6868724">colName</span>&nbsp;<span class="op" id="6868732">=</span>&nbsp;<span class="builtinfunc" id="6868734">append</span><span class="op" id="6868740">(</span><span class="ident" id="6868741">stmt</span><span class="op" id="6868745">.</span><span class="ident" id="6868746">colName</span><span class="op" id="6868753">,</span>&nbsp;<span class="ident" id="6868755">nameType</span><span class="op" id="6868763">[</span><span class="num" id="6868764">0</span><span class="op" id="6868765">]</span><span class="op" id="6868766">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868770">stmt</span><span class="op" id="6868774">.</span><span class="ident" id="6868775">colType</span>&nbsp;<span class="op" id="6868783">=</span>&nbsp;<span class="builtinfunc" id="6868785">append</span><span class="op" id="6868791">(</span><span class="ident" id="6868792">stmt</span><span class="op" id="6868796">.</span><span class="ident" id="6868797">colType</span><span class="op" id="6868804">,</span>&nbsp;<span class="ident" id="6868806">nameType</span><span class="op" id="6868814">[</span><span class="num" id="6868815">1</span><span class="op" id="6868816">]</span><span class="op" id="6868817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6868820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6868823">return</span>&nbsp;<span class="ident" id="6868830">stmt</span><span class="op" id="6868834">,</span>&nbsp;<span class="ident" id="6868836">nil</span><br>
<span class="lineno"></span><span class="op" id="6868840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="6868843">//&nbsp;parts&nbsp;are&nbsp;table|col=?,col2=val</span><br>
<span class="lineno"></span><span class="keyword" id="6868877">func</span>&nbsp;<span class="op" id="6868882">(</span><span class="ident" id="6868883">c</span>&nbsp;<span class="op" id="6868885">*</span><span class="ident" id="6868886">fakeConn</span><span class="op" id="6868894">)</span>&nbsp;<span class="ident" id="6868896">prepareInsert</span><span class="op" id="6868909">(</span><span class="ident" id="6868910">stmt</span>&nbsp;<span class="op" id="6868915">*</span><span class="ident" id="6868916">fakeStmt</span><span class="op" id="6868924">,</span>&nbsp;<span class="ident" id="6868926">parts</span>&nbsp;<span class="op" id="6868932">[</span><span class="op" id="6868933">]</span><span class="builtintype" id="6868934">string</span><span class="op" id="6868940">)</span>&nbsp;<span class="op" id="6868942">(</span><span class="ident" id="6868943">driver</span><span class="op" id="6868949">.</span><span class="ident" id="6868950">Stmt</span><span class="op" id="6868954">,</span>&nbsp;<span class="builtintype" id="6868956">error</span><span class="op" id="6868961">)</span>&nbsp;<span class="op" id="6868963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6868966">if</span>&nbsp;<span class="builtinfunc" id="6868969">len</span><span class="op" id="6868972">(</span><span class="ident" id="6868973">parts</span><span class="op" id="6868978">)</span>&nbsp;<span class="op" id="6868980">!=</span>&nbsp;<span class="num" id="6868983">2</span>&nbsp;<span class="op" id="6868985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868989">stmt</span><span class="op" id="6868993">.</span><span class="ident" id="6868994">Close</span><span class="op" id="6868999">(</span><span class="op" id="6869000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869004">return</span>&nbsp;<span class="ident" id="6869011">nil</span><span class="op" id="6869014">,</span>&nbsp;<span class="ident" id="6869016">errf</span><span class="op" id="6869020">(</span><span class="string" id="6869021">&#34;invalid&nbsp;INSERT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="6869066">,</span>&nbsp;<span class="builtinfunc" id="6869068">len</span><span class="op" id="6869071">(</span><span class="ident" id="6869072">parts</span><span class="op" id="6869077">)</span><span class="op" id="6869078">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6869081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869084">stmt</span><span class="op" id="6869088">.</span><span class="ident" id="6869089">table</span>&nbsp;<span class="op" id="6869095">=</span>&nbsp;<span class="ident" id="6869097">parts</span><span class="op" id="6869102">[</span><span class="num" id="6869103">0</span><span class="op" id="6869104">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869107">for</span>&nbsp;<span class="ident" id="6869111">n</span><span class="op" id="6869112">,</span>&nbsp;<span class="ident" id="6869114">colspec</span>&nbsp;<span class="op" id="6869122">:=</span>&nbsp;<span class="keyword" id="6869125">range</span>&nbsp;<span class="ident" id="6869131">strings</span><span class="op" id="6869138">.</span><span class="ident" id="6869139">Split</span><span class="op" id="6869144">(</span><span class="ident" id="6869145">parts</span><span class="op" id="6869150">[</span><span class="num" id="6869151">1</span><span class="op" id="6869152">]</span><span class="op" id="6869153">,</span>&nbsp;<span class="string" id="6869155">&#34;,&#34;</span><span class="op" id="6869158">)</span>&nbsp;<span class="op" id="6869160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869164">nameVal</span>&nbsp;<span class="op" id="6869172">:=</span>&nbsp;<span class="ident" id="6869175">strings</span><span class="op" id="6869182">.</span><span class="ident" id="6869183">Split</span><span class="op" id="6869188">(</span><span class="ident" id="6869189">colspec</span><span class="op" id="6869196">,</span>&nbsp;<span class="string" id="6869198">&#34;=&#34;</span><span class="op" id="6869201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869205">if</span>&nbsp;<span class="builtinfunc" id="6869208">len</span><span class="op" id="6869211">(</span><span class="ident" id="6869212">nameVal</span><span class="op" id="6869219">)</span>&nbsp;<span class="op" id="6869221">!=</span>&nbsp;<span class="num" id="6869224">2</span>&nbsp;<span class="op" id="6869226">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869231">stmt</span><span class="op" id="6869235">.</span><span class="ident" id="6869236">Close</span><span class="op" id="6869241">(</span><span class="op" id="6869242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869247">return</span>&nbsp;<span class="ident" id="6869254">nil</span><span class="op" id="6869257">,</span>&nbsp;<span class="ident" id="6869259">errf</span><span class="op" id="6869263">(</span><span class="string" id="6869264">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="6869322">,</span>&nbsp;<span class="ident" id="6869324">stmt</span><span class="op" id="6869328">.</span><span class="ident" id="6869329">table</span><span class="op" id="6869334">,</span>&nbsp;<span class="ident" id="6869336">colspec</span><span class="op" id="6869343">,</span>&nbsp;<span class="ident" id="6869345">n</span><span class="op" id="6869346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6869350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869354">column</span><span class="op" id="6869360">,</span>&nbsp;<span class="ident" id="6869362">value</span>&nbsp;<span class="op" id="6869368">:=</span>&nbsp;<span class="ident" id="6869371">nameVal</span><span class="op" id="6869378">[</span><span class="num" id="6869379">0</span><span class="op" id="6869380">]</span><span class="op" id="6869381">,</span>&nbsp;<span class="ident" id="6869383">nameVal</span><span class="op" id="6869390">[</span><span class="num" id="6869391">1</span><span class="op" id="6869392">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869396">ctype</span><span class="op" id="6869401">,</span>&nbsp;<span class="ident" id="6869403">ok</span>&nbsp;<span class="op" id="6869406">:=</span>&nbsp;<span class="ident" id="6869409">c</span><span class="op" id="6869410">.</span><span class="ident" id="6869411">db</span><span class="op" id="6869413">.</span><span class="ident" id="6869414">columnType</span><span class="op" id="6869424">(</span><span class="ident" id="6869425">stmt</span><span class="op" id="6869429">.</span><span class="ident" id="6869430">table</span><span class="op" id="6869435">,</span>&nbsp;<span class="ident" id="6869437">column</span><span class="op" id="6869443">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869447">if</span>&nbsp;<span class="op" id="6869450">!</span><span class="ident" id="6869451">ok</span>&nbsp;<span class="op" id="6869454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869459">stmt</span><span class="op" id="6869463">.</span><span class="ident" id="6869464">Close</span><span class="op" id="6869469">(</span><span class="op" id="6869470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869475">return</span>&nbsp;<span class="ident" id="6869482">nil</span><span class="op" id="6869485">,</span>&nbsp;<span class="ident" id="6869487">errf</span><span class="op" id="6869491">(</span><span class="string" id="6869492">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="6869543">,</span>&nbsp;<span class="ident" id="6869545">stmt</span><span class="op" id="6869549">.</span><span class="ident" id="6869550">table</span><span class="op" id="6869555">,</span>&nbsp;<span class="ident" id="6869557">column</span><span class="op" id="6869563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6869567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869571">stmt</span><span class="op" id="6869575">.</span><span class="ident" id="6869576">colName</span>&nbsp;<span class="op" id="6869584">=</span>&nbsp;<span class="builtinfunc" id="6869586">append</span><span class="op" id="6869592">(</span><span class="ident" id="6869593">stmt</span><span class="op" id="6869597">.</span><span class="ident" id="6869598">colName</span><span class="op" id="6869605">,</span>&nbsp;<span class="ident" id="6869607">column</span><span class="op" id="6869613">)</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869618">if</span>&nbsp;<span class="ident" id="6869621">value</span>&nbsp;<span class="op" id="6869627">!=</span>&nbsp;<span class="string" id="6869630">&#34;?&#34;</span>&nbsp;<span class="op" id="6869634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869639">var</span>&nbsp;<span class="ident" id="6869643">subsetVal</span>&nbsp;<span class="keyword" id="6869653">interface</span><span class="op" id="6869662">{</span><span class="op" id="6869663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6869668">//&nbsp;Convert&nbsp;to&nbsp;driver&nbsp;subset&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869704">switch</span>&nbsp;<span class="ident" id="6869711">ctype</span>&nbsp;<span class="op" id="6869717">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869722">case</span>&nbsp;<span class="string" id="6869727">&#34;string&#34;</span><span class="op" id="6869735">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869741">subsetVal</span>&nbsp;<span class="op" id="6869751">=</span>&nbsp;<span class="op" id="6869753">[</span><span class="op" id="6869754">]</span><span class="builtintype" id="6869755">byte</span><span class="op" id="6869759">(</span><span class="ident" id="6869760">value</span><span class="op" id="6869765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869770">case</span>&nbsp;<span class="string" id="6869775">&#34;blob&#34;</span><span class="op" id="6869781">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869787">subsetVal</span>&nbsp;<span class="op" id="6869797">=</span>&nbsp;<span class="op" id="6869799">[</span><span class="op" id="6869800">]</span><span class="builtintype" id="6869801">byte</span><span class="op" id="6869805">(</span><span class="ident" id="6869806">value</span><span class="op" id="6869811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869816">case</span>&nbsp;<span class="string" id="6869821">&#34;int32&#34;</span><span class="op" id="6869828">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869834">i</span><span class="op" id="6869835">,</span>&nbsp;<span class="ident" id="6869837">err</span>&nbsp;<span class="op" id="6869841">:=</span>&nbsp;<span class="ident" id="6869844">strconv</span><span class="op" id="6869851">.</span><span class="ident" id="6869852">Atoi</span><span class="op" id="6869856">(</span><span class="ident" id="6869857">value</span><span class="op" id="6869862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869868">if</span>&nbsp;<span class="ident" id="6869871">err</span>&nbsp;<span class="op" id="6869875">!=</span>&nbsp;<span class="ident" id="6869878">nil</span>&nbsp;<span class="op" id="6869882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869889">stmt</span><span class="op" id="6869893">.</span><span class="ident" id="6869894">Close</span><span class="op" id="6869899">(</span><span class="op" id="6869900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869907">return</span>&nbsp;<span class="ident" id="6869914">nil</span><span class="op" id="6869917">,</span>&nbsp;<span class="ident" id="6869919">errf</span><span class="op" id="6869923">(</span><span class="string" id="6869924">&#34;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;%q&#34;</span><span class="op" id="6869961">,</span>&nbsp;<span class="ident" id="6869963">value</span><span class="op" id="6869968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6869974">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869980">subsetVal</span>&nbsp;<span class="op" id="6869990">=</span>&nbsp;<span class="ident" id="6869992">int64</span><span class="op" id="6869997">(</span><span class="ident" id="6869998">i</span><span class="op" id="6869999">)</span>&nbsp;<span class="comment" id="6870001">//&nbsp;int64&nbsp;is&nbsp;a&nbsp;subset&nbsp;type,&nbsp;but&nbsp;not&nbsp;int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870045">default</span><span class="op" id="6870052">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870058">stmt</span><span class="op" id="6870062">.</span><span class="ident" id="6870063">Close</span><span class="op" id="6870068">(</span><span class="op" id="6870069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870075">return</span>&nbsp;<span class="ident" id="6870082">nil</span><span class="op" id="6870085">,</span>&nbsp;<span class="ident" id="6870087">errf</span><span class="op" id="6870091">(</span><span class="string" id="6870092">&#34;unsupported&nbsp;conversion&nbsp;for&nbsp;pre-bound&nbsp;parameter&nbsp;%q&nbsp;to&nbsp;type&nbsp;%q&#34;</span><span class="op" id="6870154">,</span>&nbsp;<span class="ident" id="6870156">value</span><span class="op" id="6870161">,</span>&nbsp;<span class="ident" id="6870163">ctype</span><span class="op" id="6870168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870173">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870178">stmt</span><span class="op" id="6870182">.</span><span class="ident" id="6870183">colValue</span>&nbsp;<span class="op" id="6870192">=</span>&nbsp;<span class="builtinfunc" id="6870194">append</span><span class="op" id="6870200">(</span><span class="ident" id="6870201">stmt</span><span class="op" id="6870205">.</span><span class="ident" id="6870206">colValue</span><span class="op" id="6870214">,</span>&nbsp;<span class="ident" id="6870216">subsetVal</span><span class="op" id="6870225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870229">}</span>&nbsp;<span class="keyword" id="6870231">else</span>&nbsp;<span class="op" id="6870236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870241">stmt</span><span class="op" id="6870245">.</span><span class="ident" id="6870246">placeholders</span><span class="op" id="6870258">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870264">stmt</span><span class="op" id="6870268">.</span><span class="ident" id="6870269">placeholderConverter</span>&nbsp;<span class="op" id="6870290">=</span>&nbsp;<span class="builtinfunc" id="6870292">append</span><span class="op" id="6870298">(</span><span class="ident" id="6870299">stmt</span><span class="op" id="6870303">.</span><span class="ident" id="6870304">placeholderConverter</span><span class="op" id="6870324">,</span>&nbsp;<span class="ident" id="6870326">converterForType</span><span class="op" id="6870342">(</span><span class="ident" id="6870343">ctype</span><span class="op" id="6870348">)</span><span class="op" id="6870349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870354">stmt</span><span class="op" id="6870358">.</span><span class="ident" id="6870359">colValue</span>&nbsp;<span class="op" id="6870368">=</span>&nbsp;<span class="builtinfunc" id="6870370">append</span><span class="op" id="6870376">(</span><span class="ident" id="6870377">stmt</span><span class="op" id="6870381">.</span><span class="ident" id="6870382">colValue</span><span class="op" id="6870390">,</span>&nbsp;<span class="string" id="6870392">&#34;?&#34;</span><span class="op" id="6870395">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870405">return</span>&nbsp;<span class="ident" id="6870412">stmt</span><span class="op" id="6870416">,</span>&nbsp;<span class="ident" id="6870418">nil</span><br>
<span class="lineno"></span><span class="op" id="6870422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="6870425">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="6870464">var</span>&nbsp;<span class="ident" id="6870468">hookPrepareBadConn</span>&nbsp;<span class="keyword" id="6870487">func</span><span class="op" id="6870491">(</span><span class="op" id="6870492">)</span>&nbsp;<span class="builtintype" id="6870494">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6870500">func</span>&nbsp;<span class="op" id="6870505">(</span><span class="ident" id="6870506">c</span>&nbsp;<span class="op" id="6870508">*</span><span class="ident" id="6870509">fakeConn</span><span class="op" id="6870517">)</span>&nbsp;<span class="ident" id="6870519">Prepare</span><span class="op" id="6870526">(</span><span class="ident" id="6870527">query</span>&nbsp;<span class="builtintype" id="6870533">string</span><span class="op" id="6870539">)</span>&nbsp;<span class="op" id="6870541">(</span><span class="ident" id="6870542">driver</span><span class="op" id="6870548">.</span><span class="ident" id="6870549">Stmt</span><span class="op" id="6870553">,</span>&nbsp;<span class="builtintype" id="6870555">error</span><span class="op" id="6870560">)</span>&nbsp;<span class="op" id="6870562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870565">c</span><span class="op" id="6870566">.</span><span class="ident" id="6870567">numPrepare</span><span class="op" id="6870577">++</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870581">if</span>&nbsp;<span class="ident" id="6870584">c</span><span class="op" id="6870585">.</span><span class="ident" id="6870586">db</span>&nbsp;<span class="op" id="6870589">==</span>&nbsp;<span class="ident" id="6870592">nil</span>&nbsp;<span class="op" id="6870596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6870600">panic</span><span class="op" id="6870605">(</span><span class="string" id="6870606">&#34;nil&nbsp;c.db;&nbsp;conn&nbsp;=&nbsp;&#34;</span>&nbsp;<span class="op" id="6870626">+</span>&nbsp;<span class="ident" id="6870628">fmt</span><span class="op" id="6870631">.</span><span class="ident" id="6870632">Sprintf</span><span class="op" id="6870639">(</span><span class="string" id="6870640">&#34;%#v&#34;</span><span class="op" id="6870645">,</span>&nbsp;<span class="ident" id="6870647">c</span><span class="op" id="6870648">)</span><span class="op" id="6870649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870656">if</span>&nbsp;<span class="ident" id="6870659">hookPrepareBadConn</span>&nbsp;<span class="op" id="6870678">!=</span>&nbsp;<span class="ident" id="6870681">nil</span>&nbsp;<span class="op" id="6870685">&amp;&amp;</span>&nbsp;<span class="ident" id="6870688">hookPrepareBadConn</span><span class="op" id="6870706">(</span><span class="op" id="6870707">)</span>&nbsp;<span class="op" id="6870709">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870713">return</span>&nbsp;<span class="ident" id="6870720">nil</span><span class="op" id="6870723">,</span>&nbsp;<span class="ident" id="6870725">driver</span><span class="op" id="6870731">.</span><span class="ident" id="6870732">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870748">parts</span>&nbsp;<span class="op" id="6870754">:=</span>&nbsp;<span class="ident" id="6870757">strings</span><span class="op" id="6870764">.</span><span class="ident" id="6870765">Split</span><span class="op" id="6870770">(</span><span class="ident" id="6870771">query</span><span class="op" id="6870776">,</span>&nbsp;<span class="string" id="6870778">&#34;|&#34;</span><span class="op" id="6870781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870784">if</span>&nbsp;<span class="builtinfunc" id="6870787">len</span><span class="op" id="6870790">(</span><span class="ident" id="6870791">parts</span><span class="op" id="6870796">)</span>&nbsp;<span class="op" id="6870798">&lt;</span>&nbsp;<span class="num" id="6870800">1</span>&nbsp;<span class="op" id="6870802">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870806">return</span>&nbsp;<span class="ident" id="6870813">nil</span><span class="op" id="6870816">,</span>&nbsp;<span class="ident" id="6870818">errf</span><span class="op" id="6870822">(</span><span class="string" id="6870823">&#34;empty&nbsp;query&#34;</span><span class="op" id="6870836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870842">cmd</span>&nbsp;<span class="op" id="6870846">:=</span>&nbsp;<span class="ident" id="6870849">parts</span><span class="op" id="6870854">[</span><span class="num" id="6870855">0</span><span class="op" id="6870856">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870859">parts</span>&nbsp;<span class="op" id="6870865">=</span>&nbsp;<span class="ident" id="6870867">parts</span><span class="op" id="6870872">[</span><span class="num" id="6870873">1</span><span class="op" id="6870874">:</span><span class="op" id="6870875">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870878">stmt</span>&nbsp;<span class="op" id="6870883">:=</span>&nbsp;<span class="op" id="6870886">&amp;</span><span class="ident" id="6870887">fakeStmt</span><span class="op" id="6870895">{</span><span class="ident" id="6870896">q</span><span class="op" id="6870897">:</span>&nbsp;<span class="ident" id="6870899">query</span><span class="op" id="6870904">,</span>&nbsp;<span class="ident" id="6870906">c</span><span class="op" id="6870907">:</span>&nbsp;<span class="ident" id="6870909">c</span><span class="op" id="6870910">,</span>&nbsp;<span class="ident" id="6870912">cmd</span><span class="op" id="6870915">:</span>&nbsp;<span class="ident" id="6870917">cmd</span><span class="op" id="6870920">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870923">c</span><span class="op" id="6870924">.</span><span class="ident" id="6870925">incrStat</span><span class="op" id="6870933">(</span><span class="op" id="6870934">&amp;</span><span class="ident" id="6870935">c</span><span class="op" id="6870936">.</span><span class="ident" id="6870937">stmtsMade</span><span class="op" id="6870946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870949">switch</span>&nbsp;<span class="ident" id="6870956">cmd</span>&nbsp;<span class="op" id="6870960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870963">case</span>&nbsp;<span class="string" id="6870968">&#34;WIPE&#34;</span><span class="op" id="6870974">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6870978">//&nbsp;Nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870990">case</span>&nbsp;<span class="string" id="6870995">&#34;SELECT&#34;</span><span class="op" id="6871003">:</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871007">return</span>&nbsp;<span class="ident" id="6871014">c</span><span class="op" id="6871015">.</span><span class="ident" id="6871016">prepareSelect</span><span class="op" id="6871029">(</span><span class="ident" id="6871030">stmt</span><span class="op" id="6871034">,</span>&nbsp;<span class="ident" id="6871036">parts</span><span class="op" id="6871041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871044">case</span>&nbsp;<span class="string" id="6871049">&#34;CREATE&#34;</span><span class="op" id="6871057">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871061">return</span>&nbsp;<span class="ident" id="6871068">c</span><span class="op" id="6871069">.</span><span class="ident" id="6871070">prepareCreate</span><span class="op" id="6871083">(</span><span class="ident" id="6871084">stmt</span><span class="op" id="6871088">,</span>&nbsp;<span class="ident" id="6871090">parts</span><span class="op" id="6871095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871098">case</span>&nbsp;<span class="string" id="6871103">&#34;INSERT&#34;</span><span class="op" id="6871111">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871115">return</span>&nbsp;<span class="ident" id="6871122">c</span><span class="op" id="6871123">.</span><span class="ident" id="6871124">prepareInsert</span><span class="op" id="6871137">(</span><span class="ident" id="6871138">stmt</span><span class="op" id="6871142">,</span>&nbsp;<span class="ident" id="6871144">parts</span><span class="op" id="6871149">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871152">case</span>&nbsp;<span class="string" id="6871157">&#34;NOSERT&#34;</span><span class="op" id="6871165">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6871169">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6871249">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871293">return</span>&nbsp;<span class="ident" id="6871300">c</span><span class="op" id="6871301">.</span><span class="ident" id="6871302">prepareInsert</span><span class="op" id="6871315">(</span><span class="ident" id="6871316">stmt</span><span class="op" id="6871320">,</span>&nbsp;<span class="ident" id="6871322">parts</span><span class="op" id="6871327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871330">default</span><span class="op" id="6871337">:</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871341">stmt</span><span class="op" id="6871345">.</span><span class="ident" id="6871346">Close</span><span class="op" id="6871351">(</span><span class="op" id="6871352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871356">return</span>&nbsp;<span class="ident" id="6871363">nil</span><span class="op" id="6871366">,</span>&nbsp;<span class="ident" id="6871368">errf</span><span class="op" id="6871372">(</span><span class="string" id="6871373">&#34;unsupported&nbsp;command&nbsp;type&nbsp;%q&#34;</span><span class="op" id="6871402">,</span>&nbsp;<span class="ident" id="6871404">cmd</span><span class="op" id="6871407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6871410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871413">return</span>&nbsp;<span class="ident" id="6871420">stmt</span><span class="op" id="6871424">,</span>&nbsp;<span class="ident" id="6871426">nil</span><br>
<span class="lineno"></span><span class="op" id="6871430">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="6871433">func</span>&nbsp;<span class="op" id="6871438">(</span><span class="ident" id="6871439">s</span>&nbsp;<span class="op" id="6871441">*</span><span class="ident" id="6871442">fakeStmt</span><span class="op" id="6871450">)</span>&nbsp;<span class="ident" id="6871452">ColumnConverter</span><span class="op" id="6871467">(</span><span class="ident" id="6871468">idx</span>&nbsp;<span class="builtintype" id="6871472">int</span><span class="op" id="6871475">)</span>&nbsp;<span class="ident" id="6871477">driver</span><span class="op" id="6871483">.</span><span class="ident" id="6871484">ValueConverter</span>&nbsp;<span class="op" id="6871499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871502">if</span>&nbsp;<span class="builtinfunc" id="6871505">len</span><span class="op" id="6871508">(</span><span class="ident" id="6871509">s</span><span class="op" id="6871510">.</span><span class="ident" id="6871511">placeholderConverter</span><span class="op" id="6871531">)</span>&nbsp;<span class="op" id="6871533">==</span>&nbsp;<span class="num" id="6871536">0</span>&nbsp;<span class="op" id="6871538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871542">return</span>&nbsp;<span class="ident" id="6871549">driver</span><span class="op" id="6871555">.</span><span class="ident" id="6871556">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6871583">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871586">return</span>&nbsp;<span class="ident" id="6871593">s</span><span class="op" id="6871594">.</span><span class="ident" id="6871595">placeholderConverter</span><span class="op" id="6871615">[</span><span class="ident" id="6871616">idx</span><span class="op" id="6871619">]</span><br>
<span class="lineno"></span><span class="op" id="6871621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6871624">func</span>&nbsp;<span class="op" id="6871629">(</span><span class="ident" id="6871630">s</span>&nbsp;<span class="op" id="6871632">*</span><span class="ident" id="6871633">fakeStmt</span><span class="op" id="6871641">)</span>&nbsp;<span class="ident" id="6871643">Close</span><span class="op" id="6871648">(</span><span class="op" id="6871649">)</span>&nbsp;<span class="builtintype" id="6871651">error</span>&nbsp;<span class="op" id="6871657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871660">if</span>&nbsp;<span class="ident" id="6871663">s</span><span class="op" id="6871664">.</span><span class="ident" id="6871665">c</span>&nbsp;<span class="op" id="6871667">==</span>&nbsp;<span class="ident" id="6871670">nil</span>&nbsp;<span class="op" id="6871674">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6871678">panic</span><span class="op" id="6871683">(</span><span class="string" id="6871684">&#34;nil&nbsp;conn&nbsp;in&nbsp;fakeStmt.Close&#34;</span><span class="op" id="6871712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6871715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871718">if</span>&nbsp;<span class="ident" id="6871721">s</span><span class="op" id="6871722">.</span><span class="ident" id="6871723">c</span><span class="op" id="6871724">.</span><span class="ident" id="6871725">db</span>&nbsp;<span class="op" id="6871728">==</span>&nbsp;<span class="ident" id="6871731">nil</span>&nbsp;<span class="op" id="6871735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6871739">panic</span><span class="op" id="6871744">(</span><span class="string" id="6871745">&#34;in&nbsp;fakeStmt.Close,&nbsp;conn&#39;s&nbsp;db&nbsp;is&nbsp;nil&nbsp;(already&nbsp;closed)&#34;</span><span class="op" id="6871799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6871802">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871805">if</span>&nbsp;<span class="op" id="6871808">!</span><span class="ident" id="6871809">s</span><span class="op" id="6871810">.</span><span class="ident" id="6871811">closed</span>&nbsp;<span class="op" id="6871818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871822">s</span><span class="op" id="6871823">.</span><span class="ident" id="6871824">c</span><span class="op" id="6871825">.</span><span class="ident" id="6871826">incrStat</span><span class="op" id="6871834">(</span><span class="op" id="6871835">&amp;</span><span class="ident" id="6871836">s</span><span class="op" id="6871837">.</span><span class="ident" id="6871838">c</span><span class="op" id="6871839">.</span><span class="ident" id="6871840">stmtsClosed</span><span class="op" id="6871851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871855">s</span><span class="op" id="6871856">.</span><span class="ident" id="6871857">closed</span>&nbsp;<span class="op" id="6871864">=</span>&nbsp;<span class="builtintype" id="6871866">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6871872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871875">return</span>&nbsp;<span class="ident" id="6871882">nil</span><br>
<span class="lineno">520</span><span class="op" id="6871886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6871889">var</span>&nbsp;<span class="ident" id="6871893">errClosed</span>&nbsp;<span class="op" id="6871903">=</span>&nbsp;<span class="ident" id="6871905">errors</span><span class="op" id="6871911">.</span><span class="ident" id="6871912">New</span><span class="op" id="6871915">(</span><span class="string" id="6871916">&#34;fakedb:&nbsp;statement&nbsp;has&nbsp;been&nbsp;closed&#34;</span><span class="op" id="6871951">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6871954">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno">525</span><span class="keyword" id="6871993">var</span>&nbsp;<span class="ident" id="6871997">hookExecBadConn</span>&nbsp;<span class="keyword" id="6872013">func</span><span class="op" id="6872017">(</span><span class="op" id="6872018">)</span>&nbsp;<span class="builtintype" id="6872020">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6872026">func</span>&nbsp;<span class="op" id="6872031">(</span><span class="ident" id="6872032">s</span>&nbsp;<span class="op" id="6872034">*</span><span class="ident" id="6872035">fakeStmt</span><span class="op" id="6872043">)</span>&nbsp;<span class="ident" id="6872045">Exec</span><span class="op" id="6872049">(</span><span class="ident" id="6872050">args</span>&nbsp;<span class="op" id="6872055">[</span><span class="op" id="6872056">]</span><span class="ident" id="6872057">driver</span><span class="op" id="6872063">.</span><span class="ident" id="6872064">Value</span><span class="op" id="6872069">)</span>&nbsp;<span class="op" id="6872071">(</span><span class="ident" id="6872072">driver</span><span class="op" id="6872078">.</span><span class="ident" id="6872079">Result</span><span class="op" id="6872085">,</span>&nbsp;<span class="builtintype" id="6872087">error</span><span class="op" id="6872092">)</span>&nbsp;<span class="op" id="6872094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872097">if</span>&nbsp;<span class="ident" id="6872100">s</span><span class="op" id="6872101">.</span><span class="ident" id="6872102">closed</span>&nbsp;<span class="op" id="6872109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872113">return</span>&nbsp;<span class="ident" id="6872120">nil</span><span class="op" id="6872123">,</span>&nbsp;<span class="ident" id="6872125">errClosed</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872140">if</span>&nbsp;<span class="ident" id="6872143">hookExecBadConn</span>&nbsp;<span class="op" id="6872159">!=</span>&nbsp;<span class="ident" id="6872162">nil</span>&nbsp;<span class="op" id="6872166">&amp;&amp;</span>&nbsp;<span class="ident" id="6872169">hookExecBadConn</span><span class="op" id="6872184">(</span><span class="op" id="6872185">)</span>&nbsp;<span class="op" id="6872187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872191">return</span>&nbsp;<span class="ident" id="6872198">nil</span><span class="op" id="6872201">,</span>&nbsp;<span class="ident" id="6872203">driver</span><span class="op" id="6872209">.</span><span class="ident" id="6872210">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872222">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872226">err</span>&nbsp;<span class="op" id="6872230">:=</span>&nbsp;<span class="ident" id="6872233">checkSubsetTypes</span><span class="op" id="6872249">(</span><span class="ident" id="6872250">args</span><span class="op" id="6872254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872257">if</span>&nbsp;<span class="ident" id="6872260">err</span>&nbsp;<span class="op" id="6872264">!=</span>&nbsp;<span class="ident" id="6872267">nil</span>&nbsp;<span class="op" id="6872271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872275">return</span>&nbsp;<span class="ident" id="6872282">nil</span><span class="op" id="6872285">,</span>&nbsp;<span class="ident" id="6872287">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872292">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872296">db</span>&nbsp;<span class="op" id="6872299">:=</span>&nbsp;<span class="ident" id="6872302">s</span><span class="op" id="6872303">.</span><span class="ident" id="6872304">c</span><span class="op" id="6872305">.</span><span class="ident" id="6872306">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872310">switch</span>&nbsp;<span class="ident" id="6872317">s</span><span class="op" id="6872318">.</span><span class="ident" id="6872319">cmd</span>&nbsp;<span class="op" id="6872323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872326">case</span>&nbsp;<span class="string" id="6872331">&#34;WIPE&#34;</span><span class="op" id="6872337">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872341">db</span><span class="op" id="6872343">.</span><span class="ident" id="6872344">wipe</span><span class="op" id="6872348">(</span><span class="op" id="6872349">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872353">return</span>&nbsp;<span class="ident" id="6872360">driver</span><span class="op" id="6872366">.</span><span class="ident" id="6872367">ResultNoRows</span><span class="op" id="6872379">,</span>&nbsp;<span class="ident" id="6872381">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872386">case</span>&nbsp;<span class="string" id="6872391">&#34;CREATE&#34;</span><span class="op" id="6872399">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872403">if</span>&nbsp;<span class="ident" id="6872406">err</span>&nbsp;<span class="op" id="6872410">:=</span>&nbsp;<span class="ident" id="6872413">db</span><span class="op" id="6872415">.</span><span class="ident" id="6872416">createTable</span><span class="op" id="6872427">(</span><span class="ident" id="6872428">s</span><span class="op" id="6872429">.</span><span class="ident" id="6872430">table</span><span class="op" id="6872435">,</span>&nbsp;<span class="ident" id="6872437">s</span><span class="op" id="6872438">.</span><span class="ident" id="6872439">colName</span><span class="op" id="6872446">,</span>&nbsp;<span class="ident" id="6872448">s</span><span class="op" id="6872449">.</span><span class="ident" id="6872450">colType</span><span class="op" id="6872457">)</span><span class="op" id="6872458">;</span>&nbsp;<span class="ident" id="6872460">err</span>&nbsp;<span class="op" id="6872464">!=</span>&nbsp;<span class="ident" id="6872467">nil</span>&nbsp;<span class="op" id="6872471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872476">return</span>&nbsp;<span class="ident" id="6872483">nil</span><span class="op" id="6872486">,</span>&nbsp;<span class="ident" id="6872488">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872494">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872498">return</span>&nbsp;<span class="ident" id="6872505">driver</span><span class="op" id="6872511">.</span><span class="ident" id="6872512">ResultNoRows</span><span class="op" id="6872524">,</span>&nbsp;<span class="ident" id="6872526">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872531">case</span>&nbsp;<span class="string" id="6872536">&#34;INSERT&#34;</span><span class="op" id="6872544">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872548">return</span>&nbsp;<span class="ident" id="6872555">s</span><span class="op" id="6872556">.</span><span class="ident" id="6872557">execInsert</span><span class="op" id="6872567">(</span><span class="ident" id="6872568">args</span><span class="op" id="6872572">,</span>&nbsp;<span class="builtintype" id="6872574">true</span><span class="op" id="6872578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872581">case</span>&nbsp;<span class="string" id="6872586">&#34;NOSERT&#34;</span><span class="op" id="6872594">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6872598">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6872678">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872722">return</span>&nbsp;<span class="ident" id="6872729">s</span><span class="op" id="6872730">.</span><span class="ident" id="6872731">execInsert</span><span class="op" id="6872741">(</span><span class="ident" id="6872742">args</span><span class="op" id="6872746">,</span>&nbsp;<span class="builtintype" id="6872748">false</span><span class="op" id="6872753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872759">fmt</span><span class="op" id="6872762">.</span><span class="ident" id="6872763">Printf</span><span class="op" id="6872769">(</span><span class="string" id="6872770">&#34;EXEC&nbsp;statement,&nbsp;cmd=%q:&nbsp;%#v\n&#34;</span><span class="op" id="6872801">,</span>&nbsp;<span class="ident" id="6872803">s</span><span class="op" id="6872804">.</span><span class="ident" id="6872805">cmd</span><span class="op" id="6872808">,</span>&nbsp;<span class="ident" id="6872810">s</span><span class="op" id="6872811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872814">return</span>&nbsp;<span class="ident" id="6872821">nil</span><span class="op" id="6872824">,</span>&nbsp;<span class="ident" id="6872826">fmt</span><span class="op" id="6872829">.</span><span class="ident" id="6872830">Errorf</span><span class="op" id="6872836">(</span><span class="string" id="6872837">&#34;unimplemented&nbsp;statement&nbsp;Exec&nbsp;command&nbsp;type&nbsp;of&nbsp;%q&#34;</span><span class="op" id="6872886">,</span>&nbsp;<span class="ident" id="6872888">s</span><span class="op" id="6872889">.</span><span class="ident" id="6872890">cmd</span><span class="op" id="6872893">)</span><br>
<span class="lineno">560</span><span class="op" id="6872895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6872898">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;true,&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span><span class="comment" id="6872950">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;false&nbsp;do&nbsp;prep-work&nbsp;and&nbsp;error&nbsp;checking,&nbsp;but&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="6873019">//&nbsp;actually&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno">565</span><span class="keyword" id="6873057">func</span>&nbsp;<span class="op" id="6873062">(</span><span class="ident" id="6873063">s</span>&nbsp;<span class="op" id="6873065">*</span><span class="ident" id="6873066">fakeStmt</span><span class="op" id="6873074">)</span>&nbsp;<span class="ident" id="6873076">execInsert</span><span class="op" id="6873086">(</span><span class="ident" id="6873087">args</span>&nbsp;<span class="op" id="6873092">[</span><span class="op" id="6873093">]</span><span class="ident" id="6873094">driver</span><span class="op" id="6873100">.</span><span class="ident" id="6873101">Value</span><span class="op" id="6873106">,</span>&nbsp;<span class="ident" id="6873108">doInsert</span>&nbsp;<span class="builtintype" id="6873117">bool</span><span class="op" id="6873121">)</span>&nbsp;<span class="op" id="6873123">(</span><span class="ident" id="6873124">driver</span><span class="op" id="6873130">.</span><span class="ident" id="6873131">Result</span><span class="op" id="6873137">,</span>&nbsp;<span class="builtintype" id="6873139">error</span><span class="op" id="6873144">)</span>&nbsp;<span class="op" id="6873146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873149">db</span>&nbsp;<span class="op" id="6873152">:=</span>&nbsp;<span class="ident" id="6873155">s</span><span class="op" id="6873156">.</span><span class="ident" id="6873157">c</span><span class="op" id="6873158">.</span><span class="ident" id="6873159">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873163">if</span>&nbsp;<span class="builtinfunc" id="6873166">len</span><span class="op" id="6873169">(</span><span class="ident" id="6873170">args</span><span class="op" id="6873174">)</span>&nbsp;<span class="op" id="6873176">!=</span>&nbsp;<span class="ident" id="6873179">s</span><span class="op" id="6873180">.</span><span class="ident" id="6873181">placeholders</span>&nbsp;<span class="op" id="6873194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6873198">panic</span><span class="op" id="6873203">(</span><span class="string" id="6873204">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="6873262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873265">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873268">db</span><span class="op" id="6873270">.</span><span class="ident" id="6873271">mu</span><span class="op" id="6873273">.</span><span class="ident" id="6873274">Lock</span><span class="op" id="6873278">(</span><span class="op" id="6873279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873282">t</span><span class="op" id="6873283">,</span>&nbsp;<span class="ident" id="6873285">ok</span>&nbsp;<span class="op" id="6873288">:=</span>&nbsp;<span class="ident" id="6873291">db</span><span class="op" id="6873293">.</span><span class="ident" id="6873294">table</span><span class="op" id="6873299">(</span><span class="ident" id="6873300">s</span><span class="op" id="6873301">.</span><span class="ident" id="6873302">table</span><span class="op" id="6873307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873310">db</span><span class="op" id="6873312">.</span><span class="ident" id="6873313">mu</span><span class="op" id="6873315">.</span><span class="ident" id="6873316">Unlock</span><span class="op" id="6873322">(</span><span class="op" id="6873323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873326">if</span>&nbsp;<span class="op" id="6873329">!</span><span class="ident" id="6873330">ok</span>&nbsp;<span class="op" id="6873333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873337">return</span>&nbsp;<span class="ident" id="6873344">nil</span><span class="op" id="6873347">,</span>&nbsp;<span class="ident" id="6873349">fmt</span><span class="op" id="6873352">.</span><span class="ident" id="6873353">Errorf</span><span class="op" id="6873359">(</span><span class="string" id="6873360">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="6873392">,</span>&nbsp;<span class="ident" id="6873394">s</span><span class="op" id="6873395">.</span><span class="ident" id="6873396">table</span><span class="op" id="6873401">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873408">t</span><span class="op" id="6873409">.</span><span class="ident" id="6873410">mu</span><span class="op" id="6873412">.</span><span class="ident" id="6873413">Lock</span><span class="op" id="6873417">(</span><span class="op" id="6873418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873421">defer</span>&nbsp;<span class="ident" id="6873427">t</span><span class="op" id="6873428">.</span><span class="ident" id="6873429">mu</span><span class="op" id="6873431">.</span><span class="ident" id="6873432">Unlock</span><span class="op" id="6873438">(</span><span class="op" id="6873439">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873443">var</span>&nbsp;<span class="ident" id="6873447">cols</span>&nbsp;<span class="op" id="6873452">[</span><span class="op" id="6873453">]</span><span class="keyword" id="6873454">interface</span><span class="op" id="6873463">{</span><span class="op" id="6873464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873467">if</span>&nbsp;<span class="ident" id="6873470">doInsert</span>&nbsp;<span class="op" id="6873479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873483">cols</span>&nbsp;<span class="op" id="6873488">=</span>&nbsp;<span class="builtinfunc" id="6873490">make</span><span class="op" id="6873494">(</span><span class="op" id="6873495">[</span><span class="op" id="6873496">]</span><span class="keyword" id="6873497">interface</span><span class="op" id="6873506">{</span><span class="op" id="6873507">}</span><span class="op" id="6873508">,</span>&nbsp;<span class="builtinfunc" id="6873510">len</span><span class="op" id="6873513">(</span><span class="ident" id="6873514">t</span><span class="op" id="6873515">.</span><span class="ident" id="6873516">colname</span><span class="op" id="6873523">)</span><span class="op" id="6873524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873530">argPos</span>&nbsp;<span class="op" id="6873537">:=</span>&nbsp;<span class="num" id="6873540">0</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873543">for</span>&nbsp;<span class="ident" id="6873547">n</span><span class="op" id="6873548">,</span>&nbsp;<span class="ident" id="6873550">colname</span>&nbsp;<span class="op" id="6873558">:=</span>&nbsp;<span class="keyword" id="6873561">range</span>&nbsp;<span class="ident" id="6873567">s</span><span class="op" id="6873568">.</span><span class="ident" id="6873569">colName</span>&nbsp;<span class="op" id="6873577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873581">colidx</span>&nbsp;<span class="op" id="6873588">:=</span>&nbsp;<span class="ident" id="6873591">t</span><span class="op" id="6873592">.</span><span class="ident" id="6873593">columnIndex</span><span class="op" id="6873604">(</span><span class="ident" id="6873605">colname</span><span class="op" id="6873612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873616">if</span>&nbsp;<span class="ident" id="6873619">colidx</span>&nbsp;<span class="op" id="6873626">==</span>&nbsp;<span class="op" id="6873629">-</span><span class="num" id="6873630">1</span>&nbsp;<span class="op" id="6873632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873637">return</span>&nbsp;<span class="ident" id="6873644">nil</span><span class="op" id="6873647">,</span>&nbsp;<span class="ident" id="6873649">fmt</span><span class="op" id="6873652">.</span><span class="ident" id="6873653">Errorf</span><span class="op" id="6873659">(</span><span class="string" id="6873660">&#34;fakedb:&nbsp;column&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&nbsp;or&nbsp;dropped&nbsp;since&nbsp;prepared&nbsp;statement&nbsp;was&nbsp;created&#34;</span><span class="op" id="6873741">,</span>&nbsp;<span class="ident" id="6873743">colname</span><span class="op" id="6873750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873754">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873758">var</span>&nbsp;<span class="ident" id="6873762">val</span>&nbsp;<span class="keyword" id="6873766">interface</span><span class="op" id="6873775">{</span><span class="op" id="6873776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873780">if</span>&nbsp;<span class="ident" id="6873783">strvalue</span><span class="op" id="6873791">,</span>&nbsp;<span class="ident" id="6873793">ok</span>&nbsp;<span class="op" id="6873796">:=</span>&nbsp;<span class="ident" id="6873799">s</span><span class="op" id="6873800">.</span><span class="ident" id="6873801">colValue</span><span class="op" id="6873809">[</span><span class="ident" id="6873810">n</span><span class="op" id="6873811">]</span><span class="op" id="6873812">.</span><span class="op" id="6873813">(</span><span class="builtintype" id="6873814">string</span><span class="op" id="6873820">)</span><span class="op" id="6873821">;</span>&nbsp;<span class="ident" id="6873823">ok</span>&nbsp;<span class="op" id="6873826">&amp;&amp;</span>&nbsp;<span class="ident" id="6873829">strvalue</span>&nbsp;<span class="op" id="6873838">==</span>&nbsp;<span class="string" id="6873841">&#34;?&#34;</span>&nbsp;<span class="op" id="6873845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873850">val</span>&nbsp;<span class="op" id="6873854">=</span>&nbsp;<span class="ident" id="6873856">args</span><span class="op" id="6873860">[</span><span class="ident" id="6873861">argPos</span><span class="op" id="6873867">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873872">argPos</span><span class="op" id="6873878">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873883">}</span>&nbsp;<span class="keyword" id="6873885">else</span>&nbsp;<span class="op" id="6873890">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873895">val</span>&nbsp;<span class="op" id="6873899">=</span>&nbsp;<span class="ident" id="6873901">s</span><span class="op" id="6873902">.</span><span class="ident" id="6873903">colValue</span><span class="op" id="6873911">[</span><span class="ident" id="6873912">n</span><span class="op" id="6873913">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873921">if</span>&nbsp;<span class="ident" id="6873924">doInsert</span>&nbsp;<span class="op" id="6873933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873938">cols</span><span class="op" id="6873942">[</span><span class="ident" id="6873943">colidx</span><span class="op" id="6873949">]</span>&nbsp;<span class="op" id="6873951">=</span>&nbsp;<span class="ident" id="6873953">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873959">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873966">if</span>&nbsp;<span class="ident" id="6873969">doInsert</span>&nbsp;<span class="op" id="6873978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873982">t</span><span class="op" id="6873983">.</span><span class="ident" id="6873984">rows</span>&nbsp;<span class="op" id="6873989">=</span>&nbsp;<span class="builtinfunc" id="6873991">append</span><span class="op" id="6873997">(</span><span class="ident" id="6873998">t</span><span class="op" id="6873999">.</span><span class="ident" id="6874000">rows</span><span class="op" id="6874004">,</span>&nbsp;<span class="op" id="6874006">&amp;</span><span class="ident" id="6874007">row</span><span class="op" id="6874010">{</span><span class="ident" id="6874011">cols</span><span class="op" id="6874015">:</span>&nbsp;<span class="ident" id="6874017">cols</span><span class="op" id="6874021">}</span><span class="op" id="6874022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874025">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874028">return</span>&nbsp;<span class="ident" id="6874035">driver</span><span class="op" id="6874041">.</span><span class="ident" id="6874042">RowsAffected</span><span class="op" id="6874054">(</span><span class="num" id="6874055">1</span><span class="op" id="6874056">)</span><span class="op" id="6874057">,</span>&nbsp;<span class="ident" id="6874059">nil</span><br>
<span class="lineno"></span><span class="op" id="6874063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6874066">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="6874105">var</span>&nbsp;<span class="ident" id="6874109">hookQueryBadConn</span>&nbsp;<span class="keyword" id="6874126">func</span><span class="op" id="6874130">(</span><span class="op" id="6874131">)</span>&nbsp;<span class="builtintype" id="6874133">bool</span><br>
<span class="lineno">610</span><br>
<span class="lineno"></span><span class="keyword" id="6874139">func</span>&nbsp;<span class="op" id="6874144">(</span><span class="ident" id="6874145">s</span>&nbsp;<span class="op" id="6874147">*</span><span class="ident" id="6874148">fakeStmt</span><span class="op" id="6874156">)</span>&nbsp;<span class="ident" id="6874158">Query</span><span class="op" id="6874163">(</span><span class="ident" id="6874164">args</span>&nbsp;<span class="op" id="6874169">[</span><span class="op" id="6874170">]</span><span class="ident" id="6874171">driver</span><span class="op" id="6874177">.</span><span class="ident" id="6874178">Value</span><span class="op" id="6874183">)</span>&nbsp;<span class="op" id="6874185">(</span><span class="ident" id="6874186">driver</span><span class="op" id="6874192">.</span><span class="ident" id="6874193">Rows</span><span class="op" id="6874197">,</span>&nbsp;<span class="builtintype" id="6874199">error</span><span class="op" id="6874204">)</span>&nbsp;<span class="op" id="6874206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874209">if</span>&nbsp;<span class="ident" id="6874212">s</span><span class="op" id="6874213">.</span><span class="ident" id="6874214">closed</span>&nbsp;<span class="op" id="6874221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874225">return</span>&nbsp;<span class="ident" id="6874232">nil</span><span class="op" id="6874235">,</span>&nbsp;<span class="ident" id="6874237">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874248">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874252">if</span>&nbsp;<span class="ident" id="6874255">hookQueryBadConn</span>&nbsp;<span class="op" id="6874272">!=</span>&nbsp;<span class="ident" id="6874275">nil</span>&nbsp;<span class="op" id="6874279">&amp;&amp;</span>&nbsp;<span class="ident" id="6874282">hookQueryBadConn</span><span class="op" id="6874298">(</span><span class="op" id="6874299">)</span>&nbsp;<span class="op" id="6874301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874305">return</span>&nbsp;<span class="ident" id="6874312">nil</span><span class="op" id="6874315">,</span>&nbsp;<span class="ident" id="6874317">driver</span><span class="op" id="6874323">.</span><span class="ident" id="6874324">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874340">err</span>&nbsp;<span class="op" id="6874344">:=</span>&nbsp;<span class="ident" id="6874347">checkSubsetTypes</span><span class="op" id="6874363">(</span><span class="ident" id="6874364">args</span><span class="op" id="6874368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874371">if</span>&nbsp;<span class="ident" id="6874374">err</span>&nbsp;<span class="op" id="6874378">!=</span>&nbsp;<span class="ident" id="6874381">nil</span>&nbsp;<span class="op" id="6874385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874389">return</span>&nbsp;<span class="ident" id="6874396">nil</span><span class="op" id="6874399">,</span>&nbsp;<span class="ident" id="6874401">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874410">db</span>&nbsp;<span class="op" id="6874413">:=</span>&nbsp;<span class="ident" id="6874416">s</span><span class="op" id="6874417">.</span><span class="ident" id="6874418">c</span><span class="op" id="6874419">.</span><span class="ident" id="6874420">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874424">if</span>&nbsp;<span class="builtinfunc" id="6874427">len</span><span class="op" id="6874430">(</span><span class="ident" id="6874431">args</span><span class="op" id="6874435">)</span>&nbsp;<span class="op" id="6874437">!=</span>&nbsp;<span class="ident" id="6874440">s</span><span class="op" id="6874441">.</span><span class="ident" id="6874442">placeholders</span>&nbsp;<span class="op" id="6874455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6874459">panic</span><span class="op" id="6874464">(</span><span class="string" id="6874465">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="6874523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874530">db</span><span class="op" id="6874532">.</span><span class="ident" id="6874533">mu</span><span class="op" id="6874535">.</span><span class="ident" id="6874536">Lock</span><span class="op" id="6874540">(</span><span class="op" id="6874541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874544">t</span><span class="op" id="6874545">,</span>&nbsp;<span class="ident" id="6874547">ok</span>&nbsp;<span class="op" id="6874550">:=</span>&nbsp;<span class="ident" id="6874553">db</span><span class="op" id="6874555">.</span><span class="ident" id="6874556">table</span><span class="op" id="6874561">(</span><span class="ident" id="6874562">s</span><span class="op" id="6874563">.</span><span class="ident" id="6874564">table</span><span class="op" id="6874569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874572">db</span><span class="op" id="6874574">.</span><span class="ident" id="6874575">mu</span><span class="op" id="6874577">.</span><span class="ident" id="6874578">Unlock</span><span class="op" id="6874584">(</span><span class="op" id="6874585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874588">if</span>&nbsp;<span class="op" id="6874591">!</span><span class="ident" id="6874592">ok</span>&nbsp;<span class="op" id="6874595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874599">return</span>&nbsp;<span class="ident" id="6874606">nil</span><span class="op" id="6874609">,</span>&nbsp;<span class="ident" id="6874611">fmt</span><span class="op" id="6874614">.</span><span class="ident" id="6874615">Errorf</span><span class="op" id="6874621">(</span><span class="string" id="6874622">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="6874654">,</span>&nbsp;<span class="ident" id="6874656">s</span><span class="op" id="6874657">.</span><span class="ident" id="6874658">table</span><span class="op" id="6874663">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874670">if</span>&nbsp;<span class="ident" id="6874673">s</span><span class="op" id="6874674">.</span><span class="ident" id="6874675">table</span>&nbsp;<span class="op" id="6874681">==</span>&nbsp;<span class="string" id="6874684">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="6874697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874701">if</span>&nbsp;<span class="builtinfunc" id="6874704">len</span><span class="op" id="6874707">(</span><span class="ident" id="6874708">s</span><span class="op" id="6874709">.</span><span class="ident" id="6874710">whereCol</span><span class="op" id="6874718">)</span>&nbsp;<span class="op" id="6874720">==</span>&nbsp;<span class="num" id="6874723">2</span>&nbsp;<span class="op" id="6874725">&amp;&amp;</span>&nbsp;<span class="ident" id="6874728">s</span><span class="op" id="6874729">.</span><span class="ident" id="6874730">whereCol</span><span class="op" id="6874738">[</span><span class="num" id="6874739">0</span><span class="op" id="6874740">]</span>&nbsp;<span class="op" id="6874742">==</span>&nbsp;<span class="string" id="6874745">&#34;op&#34;</span>&nbsp;<span class="op" id="6874750">&amp;&amp;</span>&nbsp;<span class="ident" id="6874753">s</span><span class="op" id="6874754">.</span><span class="ident" id="6874755">whereCol</span><span class="op" id="6874763">[</span><span class="num" id="6874764">1</span><span class="op" id="6874765">]</span>&nbsp;<span class="op" id="6874767">==</span>&nbsp;<span class="string" id="6874770">&#34;millis&#34;</span>&nbsp;<span class="op" id="6874779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874784">if</span>&nbsp;<span class="ident" id="6874787">args</span><span class="op" id="6874791">[</span><span class="num" id="6874792">0</span><span class="op" id="6874793">]</span>&nbsp;<span class="op" id="6874795">==</span>&nbsp;<span class="string" id="6874798">&#34;sleep&#34;</span>&nbsp;<span class="op" id="6874806">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874812">time</span><span class="op" id="6874816">.</span><span class="ident" id="6874817">Sleep</span><span class="op" id="6874822">(</span><span class="ident" id="6874823">time</span><span class="op" id="6874827">.</span><span class="ident" id="6874828">Duration</span><span class="op" id="6874836">(</span><span class="ident" id="6874837">args</span><span class="op" id="6874841">[</span><span class="num" id="6874842">1</span><span class="op" id="6874843">]</span><span class="op" id="6874844">.</span><span class="op" id="6874845">(</span><span class="ident" id="6874846">int64</span><span class="op" id="6874851">)</span><span class="op" id="6874852">)</span>&nbsp;<span class="op" id="6874854">*</span>&nbsp;<span class="ident" id="6874856">time</span><span class="op" id="6874860">.</span><span class="ident" id="6874861">Millisecond</span><span class="op" id="6874872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874888">t</span><span class="op" id="6874889">.</span><span class="ident" id="6874890">mu</span><span class="op" id="6874892">.</span><span class="ident" id="6874893">Lock</span><span class="op" id="6874897">(</span><span class="op" id="6874898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874901">defer</span>&nbsp;<span class="ident" id="6874907">t</span><span class="op" id="6874908">.</span><span class="ident" id="6874909">mu</span><span class="op" id="6874911">.</span><span class="ident" id="6874912">Unlock</span><span class="op" id="6874918">(</span><span class="op" id="6874919">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874923">colIdx</span>&nbsp;<span class="op" id="6874930">:=</span>&nbsp;<span class="builtinfunc" id="6874933">make</span><span class="op" id="6874937">(</span><span class="keyword" id="6874938">map</span><span class="op" id="6874941">[</span><span class="builtintype" id="6874942">string</span><span class="op" id="6874948">]</span><span class="builtintype" id="6874949">int</span><span class="op" id="6874952">)</span>&nbsp;<span class="comment" id="6874954">//&nbsp;select&nbsp;column&nbsp;name&nbsp;-&gt;&nbsp;column&nbsp;index&nbsp;in&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875002">for</span>&nbsp;<span class="ident" id="6875006">_</span><span class="op" id="6875007">,</span>&nbsp;<span class="ident" id="6875009">name</span>&nbsp;<span class="op" id="6875014">:=</span>&nbsp;<span class="keyword" id="6875017">range</span>&nbsp;<span class="ident" id="6875023">s</span><span class="op" id="6875024">.</span><span class="ident" id="6875025">colName</span>&nbsp;<span class="op" id="6875033">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875037">idx</span>&nbsp;<span class="op" id="6875041">:=</span>&nbsp;<span class="ident" id="6875044">t</span><span class="op" id="6875045">.</span><span class="ident" id="6875046">columnIndex</span><span class="op" id="6875057">(</span><span class="ident" id="6875058">name</span><span class="op" id="6875062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875066">if</span>&nbsp;<span class="ident" id="6875069">idx</span>&nbsp;<span class="op" id="6875073">==</span>&nbsp;<span class="op" id="6875076">-</span><span class="num" id="6875077">1</span>&nbsp;<span class="op" id="6875079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875084">return</span>&nbsp;<span class="ident" id="6875091">nil</span><span class="op" id="6875094">,</span>&nbsp;<span class="ident" id="6875096">fmt</span><span class="op" id="6875099">.</span><span class="ident" id="6875100">Errorf</span><span class="op" id="6875106">(</span><span class="string" id="6875107">&#34;fakedb:&nbsp;unknown&nbsp;column&nbsp;name&nbsp;%q&#34;</span><span class="op" id="6875139">,</span>&nbsp;<span class="ident" id="6875141">name</span><span class="op" id="6875145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875153">colIdx</span><span class="op" id="6875159">[</span><span class="ident" id="6875160">name</span><span class="op" id="6875164">]</span>&nbsp;<span class="op" id="6875166">=</span>&nbsp;<span class="ident" id="6875168">idx</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875177">mrows</span>&nbsp;<span class="op" id="6875183">:=</span>&nbsp;<span class="op" id="6875186">[</span><span class="op" id="6875187">]</span><span class="op" id="6875188">*</span><span class="ident" id="6875189">row</span><span class="op" id="6875192">{</span><span class="op" id="6875193">}</span><br>
<span class="lineno"></span><span class="ident" id="6875195">rows</span><span class="op" id="6875199">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875202">for</span>&nbsp;<span class="ident" id="6875206">_</span><span class="op" id="6875207">,</span>&nbsp;<span class="ident" id="6875209">trow</span>&nbsp;<span class="op" id="6875214">:=</span>&nbsp;<span class="keyword" id="6875217">range</span>&nbsp;<span class="ident" id="6875223">t</span><span class="op" id="6875224">.</span><span class="ident" id="6875225">rows</span>&nbsp;<span class="op" id="6875230">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6875234">//&nbsp;Process&nbsp;the&nbsp;where&nbsp;clause,&nbsp;skipping&nbsp;non-match&nbsp;rows.&nbsp;This&nbsp;is&nbsp;lazy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6875303">//&nbsp;and&nbsp;just&nbsp;uses&nbsp;fmt.Sprintf(&#34;%v&#34;)&nbsp;to&nbsp;test&nbsp;equality.&nbsp;&nbsp;Good&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6875371">//&nbsp;for&nbsp;test&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875391">for</span>&nbsp;<span class="ident" id="6875395">widx</span><span class="op" id="6875399">,</span>&nbsp;<span class="ident" id="6875401">wcol</span>&nbsp;<span class="op" id="6875406">:=</span>&nbsp;<span class="keyword" id="6875409">range</span>&nbsp;<span class="ident" id="6875415">s</span><span class="op" id="6875416">.</span><span class="ident" id="6875417">whereCol</span>&nbsp;<span class="op" id="6875426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875431">idx</span>&nbsp;<span class="op" id="6875435">:=</span>&nbsp;<span class="ident" id="6875438">t</span><span class="op" id="6875439">.</span><span class="ident" id="6875440">columnIndex</span><span class="op" id="6875451">(</span><span class="ident" id="6875452">wcol</span><span class="op" id="6875456">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875461">if</span>&nbsp;<span class="ident" id="6875464">idx</span>&nbsp;<span class="op" id="6875468">==</span>&nbsp;<span class="op" id="6875471">-</span><span class="num" id="6875472">1</span>&nbsp;<span class="op" id="6875474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875480">return</span>&nbsp;<span class="ident" id="6875487">nil</span><span class="op" id="6875490">,</span>&nbsp;<span class="ident" id="6875492">fmt</span><span class="op" id="6875495">.</span><span class="ident" id="6875496">Errorf</span><span class="op" id="6875502">(</span><span class="string" id="6875503">&#34;db:&nbsp;invalid&nbsp;where&nbsp;clause&nbsp;column&nbsp;%q&#34;</span><span class="op" id="6875539">,</span>&nbsp;<span class="ident" id="6875541">wcol</span><span class="op" id="6875545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875555">tcol</span>&nbsp;<span class="op" id="6875560">:=</span>&nbsp;<span class="ident" id="6875563">trow</span><span class="op" id="6875567">.</span><span class="ident" id="6875568">cols</span><span class="op" id="6875572">[</span><span class="ident" id="6875573">idx</span><span class="op" id="6875576">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875581">if</span>&nbsp;<span class="ident" id="6875584">bs</span><span class="op" id="6875586">,</span>&nbsp;<span class="ident" id="6875588">ok</span>&nbsp;<span class="op" id="6875591">:=</span>&nbsp;<span class="ident" id="6875594">tcol</span><span class="op" id="6875598">.</span><span class="op" id="6875599">(</span><span class="op" id="6875600">[</span><span class="op" id="6875601">]</span><span class="builtintype" id="6875602">byte</span><span class="op" id="6875606">)</span><span class="op" id="6875607">;</span>&nbsp;<span class="ident" id="6875609">ok</span>&nbsp;<span class="op" id="6875612">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6875618">//&nbsp;lazy&nbsp;hack&nbsp;to&nbsp;avoid&nbsp;sprintf&nbsp;%v&nbsp;on&nbsp;a&nbsp;[]byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875667">tcol</span>&nbsp;<span class="op" id="6875672">=</span>&nbsp;<span class="builtintype" id="6875674">string</span><span class="op" id="6875680">(</span><span class="ident" id="6875681">bs</span><span class="op" id="6875683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875693">if</span>&nbsp;<span class="ident" id="6875696">fmt</span><span class="op" id="6875699">.</span><span class="ident" id="6875700">Sprintf</span><span class="op" id="6875707">(</span><span class="string" id="6875708">&#34;%v&#34;</span><span class="op" id="6875712">,</span>&nbsp;<span class="ident" id="6875714">tcol</span><span class="op" id="6875718">)</span>&nbsp;<span class="op" id="6875720">!=</span>&nbsp;<span class="ident" id="6875723">fmt</span><span class="op" id="6875726">.</span><span class="ident" id="6875727">Sprintf</span><span class="op" id="6875734">(</span><span class="string" id="6875735">&#34;%v&#34;</span><span class="op" id="6875739">,</span>&nbsp;<span class="ident" id="6875741">args</span><span class="op" id="6875745">[</span><span class="ident" id="6875746">widx</span><span class="op" id="6875750">]</span><span class="op" id="6875751">)</span>&nbsp;<span class="op" id="6875753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875759">continue</span>&nbsp;<span class="ident" id="6875768">rows</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875784">mrow</span>&nbsp;<span class="op" id="6875789">:=</span>&nbsp;<span class="op" id="6875792">&amp;</span><span class="ident" id="6875793">row</span><span class="op" id="6875796">{</span><span class="ident" id="6875797">cols</span><span class="op" id="6875801">:</span>&nbsp;<span class="builtinfunc" id="6875803">make</span><span class="op" id="6875807">(</span><span class="op" id="6875808">[</span><span class="op" id="6875809">]</span><span class="keyword" id="6875810">interface</span><span class="op" id="6875819">{</span><span class="op" id="6875820">}</span><span class="op" id="6875821">,</span>&nbsp;<span class="builtinfunc" id="6875823">len</span><span class="op" id="6875826">(</span><span class="ident" id="6875827">s</span><span class="op" id="6875828">.</span><span class="ident" id="6875829">colName</span><span class="op" id="6875836">)</span><span class="op" id="6875837">)</span><span class="op" id="6875838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875842">for</span>&nbsp;<span class="ident" id="6875846">seli</span><span class="op" id="6875850">,</span>&nbsp;<span class="ident" id="6875852">name</span>&nbsp;<span class="op" id="6875857">:=</span>&nbsp;<span class="keyword" id="6875860">range</span>&nbsp;<span class="ident" id="6875866">s</span><span class="op" id="6875867">.</span><span class="ident" id="6875868">colName</span>&nbsp;<span class="op" id="6875876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875881">mrow</span><span class="op" id="6875885">.</span><span class="ident" id="6875886">cols</span><span class="op" id="6875890">[</span><span class="ident" id="6875891">seli</span><span class="op" id="6875895">]</span>&nbsp;<span class="op" id="6875897">=</span>&nbsp;<span class="ident" id="6875899">trow</span><span class="op" id="6875903">.</span><span class="ident" id="6875904">cols</span><span class="op" id="6875908">[</span><span class="ident" id="6875909">colIdx</span><span class="op" id="6875915">[</span><span class="ident" id="6875916">name</span><span class="op" id="6875920">]</span><span class="op" id="6875921">]</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875929">mrows</span>&nbsp;<span class="op" id="6875935">=</span>&nbsp;<span class="builtinfunc" id="6875937">append</span><span class="op" id="6875943">(</span><span class="ident" id="6875944">mrows</span><span class="op" id="6875949">,</span>&nbsp;<span class="ident" id="6875951">mrow</span><span class="op" id="6875955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875962">cursor</span>&nbsp;<span class="op" id="6875969">:=</span>&nbsp;<span class="op" id="6875972">&amp;</span><span class="ident" id="6875973">rowsCursor</span><span class="op" id="6875983">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875987">pos</span><span class="op" id="6875990">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6875995">-</span><span class="num" id="6875996">1</span><span class="op" id="6875997">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876001">rows</span><span class="op" id="6876005">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6876009">mrows</span><span class="op" id="6876014">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876018">cols</span><span class="op" id="6876022">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6876026">s</span><span class="op" id="6876027">.</span><span class="ident" id="6876028">colName</span><span class="op" id="6876035">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876039">errPos</span><span class="op" id="6876045">:</span>&nbsp;<span class="op" id="6876047">-</span><span class="num" id="6876048">1</span><span class="op" id="6876049">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876052">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876055">return</span>&nbsp;<span class="ident" id="6876062">cursor</span><span class="op" id="6876068">,</span>&nbsp;<span class="ident" id="6876070">nil</span><br>
<span class="lineno"></span><span class="op" id="6876074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6876077">func</span>&nbsp;<span class="op" id="6876082">(</span><span class="ident" id="6876083">s</span>&nbsp;<span class="op" id="6876085">*</span><span class="ident" id="6876086">fakeStmt</span><span class="op" id="6876094">)</span>&nbsp;<span class="ident" id="6876096">NumInput</span><span class="op" id="6876104">(</span><span class="op" id="6876105">)</span>&nbsp;<span class="builtintype" id="6876107">int</span>&nbsp;<span class="op" id="6876111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876114">return</span>&nbsp;<span class="ident" id="6876121">s</span><span class="op" id="6876122">.</span><span class="ident" id="6876123">placeholders</span><br>
<span class="lineno">695</span><span class="op" id="6876136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6876139">func</span>&nbsp;<span class="op" id="6876144">(</span><span class="ident" id="6876145">tx</span>&nbsp;<span class="op" id="6876148">*</span><span class="ident" id="6876149">fakeTx</span><span class="op" id="6876155">)</span>&nbsp;<span class="ident" id="6876157">Commit</span><span class="op" id="6876163">(</span><span class="op" id="6876164">)</span>&nbsp;<span class="builtintype" id="6876166">error</span>&nbsp;<span class="op" id="6876172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876175">tx</span><span class="op" id="6876177">.</span><span class="ident" id="6876178">c</span><span class="op" id="6876179">.</span><span class="ident" id="6876180">currTx</span>&nbsp;<span class="op" id="6876187">=</span>&nbsp;<span class="ident" id="6876189">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876194">return</span>&nbsp;<span class="ident" id="6876201">nil</span><br>
<span class="lineno">700</span><span class="op" id="6876205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6876208">func</span>&nbsp;<span class="op" id="6876213">(</span><span class="ident" id="6876214">tx</span>&nbsp;<span class="op" id="6876217">*</span><span class="ident" id="6876218">fakeTx</span><span class="op" id="6876224">)</span>&nbsp;<span class="ident" id="6876226">Rollback</span><span class="op" id="6876234">(</span><span class="op" id="6876235">)</span>&nbsp;<span class="builtintype" id="6876237">error</span>&nbsp;<span class="op" id="6876243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876246">tx</span><span class="op" id="6876248">.</span><span class="ident" id="6876249">c</span><span class="op" id="6876250">.</span><span class="ident" id="6876251">currTx</span>&nbsp;<span class="op" id="6876258">=</span>&nbsp;<span class="ident" id="6876260">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876265">return</span>&nbsp;<span class="ident" id="6876272">nil</span><br>
<span class="lineno">705</span><span class="op" id="6876276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6876279">type</span>&nbsp;<span class="ident" id="6876284">rowsCursor</span>&nbsp;<span class="keyword" id="6876295">struct</span>&nbsp;<span class="op" id="6876302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876305">cols</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6876312">[</span><span class="op" id="6876313">]</span><span class="builtintype" id="6876314">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876322">pos</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6876329">int</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876334">rows</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6876341">[</span><span class="op" id="6876342">]</span><span class="op" id="6876343">*</span><span class="ident" id="6876344">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876349">closed</span>&nbsp;<span class="builtintype" id="6876356">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6876363">//&nbsp;errPos&nbsp;and&nbsp;err&nbsp;are&nbsp;for&nbsp;making&nbsp;Next&nbsp;return&nbsp;early&nbsp;with&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876427">errPos</span>&nbsp;<span class="builtintype" id="6876434">int</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876439">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6876446">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6876454">//&nbsp;a&nbsp;clone&nbsp;of&nbsp;slices&nbsp;to&nbsp;give&nbsp;out&nbsp;to&nbsp;clients,&nbsp;indexed&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6876515">//&nbsp;the&nbsp;original&nbsp;slice&#39;s&nbsp;first&nbsp;byte&nbsp;address.&nbsp;&nbsp;we&nbsp;clone&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6876575">//&nbsp;just&nbsp;so&nbsp;we&#39;re&nbsp;able&nbsp;to&nbsp;corrupt&nbsp;them&nbsp;on&nbsp;close.</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876624">bytesClone</span>&nbsp;<span class="keyword" id="6876635">map</span><span class="op" id="6876638">[</span><span class="op" id="6876639">*</span><span class="builtintype" id="6876640">byte</span><span class="op" id="6876644">]</span><span class="op" id="6876645">[</span><span class="op" id="6876646">]</span><span class="builtintype" id="6876647">byte</span><br>
<span class="lineno"></span><span class="op" id="6876652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6876655">func</span>&nbsp;<span class="op" id="6876660">(</span><span class="ident" id="6876661">rc</span>&nbsp;<span class="op" id="6876664">*</span><span class="ident" id="6876665">rowsCursor</span><span class="op" id="6876675">)</span>&nbsp;<span class="ident" id="6876677">Close</span><span class="op" id="6876682">(</span><span class="op" id="6876683">)</span>&nbsp;<span class="builtintype" id="6876685">error</span>&nbsp;<span class="op" id="6876691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876694">if</span>&nbsp;<span class="op" id="6876697">!</span><span class="ident" id="6876698">rc</span><span class="op" id="6876700">.</span><span class="ident" id="6876701">closed</span>&nbsp;<span class="op" id="6876708">{</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876712">for</span>&nbsp;<span class="ident" id="6876716">_</span><span class="op" id="6876717">,</span>&nbsp;<span class="ident" id="6876719">bs</span>&nbsp;<span class="op" id="6876722">:=</span>&nbsp;<span class="keyword" id="6876725">range</span>&nbsp;<span class="ident" id="6876731">rc</span><span class="op" id="6876733">.</span><span class="ident" id="6876734">bytesClone</span>&nbsp;<span class="op" id="6876745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876750">bs</span><span class="op" id="6876752">[</span><span class="num" id="6876753">0</span><span class="op" id="6876754">]</span>&nbsp;<span class="op" id="6876756">=</span>&nbsp;<span class="num" id="6876758">255</span>&nbsp;<span class="comment" id="6876762">//&nbsp;first&nbsp;byte&nbsp;corrupted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876794">rc</span><span class="op" id="6876796">.</span><span class="ident" id="6876797">closed</span>&nbsp;<span class="op" id="6876804">=</span>&nbsp;<span class="builtintype" id="6876806">true</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876812">return</span>&nbsp;<span class="ident" id="6876819">nil</span><br>
<span class="lineno"></span><span class="op" id="6876823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6876826">func</span>&nbsp;<span class="op" id="6876831">(</span><span class="ident" id="6876832">rc</span>&nbsp;<span class="op" id="6876835">*</span><span class="ident" id="6876836">rowsCursor</span><span class="op" id="6876846">)</span>&nbsp;<span class="ident" id="6876848">Columns</span><span class="op" id="6876855">(</span><span class="op" id="6876856">)</span>&nbsp;<span class="op" id="6876858">[</span><span class="op" id="6876859">]</span><span class="builtintype" id="6876860">string</span>&nbsp;<span class="op" id="6876867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876870">return</span>&nbsp;<span class="ident" id="6876877">rc</span><span class="op" id="6876879">.</span><span class="ident" id="6876880">cols</span><br>
<span class="lineno">735</span><span class="op" id="6876885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6876888">var</span>&nbsp;<span class="ident" id="6876892">rowsCursorNextHook</span>&nbsp;<span class="keyword" id="6876911">func</span><span class="op" id="6876915">(</span><span class="ident" id="6876916">dest</span>&nbsp;<span class="op" id="6876921">[</span><span class="op" id="6876922">]</span><span class="ident" id="6876923">driver</span><span class="op" id="6876929">.</span><span class="ident" id="6876930">Value</span><span class="op" id="6876935">)</span>&nbsp;<span class="builtintype" id="6876937">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6876944">func</span>&nbsp;<span class="op" id="6876949">(</span><span class="ident" id="6876950">rc</span>&nbsp;<span class="op" id="6876953">*</span><span class="ident" id="6876954">rowsCursor</span><span class="op" id="6876964">)</span>&nbsp;<span class="ident" id="6876966">Next</span><span class="op" id="6876970">(</span><span class="ident" id="6876971">dest</span>&nbsp;<span class="op" id="6876976">[</span><span class="op" id="6876977">]</span><span class="ident" id="6876978">driver</span><span class="op" id="6876984">.</span><span class="ident" id="6876985">Value</span><span class="op" id="6876990">)</span>&nbsp;<span class="builtintype" id="6876992">error</span>&nbsp;<span class="op" id="6876998">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877001">if</span>&nbsp;<span class="ident" id="6877004">rowsCursorNextHook</span>&nbsp;<span class="op" id="6877023">!=</span>&nbsp;<span class="ident" id="6877026">nil</span>&nbsp;<span class="op" id="6877030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877034">return</span>&nbsp;<span class="ident" id="6877041">rowsCursorNextHook</span><span class="op" id="6877059">(</span><span class="ident" id="6877060">dest</span><span class="op" id="6877064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877071">if</span>&nbsp;<span class="ident" id="6877074">rc</span><span class="op" id="6877076">.</span><span class="ident" id="6877077">closed</span>&nbsp;<span class="op" id="6877084">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877088">return</span>&nbsp;<span class="ident" id="6877095">errors</span><span class="op" id="6877101">.</span><span class="ident" id="6877102">New</span><span class="op" id="6877105">(</span><span class="string" id="6877106">&#34;fakedb:&nbsp;cursor&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6877132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877138">rc</span><span class="op" id="6877140">.</span><span class="ident" id="6877141">pos</span><span class="op" id="6877144">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877148">if</span>&nbsp;<span class="ident" id="6877151">rc</span><span class="op" id="6877153">.</span><span class="ident" id="6877154">pos</span>&nbsp;<span class="op" id="6877158">==</span>&nbsp;<span class="ident" id="6877161">rc</span><span class="op" id="6877163">.</span><span class="ident" id="6877164">errPos</span>&nbsp;<span class="op" id="6877171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877175">return</span>&nbsp;<span class="ident" id="6877182">rc</span><span class="op" id="6877184">.</span><span class="ident" id="6877185">err</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877193">if</span>&nbsp;<span class="ident" id="6877196">rc</span><span class="op" id="6877198">.</span><span class="ident" id="6877199">pos</span>&nbsp;<span class="op" id="6877203">&gt;=</span>&nbsp;<span class="builtinfunc" id="6877206">len</span><span class="op" id="6877209">(</span><span class="ident" id="6877210">rc</span><span class="op" id="6877212">.</span><span class="ident" id="6877213">rows</span><span class="op" id="6877217">)</span>&nbsp;<span class="op" id="6877219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877223">return</span>&nbsp;<span class="ident" id="6877230">io</span><span class="op" id="6877232">.</span><span class="ident" id="6877233">EOF</span>&nbsp;<span class="comment" id="6877237">//&nbsp;per&nbsp;interface&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877263">for</span>&nbsp;<span class="ident" id="6877267">i</span><span class="op" id="6877268">,</span>&nbsp;<span class="ident" id="6877270">v</span>&nbsp;<span class="op" id="6877272">:=</span>&nbsp;<span class="keyword" id="6877275">range</span>&nbsp;<span class="ident" id="6877281">rc</span><span class="op" id="6877283">.</span><span class="ident" id="6877284">rows</span><span class="op" id="6877288">[</span><span class="ident" id="6877289">rc</span><span class="op" id="6877291">.</span><span class="ident" id="6877292">pos</span><span class="op" id="6877295">]</span><span class="op" id="6877296">.</span><span class="ident" id="6877297">cols</span>&nbsp;<span class="op" id="6877302">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877306">//&nbsp;TODO(bradfitz):&nbsp;convert&nbsp;to&nbsp;subset&nbsp;types?&nbsp;naah,&nbsp;I</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877360">//&nbsp;think&nbsp;the&nbsp;subset&nbsp;types&nbsp;should&nbsp;only&nbsp;be&nbsp;input&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877412">//&nbsp;driver,&nbsp;but&nbsp;the&nbsp;sql&nbsp;package&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877470">//&nbsp;a&nbsp;wider&nbsp;range&nbsp;of&nbsp;types&nbsp;coming&nbsp;out&nbsp;of&nbsp;drivers.&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877525">//&nbsp;for&nbsp;ease&nbsp;of&nbsp;drivers,&nbsp;and&nbsp;to&nbsp;prevent&nbsp;drivers&nbsp;from</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877579">//&nbsp;messing&nbsp;up&nbsp;conversions&nbsp;or&nbsp;doing&nbsp;them&nbsp;differently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877634">dest</span><span class="op" id="6877638">[</span><span class="ident" id="6877639">i</span><span class="op" id="6877640">]</span>&nbsp;<span class="op" id="6877642">=</span>&nbsp;<span class="ident" id="6877644">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877649">if</span>&nbsp;<span class="ident" id="6877652">bs</span><span class="op" id="6877654">,</span>&nbsp;<span class="ident" id="6877656">ok</span>&nbsp;<span class="op" id="6877659">:=</span>&nbsp;<span class="ident" id="6877662">v</span><span class="op" id="6877663">.</span><span class="op" id="6877664">(</span><span class="op" id="6877665">[</span><span class="op" id="6877666">]</span><span class="builtintype" id="6877667">byte</span><span class="op" id="6877671">)</span><span class="op" id="6877672">;</span>&nbsp;<span class="ident" id="6877674">ok</span>&nbsp;<span class="op" id="6877677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877682">if</span>&nbsp;<span class="ident" id="6877685">rc</span><span class="op" id="6877687">.</span><span class="ident" id="6877688">bytesClone</span>&nbsp;<span class="op" id="6877699">==</span>&nbsp;<span class="ident" id="6877702">nil</span>&nbsp;<span class="op" id="6877706">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877712">rc</span><span class="op" id="6877714">.</span><span class="ident" id="6877715">bytesClone</span>&nbsp;<span class="op" id="6877726">=</span>&nbsp;<span class="builtinfunc" id="6877728">make</span><span class="op" id="6877732">(</span><span class="keyword" id="6877733">map</span><span class="op" id="6877736">[</span><span class="op" id="6877737">*</span><span class="builtintype" id="6877738">byte</span><span class="op" id="6877742">]</span><span class="op" id="6877743">[</span><span class="op" id="6877744">]</span><span class="builtintype" id="6877745">byte</span><span class="op" id="6877749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877759">clone</span><span class="op" id="6877764">,</span>&nbsp;<span class="ident" id="6877766">ok</span>&nbsp;<span class="op" id="6877769">:=</span>&nbsp;<span class="ident" id="6877772">rc</span><span class="op" id="6877774">.</span><span class="ident" id="6877775">bytesClone</span><span class="op" id="6877785">[</span><span class="op" id="6877786">&amp;</span><span class="ident" id="6877787">bs</span><span class="op" id="6877789">[</span><span class="num" id="6877790">0</span><span class="op" id="6877791">]</span><span class="op" id="6877792">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877797">if</span>&nbsp;<span class="op" id="6877800">!</span><span class="ident" id="6877801">ok</span>&nbsp;<span class="op" id="6877804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877810">clone</span>&nbsp;<span class="op" id="6877816">=</span>&nbsp;<span class="builtinfunc" id="6877818">make</span><span class="op" id="6877822">(</span><span class="op" id="6877823">[</span><span class="op" id="6877824">]</span><span class="builtintype" id="6877825">byte</span><span class="op" id="6877829">,</span>&nbsp;<span class="builtinfunc" id="6877831">len</span><span class="op" id="6877834">(</span><span class="ident" id="6877835">bs</span><span class="op" id="6877837">)</span><span class="op" id="6877838">)</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6877844">copy</span><span class="op" id="6877848">(</span><span class="ident" id="6877849">clone</span><span class="op" id="6877854">,</span>&nbsp;<span class="ident" id="6877856">bs</span><span class="op" id="6877858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877864">rc</span><span class="op" id="6877866">.</span><span class="ident" id="6877867">bytesClone</span><span class="op" id="6877877">[</span><span class="op" id="6877878">&amp;</span><span class="ident" id="6877879">bs</span><span class="op" id="6877881">[</span><span class="num" id="6877882">0</span><span class="op" id="6877883">]</span><span class="op" id="6877884">]</span>&nbsp;<span class="op" id="6877886">=</span>&nbsp;<span class="ident" id="6877888">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877902">dest</span><span class="op" id="6877906">[</span><span class="ident" id="6877907">i</span><span class="op" id="6877908">]</span>&nbsp;<span class="op" id="6877910">=</span>&nbsp;<span class="ident" id="6877912">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877920">}</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877926">return</span>&nbsp;<span class="ident" id="6877933">nil</span><br>
<span class="lineno"></span><span class="op" id="6877937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6877940">//&nbsp;fakeDriverString&nbsp;is&nbsp;like&nbsp;driver.String,&nbsp;but&nbsp;indirects&nbsp;pointers&nbsp;like</span><br>
<span class="lineno">780</span><span class="comment" id="6878011">//&nbsp;DefaultValueConverter.</span><br>
<span class="lineno"></span><span class="comment" id="6878037">//</span><br>
<span class="lineno"></span><span class="comment" id="6878040">//&nbsp;This&nbsp;could&nbsp;be&nbsp;surprising&nbsp;behavior&nbsp;to&nbsp;retroactively&nbsp;apply&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="6878103">//&nbsp;driver.String&nbsp;now&nbsp;that&nbsp;Go1&nbsp;is&nbsp;out,&nbsp;but&nbsp;this&nbsp;is&nbsp;convenient&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6878168">//&nbsp;our&nbsp;TestPointerParamsAndScans.</span><br>
<span class="lineno">785</span><span class="comment" id="6878202">//</span><br>
<span class="lineno"></span><span class="keyword" id="6878205">type</span>&nbsp;<span class="ident" id="6878210">fakeDriverString</span>&nbsp;<span class="keyword" id="6878227">struct</span><span class="op" id="6878233">{</span><span class="op" id="6878234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6878237">func</span>&nbsp;<span class="op" id="6878242">(</span><span class="ident" id="6878243">fakeDriverString</span><span class="op" id="6878259">)</span>&nbsp;<span class="ident" id="6878261">ConvertValue</span><span class="op" id="6878273">(</span><span class="ident" id="6878274">v</span>&nbsp;<span class="keyword" id="6878276">interface</span><span class="op" id="6878285">{</span><span class="op" id="6878286">}</span><span class="op" id="6878287">)</span>&nbsp;<span class="op" id="6878289">(</span><span class="ident" id="6878290">driver</span><span class="op" id="6878296">.</span><span class="ident" id="6878297">Value</span><span class="op" id="6878302">,</span>&nbsp;<span class="builtintype" id="6878304">error</span><span class="op" id="6878309">)</span>&nbsp;<span class="op" id="6878311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878314">switch</span>&nbsp;<span class="ident" id="6878321">c</span>&nbsp;<span class="op" id="6878323">:=</span>&nbsp;<span class="ident" id="6878326">v</span><span class="op" id="6878327">.</span><span class="op" id="6878328">(</span><span class="keyword" id="6878329">type</span><span class="op" id="6878333">)</span>&nbsp;<span class="op" id="6878335">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878338">case</span>&nbsp;<span class="builtintype" id="6878343">string</span><span class="op" id="6878349">,</span>&nbsp;<span class="op" id="6878351">[</span><span class="op" id="6878352">]</span><span class="builtintype" id="6878353">byte</span><span class="op" id="6878357">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878361">return</span>&nbsp;<span class="ident" id="6878368">v</span><span class="op" id="6878369">,</span>&nbsp;<span class="ident" id="6878371">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878376">case</span>&nbsp;<span class="op" id="6878381">*</span><span class="builtintype" id="6878382">string</span><span class="op" id="6878388">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878392">if</span>&nbsp;<span class="ident" id="6878395">c</span>&nbsp;<span class="op" id="6878397">==</span>&nbsp;<span class="ident" id="6878400">nil</span>&nbsp;<span class="op" id="6878404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878409">return</span>&nbsp;<span class="ident" id="6878416">nil</span><span class="op" id="6878419">,</span>&nbsp;<span class="ident" id="6878421">nil</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878431">return</span>&nbsp;<span class="op" id="6878438">*</span><span class="ident" id="6878439">c</span><span class="op" id="6878440">,</span>&nbsp;<span class="ident" id="6878442">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878450">return</span>&nbsp;<span class="ident" id="6878457">fmt</span><span class="op" id="6878460">.</span><span class="ident" id="6878461">Sprintf</span><span class="op" id="6878468">(</span><span class="string" id="6878469">&#34;%v&#34;</span><span class="op" id="6878473">,</span>&nbsp;<span class="ident" id="6878475">v</span><span class="op" id="6878476">)</span><span class="op" id="6878477">,</span>&nbsp;<span class="ident" id="6878479">nil</span><br>
<span class="lineno"></span><span class="op" id="6878483">}</span><br>
<span class="lineno">800</span><br>
<span class="lineno"></span><span class="keyword" id="6878486">func</span>&nbsp;<span class="ident" id="6878491">converterForType</span><span class="op" id="6878507">(</span><span class="ident" id="6878508">typ</span>&nbsp;<span class="builtintype" id="6878512">string</span><span class="op" id="6878518">)</span>&nbsp;<span class="ident" id="6878520">driver</span><span class="op" id="6878526">.</span><span class="ident" id="6878527">ValueConverter</span>&nbsp;<span class="op" id="6878542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878545">switch</span>&nbsp;<span class="ident" id="6878552">typ</span>&nbsp;<span class="op" id="6878556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878559">case</span>&nbsp;<span class="string" id="6878564">&#34;bool&#34;</span><span class="op" id="6878570">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878574">return</span>&nbsp;<span class="ident" id="6878581">driver</span><span class="op" id="6878587">.</span><span class="ident" id="6878588">Bool</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878594">case</span>&nbsp;<span class="string" id="6878599">&#34;nullbool&#34;</span><span class="op" id="6878609">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878613">return</span>&nbsp;<span class="ident" id="6878620">driver</span><span class="op" id="6878626">.</span><span class="ident" id="6878627">Null</span><span class="op" id="6878631">{</span><span class="ident" id="6878632">Converter</span><span class="op" id="6878641">:</span>&nbsp;<span class="ident" id="6878643">driver</span><span class="op" id="6878649">.</span><span class="ident" id="6878650">Bool</span><span class="op" id="6878654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878657">case</span>&nbsp;<span class="string" id="6878662">&#34;int32&#34;</span><span class="op" id="6878669">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878673">return</span>&nbsp;<span class="ident" id="6878680">driver</span><span class="op" id="6878686">.</span><span class="ident" id="6878687">Int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878694">case</span>&nbsp;<span class="string" id="6878699">&#34;string&#34;</span><span class="op" id="6878707">:</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878711">return</span>&nbsp;<span class="ident" id="6878718">driver</span><span class="op" id="6878724">.</span><span class="ident" id="6878725">NotNull</span><span class="op" id="6878732">{</span><span class="ident" id="6878733">Converter</span><span class="op" id="6878742">:</span>&nbsp;<span class="ident" id="6878744">fakeDriverString</span><span class="op" id="6878760">{</span><span class="op" id="6878761">}</span><span class="op" id="6878762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878765">case</span>&nbsp;<span class="string" id="6878770">&#34;nullstring&#34;</span><span class="op" id="6878782">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878786">return</span>&nbsp;<span class="ident" id="6878793">driver</span><span class="op" id="6878799">.</span><span class="ident" id="6878800">Null</span><span class="op" id="6878804">{</span><span class="ident" id="6878805">Converter</span><span class="op" id="6878814">:</span>&nbsp;<span class="ident" id="6878816">fakeDriverString</span><span class="op" id="6878832">{</span><span class="op" id="6878833">}</span><span class="op" id="6878834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878837">case</span>&nbsp;<span class="string" id="6878842">&#34;int64&#34;</span><span class="op" id="6878849">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6878853">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878905">return</span>&nbsp;<span class="ident" id="6878912">driver</span><span class="op" id="6878918">.</span><span class="ident" id="6878919">NotNull</span><span class="op" id="6878926">{</span><span class="ident" id="6878927">Converter</span><span class="op" id="6878936">:</span>&nbsp;<span class="ident" id="6878938">driver</span><span class="op" id="6878944">.</span><span class="ident" id="6878945">DefaultParameterConverter</span><span class="op" id="6878970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878973">case</span>&nbsp;<span class="string" id="6878978">&#34;nullint64&#34;</span><span class="op" id="6878989">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6878993">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879045">return</span>&nbsp;<span class="ident" id="6879052">driver</span><span class="op" id="6879058">.</span><span class="ident" id="6879059">Null</span><span class="op" id="6879063">{</span><span class="ident" id="6879064">Converter</span><span class="op" id="6879073">:</span>&nbsp;<span class="ident" id="6879075">driver</span><span class="op" id="6879081">.</span><span class="ident" id="6879082">DefaultParameterConverter</span><span class="op" id="6879107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879110">case</span>&nbsp;<span class="string" id="6879115">&#34;float64&#34;</span><span class="op" id="6879124">:</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6879128">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879180">return</span>&nbsp;<span class="ident" id="6879187">driver</span><span class="op" id="6879193">.</span><span class="ident" id="6879194">NotNull</span><span class="op" id="6879201">{</span><span class="ident" id="6879202">Converter</span><span class="op" id="6879211">:</span>&nbsp;<span class="ident" id="6879213">driver</span><span class="op" id="6879219">.</span><span class="ident" id="6879220">DefaultParameterConverter</span><span class="op" id="6879245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879248">case</span>&nbsp;<span class="string" id="6879253">&#34;nullfloat64&#34;</span><span class="op" id="6879266">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6879270">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879322">return</span>&nbsp;<span class="ident" id="6879329">driver</span><span class="op" id="6879335">.</span><span class="ident" id="6879336">Null</span><span class="op" id="6879340">{</span><span class="ident" id="6879341">Converter</span><span class="op" id="6879350">:</span>&nbsp;<span class="ident" id="6879352">driver</span><span class="op" id="6879358">.</span><span class="ident" id="6879359">DefaultParameterConverter</span><span class="op" id="6879384">}</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879387">case</span>&nbsp;<span class="string" id="6879392">&#34;datetime&#34;</span><span class="op" id="6879402">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879406">return</span>&nbsp;<span class="ident" id="6879413">driver</span><span class="op" id="6879419">.</span><span class="ident" id="6879420">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6879450">panic</span><span class="op" id="6879455">(</span><span class="string" id="6879456">&#34;invalid&nbsp;fakedb&nbsp;column&nbsp;type&nbsp;of&nbsp;&#34;</span>&nbsp;<span class="op" id="6879489">+</span>&nbsp;<span class="ident" id="6879491">typ</span><span class="op" id="6879494">)</span><br>
<span class="lineno"></span><span class="op" id="6879496">}</span>
</div>
</body>
</html>
