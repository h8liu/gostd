<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc</h2>
<ul>
<li><a href="/gostd/net/rpc/client.go.html" class="current">client.go</a></li>
<li><a href="/gostd/net/rpc/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/rpc/debug.go.html">debug.go</a></li>
<li><a href="/gostd/net/rpc/server.go.html">server.go</a></li>
<li><a href="/gostd/net/rpc/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5747575">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5747630">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5747684">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5747735">package</span>&nbsp;<span class="ident" id="5747743">rpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5747748">import</span>&nbsp;<span class="op" id="5747755">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5747758">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5747767">&#34;encoding/gob&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5747783">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5747793">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5747799">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5747806">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5747813">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5747825">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5747832">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5747835">//&nbsp;ServerError&nbsp;represents&nbsp;an&nbsp;error&nbsp;that&nbsp;has&nbsp;been&nbsp;returned&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="5747898">//&nbsp;the&nbsp;remote&nbsp;side&nbsp;of&nbsp;the&nbsp;RPC&nbsp;connection.</span><br>
<span class="lineno">20</span><span class="keyword" id="5747940">type</span>&nbsp;<span class="ident" id="5747945">ServerError</span>&nbsp;<span class="builtintype" id="5747957">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5747965">func</span>&nbsp;<span class="op" id="5747970">(</span><span class="ident" id="5747971">e</span>&nbsp;<span class="ident" id="5747973">ServerError</span><span class="op" id="5747984">)</span>&nbsp;<span class="ident" id="5747986">Error</span><span class="op" id="5747991">(</span><span class="op" id="5747992">)</span>&nbsp;<span class="builtintype" id="5747994">string</span>&nbsp;<span class="op" id="5748001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5748004">return</span>&nbsp;<span class="builtintype" id="5748011">string</span><span class="op" id="5748017">(</span><span class="ident" id="5748018">e</span><span class="op" id="5748019">)</span><br>
<span class="lineno"></span><span class="op" id="5748021">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="5748024">var</span>&nbsp;<span class="ident" id="5748028">ErrShutdown</span>&nbsp;<span class="op" id="5748040">=</span>&nbsp;<span class="ident" id="5748042">errors</span><span class="op" id="5748048">.</span><span class="ident" id="5748049">New</span><span class="op" id="5748052">(</span><span class="string" id="5748053">&#34;connection&nbsp;is&nbsp;shut&nbsp;down&#34;</span><span class="op" id="5748078">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5748081">//&nbsp;Call&nbsp;represents&nbsp;an&nbsp;active&nbsp;RPC.</span><br>
<span class="lineno"></span><span class="keyword" id="5748115">type</span>&nbsp;<span class="ident" id="5748120">Call</span>&nbsp;<span class="keyword" id="5748125">struct</span>&nbsp;<span class="op" id="5748132">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5748135">ServiceMethod</span>&nbsp;<span class="builtintype" id="5748149">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5748161">//&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;service&nbsp;and&nbsp;method&nbsp;to&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5748209">Args</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5748223">interface</span><span class="op" id="5748232">{</span><span class="op" id="5748233">}</span>&nbsp;<span class="comment" id="5748235">//&nbsp;The&nbsp;argument&nbsp;to&nbsp;the&nbsp;function&nbsp;(*struct).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5748279">Reply</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5748293">interface</span><span class="op" id="5748302">{</span><span class="op" id="5748303">}</span>&nbsp;<span class="comment" id="5748305">//&nbsp;The&nbsp;reply&nbsp;from&nbsp;the&nbsp;function&nbsp;(*struct).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5748348">Error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5748362">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5748374">//&nbsp;After&nbsp;completion,&nbsp;the&nbsp;error&nbsp;status.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5748414">Done</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5748428">chan</span>&nbsp;<span class="op" id="5748433">*</span><span class="ident" id="5748434">Call</span>&nbsp;&nbsp;<span class="comment" id="5748440">//&nbsp;Strobes&nbsp;when&nbsp;call&nbsp;is&nbsp;complete.</span><br>
<span class="lineno">35</span><span class="op" id="5748474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5748477">//&nbsp;Client&nbsp;represents&nbsp;an&nbsp;RPC&nbsp;Client.</span><br>
<span class="lineno"></span><span class="comment" id="5748513">//&nbsp;There&nbsp;may&nbsp;be&nbsp;multiple&nbsp;outstanding&nbsp;Calls&nbsp;associated</span><br>
<span class="lineno"></span><span class="comment" id="5748567">//&nbsp;with&nbsp;a&nbsp;single&nbsp;Client,&nbsp;and&nbsp;a&nbsp;Client&nbsp;may&nbsp;be&nbsp;used&nbsp;by</span><br>
<span class="lineno">40</span><span class="comment" id="5748620">//&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="keyword" id="5748659">type</span>&nbsp;<span class="ident" id="5748664">Client</span>&nbsp;<span class="keyword" id="5748671">struct</span>&nbsp;<span class="op" id="5748678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5748681">codec</span>&nbsp;<span class="ident" id="5748687">ClientCodec</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5748701">reqMutex</span>&nbsp;<span class="ident" id="5748710">sync</span><span class="op" id="5748714">.</span><span class="ident" id="5748715">Mutex</span>&nbsp;<span class="comment" id="5748721">//&nbsp;protects&nbsp;following</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5748744">request</span>&nbsp;&nbsp;<span class="ident" id="5748753">Request</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5748763">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5748772">sync</span><span class="op" id="5748776">.</span><span class="ident" id="5748777">Mutex</span>&nbsp;<span class="comment" id="5748783">//&nbsp;protects&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5748806">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5748815">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5748823">pending</span>&nbsp;&nbsp;<span class="keyword" id="5748832">map</span><span class="op" id="5748835">[</span><span class="builtintype" id="5748836">uint64</span><span class="op" id="5748842">]</span><span class="op" id="5748843">*</span><span class="ident" id="5748844">Call</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5748850">closing</span>&nbsp;&nbsp;<span class="builtintype" id="5748859">bool</span>&nbsp;<span class="comment" id="5748864">//&nbsp;user&nbsp;has&nbsp;called&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5748890">shutdown</span>&nbsp;<span class="builtintype" id="5748899">bool</span>&nbsp;<span class="comment" id="5748904">//&nbsp;server&nbsp;has&nbsp;told&nbsp;us&nbsp;to&nbsp;stop</span><br>
<span class="lineno"></span><span class="op" id="5748934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5748937">//&nbsp;A&nbsp;ClientCodec&nbsp;implements&nbsp;writing&nbsp;of&nbsp;RPC&nbsp;requests&nbsp;and</span><br>
<span class="lineno">55</span><span class="comment" id="5748993">//&nbsp;reading&nbsp;of&nbsp;RPC&nbsp;responses&nbsp;for&nbsp;the&nbsp;client&nbsp;side&nbsp;of&nbsp;an&nbsp;RPC&nbsp;session.</span><br>
<span class="lineno"></span><span class="comment" id="5749060">//&nbsp;The&nbsp;client&nbsp;calls&nbsp;WriteRequest&nbsp;to&nbsp;write&nbsp;a&nbsp;request&nbsp;to&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5749130">//&nbsp;and&nbsp;calls&nbsp;ReadResponseHeader&nbsp;and&nbsp;ReadResponseBody&nbsp;in&nbsp;pairs</span><br>
<span class="lineno"></span><span class="comment" id="5749192">//&nbsp;to&nbsp;read&nbsp;responses.&nbsp;&nbsp;The&nbsp;client&nbsp;calls&nbsp;Close&nbsp;when&nbsp;finished&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5749261">//&nbsp;connection.&nbsp;ReadResponseBody&nbsp;may&nbsp;be&nbsp;called&nbsp;with&nbsp;a&nbsp;nil</span><br>
<span class="lineno">60</span><span class="comment" id="5749318">//&nbsp;argument&nbsp;to&nbsp;force&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;response&nbsp;to&nbsp;be&nbsp;read&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="5749384">//&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="5749398">type</span>&nbsp;<span class="ident" id="5749403">ClientCodec</span>&nbsp;<span class="keyword" id="5749415">interface</span>&nbsp;<span class="op" id="5749425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5749428">//&nbsp;WriteRequest&nbsp;must&nbsp;be&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5749501">WriteRequest</span><span class="op" id="5749513">(</span><span class="op" id="5749514">*</span><span class="ident" id="5749515">Request</span><span class="op" id="5749522">,</span>&nbsp;<span class="keyword" id="5749524">interface</span><span class="op" id="5749533">{</span><span class="op" id="5749534">}</span><span class="op" id="5749535">)</span>&nbsp;<span class="builtintype" id="5749537">error</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5749544">ReadResponseHeader</span><span class="op" id="5749562">(</span><span class="op" id="5749563">*</span><span class="ident" id="5749564">Response</span><span class="op" id="5749572">)</span>&nbsp;<span class="builtintype" id="5749574">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5749581">ReadResponseBody</span><span class="op" id="5749597">(</span><span class="keyword" id="5749598">interface</span><span class="op" id="5749607">{</span><span class="op" id="5749608">}</span><span class="op" id="5749609">)</span>&nbsp;<span class="builtintype" id="5749611">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5749619">Close</span><span class="op" id="5749624">(</span><span class="op" id="5749625">)</span>&nbsp;<span class="builtintype" id="5749627">error</span><br>
<span class="lineno"></span><span class="op" id="5749633">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="5749636">func</span>&nbsp;<span class="op" id="5749641">(</span><span class="ident" id="5749642">client</span>&nbsp;<span class="op" id="5749649">*</span><span class="ident" id="5749650">Client</span><span class="op" id="5749656">)</span>&nbsp;<span class="ident" id="5749658">send</span><span class="op" id="5749662">(</span><span class="ident" id="5749663">call</span>&nbsp;<span class="op" id="5749668">*</span><span class="ident" id="5749669">Call</span><span class="op" id="5749673">)</span>&nbsp;<span class="op" id="5749675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5749678">client</span><span class="op" id="5749684">.</span><span class="ident" id="5749685">reqMutex</span><span class="op" id="5749693">.</span><span class="ident" id="5749694">Lock</span><span class="op" id="5749698">(</span><span class="op" id="5749699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5749702">defer</span>&nbsp;<span class="ident" id="5749708">client</span><span class="op" id="5749714">.</span><span class="ident" id="5749715">reqMutex</span><span class="op" id="5749723">.</span><span class="ident" id="5749724">Unlock</span><span class="op" id="5749730">(</span><span class="op" id="5749731">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5749735">//&nbsp;Register&nbsp;this&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5749759">client</span><span class="op" id="5749765">.</span><span class="ident" id="5749766">mutex</span><span class="op" id="5749771">.</span><span class="ident" id="5749772">Lock</span><span class="op" id="5749776">(</span><span class="op" id="5749777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5749780">if</span>&nbsp;<span class="ident" id="5749783">client</span><span class="op" id="5749789">.</span><span class="ident" id="5749790">shutdown</span>&nbsp;<span class="op" id="5749799">||</span>&nbsp;<span class="ident" id="5749802">client</span><span class="op" id="5749808">.</span><span class="ident" id="5749809">closing</span>&nbsp;<span class="op" id="5749817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5749821">call</span><span class="op" id="5749825">.</span><span class="ident" id="5749826">Error</span>&nbsp;<span class="op" id="5749832">=</span>&nbsp;<span class="ident" id="5749834">ErrShutdown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5749848">client</span><span class="op" id="5749854">.</span><span class="ident" id="5749855">mutex</span><span class="op" id="5749860">.</span><span class="ident" id="5749861">Unlock</span><span class="op" id="5749867">(</span><span class="op" id="5749868">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5749872">call</span><span class="op" id="5749876">.</span><span class="ident" id="5749877">done</span><span class="op" id="5749881">(</span><span class="op" id="5749882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5749886">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5749894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5749897">seq</span>&nbsp;<span class="op" id="5749901">:=</span>&nbsp;<span class="ident" id="5749904">client</span><span class="op" id="5749910">.</span><span class="ident" id="5749911">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5749916">client</span><span class="op" id="5749922">.</span><span class="ident" id="5749923">seq</span><span class="op" id="5749926">++</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5749930">client</span><span class="op" id="5749936">.</span><span class="ident" id="5749937">pending</span><span class="op" id="5749944">[</span><span class="ident" id="5749945">seq</span><span class="op" id="5749948">]</span>&nbsp;<span class="op" id="5749950">=</span>&nbsp;<span class="ident" id="5749952">call</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5749958">client</span><span class="op" id="5749964">.</span><span class="ident" id="5749965">mutex</span><span class="op" id="5749970">.</span><span class="ident" id="5749971">Unlock</span><span class="op" id="5749977">(</span><span class="op" id="5749978">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5749982">//&nbsp;Encode&nbsp;and&nbsp;send&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5750015">client</span><span class="op" id="5750021">.</span><span class="ident" id="5750022">request</span><span class="op" id="5750029">.</span><span class="ident" id="5750030">Seq</span>&nbsp;<span class="op" id="5750034">=</span>&nbsp;<span class="ident" id="5750036">seq</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5750041">client</span><span class="op" id="5750047">.</span><span class="ident" id="5750048">request</span><span class="op" id="5750055">.</span><span class="ident" id="5750056">ServiceMethod</span>&nbsp;<span class="op" id="5750070">=</span>&nbsp;<span class="ident" id="5750072">call</span><span class="op" id="5750076">.</span><span class="ident" id="5750077">ServiceMethod</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5750092">err</span>&nbsp;<span class="op" id="5750096">:=</span>&nbsp;<span class="ident" id="5750099">client</span><span class="op" id="5750105">.</span><span class="ident" id="5750106">codec</span><span class="op" id="5750111">.</span><span class="ident" id="5750112">WriteRequest</span><span class="op" id="5750124">(</span><span class="op" id="5750125">&amp;</span><span class="ident" id="5750126">client</span><span class="op" id="5750132">.</span><span class="ident" id="5750133">request</span><span class="op" id="5750140">,</span>&nbsp;<span class="ident" id="5750142">call</span><span class="op" id="5750146">.</span><span class="ident" id="5750147">Args</span><span class="op" id="5750151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5750154">if</span>&nbsp;<span class="ident" id="5750157">err</span>&nbsp;<span class="op" id="5750161">!=</span>&nbsp;<span class="builtintype" id="5750164">nil</span>&nbsp;<span class="op" id="5750168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5750172">client</span><span class="op" id="5750178">.</span><span class="ident" id="5750179">mutex</span><span class="op" id="5750184">.</span><span class="ident" id="5750185">Lock</span><span class="op" id="5750189">(</span><span class="op" id="5750190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5750194">call</span>&nbsp;<span class="op" id="5750199">=</span>&nbsp;<span class="ident" id="5750201">client</span><span class="op" id="5750207">.</span><span class="ident" id="5750208">pending</span><span class="op" id="5750215">[</span><span class="ident" id="5750216">seq</span><span class="op" id="5750219">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5750223">delete</span><span class="op" id="5750229">(</span><span class="ident" id="5750230">client</span><span class="op" id="5750236">.</span><span class="ident" id="5750237">pending</span><span class="op" id="5750244">,</span>&nbsp;<span class="ident" id="5750246">seq</span><span class="op" id="5750249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5750253">client</span><span class="op" id="5750259">.</span><span class="ident" id="5750260">mutex</span><span class="op" id="5750265">.</span><span class="ident" id="5750266">Unlock</span><span class="op" id="5750272">(</span><span class="op" id="5750273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5750277">if</span>&nbsp;<span class="ident" id="5750280">call</span>&nbsp;<span class="op" id="5750285">!=</span>&nbsp;<span class="builtintype" id="5750288">nil</span>&nbsp;<span class="op" id="5750292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5750297">call</span><span class="op" id="5750301">.</span><span class="ident" id="5750302">Error</span>&nbsp;<span class="op" id="5750308">=</span>&nbsp;<span class="ident" id="5750310">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5750317">call</span><span class="op" id="5750321">.</span><span class="ident" id="5750322">done</span><span class="op" id="5750326">(</span><span class="op" id="5750327">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5750331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5750334">}</span><br>
<span class="lineno"></span><span class="op" id="5750336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5750339">func</span>&nbsp;<span class="op" id="5750344">(</span><span class="ident" id="5750345">client</span>&nbsp;<span class="op" id="5750352">*</span><span class="ident" id="5750353">Client</span><span class="op" id="5750359">)</span>&nbsp;<span class="ident" id="5750361">input</span><span class="op" id="5750366">(</span><span class="op" id="5750367">)</span>&nbsp;<span class="op" id="5750369">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5750372">var</span>&nbsp;<span class="ident" id="5750376">err</span>&nbsp;<span class="builtintype" id="5750380">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5750387">var</span>&nbsp;<span class="ident" id="5750391">response</span>&nbsp;<span class="ident" id="5750400">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5750410">for</span>&nbsp;<span class="ident" id="5750414">err</span>&nbsp;<span class="op" id="5750418">==</span>&nbsp;<span class="builtintype" id="5750421">nil</span>&nbsp;<span class="op" id="5750425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5750429">response</span>&nbsp;<span class="op" id="5750438">=</span>&nbsp;<span class="ident" id="5750440">Response</span><span class="op" id="5750448">{</span><span class="op" id="5750449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5750453">err</span>&nbsp;<span class="op" id="5750457">=</span>&nbsp;<span class="ident" id="5750459">client</span><span class="op" id="5750465">.</span><span class="ident" id="5750466">codec</span><span class="op" id="5750471">.</span><span class="ident" id="5750472">ReadResponseHeader</span><span class="op" id="5750490">(</span><span class="op" id="5750491">&amp;</span><span class="ident" id="5750492">response</span><span class="op" id="5750500">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5750504">if</span>&nbsp;<span class="ident" id="5750507">err</span>&nbsp;<span class="op" id="5750511">!=</span>&nbsp;<span class="builtintype" id="5750514">nil</span>&nbsp;<span class="op" id="5750518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5750523">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5750531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5750535">seq</span>&nbsp;<span class="op" id="5750539">:=</span>&nbsp;<span class="ident" id="5750542">response</span><span class="op" id="5750550">.</span><span class="ident" id="5750551">Seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5750557">client</span><span class="op" id="5750563">.</span><span class="ident" id="5750564">mutex</span><span class="op" id="5750569">.</span><span class="ident" id="5750570">Lock</span><span class="op" id="5750574">(</span><span class="op" id="5750575">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5750579">call</span>&nbsp;<span class="op" id="5750584">:=</span>&nbsp;<span class="ident" id="5750587">client</span><span class="op" id="5750593">.</span><span class="ident" id="5750594">pending</span><span class="op" id="5750601">[</span><span class="ident" id="5750602">seq</span><span class="op" id="5750605">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5750609">delete</span><span class="op" id="5750615">(</span><span class="ident" id="5750616">client</span><span class="op" id="5750622">.</span><span class="ident" id="5750623">pending</span><span class="op" id="5750630">,</span>&nbsp;<span class="ident" id="5750632">seq</span><span class="op" id="5750635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5750639">client</span><span class="op" id="5750645">.</span><span class="ident" id="5750646">mutex</span><span class="op" id="5750651">.</span><span class="ident" id="5750652">Unlock</span><span class="op" id="5750658">(</span><span class="op" id="5750659">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5750664">switch</span>&nbsp;<span class="op" id="5750671">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5750675">case</span>&nbsp;<span class="ident" id="5750680">call</span>&nbsp;<span class="op" id="5750685">==</span>&nbsp;<span class="builtintype" id="5750688">nil</span><span class="op" id="5750691">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5750696">//&nbsp;We&#39;ve&nbsp;got&nbsp;no&nbsp;pending&nbsp;call.&nbsp;That&nbsp;usually&nbsp;means&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5750753">//&nbsp;WriteRequest&nbsp;partially&nbsp;failed,&nbsp;and&nbsp;call&nbsp;was&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5750811">//&nbsp;removed;&nbsp;response&nbsp;is&nbsp;a&nbsp;server&nbsp;telling&nbsp;us&nbsp;about&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5750867">//&nbsp;error&nbsp;reading&nbsp;request&nbsp;body.&nbsp;We&nbsp;should&nbsp;still&nbsp;attempt</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5750925">//&nbsp;to&nbsp;read&nbsp;error&nbsp;body,&nbsp;but&nbsp;there&#39;s&nbsp;no&nbsp;one&nbsp;to&nbsp;give&nbsp;it&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5750985">err</span>&nbsp;<span class="op" id="5750989">=</span>&nbsp;<span class="ident" id="5750991">client</span><span class="op" id="5750997">.</span><span class="ident" id="5750998">codec</span><span class="op" id="5751003">.</span><span class="ident" id="5751004">ReadResponseBody</span><span class="op" id="5751020">(</span><span class="builtintype" id="5751021">nil</span><span class="op" id="5751024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5751029">if</span>&nbsp;<span class="ident" id="5751032">err</span>&nbsp;<span class="op" id="5751036">!=</span>&nbsp;<span class="builtintype" id="5751039">nil</span>&nbsp;<span class="op" id="5751043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751049">err</span>&nbsp;<span class="op" id="5751053">=</span>&nbsp;<span class="ident" id="5751055">errors</span><span class="op" id="5751061">.</span><span class="ident" id="5751062">New</span><span class="op" id="5751065">(</span><span class="string" id="5751066">&#34;reading&nbsp;error&nbsp;body:&nbsp;&#34;</span>&nbsp;<span class="op" id="5751089">+</span>&nbsp;<span class="ident" id="5751091">err</span><span class="op" id="5751094">.</span><span class="ident" id="5751095">Error</span><span class="op" id="5751100">(</span><span class="op" id="5751101">)</span><span class="op" id="5751102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5751107">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5751111">case</span>&nbsp;<span class="ident" id="5751116">response</span><span class="op" id="5751124">.</span><span class="ident" id="5751125">Error</span>&nbsp;<span class="op" id="5751131">!=</span>&nbsp;<span class="string" id="5751134">&#34;&#34;</span><span class="op" id="5751136">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5751141">//&nbsp;We&#39;ve&nbsp;got&nbsp;an&nbsp;error&nbsp;response.&nbsp;Give&nbsp;this&nbsp;to&nbsp;the&nbsp;request;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5751202">//&nbsp;any&nbsp;subsequent&nbsp;requests&nbsp;will&nbsp;get&nbsp;the&nbsp;ReadResponseBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5751262">//&nbsp;error&nbsp;if&nbsp;there&nbsp;is&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751291">call</span><span class="op" id="5751295">.</span><span class="ident" id="5751296">Error</span>&nbsp;<span class="op" id="5751302">=</span>&nbsp;<span class="ident" id="5751304">ServerError</span><span class="op" id="5751315">(</span><span class="ident" id="5751316">response</span><span class="op" id="5751324">.</span><span class="ident" id="5751325">Error</span><span class="op" id="5751330">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751335">err</span>&nbsp;<span class="op" id="5751339">=</span>&nbsp;<span class="ident" id="5751341">client</span><span class="op" id="5751347">.</span><span class="ident" id="5751348">codec</span><span class="op" id="5751353">.</span><span class="ident" id="5751354">ReadResponseBody</span><span class="op" id="5751370">(</span><span class="builtintype" id="5751371">nil</span><span class="op" id="5751374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5751379">if</span>&nbsp;<span class="ident" id="5751382">err</span>&nbsp;<span class="op" id="5751386">!=</span>&nbsp;<span class="builtintype" id="5751389">nil</span>&nbsp;<span class="op" id="5751393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751399">err</span>&nbsp;<span class="op" id="5751403">=</span>&nbsp;<span class="ident" id="5751405">errors</span><span class="op" id="5751411">.</span><span class="ident" id="5751412">New</span><span class="op" id="5751415">(</span><span class="string" id="5751416">&#34;reading&nbsp;error&nbsp;body:&nbsp;&#34;</span>&nbsp;<span class="op" id="5751439">+</span>&nbsp;<span class="ident" id="5751441">err</span><span class="op" id="5751444">.</span><span class="ident" id="5751445">Error</span><span class="op" id="5751450">(</span><span class="op" id="5751451">)</span><span class="op" id="5751452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5751457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751462">call</span><span class="op" id="5751466">.</span><span class="ident" id="5751467">done</span><span class="op" id="5751471">(</span><span class="op" id="5751472">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5751476">default</span><span class="op" id="5751483">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751488">err</span>&nbsp;<span class="op" id="5751492">=</span>&nbsp;<span class="ident" id="5751494">client</span><span class="op" id="5751500">.</span><span class="ident" id="5751501">codec</span><span class="op" id="5751506">.</span><span class="ident" id="5751507">ReadResponseBody</span><span class="op" id="5751523">(</span><span class="ident" id="5751524">call</span><span class="op" id="5751528">.</span><span class="ident" id="5751529">Reply</span><span class="op" id="5751534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5751539">if</span>&nbsp;<span class="ident" id="5751542">err</span>&nbsp;<span class="op" id="5751546">!=</span>&nbsp;<span class="builtintype" id="5751549">nil</span>&nbsp;<span class="op" id="5751553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751559">call</span><span class="op" id="5751563">.</span><span class="ident" id="5751564">Error</span>&nbsp;<span class="op" id="5751570">=</span>&nbsp;<span class="ident" id="5751572">errors</span><span class="op" id="5751578">.</span><span class="ident" id="5751579">New</span><span class="op" id="5751582">(</span><span class="string" id="5751583">&#34;reading&nbsp;body&nbsp;&#34;</span>&nbsp;<span class="op" id="5751599">+</span>&nbsp;<span class="ident" id="5751601">err</span><span class="op" id="5751604">.</span><span class="ident" id="5751605">Error</span><span class="op" id="5751610">(</span><span class="op" id="5751611">)</span><span class="op" id="5751612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5751617">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751622">call</span><span class="op" id="5751626">.</span><span class="ident" id="5751627">done</span><span class="op" id="5751631">(</span><span class="op" id="5751632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5751636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5751639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5751642">//&nbsp;Terminate&nbsp;pending&nbsp;calls.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751671">client</span><span class="op" id="5751677">.</span><span class="ident" id="5751678">reqMutex</span><span class="op" id="5751686">.</span><span class="ident" id="5751687">Lock</span><span class="op" id="5751691">(</span><span class="op" id="5751692">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751695">client</span><span class="op" id="5751701">.</span><span class="ident" id="5751702">mutex</span><span class="op" id="5751707">.</span><span class="ident" id="5751708">Lock</span><span class="op" id="5751712">(</span><span class="op" id="5751713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751716">client</span><span class="op" id="5751722">.</span><span class="ident" id="5751723">shutdown</span>&nbsp;<span class="op" id="5751732">=</span>&nbsp;<span class="builtintype" id="5751734">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751740">closing</span>&nbsp;<span class="op" id="5751748">:=</span>&nbsp;<span class="ident" id="5751751">client</span><span class="op" id="5751757">.</span><span class="ident" id="5751758">closing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5751767">if</span>&nbsp;<span class="ident" id="5751770">err</span>&nbsp;<span class="op" id="5751774">==</span>&nbsp;<span class="ident" id="5751777">io</span><span class="op" id="5751779">.</span><span class="ident" id="5751780">EOF</span>&nbsp;<span class="op" id="5751784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5751788">if</span>&nbsp;<span class="ident" id="5751791">closing</span>&nbsp;<span class="op" id="5751799">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751804">err</span>&nbsp;<span class="op" id="5751808">=</span>&nbsp;<span class="ident" id="5751810">ErrShutdown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5751824">}</span>&nbsp;<span class="keyword" id="5751826">else</span>&nbsp;<span class="op" id="5751831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751836">err</span>&nbsp;<span class="op" id="5751840">=</span>&nbsp;<span class="ident" id="5751842">io</span><span class="op" id="5751844">.</span><span class="ident" id="5751845">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5751864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5751867">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5751870">for</span>&nbsp;<span class="ident" id="5751874">_</span><span class="op" id="5751875">,</span>&nbsp;<span class="ident" id="5751877">call</span>&nbsp;<span class="op" id="5751882">:=</span>&nbsp;<span class="keyword" id="5751885">range</span>&nbsp;<span class="ident" id="5751891">client</span><span class="op" id="5751897">.</span><span class="ident" id="5751898">pending</span>&nbsp;<span class="op" id="5751906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751910">call</span><span class="op" id="5751914">.</span><span class="ident" id="5751915">Error</span>&nbsp;<span class="op" id="5751921">=</span>&nbsp;<span class="ident" id="5751923">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751929">call</span><span class="op" id="5751933">.</span><span class="ident" id="5751934">done</span><span class="op" id="5751938">(</span><span class="op" id="5751939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5751942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751945">client</span><span class="op" id="5751951">.</span><span class="ident" id="5751952">mutex</span><span class="op" id="5751957">.</span><span class="ident" id="5751958">Unlock</span><span class="op" id="5751964">(</span><span class="op" id="5751965">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5751968">client</span><span class="op" id="5751974">.</span><span class="ident" id="5751975">reqMutex</span><span class="op" id="5751983">.</span><span class="ident" id="5751984">Unlock</span><span class="op" id="5751990">(</span><span class="op" id="5751991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5751994">if</span>&nbsp;<span class="ident" id="5751997">debugLog</span>&nbsp;<span class="op" id="5752006">&amp;&amp;</span>&nbsp;<span class="ident" id="5752009">err</span>&nbsp;<span class="op" id="5752013">!=</span>&nbsp;<span class="ident" id="5752016">io</span><span class="op" id="5752018">.</span><span class="ident" id="5752019">EOF</span>&nbsp;<span class="op" id="5752023">&amp;&amp;</span>&nbsp;<span class="op" id="5752026">!</span><span class="ident" id="5752027">closing</span>&nbsp;<span class="op" id="5752035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5752039">log</span><span class="op" id="5752042">.</span><span class="ident" id="5752043">Println</span><span class="op" id="5752050">(</span><span class="string" id="5752051">&#34;rpc:&nbsp;client&nbsp;protocol&nbsp;error:&#34;</span><span class="op" id="5752080">,</span>&nbsp;<span class="ident" id="5752082">err</span><span class="op" id="5752085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5752088">}</span><br>
<span class="lineno"></span><span class="op" id="5752090">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="5752093">func</span>&nbsp;<span class="op" id="5752098">(</span><span class="ident" id="5752099">call</span>&nbsp;<span class="op" id="5752104">*</span><span class="ident" id="5752105">Call</span><span class="op" id="5752109">)</span>&nbsp;<span class="ident" id="5752111">done</span><span class="op" id="5752115">(</span><span class="op" id="5752116">)</span>&nbsp;<span class="op" id="5752118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5752121">select</span>&nbsp;<span class="op" id="5752128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5752131">case</span>&nbsp;<span class="ident" id="5752136">call</span><span class="op" id="5752140">.</span><span class="ident" id="5752141">Done</span>&nbsp;<span class="op" id="5752146">&lt;-</span>&nbsp;<span class="ident" id="5752149">call</span><span class="op" id="5752153">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5752157">//&nbsp;ok</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5752164">default</span><span class="op" id="5752171">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5752175">//&nbsp;We&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;block&nbsp;here.&nbsp;&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;make</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5752252">//&nbsp;sure&nbsp;the&nbsp;channel&nbsp;has&nbsp;enough&nbsp;buffer&nbsp;space.&nbsp;See&nbsp;comment&nbsp;in&nbsp;Go().</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5752320">if</span>&nbsp;<span class="ident" id="5752323">debugLog</span>&nbsp;<span class="op" id="5752332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5752337">log</span><span class="op" id="5752340">.</span><span class="ident" id="5752341">Println</span><span class="op" id="5752348">(</span><span class="string" id="5752349">&#34;rpc:&nbsp;discarding&nbsp;Call&nbsp;reply&nbsp;due&nbsp;to&nbsp;insufficient&nbsp;Done&nbsp;chan&nbsp;capacity&#34;</span><span class="op" id="5752416">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5752420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5752423">}</span><br>
<span class="lineno"></span><span class="op" id="5752425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5752428">//&nbsp;NewClient&nbsp;returns&nbsp;a&nbsp;new&nbsp;Client&nbsp;to&nbsp;handle&nbsp;requests&nbsp;to&nbsp;the</span><br>
<span class="lineno">185</span><span class="comment" id="5752488">//&nbsp;set&nbsp;of&nbsp;services&nbsp;at&nbsp;the&nbsp;other&nbsp;end&nbsp;of&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5752543">//&nbsp;It&nbsp;adds&nbsp;a&nbsp;buffer&nbsp;to&nbsp;the&nbsp;write&nbsp;side&nbsp;of&nbsp;the&nbsp;connection&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5752602">//&nbsp;the&nbsp;header&nbsp;and&nbsp;payload&nbsp;are&nbsp;sent&nbsp;as&nbsp;a&nbsp;unit.</span><br>
<span class="lineno"></span><span class="keyword" id="5752648">func</span>&nbsp;<span class="ident" id="5752653">NewClient</span><span class="op" id="5752662">(</span><span class="ident" id="5752663">conn</span>&nbsp;<span class="ident" id="5752668">io</span><span class="op" id="5752670">.</span><span class="ident" id="5752671">ReadWriteCloser</span><span class="op" id="5752686">)</span>&nbsp;<span class="op" id="5752688">*</span><span class="ident" id="5752689">Client</span>&nbsp;<span class="op" id="5752696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5752699">encBuf</span>&nbsp;<span class="op" id="5752706">:=</span>&nbsp;<span class="ident" id="5752709">bufio</span><span class="op" id="5752714">.</span><span class="ident" id="5752715">NewWriter</span><span class="op" id="5752724">(</span><span class="ident" id="5752725">conn</span><span class="op" id="5752729">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5752732">client</span>&nbsp;<span class="op" id="5752739">:=</span>&nbsp;<span class="op" id="5752742">&amp;</span><span class="ident" id="5752743">gobClientCodec</span><span class="op" id="5752757">{</span><span class="ident" id="5752758">conn</span><span class="op" id="5752762">,</span>&nbsp;<span class="ident" id="5752764">gob</span><span class="op" id="5752767">.</span><span class="ident" id="5752768">NewDecoder</span><span class="op" id="5752778">(</span><span class="ident" id="5752779">conn</span><span class="op" id="5752783">)</span><span class="op" id="5752784">,</span>&nbsp;<span class="ident" id="5752786">gob</span><span class="op" id="5752789">.</span><span class="ident" id="5752790">NewEncoder</span><span class="op" id="5752800">(</span><span class="ident" id="5752801">encBuf</span><span class="op" id="5752807">)</span><span class="op" id="5752808">,</span>&nbsp;<span class="ident" id="5752810">encBuf</span><span class="op" id="5752816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5752819">return</span>&nbsp;<span class="ident" id="5752826">NewClientWithCodec</span><span class="op" id="5752844">(</span><span class="ident" id="5752845">client</span><span class="op" id="5752851">)</span><br>
<span class="lineno"></span><span class="op" id="5752853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5752856">//&nbsp;NewClientWithCodec&nbsp;is&nbsp;like&nbsp;NewClient&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified</span><br>
<span class="lineno">195</span><span class="comment" id="5752919">//&nbsp;codec&nbsp;to&nbsp;encode&nbsp;requests&nbsp;and&nbsp;decode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5752969">func</span>&nbsp;<span class="ident" id="5752974">NewClientWithCodec</span><span class="op" id="5752992">(</span><span class="ident" id="5752993">codec</span>&nbsp;<span class="ident" id="5752999">ClientCodec</span><span class="op" id="5753010">)</span>&nbsp;<span class="op" id="5753012">*</span><span class="ident" id="5753013">Client</span>&nbsp;<span class="op" id="5753020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5753023">client</span>&nbsp;<span class="op" id="5753030">:=</span>&nbsp;<span class="op" id="5753033">&amp;</span><span class="ident" id="5753034">Client</span><span class="op" id="5753040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5753044">codec</span><span class="op" id="5753049">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5753053">codec</span><span class="op" id="5753058">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5753062">pending</span><span class="op" id="5753069">:</span>&nbsp;<span class="builtinfunc" id="5753071">make</span><span class="op" id="5753075">(</span><span class="keyword" id="5753076">map</span><span class="op" id="5753079">[</span><span class="builtintype" id="5753080">uint64</span><span class="op" id="5753086">]</span><span class="op" id="5753087">*</span><span class="ident" id="5753088">Call</span><span class="op" id="5753092">)</span><span class="op" id="5753093">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5753096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5753099">go</span>&nbsp;<span class="ident" id="5753102">client</span><span class="op" id="5753108">.</span><span class="ident" id="5753109">input</span><span class="op" id="5753114">(</span><span class="op" id="5753115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5753118">return</span>&nbsp;<span class="ident" id="5753125">client</span><br>
<span class="lineno"></span><span class="op" id="5753132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="keyword" id="5753135">type</span>&nbsp;<span class="ident" id="5753140">gobClientCodec</span>&nbsp;<span class="keyword" id="5753155">struct</span>&nbsp;<span class="op" id="5753162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5753165">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5753172">io</span><span class="op" id="5753174">.</span><span class="ident" id="5753175">ReadWriteCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5753192">dec</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5753199">*</span><span class="ident" id="5753200">gob</span><span class="op" id="5753203">.</span><span class="ident" id="5753204">Decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5753213">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5753220">*</span><span class="ident" id="5753221">gob</span><span class="op" id="5753224">.</span><span class="ident" id="5753225">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5753234">encBuf</span>&nbsp;<span class="op" id="5753241">*</span><span class="ident" id="5753242">bufio</span><span class="op" id="5753247">.</span><span class="ident" id="5753248">Writer</span><br>
<span class="lineno">210</span><span class="op" id="5753255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5753258">func</span>&nbsp;<span class="op" id="5753263">(</span><span class="ident" id="5753264">c</span>&nbsp;<span class="op" id="5753266">*</span><span class="ident" id="5753267">gobClientCodec</span><span class="op" id="5753281">)</span>&nbsp;<span class="ident" id="5753283">WriteRequest</span><span class="op" id="5753295">(</span><span class="ident" id="5753296">r</span>&nbsp;<span class="op" id="5753298">*</span><span class="ident" id="5753299">Request</span><span class="op" id="5753306">,</span>&nbsp;<span class="ident" id="5753308">body</span>&nbsp;<span class="keyword" id="5753313">interface</span><span class="op" id="5753322">{</span><span class="op" id="5753323">}</span><span class="op" id="5753324">)</span>&nbsp;<span class="op" id="5753326">(</span><span class="ident" id="5753327">err</span>&nbsp;<span class="builtintype" id="5753331">error</span><span class="op" id="5753336">)</span>&nbsp;<span class="op" id="5753338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5753341">if</span>&nbsp;<span class="ident" id="5753344">err</span>&nbsp;<span class="op" id="5753348">=</span>&nbsp;<span class="ident" id="5753350">c</span><span class="op" id="5753351">.</span><span class="ident" id="5753352">enc</span><span class="op" id="5753355">.</span><span class="ident" id="5753356">Encode</span><span class="op" id="5753362">(</span><span class="ident" id="5753363">r</span><span class="op" id="5753364">)</span><span class="op" id="5753365">;</span>&nbsp;<span class="ident" id="5753367">err</span>&nbsp;<span class="op" id="5753371">!=</span>&nbsp;<span class="builtintype" id="5753374">nil</span>&nbsp;<span class="op" id="5753378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5753382">return</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5753390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5753393">if</span>&nbsp;<span class="ident" id="5753396">err</span>&nbsp;<span class="op" id="5753400">=</span>&nbsp;<span class="ident" id="5753402">c</span><span class="op" id="5753403">.</span><span class="ident" id="5753404">enc</span><span class="op" id="5753407">.</span><span class="ident" id="5753408">Encode</span><span class="op" id="5753414">(</span><span class="ident" id="5753415">body</span><span class="op" id="5753419">)</span><span class="op" id="5753420">;</span>&nbsp;<span class="ident" id="5753422">err</span>&nbsp;<span class="op" id="5753426">!=</span>&nbsp;<span class="builtintype" id="5753429">nil</span>&nbsp;<span class="op" id="5753433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5753437">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5753445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5753448">return</span>&nbsp;<span class="ident" id="5753455">c</span><span class="op" id="5753456">.</span><span class="ident" id="5753457">encBuf</span><span class="op" id="5753463">.</span><span class="ident" id="5753464">Flush</span><span class="op" id="5753469">(</span><span class="op" id="5753470">)</span><br>
<span class="lineno">220</span><span class="op" id="5753472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5753475">func</span>&nbsp;<span class="op" id="5753480">(</span><span class="ident" id="5753481">c</span>&nbsp;<span class="op" id="5753483">*</span><span class="ident" id="5753484">gobClientCodec</span><span class="op" id="5753498">)</span>&nbsp;<span class="ident" id="5753500">ReadResponseHeader</span><span class="op" id="5753518">(</span><span class="ident" id="5753519">r</span>&nbsp;<span class="op" id="5753521">*</span><span class="ident" id="5753522">Response</span><span class="op" id="5753530">)</span>&nbsp;<span class="builtintype" id="5753532">error</span>&nbsp;<span class="op" id="5753538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5753541">return</span>&nbsp;<span class="ident" id="5753548">c</span><span class="op" id="5753549">.</span><span class="ident" id="5753550">dec</span><span class="op" id="5753553">.</span><span class="ident" id="5753554">Decode</span><span class="op" id="5753560">(</span><span class="ident" id="5753561">r</span><span class="op" id="5753562">)</span><br>
<span class="lineno"></span><span class="op" id="5753564">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="5753567">func</span>&nbsp;<span class="op" id="5753572">(</span><span class="ident" id="5753573">c</span>&nbsp;<span class="op" id="5753575">*</span><span class="ident" id="5753576">gobClientCodec</span><span class="op" id="5753590">)</span>&nbsp;<span class="ident" id="5753592">ReadResponseBody</span><span class="op" id="5753608">(</span><span class="ident" id="5753609">body</span>&nbsp;<span class="keyword" id="5753614">interface</span><span class="op" id="5753623">{</span><span class="op" id="5753624">}</span><span class="op" id="5753625">)</span>&nbsp;<span class="builtintype" id="5753627">error</span>&nbsp;<span class="op" id="5753633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5753636">return</span>&nbsp;<span class="ident" id="5753643">c</span><span class="op" id="5753644">.</span><span class="ident" id="5753645">dec</span><span class="op" id="5753648">.</span><span class="ident" id="5753649">Decode</span><span class="op" id="5753655">(</span><span class="ident" id="5753656">body</span><span class="op" id="5753660">)</span><br>
<span class="lineno"></span><span class="op" id="5753662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="5753665">func</span>&nbsp;<span class="op" id="5753670">(</span><span class="ident" id="5753671">c</span>&nbsp;<span class="op" id="5753673">*</span><span class="ident" id="5753674">gobClientCodec</span><span class="op" id="5753688">)</span>&nbsp;<span class="ident" id="5753690">Close</span><span class="op" id="5753695">(</span><span class="op" id="5753696">)</span>&nbsp;<span class="builtintype" id="5753698">error</span>&nbsp;<span class="op" id="5753704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5753707">return</span>&nbsp;<span class="ident" id="5753714">c</span><span class="op" id="5753715">.</span><span class="ident" id="5753716">rwc</span><span class="op" id="5753719">.</span><span class="ident" id="5753720">Close</span><span class="op" id="5753725">(</span><span class="op" id="5753726">)</span><br>
<span class="lineno"></span><span class="op" id="5753728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5753731">//&nbsp;DialHTTP&nbsp;connects&nbsp;to&nbsp;an&nbsp;HTTP&nbsp;RPC&nbsp;server&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address</span><br>
<span class="lineno">235</span><span class="comment" id="5753807">//&nbsp;listening&nbsp;on&nbsp;the&nbsp;default&nbsp;HTTP&nbsp;RPC&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="5753850">func</span>&nbsp;<span class="ident" id="5753855">DialHTTP</span><span class="op" id="5753863">(</span><span class="ident" id="5753864">network</span><span class="op" id="5753871">,</span>&nbsp;<span class="ident" id="5753873">address</span>&nbsp;<span class="builtintype" id="5753881">string</span><span class="op" id="5753887">)</span>&nbsp;<span class="op" id="5753889">(</span><span class="op" id="5753890">*</span><span class="ident" id="5753891">Client</span><span class="op" id="5753897">,</span>&nbsp;<span class="builtintype" id="5753899">error</span><span class="op" id="5753904">)</span>&nbsp;<span class="op" id="5753906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5753909">return</span>&nbsp;<span class="ident" id="5753916">DialHTTPPath</span><span class="op" id="5753928">(</span><span class="ident" id="5753929">network</span><span class="op" id="5753936">,</span>&nbsp;<span class="ident" id="5753938">address</span><span class="op" id="5753945">,</span>&nbsp;<span class="ident" id="5753947">DefaultRPCPath</span><span class="op" id="5753961">)</span><br>
<span class="lineno"></span><span class="op" id="5753963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="comment" id="5753966">//&nbsp;DialHTTPPath&nbsp;connects&nbsp;to&nbsp;an&nbsp;HTTP&nbsp;RPC&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="5754013">//&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address&nbsp;and&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="5754059">func</span>&nbsp;<span class="ident" id="5754064">DialHTTPPath</span><span class="op" id="5754076">(</span><span class="ident" id="5754077">network</span><span class="op" id="5754084">,</span>&nbsp;<span class="ident" id="5754086">address</span><span class="op" id="5754093">,</span>&nbsp;<span class="ident" id="5754095">path</span>&nbsp;<span class="builtintype" id="5754100">string</span><span class="op" id="5754106">)</span>&nbsp;<span class="op" id="5754108">(</span><span class="op" id="5754109">*</span><span class="ident" id="5754110">Client</span><span class="op" id="5754116">,</span>&nbsp;<span class="builtintype" id="5754118">error</span><span class="op" id="5754123">)</span>&nbsp;<span class="op" id="5754125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5754128">var</span>&nbsp;<span class="ident" id="5754132">err</span>&nbsp;<span class="builtintype" id="5754136">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5754143">conn</span><span class="op" id="5754147">,</span>&nbsp;<span class="ident" id="5754149">err</span>&nbsp;<span class="op" id="5754153">:=</span>&nbsp;<span class="ident" id="5754156">net</span><span class="op" id="5754159">.</span><span class="ident" id="5754160">Dial</span><span class="op" id="5754164">(</span><span class="ident" id="5754165">network</span><span class="op" id="5754172">,</span>&nbsp;<span class="ident" id="5754174">address</span><span class="op" id="5754181">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5754184">if</span>&nbsp;<span class="ident" id="5754187">err</span>&nbsp;<span class="op" id="5754191">!=</span>&nbsp;<span class="builtintype" id="5754194">nil</span>&nbsp;<span class="op" id="5754198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5754202">return</span>&nbsp;<span class="builtintype" id="5754209">nil</span><span class="op" id="5754212">,</span>&nbsp;<span class="ident" id="5754214">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5754219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5754222">io</span><span class="op" id="5754224">.</span><span class="ident" id="5754225">WriteString</span><span class="op" id="5754236">(</span><span class="ident" id="5754237">conn</span><span class="op" id="5754241">,</span>&nbsp;<span class="string" id="5754243">&#34;CONNECT&nbsp;&#34;</span><span class="op" id="5754253">+</span><span class="ident" id="5754254">path</span><span class="op" id="5754258">+</span><span class="string" id="5754259">&#34;&nbsp;HTTP/1.0\n\n&#34;</span><span class="op" id="5754274">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5754278">//&nbsp;Require&nbsp;successful&nbsp;HTTP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5754315">//&nbsp;before&nbsp;switching&nbsp;to&nbsp;RPC&nbsp;protocol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5754353">resp</span><span class="op" id="5754357">,</span>&nbsp;<span class="ident" id="5754359">err</span>&nbsp;<span class="op" id="5754363">:=</span>&nbsp;<span class="ident" id="5754366">http</span><span class="op" id="5754370">.</span><span class="ident" id="5754371">ReadResponse</span><span class="op" id="5754383">(</span><span class="ident" id="5754384">bufio</span><span class="op" id="5754389">.</span><span class="ident" id="5754390">NewReader</span><span class="op" id="5754399">(</span><span class="ident" id="5754400">conn</span><span class="op" id="5754404">)</span><span class="op" id="5754405">,</span>&nbsp;<span class="op" id="5754407">&amp;</span><span class="ident" id="5754408">http</span><span class="op" id="5754412">.</span><span class="ident" id="5754413">Request</span><span class="op" id="5754420">{</span><span class="ident" id="5754421">Method</span><span class="op" id="5754427">:</span>&nbsp;<span class="string" id="5754429">&#34;CONNECT&#34;</span><span class="op" id="5754438">}</span><span class="op" id="5754439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5754442">if</span>&nbsp;<span class="ident" id="5754445">err</span>&nbsp;<span class="op" id="5754449">==</span>&nbsp;<span class="builtintype" id="5754452">nil</span>&nbsp;<span class="op" id="5754456">&amp;&amp;</span>&nbsp;<span class="ident" id="5754459">resp</span><span class="op" id="5754463">.</span><span class="ident" id="5754464">Status</span>&nbsp;<span class="op" id="5754471">==</span>&nbsp;<span class="ident" id="5754474">connected</span>&nbsp;<span class="op" id="5754484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5754488">return</span>&nbsp;<span class="ident" id="5754495">NewClient</span><span class="op" id="5754504">(</span><span class="ident" id="5754505">conn</span><span class="op" id="5754509">)</span><span class="op" id="5754510">,</span>&nbsp;<span class="builtintype" id="5754512">nil</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5754517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5754520">if</span>&nbsp;<span class="ident" id="5754523">err</span>&nbsp;<span class="op" id="5754527">==</span>&nbsp;<span class="builtintype" id="5754530">nil</span>&nbsp;<span class="op" id="5754534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5754538">err</span>&nbsp;<span class="op" id="5754542">=</span>&nbsp;<span class="ident" id="5754544">errors</span><span class="op" id="5754550">.</span><span class="ident" id="5754551">New</span><span class="op" id="5754554">(</span><span class="string" id="5754555">&#34;unexpected&nbsp;HTTP&nbsp;response:&nbsp;&#34;</span>&nbsp;<span class="op" id="5754584">+</span>&nbsp;<span class="ident" id="5754586">resp</span><span class="op" id="5754590">.</span><span class="ident" id="5754591">Status</span><span class="op" id="5754597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5754600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5754603">conn</span><span class="op" id="5754607">.</span><span class="ident" id="5754608">Close</span><span class="op" id="5754613">(</span><span class="op" id="5754614">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5754617">return</span>&nbsp;<span class="builtintype" id="5754624">nil</span><span class="op" id="5754627">,</span>&nbsp;<span class="op" id="5754629">&amp;</span><span class="ident" id="5754630">net</span><span class="op" id="5754633">.</span><span class="ident" id="5754634">OpError</span><span class="op" id="5754641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5754645">Op</span><span class="op" id="5754647">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="5754651">&#34;dial-http&#34;</span><span class="op" id="5754662">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5754666">Net</span><span class="op" id="5754669">:</span>&nbsp;&nbsp;<span class="ident" id="5754672">network</span>&nbsp;<span class="op" id="5754680">+</span>&nbsp;<span class="string" id="5754682">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="5754686">+</span>&nbsp;<span class="ident" id="5754688">address</span><span class="op" id="5754695">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5754699">Addr</span><span class="op" id="5754703">:</span>&nbsp;<span class="builtintype" id="5754705">nil</span><span class="op" id="5754708">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5754712">Err</span><span class="op" id="5754715">:</span>&nbsp;&nbsp;<span class="ident" id="5754718">err</span><span class="op" id="5754721">,</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5754724">}</span><br>
<span class="lineno"></span><span class="op" id="5754726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5754729">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;an&nbsp;RPC&nbsp;server&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="5754797">func</span>&nbsp;<span class="ident" id="5754802">Dial</span><span class="op" id="5754806">(</span><span class="ident" id="5754807">network</span><span class="op" id="5754814">,</span>&nbsp;<span class="ident" id="5754816">address</span>&nbsp;<span class="builtintype" id="5754824">string</span><span class="op" id="5754830">)</span>&nbsp;<span class="op" id="5754832">(</span><span class="op" id="5754833">*</span><span class="ident" id="5754834">Client</span><span class="op" id="5754840">,</span>&nbsp;<span class="builtintype" id="5754842">error</span><span class="op" id="5754847">)</span>&nbsp;<span class="op" id="5754849">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5754852">conn</span><span class="op" id="5754856">,</span>&nbsp;<span class="ident" id="5754858">err</span>&nbsp;<span class="op" id="5754862">:=</span>&nbsp;<span class="ident" id="5754865">net</span><span class="op" id="5754868">.</span><span class="ident" id="5754869">Dial</span><span class="op" id="5754873">(</span><span class="ident" id="5754874">network</span><span class="op" id="5754881">,</span>&nbsp;<span class="ident" id="5754883">address</span><span class="op" id="5754890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5754893">if</span>&nbsp;<span class="ident" id="5754896">err</span>&nbsp;<span class="op" id="5754900">!=</span>&nbsp;<span class="builtintype" id="5754903">nil</span>&nbsp;<span class="op" id="5754907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5754911">return</span>&nbsp;<span class="builtintype" id="5754918">nil</span><span class="op" id="5754921">,</span>&nbsp;<span class="ident" id="5754923">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5754928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5754931">return</span>&nbsp;<span class="ident" id="5754938">NewClient</span><span class="op" id="5754947">(</span><span class="ident" id="5754948">conn</span><span class="op" id="5754952">)</span><span class="op" id="5754953">,</span>&nbsp;<span class="builtintype" id="5754955">nil</span><br>
<span class="lineno">275</span><span class="op" id="5754959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5754962">func</span>&nbsp;<span class="op" id="5754967">(</span><span class="ident" id="5754968">client</span>&nbsp;<span class="op" id="5754975">*</span><span class="ident" id="5754976">Client</span><span class="op" id="5754982">)</span>&nbsp;<span class="ident" id="5754984">Close</span><span class="op" id="5754989">(</span><span class="op" id="5754990">)</span>&nbsp;<span class="builtintype" id="5754992">error</span>&nbsp;<span class="op" id="5754998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5755001">client</span><span class="op" id="5755007">.</span><span class="ident" id="5755008">mutex</span><span class="op" id="5755013">.</span><span class="ident" id="5755014">Lock</span><span class="op" id="5755018">(</span><span class="op" id="5755019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5755022">if</span>&nbsp;<span class="ident" id="5755025">client</span><span class="op" id="5755031">.</span><span class="ident" id="5755032">closing</span>&nbsp;<span class="op" id="5755040">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5755044">client</span><span class="op" id="5755050">.</span><span class="ident" id="5755051">mutex</span><span class="op" id="5755056">.</span><span class="ident" id="5755057">Unlock</span><span class="op" id="5755063">(</span><span class="op" id="5755064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5755068">return</span>&nbsp;<span class="ident" id="5755075">ErrShutdown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5755088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5755091">client</span><span class="op" id="5755097">.</span><span class="ident" id="5755098">closing</span>&nbsp;<span class="op" id="5755106">=</span>&nbsp;<span class="builtintype" id="5755108">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5755114">client</span><span class="op" id="5755120">.</span><span class="ident" id="5755121">mutex</span><span class="op" id="5755126">.</span><span class="ident" id="5755127">Unlock</span><span class="op" id="5755133">(</span><span class="op" id="5755134">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5755137">return</span>&nbsp;<span class="ident" id="5755144">client</span><span class="op" id="5755150">.</span><span class="ident" id="5755151">codec</span><span class="op" id="5755156">.</span><span class="ident" id="5755157">Close</span><span class="op" id="5755162">(</span><span class="op" id="5755163">)</span><br>
<span class="lineno"></span><span class="op" id="5755165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5755168">//&nbsp;Go&nbsp;invokes&nbsp;the&nbsp;function&nbsp;asynchronously.&nbsp;&nbsp;It&nbsp;returns&nbsp;the&nbsp;Call&nbsp;structure&nbsp;representing</span><br>
<span class="lineno"></span><span class="comment" id="5755255">//&nbsp;the&nbsp;invocation.&nbsp;&nbsp;The&nbsp;done&nbsp;channel&nbsp;will&nbsp;signal&nbsp;when&nbsp;the&nbsp;call&nbsp;is&nbsp;complete&nbsp;by&nbsp;returning</span><br>
<span class="lineno">290</span><span class="comment" id="5755343">//&nbsp;the&nbsp;same&nbsp;Call&nbsp;object.&nbsp;&nbsp;If&nbsp;done&nbsp;is&nbsp;nil,&nbsp;Go&nbsp;will&nbsp;allocate&nbsp;a&nbsp;new&nbsp;channel.</span><br>
<span class="lineno"></span><span class="comment" id="5755417">//&nbsp;If&nbsp;non-nil,&nbsp;done&nbsp;must&nbsp;be&nbsp;buffered&nbsp;or&nbsp;Go&nbsp;will&nbsp;deliberately&nbsp;crash.</span><br>
<span class="lineno"></span><span class="keyword" id="5755485">func</span>&nbsp;<span class="op" id="5755490">(</span><span class="ident" id="5755491">client</span>&nbsp;<span class="op" id="5755498">*</span><span class="ident" id="5755499">Client</span><span class="op" id="5755505">)</span>&nbsp;<span class="ident" id="5755507">Go</span><span class="op" id="5755509">(</span><span class="ident" id="5755510">serviceMethod</span>&nbsp;<span class="builtintype" id="5755524">string</span><span class="op" id="5755530">,</span>&nbsp;<span class="ident" id="5755532">args</span>&nbsp;<span class="keyword" id="5755537">interface</span><span class="op" id="5755546">{</span><span class="op" id="5755547">}</span><span class="op" id="5755548">,</span>&nbsp;<span class="ident" id="5755550">reply</span>&nbsp;<span class="keyword" id="5755556">interface</span><span class="op" id="5755565">{</span><span class="op" id="5755566">}</span><span class="op" id="5755567">,</span>&nbsp;<span class="ident" id="5755569">done</span>&nbsp;<span class="keyword" id="5755574">chan</span>&nbsp;<span class="op" id="5755579">*</span><span class="ident" id="5755580">Call</span><span class="op" id="5755584">)</span>&nbsp;<span class="op" id="5755586">*</span><span class="ident" id="5755587">Call</span>&nbsp;<span class="op" id="5755592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5755595">call</span>&nbsp;<span class="op" id="5755600">:=</span>&nbsp;<span class="builtinfunc" id="5755603">new</span><span class="op" id="5755606">(</span><span class="ident" id="5755607">Call</span><span class="op" id="5755611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5755614">call</span><span class="op" id="5755618">.</span><span class="ident" id="5755619">ServiceMethod</span>&nbsp;<span class="op" id="5755633">=</span>&nbsp;<span class="ident" id="5755635">serviceMethod</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5755650">call</span><span class="op" id="5755654">.</span><span class="ident" id="5755655">Args</span>&nbsp;<span class="op" id="5755660">=</span>&nbsp;<span class="ident" id="5755662">args</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5755668">call</span><span class="op" id="5755672">.</span><span class="ident" id="5755673">Reply</span>&nbsp;<span class="op" id="5755679">=</span>&nbsp;<span class="ident" id="5755681">reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5755688">if</span>&nbsp;<span class="ident" id="5755691">done</span>&nbsp;<span class="op" id="5755696">==</span>&nbsp;<span class="builtintype" id="5755699">nil</span>&nbsp;<span class="op" id="5755703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5755707">done</span>&nbsp;<span class="op" id="5755712">=</span>&nbsp;<span class="builtinfunc" id="5755714">make</span><span class="op" id="5755718">(</span><span class="keyword" id="5755719">chan</span>&nbsp;<span class="op" id="5755724">*</span><span class="ident" id="5755725">Call</span><span class="op" id="5755729">,</span>&nbsp;<span class="num" id="5755731">10</span><span class="op" id="5755733">)</span>&nbsp;<span class="comment" id="5755735">//&nbsp;buffered.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5755749">}</span>&nbsp;<span class="keyword" id="5755751">else</span>&nbsp;<span class="op" id="5755756">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5755760">//&nbsp;If&nbsp;caller&nbsp;passes&nbsp;done&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;must&nbsp;arrange&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5755816">//&nbsp;done&nbsp;has&nbsp;enough&nbsp;buffer&nbsp;for&nbsp;the&nbsp;number&nbsp;of&nbsp;simultaneous</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5755875">//&nbsp;RPCs&nbsp;that&nbsp;will&nbsp;be&nbsp;using&nbsp;that&nbsp;channel.&nbsp;&nbsp;If&nbsp;the&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5755934">//&nbsp;is&nbsp;totally&nbsp;unbuffered,&nbsp;it&#39;s&nbsp;best&nbsp;not&nbsp;to&nbsp;run&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5755991">if</span>&nbsp;<span class="builtinfunc" id="5755994">cap</span><span class="op" id="5755997">(</span><span class="ident" id="5755998">done</span><span class="op" id="5756002">)</span>&nbsp;<span class="op" id="5756004">==</span>&nbsp;<span class="num" id="5756007">0</span>&nbsp;<span class="op" id="5756009">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5756014">log</span><span class="op" id="5756017">.</span><span class="ident" id="5756018">Panic</span><span class="op" id="5756023">(</span><span class="string" id="5756024">&#34;rpc:&nbsp;done&nbsp;channel&nbsp;is&nbsp;unbuffered&#34;</span><span class="op" id="5756057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5756061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5756064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5756067">call</span><span class="op" id="5756071">.</span><span class="ident" id="5756072">Done</span>&nbsp;<span class="op" id="5756077">=</span>&nbsp;<span class="ident" id="5756079">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5756085">client</span><span class="op" id="5756091">.</span><span class="ident" id="5756092">send</span><span class="op" id="5756096">(</span><span class="ident" id="5756097">call</span><span class="op" id="5756101">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5756104">return</span>&nbsp;<span class="ident" id="5756111">call</span><br>
<span class="lineno"></span><span class="op" id="5756116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5756119">//&nbsp;Call&nbsp;invokes&nbsp;the&nbsp;named&nbsp;function,&nbsp;waits&nbsp;for&nbsp;it&nbsp;to&nbsp;complete,&nbsp;and&nbsp;returns&nbsp;its&nbsp;error&nbsp;status.</span><br>
<span class="lineno"></span><span class="keyword" id="5756211">func</span>&nbsp;<span class="op" id="5756216">(</span><span class="ident" id="5756217">client</span>&nbsp;<span class="op" id="5756224">*</span><span class="ident" id="5756225">Client</span><span class="op" id="5756231">)</span>&nbsp;<span class="ident" id="5756233">Call</span><span class="op" id="5756237">(</span><span class="ident" id="5756238">serviceMethod</span>&nbsp;<span class="builtintype" id="5756252">string</span><span class="op" id="5756258">,</span>&nbsp;<span class="ident" id="5756260">args</span>&nbsp;<span class="keyword" id="5756265">interface</span><span class="op" id="5756274">{</span><span class="op" id="5756275">}</span><span class="op" id="5756276">,</span>&nbsp;<span class="ident" id="5756278">reply</span>&nbsp;<span class="keyword" id="5756284">interface</span><span class="op" id="5756293">{</span><span class="op" id="5756294">}</span><span class="op" id="5756295">)</span>&nbsp;<span class="builtintype" id="5756297">error</span>&nbsp;<span class="op" id="5756303">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5756306">call</span>&nbsp;<span class="op" id="5756311">:=</span>&nbsp;<span class="op" id="5756314">&lt;-</span><span class="ident" id="5756316">client</span><span class="op" id="5756322">.</span><span class="ident" id="5756323">Go</span><span class="op" id="5756325">(</span><span class="ident" id="5756326">serviceMethod</span><span class="op" id="5756339">,</span>&nbsp;<span class="ident" id="5756341">args</span><span class="op" id="5756345">,</span>&nbsp;<span class="ident" id="5756347">reply</span><span class="op" id="5756352">,</span>&nbsp;<span class="builtinfunc" id="5756354">make</span><span class="op" id="5756358">(</span><span class="keyword" id="5756359">chan</span>&nbsp;<span class="op" id="5756364">*</span><span class="ident" id="5756365">Call</span><span class="op" id="5756369">,</span>&nbsp;<span class="num" id="5756371">1</span><span class="op" id="5756372">)</span><span class="op" id="5756373">)</span><span class="op" id="5756374">.</span><span class="ident" id="5756375">Done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5756381">return</span>&nbsp;<span class="ident" id="5756388">call</span><span class="op" id="5756392">.</span><span class="ident" id="5756393">Error</span><br>
<span class="lineno"></span><span class="op" id="5756399">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
