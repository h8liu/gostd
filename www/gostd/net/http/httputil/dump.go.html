<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5862391">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5862446">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5862500">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5862551">package</span>&nbsp;<span class="ident" id="5862559">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5862569">import</span>&nbsp;<span class="op" id="5862576">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862579">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862588">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862597">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862607">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862614">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862620">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862633">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862640">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862652">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862663">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862674">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="5862681">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="5862684">//&nbsp;One&nbsp;of&nbsp;the&nbsp;copies,&nbsp;say&nbsp;from&nbsp;b&nbsp;to&nbsp;r2,&nbsp;could&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using&nbsp;a&nbsp;more</span><br>
<span class="lineno"></span><span class="comment" id="5862757">//&nbsp;elaborate&nbsp;trick&nbsp;where&nbsp;the&nbsp;other&nbsp;copy&nbsp;is&nbsp;made&nbsp;during&nbsp;Request/Response.Write.</span><br>
<span class="lineno"></span><span class="comment" id="5862836">//&nbsp;This&nbsp;would&nbsp;complicate&nbsp;things&nbsp;too&nbsp;much,&nbsp;given&nbsp;that&nbsp;these&nbsp;functions&nbsp;are&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5862913">//&nbsp;debugging&nbsp;only.</span><br>
<span class="lineno">25</span><span class="keyword" id="5862932">func</span>&nbsp;<span class="ident" id="5862937">drainBody</span><span class="op" id="5862946">(</span><span class="ident" id="5862947">b</span>&nbsp;<span class="ident" id="5862949">io</span><span class="op" id="5862951">.</span><span class="ident" id="5862952">ReadCloser</span><span class="op" id="5862962">)</span>&nbsp;<span class="op" id="5862964">(</span><span class="ident" id="5862965">r1</span><span class="op" id="5862967">,</span>&nbsp;<span class="ident" id="5862969">r2</span>&nbsp;<span class="ident" id="5862972">io</span><span class="op" id="5862974">.</span><span class="ident" id="5862975">ReadCloser</span><span class="op" id="5862985">,</span>&nbsp;<span class="ident" id="5862987">err</span>&nbsp;<span class="builtintype" id="5862991">error</span><span class="op" id="5862996">)</span>&nbsp;<span class="op" id="5862998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5863001">var</span>&nbsp;<span class="ident" id="5863005">buf</span>&nbsp;<span class="ident" id="5863009">bytes</span><span class="op" id="5863014">.</span><span class="ident" id="5863015">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5863023">if</span>&nbsp;<span class="ident" id="5863026">_</span><span class="op" id="5863027">,</span>&nbsp;<span class="ident" id="5863029">err</span>&nbsp;<span class="op" id="5863033">=</span>&nbsp;<span class="ident" id="5863035">buf</span><span class="op" id="5863038">.</span><span class="ident" id="5863039">ReadFrom</span><span class="op" id="5863047">(</span><span class="ident" id="5863048">b</span><span class="op" id="5863049">)</span><span class="op" id="5863050">;</span>&nbsp;<span class="ident" id="5863052">err</span>&nbsp;<span class="op" id="5863056">!=</span>&nbsp;<span class="ident" id="5863059">nil</span>&nbsp;<span class="op" id="5863063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5863067">return</span>&nbsp;<span class="ident" id="5863074">nil</span><span class="op" id="5863077">,</span>&nbsp;<span class="ident" id="5863079">nil</span><span class="op" id="5863082">,</span>&nbsp;<span class="ident" id="5863084">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5863089">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5863092">if</span>&nbsp;<span class="ident" id="5863095">err</span>&nbsp;<span class="op" id="5863099">=</span>&nbsp;<span class="ident" id="5863101">b</span><span class="op" id="5863102">.</span><span class="ident" id="5863103">Close</span><span class="op" id="5863108">(</span><span class="op" id="5863109">)</span><span class="op" id="5863110">;</span>&nbsp;<span class="ident" id="5863112">err</span>&nbsp;<span class="op" id="5863116">!=</span>&nbsp;<span class="ident" id="5863119">nil</span>&nbsp;<span class="op" id="5863123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5863127">return</span>&nbsp;<span class="ident" id="5863134">nil</span><span class="op" id="5863137">,</span>&nbsp;<span class="ident" id="5863139">nil</span><span class="op" id="5863142">,</span>&nbsp;<span class="ident" id="5863144">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5863149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5863152">return</span>&nbsp;<span class="ident" id="5863159">ioutil</span><span class="op" id="5863165">.</span><span class="ident" id="5863166">NopCloser</span><span class="op" id="5863175">(</span><span class="op" id="5863176">&amp;</span><span class="ident" id="5863177">buf</span><span class="op" id="5863180">)</span><span class="op" id="5863181">,</span>&nbsp;<span class="ident" id="5863183">ioutil</span><span class="op" id="5863189">.</span><span class="ident" id="5863190">NopCloser</span><span class="op" id="5863199">(</span><span class="ident" id="5863200">bytes</span><span class="op" id="5863205">.</span><span class="ident" id="5863206">NewReader</span><span class="op" id="5863215">(</span><span class="ident" id="5863216">buf</span><span class="op" id="5863219">.</span><span class="ident" id="5863220">Bytes</span><span class="op" id="5863225">(</span><span class="op" id="5863226">)</span><span class="op" id="5863227">)</span><span class="op" id="5863228">)</span><span class="op" id="5863229">,</span>&nbsp;<span class="ident" id="5863231">nil</span><br>
<span class="lineno"></span><span class="op" id="5863235">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="5863238">//&nbsp;dumpConn&nbsp;is&nbsp;a&nbsp;net.Conn&nbsp;which&nbsp;writes&nbsp;to&nbsp;Writer&nbsp;and&nbsp;reads&nbsp;from&nbsp;Reader</span><br>
<span class="lineno"></span><span class="keyword" id="5863309">type</span>&nbsp;<span class="ident" id="5863314">dumpConn</span>&nbsp;<span class="keyword" id="5863323">struct</span>&nbsp;<span class="op" id="5863330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5863333">io</span><span class="op" id="5863335">.</span><span class="ident" id="5863336">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5863344">io</span><span class="op" id="5863346">.</span><span class="ident" id="5863347">Reader</span><br>
<span class="lineno">40</span><span class="op" id="5863354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5863357">func</span>&nbsp;<span class="op" id="5863362">(</span><span class="ident" id="5863363">c</span>&nbsp;<span class="op" id="5863365">*</span><span class="ident" id="5863366">dumpConn</span><span class="op" id="5863374">)</span>&nbsp;<span class="ident" id="5863376">Close</span><span class="op" id="5863381">(</span><span class="op" id="5863382">)</span>&nbsp;<span class="builtintype" id="5863384">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5863412">{</span>&nbsp;<span class="keyword" id="5863414">return</span>&nbsp;<span class="ident" id="5863421">nil</span>&nbsp;<span class="op" id="5863425">}</span><br>
<span class="lineno"></span><span class="keyword" id="5863427">func</span>&nbsp;<span class="op" id="5863432">(</span><span class="ident" id="5863433">c</span>&nbsp;<span class="op" id="5863435">*</span><span class="ident" id="5863436">dumpConn</span><span class="op" id="5863444">)</span>&nbsp;<span class="ident" id="5863446">LocalAddr</span><span class="op" id="5863455">(</span><span class="op" id="5863456">)</span>&nbsp;<span class="ident" id="5863458">net</span><span class="op" id="5863461">.</span><span class="ident" id="5863462">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5863482">{</span>&nbsp;<span class="keyword" id="5863484">return</span>&nbsp;<span class="ident" id="5863491">nil</span>&nbsp;<span class="op" id="5863495">}</span><br>
<span class="lineno"></span><span class="keyword" id="5863497">func</span>&nbsp;<span class="op" id="5863502">(</span><span class="ident" id="5863503">c</span>&nbsp;<span class="op" id="5863505">*</span><span class="ident" id="5863506">dumpConn</span><span class="op" id="5863514">)</span>&nbsp;<span class="ident" id="5863516">RemoteAddr</span><span class="op" id="5863526">(</span><span class="op" id="5863527">)</span>&nbsp;<span class="ident" id="5863529">net</span><span class="op" id="5863532">.</span><span class="ident" id="5863533">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5863552">{</span>&nbsp;<span class="keyword" id="5863554">return</span>&nbsp;<span class="ident" id="5863561">nil</span>&nbsp;<span class="op" id="5863565">}</span><br>
<span class="lineno">45</span><span class="keyword" id="5863567">func</span>&nbsp;<span class="op" id="5863572">(</span><span class="ident" id="5863573">c</span>&nbsp;<span class="op" id="5863575">*</span><span class="ident" id="5863576">dumpConn</span><span class="op" id="5863584">)</span>&nbsp;<span class="ident" id="5863586">SetDeadline</span><span class="op" id="5863597">(</span><span class="ident" id="5863598">t</span>&nbsp;<span class="ident" id="5863600">time</span><span class="op" id="5863604">.</span><span class="ident" id="5863605">Time</span><span class="op" id="5863609">)</span>&nbsp;<span class="builtintype" id="5863611">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5863622">{</span>&nbsp;<span class="keyword" id="5863624">return</span>&nbsp;<span class="ident" id="5863631">nil</span>&nbsp;<span class="op" id="5863635">}</span><br>
<span class="lineno"></span><span class="keyword" id="5863637">func</span>&nbsp;<span class="op" id="5863642">(</span><span class="ident" id="5863643">c</span>&nbsp;<span class="op" id="5863645">*</span><span class="ident" id="5863646">dumpConn</span><span class="op" id="5863654">)</span>&nbsp;<span class="ident" id="5863656">SetReadDeadline</span><span class="op" id="5863671">(</span><span class="ident" id="5863672">t</span>&nbsp;<span class="ident" id="5863674">time</span><span class="op" id="5863678">.</span><span class="ident" id="5863679">Time</span><span class="op" id="5863683">)</span>&nbsp;<span class="builtintype" id="5863685">error</span>&nbsp;&nbsp;<span class="op" id="5863692">{</span>&nbsp;<span class="keyword" id="5863694">return</span>&nbsp;<span class="ident" id="5863701">nil</span>&nbsp;<span class="op" id="5863705">}</span><br>
<span class="lineno"></span><span class="keyword" id="5863707">func</span>&nbsp;<span class="op" id="5863712">(</span><span class="ident" id="5863713">c</span>&nbsp;<span class="op" id="5863715">*</span><span class="ident" id="5863716">dumpConn</span><span class="op" id="5863724">)</span>&nbsp;<span class="ident" id="5863726">SetWriteDeadline</span><span class="op" id="5863742">(</span><span class="ident" id="5863743">t</span>&nbsp;<span class="ident" id="5863745">time</span><span class="op" id="5863749">.</span><span class="ident" id="5863750">Time</span><span class="op" id="5863754">)</span>&nbsp;<span class="builtintype" id="5863756">error</span>&nbsp;<span class="op" id="5863762">{</span>&nbsp;<span class="keyword" id="5863764">return</span>&nbsp;<span class="ident" id="5863771">nil</span>&nbsp;<span class="op" id="5863775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5863778">type</span>&nbsp;<span class="ident" id="5863783">neverEnding</span>&nbsp;<span class="builtintype" id="5863795">byte</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="5863801">func</span>&nbsp;<span class="op" id="5863806">(</span><span class="ident" id="5863807">b</span>&nbsp;<span class="ident" id="5863809">neverEnding</span><span class="op" id="5863820">)</span>&nbsp;<span class="ident" id="5863822">Read</span><span class="op" id="5863826">(</span><span class="ident" id="5863827">p</span>&nbsp;<span class="op" id="5863829">[</span><span class="op" id="5863830">]</span><span class="builtintype" id="5863831">byte</span><span class="op" id="5863835">)</span>&nbsp;<span class="op" id="5863837">(</span><span class="ident" id="5863838">n</span>&nbsp;<span class="builtintype" id="5863840">int</span><span class="op" id="5863843">,</span>&nbsp;<span class="ident" id="5863845">err</span>&nbsp;<span class="builtintype" id="5863849">error</span><span class="op" id="5863854">)</span>&nbsp;<span class="op" id="5863856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5863859">for</span>&nbsp;<span class="ident" id="5863863">i</span>&nbsp;<span class="op" id="5863865">:=</span>&nbsp;<span class="keyword" id="5863868">range</span>&nbsp;<span class="ident" id="5863874">p</span>&nbsp;<span class="op" id="5863876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5863880">p</span><span class="op" id="5863881">[</span><span class="ident" id="5863882">i</span><span class="op" id="5863883">]</span>&nbsp;<span class="op" id="5863885">=</span>&nbsp;<span class="builtintype" id="5863887">byte</span><span class="op" id="5863891">(</span><span class="ident" id="5863892">b</span><span class="op" id="5863893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5863896">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5863899">return</span>&nbsp;<span class="builtinfunc" id="5863906">len</span><span class="op" id="5863909">(</span><span class="ident" id="5863910">p</span><span class="op" id="5863911">)</span><span class="op" id="5863912">,</span>&nbsp;<span class="ident" id="5863914">nil</span><br>
<span class="lineno"></span><span class="op" id="5863918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5863921">//&nbsp;DumpRequestOut&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;includes</span><br>
<span class="lineno"></span><span class="comment" id="5863972">//&nbsp;headers&nbsp;that&nbsp;the&nbsp;standard&nbsp;http.Transport&nbsp;adds,</span><br>
<span class="lineno">60</span><span class="comment" id="5864022">//&nbsp;such&nbsp;as&nbsp;User-Agent.</span><br>
<span class="lineno"></span><span class="keyword" id="5864045">func</span>&nbsp;<span class="ident" id="5864050">DumpRequestOut</span><span class="op" id="5864064">(</span><span class="ident" id="5864065">req</span>&nbsp;<span class="op" id="5864069">*</span><span class="ident" id="5864070">http</span><span class="op" id="5864074">.</span><span class="ident" id="5864075">Request</span><span class="op" id="5864082">,</span>&nbsp;<span class="ident" id="5864084">body</span>&nbsp;<span class="builtintype" id="5864089">bool</span><span class="op" id="5864093">)</span>&nbsp;<span class="op" id="5864095">(</span><span class="op" id="5864096">[</span><span class="op" id="5864097">]</span><span class="builtintype" id="5864098">byte</span><span class="op" id="5864102">,</span>&nbsp;<span class="builtintype" id="5864104">error</span><span class="op" id="5864109">)</span>&nbsp;<span class="op" id="5864111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864114">save</span>&nbsp;<span class="op" id="5864119">:=</span>&nbsp;<span class="ident" id="5864122">req</span><span class="op" id="5864125">.</span><span class="ident" id="5864126">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864132">dummyBody</span>&nbsp;<span class="op" id="5864142">:=</span>&nbsp;<span class="builtintype" id="5864145">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5864152">if</span>&nbsp;<span class="op" id="5864155">!</span><span class="ident" id="5864156">body</span>&nbsp;<span class="op" id="5864161">||</span>&nbsp;<span class="ident" id="5864164">req</span><span class="op" id="5864167">.</span><span class="ident" id="5864168">Body</span>&nbsp;<span class="op" id="5864173">==</span>&nbsp;<span class="ident" id="5864176">nil</span>&nbsp;<span class="op" id="5864180">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864184">req</span><span class="op" id="5864187">.</span><span class="ident" id="5864188">Body</span>&nbsp;<span class="op" id="5864193">=</span>&nbsp;<span class="ident" id="5864195">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5864201">if</span>&nbsp;<span class="ident" id="5864204">req</span><span class="op" id="5864207">.</span><span class="ident" id="5864208">ContentLength</span>&nbsp;<span class="op" id="5864222">!=</span>&nbsp;<span class="num" id="5864225">0</span>&nbsp;<span class="op" id="5864227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864232">req</span><span class="op" id="5864235">.</span><span class="ident" id="5864236">Body</span>&nbsp;<span class="op" id="5864241">=</span>&nbsp;<span class="ident" id="5864243">ioutil</span><span class="op" id="5864249">.</span><span class="ident" id="5864250">NopCloser</span><span class="op" id="5864259">(</span><span class="ident" id="5864260">io</span><span class="op" id="5864262">.</span><span class="ident" id="5864263">LimitReader</span><span class="op" id="5864274">(</span><span class="ident" id="5864275">neverEnding</span><span class="op" id="5864286">(</span><span class="string" id="5864287">&#39;x&#39;</span><span class="op" id="5864290">)</span><span class="op" id="5864291">,</span>&nbsp;<span class="ident" id="5864293">req</span><span class="op" id="5864296">.</span><span class="ident" id="5864297">ContentLength</span><span class="op" id="5864310">)</span><span class="op" id="5864311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864316">dummyBody</span>&nbsp;<span class="op" id="5864326">=</span>&nbsp;<span class="builtintype" id="5864328">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5864335">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5864338">}</span>&nbsp;<span class="keyword" id="5864340">else</span>&nbsp;<span class="op" id="5864345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5864349">var</span>&nbsp;<span class="ident" id="5864353">err</span>&nbsp;<span class="builtintype" id="5864357">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864365">save</span><span class="op" id="5864369">,</span>&nbsp;<span class="ident" id="5864371">req</span><span class="op" id="5864374">.</span><span class="ident" id="5864375">Body</span><span class="op" id="5864379">,</span>&nbsp;<span class="ident" id="5864381">err</span>&nbsp;<span class="op" id="5864385">=</span>&nbsp;<span class="ident" id="5864387">drainBody</span><span class="op" id="5864396">(</span><span class="ident" id="5864397">req</span><span class="op" id="5864400">.</span><span class="ident" id="5864401">Body</span><span class="op" id="5864405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5864409">if</span>&nbsp;<span class="ident" id="5864412">err</span>&nbsp;<span class="op" id="5864416">!=</span>&nbsp;<span class="ident" id="5864419">nil</span>&nbsp;<span class="op" id="5864423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5864428">return</span>&nbsp;<span class="ident" id="5864435">nil</span><span class="op" id="5864438">,</span>&nbsp;<span class="ident" id="5864440">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5864446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5864449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5864453">//&nbsp;Since&nbsp;we&#39;re&nbsp;using&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;write&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5864523">//&nbsp;switch&nbsp;to&nbsp;http&nbsp;so&nbsp;the&nbsp;Transport&nbsp;doesn&#39;t&nbsp;try&nbsp;to&nbsp;do&nbsp;an&nbsp;SSL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5864584">//&nbsp;negotiation&nbsp;with&nbsp;our&nbsp;dumpConn&nbsp;and&nbsp;its&nbsp;bytes.Buffer&nbsp;&amp;&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5864647">//&nbsp;The&nbsp;wire&nbsp;format&nbsp;for&nbsp;https&nbsp;and&nbsp;http&nbsp;are&nbsp;the&nbsp;same,&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864708">reqSend</span>&nbsp;<span class="op" id="5864716">:=</span>&nbsp;<span class="ident" id="5864719">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5864724">if</span>&nbsp;<span class="ident" id="5864727">req</span><span class="op" id="5864730">.</span><span class="ident" id="5864731">URL</span><span class="op" id="5864734">.</span><span class="ident" id="5864735">Scheme</span>&nbsp;<span class="op" id="5864742">==</span>&nbsp;<span class="string" id="5864745">&#34;https&#34;</span>&nbsp;<span class="op" id="5864753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864757">reqSend</span>&nbsp;<span class="op" id="5864765">=</span>&nbsp;<span class="builtinfunc" id="5864767">new</span><span class="op" id="5864770">(</span><span class="ident" id="5864771">http</span><span class="op" id="5864775">.</span><span class="ident" id="5864776">Request</span><span class="op" id="5864783">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5864787">*</span><span class="ident" id="5864788">reqSend</span>&nbsp;<span class="op" id="5864796">=</span>&nbsp;<span class="op" id="5864798">*</span><span class="ident" id="5864799">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864805">reqSend</span><span class="op" id="5864812">.</span><span class="ident" id="5864813">URL</span>&nbsp;<span class="op" id="5864817">=</span>&nbsp;<span class="builtinfunc" id="5864819">new</span><span class="op" id="5864822">(</span><span class="ident" id="5864823">url</span><span class="op" id="5864826">.</span><span class="ident" id="5864827">URL</span><span class="op" id="5864830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5864834">*</span><span class="ident" id="5864835">reqSend</span><span class="op" id="5864842">.</span><span class="ident" id="5864843">URL</span>&nbsp;<span class="op" id="5864847">=</span>&nbsp;<span class="op" id="5864849">*</span><span class="ident" id="5864850">req</span><span class="op" id="5864853">.</span><span class="ident" id="5864854">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864860">reqSend</span><span class="op" id="5864867">.</span><span class="ident" id="5864868">URL</span><span class="op" id="5864871">.</span><span class="ident" id="5864872">Scheme</span>&nbsp;<span class="op" id="5864879">=</span>&nbsp;<span class="string" id="5864881">&#34;http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5864889">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5864893">//&nbsp;Use&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;record&nbsp;what&nbsp;we&nbsp;would&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5864956">//&nbsp;on&nbsp;the&nbsp;wire,&nbsp;but&nbsp;not&nbsp;using&nbsp;TCP.&nbsp;&nbsp;Use&nbsp;a&nbsp;Transport&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5865016">//&nbsp;custom&nbsp;dialer&nbsp;that&nbsp;returns&nbsp;a&nbsp;fake&nbsp;net.Conn&nbsp;that&nbsp;waits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5865074">//&nbsp;for&nbsp;the&nbsp;full&nbsp;input&nbsp;(and&nbsp;recording&nbsp;it),&nbsp;and&nbsp;then&nbsp;responds</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5865135">//&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5865162">var</span>&nbsp;<span class="ident" id="5865166">buf</span>&nbsp;<span class="ident" id="5865170">bytes</span><span class="op" id="5865175">.</span><span class="ident" id="5865176">Buffer</span>&nbsp;<span class="comment" id="5865183">//&nbsp;records&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865206">pr</span><span class="op" id="5865208">,</span>&nbsp;<span class="ident" id="5865210">pw</span>&nbsp;<span class="op" id="5865213">:=</span>&nbsp;<span class="ident" id="5865216">io</span><span class="op" id="5865218">.</span><span class="ident" id="5865219">Pipe</span><span class="op" id="5865223">(</span><span class="op" id="5865224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5865227">defer</span>&nbsp;<span class="ident" id="5865233">pr</span><span class="op" id="5865235">.</span><span class="ident" id="5865236">Close</span><span class="op" id="5865241">(</span><span class="op" id="5865242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5865245">defer</span>&nbsp;<span class="ident" id="5865251">pw</span><span class="op" id="5865253">.</span><span class="ident" id="5865254">Close</span><span class="op" id="5865259">(</span><span class="op" id="5865260">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865263">dr</span>&nbsp;<span class="op" id="5865266">:=</span>&nbsp;<span class="op" id="5865269">&amp;</span><span class="ident" id="5865270">delegateReader</span><span class="op" id="5865284">{</span><span class="ident" id="5865285">c</span><span class="op" id="5865286">:</span>&nbsp;<span class="builtinfunc" id="5865288">make</span><span class="op" id="5865292">(</span><span class="keyword" id="5865293">chan</span>&nbsp;<span class="ident" id="5865298">io</span><span class="op" id="5865300">.</span><span class="ident" id="5865301">Reader</span><span class="op" id="5865307">)</span><span class="op" id="5865308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5865311">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;request&nbsp;before&nbsp;replying&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5865375">go</span>&nbsp;<span class="keyword" id="5865378">func</span><span class="op" id="5865382">(</span><span class="op" id="5865383">)</span>&nbsp;<span class="op" id="5865385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865389">req</span><span class="op" id="5865392">,</span>&nbsp;<span class="ident" id="5865394">err</span>&nbsp;<span class="op" id="5865398">:=</span>&nbsp;<span class="ident" id="5865401">http</span><span class="op" id="5865405">.</span><span class="ident" id="5865406">ReadRequest</span><span class="op" id="5865417">(</span><span class="ident" id="5865418">bufio</span><span class="op" id="5865423">.</span><span class="ident" id="5865424">NewReader</span><span class="op" id="5865433">(</span><span class="ident" id="5865434">pr</span><span class="op" id="5865436">)</span><span class="op" id="5865437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5865441">if</span>&nbsp;<span class="ident" id="5865444">err</span>&nbsp;<span class="op" id="5865448">==</span>&nbsp;<span class="ident" id="5865451">nil</span>&nbsp;<span class="op" id="5865455">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5865460">//&nbsp;Ensure&nbsp;all&nbsp;the&nbsp;body&nbsp;is&nbsp;read;&nbsp;otherwise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5865505">//&nbsp;we&#39;ll&nbsp;get&nbsp;a&nbsp;partial&nbsp;dump.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865537">io</span><span class="op" id="5865539">.</span><span class="ident" id="5865540">Copy</span><span class="op" id="5865544">(</span><span class="ident" id="5865545">ioutil</span><span class="op" id="5865551">.</span><span class="ident" id="5865552">Discard</span><span class="op" id="5865559">,</span>&nbsp;<span class="ident" id="5865561">req</span><span class="op" id="5865564">.</span><span class="ident" id="5865565">Body</span><span class="op" id="5865569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865574">req</span><span class="op" id="5865577">.</span><span class="ident" id="5865578">Body</span><span class="op" id="5865582">.</span><span class="ident" id="5865583">Close</span><span class="op" id="5865588">(</span><span class="op" id="5865589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5865593">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865597">dr</span><span class="op" id="5865599">.</span><span class="ident" id="5865600">c</span>&nbsp;<span class="op" id="5865602">&lt;-</span>&nbsp;<span class="ident" id="5865605">strings</span><span class="op" id="5865612">.</span><span class="ident" id="5865613">NewReader</span><span class="op" id="5865622">(</span><span class="string" id="5865623">&#34;HTTP/1.1&nbsp;204&nbsp;No&nbsp;Content\r\n\r\n&#34;</span><span class="op" id="5865656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5865659">}</span><span class="op" id="5865660">(</span><span class="op" id="5865661">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865665">t</span>&nbsp;<span class="op" id="5865667">:=</span>&nbsp;<span class="op" id="5865670">&amp;</span><span class="ident" id="5865671">http</span><span class="op" id="5865675">.</span><span class="ident" id="5865676">Transport</span><span class="op" id="5865685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865689">DisableKeepAlives</span><span class="op" id="5865706">:</span>&nbsp;<span class="builtintype" id="5865708">true</span><span class="op" id="5865712">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865716">Dial</span><span class="op" id="5865720">:</span>&nbsp;<span class="keyword" id="5865722">func</span><span class="op" id="5865726">(</span><span class="ident" id="5865727">net</span><span class="op" id="5865730">,</span>&nbsp;<span class="ident" id="5865732">addr</span>&nbsp;<span class="builtintype" id="5865737">string</span><span class="op" id="5865743">)</span>&nbsp;<span class="op" id="5865745">(</span><span class="ident" id="5865746">net</span><span class="op" id="5865749">.</span><span class="ident" id="5865750">Conn</span><span class="op" id="5865754">,</span>&nbsp;<span class="builtintype" id="5865756">error</span><span class="op" id="5865761">)</span>&nbsp;<span class="op" id="5865763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5865768">return</span>&nbsp;<span class="op" id="5865775">&amp;</span><span class="ident" id="5865776">dumpConn</span><span class="op" id="5865784">{</span><span class="ident" id="5865785">io</span><span class="op" id="5865787">.</span><span class="ident" id="5865788">MultiWriter</span><span class="op" id="5865799">(</span><span class="op" id="5865800">&amp;</span><span class="ident" id="5865801">buf</span><span class="op" id="5865804">,</span>&nbsp;<span class="ident" id="5865806">pw</span><span class="op" id="5865808">)</span><span class="op" id="5865809">,</span>&nbsp;<span class="ident" id="5865811">dr</span><span class="op" id="5865813">}</span><span class="op" id="5865814">,</span>&nbsp;<span class="ident" id="5865816">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5865822">}</span><span class="op" id="5865823">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5865826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865830">_</span><span class="op" id="5865831">,</span>&nbsp;<span class="ident" id="5865833">err</span>&nbsp;<span class="op" id="5865837">:=</span>&nbsp;<span class="ident" id="5865840">t</span><span class="op" id="5865841">.</span><span class="ident" id="5865842">RoundTrip</span><span class="op" id="5865851">(</span><span class="ident" id="5865852">reqSend</span><span class="op" id="5865859">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865863">req</span><span class="op" id="5865866">.</span><span class="ident" id="5865867">Body</span>&nbsp;<span class="op" id="5865872">=</span>&nbsp;<span class="ident" id="5865874">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5865880">if</span>&nbsp;<span class="ident" id="5865883">err</span>&nbsp;<span class="op" id="5865887">!=</span>&nbsp;<span class="ident" id="5865890">nil</span>&nbsp;<span class="op" id="5865894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5865898">return</span>&nbsp;<span class="ident" id="5865905">nil</span><span class="op" id="5865908">,</span>&nbsp;<span class="ident" id="5865910">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5865915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865918">dump</span>&nbsp;<span class="op" id="5865923">:=</span>&nbsp;<span class="ident" id="5865926">buf</span><span class="op" id="5865929">.</span><span class="ident" id="5865930">Bytes</span><span class="op" id="5865935">(</span><span class="op" id="5865936">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5865940">//&nbsp;If&nbsp;we&nbsp;used&nbsp;a&nbsp;dummy&nbsp;body&nbsp;above,&nbsp;remove&nbsp;it&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5865990">//&nbsp;TODO:&nbsp;if&nbsp;the&nbsp;req.ContentLength&nbsp;is&nbsp;large,&nbsp;we&nbsp;allocate&nbsp;memory</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5866054">//&nbsp;unnecessarily&nbsp;just&nbsp;to&nbsp;slice&nbsp;it&nbsp;off&nbsp;here.&nbsp;&nbsp;But&nbsp;this&nbsp;is&nbsp;just</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5866117">//&nbsp;a&nbsp;debug&nbsp;function,&nbsp;so&nbsp;this&nbsp;is&nbsp;acceptable&nbsp;for&nbsp;now.&nbsp;We&nbsp;could</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5866179">//&nbsp;discard&nbsp;the&nbsp;body&nbsp;earlier&nbsp;if&nbsp;this&nbsp;matters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5866225">if</span>&nbsp;<span class="ident" id="5866228">dummyBody</span>&nbsp;<span class="op" id="5866238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5866242">if</span>&nbsp;<span class="ident" id="5866245">i</span>&nbsp;<span class="op" id="5866247">:=</span>&nbsp;<span class="ident" id="5866250">bytes</span><span class="op" id="5866255">.</span><span class="ident" id="5866256">Index</span><span class="op" id="5866261">(</span><span class="ident" id="5866262">dump</span><span class="op" id="5866266">,</span>&nbsp;<span class="op" id="5866268">[</span><span class="op" id="5866269">]</span><span class="builtintype" id="5866270">byte</span><span class="op" id="5866274">(</span><span class="string" id="5866275">&#34;\r\n\r\n&#34;</span><span class="op" id="5866285">)</span><span class="op" id="5866286">)</span><span class="op" id="5866287">;</span>&nbsp;<span class="ident" id="5866289">i</span>&nbsp;<span class="op" id="5866291">&gt;=</span>&nbsp;<span class="num" id="5866294">0</span>&nbsp;<span class="op" id="5866296">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5866301">dump</span>&nbsp;<span class="op" id="5866306">=</span>&nbsp;<span class="ident" id="5866308">dump</span><span class="op" id="5866312">[</span><span class="op" id="5866313">:</span><span class="ident" id="5866314">i</span><span class="op" id="5866315">+</span><span class="num" id="5866316">4</span><span class="op" id="5866317">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5866321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5866324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5866327">return</span>&nbsp;<span class="ident" id="5866334">dump</span><span class="op" id="5866338">,</span>&nbsp;<span class="ident" id="5866340">nil</span><br>
<span class="lineno"></span><span class="op" id="5866344">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="5866347">//&nbsp;delegateReader&nbsp;is&nbsp;a&nbsp;reader&nbsp;that&nbsp;delegates&nbsp;to&nbsp;another&nbsp;reader,</span><br>
<span class="lineno"></span><span class="comment" id="5866411">//&nbsp;once&nbsp;it&nbsp;arrives&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="5866444">type</span>&nbsp;<span class="ident" id="5866449">delegateReader</span>&nbsp;<span class="keyword" id="5866464">struct</span>&nbsp;<span class="op" id="5866471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5866474">c</span>&nbsp;<span class="keyword" id="5866476">chan</span>&nbsp;<span class="ident" id="5866481">io</span><span class="op" id="5866483">.</span><span class="ident" id="5866484">Reader</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5866492">r</span>&nbsp;<span class="ident" id="5866494">io</span><span class="op" id="5866496">.</span><span class="ident" id="5866497">Reader</span>&nbsp;<span class="comment" id="5866504">//&nbsp;nil&nbsp;until&nbsp;received&nbsp;from&nbsp;c</span><br>
<span class="lineno"></span><span class="op" id="5866533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5866536">func</span>&nbsp;<span class="op" id="5866541">(</span><span class="ident" id="5866542">r</span>&nbsp;<span class="op" id="5866544">*</span><span class="ident" id="5866545">delegateReader</span><span class="op" id="5866559">)</span>&nbsp;<span class="ident" id="5866561">Read</span><span class="op" id="5866565">(</span><span class="ident" id="5866566">p</span>&nbsp;<span class="op" id="5866568">[</span><span class="op" id="5866569">]</span><span class="builtintype" id="5866570">byte</span><span class="op" id="5866574">)</span>&nbsp;<span class="op" id="5866576">(</span><span class="builtintype" id="5866577">int</span><span class="op" id="5866580">,</span>&nbsp;<span class="builtintype" id="5866582">error</span><span class="op" id="5866587">)</span>&nbsp;<span class="op" id="5866589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5866592">if</span>&nbsp;<span class="ident" id="5866595">r</span><span class="op" id="5866596">.</span><span class="ident" id="5866597">r</span>&nbsp;<span class="op" id="5866599">==</span>&nbsp;<span class="ident" id="5866602">nil</span>&nbsp;<span class="op" id="5866606">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5866610">r</span><span class="op" id="5866611">.</span><span class="ident" id="5866612">r</span>&nbsp;<span class="op" id="5866614">=</span>&nbsp;<span class="op" id="5866616">&lt;-</span><span class="ident" id="5866618">r</span><span class="op" id="5866619">.</span><span class="ident" id="5866620">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5866623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5866626">return</span>&nbsp;<span class="ident" id="5866633">r</span><span class="op" id="5866634">.</span><span class="ident" id="5866635">r</span><span class="op" id="5866636">.</span><span class="ident" id="5866637">Read</span><span class="op" id="5866641">(</span><span class="ident" id="5866642">p</span><span class="op" id="5866643">)</span><br>
<span class="lineno"></span><span class="op" id="5866645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="5866648">//&nbsp;Return&nbsp;value&nbsp;if&nbsp;nonempty,&nbsp;def&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="keyword" id="5866692">func</span>&nbsp;<span class="ident" id="5866697">valueOrDefault</span><span class="op" id="5866711">(</span><span class="ident" id="5866712">value</span><span class="op" id="5866717">,</span>&nbsp;<span class="ident" id="5866719">def</span>&nbsp;<span class="builtintype" id="5866723">string</span><span class="op" id="5866729">)</span>&nbsp;<span class="builtintype" id="5866731">string</span>&nbsp;<span class="op" id="5866738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5866741">if</span>&nbsp;<span class="ident" id="5866744">value</span>&nbsp;<span class="op" id="5866750">!=</span>&nbsp;<span class="string" id="5866753">&#34;&#34;</span>&nbsp;<span class="op" id="5866756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5866760">return</span>&nbsp;<span class="ident" id="5866767">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5866774">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5866777">return</span>&nbsp;<span class="ident" id="5866784">def</span><br>
<span class="lineno"></span><span class="op" id="5866788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5866791">var</span>&nbsp;<span class="ident" id="5866795">reqWriteExcludeHeaderDump</span>&nbsp;<span class="op" id="5866821">=</span>&nbsp;<span class="keyword" id="5866823">map</span><span class="op" id="5866826">[</span><span class="builtintype" id="5866827">string</span><span class="op" id="5866833">]</span><span class="builtintype" id="5866834">bool</span><span class="op" id="5866838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5866841">&#34;Host&#34;</span><span class="op" id="5866847">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5866862">true</span><span class="op" id="5866866">,</span>&nbsp;<span class="comment" id="5866868">//&nbsp;not&nbsp;in&nbsp;Header&nbsp;map&nbsp;anyway</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5866897">&#34;Content-Length&#34;</span><span class="op" id="5866913">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5866918">true</span><span class="op" id="5866922">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5866925">&#34;Transfer-Encoding&#34;</span><span class="op" id="5866944">:</span>&nbsp;<span class="builtintype" id="5866946">true</span><span class="op" id="5866950">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5866953">&#34;Trailer&#34;</span><span class="op" id="5866962">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5866974">true</span><span class="op" id="5866978">,</span><br>
<span class="lineno"></span><span class="op" id="5866980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="5866983">//&nbsp;dumpAsReceived&nbsp;writes&nbsp;req&nbsp;to&nbsp;w&nbsp;in&nbsp;the&nbsp;form&nbsp;as&nbsp;it&nbsp;was&nbsp;received,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5867052">//&nbsp;at&nbsp;least&nbsp;as&nbsp;accurately&nbsp;as&nbsp;possible&nbsp;from&nbsp;the&nbsp;information&nbsp;retained&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5867123">//&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span><span class="keyword" id="5867139">func</span>&nbsp;<span class="ident" id="5867144">dumpAsReceived</span><span class="op" id="5867158">(</span><span class="ident" id="5867159">req</span>&nbsp;<span class="op" id="5867163">*</span><span class="ident" id="5867164">http</span><span class="op" id="5867168">.</span><span class="ident" id="5867169">Request</span><span class="op" id="5867176">,</span>&nbsp;<span class="ident" id="5867178">w</span>&nbsp;<span class="ident" id="5867180">io</span><span class="op" id="5867182">.</span><span class="ident" id="5867183">Writer</span><span class="op" id="5867189">)</span>&nbsp;<span class="builtintype" id="5867191">error</span>&nbsp;<span class="op" id="5867197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5867200">return</span>&nbsp;<span class="ident" id="5867207">nil</span><br>
<span class="lineno">175</span><span class="op" id="5867211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5867214">//&nbsp;DumpRequest&nbsp;returns&nbsp;the&nbsp;as-received&nbsp;wire&nbsp;representation&nbsp;of&nbsp;req,</span><br>
<span class="lineno"></span><span class="comment" id="5867281">//&nbsp;optionally&nbsp;including&nbsp;the&nbsp;request&nbsp;body,&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="comment" id="5867338">//&nbsp;DumpRequest&nbsp;is&nbsp;semantically&nbsp;a&nbsp;no-op,&nbsp;but&nbsp;in&nbsp;order&nbsp;to</span><br>
<span class="lineno">180</span><span class="comment" id="5867394">//&nbsp;dump&nbsp;the&nbsp;body,&nbsp;it&nbsp;reads&nbsp;the&nbsp;body&nbsp;data&nbsp;into&nbsp;memory&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5867451">//&nbsp;changes&nbsp;req.Body&nbsp;to&nbsp;refer&nbsp;to&nbsp;the&nbsp;in-memory&nbsp;copy.</span><br>
<span class="lineno"></span><span class="comment" id="5867503">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;http.Request.Write&nbsp;details&nbsp;which&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="5867568">//&nbsp;of&nbsp;req&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5867588">func</span>&nbsp;<span class="ident" id="5867593">DumpRequest</span><span class="op" id="5867604">(</span><span class="ident" id="5867605">req</span>&nbsp;<span class="op" id="5867609">*</span><span class="ident" id="5867610">http</span><span class="op" id="5867614">.</span><span class="ident" id="5867615">Request</span><span class="op" id="5867622">,</span>&nbsp;<span class="ident" id="5867624">body</span>&nbsp;<span class="builtintype" id="5867629">bool</span><span class="op" id="5867633">)</span>&nbsp;<span class="op" id="5867635">(</span><span class="ident" id="5867636">dump</span>&nbsp;<span class="op" id="5867641">[</span><span class="op" id="5867642">]</span><span class="builtintype" id="5867643">byte</span><span class="op" id="5867647">,</span>&nbsp;<span class="ident" id="5867649">err</span>&nbsp;<span class="builtintype" id="5867653">error</span><span class="op" id="5867658">)</span>&nbsp;<span class="op" id="5867660">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5867663">save</span>&nbsp;<span class="op" id="5867668">:=</span>&nbsp;<span class="ident" id="5867671">req</span><span class="op" id="5867674">.</span><span class="ident" id="5867675">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5867681">if</span>&nbsp;<span class="op" id="5867684">!</span><span class="ident" id="5867685">body</span>&nbsp;<span class="op" id="5867690">||</span>&nbsp;<span class="ident" id="5867693">req</span><span class="op" id="5867696">.</span><span class="ident" id="5867697">Body</span>&nbsp;<span class="op" id="5867702">==</span>&nbsp;<span class="ident" id="5867705">nil</span>&nbsp;<span class="op" id="5867709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5867713">req</span><span class="op" id="5867716">.</span><span class="ident" id="5867717">Body</span>&nbsp;<span class="op" id="5867722">=</span>&nbsp;<span class="ident" id="5867724">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5867729">}</span>&nbsp;<span class="keyword" id="5867731">else</span>&nbsp;<span class="op" id="5867736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5867740">save</span><span class="op" id="5867744">,</span>&nbsp;<span class="ident" id="5867746">req</span><span class="op" id="5867749">.</span><span class="ident" id="5867750">Body</span><span class="op" id="5867754">,</span>&nbsp;<span class="ident" id="5867756">err</span>&nbsp;<span class="op" id="5867760">=</span>&nbsp;<span class="ident" id="5867762">drainBody</span><span class="op" id="5867771">(</span><span class="ident" id="5867772">req</span><span class="op" id="5867775">.</span><span class="ident" id="5867776">Body</span><span class="op" id="5867780">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5867784">if</span>&nbsp;<span class="ident" id="5867787">err</span>&nbsp;<span class="op" id="5867791">!=</span>&nbsp;<span class="ident" id="5867794">nil</span>&nbsp;<span class="op" id="5867798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5867803">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5867812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5867815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5867819">var</span>&nbsp;<span class="ident" id="5867823">b</span>&nbsp;<span class="ident" id="5867825">bytes</span><span class="op" id="5867830">.</span><span class="ident" id="5867831">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5867840">fmt</span><span class="op" id="5867843">.</span><span class="ident" id="5867844">Fprintf</span><span class="op" id="5867851">(</span><span class="op" id="5867852">&amp;</span><span class="ident" id="5867853">b</span><span class="op" id="5867854">,</span>&nbsp;<span class="string" id="5867856">&#34;%s&nbsp;%s&nbsp;HTTP/%d.%d\r\n&#34;</span><span class="op" id="5867878">,</span>&nbsp;<span class="ident" id="5867880">valueOrDefault</span><span class="op" id="5867894">(</span><span class="ident" id="5867895">req</span><span class="op" id="5867898">.</span><span class="ident" id="5867899">Method</span><span class="op" id="5867905">,</span>&nbsp;<span class="string" id="5867907">&#34;GET&#34;</span><span class="op" id="5867912">)</span><span class="op" id="5867913">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5867917">req</span><span class="op" id="5867920">.</span><span class="ident" id="5867921">URL</span><span class="op" id="5867924">.</span><span class="ident" id="5867925">RequestURI</span><span class="op" id="5867935">(</span><span class="op" id="5867936">)</span><span class="op" id="5867937">,</span>&nbsp;<span class="ident" id="5867939">req</span><span class="op" id="5867942">.</span><span class="ident" id="5867943">ProtoMajor</span><span class="op" id="5867953">,</span>&nbsp;<span class="ident" id="5867955">req</span><span class="op" id="5867958">.</span><span class="ident" id="5867959">ProtoMinor</span><span class="op" id="5867969">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5867973">host</span>&nbsp;<span class="op" id="5867978">:=</span>&nbsp;<span class="ident" id="5867981">req</span><span class="op" id="5867984">.</span><span class="ident" id="5867985">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5867991">if</span>&nbsp;<span class="ident" id="5867994">host</span>&nbsp;<span class="op" id="5867999">==</span>&nbsp;<span class="string" id="5868002">&#34;&#34;</span>&nbsp;<span class="op" id="5868005">&amp;&amp;</span>&nbsp;<span class="ident" id="5868008">req</span><span class="op" id="5868011">.</span><span class="ident" id="5868012">URL</span>&nbsp;<span class="op" id="5868016">!=</span>&nbsp;<span class="ident" id="5868019">nil</span>&nbsp;<span class="op" id="5868023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868027">host</span>&nbsp;<span class="op" id="5868032">=</span>&nbsp;<span class="ident" id="5868034">req</span><span class="op" id="5868037">.</span><span class="ident" id="5868038">URL</span><span class="op" id="5868041">.</span><span class="ident" id="5868042">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5868048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868051">if</span>&nbsp;<span class="ident" id="5868054">host</span>&nbsp;<span class="op" id="5868059">!=</span>&nbsp;<span class="string" id="5868062">&#34;&#34;</span>&nbsp;<span class="op" id="5868065">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868069">fmt</span><span class="op" id="5868072">.</span><span class="ident" id="5868073">Fprintf</span><span class="op" id="5868080">(</span><span class="op" id="5868081">&amp;</span><span class="ident" id="5868082">b</span><span class="op" id="5868083">,</span>&nbsp;<span class="string" id="5868085">&#34;Host:&nbsp;%s\r\n&#34;</span><span class="op" id="5868099">,</span>&nbsp;<span class="ident" id="5868101">host</span><span class="op" id="5868105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5868108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868112">chunked</span>&nbsp;<span class="op" id="5868120">:=</span>&nbsp;<span class="builtinfunc" id="5868123">len</span><span class="op" id="5868126">(</span><span class="ident" id="5868127">req</span><span class="op" id="5868130">.</span><span class="ident" id="5868131">TransferEncoding</span><span class="op" id="5868147">)</span>&nbsp;<span class="op" id="5868149">&gt;</span>&nbsp;<span class="num" id="5868151">0</span>&nbsp;<span class="op" id="5868153">&amp;&amp;</span>&nbsp;<span class="ident" id="5868156">req</span><span class="op" id="5868159">.</span><span class="ident" id="5868160">TransferEncoding</span><span class="op" id="5868176">[</span><span class="num" id="5868177">0</span><span class="op" id="5868178">]</span>&nbsp;<span class="op" id="5868180">==</span>&nbsp;<span class="string" id="5868183">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868194">if</span>&nbsp;<span class="builtinfunc" id="5868197">len</span><span class="op" id="5868200">(</span><span class="ident" id="5868201">req</span><span class="op" id="5868204">.</span><span class="ident" id="5868205">TransferEncoding</span><span class="op" id="5868221">)</span>&nbsp;<span class="op" id="5868223">&gt;</span>&nbsp;<span class="num" id="5868225">0</span>&nbsp;<span class="op" id="5868227">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868231">fmt</span><span class="op" id="5868234">.</span><span class="ident" id="5868235">Fprintf</span><span class="op" id="5868242">(</span><span class="op" id="5868243">&amp;</span><span class="ident" id="5868244">b</span><span class="op" id="5868245">,</span>&nbsp;<span class="string" id="5868247">&#34;Transfer-Encoding:&nbsp;%s\r\n&#34;</span><span class="op" id="5868274">,</span>&nbsp;<span class="ident" id="5868276">strings</span><span class="op" id="5868283">.</span><span class="ident" id="5868284">Join</span><span class="op" id="5868288">(</span><span class="ident" id="5868289">req</span><span class="op" id="5868292">.</span><span class="ident" id="5868293">TransferEncoding</span><span class="op" id="5868309">,</span>&nbsp;<span class="string" id="5868311">&#34;,&#34;</span><span class="op" id="5868314">)</span><span class="op" id="5868315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5868318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868321">if</span>&nbsp;<span class="ident" id="5868324">req</span><span class="op" id="5868327">.</span><span class="ident" id="5868328">Close</span>&nbsp;<span class="op" id="5868334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868338">fmt</span><span class="op" id="5868341">.</span><span class="ident" id="5868342">Fprintf</span><span class="op" id="5868349">(</span><span class="op" id="5868350">&amp;</span><span class="ident" id="5868351">b</span><span class="op" id="5868352">,</span>&nbsp;<span class="string" id="5868354">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="5868377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5868380">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868384">err</span>&nbsp;<span class="op" id="5868388">=</span>&nbsp;<span class="ident" id="5868390">req</span><span class="op" id="5868393">.</span><span class="ident" id="5868394">Header</span><span class="op" id="5868400">.</span><span class="ident" id="5868401">WriteSubset</span><span class="op" id="5868412">(</span><span class="op" id="5868413">&amp;</span><span class="ident" id="5868414">b</span><span class="op" id="5868415">,</span>&nbsp;<span class="ident" id="5868417">reqWriteExcludeHeaderDump</span><span class="op" id="5868442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868445">if</span>&nbsp;<span class="ident" id="5868448">err</span>&nbsp;<span class="op" id="5868452">!=</span>&nbsp;<span class="ident" id="5868455">nil</span>&nbsp;<span class="op" id="5868459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868463">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5868471">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868475">io</span><span class="op" id="5868477">.</span><span class="ident" id="5868478">WriteString</span><span class="op" id="5868489">(</span><span class="op" id="5868490">&amp;</span><span class="ident" id="5868491">b</span><span class="op" id="5868492">,</span>&nbsp;<span class="string" id="5868494">&#34;\r\n&#34;</span><span class="op" id="5868500">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868504">if</span>&nbsp;<span class="ident" id="5868507">req</span><span class="op" id="5868510">.</span><span class="ident" id="5868511">Body</span>&nbsp;<span class="op" id="5868516">!=</span>&nbsp;<span class="ident" id="5868519">nil</span>&nbsp;<span class="op" id="5868523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868527">var</span>&nbsp;<span class="ident" id="5868531">dest</span>&nbsp;<span class="ident" id="5868536">io</span><span class="op" id="5868538">.</span><span class="ident" id="5868539">Writer</span>&nbsp;<span class="op" id="5868546">=</span>&nbsp;<span class="op" id="5868548">&amp;</span><span class="ident" id="5868549">b</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868553">if</span>&nbsp;<span class="ident" id="5868556">chunked</span>&nbsp;<span class="op" id="5868564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868569">dest</span>&nbsp;<span class="op" id="5868574">=</span>&nbsp;<span class="ident" id="5868576">NewChunkedWriter</span><span class="op" id="5868592">(</span><span class="ident" id="5868593">dest</span><span class="op" id="5868597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5868601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868605">_</span><span class="op" id="5868606">,</span>&nbsp;<span class="ident" id="5868608">err</span>&nbsp;<span class="op" id="5868612">=</span>&nbsp;<span class="ident" id="5868614">io</span><span class="op" id="5868616">.</span><span class="ident" id="5868617">Copy</span><span class="op" id="5868621">(</span><span class="ident" id="5868622">dest</span><span class="op" id="5868626">,</span>&nbsp;<span class="ident" id="5868628">req</span><span class="op" id="5868631">.</span><span class="ident" id="5868632">Body</span><span class="op" id="5868636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868640">if</span>&nbsp;<span class="ident" id="5868643">chunked</span>&nbsp;<span class="op" id="5868651">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868656">dest</span><span class="op" id="5868660">.</span><span class="op" id="5868661">(</span><span class="ident" id="5868662">io</span><span class="op" id="5868664">.</span><span class="ident" id="5868665">Closer</span><span class="op" id="5868671">)</span><span class="op" id="5868672">.</span><span class="ident" id="5868673">Close</span><span class="op" id="5868678">(</span><span class="op" id="5868679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868684">io</span><span class="op" id="5868686">.</span><span class="ident" id="5868687">WriteString</span><span class="op" id="5868698">(</span><span class="op" id="5868699">&amp;</span><span class="ident" id="5868700">b</span><span class="op" id="5868701">,</span>&nbsp;<span class="string" id="5868703">&#34;\r\n&#34;</span><span class="op" id="5868709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5868713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5868716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868720">req</span><span class="op" id="5868723">.</span><span class="ident" id="5868724">Body</span>&nbsp;<span class="op" id="5868729">=</span>&nbsp;<span class="ident" id="5868731">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868737">if</span>&nbsp;<span class="ident" id="5868740">err</span>&nbsp;<span class="op" id="5868744">!=</span>&nbsp;<span class="ident" id="5868747">nil</span>&nbsp;<span class="op" id="5868751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868755">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5868763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868766">dump</span>&nbsp;<span class="op" id="5868771">=</span>&nbsp;<span class="ident" id="5868773">b</span><span class="op" id="5868774">.</span><span class="ident" id="5868775">Bytes</span><span class="op" id="5868780">(</span><span class="op" id="5868781">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868784">return</span><br>
<span class="lineno"></span><span class="op" id="5868791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5868794">//&nbsp;errNoBody&nbsp;is&nbsp;a&nbsp;sentinel&nbsp;error&nbsp;value&nbsp;used&nbsp;by&nbsp;failureToReadBody&nbsp;so&nbsp;we&nbsp;can&nbsp;detect</span><br>
<span class="lineno"></span><span class="comment" id="5868876">//&nbsp;that&nbsp;the&nbsp;lack&nbsp;of&nbsp;body&nbsp;was&nbsp;intentional.</span><br>
<span class="lineno">245</span><span class="keyword" id="5868918">var</span>&nbsp;<span class="ident" id="5868922">errNoBody</span>&nbsp;<span class="op" id="5868932">=</span>&nbsp;<span class="ident" id="5868934">errors</span><span class="op" id="5868940">.</span><span class="ident" id="5868941">New</span><span class="op" id="5868944">(</span><span class="string" id="5868945">&#34;sentinel&nbsp;error&nbsp;value&#34;</span><span class="op" id="5868967">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5868970">//&nbsp;failureToReadBody&nbsp;is&nbsp;a&nbsp;io.ReadCloser&nbsp;that&nbsp;just&nbsp;returns&nbsp;errNoBody&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="5869041">//&nbsp;Read.&nbsp;&nbsp;It&#39;s&nbsp;swapped&nbsp;in&nbsp;when&nbsp;we&nbsp;don&#39;t&nbsp;actually&nbsp;want&nbsp;to&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5869110">//&nbsp;body,&nbsp;but&nbsp;need&nbsp;a&nbsp;non-nil&nbsp;one,&nbsp;and&nbsp;want&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;error</span><br>
<span class="lineno">250</span><span class="comment" id="5869177">//&nbsp;from&nbsp;reading&nbsp;the&nbsp;dummy&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="5869209">type</span>&nbsp;<span class="ident" id="5869214">failureToReadBody</span>&nbsp;<span class="keyword" id="5869232">struct</span><span class="op" id="5869238">{</span><span class="op" id="5869239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5869242">func</span>&nbsp;<span class="op" id="5869247">(</span><span class="ident" id="5869248">failureToReadBody</span><span class="op" id="5869265">)</span>&nbsp;<span class="ident" id="5869267">Read</span><span class="op" id="5869271">(</span><span class="op" id="5869272">[</span><span class="op" id="5869273">]</span><span class="builtintype" id="5869274">byte</span><span class="op" id="5869278">)</span>&nbsp;<span class="op" id="5869280">(</span><span class="builtintype" id="5869281">int</span><span class="op" id="5869284">,</span>&nbsp;<span class="builtintype" id="5869286">error</span><span class="op" id="5869291">)</span>&nbsp;<span class="op" id="5869293">{</span>&nbsp;<span class="keyword" id="5869295">return</span>&nbsp;<span class="num" id="5869302">0</span><span class="op" id="5869303">,</span>&nbsp;<span class="ident" id="5869305">errNoBody</span>&nbsp;<span class="op" id="5869315">}</span><br>
<span class="lineno"></span><span class="keyword" id="5869317">func</span>&nbsp;<span class="op" id="5869322">(</span><span class="ident" id="5869323">failureToReadBody</span><span class="op" id="5869340">)</span>&nbsp;<span class="ident" id="5869342">Close</span><span class="op" id="5869347">(</span><span class="op" id="5869348">)</span>&nbsp;<span class="builtintype" id="5869350">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5869368">{</span>&nbsp;<span class="keyword" id="5869370">return</span>&nbsp;<span class="ident" id="5869377">nil</span>&nbsp;<span class="op" id="5869381">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="5869384">var</span>&nbsp;<span class="ident" id="5869388">emptyBody</span>&nbsp;<span class="op" id="5869398">=</span>&nbsp;<span class="ident" id="5869400">ioutil</span><span class="op" id="5869406">.</span><span class="ident" id="5869407">NopCloser</span><span class="op" id="5869416">(</span><span class="ident" id="5869417">strings</span><span class="op" id="5869424">.</span><span class="ident" id="5869425">NewReader</span><span class="op" id="5869434">(</span><span class="string" id="5869435">&#34;&#34;</span><span class="op" id="5869437">)</span><span class="op" id="5869438">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5869441">//&nbsp;DumpResponse&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;dumps&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="5869499">func</span>&nbsp;<span class="ident" id="5869504">DumpResponse</span><span class="op" id="5869516">(</span><span class="ident" id="5869517">resp</span>&nbsp;<span class="op" id="5869522">*</span><span class="ident" id="5869523">http</span><span class="op" id="5869527">.</span><span class="ident" id="5869528">Response</span><span class="op" id="5869536">,</span>&nbsp;<span class="ident" id="5869538">body</span>&nbsp;<span class="builtintype" id="5869543">bool</span><span class="op" id="5869547">)</span>&nbsp;<span class="op" id="5869549">(</span><span class="ident" id="5869550">dump</span>&nbsp;<span class="op" id="5869555">[</span><span class="op" id="5869556">]</span><span class="builtintype" id="5869557">byte</span><span class="op" id="5869561">,</span>&nbsp;<span class="ident" id="5869563">err</span>&nbsp;<span class="builtintype" id="5869567">error</span><span class="op" id="5869572">)</span>&nbsp;<span class="op" id="5869574">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5869577">var</span>&nbsp;<span class="ident" id="5869581">b</span>&nbsp;<span class="ident" id="5869583">bytes</span><span class="op" id="5869588">.</span><span class="ident" id="5869589">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869597">save</span>&nbsp;<span class="op" id="5869602">:=</span>&nbsp;<span class="ident" id="5869605">resp</span><span class="op" id="5869609">.</span><span class="ident" id="5869610">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869616">savecl</span>&nbsp;<span class="op" id="5869623">:=</span>&nbsp;<span class="ident" id="5869626">resp</span><span class="op" id="5869630">.</span><span class="ident" id="5869631">ContentLength</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5869647">if</span>&nbsp;<span class="op" id="5869650">!</span><span class="ident" id="5869651">body</span>&nbsp;<span class="op" id="5869656">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869660">resp</span><span class="op" id="5869664">.</span><span class="ident" id="5869665">Body</span>&nbsp;<span class="op" id="5869670">=</span>&nbsp;<span class="ident" id="5869672">failureToReadBody</span><span class="op" id="5869689">{</span><span class="op" id="5869690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5869693">}</span>&nbsp;<span class="keyword" id="5869695">else</span>&nbsp;<span class="keyword" id="5869700">if</span>&nbsp;<span class="ident" id="5869703">resp</span><span class="op" id="5869707">.</span><span class="ident" id="5869708">Body</span>&nbsp;<span class="op" id="5869713">==</span>&nbsp;<span class="ident" id="5869716">nil</span>&nbsp;<span class="op" id="5869720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869724">resp</span><span class="op" id="5869728">.</span><span class="ident" id="5869729">Body</span>&nbsp;<span class="op" id="5869734">=</span>&nbsp;<span class="ident" id="5869736">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5869747">}</span>&nbsp;<span class="keyword" id="5869749">else</span>&nbsp;<span class="op" id="5869754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869758">save</span><span class="op" id="5869762">,</span>&nbsp;<span class="ident" id="5869764">resp</span><span class="op" id="5869768">.</span><span class="ident" id="5869769">Body</span><span class="op" id="5869773">,</span>&nbsp;<span class="ident" id="5869775">err</span>&nbsp;<span class="op" id="5869779">=</span>&nbsp;<span class="ident" id="5869781">drainBody</span><span class="op" id="5869790">(</span><span class="ident" id="5869791">resp</span><span class="op" id="5869795">.</span><span class="ident" id="5869796">Body</span><span class="op" id="5869800">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5869804">if</span>&nbsp;<span class="ident" id="5869807">err</span>&nbsp;<span class="op" id="5869811">!=</span>&nbsp;<span class="ident" id="5869814">nil</span>&nbsp;<span class="op" id="5869818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5869823">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5869832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5869835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869838">err</span>&nbsp;<span class="op" id="5869842">=</span>&nbsp;<span class="ident" id="5869844">resp</span><span class="op" id="5869848">.</span><span class="ident" id="5869849">Write</span><span class="op" id="5869854">(</span><span class="op" id="5869855">&amp;</span><span class="ident" id="5869856">b</span><span class="op" id="5869857">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5869860">if</span>&nbsp;<span class="ident" id="5869863">err</span>&nbsp;<span class="op" id="5869867">==</span>&nbsp;<span class="ident" id="5869870">errNoBody</span>&nbsp;<span class="op" id="5869880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869884">err</span>&nbsp;<span class="op" id="5869888">=</span>&nbsp;<span class="ident" id="5869890">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5869895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869898">resp</span><span class="op" id="5869902">.</span><span class="ident" id="5869903">Body</span>&nbsp;<span class="op" id="5869908">=</span>&nbsp;<span class="ident" id="5869910">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869916">resp</span><span class="op" id="5869920">.</span><span class="ident" id="5869921">ContentLength</span>&nbsp;<span class="op" id="5869935">=</span>&nbsp;<span class="ident" id="5869937">savecl</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5869945">if</span>&nbsp;<span class="ident" id="5869948">err</span>&nbsp;<span class="op" id="5869952">!=</span>&nbsp;<span class="ident" id="5869955">nil</span>&nbsp;<span class="op" id="5869959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5869963">return</span>&nbsp;<span class="ident" id="5869970">nil</span><span class="op" id="5869973">,</span>&nbsp;<span class="ident" id="5869975">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5869980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5869983">return</span>&nbsp;<span class="ident" id="5869990">b</span><span class="op" id="5869991">.</span><span class="ident" id="5869992">Bytes</span><span class="op" id="5869997">(</span><span class="op" id="5869998">)</span><span class="op" id="5869999">,</span>&nbsp;<span class="ident" id="5870001">nil</span><br>
<span class="lineno"></span><span class="op" id="5870005">}</span>
</div>
</body>
</html>
