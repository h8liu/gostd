<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/gif</h2>
<ul>
<li><a href="/gostd/image/gif/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/gif/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/gif/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/gif/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5993116">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5993171">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5993225">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5993276">//&nbsp;Package&nbsp;gif&nbsp;implements&nbsp;a&nbsp;GIF&nbsp;image&nbsp;decoder&nbsp;and&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="comment" id="5993335">//</span><br>
<span class="lineno"></span><span class="comment" id="5993338">//&nbsp;The&nbsp;GIF&nbsp;specification&nbsp;is&nbsp;at&nbsp;http://www.w3.org/Graphics/GIF/spec-gif89a.txt.</span><br>
<span class="lineno"></span><span class="keyword" id="5993417">package</span>&nbsp;<span class="ident" id="5993425">gif</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5993430">import</span>&nbsp;<span class="op" id="5993437">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5993440">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5993449">&#34;compress/lzw&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5993465">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5993475">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5993482">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5993491">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5993506">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5993511">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="5993514">var</span>&nbsp;<span class="op" id="5993518">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993521">errNotEnough</span>&nbsp;<span class="op" id="5993534">=</span>&nbsp;<span class="ident" id="5993536">errors</span><span class="op" id="5993542">.</span><span class="ident" id="5993543">New</span><span class="op" id="5993546">(</span><span class="string" id="5993547">&#34;gif:&nbsp;not&nbsp;enough&nbsp;image&nbsp;data&#34;</span><span class="op" id="5993575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993578">errTooMuch</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5993591">=</span>&nbsp;<span class="ident" id="5993593">errors</span><span class="op" id="5993599">.</span><span class="ident" id="5993600">New</span><span class="op" id="5993603">(</span><span class="string" id="5993604">&#34;gif:&nbsp;too&nbsp;much&nbsp;image&nbsp;data&#34;</span><span class="op" id="5993630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993633">errBadPixel</span>&nbsp;&nbsp;<span class="op" id="5993646">=</span>&nbsp;<span class="ident" id="5993648">errors</span><span class="op" id="5993654">.</span><span class="ident" id="5993655">New</span><span class="op" id="5993658">(</span><span class="string" id="5993659">&#34;gif:&nbsp;invalid&nbsp;pixel&nbsp;value&#34;</span><span class="op" id="5993685">)</span><br>
<span class="lineno"></span><span class="op" id="5993687">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="5993690">//&nbsp;If&nbsp;the&nbsp;io.Reader&nbsp;does&nbsp;not&nbsp;also&nbsp;have&nbsp;ReadByte,&nbsp;then&nbsp;decode&nbsp;will&nbsp;introduce&nbsp;its&nbsp;own&nbsp;buffering.</span><br>
<span class="lineno"></span><span class="keyword" id="5993785">type</span>&nbsp;<span class="ident" id="5993790">reader</span>&nbsp;<span class="keyword" id="5993797">interface</span>&nbsp;<span class="op" id="5993807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993810">io</span><span class="op" id="5993812">.</span><span class="ident" id="5993813">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993821">io</span><span class="op" id="5993823">.</span><span class="ident" id="5993824">ByteReader</span><br>
<span class="lineno">30</span><span class="op" id="5993835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5993838">//&nbsp;Masks&nbsp;etc.</span><br>
<span class="lineno"></span><span class="keyword" id="5993852">const</span>&nbsp;<span class="op" id="5993858">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5993861">//&nbsp;Fields.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993873">fColorMapFollows</span>&nbsp;<span class="op" id="5993890">=</span>&nbsp;<span class="num" id="5993892">1</span>&nbsp;<span class="op" id="5993894">&lt;&lt;</span>&nbsp;<span class="num" id="5993897">7</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5993901">//&nbsp;Image&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993919">ifLocalColorTable</span>&nbsp;<span class="op" id="5993937">=</span>&nbsp;<span class="num" id="5993939">1</span>&nbsp;<span class="op" id="5993941">&lt;&lt;</span>&nbsp;<span class="num" id="5993944">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993947">ifInterlace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5993965">=</span>&nbsp;<span class="num" id="5993967">1</span>&nbsp;<span class="op" id="5993969">&lt;&lt;</span>&nbsp;<span class="num" id="5993972">6</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993975">ifPixelSizeMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5993993">=</span>&nbsp;<span class="num" id="5993995">7</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5993999">//&nbsp;Graphic&nbsp;control&nbsp;flags.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994026">gcTransparentColorSet</span>&nbsp;<span class="op" id="5994048">=</span>&nbsp;<span class="num" id="5994050">1</span>&nbsp;<span class="op" id="5994052">&lt;&lt;</span>&nbsp;<span class="num" id="5994055">0</span><br>
<span class="lineno"></span><span class="op" id="5994057">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="5994060">//&nbsp;Section&nbsp;indicators.</span><br>
<span class="lineno"></span><span class="keyword" id="5994083">const</span>&nbsp;<span class="op" id="5994089">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994092">sExtension</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5994109">=</span>&nbsp;<span class="num" id="5994111">0x21</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994117">sImageDescriptor</span>&nbsp;<span class="op" id="5994134">=</span>&nbsp;<span class="num" id="5994136">0x2C</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994142">sTrailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5994159">=</span>&nbsp;<span class="num" id="5994161">0x3B</span><br>
<span class="lineno"></span><span class="op" id="5994166">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5994169">//&nbsp;Extensions.</span><br>
<span class="lineno"></span><span class="keyword" id="5994184">const</span>&nbsp;<span class="op" id="5994190">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994193">eText</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5994209">=</span>&nbsp;<span class="num" id="5994211">0x01</span>&nbsp;<span class="comment" id="5994216">//&nbsp;Plain&nbsp;Text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994231">eGraphicControl</span>&nbsp;<span class="op" id="5994247">=</span>&nbsp;<span class="num" id="5994249">0xF9</span>&nbsp;<span class="comment" id="5994254">//&nbsp;Graphic&nbsp;Control</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994274">eComment</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5994290">=</span>&nbsp;<span class="num" id="5994292">0xFE</span>&nbsp;<span class="comment" id="5994297">//&nbsp;Comment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994309">eApplication</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5994325">=</span>&nbsp;<span class="num" id="5994327">0xFF</span>&nbsp;<span class="comment" id="5994332">//&nbsp;Application</span><br>
<span class="lineno"></span><span class="op" id="5994347">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="5994350">//&nbsp;decoder&nbsp;is&nbsp;the&nbsp;type&nbsp;used&nbsp;to&nbsp;decode&nbsp;a&nbsp;GIF&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="5994400">type</span>&nbsp;<span class="ident" id="5994405">decoder</span>&nbsp;<span class="keyword" id="5994413">struct</span>&nbsp;<span class="op" id="5994420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994423">r</span>&nbsp;<span class="ident" id="5994425">reader</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5994434">//&nbsp;From&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994451">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5994467">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994475">width</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5994491">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994496">height</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5994512">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994517">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5994533">byte</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994539">headerFields</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5994555">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994561">backgroundIndex</span>&nbsp;<span class="builtintype" id="5994577">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994583">loopCount</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5994599">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994604">delayTime</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5994620">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5994626">//&nbsp;Unused&nbsp;from&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994650">aspect</span>&nbsp;<span class="builtintype" id="5994657">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5994664">//&nbsp;From&nbsp;image&nbsp;descriptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994691">imageFields</span>&nbsp;<span class="builtintype" id="5994703">byte</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5994710">//&nbsp;From&nbsp;graphics&nbsp;control.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994737">transparentIndex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5994757">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994763">hasTransparentIndex</span>&nbsp;<span class="builtintype" id="5994783">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5994790">//&nbsp;Computed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994804">pixelSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5994819">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994825">globalColorMap</span>&nbsp;<span class="ident" id="5994840">color</span><span class="op" id="5994845">.</span><span class="ident" id="5994846">Palette</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5994856">//&nbsp;Used&nbsp;when&nbsp;decoding.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994880">delay</span>&nbsp;<span class="op" id="5994886">[</span><span class="op" id="5994887">]</span><span class="builtintype" id="5994888">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994893">image</span>&nbsp;<span class="op" id="5994899">[</span><span class="op" id="5994900">]</span><span class="op" id="5994901">*</span><span class="ident" id="5994902">image</span><span class="op" id="5994907">.</span><span class="ident" id="5994908">Paletted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994918">tmp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5994924">[</span><span class="num" id="5994925">1024</span><span class="op" id="5994929">]</span><span class="builtintype" id="5994930">byte</span>&nbsp;<span class="comment" id="5994935">//&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;768&nbsp;so&nbsp;we&nbsp;can&nbsp;read&nbsp;color&nbsp;map</span><br>
<span class="lineno"></span><span class="op" id="5994984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="5994987">//&nbsp;blockReader&nbsp;parses&nbsp;the&nbsp;block&nbsp;structure&nbsp;of&nbsp;GIF&nbsp;image&nbsp;data,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="5995054">//&nbsp;comprises&nbsp;(n,&nbsp;(n&nbsp;bytes))&nbsp;blocks,&nbsp;with&nbsp;1&nbsp;&lt;=&nbsp;n&nbsp;&lt;=&nbsp;255.&nbsp;&nbsp;It&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5995121">//&nbsp;reader&nbsp;given&nbsp;to&nbsp;the&nbsp;LZW&nbsp;decoder,&nbsp;which&nbsp;is&nbsp;thus&nbsp;immune&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5995185">//&nbsp;blocking.&nbsp;&nbsp;After&nbsp;the&nbsp;LZW&nbsp;decoder&nbsp;completes,&nbsp;there&nbsp;will&nbsp;be&nbsp;a&nbsp;0-byte</span><br>
<span class="lineno"></span><span class="comment" id="5995255">//&nbsp;block&nbsp;remaining&nbsp;(0,&nbsp;()),&nbsp;which&nbsp;is&nbsp;consumed&nbsp;when&nbsp;checking&nbsp;that&nbsp;the</span><br>
<span class="lineno">100</span><span class="comment" id="5995324">//&nbsp;blockReader&nbsp;is&nbsp;exhausted.</span><br>
<span class="lineno"></span><span class="keyword" id="5995353">type</span>&nbsp;<span class="ident" id="5995358">blockReader</span>&nbsp;<span class="keyword" id="5995370">struct</span>&nbsp;<span class="op" id="5995377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5995380">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5995386">reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5995394">slice</span>&nbsp;<span class="op" id="5995400">[</span><span class="op" id="5995401">]</span><span class="builtintype" id="5995402">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5995408">err</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5995414">error</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5995421">tmp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5995427">[</span><span class="num" id="5995428">256</span><span class="op" id="5995431">]</span><span class="builtintype" id="5995432">byte</span><br>
<span class="lineno"></span><span class="op" id="5995437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5995440">func</span>&nbsp;<span class="op" id="5995445">(</span><span class="ident" id="5995446">b</span>&nbsp;<span class="op" id="5995448">*</span><span class="ident" id="5995449">blockReader</span><span class="op" id="5995460">)</span>&nbsp;<span class="ident" id="5995462">Read</span><span class="op" id="5995466">(</span><span class="ident" id="5995467">p</span>&nbsp;<span class="op" id="5995469">[</span><span class="op" id="5995470">]</span><span class="builtintype" id="5995471">byte</span><span class="op" id="5995475">)</span>&nbsp;<span class="op" id="5995477">(</span><span class="builtintype" id="5995478">int</span><span class="op" id="5995481">,</span>&nbsp;<span class="builtintype" id="5995483">error</span><span class="op" id="5995488">)</span>&nbsp;<span class="op" id="5995490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995493">if</span>&nbsp;<span class="ident" id="5995496">b</span><span class="op" id="5995497">.</span><span class="ident" id="5995498">err</span>&nbsp;<span class="op" id="5995502">!=</span>&nbsp;<span class="ident" id="5995505">nil</span>&nbsp;<span class="op" id="5995509">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995513">return</span>&nbsp;<span class="num" id="5995520">0</span><span class="op" id="5995521">,</span>&nbsp;<span class="ident" id="5995523">b</span><span class="op" id="5995524">.</span><span class="ident" id="5995525">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5995530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995533">if</span>&nbsp;<span class="builtinfunc" id="5995536">len</span><span class="op" id="5995539">(</span><span class="ident" id="5995540">p</span><span class="op" id="5995541">)</span>&nbsp;<span class="op" id="5995543">==</span>&nbsp;<span class="num" id="5995546">0</span>&nbsp;<span class="op" id="5995548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995552">return</span>&nbsp;<span class="num" id="5995559">0</span><span class="op" id="5995560">,</span>&nbsp;<span class="ident" id="5995562">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5995567">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995570">if</span>&nbsp;<span class="builtinfunc" id="5995573">len</span><span class="op" id="5995576">(</span><span class="ident" id="5995577">b</span><span class="op" id="5995578">.</span><span class="ident" id="5995579">slice</span><span class="op" id="5995584">)</span>&nbsp;<span class="op" id="5995586">==</span>&nbsp;<span class="num" id="5995589">0</span>&nbsp;<span class="op" id="5995591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995595">var</span>&nbsp;<span class="ident" id="5995599">blockLen</span>&nbsp;<span class="builtintype" id="5995608">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5995616">blockLen</span><span class="op" id="5995624">,</span>&nbsp;<span class="ident" id="5995626">b</span><span class="op" id="5995627">.</span><span class="ident" id="5995628">err</span>&nbsp;<span class="op" id="5995632">=</span>&nbsp;<span class="ident" id="5995634">b</span><span class="op" id="5995635">.</span><span class="ident" id="5995636">r</span><span class="op" id="5995637">.</span><span class="ident" id="5995638">ReadByte</span><span class="op" id="5995646">(</span><span class="op" id="5995647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995651">if</span>&nbsp;<span class="ident" id="5995654">b</span><span class="op" id="5995655">.</span><span class="ident" id="5995656">err</span>&nbsp;<span class="op" id="5995660">!=</span>&nbsp;<span class="ident" id="5995663">nil</span>&nbsp;<span class="op" id="5995667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995672">return</span>&nbsp;<span class="num" id="5995679">0</span><span class="op" id="5995680">,</span>&nbsp;<span class="ident" id="5995682">b</span><span class="op" id="5995683">.</span><span class="ident" id="5995684">err</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5995690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995694">if</span>&nbsp;<span class="ident" id="5995697">blockLen</span>&nbsp;<span class="op" id="5995706">==</span>&nbsp;<span class="num" id="5995709">0</span>&nbsp;<span class="op" id="5995711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5995716">b</span><span class="op" id="5995717">.</span><span class="ident" id="5995718">err</span>&nbsp;<span class="op" id="5995722">=</span>&nbsp;<span class="ident" id="5995724">io</span><span class="op" id="5995726">.</span><span class="ident" id="5995727">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995734">return</span>&nbsp;<span class="num" id="5995741">0</span><span class="op" id="5995742">,</span>&nbsp;<span class="ident" id="5995744">b</span><span class="op" id="5995745">.</span><span class="ident" id="5995746">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5995752">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5995756">b</span><span class="op" id="5995757">.</span><span class="ident" id="5995758">slice</span>&nbsp;<span class="op" id="5995764">=</span>&nbsp;<span class="ident" id="5995766">b</span><span class="op" id="5995767">.</span><span class="ident" id="5995768">tmp</span><span class="op" id="5995771">[</span><span class="num" id="5995772">0</span><span class="op" id="5995773">:</span><span class="ident" id="5995774">blockLen</span><span class="op" id="5995782">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995786">if</span>&nbsp;<span class="ident" id="5995789">_</span><span class="op" id="5995790">,</span>&nbsp;<span class="ident" id="5995792">b</span><span class="op" id="5995793">.</span><span class="ident" id="5995794">err</span>&nbsp;<span class="op" id="5995798">=</span>&nbsp;<span class="ident" id="5995800">io</span><span class="op" id="5995802">.</span><span class="ident" id="5995803">ReadFull</span><span class="op" id="5995811">(</span><span class="ident" id="5995812">b</span><span class="op" id="5995813">.</span><span class="ident" id="5995814">r</span><span class="op" id="5995815">,</span>&nbsp;<span class="ident" id="5995817">b</span><span class="op" id="5995818">.</span><span class="ident" id="5995819">slice</span><span class="op" id="5995824">)</span><span class="op" id="5995825">;</span>&nbsp;<span class="ident" id="5995827">b</span><span class="op" id="5995828">.</span><span class="ident" id="5995829">err</span>&nbsp;<span class="op" id="5995833">!=</span>&nbsp;<span class="ident" id="5995836">nil</span>&nbsp;<span class="op" id="5995840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995845">return</span>&nbsp;<span class="num" id="5995852">0</span><span class="op" id="5995853">,</span>&nbsp;<span class="ident" id="5995855">b</span><span class="op" id="5995856">.</span><span class="ident" id="5995857">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5995863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5995866">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5995869">n</span>&nbsp;<span class="op" id="5995871">:=</span>&nbsp;<span class="builtinfunc" id="5995874">copy</span><span class="op" id="5995878">(</span><span class="ident" id="5995879">p</span><span class="op" id="5995880">,</span>&nbsp;<span class="ident" id="5995882">b</span><span class="op" id="5995883">.</span><span class="ident" id="5995884">slice</span><span class="op" id="5995889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5995892">b</span><span class="op" id="5995893">.</span><span class="ident" id="5995894">slice</span>&nbsp;<span class="op" id="5995900">=</span>&nbsp;<span class="ident" id="5995902">b</span><span class="op" id="5995903">.</span><span class="ident" id="5995904">slice</span><span class="op" id="5995909">[</span><span class="ident" id="5995910">n</span><span class="op" id="5995911">:</span><span class="op" id="5995912">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995915">return</span>&nbsp;<span class="ident" id="5995922">n</span><span class="op" id="5995923">,</span>&nbsp;<span class="ident" id="5995925">nil</span><br>
<span class="lineno"></span><span class="op" id="5995929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="comment" id="5995932">//&nbsp;decode&nbsp;reads&nbsp;a&nbsp;GIF&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;stores&nbsp;the&nbsp;result&nbsp;in&nbsp;d.</span><br>
<span class="lineno"></span><span class="keyword" id="5995995">func</span>&nbsp;<span class="op" id="5996000">(</span><span class="ident" id="5996001">d</span>&nbsp;<span class="op" id="5996003">*</span><span class="ident" id="5996004">decoder</span><span class="op" id="5996011">)</span>&nbsp;<span class="ident" id="5996013">decode</span><span class="op" id="5996019">(</span><span class="ident" id="5996020">r</span>&nbsp;<span class="ident" id="5996022">io</span><span class="op" id="5996024">.</span><span class="ident" id="5996025">Reader</span><span class="op" id="5996031">,</span>&nbsp;<span class="ident" id="5996033">configOnly</span>&nbsp;<span class="builtintype" id="5996044">bool</span><span class="op" id="5996048">)</span>&nbsp;<span class="builtintype" id="5996050">error</span>&nbsp;<span class="op" id="5996056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5996059">//&nbsp;Add&nbsp;buffering&nbsp;if&nbsp;r&nbsp;does&nbsp;not&nbsp;provide&nbsp;ReadByte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996109">if</span>&nbsp;<span class="ident" id="5996112">rr</span><span class="op" id="5996114">,</span>&nbsp;<span class="ident" id="5996116">ok</span>&nbsp;<span class="op" id="5996119">:=</span>&nbsp;<span class="ident" id="5996122">r</span><span class="op" id="5996123">.</span><span class="op" id="5996124">(</span><span class="ident" id="5996125">reader</span><span class="op" id="5996131">)</span><span class="op" id="5996132">;</span>&nbsp;<span class="ident" id="5996134">ok</span>&nbsp;<span class="op" id="5996137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996141">d</span><span class="op" id="5996142">.</span><span class="ident" id="5996143">r</span>&nbsp;<span class="op" id="5996145">=</span>&nbsp;<span class="ident" id="5996147">rr</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996151">}</span>&nbsp;<span class="keyword" id="5996153">else</span>&nbsp;<span class="op" id="5996158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996162">d</span><span class="op" id="5996163">.</span><span class="ident" id="5996164">r</span>&nbsp;<span class="op" id="5996166">=</span>&nbsp;<span class="ident" id="5996168">bufio</span><span class="op" id="5996173">.</span><span class="ident" id="5996174">NewReader</span><span class="op" id="5996183">(</span><span class="ident" id="5996184">r</span><span class="op" id="5996185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996192">err</span>&nbsp;<span class="op" id="5996196">:=</span>&nbsp;<span class="ident" id="5996199">d</span><span class="op" id="5996200">.</span><span class="ident" id="5996201">readHeaderAndScreenDescriptor</span><span class="op" id="5996230">(</span><span class="op" id="5996231">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996234">if</span>&nbsp;<span class="ident" id="5996237">err</span>&nbsp;<span class="op" id="5996241">!=</span>&nbsp;<span class="ident" id="5996244">nil</span>&nbsp;<span class="op" id="5996248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996252">return</span>&nbsp;<span class="ident" id="5996259">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996267">if</span>&nbsp;<span class="ident" id="5996270">configOnly</span>&nbsp;<span class="op" id="5996281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996285">return</span>&nbsp;<span class="ident" id="5996292">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996301">if</span>&nbsp;<span class="ident" id="5996304">d</span><span class="op" id="5996305">.</span><span class="ident" id="5996306">headerFields</span><span class="op" id="5996318">&amp;</span><span class="ident" id="5996319">fColorMapFollows</span>&nbsp;<span class="op" id="5996336">!=</span>&nbsp;<span class="num" id="5996339">0</span>&nbsp;<span class="op" id="5996341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996345">if</span>&nbsp;<span class="ident" id="5996348">d</span><span class="op" id="5996349">.</span><span class="ident" id="5996350">globalColorMap</span><span class="op" id="5996364">,</span>&nbsp;<span class="ident" id="5996366">err</span>&nbsp;<span class="op" id="5996370">=</span>&nbsp;<span class="ident" id="5996372">d</span><span class="op" id="5996373">.</span><span class="ident" id="5996374">readColorMap</span><span class="op" id="5996386">(</span><span class="op" id="5996387">)</span><span class="op" id="5996388">;</span>&nbsp;<span class="ident" id="5996390">err</span>&nbsp;<span class="op" id="5996394">!=</span>&nbsp;<span class="ident" id="5996397">nil</span>&nbsp;<span class="op" id="5996401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996406">return</span>&nbsp;<span class="ident" id="5996413">err</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996426">for</span>&nbsp;<span class="op" id="5996430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996434">c</span><span class="op" id="5996435">,</span>&nbsp;<span class="ident" id="5996437">err</span>&nbsp;<span class="op" id="5996441">:=</span>&nbsp;<span class="ident" id="5996444">d</span><span class="op" id="5996445">.</span><span class="ident" id="5996446">r</span><span class="op" id="5996447">.</span><span class="ident" id="5996448">ReadByte</span><span class="op" id="5996456">(</span><span class="op" id="5996457">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996461">if</span>&nbsp;<span class="ident" id="5996464">err</span>&nbsp;<span class="op" id="5996468">!=</span>&nbsp;<span class="ident" id="5996471">nil</span>&nbsp;<span class="op" id="5996475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996480">return</span>&nbsp;<span class="ident" id="5996487">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996497">switch</span>&nbsp;<span class="ident" id="5996504">c</span>&nbsp;<span class="op" id="5996506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996510">case</span>&nbsp;<span class="ident" id="5996515">sExtension</span><span class="op" id="5996525">:</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996530">if</span>&nbsp;<span class="ident" id="5996533">err</span>&nbsp;<span class="op" id="5996537">=</span>&nbsp;<span class="ident" id="5996539">d</span><span class="op" id="5996540">.</span><span class="ident" id="5996541">readExtension</span><span class="op" id="5996554">(</span><span class="op" id="5996555">)</span><span class="op" id="5996556">;</span>&nbsp;<span class="ident" id="5996558">err</span>&nbsp;<span class="op" id="5996562">!=</span>&nbsp;<span class="ident" id="5996565">nil</span>&nbsp;<span class="op" id="5996569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996575">return</span>&nbsp;<span class="ident" id="5996582">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996594">case</span>&nbsp;<span class="ident" id="5996599">sImageDescriptor</span><span class="op" id="5996615">:</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996620">m</span><span class="op" id="5996621">,</span>&nbsp;<span class="ident" id="5996623">err</span>&nbsp;<span class="op" id="5996627">:=</span>&nbsp;<span class="ident" id="5996630">d</span><span class="op" id="5996631">.</span><span class="ident" id="5996632">newImageFromDescriptor</span><span class="op" id="5996654">(</span><span class="op" id="5996655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996660">if</span>&nbsp;<span class="ident" id="5996663">err</span>&nbsp;<span class="op" id="5996667">!=</span>&nbsp;<span class="ident" id="5996670">nil</span>&nbsp;<span class="op" id="5996674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996680">return</span>&nbsp;<span class="ident" id="5996687">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996699">useLocalColorMap</span>&nbsp;<span class="op" id="5996716">:=</span>&nbsp;<span class="ident" id="5996719">d</span><span class="op" id="5996720">.</span><span class="ident" id="5996721">imageFields</span><span class="op" id="5996732">&amp;</span><span class="ident" id="5996733">fColorMapFollows</span>&nbsp;<span class="op" id="5996750">!=</span>&nbsp;<span class="num" id="5996753">0</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996758">if</span>&nbsp;<span class="ident" id="5996761">useLocalColorMap</span>&nbsp;<span class="op" id="5996778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996784">m</span><span class="op" id="5996785">.</span><span class="ident" id="5996786">Palette</span><span class="op" id="5996793">,</span>&nbsp;<span class="ident" id="5996795">err</span>&nbsp;<span class="op" id="5996799">=</span>&nbsp;<span class="ident" id="5996801">d</span><span class="op" id="5996802">.</span><span class="ident" id="5996803">readColorMap</span><span class="op" id="5996815">(</span><span class="op" id="5996816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996822">if</span>&nbsp;<span class="ident" id="5996825">err</span>&nbsp;<span class="op" id="5996829">!=</span>&nbsp;<span class="ident" id="5996832">nil</span>&nbsp;<span class="op" id="5996836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996843">return</span>&nbsp;<span class="ident" id="5996850">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996858">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996863">}</span>&nbsp;<span class="keyword" id="5996865">else</span>&nbsp;<span class="op" id="5996870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996876">m</span><span class="op" id="5996877">.</span><span class="ident" id="5996878">Palette</span>&nbsp;<span class="op" id="5996886">=</span>&nbsp;<span class="ident" id="5996888">d</span><span class="op" id="5996889">.</span><span class="ident" id="5996890">globalColorMap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996913">if</span>&nbsp;<span class="ident" id="5996916">d</span><span class="op" id="5996917">.</span><span class="ident" id="5996918">hasTransparentIndex</span>&nbsp;<span class="op" id="5996938">&amp;&amp;</span>&nbsp;<span class="builtintype" id="5996941">int</span><span class="op" id="5996944">(</span><span class="ident" id="5996945">d</span><span class="op" id="5996946">.</span><span class="ident" id="5996947">transparentIndex</span><span class="op" id="5996963">)</span>&nbsp;<span class="op" id="5996965">&lt;</span>&nbsp;<span class="builtinfunc" id="5996967">len</span><span class="op" id="5996970">(</span><span class="ident" id="5996971">m</span><span class="op" id="5996972">.</span><span class="ident" id="5996973">Palette</span><span class="op" id="5996980">)</span>&nbsp;<span class="op" id="5996982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996988">if</span>&nbsp;<span class="op" id="5996991">!</span><span class="ident" id="5996992">useLocalColorMap</span>&nbsp;<span class="op" id="5997009">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5997016">//&nbsp;Clone&nbsp;the&nbsp;global&nbsp;color&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997052">m</span><span class="op" id="5997053">.</span><span class="ident" id="5997054">Palette</span>&nbsp;<span class="op" id="5997062">=</span>&nbsp;<span class="builtinfunc" id="5997064">append</span><span class="op" id="5997070">(</span><span class="ident" id="5997071">color</span><span class="op" id="5997076">.</span><span class="ident" id="5997077">Palette</span><span class="op" id="5997084">(</span><span class="ident" id="5997085">nil</span><span class="op" id="5997088">)</span><span class="op" id="5997089">,</span>&nbsp;<span class="ident" id="5997091">d</span><span class="op" id="5997092">.</span><span class="ident" id="5997093">globalColorMap</span><span class="op" id="5997107">...</span><span class="op" id="5997110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997122">m</span><span class="op" id="5997123">.</span><span class="ident" id="5997124">Palette</span><span class="op" id="5997131">[</span><span class="ident" id="5997132">d</span><span class="op" id="5997133">.</span><span class="ident" id="5997134">transparentIndex</span><span class="op" id="5997150">]</span>&nbsp;<span class="op" id="5997152">=</span>&nbsp;<span class="ident" id="5997154">color</span><span class="op" id="5997159">.</span><span class="ident" id="5997160">RGBA</span><span class="op" id="5997164">{</span><span class="op" id="5997165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997170">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997175">litWidth</span><span class="op" id="5997183">,</span>&nbsp;<span class="ident" id="5997185">err</span>&nbsp;<span class="op" id="5997189">:=</span>&nbsp;<span class="ident" id="5997192">d</span><span class="op" id="5997193">.</span><span class="ident" id="5997194">r</span><span class="op" id="5997195">.</span><span class="ident" id="5997196">ReadByte</span><span class="op" id="5997204">(</span><span class="op" id="5997205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997210">if</span>&nbsp;<span class="ident" id="5997213">err</span>&nbsp;<span class="op" id="5997217">!=</span>&nbsp;<span class="ident" id="5997220">nil</span>&nbsp;<span class="op" id="5997224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997230">return</span>&nbsp;<span class="ident" id="5997237">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997249">if</span>&nbsp;<span class="ident" id="5997252">litWidth</span>&nbsp;<span class="op" id="5997261">&lt;</span>&nbsp;<span class="num" id="5997263">2</span>&nbsp;<span class="op" id="5997265">||</span>&nbsp;<span class="ident" id="5997268">litWidth</span>&nbsp;<span class="op" id="5997277">&gt;</span>&nbsp;<span class="num" id="5997279">8</span>&nbsp;<span class="op" id="5997281">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997287">return</span>&nbsp;<span class="ident" id="5997294">fmt</span><span class="op" id="5997297">.</span><span class="ident" id="5997298">Errorf</span><span class="op" id="5997304">(</span><span class="string" id="5997305">&#34;gif:&nbsp;pixel&nbsp;size&nbsp;in&nbsp;decode&nbsp;out&nbsp;of&nbsp;range:&nbsp;%d&#34;</span><span class="op" id="5997349">,</span>&nbsp;<span class="ident" id="5997351">litWidth</span><span class="op" id="5997359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5997369">//&nbsp;A&nbsp;wonderfully&nbsp;Go-like&nbsp;piece&nbsp;of&nbsp;magic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997413">br</span>&nbsp;<span class="op" id="5997416">:=</span>&nbsp;<span class="op" id="5997419">&amp;</span><span class="ident" id="5997420">blockReader</span><span class="op" id="5997431">{</span><span class="ident" id="5997432">r</span><span class="op" id="5997433">:</span>&nbsp;<span class="ident" id="5997435">d</span><span class="op" id="5997436">.</span><span class="ident" id="5997437">r</span><span class="op" id="5997438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997443">lzwr</span>&nbsp;<span class="op" id="5997448">:=</span>&nbsp;<span class="ident" id="5997451">lzw</span><span class="op" id="5997454">.</span><span class="ident" id="5997455">NewReader</span><span class="op" id="5997464">(</span><span class="ident" id="5997465">br</span><span class="op" id="5997467">,</span>&nbsp;<span class="ident" id="5997469">lzw</span><span class="op" id="5997472">.</span><span class="ident" id="5997473">LSB</span><span class="op" id="5997476">,</span>&nbsp;<span class="builtintype" id="5997478">int</span><span class="op" id="5997481">(</span><span class="ident" id="5997482">litWidth</span><span class="op" id="5997490">)</span><span class="op" id="5997491">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997496">defer</span>&nbsp;<span class="ident" id="5997502">lzwr</span><span class="op" id="5997506">.</span><span class="ident" id="5997507">Close</span><span class="op" id="5997512">(</span><span class="op" id="5997513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997518">if</span>&nbsp;<span class="ident" id="5997521">_</span><span class="op" id="5997522">,</span>&nbsp;<span class="ident" id="5997524">err</span>&nbsp;<span class="op" id="5997528">=</span>&nbsp;<span class="ident" id="5997530">io</span><span class="op" id="5997532">.</span><span class="ident" id="5997533">ReadFull</span><span class="op" id="5997541">(</span><span class="ident" id="5997542">lzwr</span><span class="op" id="5997546">,</span>&nbsp;<span class="ident" id="5997548">m</span><span class="op" id="5997549">.</span><span class="ident" id="5997550">Pix</span><span class="op" id="5997553">)</span><span class="op" id="5997554">;</span>&nbsp;<span class="ident" id="5997556">err</span>&nbsp;<span class="op" id="5997560">!=</span>&nbsp;<span class="ident" id="5997563">nil</span>&nbsp;<span class="op" id="5997567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997573">if</span>&nbsp;<span class="ident" id="5997576">err</span>&nbsp;<span class="op" id="5997580">!=</span>&nbsp;<span class="ident" id="5997583">io</span><span class="op" id="5997585">.</span><span class="ident" id="5997586">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="5997603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997610">return</span>&nbsp;<span class="ident" id="5997617">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997625">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997631">return</span>&nbsp;<span class="ident" id="5997638">errNotEnough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5997659">//&nbsp;Both&nbsp;lzwr&nbsp;and&nbsp;br&nbsp;should&nbsp;be&nbsp;exhausted.&nbsp;Reading&nbsp;from&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5997721">//&nbsp;should&nbsp;yield&nbsp;(0,&nbsp;io.EOF).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997753">if</span>&nbsp;<span class="ident" id="5997756">n</span><span class="op" id="5997757">,</span>&nbsp;<span class="ident" id="5997759">err</span>&nbsp;<span class="op" id="5997763">:=</span>&nbsp;<span class="ident" id="5997766">lzwr</span><span class="op" id="5997770">.</span><span class="ident" id="5997771">Read</span><span class="op" id="5997775">(</span><span class="ident" id="5997776">d</span><span class="op" id="5997777">.</span><span class="ident" id="5997778">tmp</span><span class="op" id="5997781">[</span><span class="op" id="5997782">:</span><span class="num" id="5997783">1</span><span class="op" id="5997784">]</span><span class="op" id="5997785">)</span><span class="op" id="5997786">;</span>&nbsp;<span class="ident" id="5997788">n</span>&nbsp;<span class="op" id="5997790">!=</span>&nbsp;<span class="num" id="5997793">0</span>&nbsp;<span class="op" id="5997795">||</span>&nbsp;<span class="ident" id="5997798">err</span>&nbsp;<span class="op" id="5997802">!=</span>&nbsp;<span class="ident" id="5997805">io</span><span class="op" id="5997807">.</span><span class="ident" id="5997808">EOF</span>&nbsp;<span class="op" id="5997812">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997818">if</span>&nbsp;<span class="ident" id="5997821">err</span>&nbsp;<span class="op" id="5997825">!=</span>&nbsp;<span class="ident" id="5997828">nil</span>&nbsp;<span class="op" id="5997832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997839">return</span>&nbsp;<span class="ident" id="5997846">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997860">return</span>&nbsp;<span class="ident" id="5997867">errTooMuch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997881">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997886">if</span>&nbsp;<span class="ident" id="5997889">n</span><span class="op" id="5997890">,</span>&nbsp;<span class="ident" id="5997892">err</span>&nbsp;<span class="op" id="5997896">:=</span>&nbsp;<span class="ident" id="5997899">br</span><span class="op" id="5997901">.</span><span class="ident" id="5997902">Read</span><span class="op" id="5997906">(</span><span class="ident" id="5997907">d</span><span class="op" id="5997908">.</span><span class="ident" id="5997909">tmp</span><span class="op" id="5997912">[</span><span class="op" id="5997913">:</span><span class="num" id="5997914">1</span><span class="op" id="5997915">]</span><span class="op" id="5997916">)</span><span class="op" id="5997917">;</span>&nbsp;<span class="ident" id="5997919">n</span>&nbsp;<span class="op" id="5997921">!=</span>&nbsp;<span class="num" id="5997924">0</span>&nbsp;<span class="op" id="5997926">||</span>&nbsp;<span class="ident" id="5997929">err</span>&nbsp;<span class="op" id="5997933">!=</span>&nbsp;<span class="ident" id="5997936">io</span><span class="op" id="5997938">.</span><span class="ident" id="5997939">EOF</span>&nbsp;<span class="op" id="5997943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997949">if</span>&nbsp;<span class="ident" id="5997952">err</span>&nbsp;<span class="op" id="5997956">!=</span>&nbsp;<span class="ident" id="5997959">nil</span>&nbsp;<span class="op" id="5997963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997970">return</span>&nbsp;<span class="ident" id="5997977">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997991">return</span>&nbsp;<span class="ident" id="5997998">errTooMuch</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5998012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5998018">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;color&nbsp;indexes&nbsp;are&nbsp;inside&nbsp;the&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998077">if</span>&nbsp;<span class="builtinfunc" id="5998080">len</span><span class="op" id="5998083">(</span><span class="ident" id="5998084">m</span><span class="op" id="5998085">.</span><span class="ident" id="5998086">Palette</span><span class="op" id="5998093">)</span>&nbsp;<span class="op" id="5998095">&lt;</span>&nbsp;<span class="num" id="5998097">256</span>&nbsp;<span class="op" id="5998101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998107">for</span>&nbsp;<span class="ident" id="5998111">_</span><span class="op" id="5998112">,</span>&nbsp;<span class="ident" id="5998114">pixel</span>&nbsp;<span class="op" id="5998120">:=</span>&nbsp;<span class="keyword" id="5998123">range</span>&nbsp;<span class="ident" id="5998129">m</span><span class="op" id="5998130">.</span><span class="ident" id="5998131">Pix</span>&nbsp;<span class="op" id="5998135">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998142">if</span>&nbsp;<span class="builtintype" id="5998145">int</span><span class="op" id="5998148">(</span><span class="ident" id="5998149">pixel</span><span class="op" id="5998154">)</span>&nbsp;<span class="op" id="5998156">&gt;=</span>&nbsp;<span class="builtinfunc" id="5998159">len</span><span class="op" id="5998162">(</span><span class="ident" id="5998163">m</span><span class="op" id="5998164">.</span><span class="ident" id="5998165">Palette</span><span class="op" id="5998172">)</span>&nbsp;<span class="op" id="5998174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998182">return</span>&nbsp;<span class="ident" id="5998189">errBadPixel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5998206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5998212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5998217">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5998223">//&nbsp;Undo&nbsp;the&nbsp;interlacing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998264">if</span>&nbsp;<span class="ident" id="5998267">d</span><span class="op" id="5998268">.</span><span class="ident" id="5998269">imageFields</span><span class="op" id="5998280">&amp;</span><span class="ident" id="5998281">ifInterlace</span>&nbsp;<span class="op" id="5998293">!=</span>&nbsp;<span class="num" id="5998296">0</span>&nbsp;<span class="op" id="5998298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5998304">uninterlace</span><span class="op" id="5998315">(</span><span class="ident" id="5998316">m</span><span class="op" id="5998317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5998322">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5998328">d</span><span class="op" id="5998329">.</span><span class="ident" id="5998330">image</span>&nbsp;<span class="op" id="5998336">=</span>&nbsp;<span class="builtinfunc" id="5998338">append</span><span class="op" id="5998344">(</span><span class="ident" id="5998345">d</span><span class="op" id="5998346">.</span><span class="ident" id="5998347">image</span><span class="op" id="5998352">,</span>&nbsp;<span class="ident" id="5998354">m</span><span class="op" id="5998355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5998360">d</span><span class="op" id="5998361">.</span><span class="ident" id="5998362">delay</span>&nbsp;<span class="op" id="5998368">=</span>&nbsp;<span class="builtinfunc" id="5998370">append</span><span class="op" id="5998376">(</span><span class="ident" id="5998377">d</span><span class="op" id="5998378">.</span><span class="ident" id="5998379">delay</span><span class="op" id="5998384">,</span>&nbsp;<span class="ident" id="5998386">d</span><span class="op" id="5998387">.</span><span class="ident" id="5998388">delayTime</span><span class="op" id="5998397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5998402">//&nbsp;The&nbsp;GIF89a&nbsp;spec,&nbsp;Section&nbsp;23&nbsp;(Graphic&nbsp;Control&nbsp;Extension)&nbsp;says:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5998470">//&nbsp;&#34;The&nbsp;scope&nbsp;of&nbsp;this&nbsp;extension&nbsp;is&nbsp;the&nbsp;first&nbsp;graphic&nbsp;rendering&nbsp;block</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5998542">//&nbsp;to&nbsp;follow.&#34;&nbsp;We&nbsp;therefore&nbsp;reset&nbsp;the&nbsp;GCE&nbsp;fields&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5998603">d</span><span class="op" id="5998604">.</span><span class="ident" id="5998605">delayTime</span>&nbsp;<span class="op" id="5998615">=</span>&nbsp;<span class="num" id="5998617">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5998622">d</span><span class="op" id="5998623">.</span><span class="ident" id="5998624">hasTransparentIndex</span>&nbsp;<span class="op" id="5998644">=</span>&nbsp;<span class="builtintype" id="5998646">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998655">case</span>&nbsp;<span class="ident" id="5998660">sTrailer</span><span class="op" id="5998668">:</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998673">if</span>&nbsp;<span class="builtinfunc" id="5998676">len</span><span class="op" id="5998679">(</span><span class="ident" id="5998680">d</span><span class="op" id="5998681">.</span><span class="ident" id="5998682">image</span><span class="op" id="5998687">)</span>&nbsp;<span class="op" id="5998689">==</span>&nbsp;<span class="num" id="5998692">0</span>&nbsp;<span class="op" id="5998694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998700">return</span>&nbsp;<span class="ident" id="5998707">io</span><span class="op" id="5998709">.</span><span class="ident" id="5998710">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5998730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998735">return</span>&nbsp;<span class="ident" id="5998742">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998749">default</span><span class="op" id="5998756">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998761">return</span>&nbsp;<span class="ident" id="5998768">fmt</span><span class="op" id="5998771">.</span><span class="ident" id="5998772">Errorf</span><span class="op" id="5998778">(</span><span class="string" id="5998779">&#34;gif:&nbsp;unknown&nbsp;block&nbsp;type:&nbsp;0x%.2x&#34;</span><span class="op" id="5998812">,</span>&nbsp;<span class="ident" id="5998814">c</span><span class="op" id="5998815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5998819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5998822">}</span><br>
<span class="lineno"></span><span class="op" id="5998824">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="5998827">func</span>&nbsp;<span class="op" id="5998832">(</span><span class="ident" id="5998833">d</span>&nbsp;<span class="op" id="5998835">*</span><span class="ident" id="5998836">decoder</span><span class="op" id="5998843">)</span>&nbsp;<span class="ident" id="5998845">readHeaderAndScreenDescriptor</span><span class="op" id="5998874">(</span><span class="op" id="5998875">)</span>&nbsp;<span class="builtintype" id="5998877">error</span>&nbsp;<span class="op" id="5998883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5998886">_</span><span class="op" id="5998887">,</span>&nbsp;<span class="ident" id="5998889">err</span>&nbsp;<span class="op" id="5998893">:=</span>&nbsp;<span class="ident" id="5998896">io</span><span class="op" id="5998898">.</span><span class="ident" id="5998899">ReadFull</span><span class="op" id="5998907">(</span><span class="ident" id="5998908">d</span><span class="op" id="5998909">.</span><span class="ident" id="5998910">r</span><span class="op" id="5998911">,</span>&nbsp;<span class="ident" id="5998913">d</span><span class="op" id="5998914">.</span><span class="ident" id="5998915">tmp</span><span class="op" id="5998918">[</span><span class="num" id="5998919">0</span><span class="op" id="5998920">:</span><span class="num" id="5998921">13</span><span class="op" id="5998923">]</span><span class="op" id="5998924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998927">if</span>&nbsp;<span class="ident" id="5998930">err</span>&nbsp;<span class="op" id="5998934">!=</span>&nbsp;<span class="ident" id="5998937">nil</span>&nbsp;<span class="op" id="5998941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998945">return</span>&nbsp;<span class="ident" id="5998952">err</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5998957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5998960">d</span><span class="op" id="5998961">.</span><span class="ident" id="5998962">vers</span>&nbsp;<span class="op" id="5998967">=</span>&nbsp;<span class="builtintype" id="5998969">string</span><span class="op" id="5998975">(</span><span class="ident" id="5998976">d</span><span class="op" id="5998977">.</span><span class="ident" id="5998978">tmp</span><span class="op" id="5998981">[</span><span class="num" id="5998982">0</span><span class="op" id="5998983">:</span><span class="num" id="5998984">6</span><span class="op" id="5998985">]</span><span class="op" id="5998986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998989">if</span>&nbsp;<span class="ident" id="5998992">d</span><span class="op" id="5998993">.</span><span class="ident" id="5998994">vers</span>&nbsp;<span class="op" id="5998999">!=</span>&nbsp;<span class="string" id="5999002">&#34;GIF87a&#34;</span>&nbsp;<span class="op" id="5999011">&amp;&amp;</span>&nbsp;<span class="ident" id="5999014">d</span><span class="op" id="5999015">.</span><span class="ident" id="5999016">vers</span>&nbsp;<span class="op" id="5999021">!=</span>&nbsp;<span class="string" id="5999024">&#34;GIF89a&#34;</span>&nbsp;<span class="op" id="5999033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5999037">return</span>&nbsp;<span class="ident" id="5999044">fmt</span><span class="op" id="5999047">.</span><span class="ident" id="5999048">Errorf</span><span class="op" id="5999054">(</span><span class="string" id="5999055">&#34;gif:&nbsp;can&#39;t&nbsp;recognize&nbsp;format&nbsp;%s&#34;</span><span class="op" id="5999087">,</span>&nbsp;<span class="ident" id="5999089">d</span><span class="op" id="5999090">.</span><span class="ident" id="5999091">vers</span><span class="op" id="5999095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5999098">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999101">d</span><span class="op" id="5999102">.</span><span class="ident" id="5999103">width</span>&nbsp;<span class="op" id="5999109">=</span>&nbsp;<span class="builtintype" id="5999111">int</span><span class="op" id="5999114">(</span><span class="ident" id="5999115">d</span><span class="op" id="5999116">.</span><span class="ident" id="5999117">tmp</span><span class="op" id="5999120">[</span><span class="num" id="5999121">6</span><span class="op" id="5999122">]</span><span class="op" id="5999123">)</span>&nbsp;<span class="op" id="5999125">+</span>&nbsp;<span class="builtintype" id="5999127">int</span><span class="op" id="5999130">(</span><span class="ident" id="5999131">d</span><span class="op" id="5999132">.</span><span class="ident" id="5999133">tmp</span><span class="op" id="5999136">[</span><span class="num" id="5999137">7</span><span class="op" id="5999138">]</span><span class="op" id="5999139">)</span><span class="op" id="5999140">&lt;&lt;</span><span class="num" id="5999142">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999145">d</span><span class="op" id="5999146">.</span><span class="ident" id="5999147">height</span>&nbsp;<span class="op" id="5999154">=</span>&nbsp;<span class="builtintype" id="5999156">int</span><span class="op" id="5999159">(</span><span class="ident" id="5999160">d</span><span class="op" id="5999161">.</span><span class="ident" id="5999162">tmp</span><span class="op" id="5999165">[</span><span class="num" id="5999166">8</span><span class="op" id="5999167">]</span><span class="op" id="5999168">)</span>&nbsp;<span class="op" id="5999170">+</span>&nbsp;<span class="builtintype" id="5999172">int</span><span class="op" id="5999175">(</span><span class="ident" id="5999176">d</span><span class="op" id="5999177">.</span><span class="ident" id="5999178">tmp</span><span class="op" id="5999181">[</span><span class="num" id="5999182">9</span><span class="op" id="5999183">]</span><span class="op" id="5999184">)</span><span class="op" id="5999185">&lt;&lt;</span><span class="num" id="5999187">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999190">d</span><span class="op" id="5999191">.</span><span class="ident" id="5999192">headerFields</span>&nbsp;<span class="op" id="5999205">=</span>&nbsp;<span class="ident" id="5999207">d</span><span class="op" id="5999208">.</span><span class="ident" id="5999209">tmp</span><span class="op" id="5999212">[</span><span class="num" id="5999213">10</span><span class="op" id="5999215">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999218">d</span><span class="op" id="5999219">.</span><span class="ident" id="5999220">backgroundIndex</span>&nbsp;<span class="op" id="5999236">=</span>&nbsp;<span class="ident" id="5999238">d</span><span class="op" id="5999239">.</span><span class="ident" id="5999240">tmp</span><span class="op" id="5999243">[</span><span class="num" id="5999244">11</span><span class="op" id="5999246">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999249">d</span><span class="op" id="5999250">.</span><span class="ident" id="5999251">aspect</span>&nbsp;<span class="op" id="5999258">=</span>&nbsp;<span class="ident" id="5999260">d</span><span class="op" id="5999261">.</span><span class="ident" id="5999262">tmp</span><span class="op" id="5999265">[</span><span class="num" id="5999266">12</span><span class="op" id="5999268">]</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999271">d</span><span class="op" id="5999272">.</span><span class="ident" id="5999273">loopCount</span>&nbsp;<span class="op" id="5999283">=</span>&nbsp;<span class="op" id="5999285">-</span><span class="num" id="5999286">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999289">d</span><span class="op" id="5999290">.</span><span class="ident" id="5999291">pixelSize</span>&nbsp;<span class="op" id="5999301">=</span>&nbsp;<span class="builtintype" id="5999303">uint</span><span class="op" id="5999307">(</span><span class="ident" id="5999308">d</span><span class="op" id="5999309">.</span><span class="ident" id="5999310">headerFields</span><span class="op" id="5999322">&amp;</span><span class="num" id="5999323">7</span><span class="op" id="5999324">)</span>&nbsp;<span class="op" id="5999326">+</span>&nbsp;<span class="num" id="5999328">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5999331">return</span>&nbsp;<span class="ident" id="5999338">nil</span><br>
<span class="lineno"></span><span class="op" id="5999342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="5999345">func</span>&nbsp;<span class="op" id="5999350">(</span><span class="ident" id="5999351">d</span>&nbsp;<span class="op" id="5999353">*</span><span class="ident" id="5999354">decoder</span><span class="op" id="5999361">)</span>&nbsp;<span class="ident" id="5999363">readColorMap</span><span class="op" id="5999375">(</span><span class="op" id="5999376">)</span>&nbsp;<span class="op" id="5999378">(</span><span class="ident" id="5999379">color</span><span class="op" id="5999384">.</span><span class="ident" id="5999385">Palette</span><span class="op" id="5999392">,</span>&nbsp;<span class="builtintype" id="5999394">error</span><span class="op" id="5999399">)</span>&nbsp;<span class="op" id="5999401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5999404">if</span>&nbsp;<span class="ident" id="5999407">d</span><span class="op" id="5999408">.</span><span class="ident" id="5999409">pixelSize</span>&nbsp;<span class="op" id="5999419">&gt;</span>&nbsp;<span class="num" id="5999421">8</span>&nbsp;<span class="op" id="5999423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5999427">return</span>&nbsp;<span class="ident" id="5999434">nil</span><span class="op" id="5999437">,</span>&nbsp;<span class="ident" id="5999439">fmt</span><span class="op" id="5999442">.</span><span class="ident" id="5999443">Errorf</span><span class="op" id="5999449">(</span><span class="string" id="5999450">&#34;gif:&nbsp;can&#39;t&nbsp;handle&nbsp;%d&nbsp;bits&nbsp;per&nbsp;pixel&#34;</span><span class="op" id="5999487">,</span>&nbsp;<span class="ident" id="5999489">d</span><span class="op" id="5999490">.</span><span class="ident" id="5999491">pixelSize</span><span class="op" id="5999500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5999503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999506">numColors</span>&nbsp;<span class="op" id="5999516">:=</span>&nbsp;<span class="num" id="5999519">1</span>&nbsp;<span class="op" id="5999521">&lt;&lt;</span>&nbsp;<span class="ident" id="5999524">d</span><span class="op" id="5999525">.</span><span class="ident" id="5999526">pixelSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5999537">if</span>&nbsp;<span class="ident" id="5999540">d</span><span class="op" id="5999541">.</span><span class="ident" id="5999542">imageFields</span><span class="op" id="5999553">&amp;</span><span class="ident" id="5999554">ifLocalColorTable</span>&nbsp;<span class="op" id="5999572">!=</span>&nbsp;<span class="num" id="5999575">0</span>&nbsp;<span class="op" id="5999577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999581">numColors</span>&nbsp;<span class="op" id="5999591">=</span>&nbsp;<span class="num" id="5999593">1</span>&nbsp;<span class="op" id="5999595">&lt;&lt;</span>&nbsp;<span class="op" id="5999598">(</span><span class="op" id="5999599">(</span><span class="ident" id="5999600">d</span><span class="op" id="5999601">.</span><span class="ident" id="5999602">imageFields</span>&nbsp;<span class="op" id="5999614">&amp;</span>&nbsp;<span class="ident" id="5999616">ifPixelSizeMask</span><span class="op" id="5999631">)</span>&nbsp;<span class="op" id="5999633">+</span>&nbsp;<span class="num" id="5999635">1</span><span class="op" id="5999636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5999639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999642">numValues</span>&nbsp;<span class="op" id="5999652">:=</span>&nbsp;<span class="num" id="5999655">3</span>&nbsp;<span class="op" id="5999657">*</span>&nbsp;<span class="ident" id="5999659">numColors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999670">_</span><span class="op" id="5999671">,</span>&nbsp;<span class="ident" id="5999673">err</span>&nbsp;<span class="op" id="5999677">:=</span>&nbsp;<span class="ident" id="5999680">io</span><span class="op" id="5999682">.</span><span class="ident" id="5999683">ReadFull</span><span class="op" id="5999691">(</span><span class="ident" id="5999692">d</span><span class="op" id="5999693">.</span><span class="ident" id="5999694">r</span><span class="op" id="5999695">,</span>&nbsp;<span class="ident" id="5999697">d</span><span class="op" id="5999698">.</span><span class="ident" id="5999699">tmp</span><span class="op" id="5999702">[</span><span class="num" id="5999703">0</span><span class="op" id="5999704">:</span><span class="ident" id="5999705">numValues</span><span class="op" id="5999714">]</span><span class="op" id="5999715">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5999718">if</span>&nbsp;<span class="ident" id="5999721">err</span>&nbsp;<span class="op" id="5999725">!=</span>&nbsp;<span class="ident" id="5999728">nil</span>&nbsp;<span class="op" id="5999732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5999736">return</span>&nbsp;<span class="ident" id="5999743">nil</span><span class="op" id="5999746">,</span>&nbsp;<span class="ident" id="5999748">fmt</span><span class="op" id="5999751">.</span><span class="ident" id="5999752">Errorf</span><span class="op" id="5999758">(</span><span class="string" id="5999759">&#34;gif:&nbsp;short&nbsp;read&nbsp;on&nbsp;color&nbsp;map:&nbsp;%s&#34;</span><span class="op" id="5999793">,</span>&nbsp;<span class="ident" id="5999795">err</span><span class="op" id="5999798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5999801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999804">colorMap</span>&nbsp;<span class="op" id="5999813">:=</span>&nbsp;<span class="builtinfunc" id="5999816">make</span><span class="op" id="5999820">(</span><span class="ident" id="5999821">color</span><span class="op" id="5999826">.</span><span class="ident" id="5999827">Palette</span><span class="op" id="5999834">,</span>&nbsp;<span class="ident" id="5999836">numColors</span><span class="op" id="5999845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999848">j</span>&nbsp;<span class="op" id="5999850">:=</span>&nbsp;<span class="num" id="5999853">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5999856">for</span>&nbsp;<span class="ident" id="5999860">i</span>&nbsp;<span class="op" id="5999862">:=</span>&nbsp;<span class="keyword" id="5999865">range</span>&nbsp;<span class="ident" id="5999871">colorMap</span>&nbsp;<span class="op" id="5999880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999884">colorMap</span><span class="op" id="5999892">[</span><span class="ident" id="5999893">i</span><span class="op" id="5999894">]</span>&nbsp;<span class="op" id="5999896">=</span>&nbsp;<span class="ident" id="5999898">color</span><span class="op" id="5999903">.</span><span class="ident" id="5999904">RGBA</span><span class="op" id="5999908">{</span><span class="ident" id="5999909">d</span><span class="op" id="5999910">.</span><span class="ident" id="5999911">tmp</span><span class="op" id="5999914">[</span><span class="ident" id="5999915">j</span><span class="op" id="5999916">+</span><span class="num" id="5999917">0</span><span class="op" id="5999918">]</span><span class="op" id="5999919">,</span>&nbsp;<span class="ident" id="5999921">d</span><span class="op" id="5999922">.</span><span class="ident" id="5999923">tmp</span><span class="op" id="5999926">[</span><span class="ident" id="5999927">j</span><span class="op" id="5999928">+</span><span class="num" id="5999929">1</span><span class="op" id="5999930">]</span><span class="op" id="5999931">,</span>&nbsp;<span class="ident" id="5999933">d</span><span class="op" id="5999934">.</span><span class="ident" id="5999935">tmp</span><span class="op" id="5999938">[</span><span class="ident" id="5999939">j</span><span class="op" id="5999940">+</span><span class="num" id="5999941">2</span><span class="op" id="5999942">]</span><span class="op" id="5999943">,</span>&nbsp;<span class="num" id="5999945">0xFF</span><span class="op" id="5999949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999953">j</span>&nbsp;<span class="op" id="5999955">+=</span>&nbsp;<span class="num" id="5999958">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5999961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5999964">return</span>&nbsp;<span class="ident" id="5999971">colorMap</span><span class="op" id="5999979">,</span>&nbsp;<span class="ident" id="5999981">nil</span><br>
<span class="lineno">295</span><span class="op" id="5999985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5999988">func</span>&nbsp;<span class="op" id="5999993">(</span><span class="ident" id="5999994">d</span>&nbsp;<span class="op" id="5999996">*</span><span class="ident" id="5999997">decoder</span><span class="op" id="6000004">)</span>&nbsp;<span class="ident" id="6000006">readExtension</span><span class="op" id="6000019">(</span><span class="op" id="6000020">)</span>&nbsp;<span class="builtintype" id="6000022">error</span>&nbsp;<span class="op" id="6000028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000031">extension</span><span class="op" id="6000040">,</span>&nbsp;<span class="ident" id="6000042">err</span>&nbsp;<span class="op" id="6000046">:=</span>&nbsp;<span class="ident" id="6000049">d</span><span class="op" id="6000050">.</span><span class="ident" id="6000051">r</span><span class="op" id="6000052">.</span><span class="ident" id="6000053">ReadByte</span><span class="op" id="6000061">(</span><span class="op" id="6000062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000065">if</span>&nbsp;<span class="ident" id="6000068">err</span>&nbsp;<span class="op" id="6000072">!=</span>&nbsp;<span class="ident" id="6000075">nil</span>&nbsp;<span class="op" id="6000079">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000083">return</span>&nbsp;<span class="ident" id="6000090">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6000095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000098">size</span>&nbsp;<span class="op" id="6000103">:=</span>&nbsp;<span class="num" id="6000106">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000109">switch</span>&nbsp;<span class="ident" id="6000116">extension</span>&nbsp;<span class="op" id="6000126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000129">case</span>&nbsp;<span class="ident" id="6000134">eText</span><span class="op" id="6000139">:</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000143">size</span>&nbsp;<span class="op" id="6000148">=</span>&nbsp;<span class="num" id="6000150">13</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000154">case</span>&nbsp;<span class="ident" id="6000159">eGraphicControl</span><span class="op" id="6000174">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000178">return</span>&nbsp;<span class="ident" id="6000185">d</span><span class="op" id="6000186">.</span><span class="ident" id="6000187">readGraphicControl</span><span class="op" id="6000205">(</span><span class="op" id="6000206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000209">case</span>&nbsp;<span class="ident" id="6000214">eComment</span><span class="op" id="6000222">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6000226">//&nbsp;nothing&nbsp;to&nbsp;do&nbsp;but&nbsp;read&nbsp;the&nbsp;data.</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000263">case</span>&nbsp;<span class="ident" id="6000268">eApplication</span><span class="op" id="6000280">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000284">b</span><span class="op" id="6000285">,</span>&nbsp;<span class="ident" id="6000287">err</span>&nbsp;<span class="op" id="6000291">:=</span>&nbsp;<span class="ident" id="6000294">d</span><span class="op" id="6000295">.</span><span class="ident" id="6000296">r</span><span class="op" id="6000297">.</span><span class="ident" id="6000298">ReadByte</span><span class="op" id="6000306">(</span><span class="op" id="6000307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000311">if</span>&nbsp;<span class="ident" id="6000314">err</span>&nbsp;<span class="op" id="6000318">!=</span>&nbsp;<span class="ident" id="6000321">nil</span>&nbsp;<span class="op" id="6000325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000330">return</span>&nbsp;<span class="ident" id="6000337">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6000343">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6000347">//&nbsp;The&nbsp;spec&nbsp;requires&nbsp;size&nbsp;be&nbsp;11,&nbsp;but&nbsp;Adobe&nbsp;sometimes&nbsp;uses&nbsp;10.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000411">size</span>&nbsp;<span class="op" id="6000416">=</span>&nbsp;<span class="builtintype" id="6000418">int</span><span class="op" id="6000421">(</span><span class="ident" id="6000422">b</span><span class="op" id="6000423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000426">default</span><span class="op" id="6000433">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000437">return</span>&nbsp;<span class="ident" id="6000444">fmt</span><span class="op" id="6000447">.</span><span class="ident" id="6000448">Errorf</span><span class="op" id="6000454">(</span><span class="string" id="6000455">&#34;gif:&nbsp;unknown&nbsp;extension&nbsp;0x%.2x&#34;</span><span class="op" id="6000486">,</span>&nbsp;<span class="ident" id="6000488">extension</span><span class="op" id="6000497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6000500">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000503">if</span>&nbsp;<span class="ident" id="6000506">size</span>&nbsp;<span class="op" id="6000511">&gt;</span>&nbsp;<span class="num" id="6000513">0</span>&nbsp;<span class="op" id="6000515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000519">if</span>&nbsp;<span class="ident" id="6000522">_</span><span class="op" id="6000523">,</span>&nbsp;<span class="ident" id="6000525">err</span>&nbsp;<span class="op" id="6000529">:=</span>&nbsp;<span class="ident" id="6000532">io</span><span class="op" id="6000534">.</span><span class="ident" id="6000535">ReadFull</span><span class="op" id="6000543">(</span><span class="ident" id="6000544">d</span><span class="op" id="6000545">.</span><span class="ident" id="6000546">r</span><span class="op" id="6000547">,</span>&nbsp;<span class="ident" id="6000549">d</span><span class="op" id="6000550">.</span><span class="ident" id="6000551">tmp</span><span class="op" id="6000554">[</span><span class="num" id="6000555">0</span><span class="op" id="6000556">:</span><span class="ident" id="6000557">size</span><span class="op" id="6000561">]</span><span class="op" id="6000562">)</span><span class="op" id="6000563">;</span>&nbsp;<span class="ident" id="6000565">err</span>&nbsp;<span class="op" id="6000569">!=</span>&nbsp;<span class="ident" id="6000572">nil</span>&nbsp;<span class="op" id="6000576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000581">return</span>&nbsp;<span class="ident" id="6000588">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6000594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6000597">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6000601">//&nbsp;Application&nbsp;Extension&nbsp;with&nbsp;&#34;NETSCAPE2.0&#34;&nbsp;as&nbsp;string&nbsp;and&nbsp;1&nbsp;in&nbsp;data&nbsp;means</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6000676">//&nbsp;this&nbsp;extension&nbsp;defines&nbsp;a&nbsp;loop&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000717">if</span>&nbsp;<span class="ident" id="6000720">extension</span>&nbsp;<span class="op" id="6000730">==</span>&nbsp;<span class="ident" id="6000733">eApplication</span>&nbsp;<span class="op" id="6000746">&amp;&amp;</span>&nbsp;<span class="builtintype" id="6000749">string</span><span class="op" id="6000755">(</span><span class="ident" id="6000756">d</span><span class="op" id="6000757">.</span><span class="ident" id="6000758">tmp</span><span class="op" id="6000761">[</span><span class="op" id="6000762">:</span><span class="ident" id="6000763">size</span><span class="op" id="6000767">]</span><span class="op" id="6000768">)</span>&nbsp;<span class="op" id="6000770">==</span>&nbsp;<span class="string" id="6000773">&#34;NETSCAPE2.0&#34;</span>&nbsp;<span class="op" id="6000787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000791">n</span><span class="op" id="6000792">,</span>&nbsp;<span class="ident" id="6000794">err</span>&nbsp;<span class="op" id="6000798">:=</span>&nbsp;<span class="ident" id="6000801">d</span><span class="op" id="6000802">.</span><span class="ident" id="6000803">readBlock</span><span class="op" id="6000812">(</span><span class="op" id="6000813">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000817">if</span>&nbsp;<span class="ident" id="6000820">n</span>&nbsp;<span class="op" id="6000822">==</span>&nbsp;<span class="num" id="6000825">0</span>&nbsp;<span class="op" id="6000827">||</span>&nbsp;<span class="ident" id="6000830">err</span>&nbsp;<span class="op" id="6000834">!=</span>&nbsp;<span class="ident" id="6000837">nil</span>&nbsp;<span class="op" id="6000841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000846">return</span>&nbsp;<span class="ident" id="6000853">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6000859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000863">if</span>&nbsp;<span class="ident" id="6000866">n</span>&nbsp;<span class="op" id="6000868">==</span>&nbsp;<span class="num" id="6000871">3</span>&nbsp;<span class="op" id="6000873">&amp;&amp;</span>&nbsp;<span class="ident" id="6000876">d</span><span class="op" id="6000877">.</span><span class="ident" id="6000878">tmp</span><span class="op" id="6000881">[</span><span class="num" id="6000882">0</span><span class="op" id="6000883">]</span>&nbsp;<span class="op" id="6000885">==</span>&nbsp;<span class="num" id="6000888">1</span>&nbsp;<span class="op" id="6000890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000895">d</span><span class="op" id="6000896">.</span><span class="ident" id="6000897">loopCount</span>&nbsp;<span class="op" id="6000907">=</span>&nbsp;<span class="builtintype" id="6000909">int</span><span class="op" id="6000912">(</span><span class="ident" id="6000913">d</span><span class="op" id="6000914">.</span><span class="ident" id="6000915">tmp</span><span class="op" id="6000918">[</span><span class="num" id="6000919">1</span><span class="op" id="6000920">]</span><span class="op" id="6000921">)</span>&nbsp;<span class="op" id="6000923">|</span>&nbsp;<span class="builtintype" id="6000925">int</span><span class="op" id="6000928">(</span><span class="ident" id="6000929">d</span><span class="op" id="6000930">.</span><span class="ident" id="6000931">tmp</span><span class="op" id="6000934">[</span><span class="num" id="6000935">2</span><span class="op" id="6000936">]</span><span class="op" id="6000937">)</span><span class="op" id="6000938">&lt;&lt;</span><span class="num" id="6000940">8</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6000944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6000947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000950">for</span>&nbsp;<span class="op" id="6000954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000958">n</span><span class="op" id="6000959">,</span>&nbsp;<span class="ident" id="6000961">err</span>&nbsp;<span class="op" id="6000965">:=</span>&nbsp;<span class="ident" id="6000968">d</span><span class="op" id="6000969">.</span><span class="ident" id="6000970">readBlock</span><span class="op" id="6000979">(</span><span class="op" id="6000980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000984">if</span>&nbsp;<span class="ident" id="6000987">n</span>&nbsp;<span class="op" id="6000989">==</span>&nbsp;<span class="num" id="6000992">0</span>&nbsp;<span class="op" id="6000994">||</span>&nbsp;<span class="ident" id="6000997">err</span>&nbsp;<span class="op" id="6001001">!=</span>&nbsp;<span class="ident" id="6001004">nil</span>&nbsp;<span class="op" id="6001008">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6001013">return</span>&nbsp;<span class="ident" id="6001020">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6001026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6001029">}</span><br>
<span class="lineno"></span><span class="op" id="6001031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span><span class="keyword" id="6001034">func</span>&nbsp;<span class="op" id="6001039">(</span><span class="ident" id="6001040">d</span>&nbsp;<span class="op" id="6001042">*</span><span class="ident" id="6001043">decoder</span><span class="op" id="6001050">)</span>&nbsp;<span class="ident" id="6001052">readGraphicControl</span><span class="op" id="6001070">(</span><span class="op" id="6001071">)</span>&nbsp;<span class="builtintype" id="6001073">error</span>&nbsp;<span class="op" id="6001079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6001082">if</span>&nbsp;<span class="ident" id="6001085">_</span><span class="op" id="6001086">,</span>&nbsp;<span class="ident" id="6001088">err</span>&nbsp;<span class="op" id="6001092">:=</span>&nbsp;<span class="ident" id="6001095">io</span><span class="op" id="6001097">.</span><span class="ident" id="6001098">ReadFull</span><span class="op" id="6001106">(</span><span class="ident" id="6001107">d</span><span class="op" id="6001108">.</span><span class="ident" id="6001109">r</span><span class="op" id="6001110">,</span>&nbsp;<span class="ident" id="6001112">d</span><span class="op" id="6001113">.</span><span class="ident" id="6001114">tmp</span><span class="op" id="6001117">[</span><span class="num" id="6001118">0</span><span class="op" id="6001119">:</span><span class="num" id="6001120">6</span><span class="op" id="6001121">]</span><span class="op" id="6001122">)</span><span class="op" id="6001123">;</span>&nbsp;<span class="ident" id="6001125">err</span>&nbsp;<span class="op" id="6001129">!=</span>&nbsp;<span class="ident" id="6001132">nil</span>&nbsp;<span class="op" id="6001136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6001140">return</span>&nbsp;<span class="ident" id="6001147">fmt</span><span class="op" id="6001150">.</span><span class="ident" id="6001151">Errorf</span><span class="op" id="6001157">(</span><span class="string" id="6001158">&#34;gif:&nbsp;can&#39;t&nbsp;read&nbsp;graphic&nbsp;control:&nbsp;%s&#34;</span><span class="op" id="6001195">,</span>&nbsp;<span class="ident" id="6001197">err</span><span class="op" id="6001200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6001203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001206">d</span><span class="op" id="6001207">.</span><span class="ident" id="6001208">flags</span>&nbsp;<span class="op" id="6001214">=</span>&nbsp;<span class="ident" id="6001216">d</span><span class="op" id="6001217">.</span><span class="ident" id="6001218">tmp</span><span class="op" id="6001221">[</span><span class="num" id="6001222">1</span><span class="op" id="6001223">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001226">d</span><span class="op" id="6001227">.</span><span class="ident" id="6001228">delayTime</span>&nbsp;<span class="op" id="6001238">=</span>&nbsp;<span class="builtintype" id="6001240">int</span><span class="op" id="6001243">(</span><span class="ident" id="6001244">d</span><span class="op" id="6001245">.</span><span class="ident" id="6001246">tmp</span><span class="op" id="6001249">[</span><span class="num" id="6001250">2</span><span class="op" id="6001251">]</span><span class="op" id="6001252">)</span>&nbsp;<span class="op" id="6001254">|</span>&nbsp;<span class="builtintype" id="6001256">int</span><span class="op" id="6001259">(</span><span class="ident" id="6001260">d</span><span class="op" id="6001261">.</span><span class="ident" id="6001262">tmp</span><span class="op" id="6001265">[</span><span class="num" id="6001266">3</span><span class="op" id="6001267">]</span><span class="op" id="6001268">)</span><span class="op" id="6001269">&lt;&lt;</span><span class="num" id="6001271">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6001274">if</span>&nbsp;<span class="ident" id="6001277">d</span><span class="op" id="6001278">.</span><span class="ident" id="6001279">flags</span><span class="op" id="6001284">&amp;</span><span class="ident" id="6001285">gcTransparentColorSet</span>&nbsp;<span class="op" id="6001307">!=</span>&nbsp;<span class="num" id="6001310">0</span>&nbsp;<span class="op" id="6001312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001316">d</span><span class="op" id="6001317">.</span><span class="ident" id="6001318">transparentIndex</span>&nbsp;<span class="op" id="6001335">=</span>&nbsp;<span class="ident" id="6001337">d</span><span class="op" id="6001338">.</span><span class="ident" id="6001339">tmp</span><span class="op" id="6001342">[</span><span class="num" id="6001343">4</span><span class="op" id="6001344">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001348">d</span><span class="op" id="6001349">.</span><span class="ident" id="6001350">hasTransparentIndex</span>&nbsp;<span class="op" id="6001370">=</span>&nbsp;<span class="builtintype" id="6001372">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6001378">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6001381">return</span>&nbsp;<span class="ident" id="6001388">nil</span><br>
<span class="lineno"></span><span class="op" id="6001392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6001395">func</span>&nbsp;<span class="op" id="6001400">(</span><span class="ident" id="6001401">d</span>&nbsp;<span class="op" id="6001403">*</span><span class="ident" id="6001404">decoder</span><span class="op" id="6001411">)</span>&nbsp;<span class="ident" id="6001413">newImageFromDescriptor</span><span class="op" id="6001435">(</span><span class="op" id="6001436">)</span>&nbsp;<span class="op" id="6001438">(</span><span class="op" id="6001439">*</span><span class="ident" id="6001440">image</span><span class="op" id="6001445">.</span><span class="ident" id="6001446">Paletted</span><span class="op" id="6001454">,</span>&nbsp;<span class="builtintype" id="6001456">error</span><span class="op" id="6001461">)</span>&nbsp;<span class="op" id="6001463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6001466">if</span>&nbsp;<span class="ident" id="6001469">_</span><span class="op" id="6001470">,</span>&nbsp;<span class="ident" id="6001472">err</span>&nbsp;<span class="op" id="6001476">:=</span>&nbsp;<span class="ident" id="6001479">io</span><span class="op" id="6001481">.</span><span class="ident" id="6001482">ReadFull</span><span class="op" id="6001490">(</span><span class="ident" id="6001491">d</span><span class="op" id="6001492">.</span><span class="ident" id="6001493">r</span><span class="op" id="6001494">,</span>&nbsp;<span class="ident" id="6001496">d</span><span class="op" id="6001497">.</span><span class="ident" id="6001498">tmp</span><span class="op" id="6001501">[</span><span class="num" id="6001502">0</span><span class="op" id="6001503">:</span><span class="num" id="6001504">9</span><span class="op" id="6001505">]</span><span class="op" id="6001506">)</span><span class="op" id="6001507">;</span>&nbsp;<span class="ident" id="6001509">err</span>&nbsp;<span class="op" id="6001513">!=</span>&nbsp;<span class="ident" id="6001516">nil</span>&nbsp;<span class="op" id="6001520">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6001524">return</span>&nbsp;<span class="ident" id="6001531">nil</span><span class="op" id="6001534">,</span>&nbsp;<span class="ident" id="6001536">fmt</span><span class="op" id="6001539">.</span><span class="ident" id="6001540">Errorf</span><span class="op" id="6001546">(</span><span class="string" id="6001547">&#34;gif:&nbsp;can&#39;t&nbsp;read&nbsp;image&nbsp;descriptor:&nbsp;%s&#34;</span><span class="op" id="6001585">,</span>&nbsp;<span class="ident" id="6001587">err</span><span class="op" id="6001590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6001593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001596">left</span>&nbsp;<span class="op" id="6001601">:=</span>&nbsp;<span class="builtintype" id="6001604">int</span><span class="op" id="6001607">(</span><span class="ident" id="6001608">d</span><span class="op" id="6001609">.</span><span class="ident" id="6001610">tmp</span><span class="op" id="6001613">[</span><span class="num" id="6001614">0</span><span class="op" id="6001615">]</span><span class="op" id="6001616">)</span>&nbsp;<span class="op" id="6001618">+</span>&nbsp;<span class="builtintype" id="6001620">int</span><span class="op" id="6001623">(</span><span class="ident" id="6001624">d</span><span class="op" id="6001625">.</span><span class="ident" id="6001626">tmp</span><span class="op" id="6001629">[</span><span class="num" id="6001630">1</span><span class="op" id="6001631">]</span><span class="op" id="6001632">)</span><span class="op" id="6001633">&lt;&lt;</span><span class="num" id="6001635">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001638">top</span>&nbsp;<span class="op" id="6001642">:=</span>&nbsp;<span class="builtintype" id="6001645">int</span><span class="op" id="6001648">(</span><span class="ident" id="6001649">d</span><span class="op" id="6001650">.</span><span class="ident" id="6001651">tmp</span><span class="op" id="6001654">[</span><span class="num" id="6001655">2</span><span class="op" id="6001656">]</span><span class="op" id="6001657">)</span>&nbsp;<span class="op" id="6001659">+</span>&nbsp;<span class="builtintype" id="6001661">int</span><span class="op" id="6001664">(</span><span class="ident" id="6001665">d</span><span class="op" id="6001666">.</span><span class="ident" id="6001667">tmp</span><span class="op" id="6001670">[</span><span class="num" id="6001671">3</span><span class="op" id="6001672">]</span><span class="op" id="6001673">)</span><span class="op" id="6001674">&lt;&lt;</span><span class="num" id="6001676">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001679">width</span>&nbsp;<span class="op" id="6001685">:=</span>&nbsp;<span class="builtintype" id="6001688">int</span><span class="op" id="6001691">(</span><span class="ident" id="6001692">d</span><span class="op" id="6001693">.</span><span class="ident" id="6001694">tmp</span><span class="op" id="6001697">[</span><span class="num" id="6001698">4</span><span class="op" id="6001699">]</span><span class="op" id="6001700">)</span>&nbsp;<span class="op" id="6001702">+</span>&nbsp;<span class="builtintype" id="6001704">int</span><span class="op" id="6001707">(</span><span class="ident" id="6001708">d</span><span class="op" id="6001709">.</span><span class="ident" id="6001710">tmp</span><span class="op" id="6001713">[</span><span class="num" id="6001714">5</span><span class="op" id="6001715">]</span><span class="op" id="6001716">)</span><span class="op" id="6001717">&lt;&lt;</span><span class="num" id="6001719">8</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001722">height</span>&nbsp;<span class="op" id="6001729">:=</span>&nbsp;<span class="builtintype" id="6001732">int</span><span class="op" id="6001735">(</span><span class="ident" id="6001736">d</span><span class="op" id="6001737">.</span><span class="ident" id="6001738">tmp</span><span class="op" id="6001741">[</span><span class="num" id="6001742">6</span><span class="op" id="6001743">]</span><span class="op" id="6001744">)</span>&nbsp;<span class="op" id="6001746">+</span>&nbsp;<span class="builtintype" id="6001748">int</span><span class="op" id="6001751">(</span><span class="ident" id="6001752">d</span><span class="op" id="6001753">.</span><span class="ident" id="6001754">tmp</span><span class="op" id="6001757">[</span><span class="num" id="6001758">7</span><span class="op" id="6001759">]</span><span class="op" id="6001760">)</span><span class="op" id="6001761">&lt;&lt;</span><span class="num" id="6001763">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001766">d</span><span class="op" id="6001767">.</span><span class="ident" id="6001768">imageFields</span>&nbsp;<span class="op" id="6001780">=</span>&nbsp;<span class="ident" id="6001782">d</span><span class="op" id="6001783">.</span><span class="ident" id="6001784">tmp</span><span class="op" id="6001787">[</span><span class="num" id="6001788">8</span><span class="op" id="6001789">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6001793">//&nbsp;The&nbsp;GIF89a&nbsp;spec,&nbsp;Section&nbsp;20&nbsp;(Image&nbsp;Descriptor)&nbsp;says:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6001850">//&nbsp;&#34;Each&nbsp;image&nbsp;must&nbsp;fit&nbsp;within&nbsp;the&nbsp;boundaries&nbsp;of&nbsp;the&nbsp;Logical</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6001912">//&nbsp;Screen,&nbsp;as&nbsp;defined&nbsp;in&nbsp;the&nbsp;Logical&nbsp;Screen&nbsp;Descriptor.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001970">bounds</span>&nbsp;<span class="op" id="6001977">:=</span>&nbsp;<span class="ident" id="6001980">image</span><span class="op" id="6001985">.</span><span class="ident" id="6001986">Rect</span><span class="op" id="6001990">(</span><span class="ident" id="6001991">left</span><span class="op" id="6001995">,</span>&nbsp;<span class="ident" id="6001997">top</span><span class="op" id="6002000">,</span>&nbsp;<span class="ident" id="6002002">left</span><span class="op" id="6002006">+</span><span class="ident" id="6002007">width</span><span class="op" id="6002012">,</span>&nbsp;<span class="ident" id="6002014">top</span><span class="op" id="6002017">+</span><span class="ident" id="6002018">height</span><span class="op" id="6002024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6002027">if</span>&nbsp;<span class="ident" id="6002030">bounds</span>&nbsp;<span class="op" id="6002037">!=</span>&nbsp;<span class="ident" id="6002040">bounds</span><span class="op" id="6002046">.</span><span class="ident" id="6002047">Intersect</span><span class="op" id="6002056">(</span><span class="ident" id="6002057">image</span><span class="op" id="6002062">.</span><span class="ident" id="6002063">Rect</span><span class="op" id="6002067">(</span><span class="num" id="6002068">0</span><span class="op" id="6002069">,</span>&nbsp;<span class="num" id="6002071">0</span><span class="op" id="6002072">,</span>&nbsp;<span class="ident" id="6002074">d</span><span class="op" id="6002075">.</span><span class="ident" id="6002076">width</span><span class="op" id="6002081">,</span>&nbsp;<span class="ident" id="6002083">d</span><span class="op" id="6002084">.</span><span class="ident" id="6002085">height</span><span class="op" id="6002091">)</span><span class="op" id="6002092">)</span>&nbsp;<span class="op" id="6002094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6002098">return</span>&nbsp;<span class="ident" id="6002105">nil</span><span class="op" id="6002108">,</span>&nbsp;<span class="ident" id="6002110">errors</span><span class="op" id="6002116">.</span><span class="ident" id="6002117">New</span><span class="op" id="6002120">(</span><span class="string" id="6002121">&#34;gif:&nbsp;frame&nbsp;bounds&nbsp;larger&nbsp;than&nbsp;image&nbsp;bounds&#34;</span><span class="op" id="6002165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6002168">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6002171">return</span>&nbsp;<span class="ident" id="6002178">image</span><span class="op" id="6002183">.</span><span class="ident" id="6002184">NewPaletted</span><span class="op" id="6002195">(</span><span class="ident" id="6002196">bounds</span><span class="op" id="6002202">,</span>&nbsp;<span class="ident" id="6002204">nil</span><span class="op" id="6002207">)</span><span class="op" id="6002208">,</span>&nbsp;<span class="ident" id="6002210">nil</span><br>
<span class="lineno"></span><span class="op" id="6002214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6002217">func</span>&nbsp;<span class="op" id="6002222">(</span><span class="ident" id="6002223">d</span>&nbsp;<span class="op" id="6002225">*</span><span class="ident" id="6002226">decoder</span><span class="op" id="6002233">)</span>&nbsp;<span class="ident" id="6002235">readBlock</span><span class="op" id="6002244">(</span><span class="op" id="6002245">)</span>&nbsp;<span class="op" id="6002247">(</span><span class="builtintype" id="6002248">int</span><span class="op" id="6002251">,</span>&nbsp;<span class="builtintype" id="6002253">error</span><span class="op" id="6002258">)</span>&nbsp;<span class="op" id="6002260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6002263">n</span><span class="op" id="6002264">,</span>&nbsp;<span class="ident" id="6002266">err</span>&nbsp;<span class="op" id="6002270">:=</span>&nbsp;<span class="ident" id="6002273">d</span><span class="op" id="6002274">.</span><span class="ident" id="6002275">r</span><span class="op" id="6002276">.</span><span class="ident" id="6002277">ReadByte</span><span class="op" id="6002285">(</span><span class="op" id="6002286">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6002289">if</span>&nbsp;<span class="ident" id="6002292">n</span>&nbsp;<span class="op" id="6002294">==</span>&nbsp;<span class="num" id="6002297">0</span>&nbsp;<span class="op" id="6002299">||</span>&nbsp;<span class="ident" id="6002302">err</span>&nbsp;<span class="op" id="6002306">!=</span>&nbsp;<span class="ident" id="6002309">nil</span>&nbsp;<span class="op" id="6002313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6002317">return</span>&nbsp;<span class="num" id="6002324">0</span><span class="op" id="6002325">,</span>&nbsp;<span class="ident" id="6002327">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6002332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6002335">return</span>&nbsp;<span class="ident" id="6002342">io</span><span class="op" id="6002344">.</span><span class="ident" id="6002345">ReadFull</span><span class="op" id="6002353">(</span><span class="ident" id="6002354">d</span><span class="op" id="6002355">.</span><span class="ident" id="6002356">r</span><span class="op" id="6002357">,</span>&nbsp;<span class="ident" id="6002359">d</span><span class="op" id="6002360">.</span><span class="ident" id="6002361">tmp</span><span class="op" id="6002364">[</span><span class="num" id="6002365">0</span><span class="op" id="6002366">:</span><span class="ident" id="6002367">n</span><span class="op" id="6002368">]</span><span class="op" id="6002369">)</span><br>
<span class="lineno"></span><span class="op" id="6002371">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span><span class="comment" id="6002374">//&nbsp;interlaceScan&nbsp;defines&nbsp;the&nbsp;ordering&nbsp;for&nbsp;a&nbsp;pass&nbsp;of&nbsp;the&nbsp;interlace&nbsp;algorithm.</span><br>
<span class="lineno"></span><span class="keyword" id="6002451">type</span>&nbsp;<span class="ident" id="6002456">interlaceScan</span>&nbsp;<span class="keyword" id="6002470">struct</span>&nbsp;<span class="op" id="6002477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6002480">skip</span><span class="op" id="6002484">,</span>&nbsp;<span class="ident" id="6002486">start</span>&nbsp;<span class="builtintype" id="6002492">int</span><br>
<span class="lineno"></span><span class="op" id="6002496">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span><span class="comment" id="6002499">//&nbsp;interlacing&nbsp;represents&nbsp;the&nbsp;set&nbsp;of&nbsp;scans&nbsp;in&nbsp;an&nbsp;interlaced&nbsp;GIF&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="6002570">var</span>&nbsp;<span class="ident" id="6002574">interlacing</span>&nbsp;<span class="op" id="6002586">=</span>&nbsp;<span class="op" id="6002588">[</span><span class="op" id="6002589">]</span><span class="ident" id="6002590">interlaceScan</span><span class="op" id="6002603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6002606">{</span><span class="num" id="6002607">8</span><span class="op" id="6002608">,</span>&nbsp;<span class="num" id="6002610">0</span><span class="op" id="6002611">}</span><span class="op" id="6002612">,</span>&nbsp;<span class="comment" id="6002614">//&nbsp;Group&nbsp;1&nbsp;:&nbsp;Every&nbsp;8th.&nbsp;row,&nbsp;starting&nbsp;with&nbsp;row&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6002665">{</span><span class="num" id="6002666">8</span><span class="op" id="6002667">,</span>&nbsp;<span class="num" id="6002669">4</span><span class="op" id="6002670">}</span><span class="op" id="6002671">,</span>&nbsp;<span class="comment" id="6002673">//&nbsp;Group&nbsp;2&nbsp;:&nbsp;Every&nbsp;8th.&nbsp;row,&nbsp;starting&nbsp;with&nbsp;row&nbsp;4.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6002724">{</span><span class="num" id="6002725">4</span><span class="op" id="6002726">,</span>&nbsp;<span class="num" id="6002728">2</span><span class="op" id="6002729">}</span><span class="op" id="6002730">,</span>&nbsp;<span class="comment" id="6002732">//&nbsp;Group&nbsp;3&nbsp;:&nbsp;Every&nbsp;4th.&nbsp;row,&nbsp;starting&nbsp;with&nbsp;row&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6002783">{</span><span class="num" id="6002784">2</span><span class="op" id="6002785">,</span>&nbsp;<span class="num" id="6002787">1</span><span class="op" id="6002788">}</span><span class="op" id="6002789">,</span>&nbsp;<span class="comment" id="6002791">//&nbsp;Group&nbsp;4&nbsp;:&nbsp;Every&nbsp;2nd.&nbsp;row,&nbsp;starting&nbsp;with&nbsp;row&nbsp;1.</span><br>
<span class="lineno"></span><span class="op" id="6002841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6002844">//&nbsp;uninterlace&nbsp;rearranges&nbsp;the&nbsp;pixels&nbsp;in&nbsp;m&nbsp;to&nbsp;account&nbsp;for&nbsp;interlaced&nbsp;input.</span><br>
<span class="lineno">400</span><span class="keyword" id="6002919">func</span>&nbsp;<span class="ident" id="6002924">uninterlace</span><span class="op" id="6002935">(</span><span class="ident" id="6002936">m</span>&nbsp;<span class="op" id="6002938">*</span><span class="ident" id="6002939">image</span><span class="op" id="6002944">.</span><span class="ident" id="6002945">Paletted</span><span class="op" id="6002953">)</span>&nbsp;<span class="op" id="6002955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6002958">var</span>&nbsp;<span class="ident" id="6002962">nPix</span>&nbsp;<span class="op" id="6002967">[</span><span class="op" id="6002968">]</span><span class="builtintype" id="6002969">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6002976">dx</span>&nbsp;<span class="op" id="6002979">:=</span>&nbsp;<span class="ident" id="6002982">m</span><span class="op" id="6002983">.</span><span class="ident" id="6002984">Bounds</span><span class="op" id="6002990">(</span><span class="op" id="6002991">)</span><span class="op" id="6002992">.</span><span class="ident" id="6002993">Dx</span><span class="op" id="6002995">(</span><span class="op" id="6002996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6002999">dy</span>&nbsp;<span class="op" id="6003002">:=</span>&nbsp;<span class="ident" id="6003005">m</span><span class="op" id="6003006">.</span><span class="ident" id="6003007">Bounds</span><span class="op" id="6003013">(</span><span class="op" id="6003014">)</span><span class="op" id="6003015">.</span><span class="ident" id="6003016">Dy</span><span class="op" id="6003018">(</span><span class="op" id="6003019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6003022">nPix</span>&nbsp;<span class="op" id="6003027">=</span>&nbsp;<span class="builtinfunc" id="6003029">make</span><span class="op" id="6003033">(</span><span class="op" id="6003034">[</span><span class="op" id="6003035">]</span><span class="builtintype" id="6003036">uint8</span><span class="op" id="6003041">,</span>&nbsp;<span class="ident" id="6003043">dx</span><span class="op" id="6003045">*</span><span class="ident" id="6003046">dy</span><span class="op" id="6003048">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6003051">offset</span>&nbsp;<span class="op" id="6003058">:=</span>&nbsp;<span class="num" id="6003061">0</span>&nbsp;<span class="comment" id="6003063">//&nbsp;steps&nbsp;through&nbsp;the&nbsp;input&nbsp;by&nbsp;sequential&nbsp;scan&nbsp;lines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6003117">for</span>&nbsp;<span class="ident" id="6003121">_</span><span class="op" id="6003122">,</span>&nbsp;<span class="ident" id="6003124">pass</span>&nbsp;<span class="op" id="6003129">:=</span>&nbsp;<span class="keyword" id="6003132">range</span>&nbsp;<span class="ident" id="6003138">interlacing</span>&nbsp;<span class="op" id="6003150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6003154">nOffset</span>&nbsp;<span class="op" id="6003162">:=</span>&nbsp;<span class="ident" id="6003165">pass</span><span class="op" id="6003169">.</span><span class="ident" id="6003170">start</span>&nbsp;<span class="op" id="6003176">*</span>&nbsp;<span class="ident" id="6003178">dx</span>&nbsp;<span class="comment" id="6003181">//&nbsp;steps&nbsp;through&nbsp;the&nbsp;output&nbsp;as&nbsp;defined&nbsp;by&nbsp;pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6003231">for</span>&nbsp;<span class="ident" id="6003235">y</span>&nbsp;<span class="op" id="6003237">:=</span>&nbsp;<span class="ident" id="6003240">pass</span><span class="op" id="6003244">.</span><span class="ident" id="6003245">start</span><span class="op" id="6003250">;</span>&nbsp;<span class="ident" id="6003252">y</span>&nbsp;<span class="op" id="6003254">&lt;</span>&nbsp;<span class="ident" id="6003256">dy</span><span class="op" id="6003258">;</span>&nbsp;<span class="ident" id="6003260">y</span>&nbsp;<span class="op" id="6003262">+=</span>&nbsp;<span class="ident" id="6003265">pass</span><span class="op" id="6003269">.</span><span class="ident" id="6003270">skip</span>&nbsp;<span class="op" id="6003275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6003280">copy</span><span class="op" id="6003284">(</span><span class="ident" id="6003285">nPix</span><span class="op" id="6003289">[</span><span class="ident" id="6003290">nOffset</span><span class="op" id="6003297">:</span><span class="ident" id="6003298">nOffset</span><span class="op" id="6003305">+</span><span class="ident" id="6003306">dx</span><span class="op" id="6003308">]</span><span class="op" id="6003309">,</span>&nbsp;<span class="ident" id="6003311">m</span><span class="op" id="6003312">.</span><span class="ident" id="6003313">Pix</span><span class="op" id="6003316">[</span><span class="ident" id="6003317">offset</span><span class="op" id="6003323">:</span><span class="ident" id="6003324">offset</span><span class="op" id="6003330">+</span><span class="ident" id="6003331">dx</span><span class="op" id="6003333">]</span><span class="op" id="6003334">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6003339">offset</span>&nbsp;<span class="op" id="6003346">+=</span>&nbsp;<span class="ident" id="6003349">dx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6003355">nOffset</span>&nbsp;<span class="op" id="6003363">+=</span>&nbsp;<span class="ident" id="6003366">dx</span>&nbsp;<span class="op" id="6003369">*</span>&nbsp;<span class="ident" id="6003371">pass</span><span class="op" id="6003375">.</span><span class="ident" id="6003376">skip</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6003383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6003386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6003389">m</span><span class="op" id="6003390">.</span><span class="ident" id="6003391">Pix</span>&nbsp;<span class="op" id="6003395">=</span>&nbsp;<span class="ident" id="6003397">nPix</span><br>
<span class="lineno">415</span><span class="op" id="6003402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6003405">//&nbsp;Decode&nbsp;reads&nbsp;a&nbsp;GIF&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;the&nbsp;first&nbsp;embedded</span><br>
<span class="lineno"></span><span class="comment" id="6003471">//&nbsp;image&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="6003499">func</span>&nbsp;<span class="ident" id="6003504">Decode</span><span class="op" id="6003510">(</span><span class="ident" id="6003511">r</span>&nbsp;<span class="ident" id="6003513">io</span><span class="op" id="6003515">.</span><span class="ident" id="6003516">Reader</span><span class="op" id="6003522">)</span>&nbsp;<span class="op" id="6003524">(</span><span class="ident" id="6003525">image</span><span class="op" id="6003530">.</span><span class="ident" id="6003531">Image</span><span class="op" id="6003536">,</span>&nbsp;<span class="builtintype" id="6003538">error</span><span class="op" id="6003543">)</span>&nbsp;<span class="op" id="6003545">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6003548">var</span>&nbsp;<span class="ident" id="6003552">d</span>&nbsp;<span class="ident" id="6003554">decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6003563">if</span>&nbsp;<span class="ident" id="6003566">err</span>&nbsp;<span class="op" id="6003570">:=</span>&nbsp;<span class="ident" id="6003573">d</span><span class="op" id="6003574">.</span><span class="ident" id="6003575">decode</span><span class="op" id="6003581">(</span><span class="ident" id="6003582">r</span><span class="op" id="6003583">,</span>&nbsp;<span class="builtintype" id="6003585">false</span><span class="op" id="6003590">)</span><span class="op" id="6003591">;</span>&nbsp;<span class="ident" id="6003593">err</span>&nbsp;<span class="op" id="6003597">!=</span>&nbsp;<span class="ident" id="6003600">nil</span>&nbsp;<span class="op" id="6003604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6003608">return</span>&nbsp;<span class="ident" id="6003615">nil</span><span class="op" id="6003618">,</span>&nbsp;<span class="ident" id="6003620">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6003625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6003628">return</span>&nbsp;<span class="ident" id="6003635">d</span><span class="op" id="6003636">.</span><span class="ident" id="6003637">image</span><span class="op" id="6003642">[</span><span class="num" id="6003643">0</span><span class="op" id="6003644">]</span><span class="op" id="6003645">,</span>&nbsp;<span class="ident" id="6003647">nil</span><br>
<span class="lineno">425</span><span class="op" id="6003651">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6003654">//&nbsp;GIF&nbsp;represents&nbsp;the&nbsp;possibly&nbsp;multiple&nbsp;images&nbsp;stored&nbsp;in&nbsp;a&nbsp;GIF&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="6003723">type</span>&nbsp;<span class="ident" id="6003728">GIF</span>&nbsp;<span class="keyword" id="6003732">struct</span>&nbsp;<span class="op" id="6003739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6003742">Image</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6003752">[</span><span class="op" id="6003753">]</span><span class="op" id="6003754">*</span><span class="ident" id="6003755">image</span><span class="op" id="6003760">.</span><span class="ident" id="6003761">Paletted</span>&nbsp;<span class="comment" id="6003770">//&nbsp;The&nbsp;successive&nbsp;images.</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6003797">Delay</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6003807">[</span><span class="op" id="6003808">]</span><span class="builtintype" id="6003809">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6003825">//&nbsp;The&nbsp;successive&nbsp;delay&nbsp;times,&nbsp;one&nbsp;per&nbsp;frame,&nbsp;in&nbsp;100ths&nbsp;of&nbsp;a&nbsp;second.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6003895">LoopCount</span>&nbsp;<span class="builtintype" id="6003905">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6003923">//&nbsp;The&nbsp;loop&nbsp;count.</span><br>
<span class="lineno"></span><span class="op" id="6003942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6003945">//&nbsp;DecodeAll&nbsp;reads&nbsp;a&nbsp;GIF&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;the&nbsp;sequential&nbsp;frames</span><br>
<span class="lineno">435</span><span class="comment" id="6004017">//&nbsp;and&nbsp;timing&nbsp;information.</span><br>
<span class="lineno"></span><span class="keyword" id="6004044">func</span>&nbsp;<span class="ident" id="6004049">DecodeAll</span><span class="op" id="6004058">(</span><span class="ident" id="6004059">r</span>&nbsp;<span class="ident" id="6004061">io</span><span class="op" id="6004063">.</span><span class="ident" id="6004064">Reader</span><span class="op" id="6004070">)</span>&nbsp;<span class="op" id="6004072">(</span><span class="op" id="6004073">*</span><span class="ident" id="6004074">GIF</span><span class="op" id="6004077">,</span>&nbsp;<span class="builtintype" id="6004079">error</span><span class="op" id="6004084">)</span>&nbsp;<span class="op" id="6004086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6004089">var</span>&nbsp;<span class="ident" id="6004093">d</span>&nbsp;<span class="ident" id="6004095">decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6004104">if</span>&nbsp;<span class="ident" id="6004107">err</span>&nbsp;<span class="op" id="6004111">:=</span>&nbsp;<span class="ident" id="6004114">d</span><span class="op" id="6004115">.</span><span class="ident" id="6004116">decode</span><span class="op" id="6004122">(</span><span class="ident" id="6004123">r</span><span class="op" id="6004124">,</span>&nbsp;<span class="builtintype" id="6004126">false</span><span class="op" id="6004131">)</span><span class="op" id="6004132">;</span>&nbsp;<span class="ident" id="6004134">err</span>&nbsp;<span class="op" id="6004138">!=</span>&nbsp;<span class="ident" id="6004141">nil</span>&nbsp;<span class="op" id="6004145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6004149">return</span>&nbsp;<span class="ident" id="6004156">nil</span><span class="op" id="6004159">,</span>&nbsp;<span class="ident" id="6004161">err</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6004166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6004169">gif</span>&nbsp;<span class="op" id="6004173">:=</span>&nbsp;<span class="op" id="6004176">&amp;</span><span class="ident" id="6004177">GIF</span><span class="op" id="6004180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6004184">Image</span><span class="op" id="6004189">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6004195">d</span><span class="op" id="6004196">.</span><span class="ident" id="6004197">image</span><span class="op" id="6004202">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6004206">LoopCount</span><span class="op" id="6004215">:</span>&nbsp;<span class="ident" id="6004217">d</span><span class="op" id="6004218">.</span><span class="ident" id="6004219">loopCount</span><span class="op" id="6004228">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6004232">Delay</span><span class="op" id="6004237">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6004243">d</span><span class="op" id="6004244">.</span><span class="ident" id="6004245">delay</span><span class="op" id="6004250">,</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6004253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6004256">return</span>&nbsp;<span class="ident" id="6004263">gif</span><span class="op" id="6004266">,</span>&nbsp;<span class="ident" id="6004268">nil</span><br>
<span class="lineno"></span><span class="op" id="6004272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6004275">//&nbsp;DecodeConfig&nbsp;returns&nbsp;the&nbsp;global&nbsp;color&nbsp;model&nbsp;and&nbsp;dimensions&nbsp;of&nbsp;a&nbsp;GIF&nbsp;image</span><br>
<span class="lineno">450</span><span class="comment" id="6004352">//&nbsp;without&nbsp;decoding&nbsp;the&nbsp;entire&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="6004390">func</span>&nbsp;<span class="ident" id="6004395">DecodeConfig</span><span class="op" id="6004407">(</span><span class="ident" id="6004408">r</span>&nbsp;<span class="ident" id="6004410">io</span><span class="op" id="6004412">.</span><span class="ident" id="6004413">Reader</span><span class="op" id="6004419">)</span>&nbsp;<span class="op" id="6004421">(</span><span class="ident" id="6004422">image</span><span class="op" id="6004427">.</span><span class="ident" id="6004428">Config</span><span class="op" id="6004434">,</span>&nbsp;<span class="builtintype" id="6004436">error</span><span class="op" id="6004441">)</span>&nbsp;<span class="op" id="6004443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6004446">var</span>&nbsp;<span class="ident" id="6004450">d</span>&nbsp;<span class="ident" id="6004452">decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6004461">if</span>&nbsp;<span class="ident" id="6004464">err</span>&nbsp;<span class="op" id="6004468">:=</span>&nbsp;<span class="ident" id="6004471">d</span><span class="op" id="6004472">.</span><span class="ident" id="6004473">decode</span><span class="op" id="6004479">(</span><span class="ident" id="6004480">r</span><span class="op" id="6004481">,</span>&nbsp;<span class="builtintype" id="6004483">true</span><span class="op" id="6004487">)</span><span class="op" id="6004488">;</span>&nbsp;<span class="ident" id="6004490">err</span>&nbsp;<span class="op" id="6004494">!=</span>&nbsp;<span class="ident" id="6004497">nil</span>&nbsp;<span class="op" id="6004501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6004505">return</span>&nbsp;<span class="ident" id="6004512">image</span><span class="op" id="6004517">.</span><span class="ident" id="6004518">Config</span><span class="op" id="6004524">{</span><span class="op" id="6004525">}</span><span class="op" id="6004526">,</span>&nbsp;<span class="ident" id="6004528">err</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6004533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6004536">return</span>&nbsp;<span class="ident" id="6004543">image</span><span class="op" id="6004548">.</span><span class="ident" id="6004549">Config</span><span class="op" id="6004555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6004559">ColorModel</span><span class="op" id="6004569">:</span>&nbsp;<span class="ident" id="6004571">d</span><span class="op" id="6004572">.</span><span class="ident" id="6004573">globalColorMap</span><span class="op" id="6004587">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6004591">Width</span><span class="op" id="6004596">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6004603">d</span><span class="op" id="6004604">.</span><span class="ident" id="6004605">width</span><span class="op" id="6004610">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6004614">Height</span><span class="op" id="6004620">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6004626">d</span><span class="op" id="6004627">.</span><span class="ident" id="6004628">height</span><span class="op" id="6004634">,</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6004637">}</span><span class="op" id="6004638">,</span>&nbsp;<span class="ident" id="6004640">nil</span><br>
<span class="lineno"></span><span class="op" id="6004644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6004647">func</span>&nbsp;<span class="ident" id="6004652">init</span><span class="op" id="6004656">(</span><span class="op" id="6004657">)</span>&nbsp;<span class="op" id="6004659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6004662">image</span><span class="op" id="6004667">.</span><span class="ident" id="6004668">RegisterFormat</span><span class="op" id="6004682">(</span><span class="string" id="6004683">&#34;gif&#34;</span><span class="op" id="6004688">,</span>&nbsp;<span class="string" id="6004690">&#34;GIF8?a&#34;</span><span class="op" id="6004698">,</span>&nbsp;<span class="ident" id="6004700">Decode</span><span class="op" id="6004706">,</span>&nbsp;<span class="ident" id="6004708">DecodeConfig</span><span class="op" id="6004720">)</span><br>
<span class="lineno">465</span><span class="op" id="6004722">}</span>
</div>
</body>
</html>
