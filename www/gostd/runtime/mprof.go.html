<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html" class="current">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1616097">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1616152">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1616206">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1616257">//&nbsp;Malloc&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1616278">//&nbsp;Patterned&nbsp;after&nbsp;tcmalloc&#39;s&nbsp;algorithms;&nbsp;shorter&nbsp;code.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1616335">package</span>&nbsp;<span class="ident" id="1616343">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1616352">import</span>&nbsp;<span class="op" id="1616359">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1616362">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1616371">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1616374">//&nbsp;NOTE(rsc):&nbsp;Everything&nbsp;here&nbsp;could&nbsp;use&nbsp;cas&nbsp;if&nbsp;contention&nbsp;became&nbsp;an&nbsp;issue.</span><br>
<span class="lineno">15</span><span class="keyword" id="1616449">var</span>&nbsp;<span class="ident" id="1616453">proflock</span>&nbsp;<span class="ident" id="1616462">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1616469">//&nbsp;All&nbsp;memory&nbsp;allocations&nbsp;are&nbsp;local&nbsp;and&nbsp;do&nbsp;not&nbsp;escape&nbsp;outside&nbsp;of&nbsp;the&nbsp;profiler.</span><br>
<span class="lineno"></span><span class="comment" id="1616548">//&nbsp;The&nbsp;profiler&nbsp;is&nbsp;forbidden&nbsp;from&nbsp;referring&nbsp;to&nbsp;garbage-collected&nbsp;memory.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1616622">const</span>&nbsp;<span class="op" id="1616628">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1616631">//&nbsp;profile&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616649">memProfile</span>&nbsp;<span class="ident" id="1616660">bucketType</span>&nbsp;<span class="op" id="1616671">=</span>&nbsp;<span class="num" id="1616673">1</span>&nbsp;<span class="op" id="1616675">+</span>&nbsp;<span class="ident" id="1616677">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616683">blockProfile</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1616698">//&nbsp;size&nbsp;of&nbsp;bucket&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616728">buckHashSize</span>&nbsp;<span class="op" id="1616741">=</span>&nbsp;<span class="num" id="1616743">179999</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1616752">//&nbsp;max&nbsp;depth&nbsp;of&nbsp;stack&nbsp;to&nbsp;record&nbsp;in&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616795">maxStack</span>&nbsp;<span class="op" id="1616804">=</span>&nbsp;<span class="num" id="1616806">32</span><br>
<span class="lineno">30</span><span class="op" id="1616809">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1616812">type</span>&nbsp;<span class="ident" id="1616817">bucketType</span>&nbsp;<span class="builtintype" id="1616828">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1616833">//&nbsp;A&nbsp;bucket&nbsp;holds&nbsp;per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno">35</span><span class="comment" id="1616889">//&nbsp;The&nbsp;representation&nbsp;is&nbsp;a&nbsp;bit&nbsp;sleazy,&nbsp;inherited&nbsp;from&nbsp;C.</span><br>
<span class="lineno"></span><span class="comment" id="1616946">//&nbsp;This&nbsp;struct&nbsp;defines&nbsp;the&nbsp;bucket&nbsp;header.&nbsp;It&nbsp;is&nbsp;followed&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1617006">//&nbsp;memory&nbsp;by&nbsp;the&nbsp;stack&nbsp;words&nbsp;and&nbsp;then&nbsp;the&nbsp;actual&nbsp;record</span><br>
<span class="lineno"></span><span class="comment" id="1617062">//&nbsp;data,&nbsp;either&nbsp;a&nbsp;memRecord&nbsp;or&nbsp;a&nbsp;blockRecord.</span><br>
<span class="lineno"></span><span class="comment" id="1617108">//</span><br>
<span class="lineno">40</span><span class="comment" id="1617111">//&nbsp;Per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="1617152">//&nbsp;Lookup&nbsp;by&nbsp;hashing&nbsp;call&nbsp;stack&nbsp;into&nbsp;a&nbsp;linked-list&nbsp;hash&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="1617215">type</span>&nbsp;<span class="ident" id="1617220">bucket</span>&nbsp;<span class="keyword" id="1617227">struct</span>&nbsp;<span class="op" id="1617234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617237">next</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1617245">*</span><span class="ident" id="1617246">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617254">allnext</span>&nbsp;<span class="op" id="1617262">*</span><span class="ident" id="1617263">bucket</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617271">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617279">bucketType</span>&nbsp;<span class="comment" id="1617290">//&nbsp;memBucket&nbsp;or&nbsp;blockBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617319">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1617327">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617336">size</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1617344">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617353">nstk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1617361">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1617369">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="1617372">//&nbsp;A&nbsp;memRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;memProfile,</span><br>
<span class="lineno"></span><span class="comment" id="1617439">//&nbsp;part&nbsp;of&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1617470">type</span>&nbsp;<span class="ident" id="1617475">memRecord</span>&nbsp;<span class="keyword" id="1617485">struct</span>&nbsp;<span class="op" id="1617492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617495">//&nbsp;The&nbsp;following&nbsp;complex&nbsp;3-stage&nbsp;scheme&nbsp;of&nbsp;stats&nbsp;accumulation</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617558">//&nbsp;is&nbsp;required&nbsp;to&nbsp;obtain&nbsp;a&nbsp;consistent&nbsp;picture&nbsp;of&nbsp;mallocs&nbsp;and&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617626">//&nbsp;for&nbsp;some&nbsp;point&nbsp;in&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617654">//&nbsp;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;mallocs&nbsp;come&nbsp;in&nbsp;real&nbsp;time,&nbsp;while&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617717">//&nbsp;come&nbsp;only&nbsp;after&nbsp;a&nbsp;GC&nbsp;during&nbsp;concurrent&nbsp;sweeping.&nbsp;So&nbsp;if&nbsp;we&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617785">//&nbsp;naively&nbsp;count&nbsp;them,&nbsp;we&nbsp;would&nbsp;get&nbsp;a&nbsp;skew&nbsp;toward&nbsp;mallocs.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617845">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617849">//&nbsp;Mallocs&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617892">//&nbsp;Explicit&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617942">//&nbsp;GC&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617984">//&nbsp;After&nbsp;GC&nbsp;prev&nbsp;stats&nbsp;are&nbsp;added&nbsp;to&nbsp;final&nbsp;stats&nbsp;and</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1618037">//&nbsp;recent&nbsp;stats&nbsp;are&nbsp;moved&nbsp;into&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618081">allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1618093">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618102">frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1618114">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618123">alloc_bytes</span>&nbsp;<span class="builtintype" id="1618135">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618144">free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1618156">uintptr</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1618166">//&nbsp;changes&nbsp;between&nbsp;next-to-last&nbsp;GC&nbsp;and&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618214">prev_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1618231">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618240">prev_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1618257">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618266">prev_alloc_bytes</span>&nbsp;<span class="builtintype" id="1618283">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618292">prev_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1618309">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1618319">//&nbsp;changes&nbsp;since&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618345">recent_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1618364">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618373">recent_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1618392">uintptr</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618401">recent_alloc_bytes</span>&nbsp;<span class="builtintype" id="1618420">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618429">recent_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1618448">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1618456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1618459">//&nbsp;A&nbsp;blockRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;blockProfile,</span><br>
<span class="lineno">85</span><span class="comment" id="1618530">//&nbsp;part&nbsp;of&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1618563">type</span>&nbsp;<span class="ident" id="1618568">blockRecord</span>&nbsp;<span class="keyword" id="1618580">struct</span>&nbsp;<span class="op" id="1618587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618590">count</span>&nbsp;&nbsp;<span class="ident" id="1618597">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618604">cycles</span>&nbsp;<span class="ident" id="1618611">int64</span><br>
<span class="lineno"></span><span class="op" id="1618617">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="1618620">var</span>&nbsp;<span class="op" id="1618624">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618627">mbuckets</span>&nbsp;&nbsp;<span class="op" id="1618637">*</span><span class="ident" id="1618638">bucket</span>&nbsp;<span class="comment" id="1618645">//&nbsp;memory&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618672">bbuckets</span>&nbsp;&nbsp;<span class="op" id="1618682">*</span><span class="ident" id="1618683">bucket</span>&nbsp;<span class="comment" id="1618690">//&nbsp;blocking&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618719">buckhash</span>&nbsp;&nbsp;<span class="op" id="1618729">*</span><span class="op" id="1618730">[</span><span class="num" id="1618731">179999</span><span class="op" id="1618737">]</span><span class="op" id="1618738">*</span><span class="ident" id="1618739">bucket</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618747">bucketmem</span>&nbsp;<span class="builtintype" id="1618757">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1618765">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1618768">//&nbsp;newBucket&nbsp;allocates&nbsp;a&nbsp;bucket&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;number&nbsp;of&nbsp;stack&nbsp;entries.</span><br>
<span class="lineno"></span><span class="keyword" id="1618849">func</span>&nbsp;<span class="ident" id="1618854">newBucket</span><span class="op" id="1618863">(</span><span class="ident" id="1618864">typ</span>&nbsp;<span class="ident" id="1618868">bucketType</span><span class="op" id="1618878">,</span>&nbsp;<span class="ident" id="1618880">nstk</span>&nbsp;<span class="builtintype" id="1618885">int</span><span class="op" id="1618888">)</span>&nbsp;<span class="op" id="1618890">*</span><span class="ident" id="1618891">bucket</span>&nbsp;<span class="op" id="1618898">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618901">size</span>&nbsp;<span class="op" id="1618906">:=</span>&nbsp;<span class="ident" id="1618909">unsafe</span><span class="op" id="1618915">.</span><span class="ident" id="1618916">Sizeof</span><span class="op" id="1618922">(</span><span class="ident" id="1618923">bucket</span><span class="op" id="1618929">{</span><span class="op" id="1618930">}</span><span class="op" id="1618931">)</span>&nbsp;<span class="op" id="1618933">+</span>&nbsp;<span class="builtintype" id="1618935">uintptr</span><span class="op" id="1618942">(</span><span class="ident" id="1618943">nstk</span><span class="op" id="1618947">)</span><span class="op" id="1618948">*</span><span class="ident" id="1618949">unsafe</span><span class="op" id="1618955">.</span><span class="ident" id="1618956">Sizeof</span><span class="op" id="1618962">(</span><span class="builtintype" id="1618963">uintptr</span><span class="op" id="1618970">(</span><span class="num" id="1618971">0</span><span class="op" id="1618972">)</span><span class="op" id="1618973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618976">switch</span>&nbsp;<span class="ident" id="1618983">typ</span>&nbsp;<span class="op" id="1618987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618990">default</span><span class="op" id="1618997">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619001">gothrow</span><span class="op" id="1619008">(</span><span class="string" id="1619009">&#34;invalid&nbsp;profile&nbsp;bucket&nbsp;type&#34;</span><span class="op" id="1619038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619041">case</span>&nbsp;<span class="ident" id="1619046">memProfile</span><span class="op" id="1619056">:</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619060">size</span>&nbsp;<span class="op" id="1619065">+=</span>&nbsp;<span class="ident" id="1619068">unsafe</span><span class="op" id="1619074">.</span><span class="ident" id="1619075">Sizeof</span><span class="op" id="1619081">(</span><span class="ident" id="1619082">memRecord</span><span class="op" id="1619091">{</span><span class="op" id="1619092">}</span><span class="op" id="1619093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619096">case</span>&nbsp;<span class="ident" id="1619101">blockProfile</span><span class="op" id="1619113">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619117">size</span>&nbsp;<span class="op" id="1619122">+=</span>&nbsp;<span class="ident" id="1619125">unsafe</span><span class="op" id="1619131">.</span><span class="ident" id="1619132">Sizeof</span><span class="op" id="1619138">(</span><span class="ident" id="1619139">blockRecord</span><span class="op" id="1619150">{</span><span class="op" id="1619151">}</span><span class="op" id="1619152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619159">b</span>&nbsp;<span class="op" id="1619161">:=</span>&nbsp;<span class="op" id="1619164">(</span><span class="op" id="1619165">*</span><span class="ident" id="1619166">bucket</span><span class="op" id="1619172">)</span><span class="op" id="1619173">(</span><span class="ident" id="1619174">persistentalloc</span><span class="op" id="1619189">(</span><span class="ident" id="1619190">size</span><span class="op" id="1619194">,</span>&nbsp;<span class="num" id="1619196">0</span><span class="op" id="1619197">,</span>&nbsp;<span class="op" id="1619199">&amp;</span><span class="ident" id="1619200">memstats</span><span class="op" id="1619208">.</span><span class="ident" id="1619209">buckhash_sys</span><span class="op" id="1619221">)</span><span class="op" id="1619222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619225">bucketmem</span>&nbsp;<span class="op" id="1619235">+=</span>&nbsp;<span class="ident" id="1619238">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619244">b</span><span class="op" id="1619245">.</span><span class="ident" id="1619246">typ</span>&nbsp;<span class="op" id="1619250">=</span>&nbsp;<span class="ident" id="1619252">typ</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619257">b</span><span class="op" id="1619258">.</span><span class="ident" id="1619259">nstk</span>&nbsp;<span class="op" id="1619264">=</span>&nbsp;<span class="builtintype" id="1619266">uintptr</span><span class="op" id="1619273">(</span><span class="ident" id="1619274">nstk</span><span class="op" id="1619278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619281">return</span>&nbsp;<span class="ident" id="1619288">b</span><br>
<span class="lineno">115</span><span class="op" id="1619290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1619293">//&nbsp;stk&nbsp;returns&nbsp;the&nbsp;slice&nbsp;in&nbsp;b&nbsp;holding&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1619342">func</span>&nbsp;<span class="op" id="1619347">(</span><span class="ident" id="1619348">b</span>&nbsp;<span class="op" id="1619350">*</span><span class="ident" id="1619351">bucket</span><span class="op" id="1619357">)</span>&nbsp;<span class="ident" id="1619359">stk</span><span class="op" id="1619362">(</span><span class="op" id="1619363">)</span>&nbsp;<span class="op" id="1619365">[</span><span class="op" id="1619366">]</span><span class="builtintype" id="1619367">uintptr</span>&nbsp;<span class="op" id="1619375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619378">stk</span>&nbsp;<span class="op" id="1619382">:=</span>&nbsp;<span class="op" id="1619385">(</span><span class="op" id="1619386">*</span><span class="op" id="1619387">[</span><span class="ident" id="1619388">maxStack</span><span class="op" id="1619396">]</span><span class="builtintype" id="1619397">uintptr</span><span class="op" id="1619404">)</span><span class="op" id="1619405">(</span><span class="ident" id="1619406">add</span><span class="op" id="1619409">(</span><span class="ident" id="1619410">unsafe</span><span class="op" id="1619416">.</span><span class="ident" id="1619417">Pointer</span><span class="op" id="1619424">(</span><span class="ident" id="1619425">b</span><span class="op" id="1619426">)</span><span class="op" id="1619427">,</span>&nbsp;<span class="ident" id="1619429">unsafe</span><span class="op" id="1619435">.</span><span class="ident" id="1619436">Sizeof</span><span class="op" id="1619442">(</span><span class="op" id="1619443">*</span><span class="ident" id="1619444">b</span><span class="op" id="1619445">)</span><span class="op" id="1619446">)</span><span class="op" id="1619447">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619450">return</span>&nbsp;<span class="ident" id="1619457">stk</span><span class="op" id="1619460">[</span><span class="op" id="1619461">:</span><span class="ident" id="1619462">b</span><span class="op" id="1619463">.</span><span class="ident" id="1619464">nstk</span><span class="op" id="1619468">:</span><span class="ident" id="1619469">b</span><span class="op" id="1619470">.</span><span class="ident" id="1619471">nstk</span><span class="op" id="1619475">]</span><br>
<span class="lineno"></span><span class="op" id="1619477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1619480">//&nbsp;mp&nbsp;returns&nbsp;the&nbsp;memRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;memProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1619549">func</span>&nbsp;<span class="op" id="1619554">(</span><span class="ident" id="1619555">b</span>&nbsp;<span class="op" id="1619557">*</span><span class="ident" id="1619558">bucket</span><span class="op" id="1619564">)</span>&nbsp;<span class="ident" id="1619566">mp</span><span class="op" id="1619568">(</span><span class="op" id="1619569">)</span>&nbsp;<span class="op" id="1619571">*</span><span class="ident" id="1619572">memRecord</span>&nbsp;<span class="op" id="1619582">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619585">if</span>&nbsp;<span class="ident" id="1619588">b</span><span class="op" id="1619589">.</span><span class="ident" id="1619590">typ</span>&nbsp;<span class="op" id="1619594">!=</span>&nbsp;<span class="ident" id="1619597">memProfile</span>&nbsp;<span class="op" id="1619608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619612">gothrow</span><span class="op" id="1619619">(</span><span class="string" id="1619620">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.mp&#34;</span><span class="op" id="1619642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619648">data</span>&nbsp;<span class="op" id="1619653">:=</span>&nbsp;<span class="ident" id="1619656">add</span><span class="op" id="1619659">(</span><span class="ident" id="1619660">unsafe</span><span class="op" id="1619666">.</span><span class="ident" id="1619667">Pointer</span><span class="op" id="1619674">(</span><span class="ident" id="1619675">b</span><span class="op" id="1619676">)</span><span class="op" id="1619677">,</span>&nbsp;<span class="ident" id="1619679">unsafe</span><span class="op" id="1619685">.</span><span class="ident" id="1619686">Sizeof</span><span class="op" id="1619692">(</span><span class="op" id="1619693">*</span><span class="ident" id="1619694">b</span><span class="op" id="1619695">)</span><span class="op" id="1619696">+</span><span class="ident" id="1619697">b</span><span class="op" id="1619698">.</span><span class="ident" id="1619699">nstk</span><span class="op" id="1619703">*</span><span class="ident" id="1619704">unsafe</span><span class="op" id="1619710">.</span><span class="ident" id="1619711">Sizeof</span><span class="op" id="1619717">(</span><span class="builtintype" id="1619718">uintptr</span><span class="op" id="1619725">(</span><span class="num" id="1619726">0</span><span class="op" id="1619727">)</span><span class="op" id="1619728">)</span><span class="op" id="1619729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619732">return</span>&nbsp;<span class="op" id="1619739">(</span><span class="op" id="1619740">*</span><span class="ident" id="1619741">memRecord</span><span class="op" id="1619750">)</span><span class="op" id="1619751">(</span><span class="ident" id="1619752">data</span><span class="op" id="1619756">)</span><br>
<span class="lineno">130</span><span class="op" id="1619758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1619761">//&nbsp;bp&nbsp;returns&nbsp;the&nbsp;blockRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;blockProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1619834">func</span>&nbsp;<span class="op" id="1619839">(</span><span class="ident" id="1619840">b</span>&nbsp;<span class="op" id="1619842">*</span><span class="ident" id="1619843">bucket</span><span class="op" id="1619849">)</span>&nbsp;<span class="ident" id="1619851">bp</span><span class="op" id="1619853">(</span><span class="op" id="1619854">)</span>&nbsp;<span class="op" id="1619856">*</span><span class="ident" id="1619857">blockRecord</span>&nbsp;<span class="op" id="1619869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619872">if</span>&nbsp;<span class="ident" id="1619875">b</span><span class="op" id="1619876">.</span><span class="ident" id="1619877">typ</span>&nbsp;<span class="op" id="1619881">!=</span>&nbsp;<span class="ident" id="1619884">blockProfile</span>&nbsp;<span class="op" id="1619897">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619901">gothrow</span><span class="op" id="1619908">(</span><span class="string" id="1619909">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.bp&#34;</span><span class="op" id="1619931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619937">data</span>&nbsp;<span class="op" id="1619942">:=</span>&nbsp;<span class="ident" id="1619945">add</span><span class="op" id="1619948">(</span><span class="ident" id="1619949">unsafe</span><span class="op" id="1619955">.</span><span class="ident" id="1619956">Pointer</span><span class="op" id="1619963">(</span><span class="ident" id="1619964">b</span><span class="op" id="1619965">)</span><span class="op" id="1619966">,</span>&nbsp;<span class="ident" id="1619968">unsafe</span><span class="op" id="1619974">.</span><span class="ident" id="1619975">Sizeof</span><span class="op" id="1619981">(</span><span class="op" id="1619982">*</span><span class="ident" id="1619983">b</span><span class="op" id="1619984">)</span><span class="op" id="1619985">+</span><span class="ident" id="1619986">b</span><span class="op" id="1619987">.</span><span class="ident" id="1619988">nstk</span><span class="op" id="1619992">*</span><span class="ident" id="1619993">unsafe</span><span class="op" id="1619999">.</span><span class="ident" id="1620000">Sizeof</span><span class="op" id="1620006">(</span><span class="builtintype" id="1620007">uintptr</span><span class="op" id="1620014">(</span><span class="num" id="1620015">0</span><span class="op" id="1620016">)</span><span class="op" id="1620017">)</span><span class="op" id="1620018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620021">return</span>&nbsp;<span class="op" id="1620028">(</span><span class="op" id="1620029">*</span><span class="ident" id="1620030">blockRecord</span><span class="op" id="1620041">)</span><span class="op" id="1620042">(</span><span class="ident" id="1620043">data</span><span class="op" id="1620047">)</span><br>
<span class="lineno"></span><span class="op" id="1620049">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="1620052">//&nbsp;Return&nbsp;the&nbsp;bucket&nbsp;for&nbsp;stk[0:nstk],&nbsp;allocating&nbsp;new&nbsp;bucket&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="1620123">func</span>&nbsp;<span class="ident" id="1620128">stkbucket</span><span class="op" id="1620137">(</span><span class="ident" id="1620138">typ</span>&nbsp;<span class="ident" id="1620142">bucketType</span><span class="op" id="1620152">,</span>&nbsp;<span class="ident" id="1620154">size</span>&nbsp;<span class="builtintype" id="1620159">uintptr</span><span class="op" id="1620166">,</span>&nbsp;<span class="ident" id="1620168">stk</span>&nbsp;<span class="op" id="1620172">[</span><span class="op" id="1620173">]</span><span class="builtintype" id="1620174">uintptr</span><span class="op" id="1620181">,</span>&nbsp;<span class="ident" id="1620183">alloc</span>&nbsp;<span class="builtintype" id="1620189">bool</span><span class="op" id="1620193">)</span>&nbsp;<span class="op" id="1620195">*</span><span class="ident" id="1620196">bucket</span>&nbsp;<span class="op" id="1620203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620206">if</span>&nbsp;<span class="ident" id="1620209">buckhash</span>&nbsp;<span class="op" id="1620218">==</span>&nbsp;<span class="ident" id="1620221">nil</span>&nbsp;<span class="op" id="1620225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620229">buckhash</span>&nbsp;<span class="op" id="1620238">=</span>&nbsp;<span class="op" id="1620240">(</span><span class="op" id="1620241">*</span><span class="op" id="1620242">[</span><span class="ident" id="1620243">buckHashSize</span><span class="op" id="1620255">]</span><span class="op" id="1620256">*</span><span class="ident" id="1620257">bucket</span><span class="op" id="1620263">)</span><span class="op" id="1620264">(</span><span class="ident" id="1620265">sysAlloc</span><span class="op" id="1620273">(</span><span class="ident" id="1620274">unsafe</span><span class="op" id="1620280">.</span><span class="ident" id="1620281">Sizeof</span><span class="op" id="1620287">(</span><span class="op" id="1620288">*</span><span class="ident" id="1620289">buckhash</span><span class="op" id="1620297">)</span><span class="op" id="1620298">,</span>&nbsp;<span class="op" id="1620300">&amp;</span><span class="ident" id="1620301">memstats</span><span class="op" id="1620309">.</span><span class="ident" id="1620310">buckhash_sys</span><span class="op" id="1620322">)</span><span class="op" id="1620323">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620327">if</span>&nbsp;<span class="ident" id="1620330">buckhash</span>&nbsp;<span class="op" id="1620339">==</span>&nbsp;<span class="ident" id="1620342">nil</span>&nbsp;<span class="op" id="1620346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620351">gothrow</span><span class="op" id="1620358">(</span><span class="string" id="1620359">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1620392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1620403">//&nbsp;Hash&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620419">var</span>&nbsp;<span class="ident" id="1620423">h</span>&nbsp;<span class="builtintype" id="1620425">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620434">for</span>&nbsp;<span class="ident" id="1620438">_</span><span class="op" id="1620439">,</span>&nbsp;<span class="ident" id="1620441">pc</span>&nbsp;<span class="op" id="1620444">:=</span>&nbsp;<span class="keyword" id="1620447">range</span>&nbsp;<span class="ident" id="1620453">stk</span>&nbsp;<span class="op" id="1620457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620461">h</span>&nbsp;<span class="op" id="1620463">+=</span>&nbsp;<span class="ident" id="1620466">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620471">h</span>&nbsp;<span class="op" id="1620473">+=</span>&nbsp;<span class="ident" id="1620476">h</span>&nbsp;<span class="op" id="1620478">&lt;&lt;</span>&nbsp;<span class="num" id="1620481">10</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620486">h</span>&nbsp;<span class="op" id="1620488">^=</span>&nbsp;<span class="ident" id="1620491">h</span>&nbsp;<span class="op" id="1620493">&gt;&gt;</span>&nbsp;<span class="num" id="1620496">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1620502">//&nbsp;hash&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620519">h</span>&nbsp;<span class="op" id="1620521">+=</span>&nbsp;<span class="ident" id="1620524">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620530">h</span>&nbsp;<span class="op" id="1620532">+=</span>&nbsp;<span class="ident" id="1620535">h</span>&nbsp;<span class="op" id="1620537">&lt;&lt;</span>&nbsp;<span class="num" id="1620540">10</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620544">h</span>&nbsp;<span class="op" id="1620546">^=</span>&nbsp;<span class="ident" id="1620549">h</span>&nbsp;<span class="op" id="1620551">&gt;&gt;</span>&nbsp;<span class="num" id="1620554">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1620557">//&nbsp;finalize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620570">h</span>&nbsp;<span class="op" id="1620572">+=</span>&nbsp;<span class="ident" id="1620575">h</span>&nbsp;<span class="op" id="1620577">&lt;&lt;</span>&nbsp;<span class="num" id="1620580">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620583">h</span>&nbsp;<span class="op" id="1620585">^=</span>&nbsp;<span class="ident" id="1620588">h</span>&nbsp;<span class="op" id="1620590">&gt;&gt;</span>&nbsp;<span class="num" id="1620593">11</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620598">i</span>&nbsp;<span class="op" id="1620600">:=</span>&nbsp;<span class="builtintype" id="1620603">int</span><span class="op" id="1620606">(</span><span class="ident" id="1620607">h</span>&nbsp;<span class="op" id="1620609">%</span>&nbsp;<span class="ident" id="1620611">buckHashSize</span><span class="op" id="1620623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620626">for</span>&nbsp;<span class="ident" id="1620630">b</span>&nbsp;<span class="op" id="1620632">:=</span>&nbsp;<span class="ident" id="1620635">buckhash</span><span class="op" id="1620643">[</span><span class="ident" id="1620644">i</span><span class="op" id="1620645">]</span><span class="op" id="1620646">;</span>&nbsp;<span class="ident" id="1620648">b</span>&nbsp;<span class="op" id="1620650">!=</span>&nbsp;<span class="ident" id="1620653">nil</span><span class="op" id="1620656">;</span>&nbsp;<span class="ident" id="1620658">b</span>&nbsp;<span class="op" id="1620660">=</span>&nbsp;<span class="ident" id="1620662">b</span><span class="op" id="1620663">.</span><span class="ident" id="1620664">next</span>&nbsp;<span class="op" id="1620669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620673">if</span>&nbsp;<span class="ident" id="1620676">b</span><span class="op" id="1620677">.</span><span class="ident" id="1620678">typ</span>&nbsp;<span class="op" id="1620682">==</span>&nbsp;<span class="ident" id="1620685">typ</span>&nbsp;<span class="op" id="1620689">&amp;&amp;</span>&nbsp;<span class="ident" id="1620692">b</span><span class="op" id="1620693">.</span><span class="ident" id="1620694">hash</span>&nbsp;<span class="op" id="1620699">==</span>&nbsp;<span class="ident" id="1620702">h</span>&nbsp;<span class="op" id="1620704">&amp;&amp;</span>&nbsp;<span class="ident" id="1620707">b</span><span class="op" id="1620708">.</span><span class="ident" id="1620709">size</span>&nbsp;<span class="op" id="1620714">==</span>&nbsp;<span class="ident" id="1620717">size</span>&nbsp;<span class="op" id="1620722">&amp;&amp;</span>&nbsp;<span class="ident" id="1620725">eqslice</span><span class="op" id="1620732">(</span><span class="ident" id="1620733">b</span><span class="op" id="1620734">.</span><span class="ident" id="1620735">stk</span><span class="op" id="1620738">(</span><span class="op" id="1620739">)</span><span class="op" id="1620740">,</span>&nbsp;<span class="ident" id="1620742">stk</span><span class="op" id="1620745">)</span>&nbsp;<span class="op" id="1620747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620752">return</span>&nbsp;<span class="ident" id="1620759">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620763">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620770">if</span>&nbsp;<span class="op" id="1620773">!</span><span class="ident" id="1620774">alloc</span>&nbsp;<span class="op" id="1620780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620784">return</span>&nbsp;<span class="ident" id="1620791">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620796">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1620800">//&nbsp;Create&nbsp;new&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620823">b</span>&nbsp;<span class="op" id="1620825">:=</span>&nbsp;<span class="ident" id="1620828">newBucket</span><span class="op" id="1620837">(</span><span class="ident" id="1620838">typ</span><span class="op" id="1620841">,</span>&nbsp;<span class="builtinfunc" id="1620843">len</span><span class="op" id="1620846">(</span><span class="ident" id="1620847">stk</span><span class="op" id="1620850">)</span><span class="op" id="1620851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1620854">copy</span><span class="op" id="1620858">(</span><span class="ident" id="1620859">b</span><span class="op" id="1620860">.</span><span class="ident" id="1620861">stk</span><span class="op" id="1620864">(</span><span class="op" id="1620865">)</span><span class="op" id="1620866">,</span>&nbsp;<span class="ident" id="1620868">stk</span><span class="op" id="1620871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620874">b</span><span class="op" id="1620875">.</span><span class="ident" id="1620876">hash</span>&nbsp;<span class="op" id="1620881">=</span>&nbsp;<span class="ident" id="1620883">h</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620886">b</span><span class="op" id="1620887">.</span><span class="ident" id="1620888">size</span>&nbsp;<span class="op" id="1620893">=</span>&nbsp;<span class="ident" id="1620895">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620901">b</span><span class="op" id="1620902">.</span><span class="ident" id="1620903">next</span>&nbsp;<span class="op" id="1620908">=</span>&nbsp;<span class="ident" id="1620910">buckhash</span><span class="op" id="1620918">[</span><span class="ident" id="1620919">i</span><span class="op" id="1620920">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620923">buckhash</span><span class="op" id="1620931">[</span><span class="ident" id="1620932">i</span><span class="op" id="1620933">]</span>&nbsp;<span class="op" id="1620935">=</span>&nbsp;<span class="ident" id="1620937">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620940">if</span>&nbsp;<span class="ident" id="1620943">typ</span>&nbsp;<span class="op" id="1620947">==</span>&nbsp;<span class="ident" id="1620950">memProfile</span>&nbsp;<span class="op" id="1620961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620965">b</span><span class="op" id="1620966">.</span><span class="ident" id="1620967">allnext</span>&nbsp;<span class="op" id="1620975">=</span>&nbsp;<span class="ident" id="1620977">mbuckets</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620988">mbuckets</span>&nbsp;<span class="op" id="1620997">=</span>&nbsp;<span class="ident" id="1620999">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621002">}</span>&nbsp;<span class="keyword" id="1621004">else</span>&nbsp;<span class="op" id="1621009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621013">b</span><span class="op" id="1621014">.</span><span class="ident" id="1621015">allnext</span>&nbsp;<span class="op" id="1621023">=</span>&nbsp;<span class="ident" id="1621025">bbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621036">bbuckets</span>&nbsp;<span class="op" id="1621045">=</span>&nbsp;<span class="ident" id="1621047">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621050">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621053">return</span>&nbsp;<span class="ident" id="1621060">b</span><br>
<span class="lineno"></span><span class="op" id="1621062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1621065">func</span>&nbsp;<span class="ident" id="1621070">sysAlloc</span><span class="op" id="1621078">(</span><span class="ident" id="1621079">n</span>&nbsp;<span class="builtintype" id="1621081">uintptr</span><span class="op" id="1621088">,</span>&nbsp;<span class="ident" id="1621090">stat</span>&nbsp;<span class="op" id="1621095">*</span><span class="ident" id="1621096">uint64</span><span class="op" id="1621102">)</span>&nbsp;<span class="ident" id="1621104">unsafe</span><span class="op" id="1621110">.</span><span class="ident" id="1621111">Pointer</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="1621120">func</span>&nbsp;<span class="ident" id="1621125">eqslice</span><span class="op" id="1621132">(</span><span class="ident" id="1621133">x</span><span class="op" id="1621134">,</span>&nbsp;<span class="ident" id="1621136">y</span>&nbsp;<span class="op" id="1621138">[</span><span class="op" id="1621139">]</span><span class="builtintype" id="1621140">uintptr</span><span class="op" id="1621147">)</span>&nbsp;<span class="builtintype" id="1621149">bool</span>&nbsp;<span class="op" id="1621154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621157">if</span>&nbsp;<span class="builtinfunc" id="1621160">len</span><span class="op" id="1621163">(</span><span class="ident" id="1621164">x</span><span class="op" id="1621165">)</span>&nbsp;<span class="op" id="1621167">!=</span>&nbsp;<span class="builtinfunc" id="1621170">len</span><span class="op" id="1621173">(</span><span class="ident" id="1621174">y</span><span class="op" id="1621175">)</span>&nbsp;<span class="op" id="1621177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621181">return</span>&nbsp;<span class="builtintype" id="1621188">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621198">for</span>&nbsp;<span class="ident" id="1621202">i</span><span class="op" id="1621203">,</span>&nbsp;<span class="ident" id="1621205">xi</span>&nbsp;<span class="op" id="1621208">:=</span>&nbsp;<span class="keyword" id="1621211">range</span>&nbsp;<span class="ident" id="1621217">x</span>&nbsp;<span class="op" id="1621219">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621223">if</span>&nbsp;<span class="ident" id="1621226">xi</span>&nbsp;<span class="op" id="1621229">!=</span>&nbsp;<span class="ident" id="1621232">y</span><span class="op" id="1621233">[</span><span class="ident" id="1621234">i</span><span class="op" id="1621235">]</span>&nbsp;<span class="op" id="1621237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621242">return</span>&nbsp;<span class="builtintype" id="1621249">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621263">return</span>&nbsp;<span class="builtintype" id="1621270">true</span><br>
<span class="lineno">205</span><span class="op" id="1621275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1621278">func</span>&nbsp;<span class="ident" id="1621283">mprof_GC</span><span class="op" id="1621291">(</span><span class="op" id="1621292">)</span>&nbsp;<span class="op" id="1621294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621297">for</span>&nbsp;<span class="ident" id="1621301">b</span>&nbsp;<span class="op" id="1621303">:=</span>&nbsp;<span class="ident" id="1621306">mbuckets</span><span class="op" id="1621314">;</span>&nbsp;<span class="ident" id="1621316">b</span>&nbsp;<span class="op" id="1621318">!=</span>&nbsp;<span class="ident" id="1621321">nil</span><span class="op" id="1621324">;</span>&nbsp;<span class="ident" id="1621326">b</span>&nbsp;<span class="op" id="1621328">=</span>&nbsp;<span class="ident" id="1621330">b</span><span class="op" id="1621331">.</span><span class="ident" id="1621332">allnext</span>&nbsp;<span class="op" id="1621340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621344">mp</span>&nbsp;<span class="op" id="1621347">:=</span>&nbsp;<span class="ident" id="1621350">b</span><span class="op" id="1621351">.</span><span class="ident" id="1621352">mp</span><span class="op" id="1621354">(</span><span class="op" id="1621355">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621359">mp</span><span class="op" id="1621361">.</span><span class="ident" id="1621362">allocs</span>&nbsp;<span class="op" id="1621369">+=</span>&nbsp;<span class="ident" id="1621372">mp</span><span class="op" id="1621374">.</span><span class="ident" id="1621375">prev_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621389">mp</span><span class="op" id="1621391">.</span><span class="ident" id="1621392">frees</span>&nbsp;<span class="op" id="1621398">+=</span>&nbsp;<span class="ident" id="1621401">mp</span><span class="op" id="1621403">.</span><span class="ident" id="1621404">prev_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621417">mp</span><span class="op" id="1621419">.</span><span class="ident" id="1621420">alloc_bytes</span>&nbsp;<span class="op" id="1621432">+=</span>&nbsp;<span class="ident" id="1621435">mp</span><span class="op" id="1621437">.</span><span class="ident" id="1621438">prev_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621457">mp</span><span class="op" id="1621459">.</span><span class="ident" id="1621460">free_bytes</span>&nbsp;<span class="op" id="1621471">+=</span>&nbsp;<span class="ident" id="1621474">mp</span><span class="op" id="1621476">.</span><span class="ident" id="1621477">prev_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621496">mp</span><span class="op" id="1621498">.</span><span class="ident" id="1621499">prev_allocs</span>&nbsp;<span class="op" id="1621511">=</span>&nbsp;<span class="ident" id="1621513">mp</span><span class="op" id="1621515">.</span><span class="ident" id="1621516">recent_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621532">mp</span><span class="op" id="1621534">.</span><span class="ident" id="1621535">prev_frees</span>&nbsp;<span class="op" id="1621546">=</span>&nbsp;<span class="ident" id="1621548">mp</span><span class="op" id="1621550">.</span><span class="ident" id="1621551">recent_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621566">mp</span><span class="op" id="1621568">.</span><span class="ident" id="1621569">prev_alloc_bytes</span>&nbsp;<span class="op" id="1621586">=</span>&nbsp;<span class="ident" id="1621588">mp</span><span class="op" id="1621590">.</span><span class="ident" id="1621591">recent_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621612">mp</span><span class="op" id="1621614">.</span><span class="ident" id="1621615">prev_free_bytes</span>&nbsp;<span class="op" id="1621631">=</span>&nbsp;<span class="ident" id="1621633">mp</span><span class="op" id="1621635">.</span><span class="ident" id="1621636">recent_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621657">mp</span><span class="op" id="1621659">.</span><span class="ident" id="1621660">recent_allocs</span>&nbsp;<span class="op" id="1621674">=</span>&nbsp;<span class="num" id="1621676">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621680">mp</span><span class="op" id="1621682">.</span><span class="ident" id="1621683">recent_frees</span>&nbsp;<span class="op" id="1621696">=</span>&nbsp;<span class="num" id="1621698">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621702">mp</span><span class="op" id="1621704">.</span><span class="ident" id="1621705">recent_alloc_bytes</span>&nbsp;<span class="op" id="1621724">=</span>&nbsp;<span class="num" id="1621726">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621730">mp</span><span class="op" id="1621732">.</span><span class="ident" id="1621733">recent_free_bytes</span>&nbsp;<span class="op" id="1621751">=</span>&nbsp;<span class="num" id="1621753">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621756">}</span><br>
<span class="lineno">225</span><span class="op" id="1621758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1621761">//&nbsp;Record&nbsp;that&nbsp;a&nbsp;gc&nbsp;just&nbsp;happened:&nbsp;all&nbsp;the&nbsp;&#39;recent&#39;&nbsp;statistics&nbsp;are&nbsp;now&nbsp;real.</span><br>
<span class="lineno"></span><span class="keyword" id="1621838">func</span>&nbsp;<span class="ident" id="1621843">mProf_GC</span><span class="op" id="1621851">(</span><span class="op" id="1621852">)</span>&nbsp;<span class="op" id="1621854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621857">lock</span><span class="op" id="1621861">(</span><span class="op" id="1621862">&amp;</span><span class="ident" id="1621863">proflock</span><span class="op" id="1621871">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621874">mprof_GC</span><span class="op" id="1621882">(</span><span class="op" id="1621883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621886">unlock</span><span class="op" id="1621892">(</span><span class="op" id="1621893">&amp;</span><span class="ident" id="1621894">proflock</span><span class="op" id="1621902">)</span><br>
<span class="lineno"></span><span class="op" id="1621904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1621907">//&nbsp;Called&nbsp;by&nbsp;malloc&nbsp;to&nbsp;record&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno">235</span><span class="keyword" id="1621955">func</span>&nbsp;<span class="ident" id="1621960">mProf_Malloc</span><span class="op" id="1621972">(</span><span class="ident" id="1621973">p</span>&nbsp;<span class="ident" id="1621975">unsafe</span><span class="op" id="1621981">.</span><span class="ident" id="1621982">Pointer</span><span class="op" id="1621989">,</span>&nbsp;<span class="ident" id="1621991">size</span>&nbsp;<span class="builtintype" id="1621996">uintptr</span><span class="op" id="1622003">)</span>&nbsp;<span class="op" id="1622005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622008">var</span>&nbsp;<span class="ident" id="1622012">stk</span>&nbsp;<span class="op" id="1622016">[</span><span class="ident" id="1622017">maxStack</span><span class="op" id="1622025">]</span><span class="builtintype" id="1622026">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622035">nstk</span>&nbsp;<span class="op" id="1622040">:=</span>&nbsp;<span class="ident" id="1622043">callers</span><span class="op" id="1622050">(</span><span class="num" id="1622051">4</span><span class="op" id="1622052">,</span>&nbsp;<span class="op" id="1622054">&amp;</span><span class="ident" id="1622055">stk</span><span class="op" id="1622058">[</span><span class="num" id="1622059">0</span><span class="op" id="1622060">]</span><span class="op" id="1622061">,</span>&nbsp;<span class="builtinfunc" id="1622063">len</span><span class="op" id="1622066">(</span><span class="ident" id="1622067">stk</span><span class="op" id="1622070">)</span><span class="op" id="1622071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622074">lock</span><span class="op" id="1622078">(</span><span class="op" id="1622079">&amp;</span><span class="ident" id="1622080">proflock</span><span class="op" id="1622088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622091">b</span>&nbsp;<span class="op" id="1622093">:=</span>&nbsp;<span class="ident" id="1622096">stkbucket</span><span class="op" id="1622105">(</span><span class="ident" id="1622106">memProfile</span><span class="op" id="1622116">,</span>&nbsp;<span class="ident" id="1622118">size</span><span class="op" id="1622122">,</span>&nbsp;<span class="ident" id="1622124">stk</span><span class="op" id="1622127">[</span><span class="op" id="1622128">:</span><span class="ident" id="1622129">nstk</span><span class="op" id="1622133">]</span><span class="op" id="1622134">,</span>&nbsp;<span class="builtintype" id="1622136">true</span><span class="op" id="1622140">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622143">mp</span>&nbsp;<span class="op" id="1622146">:=</span>&nbsp;<span class="ident" id="1622149">b</span><span class="op" id="1622150">.</span><span class="ident" id="1622151">mp</span><span class="op" id="1622153">(</span><span class="op" id="1622154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622157">mp</span><span class="op" id="1622159">.</span><span class="ident" id="1622160">recent_allocs</span><span class="op" id="1622173">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622177">mp</span><span class="op" id="1622179">.</span><span class="ident" id="1622180">recent_alloc_bytes</span>&nbsp;<span class="op" id="1622199">+=</span>&nbsp;<span class="ident" id="1622202">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622208">unlock</span><span class="op" id="1622214">(</span><span class="op" id="1622215">&amp;</span><span class="ident" id="1622216">proflock</span><span class="op" id="1622224">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1622228">//&nbsp;Setprofilebucket&nbsp;locks&nbsp;a&nbsp;bunch&nbsp;of&nbsp;other&nbsp;mutexes,&nbsp;so&nbsp;we&nbsp;call&nbsp;it&nbsp;outside&nbsp;of&nbsp;proflock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1622316">//&nbsp;This&nbsp;reduces&nbsp;potential&nbsp;contention&nbsp;and&nbsp;chances&nbsp;of&nbsp;deadlocks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1622380">//&nbsp;Since&nbsp;the&nbsp;object&nbsp;must&nbsp;be&nbsp;alive&nbsp;during&nbsp;call&nbsp;to&nbsp;mProf_Malloc,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1622444">//&nbsp;it&#39;s&nbsp;fine&nbsp;to&nbsp;do&nbsp;this&nbsp;non-atomically.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622485">setprofilebucket</span><span class="op" id="1622501">(</span><span class="ident" id="1622502">p</span><span class="op" id="1622503">,</span>&nbsp;<span class="ident" id="1622505">b</span><span class="op" id="1622506">)</span><br>
<span class="lineno">250</span><span class="op" id="1622508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1622511">func</span>&nbsp;<span class="ident" id="1622516">setprofilebucket_m</span><span class="op" id="1622534">(</span><span class="op" id="1622535">)</span>&nbsp;<span class="comment" id="1622537">//&nbsp;mheap.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1622549">func</span>&nbsp;<span class="ident" id="1622554">setprofilebucket</span><span class="op" id="1622570">(</span><span class="ident" id="1622571">p</span>&nbsp;<span class="ident" id="1622573">unsafe</span><span class="op" id="1622579">.</span><span class="ident" id="1622580">Pointer</span><span class="op" id="1622587">,</span>&nbsp;<span class="ident" id="1622589">b</span>&nbsp;<span class="op" id="1622591">*</span><span class="ident" id="1622592">bucket</span><span class="op" id="1622598">)</span>&nbsp;<span class="op" id="1622600">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622603">g</span>&nbsp;<span class="op" id="1622605">:=</span>&nbsp;<span class="ident" id="1622608">getg</span><span class="op" id="1622612">(</span><span class="op" id="1622613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622616">g</span><span class="op" id="1622617">.</span><span class="ident" id="1622618">m</span><span class="op" id="1622619">.</span><span class="ident" id="1622620">ptrarg</span><span class="op" id="1622626">[</span><span class="num" id="1622627">0</span><span class="op" id="1622628">]</span>&nbsp;<span class="op" id="1622630">=</span>&nbsp;<span class="ident" id="1622632">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622635">g</span><span class="op" id="1622636">.</span><span class="ident" id="1622637">m</span><span class="op" id="1622638">.</span><span class="ident" id="1622639">ptrarg</span><span class="op" id="1622645">[</span><span class="num" id="1622646">1</span><span class="op" id="1622647">]</span>&nbsp;<span class="op" id="1622649">=</span>&nbsp;<span class="ident" id="1622651">unsafe</span><span class="op" id="1622657">.</span><span class="ident" id="1622658">Pointer</span><span class="op" id="1622665">(</span><span class="ident" id="1622666">b</span><span class="op" id="1622667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622670">onM</span><span class="op" id="1622673">(</span><span class="ident" id="1622674">setprofilebucket_m</span><span class="op" id="1622692">)</span><br>
<span class="lineno"></span><span class="op" id="1622694">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="1622697">//&nbsp;Called&nbsp;when&nbsp;freeing&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="1622738">func</span>&nbsp;<span class="ident" id="1622743">mProf_Free</span><span class="op" id="1622753">(</span><span class="ident" id="1622754">b</span>&nbsp;<span class="op" id="1622756">*</span><span class="ident" id="1622757">bucket</span><span class="op" id="1622763">,</span>&nbsp;<span class="ident" id="1622765">size</span>&nbsp;<span class="builtintype" id="1622770">uintptr</span><span class="op" id="1622777">,</span>&nbsp;<span class="ident" id="1622779">freed</span>&nbsp;<span class="builtintype" id="1622785">bool</span><span class="op" id="1622789">)</span>&nbsp;<span class="op" id="1622791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622794">lock</span><span class="op" id="1622798">(</span><span class="op" id="1622799">&amp;</span><span class="ident" id="1622800">proflock</span><span class="op" id="1622808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622811">mp</span>&nbsp;<span class="op" id="1622814">:=</span>&nbsp;<span class="ident" id="1622817">b</span><span class="op" id="1622818">.</span><span class="ident" id="1622819">mp</span><span class="op" id="1622821">(</span><span class="op" id="1622822">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622825">if</span>&nbsp;<span class="ident" id="1622828">freed</span>&nbsp;<span class="op" id="1622834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622838">mp</span><span class="op" id="1622840">.</span><span class="ident" id="1622841">recent_frees</span><span class="op" id="1622853">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622858">mp</span><span class="op" id="1622860">.</span><span class="ident" id="1622861">recent_free_bytes</span>&nbsp;<span class="op" id="1622879">+=</span>&nbsp;<span class="ident" id="1622882">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622888">}</span>&nbsp;<span class="keyword" id="1622890">else</span>&nbsp;<span class="op" id="1622895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622899">mp</span><span class="op" id="1622901">.</span><span class="ident" id="1622902">prev_frees</span><span class="op" id="1622912">++</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622917">mp</span><span class="op" id="1622919">.</span><span class="ident" id="1622920">prev_free_bytes</span>&nbsp;<span class="op" id="1622936">+=</span>&nbsp;<span class="ident" id="1622939">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622948">unlock</span><span class="op" id="1622954">(</span><span class="op" id="1622955">&amp;</span><span class="ident" id="1622956">proflock</span><span class="op" id="1622964">)</span><br>
<span class="lineno"></span><span class="op" id="1622966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="1622969">var</span>&nbsp;<span class="ident" id="1622973">blockprofilerate</span>&nbsp;<span class="ident" id="1622990">uint64</span>&nbsp;<span class="comment" id="1622997">//&nbsp;in&nbsp;CPU&nbsp;ticks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1623014">//&nbsp;SetBlockProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;goroutine&nbsp;blocking&nbsp;events</span><br>
<span class="lineno"></span><span class="comment" id="1623088">//&nbsp;that&nbsp;are&nbsp;reported&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.&nbsp;&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample</span><br>
<span class="lineno"></span><span class="comment" id="1623163">//&nbsp;an&nbsp;average&nbsp;of&nbsp;one&nbsp;blocking&nbsp;event&nbsp;per&nbsp;rate&nbsp;nanoseconds&nbsp;spent&nbsp;blocked.</span><br>
<span class="lineno">280</span><span class="comment" id="1623235">//</span><br>
<span class="lineno"></span><span class="comment" id="1623238">//&nbsp;To&nbsp;include&nbsp;every&nbsp;blocking&nbsp;event&nbsp;in&nbsp;the&nbsp;profile,&nbsp;pass&nbsp;rate&nbsp;=&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1623304">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;pass&nbsp;rate&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="1623355">func</span>&nbsp;<span class="ident" id="1623360">SetBlockProfileRate</span><span class="op" id="1623379">(</span><span class="ident" id="1623380">rate</span>&nbsp;<span class="builtintype" id="1623385">int</span><span class="op" id="1623388">)</span>&nbsp;<span class="op" id="1623390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623393">var</span>&nbsp;<span class="ident" id="1623397">r</span>&nbsp;<span class="ident" id="1623399">int64</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623406">if</span>&nbsp;<span class="ident" id="1623409">rate</span>&nbsp;<span class="op" id="1623414">&lt;=</span>&nbsp;<span class="num" id="1623417">0</span>&nbsp;<span class="op" id="1623419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623423">r</span>&nbsp;<span class="op" id="1623425">=</span>&nbsp;<span class="num" id="1623427">0</span>&nbsp;<span class="comment" id="1623429">//&nbsp;disable&nbsp;profiling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623451">}</span>&nbsp;<span class="keyword" id="1623453">else</span>&nbsp;<span class="keyword" id="1623458">if</span>&nbsp;<span class="ident" id="1623461">rate</span>&nbsp;<span class="op" id="1623466">==</span>&nbsp;<span class="num" id="1623469">1</span>&nbsp;<span class="op" id="1623471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623475">r</span>&nbsp;<span class="op" id="1623477">=</span>&nbsp;<span class="num" id="1623479">1</span>&nbsp;<span class="comment" id="1623481">//&nbsp;profile&nbsp;everything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623504">}</span>&nbsp;<span class="keyword" id="1623506">else</span>&nbsp;<span class="op" id="1623511">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1623515">//&nbsp;convert&nbsp;ns&nbsp;to&nbsp;cycles,&nbsp;use&nbsp;float64&nbsp;to&nbsp;prevent&nbsp;overflow&nbsp;during&nbsp;multiplication</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623596">r</span>&nbsp;<span class="op" id="1623598">=</span>&nbsp;<span class="ident" id="1623600">int64</span><span class="op" id="1623605">(</span><span class="builtintype" id="1623606">float64</span><span class="op" id="1623613">(</span><span class="ident" id="1623614">rate</span><span class="op" id="1623618">)</span>&nbsp;<span class="op" id="1623620">*</span>&nbsp;<span class="builtintype" id="1623622">float64</span><span class="op" id="1623629">(</span><span class="ident" id="1623630">tickspersecond</span><span class="op" id="1623644">(</span><span class="op" id="1623645">)</span><span class="op" id="1623646">)</span>&nbsp;<span class="op" id="1623648">/</span>&nbsp;<span class="op" id="1623650">(</span><span class="num" id="1623651">1000</span>&nbsp;<span class="op" id="1623656">*</span>&nbsp;<span class="num" id="1623658">1000</span>&nbsp;<span class="op" id="1623663">*</span>&nbsp;<span class="num" id="1623665">1000</span><span class="op" id="1623669">)</span><span class="op" id="1623670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623674">if</span>&nbsp;<span class="ident" id="1623677">r</span>&nbsp;<span class="op" id="1623679">==</span>&nbsp;<span class="num" id="1623682">0</span>&nbsp;<span class="op" id="1623684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623689">r</span>&nbsp;<span class="op" id="1623691">=</span>&nbsp;<span class="num" id="1623693">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623697">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623704">atomicstore64</span><span class="op" id="1623717">(</span><span class="op" id="1623718">&amp;</span><span class="ident" id="1623719">blockprofilerate</span><span class="op" id="1623735">,</span>&nbsp;<span class="ident" id="1623737">uint64</span><span class="op" id="1623743">(</span><span class="ident" id="1623744">r</span><span class="op" id="1623745">)</span><span class="op" id="1623746">)</span><br>
<span class="lineno"></span><span class="op" id="1623748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="keyword" id="1623751">func</span>&nbsp;<span class="ident" id="1623756">blockevent</span><span class="op" id="1623766">(</span><span class="ident" id="1623767">cycles</span>&nbsp;<span class="ident" id="1623774">int64</span><span class="op" id="1623779">,</span>&nbsp;<span class="ident" id="1623781">skip</span>&nbsp;<span class="builtintype" id="1623786">int</span><span class="op" id="1623789">)</span>&nbsp;<span class="op" id="1623791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623794">if</span>&nbsp;<span class="ident" id="1623797">cycles</span>&nbsp;<span class="op" id="1623804">&lt;=</span>&nbsp;<span class="num" id="1623807">0</span>&nbsp;<span class="op" id="1623809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623813">cycles</span>&nbsp;<span class="op" id="1623820">=</span>&nbsp;<span class="num" id="1623822">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623828">rate</span>&nbsp;<span class="op" id="1623833">:=</span>&nbsp;<span class="ident" id="1623836">int64</span><span class="op" id="1623841">(</span><span class="ident" id="1623842">atomicload64</span><span class="op" id="1623854">(</span><span class="op" id="1623855">&amp;</span><span class="ident" id="1623856">blockprofilerate</span><span class="op" id="1623872">)</span><span class="op" id="1623873">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623876">if</span>&nbsp;<span class="ident" id="1623879">rate</span>&nbsp;<span class="op" id="1623884">&lt;=</span>&nbsp;<span class="num" id="1623887">0</span>&nbsp;<span class="op" id="1623889">||</span>&nbsp;<span class="op" id="1623892">(</span><span class="ident" id="1623893">rate</span>&nbsp;<span class="op" id="1623898">&gt;</span>&nbsp;<span class="ident" id="1623900">cycles</span>&nbsp;<span class="op" id="1623907">&amp;&amp;</span>&nbsp;<span class="ident" id="1623910">int64</span><span class="op" id="1623915">(</span><span class="ident" id="1623916">fastrand1</span><span class="op" id="1623925">(</span><span class="op" id="1623926">)</span><span class="op" id="1623927">)</span><span class="op" id="1623928">%</span><span class="ident" id="1623929">rate</span>&nbsp;<span class="op" id="1623934">&gt;</span>&nbsp;<span class="ident" id="1623936">cycles</span><span class="op" id="1623942">)</span>&nbsp;<span class="op" id="1623944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623948">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623959">gp</span>&nbsp;<span class="op" id="1623962">:=</span>&nbsp;<span class="ident" id="1623965">getg</span><span class="op" id="1623969">(</span><span class="op" id="1623970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623973">var</span>&nbsp;<span class="ident" id="1623977">nstk</span>&nbsp;<span class="builtintype" id="1623982">int</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623987">var</span>&nbsp;<span class="ident" id="1623991">stk</span>&nbsp;<span class="op" id="1623995">[</span><span class="ident" id="1623996">maxStack</span><span class="op" id="1624004">]</span><span class="builtintype" id="1624005">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1624014">if</span>&nbsp;<span class="ident" id="1624017">gp</span><span class="op" id="1624019">.</span><span class="ident" id="1624020">m</span><span class="op" id="1624021">.</span><span class="ident" id="1624022">curg</span>&nbsp;<span class="op" id="1624027">==</span>&nbsp;<span class="ident" id="1624030">nil</span>&nbsp;<span class="op" id="1624034">||</span>&nbsp;<span class="ident" id="1624037">gp</span><span class="op" id="1624039">.</span><span class="ident" id="1624040">m</span><span class="op" id="1624041">.</span><span class="ident" id="1624042">curg</span>&nbsp;<span class="op" id="1624047">==</span>&nbsp;<span class="ident" id="1624050">gp</span>&nbsp;<span class="op" id="1624053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624057">nstk</span>&nbsp;<span class="op" id="1624062">=</span>&nbsp;<span class="ident" id="1624064">callers</span><span class="op" id="1624071">(</span><span class="ident" id="1624072">skip</span><span class="op" id="1624076">,</span>&nbsp;<span class="op" id="1624078">&amp;</span><span class="ident" id="1624079">stk</span><span class="op" id="1624082">[</span><span class="num" id="1624083">0</span><span class="op" id="1624084">]</span><span class="op" id="1624085">,</span>&nbsp;<span class="builtinfunc" id="1624087">len</span><span class="op" id="1624090">(</span><span class="ident" id="1624091">stk</span><span class="op" id="1624094">)</span><span class="op" id="1624095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1624098">}</span>&nbsp;<span class="keyword" id="1624100">else</span>&nbsp;<span class="op" id="1624105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624109">nstk</span>&nbsp;<span class="op" id="1624114">=</span>&nbsp;<span class="ident" id="1624116">gcallers</span><span class="op" id="1624124">(</span><span class="ident" id="1624125">gp</span><span class="op" id="1624127">.</span><span class="ident" id="1624128">m</span><span class="op" id="1624129">.</span><span class="ident" id="1624130">curg</span><span class="op" id="1624134">,</span>&nbsp;<span class="ident" id="1624136">skip</span><span class="op" id="1624140">,</span>&nbsp;<span class="op" id="1624142">&amp;</span><span class="ident" id="1624143">stk</span><span class="op" id="1624146">[</span><span class="num" id="1624147">0</span><span class="op" id="1624148">]</span><span class="op" id="1624149">,</span>&nbsp;<span class="builtinfunc" id="1624151">len</span><span class="op" id="1624154">(</span><span class="ident" id="1624155">stk</span><span class="op" id="1624158">)</span><span class="op" id="1624159">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1624162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624165">lock</span><span class="op" id="1624169">(</span><span class="op" id="1624170">&amp;</span><span class="ident" id="1624171">proflock</span><span class="op" id="1624179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624182">b</span>&nbsp;<span class="op" id="1624184">:=</span>&nbsp;<span class="ident" id="1624187">stkbucket</span><span class="op" id="1624196">(</span><span class="ident" id="1624197">blockProfile</span><span class="op" id="1624209">,</span>&nbsp;<span class="num" id="1624211">0</span><span class="op" id="1624212">,</span>&nbsp;<span class="ident" id="1624214">stk</span><span class="op" id="1624217">[</span><span class="op" id="1624218">:</span><span class="ident" id="1624219">nstk</span><span class="op" id="1624223">]</span><span class="op" id="1624224">,</span>&nbsp;<span class="builtintype" id="1624226">true</span><span class="op" id="1624230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624233">b</span><span class="op" id="1624234">.</span><span class="ident" id="1624235">bp</span><span class="op" id="1624237">(</span><span class="op" id="1624238">)</span><span class="op" id="1624239">.</span><span class="ident" id="1624240">count</span><span class="op" id="1624245">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624249">b</span><span class="op" id="1624250">.</span><span class="ident" id="1624251">bp</span><span class="op" id="1624253">(</span><span class="op" id="1624254">)</span><span class="op" id="1624255">.</span><span class="ident" id="1624256">cycles</span>&nbsp;<span class="op" id="1624263">+=</span>&nbsp;<span class="ident" id="1624266">cycles</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624274">unlock</span><span class="op" id="1624280">(</span><span class="op" id="1624281">&amp;</span><span class="ident" id="1624282">proflock</span><span class="op" id="1624290">)</span><br>
<span class="lineno"></span><span class="op" id="1624292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1624295">//&nbsp;Go&nbsp;interface&nbsp;to&nbsp;profile&nbsp;data.</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="1624329">//&nbsp;A&nbsp;StackRecord&nbsp;describes&nbsp;a&nbsp;single&nbsp;execution&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1624382">type</span>&nbsp;<span class="ident" id="1624387">StackRecord</span>&nbsp;<span class="keyword" id="1624399">struct</span>&nbsp;<span class="op" id="1624406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624409">Stack0</span>&nbsp;<span class="op" id="1624416">[</span><span class="num" id="1624417">32</span><span class="op" id="1624419">]</span><span class="builtintype" id="1624420">uintptr</span>&nbsp;<span class="comment" id="1624428">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1624482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="1624485">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1624546">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno"></span><span class="keyword" id="1624571">func</span>&nbsp;<span class="op" id="1624576">(</span><span class="ident" id="1624577">r</span>&nbsp;<span class="op" id="1624579">*</span><span class="ident" id="1624580">StackRecord</span><span class="op" id="1624591">)</span>&nbsp;<span class="ident" id="1624593">Stack</span><span class="op" id="1624598">(</span><span class="op" id="1624599">)</span>&nbsp;<span class="op" id="1624601">[</span><span class="op" id="1624602">]</span><span class="builtintype" id="1624603">uintptr</span>&nbsp;<span class="op" id="1624611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1624614">for</span>&nbsp;<span class="ident" id="1624618">i</span><span class="op" id="1624619">,</span>&nbsp;<span class="ident" id="1624621">v</span>&nbsp;<span class="op" id="1624623">:=</span>&nbsp;<span class="keyword" id="1624626">range</span>&nbsp;<span class="ident" id="1624632">r</span><span class="op" id="1624633">.</span><span class="ident" id="1624634">Stack0</span>&nbsp;<span class="op" id="1624641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1624645">if</span>&nbsp;<span class="ident" id="1624648">v</span>&nbsp;<span class="op" id="1624650">==</span>&nbsp;<span class="num" id="1624653">0</span>&nbsp;<span class="op" id="1624655">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1624660">return</span>&nbsp;<span class="ident" id="1624667">r</span><span class="op" id="1624668">.</span><span class="ident" id="1624669">Stack0</span><span class="op" id="1624675">[</span><span class="num" id="1624676">0</span><span class="op" id="1624677">:</span><span class="ident" id="1624678">i</span><span class="op" id="1624679">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1624683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1624686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1624689">return</span>&nbsp;<span class="ident" id="1624696">r</span><span class="op" id="1624697">.</span><span class="ident" id="1624698">Stack0</span><span class="op" id="1624704">[</span><span class="num" id="1624705">0</span><span class="op" id="1624706">:</span><span class="op" id="1624707">]</span><br>
<span class="lineno"></span><span class="op" id="1624709">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="comment" id="1624712">//&nbsp;MemProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;memory&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="1624774">//&nbsp;that&nbsp;are&nbsp;recorded&nbsp;and&nbsp;reported&nbsp;in&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1624831">//&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample&nbsp;an&nbsp;average&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1624876">//&nbsp;one&nbsp;allocation&nbsp;per&nbsp;MemProfileRate&nbsp;bytes&nbsp;allocated.</span><br>
<span class="lineno">345</span><span class="comment" id="1624930">//</span><br>
<span class="lineno"></span><span class="comment" id="1624933">//&nbsp;To&nbsp;include&nbsp;every&nbsp;allocated&nbsp;block&nbsp;in&nbsp;the&nbsp;profile,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1625010">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1625070">//</span><br>
<span class="lineno"></span><span class="comment" id="1625073">//&nbsp;The&nbsp;tools&nbsp;that&nbsp;process&nbsp;the&nbsp;memory&nbsp;profiles&nbsp;assume&nbsp;that&nbsp;the</span><br>
<span class="lineno">350</span><span class="comment" id="1625135">//&nbsp;profile&nbsp;rate&nbsp;is&nbsp;constant&nbsp;across&nbsp;the&nbsp;lifetime&nbsp;of&nbsp;the&nbsp;program</span><br>
<span class="lineno"></span><span class="comment" id="1625198">//&nbsp;and&nbsp;equal&nbsp;to&nbsp;the&nbsp;current&nbsp;value.&nbsp;&nbsp;Programs&nbsp;that&nbsp;change&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1625259">//&nbsp;memory&nbsp;profiling&nbsp;rate&nbsp;should&nbsp;do&nbsp;so&nbsp;just&nbsp;once,&nbsp;as&nbsp;early&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1625320">//&nbsp;possible&nbsp;in&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;program&nbsp;(for&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="1625378">//&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;main).</span><br>
<span class="lineno">355</span><span class="keyword" id="1625408">var</span>&nbsp;<span class="ident" id="1625412">MemProfileRate</span>&nbsp;<span class="builtintype" id="1625427">int</span>&nbsp;<span class="op" id="1625431">=</span>&nbsp;<span class="num" id="1625433">512</span>&nbsp;<span class="op" id="1625437">*</span>&nbsp;<span class="num" id="1625439">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1625445">//&nbsp;A&nbsp;MemProfileRecord&nbsp;describes&nbsp;the&nbsp;live&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1625504">//&nbsp;by&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1625552">type</span>&nbsp;<span class="ident" id="1625557">MemProfileRecord</span>&nbsp;<span class="keyword" id="1625574">struct</span>&nbsp;<span class="op" id="1625581">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625584">AllocBytes</span><span class="op" id="1625594">,</span>&nbsp;<span class="ident" id="1625596">FreeBytes</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1625610">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1625622">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625659">AllocObjects</span><span class="op" id="1625671">,</span>&nbsp;<span class="ident" id="1625673">FreeObjects</span>&nbsp;<span class="ident" id="1625685">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1625697">//&nbsp;number&nbsp;of&nbsp;objects&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625736">Stack0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1625762">[</span><span class="num" id="1625763">32</span><span class="op" id="1625765">]</span><span class="builtintype" id="1625766">uintptr</span>&nbsp;<span class="comment" id="1625774">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1625828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="1625831">//&nbsp;InUseBytes&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;use&nbsp;(AllocBytes&nbsp;-&nbsp;FreeBytes).</span><br>
<span class="lineno"></span><span class="keyword" id="1625906">func</span>&nbsp;<span class="op" id="1625911">(</span><span class="ident" id="1625912">r</span>&nbsp;<span class="op" id="1625914">*</span><span class="ident" id="1625915">MemProfileRecord</span><span class="op" id="1625931">)</span>&nbsp;<span class="ident" id="1625933">InUseBytes</span><span class="op" id="1625943">(</span><span class="op" id="1625944">)</span>&nbsp;<span class="ident" id="1625946">int64</span>&nbsp;<span class="op" id="1625952">{</span>&nbsp;<span class="keyword" id="1625954">return</span>&nbsp;<span class="ident" id="1625961">r</span><span class="op" id="1625962">.</span><span class="ident" id="1625963">AllocBytes</span>&nbsp;<span class="op" id="1625974">-</span>&nbsp;<span class="ident" id="1625976">r</span><span class="op" id="1625977">.</span><span class="ident" id="1625978">FreeBytes</span>&nbsp;<span class="op" id="1625988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1625991">//&nbsp;InUseObjects&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;objects&nbsp;in&nbsp;use&nbsp;(AllocObjects&nbsp;-&nbsp;FreeObjects).</span><br>
<span class="lineno"></span><span class="keyword" id="1626074">func</span>&nbsp;<span class="op" id="1626079">(</span><span class="ident" id="1626080">r</span>&nbsp;<span class="op" id="1626082">*</span><span class="ident" id="1626083">MemProfileRecord</span><span class="op" id="1626099">)</span>&nbsp;<span class="ident" id="1626101">InUseObjects</span><span class="op" id="1626113">(</span><span class="op" id="1626114">)</span>&nbsp;<span class="ident" id="1626116">int64</span>&nbsp;<span class="op" id="1626122">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626125">return</span>&nbsp;<span class="ident" id="1626132">r</span><span class="op" id="1626133">.</span><span class="ident" id="1626134">AllocObjects</span>&nbsp;<span class="op" id="1626147">-</span>&nbsp;<span class="ident" id="1626149">r</span><span class="op" id="1626150">.</span><span class="ident" id="1626151">FreeObjects</span><br>
<span class="lineno"></span><span class="op" id="1626163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1626166">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1626227">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno">375</span><span class="keyword" id="1626252">func</span>&nbsp;<span class="op" id="1626257">(</span><span class="ident" id="1626258">r</span>&nbsp;<span class="op" id="1626260">*</span><span class="ident" id="1626261">MemProfileRecord</span><span class="op" id="1626277">)</span>&nbsp;<span class="ident" id="1626279">Stack</span><span class="op" id="1626284">(</span><span class="op" id="1626285">)</span>&nbsp;<span class="op" id="1626287">[</span><span class="op" id="1626288">]</span><span class="builtintype" id="1626289">uintptr</span>&nbsp;<span class="op" id="1626297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626300">for</span>&nbsp;<span class="ident" id="1626304">i</span><span class="op" id="1626305">,</span>&nbsp;<span class="ident" id="1626307">v</span>&nbsp;<span class="op" id="1626309">:=</span>&nbsp;<span class="keyword" id="1626312">range</span>&nbsp;<span class="ident" id="1626318">r</span><span class="op" id="1626319">.</span><span class="ident" id="1626320">Stack0</span>&nbsp;<span class="op" id="1626327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626331">if</span>&nbsp;<span class="ident" id="1626334">v</span>&nbsp;<span class="op" id="1626336">==</span>&nbsp;<span class="num" id="1626339">0</span>&nbsp;<span class="op" id="1626341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626346">return</span>&nbsp;<span class="ident" id="1626353">r</span><span class="op" id="1626354">.</span><span class="ident" id="1626355">Stack0</span><span class="op" id="1626361">[</span><span class="num" id="1626362">0</span><span class="op" id="1626363">:</span><span class="ident" id="1626364">i</span><span class="op" id="1626365">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626369">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626375">return</span>&nbsp;<span class="ident" id="1626382">r</span><span class="op" id="1626383">.</span><span class="ident" id="1626384">Stack0</span><span class="op" id="1626390">[</span><span class="num" id="1626391">0</span><span class="op" id="1626392">:</span><span class="op" id="1626393">]</span><br>
<span class="lineno"></span><span class="op" id="1626395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1626398">//&nbsp;MemProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno">385</span><span class="comment" id="1626476">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;MemProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1626553">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;MemProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1626622">//</span><br>
<span class="lineno"></span><span class="comment" id="1626625">//&nbsp;If&nbsp;inuseZero&nbsp;is&nbsp;true,&nbsp;the&nbsp;profile&nbsp;includes&nbsp;allocation&nbsp;records</span><br>
<span class="lineno"></span><span class="comment" id="1626690">//&nbsp;where&nbsp;r.AllocBytes&nbsp;&gt;&nbsp;0&nbsp;but&nbsp;r.AllocBytes&nbsp;==&nbsp;r.FreeBytes.</span><br>
<span class="lineno">390</span><span class="comment" id="1626749">//&nbsp;These&nbsp;are&nbsp;sites&nbsp;where&nbsp;memory&nbsp;was&nbsp;allocated,&nbsp;but&nbsp;it&nbsp;has&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="1626811">//&nbsp;been&nbsp;released&nbsp;back&nbsp;to&nbsp;the&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="1626849">//</span><br>
<span class="lineno"></span><span class="comment" id="1626852">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1626908">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.memprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno">395</span><span class="comment" id="1626963">//&nbsp;of&nbsp;calling&nbsp;MemProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1626998">func</span>&nbsp;<span class="ident" id="1627003">MemProfile</span><span class="op" id="1627013">(</span><span class="ident" id="1627014">p</span>&nbsp;<span class="op" id="1627016">[</span><span class="op" id="1627017">]</span><span class="ident" id="1627018">MemProfileRecord</span><span class="op" id="1627034">,</span>&nbsp;<span class="ident" id="1627036">inuseZero</span>&nbsp;<span class="builtintype" id="1627046">bool</span><span class="op" id="1627050">)</span>&nbsp;<span class="op" id="1627052">(</span><span class="ident" id="1627053">n</span>&nbsp;<span class="builtintype" id="1627055">int</span><span class="op" id="1627058">,</span>&nbsp;<span class="ident" id="1627060">ok</span>&nbsp;<span class="builtintype" id="1627063">bool</span><span class="op" id="1627067">)</span>&nbsp;<span class="op" id="1627069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627072">lock</span><span class="op" id="1627076">(</span><span class="op" id="1627077">&amp;</span><span class="ident" id="1627078">proflock</span><span class="op" id="1627086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627089">clear</span>&nbsp;<span class="op" id="1627095">:=</span>&nbsp;<span class="builtintype" id="1627098">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627104">for</span>&nbsp;<span class="ident" id="1627108">b</span>&nbsp;<span class="op" id="1627110">:=</span>&nbsp;<span class="ident" id="1627113">mbuckets</span><span class="op" id="1627121">;</span>&nbsp;<span class="ident" id="1627123">b</span>&nbsp;<span class="op" id="1627125">!=</span>&nbsp;<span class="ident" id="1627128">nil</span><span class="op" id="1627131">;</span>&nbsp;<span class="ident" id="1627133">b</span>&nbsp;<span class="op" id="1627135">=</span>&nbsp;<span class="ident" id="1627137">b</span><span class="op" id="1627138">.</span><span class="ident" id="1627139">allnext</span>&nbsp;<span class="op" id="1627147">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627151">mp</span>&nbsp;<span class="op" id="1627154">:=</span>&nbsp;<span class="ident" id="1627157">b</span><span class="op" id="1627158">.</span><span class="ident" id="1627159">mp</span><span class="op" id="1627161">(</span><span class="op" id="1627162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627166">if</span>&nbsp;<span class="ident" id="1627169">inuseZero</span>&nbsp;<span class="op" id="1627179">||</span>&nbsp;<span class="ident" id="1627182">mp</span><span class="op" id="1627184">.</span><span class="ident" id="1627185">alloc_bytes</span>&nbsp;<span class="op" id="1627197">!=</span>&nbsp;<span class="ident" id="1627200">mp</span><span class="op" id="1627202">.</span><span class="ident" id="1627203">free_bytes</span>&nbsp;<span class="op" id="1627214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627219">n</span><span class="op" id="1627220">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627229">if</span>&nbsp;<span class="ident" id="1627232">mp</span><span class="op" id="1627234">.</span><span class="ident" id="1627235">allocs</span>&nbsp;<span class="op" id="1627242">!=</span>&nbsp;<span class="num" id="1627245">0</span>&nbsp;<span class="op" id="1627247">||</span>&nbsp;<span class="ident" id="1627250">mp</span><span class="op" id="1627252">.</span><span class="ident" id="1627253">frees</span>&nbsp;<span class="op" id="1627259">!=</span>&nbsp;<span class="num" id="1627262">0</span>&nbsp;<span class="op" id="1627264">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627269">clear</span>&nbsp;<span class="op" id="1627275">=</span>&nbsp;<span class="builtintype" id="1627277">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627291">if</span>&nbsp;<span class="ident" id="1627294">clear</span>&nbsp;<span class="op" id="1627300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1627304">//&nbsp;Absolutely&nbsp;no&nbsp;data,&nbsp;suggesting&nbsp;that&nbsp;a&nbsp;garbage&nbsp;collection</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1627366">//&nbsp;has&nbsp;not&nbsp;yet&nbsp;happened.&nbsp;In&nbsp;order&nbsp;to&nbsp;allow&nbsp;profiling&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1627426">//&nbsp;garbage&nbsp;collection&nbsp;is&nbsp;disabled&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;execution,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1627495">//&nbsp;accumulate&nbsp;stats&nbsp;as&nbsp;if&nbsp;a&nbsp;GC&nbsp;just&nbsp;happened,&nbsp;and&nbsp;recount&nbsp;buckets.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627564">mprof_GC</span><span class="op" id="1627572">(</span><span class="op" id="1627573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627577">mprof_GC</span><span class="op" id="1627585">(</span><span class="op" id="1627586">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627590">n</span>&nbsp;<span class="op" id="1627592">=</span>&nbsp;<span class="num" id="1627594">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627598">for</span>&nbsp;<span class="ident" id="1627602">b</span>&nbsp;<span class="op" id="1627604">:=</span>&nbsp;<span class="ident" id="1627607">mbuckets</span><span class="op" id="1627615">;</span>&nbsp;<span class="ident" id="1627617">b</span>&nbsp;<span class="op" id="1627619">!=</span>&nbsp;<span class="ident" id="1627622">nil</span><span class="op" id="1627625">;</span>&nbsp;<span class="ident" id="1627627">b</span>&nbsp;<span class="op" id="1627629">=</span>&nbsp;<span class="ident" id="1627631">b</span><span class="op" id="1627632">.</span><span class="ident" id="1627633">allnext</span>&nbsp;<span class="op" id="1627641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627646">mp</span>&nbsp;<span class="op" id="1627649">:=</span>&nbsp;<span class="ident" id="1627652">b</span><span class="op" id="1627653">.</span><span class="ident" id="1627654">mp</span><span class="op" id="1627656">(</span><span class="op" id="1627657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627662">if</span>&nbsp;<span class="ident" id="1627665">inuseZero</span>&nbsp;<span class="op" id="1627675">||</span>&nbsp;<span class="ident" id="1627678">mp</span><span class="op" id="1627680">.</span><span class="ident" id="1627681">alloc_bytes</span>&nbsp;<span class="op" id="1627693">!=</span>&nbsp;<span class="ident" id="1627696">mp</span><span class="op" id="1627698">.</span><span class="ident" id="1627699">free_bytes</span>&nbsp;<span class="op" id="1627710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627716">n</span><span class="op" id="1627717">++</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627733">if</span>&nbsp;<span class="ident" id="1627736">n</span>&nbsp;<span class="op" id="1627738">&lt;=</span>&nbsp;<span class="builtinfunc" id="1627741">len</span><span class="op" id="1627744">(</span><span class="ident" id="1627745">p</span><span class="op" id="1627746">)</span>&nbsp;<span class="op" id="1627748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627752">ok</span>&nbsp;<span class="op" id="1627755">=</span>&nbsp;<span class="builtintype" id="1627757">true</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627764">idx</span>&nbsp;<span class="op" id="1627768">:=</span>&nbsp;<span class="num" id="1627771">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627775">for</span>&nbsp;<span class="ident" id="1627779">b</span>&nbsp;<span class="op" id="1627781">:=</span>&nbsp;<span class="ident" id="1627784">mbuckets</span><span class="op" id="1627792">;</span>&nbsp;<span class="ident" id="1627794">b</span>&nbsp;<span class="op" id="1627796">!=</span>&nbsp;<span class="ident" id="1627799">nil</span><span class="op" id="1627802">;</span>&nbsp;<span class="ident" id="1627804">b</span>&nbsp;<span class="op" id="1627806">=</span>&nbsp;<span class="ident" id="1627808">b</span><span class="op" id="1627809">.</span><span class="ident" id="1627810">allnext</span>&nbsp;<span class="op" id="1627818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627823">mp</span>&nbsp;<span class="op" id="1627826">:=</span>&nbsp;<span class="ident" id="1627829">b</span><span class="op" id="1627830">.</span><span class="ident" id="1627831">mp</span><span class="op" id="1627833">(</span><span class="op" id="1627834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627839">if</span>&nbsp;<span class="ident" id="1627842">inuseZero</span>&nbsp;<span class="op" id="1627852">||</span>&nbsp;<span class="ident" id="1627855">mp</span><span class="op" id="1627857">.</span><span class="ident" id="1627858">alloc_bytes</span>&nbsp;<span class="op" id="1627870">!=</span>&nbsp;<span class="ident" id="1627873">mp</span><span class="op" id="1627875">.</span><span class="ident" id="1627876">free_bytes</span>&nbsp;<span class="op" id="1627887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627893">record</span><span class="op" id="1627899">(</span><span class="op" id="1627900">&amp;</span><span class="ident" id="1627901">p</span><span class="op" id="1627902">[</span><span class="ident" id="1627903">idx</span><span class="op" id="1627906">]</span><span class="op" id="1627907">,</span>&nbsp;<span class="ident" id="1627909">b</span><span class="op" id="1627910">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627916">idx</span><span class="op" id="1627919">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627935">unlock</span><span class="op" id="1627941">(</span><span class="op" id="1627942">&amp;</span><span class="ident" id="1627943">proflock</span><span class="op" id="1627951">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627954">return</span><br>
<span class="lineno"></span><span class="op" id="1627961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1627964">//&nbsp;Write&nbsp;b&#39;s&nbsp;data&nbsp;to&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="1627988">func</span>&nbsp;<span class="ident" id="1627993">record</span><span class="op" id="1627999">(</span><span class="ident" id="1628000">r</span>&nbsp;<span class="op" id="1628002">*</span><span class="ident" id="1628003">MemProfileRecord</span><span class="op" id="1628019">,</span>&nbsp;<span class="ident" id="1628021">b</span>&nbsp;<span class="op" id="1628023">*</span><span class="ident" id="1628024">bucket</span><span class="op" id="1628030">)</span>&nbsp;<span class="op" id="1628032">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628035">mp</span>&nbsp;<span class="op" id="1628038">:=</span>&nbsp;<span class="ident" id="1628041">b</span><span class="op" id="1628042">.</span><span class="ident" id="1628043">mp</span><span class="op" id="1628045">(</span><span class="op" id="1628046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628049">r</span><span class="op" id="1628050">.</span><span class="ident" id="1628051">AllocBytes</span>&nbsp;<span class="op" id="1628062">=</span>&nbsp;<span class="ident" id="1628064">int64</span><span class="op" id="1628069">(</span><span class="ident" id="1628070">mp</span><span class="op" id="1628072">.</span><span class="ident" id="1628073">alloc_bytes</span><span class="op" id="1628084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628087">r</span><span class="op" id="1628088">.</span><span class="ident" id="1628089">FreeBytes</span>&nbsp;<span class="op" id="1628099">=</span>&nbsp;<span class="ident" id="1628101">int64</span><span class="op" id="1628106">(</span><span class="ident" id="1628107">mp</span><span class="op" id="1628109">.</span><span class="ident" id="1628110">free_bytes</span><span class="op" id="1628120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628123">r</span><span class="op" id="1628124">.</span><span class="ident" id="1628125">AllocObjects</span>&nbsp;<span class="op" id="1628138">=</span>&nbsp;<span class="ident" id="1628140">int64</span><span class="op" id="1628145">(</span><span class="ident" id="1628146">mp</span><span class="op" id="1628148">.</span><span class="ident" id="1628149">allocs</span><span class="op" id="1628155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628158">r</span><span class="op" id="1628159">.</span><span class="ident" id="1628160">FreeObjects</span>&nbsp;<span class="op" id="1628172">=</span>&nbsp;<span class="ident" id="1628174">int64</span><span class="op" id="1628179">(</span><span class="ident" id="1628180">mp</span><span class="op" id="1628182">.</span><span class="ident" id="1628183">frees</span><span class="op" id="1628188">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1628191">copy</span><span class="op" id="1628195">(</span><span class="ident" id="1628196">r</span><span class="op" id="1628197">.</span><span class="ident" id="1628198">Stack0</span><span class="op" id="1628204">[</span><span class="op" id="1628205">:</span><span class="op" id="1628206">]</span><span class="op" id="1628207">,</span>&nbsp;<span class="ident" id="1628209">b</span><span class="op" id="1628210">.</span><span class="ident" id="1628211">stk</span><span class="op" id="1628214">(</span><span class="op" id="1628215">)</span><span class="op" id="1628216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628219">for</span>&nbsp;<span class="ident" id="1628223">i</span>&nbsp;<span class="op" id="1628225">:=</span>&nbsp;<span class="builtintype" id="1628228">int</span><span class="op" id="1628231">(</span><span class="ident" id="1628232">b</span><span class="op" id="1628233">.</span><span class="ident" id="1628234">nstk</span><span class="op" id="1628238">)</span><span class="op" id="1628239">;</span>&nbsp;<span class="ident" id="1628241">i</span>&nbsp;<span class="op" id="1628243">&lt;</span>&nbsp;<span class="builtinfunc" id="1628245">len</span><span class="op" id="1628248">(</span><span class="ident" id="1628249">r</span><span class="op" id="1628250">.</span><span class="ident" id="1628251">Stack0</span><span class="op" id="1628257">)</span><span class="op" id="1628258">;</span>&nbsp;<span class="ident" id="1628260">i</span><span class="op" id="1628261">++</span>&nbsp;<span class="op" id="1628264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628268">r</span><span class="op" id="1628269">.</span><span class="ident" id="1628270">Stack0</span><span class="op" id="1628276">[</span><span class="ident" id="1628277">i</span><span class="op" id="1628278">]</span>&nbsp;<span class="op" id="1628280">=</span>&nbsp;<span class="num" id="1628282">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628285">}</span><br>
<span class="lineno"></span><span class="op" id="1628287">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span><span class="keyword" id="1628290">func</span>&nbsp;<span class="ident" id="1628295">iterate_memprof</span><span class="op" id="1628310">(</span><span class="ident" id="1628311">fn</span>&nbsp;<span class="keyword" id="1628314">func</span><span class="op" id="1628318">(</span><span class="op" id="1628319">*</span><span class="ident" id="1628320">bucket</span><span class="op" id="1628326">,</span>&nbsp;<span class="builtintype" id="1628328">uintptr</span><span class="op" id="1628335">,</span>&nbsp;<span class="op" id="1628337">*</span><span class="builtintype" id="1628338">uintptr</span><span class="op" id="1628345">,</span>&nbsp;<span class="builtintype" id="1628347">uintptr</span><span class="op" id="1628354">,</span>&nbsp;<span class="builtintype" id="1628356">uintptr</span><span class="op" id="1628363">,</span>&nbsp;<span class="builtintype" id="1628365">uintptr</span><span class="op" id="1628372">)</span><span class="op" id="1628373">)</span>&nbsp;<span class="op" id="1628375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628378">lock</span><span class="op" id="1628382">(</span><span class="op" id="1628383">&amp;</span><span class="ident" id="1628384">proflock</span><span class="op" id="1628392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628395">for</span>&nbsp;<span class="ident" id="1628399">b</span>&nbsp;<span class="op" id="1628401">:=</span>&nbsp;<span class="ident" id="1628404">mbuckets</span><span class="op" id="1628412">;</span>&nbsp;<span class="ident" id="1628414">b</span>&nbsp;<span class="op" id="1628416">!=</span>&nbsp;<span class="ident" id="1628419">nil</span><span class="op" id="1628422">;</span>&nbsp;<span class="ident" id="1628424">b</span>&nbsp;<span class="op" id="1628426">=</span>&nbsp;<span class="ident" id="1628428">b</span><span class="op" id="1628429">.</span><span class="ident" id="1628430">allnext</span>&nbsp;<span class="op" id="1628438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628442">mp</span>&nbsp;<span class="op" id="1628445">:=</span>&nbsp;<span class="ident" id="1628448">b</span><span class="op" id="1628449">.</span><span class="ident" id="1628450">mp</span><span class="op" id="1628452">(</span><span class="op" id="1628453">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628457">fn</span><span class="op" id="1628459">(</span><span class="ident" id="1628460">b</span><span class="op" id="1628461">,</span>&nbsp;<span class="builtintype" id="1628463">uintptr</span><span class="op" id="1628470">(</span><span class="ident" id="1628471">b</span><span class="op" id="1628472">.</span><span class="ident" id="1628473">nstk</span><span class="op" id="1628477">)</span><span class="op" id="1628478">,</span>&nbsp;<span class="op" id="1628480">&amp;</span><span class="ident" id="1628481">b</span><span class="op" id="1628482">.</span><span class="ident" id="1628483">stk</span><span class="op" id="1628486">(</span><span class="op" id="1628487">)</span><span class="op" id="1628488">[</span><span class="num" id="1628489">0</span><span class="op" id="1628490">]</span><span class="op" id="1628491">,</span>&nbsp;<span class="ident" id="1628493">b</span><span class="op" id="1628494">.</span><span class="ident" id="1628495">size</span><span class="op" id="1628499">,</span>&nbsp;<span class="ident" id="1628501">mp</span><span class="op" id="1628503">.</span><span class="ident" id="1628504">allocs</span><span class="op" id="1628510">,</span>&nbsp;<span class="ident" id="1628512">mp</span><span class="op" id="1628514">.</span><span class="ident" id="1628515">frees</span><span class="op" id="1628520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628526">unlock</span><span class="op" id="1628532">(</span><span class="op" id="1628533">&amp;</span><span class="ident" id="1628534">proflock</span><span class="op" id="1628542">)</span><br>
<span class="lineno"></span><span class="op" id="1628544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="1628547">//&nbsp;BlockProfileRecord&nbsp;describes&nbsp;blocking&nbsp;events&nbsp;originated</span><br>
<span class="lineno"></span><span class="comment" id="1628606">//&nbsp;at&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1628654">type</span>&nbsp;<span class="ident" id="1628659">BlockProfileRecord</span>&nbsp;<span class="keyword" id="1628678">struct</span>&nbsp;<span class="op" id="1628685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628688">Count</span>&nbsp;&nbsp;<span class="ident" id="1628695">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628702">Cycles</span>&nbsp;<span class="ident" id="1628709">int64</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628716">StackRecord</span><br>
<span class="lineno"></span><span class="op" id="1628728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1628731">//&nbsp;BlockProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1628813">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;BlockProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">470</span><span class="comment" id="1628892">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;BlockProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1628963">//</span><br>
<span class="lineno"></span><span class="comment" id="1628966">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1629022">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.blockprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1629079">//&nbsp;of&nbsp;calling&nbsp;BlockProfile&nbsp;directly.</span><br>
<span class="lineno">475</span><span class="keyword" id="1629116">func</span>&nbsp;<span class="ident" id="1629121">BlockProfile</span><span class="op" id="1629133">(</span><span class="ident" id="1629134">p</span>&nbsp;<span class="op" id="1629136">[</span><span class="op" id="1629137">]</span><span class="ident" id="1629138">BlockProfileRecord</span><span class="op" id="1629156">)</span>&nbsp;<span class="op" id="1629158">(</span><span class="ident" id="1629159">n</span>&nbsp;<span class="builtintype" id="1629161">int</span><span class="op" id="1629164">,</span>&nbsp;<span class="ident" id="1629166">ok</span>&nbsp;<span class="builtintype" id="1629169">bool</span><span class="op" id="1629173">)</span>&nbsp;<span class="op" id="1629175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629178">lock</span><span class="op" id="1629182">(</span><span class="op" id="1629183">&amp;</span><span class="ident" id="1629184">proflock</span><span class="op" id="1629192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1629195">for</span>&nbsp;<span class="ident" id="1629199">b</span>&nbsp;<span class="op" id="1629201">:=</span>&nbsp;<span class="ident" id="1629204">bbuckets</span><span class="op" id="1629212">;</span>&nbsp;<span class="ident" id="1629214">b</span>&nbsp;<span class="op" id="1629216">!=</span>&nbsp;<span class="ident" id="1629219">nil</span><span class="op" id="1629222">;</span>&nbsp;<span class="ident" id="1629224">b</span>&nbsp;<span class="op" id="1629226">=</span>&nbsp;<span class="ident" id="1629228">b</span><span class="op" id="1629229">.</span><span class="ident" id="1629230">allnext</span>&nbsp;<span class="op" id="1629238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629242">n</span><span class="op" id="1629243">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1629247">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1629250">if</span>&nbsp;<span class="ident" id="1629253">n</span>&nbsp;<span class="op" id="1629255">&lt;=</span>&nbsp;<span class="builtinfunc" id="1629258">len</span><span class="op" id="1629261">(</span><span class="ident" id="1629262">p</span><span class="op" id="1629263">)</span>&nbsp;<span class="op" id="1629265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629269">ok</span>&nbsp;<span class="op" id="1629272">=</span>&nbsp;<span class="builtintype" id="1629274">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1629281">for</span>&nbsp;<span class="ident" id="1629285">b</span>&nbsp;<span class="op" id="1629287">:=</span>&nbsp;<span class="ident" id="1629290">bbuckets</span><span class="op" id="1629298">;</span>&nbsp;<span class="ident" id="1629300">b</span>&nbsp;<span class="op" id="1629302">!=</span>&nbsp;<span class="ident" id="1629305">nil</span><span class="op" id="1629308">;</span>&nbsp;<span class="ident" id="1629310">b</span>&nbsp;<span class="op" id="1629312">=</span>&nbsp;<span class="ident" id="1629314">b</span><span class="op" id="1629315">.</span><span class="ident" id="1629316">allnext</span>&nbsp;<span class="op" id="1629324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629329">bp</span>&nbsp;<span class="op" id="1629332">:=</span>&nbsp;<span class="ident" id="1629335">b</span><span class="op" id="1629336">.</span><span class="ident" id="1629337">bp</span><span class="op" id="1629339">(</span><span class="op" id="1629340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629345">r</span>&nbsp;<span class="op" id="1629347">:=</span>&nbsp;<span class="op" id="1629350">&amp;</span><span class="ident" id="1629351">p</span><span class="op" id="1629352">[</span><span class="num" id="1629353">0</span><span class="op" id="1629354">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629359">r</span><span class="op" id="1629360">.</span><span class="ident" id="1629361">Count</span>&nbsp;<span class="op" id="1629367">=</span>&nbsp;<span class="ident" id="1629369">int64</span><span class="op" id="1629374">(</span><span class="ident" id="1629375">bp</span><span class="op" id="1629377">.</span><span class="ident" id="1629378">count</span><span class="op" id="1629383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629388">r</span><span class="op" id="1629389">.</span><span class="ident" id="1629390">Cycles</span>&nbsp;<span class="op" id="1629397">=</span>&nbsp;<span class="ident" id="1629399">int64</span><span class="op" id="1629404">(</span><span class="ident" id="1629405">bp</span><span class="op" id="1629407">.</span><span class="ident" id="1629408">cycles</span><span class="op" id="1629414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629419">i</span>&nbsp;<span class="op" id="1629421">:=</span>&nbsp;<span class="builtinfunc" id="1629424">copy</span><span class="op" id="1629428">(</span><span class="ident" id="1629429">r</span><span class="op" id="1629430">.</span><span class="ident" id="1629431">Stack0</span><span class="op" id="1629437">[</span><span class="op" id="1629438">:</span><span class="op" id="1629439">]</span><span class="op" id="1629440">,</span>&nbsp;<span class="ident" id="1629442">b</span><span class="op" id="1629443">.</span><span class="ident" id="1629444">stk</span><span class="op" id="1629447">(</span><span class="op" id="1629448">)</span><span class="op" id="1629449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1629454">for</span>&nbsp;<span class="op" id="1629458">;</span>&nbsp;<span class="ident" id="1629460">i</span>&nbsp;<span class="op" id="1629462">&lt;</span>&nbsp;<span class="builtinfunc" id="1629464">len</span><span class="op" id="1629467">(</span><span class="ident" id="1629468">r</span><span class="op" id="1629469">.</span><span class="ident" id="1629470">Stack0</span><span class="op" id="1629476">)</span><span class="op" id="1629477">;</span>&nbsp;<span class="ident" id="1629479">i</span><span class="op" id="1629480">++</span>&nbsp;<span class="op" id="1629483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629489">r</span><span class="op" id="1629490">.</span><span class="ident" id="1629491">Stack0</span><span class="op" id="1629497">[</span><span class="ident" id="1629498">i</span><span class="op" id="1629499">]</span>&nbsp;<span class="op" id="1629501">=</span>&nbsp;<span class="num" id="1629503">0</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1629508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629513">p</span>&nbsp;<span class="op" id="1629515">=</span>&nbsp;<span class="ident" id="1629517">p</span><span class="op" id="1629518">[</span><span class="num" id="1629519">1</span><span class="op" id="1629520">:</span><span class="op" id="1629521">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1629525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1629528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629531">unlock</span><span class="op" id="1629537">(</span><span class="op" id="1629538">&amp;</span><span class="ident" id="1629539">proflock</span><span class="op" id="1629547">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1629550">return</span><br>
<span class="lineno"></span><span class="op" id="1629557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1629560">//&nbsp;ThreadCreateProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;thread&nbsp;creation&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1629648">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">500</span><span class="comment" id="1629734">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1629812">//</span><br>
<span class="lineno"></span><span class="comment" id="1629815">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1629876">//&nbsp;of&nbsp;calling&nbsp;ThreadCreateProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1629920">func</span>&nbsp;<span class="ident" id="1629925">ThreadCreateProfile</span><span class="op" id="1629944">(</span><span class="ident" id="1629945">p</span>&nbsp;<span class="op" id="1629947">[</span><span class="op" id="1629948">]</span><span class="ident" id="1629949">StackRecord</span><span class="op" id="1629960">)</span>&nbsp;<span class="op" id="1629962">(</span><span class="ident" id="1629963">n</span>&nbsp;<span class="builtintype" id="1629965">int</span><span class="op" id="1629968">,</span>&nbsp;<span class="ident" id="1629970">ok</span>&nbsp;<span class="builtintype" id="1629973">bool</span><span class="op" id="1629977">)</span>&nbsp;<span class="op" id="1629979">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629982">first</span>&nbsp;<span class="op" id="1629988">:=</span>&nbsp;<span class="op" id="1629991">(</span><span class="op" id="1629992">*</span><span class="ident" id="1629993">m</span><span class="op" id="1629994">)</span><span class="op" id="1629995">(</span><span class="ident" id="1629996">atomicloadp</span><span class="op" id="1630007">(</span><span class="ident" id="1630008">unsafe</span><span class="op" id="1630014">.</span><span class="ident" id="1630015">Pointer</span><span class="op" id="1630022">(</span><span class="op" id="1630023">&amp;</span><span class="ident" id="1630024">allm</span><span class="op" id="1630028">)</span><span class="op" id="1630029">)</span><span class="op" id="1630030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630033">for</span>&nbsp;<span class="ident" id="1630037">mp</span>&nbsp;<span class="op" id="1630040">:=</span>&nbsp;<span class="ident" id="1630043">first</span><span class="op" id="1630048">;</span>&nbsp;<span class="ident" id="1630050">mp</span>&nbsp;<span class="op" id="1630053">!=</span>&nbsp;<span class="ident" id="1630056">nil</span><span class="op" id="1630059">;</span>&nbsp;<span class="ident" id="1630061">mp</span>&nbsp;<span class="op" id="1630064">=</span>&nbsp;<span class="ident" id="1630066">mp</span><span class="op" id="1630068">.</span><span class="ident" id="1630069">alllink</span>&nbsp;<span class="op" id="1630077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630081">n</span><span class="op" id="1630082">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630089">if</span>&nbsp;<span class="ident" id="1630092">n</span>&nbsp;<span class="op" id="1630094">&lt;=</span>&nbsp;<span class="builtinfunc" id="1630097">len</span><span class="op" id="1630100">(</span><span class="ident" id="1630101">p</span><span class="op" id="1630102">)</span>&nbsp;<span class="op" id="1630104">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630108">ok</span>&nbsp;<span class="op" id="1630111">=</span>&nbsp;<span class="builtintype" id="1630113">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630120">i</span>&nbsp;<span class="op" id="1630122">:=</span>&nbsp;<span class="num" id="1630125">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630129">for</span>&nbsp;<span class="ident" id="1630133">mp</span>&nbsp;<span class="op" id="1630136">:=</span>&nbsp;<span class="ident" id="1630139">first</span><span class="op" id="1630144">;</span>&nbsp;<span class="ident" id="1630146">mp</span>&nbsp;<span class="op" id="1630149">!=</span>&nbsp;<span class="ident" id="1630152">nil</span><span class="op" id="1630155">;</span>&nbsp;<span class="ident" id="1630157">mp</span>&nbsp;<span class="op" id="1630160">=</span>&nbsp;<span class="ident" id="1630162">mp</span><span class="op" id="1630164">.</span><span class="ident" id="1630165">alllink</span>&nbsp;<span class="op" id="1630173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630178">for</span>&nbsp;<span class="ident" id="1630182">s</span>&nbsp;<span class="op" id="1630184">:=</span>&nbsp;<span class="keyword" id="1630187">range</span>&nbsp;<span class="ident" id="1630193">mp</span><span class="op" id="1630195">.</span><span class="ident" id="1630196">createstack</span>&nbsp;<span class="op" id="1630208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630214">p</span><span class="op" id="1630215">[</span><span class="ident" id="1630216">i</span><span class="op" id="1630217">]</span><span class="op" id="1630218">.</span><span class="ident" id="1630219">Stack0</span><span class="op" id="1630225">[</span><span class="ident" id="1630226">s</span><span class="op" id="1630227">]</span>&nbsp;<span class="op" id="1630229">=</span>&nbsp;<span class="builtintype" id="1630231">uintptr</span><span class="op" id="1630238">(</span><span class="ident" id="1630239">mp</span><span class="op" id="1630241">.</span><span class="ident" id="1630242">createstack</span><span class="op" id="1630253">[</span><span class="ident" id="1630254">s</span><span class="op" id="1630255">]</span><span class="op" id="1630256">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630266">i</span><span class="op" id="1630267">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630278">return</span><br>
<span class="lineno">520</span><span class="op" id="1630285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1630288">var</span>&nbsp;<span class="ident" id="1630292">allgs</span>&nbsp;<span class="op" id="1630298">[</span><span class="op" id="1630299">]</span><span class="op" id="1630300">*</span><span class="ident" id="1630301">g</span>&nbsp;<span class="comment" id="1630303">//&nbsp;proc.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1630314">//&nbsp;GoroutineProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;active&nbsp;goroutine&nbsp;stack&nbsp;profile.</span><br>
<span class="lineno">525</span><span class="comment" id="1630406">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;GoroutineProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1630489">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;GoroutineProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1630564">//</span><br>
<span class="lineno"></span><span class="comment" id="1630567">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1630628">//&nbsp;of&nbsp;calling&nbsp;GoroutineProfile&nbsp;directly.</span><br>
<span class="lineno">530</span><span class="keyword" id="1630669">func</span>&nbsp;<span class="ident" id="1630674">GoroutineProfile</span><span class="op" id="1630690">(</span><span class="ident" id="1630691">p</span>&nbsp;<span class="op" id="1630693">[</span><span class="op" id="1630694">]</span><span class="ident" id="1630695">StackRecord</span><span class="op" id="1630706">)</span>&nbsp;<span class="op" id="1630708">(</span><span class="ident" id="1630709">n</span>&nbsp;<span class="builtintype" id="1630711">int</span><span class="op" id="1630714">,</span>&nbsp;<span class="ident" id="1630716">ok</span>&nbsp;<span class="builtintype" id="1630719">bool</span><span class="op" id="1630723">)</span>&nbsp;<span class="op" id="1630725">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630729">n</span>&nbsp;<span class="op" id="1630731">=</span>&nbsp;<span class="ident" id="1630733">NumGoroutine</span><span class="op" id="1630745">(</span><span class="op" id="1630746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630749">if</span>&nbsp;<span class="ident" id="1630752">n</span>&nbsp;<span class="op" id="1630754">&lt;=</span>&nbsp;<span class="builtinfunc" id="1630757">len</span><span class="op" id="1630760">(</span><span class="ident" id="1630761">p</span><span class="op" id="1630762">)</span>&nbsp;<span class="op" id="1630764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630768">gp</span>&nbsp;<span class="op" id="1630771">:=</span>&nbsp;<span class="ident" id="1630774">getg</span><span class="op" id="1630778">(</span><span class="op" id="1630779">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630783">semacquire</span><span class="op" id="1630793">(</span><span class="op" id="1630794">&amp;</span><span class="ident" id="1630795">worldsema</span><span class="op" id="1630804">,</span>&nbsp;<span class="builtintype" id="1630806">false</span><span class="op" id="1630811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630815">gp</span><span class="op" id="1630817">.</span><span class="ident" id="1630818">m</span><span class="op" id="1630819">.</span><span class="ident" id="1630820">gcing</span>&nbsp;<span class="op" id="1630826">=</span>&nbsp;<span class="num" id="1630828">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630832">onM</span><span class="op" id="1630835">(</span><span class="ident" id="1630836">stoptheworld</span><span class="op" id="1630848">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630853">n</span>&nbsp;<span class="op" id="1630855">=</span>&nbsp;<span class="ident" id="1630857">NumGoroutine</span><span class="op" id="1630869">(</span><span class="op" id="1630870">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630874">if</span>&nbsp;<span class="ident" id="1630877">n</span>&nbsp;<span class="op" id="1630879">&lt;=</span>&nbsp;<span class="builtinfunc" id="1630882">len</span><span class="op" id="1630885">(</span><span class="ident" id="1630886">p</span><span class="op" id="1630887">)</span>&nbsp;<span class="op" id="1630889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630894">ok</span>&nbsp;<span class="op" id="1630897">=</span>&nbsp;<span class="builtintype" id="1630899">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630907">r</span>&nbsp;<span class="op" id="1630909">:=</span>&nbsp;<span class="ident" id="1630912">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630917">sp</span>&nbsp;<span class="op" id="1630920">:=</span>&nbsp;<span class="ident" id="1630923">getcallersp</span><span class="op" id="1630934">(</span><span class="ident" id="1630935">unsafe</span><span class="op" id="1630941">.</span><span class="ident" id="1630942">Pointer</span><span class="op" id="1630949">(</span><span class="op" id="1630950">&amp;</span><span class="ident" id="1630951">p</span><span class="op" id="1630952">)</span><span class="op" id="1630953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630958">pc</span>&nbsp;<span class="op" id="1630961">:=</span>&nbsp;<span class="ident" id="1630964">getcallerpc</span><span class="op" id="1630975">(</span><span class="ident" id="1630976">unsafe</span><span class="op" id="1630982">.</span><span class="ident" id="1630983">Pointer</span><span class="op" id="1630990">(</span><span class="op" id="1630991">&amp;</span><span class="ident" id="1630992">p</span><span class="op" id="1630993">)</span><span class="op" id="1630994">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630999">onM</span><span class="op" id="1631002">(</span><span class="keyword" id="1631003">func</span><span class="op" id="1631007">(</span><span class="op" id="1631008">)</span>&nbsp;<span class="op" id="1631010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631016">saveg</span><span class="op" id="1631021">(</span><span class="ident" id="1631022">pc</span><span class="op" id="1631024">,</span>&nbsp;<span class="ident" id="1631026">sp</span><span class="op" id="1631028">,</span>&nbsp;<span class="ident" id="1631030">gp</span><span class="op" id="1631032">,</span>&nbsp;<span class="op" id="1631034">&amp;</span><span class="ident" id="1631035">r</span><span class="op" id="1631036">[</span><span class="num" id="1631037">0</span><span class="op" id="1631038">]</span><span class="op" id="1631039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631044">}</span><span class="op" id="1631045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631050">r</span>&nbsp;<span class="op" id="1631052">=</span>&nbsp;<span class="ident" id="1631054">r</span><span class="op" id="1631055">[</span><span class="num" id="1631056">1</span><span class="op" id="1631057">:</span><span class="op" id="1631058">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631063">for</span>&nbsp;<span class="ident" id="1631067">_</span><span class="op" id="1631068">,</span>&nbsp;<span class="ident" id="1631070">gp1</span>&nbsp;<span class="op" id="1631074">:=</span>&nbsp;<span class="keyword" id="1631077">range</span>&nbsp;<span class="ident" id="1631083">allgs</span>&nbsp;<span class="op" id="1631089">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631095">if</span>&nbsp;<span class="ident" id="1631098">gp1</span>&nbsp;<span class="op" id="1631102">==</span>&nbsp;<span class="ident" id="1631105">gp</span>&nbsp;<span class="op" id="1631108">||</span>&nbsp;<span class="ident" id="1631111">readgstatus</span><span class="op" id="1631122">(</span><span class="ident" id="1631123">gp1</span><span class="op" id="1631126">)</span>&nbsp;<span class="op" id="1631128">==</span>&nbsp;<span class="ident" id="1631131">_Gdead</span>&nbsp;<span class="op" id="1631138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631145">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631164">saveg</span><span class="op" id="1631169">(</span><span class="op" id="1631170">^</span><span class="builtintype" id="1631171">uintptr</span><span class="op" id="1631178">(</span><span class="num" id="1631179">0</span><span class="op" id="1631180">)</span><span class="op" id="1631181">,</span>&nbsp;<span class="op" id="1631183">^</span><span class="builtintype" id="1631184">uintptr</span><span class="op" id="1631191">(</span><span class="num" id="1631192">0</span><span class="op" id="1631193">)</span><span class="op" id="1631194">,</span>&nbsp;<span class="ident" id="1631196">gp1</span><span class="op" id="1631199">,</span>&nbsp;<span class="op" id="1631201">&amp;</span><span class="ident" id="1631202">r</span><span class="op" id="1631203">[</span><span class="num" id="1631204">0</span><span class="op" id="1631205">]</span><span class="op" id="1631206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631212">r</span>&nbsp;<span class="op" id="1631214">=</span>&nbsp;<span class="ident" id="1631216">r</span><span class="op" id="1631217">[</span><span class="num" id="1631218">1</span><span class="op" id="1631219">:</span><span class="op" id="1631220">]</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631234">gp</span><span class="op" id="1631236">.</span><span class="ident" id="1631237">m</span><span class="op" id="1631238">.</span><span class="ident" id="1631239">gcing</span>&nbsp;<span class="op" id="1631245">=</span>&nbsp;<span class="num" id="1631247">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631251">semrelease</span><span class="op" id="1631261">(</span><span class="op" id="1631262">&amp;</span><span class="ident" id="1631263">worldsema</span><span class="op" id="1631272">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631276">onM</span><span class="op" id="1631279">(</span><span class="ident" id="1631280">starttheworld</span><span class="op" id="1631293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631300">return</span>&nbsp;<span class="ident" id="1631307">n</span><span class="op" id="1631308">,</span>&nbsp;<span class="ident" id="1631310">ok</span><br>
<span class="lineno"></span><span class="op" id="1631313">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="keyword" id="1631316">func</span>&nbsp;<span class="ident" id="1631321">saveg</span><span class="op" id="1631326">(</span><span class="ident" id="1631327">pc</span><span class="op" id="1631329">,</span>&nbsp;<span class="ident" id="1631331">sp</span>&nbsp;<span class="builtintype" id="1631334">uintptr</span><span class="op" id="1631341">,</span>&nbsp;<span class="ident" id="1631343">gp</span>&nbsp;<span class="op" id="1631346">*</span><span class="ident" id="1631347">g</span><span class="op" id="1631348">,</span>&nbsp;<span class="ident" id="1631350">r</span>&nbsp;<span class="op" id="1631352">*</span><span class="ident" id="1631353">StackRecord</span><span class="op" id="1631364">)</span>&nbsp;<span class="op" id="1631366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631369">n</span>&nbsp;<span class="op" id="1631371">:=</span>&nbsp;<span class="ident" id="1631374">gentraceback</span><span class="op" id="1631386">(</span><span class="ident" id="1631387">pc</span><span class="op" id="1631389">,</span>&nbsp;<span class="ident" id="1631391">sp</span><span class="op" id="1631393">,</span>&nbsp;<span class="num" id="1631395">0</span><span class="op" id="1631396">,</span>&nbsp;<span class="ident" id="1631398">gp</span><span class="op" id="1631400">,</span>&nbsp;<span class="num" id="1631402">0</span><span class="op" id="1631403">,</span>&nbsp;<span class="op" id="1631405">&amp;</span><span class="ident" id="1631406">r</span><span class="op" id="1631407">.</span><span class="ident" id="1631408">Stack0</span><span class="op" id="1631414">[</span><span class="num" id="1631415">0</span><span class="op" id="1631416">]</span><span class="op" id="1631417">,</span>&nbsp;<span class="builtinfunc" id="1631419">len</span><span class="op" id="1631422">(</span><span class="ident" id="1631423">r</span><span class="op" id="1631424">.</span><span class="ident" id="1631425">Stack0</span><span class="op" id="1631431">)</span><span class="op" id="1631432">,</span>&nbsp;<span class="ident" id="1631434">nil</span><span class="op" id="1631437">,</span>&nbsp;<span class="ident" id="1631439">nil</span><span class="op" id="1631442">,</span>&nbsp;<span class="num" id="1631444">0</span><span class="op" id="1631445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631448">if</span>&nbsp;<span class="ident" id="1631451">n</span>&nbsp;<span class="op" id="1631453">&lt;</span>&nbsp;<span class="builtinfunc" id="1631455">len</span><span class="op" id="1631458">(</span><span class="ident" id="1631459">r</span><span class="op" id="1631460">.</span><span class="ident" id="1631461">Stack0</span><span class="op" id="1631467">)</span>&nbsp;<span class="op" id="1631469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631473">r</span><span class="op" id="1631474">.</span><span class="ident" id="1631475">Stack0</span><span class="op" id="1631481">[</span><span class="ident" id="1631482">n</span><span class="op" id="1631483">]</span>&nbsp;<span class="op" id="1631485">=</span>&nbsp;<span class="num" id="1631487">0</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631490">}</span><br>
<span class="lineno"></span><span class="op" id="1631492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1631495">//&nbsp;Stack&nbsp;formats&nbsp;a&nbsp;stack&nbsp;trace&nbsp;of&nbsp;the&nbsp;calling&nbsp;goroutine&nbsp;into&nbsp;buf</span><br>
<span class="lineno"></span><span class="comment" id="1631560">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;to&nbsp;buf.</span><br>
<span class="lineno">575</span><span class="comment" id="1631611">//&nbsp;If&nbsp;all&nbsp;is&nbsp;true,&nbsp;Stack&nbsp;formats&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;other&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="1631681">//&nbsp;into&nbsp;buf&nbsp;after&nbsp;the&nbsp;trace&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1631736">func</span>&nbsp;<span class="ident" id="1631741">Stack</span><span class="op" id="1631746">(</span><span class="ident" id="1631747">buf</span>&nbsp;<span class="op" id="1631751">[</span><span class="op" id="1631752">]</span><span class="builtintype" id="1631753">byte</span><span class="op" id="1631757">,</span>&nbsp;<span class="ident" id="1631759">all</span>&nbsp;<span class="builtintype" id="1631763">bool</span><span class="op" id="1631767">)</span>&nbsp;<span class="builtintype" id="1631769">int</span>&nbsp;<span class="op" id="1631773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631776">mp</span>&nbsp;<span class="op" id="1631779">:=</span>&nbsp;<span class="ident" id="1631782">acquirem</span><span class="op" id="1631790">(</span><span class="op" id="1631791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631794">gp</span>&nbsp;<span class="op" id="1631797">:=</span>&nbsp;<span class="ident" id="1631800">mp</span><span class="op" id="1631802">.</span><span class="ident" id="1631803">curg</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631809">if</span>&nbsp;<span class="ident" id="1631812">all</span>&nbsp;<span class="op" id="1631816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631820">semacquire</span><span class="op" id="1631830">(</span><span class="op" id="1631831">&amp;</span><span class="ident" id="1631832">worldsema</span><span class="op" id="1631841">,</span>&nbsp;<span class="builtintype" id="1631843">false</span><span class="op" id="1631848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631852">mp</span><span class="op" id="1631854">.</span><span class="ident" id="1631855">gcing</span>&nbsp;<span class="op" id="1631861">=</span>&nbsp;<span class="num" id="1631863">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631867">releasem</span><span class="op" id="1631875">(</span><span class="ident" id="1631876">mp</span><span class="op" id="1631878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631882">onM</span><span class="op" id="1631885">(</span><span class="ident" id="1631886">stoptheworld</span><span class="op" id="1631898">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631902">if</span>&nbsp;<span class="ident" id="1631905">mp</span>&nbsp;<span class="op" id="1631908">!=</span>&nbsp;<span class="ident" id="1631911">acquirem</span><span class="op" id="1631919">(</span><span class="op" id="1631920">)</span>&nbsp;<span class="op" id="1631922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631927">gothrow</span><span class="op" id="1631934">(</span><span class="string" id="1631935">&#34;Stack:&nbsp;rescheduled&#34;</span><span class="op" id="1631955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631966">n</span>&nbsp;<span class="op" id="1631968">:=</span>&nbsp;<span class="num" id="1631971">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631974">if</span>&nbsp;<span class="builtinfunc" id="1631977">len</span><span class="op" id="1631980">(</span><span class="ident" id="1631981">buf</span><span class="op" id="1631984">)</span>&nbsp;<span class="op" id="1631986">&gt;</span>&nbsp;<span class="num" id="1631988">0</span>&nbsp;<span class="op" id="1631990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631994">sp</span>&nbsp;<span class="op" id="1631997">:=</span>&nbsp;<span class="ident" id="1632000">getcallersp</span><span class="op" id="1632011">(</span><span class="ident" id="1632012">unsafe</span><span class="op" id="1632018">.</span><span class="ident" id="1632019">Pointer</span><span class="op" id="1632026">(</span><span class="op" id="1632027">&amp;</span><span class="ident" id="1632028">buf</span><span class="op" id="1632031">)</span><span class="op" id="1632032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632036">pc</span>&nbsp;<span class="op" id="1632039">:=</span>&nbsp;<span class="ident" id="1632042">getcallerpc</span><span class="op" id="1632053">(</span><span class="ident" id="1632054">unsafe</span><span class="op" id="1632060">.</span><span class="ident" id="1632061">Pointer</span><span class="op" id="1632068">(</span><span class="op" id="1632069">&amp;</span><span class="ident" id="1632070">buf</span><span class="op" id="1632073">)</span><span class="op" id="1632074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632078">onM</span><span class="op" id="1632081">(</span><span class="keyword" id="1632082">func</span><span class="op" id="1632086">(</span><span class="op" id="1632087">)</span>&nbsp;<span class="op" id="1632089">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632094">g0</span>&nbsp;<span class="op" id="1632097">:=</span>&nbsp;<span class="ident" id="1632100">getg</span><span class="op" id="1632104">(</span><span class="op" id="1632105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632110">g0</span><span class="op" id="1632112">.</span><span class="ident" id="1632113">writebuf</span>&nbsp;<span class="op" id="1632122">=</span>&nbsp;<span class="ident" id="1632124">buf</span><span class="op" id="1632127">[</span><span class="num" id="1632128">0</span><span class="op" id="1632129">:</span><span class="num" id="1632130">0</span><span class="op" id="1632131">:</span><span class="builtinfunc" id="1632132">len</span><span class="op" id="1632135">(</span><span class="ident" id="1632136">buf</span><span class="op" id="1632139">)</span><span class="op" id="1632140">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632145">goroutineheader</span><span class="op" id="1632160">(</span><span class="ident" id="1632161">gp</span><span class="op" id="1632163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632168">traceback</span><span class="op" id="1632177">(</span><span class="ident" id="1632178">pc</span><span class="op" id="1632180">,</span>&nbsp;<span class="ident" id="1632182">sp</span><span class="op" id="1632184">,</span>&nbsp;<span class="num" id="1632186">0</span><span class="op" id="1632187">,</span>&nbsp;<span class="ident" id="1632189">gp</span><span class="op" id="1632191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632196">if</span>&nbsp;<span class="ident" id="1632199">all</span>&nbsp;<span class="op" id="1632203">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632209">tracebackothers</span><span class="op" id="1632224">(</span><span class="ident" id="1632225">gp</span><span class="op" id="1632227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632237">n</span>&nbsp;<span class="op" id="1632239">=</span>&nbsp;<span class="builtinfunc" id="1632241">len</span><span class="op" id="1632244">(</span><span class="ident" id="1632245">g0</span><span class="op" id="1632247">.</span><span class="ident" id="1632248">writebuf</span><span class="op" id="1632256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632261">g0</span><span class="op" id="1632263">.</span><span class="ident" id="1632264">writebuf</span>&nbsp;<span class="op" id="1632273">=</span>&nbsp;<span class="ident" id="1632275">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632281">}</span><span class="op" id="1632282">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632289">if</span>&nbsp;<span class="ident" id="1632292">all</span>&nbsp;<span class="op" id="1632296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632300">mp</span><span class="op" id="1632302">.</span><span class="ident" id="1632303">gcing</span>&nbsp;<span class="op" id="1632309">=</span>&nbsp;<span class="num" id="1632311">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632315">semrelease</span><span class="op" id="1632325">(</span><span class="op" id="1632326">&amp;</span><span class="ident" id="1632327">worldsema</span><span class="op" id="1632336">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632340">onM</span><span class="op" id="1632343">(</span><span class="ident" id="1632344">starttheworld</span><span class="op" id="1632357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632363">releasem</span><span class="op" id="1632371">(</span><span class="ident" id="1632372">mp</span><span class="op" id="1632374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632377">return</span>&nbsp;<span class="ident" id="1632384">n</span><br>
<span class="lineno"></span><span class="op" id="1632386">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="comment" id="1632389">//&nbsp;Tracing&nbsp;of&nbsp;alloc/free/gc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1632419">var</span>&nbsp;<span class="ident" id="1632423">tracelock</span>&nbsp;<span class="ident" id="1632433">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="1632440">func</span>&nbsp;<span class="ident" id="1632445">tracealloc</span><span class="op" id="1632455">(</span><span class="ident" id="1632456">p</span>&nbsp;<span class="ident" id="1632458">unsafe</span><span class="op" id="1632464">.</span><span class="ident" id="1632465">Pointer</span><span class="op" id="1632472">,</span>&nbsp;<span class="ident" id="1632474">size</span>&nbsp;<span class="builtintype" id="1632479">uintptr</span><span class="op" id="1632486">,</span>&nbsp;<span class="ident" id="1632488">typ</span>&nbsp;<span class="op" id="1632492">*</span><span class="ident" id="1632493">_type</span><span class="op" id="1632498">)</span>&nbsp;<span class="op" id="1632500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632503">lock</span><span class="op" id="1632507">(</span><span class="op" id="1632508">&amp;</span><span class="ident" id="1632509">tracelock</span><span class="op" id="1632518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632521">gp</span>&nbsp;<span class="op" id="1632524">:=</span>&nbsp;<span class="ident" id="1632527">getg</span><span class="op" id="1632531">(</span><span class="op" id="1632532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632535">gp</span><span class="op" id="1632537">.</span><span class="ident" id="1632538">m</span><span class="op" id="1632539">.</span><span class="ident" id="1632540">traceback</span>&nbsp;<span class="op" id="1632550">=</span>&nbsp;<span class="num" id="1632552">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632555">if</span>&nbsp;<span class="ident" id="1632558">typ</span>&nbsp;<span class="op" id="1632562">==</span>&nbsp;<span class="ident" id="1632565">nil</span>&nbsp;<span class="op" id="1632569">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1632573">print</span><span class="op" id="1632578">(</span><span class="string" id="1632579">&#34;tracealloc(&#34;</span><span class="op" id="1632592">,</span>&nbsp;<span class="ident" id="1632594">p</span><span class="op" id="1632595">,</span>&nbsp;<span class="string" id="1632597">&#34;,&nbsp;&#34;</span><span class="op" id="1632601">,</span>&nbsp;<span class="ident" id="1632603">hex</span><span class="op" id="1632606">(</span><span class="ident" id="1632607">size</span><span class="op" id="1632611">)</span><span class="op" id="1632612">,</span>&nbsp;<span class="string" id="1632614">&#34;)\n&#34;</span><span class="op" id="1632619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632622">}</span>&nbsp;<span class="keyword" id="1632624">else</span>&nbsp;<span class="op" id="1632629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1632633">print</span><span class="op" id="1632638">(</span><span class="string" id="1632639">&#34;tracealloc(&#34;</span><span class="op" id="1632652">,</span>&nbsp;<span class="ident" id="1632654">p</span><span class="op" id="1632655">,</span>&nbsp;<span class="string" id="1632657">&#34;,&nbsp;&#34;</span><span class="op" id="1632661">,</span>&nbsp;<span class="ident" id="1632663">hex</span><span class="op" id="1632666">(</span><span class="ident" id="1632667">size</span><span class="op" id="1632671">)</span><span class="op" id="1632672">,</span>&nbsp;<span class="string" id="1632674">&#34;,&nbsp;&#34;</span><span class="op" id="1632678">,</span>&nbsp;<span class="op" id="1632680">*</span><span class="ident" id="1632681">typ</span><span class="op" id="1632684">.</span><span class="ident" id="1632685">_string</span><span class="op" id="1632692">,</span>&nbsp;<span class="string" id="1632694">&#34;)\n&#34;</span><span class="op" id="1632699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632705">if</span>&nbsp;<span class="ident" id="1632708">gp</span><span class="op" id="1632710">.</span><span class="ident" id="1632711">m</span><span class="op" id="1632712">.</span><span class="ident" id="1632713">curg</span>&nbsp;<span class="op" id="1632718">==</span>&nbsp;<span class="ident" id="1632721">nil</span>&nbsp;<span class="op" id="1632725">||</span>&nbsp;<span class="ident" id="1632728">gp</span>&nbsp;<span class="op" id="1632731">==</span>&nbsp;<span class="ident" id="1632734">gp</span><span class="op" id="1632736">.</span><span class="ident" id="1632737">m</span><span class="op" id="1632738">.</span><span class="ident" id="1632739">curg</span>&nbsp;<span class="op" id="1632744">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632748">goroutineheader</span><span class="op" id="1632763">(</span><span class="ident" id="1632764">gp</span><span class="op" id="1632766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632770">pc</span>&nbsp;<span class="op" id="1632773">:=</span>&nbsp;<span class="ident" id="1632776">getcallerpc</span><span class="op" id="1632787">(</span><span class="ident" id="1632788">unsafe</span><span class="op" id="1632794">.</span><span class="ident" id="1632795">Pointer</span><span class="op" id="1632802">(</span><span class="op" id="1632803">&amp;</span><span class="ident" id="1632804">p</span><span class="op" id="1632805">)</span><span class="op" id="1632806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632810">sp</span>&nbsp;<span class="op" id="1632813">:=</span>&nbsp;<span class="ident" id="1632816">getcallersp</span><span class="op" id="1632827">(</span><span class="ident" id="1632828">unsafe</span><span class="op" id="1632834">.</span><span class="ident" id="1632835">Pointer</span><span class="op" id="1632842">(</span><span class="op" id="1632843">&amp;</span><span class="ident" id="1632844">p</span><span class="op" id="1632845">)</span><span class="op" id="1632846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632850">onM</span><span class="op" id="1632853">(</span><span class="keyword" id="1632854">func</span><span class="op" id="1632858">(</span><span class="op" id="1632859">)</span>&nbsp;<span class="op" id="1632861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632866">traceback</span><span class="op" id="1632875">(</span><span class="ident" id="1632876">pc</span><span class="op" id="1632878">,</span>&nbsp;<span class="ident" id="1632880">sp</span><span class="op" id="1632882">,</span>&nbsp;<span class="num" id="1632884">0</span><span class="op" id="1632885">,</span>&nbsp;<span class="ident" id="1632887">gp</span><span class="op" id="1632889">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632893">}</span><span class="op" id="1632894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632897">}</span>&nbsp;<span class="keyword" id="1632899">else</span>&nbsp;<span class="op" id="1632904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632908">goroutineheader</span><span class="op" id="1632923">(</span><span class="ident" id="1632924">gp</span><span class="op" id="1632926">.</span><span class="ident" id="1632927">m</span><span class="op" id="1632928">.</span><span class="ident" id="1632929">curg</span><span class="op" id="1632933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632937">traceback</span><span class="op" id="1632946">(</span><span class="op" id="1632947">^</span><span class="builtintype" id="1632948">uintptr</span><span class="op" id="1632955">(</span><span class="num" id="1632956">0</span><span class="op" id="1632957">)</span><span class="op" id="1632958">,</span>&nbsp;<span class="op" id="1632960">^</span><span class="builtintype" id="1632961">uintptr</span><span class="op" id="1632968">(</span><span class="num" id="1632969">0</span><span class="op" id="1632970">)</span><span class="op" id="1632971">,</span>&nbsp;<span class="num" id="1632973">0</span><span class="op" id="1632974">,</span>&nbsp;<span class="ident" id="1632976">gp</span><span class="op" id="1632978">.</span><span class="ident" id="1632979">m</span><span class="op" id="1632980">.</span><span class="ident" id="1632981">curg</span><span class="op" id="1632985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632988">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1632991">print</span><span class="op" id="1632996">(</span><span class="string" id="1632997">&#34;\n&#34;</span><span class="op" id="1633001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633004">gp</span><span class="op" id="1633006">.</span><span class="ident" id="1633007">m</span><span class="op" id="1633008">.</span><span class="ident" id="1633009">traceback</span>&nbsp;<span class="op" id="1633019">=</span>&nbsp;<span class="num" id="1633021">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633024">unlock</span><span class="op" id="1633030">(</span><span class="op" id="1633031">&amp;</span><span class="ident" id="1633032">tracelock</span><span class="op" id="1633041">)</span><br>
<span class="lineno"></span><span class="op" id="1633043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span><span class="keyword" id="1633046">func</span>&nbsp;<span class="ident" id="1633051">tracefree</span><span class="op" id="1633060">(</span><span class="ident" id="1633061">p</span>&nbsp;<span class="ident" id="1633063">unsafe</span><span class="op" id="1633069">.</span><span class="ident" id="1633070">Pointer</span><span class="op" id="1633077">,</span>&nbsp;<span class="ident" id="1633079">size</span>&nbsp;<span class="builtintype" id="1633084">uintptr</span><span class="op" id="1633091">)</span>&nbsp;<span class="op" id="1633093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633096">lock</span><span class="op" id="1633100">(</span><span class="op" id="1633101">&amp;</span><span class="ident" id="1633102">tracelock</span><span class="op" id="1633111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633114">gp</span>&nbsp;<span class="op" id="1633117">:=</span>&nbsp;<span class="ident" id="1633120">getg</span><span class="op" id="1633124">(</span><span class="op" id="1633125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633128">gp</span><span class="op" id="1633130">.</span><span class="ident" id="1633131">m</span><span class="op" id="1633132">.</span><span class="ident" id="1633133">traceback</span>&nbsp;<span class="op" id="1633143">=</span>&nbsp;<span class="num" id="1633145">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1633148">print</span><span class="op" id="1633153">(</span><span class="string" id="1633154">&#34;tracefree(&#34;</span><span class="op" id="1633166">,</span>&nbsp;<span class="ident" id="1633168">p</span><span class="op" id="1633169">,</span>&nbsp;<span class="string" id="1633171">&#34;,&nbsp;&#34;</span><span class="op" id="1633175">,</span>&nbsp;<span class="ident" id="1633177">hex</span><span class="op" id="1633180">(</span><span class="ident" id="1633181">size</span><span class="op" id="1633185">)</span><span class="op" id="1633186">,</span>&nbsp;<span class="string" id="1633188">&#34;)\n&#34;</span><span class="op" id="1633193">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633196">goroutineheader</span><span class="op" id="1633211">(</span><span class="ident" id="1633212">gp</span><span class="op" id="1633214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633217">pc</span>&nbsp;<span class="op" id="1633220">:=</span>&nbsp;<span class="ident" id="1633223">getcallerpc</span><span class="op" id="1633234">(</span><span class="ident" id="1633235">unsafe</span><span class="op" id="1633241">.</span><span class="ident" id="1633242">Pointer</span><span class="op" id="1633249">(</span><span class="op" id="1633250">&amp;</span><span class="ident" id="1633251">p</span><span class="op" id="1633252">)</span><span class="op" id="1633253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633256">sp</span>&nbsp;<span class="op" id="1633259">:=</span>&nbsp;<span class="ident" id="1633262">getcallersp</span><span class="op" id="1633273">(</span><span class="ident" id="1633274">unsafe</span><span class="op" id="1633280">.</span><span class="ident" id="1633281">Pointer</span><span class="op" id="1633288">(</span><span class="op" id="1633289">&amp;</span><span class="ident" id="1633290">p</span><span class="op" id="1633291">)</span><span class="op" id="1633292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633295">onM</span><span class="op" id="1633298">(</span><span class="keyword" id="1633299">func</span><span class="op" id="1633303">(</span><span class="op" id="1633304">)</span>&nbsp;<span class="op" id="1633306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633310">traceback</span><span class="op" id="1633319">(</span><span class="ident" id="1633320">pc</span><span class="op" id="1633322">,</span>&nbsp;<span class="ident" id="1633324">sp</span><span class="op" id="1633326">,</span>&nbsp;<span class="num" id="1633328">0</span><span class="op" id="1633329">,</span>&nbsp;<span class="ident" id="1633331">gp</span><span class="op" id="1633333">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633336">}</span><span class="op" id="1633337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1633340">print</span><span class="op" id="1633345">(</span><span class="string" id="1633346">&#34;\n&#34;</span><span class="op" id="1633350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633353">gp</span><span class="op" id="1633355">.</span><span class="ident" id="1633356">m</span><span class="op" id="1633357">.</span><span class="ident" id="1633358">traceback</span>&nbsp;<span class="op" id="1633368">=</span>&nbsp;<span class="num" id="1633370">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633373">unlock</span><span class="op" id="1633379">(</span><span class="op" id="1633380">&amp;</span><span class="ident" id="1633381">tracelock</span><span class="op" id="1633390">)</span><br>
<span class="lineno"></span><span class="op" id="1633392">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="keyword" id="1633395">func</span>&nbsp;<span class="ident" id="1633400">tracegc</span><span class="op" id="1633407">(</span><span class="op" id="1633408">)</span>&nbsp;<span class="op" id="1633410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633413">lock</span><span class="op" id="1633417">(</span><span class="op" id="1633418">&amp;</span><span class="ident" id="1633419">tracelock</span><span class="op" id="1633428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633431">gp</span>&nbsp;<span class="op" id="1633434">:=</span>&nbsp;<span class="ident" id="1633437">getg</span><span class="op" id="1633441">(</span><span class="op" id="1633442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633445">gp</span><span class="op" id="1633447">.</span><span class="ident" id="1633448">m</span><span class="op" id="1633449">.</span><span class="ident" id="1633450">traceback</span>&nbsp;<span class="op" id="1633460">=</span>&nbsp;<span class="num" id="1633462">2</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1633465">print</span><span class="op" id="1633470">(</span><span class="string" id="1633471">&#34;tracegc()\n&#34;</span><span class="op" id="1633484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1633487">//&nbsp;running&nbsp;on&nbsp;m-&gt;g0&nbsp;stack;&nbsp;show&nbsp;all&nbsp;non-g0&nbsp;goroutines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633542">tracebackothers</span><span class="op" id="1633557">(</span><span class="ident" id="1633558">gp</span><span class="op" id="1633560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1633563">print</span><span class="op" id="1633568">(</span><span class="string" id="1633569">&#34;end&nbsp;tracegc\n&#34;</span><span class="op" id="1633584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1633587">print</span><span class="op" id="1633592">(</span><span class="string" id="1633593">&#34;\n&#34;</span><span class="op" id="1633597">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633600">gp</span><span class="op" id="1633602">.</span><span class="ident" id="1633603">m</span><span class="op" id="1633604">.</span><span class="ident" id="1633605">traceback</span>&nbsp;<span class="op" id="1633615">=</span>&nbsp;<span class="num" id="1633617">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633620">unlock</span><span class="op" id="1633626">(</span><span class="op" id="1633627">&amp;</span><span class="ident" id="1633628">tracelock</span><span class="op" id="1633637">)</span><br>
<span class="lineno"></span><span class="op" id="1633639">}</span>
</div>
</body>
</html>
