<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/smtp</h2>
<ul>
<li><a href="/gostd/net/smtp/auth.go.html">auth.go</a></li>
<li><a href="/gostd/net/smtp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/smtp/smtp.go.html">smtp.go</a></li>
<li><a href="/gostd/net/smtp/smtp_test.go.html">smtp_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7560539">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7560594">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7560648">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7560699">package</span>&nbsp;<span class="ident" id="7560707">smtp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7560713">import</span>&nbsp;<span class="op" id="7560720">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7560723">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7560732">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7560741">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7560755">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7560770">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7560776">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7560783">&#34;net/textproto&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7560800">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7560811">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7560822">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7560829">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="7560832">type</span>&nbsp;<span class="ident" id="7560837">authTest</span>&nbsp;<span class="keyword" id="7560846">struct</span>&nbsp;<span class="op" id="7560853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560856">auth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7560867">Auth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560873">challenges</span>&nbsp;<span class="op" id="7560884">[</span><span class="op" id="7560885">]</span><span class="builtintype" id="7560886">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560894">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7560905">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7560913">responses</span>&nbsp;&nbsp;<span class="op" id="7560924">[</span><span class="op" id="7560925">]</span><span class="builtintype" id="7560926">string</span><br>
<span class="lineno">25</span><span class="op" id="7560933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7560936">var</span>&nbsp;<span class="ident" id="7560940">authTests</span>&nbsp;<span class="op" id="7560950">=</span>&nbsp;<span class="op" id="7560952">[</span><span class="op" id="7560953">]</span><span class="ident" id="7560954">authTest</span><span class="op" id="7560962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7560965">{</span><span class="ident" id="7560966">PlainAuth</span><span class="op" id="7560975">(</span><span class="string" id="7560976">&#34;&#34;</span><span class="op" id="7560978">,</span>&nbsp;<span class="string" id="7560980">&#34;user&#34;</span><span class="op" id="7560986">,</span>&nbsp;<span class="string" id="7560988">&#34;pass&#34;</span><span class="op" id="7560994">,</span>&nbsp;<span class="string" id="7560996">&#34;testserver&#34;</span><span class="op" id="7561008">)</span><span class="op" id="7561009">,</span>&nbsp;<span class="op" id="7561011">[</span><span class="op" id="7561012">]</span><span class="builtintype" id="7561013">string</span><span class="op" id="7561019">{</span><span class="op" id="7561020">}</span><span class="op" id="7561021">,</span>&nbsp;<span class="string" id="7561023">&#34;PLAIN&#34;</span><span class="op" id="7561030">,</span>&nbsp;<span class="op" id="7561032">[</span><span class="op" id="7561033">]</span><span class="builtintype" id="7561034">string</span><span class="op" id="7561040">{</span><span class="string" id="7561041">&#34;\x00user\x00pass&#34;</span><span class="op" id="7561059">}</span><span class="op" id="7561060">}</span><span class="op" id="7561061">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7561064">{</span><span class="ident" id="7561065">PlainAuth</span><span class="op" id="7561074">(</span><span class="string" id="7561075">&#34;foo&#34;</span><span class="op" id="7561080">,</span>&nbsp;<span class="string" id="7561082">&#34;bar&#34;</span><span class="op" id="7561087">,</span>&nbsp;<span class="string" id="7561089">&#34;baz&#34;</span><span class="op" id="7561094">,</span>&nbsp;<span class="string" id="7561096">&#34;testserver&#34;</span><span class="op" id="7561108">)</span><span class="op" id="7561109">,</span>&nbsp;<span class="op" id="7561111">[</span><span class="op" id="7561112">]</span><span class="builtintype" id="7561113">string</span><span class="op" id="7561119">{</span><span class="op" id="7561120">}</span><span class="op" id="7561121">,</span>&nbsp;<span class="string" id="7561123">&#34;PLAIN&#34;</span><span class="op" id="7561130">,</span>&nbsp;<span class="op" id="7561132">[</span><span class="op" id="7561133">]</span><span class="builtintype" id="7561134">string</span><span class="op" id="7561140">{</span><span class="string" id="7561141">&#34;foo\x00bar\x00baz&#34;</span><span class="op" id="7561160">}</span><span class="op" id="7561161">}</span><span class="op" id="7561162">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7561165">{</span><span class="ident" id="7561166">CRAMMD5Auth</span><span class="op" id="7561177">(</span><span class="string" id="7561178">&#34;user&#34;</span><span class="op" id="7561184">,</span>&nbsp;<span class="string" id="7561186">&#34;pass&#34;</span><span class="op" id="7561192">)</span><span class="op" id="7561193">,</span>&nbsp;<span class="op" id="7561195">[</span><span class="op" id="7561196">]</span><span class="builtintype" id="7561197">string</span><span class="op" id="7561203">{</span><span class="string" id="7561204">&#34;&lt;123456.1322876914@testserver&gt;&#34;</span><span class="op" id="7561236">}</span><span class="op" id="7561237">,</span>&nbsp;<span class="string" id="7561239">&#34;CRAM-MD5&#34;</span><span class="op" id="7561249">,</span>&nbsp;<span class="op" id="7561251">[</span><span class="op" id="7561252">]</span><span class="builtintype" id="7561253">string</span><span class="op" id="7561259">{</span><span class="string" id="7561260">&#34;&#34;</span><span class="op" id="7561262">,</span>&nbsp;<span class="string" id="7561264">&#34;user&nbsp;287eb355114cf5c471c26a875f1ca4ae&#34;</span><span class="op" id="7561303">}</span><span class="op" id="7561304">}</span><span class="op" id="7561305">,</span><br>
<span class="lineno"></span><span class="op" id="7561307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7561310">func</span>&nbsp;<span class="ident" id="7561315">TestAuth</span><span class="op" id="7561323">(</span><span class="ident" id="7561324">t</span>&nbsp;<span class="op" id="7561326">*</span><span class="ident" id="7561327">testing</span><span class="op" id="7561334">.</span><span class="ident" id="7561335">T</span><span class="op" id="7561336">)</span>&nbsp;<span class="op" id="7561338">{</span><br>
<span class="lineno"></span><span class="ident" id="7561340">testLoop</span><span class="op" id="7561348">:</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561351">for</span>&nbsp;<span class="ident" id="7561355">i</span><span class="op" id="7561356">,</span>&nbsp;<span class="ident" id="7561358">test</span>&nbsp;<span class="op" id="7561363">:=</span>&nbsp;<span class="keyword" id="7561366">range</span>&nbsp;<span class="ident" id="7561372">authTests</span>&nbsp;<span class="op" id="7561382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561386">name</span><span class="op" id="7561390">,</span>&nbsp;<span class="ident" id="7561392">resp</span><span class="op" id="7561396">,</span>&nbsp;<span class="ident" id="7561398">err</span>&nbsp;<span class="op" id="7561402">:=</span>&nbsp;<span class="ident" id="7561405">test</span><span class="op" id="7561409">.</span><span class="ident" id="7561410">auth</span><span class="op" id="7561414">.</span><span class="ident" id="7561415">Start</span><span class="op" id="7561420">(</span><span class="op" id="7561421">&amp;</span><span class="ident" id="7561422">ServerInfo</span><span class="op" id="7561432">{</span><span class="string" id="7561433">&#34;testserver&#34;</span><span class="op" id="7561445">,</span>&nbsp;<span class="builtintype" id="7561447">true</span><span class="op" id="7561451">,</span>&nbsp;<span class="ident" id="7561453">nil</span><span class="op" id="7561456">}</span><span class="op" id="7561457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561461">if</span>&nbsp;<span class="ident" id="7561464">name</span>&nbsp;<span class="op" id="7561469">!=</span>&nbsp;<span class="ident" id="7561472">test</span><span class="op" id="7561476">.</span><span class="ident" id="7561477">name</span>&nbsp;<span class="op" id="7561482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561487">t</span><span class="op" id="7561488">.</span><span class="ident" id="7561489">Errorf</span><span class="op" id="7561495">(</span><span class="string" id="7561496">&#34;#%d&nbsp;got&nbsp;name&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="7561526">,</span>&nbsp;<span class="ident" id="7561528">i</span><span class="op" id="7561529">,</span>&nbsp;<span class="ident" id="7561531">name</span><span class="op" id="7561535">,</span>&nbsp;<span class="ident" id="7561537">test</span><span class="op" id="7561541">.</span><span class="ident" id="7561542">name</span><span class="op" id="7561546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7561550">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561554">if</span>&nbsp;<span class="op" id="7561557">!</span><span class="ident" id="7561558">bytes</span><span class="op" id="7561563">.</span><span class="ident" id="7561564">Equal</span><span class="op" id="7561569">(</span><span class="ident" id="7561570">resp</span><span class="op" id="7561574">,</span>&nbsp;<span class="op" id="7561576">[</span><span class="op" id="7561577">]</span><span class="builtintype" id="7561578">byte</span><span class="op" id="7561582">(</span><span class="ident" id="7561583">test</span><span class="op" id="7561587">.</span><span class="ident" id="7561588">responses</span><span class="op" id="7561597">[</span><span class="num" id="7561598">0</span><span class="op" id="7561599">]</span><span class="op" id="7561600">)</span><span class="op" id="7561601">)</span>&nbsp;<span class="op" id="7561603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561608">t</span><span class="op" id="7561609">.</span><span class="ident" id="7561610">Errorf</span><span class="op" id="7561616">(</span><span class="string" id="7561617">&#34;#%d&nbsp;got&nbsp;response&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="7561651">,</span>&nbsp;<span class="ident" id="7561653">i</span><span class="op" id="7561654">,</span>&nbsp;<span class="ident" id="7561656">resp</span><span class="op" id="7561660">,</span>&nbsp;<span class="ident" id="7561662">test</span><span class="op" id="7561666">.</span><span class="ident" id="7561667">responses</span><span class="op" id="7561676">[</span><span class="num" id="7561677">0</span><span class="op" id="7561678">]</span><span class="op" id="7561679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7561683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561687">if</span>&nbsp;<span class="ident" id="7561690">err</span>&nbsp;<span class="op" id="7561694">!=</span>&nbsp;<span class="ident" id="7561697">nil</span>&nbsp;<span class="op" id="7561701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561706">t</span><span class="op" id="7561707">.</span><span class="ident" id="7561708">Errorf</span><span class="op" id="7561714">(</span><span class="string" id="7561715">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="7561730">,</span>&nbsp;<span class="ident" id="7561732">i</span><span class="op" id="7561733">,</span>&nbsp;<span class="ident" id="7561735">err</span><span class="op" id="7561738">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7561742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561746">for</span>&nbsp;<span class="ident" id="7561750">j</span>&nbsp;<span class="op" id="7561752">:=</span>&nbsp;<span class="keyword" id="7561755">range</span>&nbsp;<span class="ident" id="7561761">test</span><span class="op" id="7561765">.</span><span class="ident" id="7561766">challenges</span>&nbsp;<span class="op" id="7561777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561782">challenge</span>&nbsp;<span class="op" id="7561792">:=</span>&nbsp;<span class="op" id="7561795">[</span><span class="op" id="7561796">]</span><span class="builtintype" id="7561797">byte</span><span class="op" id="7561801">(</span><span class="ident" id="7561802">test</span><span class="op" id="7561806">.</span><span class="ident" id="7561807">challenges</span><span class="op" id="7561817">[</span><span class="ident" id="7561818">j</span><span class="op" id="7561819">]</span><span class="op" id="7561820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561825">expected</span>&nbsp;<span class="op" id="7561834">:=</span>&nbsp;<span class="op" id="7561837">[</span><span class="op" id="7561838">]</span><span class="builtintype" id="7561839">byte</span><span class="op" id="7561843">(</span><span class="ident" id="7561844">test</span><span class="op" id="7561848">.</span><span class="ident" id="7561849">responses</span><span class="op" id="7561858">[</span><span class="ident" id="7561859">j</span><span class="op" id="7561860">+</span><span class="num" id="7561861">1</span><span class="op" id="7561862">]</span><span class="op" id="7561863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561868">resp</span><span class="op" id="7561872">,</span>&nbsp;<span class="ident" id="7561874">err</span>&nbsp;<span class="op" id="7561878">:=</span>&nbsp;<span class="ident" id="7561881">test</span><span class="op" id="7561885">.</span><span class="ident" id="7561886">auth</span><span class="op" id="7561890">.</span><span class="ident" id="7561891">Next</span><span class="op" id="7561895">(</span><span class="ident" id="7561896">challenge</span><span class="op" id="7561905">,</span>&nbsp;<span class="builtintype" id="7561907">true</span><span class="op" id="7561911">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561916">if</span>&nbsp;<span class="ident" id="7561919">err</span>&nbsp;<span class="op" id="7561923">!=</span>&nbsp;<span class="ident" id="7561926">nil</span>&nbsp;<span class="op" id="7561930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7561936">t</span><span class="op" id="7561937">.</span><span class="ident" id="7561938">Errorf</span><span class="op" id="7561944">(</span><span class="string" id="7561945">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="7561960">,</span>&nbsp;<span class="ident" id="7561962">i</span><span class="op" id="7561963">,</span>&nbsp;<span class="ident" id="7561965">err</span><span class="op" id="7561968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7561974">continue</span>&nbsp;<span class="ident" id="7561983">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7561995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7562000">if</span>&nbsp;<span class="op" id="7562003">!</span><span class="ident" id="7562004">bytes</span><span class="op" id="7562009">.</span><span class="ident" id="7562010">Equal</span><span class="op" id="7562015">(</span><span class="ident" id="7562016">resp</span><span class="op" id="7562020">,</span>&nbsp;<span class="ident" id="7562022">expected</span><span class="op" id="7562030">)</span>&nbsp;<span class="op" id="7562032">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562038">t</span><span class="op" id="7562039">.</span><span class="ident" id="7562040">Errorf</span><span class="op" id="7562046">(</span><span class="string" id="7562047">&#34;#%d&nbsp;got&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="7562072">,</span>&nbsp;<span class="ident" id="7562074">i</span><span class="op" id="7562075">,</span>&nbsp;<span class="ident" id="7562077">resp</span><span class="op" id="7562081">,</span>&nbsp;<span class="ident" id="7562083">expected</span><span class="op" id="7562091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7562097">continue</span>&nbsp;<span class="ident" id="7562106">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562125">}</span><br>
<span class="lineno">60</span><span class="op" id="7562127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7562130">func</span>&nbsp;<span class="ident" id="7562135">TestAuthPlain</span><span class="op" id="7562148">(</span><span class="ident" id="7562149">t</span>&nbsp;<span class="op" id="7562151">*</span><span class="ident" id="7562152">testing</span><span class="op" id="7562159">.</span><span class="ident" id="7562160">T</span><span class="op" id="7562161">)</span>&nbsp;<span class="op" id="7562163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562166">auth</span>&nbsp;<span class="op" id="7562171">:=</span>&nbsp;<span class="ident" id="7562174">PlainAuth</span><span class="op" id="7562183">(</span><span class="string" id="7562184">&#34;foo&#34;</span><span class="op" id="7562189">,</span>&nbsp;<span class="string" id="7562191">&#34;bar&#34;</span><span class="op" id="7562196">,</span>&nbsp;<span class="string" id="7562198">&#34;baz&#34;</span><span class="op" id="7562203">,</span>&nbsp;<span class="string" id="7562205">&#34;servername&#34;</span><span class="op" id="7562217">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562221">tests</span>&nbsp;<span class="op" id="7562227">:=</span>&nbsp;<span class="op" id="7562230">[</span><span class="op" id="7562231">]</span><span class="keyword" id="7562232">struct</span>&nbsp;<span class="op" id="7562239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562243">server</span>&nbsp;<span class="op" id="7562250">*</span><span class="ident" id="7562251">ServerInfo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562264">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7562271">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562279">}</span><span class="op" id="7562280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562284">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562289">server</span><span class="op" id="7562295">:</span>&nbsp;<span class="op" id="7562297">&amp;</span><span class="ident" id="7562298">ServerInfo</span><span class="op" id="7562308">{</span><span class="ident" id="7562309">Name</span><span class="op" id="7562313">:</span>&nbsp;<span class="string" id="7562315">&#34;servername&#34;</span><span class="op" id="7562327">,</span>&nbsp;<span class="ident" id="7562329">TLS</span><span class="op" id="7562332">:</span>&nbsp;<span class="builtintype" id="7562334">true</span><span class="op" id="7562338">}</span><span class="op" id="7562339">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562343">}</span><span class="op" id="7562344">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7562353">//&nbsp;Okay;&nbsp;explicitly&nbsp;advertised&nbsp;by&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562398">server</span><span class="op" id="7562404">:</span>&nbsp;<span class="op" id="7562406">&amp;</span><span class="ident" id="7562407">ServerInfo</span><span class="op" id="7562417">{</span><span class="ident" id="7562418">Name</span><span class="op" id="7562422">:</span>&nbsp;<span class="string" id="7562424">&#34;servername&#34;</span><span class="op" id="7562436">,</span>&nbsp;<span class="ident" id="7562438">Auth</span><span class="op" id="7562442">:</span>&nbsp;<span class="op" id="7562444">[</span><span class="op" id="7562445">]</span><span class="builtintype" id="7562446">string</span><span class="op" id="7562452">{</span><span class="string" id="7562453">&#34;PLAIN&#34;</span><span class="op" id="7562460">}</span><span class="op" id="7562461">}</span><span class="op" id="7562462">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562466">}</span><span class="op" id="7562467">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562476">server</span><span class="op" id="7562482">:</span>&nbsp;<span class="op" id="7562484">&amp;</span><span class="ident" id="7562485">ServerInfo</span><span class="op" id="7562495">{</span><span class="ident" id="7562496">Name</span><span class="op" id="7562500">:</span>&nbsp;<span class="string" id="7562502">&#34;servername&#34;</span><span class="op" id="7562514">,</span>&nbsp;<span class="ident" id="7562516">Auth</span><span class="op" id="7562520">:</span>&nbsp;<span class="op" id="7562522">[</span><span class="op" id="7562523">]</span><span class="builtintype" id="7562524">string</span><span class="op" id="7562530">{</span><span class="string" id="7562531">&#34;CRAM-MD5&#34;</span><span class="op" id="7562541">}</span><span class="op" id="7562542">}</span><span class="op" id="7562543">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562548">err</span><span class="op" id="7562551">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7562556">&#34;unencrypted&nbsp;connection&#34;</span><span class="op" id="7562580">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562584">}</span><span class="op" id="7562585">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562594">server</span><span class="op" id="7562600">:</span>&nbsp;<span class="op" id="7562602">&amp;</span><span class="ident" id="7562603">ServerInfo</span><span class="op" id="7562613">{</span><span class="ident" id="7562614">Name</span><span class="op" id="7562618">:</span>&nbsp;<span class="string" id="7562620">&#34;attacker&#34;</span><span class="op" id="7562630">,</span>&nbsp;<span class="ident" id="7562632">TLS</span><span class="op" id="7562635">:</span>&nbsp;<span class="builtintype" id="7562637">true</span><span class="op" id="7562641">}</span><span class="op" id="7562642">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562647">err</span><span class="op" id="7562650">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7562655">&#34;wrong&nbsp;host&nbsp;name&#34;</span><span class="op" id="7562672">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562676">}</span><span class="op" id="7562677">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562680">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7562683">for</span>&nbsp;<span class="ident" id="7562687">i</span><span class="op" id="7562688">,</span>&nbsp;<span class="ident" id="7562690">tt</span>&nbsp;<span class="op" id="7562693">:=</span>&nbsp;<span class="keyword" id="7562696">range</span>&nbsp;<span class="ident" id="7562702">tests</span>&nbsp;<span class="op" id="7562708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562712">_</span><span class="op" id="7562713">,</span>&nbsp;<span class="ident" id="7562715">_</span><span class="op" id="7562716">,</span>&nbsp;<span class="ident" id="7562718">err</span>&nbsp;<span class="op" id="7562722">:=</span>&nbsp;<span class="ident" id="7562725">auth</span><span class="op" id="7562729">.</span><span class="ident" id="7562730">Start</span><span class="op" id="7562735">(</span><span class="ident" id="7562736">tt</span><span class="op" id="7562738">.</span><span class="ident" id="7562739">server</span><span class="op" id="7562745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562749">got</span>&nbsp;<span class="op" id="7562753">:=</span>&nbsp;<span class="string" id="7562756">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7562761">if</span>&nbsp;<span class="ident" id="7562764">err</span>&nbsp;<span class="op" id="7562768">!=</span>&nbsp;<span class="ident" id="7562771">nil</span>&nbsp;<span class="op" id="7562775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562780">got</span>&nbsp;<span class="op" id="7562784">=</span>&nbsp;<span class="ident" id="7562786">err</span><span class="op" id="7562789">.</span><span class="ident" id="7562790">Error</span><span class="op" id="7562795">(</span><span class="op" id="7562796">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7562804">if</span>&nbsp;<span class="ident" id="7562807">got</span>&nbsp;<span class="op" id="7562811">!=</span>&nbsp;<span class="ident" id="7562814">tt</span><span class="op" id="7562816">.</span><span class="ident" id="7562817">err</span>&nbsp;<span class="op" id="7562821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562826">t</span><span class="op" id="7562827">.</span><span class="ident" id="7562828">Errorf</span><span class="op" id="7562834">(</span><span class="string" id="7562835">&#34;%d.&nbsp;got&nbsp;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7562864">,</span>&nbsp;<span class="ident" id="7562866">i</span><span class="op" id="7562867">,</span>&nbsp;<span class="ident" id="7562869">got</span><span class="op" id="7562872">,</span>&nbsp;<span class="ident" id="7562874">tt</span><span class="op" id="7562876">.</span><span class="ident" id="7562877">err</span><span class="op" id="7562880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7562887">}</span><br>
<span class="lineno">95</span><span class="op" id="7562889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7562892">type</span>&nbsp;<span class="ident" id="7562897">faker</span>&nbsp;<span class="keyword" id="7562903">struct</span>&nbsp;<span class="op" id="7562910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7562913">io</span><span class="op" id="7562915">.</span><span class="ident" id="7562916">ReadWriter</span><br>
<span class="lineno"></span><span class="op" id="7562927">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="7562930">func</span>&nbsp;<span class="op" id="7562935">(</span><span class="ident" id="7562936">f</span>&nbsp;<span class="ident" id="7562938">faker</span><span class="op" id="7562943">)</span>&nbsp;<span class="ident" id="7562945">Close</span><span class="op" id="7562950">(</span><span class="op" id="7562951">)</span>&nbsp;<span class="builtintype" id="7562953">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7562979">{</span>&nbsp;<span class="keyword" id="7562981">return</span>&nbsp;<span class="ident" id="7562988">nil</span>&nbsp;<span class="op" id="7562992">}</span><br>
<span class="lineno"></span><span class="keyword" id="7562994">func</span>&nbsp;<span class="op" id="7562999">(</span><span class="ident" id="7563000">f</span>&nbsp;<span class="ident" id="7563002">faker</span><span class="op" id="7563007">)</span>&nbsp;<span class="ident" id="7563009">LocalAddr</span><span class="op" id="7563018">(</span><span class="op" id="7563019">)</span>&nbsp;<span class="ident" id="7563021">net</span><span class="op" id="7563024">.</span><span class="ident" id="7563025">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7563043">{</span>&nbsp;<span class="keyword" id="7563045">return</span>&nbsp;<span class="ident" id="7563052">nil</span>&nbsp;<span class="op" id="7563056">}</span><br>
<span class="lineno"></span><span class="keyword" id="7563058">func</span>&nbsp;<span class="op" id="7563063">(</span><span class="ident" id="7563064">f</span>&nbsp;<span class="ident" id="7563066">faker</span><span class="op" id="7563071">)</span>&nbsp;<span class="ident" id="7563073">RemoteAddr</span><span class="op" id="7563083">(</span><span class="op" id="7563084">)</span>&nbsp;<span class="ident" id="7563086">net</span><span class="op" id="7563089">.</span><span class="ident" id="7563090">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7563107">{</span>&nbsp;<span class="keyword" id="7563109">return</span>&nbsp;<span class="ident" id="7563116">nil</span>&nbsp;<span class="op" id="7563120">}</span><br>
<span class="lineno"></span><span class="keyword" id="7563122">func</span>&nbsp;<span class="op" id="7563127">(</span><span class="ident" id="7563128">f</span>&nbsp;<span class="ident" id="7563130">faker</span><span class="op" id="7563135">)</span>&nbsp;<span class="ident" id="7563137">SetDeadline</span><span class="op" id="7563148">(</span><span class="ident" id="7563149">time</span><span class="op" id="7563153">.</span><span class="ident" id="7563154">Time</span><span class="op" id="7563158">)</span>&nbsp;<span class="builtintype" id="7563160">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7563171">{</span>&nbsp;<span class="keyword" id="7563173">return</span>&nbsp;<span class="ident" id="7563180">nil</span>&nbsp;<span class="op" id="7563184">}</span><br>
<span class="lineno">105</span><span class="keyword" id="7563186">func</span>&nbsp;<span class="op" id="7563191">(</span><span class="ident" id="7563192">f</span>&nbsp;<span class="ident" id="7563194">faker</span><span class="op" id="7563199">)</span>&nbsp;<span class="ident" id="7563201">SetReadDeadline</span><span class="op" id="7563216">(</span><span class="ident" id="7563217">time</span><span class="op" id="7563221">.</span><span class="ident" id="7563222">Time</span><span class="op" id="7563226">)</span>&nbsp;<span class="builtintype" id="7563228">error</span>&nbsp;&nbsp;<span class="op" id="7563235">{</span>&nbsp;<span class="keyword" id="7563237">return</span>&nbsp;<span class="ident" id="7563244">nil</span>&nbsp;<span class="op" id="7563248">}</span><br>
<span class="lineno"></span><span class="keyword" id="7563250">func</span>&nbsp;<span class="op" id="7563255">(</span><span class="ident" id="7563256">f</span>&nbsp;<span class="ident" id="7563258">faker</span><span class="op" id="7563263">)</span>&nbsp;<span class="ident" id="7563265">SetWriteDeadline</span><span class="op" id="7563281">(</span><span class="ident" id="7563282">time</span><span class="op" id="7563286">.</span><span class="ident" id="7563287">Time</span><span class="op" id="7563291">)</span>&nbsp;<span class="builtintype" id="7563293">error</span>&nbsp;<span class="op" id="7563299">{</span>&nbsp;<span class="keyword" id="7563301">return</span>&nbsp;<span class="ident" id="7563308">nil</span>&nbsp;<span class="op" id="7563312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7563315">func</span>&nbsp;<span class="ident" id="7563320">TestBasic</span><span class="op" id="7563329">(</span><span class="ident" id="7563330">t</span>&nbsp;<span class="op" id="7563332">*</span><span class="ident" id="7563333">testing</span><span class="op" id="7563340">.</span><span class="ident" id="7563341">T</span><span class="op" id="7563342">)</span>&nbsp;<span class="op" id="7563344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563347">server</span>&nbsp;<span class="op" id="7563354">:=</span>&nbsp;<span class="ident" id="7563357">strings</span><span class="op" id="7563364">.</span><span class="ident" id="7563365">Join</span><span class="op" id="7563369">(</span><span class="ident" id="7563370">strings</span><span class="op" id="7563377">.</span><span class="ident" id="7563378">Split</span><span class="op" id="7563383">(</span><span class="ident" id="7563384">basicServer</span><span class="op" id="7563395">,</span>&nbsp;<span class="string" id="7563397">&#34;\n&#34;</span><span class="op" id="7563401">)</span><span class="op" id="7563402">,</span>&nbsp;<span class="string" id="7563404">&#34;\r\n&#34;</span><span class="op" id="7563410">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563413">client</span>&nbsp;<span class="op" id="7563420">:=</span>&nbsp;<span class="ident" id="7563423">strings</span><span class="op" id="7563430">.</span><span class="ident" id="7563431">Join</span><span class="op" id="7563435">(</span><span class="ident" id="7563436">strings</span><span class="op" id="7563443">.</span><span class="ident" id="7563444">Split</span><span class="op" id="7563449">(</span><span class="ident" id="7563450">basicClient</span><span class="op" id="7563461">,</span>&nbsp;<span class="string" id="7563463">&#34;\n&#34;</span><span class="op" id="7563467">)</span><span class="op" id="7563468">,</span>&nbsp;<span class="string" id="7563470">&#34;\r\n&#34;</span><span class="op" id="7563476">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563480">var</span>&nbsp;<span class="ident" id="7563484">cmdbuf</span>&nbsp;<span class="ident" id="7563491">bytes</span><span class="op" id="7563496">.</span><span class="ident" id="7563497">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563505">bcmdbuf</span>&nbsp;<span class="op" id="7563513">:=</span>&nbsp;<span class="ident" id="7563516">bufio</span><span class="op" id="7563521">.</span><span class="ident" id="7563522">NewWriter</span><span class="op" id="7563531">(</span><span class="op" id="7563532">&amp;</span><span class="ident" id="7563533">cmdbuf</span><span class="op" id="7563539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563542">var</span>&nbsp;<span class="ident" id="7563546">fake</span>&nbsp;<span class="ident" id="7563551">faker</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563558">fake</span><span class="op" id="7563562">.</span><span class="ident" id="7563563">ReadWriter</span>&nbsp;<span class="op" id="7563574">=</span>&nbsp;<span class="ident" id="7563576">bufio</span><span class="op" id="7563581">.</span><span class="ident" id="7563582">NewReadWriter</span><span class="op" id="7563595">(</span><span class="ident" id="7563596">bufio</span><span class="op" id="7563601">.</span><span class="ident" id="7563602">NewReader</span><span class="op" id="7563611">(</span><span class="ident" id="7563612">strings</span><span class="op" id="7563619">.</span><span class="ident" id="7563620">NewReader</span><span class="op" id="7563629">(</span><span class="ident" id="7563630">server</span><span class="op" id="7563636">)</span><span class="op" id="7563637">)</span><span class="op" id="7563638">,</span>&nbsp;<span class="ident" id="7563640">bcmdbuf</span><span class="op" id="7563647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563650">c</span>&nbsp;<span class="op" id="7563652">:=</span>&nbsp;<span class="op" id="7563655">&amp;</span><span class="ident" id="7563656">Client</span><span class="op" id="7563662">{</span><span class="ident" id="7563663">Text</span><span class="op" id="7563667">:</span>&nbsp;<span class="ident" id="7563669">textproto</span><span class="op" id="7563678">.</span><span class="ident" id="7563679">NewConn</span><span class="op" id="7563686">(</span><span class="ident" id="7563687">fake</span><span class="op" id="7563691">)</span><span class="op" id="7563692">,</span>&nbsp;<span class="ident" id="7563694">localName</span><span class="op" id="7563703">:</span>&nbsp;<span class="string" id="7563705">&#34;localhost&#34;</span><span class="op" id="7563716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563720">if</span>&nbsp;<span class="ident" id="7563723">err</span>&nbsp;<span class="op" id="7563727">:=</span>&nbsp;<span class="ident" id="7563730">c</span><span class="op" id="7563731">.</span><span class="ident" id="7563732">helo</span><span class="op" id="7563736">(</span><span class="op" id="7563737">)</span><span class="op" id="7563738">;</span>&nbsp;<span class="ident" id="7563740">err</span>&nbsp;<span class="op" id="7563744">!=</span>&nbsp;<span class="ident" id="7563747">nil</span>&nbsp;<span class="op" id="7563751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563755">t</span><span class="op" id="7563756">.</span><span class="ident" id="7563757">Fatalf</span><span class="op" id="7563763">(</span><span class="string" id="7563764">&#34;HELO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7563781">,</span>&nbsp;<span class="ident" id="7563783">err</span><span class="op" id="7563786">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7563789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563792">if</span>&nbsp;<span class="ident" id="7563795">err</span>&nbsp;<span class="op" id="7563799">:=</span>&nbsp;<span class="ident" id="7563802">c</span><span class="op" id="7563803">.</span><span class="ident" id="7563804">ehlo</span><span class="op" id="7563808">(</span><span class="op" id="7563809">)</span><span class="op" id="7563810">;</span>&nbsp;<span class="ident" id="7563812">err</span>&nbsp;<span class="op" id="7563816">==</span>&nbsp;<span class="ident" id="7563819">nil</span>&nbsp;<span class="op" id="7563823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563827">t</span><span class="op" id="7563828">.</span><span class="ident" id="7563829">Fatalf</span><span class="op" id="7563835">(</span><span class="string" id="7563836">&#34;Expected&nbsp;first&nbsp;EHLO&nbsp;to&nbsp;fail&#34;</span><span class="op" id="7563865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7563868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563871">if</span>&nbsp;<span class="ident" id="7563874">err</span>&nbsp;<span class="op" id="7563878">:=</span>&nbsp;<span class="ident" id="7563881">c</span><span class="op" id="7563882">.</span><span class="ident" id="7563883">ehlo</span><span class="op" id="7563887">(</span><span class="op" id="7563888">)</span><span class="op" id="7563889">;</span>&nbsp;<span class="ident" id="7563891">err</span>&nbsp;<span class="op" id="7563895">!=</span>&nbsp;<span class="ident" id="7563898">nil</span>&nbsp;<span class="op" id="7563902">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563906">t</span><span class="op" id="7563907">.</span><span class="ident" id="7563908">Fatalf</span><span class="op" id="7563914">(</span><span class="string" id="7563915">&#34;Second&nbsp;EHLO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7563939">,</span>&nbsp;<span class="ident" id="7563941">err</span><span class="op" id="7563944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7563947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7563951">c</span><span class="op" id="7563952">.</span><span class="ident" id="7563953">didHello</span>&nbsp;<span class="op" id="7563962">=</span>&nbsp;<span class="builtintype" id="7563964">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7563970">if</span>&nbsp;<span class="ident" id="7563973">ok</span><span class="op" id="7563975">,</span>&nbsp;<span class="ident" id="7563977">args</span>&nbsp;<span class="op" id="7563982">:=</span>&nbsp;<span class="ident" id="7563985">c</span><span class="op" id="7563986">.</span><span class="ident" id="7563987">Extension</span><span class="op" id="7563996">(</span><span class="string" id="7563997">&#34;aUtH&#34;</span><span class="op" id="7564003">)</span><span class="op" id="7564004">;</span>&nbsp;<span class="op" id="7564006">!</span><span class="ident" id="7564007">ok</span>&nbsp;<span class="op" id="7564010">||</span>&nbsp;<span class="ident" id="7564013">args</span>&nbsp;<span class="op" id="7564018">!=</span>&nbsp;<span class="string" id="7564021">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="7564035">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564039">t</span><span class="op" id="7564040">.</span><span class="ident" id="7564041">Fatalf</span><span class="op" id="7564047">(</span><span class="string" id="7564048">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="7564073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7564076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564079">if</span>&nbsp;<span class="ident" id="7564082">ok</span><span class="op" id="7564084">,</span>&nbsp;<span class="ident" id="7564086">_</span>&nbsp;<span class="op" id="7564088">:=</span>&nbsp;<span class="ident" id="7564091">c</span><span class="op" id="7564092">.</span><span class="ident" id="7564093">Extension</span><span class="op" id="7564102">(</span><span class="string" id="7564103">&#34;DSN&#34;</span><span class="op" id="7564108">)</span><span class="op" id="7564109">;</span>&nbsp;<span class="ident" id="7564111">ok</span>&nbsp;<span class="op" id="7564114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564118">t</span><span class="op" id="7564119">.</span><span class="ident" id="7564120">Fatalf</span><span class="op" id="7564126">(</span><span class="string" id="7564127">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="7564150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7564153">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564157">if</span>&nbsp;<span class="ident" id="7564160">err</span>&nbsp;<span class="op" id="7564164">:=</span>&nbsp;<span class="ident" id="7564167">c</span><span class="op" id="7564168">.</span><span class="ident" id="7564169">Mail</span><span class="op" id="7564173">(</span><span class="string" id="7564174">&#34;user@gmail.com&#34;</span><span class="op" id="7564190">)</span><span class="op" id="7564191">;</span>&nbsp;<span class="ident" id="7564193">err</span>&nbsp;<span class="op" id="7564197">==</span>&nbsp;<span class="ident" id="7564200">nil</span>&nbsp;<span class="op" id="7564204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564208">t</span><span class="op" id="7564209">.</span><span class="ident" id="7564210">Fatalf</span><span class="op" id="7564216">(</span><span class="string" id="7564217">&#34;MAIL&nbsp;should&nbsp;require&nbsp;authentication&#34;</span><span class="op" id="7564253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7564256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564260">if</span>&nbsp;<span class="ident" id="7564263">err</span>&nbsp;<span class="op" id="7564267">:=</span>&nbsp;<span class="ident" id="7564270">c</span><span class="op" id="7564271">.</span><span class="ident" id="7564272">Verify</span><span class="op" id="7564278">(</span><span class="string" id="7564279">&#34;user1@gmail.com&#34;</span><span class="op" id="7564296">)</span><span class="op" id="7564297">;</span>&nbsp;<span class="ident" id="7564299">err</span>&nbsp;<span class="op" id="7564303">==</span>&nbsp;<span class="ident" id="7564306">nil</span>&nbsp;<span class="op" id="7564310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564314">t</span><span class="op" id="7564315">.</span><span class="ident" id="7564316">Fatalf</span><span class="op" id="7564322">(</span><span class="string" id="7564323">&#34;First&nbsp;VRFY:&nbsp;expected&nbsp;no&nbsp;verification&#34;</span><span class="op" id="7564361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7564364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564367">if</span>&nbsp;<span class="ident" id="7564370">err</span>&nbsp;<span class="op" id="7564374">:=</span>&nbsp;<span class="ident" id="7564377">c</span><span class="op" id="7564378">.</span><span class="ident" id="7564379">Verify</span><span class="op" id="7564385">(</span><span class="string" id="7564386">&#34;user2@gmail.com&#34;</span><span class="op" id="7564403">)</span><span class="op" id="7564404">;</span>&nbsp;<span class="ident" id="7564406">err</span>&nbsp;<span class="op" id="7564410">!=</span>&nbsp;<span class="ident" id="7564413">nil</span>&nbsp;<span class="op" id="7564417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564421">t</span><span class="op" id="7564422">.</span><span class="ident" id="7564423">Fatalf</span><span class="op" id="7564429">(</span><span class="string" id="7564430">&#34;Second&nbsp;VRFY:&nbsp;expected&nbsp;verification,&nbsp;got&nbsp;%s&#34;</span><span class="op" id="7564474">,</span>&nbsp;<span class="ident" id="7564476">err</span><span class="op" id="7564479">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7564482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7564486">//&nbsp;fake&nbsp;TLS&nbsp;so&nbsp;authentication&nbsp;won&#39;t&nbsp;complain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564532">c</span><span class="op" id="7564533">.</span><span class="ident" id="7564534">tls</span>&nbsp;<span class="op" id="7564538">=</span>&nbsp;<span class="builtintype" id="7564540">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564546">c</span><span class="op" id="7564547">.</span><span class="ident" id="7564548">serverName</span>&nbsp;<span class="op" id="7564559">=</span>&nbsp;<span class="string" id="7564561">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564580">if</span>&nbsp;<span class="ident" id="7564583">err</span>&nbsp;<span class="op" id="7564587">:=</span>&nbsp;<span class="ident" id="7564590">c</span><span class="op" id="7564591">.</span><span class="ident" id="7564592">Auth</span><span class="op" id="7564596">(</span><span class="ident" id="7564597">PlainAuth</span><span class="op" id="7564606">(</span><span class="string" id="7564607">&#34;&#34;</span><span class="op" id="7564609">,</span>&nbsp;<span class="string" id="7564611">&#34;user&#34;</span><span class="op" id="7564617">,</span>&nbsp;<span class="string" id="7564619">&#34;pass&#34;</span><span class="op" id="7564625">,</span>&nbsp;<span class="string" id="7564627">&#34;smtp.google.com&#34;</span><span class="op" id="7564644">)</span><span class="op" id="7564645">)</span><span class="op" id="7564646">;</span>&nbsp;<span class="ident" id="7564648">err</span>&nbsp;<span class="op" id="7564652">!=</span>&nbsp;<span class="ident" id="7564655">nil</span>&nbsp;<span class="op" id="7564659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564663">t</span><span class="op" id="7564664">.</span><span class="ident" id="7564665">Fatalf</span><span class="op" id="7564671">(</span><span class="string" id="7564672">&#34;AUTH&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7564689">,</span>&nbsp;<span class="ident" id="7564691">err</span><span class="op" id="7564694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7564697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564701">if</span>&nbsp;<span class="ident" id="7564704">err</span>&nbsp;<span class="op" id="7564708">:=</span>&nbsp;<span class="ident" id="7564711">c</span><span class="op" id="7564712">.</span><span class="ident" id="7564713">Mail</span><span class="op" id="7564717">(</span><span class="string" id="7564718">&#34;user@gmail.com&#34;</span><span class="op" id="7564734">)</span><span class="op" id="7564735">;</span>&nbsp;<span class="ident" id="7564737">err</span>&nbsp;<span class="op" id="7564741">!=</span>&nbsp;<span class="ident" id="7564744">nil</span>&nbsp;<span class="op" id="7564748">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564752">t</span><span class="op" id="7564753">.</span><span class="ident" id="7564754">Fatalf</span><span class="op" id="7564760">(</span><span class="string" id="7564761">&#34;MAIL&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7564778">,</span>&nbsp;<span class="ident" id="7564780">err</span><span class="op" id="7564783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7564786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7564789">if</span>&nbsp;<span class="ident" id="7564792">err</span>&nbsp;<span class="op" id="7564796">:=</span>&nbsp;<span class="ident" id="7564799">c</span><span class="op" id="7564800">.</span><span class="ident" id="7564801">Rcpt</span><span class="op" id="7564805">(</span><span class="string" id="7564806">&#34;golang-nuts@googlegroups.com&#34;</span><span class="op" id="7564836">)</span><span class="op" id="7564837">;</span>&nbsp;<span class="ident" id="7564839">err</span>&nbsp;<span class="op" id="7564843">!=</span>&nbsp;<span class="ident" id="7564846">nil</span>&nbsp;<span class="op" id="7564850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564854">t</span><span class="op" id="7564855">.</span><span class="ident" id="7564856">Fatalf</span><span class="op" id="7564862">(</span><span class="string" id="7564863">&#34;RCPT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7564880">,</span>&nbsp;<span class="ident" id="7564882">err</span><span class="op" id="7564885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7564888">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7564891">msg</span>&nbsp;<span class="op" id="7564895">:=</span>&nbsp;<span class="string" id="7564898">`From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno"></span>Line&nbsp;1<br>
<span class="lineno">165</span>.Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565015">w</span><span class="op" id="7565016">,</span>&nbsp;<span class="ident" id="7565018">err</span>&nbsp;<span class="op" id="7565022">:=</span>&nbsp;<span class="ident" id="7565025">c</span><span class="op" id="7565026">.</span><span class="ident" id="7565027">Data</span><span class="op" id="7565031">(</span><span class="op" id="7565032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565035">if</span>&nbsp;<span class="ident" id="7565038">err</span>&nbsp;<span class="op" id="7565042">!=</span>&nbsp;<span class="ident" id="7565045">nil</span>&nbsp;<span class="op" id="7565049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565053">t</span><span class="op" id="7565054">.</span><span class="ident" id="7565055">Fatalf</span><span class="op" id="7565061">(</span><span class="string" id="7565062">&#34;DATA&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7565079">,</span>&nbsp;<span class="ident" id="7565081">err</span><span class="op" id="7565084">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7565087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565090">if</span>&nbsp;<span class="ident" id="7565093">_</span><span class="op" id="7565094">,</span>&nbsp;<span class="ident" id="7565096">err</span>&nbsp;<span class="op" id="7565100">:=</span>&nbsp;<span class="ident" id="7565103">w</span><span class="op" id="7565104">.</span><span class="ident" id="7565105">Write</span><span class="op" id="7565110">(</span><span class="op" id="7565111">[</span><span class="op" id="7565112">]</span><span class="builtintype" id="7565113">byte</span><span class="op" id="7565117">(</span><span class="ident" id="7565118">msg</span><span class="op" id="7565121">)</span><span class="op" id="7565122">)</span><span class="op" id="7565123">;</span>&nbsp;<span class="ident" id="7565125">err</span>&nbsp;<span class="op" id="7565129">!=</span>&nbsp;<span class="ident" id="7565132">nil</span>&nbsp;<span class="op" id="7565136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565140">t</span><span class="op" id="7565141">.</span><span class="ident" id="7565142">Fatalf</span><span class="op" id="7565148">(</span><span class="string" id="7565149">&#34;Data&nbsp;write&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7565172">,</span>&nbsp;<span class="ident" id="7565174">err</span><span class="op" id="7565177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7565180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565183">if</span>&nbsp;<span class="ident" id="7565186">err</span>&nbsp;<span class="op" id="7565190">:=</span>&nbsp;<span class="ident" id="7565193">w</span><span class="op" id="7565194">.</span><span class="ident" id="7565195">Close</span><span class="op" id="7565200">(</span><span class="op" id="7565201">)</span><span class="op" id="7565202">;</span>&nbsp;<span class="ident" id="7565204">err</span>&nbsp;<span class="op" id="7565208">!=</span>&nbsp;<span class="ident" id="7565211">nil</span>&nbsp;<span class="op" id="7565215">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565219">t</span><span class="op" id="7565220">.</span><span class="ident" id="7565221">Fatalf</span><span class="op" id="7565227">(</span><span class="string" id="7565228">&#34;Bad&nbsp;data&nbsp;response:&nbsp;%s&#34;</span><span class="op" id="7565251">,</span>&nbsp;<span class="ident" id="7565253">err</span><span class="op" id="7565256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7565259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565263">if</span>&nbsp;<span class="ident" id="7565266">err</span>&nbsp;<span class="op" id="7565270">:=</span>&nbsp;<span class="ident" id="7565273">c</span><span class="op" id="7565274">.</span><span class="ident" id="7565275">Quit</span><span class="op" id="7565279">(</span><span class="op" id="7565280">)</span><span class="op" id="7565281">;</span>&nbsp;<span class="ident" id="7565283">err</span>&nbsp;<span class="op" id="7565287">!=</span>&nbsp;<span class="ident" id="7565290">nil</span>&nbsp;<span class="op" id="7565294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565298">t</span><span class="op" id="7565299">.</span><span class="ident" id="7565300">Fatalf</span><span class="op" id="7565306">(</span><span class="string" id="7565307">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7565324">,</span>&nbsp;<span class="ident" id="7565326">err</span><span class="op" id="7565329">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7565332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565336">bcmdbuf</span><span class="op" id="7565343">.</span><span class="ident" id="7565344">Flush</span><span class="op" id="7565349">(</span><span class="op" id="7565350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565353">actualcmds</span>&nbsp;<span class="op" id="7565364">:=</span>&nbsp;<span class="ident" id="7565367">cmdbuf</span><span class="op" id="7565373">.</span><span class="ident" id="7565374">String</span><span class="op" id="7565380">(</span><span class="op" id="7565381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7565384">if</span>&nbsp;<span class="ident" id="7565387">client</span>&nbsp;<span class="op" id="7565394">!=</span>&nbsp;<span class="ident" id="7565397">actualcmds</span>&nbsp;<span class="op" id="7565408">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565412">t</span><span class="op" id="7565413">.</span><span class="ident" id="7565414">Fatalf</span><span class="op" id="7565420">(</span><span class="string" id="7565421">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7565446">,</span>&nbsp;<span class="ident" id="7565448">actualcmds</span><span class="op" id="7565458">,</span>&nbsp;<span class="ident" id="7565460">client</span><span class="op" id="7565466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7565469">}</span><br>
<span class="lineno"></span><span class="op" id="7565471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7565474">var</span>&nbsp;<span class="ident" id="7565478">basicServer</span>&nbsp;<span class="op" id="7565490">=</span>&nbsp;<span class="string" id="7565492">`250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno">190</span>502&nbsp;Unrecognized&nbsp;command.<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">195</span>530&nbsp;Authentication&nbsp;required<br>
<span class="lineno"></span>252&nbsp;Send&nbsp;some&nbsp;mail,&nbsp;I&#39;ll&nbsp;try&nbsp;my&nbsp;best<br>
<span class="lineno"></span>250&nbsp;User&nbsp;is&nbsp;valid<br>
<span class="lineno"></span>235&nbsp;Accepted<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;OK<br>
<span class="lineno">200</span>250&nbsp;Receiver&nbsp;OK<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;OK<br>
<span class="lineno"></span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="7565800">var</span>&nbsp;<span class="ident" id="7565804">basicClient</span>&nbsp;<span class="op" id="7565816">=</span>&nbsp;<span class="string" id="7565818">`HELO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno">210</span>VRFY&nbsp;user1@gmail.com<br>
<span class="lineno"></span>VRFY&nbsp;user2@gmail.com<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;golang-nuts@googlegroups.com&gt;<br>
<span class="lineno">215</span>DATA<br>
<span class="lineno"></span>From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno">220</span>Line&nbsp;1<br>
<span class="lineno"></span>..Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">225</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7566185">func</span>&nbsp;<span class="ident" id="7566190">TestNewClient</span><span class="op" id="7566203">(</span><span class="ident" id="7566204">t</span>&nbsp;<span class="op" id="7566206">*</span><span class="ident" id="7566207">testing</span><span class="op" id="7566214">.</span><span class="ident" id="7566215">T</span><span class="op" id="7566216">)</span>&nbsp;<span class="op" id="7566218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566221">server</span>&nbsp;<span class="op" id="7566228">:=</span>&nbsp;<span class="ident" id="7566231">strings</span><span class="op" id="7566238">.</span><span class="ident" id="7566239">Join</span><span class="op" id="7566243">(</span><span class="ident" id="7566244">strings</span><span class="op" id="7566251">.</span><span class="ident" id="7566252">Split</span><span class="op" id="7566257">(</span><span class="ident" id="7566258">newClientServer</span><span class="op" id="7566273">,</span>&nbsp;<span class="string" id="7566275">&#34;\n&#34;</span><span class="op" id="7566279">)</span><span class="op" id="7566280">,</span>&nbsp;<span class="string" id="7566282">&#34;\r\n&#34;</span><span class="op" id="7566288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566291">client</span>&nbsp;<span class="op" id="7566298">:=</span>&nbsp;<span class="ident" id="7566301">strings</span><span class="op" id="7566308">.</span><span class="ident" id="7566309">Join</span><span class="op" id="7566313">(</span><span class="ident" id="7566314">strings</span><span class="op" id="7566321">.</span><span class="ident" id="7566322">Split</span><span class="op" id="7566327">(</span><span class="ident" id="7566328">newClientClient</span><span class="op" id="7566343">,</span>&nbsp;<span class="string" id="7566345">&#34;\n&#34;</span><span class="op" id="7566349">)</span><span class="op" id="7566350">,</span>&nbsp;<span class="string" id="7566352">&#34;\r\n&#34;</span><span class="op" id="7566358">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566362">var</span>&nbsp;<span class="ident" id="7566366">cmdbuf</span>&nbsp;<span class="ident" id="7566373">bytes</span><span class="op" id="7566378">.</span><span class="ident" id="7566379">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566387">bcmdbuf</span>&nbsp;<span class="op" id="7566395">:=</span>&nbsp;<span class="ident" id="7566398">bufio</span><span class="op" id="7566403">.</span><span class="ident" id="7566404">NewWriter</span><span class="op" id="7566413">(</span><span class="op" id="7566414">&amp;</span><span class="ident" id="7566415">cmdbuf</span><span class="op" id="7566421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566424">out</span>&nbsp;<span class="op" id="7566428">:=</span>&nbsp;<span class="keyword" id="7566431">func</span><span class="op" id="7566435">(</span><span class="op" id="7566436">)</span>&nbsp;<span class="builtintype" id="7566438">string</span>&nbsp;<span class="op" id="7566445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566449">bcmdbuf</span><span class="op" id="7566456">.</span><span class="ident" id="7566457">Flush</span><span class="op" id="7566462">(</span><span class="op" id="7566463">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566467">return</span>&nbsp;<span class="ident" id="7566474">cmdbuf</span><span class="op" id="7566480">.</span><span class="ident" id="7566481">String</span><span class="op" id="7566487">(</span><span class="op" id="7566488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7566491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566494">var</span>&nbsp;<span class="ident" id="7566498">fake</span>&nbsp;<span class="ident" id="7566503">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566510">fake</span><span class="op" id="7566514">.</span><span class="ident" id="7566515">ReadWriter</span>&nbsp;<span class="op" id="7566526">=</span>&nbsp;<span class="ident" id="7566528">bufio</span><span class="op" id="7566533">.</span><span class="ident" id="7566534">NewReadWriter</span><span class="op" id="7566547">(</span><span class="ident" id="7566548">bufio</span><span class="op" id="7566553">.</span><span class="ident" id="7566554">NewReader</span><span class="op" id="7566563">(</span><span class="ident" id="7566564">strings</span><span class="op" id="7566571">.</span><span class="ident" id="7566572">NewReader</span><span class="op" id="7566581">(</span><span class="ident" id="7566582">server</span><span class="op" id="7566588">)</span><span class="op" id="7566589">)</span><span class="op" id="7566590">,</span>&nbsp;<span class="ident" id="7566592">bcmdbuf</span><span class="op" id="7566599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566602">c</span><span class="op" id="7566603">,</span>&nbsp;<span class="ident" id="7566605">err</span>&nbsp;<span class="op" id="7566609">:=</span>&nbsp;<span class="ident" id="7566612">NewClient</span><span class="op" id="7566621">(</span><span class="ident" id="7566622">fake</span><span class="op" id="7566626">,</span>&nbsp;<span class="string" id="7566628">&#34;fake.host&#34;</span><span class="op" id="7566639">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566642">if</span>&nbsp;<span class="ident" id="7566645">err</span>&nbsp;<span class="op" id="7566649">!=</span>&nbsp;<span class="ident" id="7566652">nil</span>&nbsp;<span class="op" id="7566656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566660">t</span><span class="op" id="7566661">.</span><span class="ident" id="7566662">Fatalf</span><span class="op" id="7566668">(</span><span class="string" id="7566669">&#34;NewClient:&nbsp;%v\n(after&nbsp;%v)&#34;</span><span class="op" id="7566696">,</span>&nbsp;<span class="ident" id="7566698">err</span><span class="op" id="7566701">,</span>&nbsp;<span class="ident" id="7566703">out</span><span class="op" id="7566706">(</span><span class="op" id="7566707">)</span><span class="op" id="7566708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7566711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566714">defer</span>&nbsp;<span class="ident" id="7566720">c</span><span class="op" id="7566721">.</span><span class="ident" id="7566722">Close</span><span class="op" id="7566727">(</span><span class="op" id="7566728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566731">if</span>&nbsp;<span class="ident" id="7566734">ok</span><span class="op" id="7566736">,</span>&nbsp;<span class="ident" id="7566738">args</span>&nbsp;<span class="op" id="7566743">:=</span>&nbsp;<span class="ident" id="7566746">c</span><span class="op" id="7566747">.</span><span class="ident" id="7566748">Extension</span><span class="op" id="7566757">(</span><span class="string" id="7566758">&#34;aUtH&#34;</span><span class="op" id="7566764">)</span><span class="op" id="7566765">;</span>&nbsp;<span class="op" id="7566767">!</span><span class="ident" id="7566768">ok</span>&nbsp;<span class="op" id="7566771">||</span>&nbsp;<span class="ident" id="7566774">args</span>&nbsp;<span class="op" id="7566779">!=</span>&nbsp;<span class="string" id="7566782">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="7566796">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566800">t</span><span class="op" id="7566801">.</span><span class="ident" id="7566802">Fatalf</span><span class="op" id="7566808">(</span><span class="string" id="7566809">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="7566834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7566837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566840">if</span>&nbsp;<span class="ident" id="7566843">ok</span><span class="op" id="7566845">,</span>&nbsp;<span class="ident" id="7566847">_</span>&nbsp;<span class="op" id="7566849">:=</span>&nbsp;<span class="ident" id="7566852">c</span><span class="op" id="7566853">.</span><span class="ident" id="7566854">Extension</span><span class="op" id="7566863">(</span><span class="string" id="7566864">&#34;DSN&#34;</span><span class="op" id="7566869">)</span><span class="op" id="7566870">;</span>&nbsp;<span class="ident" id="7566872">ok</span>&nbsp;<span class="op" id="7566875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566879">t</span><span class="op" id="7566880">.</span><span class="ident" id="7566881">Fatalf</span><span class="op" id="7566887">(</span><span class="string" id="7566888">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="7566911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7566914">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566917">if</span>&nbsp;<span class="ident" id="7566920">err</span>&nbsp;<span class="op" id="7566924">:=</span>&nbsp;<span class="ident" id="7566927">c</span><span class="op" id="7566928">.</span><span class="ident" id="7566929">Quit</span><span class="op" id="7566933">(</span><span class="op" id="7566934">)</span><span class="op" id="7566935">;</span>&nbsp;<span class="ident" id="7566937">err</span>&nbsp;<span class="op" id="7566941">!=</span>&nbsp;<span class="ident" id="7566944">nil</span>&nbsp;<span class="op" id="7566948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566952">t</span><span class="op" id="7566953">.</span><span class="ident" id="7566954">Fatalf</span><span class="op" id="7566960">(</span><span class="string" id="7566961">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7566978">,</span>&nbsp;<span class="ident" id="7566980">err</span><span class="op" id="7566983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7566986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566990">actualcmds</span>&nbsp;<span class="op" id="7567001">:=</span>&nbsp;<span class="ident" id="7567004">out</span><span class="op" id="7567007">(</span><span class="op" id="7567008">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7567011">if</span>&nbsp;<span class="ident" id="7567014">client</span>&nbsp;<span class="op" id="7567021">!=</span>&nbsp;<span class="ident" id="7567024">actualcmds</span>&nbsp;<span class="op" id="7567035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567039">t</span><span class="op" id="7567040">.</span><span class="ident" id="7567041">Fatalf</span><span class="op" id="7567047">(</span><span class="string" id="7567048">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7567073">,</span>&nbsp;<span class="ident" id="7567075">actualcmds</span><span class="op" id="7567085">,</span>&nbsp;<span class="ident" id="7567087">client</span><span class="op" id="7567093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7567096">}</span><br>
<span class="lineno"></span><span class="op" id="7567098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="keyword" id="7567101">var</span>&nbsp;<span class="ident" id="7567105">newClientServer</span>&nbsp;<span class="op" id="7567121">=</span>&nbsp;<span class="string" id="7567123">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">265</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7567236">var</span>&nbsp;<span class="ident" id="7567240">newClientClient</span>&nbsp;<span class="op" id="7567256">=</span>&nbsp;<span class="string" id="7567258">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">270</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7567282">func</span>&nbsp;<span class="ident" id="7567287">TestNewClient2</span><span class="op" id="7567301">(</span><span class="ident" id="7567302">t</span>&nbsp;<span class="op" id="7567304">*</span><span class="ident" id="7567305">testing</span><span class="op" id="7567312">.</span><span class="ident" id="7567313">T</span><span class="op" id="7567314">)</span>&nbsp;<span class="op" id="7567316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567319">server</span>&nbsp;<span class="op" id="7567326">:=</span>&nbsp;<span class="ident" id="7567329">strings</span><span class="op" id="7567336">.</span><span class="ident" id="7567337">Join</span><span class="op" id="7567341">(</span><span class="ident" id="7567342">strings</span><span class="op" id="7567349">.</span><span class="ident" id="7567350">Split</span><span class="op" id="7567355">(</span><span class="ident" id="7567356">newClient2Server</span><span class="op" id="7567372">,</span>&nbsp;<span class="string" id="7567374">&#34;\n&#34;</span><span class="op" id="7567378">)</span><span class="op" id="7567379">,</span>&nbsp;<span class="string" id="7567381">&#34;\r\n&#34;</span><span class="op" id="7567387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567390">client</span>&nbsp;<span class="op" id="7567397">:=</span>&nbsp;<span class="ident" id="7567400">strings</span><span class="op" id="7567407">.</span><span class="ident" id="7567408">Join</span><span class="op" id="7567412">(</span><span class="ident" id="7567413">strings</span><span class="op" id="7567420">.</span><span class="ident" id="7567421">Split</span><span class="op" id="7567426">(</span><span class="ident" id="7567427">newClient2Client</span><span class="op" id="7567443">,</span>&nbsp;<span class="string" id="7567445">&#34;\n&#34;</span><span class="op" id="7567449">)</span><span class="op" id="7567450">,</span>&nbsp;<span class="string" id="7567452">&#34;\r\n&#34;</span><span class="op" id="7567458">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7567462">var</span>&nbsp;<span class="ident" id="7567466">cmdbuf</span>&nbsp;<span class="ident" id="7567473">bytes</span><span class="op" id="7567478">.</span><span class="ident" id="7567479">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567487">bcmdbuf</span>&nbsp;<span class="op" id="7567495">:=</span>&nbsp;<span class="ident" id="7567498">bufio</span><span class="op" id="7567503">.</span><span class="ident" id="7567504">NewWriter</span><span class="op" id="7567513">(</span><span class="op" id="7567514">&amp;</span><span class="ident" id="7567515">cmdbuf</span><span class="op" id="7567521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7567524">var</span>&nbsp;<span class="ident" id="7567528">fake</span>&nbsp;<span class="ident" id="7567533">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567540">fake</span><span class="op" id="7567544">.</span><span class="ident" id="7567545">ReadWriter</span>&nbsp;<span class="op" id="7567556">=</span>&nbsp;<span class="ident" id="7567558">bufio</span><span class="op" id="7567563">.</span><span class="ident" id="7567564">NewReadWriter</span><span class="op" id="7567577">(</span><span class="ident" id="7567578">bufio</span><span class="op" id="7567583">.</span><span class="ident" id="7567584">NewReader</span><span class="op" id="7567593">(</span><span class="ident" id="7567594">strings</span><span class="op" id="7567601">.</span><span class="ident" id="7567602">NewReader</span><span class="op" id="7567611">(</span><span class="ident" id="7567612">server</span><span class="op" id="7567618">)</span><span class="op" id="7567619">)</span><span class="op" id="7567620">,</span>&nbsp;<span class="ident" id="7567622">bcmdbuf</span><span class="op" id="7567629">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567632">c</span><span class="op" id="7567633">,</span>&nbsp;<span class="ident" id="7567635">err</span>&nbsp;<span class="op" id="7567639">:=</span>&nbsp;<span class="ident" id="7567642">NewClient</span><span class="op" id="7567651">(</span><span class="ident" id="7567652">fake</span><span class="op" id="7567656">,</span>&nbsp;<span class="string" id="7567658">&#34;fake.host&#34;</span><span class="op" id="7567669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7567672">if</span>&nbsp;<span class="ident" id="7567675">err</span>&nbsp;<span class="op" id="7567679">!=</span>&nbsp;<span class="ident" id="7567682">nil</span>&nbsp;<span class="op" id="7567686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567690">t</span><span class="op" id="7567691">.</span><span class="ident" id="7567692">Fatalf</span><span class="op" id="7567698">(</span><span class="string" id="7567699">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="7567714">,</span>&nbsp;<span class="ident" id="7567716">err</span><span class="op" id="7567719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7567722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7567725">defer</span>&nbsp;<span class="ident" id="7567731">c</span><span class="op" id="7567732">.</span><span class="ident" id="7567733">Close</span><span class="op" id="7567738">(</span><span class="op" id="7567739">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7567742">if</span>&nbsp;<span class="ident" id="7567745">ok</span><span class="op" id="7567747">,</span>&nbsp;<span class="ident" id="7567749">_</span>&nbsp;<span class="op" id="7567751">:=</span>&nbsp;<span class="ident" id="7567754">c</span><span class="op" id="7567755">.</span><span class="ident" id="7567756">Extension</span><span class="op" id="7567765">(</span><span class="string" id="7567766">&#34;DSN&#34;</span><span class="op" id="7567771">)</span><span class="op" id="7567772">;</span>&nbsp;<span class="ident" id="7567774">ok</span>&nbsp;<span class="op" id="7567777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567781">t</span><span class="op" id="7567782">.</span><span class="ident" id="7567783">Fatalf</span><span class="op" id="7567789">(</span><span class="string" id="7567790">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="7567813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7567816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7567819">if</span>&nbsp;<span class="ident" id="7567822">err</span>&nbsp;<span class="op" id="7567826">:=</span>&nbsp;<span class="ident" id="7567829">c</span><span class="op" id="7567830">.</span><span class="ident" id="7567831">Quit</span><span class="op" id="7567835">(</span><span class="op" id="7567836">)</span><span class="op" id="7567837">;</span>&nbsp;<span class="ident" id="7567839">err</span>&nbsp;<span class="op" id="7567843">!=</span>&nbsp;<span class="ident" id="7567846">nil</span>&nbsp;<span class="op" id="7567850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567854">t</span><span class="op" id="7567855">.</span><span class="ident" id="7567856">Fatalf</span><span class="op" id="7567862">(</span><span class="string" id="7567863">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7567880">,</span>&nbsp;<span class="ident" id="7567882">err</span><span class="op" id="7567885">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7567888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567892">bcmdbuf</span><span class="op" id="7567899">.</span><span class="ident" id="7567900">Flush</span><span class="op" id="7567905">(</span><span class="op" id="7567906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567909">actualcmds</span>&nbsp;<span class="op" id="7567920">:=</span>&nbsp;<span class="ident" id="7567923">cmdbuf</span><span class="op" id="7567929">.</span><span class="ident" id="7567930">String</span><span class="op" id="7567936">(</span><span class="op" id="7567937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7567940">if</span>&nbsp;<span class="ident" id="7567943">client</span>&nbsp;<span class="op" id="7567950">!=</span>&nbsp;<span class="ident" id="7567953">actualcmds</span>&nbsp;<span class="op" id="7567964">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567968">t</span><span class="op" id="7567969">.</span><span class="ident" id="7567970">Fatalf</span><span class="op" id="7567976">(</span><span class="string" id="7567977">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7568002">,</span>&nbsp;<span class="ident" id="7568004">actualcmds</span><span class="op" id="7568014">,</span>&nbsp;<span class="ident" id="7568016">client</span><span class="op" id="7568022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7568025">}</span><br>
<span class="lineno"></span><span class="op" id="7568027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7568030">var</span>&nbsp;<span class="ident" id="7568034">newClient2Server</span>&nbsp;<span class="op" id="7568051">=</span>&nbsp;<span class="string" id="7568053">`220&nbsp;hello&nbsp;world<br>
<span class="lineno">300</span>502&nbsp;EH?<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">305</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7568174">var</span>&nbsp;<span class="ident" id="7568178">newClient2Client</span>&nbsp;<span class="op" id="7568195">=</span>&nbsp;<span class="string" id="7568197">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno">310</span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7568236">func</span>&nbsp;<span class="ident" id="7568241">TestHello</span><span class="op" id="7568250">(</span><span class="ident" id="7568251">t</span>&nbsp;<span class="op" id="7568253">*</span><span class="ident" id="7568254">testing</span><span class="op" id="7568261">.</span><span class="ident" id="7568262">T</span><span class="op" id="7568263">)</span>&nbsp;<span class="op" id="7568265">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7568269">if</span>&nbsp;<span class="builtinfunc" id="7568272">len</span><span class="op" id="7568275">(</span><span class="ident" id="7568276">helloServer</span><span class="op" id="7568287">)</span>&nbsp;<span class="op" id="7568289">!=</span>&nbsp;<span class="builtinfunc" id="7568292">len</span><span class="op" id="7568295">(</span><span class="ident" id="7568296">helloClient</span><span class="op" id="7568307">)</span>&nbsp;<span class="op" id="7568309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568313">t</span><span class="op" id="7568314">.</span><span class="ident" id="7568315">Fatalf</span><span class="op" id="7568321">(</span><span class="string" id="7568322">&#34;Hello&nbsp;server&nbsp;and&nbsp;client&nbsp;size&nbsp;mismatch&#34;</span><span class="op" id="7568361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7568364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7568368">for</span>&nbsp;<span class="ident" id="7568372">i</span>&nbsp;<span class="op" id="7568374">:=</span>&nbsp;<span class="num" id="7568377">0</span><span class="op" id="7568378">;</span>&nbsp;<span class="ident" id="7568380">i</span>&nbsp;<span class="op" id="7568382">&lt;</span>&nbsp;<span class="builtinfunc" id="7568384">len</span><span class="op" id="7568387">(</span><span class="ident" id="7568388">helloServer</span><span class="op" id="7568399">)</span><span class="op" id="7568400">;</span>&nbsp;<span class="ident" id="7568402">i</span><span class="op" id="7568403">++</span>&nbsp;<span class="op" id="7568406">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568410">server</span>&nbsp;<span class="op" id="7568417">:=</span>&nbsp;<span class="ident" id="7568420">strings</span><span class="op" id="7568427">.</span><span class="ident" id="7568428">Join</span><span class="op" id="7568432">(</span><span class="ident" id="7568433">strings</span><span class="op" id="7568440">.</span><span class="ident" id="7568441">Split</span><span class="op" id="7568446">(</span><span class="ident" id="7568447">baseHelloServer</span><span class="op" id="7568462">+</span><span class="ident" id="7568463">helloServer</span><span class="op" id="7568474">[</span><span class="ident" id="7568475">i</span><span class="op" id="7568476">]</span><span class="op" id="7568477">,</span>&nbsp;<span class="string" id="7568479">&#34;\n&#34;</span><span class="op" id="7568483">)</span><span class="op" id="7568484">,</span>&nbsp;<span class="string" id="7568486">&#34;\r\n&#34;</span><span class="op" id="7568492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568496">client</span>&nbsp;<span class="op" id="7568503">:=</span>&nbsp;<span class="ident" id="7568506">strings</span><span class="op" id="7568513">.</span><span class="ident" id="7568514">Join</span><span class="op" id="7568518">(</span><span class="ident" id="7568519">strings</span><span class="op" id="7568526">.</span><span class="ident" id="7568527">Split</span><span class="op" id="7568532">(</span><span class="ident" id="7568533">baseHelloClient</span><span class="op" id="7568548">+</span><span class="ident" id="7568549">helloClient</span><span class="op" id="7568560">[</span><span class="ident" id="7568561">i</span><span class="op" id="7568562">]</span><span class="op" id="7568563">,</span>&nbsp;<span class="string" id="7568565">&#34;\n&#34;</span><span class="op" id="7568569">)</span><span class="op" id="7568570">,</span>&nbsp;<span class="string" id="7568572">&#34;\r\n&#34;</span><span class="op" id="7568578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7568582">var</span>&nbsp;<span class="ident" id="7568586">cmdbuf</span>&nbsp;<span class="ident" id="7568593">bytes</span><span class="op" id="7568598">.</span><span class="ident" id="7568599">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568608">bcmdbuf</span>&nbsp;<span class="op" id="7568616">:=</span>&nbsp;<span class="ident" id="7568619">bufio</span><span class="op" id="7568624">.</span><span class="ident" id="7568625">NewWriter</span><span class="op" id="7568634">(</span><span class="op" id="7568635">&amp;</span><span class="ident" id="7568636">cmdbuf</span><span class="op" id="7568642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7568646">var</span>&nbsp;<span class="ident" id="7568650">fake</span>&nbsp;<span class="ident" id="7568655">faker</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568663">fake</span><span class="op" id="7568667">.</span><span class="ident" id="7568668">ReadWriter</span>&nbsp;<span class="op" id="7568679">=</span>&nbsp;<span class="ident" id="7568681">bufio</span><span class="op" id="7568686">.</span><span class="ident" id="7568687">NewReadWriter</span><span class="op" id="7568700">(</span><span class="ident" id="7568701">bufio</span><span class="op" id="7568706">.</span><span class="ident" id="7568707">NewReader</span><span class="op" id="7568716">(</span><span class="ident" id="7568717">strings</span><span class="op" id="7568724">.</span><span class="ident" id="7568725">NewReader</span><span class="op" id="7568734">(</span><span class="ident" id="7568735">server</span><span class="op" id="7568741">)</span><span class="op" id="7568742">)</span><span class="op" id="7568743">,</span>&nbsp;<span class="ident" id="7568745">bcmdbuf</span><span class="op" id="7568752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568756">c</span><span class="op" id="7568757">,</span>&nbsp;<span class="ident" id="7568759">err</span>&nbsp;<span class="op" id="7568763">:=</span>&nbsp;<span class="ident" id="7568766">NewClient</span><span class="op" id="7568775">(</span><span class="ident" id="7568776">fake</span><span class="op" id="7568780">,</span>&nbsp;<span class="string" id="7568782">&#34;fake.host&#34;</span><span class="op" id="7568793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7568797">if</span>&nbsp;<span class="ident" id="7568800">err</span>&nbsp;<span class="op" id="7568804">!=</span>&nbsp;<span class="ident" id="7568807">nil</span>&nbsp;<span class="op" id="7568811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568816">t</span><span class="op" id="7568817">.</span><span class="ident" id="7568818">Fatalf</span><span class="op" id="7568824">(</span><span class="string" id="7568825">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="7568840">,</span>&nbsp;<span class="ident" id="7568842">err</span><span class="op" id="7568845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7568849">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7568853">defer</span>&nbsp;<span class="ident" id="7568859">c</span><span class="op" id="7568860">.</span><span class="ident" id="7568861">Close</span><span class="op" id="7568866">(</span><span class="op" id="7568867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568871">c</span><span class="op" id="7568872">.</span><span class="ident" id="7568873">localName</span>&nbsp;<span class="op" id="7568883">=</span>&nbsp;<span class="string" id="7568885">&#34;customhost&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568900">err</span>&nbsp;<span class="op" id="7568904">=</span>&nbsp;<span class="ident" id="7568906">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7568913">switch</span>&nbsp;<span class="ident" id="7568920">i</span>&nbsp;<span class="op" id="7568922">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7568926">case</span>&nbsp;<span class="num" id="7568931">0</span><span class="op" id="7568932">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568937">err</span>&nbsp;<span class="op" id="7568941">=</span>&nbsp;<span class="ident" id="7568943">c</span><span class="op" id="7568944">.</span><span class="ident" id="7568945">Hello</span><span class="op" id="7568950">(</span><span class="string" id="7568951">&#34;customhost&#34;</span><span class="op" id="7568963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7568967">case</span>&nbsp;<span class="num" id="7568972">1</span><span class="op" id="7568973">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568978">err</span>&nbsp;<span class="op" id="7568982">=</span>&nbsp;<span class="ident" id="7568984">c</span><span class="op" id="7568985">.</span><span class="ident" id="7568986">StartTLS</span><span class="op" id="7568994">(</span><span class="ident" id="7568995">nil</span><span class="op" id="7568998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569003">if</span>&nbsp;<span class="ident" id="7569006">err</span><span class="op" id="7569009">.</span><span class="ident" id="7569010">Error</span><span class="op" id="7569015">(</span><span class="op" id="7569016">)</span>&nbsp;<span class="op" id="7569018">==</span>&nbsp;<span class="string" id="7569021">&#34;502&nbsp;Not&nbsp;implemented&#34;</span>&nbsp;<span class="op" id="7569043">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569049">err</span>&nbsp;<span class="op" id="7569053">=</span>&nbsp;<span class="ident" id="7569055">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7569062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569066">case</span>&nbsp;<span class="num" id="7569071">2</span><span class="op" id="7569072">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569077">err</span>&nbsp;<span class="op" id="7569081">=</span>&nbsp;<span class="ident" id="7569083">c</span><span class="op" id="7569084">.</span><span class="ident" id="7569085">Verify</span><span class="op" id="7569091">(</span><span class="string" id="7569092">&#34;test@example.com&#34;</span><span class="op" id="7569110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569114">case</span>&nbsp;<span class="num" id="7569119">3</span><span class="op" id="7569120">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569125">c</span><span class="op" id="7569126">.</span><span class="ident" id="7569127">tls</span>&nbsp;<span class="op" id="7569131">=</span>&nbsp;<span class="builtintype" id="7569133">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569141">c</span><span class="op" id="7569142">.</span><span class="ident" id="7569143">serverName</span>&nbsp;<span class="op" id="7569154">=</span>&nbsp;<span class="string" id="7569156">&#34;smtp.google.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569177">err</span>&nbsp;<span class="op" id="7569181">=</span>&nbsp;<span class="ident" id="7569183">c</span><span class="op" id="7569184">.</span><span class="ident" id="7569185">Auth</span><span class="op" id="7569189">(</span><span class="ident" id="7569190">PlainAuth</span><span class="op" id="7569199">(</span><span class="string" id="7569200">&#34;&#34;</span><span class="op" id="7569202">,</span>&nbsp;<span class="string" id="7569204">&#34;user&#34;</span><span class="op" id="7569210">,</span>&nbsp;<span class="string" id="7569212">&#34;pass&#34;</span><span class="op" id="7569218">,</span>&nbsp;<span class="string" id="7569220">&#34;smtp.google.com&#34;</span><span class="op" id="7569237">)</span><span class="op" id="7569238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569242">case</span>&nbsp;<span class="num" id="7569247">4</span><span class="op" id="7569248">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569253">err</span>&nbsp;<span class="op" id="7569257">=</span>&nbsp;<span class="ident" id="7569259">c</span><span class="op" id="7569260">.</span><span class="ident" id="7569261">Mail</span><span class="op" id="7569265">(</span><span class="string" id="7569266">&#34;test@example.com&#34;</span><span class="op" id="7569284">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569288">case</span>&nbsp;<span class="num" id="7569293">5</span><span class="op" id="7569294">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569299">ok</span><span class="op" id="7569301">,</span>&nbsp;<span class="ident" id="7569303">_</span>&nbsp;<span class="op" id="7569305">:=</span>&nbsp;<span class="ident" id="7569308">c</span><span class="op" id="7569309">.</span><span class="ident" id="7569310">Extension</span><span class="op" id="7569319">(</span><span class="string" id="7569320">&#34;feature&#34;</span><span class="op" id="7569329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569334">if</span>&nbsp;<span class="ident" id="7569337">ok</span>&nbsp;<span class="op" id="7569340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569346">t</span><span class="op" id="7569347">.</span><span class="ident" id="7569348">Errorf</span><span class="op" id="7569354">(</span><span class="string" id="7569355">&#34;Expected&nbsp;FEATURE&nbsp;not&nbsp;to&nbsp;be&nbsp;supported&#34;</span><span class="op" id="7569393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7569398">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569402">case</span>&nbsp;<span class="num" id="7569407">6</span><span class="op" id="7569408">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569413">err</span>&nbsp;<span class="op" id="7569417">=</span>&nbsp;<span class="ident" id="7569419">c</span><span class="op" id="7569420">.</span><span class="ident" id="7569421">Reset</span><span class="op" id="7569426">(</span><span class="op" id="7569427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569431">case</span>&nbsp;<span class="num" id="7569436">7</span><span class="op" id="7569437">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569442">err</span>&nbsp;<span class="op" id="7569446">=</span>&nbsp;<span class="ident" id="7569448">c</span><span class="op" id="7569449">.</span><span class="ident" id="7569450">Quit</span><span class="op" id="7569454">(</span><span class="op" id="7569455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569459">case</span>&nbsp;<span class="num" id="7569464">8</span><span class="op" id="7569465">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569470">err</span>&nbsp;<span class="op" id="7569474">=</span>&nbsp;<span class="ident" id="7569476">c</span><span class="op" id="7569477">.</span><span class="ident" id="7569478">Verify</span><span class="op" id="7569484">(</span><span class="string" id="7569485">&#34;test@example.com&#34;</span><span class="op" id="7569503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569508">if</span>&nbsp;<span class="ident" id="7569511">err</span>&nbsp;<span class="op" id="7569515">!=</span>&nbsp;<span class="ident" id="7569518">nil</span>&nbsp;<span class="op" id="7569522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569528">err</span>&nbsp;<span class="op" id="7569532">=</span>&nbsp;<span class="ident" id="7569534">c</span><span class="op" id="7569535">.</span><span class="ident" id="7569536">Hello</span><span class="op" id="7569541">(</span><span class="string" id="7569542">&#34;customhost&#34;</span><span class="op" id="7569554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569560">if</span>&nbsp;<span class="ident" id="7569563">err</span>&nbsp;<span class="op" id="7569567">!=</span>&nbsp;<span class="ident" id="7569570">nil</span>&nbsp;<span class="op" id="7569574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569581">t</span><span class="op" id="7569582">.</span><span class="ident" id="7569583">Errorf</span><span class="op" id="7569589">(</span><span class="string" id="7569590">&#34;Want&nbsp;error,&nbsp;got&nbsp;none&#34;</span><span class="op" id="7569612">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7569618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7569623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569627">default</span><span class="op" id="7569634">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569639">t</span><span class="op" id="7569640">.</span><span class="ident" id="7569641">Fatalf</span><span class="op" id="7569647">(</span><span class="string" id="7569648">&#34;Unhandled&nbsp;command&#34;</span><span class="op" id="7569667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7569671">}</span><br>
<span class="lineno">370</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569676">if</span>&nbsp;<span class="ident" id="7569679">err</span>&nbsp;<span class="op" id="7569683">!=</span>&nbsp;<span class="ident" id="7569686">nil</span>&nbsp;<span class="op" id="7569690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569695">t</span><span class="op" id="7569696">.</span><span class="ident" id="7569697">Errorf</span><span class="op" id="7569703">(</span><span class="string" id="7569704">&#34;Command&nbsp;%d&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7569727">,</span>&nbsp;<span class="ident" id="7569729">i</span><span class="op" id="7569730">,</span>&nbsp;<span class="ident" id="7569732">err</span><span class="op" id="7569735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7569739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569744">bcmdbuf</span><span class="op" id="7569751">.</span><span class="ident" id="7569752">Flush</span><span class="op" id="7569757">(</span><span class="op" id="7569758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569762">actualcmds</span>&nbsp;<span class="op" id="7569773">:=</span>&nbsp;<span class="ident" id="7569776">cmdbuf</span><span class="op" id="7569782">.</span><span class="ident" id="7569783">String</span><span class="op" id="7569789">(</span><span class="op" id="7569790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569794">if</span>&nbsp;<span class="ident" id="7569797">client</span>&nbsp;<span class="op" id="7569804">!=</span>&nbsp;<span class="ident" id="7569807">actualcmds</span>&nbsp;<span class="op" id="7569818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569823">t</span><span class="op" id="7569824">.</span><span class="ident" id="7569825">Errorf</span><span class="op" id="7569831">(</span><span class="string" id="7569832">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7569857">,</span>&nbsp;<span class="ident" id="7569859">actualcmds</span><span class="op" id="7569869">,</span>&nbsp;<span class="ident" id="7569871">client</span><span class="op" id="7569877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7569881">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7569884">}</span><br>
<span class="lineno"></span><span class="op" id="7569886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7569889">var</span>&nbsp;<span class="ident" id="7569893">baseHelloServer</span>&nbsp;<span class="op" id="7569909">=</span>&nbsp;<span class="string" id="7569911">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno">385</span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;FEATURE<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7569985">var</span>&nbsp;<span class="ident" id="7569989">helloServer</span>&nbsp;<span class="op" id="7570001">=</span>&nbsp;<span class="op" id="7570003">[</span><span class="op" id="7570004">]</span><span class="builtintype" id="7570005">string</span><span class="op" id="7570011">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570014">&#34;&#34;</span><span class="op" id="7570016">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570019">&#34;502&nbsp;Not&nbsp;implemented\n&#34;</span><span class="op" id="7570042">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570045">&#34;250&nbsp;User&nbsp;is&nbsp;valid\n&#34;</span><span class="op" id="7570066">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570069">&#34;235&nbsp;Accepted\n&#34;</span><span class="op" id="7570085">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570088">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="7570105">,</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570108">&#34;&#34;</span><span class="op" id="7570110">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570113">&#34;250&nbsp;Reset&nbsp;ok\n&#34;</span><span class="op" id="7570129">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570132">&#34;221&nbsp;Goodbye\n&#34;</span><span class="op" id="7570147">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570150">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="7570167">,</span><br>
<span class="lineno"></span><span class="op" id="7570169">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="7570172">var</span>&nbsp;<span class="ident" id="7570176">baseHelloClient</span>&nbsp;<span class="op" id="7570192">=</span>&nbsp;<span class="string" id="7570194">`EHLO&nbsp;customhost<br>
<span class="lineno"></span>HELO&nbsp;customhost<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="7570230">var</span>&nbsp;<span class="ident" id="7570234">helloClient</span>&nbsp;<span class="op" id="7570246">=</span>&nbsp;<span class="op" id="7570248">[</span><span class="op" id="7570249">]</span><span class="builtintype" id="7570250">string</span><span class="op" id="7570256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570259">&#34;&#34;</span><span class="op" id="7570261">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570264">&#34;STARTTLS\n&#34;</span><span class="op" id="7570276">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570279">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="7570304">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570307">&#34;AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==\n&#34;</span><span class="op" id="7570338">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570341">&#34;MAIL&nbsp;FROM:&lt;test@example.com&gt;\n&#34;</span><span class="op" id="7570373">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570376">&#34;&#34;</span><span class="op" id="7570378">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570381">&#34;RSET\n&#34;</span><span class="op" id="7570389">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570392">&#34;QUIT\n&#34;</span><span class="op" id="7570400">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7570403">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="7570428">,</span><br>
<span class="lineno">415</span><span class="op" id="7570430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7570433">func</span>&nbsp;<span class="ident" id="7570438">TestSendMail</span><span class="op" id="7570450">(</span><span class="ident" id="7570451">t</span>&nbsp;<span class="op" id="7570453">*</span><span class="ident" id="7570454">testing</span><span class="op" id="7570461">.</span><span class="ident" id="7570462">T</span><span class="op" id="7570463">)</span>&nbsp;<span class="op" id="7570465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7570468">server</span>&nbsp;<span class="op" id="7570475">:=</span>&nbsp;<span class="ident" id="7570478">strings</span><span class="op" id="7570485">.</span><span class="ident" id="7570486">Join</span><span class="op" id="7570490">(</span><span class="ident" id="7570491">strings</span><span class="op" id="7570498">.</span><span class="ident" id="7570499">Split</span><span class="op" id="7570504">(</span><span class="ident" id="7570505">sendMailServer</span><span class="op" id="7570519">,</span>&nbsp;<span class="string" id="7570521">&#34;\n&#34;</span><span class="op" id="7570525">)</span><span class="op" id="7570526">,</span>&nbsp;<span class="string" id="7570528">&#34;\r\n&#34;</span><span class="op" id="7570534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7570537">client</span>&nbsp;<span class="op" id="7570544">:=</span>&nbsp;<span class="ident" id="7570547">strings</span><span class="op" id="7570554">.</span><span class="ident" id="7570555">Join</span><span class="op" id="7570559">(</span><span class="ident" id="7570560">strings</span><span class="op" id="7570567">.</span><span class="ident" id="7570568">Split</span><span class="op" id="7570573">(</span><span class="ident" id="7570574">sendMailClient</span><span class="op" id="7570588">,</span>&nbsp;<span class="string" id="7570590">&#34;\n&#34;</span><span class="op" id="7570594">)</span><span class="op" id="7570595">,</span>&nbsp;<span class="string" id="7570597">&#34;\r\n&#34;</span><span class="op" id="7570603">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570606">var</span>&nbsp;<span class="ident" id="7570610">cmdbuf</span>&nbsp;<span class="ident" id="7570617">bytes</span><span class="op" id="7570622">.</span><span class="ident" id="7570623">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7570631">bcmdbuf</span>&nbsp;<span class="op" id="7570639">:=</span>&nbsp;<span class="ident" id="7570642">bufio</span><span class="op" id="7570647">.</span><span class="ident" id="7570648">NewWriter</span><span class="op" id="7570657">(</span><span class="op" id="7570658">&amp;</span><span class="ident" id="7570659">cmdbuf</span><span class="op" id="7570665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7570668">l</span><span class="op" id="7570669">,</span>&nbsp;<span class="ident" id="7570671">err</span>&nbsp;<span class="op" id="7570675">:=</span>&nbsp;<span class="ident" id="7570678">net</span><span class="op" id="7570681">.</span><span class="ident" id="7570682">Listen</span><span class="op" id="7570688">(</span><span class="string" id="7570689">&#34;tcp&#34;</span><span class="op" id="7570694">,</span>&nbsp;<span class="string" id="7570696">&#34;127.0.0.1:0&#34;</span><span class="op" id="7570709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570712">if</span>&nbsp;<span class="ident" id="7570715">err</span>&nbsp;<span class="op" id="7570719">!=</span>&nbsp;<span class="ident" id="7570722">nil</span>&nbsp;<span class="op" id="7570726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7570730">t</span><span class="op" id="7570731">.</span><span class="ident" id="7570732">Fatalf</span><span class="op" id="7570738">(</span><span class="string" id="7570739">&#34;Unable&nbsp;to&nbsp;to&nbsp;create&nbsp;listener:&nbsp;%v&#34;</span><span class="op" id="7570773">,</span>&nbsp;<span class="ident" id="7570775">err</span><span class="op" id="7570778">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7570781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570784">defer</span>&nbsp;<span class="ident" id="7570790">l</span><span class="op" id="7570791">.</span><span class="ident" id="7570792">Close</span><span class="op" id="7570797">(</span><span class="op" id="7570798">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7570802">//&nbsp;prevent&nbsp;data&nbsp;race&nbsp;on&nbsp;bcmdbuf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570835">var</span>&nbsp;<span class="ident" id="7570839">done</span>&nbsp;<span class="op" id="7570844">=</span>&nbsp;<span class="builtinfunc" id="7570846">make</span><span class="op" id="7570850">(</span><span class="keyword" id="7570851">chan</span>&nbsp;<span class="keyword" id="7570856">struct</span><span class="op" id="7570862">{</span><span class="op" id="7570863">}</span><span class="op" id="7570864">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570867">go</span>&nbsp;<span class="keyword" id="7570870">func</span><span class="op" id="7570874">(</span><span class="ident" id="7570875">data</span>&nbsp;<span class="op" id="7570880">[</span><span class="op" id="7570881">]</span><span class="builtintype" id="7570882">string</span><span class="op" id="7570888">)</span>&nbsp;<span class="op" id="7570890">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570895">defer</span>&nbsp;<span class="builtinfunc" id="7570901">close</span><span class="op" id="7570906">(</span><span class="ident" id="7570907">done</span><span class="op" id="7570911">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7570916">conn</span><span class="op" id="7570920">,</span>&nbsp;<span class="ident" id="7570922">err</span>&nbsp;<span class="op" id="7570926">:=</span>&nbsp;<span class="ident" id="7570929">l</span><span class="op" id="7570930">.</span><span class="ident" id="7570931">Accept</span><span class="op" id="7570937">(</span><span class="op" id="7570938">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570942">if</span>&nbsp;<span class="ident" id="7570945">err</span>&nbsp;<span class="op" id="7570949">!=</span>&nbsp;<span class="ident" id="7570952">nil</span>&nbsp;<span class="op" id="7570956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7570961">t</span><span class="op" id="7570962">.</span><span class="ident" id="7570963">Errorf</span><span class="op" id="7570969">(</span><span class="string" id="7570970">&#34;Accept&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7570988">,</span>&nbsp;<span class="ident" id="7570990">err</span><span class="op" id="7570993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570998">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7571007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571011">defer</span>&nbsp;<span class="ident" id="7571017">conn</span><span class="op" id="7571021">.</span><span class="ident" id="7571022">Close</span><span class="op" id="7571027">(</span><span class="op" id="7571028">)</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571033">tc</span>&nbsp;<span class="op" id="7571036">:=</span>&nbsp;<span class="ident" id="7571039">textproto</span><span class="op" id="7571048">.</span><span class="ident" id="7571049">NewConn</span><span class="op" id="7571056">(</span><span class="ident" id="7571057">conn</span><span class="op" id="7571061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571065">for</span>&nbsp;<span class="ident" id="7571069">i</span>&nbsp;<span class="op" id="7571071">:=</span>&nbsp;<span class="num" id="7571074">0</span><span class="op" id="7571075">;</span>&nbsp;<span class="ident" id="7571077">i</span>&nbsp;<span class="op" id="7571079">&lt;</span>&nbsp;<span class="builtinfunc" id="7571081">len</span><span class="op" id="7571084">(</span><span class="ident" id="7571085">data</span><span class="op" id="7571089">)</span>&nbsp;<span class="op" id="7571091">&amp;&amp;</span>&nbsp;<span class="ident" id="7571094">data</span><span class="op" id="7571098">[</span><span class="ident" id="7571099">i</span><span class="op" id="7571100">]</span>&nbsp;<span class="op" id="7571102">!=</span>&nbsp;<span class="string" id="7571105">&#34;&#34;</span><span class="op" id="7571107">;</span>&nbsp;<span class="ident" id="7571109">i</span><span class="op" id="7571110">++</span>&nbsp;<span class="op" id="7571113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571118">tc</span><span class="op" id="7571120">.</span><span class="ident" id="7571121">PrintfLine</span><span class="op" id="7571131">(</span><span class="ident" id="7571132">data</span><span class="op" id="7571136">[</span><span class="ident" id="7571137">i</span><span class="op" id="7571138">]</span><span class="op" id="7571139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571144">for</span>&nbsp;<span class="builtinfunc" id="7571148">len</span><span class="op" id="7571151">(</span><span class="ident" id="7571152">data</span><span class="op" id="7571156">[</span><span class="ident" id="7571157">i</span><span class="op" id="7571158">]</span><span class="op" id="7571159">)</span>&nbsp;<span class="op" id="7571161">&gt;=</span>&nbsp;<span class="num" id="7571164">4</span>&nbsp;<span class="op" id="7571166">&amp;&amp;</span>&nbsp;<span class="ident" id="7571169">data</span><span class="op" id="7571173">[</span><span class="ident" id="7571174">i</span><span class="op" id="7571175">]</span><span class="op" id="7571176">[</span><span class="num" id="7571177">3</span><span class="op" id="7571178">]</span>&nbsp;<span class="op" id="7571180">==</span>&nbsp;<span class="string" id="7571183">&#39;-&#39;</span>&nbsp;<span class="op" id="7571187">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571193">i</span><span class="op" id="7571194">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571201">tc</span><span class="op" id="7571203">.</span><span class="ident" id="7571204">PrintfLine</span><span class="op" id="7571214">(</span><span class="ident" id="7571215">data</span><span class="op" id="7571219">[</span><span class="ident" id="7571220">i</span><span class="op" id="7571221">]</span><span class="op" id="7571222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7571227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571232">if</span>&nbsp;<span class="ident" id="7571235">data</span><span class="op" id="7571239">[</span><span class="ident" id="7571240">i</span><span class="op" id="7571241">]</span>&nbsp;<span class="op" id="7571243">==</span>&nbsp;<span class="string" id="7571246">&#34;221&nbsp;Goodbye&#34;</span>&nbsp;<span class="op" id="7571260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571266">return</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7571276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571281">read</span>&nbsp;<span class="op" id="7571286">:=</span>&nbsp;<span class="builtintype" id="7571289">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571298">for</span>&nbsp;<span class="op" id="7571302">!</span><span class="ident" id="7571303">read</span>&nbsp;<span class="op" id="7571308">||</span>&nbsp;<span class="ident" id="7571311">data</span><span class="op" id="7571315">[</span><span class="ident" id="7571316">i</span><span class="op" id="7571317">]</span>&nbsp;<span class="op" id="7571319">==</span>&nbsp;<span class="string" id="7571322">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="7571337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571343">msg</span><span class="op" id="7571346">,</span>&nbsp;<span class="ident" id="7571348">err</span>&nbsp;<span class="op" id="7571352">:=</span>&nbsp;<span class="ident" id="7571355">tc</span><span class="op" id="7571357">.</span><span class="ident" id="7571358">ReadLine</span><span class="op" id="7571366">(</span><span class="op" id="7571367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571373">bcmdbuf</span><span class="op" id="7571380">.</span><span class="ident" id="7571381">Write</span><span class="op" id="7571386">(</span><span class="op" id="7571387">[</span><span class="op" id="7571388">]</span><span class="builtintype" id="7571389">byte</span><span class="op" id="7571393">(</span><span class="ident" id="7571394">msg</span>&nbsp;<span class="op" id="7571398">+</span>&nbsp;<span class="string" id="7571400">&#34;\r\n&#34;</span><span class="op" id="7571406">)</span><span class="op" id="7571407">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571413">read</span>&nbsp;<span class="op" id="7571418">=</span>&nbsp;<span class="builtintype" id="7571420">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571429">if</span>&nbsp;<span class="ident" id="7571432">err</span>&nbsp;<span class="op" id="7571436">!=</span>&nbsp;<span class="ident" id="7571439">nil</span>&nbsp;<span class="op" id="7571443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571450">t</span><span class="op" id="7571451">.</span><span class="ident" id="7571452">Errorf</span><span class="op" id="7571458">(</span><span class="string" id="7571459">&#34;Read&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7571475">,</span>&nbsp;<span class="ident" id="7571477">err</span><span class="op" id="7571480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571487">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7571498">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571504">if</span>&nbsp;<span class="ident" id="7571507">data</span><span class="op" id="7571511">[</span><span class="ident" id="7571512">i</span><span class="op" id="7571513">]</span>&nbsp;<span class="op" id="7571515">==</span>&nbsp;<span class="string" id="7571518">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="7571533">&amp;&amp;</span>&nbsp;<span class="ident" id="7571536">msg</span>&nbsp;<span class="op" id="7571540">==</span>&nbsp;<span class="string" id="7571543">&#34;.&#34;</span>&nbsp;<span class="op" id="7571547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571554">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7571564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7571569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7571573">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7571576">}</span><span class="op" id="7571577">(</span><span class="ident" id="7571578">strings</span><span class="op" id="7571585">.</span><span class="ident" id="7571586">Split</span><span class="op" id="7571591">(</span><span class="ident" id="7571592">server</span><span class="op" id="7571598">,</span>&nbsp;<span class="string" id="7571600">&#34;\r\n&#34;</span><span class="op" id="7571606">)</span><span class="op" id="7571607">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571611">err</span>&nbsp;<span class="op" id="7571615">=</span>&nbsp;<span class="ident" id="7571617">SendMail</span><span class="op" id="7571625">(</span><span class="ident" id="7571626">l</span><span class="op" id="7571627">.</span><span class="ident" id="7571628">Addr</span><span class="op" id="7571632">(</span><span class="op" id="7571633">)</span><span class="op" id="7571634">.</span><span class="ident" id="7571635">String</span><span class="op" id="7571641">(</span><span class="op" id="7571642">)</span><span class="op" id="7571643">,</span>&nbsp;<span class="ident" id="7571645">nil</span><span class="op" id="7571648">,</span>&nbsp;<span class="string" id="7571650">&#34;test@example.com&#34;</span><span class="op" id="7571668">,</span>&nbsp;<span class="op" id="7571670">[</span><span class="op" id="7571671">]</span><span class="builtintype" id="7571672">string</span><span class="op" id="7571678">{</span><span class="string" id="7571679">&#34;other@example.com&#34;</span><span class="op" id="7571698">}</span><span class="op" id="7571699">,</span>&nbsp;<span class="op" id="7571701">[</span><span class="op" id="7571702">]</span><span class="builtintype" id="7571703">byte</span><span class="op" id="7571707">(</span><span class="ident" id="7571708">strings</span><span class="op" id="7571715">.</span><span class="ident" id="7571716">Replace</span><span class="op" id="7571723">(</span><span class="string" id="7571724">`From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno">470</span><br>
<span class="lineno"></span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>`</span><span class="op" id="7571823">,</span>&nbsp;<span class="string" id="7571825">&#34;\n&#34;</span><span class="op" id="7571829">,</span>&nbsp;<span class="string" id="7571831">&#34;\r\n&#34;</span><span class="op" id="7571837">,</span>&nbsp;<span class="op" id="7571839">-</span><span class="num" id="7571840">1</span><span class="op" id="7571841">)</span><span class="op" id="7571842">)</span><span class="op" id="7571843">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571847">if</span>&nbsp;<span class="ident" id="7571850">err</span>&nbsp;<span class="op" id="7571854">!=</span>&nbsp;<span class="ident" id="7571857">nil</span>&nbsp;<span class="op" id="7571861">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571865">t</span><span class="op" id="7571866">.</span><span class="ident" id="7571867">Errorf</span><span class="op" id="7571873">(</span><span class="string" id="7571874">&#34;%v&#34;</span><span class="op" id="7571878">,</span>&nbsp;<span class="ident" id="7571880">err</span><span class="op" id="7571883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7571886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7571890">&lt;-</span><span class="ident" id="7571892">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571898">bcmdbuf</span><span class="op" id="7571905">.</span><span class="ident" id="7571906">Flush</span><span class="op" id="7571911">(</span><span class="op" id="7571912">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571915">actualcmds</span>&nbsp;<span class="op" id="7571926">:=</span>&nbsp;<span class="ident" id="7571929">cmdbuf</span><span class="op" id="7571935">.</span><span class="ident" id="7571936">String</span><span class="op" id="7571942">(</span><span class="op" id="7571943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571946">if</span>&nbsp;<span class="ident" id="7571949">client</span>&nbsp;<span class="op" id="7571956">!=</span>&nbsp;<span class="ident" id="7571959">actualcmds</span>&nbsp;<span class="op" id="7571970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571974">t</span><span class="op" id="7571975">.</span><span class="ident" id="7571976">Errorf</span><span class="op" id="7571982">(</span><span class="string" id="7571983">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7572008">,</span>&nbsp;<span class="ident" id="7572010">actualcmds</span><span class="op" id="7572020">,</span>&nbsp;<span class="ident" id="7572022">client</span><span class="op" id="7572028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7572031">}</span><br>
<span class="lineno"></span><span class="op" id="7572033">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="7572036">var</span>&nbsp;<span class="ident" id="7572040">sendMailServer</span>&nbsp;<span class="op" id="7572055">=</span>&nbsp;<span class="string" id="7572057">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno"></span>250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;ok<br>
<span class="lineno">490</span>250&nbsp;Receiver&nbsp;ok<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;ok<br>
<span class="lineno"></span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="keyword" id="7572186">var</span>&nbsp;<span class="ident" id="7572190">sendMailClient</span>&nbsp;<span class="op" id="7572205">=</span>&nbsp;<span class="string" id="7572207">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;test@example.com&gt;<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;other@example.com&gt;<br>
<span class="lineno">500</span>DATA<br>
<span class="lineno"></span>From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno"></span><br>
<span class="lineno">505</span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="7572407">func</span>&nbsp;<span class="ident" id="7572412">TestAuthFailed</span><span class="op" id="7572426">(</span><span class="ident" id="7572427">t</span>&nbsp;<span class="op" id="7572429">*</span><span class="ident" id="7572430">testing</span><span class="op" id="7572437">.</span><span class="ident" id="7572438">T</span><span class="op" id="7572439">)</span>&nbsp;<span class="op" id="7572441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572444">server</span>&nbsp;<span class="op" id="7572451">:=</span>&nbsp;<span class="ident" id="7572454">strings</span><span class="op" id="7572461">.</span><span class="ident" id="7572462">Join</span><span class="op" id="7572466">(</span><span class="ident" id="7572467">strings</span><span class="op" id="7572474">.</span><span class="ident" id="7572475">Split</span><span class="op" id="7572480">(</span><span class="ident" id="7572481">authFailedServer</span><span class="op" id="7572497">,</span>&nbsp;<span class="string" id="7572499">&#34;\n&#34;</span><span class="op" id="7572503">)</span><span class="op" id="7572504">,</span>&nbsp;<span class="string" id="7572506">&#34;\r\n&#34;</span><span class="op" id="7572512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572515">client</span>&nbsp;<span class="op" id="7572522">:=</span>&nbsp;<span class="ident" id="7572525">strings</span><span class="op" id="7572532">.</span><span class="ident" id="7572533">Join</span><span class="op" id="7572537">(</span><span class="ident" id="7572538">strings</span><span class="op" id="7572545">.</span><span class="ident" id="7572546">Split</span><span class="op" id="7572551">(</span><span class="ident" id="7572552">authFailedClient</span><span class="op" id="7572568">,</span>&nbsp;<span class="string" id="7572570">&#34;\n&#34;</span><span class="op" id="7572574">)</span><span class="op" id="7572575">,</span>&nbsp;<span class="string" id="7572577">&#34;\r\n&#34;</span><span class="op" id="7572583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572586">var</span>&nbsp;<span class="ident" id="7572590">cmdbuf</span>&nbsp;<span class="ident" id="7572597">bytes</span><span class="op" id="7572602">.</span><span class="ident" id="7572603">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572611">bcmdbuf</span>&nbsp;<span class="op" id="7572619">:=</span>&nbsp;<span class="ident" id="7572622">bufio</span><span class="op" id="7572627">.</span><span class="ident" id="7572628">NewWriter</span><span class="op" id="7572637">(</span><span class="op" id="7572638">&amp;</span><span class="ident" id="7572639">cmdbuf</span><span class="op" id="7572645">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572648">var</span>&nbsp;<span class="ident" id="7572652">fake</span>&nbsp;<span class="ident" id="7572657">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572664">fake</span><span class="op" id="7572668">.</span><span class="ident" id="7572669">ReadWriter</span>&nbsp;<span class="op" id="7572680">=</span>&nbsp;<span class="ident" id="7572682">bufio</span><span class="op" id="7572687">.</span><span class="ident" id="7572688">NewReadWriter</span><span class="op" id="7572701">(</span><span class="ident" id="7572702">bufio</span><span class="op" id="7572707">.</span><span class="ident" id="7572708">NewReader</span><span class="op" id="7572717">(</span><span class="ident" id="7572718">strings</span><span class="op" id="7572725">.</span><span class="ident" id="7572726">NewReader</span><span class="op" id="7572735">(</span><span class="ident" id="7572736">server</span><span class="op" id="7572742">)</span><span class="op" id="7572743">)</span><span class="op" id="7572744">,</span>&nbsp;<span class="ident" id="7572746">bcmdbuf</span><span class="op" id="7572753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572756">c</span><span class="op" id="7572757">,</span>&nbsp;<span class="ident" id="7572759">err</span>&nbsp;<span class="op" id="7572763">:=</span>&nbsp;<span class="ident" id="7572766">NewClient</span><span class="op" id="7572775">(</span><span class="ident" id="7572776">fake</span><span class="op" id="7572780">,</span>&nbsp;<span class="string" id="7572782">&#34;fake.host&#34;</span><span class="op" id="7572793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572796">if</span>&nbsp;<span class="ident" id="7572799">err</span>&nbsp;<span class="op" id="7572803">!=</span>&nbsp;<span class="ident" id="7572806">nil</span>&nbsp;<span class="op" id="7572810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572814">t</span><span class="op" id="7572815">.</span><span class="ident" id="7572816">Fatalf</span><span class="op" id="7572822">(</span><span class="string" id="7572823">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="7572838">,</span>&nbsp;<span class="ident" id="7572840">err</span><span class="op" id="7572843">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7572846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572849">defer</span>&nbsp;<span class="ident" id="7572855">c</span><span class="op" id="7572856">.</span><span class="ident" id="7572857">Close</span><span class="op" id="7572862">(</span><span class="op" id="7572863">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572867">c</span><span class="op" id="7572868">.</span><span class="ident" id="7572869">tls</span>&nbsp;<span class="op" id="7572873">=</span>&nbsp;<span class="builtintype" id="7572875">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572881">c</span><span class="op" id="7572882">.</span><span class="ident" id="7572883">serverName</span>&nbsp;<span class="op" id="7572894">=</span>&nbsp;<span class="string" id="7572896">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572915">err</span>&nbsp;<span class="op" id="7572919">=</span>&nbsp;<span class="ident" id="7572921">c</span><span class="op" id="7572922">.</span><span class="ident" id="7572923">Auth</span><span class="op" id="7572927">(</span><span class="ident" id="7572928">PlainAuth</span><span class="op" id="7572937">(</span><span class="string" id="7572938">&#34;&#34;</span><span class="op" id="7572940">,</span>&nbsp;<span class="string" id="7572942">&#34;user&#34;</span><span class="op" id="7572948">,</span>&nbsp;<span class="string" id="7572950">&#34;pass&#34;</span><span class="op" id="7572956">,</span>&nbsp;<span class="string" id="7572958">&#34;smtp.google.com&#34;</span><span class="op" id="7572975">)</span><span class="op" id="7572976">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572980">if</span>&nbsp;<span class="ident" id="7572983">err</span>&nbsp;<span class="op" id="7572987">==</span>&nbsp;<span class="ident" id="7572990">nil</span>&nbsp;<span class="op" id="7572994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572998">t</span><span class="op" id="7572999">.</span><span class="ident" id="7573000">Error</span><span class="op" id="7573005">(</span><span class="string" id="7573006">&#34;Auth:&nbsp;expected&nbsp;error;&nbsp;got&nbsp;none&#34;</span><span class="op" id="7573038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573041">}</span>&nbsp;<span class="keyword" id="7573043">else</span>&nbsp;<span class="keyword" id="7573048">if</span>&nbsp;<span class="ident" id="7573051">err</span><span class="op" id="7573054">.</span><span class="ident" id="7573055">Error</span><span class="op" id="7573060">(</span><span class="op" id="7573061">)</span>&nbsp;<span class="op" id="7573063">!=</span>&nbsp;<span class="string" id="7573066">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span>&nbsp;<span class="op" id="7573120">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573124">t</span><span class="op" id="7573125">.</span><span class="ident" id="7573126">Errorf</span><span class="op" id="7573132">(</span><span class="string" id="7573133">&#34;Auth:&nbsp;got&nbsp;error:&nbsp;%v,&nbsp;want:&nbsp;%s&#34;</span><span class="op" id="7573164">,</span>&nbsp;<span class="ident" id="7573166">err</span><span class="op" id="7573169">,</span>&nbsp;<span class="string" id="7573171">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span><span class="op" id="7573224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573231">bcmdbuf</span><span class="op" id="7573238">.</span><span class="ident" id="7573239">Flush</span><span class="op" id="7573244">(</span><span class="op" id="7573245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573248">actualcmds</span>&nbsp;<span class="op" id="7573259">:=</span>&nbsp;<span class="ident" id="7573262">cmdbuf</span><span class="op" id="7573268">.</span><span class="ident" id="7573269">String</span><span class="op" id="7573275">(</span><span class="op" id="7573276">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573279">if</span>&nbsp;<span class="ident" id="7573282">client</span>&nbsp;<span class="op" id="7573289">!=</span>&nbsp;<span class="ident" id="7573292">actualcmds</span>&nbsp;<span class="op" id="7573303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573307">t</span><span class="op" id="7573308">.</span><span class="ident" id="7573309">Errorf</span><span class="op" id="7573315">(</span><span class="string" id="7573316">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7573341">,</span>&nbsp;<span class="ident" id="7573343">actualcmds</span><span class="op" id="7573353">,</span>&nbsp;<span class="ident" id="7573355">client</span><span class="op" id="7573361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573364">}</span><br>
<span class="lineno"></span><span class="op" id="7573366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">540</span><span class="keyword" id="7573369">var</span>&nbsp;<span class="ident" id="7573373">authFailedServer</span>&nbsp;<span class="op" id="7573390">=</span>&nbsp;<span class="string" id="7573392">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>535-Invalid&nbsp;credentials<br>
<span class="lineno"></span>535&nbsp;please&nbsp;see&nbsp;www.example.com<br>
<span class="lineno">545</span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7573534">var</span>&nbsp;<span class="ident" id="7573538">authFailedClient</span>&nbsp;<span class="op" id="7573555">=</span>&nbsp;<span class="string" id="7573557">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno">550</span>*<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7573611">func</span>&nbsp;<span class="ident" id="7573616">TestTLSClient</span><span class="op" id="7573629">(</span><span class="ident" id="7573630">t</span>&nbsp;<span class="op" id="7573632">*</span><span class="ident" id="7573633">testing</span><span class="op" id="7573640">.</span><span class="ident" id="7573641">T</span><span class="op" id="7573642">)</span>&nbsp;<span class="op" id="7573644">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573647">ln</span>&nbsp;<span class="op" id="7573650">:=</span>&nbsp;<span class="ident" id="7573653">newLocalListener</span><span class="op" id="7573669">(</span><span class="ident" id="7573670">t</span><span class="op" id="7573671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573674">defer</span>&nbsp;<span class="ident" id="7573680">ln</span><span class="op" id="7573682">.</span><span class="ident" id="7573683">Close</span><span class="op" id="7573688">(</span><span class="op" id="7573689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573692">errc</span>&nbsp;<span class="op" id="7573697">:=</span>&nbsp;<span class="builtinfunc" id="7573700">make</span><span class="op" id="7573704">(</span><span class="keyword" id="7573705">chan</span>&nbsp;<span class="builtintype" id="7573710">error</span><span class="op" id="7573715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573718">go</span>&nbsp;<span class="keyword" id="7573721">func</span><span class="op" id="7573725">(</span><span class="op" id="7573726">)</span>&nbsp;<span class="op" id="7573728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573732">errc</span>&nbsp;<span class="op" id="7573737">&lt;-</span>&nbsp;<span class="ident" id="7573740">sendMail</span><span class="op" id="7573748">(</span><span class="ident" id="7573749">ln</span><span class="op" id="7573751">.</span><span class="ident" id="7573752">Addr</span><span class="op" id="7573756">(</span><span class="op" id="7573757">)</span><span class="op" id="7573758">.</span><span class="ident" id="7573759">String</span><span class="op" id="7573765">(</span><span class="op" id="7573766">)</span><span class="op" id="7573767">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573770">}</span><span class="op" id="7573771">(</span><span class="op" id="7573772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573775">conn</span><span class="op" id="7573779">,</span>&nbsp;<span class="ident" id="7573781">err</span>&nbsp;<span class="op" id="7573785">:=</span>&nbsp;<span class="ident" id="7573788">ln</span><span class="op" id="7573790">.</span><span class="ident" id="7573791">Accept</span><span class="op" id="7573797">(</span><span class="op" id="7573798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573801">if</span>&nbsp;<span class="ident" id="7573804">err</span>&nbsp;<span class="op" id="7573808">!=</span>&nbsp;<span class="ident" id="7573811">nil</span>&nbsp;<span class="op" id="7573815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573819">t</span><span class="op" id="7573820">.</span><span class="ident" id="7573821">Fatalf</span><span class="op" id="7573827">(</span><span class="string" id="7573828">&#34;failed&nbsp;to&nbsp;accept&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="7573861">,</span>&nbsp;<span class="ident" id="7573863">err</span><span class="op" id="7573866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573869">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573872">defer</span>&nbsp;<span class="ident" id="7573878">conn</span><span class="op" id="7573882">.</span><span class="ident" id="7573883">Close</span><span class="op" id="7573888">(</span><span class="op" id="7573889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573892">if</span>&nbsp;<span class="ident" id="7573895">err</span>&nbsp;<span class="op" id="7573899">:=</span>&nbsp;<span class="ident" id="7573902">serverHandle</span><span class="op" id="7573914">(</span><span class="ident" id="7573915">conn</span><span class="op" id="7573919">,</span>&nbsp;<span class="ident" id="7573921">t</span><span class="op" id="7573922">)</span><span class="op" id="7573923">;</span>&nbsp;<span class="ident" id="7573925">err</span>&nbsp;<span class="op" id="7573929">!=</span>&nbsp;<span class="ident" id="7573932">nil</span>&nbsp;<span class="op" id="7573936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573940">t</span><span class="op" id="7573941">.</span><span class="ident" id="7573942">Fatalf</span><span class="op" id="7573948">(</span><span class="string" id="7573949">&#34;failed&nbsp;to&nbsp;handle&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="7573982">,</span>&nbsp;<span class="ident" id="7573984">err</span><span class="op" id="7573987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573993">if</span>&nbsp;<span class="ident" id="7573996">err</span>&nbsp;<span class="op" id="7574000">:=</span>&nbsp;<span class="op" id="7574003">&lt;-</span><span class="ident" id="7574005">errc</span><span class="op" id="7574009">;</span>&nbsp;<span class="ident" id="7574011">err</span>&nbsp;<span class="op" id="7574015">!=</span>&nbsp;<span class="ident" id="7574018">nil</span>&nbsp;<span class="op" id="7574022">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574026">t</span><span class="op" id="7574027">.</span><span class="ident" id="7574028">Fatalf</span><span class="op" id="7574034">(</span><span class="string" id="7574035">&#34;client&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7574053">,</span>&nbsp;<span class="ident" id="7574055">err</span><span class="op" id="7574058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7574061">}</span><br>
<span class="lineno"></span><span class="op" id="7574063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7574066">func</span>&nbsp;<span class="ident" id="7574071">newLocalListener</span><span class="op" id="7574087">(</span><span class="ident" id="7574088">t</span>&nbsp;<span class="op" id="7574090">*</span><span class="ident" id="7574091">testing</span><span class="op" id="7574098">.</span><span class="ident" id="7574099">T</span><span class="op" id="7574100">)</span>&nbsp;<span class="ident" id="7574102">net</span><span class="op" id="7574105">.</span><span class="ident" id="7574106">Listener</span>&nbsp;<span class="op" id="7574115">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574118">ln</span><span class="op" id="7574120">,</span>&nbsp;<span class="ident" id="7574122">err</span>&nbsp;<span class="op" id="7574126">:=</span>&nbsp;<span class="ident" id="7574129">net</span><span class="op" id="7574132">.</span><span class="ident" id="7574133">Listen</span><span class="op" id="7574139">(</span><span class="string" id="7574140">&#34;tcp&#34;</span><span class="op" id="7574145">,</span>&nbsp;<span class="string" id="7574147">&#34;127.0.0.1:0&#34;</span><span class="op" id="7574160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574163">if</span>&nbsp;<span class="ident" id="7574166">err</span>&nbsp;<span class="op" id="7574170">!=</span>&nbsp;<span class="ident" id="7574173">nil</span>&nbsp;<span class="op" id="7574177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574181">ln</span><span class="op" id="7574183">,</span>&nbsp;<span class="ident" id="7574185">err</span>&nbsp;<span class="op" id="7574189">=</span>&nbsp;<span class="ident" id="7574191">net</span><span class="op" id="7574194">.</span><span class="ident" id="7574195">Listen</span><span class="op" id="7574201">(</span><span class="string" id="7574202">&#34;tcp6&#34;</span><span class="op" id="7574208">,</span>&nbsp;<span class="string" id="7574210">&#34;[::1]:0&#34;</span><span class="op" id="7574219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7574222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574225">if</span>&nbsp;<span class="ident" id="7574228">err</span>&nbsp;<span class="op" id="7574232">!=</span>&nbsp;<span class="ident" id="7574235">nil</span>&nbsp;<span class="op" id="7574239">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574243">t</span><span class="op" id="7574244">.</span><span class="ident" id="7574245">Fatal</span><span class="op" id="7574250">(</span><span class="ident" id="7574251">err</span><span class="op" id="7574254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7574257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574260">return</span>&nbsp;<span class="ident" id="7574267">ln</span><br>
<span class="lineno"></span><span class="op" id="7574270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span><span class="keyword" id="7574273">type</span>&nbsp;<span class="ident" id="7574278">smtpSender</span>&nbsp;<span class="keyword" id="7574289">struct</span>&nbsp;<span class="op" id="7574296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574299">w</span>&nbsp;<span class="ident" id="7574301">io</span><span class="op" id="7574303">.</span><span class="ident" id="7574304">Writer</span><br>
<span class="lineno"></span><span class="op" id="7574311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7574314">func</span>&nbsp;<span class="op" id="7574319">(</span><span class="ident" id="7574320">s</span>&nbsp;<span class="ident" id="7574322">smtpSender</span><span class="op" id="7574332">)</span>&nbsp;<span class="ident" id="7574334">send</span><span class="op" id="7574338">(</span><span class="ident" id="7574339">f</span>&nbsp;<span class="builtintype" id="7574341">string</span><span class="op" id="7574347">)</span>&nbsp;<span class="op" id="7574349">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574352">s</span><span class="op" id="7574353">.</span><span class="ident" id="7574354">w</span><span class="op" id="7574355">.</span><span class="ident" id="7574356">Write</span><span class="op" id="7574361">(</span><span class="op" id="7574362">[</span><span class="op" id="7574363">]</span><span class="builtintype" id="7574364">byte</span><span class="op" id="7574368">(</span><span class="ident" id="7574369">f</span>&nbsp;<span class="op" id="7574371">+</span>&nbsp;<span class="string" id="7574373">&#34;\r\n&#34;</span><span class="op" id="7574379">)</span><span class="op" id="7574380">)</span><br>
<span class="lineno"></span><span class="op" id="7574382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7574385">//&nbsp;smtp&nbsp;server,&nbsp;finely&nbsp;tailored&nbsp;to&nbsp;deal&nbsp;with&nbsp;our&nbsp;own&nbsp;client&nbsp;only!</span><br>
<span class="lineno"></span><span class="keyword" id="7574451">func</span>&nbsp;<span class="ident" id="7574456">serverHandle</span><span class="op" id="7574468">(</span><span class="ident" id="7574469">c</span>&nbsp;<span class="ident" id="7574471">net</span><span class="op" id="7574474">.</span><span class="ident" id="7574475">Conn</span><span class="op" id="7574479">,</span>&nbsp;<span class="ident" id="7574481">t</span>&nbsp;<span class="op" id="7574483">*</span><span class="ident" id="7574484">testing</span><span class="op" id="7574491">.</span><span class="ident" id="7574492">T</span><span class="op" id="7574493">)</span>&nbsp;<span class="builtintype" id="7574495">error</span>&nbsp;<span class="op" id="7574501">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574504">send</span>&nbsp;<span class="op" id="7574509">:=</span>&nbsp;<span class="ident" id="7574512">smtpSender</span><span class="op" id="7574522">{</span><span class="ident" id="7574523">c</span><span class="op" id="7574524">}</span><span class="op" id="7574525">.</span><span class="ident" id="7574526">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574532">send</span><span class="op" id="7574536">(</span><span class="string" id="7574537">&#34;220&nbsp;127.0.0.1&nbsp;ESMTP&nbsp;service&nbsp;ready&#34;</span><span class="op" id="7574572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574575">s</span>&nbsp;<span class="op" id="7574577">:=</span>&nbsp;<span class="ident" id="7574580">bufio</span><span class="op" id="7574585">.</span><span class="ident" id="7574586">NewScanner</span><span class="op" id="7574596">(</span><span class="ident" id="7574597">c</span><span class="op" id="7574598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574601">for</span>&nbsp;<span class="ident" id="7574605">s</span><span class="op" id="7574606">.</span><span class="ident" id="7574607">Scan</span><span class="op" id="7574611">(</span><span class="op" id="7574612">)</span>&nbsp;<span class="op" id="7574614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574618">switch</span>&nbsp;<span class="ident" id="7574625">s</span><span class="op" id="7574626">.</span><span class="ident" id="7574627">Text</span><span class="op" id="7574631">(</span><span class="op" id="7574632">)</span>&nbsp;<span class="op" id="7574634">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574638">case</span>&nbsp;<span class="string" id="7574643">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="7574659">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574664">send</span><span class="op" id="7574668">(</span><span class="string" id="7574669">&#34;250-127.0.0.1&nbsp;ESMTP&nbsp;offers&nbsp;a&nbsp;warm&nbsp;hug&nbsp;of&nbsp;welcome&#34;</span><span class="op" id="7574719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574724">send</span><span class="op" id="7574728">(</span><span class="string" id="7574729">&#34;250-STARTTLS&#34;</span><span class="op" id="7574743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574748">send</span><span class="op" id="7574752">(</span><span class="string" id="7574753">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7574761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574765">case</span>&nbsp;<span class="string" id="7574770">&#34;STARTTLS&#34;</span><span class="op" id="7574780">:</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574785">send</span><span class="op" id="7574789">(</span><span class="string" id="7574790">&#34;220&nbsp;Go&nbsp;ahead&#34;</span><span class="op" id="7574804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574809">keypair</span><span class="op" id="7574816">,</span>&nbsp;<span class="ident" id="7574818">err</span>&nbsp;<span class="op" id="7574822">:=</span>&nbsp;<span class="ident" id="7574825">tls</span><span class="op" id="7574828">.</span><span class="ident" id="7574829">X509KeyPair</span><span class="op" id="7574840">(</span><span class="ident" id="7574841">localhostCert</span><span class="op" id="7574854">,</span>&nbsp;<span class="ident" id="7574856">localhostKey</span><span class="op" id="7574868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574873">if</span>&nbsp;<span class="ident" id="7574876">err</span>&nbsp;<span class="op" id="7574880">!=</span>&nbsp;<span class="ident" id="7574883">nil</span>&nbsp;<span class="op" id="7574887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574893">return</span>&nbsp;<span class="ident" id="7574900">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7574907">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574912">config</span>&nbsp;<span class="op" id="7574919">:=</span>&nbsp;<span class="op" id="7574922">&amp;</span><span class="ident" id="7574923">tls</span><span class="op" id="7574926">.</span><span class="ident" id="7574927">Config</span><span class="op" id="7574933">{</span><span class="ident" id="7574934">Certificates</span><span class="op" id="7574946">:</span>&nbsp;<span class="op" id="7574948">[</span><span class="op" id="7574949">]</span><span class="ident" id="7574950">tls</span><span class="op" id="7574953">.</span><span class="ident" id="7574954">Certificate</span><span class="op" id="7574965">{</span><span class="ident" id="7574966">keypair</span><span class="op" id="7574973">}</span><span class="op" id="7574974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574979">c</span>&nbsp;<span class="op" id="7574981">=</span>&nbsp;<span class="ident" id="7574983">tls</span><span class="op" id="7574986">.</span><span class="ident" id="7574987">Server</span><span class="op" id="7574993">(</span><span class="ident" id="7574994">c</span><span class="op" id="7574995">,</span>&nbsp;<span class="ident" id="7574997">config</span><span class="op" id="7575003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575008">defer</span>&nbsp;<span class="ident" id="7575014">c</span><span class="op" id="7575015">.</span><span class="ident" id="7575016">Close</span><span class="op" id="7575021">(</span><span class="op" id="7575022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575027">return</span>&nbsp;<span class="ident" id="7575034">serverHandleTLS</span><span class="op" id="7575049">(</span><span class="ident" id="7575050">c</span><span class="op" id="7575051">,</span>&nbsp;<span class="ident" id="7575053">t</span><span class="op" id="7575054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575058">default</span><span class="op" id="7575065">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575070">t</span><span class="op" id="7575071">.</span><span class="ident" id="7575072">Fatalf</span><span class="op" id="7575078">(</span><span class="string" id="7575079">&#34;unrecognized&nbsp;command:&nbsp;%q&#34;</span><span class="op" id="7575105">,</span>&nbsp;<span class="ident" id="7575107">s</span><span class="op" id="7575108">.</span><span class="ident" id="7575109">Text</span><span class="op" id="7575113">(</span><span class="op" id="7575114">)</span><span class="op" id="7575115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7575119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7575122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575125">return</span>&nbsp;<span class="ident" id="7575132">s</span><span class="op" id="7575133">.</span><span class="ident" id="7575134">Err</span><span class="op" id="7575137">(</span><span class="op" id="7575138">)</span><br>
<span class="lineno"></span><span class="op" id="7575140">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="7575143">func</span>&nbsp;<span class="ident" id="7575148">serverHandleTLS</span><span class="op" id="7575163">(</span><span class="ident" id="7575164">c</span>&nbsp;<span class="ident" id="7575166">net</span><span class="op" id="7575169">.</span><span class="ident" id="7575170">Conn</span><span class="op" id="7575174">,</span>&nbsp;<span class="ident" id="7575176">t</span>&nbsp;<span class="op" id="7575178">*</span><span class="ident" id="7575179">testing</span><span class="op" id="7575186">.</span><span class="ident" id="7575187">T</span><span class="op" id="7575188">)</span>&nbsp;<span class="builtintype" id="7575190">error</span>&nbsp;<span class="op" id="7575196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575199">send</span>&nbsp;<span class="op" id="7575204">:=</span>&nbsp;<span class="ident" id="7575207">smtpSender</span><span class="op" id="7575217">{</span><span class="ident" id="7575218">c</span><span class="op" id="7575219">}</span><span class="op" id="7575220">.</span><span class="ident" id="7575221">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575227">s</span>&nbsp;<span class="op" id="7575229">:=</span>&nbsp;<span class="ident" id="7575232">bufio</span><span class="op" id="7575237">.</span><span class="ident" id="7575238">NewScanner</span><span class="op" id="7575248">(</span><span class="ident" id="7575249">c</span><span class="op" id="7575250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575253">for</span>&nbsp;<span class="ident" id="7575257">s</span><span class="op" id="7575258">.</span><span class="ident" id="7575259">Scan</span><span class="op" id="7575263">(</span><span class="op" id="7575264">)</span>&nbsp;<span class="op" id="7575266">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575270">switch</span>&nbsp;<span class="ident" id="7575277">s</span><span class="op" id="7575278">.</span><span class="ident" id="7575279">Text</span><span class="op" id="7575283">(</span><span class="op" id="7575284">)</span>&nbsp;<span class="op" id="7575286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575290">case</span>&nbsp;<span class="string" id="7575295">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="7575311">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575316">send</span><span class="op" id="7575320">(</span><span class="string" id="7575321">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7575329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575333">case</span>&nbsp;<span class="string" id="7575338">&#34;MAIL&nbsp;FROM:&lt;joe1@example.com&gt;&#34;</span><span class="op" id="7575368">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575373">send</span><span class="op" id="7575377">(</span><span class="string" id="7575378">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7575386">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575390">case</span>&nbsp;<span class="string" id="7575395">&#34;RCPT&nbsp;TO:&lt;joe2@example.com&gt;&#34;</span><span class="op" id="7575423">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575428">send</span><span class="op" id="7575432">(</span><span class="string" id="7575433">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7575441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575445">case</span>&nbsp;<span class="string" id="7575450">&#34;DATA&#34;</span><span class="op" id="7575456">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575461">send</span><span class="op" id="7575465">(</span><span class="string" id="7575466">&#34;354&nbsp;send&nbsp;the&nbsp;mail&nbsp;data,&nbsp;end&nbsp;with&nbsp;.&#34;</span><span class="op" id="7575502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575507">send</span><span class="op" id="7575511">(</span><span class="string" id="7575512">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7575520">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575524">case</span>&nbsp;<span class="string" id="7575529">&#34;Subject:&nbsp;test&#34;</span><span class="op" id="7575544">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575548">case</span>&nbsp;<span class="string" id="7575553">&#34;&#34;</span><span class="op" id="7575555">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575559">case</span>&nbsp;<span class="string" id="7575564">&#34;howdy!&#34;</span><span class="op" id="7575572">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575576">case</span>&nbsp;<span class="string" id="7575581">&#34;.&#34;</span><span class="op" id="7575584">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575588">case</span>&nbsp;<span class="string" id="7575593">&#34;QUIT&#34;</span><span class="op" id="7575599">:</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575604">send</span><span class="op" id="7575608">(</span><span class="string" id="7575609">&#34;221&nbsp;127.0.0.1&nbsp;Service&nbsp;closing&nbsp;transmission&nbsp;channel&#34;</span><span class="op" id="7575661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575666">return</span>&nbsp;<span class="ident" id="7575673">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575679">default</span><span class="op" id="7575686">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575691">t</span><span class="op" id="7575692">.</span><span class="ident" id="7575693">Fatalf</span><span class="op" id="7575699">(</span><span class="string" id="7575700">&#34;unrecognized&nbsp;command&nbsp;during&nbsp;TLS:&nbsp;%q&#34;</span><span class="op" id="7575737">,</span>&nbsp;<span class="ident" id="7575739">s</span><span class="op" id="7575740">.</span><span class="ident" id="7575741">Text</span><span class="op" id="7575745">(</span><span class="op" id="7575746">)</span><span class="op" id="7575747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7575751">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7575754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575757">return</span>&nbsp;<span class="ident" id="7575764">s</span><span class="op" id="7575765">.</span><span class="ident" id="7575766">Err</span><span class="op" id="7575769">(</span><span class="op" id="7575770">)</span><br>
<span class="lineno"></span><span class="op" id="7575772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7575775">func</span>&nbsp;<span class="ident" id="7575780">init</span><span class="op" id="7575784">(</span><span class="op" id="7575785">)</span>&nbsp;<span class="op" id="7575787">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575790">testRootCAs</span>&nbsp;<span class="op" id="7575802">:=</span>&nbsp;<span class="ident" id="7575805">x509</span><span class="op" id="7575809">.</span><span class="ident" id="7575810">NewCertPool</span><span class="op" id="7575821">(</span><span class="op" id="7575822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575825">testRootCAs</span><span class="op" id="7575836">.</span><span class="ident" id="7575837">AppendCertsFromPEM</span><span class="op" id="7575855">(</span><span class="ident" id="7575856">localhostCert</span><span class="op" id="7575869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575872">testHookStartTLS</span>&nbsp;<span class="op" id="7575889">=</span>&nbsp;<span class="keyword" id="7575891">func</span><span class="op" id="7575895">(</span><span class="ident" id="7575896">config</span>&nbsp;<span class="op" id="7575903">*</span><span class="ident" id="7575904">tls</span><span class="op" id="7575907">.</span><span class="ident" id="7575908">Config</span><span class="op" id="7575914">)</span>&nbsp;<span class="op" id="7575916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575920">config</span><span class="op" id="7575926">.</span><span class="ident" id="7575927">RootCAs</span>&nbsp;<span class="op" id="7575935">=</span>&nbsp;<span class="ident" id="7575937">testRootCAs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7575950">}</span><br>
<span class="lineno">655</span><span class="op" id="7575952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7575955">func</span>&nbsp;<span class="ident" id="7575960">sendMail</span><span class="op" id="7575968">(</span><span class="ident" id="7575969">hostPort</span>&nbsp;<span class="builtintype" id="7575978">string</span><span class="op" id="7575984">)</span>&nbsp;<span class="builtintype" id="7575986">error</span>&nbsp;<span class="op" id="7575992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575995">host</span><span class="op" id="7575999">,</span>&nbsp;<span class="ident" id="7576001">_</span><span class="op" id="7576002">,</span>&nbsp;<span class="ident" id="7576004">err</span>&nbsp;<span class="op" id="7576008">:=</span>&nbsp;<span class="ident" id="7576011">net</span><span class="op" id="7576014">.</span><span class="ident" id="7576015">SplitHostPort</span><span class="op" id="7576028">(</span><span class="ident" id="7576029">hostPort</span><span class="op" id="7576037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576040">if</span>&nbsp;<span class="ident" id="7576043">err</span>&nbsp;<span class="op" id="7576047">!=</span>&nbsp;<span class="ident" id="7576050">nil</span>&nbsp;<span class="op" id="7576054">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576058">return</span>&nbsp;<span class="ident" id="7576065">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7576070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576073">auth</span>&nbsp;<span class="op" id="7576078">:=</span>&nbsp;<span class="ident" id="7576081">PlainAuth</span><span class="op" id="7576090">(</span><span class="string" id="7576091">&#34;&#34;</span><span class="op" id="7576093">,</span>&nbsp;<span class="string" id="7576095">&#34;&#34;</span><span class="op" id="7576097">,</span>&nbsp;<span class="string" id="7576099">&#34;&#34;</span><span class="op" id="7576101">,</span>&nbsp;<span class="ident" id="7576103">host</span><span class="op" id="7576107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576110">from</span>&nbsp;<span class="op" id="7576115">:=</span>&nbsp;<span class="string" id="7576118">&#34;joe1@example.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576138">to</span>&nbsp;<span class="op" id="7576141">:=</span>&nbsp;<span class="op" id="7576144">[</span><span class="op" id="7576145">]</span><span class="builtintype" id="7576146">string</span><span class="op" id="7576152">{</span><span class="string" id="7576153">&#34;joe2@example.com&#34;</span><span class="op" id="7576171">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576174">return</span>&nbsp;<span class="ident" id="7576181">SendMail</span><span class="op" id="7576189">(</span><span class="ident" id="7576190">hostPort</span><span class="op" id="7576198">,</span>&nbsp;<span class="ident" id="7576200">auth</span><span class="op" id="7576204">,</span>&nbsp;<span class="ident" id="7576206">from</span><span class="op" id="7576210">,</span>&nbsp;<span class="ident" id="7576212">to</span><span class="op" id="7576214">,</span>&nbsp;<span class="op" id="7576216">[</span><span class="op" id="7576217">]</span><span class="builtintype" id="7576218">byte</span><span class="op" id="7576222">(</span><span class="string" id="7576223">&#34;Subject:&nbsp;test\n\nhowdy!&#34;</span><span class="op" id="7576248">)</span><span class="op" id="7576249">)</span><br>
<span class="lineno"></span><span class="op" id="7576251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7576254">//&nbsp;(copied&nbsp;from&nbsp;net/http/httptest)</span><br>
<span class="lineno"></span><span class="comment" id="7576289">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno">670</span><span class="comment" id="7576345">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno"></span><span class="comment" id="7576418">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="7576437">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="7576471">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="7576607">var</span>&nbsp;<span class="ident" id="7576611">localhostCert</span>&nbsp;<span class="op" id="7576625">=</span>&nbsp;<span class="op" id="7576627">[</span><span class="op" id="7576628">]</span><span class="builtintype" id="7576629">byte</span><span class="op" id="7576633">(</span><span class="string" id="7576634">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno">675</span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno"></span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno">680</span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno"></span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="7577205">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span><span class="comment" id="7577208">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno"></span><span class="keyword" id="7577262">var</span>&nbsp;<span class="ident" id="7577266">localhostKey</span>&nbsp;<span class="op" id="7577279">=</span>&nbsp;<span class="op" id="7577281">[</span><span class="op" id="7577282">]</span><span class="builtintype" id="7577283">byte</span><span class="op" id="7577287">(</span><span class="string" id="7577288">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno">690</span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno"></span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="7577786">)</span>
</div>
</body>
</html>
