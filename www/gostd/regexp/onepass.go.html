<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>regexp</h2>
<ul>
<li><a href="/gostd/regexp/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/regexp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/regexp/exec.go.html">exec.go</a></li>
<li><a href="/gostd/regexp/exec2_test.go.html">exec2_test.go</a></li>
<li><a href="/gostd/regexp/exec_test.go.html">exec_test.go</a></li>
<li><a href="/gostd/regexp/find_test.go.html">find_test.go</a></li>
<li><a href="/gostd/regexp/onepass.go.html" class="current">onepass.go</a></li>
<li><a href="/gostd/regexp/onepass_test.go.html">onepass_test.go</a></li>
<li><a href="/gostd/regexp/regexp.go.html">regexp.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5365588">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5365644">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5365698">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5365749">package</span>&nbsp;<span class="ident" id="5365757">regexp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5365765">import</span>&nbsp;<span class="op" id="5365772">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5365775">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5365784">&#34;regexp/syntax&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5365801">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5365809">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="5365819">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5365822">//&nbsp;&#34;One-pass&#34;&nbsp;regexp&nbsp;execution.</span><br>
<span class="lineno">15</span><span class="comment" id="5365854">//&nbsp;Some&nbsp;regexps&nbsp;can&nbsp;be&nbsp;analyzed&nbsp;to&nbsp;determine&nbsp;that&nbsp;they&nbsp;never&nbsp;need</span><br>
<span class="lineno"></span><span class="comment" id="5365920">//&nbsp;backtracking:&nbsp;they&nbsp;are&nbsp;guaranteed&nbsp;to&nbsp;run&nbsp;in&nbsp;one&nbsp;pass&nbsp;over&nbsp;the&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5365992">//&nbsp;without&nbsp;bothering&nbsp;to&nbsp;save&nbsp;all&nbsp;the&nbsp;usual&nbsp;NFA&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="5366046">//&nbsp;Detect&nbsp;those&nbsp;and&nbsp;execute&nbsp;them&nbsp;more&nbsp;quickly.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5366094">//&nbsp;A&nbsp;onePassProg&nbsp;is&nbsp;a&nbsp;compiled&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="5366162">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Prog&nbsp;except&nbsp;for&nbsp;the&nbsp;use&nbsp;of&nbsp;onePassInst.</span><br>
<span class="lineno"></span><span class="keyword" id="5366230">type</span>&nbsp;<span class="ident" id="5366235">onePassProg</span>&nbsp;<span class="keyword" id="5366247">struct</span>&nbsp;<span class="op" id="5366254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5366257">Inst</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5366264">[</span><span class="op" id="5366265">]</span><span class="ident" id="5366266">onePassInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5366279">Start</span>&nbsp;&nbsp;<span class="builtintype" id="5366286">int</span>&nbsp;<span class="comment" id="5366290">//&nbsp;index&nbsp;of&nbsp;start&nbsp;instruction</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5366321">NumCap</span>&nbsp;<span class="builtintype" id="5366328">int</span>&nbsp;<span class="comment" id="5366332">//&nbsp;number&nbsp;of&nbsp;InstCapture&nbsp;insts&nbsp;in&nbsp;re</span><br>
<span class="lineno"></span><span class="op" id="5366369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5366372">//&nbsp;A&nbsp;onePassInst&nbsp;is&nbsp;a&nbsp;single&nbsp;instruction&nbsp;in&nbsp;a&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="5366455">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Inst&nbsp;except&nbsp;for&nbsp;the&nbsp;new&nbsp;&#39;Next&#39;&nbsp;field.</span><br>
<span class="lineno">30</span><span class="keyword" id="5366521">type</span>&nbsp;<span class="ident" id="5366526">onePassInst</span>&nbsp;<span class="keyword" id="5366538">struct</span>&nbsp;<span class="op" id="5366545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5366548">syntax</span><span class="op" id="5366554">.</span><span class="ident" id="5366555">Inst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5366561">Next</span>&nbsp;<span class="op" id="5366566">[</span><span class="op" id="5366567">]</span><span class="builtintype" id="5366568">uint32</span><br>
<span class="lineno"></span><span class="op" id="5366575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="5366578">//&nbsp;OnePassPrefix&nbsp;returns&nbsp;a&nbsp;literal&nbsp;string&nbsp;that&nbsp;all&nbsp;matches&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5366645">//&nbsp;regexp&nbsp;must&nbsp;start&nbsp;with.&nbsp;&nbsp;Complete&nbsp;is&nbsp;true&nbsp;if&nbsp;the&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="5366704">//&nbsp;is&nbsp;the&nbsp;entire&nbsp;match.&nbsp;Pc&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;last&nbsp;rune&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="5366773">//&nbsp;in&nbsp;the&nbsp;string.&nbsp;The&nbsp;OnePassPrefix&nbsp;skips&nbsp;over&nbsp;the&nbsp;mandatory</span><br>
<span class="lineno"></span><span class="comment" id="5366834">//&nbsp;EmptyBeginText</span><br>
<span class="lineno">40</span><span class="keyword" id="5366852">func</span>&nbsp;<span class="ident" id="5366857">onePassPrefix</span><span class="op" id="5366870">(</span><span class="ident" id="5366871">p</span>&nbsp;<span class="op" id="5366873">*</span><span class="ident" id="5366874">syntax</span><span class="op" id="5366880">.</span><span class="ident" id="5366881">Prog</span><span class="op" id="5366885">)</span>&nbsp;<span class="op" id="5366887">(</span><span class="ident" id="5366888">prefix</span>&nbsp;<span class="builtintype" id="5366895">string</span><span class="op" id="5366901">,</span>&nbsp;<span class="ident" id="5366903">complete</span>&nbsp;<span class="builtintype" id="5366912">bool</span><span class="op" id="5366916">,</span>&nbsp;<span class="ident" id="5366918">pc</span>&nbsp;<span class="builtintype" id="5366921">uint32</span><span class="op" id="5366927">)</span>&nbsp;<span class="op" id="5366929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5366932">i</span>&nbsp;<span class="op" id="5366934">:=</span>&nbsp;<span class="op" id="5366937">&amp;</span><span class="ident" id="5366938">p</span><span class="op" id="5366939">.</span><span class="ident" id="5366940">Inst</span><span class="op" id="5366944">[</span><span class="ident" id="5366945">p</span><span class="op" id="5366946">.</span><span class="ident" id="5366947">Start</span><span class="op" id="5366952">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5366955">if</span>&nbsp;<span class="ident" id="5366958">i</span><span class="op" id="5366959">.</span><span class="ident" id="5366960">Op</span>&nbsp;<span class="op" id="5366963">!=</span>&nbsp;<span class="ident" id="5366966">syntax</span><span class="op" id="5366972">.</span><span class="ident" id="5366973">InstEmptyWidth</span>&nbsp;<span class="op" id="5366988">||</span>&nbsp;<span class="op" id="5366991">(</span><span class="ident" id="5366992">syntax</span><span class="op" id="5366998">.</span><span class="ident" id="5366999">EmptyOp</span><span class="op" id="5367006">(</span><span class="ident" id="5367007">i</span><span class="op" id="5367008">.</span><span class="ident" id="5367009">Arg</span><span class="op" id="5367012">)</span><span class="op" id="5367013">)</span><span class="op" id="5367014">&amp;</span><span class="ident" id="5367015">syntax</span><span class="op" id="5367021">.</span><span class="ident" id="5367022">EmptyBeginText</span>&nbsp;<span class="op" id="5367037">==</span>&nbsp;<span class="num" id="5367040">0</span>&nbsp;<span class="op" id="5367042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5367046">return</span>&nbsp;<span class="string" id="5367053">&#34;&#34;</span><span class="op" id="5367055">,</span>&nbsp;<span class="ident" id="5367057">i</span><span class="op" id="5367058">.</span><span class="ident" id="5367059">Op</span>&nbsp;<span class="op" id="5367062">==</span>&nbsp;<span class="ident" id="5367065">syntax</span><span class="op" id="5367071">.</span><span class="ident" id="5367072">InstMatch</span><span class="op" id="5367081">,</span>&nbsp;<span class="builtintype" id="5367083">uint32</span><span class="op" id="5367089">(</span><span class="ident" id="5367090">p</span><span class="op" id="5367091">.</span><span class="ident" id="5367092">Start</span><span class="op" id="5367097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5367100">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5367103">pc</span>&nbsp;<span class="op" id="5367106">=</span>&nbsp;<span class="ident" id="5367108">i</span><span class="op" id="5367109">.</span><span class="ident" id="5367110">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5367115">i</span>&nbsp;<span class="op" id="5367117">=</span>&nbsp;<span class="op" id="5367119">&amp;</span><span class="ident" id="5367120">p</span><span class="op" id="5367121">.</span><span class="ident" id="5367122">Inst</span><span class="op" id="5367126">[</span><span class="ident" id="5367127">pc</span><span class="op" id="5367129">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5367132">for</span>&nbsp;<span class="ident" id="5367136">i</span><span class="op" id="5367137">.</span><span class="ident" id="5367138">Op</span>&nbsp;<span class="op" id="5367141">==</span>&nbsp;<span class="ident" id="5367144">syntax</span><span class="op" id="5367150">.</span><span class="ident" id="5367151">InstNop</span>&nbsp;<span class="op" id="5367159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5367163">pc</span>&nbsp;<span class="op" id="5367166">=</span>&nbsp;<span class="ident" id="5367168">i</span><span class="op" id="5367169">.</span><span class="ident" id="5367170">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5367176">i</span>&nbsp;<span class="op" id="5367178">=</span>&nbsp;<span class="op" id="5367180">&amp;</span><span class="ident" id="5367181">p</span><span class="op" id="5367182">.</span><span class="ident" id="5367183">Inst</span><span class="op" id="5367187">[</span><span class="ident" id="5367188">pc</span><span class="op" id="5367190">]</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5367193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5367196">//&nbsp;Avoid&nbsp;allocation&nbsp;of&nbsp;buffer&nbsp;if&nbsp;prefix&nbsp;is&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5367247">if</span>&nbsp;<span class="ident" id="5367250">iop</span><span class="op" id="5367253">(</span><span class="ident" id="5367254">i</span><span class="op" id="5367255">)</span>&nbsp;<span class="op" id="5367257">!=</span>&nbsp;<span class="ident" id="5367260">syntax</span><span class="op" id="5367266">.</span><span class="ident" id="5367267">InstRune</span>&nbsp;<span class="op" id="5367276">||</span>&nbsp;<span class="builtinfunc" id="5367279">len</span><span class="op" id="5367282">(</span><span class="ident" id="5367283">i</span><span class="op" id="5367284">.</span><span class="ident" id="5367285">Rune</span><span class="op" id="5367289">)</span>&nbsp;<span class="op" id="5367291">!=</span>&nbsp;<span class="num" id="5367294">1</span>&nbsp;<span class="op" id="5367296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5367300">return</span>&nbsp;<span class="string" id="5367307">&#34;&#34;</span><span class="op" id="5367309">,</span>&nbsp;<span class="ident" id="5367311">i</span><span class="op" id="5367312">.</span><span class="ident" id="5367313">Op</span>&nbsp;<span class="op" id="5367316">==</span>&nbsp;<span class="ident" id="5367319">syntax</span><span class="op" id="5367325">.</span><span class="ident" id="5367326">InstMatch</span><span class="op" id="5367335">,</span>&nbsp;<span class="builtintype" id="5367337">uint32</span><span class="op" id="5367343">(</span><span class="ident" id="5367344">p</span><span class="op" id="5367345">.</span><span class="ident" id="5367346">Start</span><span class="op" id="5367351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5367354">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5367358">//&nbsp;Have&nbsp;prefix;&nbsp;gather&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5367394">var</span>&nbsp;<span class="ident" id="5367398">buf</span>&nbsp;<span class="ident" id="5367402">bytes</span><span class="op" id="5367407">.</span><span class="ident" id="5367408">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5367416">for</span>&nbsp;<span class="ident" id="5367420">iop</span><span class="op" id="5367423">(</span><span class="ident" id="5367424">i</span><span class="op" id="5367425">)</span>&nbsp;<span class="op" id="5367427">==</span>&nbsp;<span class="ident" id="5367430">syntax</span><span class="op" id="5367436">.</span><span class="ident" id="5367437">InstRune</span>&nbsp;<span class="op" id="5367446">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5367449">len</span><span class="op" id="5367452">(</span><span class="ident" id="5367453">i</span><span class="op" id="5367454">.</span><span class="ident" id="5367455">Rune</span><span class="op" id="5367459">)</span>&nbsp;<span class="op" id="5367461">==</span>&nbsp;<span class="num" id="5367464">1</span>&nbsp;<span class="op" id="5367466">&amp;&amp;</span>&nbsp;<span class="ident" id="5367469">syntax</span><span class="op" id="5367475">.</span><span class="ident" id="5367476">Flags</span><span class="op" id="5367481">(</span><span class="ident" id="5367482">i</span><span class="op" id="5367483">.</span><span class="ident" id="5367484">Arg</span><span class="op" id="5367487">)</span><span class="op" id="5367488">&amp;</span><span class="ident" id="5367489">syntax</span><span class="op" id="5367495">.</span><span class="ident" id="5367496">FoldCase</span>&nbsp;<span class="op" id="5367505">==</span>&nbsp;<span class="num" id="5367508">0</span>&nbsp;<span class="op" id="5367510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5367514">buf</span><span class="op" id="5367517">.</span><span class="ident" id="5367518">WriteRune</span><span class="op" id="5367527">(</span><span class="ident" id="5367528">i</span><span class="op" id="5367529">.</span><span class="ident" id="5367530">Rune</span><span class="op" id="5367534">[</span><span class="num" id="5367535">0</span><span class="op" id="5367536">]</span><span class="op" id="5367537">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5367541">pc</span><span class="op" id="5367543">,</span>&nbsp;<span class="ident" id="5367545">i</span>&nbsp;<span class="op" id="5367547">=</span>&nbsp;<span class="ident" id="5367549">i</span><span class="op" id="5367550">.</span><span class="ident" id="5367551">Out</span><span class="op" id="5367554">,</span>&nbsp;<span class="op" id="5367556">&amp;</span><span class="ident" id="5367557">p</span><span class="op" id="5367558">.</span><span class="ident" id="5367559">Inst</span><span class="op" id="5367563">[</span><span class="ident" id="5367564">i</span><span class="op" id="5367565">.</span><span class="ident" id="5367566">Out</span><span class="op" id="5367569">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5367572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5367575">return</span>&nbsp;<span class="ident" id="5367582">buf</span><span class="op" id="5367585">.</span><span class="ident" id="5367586">String</span><span class="op" id="5367592">(</span><span class="op" id="5367593">)</span><span class="op" id="5367594">,</span>&nbsp;<span class="ident" id="5367596">i</span><span class="op" id="5367597">.</span><span class="ident" id="5367598">Op</span>&nbsp;<span class="op" id="5367601">==</span>&nbsp;<span class="ident" id="5367604">syntax</span><span class="op" id="5367610">.</span><span class="ident" id="5367611">InstEmptyWidth</span>&nbsp;<span class="op" id="5367626">&amp;&amp;</span>&nbsp;<span class="op" id="5367629">(</span><span class="ident" id="5367630">syntax</span><span class="op" id="5367636">.</span><span class="ident" id="5367637">EmptyOp</span><span class="op" id="5367644">(</span><span class="ident" id="5367645">i</span><span class="op" id="5367646">.</span><span class="ident" id="5367647">Arg</span><span class="op" id="5367650">)</span><span class="op" id="5367651">)</span><span class="op" id="5367652">&amp;</span><span class="ident" id="5367653">syntax</span><span class="op" id="5367659">.</span><span class="ident" id="5367660">EmptyBeginText</span>&nbsp;<span class="op" id="5367675">!=</span>&nbsp;<span class="num" id="5367678">0</span><span class="op" id="5367679">,</span>&nbsp;<span class="ident" id="5367681">pc</span><br>
<span class="lineno"></span><span class="op" id="5367684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5367687">//&nbsp;OnePassNext&nbsp;selects&nbsp;the&nbsp;next&nbsp;actionable&nbsp;state&nbsp;of&nbsp;the&nbsp;prog,&nbsp;based&nbsp;on&nbsp;the&nbsp;input&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5367779">//&nbsp;It&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;i.Op&nbsp;==&nbsp;InstAlt&nbsp;or&nbsp;InstAltMatch,&nbsp;and&nbsp;from&nbsp;the&nbsp;one-pass&nbsp;machine.</span><br>
<span class="lineno"></span><span class="comment" id="5367876">//&nbsp;One&nbsp;of&nbsp;the&nbsp;alternates&nbsp;may&nbsp;ultimately&nbsp;lead&nbsp;without&nbsp;input&nbsp;to&nbsp;end&nbsp;of&nbsp;line.&nbsp;If&nbsp;the&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="5367970">//&nbsp;is&nbsp;InstAltMatch&nbsp;the&nbsp;path&nbsp;to&nbsp;the&nbsp;InstMatch&nbsp;is&nbsp;in&nbsp;i.Out,&nbsp;the&nbsp;normal&nbsp;node&nbsp;in&nbsp;i.Next.</span><br>
<span class="lineno"></span><span class="keyword" id="5368055">func</span>&nbsp;<span class="ident" id="5368060">onePassNext</span><span class="op" id="5368071">(</span><span class="ident" id="5368072">i</span>&nbsp;<span class="op" id="5368074">*</span><span class="ident" id="5368075">onePassInst</span><span class="op" id="5368086">,</span>&nbsp;<span class="ident" id="5368088">r</span>&nbsp;<span class="builtintype" id="5368090">rune</span><span class="op" id="5368094">)</span>&nbsp;<span class="builtintype" id="5368096">uint32</span>&nbsp;<span class="op" id="5368103">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5368106">next</span>&nbsp;<span class="op" id="5368111">:=</span>&nbsp;<span class="ident" id="5368114">i</span><span class="op" id="5368115">.</span><span class="ident" id="5368116">MatchRunePos</span><span class="op" id="5368128">(</span><span class="ident" id="5368129">r</span><span class="op" id="5368130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5368133">if</span>&nbsp;<span class="ident" id="5368136">next</span>&nbsp;<span class="op" id="5368141">&gt;=</span>&nbsp;<span class="num" id="5368144">0</span>&nbsp;<span class="op" id="5368146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5368150">return</span>&nbsp;<span class="ident" id="5368157">i</span><span class="op" id="5368158">.</span><span class="ident" id="5368159">Next</span><span class="op" id="5368163">[</span><span class="ident" id="5368164">next</span><span class="op" id="5368168">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5368171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5368174">if</span>&nbsp;<span class="ident" id="5368177">i</span><span class="op" id="5368178">.</span><span class="ident" id="5368179">Op</span>&nbsp;<span class="op" id="5368182">==</span>&nbsp;<span class="ident" id="5368185">syntax</span><span class="op" id="5368191">.</span><span class="ident" id="5368192">InstAltMatch</span>&nbsp;<span class="op" id="5368205">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5368209">return</span>&nbsp;<span class="ident" id="5368216">i</span><span class="op" id="5368217">.</span><span class="ident" id="5368218">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5368223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5368226">return</span>&nbsp;<span class="num" id="5368233">0</span><br>
<span class="lineno"></span><span class="op" id="5368235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="5368238">func</span>&nbsp;<span class="ident" id="5368243">iop</span><span class="op" id="5368246">(</span><span class="ident" id="5368247">i</span>&nbsp;<span class="op" id="5368249">*</span><span class="ident" id="5368250">syntax</span><span class="op" id="5368256">.</span><span class="ident" id="5368257">Inst</span><span class="op" id="5368261">)</span>&nbsp;<span class="ident" id="5368263">syntax</span><span class="op" id="5368269">.</span><span class="ident" id="5368270">InstOp</span>&nbsp;<span class="op" id="5368277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5368280">op</span>&nbsp;<span class="op" id="5368283">:=</span>&nbsp;<span class="ident" id="5368286">i</span><span class="op" id="5368287">.</span><span class="ident" id="5368288">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5368292">switch</span>&nbsp;<span class="ident" id="5368299">op</span>&nbsp;<span class="op" id="5368302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5368305">case</span>&nbsp;<span class="ident" id="5368310">syntax</span><span class="op" id="5368316">.</span><span class="ident" id="5368317">InstRune1</span><span class="op" id="5368326">,</span>&nbsp;<span class="ident" id="5368328">syntax</span><span class="op" id="5368334">.</span><span class="ident" id="5368335">InstRuneAny</span><span class="op" id="5368346">,</span>&nbsp;<span class="ident" id="5368348">syntax</span><span class="op" id="5368354">.</span><span class="ident" id="5368355">InstRuneAnyNotNL</span><span class="op" id="5368371">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5368375">op</span>&nbsp;<span class="op" id="5368378">=</span>&nbsp;<span class="ident" id="5368380">syntax</span><span class="op" id="5368386">.</span><span class="ident" id="5368387">InstRune</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5368397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5368400">return</span>&nbsp;<span class="ident" id="5368407">op</span><br>
<span class="lineno"></span><span class="op" id="5368410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5368413">//&nbsp;Sparse&nbsp;Array&nbsp;implementation&nbsp;is&nbsp;used&nbsp;as&nbsp;a&nbsp;queueOnePass.</span><br>
<span class="lineno">90</span><span class="keyword" id="5368471">type</span>&nbsp;<span class="ident" id="5368476">queueOnePass</span>&nbsp;<span class="keyword" id="5368489">struct</span>&nbsp;<span class="op" id="5368496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5368499">sparse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5368515">[</span><span class="op" id="5368516">]</span><span class="builtintype" id="5368517">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5368525">dense</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5368541">[</span><span class="op" id="5368542">]</span><span class="builtintype" id="5368543">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5368551">size</span><span class="op" id="5368555">,</span>&nbsp;<span class="ident" id="5368557">nextIndex</span>&nbsp;<span class="builtintype" id="5368567">uint32</span><br>
<span class="lineno"></span><span class="op" id="5368574">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="5368577">func</span>&nbsp;<span class="op" id="5368582">(</span><span class="ident" id="5368583">q</span>&nbsp;<span class="op" id="5368585">*</span><span class="ident" id="5368586">queueOnePass</span><span class="op" id="5368598">)</span>&nbsp;<span class="ident" id="5368600">empty</span><span class="op" id="5368605">(</span><span class="op" id="5368606">)</span>&nbsp;<span class="builtintype" id="5368608">bool</span>&nbsp;<span class="op" id="5368613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5368616">return</span>&nbsp;<span class="ident" id="5368623">q</span><span class="op" id="5368624">.</span><span class="ident" id="5368625">nextIndex</span>&nbsp;<span class="op" id="5368635">&gt;=</span>&nbsp;<span class="ident" id="5368638">q</span><span class="op" id="5368639">.</span><span class="ident" id="5368640">size</span><br>
<span class="lineno"></span><span class="op" id="5368645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5368648">func</span>&nbsp;<span class="op" id="5368653">(</span><span class="ident" id="5368654">q</span>&nbsp;<span class="op" id="5368656">*</span><span class="ident" id="5368657">queueOnePass</span><span class="op" id="5368669">)</span>&nbsp;<span class="ident" id="5368671">next</span><span class="op" id="5368675">(</span><span class="op" id="5368676">)</span>&nbsp;<span class="op" id="5368678">(</span><span class="ident" id="5368679">n</span>&nbsp;<span class="builtintype" id="5368681">uint32</span><span class="op" id="5368687">)</span>&nbsp;<span class="op" id="5368689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5368692">n</span>&nbsp;<span class="op" id="5368694">=</span>&nbsp;<span class="ident" id="5368696">q</span><span class="op" id="5368697">.</span><span class="ident" id="5368698">dense</span><span class="op" id="5368703">[</span><span class="ident" id="5368704">q</span><span class="op" id="5368705">.</span><span class="ident" id="5368706">nextIndex</span><span class="op" id="5368715">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5368718">q</span><span class="op" id="5368719">.</span><span class="ident" id="5368720">nextIndex</span><span class="op" id="5368729">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5368733">return</span><br>
<span class="lineno"></span><span class="op" id="5368740">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="5368743">func</span>&nbsp;<span class="op" id="5368748">(</span><span class="ident" id="5368749">q</span>&nbsp;<span class="op" id="5368751">*</span><span class="ident" id="5368752">queueOnePass</span><span class="op" id="5368764">)</span>&nbsp;<span class="ident" id="5368766">clear</span><span class="op" id="5368771">(</span><span class="op" id="5368772">)</span>&nbsp;<span class="op" id="5368774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5368777">q</span><span class="op" id="5368778">.</span><span class="ident" id="5368779">size</span>&nbsp;<span class="op" id="5368784">=</span>&nbsp;<span class="num" id="5368786">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5368789">q</span><span class="op" id="5368790">.</span><span class="ident" id="5368791">nextIndex</span>&nbsp;<span class="op" id="5368801">=</span>&nbsp;<span class="num" id="5368803">0</span><br>
<span class="lineno"></span><span class="op" id="5368805">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="5368808">func</span>&nbsp;<span class="op" id="5368813">(</span><span class="ident" id="5368814">q</span>&nbsp;<span class="op" id="5368816">*</span><span class="ident" id="5368817">queueOnePass</span><span class="op" id="5368829">)</span>&nbsp;<span class="ident" id="5368831">reset</span><span class="op" id="5368836">(</span><span class="op" id="5368837">)</span>&nbsp;<span class="op" id="5368839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5368842">q</span><span class="op" id="5368843">.</span><span class="ident" id="5368844">nextIndex</span>&nbsp;<span class="op" id="5368854">=</span>&nbsp;<span class="num" id="5368856">0</span><br>
<span class="lineno"></span><span class="op" id="5368858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="5368861">func</span>&nbsp;<span class="op" id="5368866">(</span><span class="ident" id="5368867">q</span>&nbsp;<span class="op" id="5368869">*</span><span class="ident" id="5368870">queueOnePass</span><span class="op" id="5368882">)</span>&nbsp;<span class="ident" id="5368884">contains</span><span class="op" id="5368892">(</span><span class="ident" id="5368893">u</span>&nbsp;<span class="builtintype" id="5368895">uint32</span><span class="op" id="5368901">)</span>&nbsp;<span class="builtintype" id="5368903">bool</span>&nbsp;<span class="op" id="5368908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5368911">if</span>&nbsp;<span class="ident" id="5368914">u</span>&nbsp;<span class="op" id="5368916">&gt;=</span>&nbsp;<span class="builtintype" id="5368919">uint32</span><span class="op" id="5368925">(</span><span class="builtinfunc" id="5368926">len</span><span class="op" id="5368929">(</span><span class="ident" id="5368930">q</span><span class="op" id="5368931">.</span><span class="ident" id="5368932">sparse</span><span class="op" id="5368938">)</span><span class="op" id="5368939">)</span>&nbsp;<span class="op" id="5368941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5368945">return</span>&nbsp;<span class="builtintype" id="5368952">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5368959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5368962">return</span>&nbsp;<span class="ident" id="5368969">q</span><span class="op" id="5368970">.</span><span class="ident" id="5368971">sparse</span><span class="op" id="5368977">[</span><span class="ident" id="5368978">u</span><span class="op" id="5368979">]</span>&nbsp;<span class="op" id="5368981">&lt;</span>&nbsp;<span class="ident" id="5368983">q</span><span class="op" id="5368984">.</span><span class="ident" id="5368985">size</span>&nbsp;<span class="op" id="5368990">&amp;&amp;</span>&nbsp;<span class="ident" id="5368993">q</span><span class="op" id="5368994">.</span><span class="ident" id="5368995">dense</span><span class="op" id="5369000">[</span><span class="ident" id="5369001">q</span><span class="op" id="5369002">.</span><span class="ident" id="5369003">sparse</span><span class="op" id="5369009">[</span><span class="ident" id="5369010">u</span><span class="op" id="5369011">]</span><span class="op" id="5369012">]</span>&nbsp;<span class="op" id="5369014">==</span>&nbsp;<span class="ident" id="5369017">u</span><br>
<span class="lineno">120</span><span class="op" id="5369019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5369022">func</span>&nbsp;<span class="op" id="5369027">(</span><span class="ident" id="5369028">q</span>&nbsp;<span class="op" id="5369030">*</span><span class="ident" id="5369031">queueOnePass</span><span class="op" id="5369043">)</span>&nbsp;<span class="ident" id="5369045">insert</span><span class="op" id="5369051">(</span><span class="ident" id="5369052">u</span>&nbsp;<span class="builtintype" id="5369054">uint32</span><span class="op" id="5369060">)</span>&nbsp;<span class="op" id="5369062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5369065">if</span>&nbsp;<span class="op" id="5369068">!</span><span class="ident" id="5369069">q</span><span class="op" id="5369070">.</span><span class="ident" id="5369071">contains</span><span class="op" id="5369079">(</span><span class="ident" id="5369080">u</span><span class="op" id="5369081">)</span>&nbsp;<span class="op" id="5369083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5369087">q</span><span class="op" id="5369088">.</span><span class="ident" id="5369089">insertNew</span><span class="op" id="5369098">(</span><span class="ident" id="5369099">u</span><span class="op" id="5369100">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5369103">}</span><br>
<span class="lineno"></span><span class="op" id="5369105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5369108">func</span>&nbsp;<span class="op" id="5369113">(</span><span class="ident" id="5369114">q</span>&nbsp;<span class="op" id="5369116">*</span><span class="ident" id="5369117">queueOnePass</span><span class="op" id="5369129">)</span>&nbsp;<span class="ident" id="5369131">insertNew</span><span class="op" id="5369140">(</span><span class="ident" id="5369141">u</span>&nbsp;<span class="builtintype" id="5369143">uint32</span><span class="op" id="5369149">)</span>&nbsp;<span class="op" id="5369151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5369154">if</span>&nbsp;<span class="ident" id="5369157">u</span>&nbsp;<span class="op" id="5369159">&gt;=</span>&nbsp;<span class="builtintype" id="5369162">uint32</span><span class="op" id="5369168">(</span><span class="builtinfunc" id="5369169">len</span><span class="op" id="5369172">(</span><span class="ident" id="5369173">q</span><span class="op" id="5369174">.</span><span class="ident" id="5369175">sparse</span><span class="op" id="5369181">)</span><span class="op" id="5369182">)</span>&nbsp;<span class="op" id="5369184">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5369188">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5369196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5369199">q</span><span class="op" id="5369200">.</span><span class="ident" id="5369201">sparse</span><span class="op" id="5369207">[</span><span class="ident" id="5369208">u</span><span class="op" id="5369209">]</span>&nbsp;<span class="op" id="5369211">=</span>&nbsp;<span class="ident" id="5369213">q</span><span class="op" id="5369214">.</span><span class="ident" id="5369215">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5369221">q</span><span class="op" id="5369222">.</span><span class="ident" id="5369223">dense</span><span class="op" id="5369228">[</span><span class="ident" id="5369229">q</span><span class="op" id="5369230">.</span><span class="ident" id="5369231">size</span><span class="op" id="5369235">]</span>&nbsp;<span class="op" id="5369237">=</span>&nbsp;<span class="ident" id="5369239">u</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5369242">q</span><span class="op" id="5369243">.</span><span class="ident" id="5369244">size</span><span class="op" id="5369248">++</span><br>
<span class="lineno">135</span><span class="op" id="5369251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5369254">func</span>&nbsp;<span class="ident" id="5369259">newQueue</span><span class="op" id="5369267">(</span><span class="ident" id="5369268">size</span>&nbsp;<span class="builtintype" id="5369273">int</span><span class="op" id="5369276">)</span>&nbsp;<span class="op" id="5369278">(</span><span class="ident" id="5369279">q</span>&nbsp;<span class="op" id="5369281">*</span><span class="ident" id="5369282">queueOnePass</span><span class="op" id="5369294">)</span>&nbsp;<span class="op" id="5369296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5369299">return</span>&nbsp;<span class="op" id="5369306">&amp;</span><span class="ident" id="5369307">queueOnePass</span><span class="op" id="5369319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5369323">sparse</span><span class="op" id="5369329">:</span>&nbsp;<span class="builtinfunc" id="5369331">make</span><span class="op" id="5369335">(</span><span class="op" id="5369336">[</span><span class="op" id="5369337">]</span><span class="builtintype" id="5369338">uint32</span><span class="op" id="5369344">,</span>&nbsp;<span class="ident" id="5369346">size</span><span class="op" id="5369350">)</span><span class="op" id="5369351">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5369355">dense</span><span class="op" id="5369360">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5369363">make</span><span class="op" id="5369367">(</span><span class="op" id="5369368">[</span><span class="op" id="5369369">]</span><span class="builtintype" id="5369370">uint32</span><span class="op" id="5369376">,</span>&nbsp;<span class="ident" id="5369378">size</span><span class="op" id="5369382">)</span><span class="op" id="5369383">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5369386">}</span><br>
<span class="lineno"></span><span class="op" id="5369388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5369391">//&nbsp;mergeRuneSets&nbsp;merges&nbsp;two&nbsp;non-intersecting&nbsp;runesets,&nbsp;and&nbsp;returns&nbsp;the&nbsp;merged&nbsp;result,</span><br>
<span class="lineno">145</span><span class="comment" id="5369477">//&nbsp;and&nbsp;a&nbsp;NextIp&nbsp;array.&nbsp;The&nbsp;idea&nbsp;is&nbsp;that&nbsp;if&nbsp;a&nbsp;rune&nbsp;matches&nbsp;the&nbsp;OnePassRunes&nbsp;at&nbsp;index</span><br>
<span class="lineno"></span><span class="comment" id="5369561">//&nbsp;i,&nbsp;NextIp[i/2]&nbsp;is&nbsp;the&nbsp;target.&nbsp;If&nbsp;the&nbsp;input&nbsp;sets&nbsp;intersect,&nbsp;an&nbsp;empty&nbsp;runeset&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5369646">//&nbsp;NextIp&nbsp;array&nbsp;with&nbsp;the&nbsp;single&nbsp;element&nbsp;mergeFailed&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="5369711">//&nbsp;The&nbsp;code&nbsp;assumes&nbsp;that&nbsp;both&nbsp;inputs&nbsp;contain&nbsp;ordered&nbsp;and&nbsp;non-intersecting&nbsp;rune&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="keyword" id="5369797">const</span>&nbsp;<span class="ident" id="5369803">mergeFailed</span>&nbsp;<span class="op" id="5369815">=</span>&nbsp;<span class="builtintype" id="5369817">uint32</span><span class="op" id="5369823">(</span><span class="num" id="5369824">0xffffffff</span><span class="op" id="5369834">)</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="5369837">var</span>&nbsp;<span class="op" id="5369841">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5369844">noRune</span>&nbsp;<span class="op" id="5369851">=</span>&nbsp;<span class="op" id="5369853">[</span><span class="op" id="5369854">]</span><span class="builtintype" id="5369855">rune</span><span class="op" id="5369859">{</span><span class="op" id="5369860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5369863">noNext</span>&nbsp;<span class="op" id="5369870">=</span>&nbsp;<span class="op" id="5369872">[</span><span class="op" id="5369873">]</span><span class="builtintype" id="5369874">uint32</span><span class="op" id="5369880">{</span><span class="ident" id="5369881">mergeFailed</span><span class="op" id="5369892">}</span><br>
<span class="lineno"></span><span class="op" id="5369894">)</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="keyword" id="5369897">func</span>&nbsp;<span class="ident" id="5369902">mergeRuneSets</span><span class="op" id="5369915">(</span><span class="ident" id="5369916">leftRunes</span><span class="op" id="5369925">,</span>&nbsp;<span class="ident" id="5369927">rightRunes</span>&nbsp;<span class="op" id="5369938">*</span><span class="op" id="5369939">[</span><span class="op" id="5369940">]</span><span class="builtintype" id="5369941">rune</span><span class="op" id="5369945">,</span>&nbsp;<span class="ident" id="5369947">leftPC</span><span class="op" id="5369953">,</span>&nbsp;<span class="ident" id="5369955">rightPC</span>&nbsp;<span class="builtintype" id="5369963">uint32</span><span class="op" id="5369969">)</span>&nbsp;<span class="op" id="5369971">(</span><span class="op" id="5369972">[</span><span class="op" id="5369973">]</span><span class="builtintype" id="5369974">rune</span><span class="op" id="5369978">,</span>&nbsp;<span class="op" id="5369980">[</span><span class="op" id="5369981">]</span><span class="builtintype" id="5369982">uint32</span><span class="op" id="5369988">)</span>&nbsp;<span class="op" id="5369990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5369993">leftLen</span>&nbsp;<span class="op" id="5370001">:=</span>&nbsp;<span class="builtinfunc" id="5370004">len</span><span class="op" id="5370007">(</span><span class="op" id="5370008">*</span><span class="ident" id="5370009">leftRunes</span><span class="op" id="5370018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5370021">rightLen</span>&nbsp;<span class="op" id="5370030">:=</span>&nbsp;<span class="builtinfunc" id="5370033">len</span><span class="op" id="5370036">(</span><span class="op" id="5370037">*</span><span class="ident" id="5370038">rightRunes</span><span class="op" id="5370048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5370051">if</span>&nbsp;<span class="ident" id="5370054">leftLen</span><span class="op" id="5370061">&amp;</span><span class="num" id="5370062">0x1</span>&nbsp;<span class="op" id="5370066">!=</span>&nbsp;<span class="num" id="5370069">0</span>&nbsp;<span class="op" id="5370071">||</span>&nbsp;<span class="ident" id="5370074">rightLen</span><span class="op" id="5370082">&amp;</span><span class="num" id="5370083">0x1</span>&nbsp;<span class="op" id="5370087">!=</span>&nbsp;<span class="num" id="5370090">0</span>&nbsp;<span class="op" id="5370092">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5370096">panic</span><span class="op" id="5370101">(</span><span class="string" id="5370102">&#34;mergeRuneSets&nbsp;odd&nbsp;length&nbsp;[]rune&#34;</span><span class="op" id="5370135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5370138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5370141">var</span>&nbsp;<span class="op" id="5370145">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5370149">lx</span><span class="op" id="5370151">,</span>&nbsp;<span class="ident" id="5370153">rx</span>&nbsp;<span class="builtintype" id="5370156">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5370161">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5370164">merged</span>&nbsp;<span class="op" id="5370171">:=</span>&nbsp;<span class="builtinfunc" id="5370174">make</span><span class="op" id="5370178">(</span><span class="op" id="5370179">[</span><span class="op" id="5370180">]</span><span class="builtintype" id="5370181">rune</span><span class="op" id="5370185">,</span>&nbsp;<span class="num" id="5370187">0</span><span class="op" id="5370188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5370191">next</span>&nbsp;<span class="op" id="5370196">:=</span>&nbsp;<span class="builtinfunc" id="5370199">make</span><span class="op" id="5370203">(</span><span class="op" id="5370204">[</span><span class="op" id="5370205">]</span><span class="builtintype" id="5370206">uint32</span><span class="op" id="5370212">,</span>&nbsp;<span class="num" id="5370214">0</span><span class="op" id="5370215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5370218">ok</span>&nbsp;<span class="op" id="5370221">:=</span>&nbsp;<span class="builtintype" id="5370224">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5370230">defer</span>&nbsp;<span class="keyword" id="5370236">func</span><span class="op" id="5370240">(</span><span class="op" id="5370241">)</span>&nbsp;<span class="op" id="5370243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5370247">if</span>&nbsp;<span class="op" id="5370250">!</span><span class="ident" id="5370251">ok</span>&nbsp;<span class="op" id="5370254">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5370259">merged</span>&nbsp;<span class="op" id="5370266">=</span>&nbsp;<span class="ident" id="5370268">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5370275">next</span>&nbsp;<span class="op" id="5370280">=</span>&nbsp;<span class="ident" id="5370282">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5370288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5370291">}</span><span class="op" id="5370292">(</span><span class="op" id="5370293">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5370297">ix</span>&nbsp;<span class="op" id="5370300">:=</span>&nbsp;<span class="op" id="5370303">-</span><span class="num" id="5370304">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5370307">extend</span>&nbsp;<span class="op" id="5370314">:=</span>&nbsp;<span class="keyword" id="5370317">func</span><span class="op" id="5370321">(</span><span class="ident" id="5370322">newLow</span>&nbsp;<span class="op" id="5370329">*</span><span class="builtintype" id="5370330">int</span><span class="op" id="5370333">,</span>&nbsp;<span class="ident" id="5370335">newArray</span>&nbsp;<span class="op" id="5370344">*</span><span class="op" id="5370345">[</span><span class="op" id="5370346">]</span><span class="builtintype" id="5370347">rune</span><span class="op" id="5370351">,</span>&nbsp;<span class="ident" id="5370353">pc</span>&nbsp;<span class="builtintype" id="5370356">uint32</span><span class="op" id="5370362">)</span>&nbsp;<span class="builtintype" id="5370364">bool</span>&nbsp;<span class="op" id="5370369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5370373">if</span>&nbsp;<span class="ident" id="5370376">ix</span>&nbsp;<span class="op" id="5370379">&gt;</span>&nbsp;<span class="num" id="5370381">0</span>&nbsp;<span class="op" id="5370383">&amp;&amp;</span>&nbsp;<span class="op" id="5370386">(</span><span class="op" id="5370387">*</span><span class="ident" id="5370388">newArray</span><span class="op" id="5370396">)</span><span class="op" id="5370397">[</span><span class="op" id="5370398">*</span><span class="ident" id="5370399">newLow</span><span class="op" id="5370405">]</span>&nbsp;<span class="op" id="5370407">&lt;=</span>&nbsp;<span class="ident" id="5370410">merged</span><span class="op" id="5370416">[</span><span class="ident" id="5370417">ix</span><span class="op" id="5370419">]</span>&nbsp;<span class="op" id="5370421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5370426">return</span>&nbsp;<span class="builtintype" id="5370433">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5370441">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5370445">merged</span>&nbsp;<span class="op" id="5370452">=</span>&nbsp;<span class="builtinfunc" id="5370454">append</span><span class="op" id="5370460">(</span><span class="ident" id="5370461">merged</span><span class="op" id="5370467">,</span>&nbsp;<span class="op" id="5370469">(</span><span class="op" id="5370470">*</span><span class="ident" id="5370471">newArray</span><span class="op" id="5370479">)</span><span class="op" id="5370480">[</span><span class="op" id="5370481">*</span><span class="ident" id="5370482">newLow</span><span class="op" id="5370488">]</span><span class="op" id="5370489">,</span>&nbsp;<span class="op" id="5370491">(</span><span class="op" id="5370492">*</span><span class="ident" id="5370493">newArray</span><span class="op" id="5370501">)</span><span class="op" id="5370502">[</span><span class="op" id="5370503">*</span><span class="ident" id="5370504">newLow</span><span class="op" id="5370510">+</span><span class="num" id="5370511">1</span><span class="op" id="5370512">]</span><span class="op" id="5370513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5370517">*</span><span class="ident" id="5370518">newLow</span>&nbsp;<span class="op" id="5370525">+=</span>&nbsp;<span class="num" id="5370528">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5370532">ix</span>&nbsp;<span class="op" id="5370535">+=</span>&nbsp;<span class="num" id="5370538">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5370542">next</span>&nbsp;<span class="op" id="5370547">=</span>&nbsp;<span class="builtinfunc" id="5370549">append</span><span class="op" id="5370555">(</span><span class="ident" id="5370556">next</span><span class="op" id="5370560">,</span>&nbsp;<span class="ident" id="5370562">pc</span><span class="op" id="5370564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5370568">return</span>&nbsp;<span class="builtintype" id="5370575">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5370581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5370585">for</span>&nbsp;<span class="ident" id="5370589">lx</span>&nbsp;<span class="op" id="5370592">&lt;</span>&nbsp;<span class="ident" id="5370594">leftLen</span>&nbsp;<span class="op" id="5370602">||</span>&nbsp;<span class="ident" id="5370605">rx</span>&nbsp;<span class="op" id="5370608">&lt;</span>&nbsp;<span class="ident" id="5370610">rightLen</span>&nbsp;<span class="op" id="5370619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5370623">switch</span>&nbsp;<span class="op" id="5370630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5370634">case</span>&nbsp;<span class="ident" id="5370639">rx</span>&nbsp;<span class="op" id="5370642">&gt;=</span>&nbsp;<span class="ident" id="5370645">rightLen</span><span class="op" id="5370653">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5370658">ok</span>&nbsp;<span class="op" id="5370661">=</span>&nbsp;<span class="ident" id="5370663">extend</span><span class="op" id="5370669">(</span><span class="op" id="5370670">&amp;</span><span class="ident" id="5370671">lx</span><span class="op" id="5370673">,</span>&nbsp;<span class="ident" id="5370675">leftRunes</span><span class="op" id="5370684">,</span>&nbsp;<span class="ident" id="5370686">leftPC</span><span class="op" id="5370692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5370696">case</span>&nbsp;<span class="ident" id="5370701">lx</span>&nbsp;<span class="op" id="5370704">&gt;=</span>&nbsp;<span class="ident" id="5370707">leftLen</span><span class="op" id="5370714">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5370719">ok</span>&nbsp;<span class="op" id="5370722">=</span>&nbsp;<span class="ident" id="5370724">extend</span><span class="op" id="5370730">(</span><span class="op" id="5370731">&amp;</span><span class="ident" id="5370732">rx</span><span class="op" id="5370734">,</span>&nbsp;<span class="ident" id="5370736">rightRunes</span><span class="op" id="5370746">,</span>&nbsp;<span class="ident" id="5370748">rightPC</span><span class="op" id="5370755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5370759">case</span>&nbsp;<span class="op" id="5370764">(</span><span class="op" id="5370765">*</span><span class="ident" id="5370766">rightRunes</span><span class="op" id="5370776">)</span><span class="op" id="5370777">[</span><span class="ident" id="5370778">rx</span><span class="op" id="5370780">]</span>&nbsp;<span class="op" id="5370782">&lt;</span>&nbsp;<span class="op" id="5370784">(</span><span class="op" id="5370785">*</span><span class="ident" id="5370786">leftRunes</span><span class="op" id="5370795">)</span><span class="op" id="5370796">[</span><span class="ident" id="5370797">lx</span><span class="op" id="5370799">]</span><span class="op" id="5370800">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5370805">ok</span>&nbsp;<span class="op" id="5370808">=</span>&nbsp;<span class="ident" id="5370810">extend</span><span class="op" id="5370816">(</span><span class="op" id="5370817">&amp;</span><span class="ident" id="5370818">rx</span><span class="op" id="5370820">,</span>&nbsp;<span class="ident" id="5370822">rightRunes</span><span class="op" id="5370832">,</span>&nbsp;<span class="ident" id="5370834">rightPC</span><span class="op" id="5370841">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5370845">default</span><span class="op" id="5370852">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5370857">ok</span>&nbsp;<span class="op" id="5370860">=</span>&nbsp;<span class="ident" id="5370862">extend</span><span class="op" id="5370868">(</span><span class="op" id="5370869">&amp;</span><span class="ident" id="5370870">lx</span><span class="op" id="5370872">,</span>&nbsp;<span class="ident" id="5370874">leftRunes</span><span class="op" id="5370883">,</span>&nbsp;<span class="ident" id="5370885">leftPC</span><span class="op" id="5370891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5370895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5370899">if</span>&nbsp;<span class="op" id="5370902">!</span><span class="ident" id="5370903">ok</span>&nbsp;<span class="op" id="5370906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5370911">return</span>&nbsp;<span class="ident" id="5370918">noRune</span><span class="op" id="5370924">,</span>&nbsp;<span class="ident" id="5370926">noNext</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5370935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5370938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5370941">return</span>&nbsp;<span class="ident" id="5370948">merged</span><span class="op" id="5370954">,</span>&nbsp;<span class="ident" id="5370956">next</span><br>
<span class="lineno"></span><span class="op" id="5370961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="comment" id="5370964">//&nbsp;cleanupOnePass&nbsp;drops&nbsp;working&nbsp;memory,&nbsp;and&nbsp;restores&nbsp;certain&nbsp;shortcut&nbsp;instructions.</span><br>
<span class="lineno"></span><span class="keyword" id="5371048">func</span>&nbsp;<span class="ident" id="5371053">cleanupOnePass</span><span class="op" id="5371067">(</span><span class="ident" id="5371068">prog</span>&nbsp;<span class="op" id="5371073">*</span><span class="ident" id="5371074">onePassProg</span><span class="op" id="5371085">,</span>&nbsp;<span class="ident" id="5371087">original</span>&nbsp;<span class="op" id="5371096">*</span><span class="ident" id="5371097">syntax</span><span class="op" id="5371103">.</span><span class="ident" id="5371104">Prog</span><span class="op" id="5371108">)</span>&nbsp;<span class="op" id="5371110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5371113">for</span>&nbsp;<span class="ident" id="5371117">ix</span><span class="op" id="5371119">,</span>&nbsp;<span class="ident" id="5371121">instOriginal</span>&nbsp;<span class="op" id="5371134">:=</span>&nbsp;<span class="keyword" id="5371137">range</span>&nbsp;<span class="ident" id="5371143">original</span><span class="op" id="5371151">.</span><span class="ident" id="5371152">Inst</span>&nbsp;<span class="op" id="5371157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5371161">switch</span>&nbsp;<span class="ident" id="5371168">instOriginal</span><span class="op" id="5371180">.</span><span class="ident" id="5371181">Op</span>&nbsp;<span class="op" id="5371184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5371188">case</span>&nbsp;<span class="ident" id="5371193">syntax</span><span class="op" id="5371199">.</span><span class="ident" id="5371200">InstAlt</span><span class="op" id="5371207">,</span>&nbsp;<span class="ident" id="5371209">syntax</span><span class="op" id="5371215">.</span><span class="ident" id="5371216">InstAltMatch</span><span class="op" id="5371228">,</span>&nbsp;<span class="ident" id="5371230">syntax</span><span class="op" id="5371236">.</span><span class="ident" id="5371237">InstRune</span><span class="op" id="5371245">:</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5371249">case</span>&nbsp;<span class="ident" id="5371254">syntax</span><span class="op" id="5371260">.</span><span class="ident" id="5371261">InstCapture</span><span class="op" id="5371272">,</span>&nbsp;<span class="ident" id="5371274">syntax</span><span class="op" id="5371280">.</span><span class="ident" id="5371281">InstEmptyWidth</span><span class="op" id="5371295">,</span>&nbsp;<span class="ident" id="5371297">syntax</span><span class="op" id="5371303">.</span><span class="ident" id="5371304">InstNop</span><span class="op" id="5371311">,</span>&nbsp;<span class="ident" id="5371313">syntax</span><span class="op" id="5371319">.</span><span class="ident" id="5371320">InstMatch</span><span class="op" id="5371329">,</span>&nbsp;<span class="ident" id="5371331">syntax</span><span class="op" id="5371337">.</span><span class="ident" id="5371338">InstFail</span><span class="op" id="5371346">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5371351">prog</span><span class="op" id="5371355">.</span><span class="ident" id="5371356">Inst</span><span class="op" id="5371360">[</span><span class="ident" id="5371361">ix</span><span class="op" id="5371363">]</span><span class="op" id="5371364">.</span><span class="ident" id="5371365">Next</span>&nbsp;<span class="op" id="5371370">=</span>&nbsp;<span class="ident" id="5371372">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5371378">case</span>&nbsp;<span class="ident" id="5371383">syntax</span><span class="op" id="5371389">.</span><span class="ident" id="5371390">InstRune1</span><span class="op" id="5371399">,</span>&nbsp;<span class="ident" id="5371401">syntax</span><span class="op" id="5371407">.</span><span class="ident" id="5371408">InstRuneAny</span><span class="op" id="5371419">,</span>&nbsp;<span class="ident" id="5371421">syntax</span><span class="op" id="5371427">.</span><span class="ident" id="5371428">InstRuneAnyNotNL</span><span class="op" id="5371444">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5371449">prog</span><span class="op" id="5371453">.</span><span class="ident" id="5371454">Inst</span><span class="op" id="5371458">[</span><span class="ident" id="5371459">ix</span><span class="op" id="5371461">]</span><span class="op" id="5371462">.</span><span class="ident" id="5371463">Next</span>&nbsp;<span class="op" id="5371468">=</span>&nbsp;<span class="ident" id="5371470">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5371477">prog</span><span class="op" id="5371481">.</span><span class="ident" id="5371482">Inst</span><span class="op" id="5371486">[</span><span class="ident" id="5371487">ix</span><span class="op" id="5371489">]</span>&nbsp;<span class="op" id="5371491">=</span>&nbsp;<span class="ident" id="5371493">onePassInst</span><span class="op" id="5371504">{</span><span class="ident" id="5371505">Inst</span><span class="op" id="5371509">:</span>&nbsp;<span class="ident" id="5371511">instOriginal</span><span class="op" id="5371523">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5371527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5371530">}</span><br>
<span class="lineno"></span><span class="op" id="5371532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5371535">//&nbsp;onePassCopy&nbsp;creates&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog,&nbsp;as&nbsp;we&#39;ll&nbsp;be&nbsp;modifying&nbsp;it</span><br>
<span class="lineno">220</span><span class="keyword" id="5371612">func</span>&nbsp;<span class="ident" id="5371617">onePassCopy</span><span class="op" id="5371628">(</span><span class="ident" id="5371629">prog</span>&nbsp;<span class="op" id="5371634">*</span><span class="ident" id="5371635">syntax</span><span class="op" id="5371641">.</span><span class="ident" id="5371642">Prog</span><span class="op" id="5371646">)</span>&nbsp;<span class="op" id="5371648">*</span><span class="ident" id="5371649">onePassProg</span>&nbsp;<span class="op" id="5371661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5371664">p</span>&nbsp;<span class="op" id="5371666">:=</span>&nbsp;<span class="op" id="5371669">&amp;</span><span class="ident" id="5371670">onePassProg</span><span class="op" id="5371681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5371685">Start</span><span class="op" id="5371690">:</span>&nbsp;&nbsp;<span class="ident" id="5371693">prog</span><span class="op" id="5371697">.</span><span class="ident" id="5371698">Start</span><span class="op" id="5371703">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5371707">NumCap</span><span class="op" id="5371713">:</span>&nbsp;<span class="ident" id="5371715">prog</span><span class="op" id="5371719">.</span><span class="ident" id="5371720">NumCap</span><span class="op" id="5371726">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5371729">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5371732">for</span>&nbsp;<span class="ident" id="5371736">_</span><span class="op" id="5371737">,</span>&nbsp;<span class="ident" id="5371739">inst</span>&nbsp;<span class="op" id="5371744">:=</span>&nbsp;<span class="keyword" id="5371747">range</span>&nbsp;<span class="ident" id="5371753">prog</span><span class="op" id="5371757">.</span><span class="ident" id="5371758">Inst</span>&nbsp;<span class="op" id="5371763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5371767">p</span><span class="op" id="5371768">.</span><span class="ident" id="5371769">Inst</span>&nbsp;<span class="op" id="5371774">=</span>&nbsp;<span class="builtinfunc" id="5371776">append</span><span class="op" id="5371782">(</span><span class="ident" id="5371783">p</span><span class="op" id="5371784">.</span><span class="ident" id="5371785">Inst</span><span class="op" id="5371789">,</span>&nbsp;<span class="ident" id="5371791">onePassInst</span><span class="op" id="5371802">{</span><span class="ident" id="5371803">Inst</span><span class="op" id="5371807">:</span>&nbsp;<span class="ident" id="5371809">inst</span><span class="op" id="5371813">}</span><span class="op" id="5371814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5371817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5371821">//&nbsp;rewrites&nbsp;one&nbsp;or&nbsp;more&nbsp;common&nbsp;Prog&nbsp;constructs&nbsp;that&nbsp;enable&nbsp;some&nbsp;otherwise</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5371896">//&nbsp;non-onepass&nbsp;Progs&nbsp;to&nbsp;be&nbsp;onepass.&nbsp;A:BD&nbsp;(for&nbsp;example)&nbsp;means&nbsp;an&nbsp;InstAlt&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5371972">//&nbsp;ip&nbsp;A,&nbsp;that&nbsp;points&nbsp;to&nbsp;ips&nbsp;B&nbsp;&amp;&nbsp;C.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5372008">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:CD</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5372039">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5372070">for</span>&nbsp;<span class="ident" id="5372074">pc</span>&nbsp;<span class="op" id="5372077">:=</span>&nbsp;<span class="keyword" id="5372080">range</span>&nbsp;<span class="ident" id="5372086">p</span><span class="op" id="5372087">.</span><span class="ident" id="5372088">Inst</span>&nbsp;<span class="op" id="5372093">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5372097">switch</span>&nbsp;<span class="ident" id="5372104">p</span><span class="op" id="5372105">.</span><span class="ident" id="5372106">Inst</span><span class="op" id="5372110">[</span><span class="ident" id="5372111">pc</span><span class="op" id="5372113">]</span><span class="op" id="5372114">.</span><span class="ident" id="5372115">Op</span>&nbsp;<span class="op" id="5372118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5372122">default</span><span class="op" id="5372129">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5372134">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5372145">case</span>&nbsp;<span class="ident" id="5372150">syntax</span><span class="op" id="5372156">.</span><span class="ident" id="5372157">InstAlt</span><span class="op" id="5372164">,</span>&nbsp;<span class="ident" id="5372166">syntax</span><span class="op" id="5372172">.</span><span class="ident" id="5372173">InstAltMatch</span><span class="op" id="5372185">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5372190">//&nbsp;A:Bx&nbsp;+&nbsp;B:Ay</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5372208">p_A_Other</span>&nbsp;<span class="op" id="5372218">:=</span>&nbsp;<span class="op" id="5372221">&amp;</span><span class="ident" id="5372222">p</span><span class="op" id="5372223">.</span><span class="ident" id="5372224">Inst</span><span class="op" id="5372228">[</span><span class="ident" id="5372229">pc</span><span class="op" id="5372231">]</span><span class="op" id="5372232">.</span><span class="ident" id="5372233">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5372240">p_A_Alt</span>&nbsp;<span class="op" id="5372248">:=</span>&nbsp;<span class="op" id="5372251">&amp;</span><span class="ident" id="5372252">p</span><span class="op" id="5372253">.</span><span class="ident" id="5372254">Inst</span><span class="op" id="5372258">[</span><span class="ident" id="5372259">pc</span><span class="op" id="5372261">]</span><span class="op" id="5372262">.</span><span class="ident" id="5372263">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5372270">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;target&nbsp;is&nbsp;another&nbsp;Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5372310">instAlt</span>&nbsp;<span class="op" id="5372318">:=</span>&nbsp;<span class="ident" id="5372321">p</span><span class="op" id="5372322">.</span><span class="ident" id="5372323">Inst</span><span class="op" id="5372327">[</span><span class="op" id="5372328">*</span><span class="ident" id="5372329">p_A_Alt</span><span class="op" id="5372336">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5372341">if</span>&nbsp;<span class="op" id="5372344">!</span><span class="op" id="5372345">(</span><span class="ident" id="5372346">instAlt</span><span class="op" id="5372353">.</span><span class="ident" id="5372354">Op</span>&nbsp;<span class="op" id="5372357">==</span>&nbsp;<span class="ident" id="5372360">syntax</span><span class="op" id="5372366">.</span><span class="ident" id="5372367">InstAlt</span>&nbsp;<span class="op" id="5372375">||</span>&nbsp;<span class="ident" id="5372378">instAlt</span><span class="op" id="5372385">.</span><span class="ident" id="5372386">Op</span>&nbsp;<span class="op" id="5372389">==</span>&nbsp;<span class="ident" id="5372392">syntax</span><span class="op" id="5372398">.</span><span class="ident" id="5372399">InstAltMatch</span><span class="op" id="5372411">)</span>&nbsp;<span class="op" id="5372413">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5372419">p_A_Alt</span><span class="op" id="5372426">,</span>&nbsp;<span class="ident" id="5372428">p_A_Other</span>&nbsp;<span class="op" id="5372438">=</span>&nbsp;<span class="ident" id="5372440">p_A_Other</span><span class="op" id="5372449">,</span>&nbsp;<span class="ident" id="5372451">p_A_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5372463">instAlt</span>&nbsp;<span class="op" id="5372471">=</span>&nbsp;<span class="ident" id="5372473">p</span><span class="op" id="5372474">.</span><span class="ident" id="5372475">Inst</span><span class="op" id="5372479">[</span><span class="op" id="5372480">*</span><span class="ident" id="5372481">p_A_Alt</span><span class="op" id="5372488">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5372494">if</span>&nbsp;<span class="op" id="5372497">!</span><span class="op" id="5372498">(</span><span class="ident" id="5372499">instAlt</span><span class="op" id="5372506">.</span><span class="ident" id="5372507">Op</span>&nbsp;<span class="op" id="5372510">==</span>&nbsp;<span class="ident" id="5372513">syntax</span><span class="op" id="5372519">.</span><span class="ident" id="5372520">InstAlt</span>&nbsp;<span class="op" id="5372528">||</span>&nbsp;<span class="ident" id="5372531">instAlt</span><span class="op" id="5372538">.</span><span class="ident" id="5372539">Op</span>&nbsp;<span class="op" id="5372542">==</span>&nbsp;<span class="ident" id="5372545">syntax</span><span class="op" id="5372551">.</span><span class="ident" id="5372552">InstAltMatch</span><span class="op" id="5372564">)</span>&nbsp;<span class="op" id="5372566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5372573">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5372586">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5372591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5372596">instOther</span>&nbsp;<span class="op" id="5372606">:=</span>&nbsp;<span class="ident" id="5372609">p</span><span class="op" id="5372610">.</span><span class="ident" id="5372611">Inst</span><span class="op" id="5372615">[</span><span class="op" id="5372616">*</span><span class="ident" id="5372617">p_A_Other</span><span class="op" id="5372626">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5372631">//&nbsp;Analyzing&nbsp;both&nbsp;legs&nbsp;pointing&nbsp;to&nbsp;Alts&nbsp;is&nbsp;for&nbsp;another&nbsp;day</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5372693">if</span>&nbsp;<span class="ident" id="5372696">instOther</span><span class="op" id="5372705">.</span><span class="ident" id="5372706">Op</span>&nbsp;<span class="op" id="5372709">==</span>&nbsp;<span class="ident" id="5372712">syntax</span><span class="op" id="5372718">.</span><span class="ident" id="5372719">InstAlt</span>&nbsp;<span class="op" id="5372727">||</span>&nbsp;<span class="ident" id="5372730">instOther</span><span class="op" id="5372739">.</span><span class="ident" id="5372740">Op</span>&nbsp;<span class="op" id="5372743">==</span>&nbsp;<span class="ident" id="5372746">syntax</span><span class="op" id="5372752">.</span><span class="ident" id="5372753">InstAltMatch</span>&nbsp;<span class="op" id="5372766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5372772">//&nbsp;too&nbsp;complicated</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5372795">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5372807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5372812">//&nbsp;simple&nbsp;empty&nbsp;transition&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5372847">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5372880">p_B_Alt</span>&nbsp;<span class="op" id="5372888">:=</span>&nbsp;<span class="op" id="5372891">&amp;</span><span class="ident" id="5372892">p</span><span class="op" id="5372893">.</span><span class="ident" id="5372894">Inst</span><span class="op" id="5372898">[</span><span class="op" id="5372899">*</span><span class="ident" id="5372900">p_A_Alt</span><span class="op" id="5372907">]</span><span class="op" id="5372908">.</span><span class="ident" id="5372909">Out</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5372916">p_B_Other</span>&nbsp;<span class="op" id="5372926">:=</span>&nbsp;<span class="op" id="5372929">&amp;</span><span class="ident" id="5372930">p</span><span class="op" id="5372931">.</span><span class="ident" id="5372932">Inst</span><span class="op" id="5372936">[</span><span class="op" id="5372937">*</span><span class="ident" id="5372938">p_A_Alt</span><span class="op" id="5372945">]</span><span class="op" id="5372946">.</span><span class="ident" id="5372947">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5372954">patch</span>&nbsp;<span class="op" id="5372960">:=</span>&nbsp;<span class="builtintype" id="5372963">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5372972">if</span>&nbsp;<span class="ident" id="5372975">instAlt</span><span class="op" id="5372982">.</span><span class="ident" id="5372983">Out</span>&nbsp;<span class="op" id="5372987">==</span>&nbsp;<span class="builtintype" id="5372990">uint32</span><span class="op" id="5372996">(</span><span class="ident" id="5372997">pc</span><span class="op" id="5372999">)</span>&nbsp;<span class="op" id="5373001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5373007">patch</span>&nbsp;<span class="op" id="5373013">=</span>&nbsp;<span class="builtintype" id="5373015">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5373023">}</span>&nbsp;<span class="keyword" id="5373025">else</span>&nbsp;<span class="keyword" id="5373030">if</span>&nbsp;<span class="ident" id="5373033">instAlt</span><span class="op" id="5373040">.</span><span class="ident" id="5373041">Arg</span>&nbsp;<span class="op" id="5373045">==</span>&nbsp;<span class="builtintype" id="5373048">uint32</span><span class="op" id="5373054">(</span><span class="ident" id="5373055">pc</span><span class="op" id="5373057">)</span>&nbsp;<span class="op" id="5373059">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5373065">patch</span>&nbsp;<span class="op" id="5373071">=</span>&nbsp;<span class="builtintype" id="5373073">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5373082">p_B_Alt</span><span class="op" id="5373089">,</span>&nbsp;<span class="ident" id="5373091">p_B_Other</span>&nbsp;<span class="op" id="5373101">=</span>&nbsp;<span class="ident" id="5373103">p_B_Other</span><span class="op" id="5373112">,</span>&nbsp;<span class="ident" id="5373114">p_B_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5373125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5373130">if</span>&nbsp;<span class="ident" id="5373133">patch</span>&nbsp;<span class="op" id="5373139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5373145">*</span><span class="ident" id="5373146">p_B_Alt</span>&nbsp;<span class="op" id="5373154">=</span>&nbsp;<span class="op" id="5373156">*</span><span class="ident" id="5373157">p_A_Other</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5373170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5373176">//&nbsp;empty&nbsp;transition&nbsp;to&nbsp;common&nbsp;target</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5373216">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5373249">if</span>&nbsp;<span class="op" id="5373252">*</span><span class="ident" id="5373253">p_A_Other</span>&nbsp;<span class="op" id="5373263">==</span>&nbsp;<span class="op" id="5373266">*</span><span class="ident" id="5373267">p_B_Alt</span>&nbsp;<span class="op" id="5373275">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5373281">*</span><span class="ident" id="5373282">p_A_Alt</span>&nbsp;<span class="op" id="5373290">=</span>&nbsp;<span class="op" id="5373292">*</span><span class="ident" id="5373293">p_B_Other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5373306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5373310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5373313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5373316">return</span>&nbsp;<span class="ident" id="5373323">p</span><br>
<span class="lineno">280</span><span class="op" id="5373325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5373328">//&nbsp;runeSlice&nbsp;exists&nbsp;to&nbsp;permit&nbsp;sorting&nbsp;the&nbsp;case-folded&nbsp;rune&nbsp;sets.</span><br>
<span class="lineno"></span><span class="keyword" id="5373393">type</span>&nbsp;<span class="ident" id="5373398">runeSlice</span>&nbsp;<span class="op" id="5373408">[</span><span class="op" id="5373409">]</span><span class="builtintype" id="5373410">rune</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="5373416">func</span>&nbsp;<span class="op" id="5373421">(</span><span class="ident" id="5373422">p</span>&nbsp;<span class="ident" id="5373424">runeSlice</span><span class="op" id="5373433">)</span>&nbsp;<span class="ident" id="5373435">Len</span><span class="op" id="5373438">(</span><span class="op" id="5373439">)</span>&nbsp;<span class="builtintype" id="5373441">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5373455">{</span>&nbsp;<span class="keyword" id="5373457">return</span>&nbsp;<span class="builtinfunc" id="5373464">len</span><span class="op" id="5373467">(</span><span class="ident" id="5373468">p</span><span class="op" id="5373469">)</span>&nbsp;<span class="op" id="5373471">}</span><br>
<span class="lineno"></span><span class="keyword" id="5373473">func</span>&nbsp;<span class="op" id="5373478">(</span><span class="ident" id="5373479">p</span>&nbsp;<span class="ident" id="5373481">runeSlice</span><span class="op" id="5373490">)</span>&nbsp;<span class="ident" id="5373492">Less</span><span class="op" id="5373496">(</span><span class="ident" id="5373497">i</span><span class="op" id="5373498">,</span>&nbsp;<span class="ident" id="5373500">j</span>&nbsp;<span class="builtintype" id="5373502">int</span><span class="op" id="5373505">)</span>&nbsp;<span class="builtintype" id="5373507">bool</span>&nbsp;<span class="op" id="5373512">{</span>&nbsp;<span class="keyword" id="5373514">return</span>&nbsp;<span class="ident" id="5373521">p</span><span class="op" id="5373522">[</span><span class="ident" id="5373523">i</span><span class="op" id="5373524">]</span>&nbsp;<span class="op" id="5373526">&lt;</span>&nbsp;<span class="ident" id="5373528">p</span><span class="op" id="5373529">[</span><span class="ident" id="5373530">j</span><span class="op" id="5373531">]</span>&nbsp;<span class="op" id="5373533">}</span><br>
<span class="lineno"></span><span class="keyword" id="5373535">func</span>&nbsp;<span class="op" id="5373540">(</span><span class="ident" id="5373541">p</span>&nbsp;<span class="ident" id="5373543">runeSlice</span><span class="op" id="5373552">)</span>&nbsp;<span class="ident" id="5373554">Swap</span><span class="op" id="5373558">(</span><span class="ident" id="5373559">i</span><span class="op" id="5373560">,</span>&nbsp;<span class="ident" id="5373562">j</span>&nbsp;<span class="builtintype" id="5373564">int</span><span class="op" id="5373567">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5373574">{</span>&nbsp;<span class="ident" id="5373576">p</span><span class="op" id="5373577">[</span><span class="ident" id="5373578">i</span><span class="op" id="5373579">]</span><span class="op" id="5373580">,</span>&nbsp;<span class="ident" id="5373582">p</span><span class="op" id="5373583">[</span><span class="ident" id="5373584">j</span><span class="op" id="5373585">]</span>&nbsp;<span class="op" id="5373587">=</span>&nbsp;<span class="ident" id="5373589">p</span><span class="op" id="5373590">[</span><span class="ident" id="5373591">j</span><span class="op" id="5373592">]</span><span class="op" id="5373593">,</span>&nbsp;<span class="ident" id="5373595">p</span><span class="op" id="5373596">[</span><span class="ident" id="5373597">i</span><span class="op" id="5373598">]</span>&nbsp;<span class="op" id="5373600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5373603">//&nbsp;Sort&nbsp;is&nbsp;a&nbsp;convenience&nbsp;method.</span><br>
<span class="lineno">290</span><span class="keyword" id="5373636">func</span>&nbsp;<span class="op" id="5373641">(</span><span class="ident" id="5373642">p</span>&nbsp;<span class="ident" id="5373644">runeSlice</span><span class="op" id="5373653">)</span>&nbsp;<span class="ident" id="5373655">Sort</span><span class="op" id="5373659">(</span><span class="op" id="5373660">)</span>&nbsp;<span class="op" id="5373662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5373665">sort</span><span class="op" id="5373669">.</span><span class="ident" id="5373670">Sort</span><span class="op" id="5373674">(</span><span class="ident" id="5373675">p</span><span class="op" id="5373676">)</span><br>
<span class="lineno"></span><span class="op" id="5373678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5373681">var</span>&nbsp;<span class="ident" id="5373685">anyRuneNotNL</span>&nbsp;<span class="op" id="5373698">=</span>&nbsp;<span class="op" id="5373700">[</span><span class="op" id="5373701">]</span><span class="builtintype" id="5373702">rune</span><span class="op" id="5373706">{</span><span class="num" id="5373707">0</span><span class="op" id="5373708">,</span>&nbsp;<span class="string" id="5373710">&#39;\n&#39;</span>&nbsp;<span class="op" id="5373715">-</span>&nbsp;<span class="num" id="5373717">1</span><span class="op" id="5373718">,</span>&nbsp;<span class="string" id="5373720">&#39;\n&#39;</span>&nbsp;<span class="op" id="5373725">+</span>&nbsp;<span class="num" id="5373727">1</span><span class="op" id="5373728">,</span>&nbsp;<span class="ident" id="5373730">unicode</span><span class="op" id="5373737">.</span><span class="ident" id="5373738">MaxRune</span><span class="op" id="5373745">}</span><br>
<span class="lineno">295</span><span class="keyword" id="5373747">var</span>&nbsp;<span class="ident" id="5373751">anyRune</span>&nbsp;<span class="op" id="5373759">=</span>&nbsp;<span class="op" id="5373761">[</span><span class="op" id="5373762">]</span><span class="builtintype" id="5373763">rune</span><span class="op" id="5373767">{</span><span class="num" id="5373768">0</span><span class="op" id="5373769">,</span>&nbsp;<span class="ident" id="5373771">unicode</span><span class="op" id="5373778">.</span><span class="ident" id="5373779">MaxRune</span><span class="op" id="5373786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5373789">//&nbsp;makeOnePass&nbsp;creates&nbsp;a&nbsp;onepass&nbsp;Prog,&nbsp;if&nbsp;possible.&nbsp;It&nbsp;is&nbsp;possible&nbsp;if&nbsp;at&nbsp;any&nbsp;alt,</span><br>
<span class="lineno"></span><span class="comment" id="5373871">//&nbsp;the&nbsp;match&nbsp;engine&nbsp;can&nbsp;always&nbsp;tell&nbsp;which&nbsp;branch&nbsp;to&nbsp;take.&nbsp;The&nbsp;routine&nbsp;may&nbsp;modify</span><br>
<span class="lineno"></span><span class="comment" id="5373952">//&nbsp;p&nbsp;if&nbsp;it&nbsp;is&nbsp;turned&nbsp;into&nbsp;a&nbsp;onepass&nbsp;Prog.&nbsp;If&nbsp;it&nbsp;isn&#39;t&nbsp;possible&nbsp;for&nbsp;this&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno">300</span><span class="comment" id="5374032">//&nbsp;onepass&nbsp;Prog,&nbsp;the&nbsp;Prog&nbsp;notOnePass&nbsp;is&nbsp;returned.&nbsp;makeOnePass&nbsp;is&nbsp;recursive</span><br>
<span class="lineno"></span><span class="comment" id="5374107">//&nbsp;to&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;Prog.</span><br>
<span class="lineno"></span><span class="keyword" id="5374135">func</span>&nbsp;<span class="ident" id="5374140">makeOnePass</span><span class="op" id="5374151">(</span><span class="ident" id="5374152">p</span>&nbsp;<span class="op" id="5374154">*</span><span class="ident" id="5374155">onePassProg</span><span class="op" id="5374166">)</span>&nbsp;<span class="op" id="5374168">*</span><span class="ident" id="5374169">onePassProg</span>&nbsp;<span class="op" id="5374181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5374184">//&nbsp;If&nbsp;the&nbsp;machine&nbsp;is&nbsp;very&nbsp;long,&nbsp;it&#39;s&nbsp;not&nbsp;worth&nbsp;the&nbsp;time&nbsp;to&nbsp;check&nbsp;if&nbsp;we&nbsp;can&nbsp;use&nbsp;one&nbsp;pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5374274">if</span>&nbsp;<span class="builtinfunc" id="5374277">len</span><span class="op" id="5374280">(</span><span class="ident" id="5374281">p</span><span class="op" id="5374282">.</span><span class="ident" id="5374283">Inst</span><span class="op" id="5374287">)</span>&nbsp;<span class="op" id="5374289">&gt;=</span>&nbsp;<span class="num" id="5374292">1000</span>&nbsp;<span class="op" id="5374297">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5374301">return</span>&nbsp;<span class="ident" id="5374308">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5374320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5374324">var</span>&nbsp;<span class="op" id="5374328">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5374332">instQueue</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5374345">=</span>&nbsp;<span class="ident" id="5374347">newQueue</span><span class="op" id="5374355">(</span><span class="builtinfunc" id="5374356">len</span><span class="op" id="5374359">(</span><span class="ident" id="5374360">p</span><span class="op" id="5374361">.</span><span class="ident" id="5374362">Inst</span><span class="op" id="5374366">)</span><span class="op" id="5374367">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5374371">visitQueue</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5374384">=</span>&nbsp;<span class="ident" id="5374386">newQueue</span><span class="op" id="5374394">(</span><span class="builtinfunc" id="5374395">len</span><span class="op" id="5374398">(</span><span class="ident" id="5374399">p</span><span class="op" id="5374400">.</span><span class="ident" id="5374401">Inst</span><span class="op" id="5374405">)</span><span class="op" id="5374406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5374410">build</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5374423">func</span><span class="op" id="5374427">(</span><span class="builtintype" id="5374428">uint32</span><span class="op" id="5374434">,</span>&nbsp;<span class="op" id="5374436">*</span><span class="ident" id="5374437">queueOnePass</span><span class="op" id="5374449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5374453">check</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5374466">func</span><span class="op" id="5374470">(</span><span class="builtintype" id="5374471">uint32</span><span class="op" id="5374477">,</span>&nbsp;<span class="keyword" id="5374479">map</span><span class="op" id="5374482">[</span><span class="builtintype" id="5374483">uint32</span><span class="op" id="5374489">]</span><span class="builtintype" id="5374490">bool</span><span class="op" id="5374494">)</span>&nbsp;<span class="builtintype" id="5374496">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5374503">onePassRunes</span>&nbsp;<span class="op" id="5374516">=</span>&nbsp;<span class="builtinfunc" id="5374518">make</span><span class="op" id="5374522">(</span><span class="op" id="5374523">[</span><span class="op" id="5374524">]</span><span class="op" id="5374525">[</span><span class="op" id="5374526">]</span><span class="builtintype" id="5374527">rune</span><span class="op" id="5374531">,</span>&nbsp;<span class="builtinfunc" id="5374533">len</span><span class="op" id="5374536">(</span><span class="ident" id="5374537">p</span><span class="op" id="5374538">.</span><span class="ident" id="5374539">Inst</span><span class="op" id="5374543">)</span><span class="op" id="5374544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5374547">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5374550">build</span>&nbsp;<span class="op" id="5374556">=</span>&nbsp;<span class="keyword" id="5374558">func</span><span class="op" id="5374562">(</span><span class="ident" id="5374563">pc</span>&nbsp;<span class="builtintype" id="5374566">uint32</span><span class="op" id="5374572">,</span>&nbsp;<span class="ident" id="5374574">q</span>&nbsp;<span class="op" id="5374576">*</span><span class="ident" id="5374577">queueOnePass</span><span class="op" id="5374589">)</span>&nbsp;<span class="op" id="5374591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5374595">if</span>&nbsp;<span class="ident" id="5374598">q</span><span class="op" id="5374599">.</span><span class="ident" id="5374600">contains</span><span class="op" id="5374608">(</span><span class="ident" id="5374609">pc</span><span class="op" id="5374611">)</span>&nbsp;<span class="op" id="5374613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5374618">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5374627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5374631">inst</span>&nbsp;<span class="op" id="5374636">:=</span>&nbsp;<span class="ident" id="5374639">p</span><span class="op" id="5374640">.</span><span class="ident" id="5374641">Inst</span><span class="op" id="5374645">[</span><span class="ident" id="5374646">pc</span><span class="op" id="5374648">]</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5374652">switch</span>&nbsp;<span class="ident" id="5374659">inst</span><span class="op" id="5374663">.</span><span class="ident" id="5374664">Op</span>&nbsp;<span class="op" id="5374667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5374671">case</span>&nbsp;<span class="ident" id="5374676">syntax</span><span class="op" id="5374682">.</span><span class="ident" id="5374683">InstAlt</span><span class="op" id="5374690">,</span>&nbsp;<span class="ident" id="5374692">syntax</span><span class="op" id="5374698">.</span><span class="ident" id="5374699">InstAltMatch</span><span class="op" id="5374711">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5374716">q</span><span class="op" id="5374717">.</span><span class="ident" id="5374718">insert</span><span class="op" id="5374724">(</span><span class="ident" id="5374725">inst</span><span class="op" id="5374729">.</span><span class="ident" id="5374730">Out</span><span class="op" id="5374733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5374738">build</span><span class="op" id="5374743">(</span><span class="ident" id="5374744">inst</span><span class="op" id="5374748">.</span><span class="ident" id="5374749">Out</span><span class="op" id="5374752">,</span>&nbsp;<span class="ident" id="5374754">q</span><span class="op" id="5374755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5374760">q</span><span class="op" id="5374761">.</span><span class="ident" id="5374762">insert</span><span class="op" id="5374768">(</span><span class="ident" id="5374769">inst</span><span class="op" id="5374773">.</span><span class="ident" id="5374774">Arg</span><span class="op" id="5374777">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5374781">case</span>&nbsp;<span class="ident" id="5374786">syntax</span><span class="op" id="5374792">.</span><span class="ident" id="5374793">InstMatch</span><span class="op" id="5374802">,</span>&nbsp;<span class="ident" id="5374804">syntax</span><span class="op" id="5374810">.</span><span class="ident" id="5374811">InstFail</span><span class="op" id="5374819">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5374823">default</span><span class="op" id="5374830">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5374835">q</span><span class="op" id="5374836">.</span><span class="ident" id="5374837">insert</span><span class="op" id="5374843">(</span><span class="ident" id="5374844">inst</span><span class="op" id="5374848">.</span><span class="ident" id="5374849">Out</span><span class="op" id="5374852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5374856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5374859">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5374863">//&nbsp;check&nbsp;that&nbsp;paths&nbsp;from&nbsp;Alt&nbsp;instructions&nbsp;are&nbsp;unambiguous,&nbsp;and&nbsp;rebuild&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5374943">//&nbsp;program&nbsp;as&nbsp;a&nbsp;onepass&nbsp;program</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5374976">check</span>&nbsp;<span class="op" id="5374982">=</span>&nbsp;<span class="keyword" id="5374984">func</span><span class="op" id="5374988">(</span><span class="ident" id="5374989">pc</span>&nbsp;<span class="builtintype" id="5374992">uint32</span><span class="op" id="5374998">,</span>&nbsp;<span class="ident" id="5375000">m</span>&nbsp;<span class="keyword" id="5375002">map</span><span class="op" id="5375005">[</span><span class="builtintype" id="5375006">uint32</span><span class="op" id="5375012">]</span><span class="builtintype" id="5375013">bool</span><span class="op" id="5375017">)</span>&nbsp;<span class="op" id="5375019">(</span><span class="ident" id="5375020">ok</span>&nbsp;<span class="builtintype" id="5375023">bool</span><span class="op" id="5375027">)</span>&nbsp;<span class="op" id="5375029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5375033">ok</span>&nbsp;<span class="op" id="5375036">=</span>&nbsp;<span class="builtintype" id="5375038">true</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5375045">inst</span>&nbsp;<span class="op" id="5375050">:=</span>&nbsp;<span class="op" id="5375053">&amp;</span><span class="ident" id="5375054">p</span><span class="op" id="5375055">.</span><span class="ident" id="5375056">Inst</span><span class="op" id="5375060">[</span><span class="ident" id="5375061">pc</span><span class="op" id="5375063">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5375067">if</span>&nbsp;<span class="ident" id="5375070">visitQueue</span><span class="op" id="5375080">.</span><span class="ident" id="5375081">contains</span><span class="op" id="5375089">(</span><span class="ident" id="5375090">pc</span><span class="op" id="5375092">)</span>&nbsp;<span class="op" id="5375094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5375099">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5375108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5375112">visitQueue</span><span class="op" id="5375122">.</span><span class="ident" id="5375123">insert</span><span class="op" id="5375129">(</span><span class="ident" id="5375130">pc</span><span class="op" id="5375132">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5375136">switch</span>&nbsp;<span class="ident" id="5375143">inst</span><span class="op" id="5375147">.</span><span class="ident" id="5375148">Op</span>&nbsp;<span class="op" id="5375151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5375155">case</span>&nbsp;<span class="ident" id="5375160">syntax</span><span class="op" id="5375166">.</span><span class="ident" id="5375167">InstAlt</span><span class="op" id="5375174">,</span>&nbsp;<span class="ident" id="5375176">syntax</span><span class="op" id="5375182">.</span><span class="ident" id="5375183">InstAltMatch</span><span class="op" id="5375195">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5375200">ok</span>&nbsp;<span class="op" id="5375203">=</span>&nbsp;<span class="ident" id="5375205">check</span><span class="op" id="5375210">(</span><span class="ident" id="5375211">inst</span><span class="op" id="5375215">.</span><span class="ident" id="5375216">Out</span><span class="op" id="5375219">,</span>&nbsp;<span class="ident" id="5375221">m</span><span class="op" id="5375222">)</span>&nbsp;<span class="op" id="5375224">&amp;&amp;</span>&nbsp;<span class="ident" id="5375227">check</span><span class="op" id="5375232">(</span><span class="ident" id="5375233">inst</span><span class="op" id="5375237">.</span><span class="ident" id="5375238">Arg</span><span class="op" id="5375241">,</span>&nbsp;<span class="ident" id="5375243">m</span><span class="op" id="5375244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5375249">//&nbsp;check&nbsp;no-input&nbsp;paths&nbsp;to&nbsp;InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5375289">matchOut</span>&nbsp;<span class="op" id="5375298">:=</span>&nbsp;<span class="ident" id="5375301">m</span><span class="op" id="5375302">[</span><span class="ident" id="5375303">inst</span><span class="op" id="5375307">.</span><span class="ident" id="5375308">Out</span><span class="op" id="5375311">]</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5375316">matchArg</span>&nbsp;<span class="op" id="5375325">:=</span>&nbsp;<span class="ident" id="5375328">m</span><span class="op" id="5375329">[</span><span class="ident" id="5375330">inst</span><span class="op" id="5375334">.</span><span class="ident" id="5375335">Arg</span><span class="op" id="5375338">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5375343">if</span>&nbsp;<span class="ident" id="5375346">matchOut</span>&nbsp;<span class="op" id="5375355">&amp;&amp;</span>&nbsp;<span class="ident" id="5375358">matchArg</span>&nbsp;<span class="op" id="5375367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5375373">ok</span>&nbsp;<span class="op" id="5375376">=</span>&nbsp;<span class="builtintype" id="5375378">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5375388">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5375397">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5375402">//&nbsp;Match&nbsp;on&nbsp;empty&nbsp;goes&nbsp;in&nbsp;inst.Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5375440">if</span>&nbsp;<span class="ident" id="5375443">matchArg</span>&nbsp;<span class="op" id="5375452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5375458">inst</span><span class="op" id="5375462">.</span><span class="ident" id="5375463">Out</span><span class="op" id="5375466">,</span>&nbsp;<span class="ident" id="5375468">inst</span><span class="op" id="5375472">.</span><span class="ident" id="5375473">Arg</span>&nbsp;<span class="op" id="5375477">=</span>&nbsp;<span class="ident" id="5375479">inst</span><span class="op" id="5375483">.</span><span class="ident" id="5375484">Arg</span><span class="op" id="5375487">,</span>&nbsp;<span class="ident" id="5375489">inst</span><span class="op" id="5375493">.</span><span class="ident" id="5375494">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5375502">matchOut</span><span class="op" id="5375510">,</span>&nbsp;<span class="ident" id="5375512">matchArg</span>&nbsp;<span class="op" id="5375521">=</span>&nbsp;<span class="ident" id="5375523">matchArg</span><span class="op" id="5375531">,</span>&nbsp;<span class="ident" id="5375533">matchOut</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5375545">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5375550">if</span>&nbsp;<span class="ident" id="5375553">matchOut</span>&nbsp;<span class="op" id="5375562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5375568">m</span><span class="op" id="5375569">[</span><span class="ident" id="5375570">pc</span><span class="op" id="5375572">]</span>&nbsp;<span class="op" id="5375574">=</span>&nbsp;<span class="builtintype" id="5375576">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5375585">inst</span><span class="op" id="5375589">.</span><span class="ident" id="5375590">Op</span>&nbsp;<span class="op" id="5375593">=</span>&nbsp;<span class="ident" id="5375595">syntax</span><span class="op" id="5375601">.</span><span class="ident" id="5375602">InstAltMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5375618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5375624">//&nbsp;build&nbsp;a&nbsp;dispatch&nbsp;operator&nbsp;from&nbsp;the&nbsp;two&nbsp;legs&nbsp;of&nbsp;the&nbsp;alt.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5375686">onePassRunes</span><span class="op" id="5375698">[</span><span class="ident" id="5375699">pc</span><span class="op" id="5375701">]</span><span class="op" id="5375702">,</span>&nbsp;<span class="ident" id="5375704">inst</span><span class="op" id="5375708">.</span><span class="ident" id="5375709">Next</span>&nbsp;<span class="op" id="5375714">=</span>&nbsp;<span class="ident" id="5375716">mergeRuneSets</span><span class="op" id="5375729">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5375735">&amp;</span><span class="ident" id="5375736">onePassRunes</span><span class="op" id="5375748">[</span><span class="ident" id="5375749">inst</span><span class="op" id="5375753">.</span><span class="ident" id="5375754">Out</span><span class="op" id="5375757">]</span><span class="op" id="5375758">,</span>&nbsp;<span class="op" id="5375760">&amp;</span><span class="ident" id="5375761">onePassRunes</span><span class="op" id="5375773">[</span><span class="ident" id="5375774">inst</span><span class="op" id="5375778">.</span><span class="ident" id="5375779">Arg</span><span class="op" id="5375782">]</span><span class="op" id="5375783">,</span>&nbsp;<span class="ident" id="5375785">inst</span><span class="op" id="5375789">.</span><span class="ident" id="5375790">Out</span><span class="op" id="5375793">,</span>&nbsp;<span class="ident" id="5375795">inst</span><span class="op" id="5375799">.</span><span class="ident" id="5375800">Arg</span><span class="op" id="5375803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5375808">if</span>&nbsp;<span class="builtinfunc" id="5375811">len</span><span class="op" id="5375814">(</span><span class="ident" id="5375815">inst</span><span class="op" id="5375819">.</span><span class="ident" id="5375820">Next</span><span class="op" id="5375824">)</span>&nbsp;<span class="op" id="5375826">&gt;</span>&nbsp;<span class="num" id="5375828">0</span>&nbsp;<span class="op" id="5375830">&amp;&amp;</span>&nbsp;<span class="ident" id="5375833">inst</span><span class="op" id="5375837">.</span><span class="ident" id="5375838">Next</span><span class="op" id="5375842">[</span><span class="num" id="5375843">0</span><span class="op" id="5375844">]</span>&nbsp;<span class="op" id="5375846">==</span>&nbsp;<span class="ident" id="5375849">mergeFailed</span>&nbsp;<span class="op" id="5375861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5375867">ok</span>&nbsp;<span class="op" id="5375870">=</span>&nbsp;<span class="builtintype" id="5375872">false</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5375882">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5375891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5375895">case</span>&nbsp;<span class="ident" id="5375900">syntax</span><span class="op" id="5375906">.</span><span class="ident" id="5375907">InstCapture</span><span class="op" id="5375918">,</span>&nbsp;<span class="ident" id="5375920">syntax</span><span class="op" id="5375926">.</span><span class="ident" id="5375927">InstNop</span><span class="op" id="5375934">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5375939">ok</span>&nbsp;<span class="op" id="5375942">=</span>&nbsp;<span class="ident" id="5375944">check</span><span class="op" id="5375949">(</span><span class="ident" id="5375950">inst</span><span class="op" id="5375954">.</span><span class="ident" id="5375955">Out</span><span class="op" id="5375958">,</span>&nbsp;<span class="ident" id="5375960">m</span><span class="op" id="5375961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5375966">m</span><span class="op" id="5375967">[</span><span class="ident" id="5375968">pc</span><span class="op" id="5375970">]</span>&nbsp;<span class="op" id="5375972">=</span>&nbsp;<span class="ident" id="5375974">m</span><span class="op" id="5375975">[</span><span class="ident" id="5375976">inst</span><span class="op" id="5375980">.</span><span class="ident" id="5375981">Out</span><span class="op" id="5375984">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5375989">//&nbsp;pass&nbsp;matching&nbsp;runes&nbsp;back&nbsp;through&nbsp;these&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376042">onePassRunes</span><span class="op" id="5376054">[</span><span class="ident" id="5376055">pc</span><span class="op" id="5376057">]</span>&nbsp;<span class="op" id="5376059">=</span>&nbsp;<span class="builtinfunc" id="5376061">append</span><span class="op" id="5376067">(</span><span class="op" id="5376068">[</span><span class="op" id="5376069">]</span><span class="builtintype" id="5376070">rune</span><span class="op" id="5376074">{</span><span class="op" id="5376075">}</span><span class="op" id="5376076">,</span>&nbsp;<span class="ident" id="5376078">onePassRunes</span><span class="op" id="5376090">[</span><span class="ident" id="5376091">inst</span><span class="op" id="5376095">.</span><span class="ident" id="5376096">Out</span><span class="op" id="5376099">]</span><span class="op" id="5376100">...</span><span class="op" id="5376103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376108">inst</span><span class="op" id="5376112">.</span><span class="ident" id="5376113">Next</span>&nbsp;<span class="op" id="5376118">=</span>&nbsp;<span class="op" id="5376120">[</span><span class="op" id="5376121">]</span><span class="builtintype" id="5376122">uint32</span><span class="op" id="5376128">{</span><span class="op" id="5376129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5376134">for</span>&nbsp;<span class="ident" id="5376138">i</span>&nbsp;<span class="op" id="5376140">:=</span>&nbsp;<span class="builtinfunc" id="5376143">len</span><span class="op" id="5376146">(</span><span class="ident" id="5376147">onePassRunes</span><span class="op" id="5376159">[</span><span class="ident" id="5376160">pc</span><span class="op" id="5376162">]</span><span class="op" id="5376163">)</span>&nbsp;<span class="op" id="5376165">/</span>&nbsp;<span class="num" id="5376167">2</span><span class="op" id="5376168">;</span>&nbsp;<span class="ident" id="5376170">i</span>&nbsp;<span class="op" id="5376172">&gt;=</span>&nbsp;<span class="num" id="5376175">0</span><span class="op" id="5376176">;</span>&nbsp;<span class="ident" id="5376178">i</span><span class="op" id="5376179">--</span>&nbsp;<span class="op" id="5376182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376188">inst</span><span class="op" id="5376192">.</span><span class="ident" id="5376193">Next</span>&nbsp;<span class="op" id="5376198">=</span>&nbsp;<span class="builtinfunc" id="5376200">append</span><span class="op" id="5376206">(</span><span class="ident" id="5376207">inst</span><span class="op" id="5376211">.</span><span class="ident" id="5376212">Next</span><span class="op" id="5376216">,</span>&nbsp;<span class="ident" id="5376218">inst</span><span class="op" id="5376222">.</span><span class="ident" id="5376223">Out</span><span class="op" id="5376226">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5376231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5376235">case</span>&nbsp;<span class="ident" id="5376240">syntax</span><span class="op" id="5376246">.</span><span class="ident" id="5376247">InstEmptyWidth</span><span class="op" id="5376261">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376266">ok</span>&nbsp;<span class="op" id="5376269">=</span>&nbsp;<span class="ident" id="5376271">check</span><span class="op" id="5376276">(</span><span class="ident" id="5376277">inst</span><span class="op" id="5376281">.</span><span class="ident" id="5376282">Out</span><span class="op" id="5376285">,</span>&nbsp;<span class="ident" id="5376287">m</span><span class="op" id="5376288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376293">m</span><span class="op" id="5376294">[</span><span class="ident" id="5376295">pc</span><span class="op" id="5376297">]</span>&nbsp;<span class="op" id="5376299">=</span>&nbsp;<span class="ident" id="5376301">m</span><span class="op" id="5376302">[</span><span class="ident" id="5376303">inst</span><span class="op" id="5376307">.</span><span class="ident" id="5376308">Out</span><span class="op" id="5376311">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376316">onePassRunes</span><span class="op" id="5376328">[</span><span class="ident" id="5376329">pc</span><span class="op" id="5376331">]</span>&nbsp;<span class="op" id="5376333">=</span>&nbsp;<span class="builtinfunc" id="5376335">append</span><span class="op" id="5376341">(</span><span class="op" id="5376342">[</span><span class="op" id="5376343">]</span><span class="builtintype" id="5376344">rune</span><span class="op" id="5376348">{</span><span class="op" id="5376349">}</span><span class="op" id="5376350">,</span>&nbsp;<span class="ident" id="5376352">onePassRunes</span><span class="op" id="5376364">[</span><span class="ident" id="5376365">inst</span><span class="op" id="5376369">.</span><span class="ident" id="5376370">Out</span><span class="op" id="5376373">]</span><span class="op" id="5376374">...</span><span class="op" id="5376377">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376382">inst</span><span class="op" id="5376386">.</span><span class="ident" id="5376387">Next</span>&nbsp;<span class="op" id="5376392">=</span>&nbsp;<span class="op" id="5376394">[</span><span class="op" id="5376395">]</span><span class="builtintype" id="5376396">uint32</span><span class="op" id="5376402">{</span><span class="op" id="5376403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5376408">for</span>&nbsp;<span class="ident" id="5376412">i</span>&nbsp;<span class="op" id="5376414">:=</span>&nbsp;<span class="builtinfunc" id="5376417">len</span><span class="op" id="5376420">(</span><span class="ident" id="5376421">onePassRunes</span><span class="op" id="5376433">[</span><span class="ident" id="5376434">pc</span><span class="op" id="5376436">]</span><span class="op" id="5376437">)</span>&nbsp;<span class="op" id="5376439">/</span>&nbsp;<span class="num" id="5376441">2</span><span class="op" id="5376442">;</span>&nbsp;<span class="ident" id="5376444">i</span>&nbsp;<span class="op" id="5376446">&gt;=</span>&nbsp;<span class="num" id="5376449">0</span><span class="op" id="5376450">;</span>&nbsp;<span class="ident" id="5376452">i</span><span class="op" id="5376453">--</span>&nbsp;<span class="op" id="5376456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376462">inst</span><span class="op" id="5376466">.</span><span class="ident" id="5376467">Next</span>&nbsp;<span class="op" id="5376472">=</span>&nbsp;<span class="builtinfunc" id="5376474">append</span><span class="op" id="5376480">(</span><span class="ident" id="5376481">inst</span><span class="op" id="5376485">.</span><span class="ident" id="5376486">Next</span><span class="op" id="5376490">,</span>&nbsp;<span class="ident" id="5376492">inst</span><span class="op" id="5376496">.</span><span class="ident" id="5376497">Out</span><span class="op" id="5376500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5376505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5376509">case</span>&nbsp;<span class="ident" id="5376514">syntax</span><span class="op" id="5376520">.</span><span class="ident" id="5376521">InstMatch</span><span class="op" id="5376530">,</span>&nbsp;<span class="ident" id="5376532">syntax</span><span class="op" id="5376538">.</span><span class="ident" id="5376539">InstFail</span><span class="op" id="5376547">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376552">m</span><span class="op" id="5376553">[</span><span class="ident" id="5376554">pc</span><span class="op" id="5376556">]</span>&nbsp;<span class="op" id="5376558">=</span>&nbsp;<span class="ident" id="5376560">inst</span><span class="op" id="5376564">.</span><span class="ident" id="5376565">Op</span>&nbsp;<span class="op" id="5376568">==</span>&nbsp;<span class="ident" id="5376571">syntax</span><span class="op" id="5376577">.</span><span class="ident" id="5376578">InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5376591">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5376599">case</span>&nbsp;<span class="ident" id="5376604">syntax</span><span class="op" id="5376610">.</span><span class="ident" id="5376611">InstRune</span><span class="op" id="5376619">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376624">ok</span>&nbsp;<span class="op" id="5376627">=</span>&nbsp;<span class="ident" id="5376629">check</span><span class="op" id="5376634">(</span><span class="ident" id="5376635">inst</span><span class="op" id="5376639">.</span><span class="ident" id="5376640">Out</span><span class="op" id="5376643">,</span>&nbsp;<span class="ident" id="5376645">m</span><span class="op" id="5376646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376651">m</span><span class="op" id="5376652">[</span><span class="ident" id="5376653">pc</span><span class="op" id="5376655">]</span>&nbsp;<span class="op" id="5376657">=</span>&nbsp;<span class="builtintype" id="5376659">false</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5376668">if</span>&nbsp;<span class="builtinfunc" id="5376671">len</span><span class="op" id="5376674">(</span><span class="ident" id="5376675">inst</span><span class="op" id="5376679">.</span><span class="ident" id="5376680">Next</span><span class="op" id="5376684">)</span>&nbsp;<span class="op" id="5376686">&gt;</span>&nbsp;<span class="num" id="5376688">0</span>&nbsp;<span class="op" id="5376690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5376696">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5376705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5376710">if</span>&nbsp;<span class="builtinfunc" id="5376713">len</span><span class="op" id="5376716">(</span><span class="ident" id="5376717">inst</span><span class="op" id="5376721">.</span><span class="ident" id="5376722">Rune</span><span class="op" id="5376726">)</span>&nbsp;<span class="op" id="5376728">==</span>&nbsp;<span class="num" id="5376731">0</span>&nbsp;<span class="op" id="5376733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376739">onePassRunes</span><span class="op" id="5376751">[</span><span class="ident" id="5376752">pc</span><span class="op" id="5376754">]</span>&nbsp;<span class="op" id="5376756">=</span>&nbsp;<span class="op" id="5376758">[</span><span class="op" id="5376759">]</span><span class="builtintype" id="5376760">rune</span><span class="op" id="5376764">{</span><span class="op" id="5376765">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376771">inst</span><span class="op" id="5376775">.</span><span class="ident" id="5376776">Next</span>&nbsp;<span class="op" id="5376781">=</span>&nbsp;<span class="op" id="5376783">[</span><span class="op" id="5376784">]</span><span class="builtintype" id="5376785">uint32</span><span class="op" id="5376791">{</span><span class="ident" id="5376792">inst</span><span class="op" id="5376796">.</span><span class="ident" id="5376797">Out</span><span class="op" id="5376800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5376806">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5376815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376820">runes</span>&nbsp;<span class="op" id="5376826">:=</span>&nbsp;<span class="builtinfunc" id="5376829">make</span><span class="op" id="5376833">(</span><span class="op" id="5376834">[</span><span class="op" id="5376835">]</span><span class="builtintype" id="5376836">rune</span><span class="op" id="5376840">,</span>&nbsp;<span class="num" id="5376842">0</span><span class="op" id="5376843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5376848">if</span>&nbsp;<span class="builtinfunc" id="5376851">len</span><span class="op" id="5376854">(</span><span class="ident" id="5376855">inst</span><span class="op" id="5376859">.</span><span class="ident" id="5376860">Rune</span><span class="op" id="5376864">)</span>&nbsp;<span class="op" id="5376866">==</span>&nbsp;<span class="num" id="5376869">1</span>&nbsp;<span class="op" id="5376871">&amp;&amp;</span>&nbsp;<span class="ident" id="5376874">syntax</span><span class="op" id="5376880">.</span><span class="ident" id="5376881">Flags</span><span class="op" id="5376886">(</span><span class="ident" id="5376887">inst</span><span class="op" id="5376891">.</span><span class="ident" id="5376892">Arg</span><span class="op" id="5376895">)</span><span class="op" id="5376896">&amp;</span><span class="ident" id="5376897">syntax</span><span class="op" id="5376903">.</span><span class="ident" id="5376904">FoldCase</span>&nbsp;<span class="op" id="5376913">!=</span>&nbsp;<span class="num" id="5376916">0</span>&nbsp;<span class="op" id="5376918">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376924">r0</span>&nbsp;<span class="op" id="5376927">:=</span>&nbsp;<span class="ident" id="5376930">inst</span><span class="op" id="5376934">.</span><span class="ident" id="5376935">Rune</span><span class="op" id="5376939">[</span><span class="num" id="5376940">0</span><span class="op" id="5376941">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376947">runes</span>&nbsp;<span class="op" id="5376953">=</span>&nbsp;<span class="builtinfunc" id="5376955">append</span><span class="op" id="5376961">(</span><span class="ident" id="5376962">runes</span><span class="op" id="5376967">,</span>&nbsp;<span class="ident" id="5376969">r0</span><span class="op" id="5376971">,</span>&nbsp;<span class="ident" id="5376973">r0</span><span class="op" id="5376975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5376981">for</span>&nbsp;<span class="ident" id="5376985">r1</span>&nbsp;<span class="op" id="5376988">:=</span>&nbsp;<span class="ident" id="5376991">unicode</span><span class="op" id="5376998">.</span><span class="ident" id="5376999">SimpleFold</span><span class="op" id="5377009">(</span><span class="ident" id="5377010">r0</span><span class="op" id="5377012">)</span><span class="op" id="5377013">;</span>&nbsp;<span class="ident" id="5377015">r1</span>&nbsp;<span class="op" id="5377018">!=</span>&nbsp;<span class="ident" id="5377021">r0</span><span class="op" id="5377023">;</span>&nbsp;<span class="ident" id="5377025">r1</span>&nbsp;<span class="op" id="5377028">=</span>&nbsp;<span class="ident" id="5377030">unicode</span><span class="op" id="5377037">.</span><span class="ident" id="5377038">SimpleFold</span><span class="op" id="5377048">(</span><span class="ident" id="5377049">r1</span><span class="op" id="5377051">)</span>&nbsp;<span class="op" id="5377053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377060">runes</span>&nbsp;<span class="op" id="5377066">=</span>&nbsp;<span class="builtinfunc" id="5377068">append</span><span class="op" id="5377074">(</span><span class="ident" id="5377075">runes</span><span class="op" id="5377080">,</span>&nbsp;<span class="ident" id="5377082">r1</span><span class="op" id="5377084">,</span>&nbsp;<span class="ident" id="5377086">r1</span><span class="op" id="5377088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5377094">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377100">sort</span><span class="op" id="5377104">.</span><span class="ident" id="5377105">Sort</span><span class="op" id="5377109">(</span><span class="ident" id="5377110">runeSlice</span><span class="op" id="5377119">(</span><span class="ident" id="5377120">runes</span><span class="op" id="5377125">)</span><span class="op" id="5377126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5377131">}</span>&nbsp;<span class="keyword" id="5377133">else</span>&nbsp;<span class="op" id="5377138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377144">runes</span>&nbsp;<span class="op" id="5377150">=</span>&nbsp;<span class="builtinfunc" id="5377152">append</span><span class="op" id="5377158">(</span><span class="ident" id="5377159">runes</span><span class="op" id="5377164">,</span>&nbsp;<span class="ident" id="5377166">inst</span><span class="op" id="5377170">.</span><span class="ident" id="5377171">Rune</span><span class="op" id="5377175">...</span><span class="op" id="5377178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5377183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377188">onePassRunes</span><span class="op" id="5377200">[</span><span class="ident" id="5377201">pc</span><span class="op" id="5377203">]</span>&nbsp;<span class="op" id="5377205">=</span>&nbsp;<span class="ident" id="5377207">runes</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377216">inst</span><span class="op" id="5377220">.</span><span class="ident" id="5377221">Next</span>&nbsp;<span class="op" id="5377226">=</span>&nbsp;<span class="op" id="5377228">[</span><span class="op" id="5377229">]</span><span class="builtintype" id="5377230">uint32</span><span class="op" id="5377236">{</span><span class="op" id="5377237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5377242">for</span>&nbsp;<span class="ident" id="5377246">i</span>&nbsp;<span class="op" id="5377248">:=</span>&nbsp;<span class="builtinfunc" id="5377251">len</span><span class="op" id="5377254">(</span><span class="ident" id="5377255">onePassRunes</span><span class="op" id="5377267">[</span><span class="ident" id="5377268">pc</span><span class="op" id="5377270">]</span><span class="op" id="5377271">)</span>&nbsp;<span class="op" id="5377273">/</span>&nbsp;<span class="num" id="5377275">2</span><span class="op" id="5377276">;</span>&nbsp;<span class="ident" id="5377278">i</span>&nbsp;<span class="op" id="5377280">&gt;=</span>&nbsp;<span class="num" id="5377283">0</span><span class="op" id="5377284">;</span>&nbsp;<span class="ident" id="5377286">i</span><span class="op" id="5377287">--</span>&nbsp;<span class="op" id="5377290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377296">inst</span><span class="op" id="5377300">.</span><span class="ident" id="5377301">Next</span>&nbsp;<span class="op" id="5377306">=</span>&nbsp;<span class="builtinfunc" id="5377308">append</span><span class="op" id="5377314">(</span><span class="ident" id="5377315">inst</span><span class="op" id="5377319">.</span><span class="ident" id="5377320">Next</span><span class="op" id="5377324">,</span>&nbsp;<span class="ident" id="5377326">inst</span><span class="op" id="5377330">.</span><span class="ident" id="5377331">Out</span><span class="op" id="5377334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5377339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377344">inst</span><span class="op" id="5377348">.</span><span class="ident" id="5377349">Op</span>&nbsp;<span class="op" id="5377352">=</span>&nbsp;<span class="ident" id="5377354">syntax</span><span class="op" id="5377360">.</span><span class="ident" id="5377361">InstRune</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5377372">case</span>&nbsp;<span class="ident" id="5377377">syntax</span><span class="op" id="5377383">.</span><span class="ident" id="5377384">InstRune1</span><span class="op" id="5377393">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377398">ok</span>&nbsp;<span class="op" id="5377401">=</span>&nbsp;<span class="ident" id="5377403">check</span><span class="op" id="5377408">(</span><span class="ident" id="5377409">inst</span><span class="op" id="5377413">.</span><span class="ident" id="5377414">Out</span><span class="op" id="5377417">,</span>&nbsp;<span class="ident" id="5377419">m</span><span class="op" id="5377420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377425">m</span><span class="op" id="5377426">[</span><span class="ident" id="5377427">pc</span><span class="op" id="5377429">]</span>&nbsp;<span class="op" id="5377431">=</span>&nbsp;<span class="builtintype" id="5377433">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5377442">if</span>&nbsp;<span class="builtinfunc" id="5377445">len</span><span class="op" id="5377448">(</span><span class="ident" id="5377449">inst</span><span class="op" id="5377453">.</span><span class="ident" id="5377454">Next</span><span class="op" id="5377458">)</span>&nbsp;<span class="op" id="5377460">&gt;</span>&nbsp;<span class="num" id="5377462">0</span>&nbsp;<span class="op" id="5377464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5377470">break</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5377479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377484">runes</span>&nbsp;<span class="op" id="5377490">:=</span>&nbsp;<span class="op" id="5377493">[</span><span class="op" id="5377494">]</span><span class="builtintype" id="5377495">rune</span><span class="op" id="5377499">{</span><span class="op" id="5377500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5377505">//&nbsp;expand&nbsp;case-folded&nbsp;runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5377536">if</span>&nbsp;<span class="ident" id="5377539">syntax</span><span class="op" id="5377545">.</span><span class="ident" id="5377546">Flags</span><span class="op" id="5377551">(</span><span class="ident" id="5377552">inst</span><span class="op" id="5377556">.</span><span class="ident" id="5377557">Arg</span><span class="op" id="5377560">)</span><span class="op" id="5377561">&amp;</span><span class="ident" id="5377562">syntax</span><span class="op" id="5377568">.</span><span class="ident" id="5377569">FoldCase</span>&nbsp;<span class="op" id="5377578">!=</span>&nbsp;<span class="num" id="5377581">0</span>&nbsp;<span class="op" id="5377583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377589">r0</span>&nbsp;<span class="op" id="5377592">:=</span>&nbsp;<span class="ident" id="5377595">inst</span><span class="op" id="5377599">.</span><span class="ident" id="5377600">Rune</span><span class="op" id="5377604">[</span><span class="num" id="5377605">0</span><span class="op" id="5377606">]</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377612">runes</span>&nbsp;<span class="op" id="5377618">=</span>&nbsp;<span class="builtinfunc" id="5377620">append</span><span class="op" id="5377626">(</span><span class="ident" id="5377627">runes</span><span class="op" id="5377632">,</span>&nbsp;<span class="ident" id="5377634">r0</span><span class="op" id="5377636">,</span>&nbsp;<span class="ident" id="5377638">r0</span><span class="op" id="5377640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5377646">for</span>&nbsp;<span class="ident" id="5377650">r1</span>&nbsp;<span class="op" id="5377653">:=</span>&nbsp;<span class="ident" id="5377656">unicode</span><span class="op" id="5377663">.</span><span class="ident" id="5377664">SimpleFold</span><span class="op" id="5377674">(</span><span class="ident" id="5377675">r0</span><span class="op" id="5377677">)</span><span class="op" id="5377678">;</span>&nbsp;<span class="ident" id="5377680">r1</span>&nbsp;<span class="op" id="5377683">!=</span>&nbsp;<span class="ident" id="5377686">r0</span><span class="op" id="5377688">;</span>&nbsp;<span class="ident" id="5377690">r1</span>&nbsp;<span class="op" id="5377693">=</span>&nbsp;<span class="ident" id="5377695">unicode</span><span class="op" id="5377702">.</span><span class="ident" id="5377703">SimpleFold</span><span class="op" id="5377713">(</span><span class="ident" id="5377714">r1</span><span class="op" id="5377716">)</span>&nbsp;<span class="op" id="5377718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377725">runes</span>&nbsp;<span class="op" id="5377731">=</span>&nbsp;<span class="builtinfunc" id="5377733">append</span><span class="op" id="5377739">(</span><span class="ident" id="5377740">runes</span><span class="op" id="5377745">,</span>&nbsp;<span class="ident" id="5377747">r1</span><span class="op" id="5377749">,</span>&nbsp;<span class="ident" id="5377751">r1</span><span class="op" id="5377753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5377759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377765">sort</span><span class="op" id="5377769">.</span><span class="ident" id="5377770">Sort</span><span class="op" id="5377774">(</span><span class="ident" id="5377775">runeSlice</span><span class="op" id="5377784">(</span><span class="ident" id="5377785">runes</span><span class="op" id="5377790">)</span><span class="op" id="5377791">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5377796">}</span>&nbsp;<span class="keyword" id="5377798">else</span>&nbsp;<span class="op" id="5377803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377809">runes</span>&nbsp;<span class="op" id="5377815">=</span>&nbsp;<span class="builtinfunc" id="5377817">append</span><span class="op" id="5377823">(</span><span class="ident" id="5377824">runes</span><span class="op" id="5377829">,</span>&nbsp;<span class="ident" id="5377831">inst</span><span class="op" id="5377835">.</span><span class="ident" id="5377836">Rune</span><span class="op" id="5377840">[</span><span class="num" id="5377841">0</span><span class="op" id="5377842">]</span><span class="op" id="5377843">,</span>&nbsp;<span class="ident" id="5377845">inst</span><span class="op" id="5377849">.</span><span class="ident" id="5377850">Rune</span><span class="op" id="5377854">[</span><span class="num" id="5377855">0</span><span class="op" id="5377856">]</span><span class="op" id="5377857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5377862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377867">onePassRunes</span><span class="op" id="5377879">[</span><span class="ident" id="5377880">pc</span><span class="op" id="5377882">]</span>&nbsp;<span class="op" id="5377884">=</span>&nbsp;<span class="ident" id="5377886">runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377895">inst</span><span class="op" id="5377899">.</span><span class="ident" id="5377900">Next</span>&nbsp;<span class="op" id="5377905">=</span>&nbsp;<span class="op" id="5377907">[</span><span class="op" id="5377908">]</span><span class="builtintype" id="5377909">uint32</span><span class="op" id="5377915">{</span><span class="op" id="5377916">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5377921">for</span>&nbsp;<span class="ident" id="5377925">i</span>&nbsp;<span class="op" id="5377927">:=</span>&nbsp;<span class="builtinfunc" id="5377930">len</span><span class="op" id="5377933">(</span><span class="ident" id="5377934">onePassRunes</span><span class="op" id="5377946">[</span><span class="ident" id="5377947">pc</span><span class="op" id="5377949">]</span><span class="op" id="5377950">)</span>&nbsp;<span class="op" id="5377952">/</span>&nbsp;<span class="num" id="5377954">2</span><span class="op" id="5377955">;</span>&nbsp;<span class="ident" id="5377957">i</span>&nbsp;<span class="op" id="5377959">&gt;=</span>&nbsp;<span class="num" id="5377962">0</span><span class="op" id="5377963">;</span>&nbsp;<span class="ident" id="5377965">i</span><span class="op" id="5377966">--</span>&nbsp;<span class="op" id="5377969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5377975">inst</span><span class="op" id="5377979">.</span><span class="ident" id="5377980">Next</span>&nbsp;<span class="op" id="5377985">=</span>&nbsp;<span class="builtinfunc" id="5377987">append</span><span class="op" id="5377993">(</span><span class="ident" id="5377994">inst</span><span class="op" id="5377998">.</span><span class="ident" id="5377999">Next</span><span class="op" id="5378003">,</span>&nbsp;<span class="ident" id="5378005">inst</span><span class="op" id="5378009">.</span><span class="ident" id="5378010">Out</span><span class="op" id="5378013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5378018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378023">inst</span><span class="op" id="5378027">.</span><span class="ident" id="5378028">Op</span>&nbsp;<span class="op" id="5378031">=</span>&nbsp;<span class="ident" id="5378033">syntax</span><span class="op" id="5378039">.</span><span class="ident" id="5378040">InstRune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5378051">case</span>&nbsp;<span class="ident" id="5378056">syntax</span><span class="op" id="5378062">.</span><span class="ident" id="5378063">InstRuneAny</span><span class="op" id="5378074">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378079">ok</span>&nbsp;<span class="op" id="5378082">=</span>&nbsp;<span class="ident" id="5378084">check</span><span class="op" id="5378089">(</span><span class="ident" id="5378090">inst</span><span class="op" id="5378094">.</span><span class="ident" id="5378095">Out</span><span class="op" id="5378098">,</span>&nbsp;<span class="ident" id="5378100">m</span><span class="op" id="5378101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378106">m</span><span class="op" id="5378107">[</span><span class="ident" id="5378108">pc</span><span class="op" id="5378110">]</span>&nbsp;<span class="op" id="5378112">=</span>&nbsp;<span class="builtintype" id="5378114">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5378123">if</span>&nbsp;<span class="builtinfunc" id="5378126">len</span><span class="op" id="5378129">(</span><span class="ident" id="5378130">inst</span><span class="op" id="5378134">.</span><span class="ident" id="5378135">Next</span><span class="op" id="5378139">)</span>&nbsp;<span class="op" id="5378141">&gt;</span>&nbsp;<span class="num" id="5378143">0</span>&nbsp;<span class="op" id="5378145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5378151">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5378160">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378165">onePassRunes</span><span class="op" id="5378177">[</span><span class="ident" id="5378178">pc</span><span class="op" id="5378180">]</span>&nbsp;<span class="op" id="5378182">=</span>&nbsp;<span class="builtinfunc" id="5378184">append</span><span class="op" id="5378190">(</span><span class="op" id="5378191">[</span><span class="op" id="5378192">]</span><span class="builtintype" id="5378193">rune</span><span class="op" id="5378197">{</span><span class="op" id="5378198">}</span><span class="op" id="5378199">,</span>&nbsp;<span class="ident" id="5378201">anyRune</span><span class="op" id="5378208">...</span><span class="op" id="5378211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378216">inst</span><span class="op" id="5378220">.</span><span class="ident" id="5378221">Next</span>&nbsp;<span class="op" id="5378226">=</span>&nbsp;<span class="op" id="5378228">[</span><span class="op" id="5378229">]</span><span class="builtintype" id="5378230">uint32</span><span class="op" id="5378236">{</span><span class="ident" id="5378237">inst</span><span class="op" id="5378241">.</span><span class="ident" id="5378242">Out</span><span class="op" id="5378245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5378249">case</span>&nbsp;<span class="ident" id="5378254">syntax</span><span class="op" id="5378260">.</span><span class="ident" id="5378261">InstRuneAnyNotNL</span><span class="op" id="5378277">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378282">ok</span>&nbsp;<span class="op" id="5378285">=</span>&nbsp;<span class="ident" id="5378287">check</span><span class="op" id="5378292">(</span><span class="ident" id="5378293">inst</span><span class="op" id="5378297">.</span><span class="ident" id="5378298">Out</span><span class="op" id="5378301">,</span>&nbsp;<span class="ident" id="5378303">m</span><span class="op" id="5378304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378309">m</span><span class="op" id="5378310">[</span><span class="ident" id="5378311">pc</span><span class="op" id="5378313">]</span>&nbsp;<span class="op" id="5378315">=</span>&nbsp;<span class="builtintype" id="5378317">false</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5378326">if</span>&nbsp;<span class="builtinfunc" id="5378329">len</span><span class="op" id="5378332">(</span><span class="ident" id="5378333">inst</span><span class="op" id="5378337">.</span><span class="ident" id="5378338">Next</span><span class="op" id="5378342">)</span>&nbsp;<span class="op" id="5378344">&gt;</span>&nbsp;<span class="num" id="5378346">0</span>&nbsp;<span class="op" id="5378348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5378354">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5378363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378368">onePassRunes</span><span class="op" id="5378380">[</span><span class="ident" id="5378381">pc</span><span class="op" id="5378383">]</span>&nbsp;<span class="op" id="5378385">=</span>&nbsp;<span class="builtinfunc" id="5378387">append</span><span class="op" id="5378393">(</span><span class="op" id="5378394">[</span><span class="op" id="5378395">]</span><span class="builtintype" id="5378396">rune</span><span class="op" id="5378400">{</span><span class="op" id="5378401">}</span><span class="op" id="5378402">,</span>&nbsp;<span class="ident" id="5378404">anyRuneNotNL</span><span class="op" id="5378416">...</span><span class="op" id="5378419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378424">inst</span><span class="op" id="5378428">.</span><span class="ident" id="5378429">Next</span>&nbsp;<span class="op" id="5378434">=</span>&nbsp;<span class="op" id="5378436">[</span><span class="op" id="5378437">]</span><span class="builtintype" id="5378438">uint32</span><span class="op" id="5378444">{</span><span class="op" id="5378445">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5378450">for</span>&nbsp;<span class="ident" id="5378454">i</span>&nbsp;<span class="op" id="5378456">:=</span>&nbsp;<span class="builtinfunc" id="5378459">len</span><span class="op" id="5378462">(</span><span class="ident" id="5378463">onePassRunes</span><span class="op" id="5378475">[</span><span class="ident" id="5378476">pc</span><span class="op" id="5378478">]</span><span class="op" id="5378479">)</span>&nbsp;<span class="op" id="5378481">/</span>&nbsp;<span class="num" id="5378483">2</span><span class="op" id="5378484">;</span>&nbsp;<span class="ident" id="5378486">i</span>&nbsp;<span class="op" id="5378488">&gt;=</span>&nbsp;<span class="num" id="5378491">0</span><span class="op" id="5378492">;</span>&nbsp;<span class="ident" id="5378494">i</span><span class="op" id="5378495">--</span>&nbsp;<span class="op" id="5378498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378504">inst</span><span class="op" id="5378508">.</span><span class="ident" id="5378509">Next</span>&nbsp;<span class="op" id="5378514">=</span>&nbsp;<span class="builtinfunc" id="5378516">append</span><span class="op" id="5378522">(</span><span class="ident" id="5378523">inst</span><span class="op" id="5378527">.</span><span class="ident" id="5378528">Next</span><span class="op" id="5378532">,</span>&nbsp;<span class="ident" id="5378534">inst</span><span class="op" id="5378538">.</span><span class="ident" id="5378539">Out</span><span class="op" id="5378542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5378547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5378551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5378555">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5378563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378567">instQueue</span><span class="op" id="5378576">.</span><span class="ident" id="5378577">clear</span><span class="op" id="5378582">(</span><span class="op" id="5378583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378586">instQueue</span><span class="op" id="5378595">.</span><span class="ident" id="5378596">insert</span><span class="op" id="5378602">(</span><span class="builtintype" id="5378603">uint32</span><span class="op" id="5378609">(</span><span class="ident" id="5378610">p</span><span class="op" id="5378611">.</span><span class="ident" id="5378612">Start</span><span class="op" id="5378617">)</span><span class="op" id="5378618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378621">m</span>&nbsp;<span class="op" id="5378623">:=</span>&nbsp;<span class="builtinfunc" id="5378626">make</span><span class="op" id="5378630">(</span><span class="keyword" id="5378631">map</span><span class="op" id="5378634">[</span><span class="builtintype" id="5378635">uint32</span><span class="op" id="5378641">]</span><span class="builtintype" id="5378642">bool</span><span class="op" id="5378646">,</span>&nbsp;<span class="builtinfunc" id="5378648">len</span><span class="op" id="5378651">(</span><span class="ident" id="5378652">p</span><span class="op" id="5378653">.</span><span class="ident" id="5378654">Inst</span><span class="op" id="5378658">)</span><span class="op" id="5378659">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5378662">for</span>&nbsp;<span class="op" id="5378666">!</span><span class="ident" id="5378667">instQueue</span><span class="op" id="5378676">.</span><span class="ident" id="5378677">empty</span><span class="op" id="5378682">(</span><span class="op" id="5378683">)</span>&nbsp;<span class="op" id="5378685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378689">pc</span>&nbsp;<span class="op" id="5378692">:=</span>&nbsp;<span class="ident" id="5378695">instQueue</span><span class="op" id="5378704">.</span><span class="ident" id="5378705">next</span><span class="op" id="5378709">(</span><span class="op" id="5378710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378714">inst</span>&nbsp;<span class="op" id="5378719">:=</span>&nbsp;<span class="ident" id="5378722">p</span><span class="op" id="5378723">.</span><span class="ident" id="5378724">Inst</span><span class="op" id="5378728">[</span><span class="ident" id="5378729">pc</span><span class="op" id="5378731">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378735">visitQueue</span><span class="op" id="5378745">.</span><span class="ident" id="5378746">clear</span><span class="op" id="5378751">(</span><span class="op" id="5378752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5378756">if</span>&nbsp;<span class="op" id="5378759">!</span><span class="ident" id="5378760">check</span><span class="op" id="5378765">(</span><span class="builtintype" id="5378766">uint32</span><span class="op" id="5378772">(</span><span class="ident" id="5378773">pc</span><span class="op" id="5378775">)</span><span class="op" id="5378776">,</span>&nbsp;<span class="ident" id="5378778">m</span><span class="op" id="5378779">)</span>&nbsp;<span class="op" id="5378781">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378786">p</span>&nbsp;<span class="op" id="5378788">=</span>&nbsp;<span class="ident" id="5378790">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5378804">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5378812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5378816">switch</span>&nbsp;<span class="ident" id="5378823">inst</span><span class="op" id="5378827">.</span><span class="ident" id="5378828">Op</span>&nbsp;<span class="op" id="5378831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5378835">case</span>&nbsp;<span class="ident" id="5378840">syntax</span><span class="op" id="5378846">.</span><span class="ident" id="5378847">InstAlt</span><span class="op" id="5378854">,</span>&nbsp;<span class="ident" id="5378856">syntax</span><span class="op" id="5378862">.</span><span class="ident" id="5378863">InstAltMatch</span><span class="op" id="5378875">:</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378880">instQueue</span><span class="op" id="5378889">.</span><span class="ident" id="5378890">insert</span><span class="op" id="5378896">(</span><span class="ident" id="5378897">inst</span><span class="op" id="5378901">.</span><span class="ident" id="5378902">Out</span><span class="op" id="5378905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5378910">instQueue</span><span class="op" id="5378919">.</span><span class="ident" id="5378920">insert</span><span class="op" id="5378926">(</span><span class="ident" id="5378927">inst</span><span class="op" id="5378931">.</span><span class="ident" id="5378932">Arg</span><span class="op" id="5378935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5378939">case</span>&nbsp;<span class="ident" id="5378944">syntax</span><span class="op" id="5378950">.</span><span class="ident" id="5378951">InstCapture</span><span class="op" id="5378962">,</span>&nbsp;<span class="ident" id="5378964">syntax</span><span class="op" id="5378970">.</span><span class="ident" id="5378971">InstEmptyWidth</span><span class="op" id="5378985">,</span>&nbsp;<span class="ident" id="5378987">syntax</span><span class="op" id="5378993">.</span><span class="ident" id="5378994">InstNop</span><span class="op" id="5379001">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5379006">instQueue</span><span class="op" id="5379015">.</span><span class="ident" id="5379016">insert</span><span class="op" id="5379022">(</span><span class="ident" id="5379023">inst</span><span class="op" id="5379027">.</span><span class="ident" id="5379028">Out</span><span class="op" id="5379031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5379035">case</span>&nbsp;<span class="ident" id="5379040">syntax</span><span class="op" id="5379046">.</span><span class="ident" id="5379047">InstMatch</span><span class="op" id="5379056">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5379060">case</span>&nbsp;<span class="ident" id="5379065">syntax</span><span class="op" id="5379071">.</span><span class="ident" id="5379072">InstFail</span><span class="op" id="5379080">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5379084">case</span>&nbsp;<span class="ident" id="5379089">syntax</span><span class="op" id="5379095">.</span><span class="ident" id="5379096">InstRune</span><span class="op" id="5379104">,</span>&nbsp;<span class="ident" id="5379106">syntax</span><span class="op" id="5379112">.</span><span class="ident" id="5379113">InstRune1</span><span class="op" id="5379122">,</span>&nbsp;<span class="ident" id="5379124">syntax</span><span class="op" id="5379130">.</span><span class="ident" id="5379131">InstRuneAny</span><span class="op" id="5379142">,</span>&nbsp;<span class="ident" id="5379144">syntax</span><span class="op" id="5379150">.</span><span class="ident" id="5379151">InstRuneAnyNotNL</span><span class="op" id="5379167">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5379171">default</span><span class="op" id="5379178">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5379182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5379185">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5379188">if</span>&nbsp;<span class="ident" id="5379191">p</span>&nbsp;<span class="op" id="5379193">!=</span>&nbsp;<span class="ident" id="5379196">notOnePass</span>&nbsp;<span class="op" id="5379207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5379211">for</span>&nbsp;<span class="ident" id="5379215">i</span>&nbsp;<span class="op" id="5379217">:=</span>&nbsp;<span class="keyword" id="5379220">range</span>&nbsp;<span class="ident" id="5379226">p</span><span class="op" id="5379227">.</span><span class="ident" id="5379228">Inst</span>&nbsp;<span class="op" id="5379233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5379238">p</span><span class="op" id="5379239">.</span><span class="ident" id="5379240">Inst</span><span class="op" id="5379244">[</span><span class="ident" id="5379245">i</span><span class="op" id="5379246">]</span><span class="op" id="5379247">.</span><span class="ident" id="5379248">Rune</span>&nbsp;<span class="op" id="5379253">=</span>&nbsp;<span class="ident" id="5379255">onePassRunes</span><span class="op" id="5379267">[</span><span class="ident" id="5379268">i</span><span class="op" id="5379269">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5379273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5379276">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5379279">return</span>&nbsp;<span class="ident" id="5379286">p</span><br>
<span class="lineno"></span><span class="op" id="5379288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5379291">//&nbsp;walk&nbsp;visits&nbsp;each&nbsp;Inst&nbsp;in&nbsp;the&nbsp;prog&nbsp;once,&nbsp;and&nbsp;applies&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="5379359">//&nbsp;function(ip,&nbsp;next),&nbsp;in&nbsp;pre-order.</span><br>
<span class="lineno">495</span><span class="keyword" id="5379396">func</span>&nbsp;<span class="ident" id="5379401">walk</span><span class="op" id="5379405">(</span><span class="ident" id="5379406">prog</span>&nbsp;<span class="op" id="5379411">*</span><span class="ident" id="5379412">syntax</span><span class="op" id="5379418">.</span><span class="ident" id="5379419">Prog</span><span class="op" id="5379423">,</span>&nbsp;<span class="ident" id="5379425">funcs</span>&nbsp;<span class="op" id="5379431">...</span><span class="keyword" id="5379434">func</span><span class="op" id="5379438">(</span><span class="ident" id="5379439">ip</span><span class="op" id="5379441">,</span>&nbsp;<span class="ident" id="5379443">next</span>&nbsp;<span class="builtintype" id="5379448">uint32</span><span class="op" id="5379454">)</span><span class="op" id="5379455">)</span>&nbsp;<span class="op" id="5379457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5379460">var</span>&nbsp;<span class="ident" id="5379464">walk1</span>&nbsp;<span class="keyword" id="5379470">func</span><span class="op" id="5379474">(</span><span class="builtintype" id="5379475">uint32</span><span class="op" id="5379481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5379484">progQueue</span>&nbsp;<span class="op" id="5379494">:=</span>&nbsp;<span class="ident" id="5379497">newQueue</span><span class="op" id="5379505">(</span><span class="builtinfunc" id="5379506">len</span><span class="op" id="5379509">(</span><span class="ident" id="5379510">prog</span><span class="op" id="5379514">.</span><span class="ident" id="5379515">Inst</span><span class="op" id="5379519">)</span><span class="op" id="5379520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5379523">walk1</span>&nbsp;<span class="op" id="5379529">=</span>&nbsp;<span class="keyword" id="5379531">func</span><span class="op" id="5379535">(</span><span class="ident" id="5379536">ip</span>&nbsp;<span class="builtintype" id="5379539">uint32</span><span class="op" id="5379545">)</span>&nbsp;<span class="op" id="5379547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5379551">if</span>&nbsp;<span class="ident" id="5379554">progQueue</span><span class="op" id="5379563">.</span><span class="ident" id="5379564">contains</span><span class="op" id="5379572">(</span><span class="ident" id="5379573">ip</span><span class="op" id="5379575">)</span>&nbsp;<span class="op" id="5379577">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5379582">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5379591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5379595">progQueue</span><span class="op" id="5379604">.</span><span class="ident" id="5379605">insert</span><span class="op" id="5379611">(</span><span class="ident" id="5379612">ip</span><span class="op" id="5379614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5379618">inst</span>&nbsp;<span class="op" id="5379623">:=</span>&nbsp;<span class="ident" id="5379626">prog</span><span class="op" id="5379630">.</span><span class="ident" id="5379631">Inst</span><span class="op" id="5379635">[</span><span class="ident" id="5379636">ip</span><span class="op" id="5379638">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5379642">switch</span>&nbsp;<span class="ident" id="5379649">inst</span><span class="op" id="5379653">.</span><span class="ident" id="5379654">Op</span>&nbsp;<span class="op" id="5379657">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5379661">case</span>&nbsp;<span class="ident" id="5379666">syntax</span><span class="op" id="5379672">.</span><span class="ident" id="5379673">InstAlt</span><span class="op" id="5379680">,</span>&nbsp;<span class="ident" id="5379682">syntax</span><span class="op" id="5379688">.</span><span class="ident" id="5379689">InstAltMatch</span><span class="op" id="5379701">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5379706">for</span>&nbsp;<span class="ident" id="5379710">_</span><span class="op" id="5379711">,</span>&nbsp;<span class="ident" id="5379713">f</span>&nbsp;<span class="op" id="5379715">:=</span>&nbsp;<span class="keyword" id="5379718">range</span>&nbsp;<span class="ident" id="5379724">funcs</span>&nbsp;<span class="op" id="5379730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5379736">f</span><span class="op" id="5379737">(</span><span class="ident" id="5379738">ip</span><span class="op" id="5379740">,</span>&nbsp;<span class="ident" id="5379742">inst</span><span class="op" id="5379746">.</span><span class="ident" id="5379747">Out</span><span class="op" id="5379750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5379756">f</span><span class="op" id="5379757">(</span><span class="ident" id="5379758">ip</span><span class="op" id="5379760">,</span>&nbsp;<span class="ident" id="5379762">inst</span><span class="op" id="5379766">.</span><span class="ident" id="5379767">Arg</span><span class="op" id="5379770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5379775">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5379780">walk1</span><span class="op" id="5379785">(</span><span class="ident" id="5379786">inst</span><span class="op" id="5379790">.</span><span class="ident" id="5379791">Out</span><span class="op" id="5379794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5379799">walk1</span><span class="op" id="5379804">(</span><span class="ident" id="5379805">inst</span><span class="op" id="5379809">.</span><span class="ident" id="5379810">Arg</span><span class="op" id="5379813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5379817">default</span><span class="op" id="5379824">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5379829">for</span>&nbsp;<span class="ident" id="5379833">_</span><span class="op" id="5379834">,</span>&nbsp;<span class="ident" id="5379836">f</span>&nbsp;<span class="op" id="5379838">:=</span>&nbsp;<span class="keyword" id="5379841">range</span>&nbsp;<span class="ident" id="5379847">funcs</span>&nbsp;<span class="op" id="5379853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5379859">f</span><span class="op" id="5379860">(</span><span class="ident" id="5379861">ip</span><span class="op" id="5379863">,</span>&nbsp;<span class="ident" id="5379865">inst</span><span class="op" id="5379869">.</span><span class="ident" id="5379870">Out</span><span class="op" id="5379873">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5379878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5379883">walk1</span><span class="op" id="5379888">(</span><span class="ident" id="5379889">inst</span><span class="op" id="5379893">.</span><span class="ident" id="5379894">Out</span><span class="op" id="5379897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5379901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5379904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5379907">walk1</span><span class="op" id="5379912">(</span><span class="builtintype" id="5379913">uint32</span><span class="op" id="5379919">(</span><span class="ident" id="5379920">prog</span><span class="op" id="5379924">.</span><span class="ident" id="5379925">Start</span><span class="op" id="5379930">)</span><span class="op" id="5379931">)</span><br>
<span class="lineno">520</span><span class="op" id="5379933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5379936">//&nbsp;find&nbsp;returns&nbsp;the&nbsp;Insts&nbsp;that&nbsp;match&nbsp;the&nbsp;argument&nbsp;predicate&nbsp;function</span><br>
<span class="lineno"></span><span class="keyword" id="5380005">func</span>&nbsp;<span class="ident" id="5380010">find</span><span class="op" id="5380014">(</span><span class="ident" id="5380015">prog</span>&nbsp;<span class="op" id="5380020">*</span><span class="ident" id="5380021">syntax</span><span class="op" id="5380027">.</span><span class="ident" id="5380028">Prog</span><span class="op" id="5380032">,</span>&nbsp;<span class="ident" id="5380034">f</span>&nbsp;<span class="keyword" id="5380036">func</span><span class="op" id="5380040">(</span><span class="op" id="5380041">*</span><span class="ident" id="5380042">syntax</span><span class="op" id="5380048">.</span><span class="ident" id="5380049">Prog</span><span class="op" id="5380053">,</span>&nbsp;<span class="builtintype" id="5380055">int</span><span class="op" id="5380058">)</span>&nbsp;<span class="builtintype" id="5380060">bool</span><span class="op" id="5380064">)</span>&nbsp;<span class="op" id="5380066">(</span><span class="ident" id="5380067">matches</span>&nbsp;<span class="op" id="5380075">[</span><span class="op" id="5380076">]</span><span class="builtintype" id="5380077">uint32</span><span class="op" id="5380083">)</span>&nbsp;<span class="op" id="5380085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5380088">matches</span>&nbsp;<span class="op" id="5380096">=</span>&nbsp;<span class="op" id="5380098">[</span><span class="op" id="5380099">]</span><span class="builtintype" id="5380100">uint32</span><span class="op" id="5380106">{</span><span class="op" id="5380107">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5380111">for</span>&nbsp;<span class="ident" id="5380115">ip</span>&nbsp;<span class="op" id="5380118">:=</span>&nbsp;<span class="keyword" id="5380121">range</span>&nbsp;<span class="ident" id="5380127">prog</span><span class="op" id="5380131">.</span><span class="ident" id="5380132">Inst</span>&nbsp;<span class="op" id="5380137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5380141">if</span>&nbsp;<span class="ident" id="5380144">f</span><span class="op" id="5380145">(</span><span class="ident" id="5380146">prog</span><span class="op" id="5380150">,</span>&nbsp;<span class="ident" id="5380152">ip</span><span class="op" id="5380154">)</span>&nbsp;<span class="op" id="5380156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5380161">matches</span>&nbsp;<span class="op" id="5380169">=</span>&nbsp;<span class="builtinfunc" id="5380171">append</span><span class="op" id="5380177">(</span><span class="ident" id="5380178">matches</span><span class="op" id="5380185">,</span>&nbsp;<span class="builtintype" id="5380187">uint32</span><span class="op" id="5380193">(</span><span class="ident" id="5380194">ip</span><span class="op" id="5380196">)</span><span class="op" id="5380197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5380201">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5380204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5380207">return</span><br>
<span class="lineno"></span><span class="op" id="5380214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5380217">var</span>&nbsp;<span class="ident" id="5380221">notOnePass</span>&nbsp;<span class="op" id="5380232">*</span><span class="ident" id="5380233">onePassProg</span>&nbsp;<span class="op" id="5380245">=</span>&nbsp;<span class="ident" id="5380247">nil</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span><span class="comment" id="5380252">//&nbsp;compileOnePass&nbsp;returns&nbsp;a&nbsp;new&nbsp;*syntax.Prog&nbsp;suitable&nbsp;for&nbsp;onePass&nbsp;execution&nbsp;if&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span><span class="comment" id="5380349">//&nbsp;can&nbsp;be&nbsp;recharacterized&nbsp;as&nbsp;a&nbsp;one-pass&nbsp;regexp&nbsp;program,&nbsp;or&nbsp;syntax.notOnePass&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5380433">//&nbsp;Prog&nbsp;cannot&nbsp;be&nbsp;converted.&nbsp;For&nbsp;a&nbsp;one&nbsp;pass&nbsp;prog,&nbsp;the&nbsp;fundamental&nbsp;condition&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="5380519">//&nbsp;be&nbsp;true&nbsp;is:&nbsp;at&nbsp;any&nbsp;InstAlt,&nbsp;there&nbsp;must&nbsp;be&nbsp;no&nbsp;ambiguity&nbsp;about&nbsp;what&nbsp;branch&nbsp;to&nbsp;&nbsp;take.</span><br>
<span class="lineno">540</span><span class="keyword" id="5380605">func</span>&nbsp;<span class="ident" id="5380610">compileOnePass</span><span class="op" id="5380624">(</span><span class="ident" id="5380625">prog</span>&nbsp;<span class="op" id="5380630">*</span><span class="ident" id="5380631">syntax</span><span class="op" id="5380637">.</span><span class="ident" id="5380638">Prog</span><span class="op" id="5380642">)</span>&nbsp;<span class="op" id="5380644">(</span><span class="ident" id="5380645">p</span>&nbsp;<span class="op" id="5380647">*</span><span class="ident" id="5380648">onePassProg</span><span class="op" id="5380659">)</span>&nbsp;<span class="op" id="5380661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5380664">if</span>&nbsp;<span class="ident" id="5380667">prog</span><span class="op" id="5380671">.</span><span class="ident" id="5380672">Start</span>&nbsp;<span class="op" id="5380678">==</span>&nbsp;<span class="num" id="5380681">0</span>&nbsp;<span class="op" id="5380683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5380687">return</span>&nbsp;<span class="ident" id="5380694">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5380706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5380709">//&nbsp;onepass&nbsp;regexp&nbsp;is&nbsp;anchored</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5380740">if</span>&nbsp;<span class="ident" id="5380743">prog</span><span class="op" id="5380747">.</span><span class="ident" id="5380748">Inst</span><span class="op" id="5380752">[</span><span class="ident" id="5380753">prog</span><span class="op" id="5380757">.</span><span class="ident" id="5380758">Start</span><span class="op" id="5380763">]</span><span class="op" id="5380764">.</span><span class="ident" id="5380765">Op</span>&nbsp;<span class="op" id="5380768">!=</span>&nbsp;<span class="ident" id="5380771">syntax</span><span class="op" id="5380777">.</span><span class="ident" id="5380778">InstEmptyWidth</span>&nbsp;<span class="op" id="5380793">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5380798">syntax</span><span class="op" id="5380804">.</span><span class="ident" id="5380805">EmptyOp</span><span class="op" id="5380812">(</span><span class="ident" id="5380813">prog</span><span class="op" id="5380817">.</span><span class="ident" id="5380818">Inst</span><span class="op" id="5380822">[</span><span class="ident" id="5380823">prog</span><span class="op" id="5380827">.</span><span class="ident" id="5380828">Start</span><span class="op" id="5380833">]</span><span class="op" id="5380834">.</span><span class="ident" id="5380835">Arg</span><span class="op" id="5380838">)</span><span class="op" id="5380839">&amp;</span><span class="ident" id="5380840">syntax</span><span class="op" id="5380846">.</span><span class="ident" id="5380847">EmptyBeginText</span>&nbsp;<span class="op" id="5380862">!=</span>&nbsp;<span class="ident" id="5380865">syntax</span><span class="op" id="5380871">.</span><span class="ident" id="5380872">EmptyBeginText</span>&nbsp;<span class="op" id="5380887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5380891">return</span>&nbsp;<span class="ident" id="5380898">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5380910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5380913">//&nbsp;every&nbsp;instruction&nbsp;leading&nbsp;to&nbsp;InstMatch&nbsp;must&nbsp;be&nbsp;EmptyEndText</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5380977">for</span>&nbsp;<span class="ident" id="5380981">_</span><span class="op" id="5380982">,</span>&nbsp;<span class="ident" id="5380984">inst</span>&nbsp;<span class="op" id="5380989">:=</span>&nbsp;<span class="keyword" id="5380992">range</span>&nbsp;<span class="ident" id="5380998">prog</span><span class="op" id="5381002">.</span><span class="ident" id="5381003">Inst</span>&nbsp;<span class="op" id="5381008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5381012">opOut</span>&nbsp;<span class="op" id="5381018">:=</span>&nbsp;<span class="ident" id="5381021">prog</span><span class="op" id="5381025">.</span><span class="ident" id="5381026">Inst</span><span class="op" id="5381030">[</span><span class="ident" id="5381031">inst</span><span class="op" id="5381035">.</span><span class="ident" id="5381036">Out</span><span class="op" id="5381039">]</span><span class="op" id="5381040">.</span><span class="ident" id="5381041">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5381046">switch</span>&nbsp;<span class="ident" id="5381053">inst</span><span class="op" id="5381057">.</span><span class="ident" id="5381058">Op</span>&nbsp;<span class="op" id="5381061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5381065">default</span><span class="op" id="5381072">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5381077">if</span>&nbsp;<span class="ident" id="5381080">opOut</span>&nbsp;<span class="op" id="5381086">==</span>&nbsp;<span class="ident" id="5381089">syntax</span><span class="op" id="5381095">.</span><span class="ident" id="5381096">InstMatch</span>&nbsp;<span class="op" id="5381106">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5381112">return</span>&nbsp;<span class="ident" id="5381119">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5381133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5381137">case</span>&nbsp;<span class="ident" id="5381142">syntax</span><span class="op" id="5381148">.</span><span class="ident" id="5381149">InstAlt</span><span class="op" id="5381156">,</span>&nbsp;<span class="ident" id="5381158">syntax</span><span class="op" id="5381164">.</span><span class="ident" id="5381165">InstAltMatch</span><span class="op" id="5381177">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5381182">if</span>&nbsp;<span class="ident" id="5381185">opOut</span>&nbsp;<span class="op" id="5381191">==</span>&nbsp;<span class="ident" id="5381194">syntax</span><span class="op" id="5381200">.</span><span class="ident" id="5381201">InstMatch</span>&nbsp;<span class="op" id="5381211">||</span>&nbsp;<span class="ident" id="5381214">prog</span><span class="op" id="5381218">.</span><span class="ident" id="5381219">Inst</span><span class="op" id="5381223">[</span><span class="ident" id="5381224">inst</span><span class="op" id="5381228">.</span><span class="ident" id="5381229">Arg</span><span class="op" id="5381232">]</span><span class="op" id="5381233">.</span><span class="ident" id="5381234">Op</span>&nbsp;<span class="op" id="5381237">==</span>&nbsp;<span class="ident" id="5381240">syntax</span><span class="op" id="5381246">.</span><span class="ident" id="5381247">InstMatch</span>&nbsp;<span class="op" id="5381257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5381263">return</span>&nbsp;<span class="ident" id="5381270">notOnePass</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5381284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5381288">case</span>&nbsp;<span class="ident" id="5381293">syntax</span><span class="op" id="5381299">.</span><span class="ident" id="5381300">InstEmptyWidth</span><span class="op" id="5381314">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5381319">if</span>&nbsp;<span class="ident" id="5381322">opOut</span>&nbsp;<span class="op" id="5381328">==</span>&nbsp;<span class="ident" id="5381331">syntax</span><span class="op" id="5381337">.</span><span class="ident" id="5381338">InstMatch</span>&nbsp;<span class="op" id="5381348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5381354">if</span>&nbsp;<span class="ident" id="5381357">syntax</span><span class="op" id="5381363">.</span><span class="ident" id="5381364">EmptyOp</span><span class="op" id="5381371">(</span><span class="ident" id="5381372">inst</span><span class="op" id="5381376">.</span><span class="ident" id="5381377">Arg</span><span class="op" id="5381380">)</span><span class="op" id="5381381">&amp;</span><span class="ident" id="5381382">syntax</span><span class="op" id="5381388">.</span><span class="ident" id="5381389">EmptyEndText</span>&nbsp;<span class="op" id="5381402">==</span>&nbsp;<span class="ident" id="5381405">syntax</span><span class="op" id="5381411">.</span><span class="ident" id="5381412">EmptyEndText</span>&nbsp;<span class="op" id="5381425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5381432">continue</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5381445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5381451">return</span>&nbsp;<span class="ident" id="5381458">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5381472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5381476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5381479">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5381482">//&nbsp;Creates&nbsp;a&nbsp;slightly&nbsp;optimized&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5381541">//&nbsp;that&nbsp;cleans&nbsp;up&nbsp;some&nbsp;Prog&nbsp;idioms&nbsp;that&nbsp;block&nbsp;valid&nbsp;onepass&nbsp;programs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5381611">p</span>&nbsp;<span class="op" id="5381613">=</span>&nbsp;<span class="ident" id="5381615">onePassCopy</span><span class="op" id="5381626">(</span><span class="ident" id="5381627">prog</span><span class="op" id="5381631">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5381635">//&nbsp;checkAmbiguity&nbsp;on&nbsp;InstAlts,&nbsp;build&nbsp;onepass&nbsp;Prog&nbsp;if&nbsp;possible</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5381698">p</span>&nbsp;<span class="op" id="5381700">=</span>&nbsp;<span class="ident" id="5381702">makeOnePass</span><span class="op" id="5381713">(</span><span class="ident" id="5381714">p</span><span class="op" id="5381715">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5381719">if</span>&nbsp;<span class="ident" id="5381722">p</span>&nbsp;<span class="op" id="5381724">!=</span>&nbsp;<span class="ident" id="5381727">notOnePass</span>&nbsp;<span class="op" id="5381738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5381742">cleanupOnePass</span><span class="op" id="5381756">(</span><span class="ident" id="5381757">p</span><span class="op" id="5381758">,</span>&nbsp;<span class="ident" id="5381760">prog</span><span class="op" id="5381764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5381767">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5381770">return</span>&nbsp;<span class="ident" id="5381777">p</span><br>
<span class="lineno"></span><span class="op" id="5381779">}</span>
</div>
</body>
</html>
