<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7395697">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7395752">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7395806">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7395857">package</span>&nbsp;<span class="ident" id="7395865">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7395871">import</span>&nbsp;<span class="op" id="7395878">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7395881">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7395890">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7395897">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7395906">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7395921">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7395927">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7395940">&#34;math/rand&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7395953">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7395959">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7395970">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="7395980">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="7395983">//&nbsp;TestDecodeProgressive&nbsp;tests&nbsp;that&nbsp;decoding&nbsp;the&nbsp;baseline&nbsp;and&nbsp;progressive</span><br>
<span class="lineno"></span><span class="comment" id="7396057">//&nbsp;versions&nbsp;of&nbsp;the&nbsp;same&nbsp;image&nbsp;result&nbsp;in&nbsp;exactly&nbsp;the&nbsp;same&nbsp;pixel&nbsp;data,&nbsp;in&nbsp;YCbCr</span><br>
<span class="lineno"></span><span class="comment" id="7396135">//&nbsp;space&nbsp;for&nbsp;color&nbsp;images,&nbsp;and&nbsp;Y&nbsp;space&nbsp;for&nbsp;grayscale&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="7396196">func</span>&nbsp;<span class="ident" id="7396201">TestDecodeProgressive</span><span class="op" id="7396222">(</span><span class="ident" id="7396223">t</span>&nbsp;<span class="op" id="7396225">*</span><span class="ident" id="7396226">testing</span><span class="op" id="7396233">.</span><span class="ident" id="7396234">T</span><span class="op" id="7396235">)</span>&nbsp;<span class="op" id="7396237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396240">testCases</span>&nbsp;<span class="op" id="7396250">:=</span>&nbsp;<span class="op" id="7396253">[</span><span class="op" id="7396254">]</span><span class="builtintype" id="7396255">string</span><span class="op" id="7396261">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7396265">&#34;../testdata/video-001&#34;</span><span class="op" id="7396288">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7396292">&#34;../testdata/video-001.q50.420&#34;</span><span class="op" id="7396323">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7396327">&#34;../testdata/video-001.q50.422&#34;</span><span class="op" id="7396358">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7396362">&#34;../testdata/video-001.q50.440&#34;</span><span class="op" id="7396393">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7396397">&#34;../testdata/video-001.q50.444&#34;</span><span class="op" id="7396428">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7396432">&#34;../testdata/video-005.gray.q50&#34;</span><span class="op" id="7396464">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7396468">&#34;../testdata/video-005.gray.q50.2x2&#34;</span><span class="op" id="7396504">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7396508">&#34;../testdata/video-001.separate.dc.progression&#34;</span><span class="op" id="7396555">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7396558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7396561">for</span>&nbsp;<span class="ident" id="7396565">_</span><span class="op" id="7396566">,</span>&nbsp;<span class="ident" id="7396568">tc</span>&nbsp;<span class="op" id="7396571">:=</span>&nbsp;<span class="keyword" id="7396574">range</span>&nbsp;<span class="ident" id="7396580">testCases</span>&nbsp;<span class="op" id="7396590">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396594">m0</span><span class="op" id="7396596">,</span>&nbsp;<span class="ident" id="7396598">err</span>&nbsp;<span class="op" id="7396602">:=</span>&nbsp;<span class="ident" id="7396605">decodeFile</span><span class="op" id="7396615">(</span><span class="ident" id="7396616">tc</span>&nbsp;<span class="op" id="7396619">+</span>&nbsp;<span class="string" id="7396621">&#34;.jpeg&#34;</span><span class="op" id="7396628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7396632">if</span>&nbsp;<span class="ident" id="7396635">err</span>&nbsp;<span class="op" id="7396639">!=</span>&nbsp;<span class="ident" id="7396642">nil</span>&nbsp;<span class="op" id="7396646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396651">t</span><span class="op" id="7396652">.</span><span class="ident" id="7396653">Errorf</span><span class="op" id="7396659">(</span><span class="string" id="7396660">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7396668">,</span>&nbsp;<span class="ident" id="7396670">tc</span><span class="op" id="7396672">+</span><span class="string" id="7396673">&#34;.jpeg&#34;</span><span class="op" id="7396680">,</span>&nbsp;<span class="ident" id="7396682">err</span><span class="op" id="7396685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7396690">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7396701">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396705">m1</span><span class="op" id="7396707">,</span>&nbsp;<span class="ident" id="7396709">err</span>&nbsp;<span class="op" id="7396713">:=</span>&nbsp;<span class="ident" id="7396716">decodeFile</span><span class="op" id="7396726">(</span><span class="ident" id="7396727">tc</span>&nbsp;<span class="op" id="7396730">+</span>&nbsp;<span class="string" id="7396732">&#34;.progressive.jpeg&#34;</span><span class="op" id="7396751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7396755">if</span>&nbsp;<span class="ident" id="7396758">err</span>&nbsp;<span class="op" id="7396762">!=</span>&nbsp;<span class="ident" id="7396765">nil</span>&nbsp;<span class="op" id="7396769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396774">t</span><span class="op" id="7396775">.</span><span class="ident" id="7396776">Errorf</span><span class="op" id="7396782">(</span><span class="string" id="7396783">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7396791">,</span>&nbsp;<span class="ident" id="7396793">tc</span><span class="op" id="7396795">+</span><span class="string" id="7396796">&#34;.progressive.jpeg&#34;</span><span class="op" id="7396815">,</span>&nbsp;<span class="ident" id="7396817">err</span><span class="op" id="7396820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7396825">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7396836">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7396840">if</span>&nbsp;<span class="ident" id="7396843">m0</span><span class="op" id="7396845">.</span><span class="ident" id="7396846">Bounds</span><span class="op" id="7396852">(</span><span class="op" id="7396853">)</span>&nbsp;<span class="op" id="7396855">!=</span>&nbsp;<span class="ident" id="7396858">m1</span><span class="op" id="7396860">.</span><span class="ident" id="7396861">Bounds</span><span class="op" id="7396867">(</span><span class="op" id="7396868">)</span>&nbsp;<span class="op" id="7396870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396875">t</span><span class="op" id="7396876">.</span><span class="ident" id="7396877">Errorf</span><span class="op" id="7396883">(</span><span class="string" id="7396884">&#34;%s:&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7396914">,</span>&nbsp;<span class="ident" id="7396916">tc</span><span class="op" id="7396918">,</span>&nbsp;<span class="ident" id="7396920">m0</span><span class="op" id="7396922">.</span><span class="ident" id="7396923">Bounds</span><span class="op" id="7396929">(</span><span class="op" id="7396930">)</span><span class="op" id="7396931">,</span>&nbsp;<span class="ident" id="7396933">m1</span><span class="op" id="7396935">.</span><span class="ident" id="7396936">Bounds</span><span class="op" id="7396942">(</span><span class="op" id="7396943">)</span><span class="op" id="7396944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7396949">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7396960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7396964">//&nbsp;All&nbsp;of&nbsp;the&nbsp;video-*.jpeg&nbsp;files&nbsp;are&nbsp;150x103.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7397012">if</span>&nbsp;<span class="ident" id="7397015">m0</span><span class="op" id="7397017">.</span><span class="ident" id="7397018">Bounds</span><span class="op" id="7397024">(</span><span class="op" id="7397025">)</span>&nbsp;<span class="op" id="7397027">!=</span>&nbsp;<span class="ident" id="7397030">image</span><span class="op" id="7397035">.</span><span class="ident" id="7397036">Rect</span><span class="op" id="7397040">(</span><span class="num" id="7397041">0</span><span class="op" id="7397042">,</span>&nbsp;<span class="num" id="7397044">0</span><span class="op" id="7397045">,</span>&nbsp;<span class="num" id="7397047">150</span><span class="op" id="7397050">,</span>&nbsp;<span class="num" id="7397052">103</span><span class="op" id="7397055">)</span>&nbsp;<span class="op" id="7397057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7397062">t</span><span class="op" id="7397063">.</span><span class="ident" id="7397064">Errorf</span><span class="op" id="7397070">(</span><span class="string" id="7397071">&#34;%s:&nbsp;bad&nbsp;bounds:&nbsp;%v&#34;</span><span class="op" id="7397091">,</span>&nbsp;<span class="ident" id="7397093">tc</span><span class="op" id="7397095">,</span>&nbsp;<span class="ident" id="7397097">m0</span><span class="op" id="7397099">.</span><span class="ident" id="7397100">Bounds</span><span class="op" id="7397106">(</span><span class="op" id="7397107">)</span><span class="op" id="7397108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7397113">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7397129">switch</span>&nbsp;<span class="ident" id="7397136">m0</span>&nbsp;<span class="op" id="7397139">:=</span>&nbsp;<span class="ident" id="7397142">m0</span><span class="op" id="7397144">.</span><span class="op" id="7397145">(</span><span class="keyword" id="7397146">type</span><span class="op" id="7397150">)</span>&nbsp;<span class="op" id="7397152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7397156">case</span>&nbsp;<span class="op" id="7397161">*</span><span class="ident" id="7397162">image</span><span class="op" id="7397167">.</span><span class="ident" id="7397168">YCbCr</span><span class="op" id="7397173">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7397178">m1</span>&nbsp;<span class="op" id="7397181">:=</span>&nbsp;<span class="ident" id="7397184">m1</span><span class="op" id="7397186">.</span><span class="op" id="7397187">(</span><span class="op" id="7397188">*</span><span class="ident" id="7397189">image</span><span class="op" id="7397194">.</span><span class="ident" id="7397195">YCbCr</span><span class="op" id="7397200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7397205">if</span>&nbsp;<span class="ident" id="7397208">err</span>&nbsp;<span class="op" id="7397212">:=</span>&nbsp;<span class="ident" id="7397215">check</span><span class="op" id="7397220">(</span><span class="ident" id="7397221">m0</span><span class="op" id="7397223">.</span><span class="ident" id="7397224">Bounds</span><span class="op" id="7397230">(</span><span class="op" id="7397231">)</span><span class="op" id="7397232">,</span>&nbsp;<span class="ident" id="7397234">m0</span><span class="op" id="7397236">.</span><span class="ident" id="7397237">Y</span><span class="op" id="7397238">,</span>&nbsp;<span class="ident" id="7397240">m1</span><span class="op" id="7397242">.</span><span class="ident" id="7397243">Y</span><span class="op" id="7397244">,</span>&nbsp;<span class="ident" id="7397246">m0</span><span class="op" id="7397248">.</span><span class="ident" id="7397249">YStride</span><span class="op" id="7397256">,</span>&nbsp;<span class="ident" id="7397258">m1</span><span class="op" id="7397260">.</span><span class="ident" id="7397261">YStride</span><span class="op" id="7397268">)</span><span class="op" id="7397269">;</span>&nbsp;<span class="ident" id="7397271">err</span>&nbsp;<span class="op" id="7397275">!=</span>&nbsp;<span class="ident" id="7397278">nil</span>&nbsp;<span class="op" id="7397282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7397288">t</span><span class="op" id="7397289">.</span><span class="ident" id="7397290">Errorf</span><span class="op" id="7397296">(</span><span class="string" id="7397297">&#34;%s&nbsp;(Y):&nbsp;%v&#34;</span><span class="op" id="7397309">,</span>&nbsp;<span class="ident" id="7397311">tc</span><span class="op" id="7397313">,</span>&nbsp;<span class="ident" id="7397315">err</span><span class="op" id="7397318">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7397324">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7397341">if</span>&nbsp;<span class="ident" id="7397344">err</span>&nbsp;<span class="op" id="7397348">:=</span>&nbsp;<span class="ident" id="7397351">check</span><span class="op" id="7397356">(</span><span class="ident" id="7397357">m0</span><span class="op" id="7397359">.</span><span class="ident" id="7397360">Bounds</span><span class="op" id="7397366">(</span><span class="op" id="7397367">)</span><span class="op" id="7397368">,</span>&nbsp;<span class="ident" id="7397370">m0</span><span class="op" id="7397372">.</span><span class="ident" id="7397373">Cb</span><span class="op" id="7397375">,</span>&nbsp;<span class="ident" id="7397377">m1</span><span class="op" id="7397379">.</span><span class="ident" id="7397380">Cb</span><span class="op" id="7397382">,</span>&nbsp;<span class="ident" id="7397384">m0</span><span class="op" id="7397386">.</span><span class="ident" id="7397387">CStride</span><span class="op" id="7397394">,</span>&nbsp;<span class="ident" id="7397396">m1</span><span class="op" id="7397398">.</span><span class="ident" id="7397399">CStride</span><span class="op" id="7397406">)</span><span class="op" id="7397407">;</span>&nbsp;<span class="ident" id="7397409">err</span>&nbsp;<span class="op" id="7397413">!=</span>&nbsp;<span class="ident" id="7397416">nil</span>&nbsp;<span class="op" id="7397420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7397426">t</span><span class="op" id="7397427">.</span><span class="ident" id="7397428">Errorf</span><span class="op" id="7397434">(</span><span class="string" id="7397435">&#34;%s&nbsp;(Cb):&nbsp;%v&#34;</span><span class="op" id="7397448">,</span>&nbsp;<span class="ident" id="7397450">tc</span><span class="op" id="7397452">,</span>&nbsp;<span class="ident" id="7397454">err</span><span class="op" id="7397457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7397463">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7397480">if</span>&nbsp;<span class="ident" id="7397483">err</span>&nbsp;<span class="op" id="7397487">:=</span>&nbsp;<span class="ident" id="7397490">check</span><span class="op" id="7397495">(</span><span class="ident" id="7397496">m0</span><span class="op" id="7397498">.</span><span class="ident" id="7397499">Bounds</span><span class="op" id="7397505">(</span><span class="op" id="7397506">)</span><span class="op" id="7397507">,</span>&nbsp;<span class="ident" id="7397509">m0</span><span class="op" id="7397511">.</span><span class="ident" id="7397512">Cr</span><span class="op" id="7397514">,</span>&nbsp;<span class="ident" id="7397516">m1</span><span class="op" id="7397518">.</span><span class="ident" id="7397519">Cr</span><span class="op" id="7397521">,</span>&nbsp;<span class="ident" id="7397523">m0</span><span class="op" id="7397525">.</span><span class="ident" id="7397526">CStride</span><span class="op" id="7397533">,</span>&nbsp;<span class="ident" id="7397535">m1</span><span class="op" id="7397537">.</span><span class="ident" id="7397538">CStride</span><span class="op" id="7397545">)</span><span class="op" id="7397546">;</span>&nbsp;<span class="ident" id="7397548">err</span>&nbsp;<span class="op" id="7397552">!=</span>&nbsp;<span class="ident" id="7397555">nil</span>&nbsp;<span class="op" id="7397559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7397565">t</span><span class="op" id="7397566">.</span><span class="ident" id="7397567">Errorf</span><span class="op" id="7397573">(</span><span class="string" id="7397574">&#34;%s&nbsp;(Cr):&nbsp;%v&#34;</span><span class="op" id="7397587">,</span>&nbsp;<span class="ident" id="7397589">tc</span><span class="op" id="7397591">,</span>&nbsp;<span class="ident" id="7397593">err</span><span class="op" id="7397596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7397602">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397614">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7397618">case</span>&nbsp;<span class="op" id="7397623">*</span><span class="ident" id="7397624">image</span><span class="op" id="7397629">.</span><span class="ident" id="7397630">Gray</span><span class="op" id="7397634">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7397639">m1</span>&nbsp;<span class="op" id="7397642">:=</span>&nbsp;<span class="ident" id="7397645">m1</span><span class="op" id="7397647">.</span><span class="op" id="7397648">(</span><span class="op" id="7397649">*</span><span class="ident" id="7397650">image</span><span class="op" id="7397655">.</span><span class="ident" id="7397656">Gray</span><span class="op" id="7397660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7397665">if</span>&nbsp;<span class="ident" id="7397668">err</span>&nbsp;<span class="op" id="7397672">:=</span>&nbsp;<span class="ident" id="7397675">check</span><span class="op" id="7397680">(</span><span class="ident" id="7397681">m0</span><span class="op" id="7397683">.</span><span class="ident" id="7397684">Bounds</span><span class="op" id="7397690">(</span><span class="op" id="7397691">)</span><span class="op" id="7397692">,</span>&nbsp;<span class="ident" id="7397694">m0</span><span class="op" id="7397696">.</span><span class="ident" id="7397697">Pix</span><span class="op" id="7397700">,</span>&nbsp;<span class="ident" id="7397702">m1</span><span class="op" id="7397704">.</span><span class="ident" id="7397705">Pix</span><span class="op" id="7397708">,</span>&nbsp;<span class="ident" id="7397710">m0</span><span class="op" id="7397712">.</span><span class="ident" id="7397713">Stride</span><span class="op" id="7397719">,</span>&nbsp;<span class="ident" id="7397721">m1</span><span class="op" id="7397723">.</span><span class="ident" id="7397724">Stride</span><span class="op" id="7397730">)</span><span class="op" id="7397731">;</span>&nbsp;<span class="ident" id="7397733">err</span>&nbsp;<span class="op" id="7397737">!=</span>&nbsp;<span class="ident" id="7397740">nil</span>&nbsp;<span class="op" id="7397744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7397750">t</span><span class="op" id="7397751">.</span><span class="ident" id="7397752">Errorf</span><span class="op" id="7397758">(</span><span class="string" id="7397759">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7397767">,</span>&nbsp;<span class="ident" id="7397769">tc</span><span class="op" id="7397771">,</span>&nbsp;<span class="ident" id="7397773">err</span><span class="op" id="7397776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7397782">continue</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7397798">default</span><span class="op" id="7397805">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7397810">t</span><span class="op" id="7397811">.</span><span class="ident" id="7397812">Errorf</span><span class="op" id="7397818">(</span><span class="string" id="7397819">&#34;%s:&nbsp;unexpected&nbsp;image&nbsp;type&nbsp;%T&#34;</span><span class="op" id="7397849">,</span>&nbsp;<span class="ident" id="7397851">tc</span><span class="op" id="7397853">,</span>&nbsp;<span class="ident" id="7397855">m0</span><span class="op" id="7397857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7397862">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397873">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397876">}</span><br>
<span class="lineno"></span><span class="op" id="7397878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7397881">func</span>&nbsp;<span class="ident" id="7397886">decodeFile</span><span class="op" id="7397896">(</span><span class="ident" id="7397897">filename</span>&nbsp;<span class="builtintype" id="7397906">string</span><span class="op" id="7397912">)</span>&nbsp;<span class="op" id="7397914">(</span><span class="ident" id="7397915">image</span><span class="op" id="7397920">.</span><span class="ident" id="7397921">Image</span><span class="op" id="7397926">,</span>&nbsp;<span class="builtintype" id="7397928">error</span><span class="op" id="7397933">)</span>&nbsp;<span class="op" id="7397935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7397938">f</span><span class="op" id="7397939">,</span>&nbsp;<span class="ident" id="7397941">err</span>&nbsp;<span class="op" id="7397945">:=</span>&nbsp;<span class="ident" id="7397948">os</span><span class="op" id="7397950">.</span><span class="ident" id="7397951">Open</span><span class="op" id="7397955">(</span><span class="ident" id="7397956">filename</span><span class="op" id="7397964">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7397967">if</span>&nbsp;<span class="ident" id="7397970">err</span>&nbsp;<span class="op" id="7397974">!=</span>&nbsp;<span class="ident" id="7397977">nil</span>&nbsp;<span class="op" id="7397981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7397985">return</span>&nbsp;<span class="ident" id="7397992">nil</span><span class="op" id="7397995">,</span>&nbsp;<span class="ident" id="7397997">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398005">defer</span>&nbsp;<span class="ident" id="7398011">f</span><span class="op" id="7398012">.</span><span class="ident" id="7398013">Close</span><span class="op" id="7398018">(</span><span class="op" id="7398019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398022">return</span>&nbsp;<span class="ident" id="7398029">Decode</span><span class="op" id="7398035">(</span><span class="ident" id="7398036">f</span><span class="op" id="7398037">)</span><br>
<span class="lineno">90</span><span class="op" id="7398039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7398042">type</span>&nbsp;<span class="ident" id="7398047">eofReader</span>&nbsp;<span class="keyword" id="7398057">struct</span>&nbsp;<span class="op" id="7398064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398067">data</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7398076">[</span><span class="op" id="7398077">]</span><span class="builtintype" id="7398078">byte</span>&nbsp;<span class="comment" id="7398083">//&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;without&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398117">dataEOF</span>&nbsp;&nbsp;<span class="op" id="7398126">[</span><span class="op" id="7398127">]</span><span class="builtintype" id="7398128">byte</span>&nbsp;<span class="comment" id="7398133">//&nbsp;then&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;with&nbsp;EOF&nbsp;on&nbsp;last&nbsp;chunk</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398183">lenAtEOF</span>&nbsp;<span class="builtintype" id="7398192">int</span><br>
<span class="lineno"></span><span class="op" id="7398196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7398199">func</span>&nbsp;<span class="op" id="7398204">(</span><span class="ident" id="7398205">r</span>&nbsp;<span class="op" id="7398207">*</span><span class="ident" id="7398208">eofReader</span><span class="op" id="7398217">)</span>&nbsp;<span class="ident" id="7398219">Read</span><span class="op" id="7398223">(</span><span class="ident" id="7398224">b</span>&nbsp;<span class="op" id="7398226">[</span><span class="op" id="7398227">]</span><span class="builtintype" id="7398228">byte</span><span class="op" id="7398232">)</span>&nbsp;<span class="op" id="7398234">(</span><span class="ident" id="7398235">n</span>&nbsp;<span class="builtintype" id="7398237">int</span><span class="op" id="7398240">,</span>&nbsp;<span class="ident" id="7398242">err</span>&nbsp;<span class="builtintype" id="7398246">error</span><span class="op" id="7398251">)</span>&nbsp;<span class="op" id="7398253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398256">if</span>&nbsp;<span class="builtinfunc" id="7398259">len</span><span class="op" id="7398262">(</span><span class="ident" id="7398263">r</span><span class="op" id="7398264">.</span><span class="ident" id="7398265">data</span><span class="op" id="7398269">)</span>&nbsp;<span class="op" id="7398271">&gt;</span>&nbsp;<span class="num" id="7398273">0</span>&nbsp;<span class="op" id="7398275">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398279">n</span>&nbsp;<span class="op" id="7398281">=</span>&nbsp;<span class="builtinfunc" id="7398283">copy</span><span class="op" id="7398287">(</span><span class="ident" id="7398288">b</span><span class="op" id="7398289">,</span>&nbsp;<span class="ident" id="7398291">r</span><span class="op" id="7398292">.</span><span class="ident" id="7398293">data</span><span class="op" id="7398297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398301">r</span><span class="op" id="7398302">.</span><span class="ident" id="7398303">data</span>&nbsp;<span class="op" id="7398308">=</span>&nbsp;<span class="ident" id="7398310">r</span><span class="op" id="7398311">.</span><span class="ident" id="7398312">data</span><span class="op" id="7398316">[</span><span class="ident" id="7398317">n</span><span class="op" id="7398318">:</span><span class="op" id="7398319">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398322">}</span>&nbsp;<span class="keyword" id="7398324">else</span>&nbsp;<span class="op" id="7398329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398333">n</span>&nbsp;<span class="op" id="7398335">=</span>&nbsp;<span class="builtinfunc" id="7398337">copy</span><span class="op" id="7398341">(</span><span class="ident" id="7398342">b</span><span class="op" id="7398343">,</span>&nbsp;<span class="ident" id="7398345">r</span><span class="op" id="7398346">.</span><span class="ident" id="7398347">dataEOF</span><span class="op" id="7398354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398358">r</span><span class="op" id="7398359">.</span><span class="ident" id="7398360">dataEOF</span>&nbsp;<span class="op" id="7398368">=</span>&nbsp;<span class="ident" id="7398370">r</span><span class="op" id="7398371">.</span><span class="ident" id="7398372">dataEOF</span><span class="op" id="7398379">[</span><span class="ident" id="7398380">n</span><span class="op" id="7398381">:</span><span class="op" id="7398382">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398386">if</span>&nbsp;<span class="builtinfunc" id="7398389">len</span><span class="op" id="7398392">(</span><span class="ident" id="7398393">r</span><span class="op" id="7398394">.</span><span class="ident" id="7398395">dataEOF</span><span class="op" id="7398402">)</span>&nbsp;<span class="op" id="7398404">==</span>&nbsp;<span class="num" id="7398407">0</span>&nbsp;<span class="op" id="7398409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398414">err</span>&nbsp;<span class="op" id="7398418">=</span>&nbsp;<span class="ident" id="7398420">io</span><span class="op" id="7398422">.</span><span class="ident" id="7398423">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398430">if</span>&nbsp;<span class="ident" id="7398433">r</span><span class="op" id="7398434">.</span><span class="ident" id="7398435">lenAtEOF</span>&nbsp;<span class="op" id="7398444">==</span>&nbsp;<span class="op" id="7398447">-</span><span class="num" id="7398448">1</span>&nbsp;<span class="op" id="7398450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398456">r</span><span class="op" id="7398457">.</span><span class="ident" id="7398458">lenAtEOF</span>&nbsp;<span class="op" id="7398467">=</span>&nbsp;<span class="ident" id="7398469">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398474">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398484">return</span><br>
<span class="lineno"></span><span class="op" id="7398491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="7398494">func</span>&nbsp;<span class="ident" id="7398499">TestDecodeEOF</span><span class="op" id="7398512">(</span><span class="ident" id="7398513">t</span>&nbsp;<span class="op" id="7398515">*</span><span class="ident" id="7398516">testing</span><span class="op" id="7398523">.</span><span class="ident" id="7398524">T</span><span class="op" id="7398525">)</span>&nbsp;<span class="op" id="7398527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7398530">//&nbsp;Check&nbsp;that&nbsp;if&nbsp;reader&nbsp;returns&nbsp;final&nbsp;data&nbsp;and&nbsp;EOF&nbsp;at&nbsp;same&nbsp;time,&nbsp;jpeg&nbsp;handles&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398613">data</span><span class="op" id="7398617">,</span>&nbsp;<span class="ident" id="7398619">err</span>&nbsp;<span class="op" id="7398623">:=</span>&nbsp;<span class="ident" id="7398626">ioutil</span><span class="op" id="7398632">.</span><span class="ident" id="7398633">ReadFile</span><span class="op" id="7398641">(</span><span class="string" id="7398642">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7398670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398673">if</span>&nbsp;<span class="ident" id="7398676">err</span>&nbsp;<span class="op" id="7398680">!=</span>&nbsp;<span class="ident" id="7398683">nil</span>&nbsp;<span class="op" id="7398687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398691">t</span><span class="op" id="7398692">.</span><span class="ident" id="7398693">Fatal</span><span class="op" id="7398698">(</span><span class="ident" id="7398699">err</span><span class="op" id="7398702">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398709">n</span>&nbsp;<span class="op" id="7398711">:=</span>&nbsp;<span class="builtinfunc" id="7398714">len</span><span class="op" id="7398717">(</span><span class="ident" id="7398718">data</span><span class="op" id="7398722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398725">for</span>&nbsp;<span class="ident" id="7398729">i</span>&nbsp;<span class="op" id="7398731">:=</span>&nbsp;<span class="num" id="7398734">0</span><span class="op" id="7398735">;</span>&nbsp;<span class="ident" id="7398737">i</span>&nbsp;<span class="op" id="7398739">&lt;</span>&nbsp;<span class="ident" id="7398741">n</span><span class="op" id="7398742">;</span>&nbsp;<span class="op" id="7398744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398748">r</span>&nbsp;<span class="op" id="7398750">:=</span>&nbsp;<span class="op" id="7398753">&amp;</span><span class="ident" id="7398754">eofReader</span><span class="op" id="7398763">{</span><span class="ident" id="7398764">data</span><span class="op" id="7398768">[</span><span class="op" id="7398769">:</span><span class="ident" id="7398770">n</span><span class="op" id="7398771">-</span><span class="ident" id="7398772">i</span><span class="op" id="7398773">]</span><span class="op" id="7398774">,</span>&nbsp;<span class="ident" id="7398776">data</span><span class="op" id="7398780">[</span><span class="ident" id="7398781">n</span><span class="op" id="7398782">-</span><span class="ident" id="7398783">i</span><span class="op" id="7398784">:</span><span class="op" id="7398785">]</span><span class="op" id="7398786">,</span>&nbsp;<span class="op" id="7398788">-</span><span class="num" id="7398789">1</span><span class="op" id="7398790">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398794">_</span><span class="op" id="7398795">,</span>&nbsp;<span class="ident" id="7398797">err</span>&nbsp;<span class="op" id="7398801">:=</span>&nbsp;<span class="ident" id="7398804">Decode</span><span class="op" id="7398810">(</span><span class="ident" id="7398811">r</span><span class="op" id="7398812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398816">if</span>&nbsp;<span class="ident" id="7398819">err</span>&nbsp;<span class="op" id="7398823">!=</span>&nbsp;<span class="ident" id="7398826">nil</span>&nbsp;<span class="op" id="7398830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398835">t</span><span class="op" id="7398836">.</span><span class="ident" id="7398837">Errorf</span><span class="op" id="7398843">(</span><span class="string" id="7398844">&#34;Decode&nbsp;with&nbsp;Read()&nbsp;=&nbsp;%d,&nbsp;EOF:&nbsp;%v&#34;</span><span class="op" id="7398878">,</span>&nbsp;<span class="ident" id="7398880">r</span><span class="op" id="7398881">.</span><span class="ident" id="7398882">lenAtEOF</span><span class="op" id="7398890">,</span>&nbsp;<span class="ident" id="7398892">err</span><span class="op" id="7398895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398903">if</span>&nbsp;<span class="ident" id="7398906">i</span>&nbsp;<span class="op" id="7398908">==</span>&nbsp;<span class="num" id="7398911">0</span>&nbsp;<span class="op" id="7398913">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398918">i</span>&nbsp;<span class="op" id="7398920">=</span>&nbsp;<span class="num" id="7398922">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398926">}</span>&nbsp;<span class="keyword" id="7398928">else</span>&nbsp;<span class="op" id="7398933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398938">i</span>&nbsp;<span class="op" id="7398940">*=</span>&nbsp;<span class="num" id="7398943">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398950">}</span><br>
<span class="lineno">135</span><span class="op" id="7398952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7398955">//&nbsp;check&nbsp;checks&nbsp;that&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;are&nbsp;equal,&nbsp;within&nbsp;the&nbsp;given&nbsp;bounds.</span><br>
<span class="lineno"></span><span class="keyword" id="7399029">func</span>&nbsp;<span class="ident" id="7399034">check</span><span class="op" id="7399039">(</span><span class="ident" id="7399040">bounds</span>&nbsp;<span class="ident" id="7399047">image</span><span class="op" id="7399052">.</span><span class="ident" id="7399053">Rectangle</span><span class="op" id="7399062">,</span>&nbsp;<span class="ident" id="7399064">pix0</span><span class="op" id="7399068">,</span>&nbsp;<span class="ident" id="7399070">pix1</span>&nbsp;<span class="op" id="7399075">[</span><span class="op" id="7399076">]</span><span class="builtintype" id="7399077">byte</span><span class="op" id="7399081">,</span>&nbsp;<span class="ident" id="7399083">stride0</span><span class="op" id="7399090">,</span>&nbsp;<span class="ident" id="7399092">stride1</span>&nbsp;<span class="builtintype" id="7399100">int</span><span class="op" id="7399103">)</span>&nbsp;<span class="builtintype" id="7399105">error</span>&nbsp;<span class="op" id="7399111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399114">if</span>&nbsp;<span class="ident" id="7399117">stride0</span>&nbsp;<span class="op" id="7399125">&lt;=</span>&nbsp;<span class="num" id="7399128">0</span>&nbsp;<span class="op" id="7399130">||</span>&nbsp;<span class="ident" id="7399133">stride0</span><span class="op" id="7399140">%</span><span class="num" id="7399141">8</span>&nbsp;<span class="op" id="7399143">!=</span>&nbsp;<span class="num" id="7399146">0</span>&nbsp;<span class="op" id="7399148">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399152">return</span>&nbsp;<span class="ident" id="7399159">fmt</span><span class="op" id="7399162">.</span><span class="ident" id="7399163">Errorf</span><span class="op" id="7399169">(</span><span class="string" id="7399170">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7399185">,</span>&nbsp;<span class="ident" id="7399187">stride0</span><span class="op" id="7399194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7399197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399200">if</span>&nbsp;<span class="ident" id="7399203">stride1</span>&nbsp;<span class="op" id="7399211">&lt;=</span>&nbsp;<span class="num" id="7399214">0</span>&nbsp;<span class="op" id="7399216">||</span>&nbsp;<span class="ident" id="7399219">stride1</span><span class="op" id="7399226">%</span><span class="num" id="7399227">8</span>&nbsp;<span class="op" id="7399229">!=</span>&nbsp;<span class="num" id="7399232">0</span>&nbsp;<span class="op" id="7399234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399238">return</span>&nbsp;<span class="ident" id="7399245">fmt</span><span class="op" id="7399248">.</span><span class="ident" id="7399249">Errorf</span><span class="op" id="7399255">(</span><span class="string" id="7399256">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7399271">,</span>&nbsp;<span class="ident" id="7399273">stride1</span><span class="op" id="7399280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7399283">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7399286">//&nbsp;Compare&nbsp;the&nbsp;two&nbsp;pix&nbsp;data,&nbsp;one&nbsp;8x8&nbsp;block&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399341">for</span>&nbsp;<span class="ident" id="7399345">y</span>&nbsp;<span class="op" id="7399347">:=</span>&nbsp;<span class="num" id="7399350">0</span><span class="op" id="7399351">;</span>&nbsp;<span class="ident" id="7399353">y</span>&nbsp;<span class="op" id="7399355">&lt;</span>&nbsp;<span class="builtinfunc" id="7399357">len</span><span class="op" id="7399360">(</span><span class="ident" id="7399361">pix0</span><span class="op" id="7399365">)</span><span class="op" id="7399366">/</span><span class="ident" id="7399367">stride0</span>&nbsp;<span class="op" id="7399375">&amp;&amp;</span>&nbsp;<span class="ident" id="7399378">y</span>&nbsp;<span class="op" id="7399380">&lt;</span>&nbsp;<span class="builtinfunc" id="7399382">len</span><span class="op" id="7399385">(</span><span class="ident" id="7399386">pix1</span><span class="op" id="7399390">)</span><span class="op" id="7399391">/</span><span class="ident" id="7399392">stride1</span><span class="op" id="7399399">;</span>&nbsp;<span class="ident" id="7399401">y</span>&nbsp;<span class="op" id="7399403">+=</span>&nbsp;<span class="num" id="7399406">8</span>&nbsp;<span class="op" id="7399408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399412">for</span>&nbsp;<span class="ident" id="7399416">x</span>&nbsp;<span class="op" id="7399418">:=</span>&nbsp;<span class="num" id="7399421">0</span><span class="op" id="7399422">;</span>&nbsp;<span class="ident" id="7399424">x</span>&nbsp;<span class="op" id="7399426">&lt;</span>&nbsp;<span class="ident" id="7399428">stride0</span>&nbsp;<span class="op" id="7399436">&amp;&amp;</span>&nbsp;<span class="ident" id="7399439">x</span>&nbsp;<span class="op" id="7399441">&lt;</span>&nbsp;<span class="ident" id="7399443">stride1</span><span class="op" id="7399450">;</span>&nbsp;<span class="ident" id="7399452">x</span>&nbsp;<span class="op" id="7399454">+=</span>&nbsp;<span class="num" id="7399457">8</span>&nbsp;<span class="op" id="7399459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399464">if</span>&nbsp;<span class="ident" id="7399467">x</span>&nbsp;<span class="op" id="7399469">&gt;=</span>&nbsp;<span class="ident" id="7399472">bounds</span><span class="op" id="7399478">.</span><span class="ident" id="7399479">Max</span><span class="op" id="7399482">.</span><span class="ident" id="7399483">X</span>&nbsp;<span class="op" id="7399485">||</span>&nbsp;<span class="ident" id="7399488">y</span>&nbsp;<span class="op" id="7399490">&gt;=</span>&nbsp;<span class="ident" id="7399493">bounds</span><span class="op" id="7399499">.</span><span class="ident" id="7399500">Max</span><span class="op" id="7399503">.</span><span class="ident" id="7399504">Y</span>&nbsp;<span class="op" id="7399506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7399512">//&nbsp;We&nbsp;don&#39;t&nbsp;care&nbsp;if&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;differ&nbsp;if&nbsp;the&nbsp;8x8&nbsp;block&nbsp;is</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7399580">//&nbsp;entirely&nbsp;outside&nbsp;of&nbsp;the&nbsp;image&#39;s&nbsp;bounds.&nbsp;For&nbsp;example,&nbsp;this&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7399649">//&nbsp;occur&nbsp;with&nbsp;a&nbsp;4:2:0&nbsp;chroma&nbsp;subsampling&nbsp;and&nbsp;a&nbsp;1x1&nbsp;image.&nbsp;Baseline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7399720">//&nbsp;decoding&nbsp;works&nbsp;on&nbsp;the&nbsp;one&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole;&nbsp;progressive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7399787">//&nbsp;decoding&#39;s&nbsp;first&nbsp;pass&nbsp;works&nbsp;on&nbsp;that&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7399855">//&nbsp;refinement&nbsp;passes&nbsp;only&nbsp;process&nbsp;one&nbsp;8x8&nbsp;block&nbsp;within&nbsp;the&nbsp;MCU.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399923">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7399935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399941">for</span>&nbsp;<span class="ident" id="7399945">j</span>&nbsp;<span class="op" id="7399947">:=</span>&nbsp;<span class="num" id="7399950">0</span><span class="op" id="7399951">;</span>&nbsp;<span class="ident" id="7399953">j</span>&nbsp;<span class="op" id="7399955">&lt;</span>&nbsp;<span class="num" id="7399957">8</span><span class="op" id="7399958">;</span>&nbsp;<span class="ident" id="7399960">j</span><span class="op" id="7399961">++</span>&nbsp;<span class="op" id="7399964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399970">for</span>&nbsp;<span class="ident" id="7399974">i</span>&nbsp;<span class="op" id="7399976">:=</span>&nbsp;<span class="num" id="7399979">0</span><span class="op" id="7399980">;</span>&nbsp;<span class="ident" id="7399982">i</span>&nbsp;<span class="op" id="7399984">&lt;</span>&nbsp;<span class="num" id="7399986">8</span><span class="op" id="7399987">;</span>&nbsp;<span class="ident" id="7399989">i</span><span class="op" id="7399990">++</span>&nbsp;<span class="op" id="7399993">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400000">index0</span>&nbsp;<span class="op" id="7400007">:=</span>&nbsp;<span class="op" id="7400010">(</span><span class="ident" id="7400011">y</span><span class="op" id="7400012">+</span><span class="ident" id="7400013">j</span><span class="op" id="7400014">)</span><span class="op" id="7400015">*</span><span class="ident" id="7400016">stride0</span>&nbsp;<span class="op" id="7400024">+</span>&nbsp;<span class="op" id="7400026">(</span><span class="ident" id="7400027">x</span>&nbsp;<span class="op" id="7400029">+</span>&nbsp;<span class="ident" id="7400031">i</span><span class="op" id="7400032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400039">index1</span>&nbsp;<span class="op" id="7400046">:=</span>&nbsp;<span class="op" id="7400049">(</span><span class="ident" id="7400050">y</span><span class="op" id="7400051">+</span><span class="ident" id="7400052">j</span><span class="op" id="7400053">)</span><span class="op" id="7400054">*</span><span class="ident" id="7400055">stride1</span>&nbsp;<span class="op" id="7400063">+</span>&nbsp;<span class="op" id="7400065">(</span><span class="ident" id="7400066">x</span>&nbsp;<span class="op" id="7400068">+</span>&nbsp;<span class="ident" id="7400070">i</span><span class="op" id="7400071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400078">if</span>&nbsp;<span class="ident" id="7400081">pix0</span><span class="op" id="7400085">[</span><span class="ident" id="7400086">index0</span><span class="op" id="7400092">]</span>&nbsp;<span class="op" id="7400094">!=</span>&nbsp;<span class="ident" id="7400097">pix1</span><span class="op" id="7400101">[</span><span class="ident" id="7400102">index1</span><span class="op" id="7400108">]</span>&nbsp;<span class="op" id="7400110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400118">return</span>&nbsp;<span class="ident" id="7400125">fmt</span><span class="op" id="7400128">.</span><span class="ident" id="7400129">Errorf</span><span class="op" id="7400135">(</span><span class="string" id="7400136">&#34;blocks&nbsp;at&nbsp;(%d,&nbsp;%d)&nbsp;differ:\n%sand\n%s&#34;</span><span class="op" id="7400175">,</span>&nbsp;<span class="ident" id="7400177">x</span><span class="op" id="7400178">,</span>&nbsp;<span class="ident" id="7400180">y</span><span class="op" id="7400181">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400190">pixString</span><span class="op" id="7400199">(</span><span class="ident" id="7400200">pix0</span><span class="op" id="7400204">,</span>&nbsp;<span class="ident" id="7400206">stride0</span><span class="op" id="7400213">,</span>&nbsp;<span class="ident" id="7400215">x</span><span class="op" id="7400216">,</span>&nbsp;<span class="ident" id="7400218">y</span><span class="op" id="7400219">)</span><span class="op" id="7400220">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400229">pixString</span><span class="op" id="7400238">(</span><span class="ident" id="7400239">pix1</span><span class="op" id="7400243">,</span>&nbsp;<span class="ident" id="7400245">stride1</span><span class="op" id="7400252">,</span>&nbsp;<span class="ident" id="7400254">x</span><span class="op" id="7400255">,</span>&nbsp;<span class="ident" id="7400257">y</span><span class="op" id="7400258">)</span><span class="op" id="7400259">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400285">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400295">return</span>&nbsp;<span class="ident" id="7400302">nil</span><br>
<span class="lineno"></span><span class="op" id="7400306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="7400309">func</span>&nbsp;<span class="ident" id="7400314">pixString</span><span class="op" id="7400323">(</span><span class="ident" id="7400324">pix</span>&nbsp;<span class="op" id="7400328">[</span><span class="op" id="7400329">]</span><span class="builtintype" id="7400330">byte</span><span class="op" id="7400334">,</span>&nbsp;<span class="ident" id="7400336">stride</span><span class="op" id="7400342">,</span>&nbsp;<span class="ident" id="7400344">x</span><span class="op" id="7400345">,</span>&nbsp;<span class="ident" id="7400347">y</span>&nbsp;<span class="builtintype" id="7400349">int</span><span class="op" id="7400352">)</span>&nbsp;<span class="builtintype" id="7400354">string</span>&nbsp;<span class="op" id="7400361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400364">s</span>&nbsp;<span class="op" id="7400366">:=</span>&nbsp;<span class="ident" id="7400369">bytes</span><span class="op" id="7400374">.</span><span class="ident" id="7400375">NewBuffer</span><span class="op" id="7400384">(</span><span class="ident" id="7400385">nil</span><span class="op" id="7400388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400391">for</span>&nbsp;<span class="ident" id="7400395">j</span>&nbsp;<span class="op" id="7400397">:=</span>&nbsp;<span class="num" id="7400400">0</span><span class="op" id="7400401">;</span>&nbsp;<span class="ident" id="7400403">j</span>&nbsp;<span class="op" id="7400405">&lt;</span>&nbsp;<span class="num" id="7400407">8</span><span class="op" id="7400408">;</span>&nbsp;<span class="ident" id="7400410">j</span><span class="op" id="7400411">++</span>&nbsp;<span class="op" id="7400414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400418">fmt</span><span class="op" id="7400421">.</span><span class="ident" id="7400422">Fprintf</span><span class="op" id="7400429">(</span><span class="ident" id="7400430">s</span><span class="op" id="7400431">,</span>&nbsp;<span class="string" id="7400433">&#34;\t&#34;</span><span class="op" id="7400437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400441">for</span>&nbsp;<span class="ident" id="7400445">i</span>&nbsp;<span class="op" id="7400447">:=</span>&nbsp;<span class="num" id="7400450">0</span><span class="op" id="7400451">;</span>&nbsp;<span class="ident" id="7400453">i</span>&nbsp;<span class="op" id="7400455">&lt;</span>&nbsp;<span class="num" id="7400457">8</span><span class="op" id="7400458">;</span>&nbsp;<span class="ident" id="7400460">i</span><span class="op" id="7400461">++</span>&nbsp;<span class="op" id="7400464">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400469">fmt</span><span class="op" id="7400472">.</span><span class="ident" id="7400473">Fprintf</span><span class="op" id="7400480">(</span><span class="ident" id="7400481">s</span><span class="op" id="7400482">,</span>&nbsp;<span class="string" id="7400484">&#34;%02x&nbsp;&#34;</span><span class="op" id="7400491">,</span>&nbsp;<span class="ident" id="7400493">pix</span><span class="op" id="7400496">[</span><span class="op" id="7400497">(</span><span class="ident" id="7400498">y</span><span class="op" id="7400499">+</span><span class="ident" id="7400500">j</span><span class="op" id="7400501">)</span><span class="op" id="7400502">*</span><span class="ident" id="7400503">stride</span><span class="op" id="7400509">+</span><span class="op" id="7400510">(</span><span class="ident" id="7400511">x</span><span class="op" id="7400512">+</span><span class="ident" id="7400513">i</span><span class="op" id="7400514">)</span><span class="op" id="7400515">]</span><span class="op" id="7400516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400524">fmt</span><span class="op" id="7400527">.</span><span class="ident" id="7400528">Fprintf</span><span class="op" id="7400535">(</span><span class="ident" id="7400536">s</span><span class="op" id="7400537">,</span>&nbsp;<span class="string" id="7400539">&#34;\n&#34;</span><span class="op" id="7400543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400549">return</span>&nbsp;<span class="ident" id="7400556">s</span><span class="op" id="7400557">.</span><span class="ident" id="7400558">String</span><span class="op" id="7400564">(</span><span class="op" id="7400565">)</span><br>
<span class="lineno">185</span><span class="op" id="7400567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7400570">func</span>&nbsp;<span class="ident" id="7400575">TestExtraneousData</span><span class="op" id="7400593">(</span><span class="ident" id="7400594">t</span>&nbsp;<span class="op" id="7400596">*</span><span class="ident" id="7400597">testing</span><span class="op" id="7400604">.</span><span class="ident" id="7400605">T</span><span class="op" id="7400606">)</span>&nbsp;<span class="op" id="7400608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7400611">//&nbsp;Encode&nbsp;a&nbsp;1x1&nbsp;red&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400639">src</span>&nbsp;<span class="op" id="7400643">:=</span>&nbsp;<span class="ident" id="7400646">image</span><span class="op" id="7400651">.</span><span class="ident" id="7400652">NewRGBA</span><span class="op" id="7400659">(</span><span class="ident" id="7400660">image</span><span class="op" id="7400665">.</span><span class="ident" id="7400666">Rect</span><span class="op" id="7400670">(</span><span class="num" id="7400671">0</span><span class="op" id="7400672">,</span>&nbsp;<span class="num" id="7400674">0</span><span class="op" id="7400675">,</span>&nbsp;<span class="num" id="7400677">1</span><span class="op" id="7400678">,</span>&nbsp;<span class="num" id="7400680">1</span><span class="op" id="7400681">)</span><span class="op" id="7400682">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400685">src</span><span class="op" id="7400688">.</span><span class="ident" id="7400689">Set</span><span class="op" id="7400692">(</span><span class="num" id="7400693">0</span><span class="op" id="7400694">,</span>&nbsp;<span class="num" id="7400696">0</span><span class="op" id="7400697">,</span>&nbsp;<span class="ident" id="7400699">color</span><span class="op" id="7400704">.</span><span class="ident" id="7400705">RGBA</span><span class="op" id="7400709">{</span><span class="num" id="7400710">0xff</span><span class="op" id="7400714">,</span>&nbsp;<span class="num" id="7400716">0x00</span><span class="op" id="7400720">,</span>&nbsp;<span class="num" id="7400722">0x00</span><span class="op" id="7400726">,</span>&nbsp;<span class="num" id="7400728">0xff</span><span class="op" id="7400732">}</span><span class="op" id="7400733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400736">buf</span>&nbsp;<span class="op" id="7400740">:=</span>&nbsp;<span class="builtinfunc" id="7400743">new</span><span class="op" id="7400746">(</span><span class="ident" id="7400747">bytes</span><span class="op" id="7400752">.</span><span class="ident" id="7400753">Buffer</span><span class="op" id="7400759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400762">if</span>&nbsp;<span class="ident" id="7400765">err</span>&nbsp;<span class="op" id="7400769">:=</span>&nbsp;<span class="ident" id="7400772">Encode</span><span class="op" id="7400778">(</span><span class="ident" id="7400779">buf</span><span class="op" id="7400782">,</span>&nbsp;<span class="ident" id="7400784">src</span><span class="op" id="7400787">,</span>&nbsp;<span class="ident" id="7400789">nil</span><span class="op" id="7400792">)</span><span class="op" id="7400793">;</span>&nbsp;<span class="ident" id="7400795">err</span>&nbsp;<span class="op" id="7400799">!=</span>&nbsp;<span class="ident" id="7400802">nil</span>&nbsp;<span class="op" id="7400806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400810">t</span><span class="op" id="7400811">.</span><span class="ident" id="7400812">Fatalf</span><span class="op" id="7400818">(</span><span class="string" id="7400819">&#34;encode:&nbsp;%v&#34;</span><span class="op" id="7400831">,</span>&nbsp;<span class="ident" id="7400833">err</span><span class="op" id="7400836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400839">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400842">enc</span>&nbsp;<span class="op" id="7400846">:=</span>&nbsp;<span class="ident" id="7400849">buf</span><span class="op" id="7400852">.</span><span class="ident" id="7400853">String</span><span class="op" id="7400859">(</span><span class="op" id="7400860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7400863">//&nbsp;Sanity&nbsp;check&nbsp;that&nbsp;the&nbsp;encoded&nbsp;JPEG&nbsp;is&nbsp;long&nbsp;enough,&nbsp;that&nbsp;it&nbsp;ends&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7400936">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker,&nbsp;and&nbsp;that&nbsp;it&nbsp;contains&nbsp;a&nbsp;&#34;\xff\xda&#34;&nbsp;SOS&nbsp;marker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7401008">//&nbsp;somewhere&nbsp;in&nbsp;the&nbsp;final&nbsp;64&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7401045">if</span>&nbsp;<span class="builtinfunc" id="7401048">len</span><span class="op" id="7401051">(</span><span class="ident" id="7401052">enc</span><span class="op" id="7401055">)</span>&nbsp;<span class="op" id="7401057">&lt;</span>&nbsp;<span class="num" id="7401059">64</span>&nbsp;<span class="op" id="7401062">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7401066">t</span><span class="op" id="7401067">.</span><span class="ident" id="7401068">Fatalf</span><span class="op" id="7401074">(</span><span class="string" id="7401075">&#34;encoded&nbsp;JPEG&nbsp;is&nbsp;too&nbsp;short:&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="7401112">,</span>&nbsp;<span class="builtinfunc" id="7401114">len</span><span class="op" id="7401117">(</span><span class="ident" id="7401118">enc</span><span class="op" id="7401121">)</span><span class="op" id="7401122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7401125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7401128">if</span>&nbsp;<span class="ident" id="7401131">got</span><span class="op" id="7401134">,</span>&nbsp;<span class="ident" id="7401136">want</span>&nbsp;<span class="op" id="7401141">:=</span>&nbsp;<span class="ident" id="7401144">enc</span><span class="op" id="7401147">[</span><span class="builtinfunc" id="7401148">len</span><span class="op" id="7401151">(</span><span class="ident" id="7401152">enc</span><span class="op" id="7401155">)</span><span class="op" id="7401156">-</span><span class="num" id="7401157">2</span><span class="op" id="7401158">:</span><span class="op" id="7401159">]</span><span class="op" id="7401160">,</span>&nbsp;<span class="string" id="7401162">&#34;\xff\xd9&#34;</span><span class="op" id="7401172">;</span>&nbsp;<span class="ident" id="7401174">got</span>&nbsp;<span class="op" id="7401178">!=</span>&nbsp;<span class="ident" id="7401181">want</span>&nbsp;<span class="op" id="7401186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7401190">t</span><span class="op" id="7401191">.</span><span class="ident" id="7401192">Fatalf</span><span class="op" id="7401198">(</span><span class="string" id="7401199">&#34;encoded&nbsp;JPEG&nbsp;ends&nbsp;with&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7401235">,</span>&nbsp;<span class="ident" id="7401237">got</span><span class="op" id="7401240">,</span>&nbsp;<span class="ident" id="7401242">want</span><span class="op" id="7401246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7401249">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7401252">if</span>&nbsp;<span class="ident" id="7401255">s</span>&nbsp;<span class="op" id="7401257">:=</span>&nbsp;<span class="ident" id="7401260">enc</span><span class="op" id="7401263">[</span><span class="builtinfunc" id="7401264">len</span><span class="op" id="7401267">(</span><span class="ident" id="7401268">enc</span><span class="op" id="7401271">)</span><span class="op" id="7401272">-</span><span class="num" id="7401273">64</span><span class="op" id="7401275">:</span><span class="op" id="7401276">]</span><span class="op" id="7401277">;</span>&nbsp;<span class="op" id="7401279">!</span><span class="ident" id="7401280">strings</span><span class="op" id="7401287">.</span><span class="ident" id="7401288">Contains</span><span class="op" id="7401296">(</span><span class="ident" id="7401297">s</span><span class="op" id="7401298">,</span>&nbsp;<span class="string" id="7401300">&#34;\xff\xda&#34;</span><span class="op" id="7401310">)</span>&nbsp;<span class="op" id="7401312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7401316">t</span><span class="op" id="7401317">.</span><span class="ident" id="7401318">Fatalf</span><span class="op" id="7401324">(</span><span class="string" id="7401325">&#34;encoded&nbsp;JPEG&nbsp;does&nbsp;not&nbsp;contain&nbsp;a&nbsp;SOS&nbsp;marker&nbsp;(ff&nbsp;da)&nbsp;near&nbsp;the&nbsp;end:&nbsp;%&nbsp;x&#34;</span><span class="op" id="7401395">,</span>&nbsp;<span class="ident" id="7401397">s</span><span class="op" id="7401398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7401401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7401404">//&nbsp;Test&nbsp;that&nbsp;adding&nbsp;some&nbsp;random&nbsp;junk&nbsp;between&nbsp;the&nbsp;SOS&nbsp;marker&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7401473">//&nbsp;EOI&nbsp;marker&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;decoding.</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7401518">rnd</span>&nbsp;<span class="op" id="7401522">:=</span>&nbsp;<span class="ident" id="7401525">rand</span><span class="op" id="7401529">.</span><span class="ident" id="7401530">New</span><span class="op" id="7401533">(</span><span class="ident" id="7401534">rand</span><span class="op" id="7401538">.</span><span class="ident" id="7401539">NewSource</span><span class="op" id="7401548">(</span><span class="num" id="7401549">1</span><span class="op" id="7401550">)</span><span class="op" id="7401551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7401554">for</span>&nbsp;<span class="ident" id="7401558">i</span><span class="op" id="7401559">,</span>&nbsp;<span class="ident" id="7401561">nerr</span>&nbsp;<span class="op" id="7401566">:=</span>&nbsp;<span class="num" id="7401569">0</span><span class="op" id="7401570">,</span>&nbsp;<span class="num" id="7401572">0</span><span class="op" id="7401573">;</span>&nbsp;<span class="ident" id="7401575">i</span>&nbsp;<span class="op" id="7401577">&lt;</span>&nbsp;<span class="num" id="7401579">1000</span>&nbsp;<span class="op" id="7401584">&amp;&amp;</span>&nbsp;<span class="ident" id="7401587">nerr</span>&nbsp;<span class="op" id="7401592">&lt;</span>&nbsp;<span class="num" id="7401594">10</span><span class="op" id="7401596">;</span>&nbsp;<span class="ident" id="7401598">i</span><span class="op" id="7401599">++</span>&nbsp;<span class="op" id="7401602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7401606">buf</span><span class="op" id="7401609">.</span><span class="ident" id="7401610">Reset</span><span class="op" id="7401615">(</span><span class="op" id="7401616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7401620">//&nbsp;Write&nbsp;all&nbsp;but&nbsp;the&nbsp;trailing&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7401675">buf</span><span class="op" id="7401678">.</span><span class="ident" id="7401679">WriteString</span><span class="op" id="7401690">(</span><span class="ident" id="7401691">enc</span><span class="op" id="7401694">[</span><span class="op" id="7401695">:</span><span class="builtinfunc" id="7401696">len</span><span class="op" id="7401699">(</span><span class="ident" id="7401700">enc</span><span class="op" id="7401703">)</span><span class="op" id="7401704">-</span><span class="num" id="7401705">2</span><span class="op" id="7401706">]</span><span class="op" id="7401707">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7401711">//&nbsp;Write&nbsp;some&nbsp;random&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7401751">for</span>&nbsp;<span class="ident" id="7401755">n</span>&nbsp;<span class="op" id="7401757">:=</span>&nbsp;<span class="ident" id="7401760">rnd</span><span class="op" id="7401763">.</span><span class="ident" id="7401764">Intn</span><span class="op" id="7401768">(</span><span class="num" id="7401769">10</span><span class="op" id="7401771">)</span><span class="op" id="7401772">;</span>&nbsp;<span class="ident" id="7401774">n</span>&nbsp;<span class="op" id="7401776">&gt;</span>&nbsp;<span class="num" id="7401778">0</span><span class="op" id="7401779">;</span>&nbsp;<span class="ident" id="7401781">n</span><span class="op" id="7401782">--</span>&nbsp;<span class="op" id="7401785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7401790">if</span>&nbsp;<span class="ident" id="7401793">x</span>&nbsp;<span class="op" id="7401795">:=</span>&nbsp;<span class="builtintype" id="7401798">byte</span><span class="op" id="7401802">(</span><span class="ident" id="7401803">rnd</span><span class="op" id="7401806">.</span><span class="ident" id="7401807">Intn</span><span class="op" id="7401811">(</span><span class="num" id="7401812">256</span><span class="op" id="7401815">)</span><span class="op" id="7401816">)</span><span class="op" id="7401817">;</span>&nbsp;<span class="ident" id="7401819">x</span>&nbsp;<span class="op" id="7401821">!=</span>&nbsp;<span class="num" id="7401824">0xff</span>&nbsp;<span class="op" id="7401829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7401835">buf</span><span class="op" id="7401838">.</span><span class="ident" id="7401839">WriteByte</span><span class="op" id="7401848">(</span><span class="ident" id="7401849">x</span><span class="op" id="7401850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7401855">}</span>&nbsp;<span class="keyword" id="7401857">else</span>&nbsp;<span class="op" id="7401862">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7401868">//&nbsp;The&nbsp;JPEG&nbsp;format&nbsp;escapes&nbsp;a&nbsp;SOS&nbsp;0xff&nbsp;data&nbsp;byte&nbsp;as&nbsp;&#34;\xff\x00&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7401935">buf</span><span class="op" id="7401938">.</span><span class="ident" id="7401939">WriteString</span><span class="op" id="7401950">(</span><span class="string" id="7401951">&#34;\xff\x00&#34;</span><span class="op" id="7401961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7401966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7401970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7401974">//&nbsp;Write&nbsp;the&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402012">buf</span><span class="op" id="7402015">.</span><span class="ident" id="7402016">WriteString</span><span class="op" id="7402027">(</span><span class="string" id="7402028">&#34;\xff\xd9&#34;</span><span class="op" id="7402038">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7402043">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;can&nbsp;still&nbsp;decode&nbsp;the&nbsp;resultant&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402100">got</span><span class="op" id="7402103">,</span>&nbsp;<span class="ident" id="7402105">err</span>&nbsp;<span class="op" id="7402109">:=</span>&nbsp;<span class="ident" id="7402112">Decode</span><span class="op" id="7402118">(</span><span class="ident" id="7402119">buf</span><span class="op" id="7402122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7402126">if</span>&nbsp;<span class="ident" id="7402129">err</span>&nbsp;<span class="op" id="7402133">!=</span>&nbsp;<span class="ident" id="7402136">nil</span>&nbsp;<span class="op" id="7402140">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402145">t</span><span class="op" id="7402146">.</span><span class="ident" id="7402147">Errorf</span><span class="op" id="7402153">(</span><span class="string" id="7402154">&#34;could&nbsp;not&nbsp;decode&nbsp;image&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="7402186">,</span>&nbsp;<span class="ident" id="7402188">i</span><span class="op" id="7402189">,</span>&nbsp;<span class="ident" id="7402191">err</span><span class="op" id="7402194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402199">nerr</span><span class="op" id="7402203">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7402209">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7402224">if</span>&nbsp;<span class="ident" id="7402227">got</span><span class="op" id="7402230">.</span><span class="ident" id="7402231">Bounds</span><span class="op" id="7402237">(</span><span class="op" id="7402238">)</span>&nbsp;<span class="op" id="7402240">!=</span>&nbsp;<span class="ident" id="7402243">src</span><span class="op" id="7402246">.</span><span class="ident" id="7402247">Bounds</span><span class="op" id="7402253">(</span><span class="op" id="7402254">)</span>&nbsp;<span class="op" id="7402256">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402261">t</span><span class="op" id="7402262">.</span><span class="ident" id="7402263">Errorf</span><span class="op" id="7402269">(</span><span class="string" id="7402270">&#34;image&nbsp;#%d,&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7402307">,</span>&nbsp;<span class="ident" id="7402309">i</span><span class="op" id="7402310">,</span>&nbsp;<span class="ident" id="7402312">got</span><span class="op" id="7402315">.</span><span class="ident" id="7402316">Bounds</span><span class="op" id="7402322">(</span><span class="op" id="7402323">)</span><span class="op" id="7402324">,</span>&nbsp;<span class="ident" id="7402326">src</span><span class="op" id="7402329">.</span><span class="ident" id="7402330">Bounds</span><span class="op" id="7402336">(</span><span class="op" id="7402337">)</span><span class="op" id="7402338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402343">nerr</span><span class="op" id="7402347">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7402353">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7402368">if</span>&nbsp;<span class="ident" id="7402371">averageDelta</span><span class="op" id="7402383">(</span><span class="ident" id="7402384">got</span><span class="op" id="7402387">,</span>&nbsp;<span class="ident" id="7402389">src</span><span class="op" id="7402392">)</span>&nbsp;<span class="op" id="7402394">&gt;</span>&nbsp;<span class="num" id="7402396">2</span><span class="op" id="7402397">&lt;&lt;</span><span class="num" id="7402399">8</span>&nbsp;<span class="op" id="7402401">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402406">t</span><span class="op" id="7402407">.</span><span class="ident" id="7402408">Errorf</span><span class="op" id="7402414">(</span><span class="string" id="7402415">&#34;image&nbsp;#%d&nbsp;changed&nbsp;too&nbsp;much&nbsp;after&nbsp;a&nbsp;round&nbsp;trip&#34;</span><span class="op" id="7402462">,</span>&nbsp;<span class="ident" id="7402464">i</span><span class="op" id="7402465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402470">nerr</span><span class="op" id="7402474">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7402480">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402494">}</span><br>
<span class="lineno">245</span><span class="op" id="7402496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7402499">func</span>&nbsp;<span class="ident" id="7402504">benchmarkDecode</span><span class="op" id="7402519">(</span><span class="ident" id="7402520">b</span>&nbsp;<span class="op" id="7402522">*</span><span class="ident" id="7402523">testing</span><span class="op" id="7402530">.</span><span class="ident" id="7402531">B</span><span class="op" id="7402532">,</span>&nbsp;<span class="ident" id="7402534">filename</span>&nbsp;<span class="builtintype" id="7402543">string</span><span class="op" id="7402549">)</span>&nbsp;<span class="op" id="7402551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402554">b</span><span class="op" id="7402555">.</span><span class="ident" id="7402556">StopTimer</span><span class="op" id="7402565">(</span><span class="op" id="7402566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402569">data</span><span class="op" id="7402573">,</span>&nbsp;<span class="ident" id="7402575">err</span>&nbsp;<span class="op" id="7402579">:=</span>&nbsp;<span class="ident" id="7402582">ioutil</span><span class="op" id="7402588">.</span><span class="ident" id="7402589">ReadFile</span><span class="op" id="7402597">(</span><span class="ident" id="7402598">filename</span><span class="op" id="7402606">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7402609">if</span>&nbsp;<span class="ident" id="7402612">err</span>&nbsp;<span class="op" id="7402616">!=</span>&nbsp;<span class="ident" id="7402619">nil</span>&nbsp;<span class="op" id="7402623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402627">b</span><span class="op" id="7402628">.</span><span class="ident" id="7402629">Fatal</span><span class="op" id="7402634">(</span><span class="ident" id="7402635">err</span><span class="op" id="7402638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402644">cfg</span><span class="op" id="7402647">,</span>&nbsp;<span class="ident" id="7402649">err</span>&nbsp;<span class="op" id="7402653">:=</span>&nbsp;<span class="ident" id="7402656">DecodeConfig</span><span class="op" id="7402668">(</span><span class="ident" id="7402669">bytes</span><span class="op" id="7402674">.</span><span class="ident" id="7402675">NewReader</span><span class="op" id="7402684">(</span><span class="ident" id="7402685">data</span><span class="op" id="7402689">)</span><span class="op" id="7402690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7402693">if</span>&nbsp;<span class="ident" id="7402696">err</span>&nbsp;<span class="op" id="7402700">!=</span>&nbsp;<span class="ident" id="7402703">nil</span>&nbsp;<span class="op" id="7402707">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402711">b</span><span class="op" id="7402712">.</span><span class="ident" id="7402713">Fatal</span><span class="op" id="7402718">(</span><span class="ident" id="7402719">err</span><span class="op" id="7402722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402728">b</span><span class="op" id="7402729">.</span><span class="ident" id="7402730">SetBytes</span><span class="op" id="7402738">(</span><span class="ident" id="7402739">int64</span><span class="op" id="7402744">(</span><span class="ident" id="7402745">cfg</span><span class="op" id="7402748">.</span><span class="ident" id="7402749">Width</span>&nbsp;<span class="op" id="7402755">*</span>&nbsp;<span class="ident" id="7402757">cfg</span><span class="op" id="7402760">.</span><span class="ident" id="7402761">Height</span>&nbsp;<span class="op" id="7402768">*</span>&nbsp;<span class="num" id="7402770">4</span><span class="op" id="7402771">)</span><span class="op" id="7402772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402775">b</span><span class="op" id="7402776">.</span><span class="ident" id="7402777">StartTimer</span><span class="op" id="7402787">(</span><span class="op" id="7402788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7402791">for</span>&nbsp;<span class="ident" id="7402795">i</span>&nbsp;<span class="op" id="7402797">:=</span>&nbsp;<span class="num" id="7402800">0</span><span class="op" id="7402801">;</span>&nbsp;<span class="ident" id="7402803">i</span>&nbsp;<span class="op" id="7402805">&lt;</span>&nbsp;<span class="ident" id="7402807">b</span><span class="op" id="7402808">.</span><span class="ident" id="7402809">N</span><span class="op" id="7402810">;</span>&nbsp;<span class="ident" id="7402812">i</span><span class="op" id="7402813">++</span>&nbsp;<span class="op" id="7402816">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402820">Decode</span><span class="op" id="7402826">(</span><span class="ident" id="7402827">bytes</span><span class="op" id="7402832">.</span><span class="ident" id="7402833">NewReader</span><span class="op" id="7402842">(</span><span class="ident" id="7402843">data</span><span class="op" id="7402847">)</span><span class="op" id="7402848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402851">}</span><br>
<span class="lineno"></span><span class="op" id="7402853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7402856">func</span>&nbsp;<span class="ident" id="7402861">BenchmarkDecodeBaseline</span><span class="op" id="7402884">(</span><span class="ident" id="7402885">b</span>&nbsp;<span class="op" id="7402887">*</span><span class="ident" id="7402888">testing</span><span class="op" id="7402895">.</span><span class="ident" id="7402896">B</span><span class="op" id="7402897">)</span>&nbsp;<span class="op" id="7402899">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402902">benchmarkDecode</span><span class="op" id="7402917">(</span><span class="ident" id="7402918">b</span><span class="op" id="7402919">,</span>&nbsp;<span class="string" id="7402921">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7402949">)</span><br>
<span class="lineno"></span><span class="op" id="7402951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7402954">func</span>&nbsp;<span class="ident" id="7402959">BenchmarkDecodeProgressive</span><span class="op" id="7402985">(</span><span class="ident" id="7402986">b</span>&nbsp;<span class="op" id="7402988">*</span><span class="ident" id="7402989">testing</span><span class="op" id="7402996">.</span><span class="ident" id="7402997">B</span><span class="op" id="7402998">)</span>&nbsp;<span class="op" id="7403000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7403003">benchmarkDecode</span><span class="op" id="7403018">(</span><span class="ident" id="7403019">b</span><span class="op" id="7403020">,</span>&nbsp;<span class="string" id="7403022">&#34;../testdata/video-001.progressive.jpeg&#34;</span><span class="op" id="7403062">)</span><br>
<span class="lineno">270</span><span class="op" id="7403064">}</span>
</div>
</body>
</html>
