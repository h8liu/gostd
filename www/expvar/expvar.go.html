<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5110333">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5110388">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5110442">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5110493">//&nbsp;Package&nbsp;expvar&nbsp;provides&nbsp;a&nbsp;standardized&nbsp;interface&nbsp;to&nbsp;public&nbsp;variables,&nbsp;such</span><br>
<span class="lineno"></span><span class="comment" id="5110571">//&nbsp;as&nbsp;operation&nbsp;counters&nbsp;in&nbsp;servers.&nbsp;It&nbsp;exposes&nbsp;these&nbsp;variables&nbsp;via&nbsp;HTTP&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5110647">//&nbsp;/debug/vars&nbsp;in&nbsp;JSON&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="5110678">//</span><br>
<span class="lineno"></span><span class="comment" id="5110681">//&nbsp;Operations&nbsp;to&nbsp;set&nbsp;or&nbsp;modify&nbsp;these&nbsp;public&nbsp;variables&nbsp;are&nbsp;atomic.</span><br>
<span class="lineno">10</span><span class="comment" id="5110747">//</span><br>
<span class="lineno"></span><span class="comment" id="5110750">//&nbsp;In&nbsp;addition&nbsp;to&nbsp;adding&nbsp;the&nbsp;HTTP&nbsp;handler,&nbsp;this&nbsp;package&nbsp;registers&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5110820">//&nbsp;following&nbsp;variables:</span><br>
<span class="lineno"></span><span class="comment" id="5110844">//</span><br>
<span class="lineno"></span><span class="comment" id="5110847">//&nbsp;&nbsp;&nbsp;&nbspcmdline&nbsp;&nbsp;&nbsp;os.Args</span><br>
<span class="lineno">15</span><span class="comment" id="5110868">//&nbsp;&nbsp;&nbsp;&nbspmemstats&nbsp;&nbsp;runtime.Memstats</span><br>
<span class="lineno"></span><span class="comment" id="5110898">//</span><br>
<span class="lineno"></span><span class="comment" id="5110901">//&nbsp;The&nbsp;package&nbsp;is&nbsp;sometimes&nbsp;only&nbsp;imported&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5110966">//&nbsp;registering&nbsp;its&nbsp;HTTP&nbsp;handler&nbsp;and&nbsp;the&nbsp;above&nbsp;variables.&nbsp;&nbsp;To&nbsp;use&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5111034">//&nbsp;this&nbsp;way,&nbsp;link&nbsp;this&nbsp;package&nbsp;into&nbsp;your&nbsp;program:</span><br>
<span class="lineno">20</span><span class="comment" id="5111084">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;_&nbsp;&#34;expvar&#34;</span><br>
<span class="lineno"></span><span class="comment" id="5111105">//</span><br>
<span class="lineno"></span><span class="keyword" id="5111108">package</span>&nbsp;<span class="ident" id="5111116">expvar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5111124">import</span>&nbsp;<span class="op" id="5111131">(</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5111134">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5111143">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5111160">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5111167">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5111174">&#34;net/http&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5111186">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5111192">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5111203">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5111211">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5111222">&#34;sync&#34;</span><br>
<span class="lineno">35</span><span class="op" id="5111229">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5111232">//&nbsp;Var&nbsp;is&nbsp;an&nbsp;abstract&nbsp;type&nbsp;for&nbsp;all&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5111287">type</span>&nbsp;<span class="ident" id="5111292">Var</span>&nbsp;<span class="keyword" id="5111296">interface</span>&nbsp;<span class="op" id="5111306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111309">String</span><span class="op" id="5111315">(</span><span class="op" id="5111316">)</span>&nbsp;<span class="builtintype" id="5111318">string</span><br>
<span class="lineno">40</span><span class="op" id="5111325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5111328">//&nbsp;Int&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;integer&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5111398">type</span>&nbsp;<span class="ident" id="5111403">Int</span>&nbsp;<span class="keyword" id="5111407">struct</span>&nbsp;<span class="op" id="5111414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111417">mu</span>&nbsp;<span class="ident" id="5111420">sync</span><span class="op" id="5111424">.</span><span class="ident" id="5111425">RWMutex</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111434">i</span>&nbsp;&nbsp;<span class="ident" id="5111437">int64</span><br>
<span class="lineno"></span><span class="op" id="5111443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5111446">func</span>&nbsp;<span class="op" id="5111451">(</span><span class="ident" id="5111452">v</span>&nbsp;<span class="op" id="5111454">*</span><span class="ident" id="5111455">Int</span><span class="op" id="5111458">)</span>&nbsp;<span class="ident" id="5111460">String</span><span class="op" id="5111466">(</span><span class="op" id="5111467">)</span>&nbsp;<span class="builtintype" id="5111469">string</span>&nbsp;<span class="op" id="5111476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111479">v</span><span class="op" id="5111480">.</span><span class="ident" id="5111481">mu</span><span class="op" id="5111483">.</span><span class="ident" id="5111484">RLock</span><span class="op" id="5111489">(</span><span class="op" id="5111490">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111493">defer</span>&nbsp;<span class="ident" id="5111499">v</span><span class="op" id="5111500">.</span><span class="ident" id="5111501">mu</span><span class="op" id="5111503">.</span><span class="ident" id="5111504">RUnlock</span><span class="op" id="5111511">(</span><span class="op" id="5111512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111515">return</span>&nbsp;<span class="ident" id="5111522">strconv</span><span class="op" id="5111529">.</span><span class="ident" id="5111530">FormatInt</span><span class="op" id="5111539">(</span><span class="ident" id="5111540">v</span><span class="op" id="5111541">.</span><span class="ident" id="5111542">i</span><span class="op" id="5111543">,</span>&nbsp;<span class="num" id="5111545">10</span><span class="op" id="5111547">)</span><br>
<span class="lineno"></span><span class="op" id="5111549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5111552">func</span>&nbsp;<span class="op" id="5111557">(</span><span class="ident" id="5111558">v</span>&nbsp;<span class="op" id="5111560">*</span><span class="ident" id="5111561">Int</span><span class="op" id="5111564">)</span>&nbsp;<span class="ident" id="5111566">Add</span><span class="op" id="5111569">(</span><span class="ident" id="5111570">delta</span>&nbsp;<span class="ident" id="5111576">int64</span><span class="op" id="5111581">)</span>&nbsp;<span class="op" id="5111583">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111586">v</span><span class="op" id="5111587">.</span><span class="ident" id="5111588">mu</span><span class="op" id="5111590">.</span><span class="ident" id="5111591">Lock</span><span class="op" id="5111595">(</span><span class="op" id="5111596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111599">defer</span>&nbsp;<span class="ident" id="5111605">v</span><span class="op" id="5111606">.</span><span class="ident" id="5111607">mu</span><span class="op" id="5111609">.</span><span class="ident" id="5111610">Unlock</span><span class="op" id="5111616">(</span><span class="op" id="5111617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111620">v</span><span class="op" id="5111621">.</span><span class="ident" id="5111622">i</span>&nbsp;<span class="op" id="5111624">+=</span>&nbsp;<span class="ident" id="5111627">delta</span><br>
<span class="lineno"></span><span class="op" id="5111633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="5111636">func</span>&nbsp;<span class="op" id="5111641">(</span><span class="ident" id="5111642">v</span>&nbsp;<span class="op" id="5111644">*</span><span class="ident" id="5111645">Int</span><span class="op" id="5111648">)</span>&nbsp;<span class="ident" id="5111650">Set</span><span class="op" id="5111653">(</span><span class="ident" id="5111654">value</span>&nbsp;<span class="ident" id="5111660">int64</span><span class="op" id="5111665">)</span>&nbsp;<span class="op" id="5111667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111670">v</span><span class="op" id="5111671">.</span><span class="ident" id="5111672">mu</span><span class="op" id="5111674">.</span><span class="ident" id="5111675">Lock</span><span class="op" id="5111679">(</span><span class="op" id="5111680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111683">defer</span>&nbsp;<span class="ident" id="5111689">v</span><span class="op" id="5111690">.</span><span class="ident" id="5111691">mu</span><span class="op" id="5111693">.</span><span class="ident" id="5111694">Unlock</span><span class="op" id="5111700">(</span><span class="op" id="5111701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111704">v</span><span class="op" id="5111705">.</span><span class="ident" id="5111706">i</span>&nbsp;<span class="op" id="5111708">=</span>&nbsp;<span class="ident" id="5111710">value</span><br>
<span class="lineno"></span><span class="op" id="5111716">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="5111719">//&nbsp;Float&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;float&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5111789">type</span>&nbsp;<span class="ident" id="5111794">Float</span>&nbsp;<span class="keyword" id="5111800">struct</span>&nbsp;<span class="op" id="5111807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111810">mu</span>&nbsp;<span class="ident" id="5111813">sync</span><span class="op" id="5111817">.</span><span class="ident" id="5111818">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111827">f</span>&nbsp;&nbsp;<span class="builtintype" id="5111830">float64</span><br>
<span class="lineno">70</span><span class="op" id="5111838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5111841">func</span>&nbsp;<span class="op" id="5111846">(</span><span class="ident" id="5111847">v</span>&nbsp;<span class="op" id="5111849">*</span><span class="ident" id="5111850">Float</span><span class="op" id="5111855">)</span>&nbsp;<span class="ident" id="5111857">String</span><span class="op" id="5111863">(</span><span class="op" id="5111864">)</span>&nbsp;<span class="builtintype" id="5111866">string</span>&nbsp;<span class="op" id="5111873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111876">v</span><span class="op" id="5111877">.</span><span class="ident" id="5111878">mu</span><span class="op" id="5111880">.</span><span class="ident" id="5111881">RLock</span><span class="op" id="5111886">(</span><span class="op" id="5111887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111890">defer</span>&nbsp;<span class="ident" id="5111896">v</span><span class="op" id="5111897">.</span><span class="ident" id="5111898">mu</span><span class="op" id="5111900">.</span><span class="ident" id="5111901">RUnlock</span><span class="op" id="5111908">(</span><span class="op" id="5111909">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111912">return</span>&nbsp;<span class="ident" id="5111919">strconv</span><span class="op" id="5111926">.</span><span class="ident" id="5111927">FormatFloat</span><span class="op" id="5111938">(</span><span class="ident" id="5111939">v</span><span class="op" id="5111940">.</span><span class="ident" id="5111941">f</span><span class="op" id="5111942">,</span>&nbsp;<span class="string" id="5111944">&#39;g&#39;</span><span class="op" id="5111947">,</span>&nbsp;<span class="op" id="5111949">-</span><span class="num" id="5111950">1</span><span class="op" id="5111951">,</span>&nbsp;<span class="num" id="5111953">64</span><span class="op" id="5111955">)</span><br>
<span class="lineno"></span><span class="op" id="5111957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5111960">//&nbsp;Add&nbsp;adds&nbsp;delta&nbsp;to&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5111984">func</span>&nbsp;<span class="op" id="5111989">(</span><span class="ident" id="5111990">v</span>&nbsp;<span class="op" id="5111992">*</span><span class="ident" id="5111993">Float</span><span class="op" id="5111998">)</span>&nbsp;<span class="ident" id="5112000">Add</span><span class="op" id="5112003">(</span><span class="ident" id="5112004">delta</span>&nbsp;<span class="builtintype" id="5112010">float64</span><span class="op" id="5112017">)</span>&nbsp;<span class="op" id="5112019">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112022">v</span><span class="op" id="5112023">.</span><span class="ident" id="5112024">mu</span><span class="op" id="5112026">.</span><span class="ident" id="5112027">Lock</span><span class="op" id="5112031">(</span><span class="op" id="5112032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112035">defer</span>&nbsp;<span class="ident" id="5112041">v</span><span class="op" id="5112042">.</span><span class="ident" id="5112043">mu</span><span class="op" id="5112045">.</span><span class="ident" id="5112046">Unlock</span><span class="op" id="5112052">(</span><span class="op" id="5112053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112056">v</span><span class="op" id="5112057">.</span><span class="ident" id="5112058">f</span>&nbsp;<span class="op" id="5112060">+=</span>&nbsp;<span class="ident" id="5112063">delta</span><br>
<span class="lineno"></span><span class="op" id="5112069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="5112072">//&nbsp;Set&nbsp;sets&nbsp;v&nbsp;to&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5112096">func</span>&nbsp;<span class="op" id="5112101">(</span><span class="ident" id="5112102">v</span>&nbsp;<span class="op" id="5112104">*</span><span class="ident" id="5112105">Float</span><span class="op" id="5112110">)</span>&nbsp;<span class="ident" id="5112112">Set</span><span class="op" id="5112115">(</span><span class="ident" id="5112116">value</span>&nbsp;<span class="builtintype" id="5112122">float64</span><span class="op" id="5112129">)</span>&nbsp;<span class="op" id="5112131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112134">v</span><span class="op" id="5112135">.</span><span class="ident" id="5112136">mu</span><span class="op" id="5112138">.</span><span class="ident" id="5112139">Lock</span><span class="op" id="5112143">(</span><span class="op" id="5112144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112147">defer</span>&nbsp;<span class="ident" id="5112153">v</span><span class="op" id="5112154">.</span><span class="ident" id="5112155">mu</span><span class="op" id="5112157">.</span><span class="ident" id="5112158">Unlock</span><span class="op" id="5112164">(</span><span class="op" id="5112165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112168">v</span><span class="op" id="5112169">.</span><span class="ident" id="5112170">f</span>&nbsp;<span class="op" id="5112172">=</span>&nbsp;<span class="ident" id="5112174">value</span><br>
<span class="lineno">90</span><span class="op" id="5112180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5112183">//&nbsp;Map&nbsp;is&nbsp;a&nbsp;string-to-Var&nbsp;map&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5112256">type</span>&nbsp;<span class="ident" id="5112261">Map</span>&nbsp;<span class="keyword" id="5112265">struct</span>&nbsp;<span class="op" id="5112272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112275">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5112280">sync</span><span class="op" id="5112284">.</span><span class="ident" id="5112285">RWMutex</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112294">m</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5112299">map</span><span class="op" id="5112302">[</span><span class="builtintype" id="5112303">string</span><span class="op" id="5112309">]</span><span class="ident" id="5112310">Var</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112315">keys</span>&nbsp;<span class="op" id="5112320">[</span><span class="op" id="5112321">]</span><span class="builtintype" id="5112322">string</span>&nbsp;<span class="comment" id="5112329">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="5112339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5112342">//&nbsp;KeyValue&nbsp;represents&nbsp;a&nbsp;single&nbsp;entry&nbsp;in&nbsp;a&nbsp;Map.</span><br>
<span class="lineno">100</span><span class="keyword" id="5112390">type</span>&nbsp;<span class="ident" id="5112395">KeyValue</span>&nbsp;<span class="keyword" id="5112404">struct</span>&nbsp;<span class="op" id="5112411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112414">Key</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5112420">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112428">Value</span>&nbsp;<span class="ident" id="5112434">Var</span><br>
<span class="lineno"></span><span class="op" id="5112438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="5112441">func</span>&nbsp;<span class="op" id="5112446">(</span><span class="ident" id="5112447">v</span>&nbsp;<span class="op" id="5112449">*</span><span class="ident" id="5112450">Map</span><span class="op" id="5112453">)</span>&nbsp;<span class="ident" id="5112455">String</span><span class="op" id="5112461">(</span><span class="op" id="5112462">)</span>&nbsp;<span class="builtintype" id="5112464">string</span>&nbsp;<span class="op" id="5112471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112474">v</span><span class="op" id="5112475">.</span><span class="ident" id="5112476">mu</span><span class="op" id="5112478">.</span><span class="ident" id="5112479">RLock</span><span class="op" id="5112484">(</span><span class="op" id="5112485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112488">defer</span>&nbsp;<span class="ident" id="5112494">v</span><span class="op" id="5112495">.</span><span class="ident" id="5112496">mu</span><span class="op" id="5112498">.</span><span class="ident" id="5112499">RUnlock</span><span class="op" id="5112506">(</span><span class="op" id="5112507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112510">var</span>&nbsp;<span class="ident" id="5112514">b</span>&nbsp;<span class="ident" id="5112516">bytes</span><span class="op" id="5112521">.</span><span class="ident" id="5112522">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112530">fmt</span><span class="op" id="5112533">.</span><span class="ident" id="5112534">Fprintf</span><span class="op" id="5112541">(</span><span class="op" id="5112542">&amp;</span><span class="ident" id="5112543">b</span><span class="op" id="5112544">,</span>&nbsp;<span class="string" id="5112546">&#34;{&#34;</span><span class="op" id="5112549">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112552">first</span>&nbsp;<span class="op" id="5112558">:=</span>&nbsp;<span class="ident" id="5112561">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112567">v</span><span class="op" id="5112568">.</span><span class="ident" id="5112569">doLocked</span><span class="op" id="5112577">(</span><span class="keyword" id="5112578">func</span><span class="op" id="5112582">(</span><span class="ident" id="5112583">kv</span>&nbsp;<span class="ident" id="5112586">KeyValue</span><span class="op" id="5112594">)</span>&nbsp;<span class="op" id="5112596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112600">if</span>&nbsp;<span class="op" id="5112603">!</span><span class="ident" id="5112604">first</span>&nbsp;<span class="op" id="5112610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112615">fmt</span><span class="op" id="5112618">.</span><span class="ident" id="5112619">Fprintf</span><span class="op" id="5112626">(</span><span class="op" id="5112627">&amp;</span><span class="ident" id="5112628">b</span><span class="op" id="5112629">,</span>&nbsp;<span class="string" id="5112631">&#34;,&nbsp;&#34;</span><span class="op" id="5112635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5112639">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112643">fmt</span><span class="op" id="5112646">.</span><span class="ident" id="5112647">Fprintf</span><span class="op" id="5112654">(</span><span class="op" id="5112655">&amp;</span><span class="ident" id="5112656">b</span><span class="op" id="5112657">,</span>&nbsp;<span class="string" id="5112659">&#34;%q:&nbsp;%v&#34;</span><span class="op" id="5112667">,</span>&nbsp;<span class="ident" id="5112669">kv</span><span class="op" id="5112671">.</span><span class="ident" id="5112672">Key</span><span class="op" id="5112675">,</span>&nbsp;<span class="ident" id="5112677">kv</span><span class="op" id="5112679">.</span><span class="ident" id="5112680">Value</span><span class="op" id="5112685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112689">first</span>&nbsp;<span class="op" id="5112695">=</span>&nbsp;<span class="ident" id="5112697">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5112704">}</span><span class="op" id="5112705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112708">fmt</span><span class="op" id="5112711">.</span><span class="ident" id="5112712">Fprintf</span><span class="op" id="5112719">(</span><span class="op" id="5112720">&amp;</span><span class="ident" id="5112721">b</span><span class="op" id="5112722">,</span>&nbsp;<span class="string" id="5112724">&#34;}&#34;</span><span class="op" id="5112727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112730">return</span>&nbsp;<span class="ident" id="5112737">b</span><span class="op" id="5112738">.</span><span class="ident" id="5112739">String</span><span class="op" id="5112745">(</span><span class="op" id="5112746">)</span><br>
<span class="lineno">120</span><span class="op" id="5112748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5112751">func</span>&nbsp;<span class="op" id="5112756">(</span><span class="ident" id="5112757">v</span>&nbsp;<span class="op" id="5112759">*</span><span class="ident" id="5112760">Map</span><span class="op" id="5112763">)</span>&nbsp;<span class="ident" id="5112765">Init</span><span class="op" id="5112769">(</span><span class="op" id="5112770">)</span>&nbsp;<span class="op" id="5112772">*</span><span class="ident" id="5112773">Map</span>&nbsp;<span class="op" id="5112777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112780">v</span><span class="op" id="5112781">.</span><span class="ident" id="5112782">m</span>&nbsp;<span class="op" id="5112784">=</span>&nbsp;<span class="builtinfunc" id="5112786">make</span><span class="op" id="5112790">(</span><span class="keyword" id="5112791">map</span><span class="op" id="5112794">[</span><span class="builtintype" id="5112795">string</span><span class="op" id="5112801">]</span><span class="ident" id="5112802">Var</span><span class="op" id="5112805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112808">return</span>&nbsp;<span class="ident" id="5112815">v</span><br>
<span class="lineno">125</span><span class="op" id="5112817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5112820">//&nbsp;updateKeys&nbsp;updates&nbsp;the&nbsp;sorted&nbsp;list&nbsp;of&nbsp;keys&nbsp;in&nbsp;v.keys.</span><br>
<span class="lineno"></span><span class="comment" id="5112877">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;v.mu&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="5112911">func</span>&nbsp;<span class="op" id="5112916">(</span><span class="ident" id="5112917">v</span>&nbsp;<span class="op" id="5112919">*</span><span class="ident" id="5112920">Map</span><span class="op" id="5112923">)</span>&nbsp;<span class="ident" id="5112925">updateKeys</span><span class="op" id="5112935">(</span><span class="op" id="5112936">)</span>&nbsp;<span class="op" id="5112938">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112941">if</span>&nbsp;<span class="builtinfunc" id="5112944">len</span><span class="op" id="5112947">(</span><span class="ident" id="5112948">v</span><span class="op" id="5112949">.</span><span class="ident" id="5112950">m</span><span class="op" id="5112951">)</span>&nbsp;<span class="op" id="5112953">==</span>&nbsp;<span class="builtinfunc" id="5112956">len</span><span class="op" id="5112959">(</span><span class="ident" id="5112960">v</span><span class="op" id="5112961">.</span><span class="ident" id="5112962">keys</span><span class="op" id="5112966">)</span>&nbsp;<span class="op" id="5112968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5112972">//&nbsp;No&nbsp;new&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112989">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5112997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113000">v</span><span class="op" id="5113001">.</span><span class="ident" id="5113002">keys</span>&nbsp;<span class="op" id="5113007">=</span>&nbsp;<span class="ident" id="5113009">v</span><span class="op" id="5113010">.</span><span class="ident" id="5113011">keys</span><span class="op" id="5113015">[</span><span class="op" id="5113016">:</span><span class="num" id="5113017">0</span><span class="op" id="5113018">]</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5113021">for</span>&nbsp;<span class="ident" id="5113025">k</span>&nbsp;<span class="op" id="5113027">:=</span>&nbsp;<span class="keyword" id="5113030">range</span>&nbsp;<span class="ident" id="5113036">v</span><span class="op" id="5113037">.</span><span class="ident" id="5113038">m</span>&nbsp;<span class="op" id="5113040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113044">v</span><span class="op" id="5113045">.</span><span class="ident" id="5113046">keys</span>&nbsp;<span class="op" id="5113051">=</span>&nbsp;<span class="builtinfunc" id="5113053">append</span><span class="op" id="5113059">(</span><span class="ident" id="5113060">v</span><span class="op" id="5113061">.</span><span class="ident" id="5113062">keys</span><span class="op" id="5113066">,</span>&nbsp;<span class="ident" id="5113068">k</span><span class="op" id="5113069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5113072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113075">sort</span><span class="op" id="5113079">.</span><span class="ident" id="5113080">Strings</span><span class="op" id="5113087">(</span><span class="ident" id="5113088">v</span><span class="op" id="5113089">.</span><span class="ident" id="5113090">keys</span><span class="op" id="5113094">)</span><br>
<span class="lineno"></span><span class="op" id="5113096">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="5113099">func</span>&nbsp;<span class="op" id="5113104">(</span><span class="ident" id="5113105">v</span>&nbsp;<span class="op" id="5113107">*</span><span class="ident" id="5113108">Map</span><span class="op" id="5113111">)</span>&nbsp;<span class="ident" id="5113113">Get</span><span class="op" id="5113116">(</span><span class="ident" id="5113117">key</span>&nbsp;<span class="builtintype" id="5113121">string</span><span class="op" id="5113127">)</span>&nbsp;<span class="ident" id="5113129">Var</span>&nbsp;<span class="op" id="5113133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113136">v</span><span class="op" id="5113137">.</span><span class="ident" id="5113138">mu</span><span class="op" id="5113140">.</span><span class="ident" id="5113141">RLock</span><span class="op" id="5113146">(</span><span class="op" id="5113147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5113150">defer</span>&nbsp;<span class="ident" id="5113156">v</span><span class="op" id="5113157">.</span><span class="ident" id="5113158">mu</span><span class="op" id="5113160">.</span><span class="ident" id="5113161">RUnlock</span><span class="op" id="5113168">(</span><span class="op" id="5113169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5113172">return</span>&nbsp;<span class="ident" id="5113179">v</span><span class="op" id="5113180">.</span><span class="ident" id="5113181">m</span><span class="op" id="5113182">[</span><span class="ident" id="5113183">key</span><span class="op" id="5113186">]</span><br>
<span class="lineno">145</span><span class="op" id="5113188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5113191">func</span>&nbsp;<span class="op" id="5113196">(</span><span class="ident" id="5113197">v</span>&nbsp;<span class="op" id="5113199">*</span><span class="ident" id="5113200">Map</span><span class="op" id="5113203">)</span>&nbsp;<span class="ident" id="5113205">Set</span><span class="op" id="5113208">(</span><span class="ident" id="5113209">key</span>&nbsp;<span class="builtintype" id="5113213">string</span><span class="op" id="5113219">,</span>&nbsp;<span class="ident" id="5113221">av</span>&nbsp;<span class="ident" id="5113224">Var</span><span class="op" id="5113227">)</span>&nbsp;<span class="op" id="5113229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113232">v</span><span class="op" id="5113233">.</span><span class="ident" id="5113234">mu</span><span class="op" id="5113236">.</span><span class="ident" id="5113237">Lock</span><span class="op" id="5113241">(</span><span class="op" id="5113242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5113245">defer</span>&nbsp;<span class="ident" id="5113251">v</span><span class="op" id="5113252">.</span><span class="ident" id="5113253">mu</span><span class="op" id="5113255">.</span><span class="ident" id="5113256">Unlock</span><span class="op" id="5113262">(</span><span class="op" id="5113263">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113266">v</span><span class="op" id="5113267">.</span><span class="ident" id="5113268">m</span><span class="op" id="5113269">[</span><span class="ident" id="5113270">key</span><span class="op" id="5113273">]</span>&nbsp;<span class="op" id="5113275">=</span>&nbsp;<span class="ident" id="5113277">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113281">v</span><span class="op" id="5113282">.</span><span class="ident" id="5113283">updateKeys</span><span class="op" id="5113293">(</span><span class="op" id="5113294">)</span><br>
<span class="lineno"></span><span class="op" id="5113296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5113299">func</span>&nbsp;<span class="op" id="5113304">(</span><span class="ident" id="5113305">v</span>&nbsp;<span class="op" id="5113307">*</span><span class="ident" id="5113308">Map</span><span class="op" id="5113311">)</span>&nbsp;<span class="ident" id="5113313">Add</span><span class="op" id="5113316">(</span><span class="ident" id="5113317">key</span>&nbsp;<span class="builtintype" id="5113321">string</span><span class="op" id="5113327">,</span>&nbsp;<span class="ident" id="5113329">delta</span>&nbsp;<span class="ident" id="5113335">int64</span><span class="op" id="5113340">)</span>&nbsp;<span class="op" id="5113342">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113345">v</span><span class="op" id="5113346">.</span><span class="ident" id="5113347">mu</span><span class="op" id="5113349">.</span><span class="ident" id="5113350">RLock</span><span class="op" id="5113355">(</span><span class="op" id="5113356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113359">av</span><span class="op" id="5113361">,</span>&nbsp;<span class="ident" id="5113363">ok</span>&nbsp;<span class="op" id="5113366">:=</span>&nbsp;<span class="ident" id="5113369">v</span><span class="op" id="5113370">.</span><span class="ident" id="5113371">m</span><span class="op" id="5113372">[</span><span class="ident" id="5113373">key</span><span class="op" id="5113376">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113379">v</span><span class="op" id="5113380">.</span><span class="ident" id="5113381">mu</span><span class="op" id="5113383">.</span><span class="ident" id="5113384">RUnlock</span><span class="op" id="5113391">(</span><span class="op" id="5113392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5113395">if</span>&nbsp;<span class="op" id="5113398">!</span><span class="ident" id="5113399">ok</span>&nbsp;<span class="op" id="5113402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5113406">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113444">v</span><span class="op" id="5113445">.</span><span class="ident" id="5113446">mu</span><span class="op" id="5113448">.</span><span class="ident" id="5113449">Lock</span><span class="op" id="5113453">(</span><span class="op" id="5113454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113458">av</span><span class="op" id="5113460">,</span>&nbsp;<span class="ident" id="5113462">ok</span>&nbsp;<span class="op" id="5113465">=</span>&nbsp;<span class="ident" id="5113467">v</span><span class="op" id="5113468">.</span><span class="ident" id="5113469">m</span><span class="op" id="5113470">[</span><span class="ident" id="5113471">key</span><span class="op" id="5113474">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5113478">if</span>&nbsp;<span class="op" id="5113481">!</span><span class="ident" id="5113482">ok</span>&nbsp;<span class="op" id="5113485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113490">av</span>&nbsp;<span class="op" id="5113493">=</span>&nbsp;<span class="builtinfunc" id="5113495">new</span><span class="op" id="5113498">(</span><span class="ident" id="5113499">Int</span><span class="op" id="5113502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113507">v</span><span class="op" id="5113508">.</span><span class="ident" id="5113509">m</span><span class="op" id="5113510">[</span><span class="ident" id="5113511">key</span><span class="op" id="5113514">]</span>&nbsp;<span class="op" id="5113516">=</span>&nbsp;<span class="ident" id="5113518">av</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113524">v</span><span class="op" id="5113525">.</span><span class="ident" id="5113526">updateKeys</span><span class="op" id="5113536">(</span><span class="op" id="5113537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5113541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113545">v</span><span class="op" id="5113546">.</span><span class="ident" id="5113547">mu</span><span class="op" id="5113549">.</span><span class="ident" id="5113550">Unlock</span><span class="op" id="5113556">(</span><span class="op" id="5113557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5113560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5113564">//&nbsp;Add&nbsp;to&nbsp;Int;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5113598">if</span>&nbsp;<span class="ident" id="5113601">iv</span><span class="op" id="5113603">,</span>&nbsp;<span class="ident" id="5113605">ok</span>&nbsp;<span class="op" id="5113608">:=</span>&nbsp;<span class="ident" id="5113611">av</span><span class="op" id="5113613">.</span><span class="op" id="5113614">(</span><span class="op" id="5113615">*</span><span class="ident" id="5113616">Int</span><span class="op" id="5113619">)</span><span class="op" id="5113620">;</span>&nbsp;<span class="ident" id="5113622">ok</span>&nbsp;<span class="op" id="5113625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113629">iv</span><span class="op" id="5113631">.</span><span class="ident" id="5113632">Add</span><span class="op" id="5113635">(</span><span class="ident" id="5113636">delta</span><span class="op" id="5113641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5113644">}</span><br>
<span class="lineno"></span><span class="op" id="5113646">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span><span class="comment" id="5113649">//&nbsp;AddFloat&nbsp;adds&nbsp;delta&nbsp;to&nbsp;the&nbsp;*Float&nbsp;value&nbsp;stored&nbsp;under&nbsp;the&nbsp;given&nbsp;map&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="5113724">func</span>&nbsp;<span class="op" id="5113729">(</span><span class="ident" id="5113730">v</span>&nbsp;<span class="op" id="5113732">*</span><span class="ident" id="5113733">Map</span><span class="op" id="5113736">)</span>&nbsp;<span class="ident" id="5113738">AddFloat</span><span class="op" id="5113746">(</span><span class="ident" id="5113747">key</span>&nbsp;<span class="builtintype" id="5113751">string</span><span class="op" id="5113757">,</span>&nbsp;<span class="ident" id="5113759">delta</span>&nbsp;<span class="builtintype" id="5113765">float64</span><span class="op" id="5113772">)</span>&nbsp;<span class="op" id="5113774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113777">v</span><span class="op" id="5113778">.</span><span class="ident" id="5113779">mu</span><span class="op" id="5113781">.</span><span class="ident" id="5113782">RLock</span><span class="op" id="5113787">(</span><span class="op" id="5113788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113791">av</span><span class="op" id="5113793">,</span>&nbsp;<span class="ident" id="5113795">ok</span>&nbsp;<span class="op" id="5113798">:=</span>&nbsp;<span class="ident" id="5113801">v</span><span class="op" id="5113802">.</span><span class="ident" id="5113803">m</span><span class="op" id="5113804">[</span><span class="ident" id="5113805">key</span><span class="op" id="5113808">]</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113811">v</span><span class="op" id="5113812">.</span><span class="ident" id="5113813">mu</span><span class="op" id="5113815">.</span><span class="ident" id="5113816">RUnlock</span><span class="op" id="5113823">(</span><span class="op" id="5113824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5113827">if</span>&nbsp;<span class="op" id="5113830">!</span><span class="ident" id="5113831">ok</span>&nbsp;<span class="op" id="5113834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5113838">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113876">v</span><span class="op" id="5113877">.</span><span class="ident" id="5113878">mu</span><span class="op" id="5113880">.</span><span class="ident" id="5113881">Lock</span><span class="op" id="5113885">(</span><span class="op" id="5113886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113890">av</span><span class="op" id="5113892">,</span>&nbsp;<span class="ident" id="5113894">ok</span>&nbsp;<span class="op" id="5113897">=</span>&nbsp;<span class="ident" id="5113899">v</span><span class="op" id="5113900">.</span><span class="ident" id="5113901">m</span><span class="op" id="5113902">[</span><span class="ident" id="5113903">key</span><span class="op" id="5113906">]</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5113910">if</span>&nbsp;<span class="op" id="5113913">!</span><span class="ident" id="5113914">ok</span>&nbsp;<span class="op" id="5113917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113922">av</span>&nbsp;<span class="op" id="5113925">=</span>&nbsp;<span class="builtinfunc" id="5113927">new</span><span class="op" id="5113930">(</span><span class="ident" id="5113931">Float</span><span class="op" id="5113936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113941">v</span><span class="op" id="5113942">.</span><span class="ident" id="5113943">m</span><span class="op" id="5113944">[</span><span class="ident" id="5113945">key</span><span class="op" id="5113948">]</span>&nbsp;<span class="op" id="5113950">=</span>&nbsp;<span class="ident" id="5113952">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113958">v</span><span class="op" id="5113959">.</span><span class="ident" id="5113960">updateKeys</span><span class="op" id="5113970">(</span><span class="op" id="5113971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5113975">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113979">v</span><span class="op" id="5113980">.</span><span class="ident" id="5113981">mu</span><span class="op" id="5113983">.</span><span class="ident" id="5113984">Unlock</span><span class="op" id="5113990">(</span><span class="op" id="5113991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5113994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5113998">//&nbsp;Add&nbsp;to&nbsp;Float;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5114034">if</span>&nbsp;<span class="ident" id="5114037">iv</span><span class="op" id="5114039">,</span>&nbsp;<span class="ident" id="5114041">ok</span>&nbsp;<span class="op" id="5114044">:=</span>&nbsp;<span class="ident" id="5114047">av</span><span class="op" id="5114049">.</span><span class="op" id="5114050">(</span><span class="op" id="5114051">*</span><span class="ident" id="5114052">Float</span><span class="op" id="5114057">)</span><span class="op" id="5114058">;</span>&nbsp;<span class="ident" id="5114060">ok</span>&nbsp;<span class="op" id="5114063">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114067">iv</span><span class="op" id="5114069">.</span><span class="ident" id="5114070">Add</span><span class="op" id="5114073">(</span><span class="ident" id="5114074">delta</span><span class="op" id="5114079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5114082">}</span><br>
<span class="lineno"></span><span class="op" id="5114084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5114087">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">200</span><span class="comment" id="5114128">//&nbsp;The&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="5114171">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="5114224">func</span>&nbsp;<span class="op" id="5114229">(</span><span class="ident" id="5114230">v</span>&nbsp;<span class="op" id="5114232">*</span><span class="ident" id="5114233">Map</span><span class="op" id="5114236">)</span>&nbsp;<span class="ident" id="5114238">Do</span><span class="op" id="5114240">(</span><span class="ident" id="5114241">f</span>&nbsp;<span class="keyword" id="5114243">func</span><span class="op" id="5114247">(</span><span class="ident" id="5114248">KeyValue</span><span class="op" id="5114256">)</span><span class="op" id="5114257">)</span>&nbsp;<span class="op" id="5114259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114262">v</span><span class="op" id="5114263">.</span><span class="ident" id="5114264">mu</span><span class="op" id="5114266">.</span><span class="ident" id="5114267">RLock</span><span class="op" id="5114272">(</span><span class="op" id="5114273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5114276">defer</span>&nbsp;<span class="ident" id="5114282">v</span><span class="op" id="5114283">.</span><span class="ident" id="5114284">mu</span><span class="op" id="5114286">.</span><span class="ident" id="5114287">RUnlock</span><span class="op" id="5114294">(</span><span class="op" id="5114295">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114298">v</span><span class="op" id="5114299">.</span><span class="ident" id="5114300">doLocked</span><span class="op" id="5114308">(</span><span class="ident" id="5114309">f</span><span class="op" id="5114310">)</span><br>
<span class="lineno"></span><span class="op" id="5114312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5114315">//&nbsp;doLocked&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="5114362">//&nbsp;v.mu&nbsp;must&nbsp;be&nbsp;held&nbsp;for&nbsp;reads.</span><br>
<span class="lineno">210</span><span class="keyword" id="5114394">func</span>&nbsp;<span class="op" id="5114399">(</span><span class="ident" id="5114400">v</span>&nbsp;<span class="op" id="5114402">*</span><span class="ident" id="5114403">Map</span><span class="op" id="5114406">)</span>&nbsp;<span class="ident" id="5114408">doLocked</span><span class="op" id="5114416">(</span><span class="ident" id="5114417">f</span>&nbsp;<span class="keyword" id="5114419">func</span><span class="op" id="5114423">(</span><span class="ident" id="5114424">KeyValue</span><span class="op" id="5114432">)</span><span class="op" id="5114433">)</span>&nbsp;<span class="op" id="5114435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5114438">for</span>&nbsp;<span class="ident" id="5114442">_</span><span class="op" id="5114443">,</span>&nbsp;<span class="ident" id="5114445">k</span>&nbsp;<span class="op" id="5114447">:=</span>&nbsp;<span class="keyword" id="5114450">range</span>&nbsp;<span class="ident" id="5114456">v</span><span class="op" id="5114457">.</span><span class="ident" id="5114458">keys</span>&nbsp;<span class="op" id="5114463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114467">f</span><span class="op" id="5114468">(</span><span class="ident" id="5114469">KeyValue</span><span class="op" id="5114477">{</span><span class="ident" id="5114478">k</span><span class="op" id="5114479">,</span>&nbsp;<span class="ident" id="5114481">v</span><span class="op" id="5114482">.</span><span class="ident" id="5114483">m</span><span class="op" id="5114484">[</span><span class="ident" id="5114485">k</span><span class="op" id="5114486">]</span><span class="op" id="5114487">}</span><span class="op" id="5114488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5114491">}</span><br>
<span class="lineno"></span><span class="op" id="5114493">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="5114496">//&nbsp;String&nbsp;is&nbsp;a&nbsp;string&nbsp;variable,&nbsp;and&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5114561">type</span>&nbsp;<span class="ident" id="5114566">String</span>&nbsp;<span class="keyword" id="5114573">struct</span>&nbsp;<span class="op" id="5114580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114583">mu</span>&nbsp;<span class="ident" id="5114586">sync</span><span class="op" id="5114590">.</span><span class="ident" id="5114591">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114600">s</span>&nbsp;&nbsp;<span class="builtintype" id="5114603">string</span><br>
<span class="lineno">220</span><span class="op" id="5114610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5114613">func</span>&nbsp;<span class="op" id="5114618">(</span><span class="ident" id="5114619">v</span>&nbsp;<span class="op" id="5114621">*</span><span class="ident" id="5114622">String</span><span class="op" id="5114628">)</span>&nbsp;<span class="ident" id="5114630">String</span><span class="op" id="5114636">(</span><span class="op" id="5114637">)</span>&nbsp;<span class="builtintype" id="5114639">string</span>&nbsp;<span class="op" id="5114646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114649">v</span><span class="op" id="5114650">.</span><span class="ident" id="5114651">mu</span><span class="op" id="5114653">.</span><span class="ident" id="5114654">RLock</span><span class="op" id="5114659">(</span><span class="op" id="5114660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5114663">defer</span>&nbsp;<span class="ident" id="5114669">v</span><span class="op" id="5114670">.</span><span class="ident" id="5114671">mu</span><span class="op" id="5114673">.</span><span class="ident" id="5114674">RUnlock</span><span class="op" id="5114681">(</span><span class="op" id="5114682">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5114685">return</span>&nbsp;<span class="ident" id="5114692">strconv</span><span class="op" id="5114699">.</span><span class="ident" id="5114700">Quote</span><span class="op" id="5114705">(</span><span class="ident" id="5114706">v</span><span class="op" id="5114707">.</span><span class="ident" id="5114708">s</span><span class="op" id="5114709">)</span><br>
<span class="lineno"></span><span class="op" id="5114711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5114714">func</span>&nbsp;<span class="op" id="5114719">(</span><span class="ident" id="5114720">v</span>&nbsp;<span class="op" id="5114722">*</span><span class="ident" id="5114723">String</span><span class="op" id="5114729">)</span>&nbsp;<span class="ident" id="5114731">Set</span><span class="op" id="5114734">(</span><span class="ident" id="5114735">value</span>&nbsp;<span class="builtintype" id="5114741">string</span><span class="op" id="5114747">)</span>&nbsp;<span class="op" id="5114749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114752">v</span><span class="op" id="5114753">.</span><span class="ident" id="5114754">mu</span><span class="op" id="5114756">.</span><span class="ident" id="5114757">Lock</span><span class="op" id="5114761">(</span><span class="op" id="5114762">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5114765">defer</span>&nbsp;<span class="ident" id="5114771">v</span><span class="op" id="5114772">.</span><span class="ident" id="5114773">mu</span><span class="op" id="5114775">.</span><span class="ident" id="5114776">Unlock</span><span class="op" id="5114782">(</span><span class="op" id="5114783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114786">v</span><span class="op" id="5114787">.</span><span class="ident" id="5114788">s</span>&nbsp;<span class="op" id="5114790">=</span>&nbsp;<span class="ident" id="5114792">value</span><br>
<span class="lineno"></span><span class="op" id="5114798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5114801">//&nbsp;Func&nbsp;implements&nbsp;Var&nbsp;by&nbsp;calling&nbsp;the&nbsp;function</span><br>
<span class="lineno">235</span><span class="comment" id="5114848">//&nbsp;and&nbsp;formatting&nbsp;the&nbsp;returned&nbsp;value&nbsp;using&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="5114897">type</span>&nbsp;<span class="ident" id="5114902">Func</span>&nbsp;<span class="keyword" id="5114907">func</span><span class="op" id="5114911">(</span><span class="op" id="5114912">)</span>&nbsp;<span class="keyword" id="5114914">interface</span><span class="op" id="5114923">{</span><span class="op" id="5114924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5114927">func</span>&nbsp;<span class="op" id="5114932">(</span><span class="ident" id="5114933">f</span>&nbsp;<span class="ident" id="5114935">Func</span><span class="op" id="5114939">)</span>&nbsp;<span class="ident" id="5114941">String</span><span class="op" id="5114947">(</span><span class="op" id="5114948">)</span>&nbsp;<span class="builtintype" id="5114950">string</span>&nbsp;<span class="op" id="5114957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114960">v</span><span class="op" id="5114961">,</span>&nbsp;<span class="ident" id="5114963">_</span>&nbsp;<span class="op" id="5114965">:=</span>&nbsp;<span class="ident" id="5114968">json</span><span class="op" id="5114972">.</span><span class="ident" id="5114973">Marshal</span><span class="op" id="5114980">(</span><span class="ident" id="5114981">f</span><span class="op" id="5114982">(</span><span class="op" id="5114983">)</span><span class="op" id="5114984">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5114987">return</span>&nbsp;<span class="builtintype" id="5114994">string</span><span class="op" id="5115000">(</span><span class="ident" id="5115001">v</span><span class="op" id="5115002">)</span><br>
<span class="lineno"></span><span class="op" id="5115004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5115007">//&nbsp;All&nbsp;published&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5115035">var</span>&nbsp;<span class="op" id="5115039">(</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115042">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5115050">sync</span><span class="op" id="5115054">.</span><span class="ident" id="5115055">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115064">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5115072">=</span>&nbsp;<span class="builtinfunc" id="5115074">make</span><span class="op" id="5115078">(</span><span class="keyword" id="5115079">map</span><span class="op" id="5115082">[</span><span class="builtintype" id="5115083">string</span><span class="op" id="5115089">]</span><span class="ident" id="5115090">Var</span><span class="op" id="5115093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115096">varKeys</span>&nbsp;<span class="op" id="5115104">[</span><span class="op" id="5115105">]</span><span class="builtintype" id="5115106">string</span>&nbsp;<span class="comment" id="5115113">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="5115123">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="comment" id="5115126">//&nbsp;Publish&nbsp;declares&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.&nbsp;This&nbsp;should&nbsp;be&nbsp;called&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5115202">//&nbsp;package&#39;s&nbsp;init&nbsp;function&nbsp;when&nbsp;it&nbsp;creates&nbsp;its&nbsp;Vars.&nbsp;If&nbsp;the&nbsp;name&nbsp;is&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="5115278">//&nbsp;registered&nbsp;then&nbsp;this&nbsp;will&nbsp;log.Panic.</span><br>
<span class="lineno"></span><span class="keyword" id="5115318">func</span>&nbsp;<span class="ident" id="5115323">Publish</span><span class="op" id="5115330">(</span><span class="ident" id="5115331">name</span>&nbsp;<span class="builtintype" id="5115336">string</span><span class="op" id="5115342">,</span>&nbsp;<span class="ident" id="5115344">v</span>&nbsp;<span class="ident" id="5115346">Var</span><span class="op" id="5115349">)</span>&nbsp;<span class="op" id="5115351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115354">mutex</span><span class="op" id="5115359">.</span><span class="ident" id="5115360">Lock</span><span class="op" id="5115364">(</span><span class="op" id="5115365">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5115368">defer</span>&nbsp;<span class="ident" id="5115374">mutex</span><span class="op" id="5115379">.</span><span class="ident" id="5115380">Unlock</span><span class="op" id="5115386">(</span><span class="op" id="5115387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5115390">if</span>&nbsp;<span class="ident" id="5115393">_</span><span class="op" id="5115394">,</span>&nbsp;<span class="ident" id="5115396">existing</span>&nbsp;<span class="op" id="5115405">:=</span>&nbsp;<span class="ident" id="5115408">vars</span><span class="op" id="5115412">[</span><span class="ident" id="5115413">name</span><span class="op" id="5115417">]</span><span class="op" id="5115418">;</span>&nbsp;<span class="ident" id="5115420">existing</span>&nbsp;<span class="op" id="5115429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115433">log</span><span class="op" id="5115436">.</span><span class="ident" id="5115437">Panicln</span><span class="op" id="5115444">(</span><span class="string" id="5115445">&#34;Reuse&nbsp;of&nbsp;exported&nbsp;var&nbsp;name:&#34;</span><span class="op" id="5115474">,</span>&nbsp;<span class="ident" id="5115476">name</span><span class="op" id="5115480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5115483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115486">vars</span><span class="op" id="5115490">[</span><span class="ident" id="5115491">name</span><span class="op" id="5115495">]</span>&nbsp;<span class="op" id="5115497">=</span>&nbsp;<span class="ident" id="5115499">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115502">varKeys</span>&nbsp;<span class="op" id="5115510">=</span>&nbsp;<span class="builtinfunc" id="5115512">append</span><span class="op" id="5115518">(</span><span class="ident" id="5115519">varKeys</span><span class="op" id="5115526">,</span>&nbsp;<span class="ident" id="5115528">name</span><span class="op" id="5115532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115535">sort</span><span class="op" id="5115539">.</span><span class="ident" id="5115540">Strings</span><span class="op" id="5115547">(</span><span class="ident" id="5115548">varKeys</span><span class="op" id="5115555">)</span><br>
<span class="lineno"></span><span class="op" id="5115557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5115560">//&nbsp;Get&nbsp;retrieves&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno">265</span><span class="keyword" id="5115604">func</span>&nbsp;<span class="ident" id="5115609">Get</span><span class="op" id="5115612">(</span><span class="ident" id="5115613">name</span>&nbsp;<span class="builtintype" id="5115618">string</span><span class="op" id="5115624">)</span>&nbsp;<span class="ident" id="5115626">Var</span>&nbsp;<span class="op" id="5115630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115633">mutex</span><span class="op" id="5115638">.</span><span class="ident" id="5115639">RLock</span><span class="op" id="5115644">(</span><span class="op" id="5115645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5115648">defer</span>&nbsp;<span class="ident" id="5115654">mutex</span><span class="op" id="5115659">.</span><span class="ident" id="5115660">RUnlock</span><span class="op" id="5115667">(</span><span class="op" id="5115668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5115671">return</span>&nbsp;<span class="ident" id="5115678">vars</span><span class="op" id="5115682">[</span><span class="ident" id="5115683">name</span><span class="op" id="5115687">]</span><br>
<span class="lineno"></span><span class="op" id="5115689">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="comment" id="5115692">//&nbsp;Convenience&nbsp;functions&nbsp;for&nbsp;creating&nbsp;new&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5115755">func</span>&nbsp;<span class="ident" id="5115760">NewInt</span><span class="op" id="5115766">(</span><span class="ident" id="5115767">name</span>&nbsp;<span class="builtintype" id="5115772">string</span><span class="op" id="5115778">)</span>&nbsp;<span class="op" id="5115780">*</span><span class="ident" id="5115781">Int</span>&nbsp;<span class="op" id="5115785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115788">v</span>&nbsp;<span class="op" id="5115790">:=</span>&nbsp;<span class="builtinfunc" id="5115793">new</span><span class="op" id="5115796">(</span><span class="ident" id="5115797">Int</span><span class="op" id="5115800">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115803">Publish</span><span class="op" id="5115810">(</span><span class="ident" id="5115811">name</span><span class="op" id="5115815">,</span>&nbsp;<span class="ident" id="5115817">v</span><span class="op" id="5115818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5115821">return</span>&nbsp;<span class="ident" id="5115828">v</span><br>
<span class="lineno"></span><span class="op" id="5115830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5115833">func</span>&nbsp;<span class="ident" id="5115838">NewFloat</span><span class="op" id="5115846">(</span><span class="ident" id="5115847">name</span>&nbsp;<span class="builtintype" id="5115852">string</span><span class="op" id="5115858">)</span>&nbsp;<span class="op" id="5115860">*</span><span class="ident" id="5115861">Float</span>&nbsp;<span class="op" id="5115867">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115870">v</span>&nbsp;<span class="op" id="5115872">:=</span>&nbsp;<span class="builtinfunc" id="5115875">new</span><span class="op" id="5115878">(</span><span class="ident" id="5115879">Float</span><span class="op" id="5115884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115887">Publish</span><span class="op" id="5115894">(</span><span class="ident" id="5115895">name</span><span class="op" id="5115899">,</span>&nbsp;<span class="ident" id="5115901">v</span><span class="op" id="5115902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5115905">return</span>&nbsp;<span class="ident" id="5115912">v</span><br>
<span class="lineno"></span><span class="op" id="5115914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="5115917">func</span>&nbsp;<span class="ident" id="5115922">NewMap</span><span class="op" id="5115928">(</span><span class="ident" id="5115929">name</span>&nbsp;<span class="builtintype" id="5115934">string</span><span class="op" id="5115940">)</span>&nbsp;<span class="op" id="5115942">*</span><span class="ident" id="5115943">Map</span>&nbsp;<span class="op" id="5115947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115950">v</span>&nbsp;<span class="op" id="5115952">:=</span>&nbsp;<span class="builtinfunc" id="5115955">new</span><span class="op" id="5115958">(</span><span class="ident" id="5115959">Map</span><span class="op" id="5115962">)</span><span class="op" id="5115963">.</span><span class="ident" id="5115964">Init</span><span class="op" id="5115968">(</span><span class="op" id="5115969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115972">Publish</span><span class="op" id="5115979">(</span><span class="ident" id="5115980">name</span><span class="op" id="5115984">,</span>&nbsp;<span class="ident" id="5115986">v</span><span class="op" id="5115987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5115990">return</span>&nbsp;<span class="ident" id="5115997">v</span><br>
<span class="lineno"></span><span class="op" id="5115999">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span><span class="keyword" id="5116002">func</span>&nbsp;<span class="ident" id="5116007">NewString</span><span class="op" id="5116016">(</span><span class="ident" id="5116017">name</span>&nbsp;<span class="builtintype" id="5116022">string</span><span class="op" id="5116028">)</span>&nbsp;<span class="op" id="5116030">*</span><span class="ident" id="5116031">String</span>&nbsp;<span class="op" id="5116038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116041">v</span>&nbsp;<span class="op" id="5116043">:=</span>&nbsp;<span class="builtinfunc" id="5116046">new</span><span class="op" id="5116049">(</span><span class="ident" id="5116050">String</span><span class="op" id="5116056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116059">Publish</span><span class="op" id="5116066">(</span><span class="ident" id="5116067">name</span><span class="op" id="5116071">,</span>&nbsp;<span class="ident" id="5116073">v</span><span class="op" id="5116074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5116077">return</span>&nbsp;<span class="ident" id="5116084">v</span><br>
<span class="lineno">295</span><span class="op" id="5116086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5116089">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="5116131">//&nbsp;The&nbsp;global&nbsp;variable&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="5116190">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno">300</span><span class="keyword" id="5116243">func</span>&nbsp;<span class="ident" id="5116248">Do</span><span class="op" id="5116250">(</span><span class="ident" id="5116251">f</span>&nbsp;<span class="keyword" id="5116253">func</span><span class="op" id="5116257">(</span><span class="ident" id="5116258">KeyValue</span><span class="op" id="5116266">)</span><span class="op" id="5116267">)</span>&nbsp;<span class="op" id="5116269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116272">mutex</span><span class="op" id="5116277">.</span><span class="ident" id="5116278">RLock</span><span class="op" id="5116283">(</span><span class="op" id="5116284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5116287">defer</span>&nbsp;<span class="ident" id="5116293">mutex</span><span class="op" id="5116298">.</span><span class="ident" id="5116299">RUnlock</span><span class="op" id="5116306">(</span><span class="op" id="5116307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5116310">for</span>&nbsp;<span class="ident" id="5116314">_</span><span class="op" id="5116315">,</span>&nbsp;<span class="ident" id="5116317">k</span>&nbsp;<span class="op" id="5116319">:=</span>&nbsp;<span class="keyword" id="5116322">range</span>&nbsp;<span class="ident" id="5116328">varKeys</span>&nbsp;<span class="op" id="5116336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116340">f</span><span class="op" id="5116341">(</span><span class="ident" id="5116342">KeyValue</span><span class="op" id="5116350">{</span><span class="ident" id="5116351">k</span><span class="op" id="5116352">,</span>&nbsp;<span class="ident" id="5116354">vars</span><span class="op" id="5116358">[</span><span class="ident" id="5116359">k</span><span class="op" id="5116360">]</span><span class="op" id="5116361">}</span><span class="op" id="5116362">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5116365">}</span><br>
<span class="lineno"></span><span class="op" id="5116367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5116370">func</span>&nbsp;<span class="ident" id="5116375">expvarHandler</span><span class="op" id="5116388">(</span><span class="ident" id="5116389">w</span>&nbsp;<span class="ident" id="5116391">http</span><span class="op" id="5116395">.</span><span class="ident" id="5116396">ResponseWriter</span><span class="op" id="5116410">,</span>&nbsp;<span class="ident" id="5116412">r</span>&nbsp;<span class="op" id="5116414">*</span><span class="ident" id="5116415">http</span><span class="op" id="5116419">.</span><span class="ident" id="5116420">Request</span><span class="op" id="5116427">)</span>&nbsp;<span class="op" id="5116429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116432">w</span><span class="op" id="5116433">.</span><span class="ident" id="5116434">Header</span><span class="op" id="5116440">(</span><span class="op" id="5116441">)</span><span class="op" id="5116442">.</span><span class="ident" id="5116443">Set</span><span class="op" id="5116446">(</span><span class="string" id="5116447">&#34;Content-Type&#34;</span><span class="op" id="5116461">,</span>&nbsp;<span class="string" id="5116463">&#34;application/json;&nbsp;charset=utf-8&#34;</span><span class="op" id="5116496">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116499">fmt</span><span class="op" id="5116502">.</span><span class="ident" id="5116503">Fprintf</span><span class="op" id="5116510">(</span><span class="ident" id="5116511">w</span><span class="op" id="5116512">,</span>&nbsp;<span class="string" id="5116514">&#34;{\n&#34;</span><span class="op" id="5116519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116522">first</span>&nbsp;<span class="op" id="5116528">:=</span>&nbsp;<span class="ident" id="5116531">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116537">Do</span><span class="op" id="5116539">(</span><span class="keyword" id="5116540">func</span><span class="op" id="5116544">(</span><span class="ident" id="5116545">kv</span>&nbsp;<span class="ident" id="5116548">KeyValue</span><span class="op" id="5116556">)</span>&nbsp;<span class="op" id="5116558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5116562">if</span>&nbsp;<span class="op" id="5116565">!</span><span class="ident" id="5116566">first</span>&nbsp;<span class="op" id="5116572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116577">fmt</span><span class="op" id="5116580">.</span><span class="ident" id="5116581">Fprintf</span><span class="op" id="5116588">(</span><span class="ident" id="5116589">w</span><span class="op" id="5116590">,</span>&nbsp;<span class="string" id="5116592">&#34;,\n&#34;</span><span class="op" id="5116597">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5116601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116605">first</span>&nbsp;<span class="op" id="5116611">=</span>&nbsp;<span class="ident" id="5116613">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116621">fmt</span><span class="op" id="5116624">.</span><span class="ident" id="5116625">Fprintf</span><span class="op" id="5116632">(</span><span class="ident" id="5116633">w</span><span class="op" id="5116634">,</span>&nbsp;<span class="string" id="5116636">&#34;%q:&nbsp;%s&#34;</span><span class="op" id="5116644">,</span>&nbsp;<span class="ident" id="5116646">kv</span><span class="op" id="5116648">.</span><span class="ident" id="5116649">Key</span><span class="op" id="5116652">,</span>&nbsp;<span class="ident" id="5116654">kv</span><span class="op" id="5116656">.</span><span class="ident" id="5116657">Value</span><span class="op" id="5116662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5116665">}</span><span class="op" id="5116666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116669">fmt</span><span class="op" id="5116672">.</span><span class="ident" id="5116673">Fprintf</span><span class="op" id="5116680">(</span><span class="ident" id="5116681">w</span><span class="op" id="5116682">,</span>&nbsp;<span class="string" id="5116684">&#34;\n}\n&#34;</span><span class="op" id="5116691">)</span><br>
<span class="lineno">320</span><span class="op" id="5116693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5116696">func</span>&nbsp;<span class="ident" id="5116701">cmdline</span><span class="op" id="5116708">(</span><span class="op" id="5116709">)</span>&nbsp;<span class="keyword" id="5116711">interface</span><span class="op" id="5116720">{</span><span class="op" id="5116721">}</span>&nbsp;<span class="op" id="5116723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5116726">return</span>&nbsp;<span class="ident" id="5116733">os</span><span class="op" id="5116735">.</span><span class="ident" id="5116736">Args</span><br>
<span class="lineno"></span><span class="op" id="5116741">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="5116744">func</span>&nbsp;<span class="ident" id="5116749">memstats</span><span class="op" id="5116757">(</span><span class="op" id="5116758">)</span>&nbsp;<span class="keyword" id="5116760">interface</span><span class="op" id="5116769">{</span><span class="op" id="5116770">}</span>&nbsp;<span class="op" id="5116772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116775">stats</span>&nbsp;<span class="op" id="5116781">:=</span>&nbsp;<span class="builtinfunc" id="5116784">new</span><span class="op" id="5116787">(</span><span class="ident" id="5116788">runtime</span><span class="op" id="5116795">.</span><span class="ident" id="5116796">MemStats</span><span class="op" id="5116804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116807">runtime</span><span class="op" id="5116814">.</span><span class="ident" id="5116815">ReadMemStats</span><span class="op" id="5116827">(</span><span class="ident" id="5116828">stats</span><span class="op" id="5116833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5116836">return</span>&nbsp;<span class="op" id="5116843">*</span><span class="ident" id="5116844">stats</span><br>
<span class="lineno">330</span><span class="op" id="5116850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5116853">func</span>&nbsp;<span class="ident" id="5116858">init</span><span class="op" id="5116862">(</span><span class="op" id="5116863">)</span>&nbsp;<span class="op" id="5116865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116868">http</span><span class="op" id="5116872">.</span><span class="ident" id="5116873">HandleFunc</span><span class="op" id="5116883">(</span><span class="string" id="5116884">&#34;/debug/vars&#34;</span><span class="op" id="5116897">,</span>&nbsp;<span class="ident" id="5116899">expvarHandler</span><span class="op" id="5116912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116915">Publish</span><span class="op" id="5116922">(</span><span class="string" id="5116923">&#34;cmdline&#34;</span><span class="op" id="5116932">,</span>&nbsp;<span class="ident" id="5116934">Func</span><span class="op" id="5116938">(</span><span class="ident" id="5116939">cmdline</span><span class="op" id="5116946">)</span><span class="op" id="5116947">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116950">Publish</span><span class="op" id="5116957">(</span><span class="string" id="5116958">&#34;memstats&#34;</span><span class="op" id="5116968">,</span>&nbsp;<span class="ident" id="5116970">Func</span><span class="op" id="5116974">(</span><span class="ident" id="5116975">memstats</span><span class="op" id="5116983">)</span><span class="op" id="5116984">)</span><br>
<span class="lineno"></span><span class="op" id="5116986">}</span>
</div>
</body>
</html>
