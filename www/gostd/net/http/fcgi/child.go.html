<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html" class="current">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5617901">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5617956">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5618010">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5618061">package</span>&nbsp;<span class="ident" id="5618069">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5618075">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;FastCGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5618149">import</span>&nbsp;<span class="op" id="5618156">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618159">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618169">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618176">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618182">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618195">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618202">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618214">&#34;net/http/cgi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618230">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618236">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618247">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618255">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="5618262">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5618265">//&nbsp;request&nbsp;holds&nbsp;the&nbsp;state&nbsp;for&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;As&nbsp;soon&nbsp;as&nbsp;it&#39;s&nbsp;complete,</span><br>
<span class="lineno"></span><span class="comment" id="5618346">//&nbsp;it&#39;s&nbsp;converted&nbsp;to&nbsp;an&nbsp;http.Request.</span><br>
<span class="lineno">25</span><span class="keyword" id="5618384">type</span>&nbsp;<span class="ident" id="5618389">request</span>&nbsp;<span class="keyword" id="5618397">struct</span>&nbsp;<span class="op" id="5618404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618407">pw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5618417">*</span><span class="ident" id="5618418">io</span><span class="op" id="5618420">.</span><span class="ident" id="5618421">PipeWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618433">reqId</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5618443">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618451">params</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5618461">map</span><span class="op" id="5618464">[</span><span class="builtintype" id="5618465">string</span><span class="op" id="5618471">]</span><span class="builtintype" id="5618472">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618480">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5618490">[</span><span class="num" id="5618491">1024</span><span class="op" id="5618495">]</span><span class="builtintype" id="5618496">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618502">rawParams</span>&nbsp;<span class="op" id="5618512">[</span><span class="op" id="5618513">]</span><span class="builtintype" id="5618514">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618520">keepConn</span>&nbsp;&nbsp;<span class="builtintype" id="5618530">bool</span><br>
<span class="lineno"></span><span class="op" id="5618535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5618538">func</span>&nbsp;<span class="ident" id="5618543">newRequest</span><span class="op" id="5618553">(</span><span class="ident" id="5618554">reqId</span>&nbsp;<span class="builtintype" id="5618560">uint16</span><span class="op" id="5618566">,</span>&nbsp;<span class="ident" id="5618568">flags</span>&nbsp;<span class="builtintype" id="5618574">uint8</span><span class="op" id="5618579">)</span>&nbsp;<span class="op" id="5618581">*</span><span class="ident" id="5618582">request</span>&nbsp;<span class="op" id="5618590">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618593">r</span>&nbsp;<span class="op" id="5618595">:=</span>&nbsp;<span class="op" id="5618598">&amp;</span><span class="ident" id="5618599">request</span><span class="op" id="5618606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618610">reqId</span><span class="op" id="5618615">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5618620">reqId</span><span class="op" id="5618625">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618629">params</span><span class="op" id="5618635">:</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="5618639">map</span><span class="op" id="5618642">[</span><span class="builtintype" id="5618643">string</span><span class="op" id="5618649">]</span><span class="builtintype" id="5618650">string</span><span class="op" id="5618656">{</span><span class="op" id="5618657">}</span><span class="op" id="5618658">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618662">keepConn</span><span class="op" id="5618670">:</span>&nbsp;<span class="ident" id="5618672">flags</span><span class="op" id="5618677">&amp;</span><span class="ident" id="5618678">flagKeepConn</span>&nbsp;<span class="op" id="5618691">!=</span>&nbsp;<span class="num" id="5618694">0</span><span class="op" id="5618695">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5618698">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618701">r</span><span class="op" id="5618702">.</span><span class="ident" id="5618703">rawParams</span>&nbsp;<span class="op" id="5618713">=</span>&nbsp;<span class="ident" id="5618715">r</span><span class="op" id="5618716">.</span><span class="ident" id="5618717">buf</span><span class="op" id="5618720">[</span><span class="op" id="5618721">:</span><span class="num" id="5618722">0</span><span class="op" id="5618723">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5618726">return</span>&nbsp;<span class="ident" id="5618733">r</span><br>
<span class="lineno"></span><span class="op" id="5618735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5618738">//&nbsp;parseParams&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;[]byte&nbsp;into&nbsp;Params.</span><br>
<span class="lineno">45</span><span class="keyword" id="5618790">func</span>&nbsp;<span class="op" id="5618795">(</span><span class="ident" id="5618796">r</span>&nbsp;<span class="op" id="5618798">*</span><span class="ident" id="5618799">request</span><span class="op" id="5618806">)</span>&nbsp;<span class="ident" id="5618808">parseParams</span><span class="op" id="5618819">(</span><span class="op" id="5618820">)</span>&nbsp;<span class="op" id="5618822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618825">text</span>&nbsp;<span class="op" id="5618830">:=</span>&nbsp;<span class="ident" id="5618833">r</span><span class="op" id="5618834">.</span><span class="ident" id="5618835">rawParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618846">r</span><span class="op" id="5618847">.</span><span class="ident" id="5618848">rawParams</span>&nbsp;<span class="op" id="5618858">=</span>&nbsp;<span class="ident" id="5618860">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5618865">for</span>&nbsp;<span class="builtinfunc" id="5618869">len</span><span class="op" id="5618872">(</span><span class="ident" id="5618873">text</span><span class="op" id="5618877">)</span>&nbsp;<span class="op" id="5618879">&gt;</span>&nbsp;<span class="num" id="5618881">0</span>&nbsp;<span class="op" id="5618883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618887">keyLen</span><span class="op" id="5618893">,</span>&nbsp;<span class="ident" id="5618895">n</span>&nbsp;<span class="op" id="5618897">:=</span>&nbsp;<span class="ident" id="5618900">readSize</span><span class="op" id="5618908">(</span><span class="ident" id="5618909">text</span><span class="op" id="5618913">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5618917">if</span>&nbsp;<span class="ident" id="5618920">n</span>&nbsp;<span class="op" id="5618922">==</span>&nbsp;<span class="num" id="5618925">0</span>&nbsp;<span class="op" id="5618927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5618932">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5618941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618945">text</span>&nbsp;<span class="op" id="5618950">=</span>&nbsp;<span class="ident" id="5618952">text</span><span class="op" id="5618956">[</span><span class="ident" id="5618957">n</span><span class="op" id="5618958">:</span><span class="op" id="5618959">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618963">valLen</span><span class="op" id="5618969">,</span>&nbsp;<span class="ident" id="5618971">n</span>&nbsp;<span class="op" id="5618973">:=</span>&nbsp;<span class="ident" id="5618976">readSize</span><span class="op" id="5618984">(</span><span class="ident" id="5618985">text</span><span class="op" id="5618989">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5618993">if</span>&nbsp;<span class="ident" id="5618996">n</span>&nbsp;<span class="op" id="5618998">==</span>&nbsp;<span class="num" id="5619001">0</span>&nbsp;<span class="op" id="5619003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619008">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5619017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619021">text</span>&nbsp;<span class="op" id="5619026">=</span>&nbsp;<span class="ident" id="5619028">text</span><span class="op" id="5619032">[</span><span class="ident" id="5619033">n</span><span class="op" id="5619034">:</span><span class="op" id="5619035">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619039">key</span>&nbsp;<span class="op" id="5619043">:=</span>&nbsp;<span class="ident" id="5619046">readString</span><span class="op" id="5619056">(</span><span class="ident" id="5619057">text</span><span class="op" id="5619061">,</span>&nbsp;<span class="ident" id="5619063">keyLen</span><span class="op" id="5619069">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619073">text</span>&nbsp;<span class="op" id="5619078">=</span>&nbsp;<span class="ident" id="5619080">text</span><span class="op" id="5619084">[</span><span class="ident" id="5619085">keyLen</span><span class="op" id="5619091">:</span><span class="op" id="5619092">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619096">val</span>&nbsp;<span class="op" id="5619100">:=</span>&nbsp;<span class="ident" id="5619103">readString</span><span class="op" id="5619113">(</span><span class="ident" id="5619114">text</span><span class="op" id="5619118">,</span>&nbsp;<span class="ident" id="5619120">valLen</span><span class="op" id="5619126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619130">text</span>&nbsp;<span class="op" id="5619135">=</span>&nbsp;<span class="ident" id="5619137">text</span><span class="op" id="5619141">[</span><span class="ident" id="5619142">valLen</span><span class="op" id="5619148">:</span><span class="op" id="5619149">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619153">r</span><span class="op" id="5619154">.</span><span class="ident" id="5619155">params</span><span class="op" id="5619161">[</span><span class="ident" id="5619162">key</span><span class="op" id="5619165">]</span>&nbsp;<span class="op" id="5619167">=</span>&nbsp;<span class="ident" id="5619169">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5619174">}</span><br>
<span class="lineno">65</span><span class="op" id="5619176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5619179">//&nbsp;response&nbsp;implements&nbsp;http.ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="5619223">type</span>&nbsp;<span class="ident" id="5619228">response</span>&nbsp;<span class="keyword" id="5619237">struct</span>&nbsp;<span class="op" id="5619244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619247">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5619259">*</span><span class="ident" id="5619260">request</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619269">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5619281">http</span><span class="op" id="5619285">.</span><span class="ident" id="5619286">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619294">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5619306">*</span><span class="ident" id="5619307">bufWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619318">wroteHeader</span>&nbsp;<span class="builtintype" id="5619330">bool</span><br>
<span class="lineno"></span><span class="op" id="5619335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="5619338">func</span>&nbsp;<span class="ident" id="5619343">newResponse</span><span class="op" id="5619354">(</span><span class="ident" id="5619355">c</span>&nbsp;<span class="op" id="5619357">*</span><span class="ident" id="5619358">child</span><span class="op" id="5619363">,</span>&nbsp;<span class="ident" id="5619365">req</span>&nbsp;<span class="op" id="5619369">*</span><span class="ident" id="5619370">request</span><span class="op" id="5619377">)</span>&nbsp;<span class="op" id="5619379">*</span><span class="ident" id="5619380">response</span>&nbsp;<span class="op" id="5619389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619392">return</span>&nbsp;<span class="op" id="5619399">&amp;</span><span class="ident" id="5619400">response</span><span class="op" id="5619408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619412">req</span><span class="op" id="5619415">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5619420">req</span><span class="op" id="5619423">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619427">header</span><span class="op" id="5619433">:</span>&nbsp;<span class="ident" id="5619435">http</span><span class="op" id="5619439">.</span><span class="ident" id="5619440">Header</span><span class="op" id="5619446">{</span><span class="op" id="5619447">}</span><span class="op" id="5619448">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619452">w</span><span class="op" id="5619453">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5619460">newWriter</span><span class="op" id="5619469">(</span><span class="ident" id="5619470">c</span><span class="op" id="5619471">.</span><span class="ident" id="5619472">conn</span><span class="op" id="5619476">,</span>&nbsp;<span class="ident" id="5619478">typeStdout</span><span class="op" id="5619488">,</span>&nbsp;<span class="ident" id="5619490">req</span><span class="op" id="5619493">.</span><span class="ident" id="5619494">reqId</span><span class="op" id="5619499">)</span><span class="op" id="5619500">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5619503">}</span><br>
<span class="lineno"></span><span class="op" id="5619505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5619508">func</span>&nbsp;<span class="op" id="5619513">(</span><span class="ident" id="5619514">r</span>&nbsp;<span class="op" id="5619516">*</span><span class="ident" id="5619517">response</span><span class="op" id="5619525">)</span>&nbsp;<span class="ident" id="5619527">Header</span><span class="op" id="5619533">(</span><span class="op" id="5619534">)</span>&nbsp;<span class="ident" id="5619536">http</span><span class="op" id="5619540">.</span><span class="ident" id="5619541">Header</span>&nbsp;<span class="op" id="5619548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619551">return</span>&nbsp;<span class="ident" id="5619558">r</span><span class="op" id="5619559">.</span><span class="ident" id="5619560">header</span><br>
<span class="lineno">85</span><span class="op" id="5619567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5619570">func</span>&nbsp;<span class="op" id="5619575">(</span><span class="ident" id="5619576">r</span>&nbsp;<span class="op" id="5619578">*</span><span class="ident" id="5619579">response</span><span class="op" id="5619587">)</span>&nbsp;<span class="ident" id="5619589">Write</span><span class="op" id="5619594">(</span><span class="ident" id="5619595">data</span>&nbsp;<span class="op" id="5619600">[</span><span class="op" id="5619601">]</span><span class="builtintype" id="5619602">byte</span><span class="op" id="5619606">)</span>&nbsp;<span class="op" id="5619608">(</span><span class="builtintype" id="5619609">int</span><span class="op" id="5619612">,</span>&nbsp;<span class="builtintype" id="5619614">error</span><span class="op" id="5619619">)</span>&nbsp;<span class="op" id="5619621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619624">if</span>&nbsp;<span class="op" id="5619627">!</span><span class="ident" id="5619628">r</span><span class="op" id="5619629">.</span><span class="ident" id="5619630">wroteHeader</span>&nbsp;<span class="op" id="5619642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619646">r</span><span class="op" id="5619647">.</span><span class="ident" id="5619648">WriteHeader</span><span class="op" id="5619659">(</span><span class="ident" id="5619660">http</span><span class="op" id="5619664">.</span><span class="ident" id="5619665">StatusOK</span><span class="op" id="5619673">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5619676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619679">return</span>&nbsp;<span class="ident" id="5619686">r</span><span class="op" id="5619687">.</span><span class="ident" id="5619688">w</span><span class="op" id="5619689">.</span><span class="ident" id="5619690">Write</span><span class="op" id="5619695">(</span><span class="ident" id="5619696">data</span><span class="op" id="5619700">)</span><br>
<span class="lineno"></span><span class="op" id="5619702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5619705">func</span>&nbsp;<span class="op" id="5619710">(</span><span class="ident" id="5619711">r</span>&nbsp;<span class="op" id="5619713">*</span><span class="ident" id="5619714">response</span><span class="op" id="5619722">)</span>&nbsp;<span class="ident" id="5619724">WriteHeader</span><span class="op" id="5619735">(</span><span class="ident" id="5619736">code</span>&nbsp;<span class="builtintype" id="5619741">int</span><span class="op" id="5619744">)</span>&nbsp;<span class="op" id="5619746">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619749">if</span>&nbsp;<span class="ident" id="5619752">r</span><span class="op" id="5619753">.</span><span class="ident" id="5619754">wroteHeader</span>&nbsp;<span class="op" id="5619766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619770">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5619778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619781">r</span><span class="op" id="5619782">.</span><span class="ident" id="5619783">wroteHeader</span>&nbsp;<span class="op" id="5619795">=</span>&nbsp;<span class="builtintype" id="5619797">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619803">if</span>&nbsp;<span class="ident" id="5619806">code</span>&nbsp;<span class="op" id="5619811">==</span>&nbsp;<span class="ident" id="5619814">http</span><span class="op" id="5619818">.</span><span class="ident" id="5619819">StatusNotModified</span>&nbsp;<span class="op" id="5619837">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5619841">//&nbsp;Must&nbsp;not&nbsp;have&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619866">r</span><span class="op" id="5619867">.</span><span class="ident" id="5619868">header</span><span class="op" id="5619874">.</span><span class="ident" id="5619875">Del</span><span class="op" id="5619878">(</span><span class="string" id="5619879">&#34;Content-Type&#34;</span><span class="op" id="5619893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619897">r</span><span class="op" id="5619898">.</span><span class="ident" id="5619899">header</span><span class="op" id="5619905">.</span><span class="ident" id="5619906">Del</span><span class="op" id="5619909">(</span><span class="string" id="5619910">&#34;Content-Length&#34;</span><span class="op" id="5619926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619930">r</span><span class="op" id="5619931">.</span><span class="ident" id="5619932">header</span><span class="op" id="5619938">.</span><span class="ident" id="5619939">Del</span><span class="op" id="5619942">(</span><span class="string" id="5619943">&#34;Transfer-Encoding&#34;</span><span class="op" id="5619962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5619965">}</span>&nbsp;<span class="keyword" id="5619967">else</span>&nbsp;<span class="keyword" id="5619972">if</span>&nbsp;<span class="ident" id="5619975">r</span><span class="op" id="5619976">.</span><span class="ident" id="5619977">header</span><span class="op" id="5619983">.</span><span class="ident" id="5619984">Get</span><span class="op" id="5619987">(</span><span class="string" id="5619988">&#34;Content-Type&#34;</span><span class="op" id="5620002">)</span>&nbsp;<span class="op" id="5620004">==</span>&nbsp;<span class="string" id="5620007">&#34;&#34;</span>&nbsp;<span class="op" id="5620010">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620014">r</span><span class="op" id="5620015">.</span><span class="ident" id="5620016">header</span><span class="op" id="5620022">.</span><span class="ident" id="5620023">Set</span><span class="op" id="5620026">(</span><span class="string" id="5620027">&#34;Content-Type&#34;</span><span class="op" id="5620041">,</span>&nbsp;<span class="string" id="5620043">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="5620069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5620072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620076">if</span>&nbsp;<span class="ident" id="5620079">r</span><span class="op" id="5620080">.</span><span class="ident" id="5620081">header</span><span class="op" id="5620087">.</span><span class="ident" id="5620088">Get</span><span class="op" id="5620091">(</span><span class="string" id="5620092">&#34;Date&#34;</span><span class="op" id="5620098">)</span>&nbsp;<span class="op" id="5620100">==</span>&nbsp;<span class="string" id="5620103">&#34;&#34;</span>&nbsp;<span class="op" id="5620106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620110">r</span><span class="op" id="5620111">.</span><span class="ident" id="5620112">header</span><span class="op" id="5620118">.</span><span class="ident" id="5620119">Set</span><span class="op" id="5620122">(</span><span class="string" id="5620123">&#34;Date&#34;</span><span class="op" id="5620129">,</span>&nbsp;<span class="ident" id="5620131">time</span><span class="op" id="5620135">.</span><span class="ident" id="5620136">Now</span><span class="op" id="5620139">(</span><span class="op" id="5620140">)</span><span class="op" id="5620141">.</span><span class="ident" id="5620142">UTC</span><span class="op" id="5620145">(</span><span class="op" id="5620146">)</span><span class="op" id="5620147">.</span><span class="ident" id="5620148">Format</span><span class="op" id="5620154">(</span><span class="ident" id="5620155">http</span><span class="op" id="5620159">.</span><span class="ident" id="5620160">TimeFormat</span><span class="op" id="5620170">)</span><span class="op" id="5620171">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5620174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620178">fmt</span><span class="op" id="5620181">.</span><span class="ident" id="5620182">Fprintf</span><span class="op" id="5620189">(</span><span class="ident" id="5620190">r</span><span class="op" id="5620191">.</span><span class="ident" id="5620192">w</span><span class="op" id="5620193">,</span>&nbsp;<span class="string" id="5620195">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="5620214">,</span>&nbsp;<span class="ident" id="5620216">code</span><span class="op" id="5620220">,</span>&nbsp;<span class="ident" id="5620222">http</span><span class="op" id="5620226">.</span><span class="ident" id="5620227">StatusText</span><span class="op" id="5620237">(</span><span class="ident" id="5620238">code</span><span class="op" id="5620242">)</span><span class="op" id="5620243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620246">r</span><span class="op" id="5620247">.</span><span class="ident" id="5620248">header</span><span class="op" id="5620254">.</span><span class="ident" id="5620255">Write</span><span class="op" id="5620260">(</span><span class="ident" id="5620261">r</span><span class="op" id="5620262">.</span><span class="ident" id="5620263">w</span><span class="op" id="5620264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620267">r</span><span class="op" id="5620268">.</span><span class="ident" id="5620269">w</span><span class="op" id="5620270">.</span><span class="ident" id="5620271">WriteString</span><span class="op" id="5620282">(</span><span class="string" id="5620283">&#34;\r\n&#34;</span><span class="op" id="5620289">)</span><br>
<span class="lineno">115</span><span class="op" id="5620291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5620294">func</span>&nbsp;<span class="op" id="5620299">(</span><span class="ident" id="5620300">r</span>&nbsp;<span class="op" id="5620302">*</span><span class="ident" id="5620303">response</span><span class="op" id="5620311">)</span>&nbsp;<span class="ident" id="5620313">Flush</span><span class="op" id="5620318">(</span><span class="op" id="5620319">)</span>&nbsp;<span class="op" id="5620321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620324">if</span>&nbsp;<span class="op" id="5620327">!</span><span class="ident" id="5620328">r</span><span class="op" id="5620329">.</span><span class="ident" id="5620330">wroteHeader</span>&nbsp;<span class="op" id="5620342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620346">r</span><span class="op" id="5620347">.</span><span class="ident" id="5620348">WriteHeader</span><span class="op" id="5620359">(</span><span class="ident" id="5620360">http</span><span class="op" id="5620364">.</span><span class="ident" id="5620365">StatusOK</span><span class="op" id="5620373">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5620376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620379">r</span><span class="op" id="5620380">.</span><span class="ident" id="5620381">w</span><span class="op" id="5620382">.</span><span class="ident" id="5620383">Flush</span><span class="op" id="5620388">(</span><span class="op" id="5620389">)</span><br>
<span class="lineno"></span><span class="op" id="5620391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5620394">func</span>&nbsp;<span class="op" id="5620399">(</span><span class="ident" id="5620400">r</span>&nbsp;<span class="op" id="5620402">*</span><span class="ident" id="5620403">response</span><span class="op" id="5620411">)</span>&nbsp;<span class="ident" id="5620413">Close</span><span class="op" id="5620418">(</span><span class="op" id="5620419">)</span>&nbsp;<span class="builtintype" id="5620421">error</span>&nbsp;<span class="op" id="5620427">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620430">r</span><span class="op" id="5620431">.</span><span class="ident" id="5620432">Flush</span><span class="op" id="5620437">(</span><span class="op" id="5620438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620441">return</span>&nbsp;<span class="ident" id="5620448">r</span><span class="op" id="5620449">.</span><span class="ident" id="5620450">w</span><span class="op" id="5620451">.</span><span class="ident" id="5620452">Close</span><span class="op" id="5620457">(</span><span class="op" id="5620458">)</span><br>
<span class="lineno"></span><span class="op" id="5620460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5620463">type</span>&nbsp;<span class="ident" id="5620468">child</span>&nbsp;<span class="keyword" id="5620474">struct</span>&nbsp;<span class="op" id="5620481">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620484">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5620492">*</span><span class="ident" id="5620493">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620499">handler</span>&nbsp;<span class="ident" id="5620507">http</span><span class="op" id="5620511">.</span><span class="ident" id="5620512">Handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620522">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5620531">sync</span><span class="op" id="5620535">.</span><span class="ident" id="5620536">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5620551">//&nbsp;protects&nbsp;requests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620574">requests</span>&nbsp;<span class="keyword" id="5620583">map</span><span class="op" id="5620586">[</span><span class="builtintype" id="5620587">uint16</span><span class="op" id="5620593">]</span><span class="op" id="5620594">*</span><span class="ident" id="5620595">request</span>&nbsp;<span class="comment" id="5620603">//&nbsp;keyed&nbsp;by&nbsp;request&nbsp;ID</span><br>
<span class="lineno">135</span><span class="op" id="5620626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5620629">func</span>&nbsp;<span class="ident" id="5620634">newChild</span><span class="op" id="5620642">(</span><span class="ident" id="5620643">rwc</span>&nbsp;<span class="ident" id="5620647">io</span><span class="op" id="5620649">.</span><span class="ident" id="5620650">ReadWriteCloser</span><span class="op" id="5620665">,</span>&nbsp;<span class="ident" id="5620667">handler</span>&nbsp;<span class="ident" id="5620675">http</span><span class="op" id="5620679">.</span><span class="ident" id="5620680">Handler</span><span class="op" id="5620687">)</span>&nbsp;<span class="op" id="5620689">*</span><span class="ident" id="5620690">child</span>&nbsp;<span class="op" id="5620696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620699">return</span>&nbsp;<span class="op" id="5620706">&amp;</span><span class="ident" id="5620707">child</span><span class="op" id="5620712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620716">conn</span><span class="op" id="5620720">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5620726">newConn</span><span class="op" id="5620733">(</span><span class="ident" id="5620734">rwc</span><span class="op" id="5620737">)</span><span class="op" id="5620738">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620742">handler</span><span class="op" id="5620749">:</span>&nbsp;&nbsp;<span class="ident" id="5620752">handler</span><span class="op" id="5620759">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620763">requests</span><span class="op" id="5620771">:</span>&nbsp;<span class="builtinfunc" id="5620773">make</span><span class="op" id="5620777">(</span><span class="keyword" id="5620778">map</span><span class="op" id="5620781">[</span><span class="builtintype" id="5620782">uint16</span><span class="op" id="5620788">]</span><span class="op" id="5620789">*</span><span class="ident" id="5620790">request</span><span class="op" id="5620797">)</span><span class="op" id="5620798">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5620801">}</span><br>
<span class="lineno"></span><span class="op" id="5620803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="5620806">func</span>&nbsp;<span class="op" id="5620811">(</span><span class="ident" id="5620812">c</span>&nbsp;<span class="op" id="5620814">*</span><span class="ident" id="5620815">child</span><span class="op" id="5620820">)</span>&nbsp;<span class="ident" id="5620822">serve</span><span class="op" id="5620827">(</span><span class="op" id="5620828">)</span>&nbsp;<span class="op" id="5620830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620833">defer</span>&nbsp;<span class="ident" id="5620839">c</span><span class="op" id="5620840">.</span><span class="ident" id="5620841">conn</span><span class="op" id="5620845">.</span><span class="ident" id="5620846">Close</span><span class="op" id="5620851">(</span><span class="op" id="5620852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620855">var</span>&nbsp;<span class="ident" id="5620859">rec</span>&nbsp;<span class="ident" id="5620863">record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620871">for</span>&nbsp;<span class="op" id="5620875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620879">if</span>&nbsp;<span class="ident" id="5620882">err</span>&nbsp;<span class="op" id="5620886">:=</span>&nbsp;<span class="ident" id="5620889">rec</span><span class="op" id="5620892">.</span><span class="ident" id="5620893">read</span><span class="op" id="5620897">(</span><span class="ident" id="5620898">c</span><span class="op" id="5620899">.</span><span class="ident" id="5620900">conn</span><span class="op" id="5620904">.</span><span class="ident" id="5620905">rwc</span><span class="op" id="5620908">)</span><span class="op" id="5620909">;</span>&nbsp;<span class="ident" id="5620911">err</span>&nbsp;<span class="op" id="5620915">!=</span>&nbsp;<span class="ident" id="5620918">nil</span>&nbsp;<span class="op" id="5620922">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620927">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5620936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620940">if</span>&nbsp;<span class="ident" id="5620943">err</span>&nbsp;<span class="op" id="5620947">:=</span>&nbsp;<span class="ident" id="5620950">c</span><span class="op" id="5620951">.</span><span class="ident" id="5620952">handleRecord</span><span class="op" id="5620964">(</span><span class="op" id="5620965">&amp;</span><span class="ident" id="5620966">rec</span><span class="op" id="5620969">)</span><span class="op" id="5620970">;</span>&nbsp;<span class="ident" id="5620972">err</span>&nbsp;<span class="op" id="5620976">!=</span>&nbsp;<span class="ident" id="5620979">nil</span>&nbsp;<span class="op" id="5620983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620988">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5620997">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621000">}</span><br>
<span class="lineno"></span><span class="op" id="5621002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5621005">var</span>&nbsp;<span class="ident" id="5621009">errCloseConn</span>&nbsp;<span class="op" id="5621022">=</span>&nbsp;<span class="ident" id="5621024">errors</span><span class="op" id="5621030">.</span><span class="ident" id="5621031">New</span><span class="op" id="5621034">(</span><span class="string" id="5621035">&#34;fcgi:&nbsp;connection&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="5621070">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="5621073">var</span>&nbsp;<span class="ident" id="5621077">emptyBody</span>&nbsp;<span class="op" id="5621087">=</span>&nbsp;<span class="ident" id="5621089">ioutil</span><span class="op" id="5621095">.</span><span class="ident" id="5621096">NopCloser</span><span class="op" id="5621105">(</span><span class="ident" id="5621106">strings</span><span class="op" id="5621113">.</span><span class="ident" id="5621114">NewReader</span><span class="op" id="5621123">(</span><span class="string" id="5621124">&#34;&#34;</span><span class="op" id="5621126">)</span><span class="op" id="5621127">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5621130">func</span>&nbsp;<span class="op" id="5621135">(</span><span class="ident" id="5621136">c</span>&nbsp;<span class="op" id="5621138">*</span><span class="ident" id="5621139">child</span><span class="op" id="5621144">)</span>&nbsp;<span class="ident" id="5621146">handleRecord</span><span class="op" id="5621158">(</span><span class="ident" id="5621159">rec</span>&nbsp;<span class="op" id="5621163">*</span><span class="ident" id="5621164">record</span><span class="op" id="5621170">)</span>&nbsp;<span class="builtintype" id="5621172">error</span>&nbsp;<span class="op" id="5621178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621181">c</span><span class="op" id="5621182">.</span><span class="ident" id="5621183">mu</span><span class="op" id="5621185">.</span><span class="ident" id="5621186">Lock</span><span class="op" id="5621190">(</span><span class="op" id="5621191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621194">req</span><span class="op" id="5621197">,</span>&nbsp;<span class="ident" id="5621199">ok</span>&nbsp;<span class="op" id="5621202">:=</span>&nbsp;<span class="ident" id="5621205">c</span><span class="op" id="5621206">.</span><span class="ident" id="5621207">requests</span><span class="op" id="5621215">[</span><span class="ident" id="5621216">rec</span><span class="op" id="5621219">.</span><span class="ident" id="5621220">h</span><span class="op" id="5621221">.</span><span class="ident" id="5621222">Id</span><span class="op" id="5621224">]</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621227">c</span><span class="op" id="5621228">.</span><span class="ident" id="5621229">mu</span><span class="op" id="5621231">.</span><span class="ident" id="5621232">Unlock</span><span class="op" id="5621238">(</span><span class="op" id="5621239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621242">if</span>&nbsp;<span class="op" id="5621245">!</span><span class="ident" id="5621246">ok</span>&nbsp;<span class="op" id="5621249">&amp;&amp;</span>&nbsp;<span class="ident" id="5621252">rec</span><span class="op" id="5621255">.</span><span class="ident" id="5621256">h</span><span class="op" id="5621257">.</span><span class="ident" id="5621258">Type</span>&nbsp;<span class="op" id="5621263">!=</span>&nbsp;<span class="ident" id="5621266">typeBeginRequest</span>&nbsp;<span class="op" id="5621283">&amp;&amp;</span>&nbsp;<span class="ident" id="5621286">rec</span><span class="op" id="5621289">.</span><span class="ident" id="5621290">h</span><span class="op" id="5621291">.</span><span class="ident" id="5621292">Type</span>&nbsp;<span class="op" id="5621297">!=</span>&nbsp;<span class="ident" id="5621300">typeGetValues</span>&nbsp;<span class="op" id="5621314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5621318">//&nbsp;The&nbsp;spec&nbsp;says&nbsp;to&nbsp;ignore&nbsp;unknown&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621368">return</span>&nbsp;<span class="ident" id="5621375">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621380">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621384">switch</span>&nbsp;<span class="ident" id="5621391">rec</span><span class="op" id="5621394">.</span><span class="ident" id="5621395">h</span><span class="op" id="5621396">.</span><span class="ident" id="5621397">Type</span>&nbsp;<span class="op" id="5621402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621405">case</span>&nbsp;<span class="ident" id="5621410">typeBeginRequest</span><span class="op" id="5621426">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621430">if</span>&nbsp;<span class="ident" id="5621433">req</span>&nbsp;<span class="op" id="5621437">!=</span>&nbsp;<span class="ident" id="5621440">nil</span>&nbsp;<span class="op" id="5621444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5621449">//&nbsp;The&nbsp;server&nbsp;is&nbsp;trying&nbsp;to&nbsp;begin&nbsp;a&nbsp;request&nbsp;with&nbsp;the&nbsp;same&nbsp;ID</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5621512">//&nbsp;as&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;This&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621563">return</span>&nbsp;<span class="ident" id="5621570">errors</span><span class="op" id="5621576">.</span><span class="ident" id="5621577">New</span><span class="op" id="5621580">(</span><span class="string" id="5621581">&#34;fcgi:&nbsp;received&nbsp;ID&nbsp;that&nbsp;is&nbsp;already&nbsp;in-flight&#34;</span><span class="op" id="5621626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621635">var</span>&nbsp;<span class="ident" id="5621639">br</span>&nbsp;<span class="ident" id="5621642">beginRequest</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621657">if</span>&nbsp;<span class="ident" id="5621660">err</span>&nbsp;<span class="op" id="5621664">:=</span>&nbsp;<span class="ident" id="5621667">br</span><span class="op" id="5621669">.</span><span class="ident" id="5621670">read</span><span class="op" id="5621674">(</span><span class="ident" id="5621675">rec</span><span class="op" id="5621678">.</span><span class="ident" id="5621679">content</span><span class="op" id="5621686">(</span><span class="op" id="5621687">)</span><span class="op" id="5621688">)</span><span class="op" id="5621689">;</span>&nbsp;<span class="ident" id="5621691">err</span>&nbsp;<span class="op" id="5621695">!=</span>&nbsp;<span class="ident" id="5621698">nil</span>&nbsp;<span class="op" id="5621702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621707">return</span>&nbsp;<span class="ident" id="5621714">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621724">if</span>&nbsp;<span class="ident" id="5621727">br</span><span class="op" id="5621729">.</span><span class="ident" id="5621730">role</span>&nbsp;<span class="op" id="5621735">!=</span>&nbsp;<span class="ident" id="5621738">roleResponder</span>&nbsp;<span class="op" id="5621752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621757">c</span><span class="op" id="5621758">.</span><span class="ident" id="5621759">conn</span><span class="op" id="5621763">.</span><span class="ident" id="5621764">writeEndRequest</span><span class="op" id="5621779">(</span><span class="ident" id="5621780">rec</span><span class="op" id="5621783">.</span><span class="ident" id="5621784">h</span><span class="op" id="5621785">.</span><span class="ident" id="5621786">Id</span><span class="op" id="5621788">,</span>&nbsp;<span class="num" id="5621790">0</span><span class="op" id="5621791">,</span>&nbsp;<span class="ident" id="5621793">statusUnknownRole</span><span class="op" id="5621810">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621815">return</span>&nbsp;<span class="ident" id="5621822">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621832">req</span>&nbsp;<span class="op" id="5621836">=</span>&nbsp;<span class="ident" id="5621838">newRequest</span><span class="op" id="5621848">(</span><span class="ident" id="5621849">rec</span><span class="op" id="5621852">.</span><span class="ident" id="5621853">h</span><span class="op" id="5621854">.</span><span class="ident" id="5621855">Id</span><span class="op" id="5621857">,</span>&nbsp;<span class="ident" id="5621859">br</span><span class="op" id="5621861">.</span><span class="ident" id="5621862">flags</span><span class="op" id="5621867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621871">c</span><span class="op" id="5621872">.</span><span class="ident" id="5621873">mu</span><span class="op" id="5621875">.</span><span class="ident" id="5621876">Lock</span><span class="op" id="5621880">(</span><span class="op" id="5621881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621885">c</span><span class="op" id="5621886">.</span><span class="ident" id="5621887">requests</span><span class="op" id="5621895">[</span><span class="ident" id="5621896">rec</span><span class="op" id="5621899">.</span><span class="ident" id="5621900">h</span><span class="op" id="5621901">.</span><span class="ident" id="5621902">Id</span><span class="op" id="5621904">]</span>&nbsp;<span class="op" id="5621906">=</span>&nbsp;<span class="ident" id="5621908">req</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621914">c</span><span class="op" id="5621915">.</span><span class="ident" id="5621916">mu</span><span class="op" id="5621918">.</span><span class="ident" id="5621919">Unlock</span><span class="op" id="5621925">(</span><span class="op" id="5621926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621930">return</span>&nbsp;<span class="ident" id="5621937">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621942">case</span>&nbsp;<span class="ident" id="5621947">typeParams</span><span class="op" id="5621957">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5621961">//&nbsp;NOTE(eds):&nbsp;Technically&nbsp;a&nbsp;key-value&nbsp;pair&nbsp;can&nbsp;straddle&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5622032">//&nbsp;between&nbsp;two&nbsp;packets.&nbsp;We&nbsp;buffer&nbsp;until&nbsp;we&#39;ve&nbsp;received&nbsp;all&nbsp;parameters.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622105">if</span>&nbsp;<span class="builtinfunc" id="5622108">len</span><span class="op" id="5622111">(</span><span class="ident" id="5622112">rec</span><span class="op" id="5622115">.</span><span class="ident" id="5622116">content</span><span class="op" id="5622123">(</span><span class="op" id="5622124">)</span><span class="op" id="5622125">)</span>&nbsp;<span class="op" id="5622127">&gt;</span>&nbsp;<span class="num" id="5622129">0</span>&nbsp;<span class="op" id="5622131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622136">req</span><span class="op" id="5622139">.</span><span class="ident" id="5622140">rawParams</span>&nbsp;<span class="op" id="5622150">=</span>&nbsp;<span class="builtinfunc" id="5622152">append</span><span class="op" id="5622158">(</span><span class="ident" id="5622159">req</span><span class="op" id="5622162">.</span><span class="ident" id="5622163">rawParams</span><span class="op" id="5622172">,</span>&nbsp;<span class="ident" id="5622174">rec</span><span class="op" id="5622177">.</span><span class="ident" id="5622178">content</span><span class="op" id="5622185">(</span><span class="op" id="5622186">)</span><span class="op" id="5622187">...</span><span class="op" id="5622190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622195">return</span>&nbsp;<span class="ident" id="5622202">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5622208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622212">req</span><span class="op" id="5622215">.</span><span class="ident" id="5622216">parseParams</span><span class="op" id="5622227">(</span><span class="op" id="5622228">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622232">return</span>&nbsp;<span class="ident" id="5622239">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622244">case</span>&nbsp;<span class="ident" id="5622249">typeStdin</span><span class="op" id="5622258">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622262">content</span>&nbsp;<span class="op" id="5622270">:=</span>&nbsp;<span class="ident" id="5622273">rec</span><span class="op" id="5622276">.</span><span class="ident" id="5622277">content</span><span class="op" id="5622284">(</span><span class="op" id="5622285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622289">if</span>&nbsp;<span class="ident" id="5622292">req</span><span class="op" id="5622295">.</span><span class="ident" id="5622296">pw</span>&nbsp;<span class="op" id="5622299">==</span>&nbsp;<span class="ident" id="5622302">nil</span>&nbsp;<span class="op" id="5622306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622311">var</span>&nbsp;<span class="ident" id="5622315">body</span>&nbsp;<span class="ident" id="5622320">io</span><span class="op" id="5622322">.</span><span class="ident" id="5622323">ReadCloser</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622337">if</span>&nbsp;<span class="builtinfunc" id="5622340">len</span><span class="op" id="5622343">(</span><span class="ident" id="5622344">content</span><span class="op" id="5622351">)</span>&nbsp;<span class="op" id="5622353">&gt;</span>&nbsp;<span class="num" id="5622355">0</span>&nbsp;<span class="op" id="5622357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5622363">//&nbsp;body&nbsp;could&nbsp;be&nbsp;an&nbsp;io.LimitReader,&nbsp;but&nbsp;it&nbsp;shouldn&#39;t&nbsp;matter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5622427">//&nbsp;as&nbsp;long&nbsp;as&nbsp;both&nbsp;sides&nbsp;are&nbsp;behaving.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622470">body</span><span class="op" id="5622474">,</span>&nbsp;<span class="ident" id="5622476">req</span><span class="op" id="5622479">.</span><span class="ident" id="5622480">pw</span>&nbsp;<span class="op" id="5622483">=</span>&nbsp;<span class="ident" id="5622485">io</span><span class="op" id="5622487">.</span><span class="ident" id="5622488">Pipe</span><span class="op" id="5622492">(</span><span class="op" id="5622493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5622498">}</span>&nbsp;<span class="keyword" id="5622500">else</span>&nbsp;<span class="op" id="5622505">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622511">body</span>&nbsp;<span class="op" id="5622516">=</span>&nbsp;<span class="ident" id="5622518">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5622531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622536">go</span>&nbsp;<span class="ident" id="5622539">c</span><span class="op" id="5622540">.</span><span class="ident" id="5622541">serveRequest</span><span class="op" id="5622553">(</span><span class="ident" id="5622554">req</span><span class="op" id="5622557">,</span>&nbsp;<span class="ident" id="5622559">body</span><span class="op" id="5622563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5622567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622571">if</span>&nbsp;<span class="builtinfunc" id="5622574">len</span><span class="op" id="5622577">(</span><span class="ident" id="5622578">content</span><span class="op" id="5622585">)</span>&nbsp;<span class="op" id="5622587">&gt;</span>&nbsp;<span class="num" id="5622589">0</span>&nbsp;<span class="op" id="5622591">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5622596">//&nbsp;TODO(eds):&nbsp;This&nbsp;blocks&nbsp;until&nbsp;the&nbsp;handler&nbsp;reads&nbsp;from&nbsp;the&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5622664">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;takes&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;might&nbsp;be&nbsp;a&nbsp;problem.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622727">req</span><span class="op" id="5622730">.</span><span class="ident" id="5622731">pw</span><span class="op" id="5622733">.</span><span class="ident" id="5622734">Write</span><span class="op" id="5622739">(</span><span class="ident" id="5622740">content</span><span class="op" id="5622747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5622751">}</span>&nbsp;<span class="keyword" id="5622753">else</span>&nbsp;<span class="keyword" id="5622758">if</span>&nbsp;<span class="ident" id="5622761">req</span><span class="op" id="5622764">.</span><span class="ident" id="5622765">pw</span>&nbsp;<span class="op" id="5622768">!=</span>&nbsp;<span class="ident" id="5622771">nil</span>&nbsp;<span class="op" id="5622775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622780">req</span><span class="op" id="5622783">.</span><span class="ident" id="5622784">pw</span><span class="op" id="5622786">.</span><span class="ident" id="5622787">Close</span><span class="op" id="5622792">(</span><span class="op" id="5622793">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5622797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622801">return</span>&nbsp;<span class="ident" id="5622808">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622813">case</span>&nbsp;<span class="ident" id="5622818">typeGetValues</span><span class="op" id="5622831">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622835">values</span>&nbsp;<span class="op" id="5622842">:=</span>&nbsp;<span class="keyword" id="5622845">map</span><span class="op" id="5622848">[</span><span class="builtintype" id="5622849">string</span><span class="op" id="5622855">]</span><span class="builtintype" id="5622856">string</span><span class="op" id="5622862">{</span><span class="string" id="5622863">&#34;FCGI_MPXS_CONNS&#34;</span><span class="op" id="5622880">:</span>&nbsp;<span class="string" id="5622882">&#34;1&#34;</span><span class="op" id="5622885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622889">c</span><span class="op" id="5622890">.</span><span class="ident" id="5622891">conn</span><span class="op" id="5622895">.</span><span class="ident" id="5622896">writePairs</span><span class="op" id="5622906">(</span><span class="ident" id="5622907">typeGetValuesResult</span><span class="op" id="5622926">,</span>&nbsp;<span class="num" id="5622928">0</span><span class="op" id="5622929">,</span>&nbsp;<span class="ident" id="5622931">values</span><span class="op" id="5622937">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622941">return</span>&nbsp;<span class="ident" id="5622948">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622953">case</span>&nbsp;<span class="ident" id="5622958">typeData</span><span class="op" id="5622966">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5622970">//&nbsp;If&nbsp;the&nbsp;filter&nbsp;role&nbsp;is&nbsp;implemented,&nbsp;read&nbsp;the&nbsp;data&nbsp;stream&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5623037">return</span>&nbsp;<span class="ident" id="5623044">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5623049">case</span>&nbsp;<span class="ident" id="5623054">typeAbortRequest</span><span class="op" id="5623070">:</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5623074">println</span><span class="op" id="5623081">(</span><span class="string" id="5623082">&#34;abort&#34;</span><span class="op" id="5623089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623093">c</span><span class="op" id="5623094">.</span><span class="ident" id="5623095">mu</span><span class="op" id="5623097">.</span><span class="ident" id="5623098">Lock</span><span class="op" id="5623102">(</span><span class="op" id="5623103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5623107">delete</span><span class="op" id="5623113">(</span><span class="ident" id="5623114">c</span><span class="op" id="5623115">.</span><span class="ident" id="5623116">requests</span><span class="op" id="5623124">,</span>&nbsp;<span class="ident" id="5623126">rec</span><span class="op" id="5623129">.</span><span class="ident" id="5623130">h</span><span class="op" id="5623131">.</span><span class="ident" id="5623132">Id</span><span class="op" id="5623134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623138">c</span><span class="op" id="5623139">.</span><span class="ident" id="5623140">mu</span><span class="op" id="5623142">.</span><span class="ident" id="5623143">Unlock</span><span class="op" id="5623149">(</span><span class="op" id="5623150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623154">c</span><span class="op" id="5623155">.</span><span class="ident" id="5623156">conn</span><span class="op" id="5623160">.</span><span class="ident" id="5623161">writeEndRequest</span><span class="op" id="5623176">(</span><span class="ident" id="5623177">rec</span><span class="op" id="5623180">.</span><span class="ident" id="5623181">h</span><span class="op" id="5623182">.</span><span class="ident" id="5623183">Id</span><span class="op" id="5623185">,</span>&nbsp;<span class="num" id="5623187">0</span><span class="op" id="5623188">,</span>&nbsp;<span class="ident" id="5623190">statusRequestComplete</span><span class="op" id="5623211">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5623215">if</span>&nbsp;<span class="op" id="5623218">!</span><span class="ident" id="5623219">req</span><span class="op" id="5623222">.</span><span class="ident" id="5623223">keepConn</span>&nbsp;<span class="op" id="5623232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5623237">//&nbsp;connection&nbsp;will&nbsp;close&nbsp;upon&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5623277">return</span>&nbsp;<span class="ident" id="5623284">errCloseConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5623299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5623303">return</span>&nbsp;<span class="ident" id="5623310">nil</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5623315">default</span><span class="op" id="5623322">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623326">b</span>&nbsp;<span class="op" id="5623328">:=</span>&nbsp;<span class="builtinfunc" id="5623331">make</span><span class="op" id="5623335">(</span><span class="op" id="5623336">[</span><span class="op" id="5623337">]</span><span class="builtintype" id="5623338">byte</span><span class="op" id="5623342">,</span>&nbsp;<span class="num" id="5623344">8</span><span class="op" id="5623345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623349">b</span><span class="op" id="5623350">[</span><span class="num" id="5623351">0</span><span class="op" id="5623352">]</span>&nbsp;<span class="op" id="5623354">=</span>&nbsp;<span class="builtintype" id="5623356">byte</span><span class="op" id="5623360">(</span><span class="ident" id="5623361">rec</span><span class="op" id="5623364">.</span><span class="ident" id="5623365">h</span><span class="op" id="5623366">.</span><span class="ident" id="5623367">Type</span><span class="op" id="5623371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623375">c</span><span class="op" id="5623376">.</span><span class="ident" id="5623377">conn</span><span class="op" id="5623381">.</span><span class="ident" id="5623382">writeRecord</span><span class="op" id="5623393">(</span><span class="ident" id="5623394">typeUnknownType</span><span class="op" id="5623409">,</span>&nbsp;<span class="num" id="5623411">0</span><span class="op" id="5623412">,</span>&nbsp;<span class="ident" id="5623414">b</span><span class="op" id="5623415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5623419">return</span>&nbsp;<span class="ident" id="5623426">nil</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5623431">}</span><br>
<span class="lineno"></span><span class="op" id="5623433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5623436">func</span>&nbsp;<span class="op" id="5623441">(</span><span class="ident" id="5623442">c</span>&nbsp;<span class="op" id="5623444">*</span><span class="ident" id="5623445">child</span><span class="op" id="5623450">)</span>&nbsp;<span class="ident" id="5623452">serveRequest</span><span class="op" id="5623464">(</span><span class="ident" id="5623465">req</span>&nbsp;<span class="op" id="5623469">*</span><span class="ident" id="5623470">request</span><span class="op" id="5623477">,</span>&nbsp;<span class="ident" id="5623479">body</span>&nbsp;<span class="ident" id="5623484">io</span><span class="op" id="5623486">.</span><span class="ident" id="5623487">ReadCloser</span><span class="op" id="5623497">)</span>&nbsp;<span class="op" id="5623499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623502">r</span>&nbsp;<span class="op" id="5623504">:=</span>&nbsp;<span class="ident" id="5623507">newResponse</span><span class="op" id="5623518">(</span><span class="ident" id="5623519">c</span><span class="op" id="5623520">,</span>&nbsp;<span class="ident" id="5623522">req</span><span class="op" id="5623525">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623528">httpReq</span><span class="op" id="5623535">,</span>&nbsp;<span class="ident" id="5623537">err</span>&nbsp;<span class="op" id="5623541">:=</span>&nbsp;<span class="ident" id="5623544">cgi</span><span class="op" id="5623547">.</span><span class="ident" id="5623548">RequestFromMap</span><span class="op" id="5623562">(</span><span class="ident" id="5623563">req</span><span class="op" id="5623566">.</span><span class="ident" id="5623567">params</span><span class="op" id="5623573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5623576">if</span>&nbsp;<span class="ident" id="5623579">err</span>&nbsp;<span class="op" id="5623583">!=</span>&nbsp;<span class="ident" id="5623586">nil</span>&nbsp;<span class="op" id="5623590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5623594">//&nbsp;there&nbsp;was&nbsp;an&nbsp;error&nbsp;reading&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623638">r</span><span class="op" id="5623639">.</span><span class="ident" id="5623640">WriteHeader</span><span class="op" id="5623651">(</span><span class="ident" id="5623652">http</span><span class="op" id="5623656">.</span><span class="ident" id="5623657">StatusInternalServerError</span><span class="op" id="5623682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623686">c</span><span class="op" id="5623687">.</span><span class="ident" id="5623688">conn</span><span class="op" id="5623692">.</span><span class="ident" id="5623693">writeRecord</span><span class="op" id="5623704">(</span><span class="ident" id="5623705">typeStderr</span><span class="op" id="5623715">,</span>&nbsp;<span class="ident" id="5623717">req</span><span class="op" id="5623720">.</span><span class="ident" id="5623721">reqId</span><span class="op" id="5623726">,</span>&nbsp;<span class="op" id="5623728">[</span><span class="op" id="5623729">]</span><span class="builtintype" id="5623730">byte</span><span class="op" id="5623734">(</span><span class="ident" id="5623735">err</span><span class="op" id="5623738">.</span><span class="ident" id="5623739">Error</span><span class="op" id="5623744">(</span><span class="op" id="5623745">)</span><span class="op" id="5623746">)</span><span class="op" id="5623747">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5623750">}</span>&nbsp;<span class="keyword" id="5623752">else</span>&nbsp;<span class="op" id="5623757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623761">httpReq</span><span class="op" id="5623768">.</span><span class="ident" id="5623769">Body</span>&nbsp;<span class="op" id="5623774">=</span>&nbsp;<span class="ident" id="5623776">body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623783">c</span><span class="op" id="5623784">.</span><span class="ident" id="5623785">handler</span><span class="op" id="5623792">.</span><span class="ident" id="5623793">ServeHTTP</span><span class="op" id="5623802">(</span><span class="ident" id="5623803">r</span><span class="op" id="5623804">,</span>&nbsp;<span class="ident" id="5623806">httpReq</span><span class="op" id="5623813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5623816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623819">r</span><span class="op" id="5623820">.</span><span class="ident" id="5623821">Close</span><span class="op" id="5623826">(</span><span class="op" id="5623827">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623830">c</span><span class="op" id="5623831">.</span><span class="ident" id="5623832">mu</span><span class="op" id="5623834">.</span><span class="ident" id="5623835">Lock</span><span class="op" id="5623839">(</span><span class="op" id="5623840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5623843">delete</span><span class="op" id="5623849">(</span><span class="ident" id="5623850">c</span><span class="op" id="5623851">.</span><span class="ident" id="5623852">requests</span><span class="op" id="5623860">,</span>&nbsp;<span class="ident" id="5623862">req</span><span class="op" id="5623865">.</span><span class="ident" id="5623866">reqId</span><span class="op" id="5623871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623874">c</span><span class="op" id="5623875">.</span><span class="ident" id="5623876">mu</span><span class="op" id="5623878">.</span><span class="ident" id="5623879">Unlock</span><span class="op" id="5623885">(</span><span class="op" id="5623886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623889">c</span><span class="op" id="5623890">.</span><span class="ident" id="5623891">conn</span><span class="op" id="5623895">.</span><span class="ident" id="5623896">writeEndRequest</span><span class="op" id="5623911">(</span><span class="ident" id="5623912">req</span><span class="op" id="5623915">.</span><span class="ident" id="5623916">reqId</span><span class="op" id="5623921">,</span>&nbsp;<span class="num" id="5623923">0</span><span class="op" id="5623924">,</span>&nbsp;<span class="ident" id="5623926">statusRequestComplete</span><span class="op" id="5623947">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5623951">//&nbsp;Consume&nbsp;the&nbsp;entire&nbsp;body,&nbsp;so&nbsp;the&nbsp;host&nbsp;isn&#39;t&nbsp;still&nbsp;writing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5624015">//&nbsp;us&nbsp;when&nbsp;we&nbsp;close&nbsp;the&nbsp;socket&nbsp;below&nbsp;in&nbsp;the&nbsp;!keepConn&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5624076">//&nbsp;otherwise&nbsp;we&#39;d&nbsp;send&nbsp;a&nbsp;RST.&nbsp;(golang.org/issue/4183)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5624131">//&nbsp;TODO(bradfitz):&nbsp;also&nbsp;bound&nbsp;this&nbsp;copy&nbsp;in&nbsp;time.&nbsp;Or&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5624189">//&nbsp;some&nbsp;sort&nbsp;of&nbsp;abort&nbsp;request&nbsp;to&nbsp;the&nbsp;host,&nbsp;so&nbsp;the&nbsp;host</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5624245">//&nbsp;can&nbsp;properly&nbsp;cut&nbsp;off&nbsp;the&nbsp;client&nbsp;sending&nbsp;all&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5624303">//&nbsp;For&nbsp;now&nbsp;just&nbsp;bound&nbsp;it&nbsp;a&nbsp;little&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624342">io</span><span class="op" id="5624344">.</span><span class="ident" id="5624345">CopyN</span><span class="op" id="5624350">(</span><span class="ident" id="5624351">ioutil</span><span class="op" id="5624357">.</span><span class="ident" id="5624358">Discard</span><span class="op" id="5624365">,</span>&nbsp;<span class="ident" id="5624367">body</span><span class="op" id="5624371">,</span>&nbsp;<span class="num" id="5624373">100</span><span class="op" id="5624376">&lt;&lt;</span><span class="num" id="5624378">20</span><span class="op" id="5624380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624383">body</span><span class="op" id="5624387">.</span><span class="ident" id="5624388">Close</span><span class="op" id="5624393">(</span><span class="op" id="5624394">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624398">if</span>&nbsp;<span class="op" id="5624401">!</span><span class="ident" id="5624402">req</span><span class="op" id="5624405">.</span><span class="ident" id="5624406">keepConn</span>&nbsp;<span class="op" id="5624415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624419">c</span><span class="op" id="5624420">.</span><span class="ident" id="5624421">conn</span><span class="op" id="5624425">.</span><span class="ident" id="5624426">Close</span><span class="op" id="5624431">(</span><span class="op" id="5624432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5624435">}</span><br>
<span class="lineno"></span><span class="op" id="5624437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="5624440">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;FastCGI&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,&nbsp;creating&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="5624520">//&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;The&nbsp;goroutine&nbsp;reads&nbsp;requests&nbsp;and&nbsp;then&nbsp;calls&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="5624595">//&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="5624616">//&nbsp;If&nbsp;l&nbsp;is&nbsp;nil,&nbsp;Serve&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;os.Stdin.</span><br>
<span class="lineno"></span><span class="comment" id="5624673">//&nbsp;If&nbsp;handler&nbsp;is&nbsp;nil,&nbsp;http.DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno">285</span><span class="keyword" id="5624725">func</span>&nbsp;<span class="ident" id="5624730">Serve</span><span class="op" id="5624735">(</span><span class="ident" id="5624736">l</span>&nbsp;<span class="ident" id="5624738">net</span><span class="op" id="5624741">.</span><span class="ident" id="5624742">Listener</span><span class="op" id="5624750">,</span>&nbsp;<span class="ident" id="5624752">handler</span>&nbsp;<span class="ident" id="5624760">http</span><span class="op" id="5624764">.</span><span class="ident" id="5624765">Handler</span><span class="op" id="5624772">)</span>&nbsp;<span class="builtintype" id="5624774">error</span>&nbsp;<span class="op" id="5624780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624783">if</span>&nbsp;<span class="ident" id="5624786">l</span>&nbsp;<span class="op" id="5624788">==</span>&nbsp;<span class="ident" id="5624791">nil</span>&nbsp;<span class="op" id="5624795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624799">var</span>&nbsp;<span class="ident" id="5624803">err</span>&nbsp;<span class="builtintype" id="5624807">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624815">l</span><span class="op" id="5624816">,</span>&nbsp;<span class="ident" id="5624818">err</span>&nbsp;<span class="op" id="5624822">=</span>&nbsp;<span class="ident" id="5624824">net</span><span class="op" id="5624827">.</span><span class="ident" id="5624828">FileListener</span><span class="op" id="5624840">(</span><span class="ident" id="5624841">os</span><span class="op" id="5624843">.</span><span class="ident" id="5624844">Stdin</span><span class="op" id="5624849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624853">if</span>&nbsp;<span class="ident" id="5624856">err</span>&nbsp;<span class="op" id="5624860">!=</span>&nbsp;<span class="ident" id="5624863">nil</span>&nbsp;<span class="op" id="5624867">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624872">return</span>&nbsp;<span class="ident" id="5624879">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5624885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624889">defer</span>&nbsp;<span class="ident" id="5624895">l</span><span class="op" id="5624896">.</span><span class="ident" id="5624897">Close</span><span class="op" id="5624902">(</span><span class="op" id="5624903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5624906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624909">if</span>&nbsp;<span class="ident" id="5624912">handler</span>&nbsp;<span class="op" id="5624920">==</span>&nbsp;<span class="ident" id="5624923">nil</span>&nbsp;<span class="op" id="5624927">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624931">handler</span>&nbsp;<span class="op" id="5624939">=</span>&nbsp;<span class="ident" id="5624941">http</span><span class="op" id="5624945">.</span><span class="ident" id="5624946">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5624963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624966">for</span>&nbsp;<span class="op" id="5624970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624974">rw</span><span class="op" id="5624976">,</span>&nbsp;<span class="ident" id="5624978">err</span>&nbsp;<span class="op" id="5624982">:=</span>&nbsp;<span class="ident" id="5624985">l</span><span class="op" id="5624986">.</span><span class="ident" id="5624987">Accept</span><span class="op" id="5624993">(</span><span class="op" id="5624994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624998">if</span>&nbsp;<span class="ident" id="5625001">err</span>&nbsp;<span class="op" id="5625005">!=</span>&nbsp;<span class="ident" id="5625008">nil</span>&nbsp;<span class="op" id="5625012">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5625017">return</span>&nbsp;<span class="ident" id="5625024">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5625030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5625034">c</span>&nbsp;<span class="op" id="5625036">:=</span>&nbsp;<span class="ident" id="5625039">newChild</span><span class="op" id="5625047">(</span><span class="ident" id="5625048">rw</span><span class="op" id="5625050">,</span>&nbsp;<span class="ident" id="5625052">handler</span><span class="op" id="5625059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5625063">go</span>&nbsp;<span class="ident" id="5625066">c</span><span class="op" id="5625067">.</span><span class="ident" id="5625068">serve</span><span class="op" id="5625073">(</span><span class="op" id="5625074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5625077">}</span><br>
<span class="lineno">305</span><span class="op" id="5625079">}</span>
</div>
</body>
</html>
