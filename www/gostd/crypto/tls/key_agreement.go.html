<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3878479">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3878534">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3878588">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3878639">package</span>&nbsp;<span class="ident" id="3878647">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3878652">import</span>&nbsp;<span class="op" id="3878659">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3878662">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3878672">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3878688">&#34;crypto/elliptic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3878707">&#34;crypto/md5&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3878721">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3878735">&#34;crypto/sha1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3878750">&#34;crypto/sha256&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3878767">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3878782">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3878799">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3878809">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3878815">&#34;math/big&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3878826">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3878829">var</span>&nbsp;<span class="ident" id="3878833">errClientKeyExchange</span>&nbsp;<span class="op" id="3878854">=</span>&nbsp;<span class="ident" id="3878856">errors</span><span class="op" id="3878862">.</span><span class="ident" id="3878863">New</span><span class="op" id="3878866">(</span><span class="string" id="3878867">&#34;tls:&nbsp;invalid&nbsp;ClientKeyExchange&nbsp;message&#34;</span><span class="op" id="3878907">)</span><br>
<span class="lineno"></span><span class="keyword" id="3878909">var</span>&nbsp;<span class="ident" id="3878913">errServerKeyExchange</span>&nbsp;<span class="op" id="3878934">=</span>&nbsp;<span class="ident" id="3878936">errors</span><span class="op" id="3878942">.</span><span class="ident" id="3878943">New</span><span class="op" id="3878946">(</span><span class="string" id="3878947">&#34;tls:&nbsp;invalid&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="3878987">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3878990">//&nbsp;rsaKeyAgreement&nbsp;implements&nbsp;the&nbsp;standard&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="3879068">//&nbsp;encrypts&nbsp;the&nbsp;pre-master&nbsp;secret&nbsp;to&nbsp;the&nbsp;server&#39;s&nbsp;public&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="3879130">type</span>&nbsp;<span class="ident" id="3879135">rsaKeyAgreement</span>&nbsp;<span class="keyword" id="3879151">struct</span><span class="op" id="3879157">{</span><span class="op" id="3879158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3879161">func</span>&nbsp;<span class="op" id="3879166">(</span><span class="ident" id="3879167">ka</span>&nbsp;<span class="ident" id="3879170">rsaKeyAgreement</span><span class="op" id="3879185">)</span>&nbsp;<span class="ident" id="3879187">generateServerKeyExchange</span><span class="op" id="3879212">(</span><span class="ident" id="3879213">config</span>&nbsp;<span class="op" id="3879220">*</span><span class="ident" id="3879221">Config</span><span class="op" id="3879227">,</span>&nbsp;<span class="ident" id="3879229">cert</span>&nbsp;<span class="op" id="3879234">*</span><span class="ident" id="3879235">Certificate</span><span class="op" id="3879246">,</span>&nbsp;<span class="ident" id="3879248">clientHello</span>&nbsp;<span class="op" id="3879260">*</span><span class="ident" id="3879261">clientHelloMsg</span><span class="op" id="3879275">,</span>&nbsp;<span class="ident" id="3879277">hello</span>&nbsp;<span class="op" id="3879283">*</span><span class="ident" id="3879284">serverHelloMsg</span><span class="op" id="3879298">)</span>&nbsp;<span class="op" id="3879300">(</span><span class="op" id="3879301">*</span><span class="ident" id="3879302">serverKeyExchangeMsg</span><span class="op" id="3879322">,</span>&nbsp;<span class="builtintype" id="3879324">error</span><span class="op" id="3879329">)</span>&nbsp;<span class="op" id="3879331">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879334">return</span>&nbsp;<span class="ident" id="3879341">nil</span><span class="op" id="3879344">,</span>&nbsp;<span class="ident" id="3879346">nil</span><br>
<span class="lineno"></span><span class="op" id="3879350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3879353">func</span>&nbsp;<span class="op" id="3879358">(</span><span class="ident" id="3879359">ka</span>&nbsp;<span class="ident" id="3879362">rsaKeyAgreement</span><span class="op" id="3879377">)</span>&nbsp;<span class="ident" id="3879379">processClientKeyExchange</span><span class="op" id="3879403">(</span><span class="ident" id="3879404">config</span>&nbsp;<span class="op" id="3879411">*</span><span class="ident" id="3879412">Config</span><span class="op" id="3879418">,</span>&nbsp;<span class="ident" id="3879420">cert</span>&nbsp;<span class="op" id="3879425">*</span><span class="ident" id="3879426">Certificate</span><span class="op" id="3879437">,</span>&nbsp;<span class="ident" id="3879439">ckx</span>&nbsp;<span class="op" id="3879443">*</span><span class="ident" id="3879444">clientKeyExchangeMsg</span><span class="op" id="3879464">,</span>&nbsp;<span class="ident" id="3879466">version</span>&nbsp;<span class="builtintype" id="3879474">uint16</span><span class="op" id="3879480">)</span>&nbsp;<span class="op" id="3879482">(</span><span class="op" id="3879483">[</span><span class="op" id="3879484">]</span><span class="builtintype" id="3879485">byte</span><span class="op" id="3879489">,</span>&nbsp;<span class="builtintype" id="3879491">error</span><span class="op" id="3879496">)</span>&nbsp;<span class="op" id="3879498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879501">preMasterSecret</span>&nbsp;<span class="op" id="3879517">:=</span>&nbsp;<span class="builtinfunc" id="3879520">make</span><span class="op" id="3879524">(</span><span class="op" id="3879525">[</span><span class="op" id="3879526">]</span><span class="builtintype" id="3879527">byte</span><span class="op" id="3879531">,</span>&nbsp;<span class="num" id="3879533">48</span><span class="op" id="3879535">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879538">_</span><span class="op" id="3879539">,</span>&nbsp;<span class="ident" id="3879541">err</span>&nbsp;<span class="op" id="3879545">:=</span>&nbsp;<span class="ident" id="3879548">io</span><span class="op" id="3879550">.</span><span class="ident" id="3879551">ReadFull</span><span class="op" id="3879559">(</span><span class="ident" id="3879560">config</span><span class="op" id="3879566">.</span><span class="ident" id="3879567">rand</span><span class="op" id="3879571">(</span><span class="op" id="3879572">)</span><span class="op" id="3879573">,</span>&nbsp;<span class="ident" id="3879575">preMasterSecret</span><span class="op" id="3879590">[</span><span class="num" id="3879591">2</span><span class="op" id="3879592">:</span><span class="op" id="3879593">]</span><span class="op" id="3879594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879597">if</span>&nbsp;<span class="ident" id="3879600">err</span>&nbsp;<span class="op" id="3879604">!=</span>&nbsp;<span class="ident" id="3879607">nil</span>&nbsp;<span class="op" id="3879611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879615">return</span>&nbsp;<span class="ident" id="3879622">nil</span><span class="op" id="3879625">,</span>&nbsp;<span class="ident" id="3879627">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3879632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879636">if</span>&nbsp;<span class="builtinfunc" id="3879639">len</span><span class="op" id="3879642">(</span><span class="ident" id="3879643">ckx</span><span class="op" id="3879646">.</span><span class="ident" id="3879647">ciphertext</span><span class="op" id="3879657">)</span>&nbsp;<span class="op" id="3879659">&lt;</span>&nbsp;<span class="num" id="3879661">2</span>&nbsp;<span class="op" id="3879663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879667">return</span>&nbsp;<span class="ident" id="3879674">nil</span><span class="op" id="3879677">,</span>&nbsp;<span class="ident" id="3879679">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3879701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879705">ciphertext</span>&nbsp;<span class="op" id="3879716">:=</span>&nbsp;<span class="ident" id="3879719">ckx</span><span class="op" id="3879722">.</span><span class="ident" id="3879723">ciphertext</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879735">if</span>&nbsp;<span class="ident" id="3879738">version</span>&nbsp;<span class="op" id="3879746">!=</span>&nbsp;<span class="ident" id="3879749">VersionSSL30</span>&nbsp;<span class="op" id="3879762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879766">ciphertextLen</span>&nbsp;<span class="op" id="3879780">:=</span>&nbsp;<span class="builtintype" id="3879783">int</span><span class="op" id="3879786">(</span><span class="ident" id="3879787">ckx</span><span class="op" id="3879790">.</span><span class="ident" id="3879791">ciphertext</span><span class="op" id="3879801">[</span><span class="num" id="3879802">0</span><span class="op" id="3879803">]</span><span class="op" id="3879804">)</span><span class="op" id="3879805">&lt;&lt;</span><span class="num" id="3879807">8</span>&nbsp;<span class="op" id="3879809">|</span>&nbsp;<span class="builtintype" id="3879811">int</span><span class="op" id="3879814">(</span><span class="ident" id="3879815">ckx</span><span class="op" id="3879818">.</span><span class="ident" id="3879819">ciphertext</span><span class="op" id="3879829">[</span><span class="num" id="3879830">1</span><span class="op" id="3879831">]</span><span class="op" id="3879832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879836">if</span>&nbsp;<span class="ident" id="3879839">ciphertextLen</span>&nbsp;<span class="op" id="3879853">!=</span>&nbsp;<span class="builtinfunc" id="3879856">len</span><span class="op" id="3879859">(</span><span class="ident" id="3879860">ckx</span><span class="op" id="3879863">.</span><span class="ident" id="3879864">ciphertext</span><span class="op" id="3879874">)</span><span class="op" id="3879875">-</span><span class="num" id="3879876">2</span>&nbsp;<span class="op" id="3879878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879883">return</span>&nbsp;<span class="ident" id="3879890">nil</span><span class="op" id="3879893">,</span>&nbsp;<span class="ident" id="3879895">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3879918">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879922">ciphertext</span>&nbsp;<span class="op" id="3879933">=</span>&nbsp;<span class="ident" id="3879935">ckx</span><span class="op" id="3879938">.</span><span class="ident" id="3879939">ciphertext</span><span class="op" id="3879949">[</span><span class="num" id="3879950">2</span><span class="op" id="3879951">:</span><span class="op" id="3879952">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3879955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879959">err</span>&nbsp;<span class="op" id="3879963">=</span>&nbsp;<span class="ident" id="3879965">rsa</span><span class="op" id="3879968">.</span><span class="ident" id="3879969">DecryptPKCS1v15SessionKey</span><span class="op" id="3879994">(</span><span class="ident" id="3879995">config</span><span class="op" id="3880001">.</span><span class="ident" id="3880002">rand</span><span class="op" id="3880006">(</span><span class="op" id="3880007">)</span><span class="op" id="3880008">,</span>&nbsp;<span class="ident" id="3880010">cert</span><span class="op" id="3880014">.</span><span class="ident" id="3880015">PrivateKey</span><span class="op" id="3880025">.</span><span class="op" id="3880026">(</span><span class="op" id="3880027">*</span><span class="ident" id="3880028">rsa</span><span class="op" id="3880031">.</span><span class="ident" id="3880032">PrivateKey</span><span class="op" id="3880042">)</span><span class="op" id="3880043">,</span>&nbsp;<span class="ident" id="3880045">ciphertext</span><span class="op" id="3880055">,</span>&nbsp;<span class="ident" id="3880057">preMasterSecret</span><span class="op" id="3880072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880075">if</span>&nbsp;<span class="ident" id="3880078">err</span>&nbsp;<span class="op" id="3880082">!=</span>&nbsp;<span class="ident" id="3880085">nil</span>&nbsp;<span class="op" id="3880089">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880093">return</span>&nbsp;<span class="ident" id="3880100">nil</span><span class="op" id="3880103">,</span>&nbsp;<span class="ident" id="3880105">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3880110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3880113">//&nbsp;We&nbsp;don&#39;t&nbsp;check&nbsp;the&nbsp;version&nbsp;number&nbsp;in&nbsp;the&nbsp;premaster&nbsp;secret.&nbsp;&nbsp;For&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3880186">//&nbsp;by&nbsp;checking&nbsp;it,&nbsp;we&nbsp;would&nbsp;leak&nbsp;information&nbsp;about&nbsp;the&nbsp;validity&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3880258">//&nbsp;encrypted&nbsp;pre-master&nbsp;secret.&nbsp;Secondly,&nbsp;it&nbsp;provides&nbsp;only&nbsp;a&nbsp;small</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3880326">//&nbsp;benefit&nbsp;against&nbsp;a&nbsp;downgrade&nbsp;attack&nbsp;and&nbsp;some&nbsp;implementations&nbsp;send&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3880399">//&nbsp;wrong&nbsp;version&nbsp;anyway.&nbsp;See&nbsp;the&nbsp;discussion&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;section</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3880466">//&nbsp;7.4.7.1&nbsp;of&nbsp;RFC&nbsp;4346.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880491">return</span>&nbsp;<span class="ident" id="3880498">preMasterSecret</span><span class="op" id="3880513">,</span>&nbsp;<span class="ident" id="3880515">nil</span><br>
<span class="lineno"></span><span class="op" id="3880519">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="3880522">func</span>&nbsp;<span class="op" id="3880527">(</span><span class="ident" id="3880528">ka</span>&nbsp;<span class="ident" id="3880531">rsaKeyAgreement</span><span class="op" id="3880546">)</span>&nbsp;<span class="ident" id="3880548">processServerKeyExchange</span><span class="op" id="3880572">(</span><span class="ident" id="3880573">config</span>&nbsp;<span class="op" id="3880580">*</span><span class="ident" id="3880581">Config</span><span class="op" id="3880587">,</span>&nbsp;<span class="ident" id="3880589">clientHello</span>&nbsp;<span class="op" id="3880601">*</span><span class="ident" id="3880602">clientHelloMsg</span><span class="op" id="3880616">,</span>&nbsp;<span class="ident" id="3880618">serverHello</span>&nbsp;<span class="op" id="3880630">*</span><span class="ident" id="3880631">serverHelloMsg</span><span class="op" id="3880645">,</span>&nbsp;<span class="ident" id="3880647">cert</span>&nbsp;<span class="op" id="3880652">*</span><span class="ident" id="3880653">x509</span><span class="op" id="3880657">.</span><span class="ident" id="3880658">Certificate</span><span class="op" id="3880669">,</span>&nbsp;<span class="ident" id="3880671">skx</span>&nbsp;<span class="op" id="3880675">*</span><span class="ident" id="3880676">serverKeyExchangeMsg</span><span class="op" id="3880696">)</span>&nbsp;<span class="builtintype" id="3880698">error</span>&nbsp;<span class="op" id="3880704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880707">return</span>&nbsp;<span class="ident" id="3880714">errors</span><span class="op" id="3880720">.</span><span class="ident" id="3880721">New</span><span class="op" id="3880724">(</span><span class="string" id="3880725">&#34;tls:&nbsp;unexpected&nbsp;ServerKeyExchange&#34;</span><span class="op" id="3880760">)</span><br>
<span class="lineno"></span><span class="op" id="3880762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="3880765">func</span>&nbsp;<span class="op" id="3880770">(</span><span class="ident" id="3880771">ka</span>&nbsp;<span class="ident" id="3880774">rsaKeyAgreement</span><span class="op" id="3880789">)</span>&nbsp;<span class="ident" id="3880791">generateClientKeyExchange</span><span class="op" id="3880816">(</span><span class="ident" id="3880817">config</span>&nbsp;<span class="op" id="3880824">*</span><span class="ident" id="3880825">Config</span><span class="op" id="3880831">,</span>&nbsp;<span class="ident" id="3880833">clientHello</span>&nbsp;<span class="op" id="3880845">*</span><span class="ident" id="3880846">clientHelloMsg</span><span class="op" id="3880860">,</span>&nbsp;<span class="ident" id="3880862">cert</span>&nbsp;<span class="op" id="3880867">*</span><span class="ident" id="3880868">x509</span><span class="op" id="3880872">.</span><span class="ident" id="3880873">Certificate</span><span class="op" id="3880884">)</span>&nbsp;<span class="op" id="3880886">(</span><span class="op" id="3880887">[</span><span class="op" id="3880888">]</span><span class="builtintype" id="3880889">byte</span><span class="op" id="3880893">,</span>&nbsp;<span class="op" id="3880895">*</span><span class="ident" id="3880896">clientKeyExchangeMsg</span><span class="op" id="3880916">,</span>&nbsp;<span class="builtintype" id="3880918">error</span><span class="op" id="3880923">)</span>&nbsp;<span class="op" id="3880925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880928">preMasterSecret</span>&nbsp;<span class="op" id="3880944">:=</span>&nbsp;<span class="builtinfunc" id="3880947">make</span><span class="op" id="3880951">(</span><span class="op" id="3880952">[</span><span class="op" id="3880953">]</span><span class="builtintype" id="3880954">byte</span><span class="op" id="3880958">,</span>&nbsp;<span class="num" id="3880960">48</span><span class="op" id="3880962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880965">preMasterSecret</span><span class="op" id="3880980">[</span><span class="num" id="3880981">0</span><span class="op" id="3880982">]</span>&nbsp;<span class="op" id="3880984">=</span>&nbsp;<span class="builtintype" id="3880986">byte</span><span class="op" id="3880990">(</span><span class="ident" id="3880991">clientHello</span><span class="op" id="3881002">.</span><span class="ident" id="3881003">vers</span>&nbsp;<span class="op" id="3881008">&gt;&gt;</span>&nbsp;<span class="num" id="3881011">8</span><span class="op" id="3881012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881015">preMasterSecret</span><span class="op" id="3881030">[</span><span class="num" id="3881031">1</span><span class="op" id="3881032">]</span>&nbsp;<span class="op" id="3881034">=</span>&nbsp;<span class="builtintype" id="3881036">byte</span><span class="op" id="3881040">(</span><span class="ident" id="3881041">clientHello</span><span class="op" id="3881052">.</span><span class="ident" id="3881053">vers</span><span class="op" id="3881057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881060">_</span><span class="op" id="3881061">,</span>&nbsp;<span class="ident" id="3881063">err</span>&nbsp;<span class="op" id="3881067">:=</span>&nbsp;<span class="ident" id="3881070">io</span><span class="op" id="3881072">.</span><span class="ident" id="3881073">ReadFull</span><span class="op" id="3881081">(</span><span class="ident" id="3881082">config</span><span class="op" id="3881088">.</span><span class="ident" id="3881089">rand</span><span class="op" id="3881093">(</span><span class="op" id="3881094">)</span><span class="op" id="3881095">,</span>&nbsp;<span class="ident" id="3881097">preMasterSecret</span><span class="op" id="3881112">[</span><span class="num" id="3881113">2</span><span class="op" id="3881114">:</span><span class="op" id="3881115">]</span><span class="op" id="3881116">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881119">if</span>&nbsp;<span class="ident" id="3881122">err</span>&nbsp;<span class="op" id="3881126">!=</span>&nbsp;<span class="ident" id="3881129">nil</span>&nbsp;<span class="op" id="3881133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881137">return</span>&nbsp;<span class="ident" id="3881144">nil</span><span class="op" id="3881147">,</span>&nbsp;<span class="ident" id="3881149">nil</span><span class="op" id="3881152">,</span>&nbsp;<span class="ident" id="3881154">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3881159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881163">encrypted</span><span class="op" id="3881172">,</span>&nbsp;<span class="ident" id="3881174">err</span>&nbsp;<span class="op" id="3881178">:=</span>&nbsp;<span class="ident" id="3881181">rsa</span><span class="op" id="3881184">.</span><span class="ident" id="3881185">EncryptPKCS1v15</span><span class="op" id="3881200">(</span><span class="ident" id="3881201">config</span><span class="op" id="3881207">.</span><span class="ident" id="3881208">rand</span><span class="op" id="3881212">(</span><span class="op" id="3881213">)</span><span class="op" id="3881214">,</span>&nbsp;<span class="ident" id="3881216">cert</span><span class="op" id="3881220">.</span><span class="ident" id="3881221">PublicKey</span><span class="op" id="3881230">.</span><span class="op" id="3881231">(</span><span class="op" id="3881232">*</span><span class="ident" id="3881233">rsa</span><span class="op" id="3881236">.</span><span class="ident" id="3881237">PublicKey</span><span class="op" id="3881246">)</span><span class="op" id="3881247">,</span>&nbsp;<span class="ident" id="3881249">preMasterSecret</span><span class="op" id="3881264">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881267">if</span>&nbsp;<span class="ident" id="3881270">err</span>&nbsp;<span class="op" id="3881274">!=</span>&nbsp;<span class="ident" id="3881277">nil</span>&nbsp;<span class="op" id="3881281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881285">return</span>&nbsp;<span class="ident" id="3881292">nil</span><span class="op" id="3881295">,</span>&nbsp;<span class="ident" id="3881297">nil</span><span class="op" id="3881300">,</span>&nbsp;<span class="ident" id="3881302">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3881307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881310">ckx</span>&nbsp;<span class="op" id="3881314">:=</span>&nbsp;<span class="builtinfunc" id="3881317">new</span><span class="op" id="3881320">(</span><span class="ident" id="3881321">clientKeyExchangeMsg</span><span class="op" id="3881341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881344">ckx</span><span class="op" id="3881347">.</span><span class="ident" id="3881348">ciphertext</span>&nbsp;<span class="op" id="3881359">=</span>&nbsp;<span class="builtinfunc" id="3881361">make</span><span class="op" id="3881365">(</span><span class="op" id="3881366">[</span><span class="op" id="3881367">]</span><span class="builtintype" id="3881368">byte</span><span class="op" id="3881372">,</span>&nbsp;<span class="builtinfunc" id="3881374">len</span><span class="op" id="3881377">(</span><span class="ident" id="3881378">encrypted</span><span class="op" id="3881387">)</span><span class="op" id="3881388">+</span><span class="num" id="3881389">2</span><span class="op" id="3881390">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881393">ckx</span><span class="op" id="3881396">.</span><span class="ident" id="3881397">ciphertext</span><span class="op" id="3881407">[</span><span class="num" id="3881408">0</span><span class="op" id="3881409">]</span>&nbsp;<span class="op" id="3881411">=</span>&nbsp;<span class="builtintype" id="3881413">byte</span><span class="op" id="3881417">(</span><span class="builtinfunc" id="3881418">len</span><span class="op" id="3881421">(</span><span class="ident" id="3881422">encrypted</span><span class="op" id="3881431">)</span>&nbsp;<span class="op" id="3881433">&gt;&gt;</span>&nbsp;<span class="num" id="3881436">8</span><span class="op" id="3881437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881440">ckx</span><span class="op" id="3881443">.</span><span class="ident" id="3881444">ciphertext</span><span class="op" id="3881454">[</span><span class="num" id="3881455">1</span><span class="op" id="3881456">]</span>&nbsp;<span class="op" id="3881458">=</span>&nbsp;<span class="builtintype" id="3881460">byte</span><span class="op" id="3881464">(</span><span class="builtinfunc" id="3881465">len</span><span class="op" id="3881468">(</span><span class="ident" id="3881469">encrypted</span><span class="op" id="3881478">)</span><span class="op" id="3881479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3881482">copy</span><span class="op" id="3881486">(</span><span class="ident" id="3881487">ckx</span><span class="op" id="3881490">.</span><span class="ident" id="3881491">ciphertext</span><span class="op" id="3881501">[</span><span class="num" id="3881502">2</span><span class="op" id="3881503">:</span><span class="op" id="3881504">]</span><span class="op" id="3881505">,</span>&nbsp;<span class="ident" id="3881507">encrypted</span><span class="op" id="3881516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881519">return</span>&nbsp;<span class="ident" id="3881526">preMasterSecret</span><span class="op" id="3881541">,</span>&nbsp;<span class="ident" id="3881543">ckx</span><span class="op" id="3881546">,</span>&nbsp;<span class="ident" id="3881548">nil</span><br>
<span class="lineno"></span><span class="op" id="3881552">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="3881555">//&nbsp;sha1Hash&nbsp;calculates&nbsp;a&nbsp;SHA1&nbsp;hash&nbsp;over&nbsp;the&nbsp;given&nbsp;byte&nbsp;slices.</span><br>
<span class="lineno"></span><span class="keyword" id="3881618">func</span>&nbsp;<span class="ident" id="3881623">sha1Hash</span><span class="op" id="3881631">(</span><span class="ident" id="3881632">slices</span>&nbsp;<span class="op" id="3881639">[</span><span class="op" id="3881640">]</span><span class="op" id="3881641">[</span><span class="op" id="3881642">]</span><span class="builtintype" id="3881643">byte</span><span class="op" id="3881647">)</span>&nbsp;<span class="op" id="3881649">[</span><span class="op" id="3881650">]</span><span class="builtintype" id="3881651">byte</span>&nbsp;<span class="op" id="3881656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881659">hsha1</span>&nbsp;<span class="op" id="3881665">:=</span>&nbsp;<span class="ident" id="3881668">sha1</span><span class="op" id="3881672">.</span><span class="ident" id="3881673">New</span><span class="op" id="3881676">(</span><span class="op" id="3881677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881680">for</span>&nbsp;<span class="ident" id="3881684">_</span><span class="op" id="3881685">,</span>&nbsp;<span class="ident" id="3881687">slice</span>&nbsp;<span class="op" id="3881693">:=</span>&nbsp;<span class="keyword" id="3881696">range</span>&nbsp;<span class="ident" id="3881702">slices</span>&nbsp;<span class="op" id="3881709">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881713">hsha1</span><span class="op" id="3881718">.</span><span class="ident" id="3881719">Write</span><span class="op" id="3881724">(</span><span class="ident" id="3881725">slice</span><span class="op" id="3881730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3881733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881736">return</span>&nbsp;<span class="ident" id="3881743">hsha1</span><span class="op" id="3881748">.</span><span class="ident" id="3881749">Sum</span><span class="op" id="3881752">(</span><span class="ident" id="3881753">nil</span><span class="op" id="3881756">)</span><br>
<span class="lineno"></span><span class="op" id="3881758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="3881761">//&nbsp;md5SHA1Hash&nbsp;implements&nbsp;TLS&nbsp;1.0&#39;s&nbsp;hybrid&nbsp;hash&nbsp;function&nbsp;which&nbsp;consists&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3881840">//&nbsp;concatenation&nbsp;of&nbsp;an&nbsp;MD5&nbsp;and&nbsp;SHA1&nbsp;hash.</span><br>
<span class="lineno"></span><span class="keyword" id="3881882">func</span>&nbsp;<span class="ident" id="3881887">md5SHA1Hash</span><span class="op" id="3881898">(</span><span class="ident" id="3881899">slices</span>&nbsp;<span class="op" id="3881906">[</span><span class="op" id="3881907">]</span><span class="op" id="3881908">[</span><span class="op" id="3881909">]</span><span class="builtintype" id="3881910">byte</span><span class="op" id="3881914">)</span>&nbsp;<span class="op" id="3881916">[</span><span class="op" id="3881917">]</span><span class="builtintype" id="3881918">byte</span>&nbsp;<span class="op" id="3881923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881926">md5sha1</span>&nbsp;<span class="op" id="3881934">:=</span>&nbsp;<span class="builtinfunc" id="3881937">make</span><span class="op" id="3881941">(</span><span class="op" id="3881942">[</span><span class="op" id="3881943">]</span><span class="builtintype" id="3881944">byte</span><span class="op" id="3881948">,</span>&nbsp;<span class="ident" id="3881950">md5</span><span class="op" id="3881953">.</span><span class="ident" id="3881954">Size</span><span class="op" id="3881958">+</span><span class="ident" id="3881959">sha1</span><span class="op" id="3881963">.</span><span class="ident" id="3881964">Size</span><span class="op" id="3881968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881971">hmd5</span>&nbsp;<span class="op" id="3881976">:=</span>&nbsp;<span class="ident" id="3881979">md5</span><span class="op" id="3881982">.</span><span class="ident" id="3881983">New</span><span class="op" id="3881986">(</span><span class="op" id="3881987">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881990">for</span>&nbsp;<span class="ident" id="3881994">_</span><span class="op" id="3881995">,</span>&nbsp;<span class="ident" id="3881997">slice</span>&nbsp;<span class="op" id="3882003">:=</span>&nbsp;<span class="keyword" id="3882006">range</span>&nbsp;<span class="ident" id="3882012">slices</span>&nbsp;<span class="op" id="3882019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882023">hmd5</span><span class="op" id="3882027">.</span><span class="ident" id="3882028">Write</span><span class="op" id="3882033">(</span><span class="ident" id="3882034">slice</span><span class="op" id="3882039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3882045">copy</span><span class="op" id="3882049">(</span><span class="ident" id="3882050">md5sha1</span><span class="op" id="3882057">,</span>&nbsp;<span class="ident" id="3882059">hmd5</span><span class="op" id="3882063">.</span><span class="ident" id="3882064">Sum</span><span class="op" id="3882067">(</span><span class="ident" id="3882068">nil</span><span class="op" id="3882071">)</span><span class="op" id="3882072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3882075">copy</span><span class="op" id="3882079">(</span><span class="ident" id="3882080">md5sha1</span><span class="op" id="3882087">[</span><span class="ident" id="3882088">md5</span><span class="op" id="3882091">.</span><span class="ident" id="3882092">Size</span><span class="op" id="3882096">:</span><span class="op" id="3882097">]</span><span class="op" id="3882098">,</span>&nbsp;<span class="ident" id="3882100">sha1Hash</span><span class="op" id="3882108">(</span><span class="ident" id="3882109">slices</span><span class="op" id="3882115">)</span><span class="op" id="3882116">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882119">return</span>&nbsp;<span class="ident" id="3882126">md5sha1</span><br>
<span class="lineno"></span><span class="op" id="3882134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3882137">//&nbsp;sha256Hash&nbsp;implements&nbsp;TLS&nbsp;1.2&#39;s&nbsp;hash&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="3882187">func</span>&nbsp;<span class="ident" id="3882192">sha256Hash</span><span class="op" id="3882202">(</span><span class="ident" id="3882203">slices</span>&nbsp;<span class="op" id="3882210">[</span><span class="op" id="3882211">]</span><span class="op" id="3882212">[</span><span class="op" id="3882213">]</span><span class="builtintype" id="3882214">byte</span><span class="op" id="3882218">)</span>&nbsp;<span class="op" id="3882220">[</span><span class="op" id="3882221">]</span><span class="builtintype" id="3882222">byte</span>&nbsp;<span class="op" id="3882227">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882230">h</span>&nbsp;<span class="op" id="3882232">:=</span>&nbsp;<span class="ident" id="3882235">sha256</span><span class="op" id="3882241">.</span><span class="ident" id="3882242">New</span><span class="op" id="3882245">(</span><span class="op" id="3882246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882249">for</span>&nbsp;<span class="ident" id="3882253">_</span><span class="op" id="3882254">,</span>&nbsp;<span class="ident" id="3882256">slice</span>&nbsp;<span class="op" id="3882262">:=</span>&nbsp;<span class="keyword" id="3882265">range</span>&nbsp;<span class="ident" id="3882271">slices</span>&nbsp;<span class="op" id="3882278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882282">h</span><span class="op" id="3882283">.</span><span class="ident" id="3882284">Write</span><span class="op" id="3882289">(</span><span class="ident" id="3882290">slice</span><span class="op" id="3882295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882301">return</span>&nbsp;<span class="ident" id="3882308">h</span><span class="op" id="3882309">.</span><span class="ident" id="3882310">Sum</span><span class="op" id="3882313">(</span><span class="ident" id="3882314">nil</span><span class="op" id="3882317">)</span><br>
<span class="lineno">120</span><span class="op" id="3882319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3882322">//&nbsp;hashForServerKeyExchange&nbsp;hashes&nbsp;the&nbsp;given&nbsp;slices&nbsp;and&nbsp;returns&nbsp;their&nbsp;digest</span><br>
<span class="lineno"></span><span class="comment" id="3882399">//&nbsp;and&nbsp;the&nbsp;identifier&nbsp;of&nbsp;the&nbsp;hash&nbsp;function&nbsp;used.&nbsp;The&nbsp;hashFunc&nbsp;argument&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="3882478">//&nbsp;used&nbsp;for&nbsp;&gt;=&nbsp;TLS&nbsp;1.2&nbsp;and&nbsp;precisely&nbsp;identifies&nbsp;the&nbsp;hash&nbsp;function&nbsp;to&nbsp;use.</span><br>
<span class="lineno">125</span><span class="keyword" id="3882552">func</span>&nbsp;<span class="ident" id="3882557">hashForServerKeyExchange</span><span class="op" id="3882581">(</span><span class="ident" id="3882582">sigType</span><span class="op" id="3882589">,</span>&nbsp;<span class="ident" id="3882591">hashFunc</span>&nbsp;<span class="builtintype" id="3882600">uint8</span><span class="op" id="3882605">,</span>&nbsp;<span class="ident" id="3882607">version</span>&nbsp;<span class="builtintype" id="3882615">uint16</span><span class="op" id="3882621">,</span>&nbsp;<span class="ident" id="3882623">slices</span>&nbsp;<span class="op" id="3882630">...</span><span class="op" id="3882633">[</span><span class="op" id="3882634">]</span><span class="builtintype" id="3882635">byte</span><span class="op" id="3882639">)</span>&nbsp;<span class="op" id="3882641">(</span><span class="op" id="3882642">[</span><span class="op" id="3882643">]</span><span class="builtintype" id="3882644">byte</span><span class="op" id="3882648">,</span>&nbsp;<span class="ident" id="3882650">crypto</span><span class="op" id="3882656">.</span><span class="ident" id="3882657">Hash</span><span class="op" id="3882661">,</span>&nbsp;<span class="builtintype" id="3882663">error</span><span class="op" id="3882668">)</span>&nbsp;<span class="op" id="3882670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882673">if</span>&nbsp;<span class="ident" id="3882676">version</span>&nbsp;<span class="op" id="3882684">&gt;=</span>&nbsp;<span class="ident" id="3882687">VersionTLS12</span>&nbsp;<span class="op" id="3882700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882704">switch</span>&nbsp;<span class="ident" id="3882711">hashFunc</span>&nbsp;<span class="op" id="3882720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882724">case</span>&nbsp;<span class="ident" id="3882729">hashSHA256</span><span class="op" id="3882739">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882744">return</span>&nbsp;<span class="ident" id="3882751">sha256Hash</span><span class="op" id="3882761">(</span><span class="ident" id="3882762">slices</span><span class="op" id="3882768">)</span><span class="op" id="3882769">,</span>&nbsp;<span class="ident" id="3882771">crypto</span><span class="op" id="3882777">.</span><span class="ident" id="3882778">SHA256</span><span class="op" id="3882784">,</span>&nbsp;<span class="ident" id="3882786">nil</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882792">case</span>&nbsp;<span class="ident" id="3882797">hashSHA1</span><span class="op" id="3882805">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882810">return</span>&nbsp;<span class="ident" id="3882817">sha1Hash</span><span class="op" id="3882825">(</span><span class="ident" id="3882826">slices</span><span class="op" id="3882832">)</span><span class="op" id="3882833">,</span>&nbsp;<span class="ident" id="3882835">crypto</span><span class="op" id="3882841">.</span><span class="ident" id="3882842">SHA1</span><span class="op" id="3882846">,</span>&nbsp;<span class="ident" id="3882848">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882854">default</span><span class="op" id="3882861">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882866">return</span>&nbsp;<span class="ident" id="3882873">nil</span><span class="op" id="3882876">,</span>&nbsp;<span class="ident" id="3882878">crypto</span><span class="op" id="3882884">.</span><span class="ident" id="3882885">Hash</span><span class="op" id="3882889">(</span><span class="num" id="3882890">0</span><span class="op" id="3882891">)</span><span class="op" id="3882892">,</span>&nbsp;<span class="ident" id="3882894">errors</span><span class="op" id="3882900">.</span><span class="ident" id="3882901">New</span><span class="op" id="3882904">(</span><span class="string" id="3882905">&#34;tls:&nbsp;unknown&nbsp;hash&nbsp;function&nbsp;used&nbsp;by&nbsp;peer&#34;</span><span class="op" id="3882946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882950">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882956">if</span>&nbsp;<span class="ident" id="3882959">sigType</span>&nbsp;<span class="op" id="3882967">==</span>&nbsp;<span class="ident" id="3882970">signatureECDSA</span>&nbsp;<span class="op" id="3882985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882989">return</span>&nbsp;<span class="ident" id="3882996">sha1Hash</span><span class="op" id="3883004">(</span><span class="ident" id="3883005">slices</span><span class="op" id="3883011">)</span><span class="op" id="3883012">,</span>&nbsp;<span class="ident" id="3883014">crypto</span><span class="op" id="3883020">.</span><span class="ident" id="3883021">SHA1</span><span class="op" id="3883025">,</span>&nbsp;<span class="ident" id="3883027">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3883032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883035">return</span>&nbsp;<span class="ident" id="3883042">md5SHA1Hash</span><span class="op" id="3883053">(</span><span class="ident" id="3883054">slices</span><span class="op" id="3883060">)</span><span class="op" id="3883061">,</span>&nbsp;<span class="ident" id="3883063">crypto</span><span class="op" id="3883069">.</span><span class="ident" id="3883070">MD5SHA1</span><span class="op" id="3883077">,</span>&nbsp;<span class="ident" id="3883079">nil</span><br>
<span class="lineno">140</span><span class="op" id="3883083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3883086">//&nbsp;pickTLS12HashForSignature&nbsp;returns&nbsp;a&nbsp;TLS&nbsp;1.2&nbsp;hash&nbsp;identifier&nbsp;for&nbsp;signing&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3883163">//&nbsp;ServerKeyExchange&nbsp;given&nbsp;the&nbsp;signature&nbsp;type&nbsp;being&nbsp;used&nbsp;and&nbsp;the&nbsp;client&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3883237">//&nbsp;advertised&nbsp;list&nbsp;of&nbsp;supported&nbsp;signature&nbsp;and&nbsp;hash&nbsp;combinations.</span><br>
<span class="lineno">145</span><span class="keyword" id="3883302">func</span>&nbsp;<span class="ident" id="3883307">pickTLS12HashForSignature</span><span class="op" id="3883332">(</span><span class="ident" id="3883333">sigType</span>&nbsp;<span class="builtintype" id="3883341">uint8</span><span class="op" id="3883346">,</span>&nbsp;<span class="ident" id="3883348">clientSignatureAndHashes</span>&nbsp;<span class="op" id="3883373">[</span><span class="op" id="3883374">]</span><span class="ident" id="3883375">signatureAndHash</span><span class="op" id="3883391">)</span>&nbsp;<span class="op" id="3883393">(</span><span class="builtintype" id="3883394">uint8</span><span class="op" id="3883399">,</span>&nbsp;<span class="builtintype" id="3883401">error</span><span class="op" id="3883406">)</span>&nbsp;<span class="op" id="3883408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883411">if</span>&nbsp;<span class="builtinfunc" id="3883414">len</span><span class="op" id="3883417">(</span><span class="ident" id="3883418">clientSignatureAndHashes</span><span class="op" id="3883442">)</span>&nbsp;<span class="op" id="3883444">==</span>&nbsp;<span class="num" id="3883447">0</span>&nbsp;<span class="op" id="3883449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3883453">//&nbsp;If&nbsp;the&nbsp;client&nbsp;didn&#39;t&nbsp;specify&nbsp;any&nbsp;signature_algorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3883512">//&nbsp;extension&nbsp;then&nbsp;we&nbsp;can&nbsp;assume&nbsp;that&nbsp;it&nbsp;supports&nbsp;SHA1.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3883573">//&nbsp;http://tools.ietf.org/html/rfc5246#section-7.4.1.4.1</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883631">return</span>&nbsp;<span class="ident" id="3883638">hashSHA1</span><span class="op" id="3883646">,</span>&nbsp;<span class="ident" id="3883648">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3883653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883657">for</span>&nbsp;<span class="ident" id="3883661">_</span><span class="op" id="3883662">,</span>&nbsp;<span class="ident" id="3883664">sigAndHash</span>&nbsp;<span class="op" id="3883675">:=</span>&nbsp;<span class="keyword" id="3883678">range</span>&nbsp;<span class="ident" id="3883684">clientSignatureAndHashes</span>&nbsp;<span class="op" id="3883709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883713">if</span>&nbsp;<span class="ident" id="3883716">sigAndHash</span><span class="op" id="3883726">.</span><span class="ident" id="3883727">signature</span>&nbsp;<span class="op" id="3883737">!=</span>&nbsp;<span class="ident" id="3883740">sigType</span>&nbsp;<span class="op" id="3883748">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883753">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3883764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883768">switch</span>&nbsp;<span class="ident" id="3883775">sigAndHash</span><span class="op" id="3883785">.</span><span class="ident" id="3883786">hash</span>&nbsp;<span class="op" id="3883791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883795">case</span>&nbsp;<span class="ident" id="3883800">hashSHA1</span><span class="op" id="3883808">,</span>&nbsp;<span class="ident" id="3883810">hashSHA256</span><span class="op" id="3883820">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883825">return</span>&nbsp;<span class="ident" id="3883832">sigAndHash</span><span class="op" id="3883842">.</span><span class="ident" id="3883843">hash</span><span class="op" id="3883847">,</span>&nbsp;<span class="ident" id="3883849">nil</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3883855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3883858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883862">return</span>&nbsp;<span class="num" id="3883869">0</span><span class="op" id="3883870">,</span>&nbsp;<span class="ident" id="3883872">errors</span><span class="op" id="3883878">.</span><span class="ident" id="3883879">New</span><span class="op" id="3883882">(</span><span class="string" id="3883883">&#34;tls:&nbsp;client&nbsp;doesn&#39;t&nbsp;support&nbsp;any&nbsp;common&nbsp;hash&nbsp;functions&#34;</span><span class="op" id="3883938">)</span><br>
<span class="lineno"></span><span class="op" id="3883940">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="3883943">func</span>&nbsp;<span class="ident" id="3883948">curveForCurveID</span><span class="op" id="3883963">(</span><span class="ident" id="3883964">id</span>&nbsp;<span class="ident" id="3883967">CurveID</span><span class="op" id="3883974">)</span>&nbsp;<span class="op" id="3883976">(</span><span class="ident" id="3883977">elliptic</span><span class="op" id="3883985">.</span><span class="ident" id="3883986">Curve</span><span class="op" id="3883991">,</span>&nbsp;<span class="builtintype" id="3883993">bool</span><span class="op" id="3883997">)</span>&nbsp;<span class="op" id="3883999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884002">switch</span>&nbsp;<span class="ident" id="3884009">id</span>&nbsp;<span class="op" id="3884012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884015">case</span>&nbsp;<span class="ident" id="3884020">CurveP256</span><span class="op" id="3884029">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884033">return</span>&nbsp;<span class="ident" id="3884040">elliptic</span><span class="op" id="3884048">.</span><span class="ident" id="3884049">P256</span><span class="op" id="3884053">(</span><span class="op" id="3884054">)</span><span class="op" id="3884055">,</span>&nbsp;<span class="builtintype" id="3884057">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884063">case</span>&nbsp;<span class="ident" id="3884068">CurveP384</span><span class="op" id="3884077">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884081">return</span>&nbsp;<span class="ident" id="3884088">elliptic</span><span class="op" id="3884096">.</span><span class="ident" id="3884097">P384</span><span class="op" id="3884101">(</span><span class="op" id="3884102">)</span><span class="op" id="3884103">,</span>&nbsp;<span class="builtintype" id="3884105">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884111">case</span>&nbsp;<span class="ident" id="3884116">CurveP521</span><span class="op" id="3884125">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884129">return</span>&nbsp;<span class="ident" id="3884136">elliptic</span><span class="op" id="3884144">.</span><span class="ident" id="3884145">P521</span><span class="op" id="3884149">(</span><span class="op" id="3884150">)</span><span class="op" id="3884151">,</span>&nbsp;<span class="builtintype" id="3884153">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884159">default</span><span class="op" id="3884166">:</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884170">return</span>&nbsp;<span class="ident" id="3884177">nil</span><span class="op" id="3884180">,</span>&nbsp;<span class="builtintype" id="3884182">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="3884192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="comment" id="3884195">//&nbsp;ecdheRSAKeyAgreement&nbsp;implements&nbsp;a&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="3884267">//&nbsp;generates&nbsp;a&nbsp;ephemeral&nbsp;EC&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;and&nbsp;signs&nbsp;it.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="3884337">//&nbsp;pre-master&nbsp;secret&nbsp;is&nbsp;then&nbsp;calculated&nbsp;using&nbsp;ECDH.&nbsp;The&nbsp;signature&nbsp;may</span><br>
<span class="lineno"></span><span class="comment" id="3884407">//&nbsp;either&nbsp;be&nbsp;ECDSA&nbsp;or&nbsp;RSA.</span><br>
<span class="lineno"></span><span class="keyword" id="3884434">type</span>&nbsp;<span class="ident" id="3884439">ecdheKeyAgreement</span>&nbsp;<span class="keyword" id="3884457">struct</span>&nbsp;<span class="op" id="3884464">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884467">version</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3884478">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884486">sigType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3884497">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884504">privateKey</span>&nbsp;<span class="op" id="3884515">[</span><span class="op" id="3884516">]</span><span class="builtintype" id="3884517">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884523">curve</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3884534">elliptic</span><span class="op" id="3884542">.</span><span class="ident" id="3884543">Curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884550">x</span><span class="op" id="3884551">,</span>&nbsp;<span class="ident" id="3884553">y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3884561">*</span><span class="ident" id="3884562">big</span><span class="op" id="3884565">.</span><span class="ident" id="3884566">Int</span><br>
<span class="lineno">190</span><span class="op" id="3884570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3884573">func</span>&nbsp;<span class="op" id="3884578">(</span><span class="ident" id="3884579">ka</span>&nbsp;<span class="op" id="3884582">*</span><span class="ident" id="3884583">ecdheKeyAgreement</span><span class="op" id="3884600">)</span>&nbsp;<span class="ident" id="3884602">generateServerKeyExchange</span><span class="op" id="3884627">(</span><span class="ident" id="3884628">config</span>&nbsp;<span class="op" id="3884635">*</span><span class="ident" id="3884636">Config</span><span class="op" id="3884642">,</span>&nbsp;<span class="ident" id="3884644">cert</span>&nbsp;<span class="op" id="3884649">*</span><span class="ident" id="3884650">Certificate</span><span class="op" id="3884661">,</span>&nbsp;<span class="ident" id="3884663">clientHello</span>&nbsp;<span class="op" id="3884675">*</span><span class="ident" id="3884676">clientHelloMsg</span><span class="op" id="3884690">,</span>&nbsp;<span class="ident" id="3884692">hello</span>&nbsp;<span class="op" id="3884698">*</span><span class="ident" id="3884699">serverHelloMsg</span><span class="op" id="3884713">)</span>&nbsp;<span class="op" id="3884715">(</span><span class="op" id="3884716">*</span><span class="ident" id="3884717">serverKeyExchangeMsg</span><span class="op" id="3884737">,</span>&nbsp;<span class="builtintype" id="3884739">error</span><span class="op" id="3884744">)</span>&nbsp;<span class="op" id="3884746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884749">var</span>&nbsp;<span class="ident" id="3884753">curveid</span>&nbsp;<span class="ident" id="3884761">CurveID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884770">preferredCurves</span>&nbsp;<span class="op" id="3884786">:=</span>&nbsp;<span class="ident" id="3884789">config</span><span class="op" id="3884795">.</span><span class="ident" id="3884796">curvePreferences</span><span class="op" id="3884812">(</span><span class="op" id="3884813">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="ident" id="3884816">NextCandidate</span><span class="op" id="3884829">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884832">for</span>&nbsp;<span class="ident" id="3884836">_</span><span class="op" id="3884837">,</span>&nbsp;<span class="ident" id="3884839">candidate</span>&nbsp;<span class="op" id="3884849">:=</span>&nbsp;<span class="keyword" id="3884852">range</span>&nbsp;<span class="ident" id="3884858">preferredCurves</span>&nbsp;<span class="op" id="3884874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884878">for</span>&nbsp;<span class="ident" id="3884882">_</span><span class="op" id="3884883">,</span>&nbsp;<span class="ident" id="3884885">c</span>&nbsp;<span class="op" id="3884887">:=</span>&nbsp;<span class="keyword" id="3884890">range</span>&nbsp;<span class="ident" id="3884896">clientHello</span><span class="op" id="3884907">.</span><span class="ident" id="3884908">supportedCurves</span>&nbsp;<span class="op" id="3884924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884929">if</span>&nbsp;<span class="ident" id="3884932">candidate</span>&nbsp;<span class="op" id="3884942">==</span>&nbsp;<span class="ident" id="3884945">c</span>&nbsp;<span class="op" id="3884947">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884953">curveid</span>&nbsp;<span class="op" id="3884961">=</span>&nbsp;<span class="ident" id="3884963">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884969">break</span>&nbsp;<span class="ident" id="3884975">NextCandidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884999">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885003">if</span>&nbsp;<span class="ident" id="3885006">curveid</span>&nbsp;<span class="op" id="3885014">==</span>&nbsp;<span class="num" id="3885017">0</span>&nbsp;<span class="op" id="3885019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885023">return</span>&nbsp;<span class="ident" id="3885030">nil</span><span class="op" id="3885033">,</span>&nbsp;<span class="ident" id="3885035">errors</span><span class="op" id="3885041">.</span><span class="ident" id="3885042">New</span><span class="op" id="3885045">(</span><span class="string" id="3885046">&#34;tls:&nbsp;no&nbsp;supported&nbsp;elliptic&nbsp;curves&nbsp;offered&#34;</span><span class="op" id="3885089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3885092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885096">var</span>&nbsp;<span class="ident" id="3885100">ok</span>&nbsp;<span class="builtintype" id="3885103">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885109">if</span>&nbsp;<span class="ident" id="3885112">ka</span><span class="op" id="3885114">.</span><span class="ident" id="3885115">curve</span><span class="op" id="3885120">,</span>&nbsp;<span class="ident" id="3885122">ok</span>&nbsp;<span class="op" id="3885125">=</span>&nbsp;<span class="ident" id="3885127">curveForCurveID</span><span class="op" id="3885142">(</span><span class="ident" id="3885143">curveid</span><span class="op" id="3885150">)</span><span class="op" id="3885151">;</span>&nbsp;<span class="op" id="3885153">!</span><span class="ident" id="3885154">ok</span>&nbsp;<span class="op" id="3885157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885161">return</span>&nbsp;<span class="ident" id="3885168">nil</span><span class="op" id="3885171">,</span>&nbsp;<span class="ident" id="3885173">errors</span><span class="op" id="3885179">.</span><span class="ident" id="3885180">New</span><span class="op" id="3885183">(</span><span class="string" id="3885184">&#34;tls:&nbsp;preferredCurves&nbsp;includes&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3885233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3885236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885240">var</span>&nbsp;<span class="ident" id="3885244">x</span><span class="op" id="3885245">,</span>&nbsp;<span class="ident" id="3885247">y</span>&nbsp;<span class="op" id="3885249">*</span><span class="ident" id="3885250">big</span><span class="op" id="3885253">.</span><span class="ident" id="3885254">Int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885259">var</span>&nbsp;<span class="ident" id="3885263">err</span>&nbsp;<span class="builtintype" id="3885267">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885274">ka</span><span class="op" id="3885276">.</span><span class="ident" id="3885277">privateKey</span><span class="op" id="3885287">,</span>&nbsp;<span class="ident" id="3885289">x</span><span class="op" id="3885290">,</span>&nbsp;<span class="ident" id="3885292">y</span><span class="op" id="3885293">,</span>&nbsp;<span class="ident" id="3885295">err</span>&nbsp;<span class="op" id="3885299">=</span>&nbsp;<span class="ident" id="3885301">elliptic</span><span class="op" id="3885309">.</span><span class="ident" id="3885310">GenerateKey</span><span class="op" id="3885321">(</span><span class="ident" id="3885322">ka</span><span class="op" id="3885324">.</span><span class="ident" id="3885325">curve</span><span class="op" id="3885330">,</span>&nbsp;<span class="ident" id="3885332">config</span><span class="op" id="3885338">.</span><span class="ident" id="3885339">rand</span><span class="op" id="3885343">(</span><span class="op" id="3885344">)</span><span class="op" id="3885345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885348">if</span>&nbsp;<span class="ident" id="3885351">err</span>&nbsp;<span class="op" id="3885355">!=</span>&nbsp;<span class="ident" id="3885358">nil</span>&nbsp;<span class="op" id="3885362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885366">return</span>&nbsp;<span class="ident" id="3885373">nil</span><span class="op" id="3885376">,</span>&nbsp;<span class="ident" id="3885378">err</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3885383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885386">ecdhePublic</span>&nbsp;<span class="op" id="3885398">:=</span>&nbsp;<span class="ident" id="3885401">elliptic</span><span class="op" id="3885409">.</span><span class="ident" id="3885410">Marshal</span><span class="op" id="3885417">(</span><span class="ident" id="3885418">ka</span><span class="op" id="3885420">.</span><span class="ident" id="3885421">curve</span><span class="op" id="3885426">,</span>&nbsp;<span class="ident" id="3885428">x</span><span class="op" id="3885429">,</span>&nbsp;<span class="ident" id="3885431">y</span><span class="op" id="3885432">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885436">//&nbsp;http://tools.ietf.org/html/rfc4492#section-5.4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885487">serverECDHParams</span>&nbsp;<span class="op" id="3885504">:=</span>&nbsp;<span class="builtinfunc" id="3885507">make</span><span class="op" id="3885511">(</span><span class="op" id="3885512">[</span><span class="op" id="3885513">]</span><span class="builtintype" id="3885514">byte</span><span class="op" id="3885518">,</span>&nbsp;<span class="num" id="3885520">1</span><span class="op" id="3885521">+</span><span class="num" id="3885522">2</span><span class="op" id="3885523">+</span><span class="num" id="3885524">1</span><span class="op" id="3885525">+</span><span class="builtinfunc" id="3885526">len</span><span class="op" id="3885529">(</span><span class="ident" id="3885530">ecdhePublic</span><span class="op" id="3885541">)</span><span class="op" id="3885542">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885545">serverECDHParams</span><span class="op" id="3885561">[</span><span class="num" id="3885562">0</span><span class="op" id="3885563">]</span>&nbsp;<span class="op" id="3885565">=</span>&nbsp;<span class="num" id="3885567">3</span>&nbsp;<span class="comment" id="3885569">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885585">serverECDHParams</span><span class="op" id="3885601">[</span><span class="num" id="3885602">1</span><span class="op" id="3885603">]</span>&nbsp;<span class="op" id="3885605">=</span>&nbsp;<span class="builtintype" id="3885607">byte</span><span class="op" id="3885611">(</span><span class="ident" id="3885612">curveid</span>&nbsp;<span class="op" id="3885620">&gt;&gt;</span>&nbsp;<span class="num" id="3885623">8</span><span class="op" id="3885624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885627">serverECDHParams</span><span class="op" id="3885643">[</span><span class="num" id="3885644">2</span><span class="op" id="3885645">]</span>&nbsp;<span class="op" id="3885647">=</span>&nbsp;<span class="builtintype" id="3885649">byte</span><span class="op" id="3885653">(</span><span class="ident" id="3885654">curveid</span><span class="op" id="3885661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885664">serverECDHParams</span><span class="op" id="3885680">[</span><span class="num" id="3885681">3</span><span class="op" id="3885682">]</span>&nbsp;<span class="op" id="3885684">=</span>&nbsp;<span class="builtintype" id="3885686">byte</span><span class="op" id="3885690">(</span><span class="builtinfunc" id="3885691">len</span><span class="op" id="3885694">(</span><span class="ident" id="3885695">ecdhePublic</span><span class="op" id="3885706">)</span><span class="op" id="3885707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3885710">copy</span><span class="op" id="3885714">(</span><span class="ident" id="3885715">serverECDHParams</span><span class="op" id="3885731">[</span><span class="num" id="3885732">4</span><span class="op" id="3885733">:</span><span class="op" id="3885734">]</span><span class="op" id="3885735">,</span>&nbsp;<span class="ident" id="3885737">ecdhePublic</span><span class="op" id="3885748">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885752">var</span>&nbsp;<span class="ident" id="3885756">tls12HashId</span>&nbsp;<span class="builtintype" id="3885768">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885775">if</span>&nbsp;<span class="ident" id="3885778">ka</span><span class="op" id="3885780">.</span><span class="ident" id="3885781">version</span>&nbsp;<span class="op" id="3885789">&gt;=</span>&nbsp;<span class="ident" id="3885792">VersionTLS12</span>&nbsp;<span class="op" id="3885805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885809">if</span>&nbsp;<span class="ident" id="3885812">tls12HashId</span><span class="op" id="3885823">,</span>&nbsp;<span class="ident" id="3885825">err</span>&nbsp;<span class="op" id="3885829">=</span>&nbsp;<span class="ident" id="3885831">pickTLS12HashForSignature</span><span class="op" id="3885856">(</span><span class="ident" id="3885857">ka</span><span class="op" id="3885859">.</span><span class="ident" id="3885860">sigType</span><span class="op" id="3885867">,</span>&nbsp;<span class="ident" id="3885869">clientHello</span><span class="op" id="3885880">.</span><span class="ident" id="3885881">signatureAndHashes</span><span class="op" id="3885899">)</span><span class="op" id="3885900">;</span>&nbsp;<span class="ident" id="3885902">err</span>&nbsp;<span class="op" id="3885906">!=</span>&nbsp;<span class="ident" id="3885909">nil</span>&nbsp;<span class="op" id="3885913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885918">return</span>&nbsp;<span class="ident" id="3885925">nil</span><span class="op" id="3885928">,</span>&nbsp;<span class="ident" id="3885930">err</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3885936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3885939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885943">digest</span><span class="op" id="3885949">,</span>&nbsp;<span class="ident" id="3885951">hashFunc</span><span class="op" id="3885959">,</span>&nbsp;<span class="ident" id="3885961">err</span>&nbsp;<span class="op" id="3885965">:=</span>&nbsp;<span class="ident" id="3885968">hashForServerKeyExchange</span><span class="op" id="3885992">(</span><span class="ident" id="3885993">ka</span><span class="op" id="3885995">.</span><span class="ident" id="3885996">sigType</span><span class="op" id="3886003">,</span>&nbsp;<span class="ident" id="3886005">tls12HashId</span><span class="op" id="3886016">,</span>&nbsp;<span class="ident" id="3886018">ka</span><span class="op" id="3886020">.</span><span class="ident" id="3886021">version</span><span class="op" id="3886028">,</span>&nbsp;<span class="ident" id="3886030">clientHello</span><span class="op" id="3886041">.</span><span class="ident" id="3886042">random</span><span class="op" id="3886048">,</span>&nbsp;<span class="ident" id="3886050">hello</span><span class="op" id="3886055">.</span><span class="ident" id="3886056">random</span><span class="op" id="3886062">,</span>&nbsp;<span class="ident" id="3886064">serverECDHParams</span><span class="op" id="3886080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886083">if</span>&nbsp;<span class="ident" id="3886086">err</span>&nbsp;<span class="op" id="3886090">!=</span>&nbsp;<span class="ident" id="3886093">nil</span>&nbsp;<span class="op" id="3886097">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886101">return</span>&nbsp;<span class="ident" id="3886108">nil</span><span class="op" id="3886111">,</span>&nbsp;<span class="ident" id="3886113">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3886118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886121">var</span>&nbsp;<span class="ident" id="3886125">sig</span>&nbsp;<span class="op" id="3886129">[</span><span class="op" id="3886130">]</span><span class="builtintype" id="3886131">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886137">switch</span>&nbsp;<span class="ident" id="3886144">ka</span><span class="op" id="3886146">.</span><span class="ident" id="3886147">sigType</span>&nbsp;<span class="op" id="3886155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886158">case</span>&nbsp;<span class="ident" id="3886163">signatureECDSA</span><span class="op" id="3886177">:</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886181">privKey</span><span class="op" id="3886188">,</span>&nbsp;<span class="ident" id="3886190">ok</span>&nbsp;<span class="op" id="3886193">:=</span>&nbsp;<span class="ident" id="3886196">cert</span><span class="op" id="3886200">.</span><span class="ident" id="3886201">PrivateKey</span><span class="op" id="3886211">.</span><span class="op" id="3886212">(</span><span class="op" id="3886213">*</span><span class="ident" id="3886214">ecdsa</span><span class="op" id="3886219">.</span><span class="ident" id="3886220">PrivateKey</span><span class="op" id="3886230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886234">if</span>&nbsp;<span class="op" id="3886237">!</span><span class="ident" id="3886238">ok</span>&nbsp;<span class="op" id="3886241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886246">return</span>&nbsp;<span class="ident" id="3886253">nil</span><span class="op" id="3886256">,</span>&nbsp;<span class="ident" id="3886258">errors</span><span class="op" id="3886264">.</span><span class="ident" id="3886265">New</span><span class="op" id="3886268">(</span><span class="string" id="3886269">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;an&nbsp;ECDSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="3886319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3886323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886327">r</span><span class="op" id="3886328">,</span>&nbsp;<span class="ident" id="3886330">s</span><span class="op" id="3886331">,</span>&nbsp;<span class="ident" id="3886333">err</span>&nbsp;<span class="op" id="3886337">:=</span>&nbsp;<span class="ident" id="3886340">ecdsa</span><span class="op" id="3886345">.</span><span class="ident" id="3886346">Sign</span><span class="op" id="3886350">(</span><span class="ident" id="3886351">config</span><span class="op" id="3886357">.</span><span class="ident" id="3886358">rand</span><span class="op" id="3886362">(</span><span class="op" id="3886363">)</span><span class="op" id="3886364">,</span>&nbsp;<span class="ident" id="3886366">privKey</span><span class="op" id="3886373">,</span>&nbsp;<span class="ident" id="3886375">digest</span><span class="op" id="3886381">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886385">if</span>&nbsp;<span class="ident" id="3886388">err</span>&nbsp;<span class="op" id="3886392">!=</span>&nbsp;<span class="ident" id="3886395">nil</span>&nbsp;<span class="op" id="3886399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886404">return</span>&nbsp;<span class="ident" id="3886411">nil</span><span class="op" id="3886414">,</span>&nbsp;<span class="ident" id="3886416">errors</span><span class="op" id="3886422">.</span><span class="ident" id="3886423">New</span><span class="op" id="3886426">(</span><span class="string" id="3886427">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="3886463">+</span>&nbsp;<span class="ident" id="3886465">err</span><span class="op" id="3886468">.</span><span class="ident" id="3886469">Error</span><span class="op" id="3886474">(</span><span class="op" id="3886475">)</span><span class="op" id="3886476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3886480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886484">sig</span><span class="op" id="3886487">,</span>&nbsp;<span class="ident" id="3886489">err</span>&nbsp;<span class="op" id="3886493">=</span>&nbsp;<span class="ident" id="3886495">asn1</span><span class="op" id="3886499">.</span><span class="ident" id="3886500">Marshal</span><span class="op" id="3886507">(</span><span class="ident" id="3886508">ecdsaSignature</span><span class="op" id="3886522">{</span><span class="ident" id="3886523">r</span><span class="op" id="3886524">,</span>&nbsp;<span class="ident" id="3886526">s</span><span class="op" id="3886527">}</span><span class="op" id="3886528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886531">case</span>&nbsp;<span class="ident" id="3886536">signatureRSA</span><span class="op" id="3886548">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886552">privKey</span><span class="op" id="3886559">,</span>&nbsp;<span class="ident" id="3886561">ok</span>&nbsp;<span class="op" id="3886564">:=</span>&nbsp;<span class="ident" id="3886567">cert</span><span class="op" id="3886571">.</span><span class="ident" id="3886572">PrivateKey</span><span class="op" id="3886582">.</span><span class="op" id="3886583">(</span><span class="op" id="3886584">*</span><span class="ident" id="3886585">rsa</span><span class="op" id="3886588">.</span><span class="ident" id="3886589">PrivateKey</span><span class="op" id="3886599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886603">if</span>&nbsp;<span class="op" id="3886606">!</span><span class="ident" id="3886607">ok</span>&nbsp;<span class="op" id="3886610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886615">return</span>&nbsp;<span class="ident" id="3886622">nil</span><span class="op" id="3886625">,</span>&nbsp;<span class="ident" id="3886627">errors</span><span class="op" id="3886633">.</span><span class="ident" id="3886634">New</span><span class="op" id="3886637">(</span><span class="string" id="3886638">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="3886683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3886687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886691">sig</span><span class="op" id="3886694">,</span>&nbsp;<span class="ident" id="3886696">err</span>&nbsp;<span class="op" id="3886700">=</span>&nbsp;<span class="ident" id="3886702">rsa</span><span class="op" id="3886705">.</span><span class="ident" id="3886706">SignPKCS1v15</span><span class="op" id="3886718">(</span><span class="ident" id="3886719">config</span><span class="op" id="3886725">.</span><span class="ident" id="3886726">rand</span><span class="op" id="3886730">(</span><span class="op" id="3886731">)</span><span class="op" id="3886732">,</span>&nbsp;<span class="ident" id="3886734">privKey</span><span class="op" id="3886741">,</span>&nbsp;<span class="ident" id="3886743">hashFunc</span><span class="op" id="3886751">,</span>&nbsp;<span class="ident" id="3886753">digest</span><span class="op" id="3886759">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886763">if</span>&nbsp;<span class="ident" id="3886766">err</span>&nbsp;<span class="op" id="3886770">!=</span>&nbsp;<span class="ident" id="3886773">nil</span>&nbsp;<span class="op" id="3886777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886782">return</span>&nbsp;<span class="ident" id="3886789">nil</span><span class="op" id="3886792">,</span>&nbsp;<span class="ident" id="3886794">errors</span><span class="op" id="3886800">.</span><span class="ident" id="3886801">New</span><span class="op" id="3886804">(</span><span class="string" id="3886805">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="3886841">+</span>&nbsp;<span class="ident" id="3886843">err</span><span class="op" id="3886846">.</span><span class="ident" id="3886847">Error</span><span class="op" id="3886852">(</span><span class="op" id="3886853">)</span><span class="op" id="3886854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3886858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886861">default</span><span class="op" id="3886868">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886872">return</span>&nbsp;<span class="ident" id="3886879">nil</span><span class="op" id="3886882">,</span>&nbsp;<span class="ident" id="3886884">errors</span><span class="op" id="3886890">.</span><span class="ident" id="3886891">New</span><span class="op" id="3886894">(</span><span class="string" id="3886895">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="3886930">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3886933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886937">skx</span>&nbsp;<span class="op" id="3886941">:=</span>&nbsp;<span class="builtinfunc" id="3886944">new</span><span class="op" id="3886947">(</span><span class="ident" id="3886948">serverKeyExchangeMsg</span><span class="op" id="3886968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886971">sigAndHashLen</span>&nbsp;<span class="op" id="3886985">:=</span>&nbsp;<span class="num" id="3886988">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886991">if</span>&nbsp;<span class="ident" id="3886994">ka</span><span class="op" id="3886996">.</span><span class="ident" id="3886997">version</span>&nbsp;<span class="op" id="3887005">&gt;=</span>&nbsp;<span class="ident" id="3887008">VersionTLS12</span>&nbsp;<span class="op" id="3887021">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887025">sigAndHashLen</span>&nbsp;<span class="op" id="3887039">=</span>&nbsp;<span class="num" id="3887041">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3887044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887047">skx</span><span class="op" id="3887050">.</span><span class="ident" id="3887051">key</span>&nbsp;<span class="op" id="3887055">=</span>&nbsp;<span class="builtinfunc" id="3887057">make</span><span class="op" id="3887061">(</span><span class="op" id="3887062">[</span><span class="op" id="3887063">]</span><span class="builtintype" id="3887064">byte</span><span class="op" id="3887068">,</span>&nbsp;<span class="builtinfunc" id="3887070">len</span><span class="op" id="3887073">(</span><span class="ident" id="3887074">serverECDHParams</span><span class="op" id="3887090">)</span><span class="op" id="3887091">+</span><span class="ident" id="3887092">sigAndHashLen</span><span class="op" id="3887105">+</span><span class="num" id="3887106">2</span><span class="op" id="3887107">+</span><span class="builtinfunc" id="3887108">len</span><span class="op" id="3887111">(</span><span class="ident" id="3887112">sig</span><span class="op" id="3887115">)</span><span class="op" id="3887116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3887119">copy</span><span class="op" id="3887123">(</span><span class="ident" id="3887124">skx</span><span class="op" id="3887127">.</span><span class="ident" id="3887128">key</span><span class="op" id="3887131">,</span>&nbsp;<span class="ident" id="3887133">serverECDHParams</span><span class="op" id="3887149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887152">k</span>&nbsp;<span class="op" id="3887154">:=</span>&nbsp;<span class="ident" id="3887157">skx</span><span class="op" id="3887160">.</span><span class="ident" id="3887161">key</span><span class="op" id="3887164">[</span><span class="builtinfunc" id="3887165">len</span><span class="op" id="3887168">(</span><span class="ident" id="3887169">serverECDHParams</span><span class="op" id="3887185">)</span><span class="op" id="3887186">:</span><span class="op" id="3887187">]</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887190">if</span>&nbsp;<span class="ident" id="3887193">ka</span><span class="op" id="3887195">.</span><span class="ident" id="3887196">version</span>&nbsp;<span class="op" id="3887204">&gt;=</span>&nbsp;<span class="ident" id="3887207">VersionTLS12</span>&nbsp;<span class="op" id="3887220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887224">k</span><span class="op" id="3887225">[</span><span class="num" id="3887226">0</span><span class="op" id="3887227">]</span>&nbsp;<span class="op" id="3887229">=</span>&nbsp;<span class="ident" id="3887231">tls12HashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887245">k</span><span class="op" id="3887246">[</span><span class="num" id="3887247">1</span><span class="op" id="3887248">]</span>&nbsp;<span class="op" id="3887250">=</span>&nbsp;<span class="ident" id="3887252">ka</span><span class="op" id="3887254">.</span><span class="ident" id="3887255">sigType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887265">k</span>&nbsp;<span class="op" id="3887267">=</span>&nbsp;<span class="ident" id="3887269">k</span><span class="op" id="3887270">[</span><span class="num" id="3887271">2</span><span class="op" id="3887272">:</span><span class="op" id="3887273">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3887276">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887279">k</span><span class="op" id="3887280">[</span><span class="num" id="3887281">0</span><span class="op" id="3887282">]</span>&nbsp;<span class="op" id="3887284">=</span>&nbsp;<span class="builtintype" id="3887286">byte</span><span class="op" id="3887290">(</span><span class="builtinfunc" id="3887291">len</span><span class="op" id="3887294">(</span><span class="ident" id="3887295">sig</span><span class="op" id="3887298">)</span>&nbsp;<span class="op" id="3887300">&gt;&gt;</span>&nbsp;<span class="num" id="3887303">8</span><span class="op" id="3887304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887307">k</span><span class="op" id="3887308">[</span><span class="num" id="3887309">1</span><span class="op" id="3887310">]</span>&nbsp;<span class="op" id="3887312">=</span>&nbsp;<span class="builtintype" id="3887314">byte</span><span class="op" id="3887318">(</span><span class="builtinfunc" id="3887319">len</span><span class="op" id="3887322">(</span><span class="ident" id="3887323">sig</span><span class="op" id="3887326">)</span><span class="op" id="3887327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3887330">copy</span><span class="op" id="3887334">(</span><span class="ident" id="3887335">k</span><span class="op" id="3887336">[</span><span class="num" id="3887337">2</span><span class="op" id="3887338">:</span><span class="op" id="3887339">]</span><span class="op" id="3887340">,</span>&nbsp;<span class="ident" id="3887342">sig</span><span class="op" id="3887345">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887349">return</span>&nbsp;<span class="ident" id="3887356">skx</span><span class="op" id="3887359">,</span>&nbsp;<span class="ident" id="3887361">nil</span><br>
<span class="lineno">285</span><span class="op" id="3887365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3887368">func</span>&nbsp;<span class="op" id="3887373">(</span><span class="ident" id="3887374">ka</span>&nbsp;<span class="op" id="3887377">*</span><span class="ident" id="3887378">ecdheKeyAgreement</span><span class="op" id="3887395">)</span>&nbsp;<span class="ident" id="3887397">processClientKeyExchange</span><span class="op" id="3887421">(</span><span class="ident" id="3887422">config</span>&nbsp;<span class="op" id="3887429">*</span><span class="ident" id="3887430">Config</span><span class="op" id="3887436">,</span>&nbsp;<span class="ident" id="3887438">cert</span>&nbsp;<span class="op" id="3887443">*</span><span class="ident" id="3887444">Certificate</span><span class="op" id="3887455">,</span>&nbsp;<span class="ident" id="3887457">ckx</span>&nbsp;<span class="op" id="3887461">*</span><span class="ident" id="3887462">clientKeyExchangeMsg</span><span class="op" id="3887482">,</span>&nbsp;<span class="ident" id="3887484">version</span>&nbsp;<span class="builtintype" id="3887492">uint16</span><span class="op" id="3887498">)</span>&nbsp;<span class="op" id="3887500">(</span><span class="op" id="3887501">[</span><span class="op" id="3887502">]</span><span class="builtintype" id="3887503">byte</span><span class="op" id="3887507">,</span>&nbsp;<span class="builtintype" id="3887509">error</span><span class="op" id="3887514">)</span>&nbsp;<span class="op" id="3887516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887519">if</span>&nbsp;<span class="builtinfunc" id="3887522">len</span><span class="op" id="3887525">(</span><span class="ident" id="3887526">ckx</span><span class="op" id="3887529">.</span><span class="ident" id="3887530">ciphertext</span><span class="op" id="3887540">)</span>&nbsp;<span class="op" id="3887542">==</span>&nbsp;<span class="num" id="3887545">0</span>&nbsp;<span class="op" id="3887547">||</span>&nbsp;<span class="builtintype" id="3887550">int</span><span class="op" id="3887553">(</span><span class="ident" id="3887554">ckx</span><span class="op" id="3887557">.</span><span class="ident" id="3887558">ciphertext</span><span class="op" id="3887568">[</span><span class="num" id="3887569">0</span><span class="op" id="3887570">]</span><span class="op" id="3887571">)</span>&nbsp;<span class="op" id="3887573">!=</span>&nbsp;<span class="builtinfunc" id="3887576">len</span><span class="op" id="3887579">(</span><span class="ident" id="3887580">ckx</span><span class="op" id="3887583">.</span><span class="ident" id="3887584">ciphertext</span><span class="op" id="3887594">)</span><span class="op" id="3887595">-</span><span class="num" id="3887596">1</span>&nbsp;<span class="op" id="3887598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887602">return</span>&nbsp;<span class="ident" id="3887609">nil</span><span class="op" id="3887612">,</span>&nbsp;<span class="ident" id="3887614">errClientKeyExchange</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3887636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887639">x</span><span class="op" id="3887640">,</span>&nbsp;<span class="ident" id="3887642">y</span>&nbsp;<span class="op" id="3887644">:=</span>&nbsp;<span class="ident" id="3887647">elliptic</span><span class="op" id="3887655">.</span><span class="ident" id="3887656">Unmarshal</span><span class="op" id="3887665">(</span><span class="ident" id="3887666">ka</span><span class="op" id="3887668">.</span><span class="ident" id="3887669">curve</span><span class="op" id="3887674">,</span>&nbsp;<span class="ident" id="3887676">ckx</span><span class="op" id="3887679">.</span><span class="ident" id="3887680">ciphertext</span><span class="op" id="3887690">[</span><span class="num" id="3887691">1</span><span class="op" id="3887692">:</span><span class="op" id="3887693">]</span><span class="op" id="3887694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887697">if</span>&nbsp;<span class="ident" id="3887700">x</span>&nbsp;<span class="op" id="3887702">==</span>&nbsp;<span class="ident" id="3887705">nil</span>&nbsp;<span class="op" id="3887709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887713">return</span>&nbsp;<span class="ident" id="3887720">nil</span><span class="op" id="3887723">,</span>&nbsp;<span class="ident" id="3887725">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3887747">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887750">if</span>&nbsp;<span class="op" id="3887753">!</span><span class="ident" id="3887754">ka</span><span class="op" id="3887756">.</span><span class="ident" id="3887757">curve</span><span class="op" id="3887762">.</span><span class="ident" id="3887763">IsOnCurve</span><span class="op" id="3887772">(</span><span class="ident" id="3887773">x</span><span class="op" id="3887774">,</span>&nbsp;<span class="ident" id="3887776">y</span><span class="op" id="3887777">)</span>&nbsp;<span class="op" id="3887779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887783">return</span>&nbsp;<span class="ident" id="3887790">nil</span><span class="op" id="3887793">,</span>&nbsp;<span class="ident" id="3887795">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3887817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887820">x</span><span class="op" id="3887821">,</span>&nbsp;<span class="ident" id="3887823">_</span>&nbsp;<span class="op" id="3887825">=</span>&nbsp;<span class="ident" id="3887827">ka</span><span class="op" id="3887829">.</span><span class="ident" id="3887830">curve</span><span class="op" id="3887835">.</span><span class="ident" id="3887836">ScalarMult</span><span class="op" id="3887846">(</span><span class="ident" id="3887847">x</span><span class="op" id="3887848">,</span>&nbsp;<span class="ident" id="3887850">y</span><span class="op" id="3887851">,</span>&nbsp;<span class="ident" id="3887853">ka</span><span class="op" id="3887855">.</span><span class="ident" id="3887856">privateKey</span><span class="op" id="3887866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887869">preMasterSecret</span>&nbsp;<span class="op" id="3887885">:=</span>&nbsp;<span class="builtinfunc" id="3887888">make</span><span class="op" id="3887892">(</span><span class="op" id="3887893">[</span><span class="op" id="3887894">]</span><span class="builtintype" id="3887895">byte</span><span class="op" id="3887899">,</span>&nbsp;<span class="op" id="3887901">(</span><span class="ident" id="3887902">ka</span><span class="op" id="3887904">.</span><span class="ident" id="3887905">curve</span><span class="op" id="3887910">.</span><span class="ident" id="3887911">Params</span><span class="op" id="3887917">(</span><span class="op" id="3887918">)</span><span class="op" id="3887919">.</span><span class="ident" id="3887920">BitSize</span><span class="op" id="3887927">+</span><span class="num" id="3887928">7</span><span class="op" id="3887929">)</span><span class="op" id="3887930">&gt;&gt;</span><span class="num" id="3887932">3</span><span class="op" id="3887933">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887936">xBytes</span>&nbsp;<span class="op" id="3887943">:=</span>&nbsp;<span class="ident" id="3887946">x</span><span class="op" id="3887947">.</span><span class="ident" id="3887948">Bytes</span><span class="op" id="3887953">(</span><span class="op" id="3887954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3887957">copy</span><span class="op" id="3887961">(</span><span class="ident" id="3887962">preMasterSecret</span><span class="op" id="3887977">[</span><span class="builtinfunc" id="3887978">len</span><span class="op" id="3887981">(</span><span class="ident" id="3887982">preMasterSecret</span><span class="op" id="3887997">)</span><span class="op" id="3887998">-</span><span class="builtinfunc" id="3887999">len</span><span class="op" id="3888002">(</span><span class="ident" id="3888003">xBytes</span><span class="op" id="3888009">)</span><span class="op" id="3888010">:</span><span class="op" id="3888011">]</span><span class="op" id="3888012">,</span>&nbsp;<span class="ident" id="3888014">xBytes</span><span class="op" id="3888020">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888024">return</span>&nbsp;<span class="ident" id="3888031">preMasterSecret</span><span class="op" id="3888046">,</span>&nbsp;<span class="ident" id="3888048">nil</span><br>
<span class="lineno"></span><span class="op" id="3888052">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="3888055">func</span>&nbsp;<span class="op" id="3888060">(</span><span class="ident" id="3888061">ka</span>&nbsp;<span class="op" id="3888064">*</span><span class="ident" id="3888065">ecdheKeyAgreement</span><span class="op" id="3888082">)</span>&nbsp;<span class="ident" id="3888084">processServerKeyExchange</span><span class="op" id="3888108">(</span><span class="ident" id="3888109">config</span>&nbsp;<span class="op" id="3888116">*</span><span class="ident" id="3888117">Config</span><span class="op" id="3888123">,</span>&nbsp;<span class="ident" id="3888125">clientHello</span>&nbsp;<span class="op" id="3888137">*</span><span class="ident" id="3888138">clientHelloMsg</span><span class="op" id="3888152">,</span>&nbsp;<span class="ident" id="3888154">serverHello</span>&nbsp;<span class="op" id="3888166">*</span><span class="ident" id="3888167">serverHelloMsg</span><span class="op" id="3888181">,</span>&nbsp;<span class="ident" id="3888183">cert</span>&nbsp;<span class="op" id="3888188">*</span><span class="ident" id="3888189">x509</span><span class="op" id="3888193">.</span><span class="ident" id="3888194">Certificate</span><span class="op" id="3888205">,</span>&nbsp;<span class="ident" id="3888207">skx</span>&nbsp;<span class="op" id="3888211">*</span><span class="ident" id="3888212">serverKeyExchangeMsg</span><span class="op" id="3888232">)</span>&nbsp;<span class="builtintype" id="3888234">error</span>&nbsp;<span class="op" id="3888240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888243">if</span>&nbsp;<span class="builtinfunc" id="3888246">len</span><span class="op" id="3888249">(</span><span class="ident" id="3888250">skx</span><span class="op" id="3888253">.</span><span class="ident" id="3888254">key</span><span class="op" id="3888257">)</span>&nbsp;<span class="op" id="3888259">&lt;</span>&nbsp;<span class="num" id="3888261">4</span>&nbsp;<span class="op" id="3888263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888267">return</span>&nbsp;<span class="ident" id="3888274">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3888296">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888299">if</span>&nbsp;<span class="ident" id="3888302">skx</span><span class="op" id="3888305">.</span><span class="ident" id="3888306">key</span><span class="op" id="3888309">[</span><span class="num" id="3888310">0</span><span class="op" id="3888311">]</span>&nbsp;<span class="op" id="3888313">!=</span>&nbsp;<span class="num" id="3888316">3</span>&nbsp;<span class="op" id="3888318">{</span>&nbsp;<span class="comment" id="3888320">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888337">return</span>&nbsp;<span class="ident" id="3888344">errors</span><span class="op" id="3888350">.</span><span class="ident" id="3888351">New</span><span class="op" id="3888354">(</span><span class="string" id="3888355">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3888395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3888398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3888401">curveid</span>&nbsp;<span class="op" id="3888409">:=</span>&nbsp;<span class="ident" id="3888412">CurveID</span><span class="op" id="3888419">(</span><span class="ident" id="3888420">skx</span><span class="op" id="3888423">.</span><span class="ident" id="3888424">key</span><span class="op" id="3888427">[</span><span class="num" id="3888428">1</span><span class="op" id="3888429">]</span><span class="op" id="3888430">)</span><span class="op" id="3888431">&lt;&lt;</span><span class="num" id="3888433">8</span>&nbsp;<span class="op" id="3888435">|</span>&nbsp;<span class="ident" id="3888437">CurveID</span><span class="op" id="3888444">(</span><span class="ident" id="3888445">skx</span><span class="op" id="3888448">.</span><span class="ident" id="3888449">key</span><span class="op" id="3888452">[</span><span class="num" id="3888453">2</span><span class="op" id="3888454">]</span><span class="op" id="3888455">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888459">var</span>&nbsp;<span class="ident" id="3888463">ok</span>&nbsp;<span class="builtintype" id="3888466">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888472">if</span>&nbsp;<span class="ident" id="3888475">ka</span><span class="op" id="3888477">.</span><span class="ident" id="3888478">curve</span><span class="op" id="3888483">,</span>&nbsp;<span class="ident" id="3888485">ok</span>&nbsp;<span class="op" id="3888488">=</span>&nbsp;<span class="ident" id="3888490">curveForCurveID</span><span class="op" id="3888505">(</span><span class="ident" id="3888506">curveid</span><span class="op" id="3888513">)</span><span class="op" id="3888514">;</span>&nbsp;<span class="op" id="3888516">!</span><span class="ident" id="3888517">ok</span>&nbsp;<span class="op" id="3888520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888524">return</span>&nbsp;<span class="ident" id="3888531">errors</span><span class="op" id="3888537">.</span><span class="ident" id="3888538">New</span><span class="op" id="3888541">(</span><span class="string" id="3888542">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3888582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3888585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3888589">publicLen</span>&nbsp;<span class="op" id="3888599">:=</span>&nbsp;<span class="builtintype" id="3888602">int</span><span class="op" id="3888605">(</span><span class="ident" id="3888606">skx</span><span class="op" id="3888609">.</span><span class="ident" id="3888610">key</span><span class="op" id="3888613">[</span><span class="num" id="3888614">3</span><span class="op" id="3888615">]</span><span class="op" id="3888616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888619">if</span>&nbsp;<span class="ident" id="3888622">publicLen</span><span class="op" id="3888631">+</span><span class="num" id="3888632">4</span>&nbsp;<span class="op" id="3888634">&gt;</span>&nbsp;<span class="builtinfunc" id="3888636">len</span><span class="op" id="3888639">(</span><span class="ident" id="3888640">skx</span><span class="op" id="3888643">.</span><span class="ident" id="3888644">key</span><span class="op" id="3888647">)</span>&nbsp;<span class="op" id="3888649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888653">return</span>&nbsp;<span class="ident" id="3888660">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3888682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3888685">ka</span><span class="op" id="3888687">.</span><span class="ident" id="3888688">x</span><span class="op" id="3888689">,</span>&nbsp;<span class="ident" id="3888691">ka</span><span class="op" id="3888693">.</span><span class="ident" id="3888694">y</span>&nbsp;<span class="op" id="3888696">=</span>&nbsp;<span class="ident" id="3888698">elliptic</span><span class="op" id="3888706">.</span><span class="ident" id="3888707">Unmarshal</span><span class="op" id="3888716">(</span><span class="ident" id="3888717">ka</span><span class="op" id="3888719">.</span><span class="ident" id="3888720">curve</span><span class="op" id="3888725">,</span>&nbsp;<span class="ident" id="3888727">skx</span><span class="op" id="3888730">.</span><span class="ident" id="3888731">key</span><span class="op" id="3888734">[</span><span class="num" id="3888735">4</span><span class="op" id="3888736">:</span><span class="num" id="3888737">4</span><span class="op" id="3888738">+</span><span class="ident" id="3888739">publicLen</span><span class="op" id="3888748">]</span><span class="op" id="3888749">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888752">if</span>&nbsp;<span class="ident" id="3888755">ka</span><span class="op" id="3888757">.</span><span class="ident" id="3888758">x</span>&nbsp;<span class="op" id="3888760">==</span>&nbsp;<span class="ident" id="3888763">nil</span>&nbsp;<span class="op" id="3888767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888771">return</span>&nbsp;<span class="ident" id="3888778">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3888800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888803">if</span>&nbsp;<span class="op" id="3888806">!</span><span class="ident" id="3888807">ka</span><span class="op" id="3888809">.</span><span class="ident" id="3888810">curve</span><span class="op" id="3888815">.</span><span class="ident" id="3888816">IsOnCurve</span><span class="op" id="3888825">(</span><span class="ident" id="3888826">ka</span><span class="op" id="3888828">.</span><span class="ident" id="3888829">x</span><span class="op" id="3888830">,</span>&nbsp;<span class="ident" id="3888832">ka</span><span class="op" id="3888834">.</span><span class="ident" id="3888835">y</span><span class="op" id="3888836">)</span>&nbsp;<span class="op" id="3888838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888842">return</span>&nbsp;<span class="ident" id="3888849">errServerKeyExchange</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3888871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3888874">serverECDHParams</span>&nbsp;<span class="op" id="3888891">:=</span>&nbsp;<span class="ident" id="3888894">skx</span><span class="op" id="3888897">.</span><span class="ident" id="3888898">key</span><span class="op" id="3888901">[</span><span class="op" id="3888902">:</span><span class="num" id="3888903">4</span><span class="op" id="3888904">+</span><span class="ident" id="3888905">publicLen</span><span class="op" id="3888914">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3888918">sig</span>&nbsp;<span class="op" id="3888922">:=</span>&nbsp;<span class="ident" id="3888925">skx</span><span class="op" id="3888928">.</span><span class="ident" id="3888929">key</span><span class="op" id="3888932">[</span><span class="num" id="3888933">4</span><span class="op" id="3888934">+</span><span class="ident" id="3888935">publicLen</span><span class="op" id="3888944">:</span><span class="op" id="3888945">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888948">if</span>&nbsp;<span class="builtinfunc" id="3888951">len</span><span class="op" id="3888954">(</span><span class="ident" id="3888955">sig</span><span class="op" id="3888958">)</span>&nbsp;<span class="op" id="3888960">&lt;</span>&nbsp;<span class="num" id="3888962">2</span>&nbsp;<span class="op" id="3888964">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888968">return</span>&nbsp;<span class="ident" id="3888975">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3888997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889001">var</span>&nbsp;<span class="ident" id="3889005">tls12HashId</span>&nbsp;<span class="builtintype" id="3889017">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889024">if</span>&nbsp;<span class="ident" id="3889027">ka</span><span class="op" id="3889029">.</span><span class="ident" id="3889030">version</span>&nbsp;<span class="op" id="3889038">&gt;=</span>&nbsp;<span class="ident" id="3889041">VersionTLS12</span>&nbsp;<span class="op" id="3889054">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3889058">//&nbsp;handle&nbsp;SignatureAndHashAlgorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889096">var</span>&nbsp;<span class="ident" id="3889100">sigAndHash</span>&nbsp;<span class="op" id="3889111">[</span><span class="op" id="3889112">]</span><span class="builtintype" id="3889113">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889121">sigAndHash</span><span class="op" id="3889131">,</span>&nbsp;<span class="ident" id="3889133">sig</span>&nbsp;<span class="op" id="3889137">=</span>&nbsp;<span class="ident" id="3889139">sig</span><span class="op" id="3889142">[</span><span class="op" id="3889143">:</span><span class="num" id="3889144">2</span><span class="op" id="3889145">]</span><span class="op" id="3889146">,</span>&nbsp;<span class="ident" id="3889148">sig</span><span class="op" id="3889151">[</span><span class="num" id="3889152">2</span><span class="op" id="3889153">:</span><span class="op" id="3889154">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889158">if</span>&nbsp;<span class="ident" id="3889161">sigAndHash</span><span class="op" id="3889171">[</span><span class="num" id="3889172">1</span><span class="op" id="3889173">]</span>&nbsp;<span class="op" id="3889175">!=</span>&nbsp;<span class="ident" id="3889178">ka</span><span class="op" id="3889180">.</span><span class="ident" id="3889181">sigType</span>&nbsp;<span class="op" id="3889189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889194">return</span>&nbsp;<span class="ident" id="3889201">errServerKeyExchange</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3889224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889228">tls12HashId</span>&nbsp;<span class="op" id="3889240">=</span>&nbsp;<span class="ident" id="3889242">sigAndHash</span><span class="op" id="3889252">[</span><span class="num" id="3889253">0</span><span class="op" id="3889254">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889258">if</span>&nbsp;<span class="builtinfunc" id="3889261">len</span><span class="op" id="3889264">(</span><span class="ident" id="3889265">sig</span><span class="op" id="3889268">)</span>&nbsp;<span class="op" id="3889270">&lt;</span>&nbsp;<span class="num" id="3889272">2</span>&nbsp;<span class="op" id="3889274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889279">return</span>&nbsp;<span class="ident" id="3889286">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3889309">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3889312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889315">sigLen</span>&nbsp;<span class="op" id="3889322">:=</span>&nbsp;<span class="builtintype" id="3889325">int</span><span class="op" id="3889328">(</span><span class="ident" id="3889329">sig</span><span class="op" id="3889332">[</span><span class="num" id="3889333">0</span><span class="op" id="3889334">]</span><span class="op" id="3889335">)</span><span class="op" id="3889336">&lt;&lt;</span><span class="num" id="3889338">8</span>&nbsp;<span class="op" id="3889340">|</span>&nbsp;<span class="builtintype" id="3889342">int</span><span class="op" id="3889345">(</span><span class="ident" id="3889346">sig</span><span class="op" id="3889349">[</span><span class="num" id="3889350">1</span><span class="op" id="3889351">]</span><span class="op" id="3889352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889355">if</span>&nbsp;<span class="ident" id="3889358">sigLen</span><span class="op" id="3889364">+</span><span class="num" id="3889365">2</span>&nbsp;<span class="op" id="3889367">!=</span>&nbsp;<span class="builtinfunc" id="3889370">len</span><span class="op" id="3889373">(</span><span class="ident" id="3889374">sig</span><span class="op" id="3889377">)</span>&nbsp;<span class="op" id="3889379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889383">return</span>&nbsp;<span class="ident" id="3889390">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3889412">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889415">sig</span>&nbsp;<span class="op" id="3889419">=</span>&nbsp;<span class="ident" id="3889421">sig</span><span class="op" id="3889424">[</span><span class="num" id="3889425">2</span><span class="op" id="3889426">:</span><span class="op" id="3889427">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889431">digest</span><span class="op" id="3889437">,</span>&nbsp;<span class="ident" id="3889439">hashFunc</span><span class="op" id="3889447">,</span>&nbsp;<span class="ident" id="3889449">err</span>&nbsp;<span class="op" id="3889453">:=</span>&nbsp;<span class="ident" id="3889456">hashForServerKeyExchange</span><span class="op" id="3889480">(</span><span class="ident" id="3889481">ka</span><span class="op" id="3889483">.</span><span class="ident" id="3889484">sigType</span><span class="op" id="3889491">,</span>&nbsp;<span class="ident" id="3889493">tls12HashId</span><span class="op" id="3889504">,</span>&nbsp;<span class="ident" id="3889506">ka</span><span class="op" id="3889508">.</span><span class="ident" id="3889509">version</span><span class="op" id="3889516">,</span>&nbsp;<span class="ident" id="3889518">clientHello</span><span class="op" id="3889529">.</span><span class="ident" id="3889530">random</span><span class="op" id="3889536">,</span>&nbsp;<span class="ident" id="3889538">serverHello</span><span class="op" id="3889549">.</span><span class="ident" id="3889550">random</span><span class="op" id="3889556">,</span>&nbsp;<span class="ident" id="3889558">serverECDHParams</span><span class="op" id="3889574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889577">if</span>&nbsp;<span class="ident" id="3889580">err</span>&nbsp;<span class="op" id="3889584">!=</span>&nbsp;<span class="ident" id="3889587">nil</span>&nbsp;<span class="op" id="3889591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889595">return</span>&nbsp;<span class="ident" id="3889602">err</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3889607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889610">switch</span>&nbsp;<span class="ident" id="3889617">ka</span><span class="op" id="3889619">.</span><span class="ident" id="3889620">sigType</span>&nbsp;<span class="op" id="3889628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889631">case</span>&nbsp;<span class="ident" id="3889636">signatureECDSA</span><span class="op" id="3889650">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889654">pubKey</span><span class="op" id="3889660">,</span>&nbsp;<span class="ident" id="3889662">ok</span>&nbsp;<span class="op" id="3889665">:=</span>&nbsp;<span class="ident" id="3889668">cert</span><span class="op" id="3889672">.</span><span class="ident" id="3889673">PublicKey</span><span class="op" id="3889682">.</span><span class="op" id="3889683">(</span><span class="op" id="3889684">*</span><span class="ident" id="3889685">ecdsa</span><span class="op" id="3889690">.</span><span class="ident" id="3889691">PublicKey</span><span class="op" id="3889700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889704">if</span>&nbsp;<span class="op" id="3889707">!</span><span class="ident" id="3889708">ok</span>&nbsp;<span class="op" id="3889711">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889716">return</span>&nbsp;<span class="ident" id="3889723">errors</span><span class="op" id="3889729">.</span><span class="ident" id="3889730">New</span><span class="op" id="3889733">(</span><span class="string" id="3889734">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;a&nbsp;ECDSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="3889782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3889786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889790">ecdsaSig</span>&nbsp;<span class="op" id="3889799">:=</span>&nbsp;<span class="builtinfunc" id="3889802">new</span><span class="op" id="3889805">(</span><span class="ident" id="3889806">ecdsaSignature</span><span class="op" id="3889820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889824">if</span>&nbsp;<span class="ident" id="3889827">_</span><span class="op" id="3889828">,</span>&nbsp;<span class="ident" id="3889830">err</span>&nbsp;<span class="op" id="3889834">:=</span>&nbsp;<span class="ident" id="3889837">asn1</span><span class="op" id="3889841">.</span><span class="ident" id="3889842">Unmarshal</span><span class="op" id="3889851">(</span><span class="ident" id="3889852">sig</span><span class="op" id="3889855">,</span>&nbsp;<span class="ident" id="3889857">ecdsaSig</span><span class="op" id="3889865">)</span><span class="op" id="3889866">;</span>&nbsp;<span class="ident" id="3889868">err</span>&nbsp;<span class="op" id="3889872">!=</span>&nbsp;<span class="ident" id="3889875">nil</span>&nbsp;<span class="op" id="3889879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889884">return</span>&nbsp;<span class="ident" id="3889891">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3889897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889901">if</span>&nbsp;<span class="ident" id="3889904">ecdsaSig</span><span class="op" id="3889912">.</span><span class="ident" id="3889913">R</span><span class="op" id="3889914">.</span><span class="ident" id="3889915">Sign</span><span class="op" id="3889919">(</span><span class="op" id="3889920">)</span>&nbsp;<span class="op" id="3889922">&lt;=</span>&nbsp;<span class="num" id="3889925">0</span>&nbsp;<span class="op" id="3889927">||</span>&nbsp;<span class="ident" id="3889930">ecdsaSig</span><span class="op" id="3889938">.</span><span class="ident" id="3889939">S</span><span class="op" id="3889940">.</span><span class="ident" id="3889941">Sign</span><span class="op" id="3889945">(</span><span class="op" id="3889946">)</span>&nbsp;<span class="op" id="3889948">&lt;=</span>&nbsp;<span class="num" id="3889951">0</span>&nbsp;<span class="op" id="3889953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889958">return</span>&nbsp;<span class="ident" id="3889965">errors</span><span class="op" id="3889971">.</span><span class="ident" id="3889972">New</span><span class="op" id="3889975">(</span><span class="string" id="3889976">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="3890027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3890031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890035">if</span>&nbsp;<span class="op" id="3890038">!</span><span class="ident" id="3890039">ecdsa</span><span class="op" id="3890044">.</span><span class="ident" id="3890045">Verify</span><span class="op" id="3890051">(</span><span class="ident" id="3890052">pubKey</span><span class="op" id="3890058">,</span>&nbsp;<span class="ident" id="3890060">digest</span><span class="op" id="3890066">,</span>&nbsp;<span class="ident" id="3890068">ecdsaSig</span><span class="op" id="3890076">.</span><span class="ident" id="3890077">R</span><span class="op" id="3890078">,</span>&nbsp;<span class="ident" id="3890080">ecdsaSig</span><span class="op" id="3890088">.</span><span class="ident" id="3890089">S</span><span class="op" id="3890090">)</span>&nbsp;<span class="op" id="3890092">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890097">return</span>&nbsp;<span class="ident" id="3890104">errors</span><span class="op" id="3890110">.</span><span class="ident" id="3890111">New</span><span class="op" id="3890114">(</span><span class="string" id="3890115">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="3890143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3890147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890150">case</span>&nbsp;<span class="ident" id="3890155">signatureRSA</span><span class="op" id="3890167">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3890171">pubKey</span><span class="op" id="3890177">,</span>&nbsp;<span class="ident" id="3890179">ok</span>&nbsp;<span class="op" id="3890182">:=</span>&nbsp;<span class="ident" id="3890185">cert</span><span class="op" id="3890189">.</span><span class="ident" id="3890190">PublicKey</span><span class="op" id="3890199">.</span><span class="op" id="3890200">(</span><span class="op" id="3890201">*</span><span class="ident" id="3890202">rsa</span><span class="op" id="3890205">.</span><span class="ident" id="3890206">PublicKey</span><span class="op" id="3890215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890219">if</span>&nbsp;<span class="op" id="3890222">!</span><span class="ident" id="3890223">ok</span>&nbsp;<span class="op" id="3890226">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890231">return</span>&nbsp;<span class="ident" id="3890238">errors</span><span class="op" id="3890244">.</span><span class="ident" id="3890245">New</span><span class="op" id="3890248">(</span><span class="string" id="3890249">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="3890293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3890297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890301">if</span>&nbsp;<span class="ident" id="3890304">err</span>&nbsp;<span class="op" id="3890308">:=</span>&nbsp;<span class="ident" id="3890311">rsa</span><span class="op" id="3890314">.</span><span class="ident" id="3890315">VerifyPKCS1v15</span><span class="op" id="3890329">(</span><span class="ident" id="3890330">pubKey</span><span class="op" id="3890336">,</span>&nbsp;<span class="ident" id="3890338">hashFunc</span><span class="op" id="3890346">,</span>&nbsp;<span class="ident" id="3890348">digest</span><span class="op" id="3890354">,</span>&nbsp;<span class="ident" id="3890356">sig</span><span class="op" id="3890359">)</span><span class="op" id="3890360">;</span>&nbsp;<span class="ident" id="3890362">err</span>&nbsp;<span class="op" id="3890366">!=</span>&nbsp;<span class="ident" id="3890369">nil</span>&nbsp;<span class="op" id="3890373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890378">return</span>&nbsp;<span class="ident" id="3890385">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3890391">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890394">default</span><span class="op" id="3890401">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890405">return</span>&nbsp;<span class="ident" id="3890412">errors</span><span class="op" id="3890418">.</span><span class="ident" id="3890419">New</span><span class="op" id="3890422">(</span><span class="string" id="3890423">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="3890458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3890461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890465">return</span>&nbsp;<span class="ident" id="3890472">nil</span><br>
<span class="lineno">390</span><span class="op" id="3890476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3890479">func</span>&nbsp;<span class="op" id="3890484">(</span><span class="ident" id="3890485">ka</span>&nbsp;<span class="op" id="3890488">*</span><span class="ident" id="3890489">ecdheKeyAgreement</span><span class="op" id="3890506">)</span>&nbsp;<span class="ident" id="3890508">generateClientKeyExchange</span><span class="op" id="3890533">(</span><span class="ident" id="3890534">config</span>&nbsp;<span class="op" id="3890541">*</span><span class="ident" id="3890542">Config</span><span class="op" id="3890548">,</span>&nbsp;<span class="ident" id="3890550">clientHello</span>&nbsp;<span class="op" id="3890562">*</span><span class="ident" id="3890563">clientHelloMsg</span><span class="op" id="3890577">,</span>&nbsp;<span class="ident" id="3890579">cert</span>&nbsp;<span class="op" id="3890584">*</span><span class="ident" id="3890585">x509</span><span class="op" id="3890589">.</span><span class="ident" id="3890590">Certificate</span><span class="op" id="3890601">)</span>&nbsp;<span class="op" id="3890603">(</span><span class="op" id="3890604">[</span><span class="op" id="3890605">]</span><span class="builtintype" id="3890606">byte</span><span class="op" id="3890610">,</span>&nbsp;<span class="op" id="3890612">*</span><span class="ident" id="3890613">clientKeyExchangeMsg</span><span class="op" id="3890633">,</span>&nbsp;<span class="builtintype" id="3890635">error</span><span class="op" id="3890640">)</span>&nbsp;<span class="op" id="3890642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890645">if</span>&nbsp;<span class="ident" id="3890648">ka</span><span class="op" id="3890650">.</span><span class="ident" id="3890651">curve</span>&nbsp;<span class="op" id="3890657">==</span>&nbsp;<span class="ident" id="3890660">nil</span>&nbsp;<span class="op" id="3890664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890668">return</span>&nbsp;<span class="ident" id="3890675">nil</span><span class="op" id="3890678">,</span>&nbsp;<span class="ident" id="3890680">nil</span><span class="op" id="3890683">,</span>&nbsp;<span class="ident" id="3890685">errors</span><span class="op" id="3890691">.</span><span class="ident" id="3890692">New</span><span class="op" id="3890695">(</span><span class="string" id="3890696">&#34;missing&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="3890731">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3890734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3890737">priv</span><span class="op" id="3890741">,</span>&nbsp;<span class="ident" id="3890743">mx</span><span class="op" id="3890745">,</span>&nbsp;<span class="ident" id="3890747">my</span><span class="op" id="3890749">,</span>&nbsp;<span class="ident" id="3890751">err</span>&nbsp;<span class="op" id="3890755">:=</span>&nbsp;<span class="ident" id="3890758">elliptic</span><span class="op" id="3890766">.</span><span class="ident" id="3890767">GenerateKey</span><span class="op" id="3890778">(</span><span class="ident" id="3890779">ka</span><span class="op" id="3890781">.</span><span class="ident" id="3890782">curve</span><span class="op" id="3890787">,</span>&nbsp;<span class="ident" id="3890789">config</span><span class="op" id="3890795">.</span><span class="ident" id="3890796">rand</span><span class="op" id="3890800">(</span><span class="op" id="3890801">)</span><span class="op" id="3890802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890805">if</span>&nbsp;<span class="ident" id="3890808">err</span>&nbsp;<span class="op" id="3890812">!=</span>&nbsp;<span class="ident" id="3890815">nil</span>&nbsp;<span class="op" id="3890819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890823">return</span>&nbsp;<span class="ident" id="3890830">nil</span><span class="op" id="3890833">,</span>&nbsp;<span class="ident" id="3890835">nil</span><span class="op" id="3890838">,</span>&nbsp;<span class="ident" id="3890840">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3890845">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3890848">x</span><span class="op" id="3890849">,</span>&nbsp;<span class="ident" id="3890851">_</span>&nbsp;<span class="op" id="3890853">:=</span>&nbsp;<span class="ident" id="3890856">ka</span><span class="op" id="3890858">.</span><span class="ident" id="3890859">curve</span><span class="op" id="3890864">.</span><span class="ident" id="3890865">ScalarMult</span><span class="op" id="3890875">(</span><span class="ident" id="3890876">ka</span><span class="op" id="3890878">.</span><span class="ident" id="3890879">x</span><span class="op" id="3890880">,</span>&nbsp;<span class="ident" id="3890882">ka</span><span class="op" id="3890884">.</span><span class="ident" id="3890885">y</span><span class="op" id="3890886">,</span>&nbsp;<span class="ident" id="3890888">priv</span><span class="op" id="3890892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3890895">preMasterSecret</span>&nbsp;<span class="op" id="3890911">:=</span>&nbsp;<span class="builtinfunc" id="3890914">make</span><span class="op" id="3890918">(</span><span class="op" id="3890919">[</span><span class="op" id="3890920">]</span><span class="builtintype" id="3890921">byte</span><span class="op" id="3890925">,</span>&nbsp;<span class="op" id="3890927">(</span><span class="ident" id="3890928">ka</span><span class="op" id="3890930">.</span><span class="ident" id="3890931">curve</span><span class="op" id="3890936">.</span><span class="ident" id="3890937">Params</span><span class="op" id="3890943">(</span><span class="op" id="3890944">)</span><span class="op" id="3890945">.</span><span class="ident" id="3890946">BitSize</span><span class="op" id="3890953">+</span><span class="num" id="3890954">7</span><span class="op" id="3890955">)</span><span class="op" id="3890956">&gt;&gt;</span><span class="num" id="3890958">3</span><span class="op" id="3890959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3890962">xBytes</span>&nbsp;<span class="op" id="3890969">:=</span>&nbsp;<span class="ident" id="3890972">x</span><span class="op" id="3890973">.</span><span class="ident" id="3890974">Bytes</span><span class="op" id="3890979">(</span><span class="op" id="3890980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3890983">copy</span><span class="op" id="3890987">(</span><span class="ident" id="3890988">preMasterSecret</span><span class="op" id="3891003">[</span><span class="builtinfunc" id="3891004">len</span><span class="op" id="3891007">(</span><span class="ident" id="3891008">preMasterSecret</span><span class="op" id="3891023">)</span><span class="op" id="3891024">-</span><span class="builtinfunc" id="3891025">len</span><span class="op" id="3891028">(</span><span class="ident" id="3891029">xBytes</span><span class="op" id="3891035">)</span><span class="op" id="3891036">:</span><span class="op" id="3891037">]</span><span class="op" id="3891038">,</span>&nbsp;<span class="ident" id="3891040">xBytes</span><span class="op" id="3891046">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3891050">serialized</span>&nbsp;<span class="op" id="3891061">:=</span>&nbsp;<span class="ident" id="3891064">elliptic</span><span class="op" id="3891072">.</span><span class="ident" id="3891073">Marshal</span><span class="op" id="3891080">(</span><span class="ident" id="3891081">ka</span><span class="op" id="3891083">.</span><span class="ident" id="3891084">curve</span><span class="op" id="3891089">,</span>&nbsp;<span class="ident" id="3891091">mx</span><span class="op" id="3891093">,</span>&nbsp;<span class="ident" id="3891095">my</span><span class="op" id="3891097">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3891101">ckx</span>&nbsp;<span class="op" id="3891105">:=</span>&nbsp;<span class="builtinfunc" id="3891108">new</span><span class="op" id="3891111">(</span><span class="ident" id="3891112">clientKeyExchangeMsg</span><span class="op" id="3891132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3891135">ckx</span><span class="op" id="3891138">.</span><span class="ident" id="3891139">ciphertext</span>&nbsp;<span class="op" id="3891150">=</span>&nbsp;<span class="builtinfunc" id="3891152">make</span><span class="op" id="3891156">(</span><span class="op" id="3891157">[</span><span class="op" id="3891158">]</span><span class="builtintype" id="3891159">byte</span><span class="op" id="3891163">,</span>&nbsp;<span class="num" id="3891165">1</span><span class="op" id="3891166">+</span><span class="builtinfunc" id="3891167">len</span><span class="op" id="3891170">(</span><span class="ident" id="3891171">serialized</span><span class="op" id="3891181">)</span><span class="op" id="3891182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3891185">ckx</span><span class="op" id="3891188">.</span><span class="ident" id="3891189">ciphertext</span><span class="op" id="3891199">[</span><span class="num" id="3891200">0</span><span class="op" id="3891201">]</span>&nbsp;<span class="op" id="3891203">=</span>&nbsp;<span class="builtintype" id="3891205">byte</span><span class="op" id="3891209">(</span><span class="builtinfunc" id="3891210">len</span><span class="op" id="3891213">(</span><span class="ident" id="3891214">serialized</span><span class="op" id="3891224">)</span><span class="op" id="3891225">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3891228">copy</span><span class="op" id="3891232">(</span><span class="ident" id="3891233">ckx</span><span class="op" id="3891236">.</span><span class="ident" id="3891237">ciphertext</span><span class="op" id="3891247">[</span><span class="num" id="3891248">1</span><span class="op" id="3891249">:</span><span class="op" id="3891250">]</span><span class="op" id="3891251">,</span>&nbsp;<span class="ident" id="3891253">serialized</span><span class="op" id="3891263">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3891267">return</span>&nbsp;<span class="ident" id="3891274">preMasterSecret</span><span class="op" id="3891289">,</span>&nbsp;<span class="ident" id="3891291">ckx</span><span class="op" id="3891294">,</span>&nbsp;<span class="ident" id="3891296">nil</span><br>
<span class="lineno"></span><span class="op" id="3891300">}</span>
</div>
</body>
</html>
