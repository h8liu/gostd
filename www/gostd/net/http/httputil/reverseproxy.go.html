<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5370714">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5370769">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5370823">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5370874">//&nbsp;HTTP&nbsp;reverse&nbsp;proxy&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5370905">package</span>&nbsp;<span class="ident" id="5370913">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5370923">import</span>&nbsp;<span class="op" id="5370930">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5370933">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5370939">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5370946">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5370953">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5370965">&#34;net/url&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5370976">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5370987">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5370995">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="5371002">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5371005">//&nbsp;onExitFlushLoop&nbsp;is&nbsp;a&nbsp;callback&nbsp;set&nbsp;by&nbsp;tests&nbsp;to&nbsp;detect&nbsp;the&nbsp;state&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5371078">//&nbsp;flushLoop()&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="5371104">var</span>&nbsp;<span class="ident" id="5371108">onExitFlushLoop</span>&nbsp;<span class="keyword" id="5371124">func</span><span class="op" id="5371128">(</span><span class="op" id="5371129">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5371132">//&nbsp;ReverseProxy&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;that&nbsp;takes&nbsp;an&nbsp;incoming&nbsp;request&nbsp;and</span><br>
<span class="lineno">25</span><span class="comment" id="5371202">//&nbsp;sends&nbsp;it&nbsp;to&nbsp;another&nbsp;server,&nbsp;proxying&nbsp;the&nbsp;response&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5371267">//&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="5371278">type</span>&nbsp;<span class="ident" id="5371283">ReverseProxy</span>&nbsp;<span class="keyword" id="5371296">struct</span>&nbsp;<span class="op" id="5371303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371306">//&nbsp;Director&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;which&nbsp;modifies</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371353">//&nbsp;the&nbsp;request&nbsp;into&nbsp;a&nbsp;new&nbsp;request&nbsp;to&nbsp;be&nbsp;sent</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371399">//&nbsp;using&nbsp;Transport.&nbsp;Its&nbsp;response&nbsp;is&nbsp;then&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371448">//&nbsp;back&nbsp;to&nbsp;the&nbsp;original&nbsp;client&nbsp;unmodified.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371492">Director</span>&nbsp;<span class="keyword" id="5371501">func</span><span class="op" id="5371505">(</span><span class="op" id="5371506">*</span><span class="ident" id="5371507">http</span><span class="op" id="5371511">.</span><span class="ident" id="5371512">Request</span><span class="op" id="5371519">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371523">//&nbsp;The&nbsp;transport&nbsp;used&nbsp;to&nbsp;perform&nbsp;proxy&nbsp;requests.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371573">//&nbsp;If&nbsp;nil,&nbsp;http.DefaultTransport&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371616">Transport</span>&nbsp;<span class="ident" id="5371626">http</span><span class="op" id="5371630">.</span><span class="ident" id="5371631">RoundTripper</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371646">//&nbsp;FlushInterval&nbsp;specifies&nbsp;the&nbsp;flush&nbsp;interval</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371693">//&nbsp;to&nbsp;flush&nbsp;to&nbsp;the&nbsp;client&nbsp;while&nbsp;copying&nbsp;the</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371738">//&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371757">//&nbsp;If&nbsp;zero,&nbsp;no&nbsp;periodic&nbsp;flushing&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371800">FlushInterval</span>&nbsp;<span class="ident" id="5371814">time</span><span class="op" id="5371818">.</span><span class="ident" id="5371819">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371830">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371883">//&nbsp;that&nbsp;occur&nbsp;when&nbsp;attempting&nbsp;to&nbsp;proxy&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371936">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371996">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372017">ErrorLog</span>&nbsp;<span class="op" id="5372026">*</span><span class="ident" id="5372027">log</span><span class="op" id="5372030">.</span><span class="ident" id="5372031">Logger</span><br>
<span class="lineno"></span><span class="op" id="5372038">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="5372041">func</span>&nbsp;<span class="ident" id="5372046">singleJoiningSlash</span><span class="op" id="5372064">(</span><span class="ident" id="5372065">a</span><span class="op" id="5372066">,</span>&nbsp;<span class="ident" id="5372068">b</span>&nbsp;<span class="builtintype" id="5372070">string</span><span class="op" id="5372076">)</span>&nbsp;<span class="builtintype" id="5372078">string</span>&nbsp;<span class="op" id="5372085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372088">aslash</span>&nbsp;<span class="op" id="5372095">:=</span>&nbsp;<span class="ident" id="5372098">strings</span><span class="op" id="5372105">.</span><span class="ident" id="5372106">HasSuffix</span><span class="op" id="5372115">(</span><span class="ident" id="5372116">a</span><span class="op" id="5372117">,</span>&nbsp;<span class="string" id="5372119">&#34;/&#34;</span><span class="op" id="5372122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372125">bslash</span>&nbsp;<span class="op" id="5372132">:=</span>&nbsp;<span class="ident" id="5372135">strings</span><span class="op" id="5372142">.</span><span class="ident" id="5372143">HasPrefix</span><span class="op" id="5372152">(</span><span class="ident" id="5372153">b</span><span class="op" id="5372154">,</span>&nbsp;<span class="string" id="5372156">&#34;/&#34;</span><span class="op" id="5372159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372162">switch</span>&nbsp;<span class="op" id="5372169">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372172">case</span>&nbsp;<span class="ident" id="5372177">aslash</span>&nbsp;<span class="op" id="5372184">&amp;&amp;</span>&nbsp;<span class="ident" id="5372187">bslash</span><span class="op" id="5372193">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372197">return</span>&nbsp;<span class="ident" id="5372204">a</span>&nbsp;<span class="op" id="5372206">+</span>&nbsp;<span class="ident" id="5372208">b</span><span class="op" id="5372209">[</span><span class="num" id="5372210">1</span><span class="op" id="5372211">:</span><span class="op" id="5372212">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372215">case</span>&nbsp;<span class="op" id="5372220">!</span><span class="ident" id="5372221">aslash</span>&nbsp;<span class="op" id="5372228">&amp;&amp;</span>&nbsp;<span class="op" id="5372231">!</span><span class="ident" id="5372232">bslash</span><span class="op" id="5372238">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372242">return</span>&nbsp;<span class="ident" id="5372249">a</span>&nbsp;<span class="op" id="5372251">+</span>&nbsp;<span class="string" id="5372253">&#34;/&#34;</span>&nbsp;<span class="op" id="5372257">+</span>&nbsp;<span class="ident" id="5372259">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372262">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372265">return</span>&nbsp;<span class="ident" id="5372272">a</span>&nbsp;<span class="op" id="5372274">+</span>&nbsp;<span class="ident" id="5372276">b</span><br>
<span class="lineno"></span><span class="op" id="5372278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5372281">//&nbsp;NewSingleHostReverseProxy&nbsp;returns&nbsp;a&nbsp;new&nbsp;ReverseProxy&nbsp;that&nbsp;rewrites</span><br>
<span class="lineno"></span><span class="comment" id="5372351">//&nbsp;URLs&nbsp;to&nbsp;the&nbsp;scheme,&nbsp;host,&nbsp;and&nbsp;base&nbsp;path&nbsp;provided&nbsp;in&nbsp;target.&nbsp;If&nbsp;the</span><br>
<span class="lineno">65</span><span class="comment" id="5372421">//&nbsp;target&#39;s&nbsp;path&nbsp;is&nbsp;&#34;/base&#34;&nbsp;and&nbsp;the&nbsp;incoming&nbsp;request&nbsp;was&nbsp;for&nbsp;&#34;/dir&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="5372490">//&nbsp;the&nbsp;target&nbsp;request&nbsp;will&nbsp;be&nbsp;for&nbsp;/base/dir.</span><br>
<span class="lineno"></span><span class="keyword" id="5372535">func</span>&nbsp;<span class="ident" id="5372540">NewSingleHostReverseProxy</span><span class="op" id="5372565">(</span><span class="ident" id="5372566">target</span>&nbsp;<span class="op" id="5372573">*</span><span class="ident" id="5372574">url</span><span class="op" id="5372577">.</span><span class="ident" id="5372578">URL</span><span class="op" id="5372581">)</span>&nbsp;<span class="op" id="5372583">*</span><span class="ident" id="5372584">ReverseProxy</span>&nbsp;<span class="op" id="5372597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372600">targetQuery</span>&nbsp;<span class="op" id="5372612">:=</span>&nbsp;<span class="ident" id="5372615">target</span><span class="op" id="5372621">.</span><span class="ident" id="5372622">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372632">director</span>&nbsp;<span class="op" id="5372641">:=</span>&nbsp;<span class="keyword" id="5372644">func</span><span class="op" id="5372648">(</span><span class="ident" id="5372649">req</span>&nbsp;<span class="op" id="5372653">*</span><span class="ident" id="5372654">http</span><span class="op" id="5372658">.</span><span class="ident" id="5372659">Request</span><span class="op" id="5372666">)</span>&nbsp;<span class="op" id="5372668">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372672">req</span><span class="op" id="5372675">.</span><span class="ident" id="5372676">URL</span><span class="op" id="5372679">.</span><span class="ident" id="5372680">Scheme</span>&nbsp;<span class="op" id="5372687">=</span>&nbsp;<span class="ident" id="5372689">target</span><span class="op" id="5372695">.</span><span class="ident" id="5372696">Scheme</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372705">req</span><span class="op" id="5372708">.</span><span class="ident" id="5372709">URL</span><span class="op" id="5372712">.</span><span class="ident" id="5372713">Host</span>&nbsp;<span class="op" id="5372718">=</span>&nbsp;<span class="ident" id="5372720">target</span><span class="op" id="5372726">.</span><span class="ident" id="5372727">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372734">req</span><span class="op" id="5372737">.</span><span class="ident" id="5372738">URL</span><span class="op" id="5372741">.</span><span class="ident" id="5372742">Path</span>&nbsp;<span class="op" id="5372747">=</span>&nbsp;<span class="ident" id="5372749">singleJoiningSlash</span><span class="op" id="5372767">(</span><span class="ident" id="5372768">target</span><span class="op" id="5372774">.</span><span class="ident" id="5372775">Path</span><span class="op" id="5372779">,</span>&nbsp;<span class="ident" id="5372781">req</span><span class="op" id="5372784">.</span><span class="ident" id="5372785">URL</span><span class="op" id="5372788">.</span><span class="ident" id="5372789">Path</span><span class="op" id="5372793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372797">if</span>&nbsp;<span class="ident" id="5372800">targetQuery</span>&nbsp;<span class="op" id="5372812">==</span>&nbsp;<span class="string" id="5372815">&#34;&#34;</span>&nbsp;<span class="op" id="5372818">||</span>&nbsp;<span class="ident" id="5372821">req</span><span class="op" id="5372824">.</span><span class="ident" id="5372825">URL</span><span class="op" id="5372828">.</span><span class="ident" id="5372829">RawQuery</span>&nbsp;<span class="op" id="5372838">==</span>&nbsp;<span class="string" id="5372841">&#34;&#34;</span>&nbsp;<span class="op" id="5372844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372849">req</span><span class="op" id="5372852">.</span><span class="ident" id="5372853">URL</span><span class="op" id="5372856">.</span><span class="ident" id="5372857">RawQuery</span>&nbsp;<span class="op" id="5372866">=</span>&nbsp;<span class="ident" id="5372868">targetQuery</span>&nbsp;<span class="op" id="5372880">+</span>&nbsp;<span class="ident" id="5372882">req</span><span class="op" id="5372885">.</span><span class="ident" id="5372886">URL</span><span class="op" id="5372889">.</span><span class="ident" id="5372890">RawQuery</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372901">}</span>&nbsp;<span class="keyword" id="5372903">else</span>&nbsp;<span class="op" id="5372908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372913">req</span><span class="op" id="5372916">.</span><span class="ident" id="5372917">URL</span><span class="op" id="5372920">.</span><span class="ident" id="5372921">RawQuery</span>&nbsp;<span class="op" id="5372930">=</span>&nbsp;<span class="ident" id="5372932">targetQuery</span>&nbsp;<span class="op" id="5372944">+</span>&nbsp;<span class="string" id="5372946">&#34;&amp;&#34;</span>&nbsp;<span class="op" id="5372950">+</span>&nbsp;<span class="ident" id="5372952">req</span><span class="op" id="5372955">.</span><span class="ident" id="5372956">URL</span><span class="op" id="5372959">.</span><span class="ident" id="5372960">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372977">return</span>&nbsp;<span class="op" id="5372984">&amp;</span><span class="ident" id="5372985">ReverseProxy</span><span class="op" id="5372997">{</span><span class="ident" id="5372998">Director</span><span class="op" id="5373006">:</span>&nbsp;<span class="ident" id="5373008">director</span><span class="op" id="5373016">}</span><br>
<span class="lineno">80</span><span class="op" id="5373018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5373021">func</span>&nbsp;<span class="ident" id="5373026">copyHeader</span><span class="op" id="5373036">(</span><span class="ident" id="5373037">dst</span><span class="op" id="5373040">,</span>&nbsp;<span class="ident" id="5373042">src</span>&nbsp;<span class="ident" id="5373046">http</span><span class="op" id="5373050">.</span><span class="ident" id="5373051">Header</span><span class="op" id="5373057">)</span>&nbsp;<span class="op" id="5373059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5373062">for</span>&nbsp;<span class="ident" id="5373066">k</span><span class="op" id="5373067">,</span>&nbsp;<span class="ident" id="5373069">vv</span>&nbsp;<span class="op" id="5373072">:=</span>&nbsp;<span class="keyword" id="5373075">range</span>&nbsp;<span class="ident" id="5373081">src</span>&nbsp;<span class="op" id="5373085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5373089">for</span>&nbsp;<span class="ident" id="5373093">_</span><span class="op" id="5373094">,</span>&nbsp;<span class="ident" id="5373096">v</span>&nbsp;<span class="op" id="5373098">:=</span>&nbsp;<span class="keyword" id="5373101">range</span>&nbsp;<span class="ident" id="5373107">vv</span>&nbsp;<span class="op" id="5373110">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373115">dst</span><span class="op" id="5373118">.</span><span class="ident" id="5373119">Add</span><span class="op" id="5373122">(</span><span class="ident" id="5373123">k</span><span class="op" id="5373124">,</span>&nbsp;<span class="ident" id="5373126">v</span><span class="op" id="5373127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5373131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5373134">}</span><br>
<span class="lineno"></span><span class="op" id="5373136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="5373139">//&nbsp;Hop-by-hop&nbsp;headers.&nbsp;These&nbsp;are&nbsp;removed&nbsp;when&nbsp;sent&nbsp;to&nbsp;the&nbsp;backend.</span><br>
<span class="lineno"></span><span class="comment" id="5373206">//&nbsp;http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html</span><br>
<span class="lineno"></span><span class="keyword" id="5373264">var</span>&nbsp;<span class="ident" id="5373268">hopHeaders</span>&nbsp;<span class="op" id="5373279">=</span>&nbsp;<span class="op" id="5373281">[</span><span class="op" id="5373282">]</span><span class="builtintype" id="5373283">string</span><span class="op" id="5373289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5373292">&#34;Connection&#34;</span><span class="op" id="5373304">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5373307">&#34;Keep-Alive&#34;</span><span class="op" id="5373319">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5373322">&#34;Proxy-Authenticate&#34;</span><span class="op" id="5373342">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5373345">&#34;Proxy-Authorization&#34;</span><span class="op" id="5373366">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5373369">&#34;Te&#34;</span><span class="op" id="5373373">,</span>&nbsp;<span class="comment" id="5373375">//&nbsp;canonicalized&nbsp;version&nbsp;of&nbsp;&#34;TE&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5373409">&#34;Trailers&#34;</span><span class="op" id="5373419">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5373422">&#34;Transfer-Encoding&#34;</span><span class="op" id="5373441">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5373444">&#34;Upgrade&#34;</span><span class="op" id="5373453">,</span><br>
<span class="lineno"></span><span class="op" id="5373455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5373458">func</span>&nbsp;<span class="op" id="5373463">(</span><span class="ident" id="5373464">p</span>&nbsp;<span class="op" id="5373466">*</span><span class="ident" id="5373467">ReverseProxy</span><span class="op" id="5373479">)</span>&nbsp;<span class="ident" id="5373481">ServeHTTP</span><span class="op" id="5373490">(</span><span class="ident" id="5373491">rw</span>&nbsp;<span class="ident" id="5373494">http</span><span class="op" id="5373498">.</span><span class="ident" id="5373499">ResponseWriter</span><span class="op" id="5373513">,</span>&nbsp;<span class="ident" id="5373515">req</span>&nbsp;<span class="op" id="5373519">*</span><span class="ident" id="5373520">http</span><span class="op" id="5373524">.</span><span class="ident" id="5373525">Request</span><span class="op" id="5373532">)</span>&nbsp;<span class="op" id="5373534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373537">transport</span>&nbsp;<span class="op" id="5373547">:=</span>&nbsp;<span class="ident" id="5373550">p</span><span class="op" id="5373551">.</span><span class="ident" id="5373552">Transport</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5373563">if</span>&nbsp;<span class="ident" id="5373566">transport</span>&nbsp;<span class="op" id="5373576">==</span>&nbsp;<span class="ident" id="5373579">nil</span>&nbsp;<span class="op" id="5373583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373587">transport</span>&nbsp;<span class="op" id="5373597">=</span>&nbsp;<span class="ident" id="5373599">http</span><span class="op" id="5373603">.</span><span class="ident" id="5373604">DefaultTransport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5373622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373626">outreq</span>&nbsp;<span class="op" id="5373633">:=</span>&nbsp;<span class="builtinfunc" id="5373636">new</span><span class="op" id="5373639">(</span><span class="ident" id="5373640">http</span><span class="op" id="5373644">.</span><span class="ident" id="5373645">Request</span><span class="op" id="5373652">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5373655">*</span><span class="ident" id="5373656">outreq</span>&nbsp;<span class="op" id="5373663">=</span>&nbsp;<span class="op" id="5373665">*</span><span class="ident" id="5373666">req</span>&nbsp;<span class="comment" id="5373670">//&nbsp;includes&nbsp;shallow&nbsp;copies&nbsp;of&nbsp;maps,&nbsp;but&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373717">p</span><span class="op" id="5373718">.</span><span class="ident" id="5373719">Director</span><span class="op" id="5373727">(</span><span class="ident" id="5373728">outreq</span><span class="op" id="5373734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373737">outreq</span><span class="op" id="5373743">.</span><span class="ident" id="5373744">Proto</span>&nbsp;<span class="op" id="5373750">=</span>&nbsp;<span class="string" id="5373752">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373764">outreq</span><span class="op" id="5373770">.</span><span class="ident" id="5373771">ProtoMajor</span>&nbsp;<span class="op" id="5373782">=</span>&nbsp;<span class="num" id="5373784">1</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373787">outreq</span><span class="op" id="5373793">.</span><span class="ident" id="5373794">ProtoMinor</span>&nbsp;<span class="op" id="5373805">=</span>&nbsp;<span class="num" id="5373807">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373810">outreq</span><span class="op" id="5373816">.</span><span class="ident" id="5373817">Close</span>&nbsp;<span class="op" id="5373823">=</span>&nbsp;<span class="builtintype" id="5373825">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5373833">//&nbsp;Remove&nbsp;hop-by-hop&nbsp;headers&nbsp;to&nbsp;the&nbsp;backend.&nbsp;&nbsp;Especially</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5373891">//&nbsp;important&nbsp;is&nbsp;&#34;Connection&#34;&nbsp;because&nbsp;we&nbsp;want&nbsp;a&nbsp;persistent</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5373950">//&nbsp;connection,&nbsp;regardless&nbsp;of&nbsp;what&nbsp;the&nbsp;client&nbsp;sent&nbsp;to&nbsp;us.&nbsp;&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5374014">//&nbsp;is&nbsp;modifying&nbsp;the&nbsp;same&nbsp;underlying&nbsp;map&nbsp;from&nbsp;req&nbsp;(shallow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5374073">//&nbsp;copied&nbsp;above)&nbsp;so&nbsp;we&nbsp;only&nbsp;copy&nbsp;it&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374124">copiedHeaders</span>&nbsp;<span class="op" id="5374138">:=</span>&nbsp;<span class="builtintype" id="5374141">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374148">for</span>&nbsp;<span class="ident" id="5374152">_</span><span class="op" id="5374153">,</span>&nbsp;<span class="ident" id="5374155">h</span>&nbsp;<span class="op" id="5374157">:=</span>&nbsp;<span class="keyword" id="5374160">range</span>&nbsp;<span class="ident" id="5374166">hopHeaders</span>&nbsp;<span class="op" id="5374177">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374181">if</span>&nbsp;<span class="ident" id="5374184">outreq</span><span class="op" id="5374190">.</span><span class="ident" id="5374191">Header</span><span class="op" id="5374197">.</span><span class="ident" id="5374198">Get</span><span class="op" id="5374201">(</span><span class="ident" id="5374202">h</span><span class="op" id="5374203">)</span>&nbsp;<span class="op" id="5374205">!=</span>&nbsp;<span class="string" id="5374208">&#34;&#34;</span>&nbsp;<span class="op" id="5374211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374216">if</span>&nbsp;<span class="op" id="5374219">!</span><span class="ident" id="5374220">copiedHeaders</span>&nbsp;<span class="op" id="5374234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374240">outreq</span><span class="op" id="5374246">.</span><span class="ident" id="5374247">Header</span>&nbsp;<span class="op" id="5374254">=</span>&nbsp;<span class="builtinfunc" id="5374256">make</span><span class="op" id="5374260">(</span><span class="ident" id="5374261">http</span><span class="op" id="5374265">.</span><span class="ident" id="5374266">Header</span><span class="op" id="5374272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374278">copyHeader</span><span class="op" id="5374288">(</span><span class="ident" id="5374289">outreq</span><span class="op" id="5374295">.</span><span class="ident" id="5374296">Header</span><span class="op" id="5374302">,</span>&nbsp;<span class="ident" id="5374304">req</span><span class="op" id="5374307">.</span><span class="ident" id="5374308">Header</span><span class="op" id="5374314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374320">copiedHeaders</span>&nbsp;<span class="op" id="5374334">=</span>&nbsp;<span class="builtintype" id="5374336">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5374344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374349">outreq</span><span class="op" id="5374355">.</span><span class="ident" id="5374356">Header</span><span class="op" id="5374362">.</span><span class="ident" id="5374363">Del</span><span class="op" id="5374366">(</span><span class="ident" id="5374367">h</span><span class="op" id="5374368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5374372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5374375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374379">if</span>&nbsp;<span class="ident" id="5374382">clientIP</span><span class="op" id="5374390">,</span>&nbsp;<span class="ident" id="5374392">_</span><span class="op" id="5374393">,</span>&nbsp;<span class="ident" id="5374395">err</span>&nbsp;<span class="op" id="5374399">:=</span>&nbsp;<span class="ident" id="5374402">net</span><span class="op" id="5374405">.</span><span class="ident" id="5374406">SplitHostPort</span><span class="op" id="5374419">(</span><span class="ident" id="5374420">req</span><span class="op" id="5374423">.</span><span class="ident" id="5374424">RemoteAddr</span><span class="op" id="5374434">)</span><span class="op" id="5374435">;</span>&nbsp;<span class="ident" id="5374437">err</span>&nbsp;<span class="op" id="5374441">==</span>&nbsp;<span class="ident" id="5374444">nil</span>&nbsp;<span class="op" id="5374448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5374452">//&nbsp;If&nbsp;we&nbsp;aren&#39;t&nbsp;the&nbsp;first&nbsp;proxy&nbsp;retain&nbsp;prior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5374499">//&nbsp;X-Forwarded-For&nbsp;information&nbsp;as&nbsp;a&nbsp;comma+space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5374549">//&nbsp;separated&nbsp;list&nbsp;and&nbsp;fold&nbsp;multiple&nbsp;headers&nbsp;into&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374605">if</span>&nbsp;<span class="ident" id="5374608">prior</span><span class="op" id="5374613">,</span>&nbsp;<span class="ident" id="5374615">ok</span>&nbsp;<span class="op" id="5374618">:=</span>&nbsp;<span class="ident" id="5374621">outreq</span><span class="op" id="5374627">.</span><span class="ident" id="5374628">Header</span><span class="op" id="5374634">[</span><span class="string" id="5374635">&#34;X-Forwarded-For&#34;</span><span class="op" id="5374652">]</span><span class="op" id="5374653">;</span>&nbsp;<span class="ident" id="5374655">ok</span>&nbsp;<span class="op" id="5374658">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374663">clientIP</span>&nbsp;<span class="op" id="5374672">=</span>&nbsp;<span class="ident" id="5374674">strings</span><span class="op" id="5374681">.</span><span class="ident" id="5374682">Join</span><span class="op" id="5374686">(</span><span class="ident" id="5374687">prior</span><span class="op" id="5374692">,</span>&nbsp;<span class="string" id="5374694">&#34;,&nbsp;&#34;</span><span class="op" id="5374698">)</span>&nbsp;<span class="op" id="5374700">+</span>&nbsp;<span class="string" id="5374702">&#34;,&nbsp;&#34;</span>&nbsp;<span class="op" id="5374707">+</span>&nbsp;<span class="ident" id="5374709">clientIP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5374720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374724">outreq</span><span class="op" id="5374730">.</span><span class="ident" id="5374731">Header</span><span class="op" id="5374737">.</span><span class="ident" id="5374738">Set</span><span class="op" id="5374741">(</span><span class="string" id="5374742">&#34;X-Forwarded-For&#34;</span><span class="op" id="5374759">,</span>&nbsp;<span class="ident" id="5374761">clientIP</span><span class="op" id="5374769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5374772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374776">res</span><span class="op" id="5374779">,</span>&nbsp;<span class="ident" id="5374781">err</span>&nbsp;<span class="op" id="5374785">:=</span>&nbsp;<span class="ident" id="5374788">transport</span><span class="op" id="5374797">.</span><span class="ident" id="5374798">RoundTrip</span><span class="op" id="5374807">(</span><span class="ident" id="5374808">outreq</span><span class="op" id="5374814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374817">if</span>&nbsp;<span class="ident" id="5374820">err</span>&nbsp;<span class="op" id="5374824">!=</span>&nbsp;<span class="ident" id="5374827">nil</span>&nbsp;<span class="op" id="5374831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374835">p</span><span class="op" id="5374836">.</span><span class="ident" id="5374837">logf</span><span class="op" id="5374841">(</span><span class="string" id="5374842">&#34;http:&nbsp;proxy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="5374865">,</span>&nbsp;<span class="ident" id="5374867">err</span><span class="op" id="5374870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374874">rw</span><span class="op" id="5374876">.</span><span class="ident" id="5374877">WriteHeader</span><span class="op" id="5374888">(</span><span class="ident" id="5374889">http</span><span class="op" id="5374893">.</span><span class="ident" id="5374894">StatusInternalServerError</span><span class="op" id="5374919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374923">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5374931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374934">defer</span>&nbsp;<span class="ident" id="5374940">res</span><span class="op" id="5374943">.</span><span class="ident" id="5374944">Body</span><span class="op" id="5374948">.</span><span class="ident" id="5374949">Close</span><span class="op" id="5374954">(</span><span class="op" id="5374955">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374959">for</span>&nbsp;<span class="ident" id="5374963">_</span><span class="op" id="5374964">,</span>&nbsp;<span class="ident" id="5374966">h</span>&nbsp;<span class="op" id="5374968">:=</span>&nbsp;<span class="keyword" id="5374971">range</span>&nbsp;<span class="ident" id="5374977">hopHeaders</span>&nbsp;<span class="op" id="5374988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374992">res</span><span class="op" id="5374995">.</span><span class="ident" id="5374996">Header</span><span class="op" id="5375002">.</span><span class="ident" id="5375003">Del</span><span class="op" id="5375006">(</span><span class="ident" id="5375007">h</span><span class="op" id="5375008">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375015">copyHeader</span><span class="op" id="5375025">(</span><span class="ident" id="5375026">rw</span><span class="op" id="5375028">.</span><span class="ident" id="5375029">Header</span><span class="op" id="5375035">(</span><span class="op" id="5375036">)</span><span class="op" id="5375037">,</span>&nbsp;<span class="ident" id="5375039">res</span><span class="op" id="5375042">.</span><span class="ident" id="5375043">Header</span><span class="op" id="5375049">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375053">rw</span><span class="op" id="5375055">.</span><span class="ident" id="5375056">WriteHeader</span><span class="op" id="5375067">(</span><span class="ident" id="5375068">res</span><span class="op" id="5375071">.</span><span class="ident" id="5375072">StatusCode</span><span class="op" id="5375082">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375085">p</span><span class="op" id="5375086">.</span><span class="ident" id="5375087">copyResponse</span><span class="op" id="5375099">(</span><span class="ident" id="5375100">rw</span><span class="op" id="5375102">,</span>&nbsp;<span class="ident" id="5375104">res</span><span class="op" id="5375107">.</span><span class="ident" id="5375108">Body</span><span class="op" id="5375112">)</span><br>
<span class="lineno"></span><span class="op" id="5375114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5375117">func</span>&nbsp;<span class="op" id="5375122">(</span><span class="ident" id="5375123">p</span>&nbsp;<span class="op" id="5375125">*</span><span class="ident" id="5375126">ReverseProxy</span><span class="op" id="5375138">)</span>&nbsp;<span class="ident" id="5375140">copyResponse</span><span class="op" id="5375152">(</span><span class="ident" id="5375153">dst</span>&nbsp;<span class="ident" id="5375157">io</span><span class="op" id="5375159">.</span><span class="ident" id="5375160">Writer</span><span class="op" id="5375166">,</span>&nbsp;<span class="ident" id="5375168">src</span>&nbsp;<span class="ident" id="5375172">io</span><span class="op" id="5375174">.</span><span class="ident" id="5375175">Reader</span><span class="op" id="5375181">)</span>&nbsp;<span class="op" id="5375183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375186">if</span>&nbsp;<span class="ident" id="5375189">p</span><span class="op" id="5375190">.</span><span class="ident" id="5375191">FlushInterval</span>&nbsp;<span class="op" id="5375205">!=</span>&nbsp;<span class="num" id="5375208">0</span>&nbsp;<span class="op" id="5375210">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375214">if</span>&nbsp;<span class="ident" id="5375217">wf</span><span class="op" id="5375219">,</span>&nbsp;<span class="ident" id="5375221">ok</span>&nbsp;<span class="op" id="5375224">:=</span>&nbsp;<span class="ident" id="5375227">dst</span><span class="op" id="5375230">.</span><span class="op" id="5375231">(</span><span class="ident" id="5375232">writeFlusher</span><span class="op" id="5375244">)</span><span class="op" id="5375245">;</span>&nbsp;<span class="ident" id="5375247">ok</span>&nbsp;<span class="op" id="5375250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375255">mlw</span>&nbsp;<span class="op" id="5375259">:=</span>&nbsp;<span class="op" id="5375262">&amp;</span><span class="ident" id="5375263">maxLatencyWriter</span><span class="op" id="5375279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375285">dst</span><span class="op" id="5375288">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5375294">wf</span><span class="op" id="5375296">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375302">latency</span><span class="op" id="5375309">:</span>&nbsp;<span class="ident" id="5375311">p</span><span class="op" id="5375312">.</span><span class="ident" id="5375313">FlushInterval</span><span class="op" id="5375326">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375332">done</span><span class="op" id="5375336">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5375341">make</span><span class="op" id="5375345">(</span><span class="keyword" id="5375346">chan</span>&nbsp;<span class="builtintype" id="5375351">bool</span><span class="op" id="5375355">)</span><span class="op" id="5375356">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375366">go</span>&nbsp;<span class="ident" id="5375369">mlw</span><span class="op" id="5375372">.</span><span class="ident" id="5375373">flushLoop</span><span class="op" id="5375382">(</span><span class="op" id="5375383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375388">defer</span>&nbsp;<span class="ident" id="5375394">mlw</span><span class="op" id="5375397">.</span><span class="ident" id="5375398">stop</span><span class="op" id="5375402">(</span><span class="op" id="5375403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375408">dst</span>&nbsp;<span class="op" id="5375412">=</span>&nbsp;<span class="ident" id="5375414">mlw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375420">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375427">io</span><span class="op" id="5375429">.</span><span class="ident" id="5375430">Copy</span><span class="op" id="5375434">(</span><span class="ident" id="5375435">dst</span><span class="op" id="5375438">,</span>&nbsp;<span class="ident" id="5375440">src</span><span class="op" id="5375443">)</span><br>
<span class="lineno"></span><span class="op" id="5375445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="5375448">func</span>&nbsp;<span class="op" id="5375453">(</span><span class="ident" id="5375454">p</span>&nbsp;<span class="op" id="5375456">*</span><span class="ident" id="5375457">ReverseProxy</span><span class="op" id="5375469">)</span>&nbsp;<span class="ident" id="5375471">logf</span><span class="op" id="5375475">(</span><span class="ident" id="5375476">format</span>&nbsp;<span class="builtintype" id="5375483">string</span><span class="op" id="5375489">,</span>&nbsp;<span class="ident" id="5375491">args</span>&nbsp;<span class="op" id="5375496">...</span><span class="keyword" id="5375499">interface</span><span class="op" id="5375508">{</span><span class="op" id="5375509">}</span><span class="op" id="5375510">)</span>&nbsp;<span class="op" id="5375512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375515">if</span>&nbsp;<span class="ident" id="5375518">p</span><span class="op" id="5375519">.</span><span class="ident" id="5375520">ErrorLog</span>&nbsp;<span class="op" id="5375529">!=</span>&nbsp;<span class="ident" id="5375532">nil</span>&nbsp;<span class="op" id="5375536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375540">p</span><span class="op" id="5375541">.</span><span class="ident" id="5375542">ErrorLog</span><span class="op" id="5375550">.</span><span class="ident" id="5375551">Printf</span><span class="op" id="5375557">(</span><span class="ident" id="5375558">format</span><span class="op" id="5375564">,</span>&nbsp;<span class="ident" id="5375566">args</span><span class="op" id="5375570">...</span><span class="op" id="5375573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375576">}</span>&nbsp;<span class="keyword" id="5375578">else</span>&nbsp;<span class="op" id="5375583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375587">log</span><span class="op" id="5375590">.</span><span class="ident" id="5375591">Printf</span><span class="op" id="5375597">(</span><span class="ident" id="5375598">format</span><span class="op" id="5375604">,</span>&nbsp;<span class="ident" id="5375606">args</span><span class="op" id="5375610">...</span><span class="op" id="5375613">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375616">}</span><br>
<span class="lineno"></span><span class="op" id="5375618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5375621">type</span>&nbsp;<span class="ident" id="5375626">writeFlusher</span>&nbsp;<span class="keyword" id="5375639">interface</span>&nbsp;<span class="op" id="5375649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375652">io</span><span class="op" id="5375654">.</span><span class="ident" id="5375655">Writer</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375663">http</span><span class="op" id="5375667">.</span><span class="ident" id="5375668">Flusher</span><br>
<span class="lineno"></span><span class="op" id="5375676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5375679">type</span>&nbsp;<span class="ident" id="5375684">maxLatencyWriter</span>&nbsp;<span class="keyword" id="5375701">struct</span>&nbsp;<span class="op" id="5375708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375711">dst</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5375719">writeFlusher</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375733">latency</span>&nbsp;<span class="ident" id="5375741">time</span><span class="op" id="5375745">.</span><span class="ident" id="5375746">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375757">lk</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5375762">sync</span><span class="op" id="5375766">.</span><span class="ident" id="5375767">Mutex</span>&nbsp;<span class="comment" id="5375773">//&nbsp;protects&nbsp;Write&nbsp;+&nbsp;Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375800">done</span>&nbsp;<span class="keyword" id="5375805">chan</span>&nbsp;<span class="builtintype" id="5375810">bool</span><br>
<span class="lineno"></span><span class="op" id="5375815">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="5375818">func</span>&nbsp;<span class="op" id="5375823">(</span><span class="ident" id="5375824">m</span>&nbsp;<span class="op" id="5375826">*</span><span class="ident" id="5375827">maxLatencyWriter</span><span class="op" id="5375843">)</span>&nbsp;<span class="ident" id="5375845">Write</span><span class="op" id="5375850">(</span><span class="ident" id="5375851">p</span>&nbsp;<span class="op" id="5375853">[</span><span class="op" id="5375854">]</span><span class="builtintype" id="5375855">byte</span><span class="op" id="5375859">)</span>&nbsp;<span class="op" id="5375861">(</span><span class="builtintype" id="5375862">int</span><span class="op" id="5375865">,</span>&nbsp;<span class="builtintype" id="5375867">error</span><span class="op" id="5375872">)</span>&nbsp;<span class="op" id="5375874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375877">m</span><span class="op" id="5375878">.</span><span class="ident" id="5375879">lk</span><span class="op" id="5375881">.</span><span class="ident" id="5375882">Lock</span><span class="op" id="5375886">(</span><span class="op" id="5375887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375890">defer</span>&nbsp;<span class="ident" id="5375896">m</span><span class="op" id="5375897">.</span><span class="ident" id="5375898">lk</span><span class="op" id="5375900">.</span><span class="ident" id="5375901">Unlock</span><span class="op" id="5375907">(</span><span class="op" id="5375908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375911">return</span>&nbsp;<span class="ident" id="5375918">m</span><span class="op" id="5375919">.</span><span class="ident" id="5375920">dst</span><span class="op" id="5375923">.</span><span class="ident" id="5375924">Write</span><span class="op" id="5375929">(</span><span class="ident" id="5375930">p</span><span class="op" id="5375931">)</span><br>
<span class="lineno">205</span><span class="op" id="5375933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5375936">func</span>&nbsp;<span class="op" id="5375941">(</span><span class="ident" id="5375942">m</span>&nbsp;<span class="op" id="5375944">*</span><span class="ident" id="5375945">maxLatencyWriter</span><span class="op" id="5375961">)</span>&nbsp;<span class="ident" id="5375963">flushLoop</span><span class="op" id="5375972">(</span><span class="op" id="5375973">)</span>&nbsp;<span class="op" id="5375975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375978">t</span>&nbsp;<span class="op" id="5375980">:=</span>&nbsp;<span class="ident" id="5375983">time</span><span class="op" id="5375987">.</span><span class="ident" id="5375988">NewTicker</span><span class="op" id="5375997">(</span><span class="ident" id="5375998">m</span><span class="op" id="5375999">.</span><span class="ident" id="5376000">latency</span><span class="op" id="5376007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376010">defer</span>&nbsp;<span class="ident" id="5376016">t</span><span class="op" id="5376017">.</span><span class="ident" id="5376018">Stop</span><span class="op" id="5376022">(</span><span class="op" id="5376023">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376026">for</span>&nbsp;<span class="op" id="5376030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376034">select</span>&nbsp;<span class="op" id="5376041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376045">case</span>&nbsp;<span class="op" id="5376050">&lt;-</span><span class="ident" id="5376052">m</span><span class="op" id="5376053">.</span><span class="ident" id="5376054">done</span><span class="op" id="5376058">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376063">if</span>&nbsp;<span class="ident" id="5376066">onExitFlushLoop</span>&nbsp;<span class="op" id="5376082">!=</span>&nbsp;<span class="ident" id="5376085">nil</span>&nbsp;<span class="op" id="5376089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376095">onExitFlushLoop</span><span class="op" id="5376110">(</span><span class="op" id="5376111">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5376116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376121">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376130">case</span>&nbsp;<span class="op" id="5376135">&lt;-</span><span class="ident" id="5376137">t</span><span class="op" id="5376138">.</span><span class="ident" id="5376139">C</span><span class="op" id="5376140">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376145">m</span><span class="op" id="5376146">.</span><span class="ident" id="5376147">lk</span><span class="op" id="5376149">.</span><span class="ident" id="5376150">Lock</span><span class="op" id="5376154">(</span><span class="op" id="5376155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376160">m</span><span class="op" id="5376161">.</span><span class="ident" id="5376162">dst</span><span class="op" id="5376165">.</span><span class="ident" id="5376166">Flush</span><span class="op" id="5376171">(</span><span class="op" id="5376172">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376177">m</span><span class="op" id="5376178">.</span><span class="ident" id="5376179">lk</span><span class="op" id="5376181">.</span><span class="ident" id="5376182">Unlock</span><span class="op" id="5376188">(</span><span class="op" id="5376189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5376193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5376196">}</span><br>
<span class="lineno"></span><span class="op" id="5376198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="5376201">func</span>&nbsp;<span class="op" id="5376206">(</span><span class="ident" id="5376207">m</span>&nbsp;<span class="op" id="5376209">*</span><span class="ident" id="5376210">maxLatencyWriter</span><span class="op" id="5376226">)</span>&nbsp;<span class="ident" id="5376228">stop</span><span class="op" id="5376232">(</span><span class="op" id="5376233">)</span>&nbsp;<span class="op" id="5376235">{</span>&nbsp;<span class="ident" id="5376237">m</span><span class="op" id="5376238">.</span><span class="ident" id="5376239">done</span>&nbsp;<span class="op" id="5376244">&lt;-</span>&nbsp;<span class="builtintype" id="5376247">true</span>&nbsp;<span class="op" id="5376252">}</span>
</div>
</body>
</html>
