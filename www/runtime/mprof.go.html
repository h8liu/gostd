<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//&nbsp;Malloc&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Patterned&nbsp;after&nbsp;tcmalloc&#39;s&nbsp;algorithms;&nbsp;shorter&nbsp;code.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;NOTE(rsc):&nbsp;Everything&nbsp;here&nbsp;could&nbsp;use&nbsp;cas&nbsp;if&nbsp;contention&nbsp;became&nbsp;an&nbsp;issue.</span><br>
<span class="lineno">15</span><span class="keyword">var</span>&nbsp;<span class="ident">proflock</span>&nbsp;<span class="ident">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;All&nbsp;memory&nbsp;allocations&nbsp;are&nbsp;local&nbsp;and&nbsp;do&nbsp;not&nbsp;escape&nbsp;outside&nbsp;of&nbsp;the&nbsp;profiler.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;profiler&nbsp;is&nbsp;forbidden&nbsp;from&nbsp;referring&nbsp;to&nbsp;garbage-collected&nbsp;memory.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;profile&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">memProfile</span>&nbsp;<span class="ident">bucketType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">blockProfile</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;size&nbsp;of&nbsp;bucket&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buckHashSize</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">179999</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;max&nbsp;depth&nbsp;of&nbsp;stack&nbsp;to&nbsp;record&nbsp;in&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">maxStack</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">32</span><br>
<span class="lineno">30</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">bucketType</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;bucket&nbsp;holds&nbsp;per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno">35</span><span class="comment">//&nbsp;The&nbsp;representation&nbsp;is&nbsp;a&nbsp;bit&nbsp;sleazy,&nbsp;inherited&nbsp;from&nbsp;C.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;This&nbsp;struct&nbsp;defines&nbsp;the&nbsp;bucket&nbsp;header.&nbsp;It&nbsp;is&nbsp;followed&nbsp;in</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;memory&nbsp;by&nbsp;the&nbsp;stack&nbsp;words&nbsp;and&nbsp;then&nbsp;the&nbsp;actual&nbsp;record</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;data,&nbsp;either&nbsp;a&nbsp;memRecord&nbsp;or&nbsp;a&nbsp;blockRecord.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">40</span><span class="comment">//&nbsp;Per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Lookup&nbsp;by&nbsp;hashing&nbsp;call&nbsp;stack&nbsp;into&nbsp;a&nbsp;linked-list&nbsp;hash&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">bucket</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">next</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">allnext</span>&nbsp;<span class="op">*</span><span class="ident">bucket</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">bucketType</span>&nbsp;<span class="comment">//&nbsp;memBucket&nbsp;or&nbsp;blockBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nstk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;memRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;memProfile,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;part&nbsp;of&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">memRecord</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;following&nbsp;complex&nbsp;3-stage&nbsp;scheme&nbsp;of&nbsp;stats&nbsp;accumulation</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;is&nbsp;required&nbsp;to&nbsp;obtain&nbsp;a&nbsp;consistent&nbsp;picture&nbsp;of&nbsp;mallocs&nbsp;and&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;for&nbsp;some&nbsp;point&nbsp;in&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;mallocs&nbsp;come&nbsp;in&nbsp;real&nbsp;time,&nbsp;while&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;come&nbsp;only&nbsp;after&nbsp;a&nbsp;GC&nbsp;during&nbsp;concurrent&nbsp;sweeping.&nbsp;So&nbsp;if&nbsp;we&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;naively&nbsp;count&nbsp;them,&nbsp;we&nbsp;would&nbsp;get&nbsp;a&nbsp;skew&nbsp;toward&nbsp;mallocs.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Mallocs&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Explicit&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;GC&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;After&nbsp;GC&nbsp;prev&nbsp;stats&nbsp;are&nbsp;added&nbsp;to&nbsp;final&nbsp;stats&nbsp;and</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;recent&nbsp;stats&nbsp;are&nbsp;moved&nbsp;into&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">alloc_bytes</span>&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">free_bytes</span>&nbsp;&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;changes&nbsp;between&nbsp;next-to-last&nbsp;GC&nbsp;and&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prev_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prev_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prev_alloc_bytes</span>&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prev_free_bytes</span>&nbsp;&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;changes&nbsp;since&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">recent_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">recent_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">recent_alloc_bytes</span>&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">recent_free_bytes</span>&nbsp;&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;blockRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;blockProfile,</span><br>
<span class="lineno">85</span><span class="comment">//&nbsp;part&nbsp;of&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">blockRecord</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">count</span>&nbsp;&nbsp;<span class="ident">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cycles</span>&nbsp;<span class="ident">int64</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mbuckets</span>&nbsp;&nbsp;<span class="op">*</span><span class="ident">bucket</span>&nbsp;<span class="comment">//&nbsp;memory&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bbuckets</span>&nbsp;&nbsp;<span class="op">*</span><span class="ident">bucket</span>&nbsp;<span class="comment">//&nbsp;blocking&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buckhash</span>&nbsp;&nbsp;<span class="op">*</span><span class="op">[</span><span class="num">179999</span><span class="op">]</span><span class="op">*</span><span class="ident">bucket</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bucketmem</span>&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;newBucket&nbsp;allocates&nbsp;a&nbsp;bucket&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;number&nbsp;of&nbsp;stack&nbsp;entries.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">newBucket</span><span class="op">(</span><span class="ident">typ</span>&nbsp;<span class="ident">bucketType</span><span class="op">,</span>&nbsp;<span class="ident">nstk</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">bucket</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Sizeof</span><span class="op">(</span><span class="ident">bucket</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="op">+</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">(</span><span class="ident">nstk</span><span class="op">)</span><span class="op">*</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Sizeof</span><span class="op">(</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">typ</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gothrow</span><span class="op">(</span><span class="string">&#34;invalid&nbsp;profile&nbsp;bucket&nbsp;type&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">memProfile</span><span class="op">:</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Sizeof</span><span class="op">(</span><span class="ident">memRecord</span><span class="op">{</span><span class="op">}</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">blockProfile</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Sizeof</span><span class="op">(</span><span class="ident">blockRecord</span><span class="op">{</span><span class="op">}</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">bucket</span><span class="op">)</span><span class="op">(</span><span class="ident">persistentalloc</span><span class="op">(</span><span class="ident">size</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">memstats</span><span class="op">.</span><span class="ident">buckhash_sys</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bucketmem</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">typ</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">typ</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">nstk</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">(</span><span class="ident">nstk</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">b</span><br>
<span class="lineno">115</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;stk&nbsp;returns&nbsp;the&nbsp;slice&nbsp;in&nbsp;b&nbsp;holding&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">bucket</span><span class="op">)</span>&nbsp;<span class="ident">stk</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uintptr</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">stk</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="op">[</span><span class="ident">maxStack</span><span class="op">]</span><span class="builtintype">uintptr</span><span class="op">)</span><span class="op">(</span><span class="ident">add</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Sizeof</span><span class="op">(</span><span class="op">*</span><span class="ident">b</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">stk</span><span class="op">[</span><span class="op">:</span><span class="ident">b</span><span class="op">.</span><span class="ident">nstk</span><span class="op">:</span><span class="ident">b</span><span class="op">.</span><span class="ident">nstk</span><span class="op">]</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;mp&nbsp;returns&nbsp;the&nbsp;memRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;memProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">bucket</span><span class="op">)</span>&nbsp;<span class="ident">mp</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">memRecord</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">typ</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">memProfile</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gothrow</span><span class="op">(</span><span class="string">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.mp&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">data</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">add</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Sizeof</span><span class="op">(</span><span class="op">*</span><span class="ident">b</span><span class="op">)</span><span class="op">+</span><span class="ident">b</span><span class="op">.</span><span class="ident">nstk</span><span class="op">*</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Sizeof</span><span class="op">(</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">memRecord</span><span class="op">)</span><span class="op">(</span><span class="ident">data</span><span class="op">)</span><br>
<span class="lineno">130</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;bp&nbsp;returns&nbsp;the&nbsp;blockRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;blockProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">bucket</span><span class="op">)</span>&nbsp;<span class="ident">bp</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">blockRecord</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">typ</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">blockProfile</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gothrow</span><span class="op">(</span><span class="string">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.bp&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">data</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">add</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Sizeof</span><span class="op">(</span><span class="op">*</span><span class="ident">b</span><span class="op">)</span><span class="op">+</span><span class="ident">b</span><span class="op">.</span><span class="ident">nstk</span><span class="op">*</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Sizeof</span><span class="op">(</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">blockRecord</span><span class="op">)</span><span class="op">(</span><span class="ident">data</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Return&nbsp;the&nbsp;bucket&nbsp;for&nbsp;stk[0:nstk],&nbsp;allocating&nbsp;new&nbsp;bucket&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">stkbucket</span><span class="op">(</span><span class="ident">typ</span>&nbsp;<span class="ident">bucketType</span><span class="op">,</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">,</span>&nbsp;<span class="ident">stk</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uintptr</span><span class="op">,</span>&nbsp;<span class="ident">alloc</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">bucket</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">buckhash</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buckhash</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="op">[</span><span class="ident">buckHashSize</span><span class="op">]</span><span class="op">*</span><span class="ident">bucket</span><span class="op">)</span><span class="op">(</span><span class="ident">sysAlloc</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Sizeof</span><span class="op">(</span><span class="op">*</span><span class="ident">buckhash</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">memstats</span><span class="op">.</span><span class="ident">buckhash_sys</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">buckhash</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gothrow</span><span class="op">(</span><span class="string">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Hash&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">h</span>&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">pc</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">stk</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">h</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">10</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span>&nbsp;<span class="op">^=</span>&nbsp;<span class="ident">h</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;hash&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">h</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">10</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span>&nbsp;<span class="op">^=</span>&nbsp;<span class="ident">h</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;finalize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">h</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span>&nbsp;<span class="op">^=</span>&nbsp;<span class="ident">h</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">11</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">h</span>&nbsp;<span class="op">%</span>&nbsp;<span class="ident">buckHashSize</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">buckhash</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">next</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">typ</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">typ</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">hash</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">h</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">size</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">eqslice</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">stk</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">stk</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">alloc</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Create&nbsp;new&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">newBucket</span><span class="op">(</span><span class="ident">typ</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">stk</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">stk</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">stk</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">hash</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">h</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">size</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">buckhash</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buckhash</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">typ</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">memProfile</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">allnext</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mbuckets</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mbuckets</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">allnext</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bbuckets</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">b</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">sysAlloc</span><span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">,</span>&nbsp;<span class="ident">stat</span>&nbsp;<span class="op">*</span><span class="ident">uint64</span><span class="op">)</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword">func</span>&nbsp;<span class="ident">eqslice</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uintptr</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">xi</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">xi</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">y</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">205</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">mprof_GC</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">mbuckets</span><span class="op">;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">allnext</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">mp</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">allocs</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">prev_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">frees</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">prev_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">alloc_bytes</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">prev_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">free_bytes</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">prev_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">prev_allocs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">recent_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">prev_frees</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">recent_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">prev_alloc_bytes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">recent_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">prev_free_bytes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">recent_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">recent_allocs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">recent_frees</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">recent_alloc_bytes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">recent_free_bytes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">225</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Record&nbsp;that&nbsp;a&nbsp;gc&nbsp;just&nbsp;happened:&nbsp;all&nbsp;the&nbsp;&#39;recent&#39;&nbsp;statistics&nbsp;are&nbsp;now&nbsp;real.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">mProf_GC</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">proflock</span><span class="op">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mprof_GC</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">unlock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">proflock</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Called&nbsp;by&nbsp;malloc&nbsp;to&nbsp;record&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno">235</span><span class="keyword">func</span>&nbsp;<span class="ident">mProf_Malloc</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">,</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">stk</span>&nbsp;<span class="op">[</span><span class="ident">maxStack</span><span class="op">]</span><span class="builtintype">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nstk</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">callers</span><span class="op">(</span><span class="num">4</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">stk</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">stk</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">proflock</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">stkbucket</span><span class="op">(</span><span class="ident">memProfile</span><span class="op">,</span>&nbsp;<span class="ident">size</span><span class="op">,</span>&nbsp;<span class="ident">stk</span><span class="op">[</span><span class="op">:</span><span class="ident">nstk</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">true</span><span class="op">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">mp</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">recent_allocs</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">recent_alloc_bytes</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">unlock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">proflock</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Setprofilebucket&nbsp;locks&nbsp;a&nbsp;bunch&nbsp;of&nbsp;other&nbsp;mutexes,&nbsp;so&nbsp;we&nbsp;call&nbsp;it&nbsp;outside&nbsp;of&nbsp;proflock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;reduces&nbsp;potential&nbsp;contention&nbsp;and&nbsp;chances&nbsp;of&nbsp;deadlocks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Since&nbsp;the&nbsp;object&nbsp;must&nbsp;be&nbsp;alive&nbsp;during&nbsp;call&nbsp;to&nbsp;mProf_Malloc,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;it&#39;s&nbsp;fine&nbsp;to&nbsp;do&nbsp;this&nbsp;non-atomically.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">setprofilebucket</span><span class="op">(</span><span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">)</span><br>
<span class="lineno">250</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">setprofilebucket_m</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;mheap.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">setprofilebucket</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">bucket</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getg</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">m</span><span class="op">.</span><span class="ident">ptrarg</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">m</span><span class="op">.</span><span class="ident">ptrarg</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onM</span><span class="op">(</span><span class="ident">setprofilebucket_m</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Called&nbsp;when&nbsp;freeing&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">mProf_Free</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">bucket</span><span class="op">,</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">,</span>&nbsp;<span class="ident">freed</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">proflock</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">mp</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">freed</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">recent_frees</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">recent_free_bytes</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">prev_frees</span><span class="op">++</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">prev_free_bytes</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">unlock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">proflock</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword">var</span>&nbsp;<span class="ident">blockprofilerate</span>&nbsp;<span class="ident">uint64</span>&nbsp;<span class="comment">//&nbsp;in&nbsp;CPU&nbsp;ticks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;SetBlockProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;goroutine&nbsp;blocking&nbsp;events</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;that&nbsp;are&nbsp;reported&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.&nbsp;&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;an&nbsp;average&nbsp;of&nbsp;one&nbsp;blocking&nbsp;event&nbsp;per&nbsp;rate&nbsp;nanoseconds&nbsp;spent&nbsp;blocked.</span><br>
<span class="lineno">280</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;To&nbsp;include&nbsp;every&nbsp;blocking&nbsp;event&nbsp;in&nbsp;the&nbsp;profile,&nbsp;pass&nbsp;rate&nbsp;=&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;pass&nbsp;rate&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">SetBlockProfileRate</span><span class="op">(</span><span class="ident">rate</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="ident">int64</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">rate</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="comment">//&nbsp;disable&nbsp;profiling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">rate</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="comment">//&nbsp;profile&nbsp;everything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;convert&nbsp;ns&nbsp;to&nbsp;cycles,&nbsp;use&nbsp;float64&nbsp;to&nbsp;prevent&nbsp;overflow&nbsp;during&nbsp;multiplication</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="builtintype">float64</span><span class="op">(</span><span class="ident">rate</span><span class="op">)</span>&nbsp;<span class="op">*</span>&nbsp;<span class="builtintype">float64</span><span class="op">(</span><span class="ident">tickspersecond</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="op">(</span><span class="num">1000</span>&nbsp;<span class="op">*</span>&nbsp;<span class="num">1000</span>&nbsp;<span class="op">*</span>&nbsp;<span class="num">1000</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">atomicstore64</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">blockprofilerate</span><span class="op">,</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="keyword">func</span>&nbsp;<span class="ident">blockevent</span><span class="op">(</span><span class="ident">cycles</span>&nbsp;<span class="ident">int64</span><span class="op">,</span>&nbsp;<span class="ident">skip</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">cycles</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cycles</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rate</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">atomicload64</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">blockprofilerate</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">rate</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="op">(</span><span class="ident">rate</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">cycles</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">fastrand1</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">%</span><span class="ident">rate</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">cycles</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getg</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">nstk</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">stk</span>&nbsp;<span class="op">[</span><span class="ident">maxStack</span><span class="op">]</span><span class="builtintype">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">gp</span><span class="op">.</span><span class="ident">m</span><span class="op">.</span><span class="ident">curg</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">gp</span><span class="op">.</span><span class="ident">m</span><span class="op">.</span><span class="ident">curg</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">gp</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nstk</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">callers</span><span class="op">(</span><span class="ident">skip</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">stk</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">stk</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nstk</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">gcallers</span><span class="op">(</span><span class="ident">gp</span><span class="op">.</span><span class="ident">m</span><span class="op">.</span><span class="ident">curg</span><span class="op">,</span>&nbsp;<span class="ident">skip</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">stk</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">stk</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">proflock</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">stkbucket</span><span class="op">(</span><span class="ident">blockProfile</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">stk</span><span class="op">[</span><span class="op">:</span><span class="ident">nstk</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">true</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">bp</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">count</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">bp</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">cycles</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">cycles</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">unlock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">proflock</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Go&nbsp;interface&nbsp;to&nbsp;profile&nbsp;data.</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment">//&nbsp;A&nbsp;StackRecord&nbsp;describes&nbsp;a&nbsp;single&nbsp;execution&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">StackRecord</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Stack0</span>&nbsp;<span class="op">[</span><span class="num">32</span><span class="op">]</span><span class="builtintype">uintptr</span>&nbsp;<span class="comment">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">StackRecord</span><span class="op">)</span>&nbsp;<span class="ident">Stack</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uintptr</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Stack0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Stack0</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Stack0</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;MemProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;memory&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;that&nbsp;are&nbsp;recorded&nbsp;and&nbsp;reported&nbsp;in&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample&nbsp;an&nbsp;average&nbsp;of</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;one&nbsp;allocation&nbsp;per&nbsp;MemProfileRate&nbsp;bytes&nbsp;allocated.</span><br>
<span class="lineno">345</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;To&nbsp;include&nbsp;every&nbsp;allocated&nbsp;block&nbsp;in&nbsp;the&nbsp;profile,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;tools&nbsp;that&nbsp;process&nbsp;the&nbsp;memory&nbsp;profiles&nbsp;assume&nbsp;that&nbsp;the</span><br>
<span class="lineno">350</span><span class="comment">//&nbsp;profile&nbsp;rate&nbsp;is&nbsp;constant&nbsp;across&nbsp;the&nbsp;lifetime&nbsp;of&nbsp;the&nbsp;program</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;and&nbsp;equal&nbsp;to&nbsp;the&nbsp;current&nbsp;value.&nbsp;&nbsp;Programs&nbsp;that&nbsp;change&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;memory&nbsp;profiling&nbsp;rate&nbsp;should&nbsp;do&nbsp;so&nbsp;just&nbsp;once,&nbsp;as&nbsp;early&nbsp;as</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;possible&nbsp;in&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;program&nbsp;(for&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;main).</span><br>
<span class="lineno">355</span><span class="keyword">var</span>&nbsp;<span class="ident">MemProfileRate</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">512</span>&nbsp;<span class="op">*</span>&nbsp;<span class="num">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;MemProfileRecord&nbsp;describes&nbsp;the&nbsp;live&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;by&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">MemProfileRecord</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">AllocBytes</span><span class="op">,</span>&nbsp;<span class="ident">FreeBytes</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">AllocObjects</span><span class="op">,</span>&nbsp;<span class="ident">FreeObjects</span>&nbsp;<span class="ident">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;number&nbsp;of&nbsp;objects&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Stack0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="num">32</span><span class="op">]</span><span class="builtintype">uintptr</span>&nbsp;<span class="comment">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment">//&nbsp;InUseBytes&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;use&nbsp;(AllocBytes&nbsp;-&nbsp;FreeBytes).</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">MemProfileRecord</span><span class="op">)</span>&nbsp;<span class="ident">InUseBytes</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">int64</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">AllocBytes</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">FreeBytes</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;InUseObjects&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;objects&nbsp;in&nbsp;use&nbsp;(AllocObjects&nbsp;-&nbsp;FreeObjects).</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">MemProfileRecord</span><span class="op">)</span>&nbsp;<span class="ident">InUseObjects</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">int64</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">AllocObjects</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">FreeObjects</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno">375</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">MemProfileRecord</span><span class="op">)</span>&nbsp;<span class="ident">Stack</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uintptr</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Stack0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Stack0</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Stack0</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;MemProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno">385</span><span class="comment">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;MemProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;MemProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;inuseZero&nbsp;is&nbsp;true,&nbsp;the&nbsp;profile&nbsp;includes&nbsp;allocation&nbsp;records</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;where&nbsp;r.AllocBytes&nbsp;&gt;&nbsp;0&nbsp;but&nbsp;r.AllocBytes&nbsp;==&nbsp;r.FreeBytes.</span><br>
<span class="lineno">390</span><span class="comment">//&nbsp;These&nbsp;are&nbsp;sites&nbsp;where&nbsp;memory&nbsp;was&nbsp;allocated,&nbsp;but&nbsp;it&nbsp;has&nbsp;all</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;been&nbsp;released&nbsp;back&nbsp;to&nbsp;the&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.memprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno">395</span><span class="comment">//&nbsp;of&nbsp;calling&nbsp;MemProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">MemProfile</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">MemProfileRecord</span><span class="op">,</span>&nbsp;<span class="ident">inuseZero</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">proflock</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">clear</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">mbuckets</span><span class="op">;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">allnext</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">mp</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">inuseZero</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">alloc_bytes</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">free_bytes</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">allocs</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">frees</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">clear</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">clear</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Absolutely&nbsp;no&nbsp;data,&nbsp;suggesting&nbsp;that&nbsp;a&nbsp;garbage&nbsp;collection</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;has&nbsp;not&nbsp;yet&nbsp;happened.&nbsp;In&nbsp;order&nbsp;to&nbsp;allow&nbsp;profiling&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;garbage&nbsp;collection&nbsp;is&nbsp;disabled&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;execution,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;accumulate&nbsp;stats&nbsp;as&nbsp;if&nbsp;a&nbsp;GC&nbsp;just&nbsp;happened,&nbsp;and&nbsp;recount&nbsp;buckets.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mprof_GC</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mprof_GC</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">mbuckets</span><span class="op">;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">allnext</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">mp</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">inuseZero</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">alloc_bytes</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">free_bytes</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">++</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">idx</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">mbuckets</span><span class="op">;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">allnext</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">mp</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">inuseZero</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">alloc_bytes</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">free_bytes</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">record</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">p</span><span class="op">[</span><span class="ident">idx</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">idx</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">unlock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">proflock</span><span class="op">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Write&nbsp;b&#39;s&nbsp;data&nbsp;to&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">record</span><span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">MemProfileRecord</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">bucket</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">mp</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">AllocBytes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">mp</span><span class="op">.</span><span class="ident">alloc_bytes</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">FreeBytes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">mp</span><span class="op">.</span><span class="ident">free_bytes</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">AllocObjects</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">mp</span><span class="op">.</span><span class="ident">allocs</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">FreeObjects</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">mp</span><span class="op">.</span><span class="ident">frees</span><span class="op">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Stack0</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">stk</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">nstk</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Stack0</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">Stack0</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">iterate_memprof</span><span class="op">(</span><span class="ident">fn</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="op">*</span><span class="ident">bucket</span><span class="op">,</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="builtintype">uintptr</span><span class="op">,</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">,</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">,</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">proflock</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">mbuckets</span><span class="op">;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">allnext</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">mp</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fn</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">nstk</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">b</span><span class="op">.</span><span class="ident">stk</span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">size</span><span class="op">,</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">allocs</span><span class="op">,</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">frees</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">unlock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">proflock</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment">//&nbsp;BlockProfileRecord&nbsp;describes&nbsp;blocking&nbsp;events&nbsp;originated</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;at&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">BlockProfileRecord</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Count</span>&nbsp;&nbsp;<span class="ident">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Cycles</span>&nbsp;<span class="ident">int64</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">StackRecord</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;BlockProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;BlockProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">470</span><span class="comment">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;BlockProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.blockprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;of&nbsp;calling&nbsp;BlockProfile&nbsp;directly.</span><br>
<span class="lineno">475</span><span class="keyword">func</span>&nbsp;<span class="ident">BlockProfile</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">BlockProfileRecord</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">proflock</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bbuckets</span><span class="op">;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">allnext</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bbuckets</span><span class="op">;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">allnext</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">bp</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">p</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">Count</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">bp</span><span class="op">.</span><span class="ident">count</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">Cycles</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">bp</span><span class="op">.</span><span class="ident">cycles</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Stack0</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">stk</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Stack0</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">Stack0</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">p</span><span class="op">[</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">unlock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">proflock</span><span class="op">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ThreadCreateProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;thread&nbsp;creation&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">500</span><span class="comment">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;of&nbsp;calling&nbsp;ThreadCreateProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">ThreadCreateProfile</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">StackRecord</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">first</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">m</span><span class="op">)</span><span class="op">(</span><span class="ident">atomicloadp</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">allm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">mp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">first</span><span class="op">;</span>&nbsp;<span class="ident">mp</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">;</span>&nbsp;<span class="ident">mp</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">alllink</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">mp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">first</span><span class="op">;</span>&nbsp;<span class="ident">mp</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">;</span>&nbsp;<span class="ident">mp</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">alllink</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">createstack</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">Stack0</span><span class="op">[</span><span class="ident">s</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">(</span><span class="ident">mp</span><span class="op">.</span><span class="ident">createstack</span><span class="op">[</span><span class="ident">s</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">520</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">allgs</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="op">*</span><span class="ident">g</span>&nbsp;<span class="comment">//&nbsp;proc.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;GoroutineProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;active&nbsp;goroutine&nbsp;stack&nbsp;profile.</span><br>
<span class="lineno">525</span><span class="comment">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;GoroutineProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;GoroutineProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;of&nbsp;calling&nbsp;GoroutineProfile&nbsp;directly.</span><br>
<span class="lineno">530</span><span class="keyword">func</span>&nbsp;<span class="ident">GoroutineProfile</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">StackRecord</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">NumGoroutine</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getg</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">semacquire</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">worldsema</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gp</span><span class="op">.</span><span class="ident">m</span><span class="op">.</span><span class="ident">gcing</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onM</span><span class="op">(</span><span class="ident">stoptheworld</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">NumGoroutine</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getcallersp</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">p</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pc</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getcallerpc</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">p</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onM</span><span class="op">(</span><span class="keyword">func</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">saveg</span><span class="op">(</span><span class="ident">pc</span><span class="op">,</span>&nbsp;<span class="ident">sp</span><span class="op">,</span>&nbsp;<span class="ident">gp</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">r</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">[</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">gp1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">allgs</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">gp1</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">gp</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">readgstatus</span><span class="op">(</span><span class="ident">gp1</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">_Gdead</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">saveg</span><span class="op">(</span><span class="op">^</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="op">^</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">gp1</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">r</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">[</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gp</span><span class="op">.</span><span class="ident">m</span><span class="op">.</span><span class="ident">gcing</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">semrelease</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">worldsema</span><span class="op">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onM</span><span class="op">(</span><span class="ident">starttheworld</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">ok</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">saveg</span><span class="op">(</span><span class="ident">pc</span><span class="op">,</span>&nbsp;<span class="ident">sp</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">,</span>&nbsp;<span class="ident">gp</span>&nbsp;<span class="op">*</span><span class="ident">g</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">StackRecord</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">gentraceback</span><span class="op">(</span><span class="ident">pc</span><span class="op">,</span>&nbsp;<span class="ident">sp</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">gp</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">r</span><span class="op">.</span><span class="ident">Stack0</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Stack0</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">Stack0</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">Stack0</span><span class="op">[</span><span class="ident">n</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Stack&nbsp;formats&nbsp;a&nbsp;stack&nbsp;trace&nbsp;of&nbsp;the&nbsp;calling&nbsp;goroutine&nbsp;into&nbsp;buf</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;to&nbsp;buf.</span><br>
<span class="lineno">575</span><span class="comment">//&nbsp;If&nbsp;all&nbsp;is&nbsp;true,&nbsp;Stack&nbsp;formats&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;other&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;into&nbsp;buf&nbsp;after&nbsp;the&nbsp;trace&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">Stack</span><span class="op">(</span><span class="ident">buf</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">all</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">acquirem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">mp</span><span class="op">.</span><span class="ident">curg</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">all</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">semacquire</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">worldsema</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">gcing</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">releasem</span><span class="op">(</span><span class="ident">mp</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onM</span><span class="op">(</span><span class="ident">stoptheworld</span><span class="op">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">mp</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">acquirem</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gothrow</span><span class="op">(</span><span class="string">&#34;Stack:&nbsp;rescheduled&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">buf</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getcallersp</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">buf</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pc</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getcallerpc</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">buf</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onM</span><span class="op">(</span><span class="keyword">func</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g0</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getg</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g0</span><span class="op">.</span><span class="ident">writebuf</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="num">0</span><span class="op">:</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">buf</span><span class="op">)</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">goroutineheader</span><span class="op">(</span><span class="ident">gp</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">traceback</span><span class="op">(</span><span class="ident">pc</span><span class="op">,</span>&nbsp;<span class="ident">sp</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">gp</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">all</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tracebackothers</span><span class="op">(</span><span class="ident">gp</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">g0</span><span class="op">.</span><span class="ident">writebuf</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g0</span><span class="op">.</span><span class="ident">writebuf</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">all</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mp</span><span class="op">.</span><span class="ident">gcing</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">semrelease</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">worldsema</span><span class="op">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onM</span><span class="op">(</span><span class="ident">starttheworld</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">releasem</span><span class="op">(</span><span class="ident">mp</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Tracing&nbsp;of&nbsp;alloc/free/gc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">tracelock</span>&nbsp;<span class="ident">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword">func</span>&nbsp;<span class="ident">tracealloc</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">,</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">,</span>&nbsp;<span class="ident">typ</span>&nbsp;<span class="op">*</span><span class="ident">_type</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">tracelock</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getg</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gp</span><span class="op">.</span><span class="ident">m</span><span class="op">.</span><span class="ident">traceback</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">typ</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">print</span><span class="op">(</span><span class="string">&#34;tracealloc(&#34;</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">,</span>&nbsp;<span class="string">&#34;,&nbsp;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">hex</span><span class="op">(</span><span class="ident">size</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="string">&#34;)\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">print</span><span class="op">(</span><span class="string">&#34;tracealloc(&#34;</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">,</span>&nbsp;<span class="string">&#34;,&nbsp;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">hex</span><span class="op">(</span><span class="ident">size</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="string">&#34;,&nbsp;&#34;</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">typ</span><span class="op">.</span><span class="ident">_string</span><span class="op">,</span>&nbsp;<span class="string">&#34;)\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">gp</span><span class="op">.</span><span class="ident">m</span><span class="op">.</span><span class="ident">curg</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">gp</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">gp</span><span class="op">.</span><span class="ident">m</span><span class="op">.</span><span class="ident">curg</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">goroutineheader</span><span class="op">(</span><span class="ident">gp</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pc</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getcallerpc</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">p</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getcallersp</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">p</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onM</span><span class="op">(</span><span class="keyword">func</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">traceback</span><span class="op">(</span><span class="ident">pc</span><span class="op">,</span>&nbsp;<span class="ident">sp</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">gp</span><span class="op">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">goroutineheader</span><span class="op">(</span><span class="ident">gp</span><span class="op">.</span><span class="ident">m</span><span class="op">.</span><span class="ident">curg</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">traceback</span><span class="op">(</span><span class="op">^</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="op">^</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">gp</span><span class="op">.</span><span class="ident">m</span><span class="op">.</span><span class="ident">curg</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">print</span><span class="op">(</span><span class="string">&#34;\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gp</span><span class="op">.</span><span class="ident">m</span><span class="op">.</span><span class="ident">traceback</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">unlock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">tracelock</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span><span class="keyword">func</span>&nbsp;<span class="ident">tracefree</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">,</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">tracelock</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getg</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gp</span><span class="op">.</span><span class="ident">m</span><span class="op">.</span><span class="ident">traceback</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">print</span><span class="op">(</span><span class="string">&#34;tracefree(&#34;</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">,</span>&nbsp;<span class="string">&#34;,&nbsp;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">hex</span><span class="op">(</span><span class="ident">size</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="string">&#34;)\n&#34;</span><span class="op">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">goroutineheader</span><span class="op">(</span><span class="ident">gp</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pc</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getcallerpc</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">p</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getcallersp</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">p</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onM</span><span class="op">(</span><span class="keyword">func</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">traceback</span><span class="op">(</span><span class="ident">pc</span><span class="op">,</span>&nbsp;<span class="ident">sp</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">gp</span><span class="op">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">print</span><span class="op">(</span><span class="string">&#34;\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gp</span><span class="op">.</span><span class="ident">m</span><span class="op">.</span><span class="ident">traceback</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">unlock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">tracelock</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">tracegc</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">tracelock</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getg</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gp</span><span class="op">.</span><span class="ident">m</span><span class="op">.</span><span class="ident">traceback</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">2</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">print</span><span class="op">(</span><span class="string">&#34;tracegc()\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;running&nbsp;on&nbsp;m-&gt;g0&nbsp;stack;&nbsp;show&nbsp;all&nbsp;non-g0&nbsp;goroutines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tracebackothers</span><span class="op">(</span><span class="ident">gp</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">print</span><span class="op">(</span><span class="string">&#34;end&nbsp;tracegc\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">print</span><span class="op">(</span><span class="string">&#34;\n&#34;</span><span class="op">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gp</span><span class="op">.</span><span class="ident">m</span><span class="op">.</span><span class="ident">traceback</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">unlock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">tracelock</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
