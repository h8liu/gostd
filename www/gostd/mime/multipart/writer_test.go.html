<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>mime/multipart</h2>
<ul>
<li><a href="/gostd/mime/multipart/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/mime/multipart/formdata.go.html">formdata.go</a></li>
<li><a href="/gostd/mime/multipart/formdata_test.go.html">formdata_test.go</a></li>
<li><a href="/gostd/mime/multipart/multipart.go.html">multipart.go</a></li>
<li><a href="/gostd/mime/multipart/multipart_test.go.html">multipart_test.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable.go.html">quotedprintable.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable_test.go.html">quotedprintable_test.go</a></li>
<li><a href="/gostd/mime/multipart/writer.go.html">writer.go</a></li>
<li><a href="/gostd/mime/multipart/writer_test.go.html" class="current">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7888881">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7888936">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7888990">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7889041">package</span>&nbsp;<span class="ident" id="7889049">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7889060">import</span>&nbsp;<span class="op" id="7889067">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7889070">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7889079">&#34;io/ioutil&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7889092">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7889103">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="7889113">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7889116">func</span>&nbsp;<span class="ident" id="7889121">TestWriter</span><span class="op" id="7889131">(</span><span class="ident" id="7889132">t</span>&nbsp;<span class="op" id="7889134">*</span><span class="ident" id="7889135">testing</span><span class="op" id="7889142">.</span><span class="ident" id="7889143">T</span><span class="op" id="7889144">)</span>&nbsp;<span class="op" id="7889146">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889149">fileContents</span>&nbsp;<span class="op" id="7889162">:=</span>&nbsp;<span class="op" id="7889165">[</span><span class="op" id="7889166">]</span><span class="builtintype" id="7889167">byte</span><span class="op" id="7889171">(</span><span class="string" id="7889172">&#34;my&nbsp;file&nbsp;contents&#34;</span><span class="op" id="7889190">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889194">var</span>&nbsp;<span class="ident" id="7889198">b</span>&nbsp;<span class="ident" id="7889200">bytes</span><span class="op" id="7889205">.</span><span class="ident" id="7889206">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889214">w</span>&nbsp;<span class="op" id="7889216">:=</span>&nbsp;<span class="ident" id="7889219">NewWriter</span><span class="op" id="7889228">(</span><span class="op" id="7889229">&amp;</span><span class="ident" id="7889230">b</span><span class="op" id="7889231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889234">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889238">part</span><span class="op" id="7889242">,</span>&nbsp;<span class="ident" id="7889244">err</span>&nbsp;<span class="op" id="7889248">:=</span>&nbsp;<span class="ident" id="7889251">w</span><span class="op" id="7889252">.</span><span class="ident" id="7889253">CreateFormFile</span><span class="op" id="7889267">(</span><span class="string" id="7889268">&#34;myfile&#34;</span><span class="op" id="7889276">,</span>&nbsp;<span class="string" id="7889278">&#34;my-file.txt&#34;</span><span class="op" id="7889291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889295">if</span>&nbsp;<span class="ident" id="7889298">err</span>&nbsp;<span class="op" id="7889302">!=</span>&nbsp;<span class="ident" id="7889305">nil</span>&nbsp;<span class="op" id="7889309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889314">t</span><span class="op" id="7889315">.</span><span class="ident" id="7889316">Fatalf</span><span class="op" id="7889322">(</span><span class="string" id="7889323">&#34;CreateFormFile:&nbsp;%v&#34;</span><span class="op" id="7889343">,</span>&nbsp;<span class="ident" id="7889345">err</span><span class="op" id="7889348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889356">part</span><span class="op" id="7889360">.</span><span class="ident" id="7889361">Write</span><span class="op" id="7889366">(</span><span class="ident" id="7889367">fileContents</span><span class="op" id="7889379">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889383">err</span>&nbsp;<span class="op" id="7889387">=</span>&nbsp;<span class="ident" id="7889389">w</span><span class="op" id="7889390">.</span><span class="ident" id="7889391">WriteField</span><span class="op" id="7889401">(</span><span class="string" id="7889402">&#34;key&#34;</span><span class="op" id="7889407">,</span>&nbsp;<span class="string" id="7889409">&#34;val&#34;</span><span class="op" id="7889414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889418">if</span>&nbsp;<span class="ident" id="7889421">err</span>&nbsp;<span class="op" id="7889425">!=</span>&nbsp;<span class="ident" id="7889428">nil</span>&nbsp;<span class="op" id="7889432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889437">t</span><span class="op" id="7889438">.</span><span class="ident" id="7889439">Fatalf</span><span class="op" id="7889445">(</span><span class="string" id="7889446">&#34;WriteField:&nbsp;%v&#34;</span><span class="op" id="7889462">,</span>&nbsp;<span class="ident" id="7889464">err</span><span class="op" id="7889467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889475">part</span><span class="op" id="7889479">.</span><span class="ident" id="7889480">Write</span><span class="op" id="7889485">(</span><span class="op" id="7889486">[</span><span class="op" id="7889487">]</span><span class="builtintype" id="7889488">byte</span><span class="op" id="7889492">(</span><span class="string" id="7889493">&#34;val&#34;</span><span class="op" id="7889498">)</span><span class="op" id="7889499">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889503">err</span>&nbsp;<span class="op" id="7889507">=</span>&nbsp;<span class="ident" id="7889509">w</span><span class="op" id="7889510">.</span><span class="ident" id="7889511">Close</span><span class="op" id="7889516">(</span><span class="op" id="7889517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889521">if</span>&nbsp;<span class="ident" id="7889524">err</span>&nbsp;<span class="op" id="7889528">!=</span>&nbsp;<span class="ident" id="7889531">nil</span>&nbsp;<span class="op" id="7889535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889540">t</span><span class="op" id="7889541">.</span><span class="ident" id="7889542">Fatalf</span><span class="op" id="7889548">(</span><span class="string" id="7889549">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="7889560">,</span>&nbsp;<span class="ident" id="7889562">err</span><span class="op" id="7889565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889573">s</span>&nbsp;<span class="op" id="7889575">:=</span>&nbsp;<span class="ident" id="7889578">b</span><span class="op" id="7889579">.</span><span class="ident" id="7889580">String</span><span class="op" id="7889586">(</span><span class="op" id="7889587">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889591">if</span>&nbsp;<span class="builtinfunc" id="7889594">len</span><span class="op" id="7889597">(</span><span class="ident" id="7889598">s</span><span class="op" id="7889599">)</span>&nbsp;<span class="op" id="7889601">==</span>&nbsp;<span class="num" id="7889604">0</span>&nbsp;<span class="op" id="7889606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889611">t</span><span class="op" id="7889612">.</span><span class="ident" id="7889613">Fatal</span><span class="op" id="7889618">(</span><span class="string" id="7889619">&#34;String:&nbsp;unexpected&nbsp;empty&nbsp;result&#34;</span><span class="op" id="7889652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889660">if</span>&nbsp;<span class="ident" id="7889663">s</span><span class="op" id="7889664">[</span><span class="num" id="7889665">0</span><span class="op" id="7889666">]</span>&nbsp;<span class="op" id="7889668">==</span>&nbsp;<span class="string" id="7889671">&#39;\r&#39;</span>&nbsp;<span class="op" id="7889676">||</span>&nbsp;<span class="ident" id="7889679">s</span><span class="op" id="7889680">[</span><span class="num" id="7889681">0</span><span class="op" id="7889682">]</span>&nbsp;<span class="op" id="7889684">==</span>&nbsp;<span class="string" id="7889687">&#39;\n&#39;</span>&nbsp;<span class="op" id="7889692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889697">t</span><span class="op" id="7889698">.</span><span class="ident" id="7889699">Fatal</span><span class="op" id="7889704">(</span><span class="string" id="7889705">&#34;String:&nbsp;unexpected&nbsp;newline&#34;</span><span class="op" id="7889733">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889744">r</span>&nbsp;<span class="op" id="7889746">:=</span>&nbsp;<span class="ident" id="7889749">NewReader</span><span class="op" id="7889758">(</span><span class="op" id="7889759">&amp;</span><span class="ident" id="7889760">b</span><span class="op" id="7889761">,</span>&nbsp;<span class="ident" id="7889763">w</span><span class="op" id="7889764">.</span><span class="ident" id="7889765">Boundary</span><span class="op" id="7889773">(</span><span class="op" id="7889774">)</span><span class="op" id="7889775">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889779">part</span><span class="op" id="7889783">,</span>&nbsp;<span class="ident" id="7889785">err</span>&nbsp;<span class="op" id="7889789">:=</span>&nbsp;<span class="ident" id="7889792">r</span><span class="op" id="7889793">.</span><span class="ident" id="7889794">NextPart</span><span class="op" id="7889802">(</span><span class="op" id="7889803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889806">if</span>&nbsp;<span class="ident" id="7889809">err</span>&nbsp;<span class="op" id="7889813">!=</span>&nbsp;<span class="ident" id="7889816">nil</span>&nbsp;<span class="op" id="7889820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889824">t</span><span class="op" id="7889825">.</span><span class="ident" id="7889826">Fatalf</span><span class="op" id="7889832">(</span><span class="string" id="7889833">&#34;part&nbsp;1:&nbsp;%v&#34;</span><span class="op" id="7889845">,</span>&nbsp;<span class="ident" id="7889847">err</span><span class="op" id="7889850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889856">if</span>&nbsp;<span class="ident" id="7889859">g</span><span class="op" id="7889860">,</span>&nbsp;<span class="ident" id="7889862">e</span>&nbsp;<span class="op" id="7889864">:=</span>&nbsp;<span class="ident" id="7889867">part</span><span class="op" id="7889871">.</span><span class="ident" id="7889872">FormName</span><span class="op" id="7889880">(</span><span class="op" id="7889881">)</span><span class="op" id="7889882">,</span>&nbsp;<span class="string" id="7889884">&#34;myfile&#34;</span><span class="op" id="7889892">;</span>&nbsp;<span class="ident" id="7889894">g</span>&nbsp;<span class="op" id="7889896">!=</span>&nbsp;<span class="ident" id="7889899">e</span>&nbsp;<span class="op" id="7889901">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889905">t</span><span class="op" id="7889906">.</span><span class="ident" id="7889907">Errorf</span><span class="op" id="7889913">(</span><span class="string" id="7889914">&#34;part&nbsp;1:&nbsp;want&nbsp;form&nbsp;name&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7889949">,</span>&nbsp;<span class="ident" id="7889951">e</span><span class="op" id="7889952">,</span>&nbsp;<span class="ident" id="7889954">g</span><span class="op" id="7889955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889961">slurp</span><span class="op" id="7889966">,</span>&nbsp;<span class="ident" id="7889968">err</span>&nbsp;<span class="op" id="7889972">:=</span>&nbsp;<span class="ident" id="7889975">ioutil</span><span class="op" id="7889981">.</span><span class="ident" id="7889982">ReadAll</span><span class="op" id="7889989">(</span><span class="ident" id="7889990">part</span><span class="op" id="7889994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889997">if</span>&nbsp;<span class="ident" id="7890000">err</span>&nbsp;<span class="op" id="7890004">!=</span>&nbsp;<span class="ident" id="7890007">nil</span>&nbsp;<span class="op" id="7890011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890015">t</span><span class="op" id="7890016">.</span><span class="ident" id="7890017">Fatalf</span><span class="op" id="7890023">(</span><span class="string" id="7890024">&#34;part&nbsp;1:&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="7890045">,</span>&nbsp;<span class="ident" id="7890047">err</span><span class="op" id="7890050">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890056">if</span>&nbsp;<span class="ident" id="7890059">e</span><span class="op" id="7890060">,</span>&nbsp;<span class="ident" id="7890062">g</span>&nbsp;<span class="op" id="7890064">:=</span>&nbsp;<span class="builtintype" id="7890067">string</span><span class="op" id="7890073">(</span><span class="ident" id="7890074">fileContents</span><span class="op" id="7890086">)</span><span class="op" id="7890087">,</span>&nbsp;<span class="builtintype" id="7890089">string</span><span class="op" id="7890095">(</span><span class="ident" id="7890096">slurp</span><span class="op" id="7890101">)</span><span class="op" id="7890102">;</span>&nbsp;<span class="ident" id="7890104">e</span>&nbsp;<span class="op" id="7890106">!=</span>&nbsp;<span class="ident" id="7890109">g</span>&nbsp;<span class="op" id="7890111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890115">t</span><span class="op" id="7890116">.</span><span class="ident" id="7890117">Errorf</span><span class="op" id="7890123">(</span><span class="string" id="7890124">&#34;part&nbsp;1:&nbsp;want&nbsp;contents&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7890158">,</span>&nbsp;<span class="ident" id="7890160">e</span><span class="op" id="7890161">,</span>&nbsp;<span class="ident" id="7890163">g</span><span class="op" id="7890164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890171">part</span><span class="op" id="7890175">,</span>&nbsp;<span class="ident" id="7890177">err</span>&nbsp;<span class="op" id="7890181">=</span>&nbsp;<span class="ident" id="7890183">r</span><span class="op" id="7890184">.</span><span class="ident" id="7890185">NextPart</span><span class="op" id="7890193">(</span><span class="op" id="7890194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890197">if</span>&nbsp;<span class="ident" id="7890200">err</span>&nbsp;<span class="op" id="7890204">!=</span>&nbsp;<span class="ident" id="7890207">nil</span>&nbsp;<span class="op" id="7890211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890215">t</span><span class="op" id="7890216">.</span><span class="ident" id="7890217">Fatalf</span><span class="op" id="7890223">(</span><span class="string" id="7890224">&#34;part&nbsp;2:&nbsp;%v&#34;</span><span class="op" id="7890236">,</span>&nbsp;<span class="ident" id="7890238">err</span><span class="op" id="7890241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890247">if</span>&nbsp;<span class="ident" id="7890250">g</span><span class="op" id="7890251">,</span>&nbsp;<span class="ident" id="7890253">e</span>&nbsp;<span class="op" id="7890255">:=</span>&nbsp;<span class="ident" id="7890258">part</span><span class="op" id="7890262">.</span><span class="ident" id="7890263">FormName</span><span class="op" id="7890271">(</span><span class="op" id="7890272">)</span><span class="op" id="7890273">,</span>&nbsp;<span class="string" id="7890275">&#34;key&#34;</span><span class="op" id="7890280">;</span>&nbsp;<span class="ident" id="7890282">g</span>&nbsp;<span class="op" id="7890284">!=</span>&nbsp;<span class="ident" id="7890287">e</span>&nbsp;<span class="op" id="7890289">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890293">t</span><span class="op" id="7890294">.</span><span class="ident" id="7890295">Errorf</span><span class="op" id="7890301">(</span><span class="string" id="7890302">&#34;part&nbsp;2:&nbsp;want&nbsp;form&nbsp;name&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7890337">,</span>&nbsp;<span class="ident" id="7890339">e</span><span class="op" id="7890340">,</span>&nbsp;<span class="ident" id="7890342">g</span><span class="op" id="7890343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890349">slurp</span><span class="op" id="7890354">,</span>&nbsp;<span class="ident" id="7890356">err</span>&nbsp;<span class="op" id="7890360">=</span>&nbsp;<span class="ident" id="7890362">ioutil</span><span class="op" id="7890368">.</span><span class="ident" id="7890369">ReadAll</span><span class="op" id="7890376">(</span><span class="ident" id="7890377">part</span><span class="op" id="7890381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890384">if</span>&nbsp;<span class="ident" id="7890387">err</span>&nbsp;<span class="op" id="7890391">!=</span>&nbsp;<span class="ident" id="7890394">nil</span>&nbsp;<span class="op" id="7890398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890402">t</span><span class="op" id="7890403">.</span><span class="ident" id="7890404">Fatalf</span><span class="op" id="7890410">(</span><span class="string" id="7890411">&#34;part&nbsp;2:&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="7890432">,</span>&nbsp;<span class="ident" id="7890434">err</span><span class="op" id="7890437">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890443">if</span>&nbsp;<span class="ident" id="7890446">e</span><span class="op" id="7890447">,</span>&nbsp;<span class="ident" id="7890449">g</span>&nbsp;<span class="op" id="7890451">:=</span>&nbsp;<span class="string" id="7890454">&#34;val&#34;</span><span class="op" id="7890459">,</span>&nbsp;<span class="builtintype" id="7890461">string</span><span class="op" id="7890467">(</span><span class="ident" id="7890468">slurp</span><span class="op" id="7890473">)</span><span class="op" id="7890474">;</span>&nbsp;<span class="ident" id="7890476">e</span>&nbsp;<span class="op" id="7890478">!=</span>&nbsp;<span class="ident" id="7890481">g</span>&nbsp;<span class="op" id="7890483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890487">t</span><span class="op" id="7890488">.</span><span class="ident" id="7890489">Errorf</span><span class="op" id="7890495">(</span><span class="string" id="7890496">&#34;part&nbsp;2:&nbsp;want&nbsp;contents&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7890530">,</span>&nbsp;<span class="ident" id="7890532">e</span><span class="op" id="7890533">,</span>&nbsp;<span class="ident" id="7890535">g</span><span class="op" id="7890536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890543">part</span><span class="op" id="7890547">,</span>&nbsp;<span class="ident" id="7890549">err</span>&nbsp;<span class="op" id="7890553">=</span>&nbsp;<span class="ident" id="7890555">r</span><span class="op" id="7890556">.</span><span class="ident" id="7890557">NextPart</span><span class="op" id="7890565">(</span><span class="op" id="7890566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890569">if</span>&nbsp;<span class="ident" id="7890572">part</span>&nbsp;<span class="op" id="7890577">!=</span>&nbsp;<span class="ident" id="7890580">nil</span>&nbsp;<span class="op" id="7890584">||</span>&nbsp;<span class="ident" id="7890587">err</span>&nbsp;<span class="op" id="7890591">==</span>&nbsp;<span class="ident" id="7890594">nil</span>&nbsp;<span class="op" id="7890598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890602">t</span><span class="op" id="7890603">.</span><span class="ident" id="7890604">Fatalf</span><span class="op" id="7890610">(</span><span class="string" id="7890611">&#34;expected&nbsp;end&nbsp;of&nbsp;parts;&nbsp;got&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7890646">,</span>&nbsp;<span class="ident" id="7890648">part</span><span class="op" id="7890652">,</span>&nbsp;<span class="ident" id="7890654">err</span><span class="op" id="7890657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890660">}</span><br>
<span class="lineno"></span><span class="op" id="7890662">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="7890665">func</span>&nbsp;<span class="ident" id="7890670">TestWriterSetBoundary</span><span class="op" id="7890691">(</span><span class="ident" id="7890692">t</span>&nbsp;<span class="op" id="7890694">*</span><span class="ident" id="7890695">testing</span><span class="op" id="7890702">.</span><span class="ident" id="7890703">T</span><span class="op" id="7890704">)</span>&nbsp;<span class="op" id="7890706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890709">var</span>&nbsp;<span class="ident" id="7890713">b</span>&nbsp;<span class="ident" id="7890715">bytes</span><span class="op" id="7890720">.</span><span class="ident" id="7890721">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890729">w</span>&nbsp;<span class="op" id="7890731">:=</span>&nbsp;<span class="ident" id="7890734">NewWriter</span><span class="op" id="7890743">(</span><span class="op" id="7890744">&amp;</span><span class="ident" id="7890745">b</span><span class="op" id="7890746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890749">tests</span>&nbsp;<span class="op" id="7890755">:=</span>&nbsp;<span class="op" id="7890758">[</span><span class="op" id="7890759">]</span><span class="keyword" id="7890760">struct</span>&nbsp;<span class="op" id="7890767">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890771">b</span>&nbsp;&nbsp;<span class="builtintype" id="7890774">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890783">ok</span>&nbsp;<span class="builtintype" id="7890786">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890792">}</span><span class="op" id="7890793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890797">{</span><span class="string" id="7890798">&#34;abc&#34;</span><span class="op" id="7890803">,</span>&nbsp;<span class="builtintype" id="7890805">true</span><span class="op" id="7890809">}</span><span class="op" id="7890810">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890814">{</span><span class="string" id="7890815">&#34;&#34;</span><span class="op" id="7890817">,</span>&nbsp;<span class="builtintype" id="7890819">false</span><span class="op" id="7890824">}</span><span class="op" id="7890825">,</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890829">{</span><span class="string" id="7890830">&#34;ungültig&#34;</span><span class="op" id="7890841">,</span>&nbsp;<span class="builtintype" id="7890843">false</span><span class="op" id="7890848">}</span><span class="op" id="7890849">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890853">{</span><span class="string" id="7890854">&#34;!&#34;</span><span class="op" id="7890857">,</span>&nbsp;<span class="builtintype" id="7890859">false</span><span class="op" id="7890864">}</span><span class="op" id="7890865">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890869">{</span><span class="ident" id="7890870">strings</span><span class="op" id="7890877">.</span><span class="ident" id="7890878">Repeat</span><span class="op" id="7890884">(</span><span class="string" id="7890885">&#34;x&#34;</span><span class="op" id="7890888">,</span>&nbsp;<span class="num" id="7890890">69</span><span class="op" id="7890892">)</span><span class="op" id="7890893">,</span>&nbsp;<span class="builtintype" id="7890895">true</span><span class="op" id="7890899">}</span><span class="op" id="7890900">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890904">{</span><span class="ident" id="7890905">strings</span><span class="op" id="7890912">.</span><span class="ident" id="7890913">Repeat</span><span class="op" id="7890919">(</span><span class="string" id="7890920">&#34;x&#34;</span><span class="op" id="7890923">,</span>&nbsp;<span class="num" id="7890925">70</span><span class="op" id="7890927">)</span><span class="op" id="7890928">,</span>&nbsp;<span class="builtintype" id="7890930">false</span><span class="op" id="7890935">}</span><span class="op" id="7890936">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890940">{</span><span class="string" id="7890941">&#34;bad!ascii!&#34;</span><span class="op" id="7890953">,</span>&nbsp;<span class="builtintype" id="7890955">false</span><span class="op" id="7890960">}</span><span class="op" id="7890961">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890965">{</span><span class="string" id="7890966">&#34;my-separator&#34;</span><span class="op" id="7890980">,</span>&nbsp;<span class="builtintype" id="7890982">true</span><span class="op" id="7890986">}</span><span class="op" id="7890987">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890993">for</span>&nbsp;<span class="ident" id="7890997">i</span><span class="op" id="7890998">,</span>&nbsp;<span class="ident" id="7891000">tt</span>&nbsp;<span class="op" id="7891003">:=</span>&nbsp;<span class="keyword" id="7891006">range</span>&nbsp;<span class="ident" id="7891012">tests</span>&nbsp;<span class="op" id="7891018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891022">err</span>&nbsp;<span class="op" id="7891026">:=</span>&nbsp;<span class="ident" id="7891029">w</span><span class="op" id="7891030">.</span><span class="ident" id="7891031">SetBoundary</span><span class="op" id="7891042">(</span><span class="ident" id="7891043">tt</span><span class="op" id="7891045">.</span><span class="ident" id="7891046">b</span><span class="op" id="7891047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891051">got</span>&nbsp;<span class="op" id="7891055">:=</span>&nbsp;<span class="ident" id="7891058">err</span>&nbsp;<span class="op" id="7891062">==</span>&nbsp;<span class="ident" id="7891065">nil</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7891071">if</span>&nbsp;<span class="ident" id="7891074">got</span>&nbsp;<span class="op" id="7891078">!=</span>&nbsp;<span class="ident" id="7891081">tt</span><span class="op" id="7891083">.</span><span class="ident" id="7891084">ok</span>&nbsp;<span class="op" id="7891087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891092">t</span><span class="op" id="7891093">.</span><span class="ident" id="7891094">Errorf</span><span class="op" id="7891100">(</span><span class="string" id="7891101">&#34;%d.&nbsp;boundary&nbsp;%q&nbsp;=&nbsp;%v&nbsp;(%v);&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7891137">,</span>&nbsp;<span class="ident" id="7891139">i</span><span class="op" id="7891140">,</span>&nbsp;<span class="ident" id="7891142">tt</span><span class="op" id="7891144">.</span><span class="ident" id="7891145">b</span><span class="op" id="7891146">,</span>&nbsp;<span class="ident" id="7891148">got</span><span class="op" id="7891151">,</span>&nbsp;<span class="ident" id="7891153">err</span><span class="op" id="7891156">,</span>&nbsp;<span class="ident" id="7891158">tt</span><span class="op" id="7891160">.</span><span class="ident" id="7891161">ok</span><span class="op" id="7891163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7891167">}</span>&nbsp;<span class="keyword" id="7891169">else</span>&nbsp;<span class="keyword" id="7891174">if</span>&nbsp;<span class="ident" id="7891177">tt</span><span class="op" id="7891179">.</span><span class="ident" id="7891180">ok</span>&nbsp;<span class="op" id="7891183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891188">got</span>&nbsp;<span class="op" id="7891192">:=</span>&nbsp;<span class="ident" id="7891195">w</span><span class="op" id="7891196">.</span><span class="ident" id="7891197">Boundary</span><span class="op" id="7891205">(</span><span class="op" id="7891206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7891211">if</span>&nbsp;<span class="ident" id="7891214">got</span>&nbsp;<span class="op" id="7891218">!=</span>&nbsp;<span class="ident" id="7891221">tt</span><span class="op" id="7891223">.</span><span class="ident" id="7891224">b</span>&nbsp;<span class="op" id="7891226">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891232">t</span><span class="op" id="7891233">.</span><span class="ident" id="7891234">Errorf</span><span class="op" id="7891240">(</span><span class="string" id="7891241">&#34;boundary&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7891265">,</span>&nbsp;<span class="ident" id="7891267">got</span><span class="op" id="7891270">,</span>&nbsp;<span class="ident" id="7891272">tt</span><span class="op" id="7891274">.</span><span class="ident" id="7891275">b</span><span class="op" id="7891276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7891281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7891285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7891288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891291">w</span><span class="op" id="7891292">.</span><span class="ident" id="7891293">Close</span><span class="op" id="7891298">(</span><span class="op" id="7891299">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7891302">if</span>&nbsp;<span class="ident" id="7891305">got</span>&nbsp;<span class="op" id="7891309">:=</span>&nbsp;<span class="ident" id="7891312">b</span><span class="op" id="7891313">.</span><span class="ident" id="7891314">String</span><span class="op" id="7891320">(</span><span class="op" id="7891321">)</span><span class="op" id="7891322">;</span>&nbsp;<span class="op" id="7891324">!</span><span class="ident" id="7891325">strings</span><span class="op" id="7891332">.</span><span class="ident" id="7891333">Contains</span><span class="op" id="7891341">(</span><span class="ident" id="7891342">got</span><span class="op" id="7891345">,</span>&nbsp;<span class="string" id="7891347">&#34;\r\n--my-separator--\r\n&#34;</span><span class="op" id="7891373">)</span>&nbsp;<span class="op" id="7891375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891379">t</span><span class="op" id="7891380">.</span><span class="ident" id="7891381">Errorf</span><span class="op" id="7891387">(</span><span class="string" id="7891388">&#34;expected&nbsp;my-separator&nbsp;in&nbsp;output.&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="7891430">,</span>&nbsp;<span class="ident" id="7891432">got</span><span class="op" id="7891435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7891438">}</span><br>
<span class="lineno"></span><span class="op" id="7891440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="7891443">func</span>&nbsp;<span class="ident" id="7891448">TestWriterBoundaryGoroutines</span><span class="op" id="7891476">(</span><span class="ident" id="7891477">t</span>&nbsp;<span class="op" id="7891479">*</span><span class="ident" id="7891480">testing</span><span class="op" id="7891487">.</span><span class="ident" id="7891488">T</span><span class="op" id="7891489">)</span>&nbsp;<span class="op" id="7891491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7891494">//&nbsp;Verify&nbsp;there&#39;s&nbsp;no&nbsp;data&nbsp;race&nbsp;accessing&nbsp;any&nbsp;lazy&nbsp;boundary&nbsp;if&nbsp;it&#39;s&nbsp;used&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7891570">//&nbsp;different&nbsp;goroutines.&nbsp;This&nbsp;was&nbsp;previously&nbsp;broken&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7891626">//&nbsp;https://codereview.appspot.com/95760043/&nbsp;and&nbsp;reverted&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7891687">//&nbsp;https://codereview.appspot.com/117600043/</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891733">w</span>&nbsp;<span class="op" id="7891735">:=</span>&nbsp;<span class="ident" id="7891738">NewWriter</span><span class="op" id="7891747">(</span><span class="ident" id="7891748">ioutil</span><span class="op" id="7891754">.</span><span class="ident" id="7891755">Discard</span><span class="op" id="7891762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891765">done</span>&nbsp;<span class="op" id="7891770">:=</span>&nbsp;<span class="builtinfunc" id="7891773">make</span><span class="op" id="7891777">(</span><span class="keyword" id="7891778">chan</span>&nbsp;<span class="builtintype" id="7891783">int</span><span class="op" id="7891786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7891789">go</span>&nbsp;<span class="keyword" id="7891792">func</span><span class="op" id="7891796">(</span><span class="op" id="7891797">)</span>&nbsp;<span class="op" id="7891799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891803">w</span><span class="op" id="7891804">.</span><span class="ident" id="7891805">CreateFormField</span><span class="op" id="7891820">(</span><span class="string" id="7891821">&#34;foo&#34;</span><span class="op" id="7891826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891830">done</span>&nbsp;<span class="op" id="7891835">&lt;-</span>&nbsp;<span class="num" id="7891838">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7891841">}</span><span class="op" id="7891842">(</span><span class="op" id="7891843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891846">w</span><span class="op" id="7891847">.</span><span class="ident" id="7891848">Boundary</span><span class="op" id="7891856">(</span><span class="op" id="7891857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7891860">&lt;-</span><span class="ident" id="7891862">done</span><br>
<span class="lineno"></span><span class="op" id="7891867">}</span>
</div>
</body>
</html>
