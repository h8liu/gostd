<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html" class="current">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1651105">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1651160">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1651214">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1651265">package</span>&nbsp;<span class="ident" id="1651273">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1651282">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;select&nbsp;statements.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1651349">import</span>&nbsp;<span class="string" id="1651356">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1651366">const</span>&nbsp;<span class="op" id="1651372">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651375">debugSelect</span>&nbsp;<span class="op" id="1651387">=</span>&nbsp;<span class="builtintype" id="1651389">false</span><br>
<span class="lineno"></span><span class="op" id="1651395">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="1651398">var</span>&nbsp;<span class="op" id="1651402">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651405">chansendpc</span>&nbsp;<span class="op" id="1651416">=</span>&nbsp;<span class="ident" id="1651418">funcPC</span><span class="op" id="1651424">(</span><span class="ident" id="1651425">chansend</span><span class="op" id="1651433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651436">chanrecvpc</span>&nbsp;<span class="op" id="1651447">=</span>&nbsp;<span class="ident" id="1651449">funcPC</span><span class="op" id="1651455">(</span><span class="ident" id="1651456">chanrecv</span><span class="op" id="1651464">)</span><br>
<span class="lineno"></span><span class="op" id="1651466">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1651469">func</span>&nbsp;<span class="ident" id="1651474">selectsize</span><span class="op" id="1651484">(</span><span class="ident" id="1651485">size</span>&nbsp;<span class="builtintype" id="1651490">uintptr</span><span class="op" id="1651497">)</span>&nbsp;<span class="builtintype" id="1651499">uintptr</span>&nbsp;<span class="op" id="1651507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651510">selsize</span>&nbsp;<span class="op" id="1651518">:=</span>&nbsp;<span class="ident" id="1651521">unsafe</span><span class="op" id="1651527">.</span><span class="ident" id="1651528">Sizeof</span><span class="op" id="1651534">(</span><span class="ident" id="1651535">_select</span><span class="op" id="1651542">{</span><span class="op" id="1651543">}</span><span class="op" id="1651544">)</span>&nbsp;<span class="op" id="1651546">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1651550">(</span><span class="ident" id="1651551">size</span><span class="op" id="1651555">-</span><span class="num" id="1651556">1</span><span class="op" id="1651557">)</span><span class="op" id="1651558">*</span><span class="ident" id="1651559">unsafe</span><span class="op" id="1651565">.</span><span class="ident" id="1651566">Sizeof</span><span class="op" id="1651572">(</span><span class="ident" id="1651573">_select</span><span class="op" id="1651580">{</span><span class="op" id="1651581">}</span><span class="op" id="1651582">.</span><span class="ident" id="1651583">scase</span><span class="op" id="1651588">[</span><span class="num" id="1651589">0</span><span class="op" id="1651590">]</span><span class="op" id="1651591">)</span>&nbsp;<span class="op" id="1651593">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651597">size</span><span class="op" id="1651601">*</span><span class="ident" id="1651602">unsafe</span><span class="op" id="1651608">.</span><span class="ident" id="1651609">Sizeof</span><span class="op" id="1651615">(</span><span class="op" id="1651616">*</span><span class="ident" id="1651617">_select</span><span class="op" id="1651624">{</span><span class="op" id="1651625">}</span><span class="op" id="1651626">.</span><span class="ident" id="1651627">lockorder</span><span class="op" id="1651636">)</span>&nbsp;<span class="op" id="1651638">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651642">size</span><span class="op" id="1651646">*</span><span class="ident" id="1651647">unsafe</span><span class="op" id="1651653">.</span><span class="ident" id="1651654">Sizeof</span><span class="op" id="1651660">(</span><span class="op" id="1651661">*</span><span class="ident" id="1651662">_select</span><span class="op" id="1651669">{</span><span class="op" id="1651670">}</span><span class="op" id="1651671">.</span><span class="ident" id="1651672">pollorder</span><span class="op" id="1651681">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651684">return</span>&nbsp;<span class="ident" id="1651691">round</span><span class="op" id="1651696">(</span><span class="ident" id="1651697">selsize</span><span class="op" id="1651704">,</span>&nbsp;<span class="ident" id="1651706">_Int64Align</span><span class="op" id="1651717">)</span><br>
<span class="lineno"></span><span class="op" id="1651719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1651722">func</span>&nbsp;<span class="ident" id="1651727">newselect</span><span class="op" id="1651736">(</span><span class="ident" id="1651737">sel</span>&nbsp;<span class="op" id="1651741">*</span><span class="ident" id="1651742">_select</span><span class="op" id="1651749">,</span>&nbsp;<span class="ident" id="1651751">selsize</span>&nbsp;<span class="ident" id="1651759">int64</span><span class="op" id="1651764">,</span>&nbsp;<span class="ident" id="1651766">size</span>&nbsp;<span class="builtintype" id="1651771">int32</span><span class="op" id="1651776">)</span>&nbsp;<span class="op" id="1651778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651781">if</span>&nbsp;<span class="ident" id="1651784">selsize</span>&nbsp;<span class="op" id="1651792">!=</span>&nbsp;<span class="ident" id="1651795">int64</span><span class="op" id="1651800">(</span><span class="ident" id="1651801">selectsize</span><span class="op" id="1651811">(</span><span class="builtintype" id="1651812">uintptr</span><span class="op" id="1651819">(</span><span class="ident" id="1651820">size</span><span class="op" id="1651824">)</span><span class="op" id="1651825">)</span><span class="op" id="1651826">)</span>&nbsp;<span class="op" id="1651828">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1651832">print</span><span class="op" id="1651837">(</span><span class="string" id="1651838">&#34;runtime:&nbsp;bad&nbsp;select&nbsp;size&nbsp;&#34;</span><span class="op" id="1651865">,</span>&nbsp;<span class="ident" id="1651867">selsize</span><span class="op" id="1651874">,</span>&nbsp;<span class="string" id="1651876">&#34;,&nbsp;want&nbsp;&#34;</span><span class="op" id="1651885">,</span>&nbsp;<span class="ident" id="1651887">selectsize</span><span class="op" id="1651897">(</span><span class="builtintype" id="1651898">uintptr</span><span class="op" id="1651905">(</span><span class="ident" id="1651906">size</span><span class="op" id="1651910">)</span><span class="op" id="1651911">)</span><span class="op" id="1651912">,</span>&nbsp;<span class="string" id="1651914">&#34;\n&#34;</span><span class="op" id="1651918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651922">gothrow</span><span class="op" id="1651929">(</span><span class="string" id="1651930">&#34;bad&nbsp;select&nbsp;size&#34;</span><span class="op" id="1651947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1651950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651953">sel</span><span class="op" id="1651956">.</span><span class="ident" id="1651957">tcase</span>&nbsp;<span class="op" id="1651963">=</span>&nbsp;<span class="builtintype" id="1651965">uint16</span><span class="op" id="1651971">(</span><span class="ident" id="1651972">size</span><span class="op" id="1651976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651979">sel</span><span class="op" id="1651982">.</span><span class="ident" id="1651983">ncase</span>&nbsp;<span class="op" id="1651989">=</span>&nbsp;<span class="num" id="1651991">0</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651994">sel</span><span class="op" id="1651997">.</span><span class="ident" id="1651998">lockorder</span>&nbsp;<span class="op" id="1652008">=</span>&nbsp;<span class="op" id="1652010">(</span><span class="op" id="1652011">*</span><span class="op" id="1652012">*</span><span class="ident" id="1652013">hchan</span><span class="op" id="1652018">)</span><span class="op" id="1652019">(</span><span class="ident" id="1652020">add</span><span class="op" id="1652023">(</span><span class="ident" id="1652024">unsafe</span><span class="op" id="1652030">.</span><span class="ident" id="1652031">Pointer</span><span class="op" id="1652038">(</span><span class="op" id="1652039">&amp;</span><span class="ident" id="1652040">sel</span><span class="op" id="1652043">.</span><span class="ident" id="1652044">scase</span><span class="op" id="1652049">)</span><span class="op" id="1652050">,</span>&nbsp;<span class="builtintype" id="1652052">uintptr</span><span class="op" id="1652059">(</span><span class="ident" id="1652060">size</span><span class="op" id="1652064">)</span><span class="op" id="1652065">*</span><span class="ident" id="1652066">unsafe</span><span class="op" id="1652072">.</span><span class="ident" id="1652073">Sizeof</span><span class="op" id="1652079">(</span><span class="ident" id="1652080">_select</span><span class="op" id="1652087">{</span><span class="op" id="1652088">}</span><span class="op" id="1652089">.</span><span class="ident" id="1652090">scase</span><span class="op" id="1652095">[</span><span class="num" id="1652096">0</span><span class="op" id="1652097">]</span><span class="op" id="1652098">)</span><span class="op" id="1652099">)</span><span class="op" id="1652100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652103">sel</span><span class="op" id="1652106">.</span><span class="ident" id="1652107">pollorder</span>&nbsp;<span class="op" id="1652117">=</span>&nbsp;<span class="op" id="1652119">(</span><span class="op" id="1652120">*</span><span class="builtintype" id="1652121">uint16</span><span class="op" id="1652127">)</span><span class="op" id="1652128">(</span><span class="ident" id="1652129">add</span><span class="op" id="1652132">(</span><span class="ident" id="1652133">unsafe</span><span class="op" id="1652139">.</span><span class="ident" id="1652140">Pointer</span><span class="op" id="1652147">(</span><span class="ident" id="1652148">sel</span><span class="op" id="1652151">.</span><span class="ident" id="1652152">lockorder</span><span class="op" id="1652161">)</span><span class="op" id="1652162">,</span>&nbsp;<span class="builtintype" id="1652164">uintptr</span><span class="op" id="1652171">(</span><span class="ident" id="1652172">size</span><span class="op" id="1652176">)</span><span class="op" id="1652177">*</span><span class="ident" id="1652178">unsafe</span><span class="op" id="1652184">.</span><span class="ident" id="1652185">Sizeof</span><span class="op" id="1652191">(</span><span class="op" id="1652192">*</span><span class="ident" id="1652193">_select</span><span class="op" id="1652200">{</span><span class="op" id="1652201">}</span><span class="op" id="1652202">.</span><span class="ident" id="1652203">lockorder</span><span class="op" id="1652212">)</span><span class="op" id="1652213">)</span><span class="op" id="1652214">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652218">if</span>&nbsp;<span class="ident" id="1652221">debugSelect</span>&nbsp;<span class="op" id="1652233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1652237">print</span><span class="op" id="1652242">(</span><span class="string" id="1652243">&#34;newselect&nbsp;s=&#34;</span><span class="op" id="1652257">,</span>&nbsp;<span class="ident" id="1652259">sel</span><span class="op" id="1652262">,</span>&nbsp;<span class="string" id="1652264">&#34;&nbsp;size=&#34;</span><span class="op" id="1652272">,</span>&nbsp;<span class="ident" id="1652274">size</span><span class="op" id="1652278">,</span>&nbsp;<span class="string" id="1652280">&#34;\n&#34;</span><span class="op" id="1652284">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652287">}</span><br>
<span class="lineno"></span><span class="op" id="1652289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1652292">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1652305">func</span>&nbsp;<span class="ident" id="1652310">selectsend</span><span class="op" id="1652320">(</span><span class="ident" id="1652321">sel</span>&nbsp;<span class="op" id="1652325">*</span><span class="ident" id="1652326">_select</span><span class="op" id="1652333">,</span>&nbsp;<span class="ident" id="1652335">c</span>&nbsp;<span class="op" id="1652337">*</span><span class="ident" id="1652338">hchan</span><span class="op" id="1652343">,</span>&nbsp;<span class="ident" id="1652345">elem</span>&nbsp;<span class="ident" id="1652350">unsafe</span><span class="op" id="1652356">.</span><span class="ident" id="1652357">Pointer</span><span class="op" id="1652364">)</span>&nbsp;<span class="op" id="1652366">(</span><span class="ident" id="1652367">selected</span>&nbsp;<span class="builtintype" id="1652376">bool</span><span class="op" id="1652380">)</span>&nbsp;<span class="op" id="1652382">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1652385">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652414">if</span>&nbsp;<span class="ident" id="1652417">c</span>&nbsp;<span class="op" id="1652419">!=</span>&nbsp;<span class="builtintype" id="1652422">nil</span>&nbsp;<span class="op" id="1652426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652430">selectsendImpl</span><span class="op" id="1652444">(</span><span class="ident" id="1652445">sel</span><span class="op" id="1652448">,</span>&nbsp;<span class="ident" id="1652450">c</span><span class="op" id="1652451">,</span>&nbsp;<span class="ident" id="1652453">getcallerpc</span><span class="op" id="1652464">(</span><span class="ident" id="1652465">unsafe</span><span class="op" id="1652471">.</span><span class="ident" id="1652472">Pointer</span><span class="op" id="1652479">(</span><span class="op" id="1652480">&amp;</span><span class="ident" id="1652481">sel</span><span class="op" id="1652484">)</span><span class="op" id="1652485">)</span><span class="op" id="1652486">,</span>&nbsp;<span class="ident" id="1652488">elem</span><span class="op" id="1652492">,</span>&nbsp;<span class="builtintype" id="1652494">uintptr</span><span class="op" id="1652501">(</span><span class="ident" id="1652502">unsafe</span><span class="op" id="1652508">.</span><span class="ident" id="1652509">Pointer</span><span class="op" id="1652516">(</span><span class="op" id="1652517">&amp;</span><span class="ident" id="1652518">selected</span><span class="op" id="1652526">)</span><span class="op" id="1652527">)</span><span class="op" id="1652528">-</span><span class="builtintype" id="1652529">uintptr</span><span class="op" id="1652536">(</span><span class="ident" id="1652537">unsafe</span><span class="op" id="1652543">.</span><span class="ident" id="1652544">Pointer</span><span class="op" id="1652551">(</span><span class="op" id="1652552">&amp;</span><span class="ident" id="1652553">sel</span><span class="op" id="1652556">)</span><span class="op" id="1652557">)</span><span class="op" id="1652558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652564">return</span><br>
<span class="lineno">50</span><span class="op" id="1652571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1652574">//&nbsp;cut&nbsp;in&nbsp;half&nbsp;to&nbsp;give&nbsp;stack&nbsp;a&nbsp;chance&nbsp;to&nbsp;split</span><br>
<span class="lineno"></span><span class="keyword" id="1652621">func</span>&nbsp;<span class="ident" id="1652626">selectsendImpl</span><span class="op" id="1652640">(</span><span class="ident" id="1652641">sel</span>&nbsp;<span class="op" id="1652645">*</span><span class="ident" id="1652646">_select</span><span class="op" id="1652653">,</span>&nbsp;<span class="ident" id="1652655">c</span>&nbsp;<span class="op" id="1652657">*</span><span class="ident" id="1652658">hchan</span><span class="op" id="1652663">,</span>&nbsp;<span class="ident" id="1652665">pc</span>&nbsp;<span class="builtintype" id="1652668">uintptr</span><span class="op" id="1652675">,</span>&nbsp;<span class="ident" id="1652677">elem</span>&nbsp;<span class="ident" id="1652682">unsafe</span><span class="op" id="1652688">.</span><span class="ident" id="1652689">Pointer</span><span class="op" id="1652696">,</span>&nbsp;<span class="ident" id="1652698">so</span>&nbsp;<span class="builtintype" id="1652701">uintptr</span><span class="op" id="1652708">)</span>&nbsp;<span class="op" id="1652710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652713">i</span>&nbsp;<span class="op" id="1652715">:=</span>&nbsp;<span class="ident" id="1652718">sel</span><span class="op" id="1652721">.</span><span class="ident" id="1652722">ncase</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652729">if</span>&nbsp;<span class="ident" id="1652732">i</span>&nbsp;<span class="op" id="1652734">&gt;=</span>&nbsp;<span class="ident" id="1652737">sel</span><span class="op" id="1652740">.</span><span class="ident" id="1652741">tcase</span>&nbsp;<span class="op" id="1652747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652751">gothrow</span><span class="op" id="1652758">(</span><span class="string" id="1652759">&#34;selectsend:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1652787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652793">sel</span><span class="op" id="1652796">.</span><span class="ident" id="1652797">ncase</span>&nbsp;<span class="op" id="1652803">=</span>&nbsp;<span class="ident" id="1652805">i</span>&nbsp;<span class="op" id="1652807">+</span>&nbsp;<span class="num" id="1652809">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652812">cas</span>&nbsp;<span class="op" id="1652816">:=</span>&nbsp;<span class="op" id="1652819">(</span><span class="op" id="1652820">*</span><span class="ident" id="1652821">scase</span><span class="op" id="1652826">)</span><span class="op" id="1652827">(</span><span class="ident" id="1652828">add</span><span class="op" id="1652831">(</span><span class="ident" id="1652832">unsafe</span><span class="op" id="1652838">.</span><span class="ident" id="1652839">Pointer</span><span class="op" id="1652846">(</span><span class="op" id="1652847">&amp;</span><span class="ident" id="1652848">sel</span><span class="op" id="1652851">.</span><span class="ident" id="1652852">scase</span><span class="op" id="1652857">)</span><span class="op" id="1652858">,</span>&nbsp;<span class="builtintype" id="1652860">uintptr</span><span class="op" id="1652867">(</span><span class="ident" id="1652868">i</span><span class="op" id="1652869">)</span><span class="op" id="1652870">*</span><span class="ident" id="1652871">unsafe</span><span class="op" id="1652877">.</span><span class="ident" id="1652878">Sizeof</span><span class="op" id="1652884">(</span><span class="ident" id="1652885">sel</span><span class="op" id="1652888">.</span><span class="ident" id="1652889">scase</span><span class="op" id="1652894">[</span><span class="num" id="1652895">0</span><span class="op" id="1652896">]</span><span class="op" id="1652897">)</span><span class="op" id="1652898">)</span><span class="op" id="1652899">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652903">cas</span><span class="op" id="1652906">.</span><span class="ident" id="1652907">pc</span>&nbsp;<span class="op" id="1652910">=</span>&nbsp;<span class="ident" id="1652912">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652916">cas</span><span class="op" id="1652919">.</span><span class="ident" id="1652920">_chan</span>&nbsp;<span class="op" id="1652926">=</span>&nbsp;<span class="ident" id="1652928">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652931">cas</span><span class="op" id="1652934">.</span><span class="ident" id="1652935">so</span>&nbsp;<span class="op" id="1652938">=</span>&nbsp;<span class="builtintype" id="1652940">uint16</span><span class="op" id="1652946">(</span><span class="ident" id="1652947">so</span><span class="op" id="1652949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652952">cas</span><span class="op" id="1652955">.</span><span class="ident" id="1652956">kind</span>&nbsp;<span class="op" id="1652961">=</span>&nbsp;<span class="ident" id="1652963">_CaseSend</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652974">cas</span><span class="op" id="1652977">.</span><span class="ident" id="1652978">elem</span>&nbsp;<span class="op" id="1652983">=</span>&nbsp;<span class="ident" id="1652985">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652992">if</span>&nbsp;<span class="ident" id="1652995">debugSelect</span>&nbsp;<span class="op" id="1653007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1653011">print</span><span class="op" id="1653016">(</span><span class="string" id="1653017">&#34;selectsend&nbsp;s=&#34;</span><span class="op" id="1653032">,</span>&nbsp;<span class="ident" id="1653034">sel</span><span class="op" id="1653037">,</span>&nbsp;<span class="string" id="1653039">&#34;&nbsp;pc=&#34;</span><span class="op" id="1653045">,</span>&nbsp;<span class="ident" id="1653047">hex</span><span class="op" id="1653050">(</span><span class="ident" id="1653051">cas</span><span class="op" id="1653054">.</span><span class="ident" id="1653055">pc</span><span class="op" id="1653057">)</span><span class="op" id="1653058">,</span>&nbsp;<span class="string" id="1653060">&#34;&nbsp;chan=&#34;</span><span class="op" id="1653068">,</span>&nbsp;<span class="ident" id="1653070">cas</span><span class="op" id="1653073">.</span><span class="ident" id="1653074">_chan</span><span class="op" id="1653079">,</span>&nbsp;<span class="string" id="1653081">&#34;&nbsp;so=&#34;</span><span class="op" id="1653087">,</span>&nbsp;<span class="ident" id="1653089">cas</span><span class="op" id="1653092">.</span><span class="ident" id="1653093">so</span><span class="op" id="1653095">,</span>&nbsp;<span class="string" id="1653097">&#34;\n&#34;</span><span class="op" id="1653101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653104">}</span><br>
<span class="lineno">70</span><span class="op" id="1653106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1653109">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1653122">func</span>&nbsp;<span class="ident" id="1653127">selectrecv</span><span class="op" id="1653137">(</span><span class="ident" id="1653138">sel</span>&nbsp;<span class="op" id="1653142">*</span><span class="ident" id="1653143">_select</span><span class="op" id="1653150">,</span>&nbsp;<span class="ident" id="1653152">c</span>&nbsp;<span class="op" id="1653154">*</span><span class="ident" id="1653155">hchan</span><span class="op" id="1653160">,</span>&nbsp;<span class="ident" id="1653162">elem</span>&nbsp;<span class="ident" id="1653167">unsafe</span><span class="op" id="1653173">.</span><span class="ident" id="1653174">Pointer</span><span class="op" id="1653181">)</span>&nbsp;<span class="op" id="1653183">(</span><span class="ident" id="1653184">selected</span>&nbsp;<span class="builtintype" id="1653193">bool</span><span class="op" id="1653197">)</span>&nbsp;<span class="op" id="1653199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1653202">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653231">if</span>&nbsp;<span class="ident" id="1653234">c</span>&nbsp;<span class="op" id="1653236">!=</span>&nbsp;<span class="builtintype" id="1653239">nil</span>&nbsp;<span class="op" id="1653243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653247">selectrecvImpl</span><span class="op" id="1653261">(</span><span class="ident" id="1653262">sel</span><span class="op" id="1653265">,</span>&nbsp;<span class="ident" id="1653267">c</span><span class="op" id="1653268">,</span>&nbsp;<span class="ident" id="1653270">getcallerpc</span><span class="op" id="1653281">(</span><span class="ident" id="1653282">unsafe</span><span class="op" id="1653288">.</span><span class="ident" id="1653289">Pointer</span><span class="op" id="1653296">(</span><span class="op" id="1653297">&amp;</span><span class="ident" id="1653298">sel</span><span class="op" id="1653301">)</span><span class="op" id="1653302">)</span><span class="op" id="1653303">,</span>&nbsp;<span class="ident" id="1653305">elem</span><span class="op" id="1653309">,</span>&nbsp;<span class="builtintype" id="1653311">nil</span><span class="op" id="1653314">,</span>&nbsp;<span class="builtintype" id="1653316">uintptr</span><span class="op" id="1653323">(</span><span class="ident" id="1653324">unsafe</span><span class="op" id="1653330">.</span><span class="ident" id="1653331">Pointer</span><span class="op" id="1653338">(</span><span class="op" id="1653339">&amp;</span><span class="ident" id="1653340">selected</span><span class="op" id="1653348">)</span><span class="op" id="1653349">)</span><span class="op" id="1653350">-</span><span class="builtintype" id="1653351">uintptr</span><span class="op" id="1653358">(</span><span class="ident" id="1653359">unsafe</span><span class="op" id="1653365">.</span><span class="ident" id="1653366">Pointer</span><span class="op" id="1653373">(</span><span class="op" id="1653374">&amp;</span><span class="ident" id="1653375">sel</span><span class="op" id="1653378">)</span><span class="op" id="1653379">)</span><span class="op" id="1653380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653386">return</span><br>
<span class="lineno"></span><span class="op" id="1653393">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="comment" id="1653396">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1653409">func</span>&nbsp;<span class="ident" id="1653414">selectrecv2</span><span class="op" id="1653425">(</span><span class="ident" id="1653426">sel</span>&nbsp;<span class="op" id="1653430">*</span><span class="ident" id="1653431">_select</span><span class="op" id="1653438">,</span>&nbsp;<span class="ident" id="1653440">c</span>&nbsp;<span class="op" id="1653442">*</span><span class="ident" id="1653443">hchan</span><span class="op" id="1653448">,</span>&nbsp;<span class="ident" id="1653450">elem</span>&nbsp;<span class="ident" id="1653455">unsafe</span><span class="op" id="1653461">.</span><span class="ident" id="1653462">Pointer</span><span class="op" id="1653469">,</span>&nbsp;<span class="ident" id="1653471">received</span>&nbsp;<span class="op" id="1653480">*</span><span class="builtintype" id="1653481">bool</span><span class="op" id="1653485">)</span>&nbsp;<span class="op" id="1653487">(</span><span class="ident" id="1653488">selected</span>&nbsp;<span class="builtintype" id="1653497">bool</span><span class="op" id="1653501">)</span>&nbsp;<span class="op" id="1653503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1653506">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653535">if</span>&nbsp;<span class="ident" id="1653538">c</span>&nbsp;<span class="op" id="1653540">!=</span>&nbsp;<span class="builtintype" id="1653543">nil</span>&nbsp;<span class="op" id="1653547">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653551">selectrecvImpl</span><span class="op" id="1653565">(</span><span class="ident" id="1653566">sel</span><span class="op" id="1653569">,</span>&nbsp;<span class="ident" id="1653571">c</span><span class="op" id="1653572">,</span>&nbsp;<span class="ident" id="1653574">getcallerpc</span><span class="op" id="1653585">(</span><span class="ident" id="1653586">unsafe</span><span class="op" id="1653592">.</span><span class="ident" id="1653593">Pointer</span><span class="op" id="1653600">(</span><span class="op" id="1653601">&amp;</span><span class="ident" id="1653602">sel</span><span class="op" id="1653605">)</span><span class="op" id="1653606">)</span><span class="op" id="1653607">,</span>&nbsp;<span class="ident" id="1653609">elem</span><span class="op" id="1653613">,</span>&nbsp;<span class="ident" id="1653615">received</span><span class="op" id="1653623">,</span>&nbsp;<span class="builtintype" id="1653625">uintptr</span><span class="op" id="1653632">(</span><span class="ident" id="1653633">unsafe</span><span class="op" id="1653639">.</span><span class="ident" id="1653640">Pointer</span><span class="op" id="1653647">(</span><span class="op" id="1653648">&amp;</span><span class="ident" id="1653649">selected</span><span class="op" id="1653657">)</span><span class="op" id="1653658">)</span><span class="op" id="1653659">-</span><span class="builtintype" id="1653660">uintptr</span><span class="op" id="1653667">(</span><span class="ident" id="1653668">unsafe</span><span class="op" id="1653674">.</span><span class="ident" id="1653675">Pointer</span><span class="op" id="1653682">(</span><span class="op" id="1653683">&amp;</span><span class="ident" id="1653684">sel</span><span class="op" id="1653687">)</span><span class="op" id="1653688">)</span><span class="op" id="1653689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653695">return</span><br>
<span class="lineno"></span><span class="op" id="1653702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="1653705">func</span>&nbsp;<span class="ident" id="1653710">selectrecvImpl</span><span class="op" id="1653724">(</span><span class="ident" id="1653725">sel</span>&nbsp;<span class="op" id="1653729">*</span><span class="ident" id="1653730">_select</span><span class="op" id="1653737">,</span>&nbsp;<span class="ident" id="1653739">c</span>&nbsp;<span class="op" id="1653741">*</span><span class="ident" id="1653742">hchan</span><span class="op" id="1653747">,</span>&nbsp;<span class="ident" id="1653749">pc</span>&nbsp;<span class="builtintype" id="1653752">uintptr</span><span class="op" id="1653759">,</span>&nbsp;<span class="ident" id="1653761">elem</span>&nbsp;<span class="ident" id="1653766">unsafe</span><span class="op" id="1653772">.</span><span class="ident" id="1653773">Pointer</span><span class="op" id="1653780">,</span>&nbsp;<span class="ident" id="1653782">received</span>&nbsp;<span class="op" id="1653791">*</span><span class="builtintype" id="1653792">bool</span><span class="op" id="1653796">,</span>&nbsp;<span class="ident" id="1653798">so</span>&nbsp;<span class="builtintype" id="1653801">uintptr</span><span class="op" id="1653808">)</span>&nbsp;<span class="op" id="1653810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653813">i</span>&nbsp;<span class="op" id="1653815">:=</span>&nbsp;<span class="ident" id="1653818">sel</span><span class="op" id="1653821">.</span><span class="ident" id="1653822">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653829">if</span>&nbsp;<span class="ident" id="1653832">i</span>&nbsp;<span class="op" id="1653834">&gt;=</span>&nbsp;<span class="ident" id="1653837">sel</span><span class="op" id="1653840">.</span><span class="ident" id="1653841">tcase</span>&nbsp;<span class="op" id="1653847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653851">gothrow</span><span class="op" id="1653858">(</span><span class="string" id="1653859">&#34;selectrecv:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1653887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653890">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653893">sel</span><span class="op" id="1653896">.</span><span class="ident" id="1653897">ncase</span>&nbsp;<span class="op" id="1653903">=</span>&nbsp;<span class="ident" id="1653905">i</span>&nbsp;<span class="op" id="1653907">+</span>&nbsp;<span class="num" id="1653909">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653912">cas</span>&nbsp;<span class="op" id="1653916">:=</span>&nbsp;<span class="op" id="1653919">(</span><span class="op" id="1653920">*</span><span class="ident" id="1653921">scase</span><span class="op" id="1653926">)</span><span class="op" id="1653927">(</span><span class="ident" id="1653928">add</span><span class="op" id="1653931">(</span><span class="ident" id="1653932">unsafe</span><span class="op" id="1653938">.</span><span class="ident" id="1653939">Pointer</span><span class="op" id="1653946">(</span><span class="op" id="1653947">&amp;</span><span class="ident" id="1653948">sel</span><span class="op" id="1653951">.</span><span class="ident" id="1653952">scase</span><span class="op" id="1653957">)</span><span class="op" id="1653958">,</span>&nbsp;<span class="builtintype" id="1653960">uintptr</span><span class="op" id="1653967">(</span><span class="ident" id="1653968">i</span><span class="op" id="1653969">)</span><span class="op" id="1653970">*</span><span class="ident" id="1653971">unsafe</span><span class="op" id="1653977">.</span><span class="ident" id="1653978">Sizeof</span><span class="op" id="1653984">(</span><span class="ident" id="1653985">sel</span><span class="op" id="1653988">.</span><span class="ident" id="1653989">scase</span><span class="op" id="1653994">[</span><span class="num" id="1653995">0</span><span class="op" id="1653996">]</span><span class="op" id="1653997">)</span><span class="op" id="1653998">)</span><span class="op" id="1653999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654002">cas</span><span class="op" id="1654005">.</span><span class="ident" id="1654006">pc</span>&nbsp;<span class="op" id="1654009">=</span>&nbsp;<span class="ident" id="1654011">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654015">cas</span><span class="op" id="1654018">.</span><span class="ident" id="1654019">_chan</span>&nbsp;<span class="op" id="1654025">=</span>&nbsp;<span class="ident" id="1654027">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654030">cas</span><span class="op" id="1654033">.</span><span class="ident" id="1654034">so</span>&nbsp;<span class="op" id="1654037">=</span>&nbsp;<span class="builtintype" id="1654039">uint16</span><span class="op" id="1654045">(</span><span class="ident" id="1654046">so</span><span class="op" id="1654048">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654051">cas</span><span class="op" id="1654054">.</span><span class="ident" id="1654055">kind</span>&nbsp;<span class="op" id="1654060">=</span>&nbsp;<span class="ident" id="1654062">_CaseRecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654073">cas</span><span class="op" id="1654076">.</span><span class="ident" id="1654077">elem</span>&nbsp;<span class="op" id="1654082">=</span>&nbsp;<span class="ident" id="1654084">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654090">cas</span><span class="op" id="1654093">.</span><span class="ident" id="1654094">receivedp</span>&nbsp;<span class="op" id="1654104">=</span>&nbsp;<span class="ident" id="1654106">received</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1654117">if</span>&nbsp;<span class="ident" id="1654120">debugSelect</span>&nbsp;<span class="op" id="1654132">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1654136">print</span><span class="op" id="1654141">(</span><span class="string" id="1654142">&#34;selectrecv&nbsp;s=&#34;</span><span class="op" id="1654157">,</span>&nbsp;<span class="ident" id="1654159">sel</span><span class="op" id="1654162">,</span>&nbsp;<span class="string" id="1654164">&#34;&nbsp;pc=&#34;</span><span class="op" id="1654170">,</span>&nbsp;<span class="ident" id="1654172">hex</span><span class="op" id="1654175">(</span><span class="ident" id="1654176">cas</span><span class="op" id="1654179">.</span><span class="ident" id="1654180">pc</span><span class="op" id="1654182">)</span><span class="op" id="1654183">,</span>&nbsp;<span class="string" id="1654185">&#34;&nbsp;chan=&#34;</span><span class="op" id="1654193">,</span>&nbsp;<span class="ident" id="1654195">cas</span><span class="op" id="1654198">.</span><span class="ident" id="1654199">_chan</span><span class="op" id="1654204">,</span>&nbsp;<span class="string" id="1654206">&#34;&nbsp;so=&#34;</span><span class="op" id="1654212">,</span>&nbsp;<span class="ident" id="1654214">cas</span><span class="op" id="1654217">.</span><span class="ident" id="1654218">so</span><span class="op" id="1654220">,</span>&nbsp;<span class="string" id="1654222">&#34;\n&#34;</span><span class="op" id="1654226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1654229">}</span><br>
<span class="lineno"></span><span class="op" id="1654231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1654234">//go:nosplit</span><br>
<span class="lineno">110</span><span class="keyword" id="1654247">func</span>&nbsp;<span class="ident" id="1654252">selectdefault</span><span class="op" id="1654265">(</span><span class="ident" id="1654266">sel</span>&nbsp;<span class="op" id="1654270">*</span><span class="ident" id="1654271">_select</span><span class="op" id="1654278">)</span>&nbsp;<span class="op" id="1654280">(</span><span class="ident" id="1654281">selected</span>&nbsp;<span class="builtintype" id="1654290">bool</span><span class="op" id="1654294">)</span>&nbsp;<span class="op" id="1654296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654299">selectdefaultImpl</span><span class="op" id="1654316">(</span><span class="ident" id="1654317">sel</span><span class="op" id="1654320">,</span>&nbsp;<span class="ident" id="1654322">getcallerpc</span><span class="op" id="1654333">(</span><span class="ident" id="1654334">unsafe</span><span class="op" id="1654340">.</span><span class="ident" id="1654341">Pointer</span><span class="op" id="1654348">(</span><span class="op" id="1654349">&amp;</span><span class="ident" id="1654350">sel</span><span class="op" id="1654353">)</span><span class="op" id="1654354">)</span><span class="op" id="1654355">,</span>&nbsp;<span class="builtintype" id="1654357">uintptr</span><span class="op" id="1654364">(</span><span class="ident" id="1654365">unsafe</span><span class="op" id="1654371">.</span><span class="ident" id="1654372">Pointer</span><span class="op" id="1654379">(</span><span class="op" id="1654380">&amp;</span><span class="ident" id="1654381">selected</span><span class="op" id="1654389">)</span><span class="op" id="1654390">)</span><span class="op" id="1654391">-</span><span class="builtintype" id="1654392">uintptr</span><span class="op" id="1654399">(</span><span class="ident" id="1654400">unsafe</span><span class="op" id="1654406">.</span><span class="ident" id="1654407">Pointer</span><span class="op" id="1654414">(</span><span class="op" id="1654415">&amp;</span><span class="ident" id="1654416">sel</span><span class="op" id="1654419">)</span><span class="op" id="1654420">)</span><span class="op" id="1654421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1654424">return</span><br>
<span class="lineno"></span><span class="op" id="1654431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="1654434">func</span>&nbsp;<span class="ident" id="1654439">selectdefaultImpl</span><span class="op" id="1654456">(</span><span class="ident" id="1654457">sel</span>&nbsp;<span class="op" id="1654461">*</span><span class="ident" id="1654462">_select</span><span class="op" id="1654469">,</span>&nbsp;<span class="ident" id="1654471">callerpc</span>&nbsp;<span class="builtintype" id="1654480">uintptr</span><span class="op" id="1654487">,</span>&nbsp;<span class="ident" id="1654489">so</span>&nbsp;<span class="builtintype" id="1654492">uintptr</span><span class="op" id="1654499">)</span>&nbsp;<span class="op" id="1654501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654504">i</span>&nbsp;<span class="op" id="1654506">:=</span>&nbsp;<span class="ident" id="1654509">sel</span><span class="op" id="1654512">.</span><span class="ident" id="1654513">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1654520">if</span>&nbsp;<span class="ident" id="1654523">i</span>&nbsp;<span class="op" id="1654525">&gt;=</span>&nbsp;<span class="ident" id="1654528">sel</span><span class="op" id="1654531">.</span><span class="ident" id="1654532">tcase</span>&nbsp;<span class="op" id="1654538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654542">gothrow</span><span class="op" id="1654549">(</span><span class="string" id="1654550">&#34;selectdefault:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1654581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1654584">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654587">sel</span><span class="op" id="1654590">.</span><span class="ident" id="1654591">ncase</span>&nbsp;<span class="op" id="1654597">=</span>&nbsp;<span class="ident" id="1654599">i</span>&nbsp;<span class="op" id="1654601">+</span>&nbsp;<span class="num" id="1654603">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654606">cas</span>&nbsp;<span class="op" id="1654610">:=</span>&nbsp;<span class="op" id="1654613">(</span><span class="op" id="1654614">*</span><span class="ident" id="1654615">scase</span><span class="op" id="1654620">)</span><span class="op" id="1654621">(</span><span class="ident" id="1654622">add</span><span class="op" id="1654625">(</span><span class="ident" id="1654626">unsafe</span><span class="op" id="1654632">.</span><span class="ident" id="1654633">Pointer</span><span class="op" id="1654640">(</span><span class="op" id="1654641">&amp;</span><span class="ident" id="1654642">sel</span><span class="op" id="1654645">.</span><span class="ident" id="1654646">scase</span><span class="op" id="1654651">)</span><span class="op" id="1654652">,</span>&nbsp;<span class="builtintype" id="1654654">uintptr</span><span class="op" id="1654661">(</span><span class="ident" id="1654662">i</span><span class="op" id="1654663">)</span><span class="op" id="1654664">*</span><span class="ident" id="1654665">unsafe</span><span class="op" id="1654671">.</span><span class="ident" id="1654672">Sizeof</span><span class="op" id="1654678">(</span><span class="ident" id="1654679">sel</span><span class="op" id="1654682">.</span><span class="ident" id="1654683">scase</span><span class="op" id="1654688">[</span><span class="num" id="1654689">0</span><span class="op" id="1654690">]</span><span class="op" id="1654691">)</span><span class="op" id="1654692">)</span><span class="op" id="1654693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654696">cas</span><span class="op" id="1654699">.</span><span class="ident" id="1654700">pc</span>&nbsp;<span class="op" id="1654703">=</span>&nbsp;<span class="ident" id="1654705">callerpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654715">cas</span><span class="op" id="1654718">.</span><span class="ident" id="1654719">_chan</span>&nbsp;<span class="op" id="1654725">=</span>&nbsp;<span class="builtintype" id="1654727">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654732">cas</span><span class="op" id="1654735">.</span><span class="ident" id="1654736">so</span>&nbsp;<span class="op" id="1654739">=</span>&nbsp;<span class="builtintype" id="1654741">uint16</span><span class="op" id="1654747">(</span><span class="ident" id="1654748">so</span><span class="op" id="1654750">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654753">cas</span><span class="op" id="1654756">.</span><span class="ident" id="1654757">kind</span>&nbsp;<span class="op" id="1654762">=</span>&nbsp;<span class="ident" id="1654764">_CaseDefault</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1654779">if</span>&nbsp;<span class="ident" id="1654782">debugSelect</span>&nbsp;<span class="op" id="1654794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1654798">print</span><span class="op" id="1654803">(</span><span class="string" id="1654804">&#34;selectdefault&nbsp;s=&#34;</span><span class="op" id="1654822">,</span>&nbsp;<span class="ident" id="1654824">sel</span><span class="op" id="1654827">,</span>&nbsp;<span class="string" id="1654829">&#34;&nbsp;pc=&#34;</span><span class="op" id="1654835">,</span>&nbsp;<span class="ident" id="1654837">hex</span><span class="op" id="1654840">(</span><span class="ident" id="1654841">cas</span><span class="op" id="1654844">.</span><span class="ident" id="1654845">pc</span><span class="op" id="1654847">)</span><span class="op" id="1654848">,</span>&nbsp;<span class="string" id="1654850">&#34;&nbsp;so=&#34;</span><span class="op" id="1654856">,</span>&nbsp;<span class="ident" id="1654858">cas</span><span class="op" id="1654861">.</span><span class="ident" id="1654862">so</span><span class="op" id="1654864">,</span>&nbsp;<span class="string" id="1654866">&#34;\n&#34;</span><span class="op" id="1654870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1654873">}</span><br>
<span class="lineno">130</span><span class="op" id="1654875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1654878">func</span>&nbsp;<span class="ident" id="1654883">sellock</span><span class="op" id="1654890">(</span><span class="ident" id="1654891">sel</span>&nbsp;<span class="op" id="1654895">*</span><span class="ident" id="1654896">_select</span><span class="op" id="1654903">)</span>&nbsp;<span class="op" id="1654905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654908">lockslice</span>&nbsp;<span class="op" id="1654918">:=</span>&nbsp;<span class="ident" id="1654921">sliceStruct</span><span class="op" id="1654932">{</span><span class="ident" id="1654933">unsafe</span><span class="op" id="1654939">.</span><span class="ident" id="1654940">Pointer</span><span class="op" id="1654947">(</span><span class="ident" id="1654948">sel</span><span class="op" id="1654951">.</span><span class="ident" id="1654952">lockorder</span><span class="op" id="1654961">)</span><span class="op" id="1654962">,</span>&nbsp;<span class="builtintype" id="1654964">int</span><span class="op" id="1654967">(</span><span class="ident" id="1654968">sel</span><span class="op" id="1654971">.</span><span class="ident" id="1654972">ncase</span><span class="op" id="1654977">)</span><span class="op" id="1654978">,</span>&nbsp;<span class="builtintype" id="1654980">int</span><span class="op" id="1654983">(</span><span class="ident" id="1654984">sel</span><span class="op" id="1654987">.</span><span class="ident" id="1654988">ncase</span><span class="op" id="1654993">)</span><span class="op" id="1654994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654997">lockorder</span>&nbsp;<span class="op" id="1655007">:=</span>&nbsp;<span class="op" id="1655010">*</span><span class="op" id="1655011">(</span><span class="op" id="1655012">*</span><span class="op" id="1655013">[</span><span class="op" id="1655014">]</span><span class="op" id="1655015">*</span><span class="ident" id="1655016">hchan</span><span class="op" id="1655021">)</span><span class="op" id="1655022">(</span><span class="ident" id="1655023">unsafe</span><span class="op" id="1655029">.</span><span class="ident" id="1655030">Pointer</span><span class="op" id="1655037">(</span><span class="op" id="1655038">&amp;</span><span class="ident" id="1655039">lockslice</span><span class="op" id="1655048">)</span><span class="op" id="1655049">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1655052">var</span>&nbsp;<span class="ident" id="1655056">c</span>&nbsp;<span class="op" id="1655058">*</span><span class="ident" id="1655059">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1655066">for</span>&nbsp;<span class="ident" id="1655070">_</span><span class="op" id="1655071">,</span>&nbsp;<span class="ident" id="1655073">c0</span>&nbsp;<span class="op" id="1655076">:=</span>&nbsp;<span class="keyword" id="1655079">range</span>&nbsp;<span class="ident" id="1655085">lockorder</span>&nbsp;<span class="op" id="1655095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1655099">if</span>&nbsp;<span class="ident" id="1655102">c0</span>&nbsp;<span class="op" id="1655105">!=</span>&nbsp;<span class="builtintype" id="1655108">nil</span>&nbsp;<span class="op" id="1655112">&amp;&amp;</span>&nbsp;<span class="ident" id="1655115">c0</span>&nbsp;<span class="op" id="1655118">!=</span>&nbsp;<span class="ident" id="1655121">c</span>&nbsp;<span class="op" id="1655123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655128">c</span>&nbsp;<span class="op" id="1655130">=</span>&nbsp;<span class="ident" id="1655132">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655138">lock</span><span class="op" id="1655142">(</span><span class="op" id="1655143">&amp;</span><span class="ident" id="1655144">c</span><span class="op" id="1655145">.</span><span class="ident" id="1655146">lock</span><span class="op" id="1655150">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1655154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1655157">}</span><br>
<span class="lineno"></span><span class="op" id="1655159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1655162">func</span>&nbsp;<span class="ident" id="1655167">selunlock</span><span class="op" id="1655176">(</span><span class="ident" id="1655177">sel</span>&nbsp;<span class="op" id="1655181">*</span><span class="ident" id="1655182">_select</span><span class="op" id="1655189">)</span>&nbsp;<span class="op" id="1655191">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1655194">//&nbsp;We&nbsp;must&nbsp;be&nbsp;very&nbsp;careful&nbsp;here&nbsp;to&nbsp;not&nbsp;touch&nbsp;sel&nbsp;after&nbsp;we&nbsp;have&nbsp;unlocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1655267">//&nbsp;the&nbsp;last&nbsp;lock,&nbsp;because&nbsp;sel&nbsp;can&nbsp;be&nbsp;freed&nbsp;right&nbsp;after&nbsp;the&nbsp;last&nbsp;unlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1655340">//&nbsp;Consider&nbsp;the&nbsp;following&nbsp;situation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1655378">//&nbsp;First&nbsp;M&nbsp;calls&nbsp;runtime·park()&nbsp;in&nbsp;runtime·selectgo()&nbsp;passing&nbsp;the&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1655452">//&nbsp;Once&nbsp;runtime·park()&nbsp;has&nbsp;unlocked&nbsp;the&nbsp;last&nbsp;lock,&nbsp;another&nbsp;M&nbsp;makes</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1655521">//&nbsp;the&nbsp;G&nbsp;that&nbsp;calls&nbsp;select&nbsp;runnable&nbsp;again&nbsp;and&nbsp;schedules&nbsp;it&nbsp;for&nbsp;execution.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1655596">//&nbsp;When&nbsp;the&nbsp;G&nbsp;runs&nbsp;on&nbsp;another&nbsp;M,&nbsp;it&nbsp;locks&nbsp;all&nbsp;the&nbsp;locks&nbsp;and&nbsp;frees&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1655668">//&nbsp;Now&nbsp;if&nbsp;the&nbsp;first&nbsp;M&nbsp;touches&nbsp;sel,&nbsp;it&nbsp;will&nbsp;access&nbsp;freed&nbsp;memory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655733">n</span>&nbsp;<span class="op" id="1655735">:=</span>&nbsp;<span class="builtintype" id="1655738">int</span><span class="op" id="1655741">(</span><span class="ident" id="1655742">sel</span><span class="op" id="1655745">.</span><span class="ident" id="1655746">ncase</span><span class="op" id="1655751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655754">r</span>&nbsp;<span class="op" id="1655756">:=</span>&nbsp;<span class="num" id="1655759">0</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655762">lockslice</span>&nbsp;<span class="op" id="1655772">:=</span>&nbsp;<span class="ident" id="1655775">sliceStruct</span><span class="op" id="1655786">{</span><span class="ident" id="1655787">unsafe</span><span class="op" id="1655793">.</span><span class="ident" id="1655794">Pointer</span><span class="op" id="1655801">(</span><span class="ident" id="1655802">sel</span><span class="op" id="1655805">.</span><span class="ident" id="1655806">lockorder</span><span class="op" id="1655815">)</span><span class="op" id="1655816">,</span>&nbsp;<span class="ident" id="1655818">n</span><span class="op" id="1655819">,</span>&nbsp;<span class="ident" id="1655821">n</span><span class="op" id="1655822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655825">lockorder</span>&nbsp;<span class="op" id="1655835">:=</span>&nbsp;<span class="op" id="1655838">*</span><span class="op" id="1655839">(</span><span class="op" id="1655840">*</span><span class="op" id="1655841">[</span><span class="op" id="1655842">]</span><span class="op" id="1655843">*</span><span class="ident" id="1655844">hchan</span><span class="op" id="1655849">)</span><span class="op" id="1655850">(</span><span class="ident" id="1655851">unsafe</span><span class="op" id="1655857">.</span><span class="ident" id="1655858">Pointer</span><span class="op" id="1655865">(</span><span class="op" id="1655866">&amp;</span><span class="ident" id="1655867">lockslice</span><span class="op" id="1655876">)</span><span class="op" id="1655877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1655880">//&nbsp;skip&nbsp;the&nbsp;default&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1655906">if</span>&nbsp;<span class="ident" id="1655909">n</span>&nbsp;<span class="op" id="1655911">&gt;</span>&nbsp;<span class="num" id="1655913">0</span>&nbsp;<span class="op" id="1655915">&amp;&amp;</span>&nbsp;<span class="ident" id="1655918">lockorder</span><span class="op" id="1655927">[</span><span class="num" id="1655928">0</span><span class="op" id="1655929">]</span>&nbsp;<span class="op" id="1655931">==</span>&nbsp;<span class="builtintype" id="1655934">nil</span>&nbsp;<span class="op" id="1655938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655942">r</span>&nbsp;<span class="op" id="1655944">=</span>&nbsp;<span class="num" id="1655946">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1655949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1655952">for</span>&nbsp;<span class="ident" id="1655956">i</span>&nbsp;<span class="op" id="1655958">:=</span>&nbsp;<span class="ident" id="1655961">n</span>&nbsp;<span class="op" id="1655963">-</span>&nbsp;<span class="num" id="1655965">1</span><span class="op" id="1655966">;</span>&nbsp;<span class="ident" id="1655968">i</span>&nbsp;<span class="op" id="1655970">&gt;=</span>&nbsp;<span class="ident" id="1655973">r</span><span class="op" id="1655974">;</span>&nbsp;<span class="ident" id="1655976">i</span><span class="op" id="1655977">--</span>&nbsp;<span class="op" id="1655980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655984">c</span>&nbsp;<span class="op" id="1655986">:=</span>&nbsp;<span class="ident" id="1655989">lockorder</span><span class="op" id="1655998">[</span><span class="ident" id="1655999">i</span><span class="op" id="1656000">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656004">if</span>&nbsp;<span class="ident" id="1656007">i</span>&nbsp;<span class="op" id="1656009">&gt;</span>&nbsp;<span class="num" id="1656011">0</span>&nbsp;<span class="op" id="1656013">&amp;&amp;</span>&nbsp;<span class="ident" id="1656016">c</span>&nbsp;<span class="op" id="1656018">==</span>&nbsp;<span class="ident" id="1656021">lockorder</span><span class="op" id="1656030">[</span><span class="ident" id="1656031">i</span><span class="op" id="1656032">-</span><span class="num" id="1656033">1</span><span class="op" id="1656034">]</span>&nbsp;<span class="op" id="1656036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656041">continue</span>&nbsp;<span class="comment" id="1656050">//&nbsp;will&nbsp;unlock&nbsp;it&nbsp;on&nbsp;the&nbsp;next&nbsp;iteration</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656096">unlock</span><span class="op" id="1656102">(</span><span class="op" id="1656103">&amp;</span><span class="ident" id="1656104">c</span><span class="op" id="1656105">.</span><span class="ident" id="1656106">lock</span><span class="op" id="1656110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656113">}</span><br>
<span class="lineno"></span><span class="op" id="1656115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="keyword" id="1656118">func</span>&nbsp;<span class="ident" id="1656123">selparkcommit</span><span class="op" id="1656136">(</span><span class="ident" id="1656137">gp</span>&nbsp;<span class="op" id="1656140">*</span><span class="ident" id="1656141">g</span><span class="op" id="1656142">,</span>&nbsp;<span class="ident" id="1656144">sel</span>&nbsp;<span class="op" id="1656148">*</span><span class="ident" id="1656149">_select</span><span class="op" id="1656156">)</span>&nbsp;<span class="builtintype" id="1656158">bool</span>&nbsp;<span class="op" id="1656163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656166">selunlock</span><span class="op" id="1656175">(</span><span class="ident" id="1656176">sel</span><span class="op" id="1656179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656182">return</span>&nbsp;<span class="builtintype" id="1656189">true</span><br>
<span class="lineno"></span><span class="op" id="1656194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="1656197">func</span>&nbsp;<span class="ident" id="1656202">block</span><span class="op" id="1656207">(</span><span class="op" id="1656208">)</span>&nbsp;<span class="op" id="1656210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656213">gopark</span><span class="op" id="1656219">(</span><span class="builtintype" id="1656220">nil</span><span class="op" id="1656223">,</span>&nbsp;<span class="builtintype" id="1656225">nil</span><span class="op" id="1656228">,</span>&nbsp;<span class="string" id="1656230">&#34;select&nbsp;(no&nbsp;cases)&#34;</span><span class="op" id="1656249">)</span>&nbsp;<span class="comment" id="1656251">//&nbsp;forever</span><br>
<span class="lineno"></span><span class="op" id="1656262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1656265">//&nbsp;overwrites&nbsp;return&nbsp;pc&nbsp;on&nbsp;stack&nbsp;to&nbsp;signal&nbsp;which&nbsp;case&nbsp;of&nbsp;the&nbsp;select</span><br>
<span class="lineno">180</span><span class="comment" id="1656333">//&nbsp;to&nbsp;run,&nbsp;so&nbsp;cannot&nbsp;appear&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;a&nbsp;split&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1656390">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1656403">func</span>&nbsp;<span class="ident" id="1656408">selectgo</span><span class="op" id="1656416">(</span><span class="ident" id="1656417">sel</span>&nbsp;<span class="op" id="1656421">*</span><span class="ident" id="1656422">_select</span><span class="op" id="1656429">)</span>&nbsp;<span class="op" id="1656431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656434">pc</span><span class="op" id="1656436">,</span>&nbsp;<span class="ident" id="1656438">offset</span>&nbsp;<span class="op" id="1656445">:=</span>&nbsp;<span class="ident" id="1656448">selectgoImpl</span><span class="op" id="1656460">(</span><span class="ident" id="1656461">sel</span><span class="op" id="1656464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656467">*</span><span class="op" id="1656468">(</span><span class="op" id="1656469">*</span><span class="builtintype" id="1656470">bool</span><span class="op" id="1656474">)</span><span class="op" id="1656475">(</span><span class="ident" id="1656476">add</span><span class="op" id="1656479">(</span><span class="ident" id="1656480">unsafe</span><span class="op" id="1656486">.</span><span class="ident" id="1656487">Pointer</span><span class="op" id="1656494">(</span><span class="op" id="1656495">&amp;</span><span class="ident" id="1656496">sel</span><span class="op" id="1656499">)</span><span class="op" id="1656500">,</span>&nbsp;<span class="builtintype" id="1656502">uintptr</span><span class="op" id="1656509">(</span><span class="ident" id="1656510">offset</span><span class="op" id="1656516">)</span><span class="op" id="1656517">)</span><span class="op" id="1656518">)</span>&nbsp;<span class="op" id="1656520">=</span>&nbsp;<span class="builtintype" id="1656522">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656528">setcallerpc</span><span class="op" id="1656539">(</span><span class="ident" id="1656540">unsafe</span><span class="op" id="1656546">.</span><span class="ident" id="1656547">Pointer</span><span class="op" id="1656554">(</span><span class="op" id="1656555">&amp;</span><span class="ident" id="1656556">sel</span><span class="op" id="1656559">)</span><span class="op" id="1656560">,</span>&nbsp;<span class="ident" id="1656562">pc</span><span class="op" id="1656564">)</span><br>
<span class="lineno"></span><span class="op" id="1656566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1656569">//&nbsp;selectgoImpl&nbsp;returns&nbsp;scase.pc&nbsp;and&nbsp;scase.so&nbsp;for&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span><span class="comment" id="1656630">//&nbsp;case&nbsp;which&nbsp;fired.</span><br>
<span class="lineno">190</span><span class="keyword" id="1656651">func</span>&nbsp;<span class="ident" id="1656656">selectgoImpl</span><span class="op" id="1656668">(</span><span class="ident" id="1656669">sel</span>&nbsp;<span class="op" id="1656673">*</span><span class="ident" id="1656674">_select</span><span class="op" id="1656681">)</span>&nbsp;<span class="op" id="1656683">(</span><span class="builtintype" id="1656684">uintptr</span><span class="op" id="1656691">,</span>&nbsp;<span class="builtintype" id="1656693">uint16</span><span class="op" id="1656699">)</span>&nbsp;<span class="op" id="1656701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656704">if</span>&nbsp;<span class="ident" id="1656707">debugSelect</span>&nbsp;<span class="op" id="1656719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1656723">print</span><span class="op" id="1656728">(</span><span class="string" id="1656729">&#34;select:&nbsp;sel=&#34;</span><span class="op" id="1656743">,</span>&nbsp;<span class="ident" id="1656745">sel</span><span class="op" id="1656748">,</span>&nbsp;<span class="string" id="1656750">&#34;\n&#34;</span><span class="op" id="1656754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656761">scaseslice</span>&nbsp;<span class="op" id="1656772">:=</span>&nbsp;<span class="ident" id="1656775">sliceStruct</span><span class="op" id="1656786">{</span><span class="ident" id="1656787">unsafe</span><span class="op" id="1656793">.</span><span class="ident" id="1656794">Pointer</span><span class="op" id="1656801">(</span><span class="op" id="1656802">&amp;</span><span class="ident" id="1656803">sel</span><span class="op" id="1656806">.</span><span class="ident" id="1656807">scase</span><span class="op" id="1656812">)</span><span class="op" id="1656813">,</span>&nbsp;<span class="builtintype" id="1656815">int</span><span class="op" id="1656818">(</span><span class="ident" id="1656819">sel</span><span class="op" id="1656822">.</span><span class="ident" id="1656823">ncase</span><span class="op" id="1656828">)</span><span class="op" id="1656829">,</span>&nbsp;<span class="builtintype" id="1656831">int</span><span class="op" id="1656834">(</span><span class="ident" id="1656835">sel</span><span class="op" id="1656838">.</span><span class="ident" id="1656839">ncase</span><span class="op" id="1656844">)</span><span class="op" id="1656845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656848">scases</span>&nbsp;<span class="op" id="1656855">:=</span>&nbsp;<span class="op" id="1656858">*</span><span class="op" id="1656859">(</span><span class="op" id="1656860">*</span><span class="op" id="1656861">[</span><span class="op" id="1656862">]</span><span class="ident" id="1656863">scase</span><span class="op" id="1656868">)</span><span class="op" id="1656869">(</span><span class="ident" id="1656870">unsafe</span><span class="op" id="1656876">.</span><span class="ident" id="1656877">Pointer</span><span class="op" id="1656884">(</span><span class="op" id="1656885">&amp;</span><span class="ident" id="1656886">scaseslice</span><span class="op" id="1656896">)</span><span class="op" id="1656897">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656901">var</span>&nbsp;<span class="ident" id="1656905">t0</span>&nbsp;<span class="ident" id="1656908">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656915">if</span>&nbsp;<span class="ident" id="1656918">blockprofilerate</span>&nbsp;<span class="op" id="1656935">&gt;</span>&nbsp;<span class="num" id="1656937">0</span>&nbsp;<span class="op" id="1656939">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656943">t0</span>&nbsp;<span class="op" id="1656946">=</span>&nbsp;<span class="ident" id="1656948">cputicks</span><span class="op" id="1656956">(</span><span class="op" id="1656957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656961">for</span>&nbsp;<span class="ident" id="1656965">i</span>&nbsp;<span class="op" id="1656967">:=</span>&nbsp;<span class="num" id="1656970">0</span><span class="op" id="1656971">;</span>&nbsp;<span class="ident" id="1656973">i</span>&nbsp;<span class="op" id="1656975">&lt;</span>&nbsp;<span class="builtintype" id="1656977">int</span><span class="op" id="1656980">(</span><span class="ident" id="1656981">sel</span><span class="op" id="1656984">.</span><span class="ident" id="1656985">ncase</span><span class="op" id="1656990">)</span><span class="op" id="1656991">;</span>&nbsp;<span class="ident" id="1656993">i</span><span class="op" id="1656994">++</span>&nbsp;<span class="op" id="1656997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657002">scases</span><span class="op" id="1657008">[</span><span class="ident" id="1657009">i</span><span class="op" id="1657010">]</span><span class="op" id="1657011">.</span><span class="ident" id="1657012">releasetime</span>&nbsp;<span class="op" id="1657024">=</span>&nbsp;<span class="op" id="1657026">-</span><span class="num" id="1657027">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657034">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1657038">//&nbsp;The&nbsp;compiler&nbsp;rewrites&nbsp;selects&nbsp;that&nbsp;statically&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1657093">//&nbsp;only&nbsp;0&nbsp;or&nbsp;1&nbsp;cases&nbsp;plus&nbsp;default&nbsp;into&nbsp;simpler&nbsp;constructs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1657153">//&nbsp;The&nbsp;only&nbsp;way&nbsp;we&nbsp;can&nbsp;end&nbsp;up&nbsp;with&nbsp;such&nbsp;small&nbsp;sel.ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1657210">//&nbsp;values&nbsp;here&nbsp;is&nbsp;for&nbsp;a&nbsp;larger&nbsp;select&nbsp;in&nbsp;which&nbsp;most&nbsp;channels</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1657272">//&nbsp;have&nbsp;been&nbsp;nilled&nbsp;out.&nbsp;&nbsp;The&nbsp;general&nbsp;code&nbsp;handles&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1657330">//&nbsp;cases&nbsp;correctly,&nbsp;and&nbsp;they&nbsp;are&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1657390">//&nbsp;optimizing&nbsp;(and&nbsp;needing&nbsp;to&nbsp;test).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1657429">//&nbsp;generate&nbsp;permuted&nbsp;order</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657457">pollslice</span>&nbsp;<span class="op" id="1657467">:=</span>&nbsp;<span class="ident" id="1657470">sliceStruct</span><span class="op" id="1657481">{</span><span class="ident" id="1657482">unsafe</span><span class="op" id="1657488">.</span><span class="ident" id="1657489">Pointer</span><span class="op" id="1657496">(</span><span class="ident" id="1657497">sel</span><span class="op" id="1657500">.</span><span class="ident" id="1657501">pollorder</span><span class="op" id="1657510">)</span><span class="op" id="1657511">,</span>&nbsp;<span class="builtintype" id="1657513">int</span><span class="op" id="1657516">(</span><span class="ident" id="1657517">sel</span><span class="op" id="1657520">.</span><span class="ident" id="1657521">ncase</span><span class="op" id="1657526">)</span><span class="op" id="1657527">,</span>&nbsp;<span class="builtintype" id="1657529">int</span><span class="op" id="1657532">(</span><span class="ident" id="1657533">sel</span><span class="op" id="1657536">.</span><span class="ident" id="1657537">ncase</span><span class="op" id="1657542">)</span><span class="op" id="1657543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657546">pollorder</span>&nbsp;<span class="op" id="1657556">:=</span>&nbsp;<span class="op" id="1657559">*</span><span class="op" id="1657560">(</span><span class="op" id="1657561">*</span><span class="op" id="1657562">[</span><span class="op" id="1657563">]</span><span class="builtintype" id="1657564">uint16</span><span class="op" id="1657570">)</span><span class="op" id="1657571">(</span><span class="ident" id="1657572">unsafe</span><span class="op" id="1657578">.</span><span class="ident" id="1657579">Pointer</span><span class="op" id="1657586">(</span><span class="op" id="1657587">&amp;</span><span class="ident" id="1657588">pollslice</span><span class="op" id="1657597">)</span><span class="op" id="1657598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657601">for</span>&nbsp;<span class="ident" id="1657605">i</span>&nbsp;<span class="op" id="1657607">:=</span>&nbsp;<span class="num" id="1657610">0</span><span class="op" id="1657611">;</span>&nbsp;<span class="ident" id="1657613">i</span>&nbsp;<span class="op" id="1657615">&lt;</span>&nbsp;<span class="builtintype" id="1657617">int</span><span class="op" id="1657620">(</span><span class="ident" id="1657621">sel</span><span class="op" id="1657624">.</span><span class="ident" id="1657625">ncase</span><span class="op" id="1657630">)</span><span class="op" id="1657631">;</span>&nbsp;<span class="ident" id="1657633">i</span><span class="op" id="1657634">++</span>&nbsp;<span class="op" id="1657637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657641">pollorder</span><span class="op" id="1657650">[</span><span class="ident" id="1657651">i</span><span class="op" id="1657652">]</span>&nbsp;<span class="op" id="1657654">=</span>&nbsp;<span class="builtintype" id="1657656">uint16</span><span class="op" id="1657662">(</span><span class="ident" id="1657663">i</span><span class="op" id="1657664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657667">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657670">for</span>&nbsp;<span class="ident" id="1657674">i</span>&nbsp;<span class="op" id="1657676">:=</span>&nbsp;<span class="num" id="1657679">1</span><span class="op" id="1657680">;</span>&nbsp;<span class="ident" id="1657682">i</span>&nbsp;<span class="op" id="1657684">&lt;</span>&nbsp;<span class="builtintype" id="1657686">int</span><span class="op" id="1657689">(</span><span class="ident" id="1657690">sel</span><span class="op" id="1657693">.</span><span class="ident" id="1657694">ncase</span><span class="op" id="1657699">)</span><span class="op" id="1657700">;</span>&nbsp;<span class="ident" id="1657702">i</span><span class="op" id="1657703">++</span>&nbsp;<span class="op" id="1657706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657710">o</span>&nbsp;<span class="op" id="1657712">:=</span>&nbsp;<span class="ident" id="1657715">pollorder</span><span class="op" id="1657724">[</span><span class="ident" id="1657725">i</span><span class="op" id="1657726">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657730">j</span>&nbsp;<span class="op" id="1657732">:=</span>&nbsp;<span class="builtintype" id="1657735">int</span><span class="op" id="1657738">(</span><span class="ident" id="1657739">fastrand1</span><span class="op" id="1657748">(</span><span class="op" id="1657749">)</span><span class="op" id="1657750">)</span>&nbsp;<span class="op" id="1657752">%</span>&nbsp;<span class="op" id="1657754">(</span><span class="ident" id="1657755">i</span>&nbsp;<span class="op" id="1657757">+</span>&nbsp;<span class="num" id="1657759">1</span><span class="op" id="1657760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657764">pollorder</span><span class="op" id="1657773">[</span><span class="ident" id="1657774">i</span><span class="op" id="1657775">]</span>&nbsp;<span class="op" id="1657777">=</span>&nbsp;<span class="ident" id="1657779">pollorder</span><span class="op" id="1657788">[</span><span class="ident" id="1657789">j</span><span class="op" id="1657790">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657794">pollorder</span><span class="op" id="1657803">[</span><span class="ident" id="1657804">j</span><span class="op" id="1657805">]</span>&nbsp;<span class="op" id="1657807">=</span>&nbsp;<span class="ident" id="1657809">o</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1657816">//&nbsp;sort&nbsp;the&nbsp;cases&nbsp;by&nbsp;Hchan&nbsp;address&nbsp;to&nbsp;get&nbsp;the&nbsp;locking&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1657878">//&nbsp;simple&nbsp;heap&nbsp;sort,&nbsp;to&nbsp;guarantee&nbsp;n&nbsp;log&nbsp;n&nbsp;time&nbsp;and&nbsp;constant&nbsp;stack&nbsp;footprint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657956">lockslice</span>&nbsp;<span class="op" id="1657966">:=</span>&nbsp;<span class="ident" id="1657969">sliceStruct</span><span class="op" id="1657980">{</span><span class="ident" id="1657981">unsafe</span><span class="op" id="1657987">.</span><span class="ident" id="1657988">Pointer</span><span class="op" id="1657995">(</span><span class="ident" id="1657996">sel</span><span class="op" id="1657999">.</span><span class="ident" id="1658000">lockorder</span><span class="op" id="1658009">)</span><span class="op" id="1658010">,</span>&nbsp;<span class="builtintype" id="1658012">int</span><span class="op" id="1658015">(</span><span class="ident" id="1658016">sel</span><span class="op" id="1658019">.</span><span class="ident" id="1658020">ncase</span><span class="op" id="1658025">)</span><span class="op" id="1658026">,</span>&nbsp;<span class="builtintype" id="1658028">int</span><span class="op" id="1658031">(</span><span class="ident" id="1658032">sel</span><span class="op" id="1658035">.</span><span class="ident" id="1658036">ncase</span><span class="op" id="1658041">)</span><span class="op" id="1658042">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658045">lockorder</span>&nbsp;<span class="op" id="1658055">:=</span>&nbsp;<span class="op" id="1658058">*</span><span class="op" id="1658059">(</span><span class="op" id="1658060">*</span><span class="op" id="1658061">[</span><span class="op" id="1658062">]</span><span class="op" id="1658063">*</span><span class="ident" id="1658064">hchan</span><span class="op" id="1658069">)</span><span class="op" id="1658070">(</span><span class="ident" id="1658071">unsafe</span><span class="op" id="1658077">.</span><span class="ident" id="1658078">Pointer</span><span class="op" id="1658085">(</span><span class="op" id="1658086">&amp;</span><span class="ident" id="1658087">lockslice</span><span class="op" id="1658096">)</span><span class="op" id="1658097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658100">for</span>&nbsp;<span class="ident" id="1658104">i</span>&nbsp;<span class="op" id="1658106">:=</span>&nbsp;<span class="num" id="1658109">0</span><span class="op" id="1658110">;</span>&nbsp;<span class="ident" id="1658112">i</span>&nbsp;<span class="op" id="1658114">&lt;</span>&nbsp;<span class="builtintype" id="1658116">int</span><span class="op" id="1658119">(</span><span class="ident" id="1658120">sel</span><span class="op" id="1658123">.</span><span class="ident" id="1658124">ncase</span><span class="op" id="1658129">)</span><span class="op" id="1658130">;</span>&nbsp;<span class="ident" id="1658132">i</span><span class="op" id="1658133">++</span>&nbsp;<span class="op" id="1658136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658140">j</span>&nbsp;<span class="op" id="1658142">:=</span>&nbsp;<span class="ident" id="1658145">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658149">c</span>&nbsp;<span class="op" id="1658151">:=</span>&nbsp;<span class="ident" id="1658154">scases</span><span class="op" id="1658160">[</span><span class="ident" id="1658161">j</span><span class="op" id="1658162">]</span><span class="op" id="1658163">.</span><span class="ident" id="1658164">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658172">for</span>&nbsp;<span class="ident" id="1658176">j</span>&nbsp;<span class="op" id="1658178">&gt;</span>&nbsp;<span class="num" id="1658180">0</span>&nbsp;<span class="op" id="1658182">&amp;&amp;</span>&nbsp;<span class="ident" id="1658185">lockorder</span><span class="op" id="1658194">[</span><span class="op" id="1658195">(</span><span class="ident" id="1658196">j</span><span class="op" id="1658197">-</span><span class="num" id="1658198">1</span><span class="op" id="1658199">)</span><span class="op" id="1658200">/</span><span class="num" id="1658201">2</span><span class="op" id="1658202">]</span><span class="op" id="1658203">.</span><span class="ident" id="1658204">sortkey</span><span class="op" id="1658211">(</span><span class="op" id="1658212">)</span>&nbsp;<span class="op" id="1658214">&lt;</span>&nbsp;<span class="ident" id="1658216">c</span><span class="op" id="1658217">.</span><span class="ident" id="1658218">sortkey</span><span class="op" id="1658225">(</span><span class="op" id="1658226">)</span>&nbsp;<span class="op" id="1658228">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658233">k</span>&nbsp;<span class="op" id="1658235">:=</span>&nbsp;<span class="op" id="1658238">(</span><span class="ident" id="1658239">j</span>&nbsp;<span class="op" id="1658241">-</span>&nbsp;<span class="num" id="1658243">1</span><span class="op" id="1658244">)</span>&nbsp;<span class="op" id="1658246">/</span>&nbsp;<span class="num" id="1658248">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658253">lockorder</span><span class="op" id="1658262">[</span><span class="ident" id="1658263">j</span><span class="op" id="1658264">]</span>&nbsp;<span class="op" id="1658266">=</span>&nbsp;<span class="ident" id="1658268">lockorder</span><span class="op" id="1658277">[</span><span class="ident" id="1658278">k</span><span class="op" id="1658279">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658284">j</span>&nbsp;<span class="op" id="1658286">=</span>&nbsp;<span class="ident" id="1658288">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658296">lockorder</span><span class="op" id="1658305">[</span><span class="ident" id="1658306">j</span><span class="op" id="1658307">]</span>&nbsp;<span class="op" id="1658309">=</span>&nbsp;<span class="ident" id="1658311">c</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658317">for</span>&nbsp;<span class="ident" id="1658321">i</span>&nbsp;<span class="op" id="1658323">:=</span>&nbsp;<span class="builtintype" id="1658326">int</span><span class="op" id="1658329">(</span><span class="ident" id="1658330">sel</span><span class="op" id="1658333">.</span><span class="ident" id="1658334">ncase</span><span class="op" id="1658339">)</span>&nbsp;<span class="op" id="1658341">-</span>&nbsp;<span class="num" id="1658343">1</span><span class="op" id="1658344">;</span>&nbsp;<span class="ident" id="1658346">i</span>&nbsp;<span class="op" id="1658348">&gt;=</span>&nbsp;<span class="num" id="1658351">0</span><span class="op" id="1658352">;</span>&nbsp;<span class="ident" id="1658354">i</span><span class="op" id="1658355">--</span>&nbsp;<span class="op" id="1658358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658362">c</span>&nbsp;<span class="op" id="1658364">:=</span>&nbsp;<span class="ident" id="1658367">lockorder</span><span class="op" id="1658376">[</span><span class="ident" id="1658377">i</span><span class="op" id="1658378">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658382">lockorder</span><span class="op" id="1658391">[</span><span class="ident" id="1658392">i</span><span class="op" id="1658393">]</span>&nbsp;<span class="op" id="1658395">=</span>&nbsp;<span class="ident" id="1658397">lockorder</span><span class="op" id="1658406">[</span><span class="num" id="1658407">0</span><span class="op" id="1658408">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658412">j</span>&nbsp;<span class="op" id="1658414">:=</span>&nbsp;<span class="num" id="1658417">0</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658421">for</span>&nbsp;<span class="op" id="1658425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658430">k</span>&nbsp;<span class="op" id="1658432">:=</span>&nbsp;<span class="ident" id="1658435">j</span><span class="op" id="1658436">*</span><span class="num" id="1658437">2</span>&nbsp;<span class="op" id="1658439">+</span>&nbsp;<span class="num" id="1658441">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658446">if</span>&nbsp;<span class="ident" id="1658449">k</span>&nbsp;<span class="op" id="1658451">&gt;=</span>&nbsp;<span class="ident" id="1658454">i</span>&nbsp;<span class="op" id="1658456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658462">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658471">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658476">if</span>&nbsp;<span class="ident" id="1658479">k</span><span class="op" id="1658480">+</span><span class="num" id="1658481">1</span>&nbsp;<span class="op" id="1658483">&lt;</span>&nbsp;<span class="ident" id="1658485">i</span>&nbsp;<span class="op" id="1658487">&amp;&amp;</span>&nbsp;<span class="ident" id="1658490">lockorder</span><span class="op" id="1658499">[</span><span class="ident" id="1658500">k</span><span class="op" id="1658501">]</span><span class="op" id="1658502">.</span><span class="ident" id="1658503">sortkey</span><span class="op" id="1658510">(</span><span class="op" id="1658511">)</span>&nbsp;<span class="op" id="1658513">&lt;</span>&nbsp;<span class="ident" id="1658515">lockorder</span><span class="op" id="1658524">[</span><span class="ident" id="1658525">k</span><span class="op" id="1658526">+</span><span class="num" id="1658527">1</span><span class="op" id="1658528">]</span><span class="op" id="1658529">.</span><span class="ident" id="1658530">sortkey</span><span class="op" id="1658537">(</span><span class="op" id="1658538">)</span>&nbsp;<span class="op" id="1658540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658546">k</span><span class="op" id="1658547">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658558">if</span>&nbsp;<span class="ident" id="1658561">c</span><span class="op" id="1658562">.</span><span class="ident" id="1658563">sortkey</span><span class="op" id="1658570">(</span><span class="op" id="1658571">)</span>&nbsp;<span class="op" id="1658573">&lt;</span>&nbsp;<span class="ident" id="1658575">lockorder</span><span class="op" id="1658584">[</span><span class="ident" id="1658585">k</span><span class="op" id="1658586">]</span><span class="op" id="1658587">.</span><span class="ident" id="1658588">sortkey</span><span class="op" id="1658595">(</span><span class="op" id="1658596">)</span>&nbsp;<span class="op" id="1658598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658604">lockorder</span><span class="op" id="1658613">[</span><span class="ident" id="1658614">j</span><span class="op" id="1658615">]</span>&nbsp;<span class="op" id="1658617">=</span>&nbsp;<span class="ident" id="1658619">lockorder</span><span class="op" id="1658628">[</span><span class="ident" id="1658629">k</span><span class="op" id="1658630">]</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658636">j</span>&nbsp;<span class="op" id="1658638">=</span>&nbsp;<span class="ident" id="1658640">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658646">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658663">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658671">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658675">lockorder</span><span class="op" id="1658684">[</span><span class="ident" id="1658685">j</span><span class="op" id="1658686">]</span>&nbsp;<span class="op" id="1658688">=</span>&nbsp;<span class="ident" id="1658690">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1658696">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;:=&nbsp;0;&nbsp;i+1&nbsp;&lt;&nbsp;int(sel.ncase);&nbsp;i++&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;lockorder[i].sortkey()&nbsp;&gt;&nbsp;lockorder[i+1].sortkey()&nbsp;{<br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#34;i=&#34;,&nbsp;i,&nbsp;&#34;&nbsp;x=&#34;,&nbsp;lockorder[i],&nbsp;&#34;&nbsp;y=&#34;,&nbsp;lockorder[i+1],&nbsp;&#34;\n&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gothrow(&#34;select:&nbsp;broken&nbsp;sort&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;*/</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1658918">//&nbsp;lock&nbsp;all&nbsp;the&nbsp;channels&nbsp;involved&nbsp;in&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658967">sellock</span><span class="op" id="1658974">(</span><span class="ident" id="1658975">sel</span><span class="op" id="1658978">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658982">var</span>&nbsp;<span class="op" id="1658986">(</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658990">gp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658997">*</span><span class="ident" id="1658998">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659002">done</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1659009">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659018">sg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659025">*</span><span class="ident" id="1659026">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659034">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659041">*</span><span class="ident" id="1659042">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659050">k</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659057">*</span><span class="ident" id="1659058">scase</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659066">sglist</span>&nbsp;<span class="op" id="1659073">*</span><span class="ident" id="1659074">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659082">sgnext</span>&nbsp;<span class="op" id="1659089">*</span><span class="ident" id="1659090">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659097">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1659100">loop</span><span class="op" id="1659104">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1659107">//&nbsp;pass&nbsp;1&nbsp;-&nbsp;look&nbsp;for&nbsp;something&nbsp;already&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659155">var</span>&nbsp;<span class="ident" id="1659159">dfl</span>&nbsp;<span class="op" id="1659163">*</span><span class="ident" id="1659164">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659171">var</span>&nbsp;<span class="ident" id="1659175">cas</span>&nbsp;<span class="op" id="1659179">*</span><span class="ident" id="1659180">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659187">for</span>&nbsp;<span class="ident" id="1659191">i</span>&nbsp;<span class="op" id="1659193">:=</span>&nbsp;<span class="num" id="1659196">0</span><span class="op" id="1659197">;</span>&nbsp;<span class="ident" id="1659199">i</span>&nbsp;<span class="op" id="1659201">&lt;</span>&nbsp;<span class="builtintype" id="1659203">int</span><span class="op" id="1659206">(</span><span class="ident" id="1659207">sel</span><span class="op" id="1659210">.</span><span class="ident" id="1659211">ncase</span><span class="op" id="1659216">)</span><span class="op" id="1659217">;</span>&nbsp;<span class="ident" id="1659219">i</span><span class="op" id="1659220">++</span>&nbsp;<span class="op" id="1659223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659227">cas</span>&nbsp;<span class="op" id="1659231">=</span>&nbsp;<span class="op" id="1659233">&amp;</span><span class="ident" id="1659234">scases</span><span class="op" id="1659240">[</span><span class="ident" id="1659241">pollorder</span><span class="op" id="1659250">[</span><span class="ident" id="1659251">i</span><span class="op" id="1659252">]</span><span class="op" id="1659253">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659257">c</span>&nbsp;<span class="op" id="1659259">=</span>&nbsp;<span class="ident" id="1659261">cas</span><span class="op" id="1659264">.</span><span class="ident" id="1659265">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659274">switch</span>&nbsp;<span class="ident" id="1659281">cas</span><span class="op" id="1659284">.</span><span class="ident" id="1659285">kind</span>&nbsp;<span class="op" id="1659290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659294">case</span>&nbsp;<span class="ident" id="1659299">_CaseRecv</span><span class="op" id="1659308">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659313">if</span>&nbsp;<span class="ident" id="1659316">c</span><span class="op" id="1659317">.</span><span class="ident" id="1659318">dataqsiz</span>&nbsp;<span class="op" id="1659327">&gt;</span>&nbsp;<span class="num" id="1659329">0</span>&nbsp;<span class="op" id="1659331">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659337">if</span>&nbsp;<span class="ident" id="1659340">c</span><span class="op" id="1659341">.</span><span class="ident" id="1659342">qcount</span>&nbsp;<span class="op" id="1659349">&gt;</span>&nbsp;<span class="num" id="1659351">0</span>&nbsp;<span class="op" id="1659353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659360">goto</span>&nbsp;<span class="ident" id="1659365">asyncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659384">}</span>&nbsp;<span class="keyword" id="1659386">else</span>&nbsp;<span class="op" id="1659391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659397">sg</span>&nbsp;<span class="op" id="1659400">=</span>&nbsp;<span class="ident" id="1659402">c</span><span class="op" id="1659403">.</span><span class="ident" id="1659404">sendq</span><span class="op" id="1659409">.</span><span class="ident" id="1659410">dequeue</span><span class="op" id="1659417">(</span><span class="op" id="1659418">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659424">if</span>&nbsp;<span class="ident" id="1659427">sg</span>&nbsp;<span class="op" id="1659430">!=</span>&nbsp;<span class="builtintype" id="1659433">nil</span>&nbsp;<span class="op" id="1659437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659444">goto</span>&nbsp;<span class="ident" id="1659449">syncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659472">if</span>&nbsp;<span class="ident" id="1659475">c</span><span class="op" id="1659476">.</span><span class="ident" id="1659477">closed</span>&nbsp;<span class="op" id="1659484">!=</span>&nbsp;<span class="num" id="1659487">0</span>&nbsp;<span class="op" id="1659489">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659495">goto</span>&nbsp;<span class="ident" id="1659500">rclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659515">case</span>&nbsp;<span class="ident" id="1659520">_CaseSend</span><span class="op" id="1659529">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659534">if</span>&nbsp;<span class="ident" id="1659537">raceenabled</span>&nbsp;<span class="op" id="1659549">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659555">racereadpc</span><span class="op" id="1659565">(</span><span class="ident" id="1659566">unsafe</span><span class="op" id="1659572">.</span><span class="ident" id="1659573">Pointer</span><span class="op" id="1659580">(</span><span class="ident" id="1659581">c</span><span class="op" id="1659582">)</span><span class="op" id="1659583">,</span>&nbsp;<span class="ident" id="1659585">cas</span><span class="op" id="1659588">.</span><span class="ident" id="1659589">pc</span><span class="op" id="1659591">,</span>&nbsp;<span class="ident" id="1659593">chansendpc</span><span class="op" id="1659603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659613">if</span>&nbsp;<span class="ident" id="1659616">c</span><span class="op" id="1659617">.</span><span class="ident" id="1659618">closed</span>&nbsp;<span class="op" id="1659625">!=</span>&nbsp;<span class="num" id="1659628">0</span>&nbsp;<span class="op" id="1659630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659636">goto</span>&nbsp;<span class="ident" id="1659641">sclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659651">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659656">if</span>&nbsp;<span class="ident" id="1659659">c</span><span class="op" id="1659660">.</span><span class="ident" id="1659661">dataqsiz</span>&nbsp;<span class="op" id="1659670">&gt;</span>&nbsp;<span class="num" id="1659672">0</span>&nbsp;<span class="op" id="1659674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659680">if</span>&nbsp;<span class="ident" id="1659683">c</span><span class="op" id="1659684">.</span><span class="ident" id="1659685">qcount</span>&nbsp;<span class="op" id="1659692">&lt;</span>&nbsp;<span class="ident" id="1659694">c</span><span class="op" id="1659695">.</span><span class="ident" id="1659696">dataqsiz</span>&nbsp;<span class="op" id="1659705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659712">goto</span>&nbsp;<span class="ident" id="1659717">asyncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659736">}</span>&nbsp;<span class="keyword" id="1659738">else</span>&nbsp;<span class="op" id="1659743">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659749">sg</span>&nbsp;<span class="op" id="1659752">=</span>&nbsp;<span class="ident" id="1659754">c</span><span class="op" id="1659755">.</span><span class="ident" id="1659756">recvq</span><span class="op" id="1659761">.</span><span class="ident" id="1659762">dequeue</span><span class="op" id="1659769">(</span><span class="op" id="1659770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659776">if</span>&nbsp;<span class="ident" id="1659779">sg</span>&nbsp;<span class="op" id="1659782">!=</span>&nbsp;<span class="builtintype" id="1659785">nil</span>&nbsp;<span class="op" id="1659789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659796">goto</span>&nbsp;<span class="ident" id="1659801">syncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659819">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659824">case</span>&nbsp;<span class="ident" id="1659829">_CaseDefault</span><span class="op" id="1659841">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659846">dfl</span>&nbsp;<span class="op" id="1659850">=</span>&nbsp;<span class="ident" id="1659852">cas</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659861">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659865">if</span>&nbsp;<span class="ident" id="1659868">dfl</span>&nbsp;<span class="op" id="1659872">!=</span>&nbsp;<span class="builtintype" id="1659875">nil</span>&nbsp;<span class="op" id="1659879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659883">selunlock</span><span class="op" id="1659892">(</span><span class="ident" id="1659893">sel</span><span class="op" id="1659896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659900">cas</span>&nbsp;<span class="op" id="1659904">=</span>&nbsp;<span class="ident" id="1659906">dfl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659912">goto</span>&nbsp;<span class="ident" id="1659917">retc</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1659927">//&nbsp;pass&nbsp;2&nbsp;-&nbsp;enqueue&nbsp;on&nbsp;all&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659961">gp</span>&nbsp;<span class="op" id="1659964">=</span>&nbsp;<span class="ident" id="1659966">getg</span><span class="op" id="1659970">(</span><span class="op" id="1659971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659974">done</span>&nbsp;<span class="op" id="1659979">=</span>&nbsp;<span class="num" id="1659981">0</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659984">for</span>&nbsp;<span class="ident" id="1659988">i</span>&nbsp;<span class="op" id="1659990">:=</span>&nbsp;<span class="num" id="1659993">0</span><span class="op" id="1659994">;</span>&nbsp;<span class="ident" id="1659996">i</span>&nbsp;<span class="op" id="1659998">&lt;</span>&nbsp;<span class="builtintype" id="1660000">int</span><span class="op" id="1660003">(</span><span class="ident" id="1660004">sel</span><span class="op" id="1660007">.</span><span class="ident" id="1660008">ncase</span><span class="op" id="1660013">)</span><span class="op" id="1660014">;</span>&nbsp;<span class="ident" id="1660016">i</span><span class="op" id="1660017">++</span>&nbsp;<span class="op" id="1660020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660024">cas</span>&nbsp;<span class="op" id="1660028">=</span>&nbsp;<span class="op" id="1660030">&amp;</span><span class="ident" id="1660031">scases</span><span class="op" id="1660037">[</span><span class="ident" id="1660038">pollorder</span><span class="op" id="1660047">[</span><span class="ident" id="1660048">i</span><span class="op" id="1660049">]</span><span class="op" id="1660050">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660054">c</span>&nbsp;<span class="op" id="1660056">=</span>&nbsp;<span class="ident" id="1660058">cas</span><span class="op" id="1660061">.</span><span class="ident" id="1660062">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660070">sg</span>&nbsp;<span class="op" id="1660073">:=</span>&nbsp;<span class="ident" id="1660076">acquireSudog</span><span class="op" id="1660088">(</span><span class="op" id="1660089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660093">sg</span><span class="op" id="1660095">.</span><span class="ident" id="1660096">g</span>&nbsp;<span class="op" id="1660098">=</span>&nbsp;<span class="ident" id="1660100">gp</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1660105">//&nbsp;Note:&nbsp;selectdone&nbsp;is&nbsp;adjusted&nbsp;for&nbsp;stack&nbsp;copies&nbsp;in&nbsp;stack.c:adjustsudogs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660180">sg</span><span class="op" id="1660182">.</span><span class="ident" id="1660183">selectdone</span>&nbsp;<span class="op" id="1660194">=</span>&nbsp;<span class="op" id="1660196">(</span><span class="op" id="1660197">*</span><span class="builtintype" id="1660198">uint32</span><span class="op" id="1660204">)</span><span class="op" id="1660205">(</span><span class="ident" id="1660206">noescape</span><span class="op" id="1660214">(</span><span class="ident" id="1660215">unsafe</span><span class="op" id="1660221">.</span><span class="ident" id="1660222">Pointer</span><span class="op" id="1660229">(</span><span class="op" id="1660230">&amp;</span><span class="ident" id="1660231">done</span><span class="op" id="1660235">)</span><span class="op" id="1660236">)</span><span class="op" id="1660237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660241">sg</span><span class="op" id="1660243">.</span><span class="ident" id="1660244">elem</span>&nbsp;<span class="op" id="1660249">=</span>&nbsp;<span class="ident" id="1660251">cas</span><span class="op" id="1660254">.</span><span class="ident" id="1660255">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660262">sg</span><span class="op" id="1660264">.</span><span class="ident" id="1660265">releasetime</span>&nbsp;<span class="op" id="1660277">=</span>&nbsp;<span class="num" id="1660279">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660283">if</span>&nbsp;<span class="ident" id="1660286">t0</span>&nbsp;<span class="op" id="1660289">!=</span>&nbsp;<span class="num" id="1660292">0</span>&nbsp;<span class="op" id="1660294">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660299">sg</span><span class="op" id="1660301">.</span><span class="ident" id="1660302">releasetime</span>&nbsp;<span class="op" id="1660314">=</span>&nbsp;<span class="op" id="1660316">-</span><span class="num" id="1660317">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1660321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660325">sg</span><span class="op" id="1660327">.</span><span class="ident" id="1660328">waitlink</span>&nbsp;<span class="op" id="1660337">=</span>&nbsp;<span class="ident" id="1660339">gp</span><span class="op" id="1660341">.</span><span class="ident" id="1660342">waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660352">gp</span><span class="op" id="1660354">.</span><span class="ident" id="1660355">waiting</span>&nbsp;<span class="op" id="1660363">=</span>&nbsp;<span class="ident" id="1660365">sg</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660371">switch</span>&nbsp;<span class="ident" id="1660378">cas</span><span class="op" id="1660381">.</span><span class="ident" id="1660382">kind</span>&nbsp;<span class="op" id="1660387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660391">case</span>&nbsp;<span class="ident" id="1660396">_CaseRecv</span><span class="op" id="1660405">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660410">c</span><span class="op" id="1660411">.</span><span class="ident" id="1660412">recvq</span><span class="op" id="1660417">.</span><span class="ident" id="1660418">enqueue</span><span class="op" id="1660425">(</span><span class="ident" id="1660426">sg</span><span class="op" id="1660428">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660433">case</span>&nbsp;<span class="ident" id="1660438">_CaseSend</span><span class="op" id="1660447">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660452">c</span><span class="op" id="1660453">.</span><span class="ident" id="1660454">sendq</span><span class="op" id="1660459">.</span><span class="ident" id="1660460">enqueue</span><span class="op" id="1660467">(</span><span class="ident" id="1660468">sg</span><span class="op" id="1660470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1660474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1660477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1660481">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;wake&nbsp;us&nbsp;up</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660516">gp</span><span class="op" id="1660518">.</span><span class="ident" id="1660519">param</span>&nbsp;<span class="op" id="1660525">=</span>&nbsp;<span class="builtintype" id="1660527">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660532">gopark</span><span class="op" id="1660538">(</span><span class="ident" id="1660539">unsafe</span><span class="op" id="1660545">.</span><span class="ident" id="1660546">Pointer</span><span class="op" id="1660553">(</span><span class="ident" id="1660554">funcPC</span><span class="op" id="1660560">(</span><span class="ident" id="1660561">selparkcommit</span><span class="op" id="1660574">)</span><span class="op" id="1660575">)</span><span class="op" id="1660576">,</span>&nbsp;<span class="ident" id="1660578">unsafe</span><span class="op" id="1660584">.</span><span class="ident" id="1660585">Pointer</span><span class="op" id="1660592">(</span><span class="ident" id="1660593">sel</span><span class="op" id="1660596">)</span><span class="op" id="1660597">,</span>&nbsp;<span class="string" id="1660599">&#34;select&#34;</span><span class="op" id="1660607">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1660611">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660634">sellock</span><span class="op" id="1660641">(</span><span class="ident" id="1660642">sel</span><span class="op" id="1660645">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660648">sg</span>&nbsp;<span class="op" id="1660651">=</span>&nbsp;<span class="op" id="1660653">(</span><span class="op" id="1660654">*</span><span class="ident" id="1660655">sudog</span><span class="op" id="1660660">)</span><span class="op" id="1660661">(</span><span class="ident" id="1660662">gp</span><span class="op" id="1660664">.</span><span class="ident" id="1660665">param</span><span class="op" id="1660670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660673">gp</span><span class="op" id="1660675">.</span><span class="ident" id="1660676">param</span>&nbsp;<span class="op" id="1660682">=</span>&nbsp;<span class="builtintype" id="1660684">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1660690">//&nbsp;pass&nbsp;3&nbsp;-&nbsp;dequeue&nbsp;from&nbsp;unsuccessful&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1660735">//&nbsp;otherwise&nbsp;they&nbsp;stack&nbsp;up&nbsp;on&nbsp;quiet&nbsp;channels</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1660781">//&nbsp;record&nbsp;the&nbsp;successful&nbsp;case,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1660821">//&nbsp;We&nbsp;singly-linked&nbsp;up&nbsp;the&nbsp;SudoGs&nbsp;in&nbsp;case&nbsp;order,&nbsp;so&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1660879">//&nbsp;iterating&nbsp;through&nbsp;the&nbsp;linked&nbsp;list&nbsp;they&nbsp;are&nbsp;in&nbsp;reverse&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660944">cas</span>&nbsp;<span class="op" id="1660948">=</span>&nbsp;<span class="builtintype" id="1660950">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660955">sglist</span>&nbsp;<span class="op" id="1660962">=</span>&nbsp;<span class="ident" id="1660964">gp</span><span class="op" id="1660966">.</span><span class="ident" id="1660967">waiting</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1660976">//&nbsp;Clear&nbsp;all&nbsp;selectdone&nbsp;and&nbsp;elem&nbsp;before&nbsp;unlinking&nbsp;from&nbsp;gp.waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1661044">//&nbsp;They&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;being&nbsp;put&nbsp;back&nbsp;into&nbsp;the&nbsp;sudog&nbsp;cache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1661113">//&nbsp;Clear&nbsp;before&nbsp;unlinking,&nbsp;because&nbsp;if&nbsp;a&nbsp;stack&nbsp;copy&nbsp;happens&nbsp;after&nbsp;the&nbsp;unlink,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1661191">//&nbsp;they&nbsp;will&nbsp;not&nbsp;be&nbsp;updated,&nbsp;they&nbsp;will&nbsp;be&nbsp;left&nbsp;pointing&nbsp;to&nbsp;the&nbsp;old&nbsp;stack,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1661266">//&nbsp;which&nbsp;creates&nbsp;dangling&nbsp;pointers,&nbsp;which&nbsp;may&nbsp;be&nbsp;detected&nbsp;by&nbsp;the</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1661332">//&nbsp;garbage&nbsp;collector.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1661355">for</span>&nbsp;<span class="ident" id="1661359">sg1</span>&nbsp;<span class="op" id="1661363">:=</span>&nbsp;<span class="ident" id="1661366">gp</span><span class="op" id="1661368">.</span><span class="ident" id="1661369">waiting</span><span class="op" id="1661376">;</span>&nbsp;<span class="ident" id="1661378">sg1</span>&nbsp;<span class="op" id="1661382">!=</span>&nbsp;<span class="builtintype" id="1661385">nil</span><span class="op" id="1661388">;</span>&nbsp;<span class="ident" id="1661390">sg1</span>&nbsp;<span class="op" id="1661394">=</span>&nbsp;<span class="ident" id="1661396">sg1</span><span class="op" id="1661399">.</span><span class="ident" id="1661400">waitlink</span>&nbsp;<span class="op" id="1661409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661413">sg1</span><span class="op" id="1661416">.</span><span class="ident" id="1661417">selectdone</span>&nbsp;<span class="op" id="1661428">=</span>&nbsp;<span class="builtintype" id="1661430">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661436">sg1</span><span class="op" id="1661439">.</span><span class="ident" id="1661440">elem</span>&nbsp;<span class="op" id="1661445">=</span>&nbsp;<span class="builtintype" id="1661447">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1661452">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661455">gp</span><span class="op" id="1661457">.</span><span class="ident" id="1661458">waiting</span>&nbsp;<span class="op" id="1661466">=</span>&nbsp;<span class="builtintype" id="1661468">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1661473">for</span>&nbsp;<span class="ident" id="1661477">i</span>&nbsp;<span class="op" id="1661479">:=</span>&nbsp;<span class="builtintype" id="1661482">int</span><span class="op" id="1661485">(</span><span class="ident" id="1661486">sel</span><span class="op" id="1661489">.</span><span class="ident" id="1661490">ncase</span><span class="op" id="1661495">)</span>&nbsp;<span class="op" id="1661497">-</span>&nbsp;<span class="num" id="1661499">1</span><span class="op" id="1661500">;</span>&nbsp;<span class="ident" id="1661502">i</span>&nbsp;<span class="op" id="1661504">&gt;=</span>&nbsp;<span class="num" id="1661507">0</span><span class="op" id="1661508">;</span>&nbsp;<span class="ident" id="1661510">i</span><span class="op" id="1661511">--</span>&nbsp;<span class="op" id="1661514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661518">k</span>&nbsp;<span class="op" id="1661520">=</span>&nbsp;<span class="op" id="1661522">&amp;</span><span class="ident" id="1661523">scases</span><span class="op" id="1661529">[</span><span class="ident" id="1661530">pollorder</span><span class="op" id="1661539">[</span><span class="ident" id="1661540">i</span><span class="op" id="1661541">]</span><span class="op" id="1661542">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1661546">if</span>&nbsp;<span class="ident" id="1661549">sglist</span><span class="op" id="1661555">.</span><span class="ident" id="1661556">releasetime</span>&nbsp;<span class="op" id="1661568">&gt;</span>&nbsp;<span class="num" id="1661570">0</span>&nbsp;<span class="op" id="1661572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661577">k</span><span class="op" id="1661578">.</span><span class="ident" id="1661579">releasetime</span>&nbsp;<span class="op" id="1661591">=</span>&nbsp;<span class="ident" id="1661593">sglist</span><span class="op" id="1661599">.</span><span class="ident" id="1661600">releasetime</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1661614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1661618">if</span>&nbsp;<span class="ident" id="1661621">sg</span>&nbsp;<span class="op" id="1661624">==</span>&nbsp;<span class="ident" id="1661627">sglist</span>&nbsp;<span class="op" id="1661634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661639">cas</span>&nbsp;<span class="op" id="1661643">=</span>&nbsp;<span class="ident" id="1661645">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1661649">}</span>&nbsp;<span class="keyword" id="1661651">else</span>&nbsp;<span class="op" id="1661656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661661">c</span>&nbsp;<span class="op" id="1661663">=</span>&nbsp;<span class="ident" id="1661665">k</span><span class="op" id="1661666">.</span><span class="ident" id="1661667">_chan</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1661676">if</span>&nbsp;<span class="ident" id="1661679">k</span><span class="op" id="1661680">.</span><span class="ident" id="1661681">kind</span>&nbsp;<span class="op" id="1661686">==</span>&nbsp;<span class="ident" id="1661689">_CaseSend</span>&nbsp;<span class="op" id="1661699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661705">c</span><span class="op" id="1661706">.</span><span class="ident" id="1661707">sendq</span><span class="op" id="1661712">.</span><span class="ident" id="1661713">dequeueSudoG</span><span class="op" id="1661725">(</span><span class="ident" id="1661726">sglist</span><span class="op" id="1661732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1661737">}</span>&nbsp;<span class="keyword" id="1661739">else</span>&nbsp;<span class="op" id="1661744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661750">c</span><span class="op" id="1661751">.</span><span class="ident" id="1661752">recvq</span><span class="op" id="1661757">.</span><span class="ident" id="1661758">dequeueSudoG</span><span class="op" id="1661770">(</span><span class="ident" id="1661771">sglist</span><span class="op" id="1661777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1661782">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1661786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661790">sgnext</span>&nbsp;<span class="op" id="1661797">=</span>&nbsp;<span class="ident" id="1661799">sglist</span><span class="op" id="1661805">.</span><span class="ident" id="1661806">waitlink</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661817">sglist</span><span class="op" id="1661823">.</span><span class="ident" id="1661824">waitlink</span>&nbsp;<span class="op" id="1661833">=</span>&nbsp;<span class="builtintype" id="1661835">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661841">releaseSudog</span><span class="op" id="1661853">(</span><span class="ident" id="1661854">sglist</span><span class="op" id="1661860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661864">sglist</span>&nbsp;<span class="op" id="1661871">=</span>&nbsp;<span class="ident" id="1661873">sgnext</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1661881">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1661885">if</span>&nbsp;<span class="ident" id="1661888">cas</span>&nbsp;<span class="op" id="1661892">==</span>&nbsp;<span class="builtintype" id="1661895">nil</span>&nbsp;<span class="op" id="1661899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1661903">goto</span>&nbsp;<span class="ident" id="1661908">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1661914">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661918">c</span>&nbsp;<span class="op" id="1661920">=</span>&nbsp;<span class="ident" id="1661922">cas</span><span class="op" id="1661925">.</span><span class="ident" id="1661926">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1661934">if</span>&nbsp;<span class="ident" id="1661937">c</span><span class="op" id="1661938">.</span><span class="ident" id="1661939">dataqsiz</span>&nbsp;<span class="op" id="1661948">&gt;</span>&nbsp;<span class="num" id="1661950">0</span>&nbsp;<span class="op" id="1661952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661956">gothrow</span><span class="op" id="1661963">(</span><span class="string" id="1661964">&#34;selectgo:&nbsp;shouldn&#39;t&nbsp;happen&#34;</span><span class="op" id="1661992">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1661995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1661999">if</span>&nbsp;<span class="ident" id="1662002">debugSelect</span>&nbsp;<span class="op" id="1662014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1662018">print</span><span class="op" id="1662023">(</span><span class="string" id="1662024">&#34;wait-return:&nbsp;sel=&#34;</span><span class="op" id="1662043">,</span>&nbsp;<span class="ident" id="1662045">sel</span><span class="op" id="1662048">,</span>&nbsp;<span class="string" id="1662050">&#34;&nbsp;c=&#34;</span><span class="op" id="1662055">,</span>&nbsp;<span class="ident" id="1662057">c</span><span class="op" id="1662058">,</span>&nbsp;<span class="string" id="1662060">&#34;&nbsp;cas=&#34;</span><span class="op" id="1662067">,</span>&nbsp;<span class="ident" id="1662069">cas</span><span class="op" id="1662072">,</span>&nbsp;<span class="string" id="1662074">&#34;&nbsp;kind=&#34;</span><span class="op" id="1662082">,</span>&nbsp;<span class="ident" id="1662084">cas</span><span class="op" id="1662087">.</span><span class="ident" id="1662088">kind</span><span class="op" id="1662092">,</span>&nbsp;<span class="string" id="1662094">&#34;\n&#34;</span><span class="op" id="1662098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1662101">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1662105">if</span>&nbsp;<span class="ident" id="1662108">cas</span><span class="op" id="1662111">.</span><span class="ident" id="1662112">kind</span>&nbsp;<span class="op" id="1662117">==</span>&nbsp;<span class="ident" id="1662120">_CaseRecv</span>&nbsp;<span class="op" id="1662130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1662134">if</span>&nbsp;<span class="ident" id="1662137">cas</span><span class="op" id="1662140">.</span><span class="ident" id="1662141">receivedp</span>&nbsp;<span class="op" id="1662151">!=</span>&nbsp;<span class="builtintype" id="1662154">nil</span>&nbsp;<span class="op" id="1662158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1662163">*</span><span class="ident" id="1662164">cas</span><span class="op" id="1662167">.</span><span class="ident" id="1662168">receivedp</span>&nbsp;<span class="op" id="1662178">=</span>&nbsp;<span class="builtintype" id="1662180">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1662187">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1662190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1662194">if</span>&nbsp;<span class="ident" id="1662197">raceenabled</span>&nbsp;<span class="op" id="1662209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1662213">if</span>&nbsp;<span class="ident" id="1662216">cas</span><span class="op" id="1662219">.</span><span class="ident" id="1662220">kind</span>&nbsp;<span class="op" id="1662225">==</span>&nbsp;<span class="ident" id="1662228">_CaseRecv</span>&nbsp;<span class="op" id="1662238">&amp;&amp;</span>&nbsp;<span class="ident" id="1662241">cas</span><span class="op" id="1662244">.</span><span class="ident" id="1662245">elem</span>&nbsp;<span class="op" id="1662250">!=</span>&nbsp;<span class="builtintype" id="1662253">nil</span>&nbsp;<span class="op" id="1662257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662262">raceWriteObjectPC</span><span class="op" id="1662279">(</span><span class="ident" id="1662280">c</span><span class="op" id="1662281">.</span><span class="ident" id="1662282">elemtype</span><span class="op" id="1662290">,</span>&nbsp;<span class="ident" id="1662292">cas</span><span class="op" id="1662295">.</span><span class="ident" id="1662296">elem</span><span class="op" id="1662300">,</span>&nbsp;<span class="ident" id="1662302">cas</span><span class="op" id="1662305">.</span><span class="ident" id="1662306">pc</span><span class="op" id="1662308">,</span>&nbsp;<span class="ident" id="1662310">chanrecvpc</span><span class="op" id="1662320">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1662324">}</span>&nbsp;<span class="keyword" id="1662326">else</span>&nbsp;<span class="keyword" id="1662331">if</span>&nbsp;<span class="ident" id="1662334">cas</span><span class="op" id="1662337">.</span><span class="ident" id="1662338">kind</span>&nbsp;<span class="op" id="1662343">==</span>&nbsp;<span class="ident" id="1662346">_CaseSend</span>&nbsp;<span class="op" id="1662356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662361">raceReadObjectPC</span><span class="op" id="1662377">(</span><span class="ident" id="1662378">c</span><span class="op" id="1662379">.</span><span class="ident" id="1662380">elemtype</span><span class="op" id="1662388">,</span>&nbsp;<span class="ident" id="1662390">cas</span><span class="op" id="1662393">.</span><span class="ident" id="1662394">elem</span><span class="op" id="1662398">,</span>&nbsp;<span class="ident" id="1662400">cas</span><span class="op" id="1662403">.</span><span class="ident" id="1662404">pc</span><span class="op" id="1662406">,</span>&nbsp;<span class="ident" id="1662408">chansendpc</span><span class="op" id="1662418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1662422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1662425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662429">selunlock</span><span class="op" id="1662438">(</span><span class="ident" id="1662439">sel</span><span class="op" id="1662442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1662445">goto</span>&nbsp;<span class="ident" id="1662450">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1662456">asyncrecv</span><span class="op" id="1662465">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1662468">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;buffer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1662496">if</span>&nbsp;<span class="ident" id="1662499">raceenabled</span>&nbsp;<span class="op" id="1662511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1662515">if</span>&nbsp;<span class="ident" id="1662518">cas</span><span class="op" id="1662521">.</span><span class="ident" id="1662522">elem</span>&nbsp;<span class="op" id="1662527">!=</span>&nbsp;<span class="builtintype" id="1662530">nil</span>&nbsp;<span class="op" id="1662534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662539">raceWriteObjectPC</span><span class="op" id="1662556">(</span><span class="ident" id="1662557">c</span><span class="op" id="1662558">.</span><span class="ident" id="1662559">elemtype</span><span class="op" id="1662567">,</span>&nbsp;<span class="ident" id="1662569">cas</span><span class="op" id="1662572">.</span><span class="ident" id="1662573">elem</span><span class="op" id="1662577">,</span>&nbsp;<span class="ident" id="1662579">cas</span><span class="op" id="1662582">.</span><span class="ident" id="1662583">pc</span><span class="op" id="1662585">,</span>&nbsp;<span class="ident" id="1662587">chanrecvpc</span><span class="op" id="1662597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1662601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662605">raceacquire</span><span class="op" id="1662616">(</span><span class="ident" id="1662617">chanbuf</span><span class="op" id="1662624">(</span><span class="ident" id="1662625">c</span><span class="op" id="1662626">,</span>&nbsp;<span class="ident" id="1662628">c</span><span class="op" id="1662629">.</span><span class="ident" id="1662630">recvx</span><span class="op" id="1662635">)</span><span class="op" id="1662636">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662640">racerelease</span><span class="op" id="1662651">(</span><span class="ident" id="1662652">chanbuf</span><span class="op" id="1662659">(</span><span class="ident" id="1662660">c</span><span class="op" id="1662661">,</span>&nbsp;<span class="ident" id="1662663">c</span><span class="op" id="1662664">.</span><span class="ident" id="1662665">recvx</span><span class="op" id="1662670">)</span><span class="op" id="1662671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1662674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1662677">if</span>&nbsp;<span class="ident" id="1662680">cas</span><span class="op" id="1662683">.</span><span class="ident" id="1662684">receivedp</span>&nbsp;<span class="op" id="1662694">!=</span>&nbsp;<span class="builtintype" id="1662697">nil</span>&nbsp;<span class="op" id="1662701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1662705">*</span><span class="ident" id="1662706">cas</span><span class="op" id="1662709">.</span><span class="ident" id="1662710">receivedp</span>&nbsp;<span class="op" id="1662720">=</span>&nbsp;<span class="builtintype" id="1662722">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1662728">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1662731">if</span>&nbsp;<span class="ident" id="1662734">cas</span><span class="op" id="1662737">.</span><span class="ident" id="1662738">elem</span>&nbsp;<span class="op" id="1662743">!=</span>&nbsp;<span class="builtintype" id="1662746">nil</span>&nbsp;<span class="op" id="1662750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662754">memmove</span><span class="op" id="1662761">(</span><span class="ident" id="1662762">cas</span><span class="op" id="1662765">.</span><span class="ident" id="1662766">elem</span><span class="op" id="1662770">,</span>&nbsp;<span class="ident" id="1662772">chanbuf</span><span class="op" id="1662779">(</span><span class="ident" id="1662780">c</span><span class="op" id="1662781">,</span>&nbsp;<span class="ident" id="1662783">c</span><span class="op" id="1662784">.</span><span class="ident" id="1662785">recvx</span><span class="op" id="1662790">)</span><span class="op" id="1662791">,</span>&nbsp;<span class="builtintype" id="1662793">uintptr</span><span class="op" id="1662800">(</span><span class="ident" id="1662801">c</span><span class="op" id="1662802">.</span><span class="ident" id="1662803">elemsize</span><span class="op" id="1662811">)</span><span class="op" id="1662812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1662815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662818">memclr</span><span class="op" id="1662824">(</span><span class="ident" id="1662825">chanbuf</span><span class="op" id="1662832">(</span><span class="ident" id="1662833">c</span><span class="op" id="1662834">,</span>&nbsp;<span class="ident" id="1662836">c</span><span class="op" id="1662837">.</span><span class="ident" id="1662838">recvx</span><span class="op" id="1662843">)</span><span class="op" id="1662844">,</span>&nbsp;<span class="builtintype" id="1662846">uintptr</span><span class="op" id="1662853">(</span><span class="ident" id="1662854">c</span><span class="op" id="1662855">.</span><span class="ident" id="1662856">elemsize</span><span class="op" id="1662864">)</span><span class="op" id="1662865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662868">c</span><span class="op" id="1662869">.</span><span class="ident" id="1662870">recvx</span><span class="op" id="1662875">++</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1662879">if</span>&nbsp;<span class="ident" id="1662882">c</span><span class="op" id="1662883">.</span><span class="ident" id="1662884">recvx</span>&nbsp;<span class="op" id="1662890">==</span>&nbsp;<span class="ident" id="1662893">c</span><span class="op" id="1662894">.</span><span class="ident" id="1662895">dataqsiz</span>&nbsp;<span class="op" id="1662904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662908">c</span><span class="op" id="1662909">.</span><span class="ident" id="1662910">recvx</span>&nbsp;<span class="op" id="1662916">=</span>&nbsp;<span class="num" id="1662918">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1662921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662924">c</span><span class="op" id="1662925">.</span><span class="ident" id="1662926">qcount</span><span class="op" id="1662932">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662936">sg</span>&nbsp;<span class="op" id="1662939">=</span>&nbsp;<span class="ident" id="1662941">c</span><span class="op" id="1662942">.</span><span class="ident" id="1662943">sendq</span><span class="op" id="1662948">.</span><span class="ident" id="1662949">dequeue</span><span class="op" id="1662956">(</span><span class="op" id="1662957">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1662960">if</span>&nbsp;<span class="ident" id="1662963">sg</span>&nbsp;<span class="op" id="1662966">!=</span>&nbsp;<span class="builtintype" id="1662969">nil</span>&nbsp;<span class="op" id="1662973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662977">gp</span>&nbsp;<span class="op" id="1662980">=</span>&nbsp;<span class="ident" id="1662982">sg</span><span class="op" id="1662984">.</span><span class="ident" id="1662985">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662989">selunlock</span><span class="op" id="1662998">(</span><span class="ident" id="1662999">sel</span><span class="op" id="1663002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663006">if</span>&nbsp;<span class="ident" id="1663009">sg</span><span class="op" id="1663011">.</span><span class="ident" id="1663012">releasetime</span>&nbsp;<span class="op" id="1663024">!=</span>&nbsp;<span class="num" id="1663027">0</span>&nbsp;<span class="op" id="1663029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663034">sg</span><span class="op" id="1663036">.</span><span class="ident" id="1663037">releasetime</span>&nbsp;<span class="op" id="1663049">=</span>&nbsp;<span class="ident" id="1663051">cputicks</span><span class="op" id="1663059">(</span><span class="op" id="1663060">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663068">goready</span><span class="op" id="1663075">(</span><span class="ident" id="1663076">gp</span><span class="op" id="1663078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663081">}</span>&nbsp;<span class="keyword" id="1663083">else</span>&nbsp;<span class="op" id="1663088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663092">selunlock</span><span class="op" id="1663101">(</span><span class="ident" id="1663102">sel</span><span class="op" id="1663105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663108">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663111">goto</span>&nbsp;<span class="ident" id="1663116">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1663122">asyncsend</span><span class="op" id="1663131">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1663134">//&nbsp;can&nbsp;send&nbsp;to&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663157">if</span>&nbsp;<span class="ident" id="1663160">raceenabled</span>&nbsp;<span class="op" id="1663172">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663176">raceacquire</span><span class="op" id="1663187">(</span><span class="ident" id="1663188">chanbuf</span><span class="op" id="1663195">(</span><span class="ident" id="1663196">c</span><span class="op" id="1663197">,</span>&nbsp;<span class="ident" id="1663199">c</span><span class="op" id="1663200">.</span><span class="ident" id="1663201">sendx</span><span class="op" id="1663206">)</span><span class="op" id="1663207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663211">racerelease</span><span class="op" id="1663222">(</span><span class="ident" id="1663223">chanbuf</span><span class="op" id="1663230">(</span><span class="ident" id="1663231">c</span><span class="op" id="1663232">,</span>&nbsp;<span class="ident" id="1663234">c</span><span class="op" id="1663235">.</span><span class="ident" id="1663236">sendx</span><span class="op" id="1663241">)</span><span class="op" id="1663242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663246">raceReadObjectPC</span><span class="op" id="1663262">(</span><span class="ident" id="1663263">c</span><span class="op" id="1663264">.</span><span class="ident" id="1663265">elemtype</span><span class="op" id="1663273">,</span>&nbsp;<span class="ident" id="1663275">cas</span><span class="op" id="1663278">.</span><span class="ident" id="1663279">elem</span><span class="op" id="1663283">,</span>&nbsp;<span class="ident" id="1663285">cas</span><span class="op" id="1663288">.</span><span class="ident" id="1663289">pc</span><span class="op" id="1663291">,</span>&nbsp;<span class="ident" id="1663293">chansendpc</span><span class="op" id="1663303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663309">memmove</span><span class="op" id="1663316">(</span><span class="ident" id="1663317">chanbuf</span><span class="op" id="1663324">(</span><span class="ident" id="1663325">c</span><span class="op" id="1663326">,</span>&nbsp;<span class="ident" id="1663328">c</span><span class="op" id="1663329">.</span><span class="ident" id="1663330">sendx</span><span class="op" id="1663335">)</span><span class="op" id="1663336">,</span>&nbsp;<span class="ident" id="1663338">cas</span><span class="op" id="1663341">.</span><span class="ident" id="1663342">elem</span><span class="op" id="1663346">,</span>&nbsp;<span class="builtintype" id="1663348">uintptr</span><span class="op" id="1663355">(</span><span class="ident" id="1663356">c</span><span class="op" id="1663357">.</span><span class="ident" id="1663358">elemsize</span><span class="op" id="1663366">)</span><span class="op" id="1663367">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663370">c</span><span class="op" id="1663371">.</span><span class="ident" id="1663372">sendx</span><span class="op" id="1663377">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663381">if</span>&nbsp;<span class="ident" id="1663384">c</span><span class="op" id="1663385">.</span><span class="ident" id="1663386">sendx</span>&nbsp;<span class="op" id="1663392">==</span>&nbsp;<span class="ident" id="1663395">c</span><span class="op" id="1663396">.</span><span class="ident" id="1663397">dataqsiz</span>&nbsp;<span class="op" id="1663406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663410">c</span><span class="op" id="1663411">.</span><span class="ident" id="1663412">sendx</span>&nbsp;<span class="op" id="1663418">=</span>&nbsp;<span class="num" id="1663420">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663426">c</span><span class="op" id="1663427">.</span><span class="ident" id="1663428">qcount</span><span class="op" id="1663434">++</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663438">sg</span>&nbsp;<span class="op" id="1663441">=</span>&nbsp;<span class="ident" id="1663443">c</span><span class="op" id="1663444">.</span><span class="ident" id="1663445">recvq</span><span class="op" id="1663450">.</span><span class="ident" id="1663451">dequeue</span><span class="op" id="1663458">(</span><span class="op" id="1663459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663462">if</span>&nbsp;<span class="ident" id="1663465">sg</span>&nbsp;<span class="op" id="1663468">!=</span>&nbsp;<span class="builtintype" id="1663471">nil</span>&nbsp;<span class="op" id="1663475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663479">gp</span>&nbsp;<span class="op" id="1663482">=</span>&nbsp;<span class="ident" id="1663484">sg</span><span class="op" id="1663486">.</span><span class="ident" id="1663487">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663491">selunlock</span><span class="op" id="1663500">(</span><span class="ident" id="1663501">sel</span><span class="op" id="1663504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663508">if</span>&nbsp;<span class="ident" id="1663511">sg</span><span class="op" id="1663513">.</span><span class="ident" id="1663514">releasetime</span>&nbsp;<span class="op" id="1663526">!=</span>&nbsp;<span class="num" id="1663529">0</span>&nbsp;<span class="op" id="1663531">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663536">sg</span><span class="op" id="1663538">.</span><span class="ident" id="1663539">releasetime</span>&nbsp;<span class="op" id="1663551">=</span>&nbsp;<span class="ident" id="1663553">cputicks</span><span class="op" id="1663561">(</span><span class="op" id="1663562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663570">goready</span><span class="op" id="1663577">(</span><span class="ident" id="1663578">gp</span><span class="op" id="1663580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663583">}</span>&nbsp;<span class="keyword" id="1663585">else</span>&nbsp;<span class="op" id="1663590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663594">selunlock</span><span class="op" id="1663603">(</span><span class="ident" id="1663604">sel</span><span class="op" id="1663607">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663613">goto</span>&nbsp;<span class="ident" id="1663618">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1663624">syncrecv</span><span class="op" id="1663632">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1663635">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;sleeping&nbsp;sender&nbsp;(sg)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663677">if</span>&nbsp;<span class="ident" id="1663680">raceenabled</span>&nbsp;<span class="op" id="1663692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663696">if</span>&nbsp;<span class="ident" id="1663699">cas</span><span class="op" id="1663702">.</span><span class="ident" id="1663703">elem</span>&nbsp;<span class="op" id="1663708">!=</span>&nbsp;<span class="builtintype" id="1663711">nil</span>&nbsp;<span class="op" id="1663715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663720">raceWriteObjectPC</span><span class="op" id="1663737">(</span><span class="ident" id="1663738">c</span><span class="op" id="1663739">.</span><span class="ident" id="1663740">elemtype</span><span class="op" id="1663748">,</span>&nbsp;<span class="ident" id="1663750">cas</span><span class="op" id="1663753">.</span><span class="ident" id="1663754">elem</span><span class="op" id="1663758">,</span>&nbsp;<span class="ident" id="1663760">cas</span><span class="op" id="1663763">.</span><span class="ident" id="1663764">pc</span><span class="op" id="1663766">,</span>&nbsp;<span class="ident" id="1663768">chanrecvpc</span><span class="op" id="1663778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663786">racesync</span><span class="op" id="1663794">(</span><span class="ident" id="1663795">c</span><span class="op" id="1663796">,</span>&nbsp;<span class="ident" id="1663798">sg</span><span class="op" id="1663800">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663806">selunlock</span><span class="op" id="1663815">(</span><span class="ident" id="1663816">sel</span><span class="op" id="1663819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663822">if</span>&nbsp;<span class="ident" id="1663825">debugSelect</span>&nbsp;<span class="op" id="1663837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1663841">print</span><span class="op" id="1663846">(</span><span class="string" id="1663847">&#34;syncrecv:&nbsp;sel=&#34;</span><span class="op" id="1663863">,</span>&nbsp;<span class="ident" id="1663865">sel</span><span class="op" id="1663868">,</span>&nbsp;<span class="string" id="1663870">&#34;&nbsp;c=&#34;</span><span class="op" id="1663875">,</span>&nbsp;<span class="ident" id="1663877">c</span><span class="op" id="1663878">,</span>&nbsp;<span class="string" id="1663880">&#34;\n&#34;</span><span class="op" id="1663884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663887">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663890">if</span>&nbsp;<span class="ident" id="1663893">cas</span><span class="op" id="1663896">.</span><span class="ident" id="1663897">receivedp</span>&nbsp;<span class="op" id="1663907">!=</span>&nbsp;<span class="builtintype" id="1663910">nil</span>&nbsp;<span class="op" id="1663914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663918">*</span><span class="ident" id="1663919">cas</span><span class="op" id="1663922">.</span><span class="ident" id="1663923">receivedp</span>&nbsp;<span class="op" id="1663933">=</span>&nbsp;<span class="builtintype" id="1663935">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663944">if</span>&nbsp;<span class="ident" id="1663947">cas</span><span class="op" id="1663950">.</span><span class="ident" id="1663951">elem</span>&nbsp;<span class="op" id="1663956">!=</span>&nbsp;<span class="builtintype" id="1663959">nil</span>&nbsp;<span class="op" id="1663963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663967">memmove</span><span class="op" id="1663974">(</span><span class="ident" id="1663975">cas</span><span class="op" id="1663978">.</span><span class="ident" id="1663979">elem</span><span class="op" id="1663983">,</span>&nbsp;<span class="ident" id="1663985">sg</span><span class="op" id="1663987">.</span><span class="ident" id="1663988">elem</span><span class="op" id="1663992">,</span>&nbsp;<span class="builtintype" id="1663994">uintptr</span><span class="op" id="1664001">(</span><span class="ident" id="1664002">c</span><span class="op" id="1664003">.</span><span class="ident" id="1664004">elemsize</span><span class="op" id="1664012">)</span><span class="op" id="1664013">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664019">sg</span><span class="op" id="1664021">.</span><span class="ident" id="1664022">elem</span>&nbsp;<span class="op" id="1664027">=</span>&nbsp;<span class="builtintype" id="1664029">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664034">gp</span>&nbsp;<span class="op" id="1664037">=</span>&nbsp;<span class="ident" id="1664039">sg</span><span class="op" id="1664041">.</span><span class="ident" id="1664042">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664045">gp</span><span class="op" id="1664047">.</span><span class="ident" id="1664048">param</span>&nbsp;<span class="op" id="1664054">=</span>&nbsp;<span class="ident" id="1664056">unsafe</span><span class="op" id="1664062">.</span><span class="ident" id="1664063">Pointer</span><span class="op" id="1664070">(</span><span class="ident" id="1664071">sg</span><span class="op" id="1664073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664076">if</span>&nbsp;<span class="ident" id="1664079">sg</span><span class="op" id="1664081">.</span><span class="ident" id="1664082">releasetime</span>&nbsp;<span class="op" id="1664094">!=</span>&nbsp;<span class="num" id="1664097">0</span>&nbsp;<span class="op" id="1664099">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664103">sg</span><span class="op" id="1664105">.</span><span class="ident" id="1664106">releasetime</span>&nbsp;<span class="op" id="1664118">=</span>&nbsp;<span class="ident" id="1664120">cputicks</span><span class="op" id="1664128">(</span><span class="op" id="1664129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664135">goready</span><span class="op" id="1664142">(</span><span class="ident" id="1664143">gp</span><span class="op" id="1664145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664148">goto</span>&nbsp;<span class="ident" id="1664153">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="ident" id="1664159">rclose</span><span class="op" id="1664165">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1664168">//&nbsp;read&nbsp;at&nbsp;end&nbsp;of&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664202">selunlock</span><span class="op" id="1664211">(</span><span class="ident" id="1664212">sel</span><span class="op" id="1664215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664218">if</span>&nbsp;<span class="ident" id="1664221">cas</span><span class="op" id="1664224">.</span><span class="ident" id="1664225">receivedp</span>&nbsp;<span class="op" id="1664235">!=</span>&nbsp;<span class="builtintype" id="1664238">nil</span>&nbsp;<span class="op" id="1664242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664246">*</span><span class="ident" id="1664247">cas</span><span class="op" id="1664250">.</span><span class="ident" id="1664251">receivedp</span>&nbsp;<span class="op" id="1664261">=</span>&nbsp;<span class="builtintype" id="1664263">false</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664273">if</span>&nbsp;<span class="ident" id="1664276">cas</span><span class="op" id="1664279">.</span><span class="ident" id="1664280">elem</span>&nbsp;<span class="op" id="1664285">!=</span>&nbsp;<span class="builtintype" id="1664288">nil</span>&nbsp;<span class="op" id="1664292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664296">memclr</span><span class="op" id="1664302">(</span><span class="ident" id="1664303">cas</span><span class="op" id="1664306">.</span><span class="ident" id="1664307">elem</span><span class="op" id="1664311">,</span>&nbsp;<span class="builtintype" id="1664313">uintptr</span><span class="op" id="1664320">(</span><span class="ident" id="1664321">c</span><span class="op" id="1664322">.</span><span class="ident" id="1664323">elemsize</span><span class="op" id="1664331">)</span><span class="op" id="1664332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664338">if</span>&nbsp;<span class="ident" id="1664341">raceenabled</span>&nbsp;<span class="op" id="1664353">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664357">raceacquire</span><span class="op" id="1664368">(</span><span class="ident" id="1664369">unsafe</span><span class="op" id="1664375">.</span><span class="ident" id="1664376">Pointer</span><span class="op" id="1664383">(</span><span class="ident" id="1664384">c</span><span class="op" id="1664385">)</span><span class="op" id="1664386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664392">goto</span>&nbsp;<span class="ident" id="1664397">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1664403">syncsend</span><span class="op" id="1664411">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1664414">//&nbsp;can&nbsp;send&nbsp;to&nbsp;sleeping&nbsp;receiver&nbsp;(sg)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664453">if</span>&nbsp;<span class="ident" id="1664456">raceenabled</span>&nbsp;<span class="op" id="1664468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664472">raceReadObjectPC</span><span class="op" id="1664488">(</span><span class="ident" id="1664489">c</span><span class="op" id="1664490">.</span><span class="ident" id="1664491">elemtype</span><span class="op" id="1664499">,</span>&nbsp;<span class="ident" id="1664501">cas</span><span class="op" id="1664504">.</span><span class="ident" id="1664505">elem</span><span class="op" id="1664509">,</span>&nbsp;<span class="ident" id="1664511">cas</span><span class="op" id="1664514">.</span><span class="ident" id="1664515">pc</span><span class="op" id="1664517">,</span>&nbsp;<span class="ident" id="1664519">chansendpc</span><span class="op" id="1664529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664533">racesync</span><span class="op" id="1664541">(</span><span class="ident" id="1664542">c</span><span class="op" id="1664543">,</span>&nbsp;<span class="ident" id="1664545">sg</span><span class="op" id="1664547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664550">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664553">selunlock</span><span class="op" id="1664562">(</span><span class="ident" id="1664563">sel</span><span class="op" id="1664566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664569">if</span>&nbsp;<span class="ident" id="1664572">debugSelect</span>&nbsp;<span class="op" id="1664584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1664588">print</span><span class="op" id="1664593">(</span><span class="string" id="1664594">&#34;syncsend:&nbsp;sel=&#34;</span><span class="op" id="1664610">,</span>&nbsp;<span class="ident" id="1664612">sel</span><span class="op" id="1664615">,</span>&nbsp;<span class="string" id="1664617">&#34;&nbsp;c=&#34;</span><span class="op" id="1664622">,</span>&nbsp;<span class="ident" id="1664624">c</span><span class="op" id="1664625">,</span>&nbsp;<span class="string" id="1664627">&#34;\n&#34;</span><span class="op" id="1664631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664637">if</span>&nbsp;<span class="ident" id="1664640">sg</span><span class="op" id="1664642">.</span><span class="ident" id="1664643">elem</span>&nbsp;<span class="op" id="1664648">!=</span>&nbsp;<span class="builtintype" id="1664651">nil</span>&nbsp;<span class="op" id="1664655">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664659">memmove</span><span class="op" id="1664666">(</span><span class="ident" id="1664667">sg</span><span class="op" id="1664669">.</span><span class="ident" id="1664670">elem</span><span class="op" id="1664674">,</span>&nbsp;<span class="ident" id="1664676">cas</span><span class="op" id="1664679">.</span><span class="ident" id="1664680">elem</span><span class="op" id="1664684">,</span>&nbsp;<span class="builtintype" id="1664686">uintptr</span><span class="op" id="1664693">(</span><span class="ident" id="1664694">c</span><span class="op" id="1664695">.</span><span class="ident" id="1664696">elemsize</span><span class="op" id="1664704">)</span><span class="op" id="1664705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664711">sg</span><span class="op" id="1664713">.</span><span class="ident" id="1664714">elem</span>&nbsp;<span class="op" id="1664719">=</span>&nbsp;<span class="builtintype" id="1664721">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664726">gp</span>&nbsp;<span class="op" id="1664729">=</span>&nbsp;<span class="ident" id="1664731">sg</span><span class="op" id="1664733">.</span><span class="ident" id="1664734">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664737">gp</span><span class="op" id="1664739">.</span><span class="ident" id="1664740">param</span>&nbsp;<span class="op" id="1664746">=</span>&nbsp;<span class="ident" id="1664748">unsafe</span><span class="op" id="1664754">.</span><span class="ident" id="1664755">Pointer</span><span class="op" id="1664762">(</span><span class="ident" id="1664763">sg</span><span class="op" id="1664765">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664768">if</span>&nbsp;<span class="ident" id="1664771">sg</span><span class="op" id="1664773">.</span><span class="ident" id="1664774">releasetime</span>&nbsp;<span class="op" id="1664786">!=</span>&nbsp;<span class="num" id="1664789">0</span>&nbsp;<span class="op" id="1664791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664795">sg</span><span class="op" id="1664797">.</span><span class="ident" id="1664798">releasetime</span>&nbsp;<span class="op" id="1664810">=</span>&nbsp;<span class="ident" id="1664812">cputicks</span><span class="op" id="1664820">(</span><span class="op" id="1664821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664827">goready</span><span class="op" id="1664834">(</span><span class="ident" id="1664835">gp</span><span class="op" id="1664837">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span><span class="ident" id="1664840">retc</span><span class="op" id="1664844">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664847">if</span>&nbsp;<span class="ident" id="1664850">cas</span><span class="op" id="1664853">.</span><span class="ident" id="1664854">releasetime</span>&nbsp;<span class="op" id="1664866">&gt;</span>&nbsp;<span class="num" id="1664868">0</span>&nbsp;<span class="op" id="1664870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664874">blockevent</span><span class="op" id="1664884">(</span><span class="ident" id="1664885">cas</span><span class="op" id="1664888">.</span><span class="ident" id="1664889">releasetime</span><span class="op" id="1664900">-</span><span class="ident" id="1664901">t0</span><span class="op" id="1664903">,</span>&nbsp;<span class="num" id="1664905">2</span><span class="op" id="1664906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664912">return</span>&nbsp;<span class="ident" id="1664919">cas</span><span class="op" id="1664922">.</span><span class="ident" id="1664923">pc</span><span class="op" id="1664925">,</span>&nbsp;<span class="ident" id="1664927">cas</span><span class="op" id="1664930">.</span><span class="ident" id="1664931">so</span><br>
<span class="lineno">570</span><br>
<span class="lineno"></span><span class="ident" id="1664935">sclose</span><span class="op" id="1664941">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1664944">//&nbsp;send&nbsp;on&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664971">selunlock</span><span class="op" id="1664980">(</span><span class="ident" id="1664981">sel</span><span class="op" id="1664984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1664987">panic</span><span class="op" id="1664992">(</span><span class="string" id="1664993">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1665017">)</span><br>
<span class="lineno">575</span><span class="op" id="1665019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1665022">func</span>&nbsp;<span class="op" id="1665027">(</span><span class="ident" id="1665028">c</span>&nbsp;<span class="op" id="1665030">*</span><span class="ident" id="1665031">hchan</span><span class="op" id="1665036">)</span>&nbsp;<span class="ident" id="1665038">sortkey</span><span class="op" id="1665045">(</span><span class="op" id="1665046">)</span>&nbsp;<span class="builtintype" id="1665048">uintptr</span>&nbsp;<span class="op" id="1665056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1665059">//&nbsp;TODO(khr):&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;moving&nbsp;garbage&nbsp;collector,&nbsp;we&#39;ll&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1665127">//&nbsp;change&nbsp;this&nbsp;function.</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1665153">return</span>&nbsp;<span class="builtintype" id="1665160">uintptr</span><span class="op" id="1665167">(</span><span class="ident" id="1665168">unsafe</span><span class="op" id="1665174">.</span><span class="ident" id="1665175">Pointer</span><span class="op" id="1665182">(</span><span class="ident" id="1665183">c</span><span class="op" id="1665184">)</span><span class="op" id="1665185">)</span><br>
<span class="lineno"></span><span class="op" id="1665187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1665190">//&nbsp;A&nbsp;runtimeSelect&nbsp;is&nbsp;a&nbsp;single&nbsp;case&nbsp;passed&nbsp;to&nbsp;rselect.</span><br>
<span class="lineno"></span><span class="comment" id="1665245">//&nbsp;This&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/runtimeSelect</span><br>
<span class="lineno">585</span><span class="keyword" id="1665299">type</span>&nbsp;<span class="ident" id="1665304">runtimeSelect</span>&nbsp;<span class="keyword" id="1665318">struct</span>&nbsp;<span class="op" id="1665325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665328">dir</span>&nbsp;<span class="ident" id="1665332">selectDir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665343">typ</span>&nbsp;<span class="ident" id="1665347">unsafe</span><span class="op" id="1665353">.</span><span class="ident" id="1665354">Pointer</span>&nbsp;<span class="comment" id="1665362">//&nbsp;channel&nbsp;type&nbsp;(not&nbsp;used&nbsp;here)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665395">ch</span>&nbsp;&nbsp;<span class="op" id="1665399">*</span><span class="ident" id="1665400">hchan</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1665414">//&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665426">val</span>&nbsp;<span class="ident" id="1665430">unsafe</span><span class="op" id="1665436">.</span><span class="ident" id="1665437">Pointer</span>&nbsp;<span class="comment" id="1665445">//&nbsp;ptr&nbsp;to&nbsp;data&nbsp;(SendDir)&nbsp;or&nbsp;ptr&nbsp;to&nbsp;receive&nbsp;buffer&nbsp;(RecvDir)</span><br>
<span class="lineno">590</span><span class="op" id="1665505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1665508">//&nbsp;These&nbsp;values&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/SelectDir.</span><br>
<span class="lineno"></span><span class="keyword" id="1665567">type</span>&nbsp;<span class="ident" id="1665572">selectDir</span>&nbsp;<span class="builtintype" id="1665582">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span><span class="keyword" id="1665587">const</span>&nbsp;<span class="op" id="1665593">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665596">_</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665610">selectDir</span>&nbsp;<span class="op" id="1665620">=</span>&nbsp;<span class="ident" id="1665622">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665628">selectSend</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1665652">//&nbsp;case&nbsp;Chan&nbsp;&lt;-&nbsp;Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665674">selectRecv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1665698">//&nbsp;case&nbsp;&lt;-Chan:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665715">selectDefault</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1665739">//&nbsp;default</span><br>
<span class="lineno">600</span><span class="op" id="1665750">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1665753">func</span>&nbsp;<span class="ident" id="1665758">reflect_rselect</span><span class="op" id="1665773">(</span><span class="ident" id="1665774">cases</span>&nbsp;<span class="op" id="1665780">[</span><span class="op" id="1665781">]</span><span class="ident" id="1665782">runtimeSelect</span><span class="op" id="1665795">)</span>&nbsp;<span class="op" id="1665797">(</span><span class="ident" id="1665798">chosen</span>&nbsp;<span class="builtintype" id="1665805">int</span><span class="op" id="1665808">,</span>&nbsp;<span class="ident" id="1665810">recvOK</span>&nbsp;<span class="builtintype" id="1665817">bool</span><span class="op" id="1665821">)</span>&nbsp;<span class="op" id="1665823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1665826">//&nbsp;flagNoScan&nbsp;is&nbsp;safe&nbsp;here,&nbsp;because&nbsp;all&nbsp;objects&nbsp;are&nbsp;also&nbsp;referenced&nbsp;from&nbsp;cases.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665907">size</span>&nbsp;<span class="op" id="1665912">:=</span>&nbsp;<span class="ident" id="1665915">selectsize</span><span class="op" id="1665925">(</span><span class="builtintype" id="1665926">uintptr</span><span class="op" id="1665933">(</span><span class="builtinfunc" id="1665934">len</span><span class="op" id="1665937">(</span><span class="ident" id="1665938">cases</span><span class="op" id="1665943">)</span><span class="op" id="1665944">)</span><span class="op" id="1665945">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665948">sel</span>&nbsp;<span class="op" id="1665952">:=</span>&nbsp;<span class="op" id="1665955">(</span><span class="op" id="1665956">*</span><span class="ident" id="1665957">_select</span><span class="op" id="1665964">)</span><span class="op" id="1665965">(</span><span class="ident" id="1665966">mallocgc</span><span class="op" id="1665974">(</span><span class="ident" id="1665975">size</span><span class="op" id="1665979">,</span>&nbsp;<span class="builtintype" id="1665981">nil</span><span class="op" id="1665984">,</span>&nbsp;<span class="ident" id="1665986">flagNoScan</span><span class="op" id="1665996">)</span><span class="op" id="1665997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666000">newselect</span><span class="op" id="1666009">(</span><span class="ident" id="1666010">sel</span><span class="op" id="1666013">,</span>&nbsp;<span class="ident" id="1666015">int64</span><span class="op" id="1666020">(</span><span class="ident" id="1666021">size</span><span class="op" id="1666025">)</span><span class="op" id="1666026">,</span>&nbsp;<span class="builtintype" id="1666028">int32</span><span class="op" id="1666033">(</span><span class="builtinfunc" id="1666034">len</span><span class="op" id="1666037">(</span><span class="ident" id="1666038">cases</span><span class="op" id="1666043">)</span><span class="op" id="1666044">)</span><span class="op" id="1666045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666048">r</span>&nbsp;<span class="op" id="1666050">:=</span>&nbsp;<span class="builtinfunc" id="1666053">new</span><span class="op" id="1666056">(</span><span class="builtintype" id="1666057">bool</span><span class="op" id="1666061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666064">for</span>&nbsp;<span class="ident" id="1666068">i</span>&nbsp;<span class="op" id="1666070">:=</span>&nbsp;<span class="keyword" id="1666073">range</span>&nbsp;<span class="ident" id="1666079">cases</span>&nbsp;<span class="op" id="1666085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666089">rc</span>&nbsp;<span class="op" id="1666092">:=</span>&nbsp;<span class="op" id="1666095">&amp;</span><span class="ident" id="1666096">cases</span><span class="op" id="1666101">[</span><span class="ident" id="1666102">i</span><span class="op" id="1666103">]</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666107">switch</span>&nbsp;<span class="ident" id="1666114">rc</span><span class="op" id="1666116">.</span><span class="ident" id="1666117">dir</span>&nbsp;<span class="op" id="1666121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666125">case</span>&nbsp;<span class="ident" id="1666130">selectDefault</span><span class="op" id="1666143">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666148">selectdefaultImpl</span><span class="op" id="1666165">(</span><span class="ident" id="1666166">sel</span><span class="op" id="1666169">,</span>&nbsp;<span class="builtintype" id="1666171">uintptr</span><span class="op" id="1666178">(</span><span class="ident" id="1666179">i</span><span class="op" id="1666180">)</span><span class="op" id="1666181">,</span>&nbsp;<span class="num" id="1666183">0</span><span class="op" id="1666184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666188">case</span>&nbsp;<span class="ident" id="1666193">selectSend</span><span class="op" id="1666203">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666208">if</span>&nbsp;<span class="ident" id="1666211">rc</span><span class="op" id="1666213">.</span><span class="ident" id="1666214">ch</span>&nbsp;<span class="op" id="1666217">==</span>&nbsp;<span class="builtintype" id="1666220">nil</span>&nbsp;<span class="op" id="1666224">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666230">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1666239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666244">selectsendImpl</span><span class="op" id="1666258">(</span><span class="ident" id="1666259">sel</span><span class="op" id="1666262">,</span>&nbsp;<span class="ident" id="1666264">rc</span><span class="op" id="1666266">.</span><span class="ident" id="1666267">ch</span><span class="op" id="1666269">,</span>&nbsp;<span class="builtintype" id="1666271">uintptr</span><span class="op" id="1666278">(</span><span class="ident" id="1666279">i</span><span class="op" id="1666280">)</span><span class="op" id="1666281">,</span>&nbsp;<span class="ident" id="1666283">rc</span><span class="op" id="1666285">.</span><span class="ident" id="1666286">val</span><span class="op" id="1666289">,</span>&nbsp;<span class="num" id="1666291">0</span><span class="op" id="1666292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666296">case</span>&nbsp;<span class="ident" id="1666301">selectRecv</span><span class="op" id="1666311">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666316">if</span>&nbsp;<span class="ident" id="1666319">rc</span><span class="op" id="1666321">.</span><span class="ident" id="1666322">ch</span>&nbsp;<span class="op" id="1666325">==</span>&nbsp;<span class="builtintype" id="1666328">nil</span>&nbsp;<span class="op" id="1666332">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666338">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1666347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666352">selectrecvImpl</span><span class="op" id="1666366">(</span><span class="ident" id="1666367">sel</span><span class="op" id="1666370">,</span>&nbsp;<span class="ident" id="1666372">rc</span><span class="op" id="1666374">.</span><span class="ident" id="1666375">ch</span><span class="op" id="1666377">,</span>&nbsp;<span class="builtintype" id="1666379">uintptr</span><span class="op" id="1666386">(</span><span class="ident" id="1666387">i</span><span class="op" id="1666388">)</span><span class="op" id="1666389">,</span>&nbsp;<span class="ident" id="1666391">rc</span><span class="op" id="1666393">.</span><span class="ident" id="1666394">val</span><span class="op" id="1666397">,</span>&nbsp;<span class="ident" id="1666399">r</span><span class="op" id="1666400">,</span>&nbsp;<span class="num" id="1666402">0</span><span class="op" id="1666403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1666407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1666410">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666414">pc</span><span class="op" id="1666416">,</span>&nbsp;<span class="ident" id="1666418">_</span>&nbsp;<span class="op" id="1666420">:=</span>&nbsp;<span class="ident" id="1666423">selectgoImpl</span><span class="op" id="1666435">(</span><span class="ident" id="1666436">sel</span><span class="op" id="1666439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666442">chosen</span>&nbsp;<span class="op" id="1666449">=</span>&nbsp;<span class="builtintype" id="1666451">int</span><span class="op" id="1666454">(</span><span class="ident" id="1666455">pc</span><span class="op" id="1666457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666460">recvOK</span>&nbsp;<span class="op" id="1666467">=</span>&nbsp;<span class="op" id="1666469">*</span><span class="ident" id="1666470">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666473">return</span><br>
<span class="lineno">630</span><span class="op" id="1666480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1666483">func</span>&nbsp;<span class="op" id="1666488">(</span><span class="ident" id="1666489">q</span>&nbsp;<span class="op" id="1666491">*</span><span class="ident" id="1666492">waitq</span><span class="op" id="1666497">)</span>&nbsp;<span class="ident" id="1666499">dequeueSudoG</span><span class="op" id="1666511">(</span><span class="ident" id="1666512">s</span>&nbsp;<span class="op" id="1666514">*</span><span class="ident" id="1666515">sudog</span><span class="op" id="1666520">)</span>&nbsp;<span class="op" id="1666522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666525">var</span>&nbsp;<span class="ident" id="1666529">prevsgp</span>&nbsp;<span class="op" id="1666537">*</span><span class="ident" id="1666538">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666545">l</span>&nbsp;<span class="op" id="1666547">:=</span>&nbsp;<span class="op" id="1666550">&amp;</span><span class="ident" id="1666551">q</span><span class="op" id="1666552">.</span><span class="ident" id="1666553">first</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666560">for</span>&nbsp;<span class="op" id="1666564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666568">sgp</span>&nbsp;<span class="op" id="1666572">:=</span>&nbsp;<span class="op" id="1666575">*</span><span class="ident" id="1666576">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666580">if</span>&nbsp;<span class="ident" id="1666583">sgp</span>&nbsp;<span class="op" id="1666587">==</span>&nbsp;<span class="builtintype" id="1666590">nil</span>&nbsp;<span class="op" id="1666594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666599">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1666608">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666612">if</span>&nbsp;<span class="ident" id="1666615">sgp</span>&nbsp;<span class="op" id="1666619">==</span>&nbsp;<span class="ident" id="1666622">s</span>&nbsp;<span class="op" id="1666624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1666629">*</span><span class="ident" id="1666630">l</span>&nbsp;<span class="op" id="1666632">=</span>&nbsp;<span class="ident" id="1666634">sgp</span><span class="op" id="1666637">.</span><span class="ident" id="1666638">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666646">if</span>&nbsp;<span class="ident" id="1666649">q</span><span class="op" id="1666650">.</span><span class="ident" id="1666651">last</span>&nbsp;<span class="op" id="1666656">==</span>&nbsp;<span class="ident" id="1666659">sgp</span>&nbsp;<span class="op" id="1666663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666669">q</span><span class="op" id="1666670">.</span><span class="ident" id="1666671">last</span>&nbsp;<span class="op" id="1666676">=</span>&nbsp;<span class="ident" id="1666678">prevsgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1666689">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666694">s</span><span class="op" id="1666695">.</span><span class="ident" id="1666696">next</span>&nbsp;<span class="op" id="1666701">=</span>&nbsp;<span class="builtintype" id="1666703">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666710">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1666719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666723">l</span>&nbsp;<span class="op" id="1666725">=</span>&nbsp;<span class="op" id="1666727">&amp;</span><span class="ident" id="1666728">sgp</span><span class="op" id="1666731">.</span><span class="ident" id="1666732">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666739">prevsgp</span>&nbsp;<span class="op" id="1666747">=</span>&nbsp;<span class="ident" id="1666749">sgp</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1666754">}</span><br>
<span class="lineno"></span><span class="op" id="1666756">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
