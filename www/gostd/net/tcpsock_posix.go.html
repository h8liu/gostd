<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html" class="current">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3180818">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3180874">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3180928">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3180979">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3181057">package</span>&nbsp;<span class="ident" id="3181065">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3181070">import</span>&nbsp;<span class="op" id="3181077">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3181080">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3181086">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3181092">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3181103">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3181110">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="3181113">//&nbsp;BUG(rsc):&nbsp;On&nbsp;OpenBSD,&nbsp;listening&nbsp;on&nbsp;the&nbsp;&#34;tcp&#34;&nbsp;network&nbsp;does&nbsp;not&nbsp;listen&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3181189">//&nbsp;both&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;connections.&nbsp;This&nbsp;is&nbsp;due&nbsp;to&nbsp;the&nbsp;fact&nbsp;that&nbsp;IPv4&nbsp;traffic</span><br>
<span class="lineno"></span><span class="comment" id="3181266">//&nbsp;will&nbsp;not&nbsp;be&nbsp;routed&nbsp;to&nbsp;an&nbsp;IPv6&nbsp;socket&nbsp;-&nbsp;two&nbsp;separate&nbsp;sockets&nbsp;are&nbsp;required</span><br>
<span class="lineno"></span><span class="comment" id="3181342">//&nbsp;if&nbsp;both&nbsp;AFs&nbsp;are&nbsp;to&nbsp;be&nbsp;supported.&nbsp;See&nbsp;inet6(4)&nbsp;on&nbsp;OpenBSD&nbsp;for&nbsp;details.</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3181416">func</span>&nbsp;<span class="ident" id="3181421">sockaddrToTCP</span><span class="op" id="3181434">(</span><span class="ident" id="3181435">sa</span>&nbsp;<span class="ident" id="3181438">syscall</span><span class="op" id="3181445">.</span><span class="ident" id="3181446">Sockaddr</span><span class="op" id="3181454">)</span>&nbsp;<span class="ident" id="3181456">Addr</span>&nbsp;<span class="op" id="3181461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3181464">switch</span>&nbsp;<span class="ident" id="3181471">sa</span>&nbsp;<span class="op" id="3181474">:=</span>&nbsp;<span class="ident" id="3181477">sa</span><span class="op" id="3181479">.</span><span class="op" id="3181480">(</span><span class="keyword" id="3181481">type</span><span class="op" id="3181485">)</span>&nbsp;<span class="op" id="3181487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3181490">case</span>&nbsp;<span class="op" id="3181495">*</span><span class="ident" id="3181496">syscall</span><span class="op" id="3181503">.</span><span class="ident" id="3181504">SockaddrInet4</span><span class="op" id="3181517">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3181521">return</span>&nbsp;<span class="op" id="3181528">&amp;</span><span class="ident" id="3181529">TCPAddr</span><span class="op" id="3181536">{</span><span class="ident" id="3181537">IP</span><span class="op" id="3181539">:</span>&nbsp;<span class="ident" id="3181541">sa</span><span class="op" id="3181543">.</span><span class="ident" id="3181544">Addr</span><span class="op" id="3181548">[</span><span class="num" id="3181549">0</span><span class="op" id="3181550">:</span><span class="op" id="3181551">]</span><span class="op" id="3181552">,</span>&nbsp;<span class="ident" id="3181554">Port</span><span class="op" id="3181558">:</span>&nbsp;<span class="ident" id="3181560">sa</span><span class="op" id="3181562">.</span><span class="ident" id="3181563">Port</span><span class="op" id="3181567">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3181570">case</span>&nbsp;<span class="op" id="3181575">*</span><span class="ident" id="3181576">syscall</span><span class="op" id="3181583">.</span><span class="ident" id="3181584">SockaddrInet6</span><span class="op" id="3181597">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3181601">return</span>&nbsp;<span class="op" id="3181608">&amp;</span><span class="ident" id="3181609">TCPAddr</span><span class="op" id="3181616">{</span><span class="ident" id="3181617">IP</span><span class="op" id="3181619">:</span>&nbsp;<span class="ident" id="3181621">sa</span><span class="op" id="3181623">.</span><span class="ident" id="3181624">Addr</span><span class="op" id="3181628">[</span><span class="num" id="3181629">0</span><span class="op" id="3181630">:</span><span class="op" id="3181631">]</span><span class="op" id="3181632">,</span>&nbsp;<span class="ident" id="3181634">Port</span><span class="op" id="3181638">:</span>&nbsp;<span class="ident" id="3181640">sa</span><span class="op" id="3181642">.</span><span class="ident" id="3181643">Port</span><span class="op" id="3181647">,</span>&nbsp;<span class="ident" id="3181649">Zone</span><span class="op" id="3181653">:</span>&nbsp;<span class="ident" id="3181655">zoneToString</span><span class="op" id="3181667">(</span><span class="builtintype" id="3181668">int</span><span class="op" id="3181671">(</span><span class="ident" id="3181672">sa</span><span class="op" id="3181674">.</span><span class="ident" id="3181675">ZoneId</span><span class="op" id="3181681">)</span><span class="op" id="3181682">)</span><span class="op" id="3181683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3181686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3181689">return</span>&nbsp;<span class="ident" id="3181696">nil</span><br>
<span class="lineno"></span><span class="op" id="3181700">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="3181703">func</span>&nbsp;<span class="op" id="3181708">(</span><span class="ident" id="3181709">a</span>&nbsp;<span class="op" id="3181711">*</span><span class="ident" id="3181712">TCPAddr</span><span class="op" id="3181719">)</span>&nbsp;<span class="ident" id="3181721">family</span><span class="op" id="3181727">(</span><span class="op" id="3181728">)</span>&nbsp;<span class="builtintype" id="3181730">int</span>&nbsp;<span class="op" id="3181734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3181737">if</span>&nbsp;<span class="ident" id="3181740">a</span>&nbsp;<span class="op" id="3181742">==</span>&nbsp;<span class="ident" id="3181745">nil</span>&nbsp;<span class="op" id="3181749">||</span>&nbsp;<span class="builtinfunc" id="3181752">len</span><span class="op" id="3181755">(</span><span class="ident" id="3181756">a</span><span class="op" id="3181757">.</span><span class="ident" id="3181758">IP</span><span class="op" id="3181760">)</span>&nbsp;<span class="op" id="3181762">&lt;=</span>&nbsp;<span class="ident" id="3181765">IPv4len</span>&nbsp;<span class="op" id="3181773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3181777">return</span>&nbsp;<span class="ident" id="3181784">syscall</span><span class="op" id="3181791">.</span><span class="ident" id="3181792">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3181801">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3181804">if</span>&nbsp;<span class="ident" id="3181807">a</span><span class="op" id="3181808">.</span><span class="ident" id="3181809">IP</span><span class="op" id="3181811">.</span><span class="ident" id="3181812">To4</span><span class="op" id="3181815">(</span><span class="op" id="3181816">)</span>&nbsp;<span class="op" id="3181818">!=</span>&nbsp;<span class="ident" id="3181821">nil</span>&nbsp;<span class="op" id="3181825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3181829">return</span>&nbsp;<span class="ident" id="3181836">syscall</span><span class="op" id="3181843">.</span><span class="ident" id="3181844">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3181853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3181856">return</span>&nbsp;<span class="ident" id="3181863">syscall</span><span class="op" id="3181870">.</span><span class="ident" id="3181871">AF_INET6</span><br>
<span class="lineno"></span><span class="op" id="3181880">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="3181883">func</span>&nbsp;<span class="op" id="3181888">(</span><span class="ident" id="3181889">a</span>&nbsp;<span class="op" id="3181891">*</span><span class="ident" id="3181892">TCPAddr</span><span class="op" id="3181899">)</span>&nbsp;<span class="ident" id="3181901">isWildcard</span><span class="op" id="3181911">(</span><span class="op" id="3181912">)</span>&nbsp;<span class="builtintype" id="3181914">bool</span>&nbsp;<span class="op" id="3181919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3181922">if</span>&nbsp;<span class="ident" id="3181925">a</span>&nbsp;<span class="op" id="3181927">==</span>&nbsp;<span class="ident" id="3181930">nil</span>&nbsp;<span class="op" id="3181934">||</span>&nbsp;<span class="ident" id="3181937">a</span><span class="op" id="3181938">.</span><span class="ident" id="3181939">IP</span>&nbsp;<span class="op" id="3181942">==</span>&nbsp;<span class="ident" id="3181945">nil</span>&nbsp;<span class="op" id="3181949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3181953">return</span>&nbsp;<span class="builtintype" id="3181960">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3181966">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3181969">return</span>&nbsp;<span class="ident" id="3181976">a</span><span class="op" id="3181977">.</span><span class="ident" id="3181978">IP</span><span class="op" id="3181980">.</span><span class="ident" id="3181981">IsUnspecified</span><span class="op" id="3181994">(</span><span class="op" id="3181995">)</span><br>
<span class="lineno"></span><span class="op" id="3181997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3182000">func</span>&nbsp;<span class="op" id="3182005">(</span><span class="ident" id="3182006">a</span>&nbsp;<span class="op" id="3182008">*</span><span class="ident" id="3182009">TCPAddr</span><span class="op" id="3182016">)</span>&nbsp;<span class="ident" id="3182018">sockaddr</span><span class="op" id="3182026">(</span><span class="ident" id="3182027">family</span>&nbsp;<span class="builtintype" id="3182034">int</span><span class="op" id="3182037">)</span>&nbsp;<span class="op" id="3182039">(</span><span class="ident" id="3182040">syscall</span><span class="op" id="3182047">.</span><span class="ident" id="3182048">Sockaddr</span><span class="op" id="3182056">,</span>&nbsp;<span class="builtintype" id="3182058">error</span><span class="op" id="3182063">)</span>&nbsp;<span class="op" id="3182065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3182068">if</span>&nbsp;<span class="ident" id="3182071">a</span>&nbsp;<span class="op" id="3182073">==</span>&nbsp;<span class="ident" id="3182076">nil</span>&nbsp;<span class="op" id="3182080">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3182084">return</span>&nbsp;<span class="ident" id="3182091">nil</span><span class="op" id="3182094">,</span>&nbsp;<span class="ident" id="3182096">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3182101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3182104">return</span>&nbsp;<span class="ident" id="3182111">ipToSockaddr</span><span class="op" id="3182123">(</span><span class="ident" id="3182124">family</span><span class="op" id="3182130">,</span>&nbsp;<span class="ident" id="3182132">a</span><span class="op" id="3182133">.</span><span class="ident" id="3182134">IP</span><span class="op" id="3182136">,</span>&nbsp;<span class="ident" id="3182138">a</span><span class="op" id="3182139">.</span><span class="ident" id="3182140">Port</span><span class="op" id="3182144">,</span>&nbsp;<span class="ident" id="3182146">a</span><span class="op" id="3182147">.</span><span class="ident" id="3182148">Zone</span><span class="op" id="3182152">)</span><br>
<span class="lineno"></span><span class="op" id="3182154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3182157">//&nbsp;TCPConn&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Conn&nbsp;interface&nbsp;for&nbsp;TCP&nbsp;network</span><br>
<span class="lineno"></span><span class="comment" id="3182227">//&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="3182243">type</span>&nbsp;<span class="ident" id="3182248">TCPConn</span>&nbsp;<span class="keyword" id="3182256">struct</span>&nbsp;<span class="op" id="3182263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3182266">conn</span><br>
<span class="lineno"></span><span class="op" id="3182271">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="3182274">func</span>&nbsp;<span class="ident" id="3182279">newTCPConn</span><span class="op" id="3182289">(</span><span class="ident" id="3182290">fd</span>&nbsp;<span class="op" id="3182293">*</span><span class="ident" id="3182294">netFD</span><span class="op" id="3182299">)</span>&nbsp;<span class="op" id="3182301">*</span><span class="ident" id="3182302">TCPConn</span>&nbsp;<span class="op" id="3182310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3182313">c</span>&nbsp;<span class="op" id="3182315">:=</span>&nbsp;<span class="op" id="3182318">&amp;</span><span class="ident" id="3182319">TCPConn</span><span class="op" id="3182326">{</span><span class="ident" id="3182327">conn</span><span class="op" id="3182331">{</span><span class="ident" id="3182332">fd</span><span class="op" id="3182334">}</span><span class="op" id="3182335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3182338">c</span><span class="op" id="3182339">.</span><span class="ident" id="3182340">SetNoDelay</span><span class="op" id="3182350">(</span><span class="builtintype" id="3182351">true</span><span class="op" id="3182355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3182358">return</span>&nbsp;<span class="ident" id="3182365">c</span><br>
<span class="lineno">65</span><span class="op" id="3182367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3182370">//&nbsp;ReadFrom&nbsp;implements&nbsp;the&nbsp;io.ReaderFrom&nbsp;ReadFrom&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="3182428">func</span>&nbsp;<span class="op" id="3182433">(</span><span class="ident" id="3182434">c</span>&nbsp;<span class="op" id="3182436">*</span><span class="ident" id="3182437">TCPConn</span><span class="op" id="3182444">)</span>&nbsp;<span class="ident" id="3182446">ReadFrom</span><span class="op" id="3182454">(</span><span class="ident" id="3182455">r</span>&nbsp;<span class="ident" id="3182457">io</span><span class="op" id="3182459">.</span><span class="ident" id="3182460">Reader</span><span class="op" id="3182466">)</span>&nbsp;<span class="op" id="3182468">(</span><span class="ident" id="3182469">int64</span><span class="op" id="3182474">,</span>&nbsp;<span class="builtintype" id="3182476">error</span><span class="op" id="3182481">)</span>&nbsp;<span class="op" id="3182483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3182486">if</span>&nbsp;<span class="ident" id="3182489">n</span><span class="op" id="3182490">,</span>&nbsp;<span class="ident" id="3182492">err</span><span class="op" id="3182495">,</span>&nbsp;<span class="ident" id="3182497">handled</span>&nbsp;<span class="op" id="3182505">:=</span>&nbsp;<span class="ident" id="3182508">sendFile</span><span class="op" id="3182516">(</span><span class="ident" id="3182517">c</span><span class="op" id="3182518">.</span><span class="ident" id="3182519">fd</span><span class="op" id="3182521">,</span>&nbsp;<span class="ident" id="3182523">r</span><span class="op" id="3182524">)</span><span class="op" id="3182525">;</span>&nbsp;<span class="ident" id="3182527">handled</span>&nbsp;<span class="op" id="3182535">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3182539">return</span>&nbsp;<span class="ident" id="3182546">n</span><span class="op" id="3182547">,</span>&nbsp;<span class="ident" id="3182549">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3182554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3182557">return</span>&nbsp;<span class="ident" id="3182564">genericReadFrom</span><span class="op" id="3182579">(</span><span class="ident" id="3182580">c</span><span class="op" id="3182581">,</span>&nbsp;<span class="ident" id="3182583">r</span><span class="op" id="3182584">)</span><br>
<span class="lineno"></span><span class="op" id="3182586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="3182589">//&nbsp;CloseRead&nbsp;shuts&nbsp;down&nbsp;the&nbsp;reading&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3182653">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3182692">func</span>&nbsp;<span class="op" id="3182697">(</span><span class="ident" id="3182698">c</span>&nbsp;<span class="op" id="3182700">*</span><span class="ident" id="3182701">TCPConn</span><span class="op" id="3182708">)</span>&nbsp;<span class="ident" id="3182710">CloseRead</span><span class="op" id="3182719">(</span><span class="op" id="3182720">)</span>&nbsp;<span class="builtintype" id="3182722">error</span>&nbsp;<span class="op" id="3182728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3182731">if</span>&nbsp;<span class="op" id="3182734">!</span><span class="ident" id="3182735">c</span><span class="op" id="3182736">.</span><span class="ident" id="3182737">ok</span><span class="op" id="3182739">(</span><span class="op" id="3182740">)</span>&nbsp;<span class="op" id="3182742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3182746">return</span>&nbsp;<span class="ident" id="3182753">syscall</span><span class="op" id="3182760">.</span><span class="ident" id="3182761">EINVAL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3182769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3182772">return</span>&nbsp;<span class="ident" id="3182779">c</span><span class="op" id="3182780">.</span><span class="ident" id="3182781">fd</span><span class="op" id="3182783">.</span><span class="ident" id="3182784">closeRead</span><span class="op" id="3182793">(</span><span class="op" id="3182794">)</span><br>
<span class="lineno"></span><span class="op" id="3182796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3182799">//&nbsp;CloseWrite&nbsp;shuts&nbsp;down&nbsp;the&nbsp;writing&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno">85</span><span class="comment" id="3182864">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3182903">func</span>&nbsp;<span class="op" id="3182908">(</span><span class="ident" id="3182909">c</span>&nbsp;<span class="op" id="3182911">*</span><span class="ident" id="3182912">TCPConn</span><span class="op" id="3182919">)</span>&nbsp;<span class="ident" id="3182921">CloseWrite</span><span class="op" id="3182931">(</span><span class="op" id="3182932">)</span>&nbsp;<span class="builtintype" id="3182934">error</span>&nbsp;<span class="op" id="3182940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3182943">if</span>&nbsp;<span class="op" id="3182946">!</span><span class="ident" id="3182947">c</span><span class="op" id="3182948">.</span><span class="ident" id="3182949">ok</span><span class="op" id="3182951">(</span><span class="op" id="3182952">)</span>&nbsp;<span class="op" id="3182954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3182958">return</span>&nbsp;<span class="ident" id="3182965">syscall</span><span class="op" id="3182972">.</span><span class="ident" id="3182973">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3182981">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3182984">return</span>&nbsp;<span class="ident" id="3182991">c</span><span class="op" id="3182992">.</span><span class="ident" id="3182993">fd</span><span class="op" id="3182995">.</span><span class="ident" id="3182996">closeWrite</span><span class="op" id="3183006">(</span><span class="op" id="3183007">)</span><br>
<span class="lineno"></span><span class="op" id="3183009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3183012">//&nbsp;SetLinger&nbsp;sets&nbsp;the&nbsp;behavior&nbsp;of&nbsp;Close&nbsp;on&nbsp;a&nbsp;connection&nbsp;which&nbsp;still</span><br>
<span class="lineno"></span><span class="comment" id="3183080">//&nbsp;has&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;sent&nbsp;or&nbsp;to&nbsp;be&nbsp;acknowledged.</span><br>
<span class="lineno">95</span><span class="comment" id="3183134">//</span><br>
<span class="lineno"></span><span class="comment" id="3183137">//&nbsp;If&nbsp;sec&nbsp;&lt;&nbsp;0&nbsp;(the&nbsp;default),&nbsp;the&nbsp;operating&nbsp;system&nbsp;finishes&nbsp;sending&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3183208">//&nbsp;data&nbsp;in&nbsp;the&nbsp;background.</span><br>
<span class="lineno"></span><span class="comment" id="3183235">//</span><br>
<span class="lineno"></span><span class="comment" id="3183238">//&nbsp;If&nbsp;sec&nbsp;==&nbsp;0,&nbsp;the&nbsp;operating&nbsp;system&nbsp;discards&nbsp;any&nbsp;unsent&nbsp;or</span><br>
<span class="lineno">100</span><span class="comment" id="3183298">//&nbsp;unacknowledged&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="3183322">//</span><br>
<span class="lineno"></span><span class="comment" id="3183325">//&nbsp;If&nbsp;sec&nbsp;&gt;&nbsp;0,&nbsp;the&nbsp;data&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;background&nbsp;as&nbsp;with&nbsp;sec&nbsp;&lt;&nbsp;0.&nbsp;On</span><br>
<span class="lineno"></span><span class="comment" id="3183395">//&nbsp;some&nbsp;operating&nbsp;systems&nbsp;after&nbsp;sec&nbsp;seconds&nbsp;have&nbsp;elapsed&nbsp;any&nbsp;remaining</span><br>
<span class="lineno"></span><span class="comment" id="3183466">//&nbsp;unsent&nbsp;data&nbsp;may&nbsp;be&nbsp;discarded.</span><br>
<span class="lineno">105</span><span class="keyword" id="3183499">func</span>&nbsp;<span class="op" id="3183504">(</span><span class="ident" id="3183505">c</span>&nbsp;<span class="op" id="3183507">*</span><span class="ident" id="3183508">TCPConn</span><span class="op" id="3183515">)</span>&nbsp;<span class="ident" id="3183517">SetLinger</span><span class="op" id="3183526">(</span><span class="ident" id="3183527">sec</span>&nbsp;<span class="builtintype" id="3183531">int</span><span class="op" id="3183534">)</span>&nbsp;<span class="builtintype" id="3183536">error</span>&nbsp;<span class="op" id="3183542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3183545">if</span>&nbsp;<span class="op" id="3183548">!</span><span class="ident" id="3183549">c</span><span class="op" id="3183550">.</span><span class="ident" id="3183551">ok</span><span class="op" id="3183553">(</span><span class="op" id="3183554">)</span>&nbsp;<span class="op" id="3183556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3183560">return</span>&nbsp;<span class="ident" id="3183567">syscall</span><span class="op" id="3183574">.</span><span class="ident" id="3183575">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3183583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3183586">return</span>&nbsp;<span class="ident" id="3183593">setLinger</span><span class="op" id="3183602">(</span><span class="ident" id="3183603">c</span><span class="op" id="3183604">.</span><span class="ident" id="3183605">fd</span><span class="op" id="3183607">,</span>&nbsp;<span class="ident" id="3183609">sec</span><span class="op" id="3183612">)</span><br>
<span class="lineno">110</span><span class="op" id="3183614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3183617">//&nbsp;SetKeepAlive&nbsp;sets&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;send</span><br>
<span class="lineno"></span><span class="comment" id="3183679">//&nbsp;keepalive&nbsp;messages&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3183720">func</span>&nbsp;<span class="op" id="3183725">(</span><span class="ident" id="3183726">c</span>&nbsp;<span class="op" id="3183728">*</span><span class="ident" id="3183729">TCPConn</span><span class="op" id="3183736">)</span>&nbsp;<span class="ident" id="3183738">SetKeepAlive</span><span class="op" id="3183750">(</span><span class="ident" id="3183751">keepalive</span>&nbsp;<span class="builtintype" id="3183761">bool</span><span class="op" id="3183765">)</span>&nbsp;<span class="builtintype" id="3183767">error</span>&nbsp;<span class="op" id="3183773">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3183776">if</span>&nbsp;<span class="op" id="3183779">!</span><span class="ident" id="3183780">c</span><span class="op" id="3183781">.</span><span class="ident" id="3183782">ok</span><span class="op" id="3183784">(</span><span class="op" id="3183785">)</span>&nbsp;<span class="op" id="3183787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3183791">return</span>&nbsp;<span class="ident" id="3183798">syscall</span><span class="op" id="3183805">.</span><span class="ident" id="3183806">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3183814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3183817">return</span>&nbsp;<span class="ident" id="3183824">setKeepAlive</span><span class="op" id="3183836">(</span><span class="ident" id="3183837">c</span><span class="op" id="3183838">.</span><span class="ident" id="3183839">fd</span><span class="op" id="3183841">,</span>&nbsp;<span class="ident" id="3183843">keepalive</span><span class="op" id="3183852">)</span><br>
<span class="lineno"></span><span class="op" id="3183854">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="3183857">//&nbsp;SetKeepAlivePeriod&nbsp;sets&nbsp;period&nbsp;between&nbsp;keep&nbsp;alives.</span><br>
<span class="lineno"></span><span class="keyword" id="3183912">func</span>&nbsp;<span class="op" id="3183917">(</span><span class="ident" id="3183918">c</span>&nbsp;<span class="op" id="3183920">*</span><span class="ident" id="3183921">TCPConn</span><span class="op" id="3183928">)</span>&nbsp;<span class="ident" id="3183930">SetKeepAlivePeriod</span><span class="op" id="3183948">(</span><span class="ident" id="3183949">d</span>&nbsp;<span class="ident" id="3183951">time</span><span class="op" id="3183955">.</span><span class="ident" id="3183956">Duration</span><span class="op" id="3183964">)</span>&nbsp;<span class="builtintype" id="3183966">error</span>&nbsp;<span class="op" id="3183972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3183975">if</span>&nbsp;<span class="op" id="3183978">!</span><span class="ident" id="3183979">c</span><span class="op" id="3183980">.</span><span class="ident" id="3183981">ok</span><span class="op" id="3183983">(</span><span class="op" id="3183984">)</span>&nbsp;<span class="op" id="3183986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3183990">return</span>&nbsp;<span class="ident" id="3183997">syscall</span><span class="op" id="3184004">.</span><span class="ident" id="3184005">EINVAL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3184013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3184016">return</span>&nbsp;<span class="ident" id="3184023">setKeepAlivePeriod</span><span class="op" id="3184041">(</span><span class="ident" id="3184042">c</span><span class="op" id="3184043">.</span><span class="ident" id="3184044">fd</span><span class="op" id="3184046">,</span>&nbsp;<span class="ident" id="3184048">d</span><span class="op" id="3184049">)</span><br>
<span class="lineno"></span><span class="op" id="3184051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3184054">//&nbsp;SetNoDelay&nbsp;controls&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;delay</span><br>
<span class="lineno">130</span><span class="comment" id="3184119">//&nbsp;packet&nbsp;transmission&nbsp;in&nbsp;hopes&nbsp;of&nbsp;sending&nbsp;fewer&nbsp;packets&nbsp;(Nagle&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3184185">//&nbsp;algorithm).&nbsp;&nbsp;The&nbsp;default&nbsp;is&nbsp;true&nbsp;(no&nbsp;delay),&nbsp;meaning&nbsp;that&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3184254">//&nbsp;sent&nbsp;as&nbsp;soon&nbsp;as&nbsp;possible&nbsp;after&nbsp;a&nbsp;Write.</span><br>
<span class="lineno"></span><span class="keyword" id="3184297">func</span>&nbsp;<span class="op" id="3184302">(</span><span class="ident" id="3184303">c</span>&nbsp;<span class="op" id="3184305">*</span><span class="ident" id="3184306">TCPConn</span><span class="op" id="3184313">)</span>&nbsp;<span class="ident" id="3184315">SetNoDelay</span><span class="op" id="3184325">(</span><span class="ident" id="3184326">noDelay</span>&nbsp;<span class="builtintype" id="3184334">bool</span><span class="op" id="3184338">)</span>&nbsp;<span class="builtintype" id="3184340">error</span>&nbsp;<span class="op" id="3184346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3184349">if</span>&nbsp;<span class="op" id="3184352">!</span><span class="ident" id="3184353">c</span><span class="op" id="3184354">.</span><span class="ident" id="3184355">ok</span><span class="op" id="3184357">(</span><span class="op" id="3184358">)</span>&nbsp;<span class="op" id="3184360">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3184364">return</span>&nbsp;<span class="ident" id="3184371">syscall</span><span class="op" id="3184378">.</span><span class="ident" id="3184379">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3184387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3184390">return</span>&nbsp;<span class="ident" id="3184397">setNoDelay</span><span class="op" id="3184407">(</span><span class="ident" id="3184408">c</span><span class="op" id="3184409">.</span><span class="ident" id="3184410">fd</span><span class="op" id="3184412">,</span>&nbsp;<span class="ident" id="3184414">noDelay</span><span class="op" id="3184421">)</span><br>
<span class="lineno"></span><span class="op" id="3184423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3184426">//&nbsp;DialTCP&nbsp;connects&nbsp;to&nbsp;the&nbsp;remote&nbsp;address&nbsp;raddr&nbsp;on&nbsp;the&nbsp;network&nbsp;net,</span><br>
<span class="lineno"></span><span class="comment" id="3184494">//&nbsp;which&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;is&nbsp;not&nbsp;nil,&nbsp;it&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3184565">//&nbsp;used&nbsp;as&nbsp;the&nbsp;local&nbsp;address&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3184614">func</span>&nbsp;<span class="ident" id="3184619">DialTCP</span><span class="op" id="3184626">(</span><span class="ident" id="3184627">net</span>&nbsp;<span class="builtintype" id="3184631">string</span><span class="op" id="3184637">,</span>&nbsp;<span class="ident" id="3184639">laddr</span><span class="op" id="3184644">,</span>&nbsp;<span class="ident" id="3184646">raddr</span>&nbsp;<span class="op" id="3184652">*</span><span class="ident" id="3184653">TCPAddr</span><span class="op" id="3184660">)</span>&nbsp;<span class="op" id="3184662">(</span><span class="op" id="3184663">*</span><span class="ident" id="3184664">TCPConn</span><span class="op" id="3184671">,</span>&nbsp;<span class="builtintype" id="3184673">error</span><span class="op" id="3184678">)</span>&nbsp;<span class="op" id="3184680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3184683">switch</span>&nbsp;<span class="ident" id="3184690">net</span>&nbsp;<span class="op" id="3184694">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3184697">case</span>&nbsp;<span class="string" id="3184702">&#34;tcp&#34;</span><span class="op" id="3184707">,</span>&nbsp;<span class="string" id="3184709">&#34;tcp4&#34;</span><span class="op" id="3184715">,</span>&nbsp;<span class="string" id="3184717">&#34;tcp6&#34;</span><span class="op" id="3184723">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3184726">default</span><span class="op" id="3184733">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3184737">return</span>&nbsp;<span class="ident" id="3184744">nil</span><span class="op" id="3184747">,</span>&nbsp;<span class="op" id="3184749">&amp;</span><span class="ident" id="3184750">OpError</span><span class="op" id="3184757">{</span><span class="ident" id="3184758">Op</span><span class="op" id="3184760">:</span>&nbsp;<span class="string" id="3184762">&#34;dial&#34;</span><span class="op" id="3184768">,</span>&nbsp;<span class="ident" id="3184770">Net</span><span class="op" id="3184773">:</span>&nbsp;<span class="ident" id="3184775">net</span><span class="op" id="3184778">,</span>&nbsp;<span class="ident" id="3184780">Addr</span><span class="op" id="3184784">:</span>&nbsp;<span class="ident" id="3184786">raddr</span><span class="op" id="3184791">,</span>&nbsp;<span class="ident" id="3184793">Err</span><span class="op" id="3184796">:</span>&nbsp;<span class="ident" id="3184798">UnknownNetworkError</span><span class="op" id="3184817">(</span><span class="ident" id="3184818">net</span><span class="op" id="3184821">)</span><span class="op" id="3184822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3184825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3184828">if</span>&nbsp;<span class="ident" id="3184831">raddr</span>&nbsp;<span class="op" id="3184837">==</span>&nbsp;<span class="ident" id="3184840">nil</span>&nbsp;<span class="op" id="3184844">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3184848">return</span>&nbsp;<span class="ident" id="3184855">nil</span><span class="op" id="3184858">,</span>&nbsp;<span class="op" id="3184860">&amp;</span><span class="ident" id="3184861">OpError</span><span class="op" id="3184868">{</span><span class="ident" id="3184869">Op</span><span class="op" id="3184871">:</span>&nbsp;<span class="string" id="3184873">&#34;dial&#34;</span><span class="op" id="3184879">,</span>&nbsp;<span class="ident" id="3184881">Net</span><span class="op" id="3184884">:</span>&nbsp;<span class="ident" id="3184886">net</span><span class="op" id="3184889">,</span>&nbsp;<span class="ident" id="3184891">Addr</span><span class="op" id="3184895">:</span>&nbsp;<span class="ident" id="3184897">nil</span><span class="op" id="3184900">,</span>&nbsp;<span class="ident" id="3184902">Err</span><span class="op" id="3184905">:</span>&nbsp;<span class="ident" id="3184907">errMissingAddress</span><span class="op" id="3184924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3184927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3184930">return</span>&nbsp;<span class="ident" id="3184937">dialTCP</span><span class="op" id="3184944">(</span><span class="ident" id="3184945">net</span><span class="op" id="3184948">,</span>&nbsp;<span class="ident" id="3184950">laddr</span><span class="op" id="3184955">,</span>&nbsp;<span class="ident" id="3184957">raddr</span><span class="op" id="3184962">,</span>&nbsp;<span class="ident" id="3184964">noDeadline</span><span class="op" id="3184974">)</span><br>
<span class="lineno"></span><span class="op" id="3184976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="keyword" id="3184979">func</span>&nbsp;<span class="ident" id="3184984">dialTCP</span><span class="op" id="3184991">(</span><span class="ident" id="3184992">net</span>&nbsp;<span class="builtintype" id="3184996">string</span><span class="op" id="3185002">,</span>&nbsp;<span class="ident" id="3185004">laddr</span><span class="op" id="3185009">,</span>&nbsp;<span class="ident" id="3185011">raddr</span>&nbsp;<span class="op" id="3185017">*</span><span class="ident" id="3185018">TCPAddr</span><span class="op" id="3185025">,</span>&nbsp;<span class="ident" id="3185027">deadline</span>&nbsp;<span class="ident" id="3185036">time</span><span class="op" id="3185040">.</span><span class="ident" id="3185041">Time</span><span class="op" id="3185045">)</span>&nbsp;<span class="op" id="3185047">(</span><span class="op" id="3185048">*</span><span class="ident" id="3185049">TCPConn</span><span class="op" id="3185056">,</span>&nbsp;<span class="builtintype" id="3185058">error</span><span class="op" id="3185063">)</span>&nbsp;<span class="op" id="3185065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3185068">fd</span><span class="op" id="3185070">,</span>&nbsp;<span class="ident" id="3185072">err</span>&nbsp;<span class="op" id="3185076">:=</span>&nbsp;<span class="ident" id="3185079">internetSocket</span><span class="op" id="3185093">(</span><span class="ident" id="3185094">net</span><span class="op" id="3185097">,</span>&nbsp;<span class="ident" id="3185099">laddr</span><span class="op" id="3185104">,</span>&nbsp;<span class="ident" id="3185106">raddr</span><span class="op" id="3185111">,</span>&nbsp;<span class="ident" id="3185113">deadline</span><span class="op" id="3185121">,</span>&nbsp;<span class="ident" id="3185123">syscall</span><span class="op" id="3185130">.</span><span class="ident" id="3185131">SOCK_STREAM</span><span class="op" id="3185142">,</span>&nbsp;<span class="num" id="3185144">0</span><span class="op" id="3185145">,</span>&nbsp;<span class="string" id="3185147">&#34;dial&#34;</span><span class="op" id="3185153">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3185157">//&nbsp;TCP&nbsp;has&nbsp;a&nbsp;rarely&nbsp;used&nbsp;mechanism&nbsp;called&nbsp;a&nbsp;&#39;simultaneous&nbsp;connection&#39;&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3185231">//&nbsp;which&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr1,&nbsp;addr2)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine&nbsp;at&nbsp;addr1&nbsp;can</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3185299">//&nbsp;connect&nbsp;to&nbsp;a&nbsp;simultaneous&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr2,&nbsp;addr1)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3185374">//&nbsp;at&nbsp;addr2,&nbsp;without&nbsp;either&nbsp;machine&nbsp;executing&nbsp;Listen.&nbsp;&nbsp;If&nbsp;laddr&nbsp;==&nbsp;nil,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3185447">//&nbsp;it&nbsp;means&nbsp;we&nbsp;want&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate&nbsp;originating&nbsp;local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3185520">//&nbsp;address.&nbsp;&nbsp;Some&nbsp;Linux&nbsp;kernels&nbsp;cycle&nbsp;blindly&nbsp;through&nbsp;a&nbsp;fixed&nbsp;range&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3185592">//&nbsp;local&nbsp;ports,&nbsp;regardless&nbsp;of&nbsp;destination&nbsp;port.&nbsp;&nbsp;If&nbsp;a&nbsp;kernel&nbsp;happens&nbsp;to</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3185665">//&nbsp;pick&nbsp;local&nbsp;port&nbsp;50001&nbsp;as&nbsp;the&nbsp;source&nbsp;for&nbsp;a&nbsp;Dial(&#34;tcp&#34;,&nbsp;&#34;&#34;,&nbsp;&#34;localhost:50001&#34;),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3185747">//&nbsp;then&nbsp;the&nbsp;Dial&nbsp;will&nbsp;succeed,&nbsp;having&nbsp;simultaneously&nbsp;connected&nbsp;to&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3185822">//&nbsp;This&nbsp;can&nbsp;only&nbsp;happen&nbsp;when&nbsp;we&nbsp;are&nbsp;letting&nbsp;the&nbsp;kernel&nbsp;pick&nbsp;a&nbsp;port&nbsp;(laddr&nbsp;==&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3185905">//&nbsp;and&nbsp;when&nbsp;there&nbsp;is&nbsp;no&nbsp;listener&nbsp;for&nbsp;the&nbsp;destination&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3185968">//&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;argue&nbsp;this&nbsp;is&nbsp;anything&nbsp;other&nbsp;than&nbsp;a&nbsp;kernel&nbsp;bug.&nbsp;&nbsp;If&nbsp;we</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3186040">//&nbsp;see&nbsp;this&nbsp;happen,&nbsp;rather&nbsp;than&nbsp;expose&nbsp;the&nbsp;buggy&nbsp;effect&nbsp;to&nbsp;users,&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3186110">//&nbsp;close&nbsp;the&nbsp;fd&nbsp;and&nbsp;try&nbsp;again.&nbsp;&nbsp;If&nbsp;it&nbsp;happens&nbsp;twice&nbsp;more,&nbsp;we&nbsp;relent&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3186183">//&nbsp;use&nbsp;the&nbsp;result.&nbsp;&nbsp;See&nbsp;also:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3186214">//&nbsp;&nbsp;&nbsp;&nbsp;http://golang.org/issue/2690</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3186247">//&nbsp;&nbsp;&nbsp;&nbsp;http://stackoverflow.com/questions/4949858/</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3186295">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3186299">//&nbsp;The&nbsp;opposite&nbsp;can&nbsp;also&nbsp;happen:&nbsp;if&nbsp;we&nbsp;ask&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3186377">//&nbsp;originating&nbsp;local&nbsp;address,&nbsp;sometimes&nbsp;it&nbsp;picks&nbsp;one&nbsp;that&nbsp;is&nbsp;already&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3186455">//&nbsp;So&nbsp;if&nbsp;the&nbsp;error&nbsp;is&nbsp;EADDRNOTAVAIL,&nbsp;we&nbsp;have&nbsp;to&nbsp;try&nbsp;again&nbsp;too,&nbsp;just&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3186528">//&nbsp;a&nbsp;different&nbsp;reason.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3186552">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3186556">//&nbsp;The&nbsp;kernel&nbsp;socket&nbsp;code&nbsp;is&nbsp;no&nbsp;doubt&nbsp;enjoying&nbsp;watching&nbsp;us&nbsp;squirm.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3186624">for</span>&nbsp;<span class="ident" id="3186628">i</span>&nbsp;<span class="op" id="3186630">:=</span>&nbsp;<span class="num" id="3186633">0</span><span class="op" id="3186634">;</span>&nbsp;<span class="ident" id="3186636">i</span>&nbsp;<span class="op" id="3186638">&lt;</span>&nbsp;<span class="num" id="3186640">2</span>&nbsp;<span class="op" id="3186642">&amp;&amp;</span>&nbsp;<span class="op" id="3186645">(</span><span class="ident" id="3186646">laddr</span>&nbsp;<span class="op" id="3186652">==</span>&nbsp;<span class="ident" id="3186655">nil</span>&nbsp;<span class="op" id="3186659">||</span>&nbsp;<span class="ident" id="3186662">laddr</span><span class="op" id="3186667">.</span><span class="ident" id="3186668">Port</span>&nbsp;<span class="op" id="3186673">==</span>&nbsp;<span class="num" id="3186676">0</span><span class="op" id="3186677">)</span>&nbsp;<span class="op" id="3186679">&amp;&amp;</span>&nbsp;<span class="op" id="3186682">(</span><span class="ident" id="3186683">selfConnect</span><span class="op" id="3186694">(</span><span class="ident" id="3186695">fd</span><span class="op" id="3186697">,</span>&nbsp;<span class="ident" id="3186699">err</span><span class="op" id="3186702">)</span>&nbsp;<span class="op" id="3186704">||</span>&nbsp;<span class="ident" id="3186707">spuriousENOTAVAIL</span><span class="op" id="3186724">(</span><span class="ident" id="3186725">err</span><span class="op" id="3186728">)</span><span class="op" id="3186729">)</span><span class="op" id="3186730">;</span>&nbsp;<span class="ident" id="3186732">i</span><span class="op" id="3186733">++</span>&nbsp;<span class="op" id="3186736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3186740">if</span>&nbsp;<span class="ident" id="3186743">err</span>&nbsp;<span class="op" id="3186747">==</span>&nbsp;<span class="ident" id="3186750">nil</span>&nbsp;<span class="op" id="3186754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3186759">fd</span><span class="op" id="3186761">.</span><span class="ident" id="3186762">Close</span><span class="op" id="3186767">(</span><span class="op" id="3186768">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3186772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3186776">fd</span><span class="op" id="3186778">,</span>&nbsp;<span class="ident" id="3186780">err</span>&nbsp;<span class="op" id="3186784">=</span>&nbsp;<span class="ident" id="3186786">internetSocket</span><span class="op" id="3186800">(</span><span class="ident" id="3186801">net</span><span class="op" id="3186804">,</span>&nbsp;<span class="ident" id="3186806">laddr</span><span class="op" id="3186811">,</span>&nbsp;<span class="ident" id="3186813">raddr</span><span class="op" id="3186818">,</span>&nbsp;<span class="ident" id="3186820">deadline</span><span class="op" id="3186828">,</span>&nbsp;<span class="ident" id="3186830">syscall</span><span class="op" id="3186837">.</span><span class="ident" id="3186838">SOCK_STREAM</span><span class="op" id="3186849">,</span>&nbsp;<span class="num" id="3186851">0</span><span class="op" id="3186852">,</span>&nbsp;<span class="string" id="3186854">&#34;dial&#34;</span><span class="op" id="3186860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3186863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3186867">if</span>&nbsp;<span class="ident" id="3186870">err</span>&nbsp;<span class="op" id="3186874">!=</span>&nbsp;<span class="ident" id="3186877">nil</span>&nbsp;<span class="op" id="3186881">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3186885">return</span>&nbsp;<span class="ident" id="3186892">nil</span><span class="op" id="3186895">,</span>&nbsp;<span class="op" id="3186897">&amp;</span><span class="ident" id="3186898">OpError</span><span class="op" id="3186905">{</span><span class="ident" id="3186906">Op</span><span class="op" id="3186908">:</span>&nbsp;<span class="string" id="3186910">&#34;dial&#34;</span><span class="op" id="3186916">,</span>&nbsp;<span class="ident" id="3186918">Net</span><span class="op" id="3186921">:</span>&nbsp;<span class="ident" id="3186923">net</span><span class="op" id="3186926">,</span>&nbsp;<span class="ident" id="3186928">Addr</span><span class="op" id="3186932">:</span>&nbsp;<span class="ident" id="3186934">raddr</span><span class="op" id="3186939">,</span>&nbsp;<span class="ident" id="3186941">Err</span><span class="op" id="3186944">:</span>&nbsp;<span class="ident" id="3186946">err</span><span class="op" id="3186949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3186952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3186955">return</span>&nbsp;<span class="ident" id="3186962">newTCPConn</span><span class="op" id="3186972">(</span><span class="ident" id="3186973">fd</span><span class="op" id="3186975">)</span><span class="op" id="3186976">,</span>&nbsp;<span class="ident" id="3186978">nil</span><br>
<span class="lineno"></span><span class="op" id="3186982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="3186985">func</span>&nbsp;<span class="ident" id="3186990">selfConnect</span><span class="op" id="3187001">(</span><span class="ident" id="3187002">fd</span>&nbsp;<span class="op" id="3187005">*</span><span class="ident" id="3187006">netFD</span><span class="op" id="3187011">,</span>&nbsp;<span class="ident" id="3187013">err</span>&nbsp;<span class="builtintype" id="3187017">error</span><span class="op" id="3187022">)</span>&nbsp;<span class="builtintype" id="3187024">bool</span>&nbsp;<span class="op" id="3187029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3187032">//&nbsp;If&nbsp;the&nbsp;connect&nbsp;failed,&nbsp;we&nbsp;clearly&nbsp;didn&#39;t&nbsp;connect&nbsp;to&nbsp;ourselves.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3187099">if</span>&nbsp;<span class="ident" id="3187102">err</span>&nbsp;<span class="op" id="3187106">!=</span>&nbsp;<span class="ident" id="3187109">nil</span>&nbsp;<span class="op" id="3187113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3187117">return</span>&nbsp;<span class="builtintype" id="3187124">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3187131">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3187135">//&nbsp;The&nbsp;socket&nbsp;constructor&nbsp;can&nbsp;return&nbsp;an&nbsp;fd&nbsp;with&nbsp;raddr&nbsp;nil&nbsp;under&nbsp;certain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3187208">//&nbsp;unknown&nbsp;conditions.&nbsp;The&nbsp;errors&nbsp;in&nbsp;the&nbsp;calls&nbsp;there&nbsp;to&nbsp;Getpeername</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3187277">//&nbsp;are&nbsp;discarded,&nbsp;but&nbsp;we&nbsp;can&#39;t&nbsp;catch&nbsp;the&nbsp;problem&nbsp;there&nbsp;because&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3187347">//&nbsp;calls&nbsp;are&nbsp;sometimes&nbsp;legally&nbsp;erroneous&nbsp;with&nbsp;a&nbsp;&#34;socket&nbsp;not&nbsp;connected&#34;.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3187420">//&nbsp;Since&nbsp;this&nbsp;code&nbsp;(selfConnect)&nbsp;is&nbsp;already&nbsp;trying&nbsp;to&nbsp;work&nbsp;around</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3187487">//&nbsp;a&nbsp;problem,&nbsp;we&nbsp;make&nbsp;sure&nbsp;if&nbsp;this&nbsp;happens&nbsp;we&nbsp;recognize&nbsp;trouble&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3187556">//&nbsp;ask&nbsp;the&nbsp;DialTCP&nbsp;routine&nbsp;to&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3187598">//&nbsp;TODO:&nbsp;try&nbsp;to&nbsp;understand&nbsp;what&#39;s&nbsp;really&nbsp;going&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3187650">if</span>&nbsp;<span class="ident" id="3187653">fd</span><span class="op" id="3187655">.</span><span class="ident" id="3187656">laddr</span>&nbsp;<span class="op" id="3187662">==</span>&nbsp;<span class="ident" id="3187665">nil</span>&nbsp;<span class="op" id="3187669">||</span>&nbsp;<span class="ident" id="3187672">fd</span><span class="op" id="3187674">.</span><span class="ident" id="3187675">raddr</span>&nbsp;<span class="op" id="3187681">==</span>&nbsp;<span class="ident" id="3187684">nil</span>&nbsp;<span class="op" id="3187688">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3187692">return</span>&nbsp;<span class="builtintype" id="3187699">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3187705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3187708">l</span>&nbsp;<span class="op" id="3187710">:=</span>&nbsp;<span class="ident" id="3187713">fd</span><span class="op" id="3187715">.</span><span class="ident" id="3187716">laddr</span><span class="op" id="3187721">.</span><span class="op" id="3187722">(</span><span class="op" id="3187723">*</span><span class="ident" id="3187724">TCPAddr</span><span class="op" id="3187731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3187734">r</span>&nbsp;<span class="op" id="3187736">:=</span>&nbsp;<span class="ident" id="3187739">fd</span><span class="op" id="3187741">.</span><span class="ident" id="3187742">raddr</span><span class="op" id="3187747">.</span><span class="op" id="3187748">(</span><span class="op" id="3187749">*</span><span class="ident" id="3187750">TCPAddr</span><span class="op" id="3187757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3187760">return</span>&nbsp;<span class="ident" id="3187767">l</span><span class="op" id="3187768">.</span><span class="ident" id="3187769">Port</span>&nbsp;<span class="op" id="3187774">==</span>&nbsp;<span class="ident" id="3187777">r</span><span class="op" id="3187778">.</span><span class="ident" id="3187779">Port</span>&nbsp;<span class="op" id="3187784">&amp;&amp;</span>&nbsp;<span class="ident" id="3187787">l</span><span class="op" id="3187788">.</span><span class="ident" id="3187789">IP</span><span class="op" id="3187791">.</span><span class="ident" id="3187792">Equal</span><span class="op" id="3187797">(</span><span class="ident" id="3187798">r</span><span class="op" id="3187799">.</span><span class="ident" id="3187800">IP</span><span class="op" id="3187802">)</span><br>
<span class="lineno">215</span><span class="op" id="3187804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3187807">func</span>&nbsp;<span class="ident" id="3187812">spuriousENOTAVAIL</span><span class="op" id="3187829">(</span><span class="ident" id="3187830">err</span>&nbsp;<span class="builtintype" id="3187834">error</span><span class="op" id="3187839">)</span>&nbsp;<span class="builtintype" id="3187841">bool</span>&nbsp;<span class="op" id="3187846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3187849">e</span><span class="op" id="3187850">,</span>&nbsp;<span class="ident" id="3187852">ok</span>&nbsp;<span class="op" id="3187855">:=</span>&nbsp;<span class="ident" id="3187858">err</span><span class="op" id="3187861">.</span><span class="op" id="3187862">(</span><span class="op" id="3187863">*</span><span class="ident" id="3187864">OpError</span><span class="op" id="3187871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3187874">return</span>&nbsp;<span class="ident" id="3187881">ok</span>&nbsp;<span class="op" id="3187884">&amp;&amp;</span>&nbsp;<span class="ident" id="3187887">e</span><span class="op" id="3187888">.</span><span class="ident" id="3187889">Err</span>&nbsp;<span class="op" id="3187893">==</span>&nbsp;<span class="ident" id="3187896">syscall</span><span class="op" id="3187903">.</span><span class="ident" id="3187904">EADDRNOTAVAIL</span><br>
<span class="lineno">220</span><span class="op" id="3187918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3187921">//&nbsp;TCPListener&nbsp;is&nbsp;a&nbsp;TCP&nbsp;network&nbsp;listener.&nbsp;&nbsp;Clients&nbsp;should&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="3187989">//&nbsp;use&nbsp;variables&nbsp;of&nbsp;type&nbsp;Listener&nbsp;instead&nbsp;of&nbsp;assuming&nbsp;TCP.</span><br>
<span class="lineno"></span><span class="keyword" id="3188048">type</span>&nbsp;<span class="ident" id="3188053">TCPListener</span>&nbsp;<span class="keyword" id="3188065">struct</span>&nbsp;<span class="op" id="3188072">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3188075">fd</span>&nbsp;<span class="op" id="3188078">*</span><span class="ident" id="3188079">netFD</span><br>
<span class="lineno"></span><span class="op" id="3188085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3188088">//&nbsp;AcceptTCP&nbsp;accepts&nbsp;the&nbsp;next&nbsp;incoming&nbsp;call&nbsp;and&nbsp;returns&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="3188152">//&nbsp;connection.</span><br>
<span class="lineno">230</span><span class="keyword" id="3188167">func</span>&nbsp;<span class="op" id="3188172">(</span><span class="ident" id="3188173">l</span>&nbsp;<span class="op" id="3188175">*</span><span class="ident" id="3188176">TCPListener</span><span class="op" id="3188187">)</span>&nbsp;<span class="ident" id="3188189">AcceptTCP</span><span class="op" id="3188198">(</span><span class="op" id="3188199">)</span>&nbsp;<span class="op" id="3188201">(</span><span class="op" id="3188202">*</span><span class="ident" id="3188203">TCPConn</span><span class="op" id="3188210">,</span>&nbsp;<span class="builtintype" id="3188212">error</span><span class="op" id="3188217">)</span>&nbsp;<span class="op" id="3188219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3188222">if</span>&nbsp;<span class="ident" id="3188225">l</span>&nbsp;<span class="op" id="3188227">==</span>&nbsp;<span class="ident" id="3188230">nil</span>&nbsp;<span class="op" id="3188234">||</span>&nbsp;<span class="ident" id="3188237">l</span><span class="op" id="3188238">.</span><span class="ident" id="3188239">fd</span>&nbsp;<span class="op" id="3188242">==</span>&nbsp;<span class="ident" id="3188245">nil</span>&nbsp;<span class="op" id="3188249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3188253">return</span>&nbsp;<span class="ident" id="3188260">nil</span><span class="op" id="3188263">,</span>&nbsp;<span class="ident" id="3188265">syscall</span><span class="op" id="3188272">.</span><span class="ident" id="3188273">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3188281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3188284">fd</span><span class="op" id="3188286">,</span>&nbsp;<span class="ident" id="3188288">err</span>&nbsp;<span class="op" id="3188292">:=</span>&nbsp;<span class="ident" id="3188295">l</span><span class="op" id="3188296">.</span><span class="ident" id="3188297">fd</span><span class="op" id="3188299">.</span><span class="ident" id="3188300">accept</span><span class="op" id="3188306">(</span><span class="op" id="3188307">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3188310">if</span>&nbsp;<span class="ident" id="3188313">err</span>&nbsp;<span class="op" id="3188317">!=</span>&nbsp;<span class="ident" id="3188320">nil</span>&nbsp;<span class="op" id="3188324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3188328">return</span>&nbsp;<span class="ident" id="3188335">nil</span><span class="op" id="3188338">,</span>&nbsp;<span class="ident" id="3188340">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3188345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3188348">return</span>&nbsp;<span class="ident" id="3188355">newTCPConn</span><span class="op" id="3188365">(</span><span class="ident" id="3188366">fd</span><span class="op" id="3188368">)</span><span class="op" id="3188369">,</span>&nbsp;<span class="ident" id="3188371">nil</span><br>
<span class="lineno"></span><span class="op" id="3188375">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment" id="3188378">//&nbsp;Accept&nbsp;implements&nbsp;the&nbsp;Accept&nbsp;method&nbsp;in&nbsp;the&nbsp;Listener&nbsp;interface;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3188447">//&nbsp;waits&nbsp;for&nbsp;the&nbsp;next&nbsp;call&nbsp;and&nbsp;returns&nbsp;a&nbsp;generic&nbsp;Conn.</span><br>
<span class="lineno"></span><span class="keyword" id="3188502">func</span>&nbsp;<span class="op" id="3188507">(</span><span class="ident" id="3188508">l</span>&nbsp;<span class="op" id="3188510">*</span><span class="ident" id="3188511">TCPListener</span><span class="op" id="3188522">)</span>&nbsp;<span class="ident" id="3188524">Accept</span><span class="op" id="3188530">(</span><span class="op" id="3188531">)</span>&nbsp;<span class="op" id="3188533">(</span><span class="ident" id="3188534">Conn</span><span class="op" id="3188538">,</span>&nbsp;<span class="builtintype" id="3188540">error</span><span class="op" id="3188545">)</span>&nbsp;<span class="op" id="3188547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3188550">c</span><span class="op" id="3188551">,</span>&nbsp;<span class="ident" id="3188553">err</span>&nbsp;<span class="op" id="3188557">:=</span>&nbsp;<span class="ident" id="3188560">l</span><span class="op" id="3188561">.</span><span class="ident" id="3188562">AcceptTCP</span><span class="op" id="3188571">(</span><span class="op" id="3188572">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3188575">if</span>&nbsp;<span class="ident" id="3188578">err</span>&nbsp;<span class="op" id="3188582">!=</span>&nbsp;<span class="ident" id="3188585">nil</span>&nbsp;<span class="op" id="3188589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3188593">return</span>&nbsp;<span class="ident" id="3188600">nil</span><span class="op" id="3188603">,</span>&nbsp;<span class="ident" id="3188605">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3188610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3188613">return</span>&nbsp;<span class="ident" id="3188620">c</span><span class="op" id="3188621">,</span>&nbsp;<span class="ident" id="3188623">nil</span><br>
<span class="lineno"></span><span class="op" id="3188627">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="3188630">//&nbsp;Close&nbsp;stops&nbsp;listening&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="3188675">//&nbsp;Already&nbsp;Accepted&nbsp;connections&nbsp;are&nbsp;not&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="3188723">func</span>&nbsp;<span class="op" id="3188728">(</span><span class="ident" id="3188729">l</span>&nbsp;<span class="op" id="3188731">*</span><span class="ident" id="3188732">TCPListener</span><span class="op" id="3188743">)</span>&nbsp;<span class="ident" id="3188745">Close</span><span class="op" id="3188750">(</span><span class="op" id="3188751">)</span>&nbsp;<span class="builtintype" id="3188753">error</span>&nbsp;<span class="op" id="3188759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3188762">if</span>&nbsp;<span class="ident" id="3188765">l</span>&nbsp;<span class="op" id="3188767">==</span>&nbsp;<span class="ident" id="3188770">nil</span>&nbsp;<span class="op" id="3188774">||</span>&nbsp;<span class="ident" id="3188777">l</span><span class="op" id="3188778">.</span><span class="ident" id="3188779">fd</span>&nbsp;<span class="op" id="3188782">==</span>&nbsp;<span class="ident" id="3188785">nil</span>&nbsp;<span class="op" id="3188789">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3188793">return</span>&nbsp;<span class="ident" id="3188800">syscall</span><span class="op" id="3188807">.</span><span class="ident" id="3188808">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3188816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3188819">return</span>&nbsp;<span class="ident" id="3188826">l</span><span class="op" id="3188827">.</span><span class="ident" id="3188828">fd</span><span class="op" id="3188830">.</span><span class="ident" id="3188831">Close</span><span class="op" id="3188836">(</span><span class="op" id="3188837">)</span><br>
<span class="lineno"></span><span class="op" id="3188839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="comment" id="3188842">//&nbsp;Addr&nbsp;returns&nbsp;the&nbsp;listener&#39;s&nbsp;network&nbsp;address,&nbsp;a&nbsp;*TCPAddr.</span><br>
<span class="lineno"></span><span class="keyword" id="3188902">func</span>&nbsp;<span class="op" id="3188907">(</span><span class="ident" id="3188908">l</span>&nbsp;<span class="op" id="3188910">*</span><span class="ident" id="3188911">TCPListener</span><span class="op" id="3188922">)</span>&nbsp;<span class="ident" id="3188924">Addr</span><span class="op" id="3188928">(</span><span class="op" id="3188929">)</span>&nbsp;<span class="ident" id="3188931">Addr</span>&nbsp;<span class="op" id="3188936">{</span>&nbsp;<span class="keyword" id="3188938">return</span>&nbsp;<span class="ident" id="3188945">l</span><span class="op" id="3188946">.</span><span class="ident" id="3188947">fd</span><span class="op" id="3188949">.</span><span class="ident" id="3188950">laddr</span>&nbsp;<span class="op" id="3188956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3188959">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;deadline&nbsp;associated&nbsp;with&nbsp;the&nbsp;listener.</span><br>
<span class="lineno"></span><span class="comment" id="3189022">//&nbsp;A&nbsp;zero&nbsp;time&nbsp;value&nbsp;disables&nbsp;the&nbsp;deadline.</span><br>
<span class="lineno">265</span><span class="keyword" id="3189066">func</span>&nbsp;<span class="op" id="3189071">(</span><span class="ident" id="3189072">l</span>&nbsp;<span class="op" id="3189074">*</span><span class="ident" id="3189075">TCPListener</span><span class="op" id="3189086">)</span>&nbsp;<span class="ident" id="3189088">SetDeadline</span><span class="op" id="3189099">(</span><span class="ident" id="3189100">t</span>&nbsp;<span class="ident" id="3189102">time</span><span class="op" id="3189106">.</span><span class="ident" id="3189107">Time</span><span class="op" id="3189111">)</span>&nbsp;<span class="builtintype" id="3189113">error</span>&nbsp;<span class="op" id="3189119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3189122">if</span>&nbsp;<span class="ident" id="3189125">l</span>&nbsp;<span class="op" id="3189127">==</span>&nbsp;<span class="ident" id="3189130">nil</span>&nbsp;<span class="op" id="3189134">||</span>&nbsp;<span class="ident" id="3189137">l</span><span class="op" id="3189138">.</span><span class="ident" id="3189139">fd</span>&nbsp;<span class="op" id="3189142">==</span>&nbsp;<span class="ident" id="3189145">nil</span>&nbsp;<span class="op" id="3189149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3189153">return</span>&nbsp;<span class="ident" id="3189160">syscall</span><span class="op" id="3189167">.</span><span class="ident" id="3189168">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3189176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3189179">return</span>&nbsp;<span class="ident" id="3189186">l</span><span class="op" id="3189187">.</span><span class="ident" id="3189188">fd</span><span class="op" id="3189190">.</span><span class="ident" id="3189191">setDeadline</span><span class="op" id="3189202">(</span><span class="ident" id="3189203">t</span><span class="op" id="3189204">)</span><br>
<span class="lineno">270</span><span class="op" id="3189206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3189209">//&nbsp;File&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;underlying&nbsp;os.File,&nbsp;set&nbsp;to&nbsp;blocking</span><br>
<span class="lineno"></span><span class="comment" id="3189275">//&nbsp;mode.&nbsp;&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;close&nbsp;f&nbsp;when&nbsp;finished.</span><br>
<span class="lineno"></span><span class="comment" id="3189345">//&nbsp;Closing&nbsp;l&nbsp;does&nbsp;not&nbsp;affect&nbsp;f,&nbsp;and&nbsp;closing&nbsp;f&nbsp;does&nbsp;not&nbsp;affect&nbsp;l.</span><br>
<span class="lineno">275</span><span class="comment" id="3189410">//</span><br>
<span class="lineno"></span><span class="comment" id="3189413">//&nbsp;The&nbsp;returned&nbsp;os.File&#39;s&nbsp;file&nbsp;descriptor&nbsp;is&nbsp;different&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3189477">//&nbsp;connection&#39;s.&nbsp;&nbsp;Attempting&nbsp;to&nbsp;change&nbsp;properties&nbsp;of&nbsp;the&nbsp;original</span><br>
<span class="lineno"></span><span class="comment" id="3189543">//&nbsp;using&nbsp;this&nbsp;duplicate&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;have&nbsp;the&nbsp;desired&nbsp;effect.</span><br>
<span class="lineno"></span><span class="keyword" id="3189607">func</span>&nbsp;<span class="op" id="3189612">(</span><span class="ident" id="3189613">l</span>&nbsp;<span class="op" id="3189615">*</span><span class="ident" id="3189616">TCPListener</span><span class="op" id="3189627">)</span>&nbsp;<span class="ident" id="3189629">File</span><span class="op" id="3189633">(</span><span class="op" id="3189634">)</span>&nbsp;<span class="op" id="3189636">(</span><span class="ident" id="3189637">f</span>&nbsp;<span class="op" id="3189639">*</span><span class="ident" id="3189640">os</span><span class="op" id="3189642">.</span><span class="ident" id="3189643">File</span><span class="op" id="3189647">,</span>&nbsp;<span class="ident" id="3189649">err</span>&nbsp;<span class="builtintype" id="3189653">error</span><span class="op" id="3189658">)</span>&nbsp;<span class="op" id="3189660">{</span>&nbsp;<span class="keyword" id="3189662">return</span>&nbsp;<span class="ident" id="3189669">l</span><span class="op" id="3189670">.</span><span class="ident" id="3189671">fd</span><span class="op" id="3189673">.</span><span class="ident" id="3189674">dup</span><span class="op" id="3189677">(</span><span class="op" id="3189678">)</span>&nbsp;<span class="op" id="3189680">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="3189683">//&nbsp;ListenTCP&nbsp;announces&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address&nbsp;laddr&nbsp;and&nbsp;returns&nbsp;a&nbsp;TCP</span><br>
<span class="lineno"></span><span class="comment" id="3189749">//&nbsp;listener.&nbsp;&nbsp;Net&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;has&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3189817">//&nbsp;port&nbsp;of&nbsp;0,&nbsp;ListenTCP&nbsp;will&nbsp;choose&nbsp;an&nbsp;available&nbsp;port.&nbsp;&nbsp;The&nbsp;caller&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="3189888">//&nbsp;use&nbsp;the&nbsp;Addr&nbsp;method&nbsp;of&nbsp;TCPListener&nbsp;to&nbsp;retrieve&nbsp;the&nbsp;chosen&nbsp;address.</span><br>
<span class="lineno">285</span><span class="keyword" id="3189958">func</span>&nbsp;<span class="ident" id="3189963">ListenTCP</span><span class="op" id="3189972">(</span><span class="ident" id="3189973">net</span>&nbsp;<span class="builtintype" id="3189977">string</span><span class="op" id="3189983">,</span>&nbsp;<span class="ident" id="3189985">laddr</span>&nbsp;<span class="op" id="3189991">*</span><span class="ident" id="3189992">TCPAddr</span><span class="op" id="3189999">)</span>&nbsp;<span class="op" id="3190001">(</span><span class="op" id="3190002">*</span><span class="ident" id="3190003">TCPListener</span><span class="op" id="3190014">,</span>&nbsp;<span class="builtintype" id="3190016">error</span><span class="op" id="3190021">)</span>&nbsp;<span class="op" id="3190023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3190026">switch</span>&nbsp;<span class="ident" id="3190033">net</span>&nbsp;<span class="op" id="3190037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3190040">case</span>&nbsp;<span class="string" id="3190045">&#34;tcp&#34;</span><span class="op" id="3190050">,</span>&nbsp;<span class="string" id="3190052">&#34;tcp4&#34;</span><span class="op" id="3190058">,</span>&nbsp;<span class="string" id="3190060">&#34;tcp6&#34;</span><span class="op" id="3190066">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3190069">default</span><span class="op" id="3190076">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3190080">return</span>&nbsp;<span class="ident" id="3190087">nil</span><span class="op" id="3190090">,</span>&nbsp;<span class="op" id="3190092">&amp;</span><span class="ident" id="3190093">OpError</span><span class="op" id="3190100">{</span><span class="ident" id="3190101">Op</span><span class="op" id="3190103">:</span>&nbsp;<span class="string" id="3190105">&#34;listen&#34;</span><span class="op" id="3190113">,</span>&nbsp;<span class="ident" id="3190115">Net</span><span class="op" id="3190118">:</span>&nbsp;<span class="ident" id="3190120">net</span><span class="op" id="3190123">,</span>&nbsp;<span class="ident" id="3190125">Addr</span><span class="op" id="3190129">:</span>&nbsp;<span class="ident" id="3190131">laddr</span><span class="op" id="3190136">,</span>&nbsp;<span class="ident" id="3190138">Err</span><span class="op" id="3190141">:</span>&nbsp;<span class="ident" id="3190143">UnknownNetworkError</span><span class="op" id="3190162">(</span><span class="ident" id="3190163">net</span><span class="op" id="3190166">)</span><span class="op" id="3190167">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3190170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3190173">if</span>&nbsp;<span class="ident" id="3190176">laddr</span>&nbsp;<span class="op" id="3190182">==</span>&nbsp;<span class="ident" id="3190185">nil</span>&nbsp;<span class="op" id="3190189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3190193">laddr</span>&nbsp;<span class="op" id="3190199">=</span>&nbsp;<span class="op" id="3190201">&amp;</span><span class="ident" id="3190202">TCPAddr</span><span class="op" id="3190209">{</span><span class="op" id="3190210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3190213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3190216">fd</span><span class="op" id="3190218">,</span>&nbsp;<span class="ident" id="3190220">err</span>&nbsp;<span class="op" id="3190224">:=</span>&nbsp;<span class="ident" id="3190227">internetSocket</span><span class="op" id="3190241">(</span><span class="ident" id="3190242">net</span><span class="op" id="3190245">,</span>&nbsp;<span class="ident" id="3190247">laddr</span><span class="op" id="3190252">,</span>&nbsp;<span class="ident" id="3190254">nil</span><span class="op" id="3190257">,</span>&nbsp;<span class="ident" id="3190259">noDeadline</span><span class="op" id="3190269">,</span>&nbsp;<span class="ident" id="3190271">syscall</span><span class="op" id="3190278">.</span><span class="ident" id="3190279">SOCK_STREAM</span><span class="op" id="3190290">,</span>&nbsp;<span class="num" id="3190292">0</span><span class="op" id="3190293">,</span>&nbsp;<span class="string" id="3190295">&#34;listen&#34;</span><span class="op" id="3190303">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3190306">if</span>&nbsp;<span class="ident" id="3190309">err</span>&nbsp;<span class="op" id="3190313">!=</span>&nbsp;<span class="ident" id="3190316">nil</span>&nbsp;<span class="op" id="3190320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3190324">return</span>&nbsp;<span class="ident" id="3190331">nil</span><span class="op" id="3190334">,</span>&nbsp;<span class="op" id="3190336">&amp;</span><span class="ident" id="3190337">OpError</span><span class="op" id="3190344">{</span><span class="ident" id="3190345">Op</span><span class="op" id="3190347">:</span>&nbsp;<span class="string" id="3190349">&#34;listen&#34;</span><span class="op" id="3190357">,</span>&nbsp;<span class="ident" id="3190359">Net</span><span class="op" id="3190362">:</span>&nbsp;<span class="ident" id="3190364">net</span><span class="op" id="3190367">,</span>&nbsp;<span class="ident" id="3190369">Addr</span><span class="op" id="3190373">:</span>&nbsp;<span class="ident" id="3190375">laddr</span><span class="op" id="3190380">,</span>&nbsp;<span class="ident" id="3190382">Err</span><span class="op" id="3190385">:</span>&nbsp;<span class="ident" id="3190387">err</span><span class="op" id="3190390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3190393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3190396">return</span>&nbsp;<span class="op" id="3190403">&amp;</span><span class="ident" id="3190404">TCPListener</span><span class="op" id="3190415">{</span><span class="ident" id="3190416">fd</span><span class="op" id="3190418">}</span><span class="op" id="3190419">,</span>&nbsp;<span class="ident" id="3190421">nil</span><br>
<span class="lineno"></span><span class="op" id="3190425">}</span>
</div>
</body>
</html>
