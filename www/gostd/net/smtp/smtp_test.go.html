<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/smtp</h2>
<ul>
<li><a href="/gostd/net/smtp/auth.go.html">auth.go</a></li>
<li><a href="/gostd/net/smtp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/smtp/smtp.go.html">smtp.go</a></li>
<li><a href="/gostd/net/smtp/smtp_test.go.html" class="current">smtp_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6869018">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6869073">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6869127">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6869178">package</span>&nbsp;<span class="ident" id="6869186">smtp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6869192">import</span>&nbsp;<span class="op" id="6869199">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6869202">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6869211">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6869220">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6869234">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6869249">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6869255">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6869262">&#34;net/textproto&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6869279">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6869290">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6869301">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6869308">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="6869311">type</span>&nbsp;<span class="ident" id="6869316">authTest</span>&nbsp;<span class="keyword" id="6869325">struct</span>&nbsp;<span class="op" id="6869332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869335">auth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6869346">Auth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869352">challenges</span>&nbsp;<span class="op" id="6869363">[</span><span class="op" id="6869364">]</span><span class="builtintype" id="6869365">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869373">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6869384">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869392">responses</span>&nbsp;&nbsp;<span class="op" id="6869403">[</span><span class="op" id="6869404">]</span><span class="builtintype" id="6869405">string</span><br>
<span class="lineno">25</span><span class="op" id="6869412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6869415">var</span>&nbsp;<span class="ident" id="6869419">authTests</span>&nbsp;<span class="op" id="6869429">=</span>&nbsp;<span class="op" id="6869431">[</span><span class="op" id="6869432">]</span><span class="ident" id="6869433">authTest</span><span class="op" id="6869441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6869444">{</span><span class="ident" id="6869445">PlainAuth</span><span class="op" id="6869454">(</span><span class="string" id="6869455">&#34;&#34;</span><span class="op" id="6869457">,</span>&nbsp;<span class="string" id="6869459">&#34;user&#34;</span><span class="op" id="6869465">,</span>&nbsp;<span class="string" id="6869467">&#34;pass&#34;</span><span class="op" id="6869473">,</span>&nbsp;<span class="string" id="6869475">&#34;testserver&#34;</span><span class="op" id="6869487">)</span><span class="op" id="6869488">,</span>&nbsp;<span class="op" id="6869490">[</span><span class="op" id="6869491">]</span><span class="builtintype" id="6869492">string</span><span class="op" id="6869498">{</span><span class="op" id="6869499">}</span><span class="op" id="6869500">,</span>&nbsp;<span class="string" id="6869502">&#34;PLAIN&#34;</span><span class="op" id="6869509">,</span>&nbsp;<span class="op" id="6869511">[</span><span class="op" id="6869512">]</span><span class="builtintype" id="6869513">string</span><span class="op" id="6869519">{</span><span class="string" id="6869520">&#34;\x00user\x00pass&#34;</span><span class="op" id="6869538">}</span><span class="op" id="6869539">}</span><span class="op" id="6869540">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6869543">{</span><span class="ident" id="6869544">PlainAuth</span><span class="op" id="6869553">(</span><span class="string" id="6869554">&#34;foo&#34;</span><span class="op" id="6869559">,</span>&nbsp;<span class="string" id="6869561">&#34;bar&#34;</span><span class="op" id="6869566">,</span>&nbsp;<span class="string" id="6869568">&#34;baz&#34;</span><span class="op" id="6869573">,</span>&nbsp;<span class="string" id="6869575">&#34;testserver&#34;</span><span class="op" id="6869587">)</span><span class="op" id="6869588">,</span>&nbsp;<span class="op" id="6869590">[</span><span class="op" id="6869591">]</span><span class="builtintype" id="6869592">string</span><span class="op" id="6869598">{</span><span class="op" id="6869599">}</span><span class="op" id="6869600">,</span>&nbsp;<span class="string" id="6869602">&#34;PLAIN&#34;</span><span class="op" id="6869609">,</span>&nbsp;<span class="op" id="6869611">[</span><span class="op" id="6869612">]</span><span class="builtintype" id="6869613">string</span><span class="op" id="6869619">{</span><span class="string" id="6869620">&#34;foo\x00bar\x00baz&#34;</span><span class="op" id="6869639">}</span><span class="op" id="6869640">}</span><span class="op" id="6869641">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6869644">{</span><span class="ident" id="6869645">CRAMMD5Auth</span><span class="op" id="6869656">(</span><span class="string" id="6869657">&#34;user&#34;</span><span class="op" id="6869663">,</span>&nbsp;<span class="string" id="6869665">&#34;pass&#34;</span><span class="op" id="6869671">)</span><span class="op" id="6869672">,</span>&nbsp;<span class="op" id="6869674">[</span><span class="op" id="6869675">]</span><span class="builtintype" id="6869676">string</span><span class="op" id="6869682">{</span><span class="string" id="6869683">&#34;&lt;123456.1322876914@testserver&gt;&#34;</span><span class="op" id="6869715">}</span><span class="op" id="6869716">,</span>&nbsp;<span class="string" id="6869718">&#34;CRAM-MD5&#34;</span><span class="op" id="6869728">,</span>&nbsp;<span class="op" id="6869730">[</span><span class="op" id="6869731">]</span><span class="builtintype" id="6869732">string</span><span class="op" id="6869738">{</span><span class="string" id="6869739">&#34;&#34;</span><span class="op" id="6869741">,</span>&nbsp;<span class="string" id="6869743">&#34;user&nbsp;287eb355114cf5c471c26a875f1ca4ae&#34;</span><span class="op" id="6869782">}</span><span class="op" id="6869783">}</span><span class="op" id="6869784">,</span><br>
<span class="lineno"></span><span class="op" id="6869786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6869789">func</span>&nbsp;<span class="ident" id="6869794">TestAuth</span><span class="op" id="6869802">(</span><span class="ident" id="6869803">t</span>&nbsp;<span class="op" id="6869805">*</span><span class="ident" id="6869806">testing</span><span class="op" id="6869813">.</span><span class="ident" id="6869814">T</span><span class="op" id="6869815">)</span>&nbsp;<span class="op" id="6869817">{</span><br>
<span class="lineno"></span><span class="ident" id="6869819">testLoop</span><span class="op" id="6869827">:</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869830">for</span>&nbsp;<span class="ident" id="6869834">i</span><span class="op" id="6869835">,</span>&nbsp;<span class="ident" id="6869837">test</span>&nbsp;<span class="op" id="6869842">:=</span>&nbsp;<span class="keyword" id="6869845">range</span>&nbsp;<span class="ident" id="6869851">authTests</span>&nbsp;<span class="op" id="6869861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869865">name</span><span class="op" id="6869869">,</span>&nbsp;<span class="ident" id="6869871">resp</span><span class="op" id="6869875">,</span>&nbsp;<span class="ident" id="6869877">err</span>&nbsp;<span class="op" id="6869881">:=</span>&nbsp;<span class="ident" id="6869884">test</span><span class="op" id="6869888">.</span><span class="ident" id="6869889">auth</span><span class="op" id="6869893">.</span><span class="ident" id="6869894">Start</span><span class="op" id="6869899">(</span><span class="op" id="6869900">&amp;</span><span class="ident" id="6869901">ServerInfo</span><span class="op" id="6869911">{</span><span class="string" id="6869912">&#34;testserver&#34;</span><span class="op" id="6869924">,</span>&nbsp;<span class="builtintype" id="6869926">true</span><span class="op" id="6869930">,</span>&nbsp;<span class="ident" id="6869932">nil</span><span class="op" id="6869935">}</span><span class="op" id="6869936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869940">if</span>&nbsp;<span class="ident" id="6869943">name</span>&nbsp;<span class="op" id="6869948">!=</span>&nbsp;<span class="ident" id="6869951">test</span><span class="op" id="6869955">.</span><span class="ident" id="6869956">name</span>&nbsp;<span class="op" id="6869961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869966">t</span><span class="op" id="6869967">.</span><span class="ident" id="6869968">Errorf</span><span class="op" id="6869974">(</span><span class="string" id="6869975">&#34;#%d&nbsp;got&nbsp;name&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="6870005">,</span>&nbsp;<span class="ident" id="6870007">i</span><span class="op" id="6870008">,</span>&nbsp;<span class="ident" id="6870010">name</span><span class="op" id="6870014">,</span>&nbsp;<span class="ident" id="6870016">test</span><span class="op" id="6870020">.</span><span class="ident" id="6870021">name</span><span class="op" id="6870025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870029">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870033">if</span>&nbsp;<span class="op" id="6870036">!</span><span class="ident" id="6870037">bytes</span><span class="op" id="6870042">.</span><span class="ident" id="6870043">Equal</span><span class="op" id="6870048">(</span><span class="ident" id="6870049">resp</span><span class="op" id="6870053">,</span>&nbsp;<span class="op" id="6870055">[</span><span class="op" id="6870056">]</span><span class="builtintype" id="6870057">byte</span><span class="op" id="6870061">(</span><span class="ident" id="6870062">test</span><span class="op" id="6870066">.</span><span class="ident" id="6870067">responses</span><span class="op" id="6870076">[</span><span class="num" id="6870077">0</span><span class="op" id="6870078">]</span><span class="op" id="6870079">)</span><span class="op" id="6870080">)</span>&nbsp;<span class="op" id="6870082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870087">t</span><span class="op" id="6870088">.</span><span class="ident" id="6870089">Errorf</span><span class="op" id="6870095">(</span><span class="string" id="6870096">&#34;#%d&nbsp;got&nbsp;response&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="6870130">,</span>&nbsp;<span class="ident" id="6870132">i</span><span class="op" id="6870133">,</span>&nbsp;<span class="ident" id="6870135">resp</span><span class="op" id="6870139">,</span>&nbsp;<span class="ident" id="6870141">test</span><span class="op" id="6870145">.</span><span class="ident" id="6870146">responses</span><span class="op" id="6870155">[</span><span class="num" id="6870156">0</span><span class="op" id="6870157">]</span><span class="op" id="6870158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870166">if</span>&nbsp;<span class="ident" id="6870169">err</span>&nbsp;<span class="op" id="6870173">!=</span>&nbsp;<span class="ident" id="6870176">nil</span>&nbsp;<span class="op" id="6870180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870185">t</span><span class="op" id="6870186">.</span><span class="ident" id="6870187">Errorf</span><span class="op" id="6870193">(</span><span class="string" id="6870194">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="6870209">,</span>&nbsp;<span class="ident" id="6870211">i</span><span class="op" id="6870212">,</span>&nbsp;<span class="ident" id="6870214">err</span><span class="op" id="6870217">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870225">for</span>&nbsp;<span class="ident" id="6870229">j</span>&nbsp;<span class="op" id="6870231">:=</span>&nbsp;<span class="keyword" id="6870234">range</span>&nbsp;<span class="ident" id="6870240">test</span><span class="op" id="6870244">.</span><span class="ident" id="6870245">challenges</span>&nbsp;<span class="op" id="6870256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870261">challenge</span>&nbsp;<span class="op" id="6870271">:=</span>&nbsp;<span class="op" id="6870274">[</span><span class="op" id="6870275">]</span><span class="builtintype" id="6870276">byte</span><span class="op" id="6870280">(</span><span class="ident" id="6870281">test</span><span class="op" id="6870285">.</span><span class="ident" id="6870286">challenges</span><span class="op" id="6870296">[</span><span class="ident" id="6870297">j</span><span class="op" id="6870298">]</span><span class="op" id="6870299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870304">expected</span>&nbsp;<span class="op" id="6870313">:=</span>&nbsp;<span class="op" id="6870316">[</span><span class="op" id="6870317">]</span><span class="builtintype" id="6870318">byte</span><span class="op" id="6870322">(</span><span class="ident" id="6870323">test</span><span class="op" id="6870327">.</span><span class="ident" id="6870328">responses</span><span class="op" id="6870337">[</span><span class="ident" id="6870338">j</span><span class="op" id="6870339">+</span><span class="num" id="6870340">1</span><span class="op" id="6870341">]</span><span class="op" id="6870342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870347">resp</span><span class="op" id="6870351">,</span>&nbsp;<span class="ident" id="6870353">err</span>&nbsp;<span class="op" id="6870357">:=</span>&nbsp;<span class="ident" id="6870360">test</span><span class="op" id="6870364">.</span><span class="ident" id="6870365">auth</span><span class="op" id="6870369">.</span><span class="ident" id="6870370">Next</span><span class="op" id="6870374">(</span><span class="ident" id="6870375">challenge</span><span class="op" id="6870384">,</span>&nbsp;<span class="builtintype" id="6870386">true</span><span class="op" id="6870390">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870395">if</span>&nbsp;<span class="ident" id="6870398">err</span>&nbsp;<span class="op" id="6870402">!=</span>&nbsp;<span class="ident" id="6870405">nil</span>&nbsp;<span class="op" id="6870409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870415">t</span><span class="op" id="6870416">.</span><span class="ident" id="6870417">Errorf</span><span class="op" id="6870423">(</span><span class="string" id="6870424">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="6870439">,</span>&nbsp;<span class="ident" id="6870441">i</span><span class="op" id="6870442">,</span>&nbsp;<span class="ident" id="6870444">err</span><span class="op" id="6870447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870453">continue</span>&nbsp;<span class="ident" id="6870462">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870479">if</span>&nbsp;<span class="op" id="6870482">!</span><span class="ident" id="6870483">bytes</span><span class="op" id="6870488">.</span><span class="ident" id="6870489">Equal</span><span class="op" id="6870494">(</span><span class="ident" id="6870495">resp</span><span class="op" id="6870499">,</span>&nbsp;<span class="ident" id="6870501">expected</span><span class="op" id="6870509">)</span>&nbsp;<span class="op" id="6870511">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870517">t</span><span class="op" id="6870518">.</span><span class="ident" id="6870519">Errorf</span><span class="op" id="6870525">(</span><span class="string" id="6870526">&#34;#%d&nbsp;got&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="6870551">,</span>&nbsp;<span class="ident" id="6870553">i</span><span class="op" id="6870554">,</span>&nbsp;<span class="ident" id="6870556">resp</span><span class="op" id="6870560">,</span>&nbsp;<span class="ident" id="6870562">expected</span><span class="op" id="6870570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870576">continue</span>&nbsp;<span class="ident" id="6870585">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870604">}</span><br>
<span class="lineno">60</span><span class="op" id="6870606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6870609">func</span>&nbsp;<span class="ident" id="6870614">TestAuthPlain</span><span class="op" id="6870627">(</span><span class="ident" id="6870628">t</span>&nbsp;<span class="op" id="6870630">*</span><span class="ident" id="6870631">testing</span><span class="op" id="6870638">.</span><span class="ident" id="6870639">T</span><span class="op" id="6870640">)</span>&nbsp;<span class="op" id="6870642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870645">auth</span>&nbsp;<span class="op" id="6870650">:=</span>&nbsp;<span class="ident" id="6870653">PlainAuth</span><span class="op" id="6870662">(</span><span class="string" id="6870663">&#34;foo&#34;</span><span class="op" id="6870668">,</span>&nbsp;<span class="string" id="6870670">&#34;bar&#34;</span><span class="op" id="6870675">,</span>&nbsp;<span class="string" id="6870677">&#34;baz&#34;</span><span class="op" id="6870682">,</span>&nbsp;<span class="string" id="6870684">&#34;servername&#34;</span><span class="op" id="6870696">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870700">tests</span>&nbsp;<span class="op" id="6870706">:=</span>&nbsp;<span class="op" id="6870709">[</span><span class="op" id="6870710">]</span><span class="keyword" id="6870711">struct</span>&nbsp;<span class="op" id="6870718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870722">server</span>&nbsp;<span class="op" id="6870729">*</span><span class="ident" id="6870730">ServerInfo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870743">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6870750">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870758">}</span><span class="op" id="6870759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870763">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870768">server</span><span class="op" id="6870774">:</span>&nbsp;<span class="op" id="6870776">&amp;</span><span class="ident" id="6870777">ServerInfo</span><span class="op" id="6870787">{</span><span class="ident" id="6870788">Name</span><span class="op" id="6870792">:</span>&nbsp;<span class="string" id="6870794">&#34;servername&#34;</span><span class="op" id="6870806">,</span>&nbsp;<span class="ident" id="6870808">TLS</span><span class="op" id="6870811">:</span>&nbsp;<span class="builtintype" id="6870813">true</span><span class="op" id="6870817">}</span><span class="op" id="6870818">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870822">}</span><span class="op" id="6870823">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6870832">//&nbsp;Okay;&nbsp;explicitly&nbsp;advertised&nbsp;by&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870877">server</span><span class="op" id="6870883">:</span>&nbsp;<span class="op" id="6870885">&amp;</span><span class="ident" id="6870886">ServerInfo</span><span class="op" id="6870896">{</span><span class="ident" id="6870897">Name</span><span class="op" id="6870901">:</span>&nbsp;<span class="string" id="6870903">&#34;servername&#34;</span><span class="op" id="6870915">,</span>&nbsp;<span class="ident" id="6870917">Auth</span><span class="op" id="6870921">:</span>&nbsp;<span class="op" id="6870923">[</span><span class="op" id="6870924">]</span><span class="builtintype" id="6870925">string</span><span class="op" id="6870931">{</span><span class="string" id="6870932">&#34;PLAIN&#34;</span><span class="op" id="6870939">}</span><span class="op" id="6870940">}</span><span class="op" id="6870941">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870945">}</span><span class="op" id="6870946">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870955">server</span><span class="op" id="6870961">:</span>&nbsp;<span class="op" id="6870963">&amp;</span><span class="ident" id="6870964">ServerInfo</span><span class="op" id="6870974">{</span><span class="ident" id="6870975">Name</span><span class="op" id="6870979">:</span>&nbsp;<span class="string" id="6870981">&#34;servername&#34;</span><span class="op" id="6870993">,</span>&nbsp;<span class="ident" id="6870995">Auth</span><span class="op" id="6870999">:</span>&nbsp;<span class="op" id="6871001">[</span><span class="op" id="6871002">]</span><span class="builtintype" id="6871003">string</span><span class="op" id="6871009">{</span><span class="string" id="6871010">&#34;CRAM-MD5&#34;</span><span class="op" id="6871020">}</span><span class="op" id="6871021">}</span><span class="op" id="6871022">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871027">err</span><span class="op" id="6871030">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6871035">&#34;unencrypted&nbsp;connection&#34;</span><span class="op" id="6871059">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6871063">}</span><span class="op" id="6871064">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6871068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871073">server</span><span class="op" id="6871079">:</span>&nbsp;<span class="op" id="6871081">&amp;</span><span class="ident" id="6871082">ServerInfo</span><span class="op" id="6871092">{</span><span class="ident" id="6871093">Name</span><span class="op" id="6871097">:</span>&nbsp;<span class="string" id="6871099">&#34;attacker&#34;</span><span class="op" id="6871109">,</span>&nbsp;<span class="ident" id="6871111">TLS</span><span class="op" id="6871114">:</span>&nbsp;<span class="builtintype" id="6871116">true</span><span class="op" id="6871120">}</span><span class="op" id="6871121">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871126">err</span><span class="op" id="6871129">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6871134">&#34;wrong&nbsp;host&nbsp;name&#34;</span><span class="op" id="6871151">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6871155">}</span><span class="op" id="6871156">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6871159">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871162">for</span>&nbsp;<span class="ident" id="6871166">i</span><span class="op" id="6871167">,</span>&nbsp;<span class="ident" id="6871169">tt</span>&nbsp;<span class="op" id="6871172">:=</span>&nbsp;<span class="keyword" id="6871175">range</span>&nbsp;<span class="ident" id="6871181">tests</span>&nbsp;<span class="op" id="6871187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871191">_</span><span class="op" id="6871192">,</span>&nbsp;<span class="ident" id="6871194">_</span><span class="op" id="6871195">,</span>&nbsp;<span class="ident" id="6871197">err</span>&nbsp;<span class="op" id="6871201">:=</span>&nbsp;<span class="ident" id="6871204">auth</span><span class="op" id="6871208">.</span><span class="ident" id="6871209">Start</span><span class="op" id="6871214">(</span><span class="ident" id="6871215">tt</span><span class="op" id="6871217">.</span><span class="ident" id="6871218">server</span><span class="op" id="6871224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871228">got</span>&nbsp;<span class="op" id="6871232">:=</span>&nbsp;<span class="string" id="6871235">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871240">if</span>&nbsp;<span class="ident" id="6871243">err</span>&nbsp;<span class="op" id="6871247">!=</span>&nbsp;<span class="ident" id="6871250">nil</span>&nbsp;<span class="op" id="6871254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871259">got</span>&nbsp;<span class="op" id="6871263">=</span>&nbsp;<span class="ident" id="6871265">err</span><span class="op" id="6871268">.</span><span class="ident" id="6871269">Error</span><span class="op" id="6871274">(</span><span class="op" id="6871275">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6871279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871283">if</span>&nbsp;<span class="ident" id="6871286">got</span>&nbsp;<span class="op" id="6871290">!=</span>&nbsp;<span class="ident" id="6871293">tt</span><span class="op" id="6871295">.</span><span class="ident" id="6871296">err</span>&nbsp;<span class="op" id="6871300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871305">t</span><span class="op" id="6871306">.</span><span class="ident" id="6871307">Errorf</span><span class="op" id="6871313">(</span><span class="string" id="6871314">&#34;%d.&nbsp;got&nbsp;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6871343">,</span>&nbsp;<span class="ident" id="6871345">i</span><span class="op" id="6871346">,</span>&nbsp;<span class="ident" id="6871348">got</span><span class="op" id="6871351">,</span>&nbsp;<span class="ident" id="6871353">tt</span><span class="op" id="6871355">.</span><span class="ident" id="6871356">err</span><span class="op" id="6871359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6871363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6871366">}</span><br>
<span class="lineno">95</span><span class="op" id="6871368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6871371">type</span>&nbsp;<span class="ident" id="6871376">faker</span>&nbsp;<span class="keyword" id="6871382">struct</span>&nbsp;<span class="op" id="6871389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871392">io</span><span class="op" id="6871394">.</span><span class="ident" id="6871395">ReadWriter</span><br>
<span class="lineno"></span><span class="op" id="6871406">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="6871409">func</span>&nbsp;<span class="op" id="6871414">(</span><span class="ident" id="6871415">f</span>&nbsp;<span class="ident" id="6871417">faker</span><span class="op" id="6871422">)</span>&nbsp;<span class="ident" id="6871424">Close</span><span class="op" id="6871429">(</span><span class="op" id="6871430">)</span>&nbsp;<span class="builtintype" id="6871432">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6871458">{</span>&nbsp;<span class="keyword" id="6871460">return</span>&nbsp;<span class="ident" id="6871467">nil</span>&nbsp;<span class="op" id="6871471">}</span><br>
<span class="lineno"></span><span class="keyword" id="6871473">func</span>&nbsp;<span class="op" id="6871478">(</span><span class="ident" id="6871479">f</span>&nbsp;<span class="ident" id="6871481">faker</span><span class="op" id="6871486">)</span>&nbsp;<span class="ident" id="6871488">LocalAddr</span><span class="op" id="6871497">(</span><span class="op" id="6871498">)</span>&nbsp;<span class="ident" id="6871500">net</span><span class="op" id="6871503">.</span><span class="ident" id="6871504">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6871522">{</span>&nbsp;<span class="keyword" id="6871524">return</span>&nbsp;<span class="ident" id="6871531">nil</span>&nbsp;<span class="op" id="6871535">}</span><br>
<span class="lineno"></span><span class="keyword" id="6871537">func</span>&nbsp;<span class="op" id="6871542">(</span><span class="ident" id="6871543">f</span>&nbsp;<span class="ident" id="6871545">faker</span><span class="op" id="6871550">)</span>&nbsp;<span class="ident" id="6871552">RemoteAddr</span><span class="op" id="6871562">(</span><span class="op" id="6871563">)</span>&nbsp;<span class="ident" id="6871565">net</span><span class="op" id="6871568">.</span><span class="ident" id="6871569">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6871586">{</span>&nbsp;<span class="keyword" id="6871588">return</span>&nbsp;<span class="ident" id="6871595">nil</span>&nbsp;<span class="op" id="6871599">}</span><br>
<span class="lineno"></span><span class="keyword" id="6871601">func</span>&nbsp;<span class="op" id="6871606">(</span><span class="ident" id="6871607">f</span>&nbsp;<span class="ident" id="6871609">faker</span><span class="op" id="6871614">)</span>&nbsp;<span class="ident" id="6871616">SetDeadline</span><span class="op" id="6871627">(</span><span class="ident" id="6871628">time</span><span class="op" id="6871632">.</span><span class="ident" id="6871633">Time</span><span class="op" id="6871637">)</span>&nbsp;<span class="builtintype" id="6871639">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6871650">{</span>&nbsp;<span class="keyword" id="6871652">return</span>&nbsp;<span class="ident" id="6871659">nil</span>&nbsp;<span class="op" id="6871663">}</span><br>
<span class="lineno">105</span><span class="keyword" id="6871665">func</span>&nbsp;<span class="op" id="6871670">(</span><span class="ident" id="6871671">f</span>&nbsp;<span class="ident" id="6871673">faker</span><span class="op" id="6871678">)</span>&nbsp;<span class="ident" id="6871680">SetReadDeadline</span><span class="op" id="6871695">(</span><span class="ident" id="6871696">time</span><span class="op" id="6871700">.</span><span class="ident" id="6871701">Time</span><span class="op" id="6871705">)</span>&nbsp;<span class="builtintype" id="6871707">error</span>&nbsp;&nbsp;<span class="op" id="6871714">{</span>&nbsp;<span class="keyword" id="6871716">return</span>&nbsp;<span class="ident" id="6871723">nil</span>&nbsp;<span class="op" id="6871727">}</span><br>
<span class="lineno"></span><span class="keyword" id="6871729">func</span>&nbsp;<span class="op" id="6871734">(</span><span class="ident" id="6871735">f</span>&nbsp;<span class="ident" id="6871737">faker</span><span class="op" id="6871742">)</span>&nbsp;<span class="ident" id="6871744">SetWriteDeadline</span><span class="op" id="6871760">(</span><span class="ident" id="6871761">time</span><span class="op" id="6871765">.</span><span class="ident" id="6871766">Time</span><span class="op" id="6871770">)</span>&nbsp;<span class="builtintype" id="6871772">error</span>&nbsp;<span class="op" id="6871778">{</span>&nbsp;<span class="keyword" id="6871780">return</span>&nbsp;<span class="ident" id="6871787">nil</span>&nbsp;<span class="op" id="6871791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6871794">func</span>&nbsp;<span class="ident" id="6871799">TestBasic</span><span class="op" id="6871808">(</span><span class="ident" id="6871809">t</span>&nbsp;<span class="op" id="6871811">*</span><span class="ident" id="6871812">testing</span><span class="op" id="6871819">.</span><span class="ident" id="6871820">T</span><span class="op" id="6871821">)</span>&nbsp;<span class="op" id="6871823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871826">server</span>&nbsp;<span class="op" id="6871833">:=</span>&nbsp;<span class="ident" id="6871836">strings</span><span class="op" id="6871843">.</span><span class="ident" id="6871844">Join</span><span class="op" id="6871848">(</span><span class="ident" id="6871849">strings</span><span class="op" id="6871856">.</span><span class="ident" id="6871857">Split</span><span class="op" id="6871862">(</span><span class="ident" id="6871863">basicServer</span><span class="op" id="6871874">,</span>&nbsp;<span class="string" id="6871876">&#34;\n&#34;</span><span class="op" id="6871880">)</span><span class="op" id="6871881">,</span>&nbsp;<span class="string" id="6871883">&#34;\r\n&#34;</span><span class="op" id="6871889">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871892">client</span>&nbsp;<span class="op" id="6871899">:=</span>&nbsp;<span class="ident" id="6871902">strings</span><span class="op" id="6871909">.</span><span class="ident" id="6871910">Join</span><span class="op" id="6871914">(</span><span class="ident" id="6871915">strings</span><span class="op" id="6871922">.</span><span class="ident" id="6871923">Split</span><span class="op" id="6871928">(</span><span class="ident" id="6871929">basicClient</span><span class="op" id="6871940">,</span>&nbsp;<span class="string" id="6871942">&#34;\n&#34;</span><span class="op" id="6871946">)</span><span class="op" id="6871947">,</span>&nbsp;<span class="string" id="6871949">&#34;\r\n&#34;</span><span class="op" id="6871955">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871959">var</span>&nbsp;<span class="ident" id="6871963">cmdbuf</span>&nbsp;<span class="ident" id="6871970">bytes</span><span class="op" id="6871975">.</span><span class="ident" id="6871976">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871984">bcmdbuf</span>&nbsp;<span class="op" id="6871992">:=</span>&nbsp;<span class="ident" id="6871995">bufio</span><span class="op" id="6872000">.</span><span class="ident" id="6872001">NewWriter</span><span class="op" id="6872010">(</span><span class="op" id="6872011">&amp;</span><span class="ident" id="6872012">cmdbuf</span><span class="op" id="6872018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872021">var</span>&nbsp;<span class="ident" id="6872025">fake</span>&nbsp;<span class="ident" id="6872030">faker</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872037">fake</span><span class="op" id="6872041">.</span><span class="ident" id="6872042">ReadWriter</span>&nbsp;<span class="op" id="6872053">=</span>&nbsp;<span class="ident" id="6872055">bufio</span><span class="op" id="6872060">.</span><span class="ident" id="6872061">NewReadWriter</span><span class="op" id="6872074">(</span><span class="ident" id="6872075">bufio</span><span class="op" id="6872080">.</span><span class="ident" id="6872081">NewReader</span><span class="op" id="6872090">(</span><span class="ident" id="6872091">strings</span><span class="op" id="6872098">.</span><span class="ident" id="6872099">NewReader</span><span class="op" id="6872108">(</span><span class="ident" id="6872109">server</span><span class="op" id="6872115">)</span><span class="op" id="6872116">)</span><span class="op" id="6872117">,</span>&nbsp;<span class="ident" id="6872119">bcmdbuf</span><span class="op" id="6872126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872129">c</span>&nbsp;<span class="op" id="6872131">:=</span>&nbsp;<span class="op" id="6872134">&amp;</span><span class="ident" id="6872135">Client</span><span class="op" id="6872141">{</span><span class="ident" id="6872142">Text</span><span class="op" id="6872146">:</span>&nbsp;<span class="ident" id="6872148">textproto</span><span class="op" id="6872157">.</span><span class="ident" id="6872158">NewConn</span><span class="op" id="6872165">(</span><span class="ident" id="6872166">fake</span><span class="op" id="6872170">)</span><span class="op" id="6872171">,</span>&nbsp;<span class="ident" id="6872173">localName</span><span class="op" id="6872182">:</span>&nbsp;<span class="string" id="6872184">&#34;localhost&#34;</span><span class="op" id="6872195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872199">if</span>&nbsp;<span class="ident" id="6872202">err</span>&nbsp;<span class="op" id="6872206">:=</span>&nbsp;<span class="ident" id="6872209">c</span><span class="op" id="6872210">.</span><span class="ident" id="6872211">helo</span><span class="op" id="6872215">(</span><span class="op" id="6872216">)</span><span class="op" id="6872217">;</span>&nbsp;<span class="ident" id="6872219">err</span>&nbsp;<span class="op" id="6872223">!=</span>&nbsp;<span class="ident" id="6872226">nil</span>&nbsp;<span class="op" id="6872230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872234">t</span><span class="op" id="6872235">.</span><span class="ident" id="6872236">Fatalf</span><span class="op" id="6872242">(</span><span class="string" id="6872243">&#34;HELO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6872260">,</span>&nbsp;<span class="ident" id="6872262">err</span><span class="op" id="6872265">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872271">if</span>&nbsp;<span class="ident" id="6872274">err</span>&nbsp;<span class="op" id="6872278">:=</span>&nbsp;<span class="ident" id="6872281">c</span><span class="op" id="6872282">.</span><span class="ident" id="6872283">ehlo</span><span class="op" id="6872287">(</span><span class="op" id="6872288">)</span><span class="op" id="6872289">;</span>&nbsp;<span class="ident" id="6872291">err</span>&nbsp;<span class="op" id="6872295">==</span>&nbsp;<span class="ident" id="6872298">nil</span>&nbsp;<span class="op" id="6872302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872306">t</span><span class="op" id="6872307">.</span><span class="ident" id="6872308">Fatalf</span><span class="op" id="6872314">(</span><span class="string" id="6872315">&#34;Expected&nbsp;first&nbsp;EHLO&nbsp;to&nbsp;fail&#34;</span><span class="op" id="6872344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872350">if</span>&nbsp;<span class="ident" id="6872353">err</span>&nbsp;<span class="op" id="6872357">:=</span>&nbsp;<span class="ident" id="6872360">c</span><span class="op" id="6872361">.</span><span class="ident" id="6872362">ehlo</span><span class="op" id="6872366">(</span><span class="op" id="6872367">)</span><span class="op" id="6872368">;</span>&nbsp;<span class="ident" id="6872370">err</span>&nbsp;<span class="op" id="6872374">!=</span>&nbsp;<span class="ident" id="6872377">nil</span>&nbsp;<span class="op" id="6872381">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872385">t</span><span class="op" id="6872386">.</span><span class="ident" id="6872387">Fatalf</span><span class="op" id="6872393">(</span><span class="string" id="6872394">&#34;Second&nbsp;EHLO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6872418">,</span>&nbsp;<span class="ident" id="6872420">err</span><span class="op" id="6872423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872430">c</span><span class="op" id="6872431">.</span><span class="ident" id="6872432">didHello</span>&nbsp;<span class="op" id="6872441">=</span>&nbsp;<span class="builtintype" id="6872443">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872449">if</span>&nbsp;<span class="ident" id="6872452">ok</span><span class="op" id="6872454">,</span>&nbsp;<span class="ident" id="6872456">args</span>&nbsp;<span class="op" id="6872461">:=</span>&nbsp;<span class="ident" id="6872464">c</span><span class="op" id="6872465">.</span><span class="ident" id="6872466">Extension</span><span class="op" id="6872475">(</span><span class="string" id="6872476">&#34;aUtH&#34;</span><span class="op" id="6872482">)</span><span class="op" id="6872483">;</span>&nbsp;<span class="op" id="6872485">!</span><span class="ident" id="6872486">ok</span>&nbsp;<span class="op" id="6872489">||</span>&nbsp;<span class="ident" id="6872492">args</span>&nbsp;<span class="op" id="6872497">!=</span>&nbsp;<span class="string" id="6872500">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="6872514">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872518">t</span><span class="op" id="6872519">.</span><span class="ident" id="6872520">Fatalf</span><span class="op" id="6872526">(</span><span class="string" id="6872527">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="6872552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872558">if</span>&nbsp;<span class="ident" id="6872561">ok</span><span class="op" id="6872563">,</span>&nbsp;<span class="ident" id="6872565">_</span>&nbsp;<span class="op" id="6872567">:=</span>&nbsp;<span class="ident" id="6872570">c</span><span class="op" id="6872571">.</span><span class="ident" id="6872572">Extension</span><span class="op" id="6872581">(</span><span class="string" id="6872582">&#34;DSN&#34;</span><span class="op" id="6872587">)</span><span class="op" id="6872588">;</span>&nbsp;<span class="ident" id="6872590">ok</span>&nbsp;<span class="op" id="6872593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872597">t</span><span class="op" id="6872598">.</span><span class="ident" id="6872599">Fatalf</span><span class="op" id="6872605">(</span><span class="string" id="6872606">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="6872629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872632">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872636">if</span>&nbsp;<span class="ident" id="6872639">err</span>&nbsp;<span class="op" id="6872643">:=</span>&nbsp;<span class="ident" id="6872646">c</span><span class="op" id="6872647">.</span><span class="ident" id="6872648">Mail</span><span class="op" id="6872652">(</span><span class="string" id="6872653">&#34;user@gmail.com&#34;</span><span class="op" id="6872669">)</span><span class="op" id="6872670">;</span>&nbsp;<span class="ident" id="6872672">err</span>&nbsp;<span class="op" id="6872676">==</span>&nbsp;<span class="ident" id="6872679">nil</span>&nbsp;<span class="op" id="6872683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872687">t</span><span class="op" id="6872688">.</span><span class="ident" id="6872689">Fatalf</span><span class="op" id="6872695">(</span><span class="string" id="6872696">&#34;MAIL&nbsp;should&nbsp;require&nbsp;authentication&#34;</span><span class="op" id="6872732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872739">if</span>&nbsp;<span class="ident" id="6872742">err</span>&nbsp;<span class="op" id="6872746">:=</span>&nbsp;<span class="ident" id="6872749">c</span><span class="op" id="6872750">.</span><span class="ident" id="6872751">Verify</span><span class="op" id="6872757">(</span><span class="string" id="6872758">&#34;user1@gmail.com&#34;</span><span class="op" id="6872775">)</span><span class="op" id="6872776">;</span>&nbsp;<span class="ident" id="6872778">err</span>&nbsp;<span class="op" id="6872782">==</span>&nbsp;<span class="ident" id="6872785">nil</span>&nbsp;<span class="op" id="6872789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872793">t</span><span class="op" id="6872794">.</span><span class="ident" id="6872795">Fatalf</span><span class="op" id="6872801">(</span><span class="string" id="6872802">&#34;First&nbsp;VRFY:&nbsp;expected&nbsp;no&nbsp;verification&#34;</span><span class="op" id="6872840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872846">if</span>&nbsp;<span class="ident" id="6872849">err</span>&nbsp;<span class="op" id="6872853">:=</span>&nbsp;<span class="ident" id="6872856">c</span><span class="op" id="6872857">.</span><span class="ident" id="6872858">Verify</span><span class="op" id="6872864">(</span><span class="string" id="6872865">&#34;user2@gmail.com&#34;</span><span class="op" id="6872882">)</span><span class="op" id="6872883">;</span>&nbsp;<span class="ident" id="6872885">err</span>&nbsp;<span class="op" id="6872889">!=</span>&nbsp;<span class="ident" id="6872892">nil</span>&nbsp;<span class="op" id="6872896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872900">t</span><span class="op" id="6872901">.</span><span class="ident" id="6872902">Fatalf</span><span class="op" id="6872908">(</span><span class="string" id="6872909">&#34;Second&nbsp;VRFY:&nbsp;expected&nbsp;verification,&nbsp;got&nbsp;%s&#34;</span><span class="op" id="6872953">,</span>&nbsp;<span class="ident" id="6872955">err</span><span class="op" id="6872958">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6872965">//&nbsp;fake&nbsp;TLS&nbsp;so&nbsp;authentication&nbsp;won&#39;t&nbsp;complain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873011">c</span><span class="op" id="6873012">.</span><span class="ident" id="6873013">tls</span>&nbsp;<span class="op" id="6873017">=</span>&nbsp;<span class="builtintype" id="6873019">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873025">c</span><span class="op" id="6873026">.</span><span class="ident" id="6873027">serverName</span>&nbsp;<span class="op" id="6873038">=</span>&nbsp;<span class="string" id="6873040">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873059">if</span>&nbsp;<span class="ident" id="6873062">err</span>&nbsp;<span class="op" id="6873066">:=</span>&nbsp;<span class="ident" id="6873069">c</span><span class="op" id="6873070">.</span><span class="ident" id="6873071">Auth</span><span class="op" id="6873075">(</span><span class="ident" id="6873076">PlainAuth</span><span class="op" id="6873085">(</span><span class="string" id="6873086">&#34;&#34;</span><span class="op" id="6873088">,</span>&nbsp;<span class="string" id="6873090">&#34;user&#34;</span><span class="op" id="6873096">,</span>&nbsp;<span class="string" id="6873098">&#34;pass&#34;</span><span class="op" id="6873104">,</span>&nbsp;<span class="string" id="6873106">&#34;smtp.google.com&#34;</span><span class="op" id="6873123">)</span><span class="op" id="6873124">)</span><span class="op" id="6873125">;</span>&nbsp;<span class="ident" id="6873127">err</span>&nbsp;<span class="op" id="6873131">!=</span>&nbsp;<span class="ident" id="6873134">nil</span>&nbsp;<span class="op" id="6873138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873142">t</span><span class="op" id="6873143">.</span><span class="ident" id="6873144">Fatalf</span><span class="op" id="6873150">(</span><span class="string" id="6873151">&#34;AUTH&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6873168">,</span>&nbsp;<span class="ident" id="6873170">err</span><span class="op" id="6873173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873180">if</span>&nbsp;<span class="ident" id="6873183">err</span>&nbsp;<span class="op" id="6873187">:=</span>&nbsp;<span class="ident" id="6873190">c</span><span class="op" id="6873191">.</span><span class="ident" id="6873192">Mail</span><span class="op" id="6873196">(</span><span class="string" id="6873197">&#34;user@gmail.com&#34;</span><span class="op" id="6873213">)</span><span class="op" id="6873214">;</span>&nbsp;<span class="ident" id="6873216">err</span>&nbsp;<span class="op" id="6873220">!=</span>&nbsp;<span class="ident" id="6873223">nil</span>&nbsp;<span class="op" id="6873227">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873231">t</span><span class="op" id="6873232">.</span><span class="ident" id="6873233">Fatalf</span><span class="op" id="6873239">(</span><span class="string" id="6873240">&#34;MAIL&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6873257">,</span>&nbsp;<span class="ident" id="6873259">err</span><span class="op" id="6873262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873268">if</span>&nbsp;<span class="ident" id="6873271">err</span>&nbsp;<span class="op" id="6873275">:=</span>&nbsp;<span class="ident" id="6873278">c</span><span class="op" id="6873279">.</span><span class="ident" id="6873280">Rcpt</span><span class="op" id="6873284">(</span><span class="string" id="6873285">&#34;golang-nuts@googlegroups.com&#34;</span><span class="op" id="6873315">)</span><span class="op" id="6873316">;</span>&nbsp;<span class="ident" id="6873318">err</span>&nbsp;<span class="op" id="6873322">!=</span>&nbsp;<span class="ident" id="6873325">nil</span>&nbsp;<span class="op" id="6873329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873333">t</span><span class="op" id="6873334">.</span><span class="ident" id="6873335">Fatalf</span><span class="op" id="6873341">(</span><span class="string" id="6873342">&#34;RCPT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6873359">,</span>&nbsp;<span class="ident" id="6873361">err</span><span class="op" id="6873364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873367">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873370">msg</span>&nbsp;<span class="op" id="6873374">:=</span>&nbsp;<span class="string" id="6873377">`From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno"></span>Line&nbsp;1<br>
<span class="lineno">165</span>.Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873494">w</span><span class="op" id="6873495">,</span>&nbsp;<span class="ident" id="6873497">err</span>&nbsp;<span class="op" id="6873501">:=</span>&nbsp;<span class="ident" id="6873504">c</span><span class="op" id="6873505">.</span><span class="ident" id="6873506">Data</span><span class="op" id="6873510">(</span><span class="op" id="6873511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873514">if</span>&nbsp;<span class="ident" id="6873517">err</span>&nbsp;<span class="op" id="6873521">!=</span>&nbsp;<span class="ident" id="6873524">nil</span>&nbsp;<span class="op" id="6873528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873532">t</span><span class="op" id="6873533">.</span><span class="ident" id="6873534">Fatalf</span><span class="op" id="6873540">(</span><span class="string" id="6873541">&#34;DATA&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6873558">,</span>&nbsp;<span class="ident" id="6873560">err</span><span class="op" id="6873563">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873569">if</span>&nbsp;<span class="ident" id="6873572">_</span><span class="op" id="6873573">,</span>&nbsp;<span class="ident" id="6873575">err</span>&nbsp;<span class="op" id="6873579">:=</span>&nbsp;<span class="ident" id="6873582">w</span><span class="op" id="6873583">.</span><span class="ident" id="6873584">Write</span><span class="op" id="6873589">(</span><span class="op" id="6873590">[</span><span class="op" id="6873591">]</span><span class="builtintype" id="6873592">byte</span><span class="op" id="6873596">(</span><span class="ident" id="6873597">msg</span><span class="op" id="6873600">)</span><span class="op" id="6873601">)</span><span class="op" id="6873602">;</span>&nbsp;<span class="ident" id="6873604">err</span>&nbsp;<span class="op" id="6873608">!=</span>&nbsp;<span class="ident" id="6873611">nil</span>&nbsp;<span class="op" id="6873615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873619">t</span><span class="op" id="6873620">.</span><span class="ident" id="6873621">Fatalf</span><span class="op" id="6873627">(</span><span class="string" id="6873628">&#34;Data&nbsp;write&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6873651">,</span>&nbsp;<span class="ident" id="6873653">err</span><span class="op" id="6873656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873662">if</span>&nbsp;<span class="ident" id="6873665">err</span>&nbsp;<span class="op" id="6873669">:=</span>&nbsp;<span class="ident" id="6873672">w</span><span class="op" id="6873673">.</span><span class="ident" id="6873674">Close</span><span class="op" id="6873679">(</span><span class="op" id="6873680">)</span><span class="op" id="6873681">;</span>&nbsp;<span class="ident" id="6873683">err</span>&nbsp;<span class="op" id="6873687">!=</span>&nbsp;<span class="ident" id="6873690">nil</span>&nbsp;<span class="op" id="6873694">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873698">t</span><span class="op" id="6873699">.</span><span class="ident" id="6873700">Fatalf</span><span class="op" id="6873706">(</span><span class="string" id="6873707">&#34;Bad&nbsp;data&nbsp;response:&nbsp;%s&#34;</span><span class="op" id="6873730">,</span>&nbsp;<span class="ident" id="6873732">err</span><span class="op" id="6873735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873742">if</span>&nbsp;<span class="ident" id="6873745">err</span>&nbsp;<span class="op" id="6873749">:=</span>&nbsp;<span class="ident" id="6873752">c</span><span class="op" id="6873753">.</span><span class="ident" id="6873754">Quit</span><span class="op" id="6873758">(</span><span class="op" id="6873759">)</span><span class="op" id="6873760">;</span>&nbsp;<span class="ident" id="6873762">err</span>&nbsp;<span class="op" id="6873766">!=</span>&nbsp;<span class="ident" id="6873769">nil</span>&nbsp;<span class="op" id="6873773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873777">t</span><span class="op" id="6873778">.</span><span class="ident" id="6873779">Fatalf</span><span class="op" id="6873785">(</span><span class="string" id="6873786">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6873803">,</span>&nbsp;<span class="ident" id="6873805">err</span><span class="op" id="6873808">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873815">bcmdbuf</span><span class="op" id="6873822">.</span><span class="ident" id="6873823">Flush</span><span class="op" id="6873828">(</span><span class="op" id="6873829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873832">actualcmds</span>&nbsp;<span class="op" id="6873843">:=</span>&nbsp;<span class="ident" id="6873846">cmdbuf</span><span class="op" id="6873852">.</span><span class="ident" id="6873853">String</span><span class="op" id="6873859">(</span><span class="op" id="6873860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873863">if</span>&nbsp;<span class="ident" id="6873866">client</span>&nbsp;<span class="op" id="6873873">!=</span>&nbsp;<span class="ident" id="6873876">actualcmds</span>&nbsp;<span class="op" id="6873887">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873891">t</span><span class="op" id="6873892">.</span><span class="ident" id="6873893">Fatalf</span><span class="op" id="6873899">(</span><span class="string" id="6873900">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6873925">,</span>&nbsp;<span class="ident" id="6873927">actualcmds</span><span class="op" id="6873937">,</span>&nbsp;<span class="ident" id="6873939">client</span><span class="op" id="6873945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873948">}</span><br>
<span class="lineno"></span><span class="op" id="6873950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6873953">var</span>&nbsp;<span class="ident" id="6873957">basicServer</span>&nbsp;<span class="op" id="6873969">=</span>&nbsp;<span class="string" id="6873971">`250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno">190</span>502&nbsp;Unrecognized&nbsp;command.<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">195</span>530&nbsp;Authentication&nbsp;required<br>
<span class="lineno"></span>252&nbsp;Send&nbsp;some&nbsp;mail,&nbsp;I&#39;ll&nbsp;try&nbsp;my&nbsp;best<br>
<span class="lineno"></span>250&nbsp;User&nbsp;is&nbsp;valid<br>
<span class="lineno"></span>235&nbsp;Accepted<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;OK<br>
<span class="lineno">200</span>250&nbsp;Receiver&nbsp;OK<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;OK<br>
<span class="lineno"></span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="6874279">var</span>&nbsp;<span class="ident" id="6874283">basicClient</span>&nbsp;<span class="op" id="6874295">=</span>&nbsp;<span class="string" id="6874297">`HELO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno">210</span>VRFY&nbsp;user1@gmail.com<br>
<span class="lineno"></span>VRFY&nbsp;user2@gmail.com<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;golang-nuts@googlegroups.com&gt;<br>
<span class="lineno">215</span>DATA<br>
<span class="lineno"></span>From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno">220</span>Line&nbsp;1<br>
<span class="lineno"></span>..Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">225</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6874664">func</span>&nbsp;<span class="ident" id="6874669">TestNewClient</span><span class="op" id="6874682">(</span><span class="ident" id="6874683">t</span>&nbsp;<span class="op" id="6874685">*</span><span class="ident" id="6874686">testing</span><span class="op" id="6874693">.</span><span class="ident" id="6874694">T</span><span class="op" id="6874695">)</span>&nbsp;<span class="op" id="6874697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874700">server</span>&nbsp;<span class="op" id="6874707">:=</span>&nbsp;<span class="ident" id="6874710">strings</span><span class="op" id="6874717">.</span><span class="ident" id="6874718">Join</span><span class="op" id="6874722">(</span><span class="ident" id="6874723">strings</span><span class="op" id="6874730">.</span><span class="ident" id="6874731">Split</span><span class="op" id="6874736">(</span><span class="ident" id="6874737">newClientServer</span><span class="op" id="6874752">,</span>&nbsp;<span class="string" id="6874754">&#34;\n&#34;</span><span class="op" id="6874758">)</span><span class="op" id="6874759">,</span>&nbsp;<span class="string" id="6874761">&#34;\r\n&#34;</span><span class="op" id="6874767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874770">client</span>&nbsp;<span class="op" id="6874777">:=</span>&nbsp;<span class="ident" id="6874780">strings</span><span class="op" id="6874787">.</span><span class="ident" id="6874788">Join</span><span class="op" id="6874792">(</span><span class="ident" id="6874793">strings</span><span class="op" id="6874800">.</span><span class="ident" id="6874801">Split</span><span class="op" id="6874806">(</span><span class="ident" id="6874807">newClientClient</span><span class="op" id="6874822">,</span>&nbsp;<span class="string" id="6874824">&#34;\n&#34;</span><span class="op" id="6874828">)</span><span class="op" id="6874829">,</span>&nbsp;<span class="string" id="6874831">&#34;\r\n&#34;</span><span class="op" id="6874837">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874841">var</span>&nbsp;<span class="ident" id="6874845">cmdbuf</span>&nbsp;<span class="ident" id="6874852">bytes</span><span class="op" id="6874857">.</span><span class="ident" id="6874858">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874866">bcmdbuf</span>&nbsp;<span class="op" id="6874874">:=</span>&nbsp;<span class="ident" id="6874877">bufio</span><span class="op" id="6874882">.</span><span class="ident" id="6874883">NewWriter</span><span class="op" id="6874892">(</span><span class="op" id="6874893">&amp;</span><span class="ident" id="6874894">cmdbuf</span><span class="op" id="6874900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874903">out</span>&nbsp;<span class="op" id="6874907">:=</span>&nbsp;<span class="keyword" id="6874910">func</span><span class="op" id="6874914">(</span><span class="op" id="6874915">)</span>&nbsp;<span class="builtintype" id="6874917">string</span>&nbsp;<span class="op" id="6874924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874928">bcmdbuf</span><span class="op" id="6874935">.</span><span class="ident" id="6874936">Flush</span><span class="op" id="6874941">(</span><span class="op" id="6874942">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874946">return</span>&nbsp;<span class="ident" id="6874953">cmdbuf</span><span class="op" id="6874959">.</span><span class="ident" id="6874960">String</span><span class="op" id="6874966">(</span><span class="op" id="6874967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874973">var</span>&nbsp;<span class="ident" id="6874977">fake</span>&nbsp;<span class="ident" id="6874982">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874989">fake</span><span class="op" id="6874993">.</span><span class="ident" id="6874994">ReadWriter</span>&nbsp;<span class="op" id="6875005">=</span>&nbsp;<span class="ident" id="6875007">bufio</span><span class="op" id="6875012">.</span><span class="ident" id="6875013">NewReadWriter</span><span class="op" id="6875026">(</span><span class="ident" id="6875027">bufio</span><span class="op" id="6875032">.</span><span class="ident" id="6875033">NewReader</span><span class="op" id="6875042">(</span><span class="ident" id="6875043">strings</span><span class="op" id="6875050">.</span><span class="ident" id="6875051">NewReader</span><span class="op" id="6875060">(</span><span class="ident" id="6875061">server</span><span class="op" id="6875067">)</span><span class="op" id="6875068">)</span><span class="op" id="6875069">,</span>&nbsp;<span class="ident" id="6875071">bcmdbuf</span><span class="op" id="6875078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875081">c</span><span class="op" id="6875082">,</span>&nbsp;<span class="ident" id="6875084">err</span>&nbsp;<span class="op" id="6875088">:=</span>&nbsp;<span class="ident" id="6875091">NewClient</span><span class="op" id="6875100">(</span><span class="ident" id="6875101">fake</span><span class="op" id="6875105">,</span>&nbsp;<span class="string" id="6875107">&#34;fake.host&#34;</span><span class="op" id="6875118">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875121">if</span>&nbsp;<span class="ident" id="6875124">err</span>&nbsp;<span class="op" id="6875128">!=</span>&nbsp;<span class="ident" id="6875131">nil</span>&nbsp;<span class="op" id="6875135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875139">t</span><span class="op" id="6875140">.</span><span class="ident" id="6875141">Fatalf</span><span class="op" id="6875147">(</span><span class="string" id="6875148">&#34;NewClient:&nbsp;%v\n(after&nbsp;%v)&#34;</span><span class="op" id="6875175">,</span>&nbsp;<span class="ident" id="6875177">err</span><span class="op" id="6875180">,</span>&nbsp;<span class="ident" id="6875182">out</span><span class="op" id="6875185">(</span><span class="op" id="6875186">)</span><span class="op" id="6875187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875193">defer</span>&nbsp;<span class="ident" id="6875199">c</span><span class="op" id="6875200">.</span><span class="ident" id="6875201">Close</span><span class="op" id="6875206">(</span><span class="op" id="6875207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875210">if</span>&nbsp;<span class="ident" id="6875213">ok</span><span class="op" id="6875215">,</span>&nbsp;<span class="ident" id="6875217">args</span>&nbsp;<span class="op" id="6875222">:=</span>&nbsp;<span class="ident" id="6875225">c</span><span class="op" id="6875226">.</span><span class="ident" id="6875227">Extension</span><span class="op" id="6875236">(</span><span class="string" id="6875237">&#34;aUtH&#34;</span><span class="op" id="6875243">)</span><span class="op" id="6875244">;</span>&nbsp;<span class="op" id="6875246">!</span><span class="ident" id="6875247">ok</span>&nbsp;<span class="op" id="6875250">||</span>&nbsp;<span class="ident" id="6875253">args</span>&nbsp;<span class="op" id="6875258">!=</span>&nbsp;<span class="string" id="6875261">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="6875275">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875279">t</span><span class="op" id="6875280">.</span><span class="ident" id="6875281">Fatalf</span><span class="op" id="6875287">(</span><span class="string" id="6875288">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="6875313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875319">if</span>&nbsp;<span class="ident" id="6875322">ok</span><span class="op" id="6875324">,</span>&nbsp;<span class="ident" id="6875326">_</span>&nbsp;<span class="op" id="6875328">:=</span>&nbsp;<span class="ident" id="6875331">c</span><span class="op" id="6875332">.</span><span class="ident" id="6875333">Extension</span><span class="op" id="6875342">(</span><span class="string" id="6875343">&#34;DSN&#34;</span><span class="op" id="6875348">)</span><span class="op" id="6875349">;</span>&nbsp;<span class="ident" id="6875351">ok</span>&nbsp;<span class="op" id="6875354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875358">t</span><span class="op" id="6875359">.</span><span class="ident" id="6875360">Fatalf</span><span class="op" id="6875366">(</span><span class="string" id="6875367">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="6875390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875393">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875396">if</span>&nbsp;<span class="ident" id="6875399">err</span>&nbsp;<span class="op" id="6875403">:=</span>&nbsp;<span class="ident" id="6875406">c</span><span class="op" id="6875407">.</span><span class="ident" id="6875408">Quit</span><span class="op" id="6875412">(</span><span class="op" id="6875413">)</span><span class="op" id="6875414">;</span>&nbsp;<span class="ident" id="6875416">err</span>&nbsp;<span class="op" id="6875420">!=</span>&nbsp;<span class="ident" id="6875423">nil</span>&nbsp;<span class="op" id="6875427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875431">t</span><span class="op" id="6875432">.</span><span class="ident" id="6875433">Fatalf</span><span class="op" id="6875439">(</span><span class="string" id="6875440">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6875457">,</span>&nbsp;<span class="ident" id="6875459">err</span><span class="op" id="6875462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875469">actualcmds</span>&nbsp;<span class="op" id="6875480">:=</span>&nbsp;<span class="ident" id="6875483">out</span><span class="op" id="6875486">(</span><span class="op" id="6875487">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875490">if</span>&nbsp;<span class="ident" id="6875493">client</span>&nbsp;<span class="op" id="6875500">!=</span>&nbsp;<span class="ident" id="6875503">actualcmds</span>&nbsp;<span class="op" id="6875514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875518">t</span><span class="op" id="6875519">.</span><span class="ident" id="6875520">Fatalf</span><span class="op" id="6875526">(</span><span class="string" id="6875527">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6875552">,</span>&nbsp;<span class="ident" id="6875554">actualcmds</span><span class="op" id="6875564">,</span>&nbsp;<span class="ident" id="6875566">client</span><span class="op" id="6875572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875575">}</span><br>
<span class="lineno"></span><span class="op" id="6875577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="keyword" id="6875580">var</span>&nbsp;<span class="ident" id="6875584">newClientServer</span>&nbsp;<span class="op" id="6875600">=</span>&nbsp;<span class="string" id="6875602">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">265</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6875715">var</span>&nbsp;<span class="ident" id="6875719">newClientClient</span>&nbsp;<span class="op" id="6875735">=</span>&nbsp;<span class="string" id="6875737">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">270</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6875761">func</span>&nbsp;<span class="ident" id="6875766">TestNewClient2</span><span class="op" id="6875780">(</span><span class="ident" id="6875781">t</span>&nbsp;<span class="op" id="6875783">*</span><span class="ident" id="6875784">testing</span><span class="op" id="6875791">.</span><span class="ident" id="6875792">T</span><span class="op" id="6875793">)</span>&nbsp;<span class="op" id="6875795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875798">server</span>&nbsp;<span class="op" id="6875805">:=</span>&nbsp;<span class="ident" id="6875808">strings</span><span class="op" id="6875815">.</span><span class="ident" id="6875816">Join</span><span class="op" id="6875820">(</span><span class="ident" id="6875821">strings</span><span class="op" id="6875828">.</span><span class="ident" id="6875829">Split</span><span class="op" id="6875834">(</span><span class="ident" id="6875835">newClient2Server</span><span class="op" id="6875851">,</span>&nbsp;<span class="string" id="6875853">&#34;\n&#34;</span><span class="op" id="6875857">)</span><span class="op" id="6875858">,</span>&nbsp;<span class="string" id="6875860">&#34;\r\n&#34;</span><span class="op" id="6875866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875869">client</span>&nbsp;<span class="op" id="6875876">:=</span>&nbsp;<span class="ident" id="6875879">strings</span><span class="op" id="6875886">.</span><span class="ident" id="6875887">Join</span><span class="op" id="6875891">(</span><span class="ident" id="6875892">strings</span><span class="op" id="6875899">.</span><span class="ident" id="6875900">Split</span><span class="op" id="6875905">(</span><span class="ident" id="6875906">newClient2Client</span><span class="op" id="6875922">,</span>&nbsp;<span class="string" id="6875924">&#34;\n&#34;</span><span class="op" id="6875928">)</span><span class="op" id="6875929">,</span>&nbsp;<span class="string" id="6875931">&#34;\r\n&#34;</span><span class="op" id="6875937">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875941">var</span>&nbsp;<span class="ident" id="6875945">cmdbuf</span>&nbsp;<span class="ident" id="6875952">bytes</span><span class="op" id="6875957">.</span><span class="ident" id="6875958">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875966">bcmdbuf</span>&nbsp;<span class="op" id="6875974">:=</span>&nbsp;<span class="ident" id="6875977">bufio</span><span class="op" id="6875982">.</span><span class="ident" id="6875983">NewWriter</span><span class="op" id="6875992">(</span><span class="op" id="6875993">&amp;</span><span class="ident" id="6875994">cmdbuf</span><span class="op" id="6876000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876003">var</span>&nbsp;<span class="ident" id="6876007">fake</span>&nbsp;<span class="ident" id="6876012">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876019">fake</span><span class="op" id="6876023">.</span><span class="ident" id="6876024">ReadWriter</span>&nbsp;<span class="op" id="6876035">=</span>&nbsp;<span class="ident" id="6876037">bufio</span><span class="op" id="6876042">.</span><span class="ident" id="6876043">NewReadWriter</span><span class="op" id="6876056">(</span><span class="ident" id="6876057">bufio</span><span class="op" id="6876062">.</span><span class="ident" id="6876063">NewReader</span><span class="op" id="6876072">(</span><span class="ident" id="6876073">strings</span><span class="op" id="6876080">.</span><span class="ident" id="6876081">NewReader</span><span class="op" id="6876090">(</span><span class="ident" id="6876091">server</span><span class="op" id="6876097">)</span><span class="op" id="6876098">)</span><span class="op" id="6876099">,</span>&nbsp;<span class="ident" id="6876101">bcmdbuf</span><span class="op" id="6876108">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876111">c</span><span class="op" id="6876112">,</span>&nbsp;<span class="ident" id="6876114">err</span>&nbsp;<span class="op" id="6876118">:=</span>&nbsp;<span class="ident" id="6876121">NewClient</span><span class="op" id="6876130">(</span><span class="ident" id="6876131">fake</span><span class="op" id="6876135">,</span>&nbsp;<span class="string" id="6876137">&#34;fake.host&#34;</span><span class="op" id="6876148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876151">if</span>&nbsp;<span class="ident" id="6876154">err</span>&nbsp;<span class="op" id="6876158">!=</span>&nbsp;<span class="ident" id="6876161">nil</span>&nbsp;<span class="op" id="6876165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876169">t</span><span class="op" id="6876170">.</span><span class="ident" id="6876171">Fatalf</span><span class="op" id="6876177">(</span><span class="string" id="6876178">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="6876193">,</span>&nbsp;<span class="ident" id="6876195">err</span><span class="op" id="6876198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876204">defer</span>&nbsp;<span class="ident" id="6876210">c</span><span class="op" id="6876211">.</span><span class="ident" id="6876212">Close</span><span class="op" id="6876217">(</span><span class="op" id="6876218">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876221">if</span>&nbsp;<span class="ident" id="6876224">ok</span><span class="op" id="6876226">,</span>&nbsp;<span class="ident" id="6876228">_</span>&nbsp;<span class="op" id="6876230">:=</span>&nbsp;<span class="ident" id="6876233">c</span><span class="op" id="6876234">.</span><span class="ident" id="6876235">Extension</span><span class="op" id="6876244">(</span><span class="string" id="6876245">&#34;DSN&#34;</span><span class="op" id="6876250">)</span><span class="op" id="6876251">;</span>&nbsp;<span class="ident" id="6876253">ok</span>&nbsp;<span class="op" id="6876256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876260">t</span><span class="op" id="6876261">.</span><span class="ident" id="6876262">Fatalf</span><span class="op" id="6876268">(</span><span class="string" id="6876269">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="6876292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876298">if</span>&nbsp;<span class="ident" id="6876301">err</span>&nbsp;<span class="op" id="6876305">:=</span>&nbsp;<span class="ident" id="6876308">c</span><span class="op" id="6876309">.</span><span class="ident" id="6876310">Quit</span><span class="op" id="6876314">(</span><span class="op" id="6876315">)</span><span class="op" id="6876316">;</span>&nbsp;<span class="ident" id="6876318">err</span>&nbsp;<span class="op" id="6876322">!=</span>&nbsp;<span class="ident" id="6876325">nil</span>&nbsp;<span class="op" id="6876329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876333">t</span><span class="op" id="6876334">.</span><span class="ident" id="6876335">Fatalf</span><span class="op" id="6876341">(</span><span class="string" id="6876342">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6876359">,</span>&nbsp;<span class="ident" id="6876361">err</span><span class="op" id="6876364">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876371">bcmdbuf</span><span class="op" id="6876378">.</span><span class="ident" id="6876379">Flush</span><span class="op" id="6876384">(</span><span class="op" id="6876385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876388">actualcmds</span>&nbsp;<span class="op" id="6876399">:=</span>&nbsp;<span class="ident" id="6876402">cmdbuf</span><span class="op" id="6876408">.</span><span class="ident" id="6876409">String</span><span class="op" id="6876415">(</span><span class="op" id="6876416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876419">if</span>&nbsp;<span class="ident" id="6876422">client</span>&nbsp;<span class="op" id="6876429">!=</span>&nbsp;<span class="ident" id="6876432">actualcmds</span>&nbsp;<span class="op" id="6876443">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876447">t</span><span class="op" id="6876448">.</span><span class="ident" id="6876449">Fatalf</span><span class="op" id="6876455">(</span><span class="string" id="6876456">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6876481">,</span>&nbsp;<span class="ident" id="6876483">actualcmds</span><span class="op" id="6876493">,</span>&nbsp;<span class="ident" id="6876495">client</span><span class="op" id="6876501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876504">}</span><br>
<span class="lineno"></span><span class="op" id="6876506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6876509">var</span>&nbsp;<span class="ident" id="6876513">newClient2Server</span>&nbsp;<span class="op" id="6876530">=</span>&nbsp;<span class="string" id="6876532">`220&nbsp;hello&nbsp;world<br>
<span class="lineno">300</span>502&nbsp;EH?<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">305</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6876653">var</span>&nbsp;<span class="ident" id="6876657">newClient2Client</span>&nbsp;<span class="op" id="6876674">=</span>&nbsp;<span class="string" id="6876676">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno">310</span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6876715">func</span>&nbsp;<span class="ident" id="6876720">TestHello</span><span class="op" id="6876729">(</span><span class="ident" id="6876730">t</span>&nbsp;<span class="op" id="6876732">*</span><span class="ident" id="6876733">testing</span><span class="op" id="6876740">.</span><span class="ident" id="6876741">T</span><span class="op" id="6876742">)</span>&nbsp;<span class="op" id="6876744">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876748">if</span>&nbsp;<span class="builtinfunc" id="6876751">len</span><span class="op" id="6876754">(</span><span class="ident" id="6876755">helloServer</span><span class="op" id="6876766">)</span>&nbsp;<span class="op" id="6876768">!=</span>&nbsp;<span class="builtinfunc" id="6876771">len</span><span class="op" id="6876774">(</span><span class="ident" id="6876775">helloClient</span><span class="op" id="6876786">)</span>&nbsp;<span class="op" id="6876788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876792">t</span><span class="op" id="6876793">.</span><span class="ident" id="6876794">Fatalf</span><span class="op" id="6876800">(</span><span class="string" id="6876801">&#34;Hello&nbsp;server&nbsp;and&nbsp;client&nbsp;size&nbsp;mismatch&#34;</span><span class="op" id="6876840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876847">for</span>&nbsp;<span class="ident" id="6876851">i</span>&nbsp;<span class="op" id="6876853">:=</span>&nbsp;<span class="num" id="6876856">0</span><span class="op" id="6876857">;</span>&nbsp;<span class="ident" id="6876859">i</span>&nbsp;<span class="op" id="6876861">&lt;</span>&nbsp;<span class="builtinfunc" id="6876863">len</span><span class="op" id="6876866">(</span><span class="ident" id="6876867">helloServer</span><span class="op" id="6876878">)</span><span class="op" id="6876879">;</span>&nbsp;<span class="ident" id="6876881">i</span><span class="op" id="6876882">++</span>&nbsp;<span class="op" id="6876885">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876889">server</span>&nbsp;<span class="op" id="6876896">:=</span>&nbsp;<span class="ident" id="6876899">strings</span><span class="op" id="6876906">.</span><span class="ident" id="6876907">Join</span><span class="op" id="6876911">(</span><span class="ident" id="6876912">strings</span><span class="op" id="6876919">.</span><span class="ident" id="6876920">Split</span><span class="op" id="6876925">(</span><span class="ident" id="6876926">baseHelloServer</span><span class="op" id="6876941">+</span><span class="ident" id="6876942">helloServer</span><span class="op" id="6876953">[</span><span class="ident" id="6876954">i</span><span class="op" id="6876955">]</span><span class="op" id="6876956">,</span>&nbsp;<span class="string" id="6876958">&#34;\n&#34;</span><span class="op" id="6876962">)</span><span class="op" id="6876963">,</span>&nbsp;<span class="string" id="6876965">&#34;\r\n&#34;</span><span class="op" id="6876971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876975">client</span>&nbsp;<span class="op" id="6876982">:=</span>&nbsp;<span class="ident" id="6876985">strings</span><span class="op" id="6876992">.</span><span class="ident" id="6876993">Join</span><span class="op" id="6876997">(</span><span class="ident" id="6876998">strings</span><span class="op" id="6877005">.</span><span class="ident" id="6877006">Split</span><span class="op" id="6877011">(</span><span class="ident" id="6877012">baseHelloClient</span><span class="op" id="6877027">+</span><span class="ident" id="6877028">helloClient</span><span class="op" id="6877039">[</span><span class="ident" id="6877040">i</span><span class="op" id="6877041">]</span><span class="op" id="6877042">,</span>&nbsp;<span class="string" id="6877044">&#34;\n&#34;</span><span class="op" id="6877048">)</span><span class="op" id="6877049">,</span>&nbsp;<span class="string" id="6877051">&#34;\r\n&#34;</span><span class="op" id="6877057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877061">var</span>&nbsp;<span class="ident" id="6877065">cmdbuf</span>&nbsp;<span class="ident" id="6877072">bytes</span><span class="op" id="6877077">.</span><span class="ident" id="6877078">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877087">bcmdbuf</span>&nbsp;<span class="op" id="6877095">:=</span>&nbsp;<span class="ident" id="6877098">bufio</span><span class="op" id="6877103">.</span><span class="ident" id="6877104">NewWriter</span><span class="op" id="6877113">(</span><span class="op" id="6877114">&amp;</span><span class="ident" id="6877115">cmdbuf</span><span class="op" id="6877121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877125">var</span>&nbsp;<span class="ident" id="6877129">fake</span>&nbsp;<span class="ident" id="6877134">faker</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877142">fake</span><span class="op" id="6877146">.</span><span class="ident" id="6877147">ReadWriter</span>&nbsp;<span class="op" id="6877158">=</span>&nbsp;<span class="ident" id="6877160">bufio</span><span class="op" id="6877165">.</span><span class="ident" id="6877166">NewReadWriter</span><span class="op" id="6877179">(</span><span class="ident" id="6877180">bufio</span><span class="op" id="6877185">.</span><span class="ident" id="6877186">NewReader</span><span class="op" id="6877195">(</span><span class="ident" id="6877196">strings</span><span class="op" id="6877203">.</span><span class="ident" id="6877204">NewReader</span><span class="op" id="6877213">(</span><span class="ident" id="6877214">server</span><span class="op" id="6877220">)</span><span class="op" id="6877221">)</span><span class="op" id="6877222">,</span>&nbsp;<span class="ident" id="6877224">bcmdbuf</span><span class="op" id="6877231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877235">c</span><span class="op" id="6877236">,</span>&nbsp;<span class="ident" id="6877238">err</span>&nbsp;<span class="op" id="6877242">:=</span>&nbsp;<span class="ident" id="6877245">NewClient</span><span class="op" id="6877254">(</span><span class="ident" id="6877255">fake</span><span class="op" id="6877259">,</span>&nbsp;<span class="string" id="6877261">&#34;fake.host&#34;</span><span class="op" id="6877272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877276">if</span>&nbsp;<span class="ident" id="6877279">err</span>&nbsp;<span class="op" id="6877283">!=</span>&nbsp;<span class="ident" id="6877286">nil</span>&nbsp;<span class="op" id="6877290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877295">t</span><span class="op" id="6877296">.</span><span class="ident" id="6877297">Fatalf</span><span class="op" id="6877303">(</span><span class="string" id="6877304">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="6877319">,</span>&nbsp;<span class="ident" id="6877321">err</span><span class="op" id="6877324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877328">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877332">defer</span>&nbsp;<span class="ident" id="6877338">c</span><span class="op" id="6877339">.</span><span class="ident" id="6877340">Close</span><span class="op" id="6877345">(</span><span class="op" id="6877346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877350">c</span><span class="op" id="6877351">.</span><span class="ident" id="6877352">localName</span>&nbsp;<span class="op" id="6877362">=</span>&nbsp;<span class="string" id="6877364">&#34;customhost&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877379">err</span>&nbsp;<span class="op" id="6877383">=</span>&nbsp;<span class="ident" id="6877385">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877392">switch</span>&nbsp;<span class="ident" id="6877399">i</span>&nbsp;<span class="op" id="6877401">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877405">case</span>&nbsp;<span class="num" id="6877410">0</span><span class="op" id="6877411">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877416">err</span>&nbsp;<span class="op" id="6877420">=</span>&nbsp;<span class="ident" id="6877422">c</span><span class="op" id="6877423">.</span><span class="ident" id="6877424">Hello</span><span class="op" id="6877429">(</span><span class="string" id="6877430">&#34;customhost&#34;</span><span class="op" id="6877442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877446">case</span>&nbsp;<span class="num" id="6877451">1</span><span class="op" id="6877452">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877457">err</span>&nbsp;<span class="op" id="6877461">=</span>&nbsp;<span class="ident" id="6877463">c</span><span class="op" id="6877464">.</span><span class="ident" id="6877465">StartTLS</span><span class="op" id="6877473">(</span><span class="ident" id="6877474">nil</span><span class="op" id="6877477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877482">if</span>&nbsp;<span class="ident" id="6877485">err</span><span class="op" id="6877488">.</span><span class="ident" id="6877489">Error</span><span class="op" id="6877494">(</span><span class="op" id="6877495">)</span>&nbsp;<span class="op" id="6877497">==</span>&nbsp;<span class="string" id="6877500">&#34;502&nbsp;Not&nbsp;implemented&#34;</span>&nbsp;<span class="op" id="6877522">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877528">err</span>&nbsp;<span class="op" id="6877532">=</span>&nbsp;<span class="ident" id="6877534">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877545">case</span>&nbsp;<span class="num" id="6877550">2</span><span class="op" id="6877551">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877556">err</span>&nbsp;<span class="op" id="6877560">=</span>&nbsp;<span class="ident" id="6877562">c</span><span class="op" id="6877563">.</span><span class="ident" id="6877564">Verify</span><span class="op" id="6877570">(</span><span class="string" id="6877571">&#34;test@example.com&#34;</span><span class="op" id="6877589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877593">case</span>&nbsp;<span class="num" id="6877598">3</span><span class="op" id="6877599">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877604">c</span><span class="op" id="6877605">.</span><span class="ident" id="6877606">tls</span>&nbsp;<span class="op" id="6877610">=</span>&nbsp;<span class="builtintype" id="6877612">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877620">c</span><span class="op" id="6877621">.</span><span class="ident" id="6877622">serverName</span>&nbsp;<span class="op" id="6877633">=</span>&nbsp;<span class="string" id="6877635">&#34;smtp.google.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877656">err</span>&nbsp;<span class="op" id="6877660">=</span>&nbsp;<span class="ident" id="6877662">c</span><span class="op" id="6877663">.</span><span class="ident" id="6877664">Auth</span><span class="op" id="6877668">(</span><span class="ident" id="6877669">PlainAuth</span><span class="op" id="6877678">(</span><span class="string" id="6877679">&#34;&#34;</span><span class="op" id="6877681">,</span>&nbsp;<span class="string" id="6877683">&#34;user&#34;</span><span class="op" id="6877689">,</span>&nbsp;<span class="string" id="6877691">&#34;pass&#34;</span><span class="op" id="6877697">,</span>&nbsp;<span class="string" id="6877699">&#34;smtp.google.com&#34;</span><span class="op" id="6877716">)</span><span class="op" id="6877717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877721">case</span>&nbsp;<span class="num" id="6877726">4</span><span class="op" id="6877727">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877732">err</span>&nbsp;<span class="op" id="6877736">=</span>&nbsp;<span class="ident" id="6877738">c</span><span class="op" id="6877739">.</span><span class="ident" id="6877740">Mail</span><span class="op" id="6877744">(</span><span class="string" id="6877745">&#34;test@example.com&#34;</span><span class="op" id="6877763">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877767">case</span>&nbsp;<span class="num" id="6877772">5</span><span class="op" id="6877773">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877778">ok</span><span class="op" id="6877780">,</span>&nbsp;<span class="ident" id="6877782">_</span>&nbsp;<span class="op" id="6877784">:=</span>&nbsp;<span class="ident" id="6877787">c</span><span class="op" id="6877788">.</span><span class="ident" id="6877789">Extension</span><span class="op" id="6877798">(</span><span class="string" id="6877799">&#34;feature&#34;</span><span class="op" id="6877808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877813">if</span>&nbsp;<span class="ident" id="6877816">ok</span>&nbsp;<span class="op" id="6877819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877825">t</span><span class="op" id="6877826">.</span><span class="ident" id="6877827">Errorf</span><span class="op" id="6877833">(</span><span class="string" id="6877834">&#34;Expected&nbsp;FEATURE&nbsp;not&nbsp;to&nbsp;be&nbsp;supported&#34;</span><span class="op" id="6877872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877877">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877881">case</span>&nbsp;<span class="num" id="6877886">6</span><span class="op" id="6877887">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877892">err</span>&nbsp;<span class="op" id="6877896">=</span>&nbsp;<span class="ident" id="6877898">c</span><span class="op" id="6877899">.</span><span class="ident" id="6877900">Reset</span><span class="op" id="6877905">(</span><span class="op" id="6877906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877910">case</span>&nbsp;<span class="num" id="6877915">7</span><span class="op" id="6877916">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877921">err</span>&nbsp;<span class="op" id="6877925">=</span>&nbsp;<span class="ident" id="6877927">c</span><span class="op" id="6877928">.</span><span class="ident" id="6877929">Quit</span><span class="op" id="6877933">(</span><span class="op" id="6877934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877938">case</span>&nbsp;<span class="num" id="6877943">8</span><span class="op" id="6877944">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877949">err</span>&nbsp;<span class="op" id="6877953">=</span>&nbsp;<span class="ident" id="6877955">c</span><span class="op" id="6877956">.</span><span class="ident" id="6877957">Verify</span><span class="op" id="6877963">(</span><span class="string" id="6877964">&#34;test@example.com&#34;</span><span class="op" id="6877982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877987">if</span>&nbsp;<span class="ident" id="6877990">err</span>&nbsp;<span class="op" id="6877994">!=</span>&nbsp;<span class="ident" id="6877997">nil</span>&nbsp;<span class="op" id="6878001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878007">err</span>&nbsp;<span class="op" id="6878011">=</span>&nbsp;<span class="ident" id="6878013">c</span><span class="op" id="6878014">.</span><span class="ident" id="6878015">Hello</span><span class="op" id="6878020">(</span><span class="string" id="6878021">&#34;customhost&#34;</span><span class="op" id="6878033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878039">if</span>&nbsp;<span class="ident" id="6878042">err</span>&nbsp;<span class="op" id="6878046">!=</span>&nbsp;<span class="ident" id="6878049">nil</span>&nbsp;<span class="op" id="6878053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878060">t</span><span class="op" id="6878061">.</span><span class="ident" id="6878062">Errorf</span><span class="op" id="6878068">(</span><span class="string" id="6878069">&#34;Want&nbsp;error,&nbsp;got&nbsp;none&#34;</span><span class="op" id="6878091">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878106">default</span><span class="op" id="6878113">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878118">t</span><span class="op" id="6878119">.</span><span class="ident" id="6878120">Fatalf</span><span class="op" id="6878126">(</span><span class="string" id="6878127">&#34;Unhandled&nbsp;command&#34;</span><span class="op" id="6878146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878150">}</span><br>
<span class="lineno">370</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878155">if</span>&nbsp;<span class="ident" id="6878158">err</span>&nbsp;<span class="op" id="6878162">!=</span>&nbsp;<span class="ident" id="6878165">nil</span>&nbsp;<span class="op" id="6878169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878174">t</span><span class="op" id="6878175">.</span><span class="ident" id="6878176">Errorf</span><span class="op" id="6878182">(</span><span class="string" id="6878183">&#34;Command&nbsp;%d&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6878206">,</span>&nbsp;<span class="ident" id="6878208">i</span><span class="op" id="6878209">,</span>&nbsp;<span class="ident" id="6878211">err</span><span class="op" id="6878214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878223">bcmdbuf</span><span class="op" id="6878230">.</span><span class="ident" id="6878231">Flush</span><span class="op" id="6878236">(</span><span class="op" id="6878237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878241">actualcmds</span>&nbsp;<span class="op" id="6878252">:=</span>&nbsp;<span class="ident" id="6878255">cmdbuf</span><span class="op" id="6878261">.</span><span class="ident" id="6878262">String</span><span class="op" id="6878268">(</span><span class="op" id="6878269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878273">if</span>&nbsp;<span class="ident" id="6878276">client</span>&nbsp;<span class="op" id="6878283">!=</span>&nbsp;<span class="ident" id="6878286">actualcmds</span>&nbsp;<span class="op" id="6878297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878302">t</span><span class="op" id="6878303">.</span><span class="ident" id="6878304">Errorf</span><span class="op" id="6878310">(</span><span class="string" id="6878311">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6878336">,</span>&nbsp;<span class="ident" id="6878338">actualcmds</span><span class="op" id="6878348">,</span>&nbsp;<span class="ident" id="6878350">client</span><span class="op" id="6878356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878360">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878363">}</span><br>
<span class="lineno"></span><span class="op" id="6878365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6878368">var</span>&nbsp;<span class="ident" id="6878372">baseHelloServer</span>&nbsp;<span class="op" id="6878388">=</span>&nbsp;<span class="string" id="6878390">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno">385</span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;FEATURE<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6878464">var</span>&nbsp;<span class="ident" id="6878468">helloServer</span>&nbsp;<span class="op" id="6878480">=</span>&nbsp;<span class="op" id="6878482">[</span><span class="op" id="6878483">]</span><span class="builtintype" id="6878484">string</span><span class="op" id="6878490">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878493">&#34;&#34;</span><span class="op" id="6878495">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878498">&#34;502&nbsp;Not&nbsp;implemented\n&#34;</span><span class="op" id="6878521">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878524">&#34;250&nbsp;User&nbsp;is&nbsp;valid\n&#34;</span><span class="op" id="6878545">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878548">&#34;235&nbsp;Accepted\n&#34;</span><span class="op" id="6878564">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878567">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="6878584">,</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878587">&#34;&#34;</span><span class="op" id="6878589">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878592">&#34;250&nbsp;Reset&nbsp;ok\n&#34;</span><span class="op" id="6878608">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878611">&#34;221&nbsp;Goodbye\n&#34;</span><span class="op" id="6878626">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878629">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="6878646">,</span><br>
<span class="lineno"></span><span class="op" id="6878648">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="6878651">var</span>&nbsp;<span class="ident" id="6878655">baseHelloClient</span>&nbsp;<span class="op" id="6878671">=</span>&nbsp;<span class="string" id="6878673">`EHLO&nbsp;customhost<br>
<span class="lineno"></span>HELO&nbsp;customhost<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="6878709">var</span>&nbsp;<span class="ident" id="6878713">helloClient</span>&nbsp;<span class="op" id="6878725">=</span>&nbsp;<span class="op" id="6878727">[</span><span class="op" id="6878728">]</span><span class="builtintype" id="6878729">string</span><span class="op" id="6878735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878738">&#34;&#34;</span><span class="op" id="6878740">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878743">&#34;STARTTLS\n&#34;</span><span class="op" id="6878755">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878758">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="6878783">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878786">&#34;AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==\n&#34;</span><span class="op" id="6878817">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878820">&#34;MAIL&nbsp;FROM:&lt;test@example.com&gt;\n&#34;</span><span class="op" id="6878852">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878855">&#34;&#34;</span><span class="op" id="6878857">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878860">&#34;RSET\n&#34;</span><span class="op" id="6878868">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878871">&#34;QUIT\n&#34;</span><span class="op" id="6878879">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6878882">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="6878907">,</span><br>
<span class="lineno">415</span><span class="op" id="6878909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6878912">func</span>&nbsp;<span class="ident" id="6878917">TestSendMail</span><span class="op" id="6878929">(</span><span class="ident" id="6878930">t</span>&nbsp;<span class="op" id="6878932">*</span><span class="ident" id="6878933">testing</span><span class="op" id="6878940">.</span><span class="ident" id="6878941">T</span><span class="op" id="6878942">)</span>&nbsp;<span class="op" id="6878944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878947">server</span>&nbsp;<span class="op" id="6878954">:=</span>&nbsp;<span class="ident" id="6878957">strings</span><span class="op" id="6878964">.</span><span class="ident" id="6878965">Join</span><span class="op" id="6878969">(</span><span class="ident" id="6878970">strings</span><span class="op" id="6878977">.</span><span class="ident" id="6878978">Split</span><span class="op" id="6878983">(</span><span class="ident" id="6878984">sendMailServer</span><span class="op" id="6878998">,</span>&nbsp;<span class="string" id="6879000">&#34;\n&#34;</span><span class="op" id="6879004">)</span><span class="op" id="6879005">,</span>&nbsp;<span class="string" id="6879007">&#34;\r\n&#34;</span><span class="op" id="6879013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879016">client</span>&nbsp;<span class="op" id="6879023">:=</span>&nbsp;<span class="ident" id="6879026">strings</span><span class="op" id="6879033">.</span><span class="ident" id="6879034">Join</span><span class="op" id="6879038">(</span><span class="ident" id="6879039">strings</span><span class="op" id="6879046">.</span><span class="ident" id="6879047">Split</span><span class="op" id="6879052">(</span><span class="ident" id="6879053">sendMailClient</span><span class="op" id="6879067">,</span>&nbsp;<span class="string" id="6879069">&#34;\n&#34;</span><span class="op" id="6879073">)</span><span class="op" id="6879074">,</span>&nbsp;<span class="string" id="6879076">&#34;\r\n&#34;</span><span class="op" id="6879082">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879085">var</span>&nbsp;<span class="ident" id="6879089">cmdbuf</span>&nbsp;<span class="ident" id="6879096">bytes</span><span class="op" id="6879101">.</span><span class="ident" id="6879102">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879110">bcmdbuf</span>&nbsp;<span class="op" id="6879118">:=</span>&nbsp;<span class="ident" id="6879121">bufio</span><span class="op" id="6879126">.</span><span class="ident" id="6879127">NewWriter</span><span class="op" id="6879136">(</span><span class="op" id="6879137">&amp;</span><span class="ident" id="6879138">cmdbuf</span><span class="op" id="6879144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879147">l</span><span class="op" id="6879148">,</span>&nbsp;<span class="ident" id="6879150">err</span>&nbsp;<span class="op" id="6879154">:=</span>&nbsp;<span class="ident" id="6879157">net</span><span class="op" id="6879160">.</span><span class="ident" id="6879161">Listen</span><span class="op" id="6879167">(</span><span class="string" id="6879168">&#34;tcp&#34;</span><span class="op" id="6879173">,</span>&nbsp;<span class="string" id="6879175">&#34;127.0.0.1:0&#34;</span><span class="op" id="6879188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879191">if</span>&nbsp;<span class="ident" id="6879194">err</span>&nbsp;<span class="op" id="6879198">!=</span>&nbsp;<span class="ident" id="6879201">nil</span>&nbsp;<span class="op" id="6879205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879209">t</span><span class="op" id="6879210">.</span><span class="ident" id="6879211">Fatalf</span><span class="op" id="6879217">(</span><span class="string" id="6879218">&#34;Unable&nbsp;to&nbsp;to&nbsp;create&nbsp;listener:&nbsp;%v&#34;</span><span class="op" id="6879252">,</span>&nbsp;<span class="ident" id="6879254">err</span><span class="op" id="6879257">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879263">defer</span>&nbsp;<span class="ident" id="6879269">l</span><span class="op" id="6879270">.</span><span class="ident" id="6879271">Close</span><span class="op" id="6879276">(</span><span class="op" id="6879277">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6879281">//&nbsp;prevent&nbsp;data&nbsp;race&nbsp;on&nbsp;bcmdbuf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879314">var</span>&nbsp;<span class="ident" id="6879318">done</span>&nbsp;<span class="op" id="6879323">=</span>&nbsp;<span class="builtinfunc" id="6879325">make</span><span class="op" id="6879329">(</span><span class="keyword" id="6879330">chan</span>&nbsp;<span class="keyword" id="6879335">struct</span><span class="op" id="6879341">{</span><span class="op" id="6879342">}</span><span class="op" id="6879343">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879346">go</span>&nbsp;<span class="keyword" id="6879349">func</span><span class="op" id="6879353">(</span><span class="ident" id="6879354">data</span>&nbsp;<span class="op" id="6879359">[</span><span class="op" id="6879360">]</span><span class="builtintype" id="6879361">string</span><span class="op" id="6879367">)</span>&nbsp;<span class="op" id="6879369">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879374">defer</span>&nbsp;<span class="builtinfunc" id="6879380">close</span><span class="op" id="6879385">(</span><span class="ident" id="6879386">done</span><span class="op" id="6879390">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879395">conn</span><span class="op" id="6879399">,</span>&nbsp;<span class="ident" id="6879401">err</span>&nbsp;<span class="op" id="6879405">:=</span>&nbsp;<span class="ident" id="6879408">l</span><span class="op" id="6879409">.</span><span class="ident" id="6879410">Accept</span><span class="op" id="6879416">(</span><span class="op" id="6879417">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879421">if</span>&nbsp;<span class="ident" id="6879424">err</span>&nbsp;<span class="op" id="6879428">!=</span>&nbsp;<span class="ident" id="6879431">nil</span>&nbsp;<span class="op" id="6879435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879440">t</span><span class="op" id="6879441">.</span><span class="ident" id="6879442">Errorf</span><span class="op" id="6879448">(</span><span class="string" id="6879449">&#34;Accept&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6879467">,</span>&nbsp;<span class="ident" id="6879469">err</span><span class="op" id="6879472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879477">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879490">defer</span>&nbsp;<span class="ident" id="6879496">conn</span><span class="op" id="6879500">.</span><span class="ident" id="6879501">Close</span><span class="op" id="6879506">(</span><span class="op" id="6879507">)</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879512">tc</span>&nbsp;<span class="op" id="6879515">:=</span>&nbsp;<span class="ident" id="6879518">textproto</span><span class="op" id="6879527">.</span><span class="ident" id="6879528">NewConn</span><span class="op" id="6879535">(</span><span class="ident" id="6879536">conn</span><span class="op" id="6879540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879544">for</span>&nbsp;<span class="ident" id="6879548">i</span>&nbsp;<span class="op" id="6879550">:=</span>&nbsp;<span class="num" id="6879553">0</span><span class="op" id="6879554">;</span>&nbsp;<span class="ident" id="6879556">i</span>&nbsp;<span class="op" id="6879558">&lt;</span>&nbsp;<span class="builtinfunc" id="6879560">len</span><span class="op" id="6879563">(</span><span class="ident" id="6879564">data</span><span class="op" id="6879568">)</span>&nbsp;<span class="op" id="6879570">&amp;&amp;</span>&nbsp;<span class="ident" id="6879573">data</span><span class="op" id="6879577">[</span><span class="ident" id="6879578">i</span><span class="op" id="6879579">]</span>&nbsp;<span class="op" id="6879581">!=</span>&nbsp;<span class="string" id="6879584">&#34;&#34;</span><span class="op" id="6879586">;</span>&nbsp;<span class="ident" id="6879588">i</span><span class="op" id="6879589">++</span>&nbsp;<span class="op" id="6879592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879597">tc</span><span class="op" id="6879599">.</span><span class="ident" id="6879600">PrintfLine</span><span class="op" id="6879610">(</span><span class="ident" id="6879611">data</span><span class="op" id="6879615">[</span><span class="ident" id="6879616">i</span><span class="op" id="6879617">]</span><span class="op" id="6879618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879623">for</span>&nbsp;<span class="builtinfunc" id="6879627">len</span><span class="op" id="6879630">(</span><span class="ident" id="6879631">data</span><span class="op" id="6879635">[</span><span class="ident" id="6879636">i</span><span class="op" id="6879637">]</span><span class="op" id="6879638">)</span>&nbsp;<span class="op" id="6879640">&gt;=</span>&nbsp;<span class="num" id="6879643">4</span>&nbsp;<span class="op" id="6879645">&amp;&amp;</span>&nbsp;<span class="ident" id="6879648">data</span><span class="op" id="6879652">[</span><span class="ident" id="6879653">i</span><span class="op" id="6879654">]</span><span class="op" id="6879655">[</span><span class="num" id="6879656">3</span><span class="op" id="6879657">]</span>&nbsp;<span class="op" id="6879659">==</span>&nbsp;<span class="string" id="6879662">&#39;-&#39;</span>&nbsp;<span class="op" id="6879666">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879672">i</span><span class="op" id="6879673">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879680">tc</span><span class="op" id="6879682">.</span><span class="ident" id="6879683">PrintfLine</span><span class="op" id="6879693">(</span><span class="ident" id="6879694">data</span><span class="op" id="6879698">[</span><span class="ident" id="6879699">i</span><span class="op" id="6879700">]</span><span class="op" id="6879701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879711">if</span>&nbsp;<span class="ident" id="6879714">data</span><span class="op" id="6879718">[</span><span class="ident" id="6879719">i</span><span class="op" id="6879720">]</span>&nbsp;<span class="op" id="6879722">==</span>&nbsp;<span class="string" id="6879725">&#34;221&nbsp;Goodbye&#34;</span>&nbsp;<span class="op" id="6879739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879745">return</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879760">read</span>&nbsp;<span class="op" id="6879765">:=</span>&nbsp;<span class="builtintype" id="6879768">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879777">for</span>&nbsp;<span class="op" id="6879781">!</span><span class="ident" id="6879782">read</span>&nbsp;<span class="op" id="6879787">||</span>&nbsp;<span class="ident" id="6879790">data</span><span class="op" id="6879794">[</span><span class="ident" id="6879795">i</span><span class="op" id="6879796">]</span>&nbsp;<span class="op" id="6879798">==</span>&nbsp;<span class="string" id="6879801">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="6879816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879822">msg</span><span class="op" id="6879825">,</span>&nbsp;<span class="ident" id="6879827">err</span>&nbsp;<span class="op" id="6879831">:=</span>&nbsp;<span class="ident" id="6879834">tc</span><span class="op" id="6879836">.</span><span class="ident" id="6879837">ReadLine</span><span class="op" id="6879845">(</span><span class="op" id="6879846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879852">bcmdbuf</span><span class="op" id="6879859">.</span><span class="ident" id="6879860">Write</span><span class="op" id="6879865">(</span><span class="op" id="6879866">[</span><span class="op" id="6879867">]</span><span class="builtintype" id="6879868">byte</span><span class="op" id="6879872">(</span><span class="ident" id="6879873">msg</span>&nbsp;<span class="op" id="6879877">+</span>&nbsp;<span class="string" id="6879879">&#34;\r\n&#34;</span><span class="op" id="6879885">)</span><span class="op" id="6879886">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879892">read</span>&nbsp;<span class="op" id="6879897">=</span>&nbsp;<span class="builtintype" id="6879899">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879908">if</span>&nbsp;<span class="ident" id="6879911">err</span>&nbsp;<span class="op" id="6879915">!=</span>&nbsp;<span class="ident" id="6879918">nil</span>&nbsp;<span class="op" id="6879922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879929">t</span><span class="op" id="6879930">.</span><span class="ident" id="6879931">Errorf</span><span class="op" id="6879937">(</span><span class="string" id="6879938">&#34;Read&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6879954">,</span>&nbsp;<span class="ident" id="6879956">err</span><span class="op" id="6879959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879966">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879977">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879983">if</span>&nbsp;<span class="ident" id="6879986">data</span><span class="op" id="6879990">[</span><span class="ident" id="6879991">i</span><span class="op" id="6879992">]</span>&nbsp;<span class="op" id="6879994">==</span>&nbsp;<span class="string" id="6879997">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="6880012">&amp;&amp;</span>&nbsp;<span class="ident" id="6880015">msg</span>&nbsp;<span class="op" id="6880019">==</span>&nbsp;<span class="string" id="6880022">&#34;.&#34;</span>&nbsp;<span class="op" id="6880026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880033">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880052">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880055">}</span><span class="op" id="6880056">(</span><span class="ident" id="6880057">strings</span><span class="op" id="6880064">.</span><span class="ident" id="6880065">Split</span><span class="op" id="6880070">(</span><span class="ident" id="6880071">server</span><span class="op" id="6880077">,</span>&nbsp;<span class="string" id="6880079">&#34;\r\n&#34;</span><span class="op" id="6880085">)</span><span class="op" id="6880086">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880090">err</span>&nbsp;<span class="op" id="6880094">=</span>&nbsp;<span class="ident" id="6880096">SendMail</span><span class="op" id="6880104">(</span><span class="ident" id="6880105">l</span><span class="op" id="6880106">.</span><span class="ident" id="6880107">Addr</span><span class="op" id="6880111">(</span><span class="op" id="6880112">)</span><span class="op" id="6880113">.</span><span class="ident" id="6880114">String</span><span class="op" id="6880120">(</span><span class="op" id="6880121">)</span><span class="op" id="6880122">,</span>&nbsp;<span class="ident" id="6880124">nil</span><span class="op" id="6880127">,</span>&nbsp;<span class="string" id="6880129">&#34;test@example.com&#34;</span><span class="op" id="6880147">,</span>&nbsp;<span class="op" id="6880149">[</span><span class="op" id="6880150">]</span><span class="builtintype" id="6880151">string</span><span class="op" id="6880157">{</span><span class="string" id="6880158">&#34;other@example.com&#34;</span><span class="op" id="6880177">}</span><span class="op" id="6880178">,</span>&nbsp;<span class="op" id="6880180">[</span><span class="op" id="6880181">]</span><span class="builtintype" id="6880182">byte</span><span class="op" id="6880186">(</span><span class="ident" id="6880187">strings</span><span class="op" id="6880194">.</span><span class="ident" id="6880195">Replace</span><span class="op" id="6880202">(</span><span class="string" id="6880203">`From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno">470</span><br>
<span class="lineno"></span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>`</span><span class="op" id="6880302">,</span>&nbsp;<span class="string" id="6880304">&#34;\n&#34;</span><span class="op" id="6880308">,</span>&nbsp;<span class="string" id="6880310">&#34;\r\n&#34;</span><span class="op" id="6880316">,</span>&nbsp;<span class="op" id="6880318">-</span><span class="num" id="6880319">1</span><span class="op" id="6880320">)</span><span class="op" id="6880321">)</span><span class="op" id="6880322">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880326">if</span>&nbsp;<span class="ident" id="6880329">err</span>&nbsp;<span class="op" id="6880333">!=</span>&nbsp;<span class="ident" id="6880336">nil</span>&nbsp;<span class="op" id="6880340">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880344">t</span><span class="op" id="6880345">.</span><span class="ident" id="6880346">Errorf</span><span class="op" id="6880352">(</span><span class="string" id="6880353">&#34;%v&#34;</span><span class="op" id="6880357">,</span>&nbsp;<span class="ident" id="6880359">err</span><span class="op" id="6880362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880369">&lt;-</span><span class="ident" id="6880371">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880377">bcmdbuf</span><span class="op" id="6880384">.</span><span class="ident" id="6880385">Flush</span><span class="op" id="6880390">(</span><span class="op" id="6880391">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880394">actualcmds</span>&nbsp;<span class="op" id="6880405">:=</span>&nbsp;<span class="ident" id="6880408">cmdbuf</span><span class="op" id="6880414">.</span><span class="ident" id="6880415">String</span><span class="op" id="6880421">(</span><span class="op" id="6880422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880425">if</span>&nbsp;<span class="ident" id="6880428">client</span>&nbsp;<span class="op" id="6880435">!=</span>&nbsp;<span class="ident" id="6880438">actualcmds</span>&nbsp;<span class="op" id="6880449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880453">t</span><span class="op" id="6880454">.</span><span class="ident" id="6880455">Errorf</span><span class="op" id="6880461">(</span><span class="string" id="6880462">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6880487">,</span>&nbsp;<span class="ident" id="6880489">actualcmds</span><span class="op" id="6880499">,</span>&nbsp;<span class="ident" id="6880501">client</span><span class="op" id="6880507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880510">}</span><br>
<span class="lineno"></span><span class="op" id="6880512">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="6880515">var</span>&nbsp;<span class="ident" id="6880519">sendMailServer</span>&nbsp;<span class="op" id="6880534">=</span>&nbsp;<span class="string" id="6880536">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno"></span>250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;ok<br>
<span class="lineno">490</span>250&nbsp;Receiver&nbsp;ok<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;ok<br>
<span class="lineno"></span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="keyword" id="6880665">var</span>&nbsp;<span class="ident" id="6880669">sendMailClient</span>&nbsp;<span class="op" id="6880684">=</span>&nbsp;<span class="string" id="6880686">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;test@example.com&gt;<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;other@example.com&gt;<br>
<span class="lineno">500</span>DATA<br>
<span class="lineno"></span>From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno"></span><br>
<span class="lineno">505</span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="6880886">func</span>&nbsp;<span class="ident" id="6880891">TestAuthFailed</span><span class="op" id="6880905">(</span><span class="ident" id="6880906">t</span>&nbsp;<span class="op" id="6880908">*</span><span class="ident" id="6880909">testing</span><span class="op" id="6880916">.</span><span class="ident" id="6880917">T</span><span class="op" id="6880918">)</span>&nbsp;<span class="op" id="6880920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880923">server</span>&nbsp;<span class="op" id="6880930">:=</span>&nbsp;<span class="ident" id="6880933">strings</span><span class="op" id="6880940">.</span><span class="ident" id="6880941">Join</span><span class="op" id="6880945">(</span><span class="ident" id="6880946">strings</span><span class="op" id="6880953">.</span><span class="ident" id="6880954">Split</span><span class="op" id="6880959">(</span><span class="ident" id="6880960">authFailedServer</span><span class="op" id="6880976">,</span>&nbsp;<span class="string" id="6880978">&#34;\n&#34;</span><span class="op" id="6880982">)</span><span class="op" id="6880983">,</span>&nbsp;<span class="string" id="6880985">&#34;\r\n&#34;</span><span class="op" id="6880991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880994">client</span>&nbsp;<span class="op" id="6881001">:=</span>&nbsp;<span class="ident" id="6881004">strings</span><span class="op" id="6881011">.</span><span class="ident" id="6881012">Join</span><span class="op" id="6881016">(</span><span class="ident" id="6881017">strings</span><span class="op" id="6881024">.</span><span class="ident" id="6881025">Split</span><span class="op" id="6881030">(</span><span class="ident" id="6881031">authFailedClient</span><span class="op" id="6881047">,</span>&nbsp;<span class="string" id="6881049">&#34;\n&#34;</span><span class="op" id="6881053">)</span><span class="op" id="6881054">,</span>&nbsp;<span class="string" id="6881056">&#34;\r\n&#34;</span><span class="op" id="6881062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881065">var</span>&nbsp;<span class="ident" id="6881069">cmdbuf</span>&nbsp;<span class="ident" id="6881076">bytes</span><span class="op" id="6881081">.</span><span class="ident" id="6881082">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881090">bcmdbuf</span>&nbsp;<span class="op" id="6881098">:=</span>&nbsp;<span class="ident" id="6881101">bufio</span><span class="op" id="6881106">.</span><span class="ident" id="6881107">NewWriter</span><span class="op" id="6881116">(</span><span class="op" id="6881117">&amp;</span><span class="ident" id="6881118">cmdbuf</span><span class="op" id="6881124">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881127">var</span>&nbsp;<span class="ident" id="6881131">fake</span>&nbsp;<span class="ident" id="6881136">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881143">fake</span><span class="op" id="6881147">.</span><span class="ident" id="6881148">ReadWriter</span>&nbsp;<span class="op" id="6881159">=</span>&nbsp;<span class="ident" id="6881161">bufio</span><span class="op" id="6881166">.</span><span class="ident" id="6881167">NewReadWriter</span><span class="op" id="6881180">(</span><span class="ident" id="6881181">bufio</span><span class="op" id="6881186">.</span><span class="ident" id="6881187">NewReader</span><span class="op" id="6881196">(</span><span class="ident" id="6881197">strings</span><span class="op" id="6881204">.</span><span class="ident" id="6881205">NewReader</span><span class="op" id="6881214">(</span><span class="ident" id="6881215">server</span><span class="op" id="6881221">)</span><span class="op" id="6881222">)</span><span class="op" id="6881223">,</span>&nbsp;<span class="ident" id="6881225">bcmdbuf</span><span class="op" id="6881232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881235">c</span><span class="op" id="6881236">,</span>&nbsp;<span class="ident" id="6881238">err</span>&nbsp;<span class="op" id="6881242">:=</span>&nbsp;<span class="ident" id="6881245">NewClient</span><span class="op" id="6881254">(</span><span class="ident" id="6881255">fake</span><span class="op" id="6881259">,</span>&nbsp;<span class="string" id="6881261">&#34;fake.host&#34;</span><span class="op" id="6881272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881275">if</span>&nbsp;<span class="ident" id="6881278">err</span>&nbsp;<span class="op" id="6881282">!=</span>&nbsp;<span class="ident" id="6881285">nil</span>&nbsp;<span class="op" id="6881289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881293">t</span><span class="op" id="6881294">.</span><span class="ident" id="6881295">Fatalf</span><span class="op" id="6881301">(</span><span class="string" id="6881302">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="6881317">,</span>&nbsp;<span class="ident" id="6881319">err</span><span class="op" id="6881322">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881328">defer</span>&nbsp;<span class="ident" id="6881334">c</span><span class="op" id="6881335">.</span><span class="ident" id="6881336">Close</span><span class="op" id="6881341">(</span><span class="op" id="6881342">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881346">c</span><span class="op" id="6881347">.</span><span class="ident" id="6881348">tls</span>&nbsp;<span class="op" id="6881352">=</span>&nbsp;<span class="builtintype" id="6881354">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881360">c</span><span class="op" id="6881361">.</span><span class="ident" id="6881362">serverName</span>&nbsp;<span class="op" id="6881373">=</span>&nbsp;<span class="string" id="6881375">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881394">err</span>&nbsp;<span class="op" id="6881398">=</span>&nbsp;<span class="ident" id="6881400">c</span><span class="op" id="6881401">.</span><span class="ident" id="6881402">Auth</span><span class="op" id="6881406">(</span><span class="ident" id="6881407">PlainAuth</span><span class="op" id="6881416">(</span><span class="string" id="6881417">&#34;&#34;</span><span class="op" id="6881419">,</span>&nbsp;<span class="string" id="6881421">&#34;user&#34;</span><span class="op" id="6881427">,</span>&nbsp;<span class="string" id="6881429">&#34;pass&#34;</span><span class="op" id="6881435">,</span>&nbsp;<span class="string" id="6881437">&#34;smtp.google.com&#34;</span><span class="op" id="6881454">)</span><span class="op" id="6881455">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881459">if</span>&nbsp;<span class="ident" id="6881462">err</span>&nbsp;<span class="op" id="6881466">==</span>&nbsp;<span class="ident" id="6881469">nil</span>&nbsp;<span class="op" id="6881473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881477">t</span><span class="op" id="6881478">.</span><span class="ident" id="6881479">Error</span><span class="op" id="6881484">(</span><span class="string" id="6881485">&#34;Auth:&nbsp;expected&nbsp;error;&nbsp;got&nbsp;none&#34;</span><span class="op" id="6881517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881520">}</span>&nbsp;<span class="keyword" id="6881522">else</span>&nbsp;<span class="keyword" id="6881527">if</span>&nbsp;<span class="ident" id="6881530">err</span><span class="op" id="6881533">.</span><span class="ident" id="6881534">Error</span><span class="op" id="6881539">(</span><span class="op" id="6881540">)</span>&nbsp;<span class="op" id="6881542">!=</span>&nbsp;<span class="string" id="6881545">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span>&nbsp;<span class="op" id="6881599">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881603">t</span><span class="op" id="6881604">.</span><span class="ident" id="6881605">Errorf</span><span class="op" id="6881611">(</span><span class="string" id="6881612">&#34;Auth:&nbsp;got&nbsp;error:&nbsp;%v,&nbsp;want:&nbsp;%s&#34;</span><span class="op" id="6881643">,</span>&nbsp;<span class="ident" id="6881645">err</span><span class="op" id="6881648">,</span>&nbsp;<span class="string" id="6881650">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span><span class="op" id="6881703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881710">bcmdbuf</span><span class="op" id="6881717">.</span><span class="ident" id="6881718">Flush</span><span class="op" id="6881723">(</span><span class="op" id="6881724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881727">actualcmds</span>&nbsp;<span class="op" id="6881738">:=</span>&nbsp;<span class="ident" id="6881741">cmdbuf</span><span class="op" id="6881747">.</span><span class="ident" id="6881748">String</span><span class="op" id="6881754">(</span><span class="op" id="6881755">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881758">if</span>&nbsp;<span class="ident" id="6881761">client</span>&nbsp;<span class="op" id="6881768">!=</span>&nbsp;<span class="ident" id="6881771">actualcmds</span>&nbsp;<span class="op" id="6881782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881786">t</span><span class="op" id="6881787">.</span><span class="ident" id="6881788">Errorf</span><span class="op" id="6881794">(</span><span class="string" id="6881795">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6881820">,</span>&nbsp;<span class="ident" id="6881822">actualcmds</span><span class="op" id="6881832">,</span>&nbsp;<span class="ident" id="6881834">client</span><span class="op" id="6881840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881843">}</span><br>
<span class="lineno"></span><span class="op" id="6881845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">540</span><span class="keyword" id="6881848">var</span>&nbsp;<span class="ident" id="6881852">authFailedServer</span>&nbsp;<span class="op" id="6881869">=</span>&nbsp;<span class="string" id="6881871">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>535-Invalid&nbsp;credentials<br>
<span class="lineno"></span>535&nbsp;please&nbsp;see&nbsp;www.example.com<br>
<span class="lineno">545</span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6882013">var</span>&nbsp;<span class="ident" id="6882017">authFailedClient</span>&nbsp;<span class="op" id="6882034">=</span>&nbsp;<span class="string" id="6882036">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno">550</span>*<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6882090">func</span>&nbsp;<span class="ident" id="6882095">TestTLSClient</span><span class="op" id="6882108">(</span><span class="ident" id="6882109">t</span>&nbsp;<span class="op" id="6882111">*</span><span class="ident" id="6882112">testing</span><span class="op" id="6882119">.</span><span class="ident" id="6882120">T</span><span class="op" id="6882121">)</span>&nbsp;<span class="op" id="6882123">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882126">ln</span>&nbsp;<span class="op" id="6882129">:=</span>&nbsp;<span class="ident" id="6882132">newLocalListener</span><span class="op" id="6882148">(</span><span class="ident" id="6882149">t</span><span class="op" id="6882150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882153">defer</span>&nbsp;<span class="ident" id="6882159">ln</span><span class="op" id="6882161">.</span><span class="ident" id="6882162">Close</span><span class="op" id="6882167">(</span><span class="op" id="6882168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882171">errc</span>&nbsp;<span class="op" id="6882176">:=</span>&nbsp;<span class="builtinfunc" id="6882179">make</span><span class="op" id="6882183">(</span><span class="keyword" id="6882184">chan</span>&nbsp;<span class="builtintype" id="6882189">error</span><span class="op" id="6882194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882197">go</span>&nbsp;<span class="keyword" id="6882200">func</span><span class="op" id="6882204">(</span><span class="op" id="6882205">)</span>&nbsp;<span class="op" id="6882207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882211">errc</span>&nbsp;<span class="op" id="6882216">&lt;-</span>&nbsp;<span class="ident" id="6882219">sendMail</span><span class="op" id="6882227">(</span><span class="ident" id="6882228">ln</span><span class="op" id="6882230">.</span><span class="ident" id="6882231">Addr</span><span class="op" id="6882235">(</span><span class="op" id="6882236">)</span><span class="op" id="6882237">.</span><span class="ident" id="6882238">String</span><span class="op" id="6882244">(</span><span class="op" id="6882245">)</span><span class="op" id="6882246">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882249">}</span><span class="op" id="6882250">(</span><span class="op" id="6882251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882254">conn</span><span class="op" id="6882258">,</span>&nbsp;<span class="ident" id="6882260">err</span>&nbsp;<span class="op" id="6882264">:=</span>&nbsp;<span class="ident" id="6882267">ln</span><span class="op" id="6882269">.</span><span class="ident" id="6882270">Accept</span><span class="op" id="6882276">(</span><span class="op" id="6882277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882280">if</span>&nbsp;<span class="ident" id="6882283">err</span>&nbsp;<span class="op" id="6882287">!=</span>&nbsp;<span class="ident" id="6882290">nil</span>&nbsp;<span class="op" id="6882294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882298">t</span><span class="op" id="6882299">.</span><span class="ident" id="6882300">Fatalf</span><span class="op" id="6882306">(</span><span class="string" id="6882307">&#34;failed&nbsp;to&nbsp;accept&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="6882340">,</span>&nbsp;<span class="ident" id="6882342">err</span><span class="op" id="6882345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882348">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882351">defer</span>&nbsp;<span class="ident" id="6882357">conn</span><span class="op" id="6882361">.</span><span class="ident" id="6882362">Close</span><span class="op" id="6882367">(</span><span class="op" id="6882368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882371">if</span>&nbsp;<span class="ident" id="6882374">err</span>&nbsp;<span class="op" id="6882378">:=</span>&nbsp;<span class="ident" id="6882381">serverHandle</span><span class="op" id="6882393">(</span><span class="ident" id="6882394">conn</span><span class="op" id="6882398">,</span>&nbsp;<span class="ident" id="6882400">t</span><span class="op" id="6882401">)</span><span class="op" id="6882402">;</span>&nbsp;<span class="ident" id="6882404">err</span>&nbsp;<span class="op" id="6882408">!=</span>&nbsp;<span class="ident" id="6882411">nil</span>&nbsp;<span class="op" id="6882415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882419">t</span><span class="op" id="6882420">.</span><span class="ident" id="6882421">Fatalf</span><span class="op" id="6882427">(</span><span class="string" id="6882428">&#34;failed&nbsp;to&nbsp;handle&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="6882461">,</span>&nbsp;<span class="ident" id="6882463">err</span><span class="op" id="6882466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882472">if</span>&nbsp;<span class="ident" id="6882475">err</span>&nbsp;<span class="op" id="6882479">:=</span>&nbsp;<span class="op" id="6882482">&lt;-</span><span class="ident" id="6882484">errc</span><span class="op" id="6882488">;</span>&nbsp;<span class="ident" id="6882490">err</span>&nbsp;<span class="op" id="6882494">!=</span>&nbsp;<span class="ident" id="6882497">nil</span>&nbsp;<span class="op" id="6882501">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882505">t</span><span class="op" id="6882506">.</span><span class="ident" id="6882507">Fatalf</span><span class="op" id="6882513">(</span><span class="string" id="6882514">&#34;client&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6882532">,</span>&nbsp;<span class="ident" id="6882534">err</span><span class="op" id="6882537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882540">}</span><br>
<span class="lineno"></span><span class="op" id="6882542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6882545">func</span>&nbsp;<span class="ident" id="6882550">newLocalListener</span><span class="op" id="6882566">(</span><span class="ident" id="6882567">t</span>&nbsp;<span class="op" id="6882569">*</span><span class="ident" id="6882570">testing</span><span class="op" id="6882577">.</span><span class="ident" id="6882578">T</span><span class="op" id="6882579">)</span>&nbsp;<span class="ident" id="6882581">net</span><span class="op" id="6882584">.</span><span class="ident" id="6882585">Listener</span>&nbsp;<span class="op" id="6882594">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882597">ln</span><span class="op" id="6882599">,</span>&nbsp;<span class="ident" id="6882601">err</span>&nbsp;<span class="op" id="6882605">:=</span>&nbsp;<span class="ident" id="6882608">net</span><span class="op" id="6882611">.</span><span class="ident" id="6882612">Listen</span><span class="op" id="6882618">(</span><span class="string" id="6882619">&#34;tcp&#34;</span><span class="op" id="6882624">,</span>&nbsp;<span class="string" id="6882626">&#34;127.0.0.1:0&#34;</span><span class="op" id="6882639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882642">if</span>&nbsp;<span class="ident" id="6882645">err</span>&nbsp;<span class="op" id="6882649">!=</span>&nbsp;<span class="ident" id="6882652">nil</span>&nbsp;<span class="op" id="6882656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882660">ln</span><span class="op" id="6882662">,</span>&nbsp;<span class="ident" id="6882664">err</span>&nbsp;<span class="op" id="6882668">=</span>&nbsp;<span class="ident" id="6882670">net</span><span class="op" id="6882673">.</span><span class="ident" id="6882674">Listen</span><span class="op" id="6882680">(</span><span class="string" id="6882681">&#34;tcp6&#34;</span><span class="op" id="6882687">,</span>&nbsp;<span class="string" id="6882689">&#34;[::1]:0&#34;</span><span class="op" id="6882698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882704">if</span>&nbsp;<span class="ident" id="6882707">err</span>&nbsp;<span class="op" id="6882711">!=</span>&nbsp;<span class="ident" id="6882714">nil</span>&nbsp;<span class="op" id="6882718">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882722">t</span><span class="op" id="6882723">.</span><span class="ident" id="6882724">Fatal</span><span class="op" id="6882729">(</span><span class="ident" id="6882730">err</span><span class="op" id="6882733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882739">return</span>&nbsp;<span class="ident" id="6882746">ln</span><br>
<span class="lineno"></span><span class="op" id="6882749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span><span class="keyword" id="6882752">type</span>&nbsp;<span class="ident" id="6882757">smtpSender</span>&nbsp;<span class="keyword" id="6882768">struct</span>&nbsp;<span class="op" id="6882775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882778">w</span>&nbsp;<span class="ident" id="6882780">io</span><span class="op" id="6882782">.</span><span class="ident" id="6882783">Writer</span><br>
<span class="lineno"></span><span class="op" id="6882790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6882793">func</span>&nbsp;<span class="op" id="6882798">(</span><span class="ident" id="6882799">s</span>&nbsp;<span class="ident" id="6882801">smtpSender</span><span class="op" id="6882811">)</span>&nbsp;<span class="ident" id="6882813">send</span><span class="op" id="6882817">(</span><span class="ident" id="6882818">f</span>&nbsp;<span class="builtintype" id="6882820">string</span><span class="op" id="6882826">)</span>&nbsp;<span class="op" id="6882828">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882831">s</span><span class="op" id="6882832">.</span><span class="ident" id="6882833">w</span><span class="op" id="6882834">.</span><span class="ident" id="6882835">Write</span><span class="op" id="6882840">(</span><span class="op" id="6882841">[</span><span class="op" id="6882842">]</span><span class="builtintype" id="6882843">byte</span><span class="op" id="6882847">(</span><span class="ident" id="6882848">f</span>&nbsp;<span class="op" id="6882850">+</span>&nbsp;<span class="string" id="6882852">&#34;\r\n&#34;</span><span class="op" id="6882858">)</span><span class="op" id="6882859">)</span><br>
<span class="lineno"></span><span class="op" id="6882861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6882864">//&nbsp;smtp&nbsp;server,&nbsp;finely&nbsp;tailored&nbsp;to&nbsp;deal&nbsp;with&nbsp;our&nbsp;own&nbsp;client&nbsp;only!</span><br>
<span class="lineno"></span><span class="keyword" id="6882930">func</span>&nbsp;<span class="ident" id="6882935">serverHandle</span><span class="op" id="6882947">(</span><span class="ident" id="6882948">c</span>&nbsp;<span class="ident" id="6882950">net</span><span class="op" id="6882953">.</span><span class="ident" id="6882954">Conn</span><span class="op" id="6882958">,</span>&nbsp;<span class="ident" id="6882960">t</span>&nbsp;<span class="op" id="6882962">*</span><span class="ident" id="6882963">testing</span><span class="op" id="6882970">.</span><span class="ident" id="6882971">T</span><span class="op" id="6882972">)</span>&nbsp;<span class="builtintype" id="6882974">error</span>&nbsp;<span class="op" id="6882980">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882983">send</span>&nbsp;<span class="op" id="6882988">:=</span>&nbsp;<span class="ident" id="6882991">smtpSender</span><span class="op" id="6883001">{</span><span class="ident" id="6883002">c</span><span class="op" id="6883003">}</span><span class="op" id="6883004">.</span><span class="ident" id="6883005">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883011">send</span><span class="op" id="6883015">(</span><span class="string" id="6883016">&#34;220&nbsp;127.0.0.1&nbsp;ESMTP&nbsp;service&nbsp;ready&#34;</span><span class="op" id="6883051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883054">s</span>&nbsp;<span class="op" id="6883056">:=</span>&nbsp;<span class="ident" id="6883059">bufio</span><span class="op" id="6883064">.</span><span class="ident" id="6883065">NewScanner</span><span class="op" id="6883075">(</span><span class="ident" id="6883076">c</span><span class="op" id="6883077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883080">for</span>&nbsp;<span class="ident" id="6883084">s</span><span class="op" id="6883085">.</span><span class="ident" id="6883086">Scan</span><span class="op" id="6883090">(</span><span class="op" id="6883091">)</span>&nbsp;<span class="op" id="6883093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883097">switch</span>&nbsp;<span class="ident" id="6883104">s</span><span class="op" id="6883105">.</span><span class="ident" id="6883106">Text</span><span class="op" id="6883110">(</span><span class="op" id="6883111">)</span>&nbsp;<span class="op" id="6883113">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883117">case</span>&nbsp;<span class="string" id="6883122">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="6883138">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883143">send</span><span class="op" id="6883147">(</span><span class="string" id="6883148">&#34;250-127.0.0.1&nbsp;ESMTP&nbsp;offers&nbsp;a&nbsp;warm&nbsp;hug&nbsp;of&nbsp;welcome&#34;</span><span class="op" id="6883198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883203">send</span><span class="op" id="6883207">(</span><span class="string" id="6883208">&#34;250-STARTTLS&#34;</span><span class="op" id="6883222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883227">send</span><span class="op" id="6883231">(</span><span class="string" id="6883232">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6883240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883244">case</span>&nbsp;<span class="string" id="6883249">&#34;STARTTLS&#34;</span><span class="op" id="6883259">:</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883264">send</span><span class="op" id="6883268">(</span><span class="string" id="6883269">&#34;220&nbsp;Go&nbsp;ahead&#34;</span><span class="op" id="6883283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883288">keypair</span><span class="op" id="6883295">,</span>&nbsp;<span class="ident" id="6883297">err</span>&nbsp;<span class="op" id="6883301">:=</span>&nbsp;<span class="ident" id="6883304">tls</span><span class="op" id="6883307">.</span><span class="ident" id="6883308">X509KeyPair</span><span class="op" id="6883319">(</span><span class="ident" id="6883320">localhostCert</span><span class="op" id="6883333">,</span>&nbsp;<span class="ident" id="6883335">localhostKey</span><span class="op" id="6883347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883352">if</span>&nbsp;<span class="ident" id="6883355">err</span>&nbsp;<span class="op" id="6883359">!=</span>&nbsp;<span class="ident" id="6883362">nil</span>&nbsp;<span class="op" id="6883366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883372">return</span>&nbsp;<span class="ident" id="6883379">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883386">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883391">config</span>&nbsp;<span class="op" id="6883398">:=</span>&nbsp;<span class="op" id="6883401">&amp;</span><span class="ident" id="6883402">tls</span><span class="op" id="6883405">.</span><span class="ident" id="6883406">Config</span><span class="op" id="6883412">{</span><span class="ident" id="6883413">Certificates</span><span class="op" id="6883425">:</span>&nbsp;<span class="op" id="6883427">[</span><span class="op" id="6883428">]</span><span class="ident" id="6883429">tls</span><span class="op" id="6883432">.</span><span class="ident" id="6883433">Certificate</span><span class="op" id="6883444">{</span><span class="ident" id="6883445">keypair</span><span class="op" id="6883452">}</span><span class="op" id="6883453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883458">c</span>&nbsp;<span class="op" id="6883460">=</span>&nbsp;<span class="ident" id="6883462">tls</span><span class="op" id="6883465">.</span><span class="ident" id="6883466">Server</span><span class="op" id="6883472">(</span><span class="ident" id="6883473">c</span><span class="op" id="6883474">,</span>&nbsp;<span class="ident" id="6883476">config</span><span class="op" id="6883482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883487">defer</span>&nbsp;<span class="ident" id="6883493">c</span><span class="op" id="6883494">.</span><span class="ident" id="6883495">Close</span><span class="op" id="6883500">(</span><span class="op" id="6883501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883506">return</span>&nbsp;<span class="ident" id="6883513">serverHandleTLS</span><span class="op" id="6883528">(</span><span class="ident" id="6883529">c</span><span class="op" id="6883530">,</span>&nbsp;<span class="ident" id="6883532">t</span><span class="op" id="6883533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883537">default</span><span class="op" id="6883544">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883549">t</span><span class="op" id="6883550">.</span><span class="ident" id="6883551">Fatalf</span><span class="op" id="6883557">(</span><span class="string" id="6883558">&#34;unrecognized&nbsp;command:&nbsp;%q&#34;</span><span class="op" id="6883584">,</span>&nbsp;<span class="ident" id="6883586">s</span><span class="op" id="6883587">.</span><span class="ident" id="6883588">Text</span><span class="op" id="6883592">(</span><span class="op" id="6883593">)</span><span class="op" id="6883594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883604">return</span>&nbsp;<span class="ident" id="6883611">s</span><span class="op" id="6883612">.</span><span class="ident" id="6883613">Err</span><span class="op" id="6883616">(</span><span class="op" id="6883617">)</span><br>
<span class="lineno"></span><span class="op" id="6883619">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="6883622">func</span>&nbsp;<span class="ident" id="6883627">serverHandleTLS</span><span class="op" id="6883642">(</span><span class="ident" id="6883643">c</span>&nbsp;<span class="ident" id="6883645">net</span><span class="op" id="6883648">.</span><span class="ident" id="6883649">Conn</span><span class="op" id="6883653">,</span>&nbsp;<span class="ident" id="6883655">t</span>&nbsp;<span class="op" id="6883657">*</span><span class="ident" id="6883658">testing</span><span class="op" id="6883665">.</span><span class="ident" id="6883666">T</span><span class="op" id="6883667">)</span>&nbsp;<span class="builtintype" id="6883669">error</span>&nbsp;<span class="op" id="6883675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883678">send</span>&nbsp;<span class="op" id="6883683">:=</span>&nbsp;<span class="ident" id="6883686">smtpSender</span><span class="op" id="6883696">{</span><span class="ident" id="6883697">c</span><span class="op" id="6883698">}</span><span class="op" id="6883699">.</span><span class="ident" id="6883700">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883706">s</span>&nbsp;<span class="op" id="6883708">:=</span>&nbsp;<span class="ident" id="6883711">bufio</span><span class="op" id="6883716">.</span><span class="ident" id="6883717">NewScanner</span><span class="op" id="6883727">(</span><span class="ident" id="6883728">c</span><span class="op" id="6883729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883732">for</span>&nbsp;<span class="ident" id="6883736">s</span><span class="op" id="6883737">.</span><span class="ident" id="6883738">Scan</span><span class="op" id="6883742">(</span><span class="op" id="6883743">)</span>&nbsp;<span class="op" id="6883745">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883749">switch</span>&nbsp;<span class="ident" id="6883756">s</span><span class="op" id="6883757">.</span><span class="ident" id="6883758">Text</span><span class="op" id="6883762">(</span><span class="op" id="6883763">)</span>&nbsp;<span class="op" id="6883765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883769">case</span>&nbsp;<span class="string" id="6883774">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="6883790">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883795">send</span><span class="op" id="6883799">(</span><span class="string" id="6883800">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6883808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883812">case</span>&nbsp;<span class="string" id="6883817">&#34;MAIL&nbsp;FROM:&lt;joe1@example.com&gt;&#34;</span><span class="op" id="6883847">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883852">send</span><span class="op" id="6883856">(</span><span class="string" id="6883857">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6883865">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883869">case</span>&nbsp;<span class="string" id="6883874">&#34;RCPT&nbsp;TO:&lt;joe2@example.com&gt;&#34;</span><span class="op" id="6883902">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883907">send</span><span class="op" id="6883911">(</span><span class="string" id="6883912">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6883920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883924">case</span>&nbsp;<span class="string" id="6883929">&#34;DATA&#34;</span><span class="op" id="6883935">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883940">send</span><span class="op" id="6883944">(</span><span class="string" id="6883945">&#34;354&nbsp;send&nbsp;the&nbsp;mail&nbsp;data,&nbsp;end&nbsp;with&nbsp;.&#34;</span><span class="op" id="6883981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883986">send</span><span class="op" id="6883990">(</span><span class="string" id="6883991">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6883999">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884003">case</span>&nbsp;<span class="string" id="6884008">&#34;Subject:&nbsp;test&#34;</span><span class="op" id="6884023">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884027">case</span>&nbsp;<span class="string" id="6884032">&#34;&#34;</span><span class="op" id="6884034">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884038">case</span>&nbsp;<span class="string" id="6884043">&#34;howdy!&#34;</span><span class="op" id="6884051">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884055">case</span>&nbsp;<span class="string" id="6884060">&#34;.&#34;</span><span class="op" id="6884063">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884067">case</span>&nbsp;<span class="string" id="6884072">&#34;QUIT&#34;</span><span class="op" id="6884078">:</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884083">send</span><span class="op" id="6884087">(</span><span class="string" id="6884088">&#34;221&nbsp;127.0.0.1&nbsp;Service&nbsp;closing&nbsp;transmission&nbsp;channel&#34;</span><span class="op" id="6884140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884145">return</span>&nbsp;<span class="ident" id="6884152">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884158">default</span><span class="op" id="6884165">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884170">t</span><span class="op" id="6884171">.</span><span class="ident" id="6884172">Fatalf</span><span class="op" id="6884178">(</span><span class="string" id="6884179">&#34;unrecognized&nbsp;command&nbsp;during&nbsp;TLS:&nbsp;%q&#34;</span><span class="op" id="6884216">,</span>&nbsp;<span class="ident" id="6884218">s</span><span class="op" id="6884219">.</span><span class="ident" id="6884220">Text</span><span class="op" id="6884224">(</span><span class="op" id="6884225">)</span><span class="op" id="6884226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884230">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884236">return</span>&nbsp;<span class="ident" id="6884243">s</span><span class="op" id="6884244">.</span><span class="ident" id="6884245">Err</span><span class="op" id="6884248">(</span><span class="op" id="6884249">)</span><br>
<span class="lineno"></span><span class="op" id="6884251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6884254">func</span>&nbsp;<span class="ident" id="6884259">init</span><span class="op" id="6884263">(</span><span class="op" id="6884264">)</span>&nbsp;<span class="op" id="6884266">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884269">testRootCAs</span>&nbsp;<span class="op" id="6884281">:=</span>&nbsp;<span class="ident" id="6884284">x509</span><span class="op" id="6884288">.</span><span class="ident" id="6884289">NewCertPool</span><span class="op" id="6884300">(</span><span class="op" id="6884301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884304">testRootCAs</span><span class="op" id="6884315">.</span><span class="ident" id="6884316">AppendCertsFromPEM</span><span class="op" id="6884334">(</span><span class="ident" id="6884335">localhostCert</span><span class="op" id="6884348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884351">testHookStartTLS</span>&nbsp;<span class="op" id="6884368">=</span>&nbsp;<span class="keyword" id="6884370">func</span><span class="op" id="6884374">(</span><span class="ident" id="6884375">config</span>&nbsp;<span class="op" id="6884382">*</span><span class="ident" id="6884383">tls</span><span class="op" id="6884386">.</span><span class="ident" id="6884387">Config</span><span class="op" id="6884393">)</span>&nbsp;<span class="op" id="6884395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884399">config</span><span class="op" id="6884405">.</span><span class="ident" id="6884406">RootCAs</span>&nbsp;<span class="op" id="6884414">=</span>&nbsp;<span class="ident" id="6884416">testRootCAs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884429">}</span><br>
<span class="lineno">655</span><span class="op" id="6884431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6884434">func</span>&nbsp;<span class="ident" id="6884439">sendMail</span><span class="op" id="6884447">(</span><span class="ident" id="6884448">hostPort</span>&nbsp;<span class="builtintype" id="6884457">string</span><span class="op" id="6884463">)</span>&nbsp;<span class="builtintype" id="6884465">error</span>&nbsp;<span class="op" id="6884471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884474">host</span><span class="op" id="6884478">,</span>&nbsp;<span class="ident" id="6884480">_</span><span class="op" id="6884481">,</span>&nbsp;<span class="ident" id="6884483">err</span>&nbsp;<span class="op" id="6884487">:=</span>&nbsp;<span class="ident" id="6884490">net</span><span class="op" id="6884493">.</span><span class="ident" id="6884494">SplitHostPort</span><span class="op" id="6884507">(</span><span class="ident" id="6884508">hostPort</span><span class="op" id="6884516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884519">if</span>&nbsp;<span class="ident" id="6884522">err</span>&nbsp;<span class="op" id="6884526">!=</span>&nbsp;<span class="ident" id="6884529">nil</span>&nbsp;<span class="op" id="6884533">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884537">return</span>&nbsp;<span class="ident" id="6884544">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884552">auth</span>&nbsp;<span class="op" id="6884557">:=</span>&nbsp;<span class="ident" id="6884560">PlainAuth</span><span class="op" id="6884569">(</span><span class="string" id="6884570">&#34;&#34;</span><span class="op" id="6884572">,</span>&nbsp;<span class="string" id="6884574">&#34;&#34;</span><span class="op" id="6884576">,</span>&nbsp;<span class="string" id="6884578">&#34;&#34;</span><span class="op" id="6884580">,</span>&nbsp;<span class="ident" id="6884582">host</span><span class="op" id="6884586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884589">from</span>&nbsp;<span class="op" id="6884594">:=</span>&nbsp;<span class="string" id="6884597">&#34;joe1@example.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884617">to</span>&nbsp;<span class="op" id="6884620">:=</span>&nbsp;<span class="op" id="6884623">[</span><span class="op" id="6884624">]</span><span class="builtintype" id="6884625">string</span><span class="op" id="6884631">{</span><span class="string" id="6884632">&#34;joe2@example.com&#34;</span><span class="op" id="6884650">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884653">return</span>&nbsp;<span class="ident" id="6884660">SendMail</span><span class="op" id="6884668">(</span><span class="ident" id="6884669">hostPort</span><span class="op" id="6884677">,</span>&nbsp;<span class="ident" id="6884679">auth</span><span class="op" id="6884683">,</span>&nbsp;<span class="ident" id="6884685">from</span><span class="op" id="6884689">,</span>&nbsp;<span class="ident" id="6884691">to</span><span class="op" id="6884693">,</span>&nbsp;<span class="op" id="6884695">[</span><span class="op" id="6884696">]</span><span class="builtintype" id="6884697">byte</span><span class="op" id="6884701">(</span><span class="string" id="6884702">&#34;Subject:&nbsp;test\n\nhowdy!&#34;</span><span class="op" id="6884727">)</span><span class="op" id="6884728">)</span><br>
<span class="lineno"></span><span class="op" id="6884730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6884733">//&nbsp;(copied&nbsp;from&nbsp;net/http/httptest)</span><br>
<span class="lineno"></span><span class="comment" id="6884768">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno">670</span><span class="comment" id="6884824">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno"></span><span class="comment" id="6884897">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="6884916">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="6884950">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="6885086">var</span>&nbsp;<span class="ident" id="6885090">localhostCert</span>&nbsp;<span class="op" id="6885104">=</span>&nbsp;<span class="op" id="6885106">[</span><span class="op" id="6885107">]</span><span class="builtintype" id="6885108">byte</span><span class="op" id="6885112">(</span><span class="string" id="6885113">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno">675</span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno"></span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno">680</span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno"></span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="6885684">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span><span class="comment" id="6885687">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno"></span><span class="keyword" id="6885741">var</span>&nbsp;<span class="ident" id="6885745">localhostKey</span>&nbsp;<span class="op" id="6885758">=</span>&nbsp;<span class="op" id="6885760">[</span><span class="op" id="6885761">]</span><span class="builtintype" id="6885762">byte</span><span class="op" id="6885766">(</span><span class="string" id="6885767">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno">690</span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno"></span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="6886265">)</span>
</div>
</body>
</html>
