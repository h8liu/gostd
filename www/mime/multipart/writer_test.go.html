<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6960383">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6960438">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6960492">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6960543">package</span>&nbsp;<span class="ident" id="6960551">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6960562">import</span>&nbsp;<span class="op" id="6960569">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6960572">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6960581">&#34;io/ioutil&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6960594">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6960605">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="6960615">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6960618">func</span>&nbsp;<span class="ident" id="6960623">TestWriter</span><span class="op" id="6960633">(</span><span class="ident" id="6960634">t</span>&nbsp;<span class="op" id="6960636">*</span><span class="ident" id="6960637">testing</span><span class="op" id="6960644">.</span><span class="ident" id="6960645">T</span><span class="op" id="6960646">)</span>&nbsp;<span class="op" id="6960648">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6960651">fileContents</span>&nbsp;<span class="op" id="6960664">:=</span>&nbsp;<span class="op" id="6960667">[</span><span class="op" id="6960668">]</span><span class="builtintype" id="6960669">byte</span><span class="op" id="6960673">(</span><span class="string" id="6960674">&#34;my&nbsp;file&nbsp;contents&#34;</span><span class="op" id="6960692">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6960696">var</span>&nbsp;<span class="ident" id="6960700">b</span>&nbsp;<span class="ident" id="6960702">bytes</span><span class="op" id="6960707">.</span><span class="ident" id="6960708">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6960716">w</span>&nbsp;<span class="op" id="6960718">:=</span>&nbsp;<span class="ident" id="6960721">NewWriter</span><span class="op" id="6960730">(</span><span class="op" id="6960731">&amp;</span><span class="ident" id="6960732">b</span><span class="op" id="6960733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6960736">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6960740">part</span><span class="op" id="6960744">,</span>&nbsp;<span class="ident" id="6960746">err</span>&nbsp;<span class="op" id="6960750">:=</span>&nbsp;<span class="ident" id="6960753">w</span><span class="op" id="6960754">.</span><span class="ident" id="6960755">CreateFormFile</span><span class="op" id="6960769">(</span><span class="string" id="6960770">&#34;myfile&#34;</span><span class="op" id="6960778">,</span>&nbsp;<span class="string" id="6960780">&#34;my-file.txt&#34;</span><span class="op" id="6960793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6960797">if</span>&nbsp;<span class="ident" id="6960800">err</span>&nbsp;<span class="op" id="6960804">!=</span>&nbsp;<span class="ident" id="6960807">nil</span>&nbsp;<span class="op" id="6960811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6960816">t</span><span class="op" id="6960817">.</span><span class="ident" id="6960818">Fatalf</span><span class="op" id="6960824">(</span><span class="string" id="6960825">&#34;CreateFormFile:&nbsp;%v&#34;</span><span class="op" id="6960845">,</span>&nbsp;<span class="ident" id="6960847">err</span><span class="op" id="6960850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6960854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6960858">part</span><span class="op" id="6960862">.</span><span class="ident" id="6960863">Write</span><span class="op" id="6960868">(</span><span class="ident" id="6960869">fileContents</span><span class="op" id="6960881">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6960885">err</span>&nbsp;<span class="op" id="6960889">=</span>&nbsp;<span class="ident" id="6960891">w</span><span class="op" id="6960892">.</span><span class="ident" id="6960893">WriteField</span><span class="op" id="6960903">(</span><span class="string" id="6960904">&#34;key&#34;</span><span class="op" id="6960909">,</span>&nbsp;<span class="string" id="6960911">&#34;val&#34;</span><span class="op" id="6960916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6960920">if</span>&nbsp;<span class="ident" id="6960923">err</span>&nbsp;<span class="op" id="6960927">!=</span>&nbsp;<span class="ident" id="6960930">nil</span>&nbsp;<span class="op" id="6960934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6960939">t</span><span class="op" id="6960940">.</span><span class="ident" id="6960941">Fatalf</span><span class="op" id="6960947">(</span><span class="string" id="6960948">&#34;WriteField:&nbsp;%v&#34;</span><span class="op" id="6960964">,</span>&nbsp;<span class="ident" id="6960966">err</span><span class="op" id="6960969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6960973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6960977">part</span><span class="op" id="6960981">.</span><span class="ident" id="6960982">Write</span><span class="op" id="6960987">(</span><span class="op" id="6960988">[</span><span class="op" id="6960989">]</span><span class="builtintype" id="6960990">byte</span><span class="op" id="6960994">(</span><span class="string" id="6960995">&#34;val&#34;</span><span class="op" id="6961000">)</span><span class="op" id="6961001">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961005">err</span>&nbsp;<span class="op" id="6961009">=</span>&nbsp;<span class="ident" id="6961011">w</span><span class="op" id="6961012">.</span><span class="ident" id="6961013">Close</span><span class="op" id="6961018">(</span><span class="op" id="6961019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6961023">if</span>&nbsp;<span class="ident" id="6961026">err</span>&nbsp;<span class="op" id="6961030">!=</span>&nbsp;<span class="ident" id="6961033">nil</span>&nbsp;<span class="op" id="6961037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961042">t</span><span class="op" id="6961043">.</span><span class="ident" id="6961044">Fatalf</span><span class="op" id="6961050">(</span><span class="string" id="6961051">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="6961062">,</span>&nbsp;<span class="ident" id="6961064">err</span><span class="op" id="6961067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6961071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961075">s</span>&nbsp;<span class="op" id="6961077">:=</span>&nbsp;<span class="ident" id="6961080">b</span><span class="op" id="6961081">.</span><span class="ident" id="6961082">String</span><span class="op" id="6961088">(</span><span class="op" id="6961089">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6961093">if</span>&nbsp;<span class="builtinfunc" id="6961096">len</span><span class="op" id="6961099">(</span><span class="ident" id="6961100">s</span><span class="op" id="6961101">)</span>&nbsp;<span class="op" id="6961103">==</span>&nbsp;<span class="num" id="6961106">0</span>&nbsp;<span class="op" id="6961108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961113">t</span><span class="op" id="6961114">.</span><span class="ident" id="6961115">Fatal</span><span class="op" id="6961120">(</span><span class="string" id="6961121">&#34;String:&nbsp;unexpected&nbsp;empty&nbsp;result&#34;</span><span class="op" id="6961154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6961158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6961162">if</span>&nbsp;<span class="ident" id="6961165">s</span><span class="op" id="6961166">[</span><span class="num" id="6961167">0</span><span class="op" id="6961168">]</span>&nbsp;<span class="op" id="6961170">==</span>&nbsp;<span class="string" id="6961173">&#39;\r&#39;</span>&nbsp;<span class="op" id="6961178">||</span>&nbsp;<span class="ident" id="6961181">s</span><span class="op" id="6961182">[</span><span class="num" id="6961183">0</span><span class="op" id="6961184">]</span>&nbsp;<span class="op" id="6961186">==</span>&nbsp;<span class="string" id="6961189">&#39;\n&#39;</span>&nbsp;<span class="op" id="6961194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961199">t</span><span class="op" id="6961200">.</span><span class="ident" id="6961201">Fatal</span><span class="op" id="6961206">(</span><span class="string" id="6961207">&#34;String:&nbsp;unexpected&nbsp;newline&#34;</span><span class="op" id="6961235">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6961239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6961242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961246">r</span>&nbsp;<span class="op" id="6961248">:=</span>&nbsp;<span class="ident" id="6961251">NewReader</span><span class="op" id="6961260">(</span><span class="op" id="6961261">&amp;</span><span class="ident" id="6961262">b</span><span class="op" id="6961263">,</span>&nbsp;<span class="ident" id="6961265">w</span><span class="op" id="6961266">.</span><span class="ident" id="6961267">Boundary</span><span class="op" id="6961275">(</span><span class="op" id="6961276">)</span><span class="op" id="6961277">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961281">part</span><span class="op" id="6961285">,</span>&nbsp;<span class="ident" id="6961287">err</span>&nbsp;<span class="op" id="6961291">:=</span>&nbsp;<span class="ident" id="6961294">r</span><span class="op" id="6961295">.</span><span class="ident" id="6961296">NextPart</span><span class="op" id="6961304">(</span><span class="op" id="6961305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6961308">if</span>&nbsp;<span class="ident" id="6961311">err</span>&nbsp;<span class="op" id="6961315">!=</span>&nbsp;<span class="ident" id="6961318">nil</span>&nbsp;<span class="op" id="6961322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961326">t</span><span class="op" id="6961327">.</span><span class="ident" id="6961328">Fatalf</span><span class="op" id="6961334">(</span><span class="string" id="6961335">&#34;part&nbsp;1:&nbsp;%v&#34;</span><span class="op" id="6961347">,</span>&nbsp;<span class="ident" id="6961349">err</span><span class="op" id="6961352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6961355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6961358">if</span>&nbsp;<span class="ident" id="6961361">g</span><span class="op" id="6961362">,</span>&nbsp;<span class="ident" id="6961364">e</span>&nbsp;<span class="op" id="6961366">:=</span>&nbsp;<span class="ident" id="6961369">part</span><span class="op" id="6961373">.</span><span class="ident" id="6961374">FormName</span><span class="op" id="6961382">(</span><span class="op" id="6961383">)</span><span class="op" id="6961384">,</span>&nbsp;<span class="string" id="6961386">&#34;myfile&#34;</span><span class="op" id="6961394">;</span>&nbsp;<span class="ident" id="6961396">g</span>&nbsp;<span class="op" id="6961398">!=</span>&nbsp;<span class="ident" id="6961401">e</span>&nbsp;<span class="op" id="6961403">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961407">t</span><span class="op" id="6961408">.</span><span class="ident" id="6961409">Errorf</span><span class="op" id="6961415">(</span><span class="string" id="6961416">&#34;part&nbsp;1:&nbsp;want&nbsp;form&nbsp;name&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="6961451">,</span>&nbsp;<span class="ident" id="6961453">e</span><span class="op" id="6961454">,</span>&nbsp;<span class="ident" id="6961456">g</span><span class="op" id="6961457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6961460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961463">slurp</span><span class="op" id="6961468">,</span>&nbsp;<span class="ident" id="6961470">err</span>&nbsp;<span class="op" id="6961474">:=</span>&nbsp;<span class="ident" id="6961477">ioutil</span><span class="op" id="6961483">.</span><span class="ident" id="6961484">ReadAll</span><span class="op" id="6961491">(</span><span class="ident" id="6961492">part</span><span class="op" id="6961496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6961499">if</span>&nbsp;<span class="ident" id="6961502">err</span>&nbsp;<span class="op" id="6961506">!=</span>&nbsp;<span class="ident" id="6961509">nil</span>&nbsp;<span class="op" id="6961513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961517">t</span><span class="op" id="6961518">.</span><span class="ident" id="6961519">Fatalf</span><span class="op" id="6961525">(</span><span class="string" id="6961526">&#34;part&nbsp;1:&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="6961547">,</span>&nbsp;<span class="ident" id="6961549">err</span><span class="op" id="6961552">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6961555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6961558">if</span>&nbsp;<span class="ident" id="6961561">e</span><span class="op" id="6961562">,</span>&nbsp;<span class="ident" id="6961564">g</span>&nbsp;<span class="op" id="6961566">:=</span>&nbsp;<span class="builtintype" id="6961569">string</span><span class="op" id="6961575">(</span><span class="ident" id="6961576">fileContents</span><span class="op" id="6961588">)</span><span class="op" id="6961589">,</span>&nbsp;<span class="builtintype" id="6961591">string</span><span class="op" id="6961597">(</span><span class="ident" id="6961598">slurp</span><span class="op" id="6961603">)</span><span class="op" id="6961604">;</span>&nbsp;<span class="ident" id="6961606">e</span>&nbsp;<span class="op" id="6961608">!=</span>&nbsp;<span class="ident" id="6961611">g</span>&nbsp;<span class="op" id="6961613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961617">t</span><span class="op" id="6961618">.</span><span class="ident" id="6961619">Errorf</span><span class="op" id="6961625">(</span><span class="string" id="6961626">&#34;part&nbsp;1:&nbsp;want&nbsp;contents&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="6961660">,</span>&nbsp;<span class="ident" id="6961662">e</span><span class="op" id="6961663">,</span>&nbsp;<span class="ident" id="6961665">g</span><span class="op" id="6961666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6961669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961673">part</span><span class="op" id="6961677">,</span>&nbsp;<span class="ident" id="6961679">err</span>&nbsp;<span class="op" id="6961683">=</span>&nbsp;<span class="ident" id="6961685">r</span><span class="op" id="6961686">.</span><span class="ident" id="6961687">NextPart</span><span class="op" id="6961695">(</span><span class="op" id="6961696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6961699">if</span>&nbsp;<span class="ident" id="6961702">err</span>&nbsp;<span class="op" id="6961706">!=</span>&nbsp;<span class="ident" id="6961709">nil</span>&nbsp;<span class="op" id="6961713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961717">t</span><span class="op" id="6961718">.</span><span class="ident" id="6961719">Fatalf</span><span class="op" id="6961725">(</span><span class="string" id="6961726">&#34;part&nbsp;2:&nbsp;%v&#34;</span><span class="op" id="6961738">,</span>&nbsp;<span class="ident" id="6961740">err</span><span class="op" id="6961743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6961746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6961749">if</span>&nbsp;<span class="ident" id="6961752">g</span><span class="op" id="6961753">,</span>&nbsp;<span class="ident" id="6961755">e</span>&nbsp;<span class="op" id="6961757">:=</span>&nbsp;<span class="ident" id="6961760">part</span><span class="op" id="6961764">.</span><span class="ident" id="6961765">FormName</span><span class="op" id="6961773">(</span><span class="op" id="6961774">)</span><span class="op" id="6961775">,</span>&nbsp;<span class="string" id="6961777">&#34;key&#34;</span><span class="op" id="6961782">;</span>&nbsp;<span class="ident" id="6961784">g</span>&nbsp;<span class="op" id="6961786">!=</span>&nbsp;<span class="ident" id="6961789">e</span>&nbsp;<span class="op" id="6961791">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961795">t</span><span class="op" id="6961796">.</span><span class="ident" id="6961797">Errorf</span><span class="op" id="6961803">(</span><span class="string" id="6961804">&#34;part&nbsp;2:&nbsp;want&nbsp;form&nbsp;name&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="6961839">,</span>&nbsp;<span class="ident" id="6961841">e</span><span class="op" id="6961842">,</span>&nbsp;<span class="ident" id="6961844">g</span><span class="op" id="6961845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6961848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961851">slurp</span><span class="op" id="6961856">,</span>&nbsp;<span class="ident" id="6961858">err</span>&nbsp;<span class="op" id="6961862">=</span>&nbsp;<span class="ident" id="6961864">ioutil</span><span class="op" id="6961870">.</span><span class="ident" id="6961871">ReadAll</span><span class="op" id="6961878">(</span><span class="ident" id="6961879">part</span><span class="op" id="6961883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6961886">if</span>&nbsp;<span class="ident" id="6961889">err</span>&nbsp;<span class="op" id="6961893">!=</span>&nbsp;<span class="ident" id="6961896">nil</span>&nbsp;<span class="op" id="6961900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961904">t</span><span class="op" id="6961905">.</span><span class="ident" id="6961906">Fatalf</span><span class="op" id="6961912">(</span><span class="string" id="6961913">&#34;part&nbsp;2:&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="6961934">,</span>&nbsp;<span class="ident" id="6961936">err</span><span class="op" id="6961939">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6961942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6961945">if</span>&nbsp;<span class="ident" id="6961948">e</span><span class="op" id="6961949">,</span>&nbsp;<span class="ident" id="6961951">g</span>&nbsp;<span class="op" id="6961953">:=</span>&nbsp;<span class="string" id="6961956">&#34;val&#34;</span><span class="op" id="6961961">,</span>&nbsp;<span class="builtintype" id="6961963">string</span><span class="op" id="6961969">(</span><span class="ident" id="6961970">slurp</span><span class="op" id="6961975">)</span><span class="op" id="6961976">;</span>&nbsp;<span class="ident" id="6961978">e</span>&nbsp;<span class="op" id="6961980">!=</span>&nbsp;<span class="ident" id="6961983">g</span>&nbsp;<span class="op" id="6961985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6961989">t</span><span class="op" id="6961990">.</span><span class="ident" id="6961991">Errorf</span><span class="op" id="6961997">(</span><span class="string" id="6961998">&#34;part&nbsp;2:&nbsp;want&nbsp;contents&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="6962032">,</span>&nbsp;<span class="ident" id="6962034">e</span><span class="op" id="6962035">,</span>&nbsp;<span class="ident" id="6962037">g</span><span class="op" id="6962038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6962041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6962045">part</span><span class="op" id="6962049">,</span>&nbsp;<span class="ident" id="6962051">err</span>&nbsp;<span class="op" id="6962055">=</span>&nbsp;<span class="ident" id="6962057">r</span><span class="op" id="6962058">.</span><span class="ident" id="6962059">NextPart</span><span class="op" id="6962067">(</span><span class="op" id="6962068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6962071">if</span>&nbsp;<span class="ident" id="6962074">part</span>&nbsp;<span class="op" id="6962079">!=</span>&nbsp;<span class="ident" id="6962082">nil</span>&nbsp;<span class="op" id="6962086">||</span>&nbsp;<span class="ident" id="6962089">err</span>&nbsp;<span class="op" id="6962093">==</span>&nbsp;<span class="ident" id="6962096">nil</span>&nbsp;<span class="op" id="6962100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6962104">t</span><span class="op" id="6962105">.</span><span class="ident" id="6962106">Fatalf</span><span class="op" id="6962112">(</span><span class="string" id="6962113">&#34;expected&nbsp;end&nbsp;of&nbsp;parts;&nbsp;got&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="6962148">,</span>&nbsp;<span class="ident" id="6962150">part</span><span class="op" id="6962154">,</span>&nbsp;<span class="ident" id="6962156">err</span><span class="op" id="6962159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6962162">}</span><br>
<span class="lineno"></span><span class="op" id="6962164">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="6962167">func</span>&nbsp;<span class="ident" id="6962172">TestWriterSetBoundary</span><span class="op" id="6962193">(</span><span class="ident" id="6962194">t</span>&nbsp;<span class="op" id="6962196">*</span><span class="ident" id="6962197">testing</span><span class="op" id="6962204">.</span><span class="ident" id="6962205">T</span><span class="op" id="6962206">)</span>&nbsp;<span class="op" id="6962208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6962211">var</span>&nbsp;<span class="ident" id="6962215">b</span>&nbsp;<span class="ident" id="6962217">bytes</span><span class="op" id="6962222">.</span><span class="ident" id="6962223">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6962231">w</span>&nbsp;<span class="op" id="6962233">:=</span>&nbsp;<span class="ident" id="6962236">NewWriter</span><span class="op" id="6962245">(</span><span class="op" id="6962246">&amp;</span><span class="ident" id="6962247">b</span><span class="op" id="6962248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6962251">tests</span>&nbsp;<span class="op" id="6962257">:=</span>&nbsp;<span class="op" id="6962260">[</span><span class="op" id="6962261">]</span><span class="keyword" id="6962262">struct</span>&nbsp;<span class="op" id="6962269">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6962273">b</span>&nbsp;&nbsp;<span class="builtintype" id="6962276">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6962285">ok</span>&nbsp;<span class="builtintype" id="6962288">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6962294">}</span><span class="op" id="6962295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6962299">{</span><span class="string" id="6962300">&#34;abc&#34;</span><span class="op" id="6962305">,</span>&nbsp;<span class="ident" id="6962307">true</span><span class="op" id="6962311">}</span><span class="op" id="6962312">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6962316">{</span><span class="string" id="6962317">&#34;&#34;</span><span class="op" id="6962319">,</span>&nbsp;<span class="ident" id="6962321">false</span><span class="op" id="6962326">}</span><span class="op" id="6962327">,</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6962331">{</span><span class="string" id="6962332">&#34;ung√ºltig&#34;</span><span class="op" id="6962343">,</span>&nbsp;<span class="ident" id="6962345">false</span><span class="op" id="6962350">}</span><span class="op" id="6962351">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6962355">{</span><span class="string" id="6962356">&#34;!&#34;</span><span class="op" id="6962359">,</span>&nbsp;<span class="ident" id="6962361">false</span><span class="op" id="6962366">}</span><span class="op" id="6962367">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6962371">{</span><span class="ident" id="6962372">strings</span><span class="op" id="6962379">.</span><span class="ident" id="6962380">Repeat</span><span class="op" id="6962386">(</span><span class="string" id="6962387">&#34;x&#34;</span><span class="op" id="6962390">,</span>&nbsp;<span class="num" id="6962392">69</span><span class="op" id="6962394">)</span><span class="op" id="6962395">,</span>&nbsp;<span class="ident" id="6962397">true</span><span class="op" id="6962401">}</span><span class="op" id="6962402">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6962406">{</span><span class="ident" id="6962407">strings</span><span class="op" id="6962414">.</span><span class="ident" id="6962415">Repeat</span><span class="op" id="6962421">(</span><span class="string" id="6962422">&#34;x&#34;</span><span class="op" id="6962425">,</span>&nbsp;<span class="num" id="6962427">70</span><span class="op" id="6962429">)</span><span class="op" id="6962430">,</span>&nbsp;<span class="ident" id="6962432">false</span><span class="op" id="6962437">}</span><span class="op" id="6962438">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6962442">{</span><span class="string" id="6962443">&#34;bad!ascii!&#34;</span><span class="op" id="6962455">,</span>&nbsp;<span class="ident" id="6962457">false</span><span class="op" id="6962462">}</span><span class="op" id="6962463">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6962467">{</span><span class="string" id="6962468">&#34;my-separator&#34;</span><span class="op" id="6962482">,</span>&nbsp;<span class="ident" id="6962484">true</span><span class="op" id="6962488">}</span><span class="op" id="6962489">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6962492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6962495">for</span>&nbsp;<span class="ident" id="6962499">i</span><span class="op" id="6962500">,</span>&nbsp;<span class="ident" id="6962502">tt</span>&nbsp;<span class="op" id="6962505">:=</span>&nbsp;<span class="keyword" id="6962508">range</span>&nbsp;<span class="ident" id="6962514">tests</span>&nbsp;<span class="op" id="6962520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6962524">err</span>&nbsp;<span class="op" id="6962528">:=</span>&nbsp;<span class="ident" id="6962531">w</span><span class="op" id="6962532">.</span><span class="ident" id="6962533">SetBoundary</span><span class="op" id="6962544">(</span><span class="ident" id="6962545">tt</span><span class="op" id="6962547">.</span><span class="ident" id="6962548">b</span><span class="op" id="6962549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6962553">got</span>&nbsp;<span class="op" id="6962557">:=</span>&nbsp;<span class="ident" id="6962560">err</span>&nbsp;<span class="op" id="6962564">==</span>&nbsp;<span class="ident" id="6962567">nil</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6962573">if</span>&nbsp;<span class="ident" id="6962576">got</span>&nbsp;<span class="op" id="6962580">!=</span>&nbsp;<span class="ident" id="6962583">tt</span><span class="op" id="6962585">.</span><span class="ident" id="6962586">ok</span>&nbsp;<span class="op" id="6962589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6962594">t</span><span class="op" id="6962595">.</span><span class="ident" id="6962596">Errorf</span><span class="op" id="6962602">(</span><span class="string" id="6962603">&#34;%d.&nbsp;boundary&nbsp;%q&nbsp;=&nbsp;%v&nbsp;(%v);&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6962639">,</span>&nbsp;<span class="ident" id="6962641">i</span><span class="op" id="6962642">,</span>&nbsp;<span class="ident" id="6962644">tt</span><span class="op" id="6962646">.</span><span class="ident" id="6962647">b</span><span class="op" id="6962648">,</span>&nbsp;<span class="ident" id="6962650">got</span><span class="op" id="6962653">,</span>&nbsp;<span class="ident" id="6962655">err</span><span class="op" id="6962658">,</span>&nbsp;<span class="ident" id="6962660">tt</span><span class="op" id="6962662">.</span><span class="ident" id="6962663">ok</span><span class="op" id="6962665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6962669">}</span>&nbsp;<span class="keyword" id="6962671">else</span>&nbsp;<span class="keyword" id="6962676">if</span>&nbsp;<span class="ident" id="6962679">tt</span><span class="op" id="6962681">.</span><span class="ident" id="6962682">ok</span>&nbsp;<span class="op" id="6962685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6962690">got</span>&nbsp;<span class="op" id="6962694">:=</span>&nbsp;<span class="ident" id="6962697">w</span><span class="op" id="6962698">.</span><span class="ident" id="6962699">Boundary</span><span class="op" id="6962707">(</span><span class="op" id="6962708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6962713">if</span>&nbsp;<span class="ident" id="6962716">got</span>&nbsp;<span class="op" id="6962720">!=</span>&nbsp;<span class="ident" id="6962723">tt</span><span class="op" id="6962725">.</span><span class="ident" id="6962726">b</span>&nbsp;<span class="op" id="6962728">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6962734">t</span><span class="op" id="6962735">.</span><span class="ident" id="6962736">Errorf</span><span class="op" id="6962742">(</span><span class="string" id="6962743">&#34;boundary&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6962767">,</span>&nbsp;<span class="ident" id="6962769">got</span><span class="op" id="6962772">,</span>&nbsp;<span class="ident" id="6962774">tt</span><span class="op" id="6962776">.</span><span class="ident" id="6962777">b</span><span class="op" id="6962778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6962783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6962787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6962790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6962793">w</span><span class="op" id="6962794">.</span><span class="ident" id="6962795">Close</span><span class="op" id="6962800">(</span><span class="op" id="6962801">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6962804">if</span>&nbsp;<span class="ident" id="6962807">got</span>&nbsp;<span class="op" id="6962811">:=</span>&nbsp;<span class="ident" id="6962814">b</span><span class="op" id="6962815">.</span><span class="ident" id="6962816">String</span><span class="op" id="6962822">(</span><span class="op" id="6962823">)</span><span class="op" id="6962824">;</span>&nbsp;<span class="op" id="6962826">!</span><span class="ident" id="6962827">strings</span><span class="op" id="6962834">.</span><span class="ident" id="6962835">Contains</span><span class="op" id="6962843">(</span><span class="ident" id="6962844">got</span><span class="op" id="6962847">,</span>&nbsp;<span class="string" id="6962849">&#34;\r\n--my-separator--\r\n&#34;</span><span class="op" id="6962875">)</span>&nbsp;<span class="op" id="6962877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6962881">t</span><span class="op" id="6962882">.</span><span class="ident" id="6962883">Errorf</span><span class="op" id="6962889">(</span><span class="string" id="6962890">&#34;expected&nbsp;my-separator&nbsp;in&nbsp;output.&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="6962932">,</span>&nbsp;<span class="ident" id="6962934">got</span><span class="op" id="6962937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6962940">}</span><br>
<span class="lineno"></span><span class="op" id="6962942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="6962945">func</span>&nbsp;<span class="ident" id="6962950">TestWriterBoundaryGoroutines</span><span class="op" id="6962978">(</span><span class="ident" id="6962979">t</span>&nbsp;<span class="op" id="6962981">*</span><span class="ident" id="6962982">testing</span><span class="op" id="6962989">.</span><span class="ident" id="6962990">T</span><span class="op" id="6962991">)</span>&nbsp;<span class="op" id="6962993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6962996">//&nbsp;Verify&nbsp;there&#39;s&nbsp;no&nbsp;data&nbsp;race&nbsp;accessing&nbsp;any&nbsp;lazy&nbsp;boundary&nbsp;if&nbsp;it&#39;s&nbsp;used&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6963072">//&nbsp;different&nbsp;goroutines.&nbsp;This&nbsp;was&nbsp;previously&nbsp;broken&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6963128">//&nbsp;https://codereview.appspot.com/95760043/&nbsp;and&nbsp;reverted&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6963189">//&nbsp;https://codereview.appspot.com/117600043/</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6963235">w</span>&nbsp;<span class="op" id="6963237">:=</span>&nbsp;<span class="ident" id="6963240">NewWriter</span><span class="op" id="6963249">(</span><span class="ident" id="6963250">ioutil</span><span class="op" id="6963256">.</span><span class="ident" id="6963257">Discard</span><span class="op" id="6963264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6963267">done</span>&nbsp;<span class="op" id="6963272">:=</span>&nbsp;<span class="builtinfunc" id="6963275">make</span><span class="op" id="6963279">(</span><span class="keyword" id="6963280">chan</span>&nbsp;<span class="builtintype" id="6963285">int</span><span class="op" id="6963288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6963291">go</span>&nbsp;<span class="keyword" id="6963294">func</span><span class="op" id="6963298">(</span><span class="op" id="6963299">)</span>&nbsp;<span class="op" id="6963301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6963305">w</span><span class="op" id="6963306">.</span><span class="ident" id="6963307">CreateFormField</span><span class="op" id="6963322">(</span><span class="string" id="6963323">&#34;foo&#34;</span><span class="op" id="6963328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6963332">done</span>&nbsp;<span class="op" id="6963337">&lt;-</span>&nbsp;<span class="num" id="6963340">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6963343">}</span><span class="op" id="6963344">(</span><span class="op" id="6963345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6963348">w</span><span class="op" id="6963349">.</span><span class="ident" id="6963350">Boundary</span><span class="op" id="6963358">(</span><span class="op" id="6963359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6963362">&lt;-</span><span class="ident" id="6963364">done</span><br>
<span class="lineno"></span><span class="op" id="6963369">}</span>
</div>
</body>
</html>
