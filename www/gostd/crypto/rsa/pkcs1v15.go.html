<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rsa</h2>
<ul>
<li><a href="/gostd/crypto/rsa/pkcs1v15.go.html" class="current">pkcs1v15.go</a></li>
<li><a href="/gostd/crypto/rsa/pkcs1v15_test.go.html">pkcs1v15_test.go</a></li>
<li><a href="/gostd/crypto/rsa/pss.go.html">pss.go</a></li>
<li><a href="/gostd/crypto/rsa/pss_test.go.html">pss_test.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa.go.html">rsa.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa_test.go.html">rsa_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4789746">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4789801">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4789855">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4789906">package</span>&nbsp;<span class="ident" id="4789914">rsa</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4789919">import</span>&nbsp;<span class="op" id="4789926">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4789929">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4789939">&#34;crypto/subtle&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4789956">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4789966">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4789972">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="4789983">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="4789986">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;encryption&nbsp;and&nbsp;decryption&nbsp;using&nbsp;PKCS#1&nbsp;v1.5&nbsp;padding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4790064">//&nbsp;EncryptPKCS1v15&nbsp;encrypts&nbsp;the&nbsp;given&nbsp;message&nbsp;with&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4790160">//&nbsp;The&nbsp;message&nbsp;must&nbsp;be&nbsp;no&nbsp;longer&nbsp;than&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;public&nbsp;modulus&nbsp;minus&nbsp;11&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="4790247">//&nbsp;WARNING:&nbsp;use&nbsp;of&nbsp;this&nbsp;function&nbsp;to&nbsp;encrypt&nbsp;plaintexts&nbsp;other&nbsp;than&nbsp;session&nbsp;keys</span><br>
<span class="lineno">20</span><span class="comment" id="4790326">//&nbsp;is&nbsp;dangerous.&nbsp;Use&nbsp;RSA&nbsp;OAEP&nbsp;in&nbsp;new&nbsp;protocols.</span><br>
<span class="lineno"></span><span class="keyword" id="4790374">func</span>&nbsp;<span class="ident" id="4790379">EncryptPKCS1v15</span><span class="op" id="4790394">(</span><span class="ident" id="4790395">rand</span>&nbsp;<span class="ident" id="4790400">io</span><span class="op" id="4790402">.</span><span class="ident" id="4790403">Reader</span><span class="op" id="4790409">,</span>&nbsp;<span class="ident" id="4790411">pub</span>&nbsp;<span class="op" id="4790415">*</span><span class="ident" id="4790416">PublicKey</span><span class="op" id="4790425">,</span>&nbsp;<span class="ident" id="4790427">msg</span>&nbsp;<span class="op" id="4790431">[</span><span class="op" id="4790432">]</span><span class="builtintype" id="4790433">byte</span><span class="op" id="4790437">)</span>&nbsp;<span class="op" id="4790439">(</span><span class="ident" id="4790440">out</span>&nbsp;<span class="op" id="4790444">[</span><span class="op" id="4790445">]</span><span class="builtintype" id="4790446">byte</span><span class="op" id="4790450">,</span>&nbsp;<span class="ident" id="4790452">err</span>&nbsp;<span class="builtintype" id="4790456">error</span><span class="op" id="4790461">)</span>&nbsp;<span class="op" id="4790463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790466">if</span>&nbsp;<span class="ident" id="4790469">err</span>&nbsp;<span class="op" id="4790473">:=</span>&nbsp;<span class="ident" id="4790476">checkPub</span><span class="op" id="4790484">(</span><span class="ident" id="4790485">pub</span><span class="op" id="4790488">)</span><span class="op" id="4790489">;</span>&nbsp;<span class="ident" id="4790491">err</span>&nbsp;<span class="op" id="4790495">!=</span>&nbsp;<span class="ident" id="4790498">nil</span>&nbsp;<span class="op" id="4790502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790506">return</span>&nbsp;<span class="ident" id="4790513">nil</span><span class="op" id="4790516">,</span>&nbsp;<span class="ident" id="4790518">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4790523">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790526">k</span>&nbsp;<span class="op" id="4790528">:=</span>&nbsp;<span class="op" id="4790531">(</span><span class="ident" id="4790532">pub</span><span class="op" id="4790535">.</span><span class="ident" id="4790536">N</span><span class="op" id="4790537">.</span><span class="ident" id="4790538">BitLen</span><span class="op" id="4790544">(</span><span class="op" id="4790545">)</span>&nbsp;<span class="op" id="4790547">+</span>&nbsp;<span class="num" id="4790549">7</span><span class="op" id="4790550">)</span>&nbsp;<span class="op" id="4790552">/</span>&nbsp;<span class="num" id="4790554">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790557">if</span>&nbsp;<span class="builtinfunc" id="4790560">len</span><span class="op" id="4790563">(</span><span class="ident" id="4790564">msg</span><span class="op" id="4790567">)</span>&nbsp;<span class="op" id="4790569">&gt;</span>&nbsp;<span class="ident" id="4790571">k</span><span class="op" id="4790572">-</span><span class="num" id="4790573">11</span>&nbsp;<span class="op" id="4790576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790580">err</span>&nbsp;<span class="op" id="4790584">=</span>&nbsp;<span class="ident" id="4790586">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790606">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4790614">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4790618">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x02&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;M</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790659">em</span>&nbsp;<span class="op" id="4790662">:=</span>&nbsp;<span class="builtinfunc" id="4790665">make</span><span class="op" id="4790669">(</span><span class="op" id="4790670">[</span><span class="op" id="4790671">]</span><span class="builtintype" id="4790672">byte</span><span class="op" id="4790676">,</span>&nbsp;<span class="ident" id="4790678">k</span><span class="op" id="4790679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790682">em</span><span class="op" id="4790684">[</span><span class="num" id="4790685">1</span><span class="op" id="4790686">]</span>&nbsp;<span class="op" id="4790688">=</span>&nbsp;<span class="num" id="4790690">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790693">ps</span><span class="op" id="4790695">,</span>&nbsp;<span class="ident" id="4790697">mm</span>&nbsp;<span class="op" id="4790700">:=</span>&nbsp;<span class="ident" id="4790703">em</span><span class="op" id="4790705">[</span><span class="num" id="4790706">2</span><span class="op" id="4790707">:</span><span class="builtinfunc" id="4790708">len</span><span class="op" id="4790711">(</span><span class="ident" id="4790712">em</span><span class="op" id="4790714">)</span><span class="op" id="4790715">-</span><span class="builtinfunc" id="4790716">len</span><span class="op" id="4790719">(</span><span class="ident" id="4790720">msg</span><span class="op" id="4790723">)</span><span class="op" id="4790724">-</span><span class="num" id="4790725">1</span><span class="op" id="4790726">]</span><span class="op" id="4790727">,</span>&nbsp;<span class="ident" id="4790729">em</span><span class="op" id="4790731">[</span><span class="builtinfunc" id="4790732">len</span><span class="op" id="4790735">(</span><span class="ident" id="4790736">em</span><span class="op" id="4790738">)</span><span class="op" id="4790739">-</span><span class="builtinfunc" id="4790740">len</span><span class="op" id="4790743">(</span><span class="ident" id="4790744">msg</span><span class="op" id="4790747">)</span><span class="op" id="4790748">:</span><span class="op" id="4790749">]</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790752">err</span>&nbsp;<span class="op" id="4790756">=</span>&nbsp;<span class="ident" id="4790758">nonZeroRandomBytes</span><span class="op" id="4790776">(</span><span class="ident" id="4790777">ps</span><span class="op" id="4790779">,</span>&nbsp;<span class="ident" id="4790781">rand</span><span class="op" id="4790785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790788">if</span>&nbsp;<span class="ident" id="4790791">err</span>&nbsp;<span class="op" id="4790795">!=</span>&nbsp;<span class="ident" id="4790798">nil</span>&nbsp;<span class="op" id="4790802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790806">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4790814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790817">em</span><span class="op" id="4790819">[</span><span class="builtinfunc" id="4790820">len</span><span class="op" id="4790823">(</span><span class="ident" id="4790824">em</span><span class="op" id="4790826">)</span><span class="op" id="4790827">-</span><span class="builtinfunc" id="4790828">len</span><span class="op" id="4790831">(</span><span class="ident" id="4790832">msg</span><span class="op" id="4790835">)</span><span class="op" id="4790836">-</span><span class="num" id="4790837">1</span><span class="op" id="4790838">]</span>&nbsp;<span class="op" id="4790840">=</span>&nbsp;<span class="num" id="4790842">0</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4790845">copy</span><span class="op" id="4790849">(</span><span class="ident" id="4790850">mm</span><span class="op" id="4790852">,</span>&nbsp;<span class="ident" id="4790854">msg</span><span class="op" id="4790857">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790861">m</span>&nbsp;<span class="op" id="4790863">:=</span>&nbsp;<span class="builtinfunc" id="4790866">new</span><span class="op" id="4790869">(</span><span class="ident" id="4790870">big</span><span class="op" id="4790873">.</span><span class="ident" id="4790874">Int</span><span class="op" id="4790877">)</span><span class="op" id="4790878">.</span><span class="ident" id="4790879">SetBytes</span><span class="op" id="4790887">(</span><span class="ident" id="4790888">em</span><span class="op" id="4790890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790893">c</span>&nbsp;<span class="op" id="4790895">:=</span>&nbsp;<span class="ident" id="4790898">encrypt</span><span class="op" id="4790905">(</span><span class="builtinfunc" id="4790906">new</span><span class="op" id="4790909">(</span><span class="ident" id="4790910">big</span><span class="op" id="4790913">.</span><span class="ident" id="4790914">Int</span><span class="op" id="4790917">)</span><span class="op" id="4790918">,</span>&nbsp;<span class="ident" id="4790920">pub</span><span class="op" id="4790923">,</span>&nbsp;<span class="ident" id="4790925">m</span><span class="op" id="4790926">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790930">copyWithLeftPad</span><span class="op" id="4790945">(</span><span class="ident" id="4790946">em</span><span class="op" id="4790948">,</span>&nbsp;<span class="ident" id="4790950">c</span><span class="op" id="4790951">.</span><span class="ident" id="4790952">Bytes</span><span class="op" id="4790957">(</span><span class="op" id="4790958">)</span><span class="op" id="4790959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790962">out</span>&nbsp;<span class="op" id="4790966">=</span>&nbsp;<span class="ident" id="4790968">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790972">return</span><br>
<span class="lineno"></span><span class="op" id="4790979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4790982">//&nbsp;DecryptPKCS1v15&nbsp;decrypts&nbsp;a&nbsp;plaintext&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4791073">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="keyword" id="4791151">func</span>&nbsp;<span class="ident" id="4791156">DecryptPKCS1v15</span><span class="op" id="4791171">(</span><span class="ident" id="4791172">rand</span>&nbsp;<span class="ident" id="4791177">io</span><span class="op" id="4791179">.</span><span class="ident" id="4791180">Reader</span><span class="op" id="4791186">,</span>&nbsp;<span class="ident" id="4791188">priv</span>&nbsp;<span class="op" id="4791193">*</span><span class="ident" id="4791194">PrivateKey</span><span class="op" id="4791204">,</span>&nbsp;<span class="ident" id="4791206">ciphertext</span>&nbsp;<span class="op" id="4791217">[</span><span class="op" id="4791218">]</span><span class="builtintype" id="4791219">byte</span><span class="op" id="4791223">)</span>&nbsp;<span class="op" id="4791225">(</span><span class="ident" id="4791226">out</span>&nbsp;<span class="op" id="4791230">[</span><span class="op" id="4791231">]</span><span class="builtintype" id="4791232">byte</span><span class="op" id="4791236">,</span>&nbsp;<span class="ident" id="4791238">err</span>&nbsp;<span class="builtintype" id="4791242">error</span><span class="op" id="4791247">)</span>&nbsp;<span class="op" id="4791249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4791252">if</span>&nbsp;<span class="ident" id="4791255">err</span>&nbsp;<span class="op" id="4791259">:=</span>&nbsp;<span class="ident" id="4791262">checkPub</span><span class="op" id="4791270">(</span><span class="op" id="4791271">&amp;</span><span class="ident" id="4791272">priv</span><span class="op" id="4791276">.</span><span class="ident" id="4791277">PublicKey</span><span class="op" id="4791286">)</span><span class="op" id="4791287">;</span>&nbsp;<span class="ident" id="4791289">err</span>&nbsp;<span class="op" id="4791293">!=</span>&nbsp;<span class="ident" id="4791296">nil</span>&nbsp;<span class="op" id="4791300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4791304">return</span>&nbsp;<span class="ident" id="4791311">nil</span><span class="op" id="4791314">,</span>&nbsp;<span class="ident" id="4791316">err</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4791321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4791324">valid</span><span class="op" id="4791329">,</span>&nbsp;<span class="ident" id="4791331">out</span><span class="op" id="4791334">,</span>&nbsp;<span class="ident" id="4791336">index</span><span class="op" id="4791341">,</span>&nbsp;<span class="ident" id="4791343">err</span>&nbsp;<span class="op" id="4791347">:=</span>&nbsp;<span class="ident" id="4791350">decryptPKCS1v15</span><span class="op" id="4791365">(</span><span class="ident" id="4791366">rand</span><span class="op" id="4791370">,</span>&nbsp;<span class="ident" id="4791372">priv</span><span class="op" id="4791376">,</span>&nbsp;<span class="ident" id="4791378">ciphertext</span><span class="op" id="4791388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4791391">if</span>&nbsp;<span class="ident" id="4791394">err</span>&nbsp;<span class="op" id="4791398">!=</span>&nbsp;<span class="ident" id="4791401">nil</span>&nbsp;<span class="op" id="4791405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4791409">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4791417">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4791420">if</span>&nbsp;<span class="ident" id="4791423">valid</span>&nbsp;<span class="op" id="4791429">==</span>&nbsp;<span class="num" id="4791432">0</span>&nbsp;<span class="op" id="4791434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4791438">return</span>&nbsp;<span class="ident" id="4791445">nil</span><span class="op" id="4791448">,</span>&nbsp;<span class="ident" id="4791450">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4791465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4791468">out</span>&nbsp;<span class="op" id="4791472">=</span>&nbsp;<span class="ident" id="4791474">out</span><span class="op" id="4791477">[</span><span class="ident" id="4791478">index</span><span class="op" id="4791483">:</span><span class="op" id="4791484">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4791487">return</span><br>
<span class="lineno">65</span><span class="op" id="4791494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4791497">//&nbsp;DecryptPKCS1v15SessionKey&nbsp;decrypts&nbsp;a&nbsp;session&nbsp;key&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4791600">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="comment" id="4791678">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;ciphertext&nbsp;is&nbsp;the&nbsp;wrong&nbsp;length&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="4791749">//&nbsp;ciphertext&nbsp;is&nbsp;greater&nbsp;than&nbsp;the&nbsp;public&nbsp;modulus.&nbsp;Otherwise,&nbsp;no&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4791822">//&nbsp;returned.&nbsp;If&nbsp;the&nbsp;padding&nbsp;is&nbsp;valid,&nbsp;the&nbsp;resulting&nbsp;plaintext&nbsp;message&nbsp;is&nbsp;copied</span><br>
<span class="lineno"></span><span class="comment" id="4791902">//&nbsp;into&nbsp;key.&nbsp;Otherwise,&nbsp;key&nbsp;is&nbsp;unchanged.&nbsp;These&nbsp;alternatives&nbsp;occur&nbsp;in&nbsp;constant</span><br>
<span class="lineno"></span><span class="comment" id="4791981">//&nbsp;time.&nbsp;It&nbsp;is&nbsp;intended&nbsp;that&nbsp;the&nbsp;user&nbsp;of&nbsp;this&nbsp;function&nbsp;generate&nbsp;a&nbsp;random</span><br>
<span class="lineno"></span><span class="comment" id="4792054">//&nbsp;session&nbsp;key&nbsp;beforehand&nbsp;and&nbsp;continue&nbsp;the&nbsp;protocol&nbsp;with&nbsp;the&nbsp;resulting&nbsp;value.</span><br>
<span class="lineno">75</span><span class="comment" id="4792132">//&nbsp;This&nbsp;will&nbsp;remove&nbsp;any&nbsp;possibility&nbsp;that&nbsp;an&nbsp;attacker&nbsp;can&nbsp;learn&nbsp;any&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="4792211">//&nbsp;about&nbsp;the&nbsp;plaintext.</span><br>
<span class="lineno"></span><span class="comment" id="4792235">//&nbsp;See&nbsp;``Chosen&nbsp;Ciphertext&nbsp;Attacks&nbsp;Against&nbsp;Protocols&nbsp;Based&nbsp;on&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span><span class="comment" id="4792305">//&nbsp;Encryption&nbsp;Standard&nbsp;PKCS&nbsp;#1&#39;&#39;,&nbsp;Daniel&nbsp;Bleichenbacher,&nbsp;Advances&nbsp;in&nbsp;Cryptology</span><br>
<span class="lineno"></span><span class="comment" id="4792385">//&nbsp;(Crypto&nbsp;&#39;98).</span><br>
<span class="lineno">80</span><span class="keyword" id="4792402">func</span>&nbsp;<span class="ident" id="4792407">DecryptPKCS1v15SessionKey</span><span class="op" id="4792432">(</span><span class="ident" id="4792433">rand</span>&nbsp;<span class="ident" id="4792438">io</span><span class="op" id="4792440">.</span><span class="ident" id="4792441">Reader</span><span class="op" id="4792447">,</span>&nbsp;<span class="ident" id="4792449">priv</span>&nbsp;<span class="op" id="4792454">*</span><span class="ident" id="4792455">PrivateKey</span><span class="op" id="4792465">,</span>&nbsp;<span class="ident" id="4792467">ciphertext</span>&nbsp;<span class="op" id="4792478">[</span><span class="op" id="4792479">]</span><span class="builtintype" id="4792480">byte</span><span class="op" id="4792484">,</span>&nbsp;<span class="ident" id="4792486">key</span>&nbsp;<span class="op" id="4792490">[</span><span class="op" id="4792491">]</span><span class="builtintype" id="4792492">byte</span><span class="op" id="4792496">)</span>&nbsp;<span class="op" id="4792498">(</span><span class="ident" id="4792499">err</span>&nbsp;<span class="builtintype" id="4792503">error</span><span class="op" id="4792508">)</span>&nbsp;<span class="op" id="4792510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4792513">if</span>&nbsp;<span class="ident" id="4792516">err</span>&nbsp;<span class="op" id="4792520">:=</span>&nbsp;<span class="ident" id="4792523">checkPub</span><span class="op" id="4792531">(</span><span class="op" id="4792532">&amp;</span><span class="ident" id="4792533">priv</span><span class="op" id="4792537">.</span><span class="ident" id="4792538">PublicKey</span><span class="op" id="4792547">)</span><span class="op" id="4792548">;</span>&nbsp;<span class="ident" id="4792550">err</span>&nbsp;<span class="op" id="4792554">!=</span>&nbsp;<span class="ident" id="4792557">nil</span>&nbsp;<span class="op" id="4792561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4792565">return</span>&nbsp;<span class="ident" id="4792572">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4792577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4792580">k</span>&nbsp;<span class="op" id="4792582">:=</span>&nbsp;<span class="op" id="4792585">(</span><span class="ident" id="4792586">priv</span><span class="op" id="4792590">.</span><span class="ident" id="4792591">N</span><span class="op" id="4792592">.</span><span class="ident" id="4792593">BitLen</span><span class="op" id="4792599">(</span><span class="op" id="4792600">)</span>&nbsp;<span class="op" id="4792602">+</span>&nbsp;<span class="num" id="4792604">7</span><span class="op" id="4792605">)</span>&nbsp;<span class="op" id="4792607">/</span>&nbsp;<span class="num" id="4792609">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4792612">if</span>&nbsp;<span class="ident" id="4792615">k</span><span class="op" id="4792616">-</span><span class="op" id="4792617">(</span><span class="builtinfunc" id="4792618">len</span><span class="op" id="4792621">(</span><span class="ident" id="4792622">key</span><span class="op" id="4792625">)</span><span class="op" id="4792626">+</span><span class="num" id="4792627">3</span><span class="op" id="4792628">+</span><span class="num" id="4792629">8</span><span class="op" id="4792630">)</span>&nbsp;<span class="op" id="4792632">&lt;</span>&nbsp;<span class="num" id="4792634">0</span>&nbsp;<span class="op" id="4792636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4792640">return</span>&nbsp;<span class="ident" id="4792647">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4792662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4792666">valid</span><span class="op" id="4792671">,</span>&nbsp;<span class="ident" id="4792673">em</span><span class="op" id="4792675">,</span>&nbsp;<span class="ident" id="4792677">index</span><span class="op" id="4792682">,</span>&nbsp;<span class="ident" id="4792684">err</span>&nbsp;<span class="op" id="4792688">:=</span>&nbsp;<span class="ident" id="4792691">decryptPKCS1v15</span><span class="op" id="4792706">(</span><span class="ident" id="4792707">rand</span><span class="op" id="4792711">,</span>&nbsp;<span class="ident" id="4792713">priv</span><span class="op" id="4792717">,</span>&nbsp;<span class="ident" id="4792719">ciphertext</span><span class="op" id="4792729">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4792732">if</span>&nbsp;<span class="ident" id="4792735">err</span>&nbsp;<span class="op" id="4792739">!=</span>&nbsp;<span class="ident" id="4792742">nil</span>&nbsp;<span class="op" id="4792746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4792750">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4792758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4792762">if</span>&nbsp;<span class="builtinfunc" id="4792765">len</span><span class="op" id="4792768">(</span><span class="ident" id="4792769">em</span><span class="op" id="4792771">)</span>&nbsp;<span class="op" id="4792773">!=</span>&nbsp;<span class="ident" id="4792776">k</span>&nbsp;<span class="op" id="4792778">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4792782">//&nbsp;This&nbsp;should&nbsp;be&nbsp;impossible&nbsp;because&nbsp;decryptPKCS1v15&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4792844">//&nbsp;returns&nbsp;the&nbsp;full&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4792873">return</span>&nbsp;<span class="ident" id="4792880">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4792895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4792899">valid</span>&nbsp;<span class="op" id="4792905">&amp;=</span>&nbsp;<span class="ident" id="4792908">subtle</span><span class="op" id="4792914">.</span><span class="ident" id="4792915">ConstantTimeEq</span><span class="op" id="4792929">(</span><span class="builtintype" id="4792930">int32</span><span class="op" id="4792935">(</span><span class="builtinfunc" id="4792936">len</span><span class="op" id="4792939">(</span><span class="ident" id="4792940">em</span><span class="op" id="4792942">)</span><span class="op" id="4792943">-</span><span class="ident" id="4792944">index</span><span class="op" id="4792949">)</span><span class="op" id="4792950">,</span>&nbsp;<span class="builtintype" id="4792952">int32</span><span class="op" id="4792957">(</span><span class="builtinfunc" id="4792958">len</span><span class="op" id="4792961">(</span><span class="ident" id="4792962">key</span><span class="op" id="4792965">)</span><span class="op" id="4792966">)</span><span class="op" id="4792967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4792970">subtle</span><span class="op" id="4792976">.</span><span class="ident" id="4792977">ConstantTimeCopy</span><span class="op" id="4792993">(</span><span class="ident" id="4792994">valid</span><span class="op" id="4792999">,</span>&nbsp;<span class="ident" id="4793001">key</span><span class="op" id="4793004">,</span>&nbsp;<span class="ident" id="4793006">em</span><span class="op" id="4793008">[</span><span class="builtinfunc" id="4793009">len</span><span class="op" id="4793012">(</span><span class="ident" id="4793013">em</span><span class="op" id="4793015">)</span><span class="op" id="4793016">-</span><span class="builtinfunc" id="4793017">len</span><span class="op" id="4793020">(</span><span class="ident" id="4793021">key</span><span class="op" id="4793024">)</span><span class="op" id="4793025">:</span><span class="op" id="4793026">]</span><span class="op" id="4793027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4793030">return</span><br>
<span class="lineno"></span><span class="op" id="4793037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4793040">//&nbsp;decryptPKCS1v15&nbsp;decrypts&nbsp;ciphertext&nbsp;using&nbsp;priv&nbsp;and&nbsp;blinds&nbsp;the&nbsp;operation&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4793118">//&nbsp;rand&nbsp;is&nbsp;not&nbsp;nil.&nbsp;It&nbsp;returns&nbsp;one&nbsp;or&nbsp;zero&nbsp;in&nbsp;valid&nbsp;that&nbsp;indicates&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4793197">//&nbsp;plaintext&nbsp;was&nbsp;correctly&nbsp;structured.&nbsp;In&nbsp;either&nbsp;case,&nbsp;the&nbsp;plaintext&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4793269">//&nbsp;returned&nbsp;in&nbsp;em&nbsp;so&nbsp;that&nbsp;it&nbsp;may&nbsp;be&nbsp;read&nbsp;independently&nbsp;of&nbsp;whether&nbsp;it&nbsp;was&nbsp;valid</span><br>
<span class="lineno"></span><span class="comment" id="4793348">//&nbsp;in&nbsp;order&nbsp;to&nbsp;maintain&nbsp;constant&nbsp;memory&nbsp;access&nbsp;patterns.&nbsp;If&nbsp;the&nbsp;plaintext&nbsp;was</span><br>
<span class="lineno">110</span><span class="comment" id="4793426">//&nbsp;valid&nbsp;then&nbsp;index&nbsp;contains&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;original&nbsp;message&nbsp;in&nbsp;em.</span><br>
<span class="lineno"></span><span class="keyword" id="4793496">func</span>&nbsp;<span class="ident" id="4793501">decryptPKCS1v15</span><span class="op" id="4793516">(</span><span class="ident" id="4793517">rand</span>&nbsp;<span class="ident" id="4793522">io</span><span class="op" id="4793524">.</span><span class="ident" id="4793525">Reader</span><span class="op" id="4793531">,</span>&nbsp;<span class="ident" id="4793533">priv</span>&nbsp;<span class="op" id="4793538">*</span><span class="ident" id="4793539">PrivateKey</span><span class="op" id="4793549">,</span>&nbsp;<span class="ident" id="4793551">ciphertext</span>&nbsp;<span class="op" id="4793562">[</span><span class="op" id="4793563">]</span><span class="builtintype" id="4793564">byte</span><span class="op" id="4793568">)</span>&nbsp;<span class="op" id="4793570">(</span><span class="ident" id="4793571">valid</span>&nbsp;<span class="builtintype" id="4793577">int</span><span class="op" id="4793580">,</span>&nbsp;<span class="ident" id="4793582">em</span>&nbsp;<span class="op" id="4793585">[</span><span class="op" id="4793586">]</span><span class="builtintype" id="4793587">byte</span><span class="op" id="4793591">,</span>&nbsp;<span class="ident" id="4793593">index</span>&nbsp;<span class="builtintype" id="4793599">int</span><span class="op" id="4793602">,</span>&nbsp;<span class="ident" id="4793604">err</span>&nbsp;<span class="builtintype" id="4793608">error</span><span class="op" id="4793613">)</span>&nbsp;<span class="op" id="4793615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4793618">k</span>&nbsp;<span class="op" id="4793620">:=</span>&nbsp;<span class="op" id="4793623">(</span><span class="ident" id="4793624">priv</span><span class="op" id="4793628">.</span><span class="ident" id="4793629">N</span><span class="op" id="4793630">.</span><span class="ident" id="4793631">BitLen</span><span class="op" id="4793637">(</span><span class="op" id="4793638">)</span>&nbsp;<span class="op" id="4793640">+</span>&nbsp;<span class="num" id="4793642">7</span><span class="op" id="4793643">)</span>&nbsp;<span class="op" id="4793645">/</span>&nbsp;<span class="num" id="4793647">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4793650">if</span>&nbsp;<span class="ident" id="4793653">k</span>&nbsp;<span class="op" id="4793655">&lt;</span>&nbsp;<span class="num" id="4793657">11</span>&nbsp;<span class="op" id="4793660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4793664">err</span>&nbsp;<span class="op" id="4793668">=</span>&nbsp;<span class="ident" id="4793670">ErrDecryption</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4793686">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4793694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4793698">c</span>&nbsp;<span class="op" id="4793700">:=</span>&nbsp;<span class="builtinfunc" id="4793703">new</span><span class="op" id="4793706">(</span><span class="ident" id="4793707">big</span><span class="op" id="4793710">.</span><span class="ident" id="4793711">Int</span><span class="op" id="4793714">)</span><span class="op" id="4793715">.</span><span class="ident" id="4793716">SetBytes</span><span class="op" id="4793724">(</span><span class="ident" id="4793725">ciphertext</span><span class="op" id="4793735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4793738">m</span><span class="op" id="4793739">,</span>&nbsp;<span class="ident" id="4793741">err</span>&nbsp;<span class="op" id="4793745">:=</span>&nbsp;<span class="ident" id="4793748">decrypt</span><span class="op" id="4793755">(</span><span class="ident" id="4793756">rand</span><span class="op" id="4793760">,</span>&nbsp;<span class="ident" id="4793762">priv</span><span class="op" id="4793766">,</span>&nbsp;<span class="ident" id="4793768">c</span><span class="op" id="4793769">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4793772">if</span>&nbsp;<span class="ident" id="4793775">err</span>&nbsp;<span class="op" id="4793779">!=</span>&nbsp;<span class="ident" id="4793782">nil</span>&nbsp;<span class="op" id="4793786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4793790">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4793798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4793802">em</span>&nbsp;<span class="op" id="4793805">=</span>&nbsp;<span class="ident" id="4793807">leftPad</span><span class="op" id="4793814">(</span><span class="ident" id="4793815">m</span><span class="op" id="4793816">.</span><span class="ident" id="4793817">Bytes</span><span class="op" id="4793822">(</span><span class="op" id="4793823">)</span><span class="op" id="4793824">,</span>&nbsp;<span class="ident" id="4793826">k</span><span class="op" id="4793827">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4793830">firstByteIsZero</span>&nbsp;<span class="op" id="4793846">:=</span>&nbsp;<span class="ident" id="4793849">subtle</span><span class="op" id="4793855">.</span><span class="ident" id="4793856">ConstantTimeByteEq</span><span class="op" id="4793874">(</span><span class="ident" id="4793875">em</span><span class="op" id="4793877">[</span><span class="num" id="4793878">0</span><span class="op" id="4793879">]</span><span class="op" id="4793880">,</span>&nbsp;<span class="num" id="4793882">0</span><span class="op" id="4793883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4793886">secondByteIsTwo</span>&nbsp;<span class="op" id="4793902">:=</span>&nbsp;<span class="ident" id="4793905">subtle</span><span class="op" id="4793911">.</span><span class="ident" id="4793912">ConstantTimeByteEq</span><span class="op" id="4793930">(</span><span class="ident" id="4793931">em</span><span class="op" id="4793933">[</span><span class="num" id="4793934">1</span><span class="op" id="4793935">]</span><span class="op" id="4793936">,</span>&nbsp;<span class="num" id="4793938">2</span><span class="op" id="4793939">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4793943">//&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;plaintext&nbsp;must&nbsp;be&nbsp;a&nbsp;string&nbsp;of&nbsp;non-zero&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4794014">//&nbsp;octets,&nbsp;followed&nbsp;by&nbsp;a&nbsp;0,&nbsp;followed&nbsp;by&nbsp;the&nbsp;message.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4794068">//&nbsp;&nbsp;&nbsp;lookingForIndex:&nbsp;1&nbsp;iff&nbsp;we&nbsp;are&nbsp;still&nbsp;looking&nbsp;for&nbsp;the&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4794132">//&nbsp;&nbsp;&nbsp;index:&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;first&nbsp;zero&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4794180">lookingForIndex</span>&nbsp;<span class="op" id="4794196">:=</span>&nbsp;<span class="num" id="4794199">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4794203">for</span>&nbsp;<span class="ident" id="4794207">i</span>&nbsp;<span class="op" id="4794209">:=</span>&nbsp;<span class="num" id="4794212">2</span><span class="op" id="4794213">;</span>&nbsp;<span class="ident" id="4794215">i</span>&nbsp;<span class="op" id="4794217">&lt;</span>&nbsp;<span class="builtinfunc" id="4794219">len</span><span class="op" id="4794222">(</span><span class="ident" id="4794223">em</span><span class="op" id="4794225">)</span><span class="op" id="4794226">;</span>&nbsp;<span class="ident" id="4794228">i</span><span class="op" id="4794229">++</span>&nbsp;<span class="op" id="4794232">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4794236">equals0</span>&nbsp;<span class="op" id="4794244">:=</span>&nbsp;<span class="ident" id="4794247">subtle</span><span class="op" id="4794253">.</span><span class="ident" id="4794254">ConstantTimeByteEq</span><span class="op" id="4794272">(</span><span class="ident" id="4794273">em</span><span class="op" id="4794275">[</span><span class="ident" id="4794276">i</span><span class="op" id="4794277">]</span><span class="op" id="4794278">,</span>&nbsp;<span class="num" id="4794280">0</span><span class="op" id="4794281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4794285">index</span>&nbsp;<span class="op" id="4794291">=</span>&nbsp;<span class="ident" id="4794293">subtle</span><span class="op" id="4794299">.</span><span class="ident" id="4794300">ConstantTimeSelect</span><span class="op" id="4794318">(</span><span class="ident" id="4794319">lookingForIndex</span><span class="op" id="4794334">&amp;</span><span class="ident" id="4794335">equals0</span><span class="op" id="4794342">,</span>&nbsp;<span class="ident" id="4794344">i</span><span class="op" id="4794345">,</span>&nbsp;<span class="ident" id="4794347">index</span><span class="op" id="4794352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4794356">lookingForIndex</span>&nbsp;<span class="op" id="4794372">=</span>&nbsp;<span class="ident" id="4794374">subtle</span><span class="op" id="4794380">.</span><span class="ident" id="4794381">ConstantTimeSelect</span><span class="op" id="4794399">(</span><span class="ident" id="4794400">equals0</span><span class="op" id="4794407">,</span>&nbsp;<span class="num" id="4794409">0</span><span class="op" id="4794410">,</span>&nbsp;<span class="ident" id="4794412">lookingForIndex</span><span class="op" id="4794427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4794430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4794434">//&nbsp;The&nbsp;PS&nbsp;padding&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;8&nbsp;bytes&nbsp;long,&nbsp;and&nbsp;it&nbsp;starts&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4794502">//&nbsp;bytes&nbsp;into&nbsp;em.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4794521">validPS</span>&nbsp;<span class="op" id="4794529">:=</span>&nbsp;<span class="ident" id="4794532">subtle</span><span class="op" id="4794538">.</span><span class="ident" id="4794539">ConstantTimeLessOrEq</span><span class="op" id="4794559">(</span><span class="num" id="4794560">2</span><span class="op" id="4794561">+</span><span class="num" id="4794562">8</span><span class="op" id="4794563">,</span>&nbsp;<span class="ident" id="4794565">index</span><span class="op" id="4794570">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4794574">valid</span>&nbsp;<span class="op" id="4794580">=</span>&nbsp;<span class="ident" id="4794582">firstByteIsZero</span>&nbsp;<span class="op" id="4794598">&amp;</span>&nbsp;<span class="ident" id="4794600">secondByteIsTwo</span>&nbsp;<span class="op" id="4794616">&amp;</span>&nbsp;<span class="op" id="4794618">(</span><span class="op" id="4794619">^</span><span class="ident" id="4794620">lookingForIndex</span>&nbsp;<span class="op" id="4794636">&amp;</span>&nbsp;<span class="num" id="4794638">1</span><span class="op" id="4794639">)</span>&nbsp;<span class="op" id="4794641">&amp;</span>&nbsp;<span class="ident" id="4794643">validPS</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4794652">index</span>&nbsp;<span class="op" id="4794658">=</span>&nbsp;<span class="ident" id="4794660">subtle</span><span class="op" id="4794666">.</span><span class="ident" id="4794667">ConstantTimeSelect</span><span class="op" id="4794685">(</span><span class="ident" id="4794686">valid</span><span class="op" id="4794691">,</span>&nbsp;<span class="ident" id="4794693">index</span><span class="op" id="4794698">+</span><span class="num" id="4794699">1</span><span class="op" id="4794700">,</span>&nbsp;<span class="num" id="4794702">0</span><span class="op" id="4794703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4794706">return</span>&nbsp;<span class="ident" id="4794713">valid</span><span class="op" id="4794718">,</span>&nbsp;<span class="ident" id="4794720">em</span><span class="op" id="4794722">,</span>&nbsp;<span class="ident" id="4794724">index</span><span class="op" id="4794729">,</span>&nbsp;<span class="ident" id="4794731">nil</span><br>
<span class="lineno"></span><span class="op" id="4794735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4794738">//&nbsp;nonZeroRandomBytes&nbsp;fills&nbsp;the&nbsp;given&nbsp;slice&nbsp;with&nbsp;non-zero&nbsp;random&nbsp;octets.</span><br>
<span class="lineno">150</span><span class="keyword" id="4794811">func</span>&nbsp;<span class="ident" id="4794816">nonZeroRandomBytes</span><span class="op" id="4794834">(</span><span class="ident" id="4794835">s</span>&nbsp;<span class="op" id="4794837">[</span><span class="op" id="4794838">]</span><span class="builtintype" id="4794839">byte</span><span class="op" id="4794843">,</span>&nbsp;<span class="ident" id="4794845">rand</span>&nbsp;<span class="ident" id="4794850">io</span><span class="op" id="4794852">.</span><span class="ident" id="4794853">Reader</span><span class="op" id="4794859">)</span>&nbsp;<span class="op" id="4794861">(</span><span class="ident" id="4794862">err</span>&nbsp;<span class="builtintype" id="4794866">error</span><span class="op" id="4794871">)</span>&nbsp;<span class="op" id="4794873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4794876">_</span><span class="op" id="4794877">,</span>&nbsp;<span class="ident" id="4794879">err</span>&nbsp;<span class="op" id="4794883">=</span>&nbsp;<span class="ident" id="4794885">io</span><span class="op" id="4794887">.</span><span class="ident" id="4794888">ReadFull</span><span class="op" id="4794896">(</span><span class="ident" id="4794897">rand</span><span class="op" id="4794901">,</span>&nbsp;<span class="ident" id="4794903">s</span><span class="op" id="4794904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4794907">if</span>&nbsp;<span class="ident" id="4794910">err</span>&nbsp;<span class="op" id="4794914">!=</span>&nbsp;<span class="ident" id="4794917">nil</span>&nbsp;<span class="op" id="4794921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4794925">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4794933">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4794937">for</span>&nbsp;<span class="ident" id="4794941">i</span>&nbsp;<span class="op" id="4794943">:=</span>&nbsp;<span class="num" id="4794946">0</span><span class="op" id="4794947">;</span>&nbsp;<span class="ident" id="4794949">i</span>&nbsp;<span class="op" id="4794951">&lt;</span>&nbsp;<span class="builtinfunc" id="4794953">len</span><span class="op" id="4794956">(</span><span class="ident" id="4794957">s</span><span class="op" id="4794958">)</span><span class="op" id="4794959">;</span>&nbsp;<span class="ident" id="4794961">i</span><span class="op" id="4794962">++</span>&nbsp;<span class="op" id="4794965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4794969">for</span>&nbsp;<span class="ident" id="4794973">s</span><span class="op" id="4794974">[</span><span class="ident" id="4794975">i</span><span class="op" id="4794976">]</span>&nbsp;<span class="op" id="4794978">==</span>&nbsp;<span class="num" id="4794981">0</span>&nbsp;<span class="op" id="4794983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4794988">_</span><span class="op" id="4794989">,</span>&nbsp;<span class="ident" id="4794991">err</span>&nbsp;<span class="op" id="4794995">=</span>&nbsp;<span class="ident" id="4794997">io</span><span class="op" id="4794999">.</span><span class="ident" id="4795000">ReadFull</span><span class="op" id="4795008">(</span><span class="ident" id="4795009">rand</span><span class="op" id="4795013">,</span>&nbsp;<span class="ident" id="4795015">s</span><span class="op" id="4795016">[</span><span class="ident" id="4795017">i</span><span class="op" id="4795018">:</span><span class="ident" id="4795019">i</span><span class="op" id="4795020">+</span><span class="num" id="4795021">1</span><span class="op" id="4795022">]</span><span class="op" id="4795023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4795028">if</span>&nbsp;<span class="ident" id="4795031">err</span>&nbsp;<span class="op" id="4795035">!=</span>&nbsp;<span class="ident" id="4795038">nil</span>&nbsp;<span class="op" id="4795042">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4795048">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4795058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4795063">//&nbsp;In&nbsp;tests,&nbsp;the&nbsp;PRNG&nbsp;may&nbsp;return&nbsp;all&nbsp;zeros&nbsp;so&nbsp;we&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4795118">//&nbsp;this&nbsp;to&nbsp;break&nbsp;the&nbsp;loop.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4795148">s</span><span class="op" id="4795149">[</span><span class="ident" id="4795150">i</span><span class="op" id="4795151">]</span>&nbsp;<span class="op" id="4795153">^=</span>&nbsp;<span class="num" id="4795156">0x42</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4795163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4795166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4795170">return</span><br>
<span class="lineno"></span><span class="op" id="4795177">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="4795180">//&nbsp;These&nbsp;are&nbsp;ASN1&nbsp;DER&nbsp;structures:</span><br>
<span class="lineno"></span><span class="comment" id="4795214">//&nbsp;&nbsp;&nbsp;DigestInfo&nbsp;::=&nbsp;SEQUENCE&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4795245">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digestAlgorithm&nbsp;AlgorithmIdentifier,</span><br>
<span class="lineno"></span><span class="comment" id="4795289">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digest&nbsp;OCTET&nbsp;STRING</span><br>
<span class="lineno">175</span><span class="comment" id="4795316">//&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="4795323">//&nbsp;For&nbsp;performance,&nbsp;we&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;generic&nbsp;ASN1&nbsp;encoder.&nbsp;Rather,&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="4795393">//&nbsp;precompute&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;digest&nbsp;value&nbsp;that&nbsp;makes&nbsp;a&nbsp;valid&nbsp;ASN1&nbsp;DER&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="4795471">//&nbsp;with&nbsp;the&nbsp;correct&nbsp;contents.</span><br>
<span class="lineno"></span><span class="keyword" id="4795501">var</span>&nbsp;<span class="ident" id="4795505">hashPrefixes</span>&nbsp;<span class="op" id="4795518">=</span>&nbsp;<span class="keyword" id="4795520">map</span><span class="op" id="4795523">[</span><span class="ident" id="4795524">crypto</span><span class="op" id="4795530">.</span><span class="ident" id="4795531">Hash</span><span class="op" id="4795535">]</span><span class="op" id="4795536">[</span><span class="op" id="4795537">]</span><span class="builtintype" id="4795538">byte</span><span class="op" id="4795542">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4795545">crypto</span><span class="op" id="4795551">.</span><span class="ident" id="4795552">MD5</span><span class="op" id="4795555">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4795563">{</span><span class="num" id="4795564">0x30</span><span class="op" id="4795568">,</span>&nbsp;<span class="num" id="4795570">0x20</span><span class="op" id="4795574">,</span>&nbsp;<span class="num" id="4795576">0x30</span><span class="op" id="4795580">,</span>&nbsp;<span class="num" id="4795582">0x0c</span><span class="op" id="4795586">,</span>&nbsp;<span class="num" id="4795588">0x06</span><span class="op" id="4795592">,</span>&nbsp;<span class="num" id="4795594">0x08</span><span class="op" id="4795598">,</span>&nbsp;<span class="num" id="4795600">0x2a</span><span class="op" id="4795604">,</span>&nbsp;<span class="num" id="4795606">0x86</span><span class="op" id="4795610">,</span>&nbsp;<span class="num" id="4795612">0x48</span><span class="op" id="4795616">,</span>&nbsp;<span class="num" id="4795618">0x86</span><span class="op" id="4795622">,</span>&nbsp;<span class="num" id="4795624">0xf7</span><span class="op" id="4795628">,</span>&nbsp;<span class="num" id="4795630">0x0d</span><span class="op" id="4795634">,</span>&nbsp;<span class="num" id="4795636">0x02</span><span class="op" id="4795640">,</span>&nbsp;<span class="num" id="4795642">0x05</span><span class="op" id="4795646">,</span>&nbsp;<span class="num" id="4795648">0x05</span><span class="op" id="4795652">,</span>&nbsp;<span class="num" id="4795654">0x00</span><span class="op" id="4795658">,</span>&nbsp;<span class="num" id="4795660">0x04</span><span class="op" id="4795664">,</span>&nbsp;<span class="num" id="4795666">0x10</span><span class="op" id="4795670">}</span><span class="op" id="4795671">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4795674">crypto</span><span class="op" id="4795680">.</span><span class="ident" id="4795681">SHA1</span><span class="op" id="4795685">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4795692">{</span><span class="num" id="4795693">0x30</span><span class="op" id="4795697">,</span>&nbsp;<span class="num" id="4795699">0x21</span><span class="op" id="4795703">,</span>&nbsp;<span class="num" id="4795705">0x30</span><span class="op" id="4795709">,</span>&nbsp;<span class="num" id="4795711">0x09</span><span class="op" id="4795715">,</span>&nbsp;<span class="num" id="4795717">0x06</span><span class="op" id="4795721">,</span>&nbsp;<span class="num" id="4795723">0x05</span><span class="op" id="4795727">,</span>&nbsp;<span class="num" id="4795729">0x2b</span><span class="op" id="4795733">,</span>&nbsp;<span class="num" id="4795735">0x0e</span><span class="op" id="4795739">,</span>&nbsp;<span class="num" id="4795741">0x03</span><span class="op" id="4795745">,</span>&nbsp;<span class="num" id="4795747">0x02</span><span class="op" id="4795751">,</span>&nbsp;<span class="num" id="4795753">0x1a</span><span class="op" id="4795757">,</span>&nbsp;<span class="num" id="4795759">0x05</span><span class="op" id="4795763">,</span>&nbsp;<span class="num" id="4795765">0x00</span><span class="op" id="4795769">,</span>&nbsp;<span class="num" id="4795771">0x04</span><span class="op" id="4795775">,</span>&nbsp;<span class="num" id="4795777">0x14</span><span class="op" id="4795781">}</span><span class="op" id="4795782">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4795785">crypto</span><span class="op" id="4795791">.</span><span class="ident" id="4795792">SHA224</span><span class="op" id="4795798">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4795803">{</span><span class="num" id="4795804">0x30</span><span class="op" id="4795808">,</span>&nbsp;<span class="num" id="4795810">0x2d</span><span class="op" id="4795814">,</span>&nbsp;<span class="num" id="4795816">0x30</span><span class="op" id="4795820">,</span>&nbsp;<span class="num" id="4795822">0x0d</span><span class="op" id="4795826">,</span>&nbsp;<span class="num" id="4795828">0x06</span><span class="op" id="4795832">,</span>&nbsp;<span class="num" id="4795834">0x09</span><span class="op" id="4795838">,</span>&nbsp;<span class="num" id="4795840">0x60</span><span class="op" id="4795844">,</span>&nbsp;<span class="num" id="4795846">0x86</span><span class="op" id="4795850">,</span>&nbsp;<span class="num" id="4795852">0x48</span><span class="op" id="4795856">,</span>&nbsp;<span class="num" id="4795858">0x01</span><span class="op" id="4795862">,</span>&nbsp;<span class="num" id="4795864">0x65</span><span class="op" id="4795868">,</span>&nbsp;<span class="num" id="4795870">0x03</span><span class="op" id="4795874">,</span>&nbsp;<span class="num" id="4795876">0x04</span><span class="op" id="4795880">,</span>&nbsp;<span class="num" id="4795882">0x02</span><span class="op" id="4795886">,</span>&nbsp;<span class="num" id="4795888">0x04</span><span class="op" id="4795892">,</span>&nbsp;<span class="num" id="4795894">0x05</span><span class="op" id="4795898">,</span>&nbsp;<span class="num" id="4795900">0x00</span><span class="op" id="4795904">,</span>&nbsp;<span class="num" id="4795906">0x04</span><span class="op" id="4795910">,</span>&nbsp;<span class="num" id="4795912">0x1c</span><span class="op" id="4795916">}</span><span class="op" id="4795917">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4795920">crypto</span><span class="op" id="4795926">.</span><span class="ident" id="4795927">SHA256</span><span class="op" id="4795933">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4795938">{</span><span class="num" id="4795939">0x30</span><span class="op" id="4795943">,</span>&nbsp;<span class="num" id="4795945">0x31</span><span class="op" id="4795949">,</span>&nbsp;<span class="num" id="4795951">0x30</span><span class="op" id="4795955">,</span>&nbsp;<span class="num" id="4795957">0x0d</span><span class="op" id="4795961">,</span>&nbsp;<span class="num" id="4795963">0x06</span><span class="op" id="4795967">,</span>&nbsp;<span class="num" id="4795969">0x09</span><span class="op" id="4795973">,</span>&nbsp;<span class="num" id="4795975">0x60</span><span class="op" id="4795979">,</span>&nbsp;<span class="num" id="4795981">0x86</span><span class="op" id="4795985">,</span>&nbsp;<span class="num" id="4795987">0x48</span><span class="op" id="4795991">,</span>&nbsp;<span class="num" id="4795993">0x01</span><span class="op" id="4795997">,</span>&nbsp;<span class="num" id="4795999">0x65</span><span class="op" id="4796003">,</span>&nbsp;<span class="num" id="4796005">0x03</span><span class="op" id="4796009">,</span>&nbsp;<span class="num" id="4796011">0x04</span><span class="op" id="4796015">,</span>&nbsp;<span class="num" id="4796017">0x02</span><span class="op" id="4796021">,</span>&nbsp;<span class="num" id="4796023">0x01</span><span class="op" id="4796027">,</span>&nbsp;<span class="num" id="4796029">0x05</span><span class="op" id="4796033">,</span>&nbsp;<span class="num" id="4796035">0x00</span><span class="op" id="4796039">,</span>&nbsp;<span class="num" id="4796041">0x04</span><span class="op" id="4796045">,</span>&nbsp;<span class="num" id="4796047">0x20</span><span class="op" id="4796051">}</span><span class="op" id="4796052">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4796055">crypto</span><span class="op" id="4796061">.</span><span class="ident" id="4796062">SHA384</span><span class="op" id="4796068">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4796073">{</span><span class="num" id="4796074">0x30</span><span class="op" id="4796078">,</span>&nbsp;<span class="num" id="4796080">0x41</span><span class="op" id="4796084">,</span>&nbsp;<span class="num" id="4796086">0x30</span><span class="op" id="4796090">,</span>&nbsp;<span class="num" id="4796092">0x0d</span><span class="op" id="4796096">,</span>&nbsp;<span class="num" id="4796098">0x06</span><span class="op" id="4796102">,</span>&nbsp;<span class="num" id="4796104">0x09</span><span class="op" id="4796108">,</span>&nbsp;<span class="num" id="4796110">0x60</span><span class="op" id="4796114">,</span>&nbsp;<span class="num" id="4796116">0x86</span><span class="op" id="4796120">,</span>&nbsp;<span class="num" id="4796122">0x48</span><span class="op" id="4796126">,</span>&nbsp;<span class="num" id="4796128">0x01</span><span class="op" id="4796132">,</span>&nbsp;<span class="num" id="4796134">0x65</span><span class="op" id="4796138">,</span>&nbsp;<span class="num" id="4796140">0x03</span><span class="op" id="4796144">,</span>&nbsp;<span class="num" id="4796146">0x04</span><span class="op" id="4796150">,</span>&nbsp;<span class="num" id="4796152">0x02</span><span class="op" id="4796156">,</span>&nbsp;<span class="num" id="4796158">0x02</span><span class="op" id="4796162">,</span>&nbsp;<span class="num" id="4796164">0x05</span><span class="op" id="4796168">,</span>&nbsp;<span class="num" id="4796170">0x00</span><span class="op" id="4796174">,</span>&nbsp;<span class="num" id="4796176">0x04</span><span class="op" id="4796180">,</span>&nbsp;<span class="num" id="4796182">0x30</span><span class="op" id="4796186">}</span><span class="op" id="4796187">,</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4796190">crypto</span><span class="op" id="4796196">.</span><span class="ident" id="4796197">SHA512</span><span class="op" id="4796203">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4796208">{</span><span class="num" id="4796209">0x30</span><span class="op" id="4796213">,</span>&nbsp;<span class="num" id="4796215">0x51</span><span class="op" id="4796219">,</span>&nbsp;<span class="num" id="4796221">0x30</span><span class="op" id="4796225">,</span>&nbsp;<span class="num" id="4796227">0x0d</span><span class="op" id="4796231">,</span>&nbsp;<span class="num" id="4796233">0x06</span><span class="op" id="4796237">,</span>&nbsp;<span class="num" id="4796239">0x09</span><span class="op" id="4796243">,</span>&nbsp;<span class="num" id="4796245">0x60</span><span class="op" id="4796249">,</span>&nbsp;<span class="num" id="4796251">0x86</span><span class="op" id="4796255">,</span>&nbsp;<span class="num" id="4796257">0x48</span><span class="op" id="4796261">,</span>&nbsp;<span class="num" id="4796263">0x01</span><span class="op" id="4796267">,</span>&nbsp;<span class="num" id="4796269">0x65</span><span class="op" id="4796273">,</span>&nbsp;<span class="num" id="4796275">0x03</span><span class="op" id="4796279">,</span>&nbsp;<span class="num" id="4796281">0x04</span><span class="op" id="4796285">,</span>&nbsp;<span class="num" id="4796287">0x02</span><span class="op" id="4796291">,</span>&nbsp;<span class="num" id="4796293">0x03</span><span class="op" id="4796297">,</span>&nbsp;<span class="num" id="4796299">0x05</span><span class="op" id="4796303">,</span>&nbsp;<span class="num" id="4796305">0x00</span><span class="op" id="4796309">,</span>&nbsp;<span class="num" id="4796311">0x04</span><span class="op" id="4796315">,</span>&nbsp;<span class="num" id="4796317">0x40</span><span class="op" id="4796321">}</span><span class="op" id="4796322">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4796325">crypto</span><span class="op" id="4796331">.</span><span class="ident" id="4796332">MD5SHA1</span><span class="op" id="4796339">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4796343">{</span><span class="op" id="4796344">}</span><span class="op" id="4796345">,</span>&nbsp;<span class="comment" id="4796347">//&nbsp;A&nbsp;special&nbsp;TLS&nbsp;case&nbsp;which&nbsp;doesn&#39;t&nbsp;use&nbsp;an&nbsp;ASN1&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4796404">crypto</span><span class="op" id="4796410">.</span><span class="ident" id="4796411">RIPEMD160</span><span class="op" id="4796420">:</span>&nbsp;<span class="op" id="4796422">{</span><span class="num" id="4796423">0x30</span><span class="op" id="4796427">,</span>&nbsp;<span class="num" id="4796429">0x20</span><span class="op" id="4796433">,</span>&nbsp;<span class="num" id="4796435">0x30</span><span class="op" id="4796439">,</span>&nbsp;<span class="num" id="4796441">0x08</span><span class="op" id="4796445">,</span>&nbsp;<span class="num" id="4796447">0x06</span><span class="op" id="4796451">,</span>&nbsp;<span class="num" id="4796453">0x06</span><span class="op" id="4796457">,</span>&nbsp;<span class="num" id="4796459">0x28</span><span class="op" id="4796463">,</span>&nbsp;<span class="num" id="4796465">0xcf</span><span class="op" id="4796469">,</span>&nbsp;<span class="num" id="4796471">0x06</span><span class="op" id="4796475">,</span>&nbsp;<span class="num" id="4796477">0x03</span><span class="op" id="4796481">,</span>&nbsp;<span class="num" id="4796483">0x00</span><span class="op" id="4796487">,</span>&nbsp;<span class="num" id="4796489">0x31</span><span class="op" id="4796493">,</span>&nbsp;<span class="num" id="4796495">0x04</span><span class="op" id="4796499">,</span>&nbsp;<span class="num" id="4796501">0x14</span><span class="op" id="4796505">}</span><span class="op" id="4796506">,</span><br>
<span class="lineno"></span><span class="op" id="4796508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="comment" id="4796511">//&nbsp;SignPKCS1v15&nbsp;calculates&nbsp;the&nbsp;signature&nbsp;of&nbsp;hashed&nbsp;using&nbsp;RSASSA-PKCS1-V1_5-SIGN&nbsp;from&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4796613">//&nbsp;Note&nbsp;that&nbsp;hashed&nbsp;must&nbsp;be&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4796691">//&nbsp;given&nbsp;hash&nbsp;function.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero,&nbsp;hashed&nbsp;is&nbsp;signed&nbsp;directly.&nbsp;This&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="4796770">//&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="4796812">func</span>&nbsp;<span class="ident" id="4796817">SignPKCS1v15</span><span class="op" id="4796829">(</span><span class="ident" id="4796830">rand</span>&nbsp;<span class="ident" id="4796835">io</span><span class="op" id="4796837">.</span><span class="ident" id="4796838">Reader</span><span class="op" id="4796844">,</span>&nbsp;<span class="ident" id="4796846">priv</span>&nbsp;<span class="op" id="4796851">*</span><span class="ident" id="4796852">PrivateKey</span><span class="op" id="4796862">,</span>&nbsp;<span class="ident" id="4796864">hash</span>&nbsp;<span class="ident" id="4796869">crypto</span><span class="op" id="4796875">.</span><span class="ident" id="4796876">Hash</span><span class="op" id="4796880">,</span>&nbsp;<span class="ident" id="4796882">hashed</span>&nbsp;<span class="op" id="4796889">[</span><span class="op" id="4796890">]</span><span class="builtintype" id="4796891">byte</span><span class="op" id="4796895">)</span>&nbsp;<span class="op" id="4796897">(</span><span class="ident" id="4796898">s</span>&nbsp;<span class="op" id="4796900">[</span><span class="op" id="4796901">]</span><span class="builtintype" id="4796902">byte</span><span class="op" id="4796906">,</span>&nbsp;<span class="ident" id="4796908">err</span>&nbsp;<span class="builtintype" id="4796912">error</span><span class="op" id="4796917">)</span>&nbsp;<span class="op" id="4796919">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4796922">hashLen</span><span class="op" id="4796929">,</span>&nbsp;<span class="ident" id="4796931">prefix</span><span class="op" id="4796937">,</span>&nbsp;<span class="ident" id="4796939">err</span>&nbsp;<span class="op" id="4796943">:=</span>&nbsp;<span class="ident" id="4796946">pkcs1v15HashInfo</span><span class="op" id="4796962">(</span><span class="ident" id="4796963">hash</span><span class="op" id="4796967">,</span>&nbsp;<span class="builtinfunc" id="4796969">len</span><span class="op" id="4796972">(</span><span class="ident" id="4796973">hashed</span><span class="op" id="4796979">)</span><span class="op" id="4796980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4796983">if</span>&nbsp;<span class="ident" id="4796986">err</span>&nbsp;<span class="op" id="4796990">!=</span>&nbsp;<span class="ident" id="4796993">nil</span>&nbsp;<span class="op" id="4796997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4797001">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4797009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4797013">tLen</span>&nbsp;<span class="op" id="4797018">:=</span>&nbsp;<span class="builtinfunc" id="4797021">len</span><span class="op" id="4797024">(</span><span class="ident" id="4797025">prefix</span><span class="op" id="4797031">)</span>&nbsp;<span class="op" id="4797033">+</span>&nbsp;<span class="ident" id="4797035">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4797044">k</span>&nbsp;<span class="op" id="4797046">:=</span>&nbsp;<span class="op" id="4797049">(</span><span class="ident" id="4797050">priv</span><span class="op" id="4797054">.</span><span class="ident" id="4797055">N</span><span class="op" id="4797056">.</span><span class="ident" id="4797057">BitLen</span><span class="op" id="4797063">(</span><span class="op" id="4797064">)</span>&nbsp;<span class="op" id="4797066">+</span>&nbsp;<span class="num" id="4797068">7</span><span class="op" id="4797069">)</span>&nbsp;<span class="op" id="4797071">/</span>&nbsp;<span class="num" id="4797073">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4797076">if</span>&nbsp;<span class="ident" id="4797079">k</span>&nbsp;<span class="op" id="4797081">&lt;</span>&nbsp;<span class="ident" id="4797083">tLen</span><span class="op" id="4797087">+</span><span class="num" id="4797088">11</span>&nbsp;<span class="op" id="4797091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4797095">return</span>&nbsp;<span class="ident" id="4797102">nil</span><span class="op" id="4797105">,</span>&nbsp;<span class="ident" id="4797107">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4797126">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4797130">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4797171">em</span>&nbsp;<span class="op" id="4797174">:=</span>&nbsp;<span class="builtinfunc" id="4797177">make</span><span class="op" id="4797181">(</span><span class="op" id="4797182">[</span><span class="op" id="4797183">]</span><span class="builtintype" id="4797184">byte</span><span class="op" id="4797188">,</span>&nbsp;<span class="ident" id="4797190">k</span><span class="op" id="4797191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4797194">em</span><span class="op" id="4797196">[</span><span class="num" id="4797197">1</span><span class="op" id="4797198">]</span>&nbsp;<span class="op" id="4797200">=</span>&nbsp;<span class="num" id="4797202">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4797205">for</span>&nbsp;<span class="ident" id="4797209">i</span>&nbsp;<span class="op" id="4797211">:=</span>&nbsp;<span class="num" id="4797214">2</span><span class="op" id="4797215">;</span>&nbsp;<span class="ident" id="4797217">i</span>&nbsp;<span class="op" id="4797219">&lt;</span>&nbsp;<span class="ident" id="4797221">k</span><span class="op" id="4797222">-</span><span class="ident" id="4797223">tLen</span><span class="op" id="4797227">-</span><span class="num" id="4797228">1</span><span class="op" id="4797229">;</span>&nbsp;<span class="ident" id="4797231">i</span><span class="op" id="4797232">++</span>&nbsp;<span class="op" id="4797235">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4797239">em</span><span class="op" id="4797241">[</span><span class="ident" id="4797242">i</span><span class="op" id="4797243">]</span>&nbsp;<span class="op" id="4797245">=</span>&nbsp;<span class="num" id="4797247">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4797253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4797256">copy</span><span class="op" id="4797260">(</span><span class="ident" id="4797261">em</span><span class="op" id="4797263">[</span><span class="ident" id="4797264">k</span><span class="op" id="4797265">-</span><span class="ident" id="4797266">tLen</span><span class="op" id="4797270">:</span><span class="ident" id="4797271">k</span><span class="op" id="4797272">-</span><span class="ident" id="4797273">hashLen</span><span class="op" id="4797280">]</span><span class="op" id="4797281">,</span>&nbsp;<span class="ident" id="4797283">prefix</span><span class="op" id="4797289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4797292">copy</span><span class="op" id="4797296">(</span><span class="ident" id="4797297">em</span><span class="op" id="4797299">[</span><span class="ident" id="4797300">k</span><span class="op" id="4797301">-</span><span class="ident" id="4797302">hashLen</span><span class="op" id="4797309">:</span><span class="ident" id="4797310">k</span><span class="op" id="4797311">]</span><span class="op" id="4797312">,</span>&nbsp;<span class="ident" id="4797314">hashed</span><span class="op" id="4797320">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4797324">m</span>&nbsp;<span class="op" id="4797326">:=</span>&nbsp;<span class="builtinfunc" id="4797329">new</span><span class="op" id="4797332">(</span><span class="ident" id="4797333">big</span><span class="op" id="4797336">.</span><span class="ident" id="4797337">Int</span><span class="op" id="4797340">)</span><span class="op" id="4797341">.</span><span class="ident" id="4797342">SetBytes</span><span class="op" id="4797350">(</span><span class="ident" id="4797351">em</span><span class="op" id="4797353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4797356">c</span><span class="op" id="4797357">,</span>&nbsp;<span class="ident" id="4797359">err</span>&nbsp;<span class="op" id="4797363">:=</span>&nbsp;<span class="ident" id="4797366">decrypt</span><span class="op" id="4797373">(</span><span class="ident" id="4797374">rand</span><span class="op" id="4797378">,</span>&nbsp;<span class="ident" id="4797380">priv</span><span class="op" id="4797384">,</span>&nbsp;<span class="ident" id="4797386">m</span><span class="op" id="4797387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4797390">if</span>&nbsp;<span class="ident" id="4797393">err</span>&nbsp;<span class="op" id="4797397">!=</span>&nbsp;<span class="ident" id="4797400">nil</span>&nbsp;<span class="op" id="4797404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4797408">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4797416">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4797420">copyWithLeftPad</span><span class="op" id="4797435">(</span><span class="ident" id="4797436">em</span><span class="op" id="4797438">,</span>&nbsp;<span class="ident" id="4797440">c</span><span class="op" id="4797441">.</span><span class="ident" id="4797442">Bytes</span><span class="op" id="4797447">(</span><span class="op" id="4797448">)</span><span class="op" id="4797449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4797452">s</span>&nbsp;<span class="op" id="4797454">=</span>&nbsp;<span class="ident" id="4797456">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4797460">return</span><br>
<span class="lineno"></span><span class="op" id="4797467">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="4797470">//&nbsp;VerifyPKCS1v15&nbsp;verifies&nbsp;an&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5&nbsp;signature.</span><br>
<span class="lineno"></span><span class="comment" id="4797527">//&nbsp;hashed&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the&nbsp;given&nbsp;hash</span><br>
<span class="lineno"></span><span class="comment" id="4797601">//&nbsp;function&nbsp;and&nbsp;sig&nbsp;is&nbsp;the&nbsp;signature.&nbsp;A&nbsp;valid&nbsp;signature&nbsp;is&nbsp;indicated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4797673">//&nbsp;returning&nbsp;a&nbsp;nil&nbsp;error.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero&nbsp;then&nbsp;hashed&nbsp;is&nbsp;used&nbsp;directly.&nbsp;This</span><br>
<span class="lineno">230</span><span class="comment" id="4797750">//&nbsp;isn&#39;t&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="4797798">func</span>&nbsp;<span class="ident" id="4797803">VerifyPKCS1v15</span><span class="op" id="4797817">(</span><span class="ident" id="4797818">pub</span>&nbsp;<span class="op" id="4797822">*</span><span class="ident" id="4797823">PublicKey</span><span class="op" id="4797832">,</span>&nbsp;<span class="ident" id="4797834">hash</span>&nbsp;<span class="ident" id="4797839">crypto</span><span class="op" id="4797845">.</span><span class="ident" id="4797846">Hash</span><span class="op" id="4797850">,</span>&nbsp;<span class="ident" id="4797852">hashed</span>&nbsp;<span class="op" id="4797859">[</span><span class="op" id="4797860">]</span><span class="builtintype" id="4797861">byte</span><span class="op" id="4797865">,</span>&nbsp;<span class="ident" id="4797867">sig</span>&nbsp;<span class="op" id="4797871">[</span><span class="op" id="4797872">]</span><span class="builtintype" id="4797873">byte</span><span class="op" id="4797877">)</span>&nbsp;<span class="op" id="4797879">(</span><span class="ident" id="4797880">err</span>&nbsp;<span class="builtintype" id="4797884">error</span><span class="op" id="4797889">)</span>&nbsp;<span class="op" id="4797891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4797894">hashLen</span><span class="op" id="4797901">,</span>&nbsp;<span class="ident" id="4797903">prefix</span><span class="op" id="4797909">,</span>&nbsp;<span class="ident" id="4797911">err</span>&nbsp;<span class="op" id="4797915">:=</span>&nbsp;<span class="ident" id="4797918">pkcs1v15HashInfo</span><span class="op" id="4797934">(</span><span class="ident" id="4797935">hash</span><span class="op" id="4797939">,</span>&nbsp;<span class="builtinfunc" id="4797941">len</span><span class="op" id="4797944">(</span><span class="ident" id="4797945">hashed</span><span class="op" id="4797951">)</span><span class="op" id="4797952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4797955">if</span>&nbsp;<span class="ident" id="4797958">err</span>&nbsp;<span class="op" id="4797962">!=</span>&nbsp;<span class="ident" id="4797965">nil</span>&nbsp;<span class="op" id="4797969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4797973">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4797981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4797985">tLen</span>&nbsp;<span class="op" id="4797990">:=</span>&nbsp;<span class="builtinfunc" id="4797993">len</span><span class="op" id="4797996">(</span><span class="ident" id="4797997">prefix</span><span class="op" id="4798003">)</span>&nbsp;<span class="op" id="4798005">+</span>&nbsp;<span class="ident" id="4798007">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4798016">k</span>&nbsp;<span class="op" id="4798018">:=</span>&nbsp;<span class="op" id="4798021">(</span><span class="ident" id="4798022">pub</span><span class="op" id="4798025">.</span><span class="ident" id="4798026">N</span><span class="op" id="4798027">.</span><span class="ident" id="4798028">BitLen</span><span class="op" id="4798034">(</span><span class="op" id="4798035">)</span>&nbsp;<span class="op" id="4798037">+</span>&nbsp;<span class="num" id="4798039">7</span><span class="op" id="4798040">)</span>&nbsp;<span class="op" id="4798042">/</span>&nbsp;<span class="num" id="4798044">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4798047">if</span>&nbsp;<span class="ident" id="4798050">k</span>&nbsp;<span class="op" id="4798052">&lt;</span>&nbsp;<span class="ident" id="4798054">tLen</span><span class="op" id="4798058">+</span><span class="num" id="4798059">11</span>&nbsp;<span class="op" id="4798062">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4798066">err</span>&nbsp;<span class="op" id="4798070">=</span>&nbsp;<span class="ident" id="4798072">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4798090">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4798098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4798102">c</span>&nbsp;<span class="op" id="4798104">:=</span>&nbsp;<span class="builtinfunc" id="4798107">new</span><span class="op" id="4798110">(</span><span class="ident" id="4798111">big</span><span class="op" id="4798114">.</span><span class="ident" id="4798115">Int</span><span class="op" id="4798118">)</span><span class="op" id="4798119">.</span><span class="ident" id="4798120">SetBytes</span><span class="op" id="4798128">(</span><span class="ident" id="4798129">sig</span><span class="op" id="4798132">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4798135">m</span>&nbsp;<span class="op" id="4798137">:=</span>&nbsp;<span class="ident" id="4798140">encrypt</span><span class="op" id="4798147">(</span><span class="builtinfunc" id="4798148">new</span><span class="op" id="4798151">(</span><span class="ident" id="4798152">big</span><span class="op" id="4798155">.</span><span class="ident" id="4798156">Int</span><span class="op" id="4798159">)</span><span class="op" id="4798160">,</span>&nbsp;<span class="ident" id="4798162">pub</span><span class="op" id="4798165">,</span>&nbsp;<span class="ident" id="4798167">c</span><span class="op" id="4798168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4798171">em</span>&nbsp;<span class="op" id="4798174">:=</span>&nbsp;<span class="ident" id="4798177">leftPad</span><span class="op" id="4798184">(</span><span class="ident" id="4798185">m</span><span class="op" id="4798186">.</span><span class="ident" id="4798187">Bytes</span><span class="op" id="4798192">(</span><span class="op" id="4798193">)</span><span class="op" id="4798194">,</span>&nbsp;<span class="ident" id="4798196">k</span><span class="op" id="4798197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4798200">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4798242">ok</span>&nbsp;<span class="op" id="4798245">:=</span>&nbsp;<span class="ident" id="4798248">subtle</span><span class="op" id="4798254">.</span><span class="ident" id="4798255">ConstantTimeByteEq</span><span class="op" id="4798273">(</span><span class="ident" id="4798274">em</span><span class="op" id="4798276">[</span><span class="num" id="4798277">0</span><span class="op" id="4798278">]</span><span class="op" id="4798279">,</span>&nbsp;<span class="num" id="4798281">0</span><span class="op" id="4798282">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4798285">ok</span>&nbsp;<span class="op" id="4798288">&amp;=</span>&nbsp;<span class="ident" id="4798291">subtle</span><span class="op" id="4798297">.</span><span class="ident" id="4798298">ConstantTimeByteEq</span><span class="op" id="4798316">(</span><span class="ident" id="4798317">em</span><span class="op" id="4798319">[</span><span class="num" id="4798320">1</span><span class="op" id="4798321">]</span><span class="op" id="4798322">,</span>&nbsp;<span class="num" id="4798324">1</span><span class="op" id="4798325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4798328">ok</span>&nbsp;<span class="op" id="4798331">&amp;=</span>&nbsp;<span class="ident" id="4798334">subtle</span><span class="op" id="4798340">.</span><span class="ident" id="4798341">ConstantTimeCompare</span><span class="op" id="4798360">(</span><span class="ident" id="4798361">em</span><span class="op" id="4798363">[</span><span class="ident" id="4798364">k</span><span class="op" id="4798365">-</span><span class="ident" id="4798366">hashLen</span><span class="op" id="4798373">:</span><span class="ident" id="4798374">k</span><span class="op" id="4798375">]</span><span class="op" id="4798376">,</span>&nbsp;<span class="ident" id="4798378">hashed</span><span class="op" id="4798384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4798387">ok</span>&nbsp;<span class="op" id="4798390">&amp;=</span>&nbsp;<span class="ident" id="4798393">subtle</span><span class="op" id="4798399">.</span><span class="ident" id="4798400">ConstantTimeCompare</span><span class="op" id="4798419">(</span><span class="ident" id="4798420">em</span><span class="op" id="4798422">[</span><span class="ident" id="4798423">k</span><span class="op" id="4798424">-</span><span class="ident" id="4798425">tLen</span><span class="op" id="4798429">:</span><span class="ident" id="4798430">k</span><span class="op" id="4798431">-</span><span class="ident" id="4798432">hashLen</span><span class="op" id="4798439">]</span><span class="op" id="4798440">,</span>&nbsp;<span class="ident" id="4798442">prefix</span><span class="op" id="4798448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4798451">ok</span>&nbsp;<span class="op" id="4798454">&amp;=</span>&nbsp;<span class="ident" id="4798457">subtle</span><span class="op" id="4798463">.</span><span class="ident" id="4798464">ConstantTimeByteEq</span><span class="op" id="4798482">(</span><span class="ident" id="4798483">em</span><span class="op" id="4798485">[</span><span class="ident" id="4798486">k</span><span class="op" id="4798487">-</span><span class="ident" id="4798488">tLen</span><span class="op" id="4798492">-</span><span class="num" id="4798493">1</span><span class="op" id="4798494">]</span><span class="op" id="4798495">,</span>&nbsp;<span class="num" id="4798497">0</span><span class="op" id="4798498">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4798502">for</span>&nbsp;<span class="ident" id="4798506">i</span>&nbsp;<span class="op" id="4798508">:=</span>&nbsp;<span class="num" id="4798511">2</span><span class="op" id="4798512">;</span>&nbsp;<span class="ident" id="4798514">i</span>&nbsp;<span class="op" id="4798516">&lt;</span>&nbsp;<span class="ident" id="4798518">k</span><span class="op" id="4798519">-</span><span class="ident" id="4798520">tLen</span><span class="op" id="4798524">-</span><span class="num" id="4798525">1</span><span class="op" id="4798526">;</span>&nbsp;<span class="ident" id="4798528">i</span><span class="op" id="4798529">++</span>&nbsp;<span class="op" id="4798532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4798536">ok</span>&nbsp;<span class="op" id="4798539">&amp;=</span>&nbsp;<span class="ident" id="4798542">subtle</span><span class="op" id="4798548">.</span><span class="ident" id="4798549">ConstantTimeByteEq</span><span class="op" id="4798567">(</span><span class="ident" id="4798568">em</span><span class="op" id="4798570">[</span><span class="ident" id="4798571">i</span><span class="op" id="4798572">]</span><span class="op" id="4798573">,</span>&nbsp;<span class="num" id="4798575">0xff</span><span class="op" id="4798579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4798582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4798586">if</span>&nbsp;<span class="ident" id="4798589">ok</span>&nbsp;<span class="op" id="4798592">!=</span>&nbsp;<span class="num" id="4798595">1</span>&nbsp;<span class="op" id="4798597">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4798601">return</span>&nbsp;<span class="ident" id="4798608">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4798625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4798629">return</span>&nbsp;<span class="ident" id="4798636">nil</span><br>
<span class="lineno"></span><span class="op" id="4798640">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="4798643">func</span>&nbsp;<span class="ident" id="4798648">pkcs1v15HashInfo</span><span class="op" id="4798664">(</span><span class="ident" id="4798665">hash</span>&nbsp;<span class="ident" id="4798670">crypto</span><span class="op" id="4798676">.</span><span class="ident" id="4798677">Hash</span><span class="op" id="4798681">,</span>&nbsp;<span class="ident" id="4798683">inLen</span>&nbsp;<span class="builtintype" id="4798689">int</span><span class="op" id="4798692">)</span>&nbsp;<span class="op" id="4798694">(</span><span class="ident" id="4798695">hashLen</span>&nbsp;<span class="builtintype" id="4798703">int</span><span class="op" id="4798706">,</span>&nbsp;<span class="ident" id="4798708">prefix</span>&nbsp;<span class="op" id="4798715">[</span><span class="op" id="4798716">]</span><span class="builtintype" id="4798717">byte</span><span class="op" id="4798721">,</span>&nbsp;<span class="ident" id="4798723">err</span>&nbsp;<span class="builtintype" id="4798727">error</span><span class="op" id="4798732">)</span>&nbsp;<span class="op" id="4798734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4798737">//&nbsp;Special&nbsp;case:&nbsp;crypto.Hash(0)&nbsp;is&nbsp;used&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4798807">//&nbsp;signed&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4798828">if</span>&nbsp;<span class="ident" id="4798831">hash</span>&nbsp;<span class="op" id="4798836">==</span>&nbsp;<span class="num" id="4798839">0</span>&nbsp;<span class="op" id="4798841">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4798845">return</span>&nbsp;<span class="ident" id="4798852">inLen</span><span class="op" id="4798857">,</span>&nbsp;<span class="ident" id="4798859">nil</span><span class="op" id="4798862">,</span>&nbsp;<span class="ident" id="4798864">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4798869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4798873">hashLen</span>&nbsp;<span class="op" id="4798881">=</span>&nbsp;<span class="ident" id="4798883">hash</span><span class="op" id="4798887">.</span><span class="ident" id="4798888">Size</span><span class="op" id="4798892">(</span><span class="op" id="4798893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4798896">if</span>&nbsp;<span class="ident" id="4798899">inLen</span>&nbsp;<span class="op" id="4798905">!=</span>&nbsp;<span class="ident" id="4798908">hashLen</span>&nbsp;<span class="op" id="4798916">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4798920">return</span>&nbsp;<span class="num" id="4798927">0</span><span class="op" id="4798928">,</span>&nbsp;<span class="ident" id="4798930">nil</span><span class="op" id="4798933">,</span>&nbsp;<span class="ident" id="4798935">errors</span><span class="op" id="4798941">.</span><span class="ident" id="4798942">New</span><span class="op" id="4798945">(</span><span class="string" id="4798946">&#34;crypto/rsa:&nbsp;input&nbsp;must&nbsp;be&nbsp;hashed&nbsp;message&#34;</span><span class="op" id="4798988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4798991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4798994">prefix</span><span class="op" id="4799000">,</span>&nbsp;<span class="ident" id="4799002">ok</span>&nbsp;<span class="op" id="4799005">:=</span>&nbsp;<span class="ident" id="4799008">hashPrefixes</span><span class="op" id="4799020">[</span><span class="ident" id="4799021">hash</span><span class="op" id="4799025">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4799028">if</span>&nbsp;<span class="op" id="4799031">!</span><span class="ident" id="4799032">ok</span>&nbsp;<span class="op" id="4799035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4799039">return</span>&nbsp;<span class="num" id="4799046">0</span><span class="op" id="4799047">,</span>&nbsp;<span class="ident" id="4799049">nil</span><span class="op" id="4799052">,</span>&nbsp;<span class="ident" id="4799054">errors</span><span class="op" id="4799060">.</span><span class="ident" id="4799061">New</span><span class="op" id="4799064">(</span><span class="string" id="4799065">&#34;crypto/rsa:&nbsp;unsupported&nbsp;hash&nbsp;function&#34;</span><span class="op" id="4799104">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4799107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4799110">return</span><br>
<span class="lineno"></span><span class="op" id="4799117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4799120">//&nbsp;copyWithLeftPad&nbsp;copies&nbsp;src&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;dest,&nbsp;padding&nbsp;with&nbsp;zero&nbsp;bytes&nbsp;as</span><br>
<span class="lineno">285</span><span class="comment" id="4799197">//&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="4799208">func</span>&nbsp;<span class="ident" id="4799213">copyWithLeftPad</span><span class="op" id="4799228">(</span><span class="ident" id="4799229">dest</span><span class="op" id="4799233">,</span>&nbsp;<span class="ident" id="4799235">src</span>&nbsp;<span class="op" id="4799239">[</span><span class="op" id="4799240">]</span><span class="builtintype" id="4799241">byte</span><span class="op" id="4799245">)</span>&nbsp;<span class="op" id="4799247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4799250">numPaddingBytes</span>&nbsp;<span class="op" id="4799266">:=</span>&nbsp;<span class="builtinfunc" id="4799269">len</span><span class="op" id="4799272">(</span><span class="ident" id="4799273">dest</span><span class="op" id="4799277">)</span>&nbsp;<span class="op" id="4799279">-</span>&nbsp;<span class="builtinfunc" id="4799281">len</span><span class="op" id="4799284">(</span><span class="ident" id="4799285">src</span><span class="op" id="4799288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4799291">for</span>&nbsp;<span class="ident" id="4799295">i</span>&nbsp;<span class="op" id="4799297">:=</span>&nbsp;<span class="num" id="4799300">0</span><span class="op" id="4799301">;</span>&nbsp;<span class="ident" id="4799303">i</span>&nbsp;<span class="op" id="4799305">&lt;</span>&nbsp;<span class="ident" id="4799307">numPaddingBytes</span><span class="op" id="4799322">;</span>&nbsp;<span class="ident" id="4799324">i</span><span class="op" id="4799325">++</span>&nbsp;<span class="op" id="4799328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4799332">dest</span><span class="op" id="4799336">[</span><span class="ident" id="4799337">i</span><span class="op" id="4799338">]</span>&nbsp;<span class="op" id="4799340">=</span>&nbsp;<span class="num" id="4799342">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4799345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4799348">copy</span><span class="op" id="4799352">(</span><span class="ident" id="4799353">dest</span><span class="op" id="4799357">[</span><span class="ident" id="4799358">numPaddingBytes</span><span class="op" id="4799373">:</span><span class="op" id="4799374">]</span><span class="op" id="4799375">,</span>&nbsp;<span class="ident" id="4799377">src</span><span class="op" id="4799380">)</span><br>
<span class="lineno"></span><span class="op" id="4799382">}</span>
</div>
</body>
</html>
